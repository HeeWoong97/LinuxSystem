cscope 15 $HOME/fsmodule               0001495496
	@jbd3/checkpoint.c

17 
	~<lšux/time.h
>

18 
	~<lšux/fs.h
>

19 
	~<lšux/jbd2.h
>

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/¦ab.h
>

22 
	~<lšux/blkdev.h
>

23 
	~<Œaû/ev’ts/jbd2.h
>

30 
šlše
 
	$__bufãr_uÆšk_fœ¡
(
jouº®_h—d
 *
jh
)

32 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
;

34 
jh
->
b_ıÃxt
->
b_ı´ev
 = jh->b_cpprev;

35 
jh
->
b_ı´ev
->
b_ıÃxt
 = jh->b_cpnext;

36 ià(
Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
jh
) {

37 
Œª§ùiÚ
->
t_checkpošt_li¡
 = 
jh
->
b_ıÃxt
;

38 ià(
Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
jh
)

39 
Œª§ùiÚ
->
t_checkpošt_li¡
 = 
NULL
;

41 
	}
}

48 
šlše
 
	$__bufãr_uÆšk
(
jouº®_h—d
 *
jh
)

50 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
;

52 
	`__bufãr_uÆšk_fœ¡
(
jh
);

53 ià(
Œª§ùiÚ
->
t_checkpošt_io_li¡
 =ğ
jh
) {

54 
Œª§ùiÚ
->
t_checkpošt_io_li¡
 = 
jh
->
b_ıÃxt
;

55 ià(
Œª§ùiÚ
->
t_checkpošt_io_li¡
 =ğ
jh
)

56 
Œª§ùiÚ
->
t_checkpošt_io_li¡
 = 
NULL
;

58 
	}
}

65 
šlše
 
	$__bufãr_»lšk_io
(
jouº®_h—d
 *
jh
)

67 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
;

69 
	`__bufãr_uÆšk_fœ¡
(
jh
);

71 ià(!
Œª§ùiÚ
->
t_checkpošt_io_li¡
) {

72 
jh
->
b_ıÃxt
 = jh->
b_ı´ev
 = jh;

74 
jh
->
b_ıÃxt
 = 
Œª§ùiÚ
->
t_checkpošt_io_li¡
;

75 
jh
->
b_ı´ev
 = 
Œª§ùiÚ
->
t_checkpošt_io_li¡
->b_cpprev;

76 
jh
->
b_ı´ev
->
b_ıÃxt
 = jh;

77 
jh
->
b_ıÃxt
->
b_ı´ev
 = jh;

79 
Œª§ùiÚ
->
t_checkpošt_io_li¡
 = 
jh
;

80 
	}
}

89 
	$__Œy_to_ä“_ı_buf
(
jouº®_h—d
 *
jh
)

91 
»t
 = 0;

92 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

94 ià(
jh
->
b_Œª§ùiÚ
 =ğ
NULL
 && !
	`bufãr_locked
(
bh
) &&

95 !
	`bufãr_dœty
(
bh
è&& !
	`bufãr_wr™e_io_”rÜ
(bh)) {

96 
	`JBUFFER_TRACE
(
jh
, "remove from checkpoint†ist");

97 
»t
 = 
	`__jbd2_jouº®_»move_checkpošt
(
jh
) + 1;

99  
»t
;

100 
	}
}

108 
	$__jbd2_log_wa™_fÜ_¥aû
(
jouº®_t
 *
jouº®
)

110 
nblocks
, 
¥aû_Ëá
;

113 
nblocks
 = 
	`jbd2_¥aû_Ãeded
(
jouº®
);

114 
	`jbd2_log_¥aû_Ëá
(
jouº®
è< 
nblocks
) {

115 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

116 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

129 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

130 ià(
jouº®
->
j_æags
 & 
JBD2_ABORT
) {

131 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

134 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

135 
¥aû_Ëá
 = 
	`jbd2_log_¥aû_Ëá
(
jouº®
);

136 ià(
¥aû_Ëá
 < 
nblocks
) {

137 
chk±
 = 
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
NULL
;

138 
tid_t
 
tid
 = 0;

140 ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
)

141 
tid
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
;

142 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

143 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

144 ià(
chk±
) {

145 
	`jbd2_log_do_checkpošt
(
jouº®
);

146 } ià(
	`jbd2_ş—nup_jouº®_
(
jouº®
) == 0) {

149 } ià(
tid
) {

155 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

156 
	`jbd2_log_wa™_comm™
(
jouº®
, 
tid
);

157 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

160 
	`´štk
(
KERN_ERR
 "%s:‚eeded %d blocks‡nd "

162 
__func__
, 
nblocks
, 
¥aû_Ëá
);

163 
	`´štk
(
KERN_ERR
 "%s:‚o wayo get more "

164 "jouº® s·û iÀ%s\n", 
__func__
,

165 
jouº®
->
j_devÇme
);

166 
	`WARN_ON
(1);

167 
	`jbd2_jouº®_abÜt
(
jouº®
, 0);

169 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

171 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

173 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

175 
	}
}

178 
	$__æush_b©ch
(
jouº®_t
 *
jouº®
, *
b©ch_couÁ
)

180 
i
;

181 
blk_¶ug
 
¶ug
;

183 
	`blk_¡¬t_¶ug
(&
¶ug
);

184 
i
 = 0; i < *
b©ch_couÁ
; i++)

185 
	`wr™e_dœty_bufãr
(
jouº®
->
j_chk±_bhs
[
i
], 
REQ_SYNC
);

186 
	`blk_fšish_¶ug
(&
¶ug
);

188 
i
 = 0; i < *
b©ch_couÁ
; i++) {

189 
bufãr_h—d
 *
bh
 = 
jouº®
->
j_chk±_bhs
[
i
];

190 
	`BUFFER_TRACE
(
bh
, "brelse");

191 
	`__b»l£
(
bh
);

193 *
b©ch_couÁ
 = 0;

194 
	}
}

204 
	$jbd2_log_do_checkpošt
(
jouº®_t
 *
jouº®
)

206 
jouº®_h—d
 *
jh
;

207 
bufãr_h—d
 *
bh
;

208 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

209 
tid_t
 
this_tid
;

210 
»suÉ
, 
b©ch_couÁ
 = 0;

212 
	`jbd_debug
(1, "Start checkpoint\n");

219 
»suÉ
 = 
	`jbd2_ş—nup_jouº®_
(
jouº®
);

220 
	`Œaû_jbd2_checkpošt
(
jouº®
, 
»suÉ
);

221 
	`jbd_debug
(1, "ş—nup_jouº®_„‘uºed %d\n", 
»suÉ
);

222 ià(
»suÉ
 <= 0)

223  
»suÉ
;

229 
»suÉ
 = 0;

230 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

231 ià(!
jouº®
->
j_checkpošt_Œª§ùiÚs
)

232 
out
;

233 
Œª§ùiÚ
 = 
jouº®
->
j_checkpošt_Œª§ùiÚs
;

234 ià(
Œª§ùiÚ
->
t_chp_¡©s
.
cs_chp_time
 == 0)

235 
Œª§ùiÚ
->
t_chp_¡©s
.
cs_chp_time
 = 
jiff›s
;

236 
this_tid
 = 
Œª§ùiÚ
->
t_tid
;

237 
»¡¬t
:

243 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
Œª§ùiÚ
 ||

244 
Œª§ùiÚ
->
t_tid
 !ğ
this_tid
)

245 
out
;

248 
Œª§ùiÚ
->
t_checkpošt_li¡
) {

249 
jh
 = 
Œª§ùiÚ
->
t_checkpošt_li¡
;

250 
bh
 = 
	`jh2bh
(
jh
);

252 ià(
	`bufãr_locked
(
bh
)) {

253 
	`g‘_bh
(
bh
);

254 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

255 
	`wa™_Ú_bufãr
(
bh
);

257 
	`BUFFER_TRACE
(
bh
, "brelse");

258 
	`__b»l£
(
bh
);

259 
»Œy
;

261 ià(
jh
->
b_Œª§ùiÚ
 !ğ
NULL
) {

262 
Œª§ùiÚ_t
 *
t
 = 
jh
->
b_Œª§ùiÚ
;

263 
tid_t
 
tid
 = 
t
->
t_tid
;

265 
Œª§ùiÚ
->
t_chp_¡©s
.
cs_fÜûd_to_şo£
++;

266 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

267 ià(
	`uÆik–y
(
jouº®
->
j_æags
 & 
JBD2_UNMOUNT
))

274 
	`´štk
(
KERN_ERR


276 
jouº®
->
j_devÇme
, (è
bh
->
b_blockÄ
);

278 ià(
b©ch_couÁ
)

279 
	`__æush_b©ch
(
jouº®
, &
b©ch_couÁ
);

280 
	`jbd2_log_¡¬t_comm™
(
jouº®
, 
tid
);

289 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

290 
	`jbd2_log_wa™_comm™
(
jouº®
, 
tid
);

291 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

292 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

293 
»¡¬t
;

295 ià(!
	`bufãr_dœty
(
bh
)) {

296 ià(
	`uÆik–y
(
	`bufãr_wr™e_io_”rÜ
(
bh
)è&& !
»suÉ
)

297 
»suÉ
 = -
EIO
;

298 
	`BUFFER_TRACE
(
bh
, "remove from checkpoint");

299 ià(
	`__jbd2_jouº®_»move_checkpošt
(
jh
))

301 
out
;

312 
	`BUFFER_TRACE
(
bh
, "queue");

313 
	`g‘_bh
(
bh
);

314 
	`J_ASSERT_BH
(
bh
, !
	`bufãr_jwr™e
(bh));

315 
jouº®
->
j_chk±_bhs
[
b©ch_couÁ
++] = 
bh
;

316 
	`__bufãr_»lšk_io
(
jh
);

317 
Œª§ùiÚ
->
t_chp_¡©s
.
cs_wr™‹n
++;

318 ià((
b©ch_couÁ
 =ğ
JBD2_NR_BATCH
) ||

319 
	`Ãed_»sched
() ||

320 
	`¥š_Ãedb»ak
(&
jouº®
->
j_li¡_lock
))

321 
uÆock_ªd_æush
;

324 ià(
b©ch_couÁ
) {

325 
uÆock_ªd_æush
:

326 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

327 
»Œy
:

328 ià(
b©ch_couÁ
)

329 
	`__æush_b©ch
(
jouº®
, &
b©ch_couÁ
);

330 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

331 
»¡¬t
;

338 
»¡¬t2
:

340 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
Œª§ùiÚ
 ||

341 
Œª§ùiÚ
->
t_tid
 !ğ
this_tid
)

342 
out
;

344 
Œª§ùiÚ
->
t_checkpošt_io_li¡
) {

345 
jh
 = 
Œª§ùiÚ
->
t_checkpošt_io_li¡
;

346 
bh
 = 
	`jh2bh
(
jh
);

347 ià(
	`bufãr_locked
(
bh
)) {

348 
	`g‘_bh
(
bh
);

349 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

350 
	`wa™_Ú_bufãr
(
bh
);

352 
	`BUFFER_TRACE
(
bh
, "brelse");

353 
	`__b»l£
(
bh
);

354 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

355 
»¡¬t2
;

357 ià(
	`uÆik–y
(
	`bufãr_wr™e_io_”rÜ
(
bh
)è&& !
»suÉ
)

358 
»suÉ
 = -
EIO
;

365 ià(
	`__jbd2_jouº®_»move_checkpošt
(
jh
))

368 
out
:

369 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

370 ià(
»suÉ
 < 0)

371 
	`jbd2_jouº®_abÜt
(
jouº®
, 
»suÉ
);

373 
»suÉ
 = 
	`jbd2_ş—nup_jouº®_
(
jouº®
);

375  (
»suÉ
 < 0) ?„esult : 0;

376 
	}
}

396 
	$jbd2_ş—nup_jouº®_
(
jouº®_t
 *
jouº®
)

398 
tid_t
 
fœ¡_tid
;

399 
blockÄ
;

401 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

402  -
EIO
;

404 ià(!
	`jbd2_jouº®_g‘_log_
(
jouº®
, &
fœ¡_tid
, &
blockÄ
))

406 
	`J_ASSERT
(
blockÄ
 != 0);

416 ià(
jouº®
->
j_æags
 & 
JBD2_BARRIER
)

417 
	`blkdev_issue_æush
(
jouº®
->
j_fs_dev
, 
GFP_NOFS
, 
NULL
);

419  
	`__jbd2_upd©e_log_
(
jouº®
, 
fœ¡_tid
, 
blockÄ
);

420 
	}
}

434 
	$jouº®_ş—n_Úe_ı_li¡
(
jouº®_h—d
 *
jh
, 
boŞ
 
de¡roy
)

436 
jouº®_h—d
 *
Ï¡_jh
;

437 
jouº®_h—d
 *
Ãxt_jh
 = 
jh
;

438 
»t
;

440 ià(!
jh
)

443 
Ï¡_jh
 = 
jh
->
b_ı´ev
;

445 
jh
 = 
Ãxt_jh
;

446 
Ãxt_jh
 = 
jh
->
b_ıÃxt
;

447 ià(!
de¡roy
)

448 
»t
 = 
	`__Œy_to_ä“_ı_buf
(
jh
);

450 
»t
 = 
	`__jbd2_jouº®_»move_checkpošt
(
jh
) + 1;

451 ià(!
»t
)

453 ià(
»t
 == 2)

461 ià(
	`Ãed_»sched
())

463 } 
jh
 !ğ
Ï¡_jh
);

466 
	}
}

476 
	$__jbd2_jouº®_ş—n_checkpošt_li¡
(
jouº®_t
 *
jouº®
, 
boŞ
 
de¡roy
)

478 
Œª§ùiÚ_t
 *
Œª§ùiÚ
, *
Ï¡_Œª§ùiÚ
, *
Ãxt_Œª§ùiÚ
;

479 
»t
;

481 
Œª§ùiÚ
 = 
jouº®
->
j_checkpošt_Œª§ùiÚs
;

482 ià(!
Œª§ùiÚ
)

485 
Ï¡_Œª§ùiÚ
 = 
Œª§ùiÚ
->
t_ı´ev
;

486 
Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

488 
Œª§ùiÚ
 = 
Ãxt_Œª§ùiÚ
;

489 
Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
->
t_ıÃxt
;

490 
»t
 = 
	`jouº®_ş—n_Úe_ı_li¡
(
Œª§ùiÚ
->
t_checkpošt_li¡
,

491 
de¡roy
);

497 ià(
	`Ãed_»sched
())

499 ià(
»t
)

506 
»t
 = 
	`jouº®_ş—n_Úe_ı_li¡
(
Œª§ùiÚ
->

507 
t_checkpošt_io_li¡
, 
de¡roy
);

508 ià(
	`Ãed_»sched
())

515 ià(!
»t
)

517 } 
Œª§ùiÚ
 !ğ
Ï¡_Œª§ùiÚ
);

518 
	}
}

524 
	$jbd2_jouº®_de¡roy_checkpošt
(
jouº®_t
 *
jouº®
)

531 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

532 ià(!
jouº®
->
j_checkpošt_Œª§ùiÚs
) {

533 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

536 
	`__jbd2_jouº®_ş—n_checkpošt_li¡
(
jouº®
, 
Œue
);

537 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

538 
	`cÚd_»sched
();

540 
	}
}

560 
	$__jbd2_jouº®_»move_checkpošt
(
jouº®_h—d
 *
jh
)

562 
Œª§ùiÚ_chp_¡©s_s
 *
¡©s
;

563 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

564 
jouº®_t
 *
jouº®
;

565 
»t
 = 0;

567 
	`JBUFFER_TRACE
(
jh
, "entry");

569 ià((
Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
è=ğ
NULL
) {

570 
	`JBUFFER_TRACE
(
jh
, "not onransaction");

571 
out
;

573 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

575 
	`JBUFFER_TRACE
(
jh
, "removing fromransaction");

576 
	`__bufãr_uÆšk
(
jh
);

577 
jh
->
b_ı_Œª§ùiÚ
 = 
NULL
;

578 
	`jbd2_jouº®_put_jouº®_h—d
(
jh
);

580 ià(
Œª§ùiÚ
->
t_checkpošt_li¡
 !ğ
NULL
 ||

581 
Œª§ùiÚ
->
t_checkpošt_io_li¡
 !ğ
NULL
)

582 
out
;

593 ià(
Œª§ùiÚ
->
t_¡©e
 !ğ
T_FINISHED
)

594 
out
;

598 
¡©s
 = &
Œª§ùiÚ
->
t_chp_¡©s
;

599 ià(
¡©s
->
cs_chp_time
)

600 
¡©s
->
cs_chp_time
 = 
	`jbd2_time_diff
(stats->cs_chp_time,

601 
jiff›s
);

602 
	`Œaû_jbd2_checkpošt_¡©s
(
jouº®
->
j_fs_dev
->
bd_dev
,

603 
Œª§ùiÚ
->
t_tid
, 
¡©s
);

605 
	`__jbd2_jouº®_drİ_Œª§ùiÚ
(
jouº®
, 
Œª§ùiÚ
);

606 
	`jbd2_jouº®_ä“_Œª§ùiÚ
(
Œª§ùiÚ
);

607 
»t
 = 1;

608 
out
:

609  
»t
;

610 
	}
}

620 
	$__jbd2_jouº®_š£¹_checkpošt
(
jouº®_h—d
 *
jh
,

621 
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

623 
	`JBUFFER_TRACE
(
jh
, "entry");

624 
	`J_ASSERT_JH
(
jh
, 
	`bufãr_dœty
(
	`jh2bh
(jh)è|| 
	`bufãr_jbddœty
(jh2bh(jh)));

625 
	`J_ASSERT_JH
(
jh
, jh->
b_ı_Œª§ùiÚ
 =ğ
NULL
);

628 
	`jbd2_jouº®_g¿b_jouº®_h—d
(
	`jh2bh
(
jh
));

629 
jh
->
b_ı_Œª§ùiÚ
 = 
Œª§ùiÚ
;

631 ià(!
Œª§ùiÚ
->
t_checkpošt_li¡
) {

632 
jh
->
b_ıÃxt
 = jh->
b_ı´ev
 = jh;

634 
jh
->
b_ıÃxt
 = 
Œª§ùiÚ
->
t_checkpošt_li¡
;

635 
jh
->
b_ı´ev
 = 
Œª§ùiÚ
->
t_checkpošt_li¡
->b_cpprev;

636 
jh
->
b_ı´ev
->
b_ıÃxt
 = jh;

637 
jh
->
b_ıÃxt
->
b_ı´ev
 = jh;

639 
Œª§ùiÚ
->
t_checkpošt_li¡
 = 
jh
;

640 
	}
}

652 
	$__jbd2_jouº®_drİ_Œª§ùiÚ
(
jouº®_t
 *
jouº®
, 
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

654 
	`as£¹_¥š_locked
(&
jouº®
->
j_li¡_lock
);

655 ià(
Œª§ùiÚ
->
t_ıÃxt
) {

656 
Œª§ùiÚ
->
t_ıÃxt
->
t_ı´ev
 =ransaction->t_cpprev;

657 
Œª§ùiÚ
->
t_ı´ev
->
t_ıÃxt
 =ransaction->t_cpnext;

658 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 =ğ
Œª§ùiÚ
)

659 
jouº®
->
j_checkpošt_Œª§ùiÚs
 =

660 
Œª§ùiÚ
->
t_ıÃxt
;

661 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 =ğ
Œª§ùiÚ
)

662 
jouº®
->
j_checkpošt_Œª§ùiÚs
 = 
NULL
;

665 
	`J_ASSERT
(
Œª§ùiÚ
->
t_¡©e
 =ğ
T_FINISHED
);

666 
	`J_ASSERT
(
Œª§ùiÚ
->
t_bufãrs
 =ğ
NULL
);

667 
	`J_ASSERT
(
Œª§ùiÚ
->
t_fÜg‘
 =ğ
NULL
);

668 
	`J_ASSERT
(
Œª§ùiÚ
->
t_shadow_li¡
 =ğ
NULL
);

669 
	`J_ASSERT
(
Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
NULL
);

670 
	`J_ASSERT
(
Œª§ùiÚ
->
t_checkpošt_io_li¡
 =ğ
NULL
);

671 
	`J_ASSERT
(
	`©omic_»ad
(&
Œª§ùiÚ
->
t_upd©es
) == 0);

672 
	`J_ASSERT
(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 !ğ
Œª§ùiÚ
);

673 
	`J_ASSERT
(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 !ğ
Œª§ùiÚ
);

675 
	`Œaû_jbd2_drİ_Œª§ùiÚ
(
jouº®
, 
Œª§ùiÚ
);

677 
	`jbd_debug
(1, "Drİpšg¿n§ùiÚ %d,‡Î dÚe\n", 
Œª§ùiÚ
->
t_tid
);

678 
	}
}

	@jbd3/commit.c

13 
	~<lšux/time.h
>

14 
	~<lšux/fs.h
>

15 
	~<lšux/jbd2.h
>

16 
	~<lšux/”ºo.h
>

17 
	~<lšux/¦ab.h
>

18 
	~<lšux/mm.h
>

19 
	~<lšux/·gem­.h
>

20 
	~<lšux/jiff›s.h
>

21 
	~<lšux/üc32.h
>

22 
	~<lšux/wr™eback.h
>

23 
	~<lšux/backšg-dev.h
>

24 
	~<lšux/bio.h
>

25 
	~<lšux/blkdev.h
>

26 
	~<lšux/b™İs.h
>

27 
	~<Œaû/ev’ts/jbd2.h
>

32 
	$jouº®_’d_bufãr_io_sync
(
bufãr_h—d
 *
bh
, 
u±od©e
)

34 
bufãr_h—d
 *
Üig_bh
 = 
bh
->
b_´iv©e
;

36 
	`BUFFER_TRACE
(
bh
, "");

37 ià(
u±od©e
)

38 
	`£t_bufãr_u±od©e
(
bh
);

40 
	`ş—r_bufãr_u±od©e
(
bh
);

41 ià(
Üig_bh
) {

42 
	`ş—r_b™_uÆock
(
BH_Shadow
, &
Üig_bh
->
b_¡©e
);

43 
	`smp_mb__aá”_©omic
();

44 
	`wake_up_b™
(&
Üig_bh
->
b_¡©e
, 
BH_Shadow
);

46 
	`uÆock_bufãr
(
bh
);

47 
	}
}

63 
	$»Ëa£_bufãr_·ge
(
bufãr_h—d
 *
bh
)

65 
·ge
 *page;

67 ià(
	`bufãr_dœty
(
bh
))

68 
nİe
;

69 ià(
	`©omic_»ad
(&
bh
->
b_couÁ
) != 1)

70 
nİe
;

71 
·ge
 = 
bh
->
b_·ge
;

72 ià(!
·ge
)

73 
nİe
;

74 ià(
·ge
->
m­pšg
)

75 
nİe
;

78 ià(!
	`Œylock_·ge
(
·ge
))

79 
nİe
;

81 
	`g‘_·ge
(
·ge
);

82 
	`__b»l£
(
bh
);

83 
	`Œy_to_ä“_bufãrs
(
·ge
);

84 
	`uÆock_·ge
(
·ge
);

85 
	`put_·ge
(
·ge
);

88 
nİe
:

89 
	`__b»l£
(
bh
);

90 
	}
}

92 
	$jbd2_comm™_block_csum_£t
(
jouº®_t
 *
j
, 
bufãr_h—d
 *
bh
)

94 
comm™_h—d”
 *
h
;

95 
__u32
 
csum
;

97 ià(!
	`jbd2_jouº®_has_csum_v2Ü3
(
j
))

100 
h
 = (
comm™_h—d”
 *)(
bh
->
b_d©a
);

101 
h
->
h_chksum_ty³
 = 0;

102 
h
->
h_chksum_size
 = 0;

103 
h
->
h_chksum
[0] = 0;

104 
csum
 = 
	`jbd2_chksum
(
j
, j->
j_csum_£ed
, 
bh
->
b_d©a
, j->
j_blocksize
);

105 
h
->
h_chksum
[0] = 
	`ıu_to_be32
(
csum
);

106 
	}
}

116 
	$jouº®_subm™_comm™_»cÜd
(
jouº®_t
 *
jouº®
,

117 
Œª§ùiÚ_t
 *
comm™_Œª§ùiÚ
,

118 
bufãr_h—d
 **
cbh
,

119 
__u32
 
üc32_sum
)

121 
comm™_h—d”
 *
tmp
;

122 
bufãr_h—d
 *
bh
;

123 
»t
;

124 
time¥ec64
 
now
;

126 *
cbh
 = 
NULL
;

128 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

131 
bh
 = 
	`jbd2_jouº®_g‘_desütÜ_bufãr
(
comm™_Œª§ùiÚ
,

132 
JBD2_COMMIT_BLOCK
);

133 ià(!
bh
)

136 
tmp
 = (
comm™_h—d”
 *)
bh
->
b_d©a
;

137 
	`ktime_g‘_cßr£_»®_ts64
(&
now
);

138 
tmp
->
h_comm™_£c
 = 
	`ıu_to_be64
(
now
.
tv_£c
);

139 
tmp
->
h_comm™_n£c
 = 
	`ıu_to_be32
(
now
.
tv_n£c
);

141 ià(
	`jbd2_has_ã©u»_checksum
(
jouº®
)) {

142 
tmp
->
h_chksum_ty³
 = 
JBD2_CRC32_CHKSUM
;

143 
tmp
->
h_chksum_size
 = 
JBD2_CRC32_CHKSUM_SIZE
;

144 
tmp
->
h_chksum
[0] = 
	`ıu_to_be32
(
üc32_sum
);

146 
	`jbd2_comm™_block_csum_£t
(
jouº®
, 
bh
);

148 
	`BUFFER_TRACE
(
bh
, "submit commit block");

149 
	`lock_bufãr
(
bh
);

150 
	`ş—r_bufãr_dœty
(
bh
);

151 
	`£t_bufãr_u±od©e
(
bh
);

152 
bh
->
b_’d_io
 = 
jouº®_’d_bufãr_io_sync
;

154 ià(
jouº®
->
j_æags
 & 
JBD2_BARRIER
 &&

155 !
	`jbd2_has_ã©u»_async_comm™
(
jouº®
))

156 
»t
 = 
	`subm™_bh
(
REQ_OP_WRITE
,

157 
REQ_SYNC
 | 
REQ_PREFLUSH
 | 
REQ_FUA
, 
bh
);

159 
»t
 = 
	`subm™_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
, 
bh
);

161 *
cbh
 = 
bh
;

162  
»t
;

163 
	}
}

169 
	$jouº®_wa™_Ú_comm™_»cÜd
(
jouº®_t
 *
jouº®
,

170 
bufãr_h—d
 *
bh
)

172 
»t
 = 0;

174 
	`ş—r_bufãr_dœty
(
bh
);

175 
	`wa™_Ú_bufãr
(
bh
);

177 ià(
	`uÆik–y
(!
	`bufãr_u±od©e
(
bh
)))

178 
»t
 = -
EIO
;

179 
	`put_bh
(
bh
);

181  
»t
;

182 
	}
}

190 
	$jouº®_subm™_šode_d©a_bufãrs
(
add»ss_¥aû
 *
m­pšg
,

191 
loff_t
 
dœty_¡¬t
,†off_ˆ
dœty_’d
)

193 
»t
;

194 
wr™eback_cÚŒŞ
 
wbc
 = {

195 .
sync_mode
 = 
WB_SYNC_ALL
,

196 .
Ä_to_wr™e
 = 
m­pšg
->
Ä·ges
 * 2,

197 .
¿nge_¡¬t
 = 
dœty_¡¬t
,

198 .
¿nge_’d
 = 
dœty_’d
,

201 
»t
 = 
	`g’”ic_wr™•ages
(
m­pšg
, &
wbc
);

202  
»t
;

203 
	}
}

213 
	$jouº®_subm™_d©a_bufãrs
(
jouº®_t
 *
jouº®
,

214 
Œª§ùiÚ_t
 *
comm™_Œª§ùiÚ
)

216 
jbd2_šode
 *
jšode
;

217 
”r
, 
»t
 = 0;

218 
add»ss_¥aû
 *
m­pšg
;

220 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

221 
	`li¡_fÜ_—ch_’Œy
(
jšode
, &
comm™_Œª§ùiÚ
->
t_šode_li¡
, 
i_li¡
) {

222 
loff_t
 
dœty_¡¬t
 = 
jšode
->
i_dœty_¡¬t
;

223 
loff_t
 
dœty_’d
 = 
jšode
->
i_dœty_’d
;

225 ià(!(
jšode
->
i_æags
 & 
JI_WRITE_DATA
))

227 
m­pšg
 = 
jšode
->
i_vfs_šode
->
i_m­pšg
;

228 
jšode
->
i_æags
 |ğ
JI_COMMIT_RUNNING
;

229 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

236 
	`Œaû_jbd2_subm™_šode_d©a
(
jšode
->
i_vfs_šode
);

237 
”r
 = 
	`jouº®_subm™_šode_d©a_bufãrs
(
m­pšg
, 
dœty_¡¬t
,

238 
dœty_’d
);

239 ià(!
»t
)

240 
»t
 = 
”r
;

241 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

242 
	`J_ASSERT
(
jšode
->
i_Œª§ùiÚ
 =ğ
comm™_Œª§ùiÚ
);

243 
jšode
->
i_æags
 &ğ~
JI_COMMIT_RUNNING
;

244 
	`smp_mb
();

245 
	`wake_up_b™
(&
jšode
->
i_æags
, 
__JI_COMMIT_RUNNING
);

247 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

248  
»t
;

249 
	}
}

256 
	$jouº®_fšish_šode_d©a_bufãrs
(
jouº®_t
 *
jouº®
,

257 
Œª§ùiÚ_t
 *
comm™_Œª§ùiÚ
)

259 
jbd2_šode
 *
jšode
, *
Ãxt_i
;

260 
”r
, 
»t
 = 0;

263 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

264 
	`li¡_fÜ_—ch_’Œy
(
jšode
, &
comm™_Œª§ùiÚ
->
t_šode_li¡
, 
i_li¡
) {

265 
loff_t
 
dœty_¡¬t
 = 
jšode
->
i_dœty_¡¬t
;

266 
loff_t
 
dœty_’d
 = 
jšode
->
i_dœty_’d
;

268 ià(!(
jšode
->
i_æags
 & 
JI_WAIT_DATA
))

270 
jšode
->
i_æags
 |ğ
JI_COMMIT_RUNNING
;

271 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

272 
”r
 = 
	`fem­_fd©awa™_¿nge_k“p_”rÜs
(

273 
jšode
->
i_vfs_šode
->
i_m­pšg
, 
dœty_¡¬t
,

274 
dœty_’d
);

275 ià(!
»t
)

276 
»t
 = 
”r
;

277 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

278 
jšode
->
i_æags
 &ğ~
JI_COMMIT_RUNNING
;

279 
	`smp_mb
();

280 
	`wake_up_b™
(&
jšode
->
i_æags
, 
__JI_COMMIT_RUNNING
);

284 
	`li¡_fÜ_—ch_’Œy_§ã
(
jšode
, 
Ãxt_i
,

285 &
comm™_Œª§ùiÚ
->
t_šode_li¡
, 
i_li¡
) {

286 
	`li¡_d–
(&
jšode
->
i_li¡
);

287 ià(
jšode
->
i_Ãxt_Œª§ùiÚ
) {

288 
jšode
->
i_Œª§ùiÚ
 = jšode->
i_Ãxt_Œª§ùiÚ
;

289 
jšode
->
i_Ãxt_Œª§ùiÚ
 = 
NULL
;

290 
	`li¡_add
(&
jšode
->
i_li¡
,

291 &
jšode
->
i_Œª§ùiÚ
->
t_šode_li¡
);

293 
jšode
->
i_Œª§ùiÚ
 = 
NULL
;

294 
jšode
->
i_dœty_¡¬t
 = 0;

295 
jšode
->
i_dœty_’d
 = 0;

298 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

300  
»t
;

301 
	}
}

303 
__u32
 
	$jbd2_checksum_d©a
(
__u32
 
üc32_sum
, 
bufãr_h—d
 *
bh
)

305 
·ge
 *·gğ
bh
->
b_·ge
;

306 *
addr
;

307 
__u32
 
checksum
;

309 
addr
 = 
	`km­_©omic
(
·ge
);

310 
checksum
 = 
	`üc32_be
(
üc32_sum
,

311 (*)(
addr
 + 
	`off£t_š_·ge
(
bh
->
b_d©a
)), bh->
b_size
);

312 
	`kunm­_©omic
(
addr
);

314  
checksum
;

315 
	}
}

317 
	$wr™e_g_block
(
jouº®_t
 *
j
, 
jouº®_block_g_t
 *
g
,

318 
block
)

320 
g
->
t_blockÄ
 = 
	`ıu_to_be32
(
block
 & (
u32
)~0);

321 ià(
	`jbd2_has_ã©u»_64b™
(
j
))

322 
g
->
t_blockÄ_high
 = 
	`ıu_to_be32
((
block
 >> 31) >> 1);

323 
	}
}

325 
	$jbd2_block_g_csum_£t
(
jouº®_t
 *
j
, 
jouº®_block_g_t
 *
g
,

326 
bufãr_h—d
 *
bh
, 
__u32
 
£qu’û
)

328 
jouº®_block_g3_t
 *
g3
 = (jouº®_block_g3_ˆ*)
g
;

329 
·ge
 *·gğ
bh
->
b_·ge
;

330 
__u8
 *
addr
;

331 
__u32
 
csum32
;

332 
__be32
 
£q
;

334 ià(!
	`jbd2_jouº®_has_csum_v2Ü3
(
j
))

337 
£q
 = 
	`ıu_to_be32
(
£qu’û
);

338 
addr
 = 
	`km­_©omic
(
·ge
);

339 
csum32
 = 
	`jbd2_chksum
(
j
, j->
j_csum_£ed
, (
__u8
 *)&
£q
, (seq));

340 
csum32
 = 
	`jbd2_chksum
(
j
, csum32, 
addr
 + 
	`off£t_š_·ge
(
bh
->
b_d©a
),

341 
bh
->
b_size
);

342 
	`kunm­_©omic
(
addr
);

344 ià(
	`jbd2_has_ã©u»_csum3
(
j
))

345 
g3
->
t_checksum
 = 
	`ıu_to_be32
(
csum32
);

347 
g
->
t_checksum
 = 
	`ıu_to_be16
(
csum32
);

348 
	}
}

355 
	$jbd2_jouº®_comm™_Œª§ùiÚ
(
jouº®_t
 *
jouº®
)

357 
Œª§ùiÚ_¡©s_s
 
¡©s
;

358 
Œª§ùiÚ_t
 *
comm™_Œª§ùiÚ
;

359 
jouº®_h—d
 *
jh
;

360 
bufãr_h—d
 *
desütÜ
;

361 
bufãr_h—d
 **
wbuf
 = 
jouº®
->
j_wbuf
;

362 
bufs
;

363 
æags
;

364 
”r
;

365 
blockÄ
;

366 
ktime_t
 
¡¬t_time
;

367 
u64
 
comm™_time
;

368 *
gp
 = 
NULL
;

369 
jouº®_block_g_t
 *
g
 = 
NULL
;

370 
¥aû_Ëá
 = 0;

371 
fœ¡_g
 = 0;

372 
g_æag
;

373 
i
;

374 
g_by‹s
 = 
	`jouº®_g_by‹s
(
jouº®
);

375 
bufãr_h—d
 *
cbh
 = 
NULL
;

376 
__u32
 
üc32_sum
 = ~0;

377 
blk_¶ug
 
¶ug
;

379 
fœ¡_block
;

380 
tid_t
 
fœ¡_tid
;

381 
upd©e_
;

382 
csum_size
 = 0;

383 
	`LIST_HEAD
(
io_bufs
);

384 
	`LIST_HEAD
(
log_bufs
);

386 ià(
	`jbd2_jouº®_has_csum_v2Ü3
(
jouº®
))

387 
csum_size
 = (
jbd2_jouº®_block_
);

395 ià(
jouº®
->
j_æags
 & 
JBD2_FLUSHED
) {

396 
	`jbd_debug
(3, "super block updated\n");

397 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

404 
	`jbd2_jouº®_upd©e_sb_log_
(
jouº®
,

405 
jouº®
->
j__£qu’û
,

406 
jouº®
->
j_
,

407 
REQ_SYNC
);

408 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

410 
	`jbd_debug
(3, "superblock‚ot updated\n");

413 
	`J_ASSERT
(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 !ğ
NULL
);

414 
	`J_ASSERT
(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 =ğ
NULL
);

416 
comm™_Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

418 
	`Œaû_jbd2_¡¬t_comm™
(
jouº®
, 
comm™_Œª§ùiÚ
);

419 
	`jbd_debug
(1, "JBD2: starting commit ofransaction %d\n",

420 
comm™_Œª§ùiÚ
->
t_tid
);

422 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

423 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_¡©e
 =ğ
T_RUNNING
);

424 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_LOCKED
;

426 
	`Œaû_jbd2_comm™_lockšg
(
jouº®
, 
comm™_Œª§ùiÚ
);

427 
¡©s
.
run
.
rs_wa™
 = 
comm™_Œª§ùiÚ
->
t_max_wa™
;

428 
¡©s
.
run
.
rs_»que¡_d–ay
 = 0;

429 
¡©s
.
run
.
rs_locked
 = 
jiff›s
;

430 ià(
comm™_Œª§ùiÚ
->
t_»que¡ed
)

431 
¡©s
.
run
.
rs_»que¡_d–ay
 =

432 
	`jbd2_time_diff
(
comm™_Œª§ùiÚ
->
t_»que¡ed
,

433 
¡©s
.
run
.
rs_locked
);

434 
¡©s
.
run
.
rs_ruÂšg
 = 
	`jbd2_time_diff
(
comm™_Œª§ùiÚ
->
t_¡¬t
,

435 
¡©s
.
run
.
rs_locked
);

437 
	`¥š_lock
(&
comm™_Œª§ùiÚ
->
t_hªdË_lock
);

438 
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_upd©es
)) {

439 
	`DEFINE_WAIT
(
wa™
);

441 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
,

442 
TASK_UNINTERRUPTIBLE
);

443 ià(
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_upd©es
)) {

444 
	`¥š_uÆock
(&
comm™_Œª§ùiÚ
->
t_hªdË_lock
);

445 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

446 
	`scheduË
();

447 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

448 
	`¥š_lock
(&
comm™_Œª§ùiÚ
->
t_hªdË_lock
);

450 
	`fšish_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
);

452 
	`¥š_uÆock
(&
comm™_Œª§ùiÚ
->
t_hªdË_lock
);

453 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_SWITCH
;

454 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

456 
	`J_ASSERT
 (
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
) <=

457 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
);

475 
comm™_Œª§ùiÚ
->
t_»£rved_li¡
) {

476 
jh
 = 
comm™_Œª§ùiÚ
->
t_»£rved_li¡
;

477 
	`JBUFFER_TRACE
(
jh
, "reserved, unused:„efile");

482 ià(
jh
->
b_comm™‹d_d©a
) {

483 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

485 
	`jbd_lock_bh_¡©e
(
bh
);

486 
	`jbd2_ä“
(
jh
->
b_comm™‹d_d©a
, 
bh
->
b_size
);

487 
jh
->
b_comm™‹d_d©a
 = 
NULL
;

488 
	`jbd_uÆock_bh_¡©e
(
bh
);

490 
	`jbd2_jouº®_»fe_bufãr
(
jouº®
, 
jh
);

498 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

499 
	`__jbd2_jouº®_ş—n_checkpošt_li¡
(
jouº®
, 
çl£
);

500 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

502 
	`jbd_debug
(3, "JBD2: commit…hase 1\n");

508 
	`jbd2_ş—r_bufãr_»voked_æags
(
jouº®
);

513 
	`jbd2_jouº®_sw™ch_»voke_bË
(
jouº®
);

518 
	`©omic_sub
(
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
),

519 &
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

521 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

522 
	`Œaû_jbd2_comm™_æushšg
(
jouº®
, 
comm™_Œª§ùiÚ
);

523 
¡©s
.
run
.
rs_æushšg
 = 
jiff›s
;

524 
¡©s
.
run
.
rs_locked
 = 
	`jbd2_time_diff
(stats.run.rs_locked,

525 
¡©s
.
run
.
rs_æushšg
);

527 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_FLUSH
;

528 
jouº®
->
j_comm™tšg_Œª§ùiÚ
 = 
comm™_Œª§ùiÚ
;

529 
jouº®
->
j_ruÂšg_Œª§ùiÚ
 = 
NULL
;

530 
¡¬t_time
 = 
	`ktime_g‘
();

531 
comm™_Œª§ùiÚ
->
t_log_¡¬t
 = 
jouº®
->
j_h—d
;

532 
	`wake_up
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
);

533 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

535 
	`jbd_debug
(3, "JBD2: commit…hase 2a\n");

541 
”r
 = 
	`jouº®_subm™_d©a_bufãrs
(
jouº®
, 
comm™_Œª§ùiÚ
);

542 ià(
”r
)

543 
	`jbd2_jouº®_abÜt
(
jouº®
, 
”r
);

545 
	`blk_¡¬t_¶ug
(&
¶ug
);

546 
	`jbd2_jouº®_wr™e_»voke_»cÜds
(
comm™_Œª§ùiÚ
, &
log_bufs
);

548 
	`jbd_debug
(3, "JBD2: commit…hase 2b\n");

555 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

556 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_COMMIT
;

557 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

559 
	`Œaû_jbd2_comm™_loggšg
(
jouº®
, 
comm™_Œª§ùiÚ
);

560 
¡©s
.
run
.
rs_loggšg
 = 
jiff›s
;

561 
¡©s
.
run
.
rs_æushšg
 = 
	`jbd2_time_diff
(stats.run.rs_flushing,

562 
¡©s
.
run
.
rs_loggšg
);

563 
¡©s
.
run
.
rs_blocks
 =

564 
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

565 
¡©s
.
run
.
rs_blocks_logged
 = 0;

567 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_Ä_bufãrs
 <=

568 
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
));

570 
”r
 = 0;

571 
bufs
 = 0;

572 
desütÜ
 = 
NULL
;

573 
comm™_Œª§ùiÚ
->
t_bufãrs
) {

577 
jh
 = 
comm™_Œª§ùiÚ
->
t_bufãrs
;

582 ià(
	`is_jouº®_abÜ‹d
(
jouº®
)) {

583 
	`ş—r_bufãr_jbddœty
(
	`jh2bh
(
jh
));

584 
	`JBUFFER_TRACE
(
jh
, "journal is‡borting:„efile");

585 
	`jbd2_bufãr_abÜt_Œigg”
(
jh
,

586 
jh
->
b_äoz’_d©a
 ?

587 
jh
->
b_äoz’_Œigg”s
 :

588 
jh
->
b_Œigg”s
);

589 
	`jbd2_jouº®_»fe_bufãr
(
jouº®
, 
jh
);

594 ià(!
comm™_Œª§ùiÚ
->
t_bufãrs
)

595 
¡¬t_jouº®_io
;

602 ià(!
desütÜ
) {

603 
	`J_ASSERT
 (
bufs
 == 0);

605 
	`jbd_debug
(4, "JBD2: get descriptor\n");

607 
desütÜ
 = 
	`jbd2_jouº®_g‘_desütÜ_bufãr
(

608 
comm™_Œª§ùiÚ
,

609 
JBD2_DESCRIPTOR_BLOCK
);

610 ià(!
desütÜ
) {

611 
	`jbd2_jouº®_abÜt
(
jouº®
, -
EIO
);

615 
	`jbd_debug
(4, "JBD2: got buffer %llu (%p)\n",

616 ()
desütÜ
->
b_blockÄ
,

617 
desütÜ
->
b_d©a
);

618 
gp
 = &
desütÜ
->
b_d©a
[(
jouº®_h—d”_t
)];

619 
¥aû_Ëá
 = 
desütÜ
->
b_size
 -

620 (
jouº®_h—d”_t
);

621 
fœ¡_g
 = 1;

622 
	`£t_bufãr_jwr™e
(
desütÜ
);

623 
	`£t_bufãr_dœty
(
desütÜ
);

624 
wbuf
[
bufs
++] = 
desütÜ
;

628 
	`BUFFER_TRACE
(
desütÜ
, "ph3: file‡s descriptor");

629 
	`jbd2_fe_log_bh
(&
log_bufs
, 
desütÜ
);

634 
”r
 = 
	`jbd2_jouº®_Ãxt_log_block
(
jouº®
, &
blockÄ
);

638 ià(
”r
) {

639 
	`jbd2_jouº®_abÜt
(
jouº®
, 
”r
);

648 
	`©omic_dec
(&
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

653 
	`©omic_šc
(&
	`jh2bh
(
jh
)->
b_couÁ
);

659 
	`£t_b™
(
BH_JWr™e
, &
	`jh2bh
(
jh
)->
b_¡©e
);

660 
	`JBUFFER_TRACE
(
jh
, "ph3: write metadata");

661 
æags
 = 
	`jbd2_jouº®_wr™e_m‘ad©a_bufãr
(
comm™_Œª§ùiÚ
,

662 
jh
, &
wbuf
[
bufs
], 
blockÄ
);

663 ià(
æags
 < 0) {

664 
	`jbd2_jouº®_abÜt
(
jouº®
, 
æags
);

667 
	`jbd2_fe_log_bh
(&
io_bufs
, 
wbuf
[
bufs
]);

672 
g_æag
 = 0;

673 ià(
æags
 & 1)

674 
g_æag
 |ğ
JBD2_FLAG_ESCAPE
;

675 ià(!
fœ¡_g
)

676 
g_æag
 |ğ
JBD2_FLAG_SAME_UUID
;

678 
g
 = (
jouº®_block_g_t
 *è
gp
;

679 
	`wr™e_g_block
(
jouº®
, 
g
, 
	`jh2bh
(
jh
)->
b_blockÄ
);

680 
g
->
t_æags
 = 
	`ıu_to_be16
(
g_æag
);

681 
	`jbd2_block_g_csum_£t
(
jouº®
, 
g
, 
wbuf
[
bufs
],

682 
comm™_Œª§ùiÚ
->
t_tid
);

683 
gp
 +ğ
g_by‹s
;

684 
¥aû_Ëá
 -ğ
g_by‹s
;

685 
bufs
++;

687 ià(
fœ¡_g
) {

688 
	`memıy
 (
gp
, 
jouº®
->
j_uuid
, 16);

689 
gp
 += 16;

690 
¥aû_Ëá
 -= 16;

691 
fœ¡_g
 = 0;

697 ià(
bufs
 =ğ
jouº®
->
j_wbufsize
 ||

698 
comm™_Œª§ùiÚ
->
t_bufãrs
 =ğ
NULL
 ||

699 
¥aû_Ëá
 < 
g_by‹s
 + 16 + 
csum_size
) {

701 
	`jbd_debug
(4, "JBD2: Subm™ %d IOs\n", 
bufs
);

707 
g
->
t_æags
 |ğ
	`ıu_to_be16
(
JBD2_FLAG_LAST_TAG
);

708 
¡¬t_jouº®_io
:

709 ià(
desütÜ
)

710 
	`jbd2_desütÜ_block_csum_£t
(
jouº®
,

711 
desütÜ
);

713 
i
 = 0; i < 
bufs
; i++) {

714 
bufãr_h—d
 *
bh
 = 
wbuf
[
i
];

718 ià(
	`jbd2_has_ã©u»_checksum
(
jouº®
)) {

719 
üc32_sum
 =

720 
	`jbd2_checksum_d©a
(
üc32_sum
, 
bh
);

723 
	`lock_bufãr
(
bh
);

724 
	`ş—r_bufãr_dœty
(
bh
);

725 
	`£t_bufãr_u±od©e
(
bh
);

726 
bh
->
b_’d_io
 = 
jouº®_’d_bufãr_io_sync
;

727 
	`subm™_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
, 
bh
);

729 
	`cÚd_»sched
();

730 
¡©s
.
run
.
rs_blocks_logged
 +ğ
bufs
;

734 
desütÜ
 = 
NULL
;

735 
bufs
 = 0;

739 
”r
 = 
	`jouº®_fšish_šode_d©a_bufãrs
(
jouº®
, 
comm™_Œª§ùiÚ
);

740 ià(
”r
) {

741 
	`´štk
(
KERN_WARNING


743 "Ú %s\n", 
jouº®
->
j_devÇme
);

744 ià(
jouº®
->
j_æags
 & 
JBD2_ABORT_ON_SYNCDATA_ERR
)

745 
	`jbd2_jouº®_abÜt
(
jouº®
, 
”r
);

746 
”r
 = 0;

756 
upd©e_
 =

757 
	`jbd2_jouº®_g‘_log_
(
jouº®
, &
fœ¡_tid
, &
fœ¡_block
);

759 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

760 ià(
upd©e_
) {

761 
ä“d
 = 
fœ¡_block
 - 
jouº®
->
j_
;

763 ià(
fœ¡_block
 < 
jouº®
->
j_
)

764 
ä“d
 +ğ
jouº®
->
j_Ï¡
 - jouº®->
j_fœ¡
;

766 ià(
ä“d
 < 
jouº®
->
j_maxËn
 / 4)

767 
upd©e_
 = 0;

769 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_¡©e
 =ğ
T_COMMIT
);

770 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_COMMIT_DFLUSH
;

771 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

778 ià(
comm™_Œª§ùiÚ
->
t_Ãed_d©a_æush
 &&

779 (
jouº®
->
j_fs_dev
 !ğjouº®->
j_dev
) &&

780 (
jouº®
->
j_æags
 & 
JBD2_BARRIER
))

781 
	`blkdev_issue_æush
(
jouº®
->
j_fs_dev
, 
GFP_NOFS
, 
NULL
);

784 ià(
	`jbd2_has_ã©u»_async_comm™
(
jouº®
)) {

785 
”r
 = 
	`jouº®_subm™_comm™_»cÜd
(
jouº®
, 
comm™_Œª§ùiÚ
,

786 &
cbh
, 
üc32_sum
);

787 ià(
”r
)

788 
	`__jbd2_jouº®_abÜt_h¬d
(
jouº®
);

791 
	`blk_fšish_¶ug
(&
¶ug
);

804 
	`jbd_debug
(3, "JBD2: commit…hase 3\n");

806 !
	`li¡_em±y
(&
io_bufs
)) {

807 
bufãr_h—d
 *
bh
 = 
	`li¡_’Œy
(
io_bufs
.
´ev
,

808 
bufãr_h—d
,

809 
b_assoc_bufãrs
);

811 
	`wa™_Ú_bufãr
(
bh
);

812 
	`cÚd_»sched
();

814 ià(
	`uÆik–y
(!
	`bufãr_u±od©e
(
bh
)))

815 
”r
 = -
EIO
;

816 
	`jbd2_unfe_log_bh
(
bh
);

822 
	`BUFFER_TRACE
(
bh
, "dumpingemporary bh");

823 
	`__b»l£
(
bh
);

824 
	`J_ASSERT_BH
(
bh
, 
	`©omic_»ad
(&bh->
b_couÁ
) == 0);

825 
	`ä“_bufãr_h—d
(
bh
);

828 
jh
 = 
comm™_Œª§ùiÚ
->
t_shadow_li¡
->
b_»v
;

829 
bh
 = 
	`jh2bh
(
jh
);

830 
	`ş—r_bufãr_jwr™e
(
bh
);

831 
	`J_ASSERT_BH
(
bh
, 
	`bufãr_jbddœty
(bh));

832 
	`J_ASSERT_BH
(
bh
, !
	`bufãr_shadow
(bh));

838 
	`JBUFFER_TRACE
(
jh
, "file‡s BJ_Forget");

839 
	`jbd2_jouº®_fe_bufãr
(
jh
, 
comm™_Œª§ùiÚ
, 
BJ_FÜg‘
);

840 
	`JBUFFER_TRACE
(
jh
, "brelse shadowed buffer");

841 
	`__b»l£
(
bh
);

844 
	`J_ASSERT
 (
comm™_Œª§ùiÚ
->
t_shadow_li¡
 =ğ
NULL
);

846 
	`jbd_debug
(3, "JBD2: commit…hase 4\n");

849 !
	`li¡_em±y
(&
log_bufs
)) {

850 
bufãr_h—d
 *
bh
;

852 
bh
 = 
	`li¡_’Œy
(
log_bufs
.
´ev
, 
bufãr_h—d
, 
b_assoc_bufãrs
);

853 
	`wa™_Ú_bufãr
(
bh
);

854 
	`cÚd_»sched
();

856 ià(
	`uÆik–y
(!
	`bufãr_u±od©e
(
bh
)))

857 
”r
 = -
EIO
;

859 
	`BUFFER_TRACE
(
bh
, "ph5: control buffer writeout done: unfile");

860 
	`ş—r_bufãr_jwr™e
(
bh
);

861 
	`jbd2_unfe_log_bh
(
bh
);

862 
	`__b»l£
(
bh
);

866 ià(
”r
)

867 
	`jbd2_jouº®_abÜt
(
jouº®
, 
”r
);

869 
	`jbd_debug
(3, "JBD2: commit…hase 5\n");

870 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

871 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_¡©e
 =ğ
T_COMMIT_DFLUSH
);

872 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_COMMIT_JFLUSH
;

873 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

875 ià(!
	`jbd2_has_ã©u»_async_comm™
(
jouº®
)) {

876 
”r
 = 
	`jouº®_subm™_comm™_»cÜd
(
jouº®
, 
comm™_Œª§ùiÚ
,

877 &
cbh
, 
üc32_sum
);

878 ià(
”r
)

879 
	`__jbd2_jouº®_abÜt_h¬d
(
jouº®
);

881 ià(
cbh
)

882 
”r
 = 
	`jouº®_wa™_Ú_comm™_»cÜd
(
jouº®
, 
cbh
);

883 ià(
	`jbd2_has_ã©u»_async_comm™
(
jouº®
) &&

884 
jouº®
->
j_æags
 & 
JBD2_BARRIER
) {

885 
	`blkdev_issue_æush
(
jouº®
->
j_dev
, 
GFP_NOFS
, 
NULL
);

888 ià(
”r
)

889 
	`jbd2_jouº®_abÜt
(
jouº®
, 
”r
);

896 ià(
upd©e_
)

897 
	`jbd2_upd©e_log_
(
jouº®
, 
fœ¡_tid
, 
fœ¡_block
);

904 
	`jbd_debug
(3, "JBD2: commit…hase 6\n");

906 
	`J_ASSERT
(
	`li¡_em±y
(&
comm™_Œª§ùiÚ
->
t_šode_li¡
));

907 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_bufãrs
 =ğ
NULL
);

908 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
NULL
);

909 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_shadow_li¡
 =ğ
NULL
);

911 
»¡¬t_loİ
:

916 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

917 
comm™_Œª§ùiÚ
->
t_fÜg‘
) {

918 
Œª§ùiÚ_t
 *
ı_Œª§ùiÚ
;

919 
bufãr_h—d
 *
bh
;

920 
Œy_to_ä“
 = 0;

922 
jh
 = 
comm™_Œª§ùiÚ
->
t_fÜg‘
;

923 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

924 
bh
 = 
	`jh2bh
(
jh
);

929 
	`g‘_bh
(
bh
);

930 
	`jbd_lock_bh_¡©e
(
bh
);

931 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
comm™_Œª§ùiÚ
);

946 ià(
jh
->
b_comm™‹d_d©a
) {

947 
	`jbd2_ä“
(
jh
->
b_comm™‹d_d©a
, 
bh
->
b_size
);

948 
jh
->
b_comm™‹d_d©a
 = 
NULL
;

949 ià(
jh
->
b_äoz’_d©a
) {

950 
jh
->
b_comm™‹d_d©a
 = jh->
b_äoz’_d©a
;

951 
jh
->
b_äoz’_d©a
 = 
NULL
;

952 
jh
->
b_äoz’_Œigg”s
 = 
NULL
;

954 } ià(
jh
->
b_äoz’_d©a
) {

955 
	`jbd2_ä“
(
jh
->
b_äoz’_d©a
, 
bh
->
b_size
);

956 
jh
->
b_äoz’_d©a
 = 
NULL
;

957 
jh
->
b_äoz’_Œigg”s
 = 
NULL
;

960 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

961 
ı_Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
;

962 ià(
ı_Œª§ùiÚ
) {

963 
	`JBUFFER_TRACE
(
jh
, "remove from old cpransaction");

964 
ı_Œª§ùiÚ
->
t_chp_¡©s
.
cs_drİ³d
++;

965 
	`__jbd2_jouº®_»move_checkpošt
(
jh
);

978 ià(
	`bufãr_ä“d
(
bh
)) {

994 
jh
->
b_modif›d
 = 0;

995 ià(!
jh
->
b_Ãxt_Œª§ùiÚ
) {

996 
	`ş—r_bufãr_ä“d
(
bh
);

997 
	`ş—r_bufãr_jbddœty
(
bh
);

998 
	`ş—r_bufãr_m­³d
(
bh
);

999 
	`ş—r_bufãr_Ãw
(
bh
);

1000 
	`ş—r_bufãr_»q
(
bh
);

1001 
bh
->
b_bdev
 = 
NULL
;

1005 ià(
	`bufãr_jbddœty
(
bh
)) {

1006 
	`JBUFFER_TRACE
(
jh
, "addo‚ew checkpointingrans");

1007 
	`__jbd2_jouº®_š£¹_checkpošt
(
jh
, 
comm™_Œª§ùiÚ
);

1008 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

1009 
	`ş—r_bufãr_jbddœty
(
bh
);

1011 
	`J_ASSERT_BH
(
bh
, !
	`bufãr_dœty
(bh));

1021 ià(!
jh
->
b_Ãxt_Œª§ùiÚ
)

1022 
Œy_to_ä“
 = 1;

1024 
	`JBUFFER_TRACE
(
jh
, "refile or unfile buffer");

1025 
	`__jbd2_jouº®_»fe_bufãr
(
jh
);

1026 
	`jbd_uÆock_bh_¡©e
(
bh
);

1027 ià(
Œy_to_ä“
)

1028 
	`»Ëa£_bufãr_·ge
(
bh
);

1030 
	`__b»l£
(
bh
);

1031 
	`cÚd_»sched_lock
(&
jouº®
->
j_li¡_lock
);

1033 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1040 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1041 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1046 ià(
comm™_Œª§ùiÚ
->
t_fÜg‘
) {

1047 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1048 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1049 
»¡¬t_loİ
;

1055 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 =ğ
NULL
) {

1056 
jouº®
->
j_checkpošt_Œª§ùiÚs
 = 
comm™_Œª§ùiÚ
;

1057 
comm™_Œª§ùiÚ
->
t_ıÃxt
 = commit_transaction;

1058 
comm™_Œª§ùiÚ
->
t_ı´ev
 = commit_transaction;

1060 
comm™_Œª§ùiÚ
->
t_ıÃxt
 =

1061 
jouº®
->
j_checkpošt_Œª§ùiÚs
;

1062 
comm™_Œª§ùiÚ
->
t_ı´ev
 =

1063 
comm™_Œª§ùiÚ
->
t_ıÃxt
->
t_ı´ev
;

1064 
comm™_Œª§ùiÚ
->
t_ıÃxt
->
t_ı´ev
 =

1065 
comm™_Œª§ùiÚ
;

1066 
comm™_Œª§ùiÚ
->
t_ı´ev
->
t_ıÃxt
 =

1067 
comm™_Œª§ùiÚ
;

1069 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1073 
	`jbd_debug
(3, "JBD2: commit…hase 7\n");

1075 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_¡©e
 =ğ
T_COMMIT_JFLUSH
);

1077 
comm™_Œª§ùiÚ
->
t_¡¬t
 = 
jiff›s
;

1078 
¡©s
.
run
.
rs_loggšg
 = 
	`jbd2_time_diff
(stats.run.rs_logging,

1079 
comm™_Œª§ùiÚ
->
t_¡¬t
);

1084 
¡©s
.
ts_tid
 = 
comm™_Œª§ùiÚ
->
t_tid
;

1085 
¡©s
.
run
.
rs_hªdË_couÁ
 =

1086 
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_hªdË_couÁ
);

1087 
	`Œaû_jbd2_run_¡©s
(
jouº®
->
j_fs_dev
->
bd_dev
,

1088 
comm™_Œª§ùiÚ
->
t_tid
, &
¡©s
.
run
);

1089 
¡©s
.
ts_»que¡ed
 = (
comm™_Œª§ùiÚ
->
t_»que¡ed
) ? 1 : 0;

1091 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_COMMIT_CALLBACK
;

1092 
	`J_ASSERT
(
comm™_Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

1093 
jouº®
->
j_comm™_£qu’û
 = 
comm™_Œª§ùiÚ
->
t_tid
;

1094 
jouº®
->
j_comm™tšg_Œª§ùiÚ
 = 
NULL
;

1095 
comm™_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_g‘
(), 
¡¬t_time
));

1101 ià(
	`lik–y
(
jouº®
->
j_av”age_comm™_time
))

1102 
jouº®
->
j_av”age_comm™_time
 = (
comm™_time
 +

1103 
jouº®
->
j_av”age_comm™_time
*3) / 4;

1105 
jouº®
->
j_av”age_comm™_time
 = 
comm™_time
;

1107 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1109 ià(
jouº®
->
j_comm™_ÿÎback
)

1110 
jouº®
->
	`j_comm™_ÿÎback
(jouº®, 
comm™_Œª§ùiÚ
);

1112 
	`Œaû_jbd2_’d_comm™
(
jouº®
, 
comm™_Œª§ùiÚ
);

1113 
	`jbd_debug
(1, "JBD2: commit %d complete, head %d\n",

1114 
jouº®
->
j_comm™_£qu’û
, jouº®->
j__£qu’û
);

1116 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1117 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1118 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_FINISHED
;

1120 ià(
comm™_Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
NULL
 &&

1121 
comm™_Œª§ùiÚ
->
t_checkpošt_io_li¡
 =ğ
NULL
) {

1122 
	`__jbd2_jouº®_drİ_Œª§ùiÚ
(
jouº®
, 
comm™_Œª§ùiÚ
);

1123 
	`jbd2_jouº®_ä“_Œª§ùiÚ
(
comm™_Œª§ùiÚ
);

1125 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1126 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1127 
	`wake_up
(&
jouº®
->
j_wa™_dÚe_comm™
);

1132 
	`¥š_lock
(&
jouº®
->
j_hi¡Üy_lock
);

1133 
jouº®
->
j_¡©s
.
ts_tid
++;

1134 
jouº®
->
j_¡©s
.
ts_»que¡ed
 +ğ
¡©s
.ts_requested;

1135 
jouº®
->
j_¡©s
.
run
.
rs_wa™
 +ğ
¡©s
.run.rs_wait;

1136 
jouº®
->
j_¡©s
.
run
.
rs_»que¡_d–ay
 +ğ
¡©s
.run.rs_request_delay;

1137 
jouº®
->
j_¡©s
.
run
.
rs_ruÂšg
 +ğ
¡©s
.run.rs_running;

1138 
jouº®
->
j_¡©s
.
run
.
rs_locked
 +ğ
¡©s
.run.rs_locked;

1139 
jouº®
->
j_¡©s
.
run
.
rs_æushšg
 +ğ
¡©s
.run.rs_flushing;

1140 
jouº®
->
j_¡©s
.
run
.
rs_loggšg
 +ğ
¡©s
.run.rs_logging;

1141 
jouº®
->
j_¡©s
.
run
.
rs_hªdË_couÁ
 +ğ
¡©s
.run.rs_handle_count;

1142 
jouº®
->
j_¡©s
.
run
.
rs_blocks
 +ğ
¡©s
.run.rs_blocks;

1143 
jouº®
->
j_¡©s
.
run
.
rs_blocks_logged
 +ğ
¡©s
.run.rs_blocks_logged;

1144 
	`¥š_uÆock
(&
jouº®
->
j_hi¡Üy_lock
);

1145 
	}
}

	@jbd3/journal.c

22 
	~<lšux/moduË.h
>

23 
	~<lšux/time.h
>

24 
	~<lšux/fs.h
>

25 
	~<lšux/jbd2.h
>

26 
	~<lšux/”ºo.h
>

27 
	~<lšux/¦ab.h
>

28 
	~<lšux/š™.h
>

29 
	~<lšux/mm.h
>

30 
	~<lšux/ä“z”.h
>

31 
	~<lšux/·gem­.h
>

32 
	~<lšux/kth»ad.h
>

33 
	~<lšux/poisÚ.h
>

34 
	~<lšux/´oc_fs.h
>

35 
	~<lšux/£q_fe.h
>

36 
	~<lšux/m©h64.h
>

37 
	~<lšux/hash.h
>

38 
	~<lšux/log2.h
>

39 
	~<lšux/vm®loc.h
>

40 
	~<lšux/backšg-dev.h
>

41 
	~<lšux/b™İs.h
>

42 
	~<lšux/¿‹lim™.h
>

43 
	~<lšux/sched/mm.h
>

45 
	#CREATE_TRACE_POINTS


	)

46 
	~<Œaû/ev’ts/jbd2.h
>

48 
	~<lšux/uacûss.h
>

49 
	~<asm/·ge.h
>

51 #ifdeà
CONFIG_JBD2_DEBUG


52 
ushÜt
 
jbd2_jouº®_’abË_debug
 
	g__»ad_mo¡ly
;

53 
EXPORT_SYMBOL
(
jbd2_jouº®_’abË_debug
);

55 
moduË_·¿m_Çmed
(
jbd2_debug
, 
jbd2_jouº®_’abË_debug
, 
ushÜt
, 0644);

56 
MODULE_PARM_DESC
(
jbd2_debug
, "Debugging†evel for jbd2");

59 
EXPORT_SYMBOL
(
jbd2_jouº®_ex‹nd
);

60 
EXPORT_SYMBOL
(
jbd2_jouº®_¡İ
);

61 
EXPORT_SYMBOL
(
jbd2_jouº®_lock_upd©es
);

62 
EXPORT_SYMBOL
(
jbd2_jouº®_uÆock_upd©es
);

63 
EXPORT_SYMBOL
(
jbd2_jouº®_g‘_wr™e_acûss
);

64 
EXPORT_SYMBOL
(
jbd2_jouº®_g‘_ü—‹_acûss
);

65 
EXPORT_SYMBOL
(
jbd2_jouº®_g‘_undo_acûss
);

66 
EXPORT_SYMBOL
(
jbd2_jouº®_£t_Œigg”s
);

67 
EXPORT_SYMBOL
(
jbd2_jouº®_dœty_m‘ad©a
);

68 
EXPORT_SYMBOL
(
jbd2_jouº®_fÜg‘
);

69 
EXPORT_SYMBOL
(
jbd2_jouº®_æush
);

70 
EXPORT_SYMBOL
(
jbd2_jouº®_»voke
);

72 
EXPORT_SYMBOL
(
jbd2_jouº®_š™_dev
);

73 
EXPORT_SYMBOL
(
jbd2_jouº®_š™_šode
);

74 
EXPORT_SYMBOL
(
jbd2_jouº®_check_u£d_ã©u»s
);

75 
EXPORT_SYMBOL
(
jbd2_jouº®_check_avaabË_ã©u»s
);

76 
EXPORT_SYMBOL
(
jbd2_jouº®_£t_ã©u»s
);

77 
EXPORT_SYMBOL
(
jbd2_jouº®_lßd
);

78 
EXPORT_SYMBOL
(
jbd2_jouº®_de¡roy
);

79 
EXPORT_SYMBOL
(
jbd2_jouº®_abÜt
);

80 
EXPORT_SYMBOL
(
jbd2_jouº®_”ºo
);

81 
EXPORT_SYMBOL
(
jbd2_jouº®_ack_”r
);

82 
EXPORT_SYMBOL
(
jbd2_jouº®_ş—r_”r
);

83 
EXPORT_SYMBOL
(
jbd2_log_wa™_comm™
);

84 
EXPORT_SYMBOL
(
jbd2_log_¡¬t_comm™
);

85 
EXPORT_SYMBOL
(
jbd2_jouº®_¡¬t_comm™
);

86 
EXPORT_SYMBOL
(
jbd2_jouº®_fÜû_comm™_Ã¡ed
);

87 
EXPORT_SYMBOL
(
jbd2_jouº®_we
);

88 
EXPORT_SYMBOL
(
jbd2_jouº®_blocks_³r_·ge
);

89 
EXPORT_SYMBOL
(
jbd2_jouº®_šv®id©•age
);

90 
EXPORT_SYMBOL
(
jbd2_jouº®_Œy_to_ä“_bufãrs
);

91 
EXPORT_SYMBOL
(
jbd2_jouº®_fÜû_comm™
);

92 
EXPORT_SYMBOL
(
jbd2_jouº®_šode_¿nged_wr™e
);

93 
EXPORT_SYMBOL
(
jbd2_jouº®_šode_¿nged_wa™
);

94 
EXPORT_SYMBOL
(
jbd2_jouº®_š™_jbd_šode
);

95 
EXPORT_SYMBOL
(
jbd2_jouº®_»Ëa£_jbd_šode
);

96 
EXPORT_SYMBOL
(
jbd2_jouº®_begš_Üd”ed_Œunÿ‹
);

97 
EXPORT_SYMBOL
(
jbd2_šode_ÿche
);

99 
__jouº®_abÜt_soá
 (
jouº®_t
 *
jouº®
, 
”ºo
);

100 
jbd2_jouº®_ü—‹_¦ab
(
size_t
 
¦ab_size
);

102 #ifdeà
CONFIG_JBD2_DEBUG


103 
	$__jbd2_debug
(
Ëv–
, cÚ¡ *
fe
, cÚ¡ *
func
,

104 
lše
, cÚ¡ *
fmt
, ...)

106 
va_fÜm©
 
vaf
;

107 
va_li¡
 
¬gs
;

109 ià(
Ëv–
 > 
jbd2_jouº®_’abË_debug
)

111 
	`va_¡¬t
(
¬gs
, 
fmt
);

112 
vaf
.
fmt
 = fmt;

113 
vaf
.
va
 = &
¬gs
;

114 
	`´štk
(
KERN_DEBUG
 "%s: (%s, %u): %pV", 
fe
, 
func
, 
lše
, &
vaf
);

115 
	`va_’d
(
¬gs
);

116 
	}
}

117 
EXPORT_SYMBOL
(
__jbd2_debug
);

121 
	$jbd2_v”ify_csum_ty³
(
jouº®_t
 *
j
, 
jouº®_su³rblock_t
 *
sb
)

123 ià(!
	`jbd2_jouº®_has_csum_v2Ü3_ã©u»
(
j
))

126  
sb
->
s_checksum_ty³
 =ğ
JBD2_CRC32C_CHKSUM
;

127 
	}
}

129 
__be32
 
	$jbd2_su³rblock_csum
(
jouº®_t
 *
j
, 
jouº®_su³rblock_t
 *
sb
)

131 
__u32
 
csum
;

132 
__be32
 
Şd_csum
;

134 
Şd_csum
 = 
sb
->
s_checksum
;

135 
sb
->
s_checksum
 = 0;

136 
csum
 = 
	`jbd2_chksum
(
j
, ~0, (*)
sb
, (
jouº®_su³rblock_t
));

137 
sb
->
s_checksum
 = 
Şd_csum
;

139  
	`ıu_to_be32
(
csum
);

140 
	}
}

146 
	$comm™_timeout
(
tim”_li¡
 *
t
)

148 
jouº®_t
 *
jouº®
 = 
	`äom_tim”
(jouº®, 
t
, 
j_comm™_tim”
);

150 
	`wake_up_´oûss
(
jouº®
->
j_sk
);

151 
	}
}

169 
	$kjouº®d2
(*
¬g
)

171 
jouº®_t
 *
jouº®
 = 
¬g
;

172 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

178 
	`tim”_£tup
(&
jouº®
->
j_comm™_tim”
, 
comm™_timeout
, 0);

180 
	`£t_ä“zabË
();

183 
jouº®
->
j_sk
 = 
cu¼’t
;

184 
	`wake_up
(&
jouº®
->
j_wa™_dÚe_comm™
);

192 
	`mem®loc_nofs_§ve
();

197 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

199 
loİ
:

200 ià(
jouº®
->
j_æags
 & 
JBD2_UNMOUNT
)

201 
’d_loİ
;

203 
	`jbd_debug
(1, "commit_sequence=%u, commit_request=%u\n",

204 
jouº®
->
j_comm™_£qu’û
, jouº®->
j_comm™_»que¡
);

206 ià(
jouº®
->
j_comm™_£qu’û
 !ğjouº®->
j_comm™_»que¡
) {

207 
	`jbd_debug
(1, "OK,„equests differ\n");

208 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

209 
	`d–_tim”_sync
(&
jouº®
->
j_comm™_tim”
);

210 
	`jbd2_jouº®_comm™_Œª§ùiÚ
(
jouº®
);

211 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

212 
loİ
;

215 
	`wake_up
(&
jouº®
->
j_wa™_dÚe_comm™
);

216 ià(
	`ä“zšg
(
cu¼’t
)) {

222 
	`jbd_debug
(1, "Now suspending kjournald2\n");

223 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

224 
	`Œy_to_ä“ze
();

225 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

231 
	`DEFINE_WAIT
(
wa™
);

232 
should_¦“p
 = 1;

234 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_comm™
, &
wa™
,

235 
TASK_INTERRUPTIBLE
);

236 ià(
jouº®
->
j_comm™_£qu’û
 !ğjouº®->
j_comm™_»que¡
)

237 
should_¦“p
 = 0;

238 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

239 ià(
Œª§ùiÚ
 && 
	`time_aá”_eq
(
jiff›s
,

240 
Œª§ùiÚ
->
t_expœes
))

241 
should_¦“p
 = 0;

242 ià(
jouº®
->
j_æags
 & 
JBD2_UNMOUNT
)

243 
should_¦“p
 = 0;

244 ià(
should_¦“p
) {

245 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

246 
	`scheduË
();

247 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

249 
	`fšish_wa™
(&
jouº®
->
j_wa™_comm™
, &
wa™
);

252 
	`jbd_debug
(1, "kjournald2 wakes\n");

257 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

258 ià(
Œª§ùiÚ
 && 
	`time_aá”_eq
(
jiff›s
,¿n§ùiÚ->
t_expœes
)) {

259 
jouº®
->
j_comm™_»que¡
 = 
Œª§ùiÚ
->
t_tid
;

260 
	`jbd_debug
(1, "woke because ofimeout\n");

262 
loİ
;

264 
’d_loİ
:

265 
	`d–_tim”_sync
(&
jouº®
->
j_comm™_tim”
);

266 
jouº®
->
j_sk
 = 
NULL
;

267 
	`wake_up
(&
jouº®
->
j_wa™_dÚe_comm™
);

268 
	`jbd_debug
(1, "Journalhreadƒxiting.\n");

269 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

271 
	}
}

273 
	$jbd2_jouº®_¡¬t_th»ad
(
jouº®_t
 *
jouº®
)

275 
sk_¡ruù
 *
t
;

277 
t
 = 
	`kth»ad_run
(
kjouº®d2
, 
jouº®
, "jbd2/%s",

278 
jouº®
->
j_devÇme
);

279 ià(
	`IS_ERR
(
t
))

280  
	`PTR_ERR
(
t
);

282 
	`wa™_ev’t
(
jouº®
->
j_wa™_dÚe_comm™
, jouº®->
j_sk
 !ğ
NULL
);

284 
	}
}

286 
	$jouº®_kl_th»ad
(
jouº®_t
 *
jouº®
)

288 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

289 
jouº®
->
j_æags
 |ğ
JBD2_UNMOUNT
;

291 
jouº®
->
j_sk
) {

292 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

293 
	`wake_up
(&
jouº®
->
j_wa™_comm™
);

294 
	`wa™_ev’t
(
jouº®
->
j_wa™_dÚe_comm™
, jouº®->
j_sk
 =ğ
NULL
);

295 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

297 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

298 
	}
}

335 
	$jbd2_jouº®_wr™e_m‘ad©a_bufãr
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
,

336 
jouº®_h—d
 *
jh_š
,

337 
bufãr_h—d
 **
bh_out
,

338 
£ùÜ_t
 
blockÄ
)

340 
Ãed_cİy_out
 = 0;

341 
dÚe_cİy_out
 = 0;

342 
do_esÿ³
 = 0;

343 *
m­³d_d©a
;

344 
bufãr_h—d
 *
Ãw_bh
;

345 
·ge
 *
Ãw_·ge
;

346 
Ãw_off£t
;

347 
bufãr_h—d
 *
bh_š
 = 
	`jh2bh
(
jh_š
);

348 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

359 
	`J_ASSERT_BH
(
bh_š
, 
	`bufãr_jbddœty
(bh_in));

361 
Ãw_bh
 = 
	`®loc_bufãr_h—d
(
GFP_NOFS
|
__GFP_NOFAIL
);

364 
	`©omic_£t
(&
Ãw_bh
->
b_couÁ
, 1);

366 
	`jbd_lock_bh_¡©e
(
bh_š
);

367 
»³©
:

372 ià(
jh_š
->
b_äoz’_d©a
) {

373 
dÚe_cİy_out
 = 1;

374 
Ãw_·ge
 = 
	`vœt_to_·ge
(
jh_š
->
b_äoz’_d©a
);

375 
Ãw_off£t
 = 
	`off£t_š_·ge
(
jh_š
->
b_äoz’_d©a
);

377 
Ãw_·ge
 = 
	`jh2bh
(
jh_š
)->
b_·ge
;

378 
Ãw_off£t
 = 
	`off£t_š_·ge
(
	`jh2bh
(
jh_š
)->
b_d©a
);

381 
m­³d_d©a
 = 
	`km­_©omic
(
Ãw_·ge
);

388 ià(!
dÚe_cİy_out
)

389 
	`jbd2_bufãr_äoz’_Œigg”
(
jh_š
, 
m­³d_d©a
 + 
Ãw_off£t
,

390 
jh_š
->
b_Œigg”s
);

395 ià(*((
__be32
 *)(
m­³d_d©a
 + 
Ãw_off£t
)) ==

396 
	`ıu_to_be32
(
JBD2_MAGIC_NUMBER
)) {

397 
Ãed_cİy_out
 = 1;

398 
do_esÿ³
 = 1;

400 
	`kunm­_©omic
(
m­³d_d©a
);

405 ià(
Ãed_cİy_out
 && !
dÚe_cİy_out
) {

406 *
tmp
;

408 
	`jbd_uÆock_bh_¡©e
(
bh_š
);

409 
tmp
 = 
	`jbd2_®loc
(
bh_š
->
b_size
, 
GFP_NOFS
);

410 ià(!
tmp
) {

411 
	`b»l£
(
Ãw_bh
);

412  -
ENOMEM
;

414 
	`jbd_lock_bh_¡©e
(
bh_š
);

415 ià(
jh_š
->
b_äoz’_d©a
) {

416 
	`jbd2_ä“
(
tmp
, 
bh_š
->
b_size
);

417 
»³©
;

420 
jh_š
->
b_äoz’_d©a
 = 
tmp
;

421 
m­³d_d©a
 = 
	`km­_©omic
(
Ãw_·ge
);

422 
	`memıy
(
tmp
, 
m­³d_d©a
 + 
Ãw_off£t
, 
bh_š
->
b_size
);

423 
	`kunm­_©omic
(
m­³d_d©a
);

425 
Ãw_·ge
 = 
	`vœt_to_·ge
(
tmp
);

426 
Ãw_off£t
 = 
	`off£t_š_·ge
(
tmp
);

427 
dÚe_cİy_out
 = 1;

434 
jh_š
->
b_äoz’_Œigg”s
 = jh_š->
b_Œigg”s
;

441 ià(
do_esÿ³
) {

442 
m­³d_d©a
 = 
	`km­_©omic
(
Ãw_·ge
);

443 *((*)(
m­³d_d©a
 + 
Ãw_off£t
)) = 0;

444 
	`kunm­_©omic
(
m­³d_d©a
);

447 
	`£t_bh_·ge
(
Ãw_bh
, 
Ãw_·ge
, 
Ãw_off£t
);

448 
Ãw_bh
->
b_size
 = 
bh_š
->b_size;

449 
Ãw_bh
->
b_bdev
 = 
jouº®
->
j_dev
;

450 
Ãw_bh
->
b_blockÄ
 = 
blockÄ
;

451 
Ãw_bh
->
b_´iv©e
 = 
bh_š
;

452 
	`£t_bufãr_m­³d
(
Ãw_bh
);

453 
	`£t_bufãr_dœty
(
Ãw_bh
);

455 *
bh_out
 = 
Ãw_bh
;

462 
	`JBUFFER_TRACE
(
jh_š
, "file‡s BJ_Shadow");

463 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

464 
	`__jbd2_jouº®_fe_bufãr
(
jh_š
, 
Œª§ùiÚ
, 
BJ_Shadow
);

465 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

466 
	`£t_bufãr_shadow
(
bh_š
);

467 
	`jbd_uÆock_bh_¡©e
(
bh_š
);

469  
do_esÿ³
 | (
dÚe_cİy_out
 << 1);

470 
	}
}

481 
	$__jbd2_log_¡¬t_comm™
(
jouº®_t
 *
jouº®
, 
tid_t
 
rg‘
)

484 ià(
jouº®
->
j_comm™_»que¡
 =ğ
rg‘
)

492 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 &&

493 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 =ğ
rg‘
) {

499 
jouº®
->
j_comm™_»que¡
 = 
rg‘
;

500 
	`jbd_debug
(1, "JBD2:„equesting commit %u/%u\n",

501 
jouº®
->
j_comm™_»que¡
,

502 
jouº®
->
j_comm™_£qu’û
);

503 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_»que¡ed
 = 
jiff›s
;

504 
	`wake_up
(&
jouº®
->
j_wa™_comm™
);

506 } ià(!
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
rg‘
))

510 
	`WARN_ONCE
(1, "JBD2: bad†og_start_commit: %u %u %u %u\n",

511 
jouº®
->
j_comm™_»que¡
,

512 
jouº®
->
j_comm™_£qu’û
,

513 
rg‘
, 
jouº®
->
j_ruÂšg_Œª§ùiÚ
 ?

514 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 : 0);

516 
	}
}

518 
	$jbd2_log_¡¬t_comm™
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

520 
»t
;

522 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

523 
»t
 = 
	`__jbd2_log_¡¬t_comm™
(
jouº®
, 
tid
);

524 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

525  
»t
;

526 
	}
}

535 
	$__jbd2_jouº®_fÜû_comm™
(
jouº®_t
 *
jouº®
)

537 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
NULL
;

538 
tid_t
 
tid
;

539 
Ãed_to_¡¬t
 = 0, 
»t
 = 0;

541 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

542 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 && !
cu¼’t
->
jouº®_šfo
) {

543 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

544 ià(!
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
Œª§ùiÚ
->
t_tid
))

545 
Ãed_to_¡¬t
 = 1;

546 } ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
)

547 
Œª§ùiÚ
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

549 ià(!
Œª§ùiÚ
) {

551 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

554 
tid
 = 
Œª§ùiÚ
->
t_tid
;

555 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

556 ià(
Ãed_to_¡¬t
)

557 
	`jbd2_log_¡¬t_comm™
(
jouº®
, 
tid
);

558 
»t
 = 
	`jbd2_log_wa™_comm™
(
jouº®
, 
tid
);

559 ià(!
»t
)

560 
»t
 = 1;

562  
»t
;

563 
	}
}

573 
	$jbd2_jouº®_fÜû_comm™_Ã¡ed
(
jouº®_t
 *
jouº®
)

575 
»t
;

577 
»t
 = 
	`__jbd2_jouº®_fÜû_comm™
(
jouº®
);

578  
»t
 > 0;

579 
	}
}

588 
	$jbd2_jouº®_fÜû_comm™
(
jouº®_t
 *
jouº®
)

590 
»t
;

592 
	`J_ASSERT
(!
cu¼’t
->
jouº®_šfo
);

593 
»t
 = 
	`__jbd2_jouº®_fÜû_comm™
(
jouº®
);

594 ià(
»t
 > 0)

595 
»t
 = 0;

596  
»t
;

597 
	}
}

604 
	$jbd2_jouº®_¡¬t_comm™
(
jouº®_t
 *
jouº®
, 
tid_t
 *
±id
)

606 
»t
 = 0;

608 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

609 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

610 
tid_t
 
tid
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
;

612 
	`__jbd2_log_¡¬t_comm™
(
jouº®
, 
tid
);

615 ià(
±id
)

616 *
±id
 = 
tid
;

617 
»t
 = 1;

618 } ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
) {

623 ià(
±id
)

624 *
±id
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
;

625 
»t
 = 1;

627 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

628  
»t
;

629 
	}
}

637 
	$jbd2_Œªs_wl_£nd_d©a_b¬r›r
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

639 
»t
 = 0;

640 
Œª§ùiÚ_t
 *
comm™_Œªs
;

642 ià(!(
jouº®
->
j_æags
 & 
JBD2_BARRIER
))

644 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

646 ià(
	`tid_geq
(
jouº®
->
j_comm™_£qu’û
, 
tid
))

647 
out
;

648 
comm™_Œªs
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

649 ià(!
comm™_Œªs
 || comm™_Œªs->
t_tid
 !ğ
tid
) {

650 
»t
 = 1;

651 
out
;

657 ià(
jouº®
->
j_fs_dev
 !ğjouº®->
j_dev
) {

658 ià(!
comm™_Œªs
->
t_Ãed_d©a_æush
 ||

659 
comm™_Œªs
->
t_¡©e
 >ğ
T_COMMIT_DFLUSH
)

660 
out
;

662 ià(
comm™_Œªs
->
t_¡©e
 >ğ
T_COMMIT_JFLUSH
)

663 
out
;

665 
»t
 = 1;

666 
out
:

667 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

668  
»t
;

669 
	}
}

670 
EXPORT_SYMBOL
(
jbd2_Œªs_wl_£nd_d©a_b¬r›r
);

676 
	$jbd2_log_wa™_comm™
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

678 
”r
 = 0;

680 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

681 #ifdeà
CONFIG_PROVE_LOCKING


687 ià(
	`tid_gt
(
tid
, 
jouº®
->
j_comm™_£qu’û
) &&

688 (!
jouº®
->
j_comm™tšg_Œª§ùiÚ
 ||

689 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
 !ğ
tid
)) {

690 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

691 
	`jbd2_might_wa™_fÜ_comm™
(
jouº®
);

692 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

695 #ifdeà
CONFIG_JBD2_DEBUG


696 ià(!
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
tid
)) {

697 
	`´štk
(
KERN_ERR


699 
__func__
, 
jouº®
->
j_comm™_»que¡
, 
tid
);

702 
	`tid_gt
(
tid
, 
jouº®
->
j_comm™_£qu’û
)) {

703 
	`jbd_debug
(1, "JBD2: want %u, j_commit_sequence=%u\n",

704 
tid
, 
jouº®
->
j_comm™_£qu’û
);

705 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

706 
	`wake_up
(&
jouº®
->
j_wa™_comm™
);

707 
	`wa™_ev’t
(
jouº®
->
j_wa™_dÚe_comm™
,

708 !
	`tid_gt
(
tid
, 
jouº®
->
j_comm™_£qu’û
));

709 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

711 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

713 ià(
	`uÆik–y
(
	`is_jouº®_abÜ‹d
(
jouº®
)))

714 
”r
 = -
EIO
;

715  
”r
;

716 
	}
}

719 
	$jbd2_Œª§ùiÚ_comm™‹d
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

721 
»t
 = 1;

723 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

724 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 &&

725 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 =ğ
tid
)

726 
»t
 = 0;

727 ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 &&

728 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
 =ğ
tid
)

729 
»t
 = 0;

730 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

731  
»t
;

732 
	}
}

733 
EXPORT_SYMBOL
(
jbd2_Œª§ùiÚ_comm™‹d
);

742 
	$jbd2_com¶‘e_Œª§ùiÚ
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

744 
Ãed_to_wa™
 = 1;

746 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

747 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 &&

748 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 =ğ
tid
) {

749 ià(
jouº®
->
j_comm™_»que¡
 !ğ
tid
) {

751 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

752 
	`jbd2_log_¡¬t_comm™
(
jouº®
, 
tid
);

753 
wa™_comm™
;

755 } ià(!(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 &&

756 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
 =ğ
tid
))

757 
Ãed_to_wa™
 = 0;

758 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

759 ià(!
Ãed_to_wa™
)

761 
wa™_comm™
:

762  
	`jbd2_log_wa™_comm™
(
jouº®
, 
tid
);

763 
	}
}

764 
EXPORT_SYMBOL
(
jbd2_com¶‘e_Œª§ùiÚ
);

770 
	$jbd2_jouº®_Ãxt_log_block
(
jouº®_t
 *
jouº®
, *
»
)

772 
blockÄ
;

774 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

775 
	`J_ASSERT
(
jouº®
->
j_ä“
 > 1);

777 
blockÄ
 = 
jouº®
->
j_h—d
;

778 
jouº®
->
j_h—d
++;

779 
jouº®
->
j_ä“
--;

780 ià(
jouº®
->
j_h—d
 =ğjouº®->
j_Ï¡
)

781 
jouº®
->
j_h—d
 = jouº®->
j_fœ¡
;

782 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

783  
	`jbd2_jouº®_bm­
(
jouº®
, 
blockÄ
, 
»
);

784 
	}
}

793 
	$jbd2_jouº®_bm­
(
jouº®_t
 *
jouº®
, 
blockÄ
,

794 *
»
)

796 
”r
 = 0;

797 
»t
;

799 ià(
jouº®
->
j_šode
) {

800 
»t
 = 
	`bm­
(
jouº®
->
j_šode
, 
blockÄ
);

801 ià(
»t
)

802 *
»
 = 
»t
;

804 
	`´štk
(
KERN_ALERT
 "%s: journal block‚ot found "

806 
__func__
, 
blockÄ
, 
jouº®
->
j_devÇme
);

807 
”r
 = -
EIO
;

808 
	`__jouº®_abÜt_soá
(
jouº®
, 
”r
);

811 *
»
 = 
blockÄ
;

813  
”r
;

814 
	}
}

826 
bufãr_h—d
 *

827 
	$jbd2_jouº®_g‘_desütÜ_bufãr
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
, 
ty³
)

829 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

830 
bufãr_h—d
 *
bh
;

831 
blockÄ
;

832 
jouº®_h—d”_t
 *
h—d”
;

833 
”r
;

835 
”r
 = 
	`jbd2_jouº®_Ãxt_log_block
(
jouº®
, &
blockÄ
);

837 ià(
”r
)

838  
NULL
;

840 
bh
 = 
	`__g‘blk
(
jouº®
->
j_dev
, 
blockÄ
, jouº®->
j_blocksize
);

841 ià(!
bh
)

842  
NULL
;

843 
	`lock_bufãr
(
bh
);

844 
	`mem£t
(
bh
->
b_d©a
, 0, 
jouº®
->
j_blocksize
);

845 
h—d”
 = (
jouº®_h—d”_t
 *)
bh
->
b_d©a
;

846 
h—d”
->
h_magic
 = 
	`ıu_to_be32
(
JBD2_MAGIC_NUMBER
);

847 
h—d”
->
h_blockty³
 = 
	`ıu_to_be32
(
ty³
);

848 
h—d”
->
h_£qu’û
 = 
	`ıu_to_be32
(
Œª§ùiÚ
->
t_tid
);

849 
	`£t_bufãr_u±od©e
(
bh
);

850 
	`uÆock_bufãr
(
bh
);

851 
	`BUFFER_TRACE
(
bh
, "returnhis buffer");

852  
bh
;

853 
	}
}

855 
	$jbd2_desütÜ_block_csum_£t
(
jouº®_t
 *
j
, 
bufãr_h—d
 *
bh
)

857 
jbd2_jouº®_block_
 *

;

858 
__u32
 
csum
;

860 ià(!
	`jbd2_jouº®_has_csum_v2Ü3
(
j
))

863 

 = (
jbd2_jouº®_block_
 *)(
bh
->
b_d©a
 + 
j
->
j_blocksize
 -

864 (
jbd2_jouº®_block_
));

865 

->
t_checksum
 = 0;

866 
csum
 = 
	`jbd2_chksum
(
j
, j->
j_csum_£ed
, 
bh
->
b_d©a
, j->
j_blocksize
);

867 

->
t_checksum
 = 
	`ıu_to_be32
(
csum
);

868 
	}
}

880 
	$jbd2_jouº®_g‘_log_
(
jouº®_t
 *
jouº®
, 
tid_t
 *
tid
,

881 *
block
)

883 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

884 
»t
;

886 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

887 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

888 
Œª§ùiÚ
 = 
jouº®
->
j_checkpošt_Œª§ùiÚs
;

889 ià(
Œª§ùiÚ
) {

890 *
tid
 = 
Œª§ùiÚ
->
t_tid
;

891 *
block
 = 
Œª§ùiÚ
->
t_log_¡¬t
;

892 } ià((
Œª§ùiÚ
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
è!ğ
NULL
) {

893 *
tid
 = 
Œª§ùiÚ
->
t_tid
;

894 *
block
 = 
Œª§ùiÚ
->
t_log_¡¬t
;

895 } ià((
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
è!ğ
NULL
) {

896 *
tid
 = 
Œª§ùiÚ
->
t_tid
;

897 *
block
 = 
jouº®
->
j_h—d
;

899 *
tid
 = 
jouº®
->
j_Œª§ùiÚ_£qu’û
;

900 *
block
 = 
jouº®
->
j_h—d
;

902 
»t
 = 
	`tid_gt
(*
tid
, 
jouº®
->
j__£qu’û
);

903 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

904 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

906  
»t
;

907 
	}
}

919 
	$__jbd2_upd©e_log_
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
, 
block
)

921 
ä“d
;

922 
»t
;

924 
	`BUG_ON
(!
	`mu‹x_is_locked
(&
jouº®
->
j_checkpošt_mu‹x
));

932 
»t
 = 
	`jbd2_jouº®_upd©e_sb_log_
(
jouº®
, 
tid
, 
block
,

933 
REQ_SYNC
 | 
REQ_FUA
);

934 ià(
»t
)

935 
out
;

937 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

938 
ä“d
 = 
block
 - 
jouº®
->
j_
;

939 ià(
block
 < 
jouº®
->
j_
)

940 
ä“d
 +ğ
jouº®
->
j_Ï¡
 - jouº®->
j_fœ¡
;

942 
	`Œaû_jbd2_upd©e_log_
(
jouº®
, 
tid
, 
block
, 
ä“d
);

943 
	`jbd_debug
(1,

946 
jouº®
->
j__£qu’û
, 
tid
, 
block
, 
ä“d
);

948 
jouº®
->
j_ä“
 +ğ
ä“d
;

949 
jouº®
->
j__£qu’û
 = 
tid
;

950 
jouº®
->
j_
 = 
block
;

951 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

953 
out
:

954  
»t
;

955 
	}
}

962 
	$jbd2_upd©e_log_
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
, 
block
)

964 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

965 ià(
	`tid_gt
(
tid
, 
jouº®
->
j__£qu’û
))

966 
	`__jbd2_upd©e_log_
(
jouº®
, 
tid
, 
block
);

967 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

968 
	}
}

970 
	sjbd2_¡©s_´oc_£ssiÚ
 {

971 
jouº®_t
 *
	mjouº®
;

972 
Œª§ùiÚ_¡©s_s
 *
	m¡©s
;

973 
	m¡¬t
;

974 
	mmax
;

977 *
	$jbd2_£q_šfo_¡¬t
(
£q_fe
 *
£q
, 
loff_t
 *
pos
)

979  *
pos
 ? 
NULL
 : 
SEQ_START_TOKEN
;

980 
	}
}

982 *
	$jbd2_£q_šfo_Ãxt
(
£q_fe
 *
£q
, *
v
, 
loff_t
 *
pos
)

984  
NULL
;

985 
	}
}

987 
	$jbd2_£q_šfo_show
(
£q_fe
 *
£q
, *
v
)

989 
jbd2_¡©s_´oc_£ssiÚ
 *
s
 = 
£q
->
´iv©e
;

991 ià(
v
 !ğ
SEQ_START_TOKEN
)

993 
	`£q_´štf
(
£q
, "%luransactions (%lu„equested), "

995 
s
->
¡©s
->
ts_tid
, s->¡©s->
ts_»que¡ed
,

996 
s
->
jouº®
->
j_max_Œª§ùiÚ_bufãrs
);

997 ià(
s
->
¡©s
->
ts_tid
 == 0)

999 
	`£q_´štf
(
£q
, "average: \n %ums waiting forransaction\n",

1000 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_wa™
 / s->¡©s->
ts_tid
));

1001 
	`£q_´štf
(
£q
, " %ums„equest delay\n",

1002 (
s
->
¡©s
->
ts_»que¡ed
 == 0) ? 0 :

1003 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_»que¡_d–ay
 /

1004 
s
->
¡©s
->
ts_»que¡ed
));

1005 
	`£q_´štf
(
£q
, " %ums„unningransaction\n",

1006 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_ruÂšg
 / s->¡©s->
ts_tid
));

1007 
	`£q_´štf
(
£q
, " %umsransaction was being†ocked\n",

1008 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_locked
 / s->¡©s->
ts_tid
));

1009 
	`£q_´štf
(
£q
, " %ums flushing data (in ordered mode)\n",

1010 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_æushšg
 / s->¡©s->
ts_tid
));

1011 
	`£q_´štf
(
£q
, " %ums†oggingransaction\n",

1012 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_loggšg
 / s->¡©s->
ts_tid
));

1013 
	`£q_´štf
(
£q
, " %lluus‡verageransaction commitime\n",

1014 
	`div_u64
(
s
->
jouº®
->
j_av”age_comm™_time
, 1000));

1015 
	`£q_´štf
(
£q
, " %lu handles…erransaction\n",

1016 
s
->
¡©s
->
run
.
rs_hªdË_couÁ
 / s->¡©s->
ts_tid
);

1017 
	`£q_´štf
(
£q
, " %lu blocks…erransaction\n",

1018 
s
->
¡©s
->
run
.
rs_blocks
 / s->¡©s->
ts_tid
);

1019 
	`£q_´štf
(
£q
, " %lu†ogged blocks…erransaction\n",

1020 
s
->
¡©s
->
run
.
rs_blocks_logged
 / s->¡©s->
ts_tid
);

1022 
	}
}

1024 
	$jbd2_£q_šfo_¡İ
(
£q_fe
 *
£q
, *
v
)

1026 
	}
}

1028 cÚ¡ 
£q_İ”©iÚs
 
	gjbd2_£q_šfo_İs
 = {

1029 .
¡¬t
 = 
jbd2_£q_šfo_¡¬t
,

1030 .
	gÃxt
 = 
jbd2_£q_šfo_Ãxt
,

1031 .
	g¡İ
 = 
jbd2_£q_šfo_¡İ
,

1032 .
	gshow
 = 
jbd2_£q_šfo_show
,

1035 
	$jbd2_£q_šfo_İ’
(
šode
 *šode, 
fe
 *file)

1037 
jouº®_t
 *
jouº®
 = 
	`PDE_DATA
(
šode
);

1038 
jbd2_¡©s_´oc_£ssiÚ
 *
s
;

1039 
rc
, 
size
;

1041 
s
 = 
	`km®loc
((*s), 
GFP_KERNEL
);

1042 ià(
s
 =ğ
NULL
)

1043  -
ENOMEM
;

1044 
size
 = (
Œª§ùiÚ_¡©s_s
);

1045 
s
->
¡©s
 = 
	`km®loc
(
size
, 
GFP_KERNEL
);

1046 ià(
s
->
¡©s
 =ğ
NULL
) {

1047 
	`kä“
(
s
);

1048  -
ENOMEM
;

1050 
	`¥š_lock
(&
jouº®
->
j_hi¡Üy_lock
);

1051 
	`memıy
(
s
->
¡©s
, &
jouº®
->
j_¡©s
, 
size
);

1052 
s
->
jouº®
 = journal;

1053 
	`¥š_uÆock
(&
jouº®
->
j_hi¡Üy_lock
);

1055 
rc
 = 
	`£q_İ’
(
fe
, &
jbd2_£q_šfo_İs
);

1056 ià(
rc
 == 0) {

1057 
£q_fe
 *
m
 = 
fe
->
´iv©e_d©a
;

1058 
m
->
´iv©e
 = 
s
;

1060 
	`kä“
(
s
->
¡©s
);

1061 
	`kä“
(
s
);

1063  
rc
;

1065 
	}
}

1067 
	$jbd2_£q_šfo_»Ëa£
(
šode
 *šode, 
fe
 *file)

1069 
£q_fe
 *
£q
 = 
fe
->
´iv©e_d©a
;

1070 
jbd2_¡©s_´oc_£ssiÚ
 *
s
 = 
£q
->
´iv©e
;

1071 
	`kä“
(
s
->
¡©s
);

1072 
	`kä“
(
s
);

1073  
	`£q_»Ëa£
(
šode
, 
fe
);

1074 
	}
}

1076 cÚ¡ 
fe_İ”©iÚs
 
	gjbd2_£q_šfo_fİs
 = {

1077 .
owÃr
 = 
THIS_MODULE
,

1078 .
	gİ’
 = 
jbd2_£q_šfo_İ’
,

1079 .
	g»ad
 = 
£q_»ad
,

1080 .
	gÎ£ek
 = 
£q_l£ek
,

1081 .
	g»Ëa£
 = 
jbd2_£q_šfo_»Ëa£
,

1084 
´oc_dœ_’Œy
 *
	g´oc_jbd2_¡©s
;

1086 
	$jbd2_¡©s_´oc_š™
(
jouº®_t
 *
jouº®
)

1088 
jouº®
->
j_´oc_’Œy
 = 
	`´oc_mkdœ
(jouº®->
j_devÇme
, 
´oc_jbd2_¡©s
);

1089 ià(
jouº®
->
j_´oc_’Œy
) {

1090 
	`´oc_ü—‹_d©a
("šfo", 
S_IRUGO
, 
jouº®
->
j_´oc_’Œy
,

1091 &
jbd2_£q_šfo_fİs
, 
jouº®
);

1093 
	}
}

1095 
	$jbd2_¡©s_´oc_ex™
(
jouº®_t
 *
jouº®
)

1097 
	`»move_´oc_’Œy
("šfo", 
jouº®
->
j_´oc_’Œy
);

1098 
	`»move_´oc_’Œy
(
jouº®
->
j_devÇme
, 
´oc_jbd2_¡©s
);

1099 
	}
}

1110 
jouº®_t
 *
	$jouº®_š™_commÚ
(
block_deviû
 *
bdev
,

1111 
block_deviû
 *
fs_dev
,

1112 
¡¬t
, 
Ën
, 
blocksize
)

1114 
lock_şass_key
 
jbd2_Œªs_comm™_key
;

1115 
jouº®_t
 *
jouº®
;

1116 
”r
;

1117 
bufãr_h—d
 *
bh
;

1118 
n
;

1120 
jouº®
 = 
	`kz®loc
((*jouº®), 
GFP_KERNEL
);

1121 ià(!
jouº®
)

1122  
NULL
;

1124 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
);

1125 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_dÚe_comm™
);

1126 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_comm™
);

1127 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_upd©es
);

1128 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_»£rved
);

1129 
	`mu‹x_š™
(&
jouº®
->
j_b¬r›r
);

1130 
	`mu‹x_š™
(&
jouº®
->
j_checkpošt_mu‹x
);

1131 
	`¥š_lock_š™
(&
jouº®
->
j_»voke_lock
);

1132 
	`¥š_lock_š™
(&
jouº®
->
j_li¡_lock
);

1133 
	`rwlock_š™
(&
jouº®
->
j_¡©e_lock
);

1135 
jouº®
->
j_comm™_š‹rv®
 = (
HZ
 * 
JBD2_DEFAULT_MAX_COMMIT_AGE
);

1136 
jouº®
->
j_mš_b©ch_time
 = 0;

1137 
jouº®
->
j_max_b©ch_time
 = 15000;

1138 
	`©omic_£t
(&
jouº®
->
j_»£rved_üed™s
, 0);

1141 
jouº®
->
j_æags
 = 
JBD2_ABORT
;

1144 
”r
 = 
	`jbd2_jouº®_š™_»voke
(
jouº®
, 
JOURNAL_REVOKE_DEFAULT_HASH
);

1145 ià(
”r
)

1146 
”r_ş—nup
;

1148 
	`¥š_lock_š™
(&
jouº®
->
j_hi¡Üy_lock
);

1150 
	`lockd•_š™_m­
(&
jouº®
->
j_Œªs_comm™_m­
, "jbd2_handle",

1151 &
jbd2_Œªs_comm™_key
, 0);

1154 
jouº®
->
j_blocksize
 = 
blocksize
;

1155 
jouº®
->
j_dev
 = 
bdev
;

1156 
jouº®
->
j_fs_dev
 = 
fs_dev
;

1157 
jouº®
->
j_blk_off£t
 = 
¡¬t
;

1158 
jouº®
->
j_maxËn
 = 
Ën
;

1159 
n
 = 
jouº®
->
j_blocksize
 / (
jouº®_block_g_t
);

1160 
jouº®
->
j_wbufsize
 = 
n
;

1161 
jouº®
->
j_wbuf
 = 
	`km®loc_¬¿y
(
n
, (
bufãr_h—d
 *),

1162 
GFP_KERNEL
);

1163 ià(!
jouº®
->
j_wbuf
)

1164 
”r_ş—nup
;

1166 
bh
 = 
	`g‘blk_unmovabË
(
jouº®
->
j_dev
, 
¡¬t
, jouº®->
j_blocksize
);

1167 ià(!
bh
) {

1168 
	`´_”r
("%s: Cannot get buffer for journal superblock\n",

1169 
__func__
);

1170 
”r_ş—nup
;

1172 
jouº®
->
j_sb_bufãr
 = 
bh
;

1173 
jouº®
->
j_su³rblock
 = (
jouº®_su³rblock_t
 *)
bh
->
b_d©a
;

1175  
jouº®
;

1177 
”r_ş—nup
:

1178 
	`kä“
(
jouº®
->
j_wbuf
);

1179 
	`jbd2_jouº®_de¡roy_»voke
(
jouº®
);

1180 
	`kä“
(
jouº®
);

1181  
NULL
;

1182 
	}
}

1207 
jouº®_t
 *
	$jbd2_jouº®_š™_dev
(
block_deviû
 *
bdev
,

1208 
block_deviû
 *
fs_dev
,

1209 
¡¬t
, 
Ën
, 
blocksize
)

1211 
jouº®_t
 *
jouº®
;

1213 
jouº®
 = 
	`jouº®_š™_commÚ
(
bdev
, 
fs_dev
, 
¡¬t
, 
Ën
, 
blocksize
);

1214 ià(!
jouº®
)

1215  
NULL
;

1217 
	`bdevÇme
(
jouº®
->
j_dev
, jouº®->
j_devÇme
);

1218 
	`¡¼•Ïû
(
jouº®
->
j_devÇme
, '/', '!');

1219 
	`jbd2_¡©s_´oc_š™
(
jouº®
);

1221  
jouº®
;

1222 
	}
}

1232 
jouº®_t
 *
	$jbd2_jouº®_š™_šode
(
šode
 *inode)

1234 
jouº®_t
 *
jouº®
;

1235 *
p
;

1236 
blockÄ
;

1238 
blockÄ
 = 
	`bm­
(
šode
, 0);

1239 ià(!
blockÄ
) {

1240 
	`´_”r
("%s: Cannot†ocate journal superblock\n",

1241 
__func__
);

1242  
NULL
;

1245 
	`jbd_debug
(1, "JBD2: inode %s/%ld, size %lld, bits %d, blksize %ld\n",

1246 
šode
->
i_sb
->
s_id
, inode->
i_šo
, (èšode->
i_size
,

1247 
šode
->
i_sb
->
s_blocksize_b™s
, inode->i_sb->
s_blocksize
);

1249 
jouº®
 = 
	`jouº®_š™_commÚ
(
šode
->
i_sb
->
s_bdev
, inode->i_sb->s_bdev,

1250 
blockÄ
, 
šode
->
i_size
 >> inode->
i_sb
->
s_blocksize_b™s
,

1251 
šode
->
i_sb
->
s_blocksize
);

1252 ià(!
jouº®
)

1253  
NULL
;

1255 
jouº®
->
j_šode
 = 
šode
;

1256 
	`bdevÇme
(
jouº®
->
j_dev
, jouº®->
j_devÇme
);

1257 
p
 = 
	`¡¼•Ïû
(
jouº®
->
j_devÇme
, '/', '!');

1258 
	`¥rštf
(
p
, "-%lu", 
jouº®
->
j_šode
->
i_šo
);

1259 
	`jbd2_¡©s_´oc_š™
(
jouº®
);

1261  
jouº®
;

1262 
	}
}

1269 
	$jouº®_ç_su³rblock
 (
jouº®_t
 *
jouº®
)

1271 
bufãr_h—d
 *
bh
 = 
jouº®
->
j_sb_bufãr
;

1272 
	`b»l£
(
bh
);

1273 
jouº®
->
j_sb_bufãr
 = 
NULL
;

1274 
	}
}

1283 
	$jouº®_»£t
(
jouº®_t
 *
jouº®
)

1285 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1286 
fœ¡
, 
Ï¡
;

1288 
fœ¡
 = 
	`be32_to_ıu
(
sb
->
s_fœ¡
);

1289 
Ï¡
 = 
	`be32_to_ıu
(
sb
->
s_maxËn
);

1290 ià(
fœ¡
 + 
JBD2_MIN_JOURNAL_BLOCKS
 > 
Ï¡
 + 1) {

1291 
	`´štk
(
KERN_ERR
 "JBD2: Journaloo short (blocks %llu-%llu).\n",

1292 
fœ¡
, 
Ï¡
);

1293 
	`jouº®_ç_su³rblock
(
jouº®
);

1294  -
EINVAL
;

1297 
jouº®
->
j_fœ¡
 = 
fœ¡
;

1298 
jouº®
->
j_Ï¡
 = 
Ï¡
;

1300 
jouº®
->
j_h—d
 = 
fœ¡
;

1301 
jouº®
->
j_
 = 
fœ¡
;

1302 
jouº®
->
j_ä“
 = 
Ï¡
 - 
fœ¡
;

1304 
jouº®
->
j__£qu’û
 = jouº®->
j_Œª§ùiÚ_£qu’û
;

1305 
jouº®
->
j_comm™_£qu’û
 = jouº®->
j_Œª§ùiÚ_£qu’û
 - 1;

1306 
jouº®
->
j_comm™_»que¡
 = jouº®->
j_comm™_£qu’û
;

1308 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
 = jouº®->
j_maxËn
 / 4;

1316 ià(
sb
->
s_¡¬t
 == 0) {

1317 
	`jbd_debug
(1, "JBD2: Skipping superblock update on„ecovered sb "

1319 
jouº®
->
j_
, jouº®->
j__£qu’û
,

1320 
jouº®
->
j_”ºo
);

1321 
jouº®
->
j_æags
 |ğ
JBD2_FLUSHED
;

1324 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

1331 
	`jbd2_jouº®_upd©e_sb_log_
(
jouº®
,

1332 
jouº®
->
j__£qu’û
,

1333 
jouº®
->
j_
,

1334 
REQ_SYNC
 | 
REQ_FUA
);

1335 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

1337  
	`jbd2_jouº®_¡¬t_th»ad
(
jouº®
);

1338 
	}
}

1344 
	$jbd2_wr™e_su³rblock
(
jouº®_t
 *
jouº®
, 
wr™e_æags
)

1346 
bufãr_h—d
 *
bh
 = 
jouº®
->
j_sb_bufãr
;

1347 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1348 
»t
;

1351 ià(!
	`bufãr_m­³d
(
bh
))

1352  -
EIO
;

1354 
	`Œaû_jbd2_wr™e_su³rblock
(
jouº®
, 
wr™e_æags
);

1355 ià(!(
jouº®
->
j_æags
 & 
JBD2_BARRIER
))

1356 
wr™e_æags
 &ğ~(
REQ_FUA
 | 
REQ_PREFLUSH
);

1357 ià(
	`bufãr_wr™e_io_”rÜ
(
bh
)) {

1366 
	`´štk
(
KERN_ERR
 "JBD2:…revious I/Oƒrror detected "

1368 
jouº®
->
j_devÇme
);

1369 
	`ş—r_bufãr_wr™e_io_”rÜ
(
bh
);

1370 
	`£t_bufãr_u±od©e
(
bh
);

1372 ià(
	`jbd2_jouº®_has_csum_v2Ü3
(
jouº®
))

1373 
sb
->
s_checksum
 = 
	`jbd2_su³rblock_csum
(
jouº®
, sb);

1374 
	`g‘_bh
(
bh
);

1375 
bh
->
b_’d_io
 = 
’d_bufãr_wr™e_sync
;

1376 
»t
 = 
	`subm™_bh
(
REQ_OP_WRITE
, 
wr™e_æags
, 
bh
);

1377 
	`wa™_Ú_bufãr
(
bh
);

1378 ià(
	`bufãr_wr™e_io_”rÜ
(
bh
)) {

1379 
	`ş—r_bufãr_wr™e_io_”rÜ
(
bh
);

1380 
	`£t_bufãr_u±od©e
(
bh
);

1381 
»t
 = -
EIO
;

1383 ià(
»t
) {

1384 
	`´štk
(
KERN_ERR
 "JBD2: Error %d detected when updating "

1385 "jouº® su³rblock fÜ %s.\n", 
»t
,

1386 
jouº®
->
j_devÇme
);

1387 
	`jbd2_jouº®_abÜt
(
jouº®
, 
»t
);

1390  
»t
;

1391 
	}
}

1403 
	$jbd2_jouº®_upd©e_sb_log_
(
jouº®_t
 *
jouº®
, 
tid_t
 
_tid
,

1404 
_block
, 
wr™e_İ
)

1406 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1407 
»t
;

1409 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

1410  -
EIO
;

1412 
	`BUG_ON
(!
	`mu‹x_is_locked
(&
jouº®
->
j_checkpošt_mu‹x
));

1413 
	`jbd_debug
(1, "JBD2: updating superblock (start %lu, seq %u)\n",

1414 
_block
, 
_tid
);

1416 
	`lock_bufãr
(
jouº®
->
j_sb_bufãr
);

1417 
sb
->
s_£qu’û
 = 
	`ıu_to_be32
(
_tid
);

1418 
sb
->
s_¡¬t
 = 
	`ıu_to_be32
(
_block
);

1420 
»t
 = 
	`jbd2_wr™e_su³rblock
(
jouº®
, 
wr™e_İ
);

1421 ià(
»t
)

1422 
out
;

1425 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1426 
	`WARN_ON
(!
sb
->
s_£qu’û
);

1427 
jouº®
->
j_æags
 &ğ~
JBD2_FLUSHED
;

1428 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1430 
out
:

1431  
»t
;

1432 
	}
}

1442 
	$jbd2_m¬k_jouº®_em±y
(
jouº®_t
 *
jouº®
, 
wr™e_İ
)

1444 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1446 
	`BUG_ON
(!
	`mu‹x_is_locked
(&
jouº®
->
j_checkpošt_mu‹x
));

1447 
	`lock_bufãr
(
jouº®
->
j_sb_bufãr
);

1448 ià(
sb
->
s_¡¬t
 == 0) {

1449 
	`uÆock_bufãr
(
jouº®
->
j_sb_bufãr
);

1453 
	`jbd_debug
(1, "JBD2: Marking journal‡sƒmpty (seq %u)\n",

1454 
jouº®
->
j__£qu’û
);

1456 
sb
->
s_£qu’û
 = 
	`ıu_to_be32
(
jouº®
->
j__£qu’û
);

1457 
sb
->
s_¡¬t
 = 
	`ıu_to_be32
(0);

1459 
	`jbd2_wr™e_su³rblock
(
jouº®
, 
wr™e_İ
);

1462 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1463 
jouº®
->
j_æags
 |ğ
JBD2_FLUSHED
;

1464 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1465 
	}
}

1475 
	$jbd2_jouº®_upd©e_sb_”ºo
(
jouº®_t
 *
jouº®
)

1477 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1478 
”rcode
;

1480 
	`lock_bufãr
(
jouº®
->
j_sb_bufãr
);

1481 
”rcode
 = 
jouº®
->
j_”ºo
;

1482 ià(
”rcode
 =ğ-
ESHUTDOWN
)

1483 
”rcode
 = 0;

1484 
	`jbd_debug
(1, "JBD2: upd©šg su³rblockƒ¼Ü (”ºØ%d)\n", 
”rcode
);

1485 
sb
->
s_”ºo
 = 
	`ıu_to_be32
(
”rcode
);

1487 
	`jbd2_wr™e_su³rblock
(
jouº®
, 
REQ_SYNC
 | 
REQ_FUA
);

1488 
	}
}

1489 
EXPORT_SYMBOL
(
jbd2_jouº®_upd©e_sb_”ºo
);

1495 
	$jouº®_g‘_su³rblock
(
jouº®_t
 *
jouº®
)

1497 
bufãr_h—d
 *
bh
;

1498 
jouº®_su³rblock_t
 *
sb
;

1499 
”r
 = -
EIO
;

1501 
bh
 = 
jouº®
->
j_sb_bufãr
;

1503 
	`J_ASSERT
(
bh
 !ğ
NULL
);

1504 ià(!
	`bufãr_u±od©e
(
bh
)) {

1505 
	`Î_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

1506 
	`wa™_Ú_bufãr
(
bh
);

1507 ià(!
	`bufãr_u±od©e
(
bh
)) {

1508 
	`´štk
(
KERN_ERR


1510 
out
;

1514 ià(
	`bufãr_v”if›d
(
bh
))

1517 
sb
 = 
jouº®
->
j_su³rblock
;

1519 
”r
 = -
EINVAL
;

1521 ià(
sb
->
s_h—d”
.
h_magic
 !ğ
	`ıu_to_be32
(
JBD2_MAGIC_NUMBER
) ||

1522 
sb
->
s_blocksize
 !ğ
	`ıu_to_be32
(
jouº®
->
j_blocksize
)) {

1523 
	`´štk
(
KERN_WARNING
 "JBD2:‚o valid journal superblock found\n");

1524 
out
;

1527 
	`be32_to_ıu
(
sb
->
s_h—d”
.
h_blockty³
)) {

1528 
JBD2_SUPERBLOCK_V1
:

1529 
jouº®
->
j_fÜm©_v”siÚ
 = 1;

1531 
JBD2_SUPERBLOCK_V2
:

1532 
jouº®
->
j_fÜm©_v”siÚ
 = 2;

1535 
	`´štk
(
KERN_WARNING
 "JBD2: unrecognised superblock format ID\n");

1536 
out
;

1539 ià(
	`be32_to_ıu
(
sb
->
s_maxËn
è< 
jouº®
->
j_maxËn
)

1540 
jouº®
->
j_maxËn
 = 
	`be32_to_ıu
(
sb
->
s_maxËn
);

1541 ià(
	`be32_to_ıu
(
sb
->
s_maxËn
è> 
jouº®
->
j_maxËn
) {

1542 
	`´štk
(
KERN_WARNING
 "JBD2: journal fileoo short\n");

1543 
out
;

1546 ià(
	`be32_to_ıu
(
sb
->
s_fœ¡
) == 0 ||

1547 
	`be32_to_ıu
(
sb
->
s_fœ¡
è>ğ
jouº®
->
j_maxËn
) {

1548 
	`´štk
(
KERN_WARNING


1550 
	`be32_to_ıu
(
sb
->
s_fœ¡
));

1551 
out
;

1554 ià(
	`jbd2_has_ã©u»_csum2
(
jouº®
) &&

1555 
	`jbd2_has_ã©u»_csum3
(
jouº®
)) {

1557 
	`´štk
(
KERN_ERR
 "JBD2: Can'tƒnable checksumming v2‡nd v3 "

1559 
out
;

1562 ià(
	`jbd2_jouº®_has_csum_v2Ü3_ã©u»
(
jouº®
) &&

1563 
	`jbd2_has_ã©u»_checksum
(
jouº®
)) {

1565 
	`´štk
(
KERN_ERR
 "JBD2: Can'tƒnable checksumming v1‡nd v2/3 "

1567 
out
;

1570 ià(!
	`jbd2_v”ify_csum_ty³
(
jouº®
, 
sb
)) {

1571 
	`´štk
(
KERN_ERR
 "JBD2: Unknown checksumype\n");

1572 
out
;

1576 ià(
	`jbd2_jouº®_has_csum_v2Ü3_ã©u»
(
jouº®
)) {

1577 
jouº®
->
j_chksum_driv”
 = 
	`üy±o_®loc_shash
("crc32c", 0, 0);

1578 ià(
	`IS_ERR
(
jouº®
->
j_chksum_driv”
)) {

1579 
	`´štk
(
KERN_ERR
 "JBD2: Cannot†oad crc32c driver.\n");

1580 
”r
 = 
	`PTR_ERR
(
jouº®
->
j_chksum_driv”
);

1581 
jouº®
->
j_chksum_driv”
 = 
NULL
;

1582 
out
;

1586 ià(
	`jbd2_jouº®_has_csum_v2Ü3
(
jouº®
)) {

1588 ià(
sb
->
s_checksum
 !ğ
	`jbd2_su³rblock_csum
(
jouº®
, sb)) {

1589 
	`´štk
(
KERN_ERR
 "JBD2: journal checksumƒrror\n");

1590 
”r
 = -
EFSBADCRC
;

1591 
out
;

1595 
jouº®
->
j_csum_£ed
 = 
	`jbd2_chksum
(jouº®, ~0, 
sb
->
s_uuid
,

1596 (
sb
->
s_uuid
));

1599 
	`£t_bufãr_v”if›d
(
bh
);

1603 
out
:

1604 
	`jouº®_ç_su³rblock
(
jouº®
);

1605  
”r
;

1606 
	}
}

1613 
	$lßd_su³rblock
(
jouº®_t
 *
jouº®
)

1615 
”r
;

1616 
jouº®_su³rblock_t
 *
sb
;

1618 
”r
 = 
	`jouº®_g‘_su³rblock
(
jouº®
);

1619 ià(
”r
)

1620  
”r
;

1622 
sb
 = 
jouº®
->
j_su³rblock
;

1624 
jouº®
->
j__£qu’û
 = 
	`be32_to_ıu
(
sb
->
s_£qu’û
);

1625 
jouº®
->
j_
 = 
	`be32_to_ıu
(
sb
->
s_¡¬t
);

1626 
jouº®
->
j_fœ¡
 = 
	`be32_to_ıu
(
sb
->
s_fœ¡
);

1627 
jouº®
->
j_Ï¡
 = 
	`be32_to_ıu
(
sb
->
s_maxËn
);

1628 
jouº®
->
j_”ºo
 = 
	`be32_to_ıu
(
sb
->
s_”ºo
);

1631 
	}
}

1642 
	$jbd2_jouº®_lßd
(
jouº®_t
 *
jouº®
)

1644 
”r
;

1645 
jouº®_su³rblock_t
 *
sb
;

1647 
”r
 = 
	`lßd_su³rblock
(
jouº®
);

1648 ià(
”r
)

1649  
”r
;

1651 
sb
 = 
jouº®
->
j_su³rblock
;

1655 ià(
jouº®
->
j_fÜm©_v”siÚ
 >= 2) {

1656 ià((
sb
->
s_ã©u»_ro_com·t
 &

1657 ~
	`ıu_to_be32
(
JBD2_KNOWN_ROCOMPAT_FEATURES
)) ||

1658 (
sb
->
s_ã©u»_šcom·t
 &

1659 ~
	`ıu_to_be32
(
JBD2_KNOWN_INCOMPAT_FEATURES
))) {

1660 
	`´štk
(
KERN_WARNING


1662  -
EINVAL
;

1669 
”r
 = 
	`jbd2_jouº®_ü—‹_¦ab
(
	`be32_to_ıu
(
sb
->
s_blocksize
));

1670 ià(
”r
)

1671  
”r
;

1675 ià(
	`jbd2_jouº®_»cov”
(
jouº®
))

1676 
»cov”y_”rÜ
;

1678 ià(
jouº®
->
j_çed_comm™
) {

1679 
	`´štk
(
KERN_ERR
 "JBD2: journalransaction %u on %s "

1680 "i cÜru±.\n", 
jouº®
->
j_çed_comm™
,

1681 
jouº®
->
j_devÇme
);

1682  -
EFSCORRUPTED
;

1688 ià(
	`jouº®_»£t
(
jouº®
))

1689 
»cov”y_”rÜ
;

1691 
jouº®
->
j_æags
 &ğ~
JBD2_ABORT
;

1692 
jouº®
->
j_æags
 |ğ
JBD2_LOADED
;

1695 
»cov”y_”rÜ
:

1696 
	`´štk
(
KERN_WARNING
 "JBD2:„ecovery failed\n");

1697  -
EIO
;

1698 
	}
}

1708 
	$jbd2_jouº®_de¡roy
(
jouº®_t
 *
jouº®
)

1710 
”r
 = 0;

1713 
	`jouº®_kl_th»ad
(
jouº®
);

1716 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
)

1717 
	`jbd2_jouº®_comm™_Œª§ùiÚ
(
jouº®
);

1722 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1723 
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
NULL
) {

1724 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1725 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

1726 
”r
 = 
	`jbd2_log_do_checkpošt
(
jouº®
);

1727 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

1732 ià(
”r
) {

1733 
	`jbd2_jouº®_de¡roy_checkpošt
(
jouº®
);

1734 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1737 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1740 
	`J_ASSERT
(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 =ğ
NULL
);

1741 
	`J_ASSERT
(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 =ğ
NULL
);

1742 
	`J_ASSERT
(
jouº®
->
j_checkpošt_Œª§ùiÚs
 =ğ
NULL
);

1743 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1745 ià(
jouº®
->
j_sb_bufãr
) {

1746 ià(!
	`is_jouº®_abÜ‹d
(
jouº®
)) {

1747 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

1749 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1750 
jouº®
->
j__£qu’û
 =

1751 ++
jouº®
->
j_Œª§ùiÚ_£qu’û
;

1752 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1754 
	`jbd2_m¬k_jouº®_em±y
(
jouº®
,

1755 
REQ_SYNC
 | 
REQ_PREFLUSH
 | 
REQ_FUA
);

1756 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

1758 
”r
 = -
EIO
;

1759 
	`b»l£
(
jouº®
->
j_sb_bufãr
);

1762 ià(
jouº®
->
j_´oc_’Œy
)

1763 
	`jbd2_¡©s_´oc_ex™
(
jouº®
);

1764 
	`ut
(
jouº®
->
j_šode
);

1765 ià(
jouº®
->
j_»voke
)

1766 
	`jbd2_jouº®_de¡roy_»voke
(
jouº®
);

1767 ià(
jouº®
->
j_chksum_driv”
)

1768 
	`üy±o_ä“_shash
(
jouº®
->
j_chksum_driv”
);

1769 
	`kä“
(
jouº®
->
j_wbuf
);

1770 
	`kä“
(
jouº®
);

1772  
”r
;

1773 
	}
}

1787 
	$jbd2_jouº®_check_u£d_ã©u»s
 (
jouº®_t
 *
jouº®
, 
com·t
,

1788 
ro
, 
šcom·t
)

1790 
jouº®_su³rblock_t
 *
sb
;

1792 ià(!
com·t
 && !
ro
 && !
šcom·t
)

1795 ià(
jouº®
->
j_fÜm©_v”siÚ
 == 0 &&

1796 
	`jouº®_g‘_su³rblock
(
jouº®
) != 0)

1798 ià(
jouº®
->
j_fÜm©_v”siÚ
 == 1)

1801 
sb
 = 
jouº®
->
j_su³rblock
;

1803 ià(((
	`be32_to_ıu
(
sb
->
s_ã©u»_com·t
è& 
com·t
) == compat) &&

1804 ((
	`be32_to_ıu
(
sb
->
s_ã©u»_ro_com·t
è& 
ro
) ==„o) &&

1805 ((
	`be32_to_ıu
(
sb
->
s_ã©u»_šcom·t
è& 
šcom·t
) == incompat))

1809 
	}
}

1822 
	$jbd2_jouº®_check_avaabË_ã©u»s
 (
jouº®_t
 *
jouº®
, 
com·t
,

1823 
ro
, 
šcom·t
)

1825 ià(!
com·t
 && !
ro
 && !
šcom·t
)

1832 ià(
jouº®
->
j_fÜm©_v”siÚ
 != 2)

1835 ià((
com·t
 & 
JBD2_KNOWN_COMPAT_FEATURES
) == compat &&

1836 (
ro
 & 
JBD2_KNOWN_ROCOMPAT_FEATURES
) ==„o &&

1837 (
šcom·t
 & 
JBD2_KNOWN_INCOMPAT_FEATURES
) == incompat)

1841 
	}
}

1855 
	$jbd2_jouº®_£t_ã©u»s
 (
jouº®_t
 *
jouº®
, 
com·t
,

1856 
ro
, 
šcom·t
)

1858 
	#INCOMPAT_FEATURE_ON
(
f
) \

1859 ((
šcom·t
 & (
f
)è&& !(
sb
->
s_ã©u»_šcom·t
 & 
	`ıu_to_be32
(f)))

	)

1860 
	#COMPAT_FEATURE_ON
(
f
) \

1861 ((
com·t
 & (
f
)è&& !(
sb
->
s_ã©u»_com·t
 & 
	`ıu_to_be32
(f)))

	)

1862 
jouº®_su³rblock_t
 *
sb
;

1864 ià(
	`jbd2_jouº®_check_u£d_ã©u»s
(
jouº®
, 
com·t
, 
ro
, 
šcom·t
))

1867 ià(!
	`jbd2_jouº®_check_avaabË_ã©u»s
(
jouº®
, 
com·t
, 
ro
, 
šcom·t
))

1871 ià(
šcom·t
 & 
JBD2_FEATURE_INCOMPAT_CSUM_V2
) {

1872 
šcom·t
 &ğ~
JBD2_FEATURE_INCOMPAT_CSUM_V2
;

1873 
šcom·t
 |ğ
JBD2_FEATURE_INCOMPAT_CSUM_V3
;

1877 ià(
šcom·t
 & 
JBD2_FEATURE_INCOMPAT_CSUM_V3
 &&

1878 
com·t
 & 
JBD2_FEATURE_COMPAT_CHECKSUM
)

1879 
com·t
 &ğ~
JBD2_FEATURE_COMPAT_CHECKSUM
;

1881 
	`jbd_debug
(1, "Setting‚ew features 0x%lx/0x%lx/0x%lx\n",

1882 
com·t
, 
ro
, 
šcom·t
);

1884 
sb
 = 
jouº®
->
j_su³rblock
;

1887 ià((
jouº®
->
j_chksum_driv”
 =ğ
NULL
) &&

1888 
	`INCOMPAT_FEATURE_ON
(
JBD2_FEATURE_INCOMPAT_CSUM_V3
)) {

1889 
jouº®
->
j_chksum_driv”
 = 
	`üy±o_®loc_shash
("crc32c", 0, 0);

1890 ià(
	`IS_ERR
(
jouº®
->
j_chksum_driv”
)) {

1891 
	`´štk
(
KERN_ERR
 "JBD2: Cannot†oad crc32c driver.\n");

1892 
jouº®
->
j_chksum_driv”
 = 
NULL
;

1896 
jouº®
->
j_csum_£ed
 = 
	`jbd2_chksum
(jouº®, ~0, 
sb
->
s_uuid
,

1897 (
sb
->
s_uuid
));

1900 
	`lock_bufãr
(
jouº®
->
j_sb_bufãr
);

1903 ià(
	`INCOMPAT_FEATURE_ON
(
JBD2_FEATURE_INCOMPAT_CSUM_V3
)) {

1904 
sb
->
s_checksum_ty³
 = 
JBD2_CRC32C_CHKSUM
;

1905 
sb
->
s_ã©u»_com·t
 &=

1906 ~
	`ıu_to_be32
(
JBD2_FEATURE_COMPAT_CHECKSUM
);

1910 ià(
	`COMPAT_FEATURE_ON
(
JBD2_FEATURE_COMPAT_CHECKSUM
))

1911 
sb
->
s_ã©u»_šcom·t
 &=

1912 ~
	`ıu_to_be32
(
JBD2_FEATURE_INCOMPAT_CSUM_V2
 |

1913 
JBD2_FEATURE_INCOMPAT_CSUM_V3
);

1915 
sb
->
s_ã©u»_com·t
 |ğ
	`ıu_to_be32
(
com·t
);

1916 
sb
->
s_ã©u»_ro_com·t
 |ğ
	`ıu_to_be32
(
ro
);

1917 
sb
->
s_ã©u»_šcom·t
 |ğ
	`ıu_to_be32
(
šcom·t
);

1918 
	`uÆock_bufãr
(
jouº®
->
j_sb_bufãr
);

1921 #undeà
COMPAT_FEATURE_ON


1922 #undeà
INCOMPAT_FEATURE_ON


1923 
	}
}

1936 
	$jbd2_jouº®_ş—r_ã©u»s
(
jouº®_t
 *
jouº®
, 
com·t
,

1937 
ro
, 
šcom·t
)

1939 
jouº®_su³rblock_t
 *
sb
;

1941 
	`jbd_debug
(1, "Clear features 0x%lx/0x%lx/0x%lx\n",

1942 
com·t
, 
ro
, 
šcom·t
);

1944 
sb
 = 
jouº®
->
j_su³rblock
;

1946 
sb
->
s_ã©u»_com·t
 &ğ~
	`ıu_to_be32
(
com·t
);

1947 
sb
->
s_ã©u»_ro_com·t
 &ğ~
	`ıu_to_be32
(
ro
);

1948 
sb
->
s_ã©u»_šcom·t
 &ğ~
	`ıu_to_be32
(
šcom·t
);

1949 
	}
}

1950 
EXPORT_SYMBOL
(
jbd2_jouº®_ş—r_ã©u»s
);

1961 
	$jbd2_jouº®_æush
(
jouº®_t
 *
jouº®
)

1963 
”r
 = 0;

1964 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
NULL
;

1966 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1969 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

1970 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

1971 
	`__jbd2_log_¡¬t_comm™
(
jouº®
, 
Œª§ùiÚ
->
t_tid
);

1972 } ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
)

1973 
Œª§ùiÚ
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

1976 ià(
Œª§ùiÚ
) {

1977 
tid_t
 
tid
 = 
Œª§ùiÚ
->
t_tid
;

1979 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1980 
	`jbd2_log_wa™_comm™
(
jouº®
, 
tid
);

1982 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1986 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1987 !
”r
 && 
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
NULL
) {

1988 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1989 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

1990 
”r
 = 
	`jbd2_log_do_checkpošt
(
jouº®
);

1991 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

1992 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1994 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1996 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

1997  -
EIO
;

1999 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

2000 ià(!
”r
) {

2001 
”r
 = 
	`jbd2_ş—nup_jouº®_
(
jouº®
);

2002 ià(
”r
 < 0) {

2003 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

2004 
out
;

2006 
”r
 = 0;

2014 
	`jbd2_m¬k_jouº®_em±y
(
jouº®
, 
REQ_SYNC
 | 
REQ_FUA
);

2015 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

2016 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2017 
	`J_ASSERT
(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
);

2018 
	`J_ASSERT
(!
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

2019 
	`J_ASSERT
(!
jouº®
->
j_checkpošt_Œª§ùiÚs
);

2020 
	`J_ASSERT
(
jouº®
->
j_h—d
 =ğjouº®->
j_
);

2021 
	`J_ASSERT
(
jouº®
->
j__£qu’û
 =ğjouº®->
j_Œª§ùiÚ_£qu’û
);

2022 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2023 
out
:

2024  
”r
;

2025 
	}
}

2040 
	$jbd2_jouº®_we
(
jouº®_t
 *
jouº®
, 
wr™e
)

2042 
”r
 = 0;

2044 
	`J_ASSERT
 (!(
jouº®
->
j_æags
 & 
JBD2_LOADED
));

2046 
”r
 = 
	`lßd_su³rblock
(
jouº®
);

2047 ià(
”r
)

2048  
”r
;

2050 ià(!
jouº®
->
j_
)

2051 
no_»cov”y
;

2053 
	`´štk
(
KERN_WARNING
 "JBD2: %s„ecovery information on journal\n",

2054 
wr™e
 ? "Clearing" : "Ignoring");

2056 
”r
 = 
	`jbd2_jouº®_sk_»cov”y
(
jouº®
);

2057 ià(
wr™e
) {

2059 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

2060 
	`jbd2_m¬k_jouº®_em±y
(
jouº®
, 
REQ_SYNC
 | 
REQ_FUA
);

2061 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

2064 
no_»cov”y
:

2065  
”r
;

2066 
	}
}

2081 
	$__jbd2_jouº®_abÜt_h¬d
(
jouº®_t
 *
jouº®
)

2083 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

2085 ià(
jouº®
->
j_æags
 & 
JBD2_ABORT
)

2088 
	`´štk
(
KERN_ERR
 "Aborting journal on device %s.\n",

2089 
jouº®
->
j_devÇme
);

2091 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2092 
jouº®
->
j_æags
 |ğ
JBD2_ABORT
;

2093 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

2094 ià(
Œª§ùiÚ
)

2095 
	`__jbd2_log_¡¬t_comm™
(
jouº®
, 
Œª§ùiÚ
->
t_tid
);

2096 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2097 
	}
}

2101 
	$__jouº®_abÜt_soá
 (
jouº®_t
 *
jouº®
, 
”ºo
)

2103 
Şd_”ºo
;

2105 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2106 
Şd_”ºo
 = 
jouº®
->
j_”ºo
;

2107 ià(!
jouº®
->
j_”ºo
 || 
”ºo
 =ğ-
ESHUTDOWN
)

2108 
jouº®
->
j_”ºo
 = 
”ºo
;

2110 ià(
jouº®
->
j_æags
 & 
JBD2_ABORT
) {

2111 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2112 ià(!
Şd_”ºo
 && old_”ºØ!ğ-
ESHUTDOWN
 &&

2113 
”ºo
 =ğ-
ESHUTDOWN
)

2114 
	`jbd2_jouº®_upd©e_sb_”ºo
(
jouº®
);

2117 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2119 
	`__jbd2_jouº®_abÜt_h¬d
(
jouº®
);

2121 ià(
”ºo
) {

2122 
	`jbd2_jouº®_upd©e_sb_”ºo
(
jouº®
);

2123 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2124 
jouº®
->
j_æags
 |ğ
JBD2_REC_ERR
;

2125 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2127 
	}
}

2175 
	$jbd2_jouº®_abÜt
(
jouº®_t
 *
jouº®
, 
”ºo
)

2177 
	`__jouº®_abÜt_soá
(
jouº®
, 
”ºo
);

2178 
	}
}

2191 
	$jbd2_jouº®_”ºo
(
jouº®_t
 *
jouº®
)

2193 
”r
;

2195 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

2196 ià(
jouº®
->
j_æags
 & 
JBD2_ABORT
)

2197 
”r
 = -
EROFS
;

2199 
”r
 = 
jouº®
->
j_”ºo
;

2200 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

2201  
”r
;

2202 
	}
}

2211 
	$jbd2_jouº®_ş—r_”r
(
jouº®_t
 *
jouº®
)

2213 
”r
 = 0;

2215 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2216 ià(
jouº®
->
j_æags
 & 
JBD2_ABORT
)

2217 
”r
 = -
EROFS
;

2219 
jouº®
->
j_”ºo
 = 0;

2220 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2221  
”r
;

2222 
	}
}

2231 
	$jbd2_jouº®_ack_”r
(
jouº®_t
 *
jouº®
)

2233 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2234 ià(
jouº®
->
j_”ºo
)

2235 
jouº®
->
j_æags
 |ğ
JBD2_ACK_ERR
;

2236 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2237 
	}
}

2239 
	$jbd2_jouº®_blocks_³r_·ge
(
šode
 *inode)

2241  1 << (
PAGE_SHIFT
 - 
šode
->
i_sb
->
s_blocksize_b™s
);

2242 
	}
}

2247 
size_t
 
	$jouº®_g_by‹s
(
jouº®_t
 *
jouº®
)

2249 
size_t
 
sz
;

2251 ià(
	`jbd2_has_ã©u»_csum3
(
jouº®
))

2252  (
jouº®_block_g3_t
);

2254 
sz
 = (
jouº®_block_g_t
);

2256 ià(
	`jbd2_has_ã©u»_csum2
(
jouº®
))

2257 
sz
 +ğ(
__u16
);

2259 ià(
	`jbd2_has_ã©u»_64b™
(
jouº®
))

2260  
sz
;

2262  
sz
 - (
__u32
);

2263 
	}
}

2280 
	#JBD2_MAX_SLABS
 8

	)

2281 
kmem_ÿche
 *
	gjbd2_¦ab
[
JBD2_MAX_SLABS
];

2283 cÚ¡ *
	gjbd2_¦ab_Çmes
[
JBD2_MAX_SLABS
] = {

2289 
	$jbd2_jouº®_de¡roy_¦abs
()

2291 
i
;

2293 
i
 = 0; i < 
JBD2_MAX_SLABS
; i++) {

2294 
	`kmem_ÿche_de¡roy
(
jbd2_¦ab
[
i
]);

2295 
jbd2_¦ab
[
i
] = 
NULL
;

2297 
	}
}

2299 
	$jbd2_jouº®_ü—‹_¦ab
(
size_t
 
size
)

2301 
	`DEFINE_MUTEX
(
jbd2_¦ab_ü—‹_mu‹x
);

2302 
i
 = 
	`Üd”_ba£_2
(
size
) - 10;

2303 
size_t
 
¦ab_size
;

2305 ià(
size
 =ğ
PAGE_SIZE
)

2308 ià(
i
 >ğ
JBD2_MAX_SLABS
)

2309  -
EINVAL
;

2311 ià(
	`uÆik–y
(
i
 < 0))

2312 
i
 = 0;

2313 
	`mu‹x_lock
(&
jbd2_¦ab_ü—‹_mu‹x
);

2314 ià(
jbd2_¦ab
[
i
]) {

2315 
	`mu‹x_uÆock
(&
jbd2_¦ab_ü—‹_mu‹x
);

2319 
¦ab_size
 = 1 << (
i
+10);

2320 
jbd2_¦ab
[
i
] = 
	`kmem_ÿche_ü—‹
(
jbd2_¦ab_Çmes
[i], 
¦ab_size
,

2321 
¦ab_size
, 0, 
NULL
);

2322 
	`mu‹x_uÆock
(&
jbd2_¦ab_ü—‹_mu‹x
);

2323 ià(!
jbd2_¦ab
[
i
]) {

2324 
	`´štk
(
KERN_EMERG
 "JBD2:‚o memory for jbd2_slab cache\n");

2325  -
ENOMEM
;

2328 
	}
}

2330 
kmem_ÿche
 *
	$g‘_¦ab
(
size_t
 
size
)

2332 
i
 = 
	`Üd”_ba£_2
(
size
) - 10;

2334 
	`BUG_ON
(
i
 >ğ
JBD2_MAX_SLABS
);

2335 ià(
	`uÆik–y
(
i
 < 0))

2336 
i
 = 0;

2337 
	`BUG_ON
(
jbd2_¦ab
[
i
] =ğ
NULL
);

2338  
jbd2_¦ab
[
i
];

2339 
	}
}

2341 *
	$jbd2_®loc
(
size_t
 
size
, 
gå_t
 
æags
)

2343 *
±r
;

2345 
	`BUG_ON
(
size
 & (size-1));

2347 ià(
size
 < 
PAGE_SIZE
)

2348 
±r
 = 
	`kmem_ÿche_®loc
(
	`g‘_¦ab
(
size
), 
æags
);

2350 
±r
 = (*)
	`__g‘_ä“_·ges
(
æags
, 
	`g‘_Üd”
(
size
));

2354 
	`BUG_ON
(((è
±r
è& (
size
-1));

2356  
±r
;

2357 
	}
}

2359 
	$jbd2_ä“
(*
±r
, 
size_t
 
size
)

2361 ià(
size
 < 
PAGE_SIZE
)

2362 
	`kmem_ÿche_ä“
(
	`g‘_¦ab
(
size
), 
±r
);

2364 
	`ä“_·ges
(()
±r
, 
	`g‘_Üd”
(
size
));

2365 
	}
};

2370 
kmem_ÿche
 *
	gjbd2_jouº®_h—d_ÿche
;

2371 #ifdeà
CONFIG_JBD2_DEBUG


2372 
©omic_t
 
	gÄ_jouº®_h—ds
 = 
ATOMIC_INIT
(0);

2375 
__š™
 
	$jbd2_jouº®_š™_jouº®_h—d_ÿche
()

2377 
	`J_ASSERT
(!
jbd2_jouº®_h—d_ÿche
);

2378 
jbd2_jouº®_h—d_ÿche
 = 
	`kmem_ÿche_ü—‹
("jbd2_journal_head",

2379 (
jouº®_h—d
),

2381 
SLAB_TEMPORARY
 | 
SLAB_TYPESAFE_BY_RCU
,

2382 
NULL
);

2383 ià(!
jbd2_jouº®_h—d_ÿche
) {

2384 
	`´štk
(
KERN_EMERG
 "JBD2:‚o memory for journal_head cache\n");

2385  -
ENOMEM
;

2388 
	}
}

2390 
	$jbd2_jouº®_de¡roy_jouº®_h—d_ÿche
()

2392 
	`kmem_ÿche_de¡roy
(
jbd2_jouº®_h—d_ÿche
);

2393 
jbd2_jouº®_h—d_ÿche
 = 
NULL
;

2394 
	}
}

2399 
jouº®_h—d
 *
	$jouº®_®loc_jouº®_h—d
()

2401 
jouº®_h—d
 *
»t
;

2403 #ifdeà
CONFIG_JBD2_DEBUG


2404 
	`©omic_šc
(&
Ä_jouº®_h—ds
);

2406 
»t
 = 
	`kmem_ÿche_z®loc
(
jbd2_jouº®_h—d_ÿche
, 
GFP_NOFS
);

2407 ià(!
»t
) {

2408 
	`jbd_debug
(1, "out of memory for journal_head\n");

2409 
	`´_nÙiû_¿‹lim™ed
("ENOMEM iÀ%s,„‘ryšg.\n", 
__func__
);

2410 
»t
 = 
	`kmem_ÿche_z®loc
(
jbd2_jouº®_h—d_ÿche
,

2411 
GFP_NOFS
 | 
__GFP_NOFAIL
);

2413  
»t
;

2414 
	}
}

2416 
	$jouº®_ä“_jouº®_h—d
(
jouº®_h—d
 *
jh
)

2418 #ifdeà
CONFIG_JBD2_DEBUG


2419 
	`©omic_dec
(&
Ä_jouº®_h—ds
);

2420 
	`mem£t
(
jh
, 
JBD2_POISON_FREE
, (*jh));

2422 
	`kmem_ÿche_ä“
(
jbd2_jouº®_h—d_ÿche
, 
jh
);

2423 
	}
}

2466 
jouº®_h—d
 *
	$jbd2_jouº®_add_jouº®_h—d
(
bufãr_h—d
 *
bh
)

2468 
jouº®_h—d
 *
jh
;

2469 
jouº®_h—d
 *
Ãw_jh
 = 
NULL
;

2471 
»³©
:

2472 ià(!
	`bufãr_jbd
(
bh
))

2473 
Ãw_jh
 = 
	`jouº®_®loc_jouº®_h—d
();

2475 
	`jbd_lock_bh_jouº®_h—d
(
bh
);

2476 ià(
	`bufãr_jbd
(
bh
)) {

2477 
jh
 = 
	`bh2jh
(
bh
);

2479 
	`J_ASSERT_BH
(
bh
,

2480 (
	`©omic_»ad
(&
bh
->
b_couÁ
) > 0) ||

2481 (
bh
->
b_·ge
 && bh->b_·ge->
m­pšg
));

2483 ià(!
Ãw_jh
) {

2484 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2485 
»³©
;

2488 
jh
 = 
Ãw_jh
;

2489 
Ãw_jh
 = 
NULL
;

2490 
	`£t_bufãr_jbd
(
bh
);

2491 
bh
->
b_´iv©e
 = 
jh
;

2492 
jh
->
b_bh
 = 
bh
;

2493 
	`g‘_bh
(
bh
);

2494 
	`BUFFER_TRACE
(
bh
, "added journal_head");

2496 
jh
->
b_jcouÁ
++;

2497 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2498 ià(
Ãw_jh
)

2499 
	`jouº®_ä“_jouº®_h—d
(
Ãw_jh
);

2500  
bh
->
b_´iv©e
;

2501 
	}
}

2507 
jouº®_h—d
 *
	$jbd2_jouº®_g¿b_jouº®_h—d
(
bufãr_h—d
 *
bh
)

2509 
jouº®_h—d
 *
jh
 = 
NULL
;

2511 
	`jbd_lock_bh_jouº®_h—d
(
bh
);

2512 ià(
	`bufãr_jbd
(
bh
)) {

2513 
jh
 = 
	`bh2jh
(
bh
);

2514 
jh
->
b_jcouÁ
++;

2516 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2517  
jh
;

2518 
	}
}

2520 
	$__jouº®_»move_jouº®_h—d
(
bufãr_h—d
 *
bh
)

2522 
jouº®_h—d
 *
jh
 = 
	`bh2jh
(
bh
);

2524 
	`J_ASSERT_JH
(
jh
, jh->
b_jcouÁ
 >= 0);

2525 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
NULL
);

2526 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

2527 
	`J_ASSERT_JH
(
jh
, jh->
b_ı_Œª§ùiÚ
 =ğ
NULL
);

2528 
	`J_ASSERT_JH
(
jh
, jh->
b_jli¡
 =ğ
BJ_NÚe
);

2529 
	`J_ASSERT_BH
(
bh
, 
	`bufãr_jbd
(bh));

2530 
	`J_ASSERT_BH
(
bh
, 
	`jh2bh
(
jh
) == bh);

2531 
	`BUFFER_TRACE
(
bh
, "remove journal_head");

2532 ià(
jh
->
b_äoz’_d©a
) {

2533 
	`´štk
(
KERN_WARNING
 "%s: f»ešg b_äoz’_d©a\n", 
__func__
);

2534 
	`jbd2_ä“
(
jh
->
b_äoz’_d©a
, 
bh
->
b_size
);

2536 ià(
jh
->
b_comm™‹d_d©a
) {

2537 
	`´štk
(
KERN_WARNING
 "%s: f»ešg b_comm™‹d_d©a\n", 
__func__
);

2538 
	`jbd2_ä“
(
jh
->
b_comm™‹d_d©a
, 
bh
->
b_size
);

2540 
bh
->
b_´iv©e
 = 
NULL
;

2541 
jh
->
b_bh
 = 
NULL
;

2542 
	`ş—r_bufãr_jbd
(
bh
);

2543 
	`jouº®_ä“_jouº®_h—d
(
jh
);

2544 
	}
}

2550 
	$jbd2_jouº®_put_jouº®_h—d
(
jouº®_h—d
 *
jh
)

2552 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2554 
	`jbd_lock_bh_jouº®_h—d
(
bh
);

2555 
	`J_ASSERT_JH
(
jh
, jh->
b_jcouÁ
 > 0);

2556 --
jh
->
b_jcouÁ
;

2557 ià(!
jh
->
b_jcouÁ
) {

2558 
	`__jouº®_»move_jouº®_h—d
(
bh
);

2559 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2560 
	`__b»l£
(
bh
);

2562 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2563 
	}
}

2568 
	$jbd2_jouº®_š™_jbd_šode
(
jbd2_šode
 *
jšode
, 
šode
 *inode)

2570 
jšode
->
i_Œª§ùiÚ
 = 
NULL
;

2571 
jšode
->
i_Ãxt_Œª§ùiÚ
 = 
NULL
;

2572 
jšode
->
i_vfs_šode
 = 
šode
;

2573 
jšode
->
i_æags
 = 0;

2574 
jšode
->
i_dœty_¡¬t
 = 0;

2575 
jšode
->
i_dœty_’d
 = 0;

2576 
	`INIT_LIST_HEAD
(&
jšode
->
i_li¡
);

2577 
	}
}

2584 
	$jbd2_jouº®_»Ëa£_jbd_šode
(
jouº®_t
 *
jouº®
,

2585 
jbd2_šode
 *
jšode
)

2587 ià(!
jouº®
)

2589 
»¡¬t
:

2590 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2592 ià(
jšode
->
i_æags
 & 
JI_COMMIT_RUNNING
) {

2593 
wa™_queue_h—d_t
 *
wq
;

2594 
	`DEFINE_WAIT_BIT
(
wa™
, &
jšode
->
i_æags
, 
__JI_COMMIT_RUNNING
);

2595 
wq
 = 
	`b™_wa™queue
(&
jšode
->
i_æags
, 
__JI_COMMIT_RUNNING
);

2596 
	`´•¬e_to_wa™
(
wq
, &
wa™
.
wq_’Œy
, 
TASK_UNINTERRUPTIBLE
);

2597 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2598 
	`scheduË
();

2599 
	`fšish_wa™
(
wq
, &
wa™
.
wq_’Œy
);

2600 
»¡¬t
;

2603 ià(
jšode
->
i_Œª§ùiÚ
) {

2604 
	`li¡_d–
(&
jšode
->
i_li¡
);

2605 
jšode
->
i_Œª§ùiÚ
 = 
NULL
;

2607 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2608 
	}
}

2611 #ifdeà
CONFIG_PROC_FS


2613 
	#JBD2_STATS_PROC_NAME
 "fs/jbd2"

	)

2615 
__š™
 
	$jbd2_ü—‹_jbd_¡©s_´oc_’Œy
()

2617 
´oc_jbd2_¡©s
 = 
	`´oc_mkdœ
(
JBD2_STATS_PROC_NAME
, 
NULL
);

2618 
	}
}

2620 
__ex™
 
	$jbd2_»move_jbd_¡©s_´oc_’Œy
()

2622 ià(
´oc_jbd2_¡©s
)

2623 
	`»move_´oc_’Œy
(
JBD2_STATS_PROC_NAME
, 
NULL
);

2624 
	}
}

2628 
	#jbd2_ü—‹_jbd_¡©s_´oc_’Œy
(èdØ{} 0)

	)

2629 
	#jbd2_»move_jbd_¡©s_´oc_’Œy
(èdØ{} 0)

	)

2633 
kmem_ÿche
 *
	gjbd2_hªdË_ÿche
, *
	gjbd2_šode_ÿche
;

2635 
__š™
 
	$jbd2_jouº®_š™_šode_ÿche
()

2637 
	`J_ASSERT
(!
jbd2_šode_ÿche
);

2638 
jbd2_šode_ÿche
 = 
	`KMEM_CACHE
(
jbd2_šode
, 0);

2639 ià(!
jbd2_šode_ÿche
) {

2640 
	`´_em”g
("JBD2: failedo create inode cache\n");

2641  -
ENOMEM
;

2644 
	}
}

2646 
__š™
 
	$jbd2_jouº®_š™_hªdË_ÿche
()

2648 
	`J_ASSERT
(!
jbd2_hªdË_ÿche
);

2649 
jbd2_hªdË_ÿche
 = 
	`KMEM_CACHE
(
jbd2_jouº®_hªdË
, 
SLAB_TEMPORARY
);

2650 ià(!
jbd2_hªdË_ÿche
) {

2651 
	`´štk
(
KERN_EMERG
 "JBD2: failedo create handle cache\n");

2652  -
ENOMEM
;

2655 
	}
}

2657 
	$jbd2_jouº®_de¡roy_šode_ÿche
()

2659 
	`kmem_ÿche_de¡roy
(
jbd2_šode_ÿche
);

2660 
jbd2_šode_ÿche
 = 
NULL
;

2661 
	}
}

2663 
	$jbd2_jouº®_de¡roy_hªdË_ÿche
()

2665 
	`kmem_ÿche_de¡roy
(
jbd2_hªdË_ÿche
);

2666 
jbd2_hªdË_ÿche
 = 
NULL
;

2667 
	}
}

2673 
__š™
 
	$jouº®_š™_ÿches
()

2675 
»t
;

2677 
»t
 = 
	`jbd2_jouº®_š™_»voke_»cÜd_ÿche
();

2678 ià(
»t
 == 0)

2679 
»t
 = 
	`jbd2_jouº®_š™_»voke_bË_ÿche
();

2680 ià(
»t
 == 0)

2681 
»t
 = 
	`jbd2_jouº®_š™_jouº®_h—d_ÿche
();

2682 ià(
»t
 == 0)

2683 
»t
 = 
	`jbd2_jouº®_š™_hªdË_ÿche
();

2684 ià(
»t
 == 0)

2685 
»t
 = 
	`jbd2_jouº®_š™_šode_ÿche
();

2686 ià(
»t
 == 0)

2687 
»t
 = 
	`jbd2_jouº®_š™_Œª§ùiÚ_ÿche
();

2688  
»t
;

2689 
	}
}

2691 
	$jbd2_jouº®_de¡roy_ÿches
()

2693 
	`jbd2_jouº®_de¡roy_»voke_»cÜd_ÿche
();

2694 
	`jbd2_jouº®_de¡roy_»voke_bË_ÿche
();

2695 
	`jbd2_jouº®_de¡roy_jouº®_h—d_ÿche
();

2696 
	`jbd2_jouº®_de¡roy_hªdË_ÿche
();

2697 
	`jbd2_jouº®_de¡roy_šode_ÿche
();

2698 
	`jbd2_jouº®_de¡roy_Œª§ùiÚ_ÿche
();

2699 
	`jbd2_jouº®_de¡roy_¦abs
();

2700 
	}
}

2702 
__š™
 
	$jouº®_š™
()

2704 
»t
;

2706 
	`BUILD_BUG_ON
((
jouº®_su³rblock_s
) != 1024);

2708 
»t
 = 
	`jouº®_š™_ÿches
();

2709 ià(
»t
 == 0) {

2710 
	`jbd2_ü—‹_jbd_¡©s_´oc_’Œy
();

2712 
	`jbd2_jouº®_de¡roy_ÿches
();

2714  
»t
;

2715 
	}
}

2717 
__ex™
 
	$jouº®_ex™
()

2719 #ifdeà
CONFIG_JBD2_DEBUG


2720 
n
 = 
	`©omic_»ad
(&
Ä_jouº®_h—ds
);

2721 ià(
n
)

2722 
	`´štk
(
KERN_ERR
 "JBD2:†—ked %d jouº®_h—ds!\n", 
n
);

2724 
	`jbd2_»move_jbd_¡©s_´oc_’Œy
();

2725 
	`jbd2_jouº®_de¡roy_ÿches
();

2726 
	}
}

2728 
MODULE_LICENSE
("GPL");

2729 
moduË_š™
(
jouº®_š™
);

2730 
moduË_ex™
(
jouº®_ex™
);

	@jbd3/recovery.c

13 #iâdeà
__KERNEL__


14 
	~"jfs_u£r.h
"

16 
	~<lšux/time.h
>

17 
	~<lšux/fs.h
>

18 
	~<lšux/jbd2.h
>

19 
	~<lšux/”ºo.h
>

20 
	~<lšux/üc32.h
>

21 
	~<lšux/blkdev.h
>

28 
	s»cov”y_šfo


30 
tid_t
 
	m¡¬t_Œª§ùiÚ
;

31 
tid_t
 
	m’d_Œª§ùiÚ
;

33 
	mÄ_»¶ays
;

34 
	mÄ_»vokes
;

35 
	mÄ_»voke_h™s
;

38 
	e·s¡y³
 {
	mPASS_SCAN
, 
	mPASS_REVOKE
, 
	mPASS_REPLAY
};

39 
do_Úe_·ss
(
jouº®_t
 *
jouº®
,

40 
»cov”y_šfo
 *
šfo
, 
·s¡y³
 
·ss
);

41 
sÿn_»voke_»cÜds
(
jouº®_t
 *, 
bufãr_h—d
 *,

42 
tid_t
, 
»cov”y_šfo
 *);

44 #ifdeà
__KERNEL__


47 
	$jouº®_b»l£_¬¿y
(
bufãr_h—d
 *
b
[], 
n
)

49 --
n
 >= 0)

50 
	`b»l£
 (
b
[
n
]);

51 
	}
}

66 
	#MAXBUF
 8

	)

67 
	$do_»adah—d
(
jouº®_t
 *
jouº®
, 
¡¬t
)

69 
”r
;

70 
max
, 
nbufs
, 
Ãxt
;

71 
blockÄ
;

72 
bufãr_h—d
 *
bh
;

74 
bufãr_h—d
 * 
bufs
[
MAXBUF
];

77 
max
 = 
¡¬t
 + (128 * 1024 / 
jouº®
->
j_blocksize
);

78 ià(
max
 > 
jouº®
->
j_maxËn
)

79 
max
 = 
jouº®
->
j_maxËn
;

84 
nbufs
 = 0;

86 
Ãxt
 = 
¡¬t
;‚exˆ< 
max
;‚ext++) {

87 
”r
 = 
	`jbd2_jouº®_bm­
(
jouº®
, 
Ãxt
, &
blockÄ
);

89 ià(
”r
) {

90 
	`´štk
(
KERN_ERR
 "JBD2: bad block‡t offset %u\n",

91 
Ãxt
);

92 
çed
;

95 
bh
 = 
	`__g‘blk
(
jouº®
->
j_dev
, 
blockÄ
, jouº®->
j_blocksize
);

96 ià(!
bh
) {

97 
”r
 = -
ENOMEM
;

98 
çed
;

101 ià(!
	`bufãr_u±od©e
(
bh
è&& !
	`bufãr_locked
(bh)) {

102 
bufs
[
nbufs
++] = 
bh
;

103 ià(
nbufs
 =ğ
MAXBUF
) {

104 
	`Î_rw_block
(
REQ_OP_READ
, 0, 
nbufs
, 
bufs
);

105 
	`jouº®_b»l£_¬¿y
(
bufs
, 
nbufs
);

106 
nbufs
 = 0;

109 
	`b»l£
(
bh
);

112 ià(
nbufs
)

113 
	`Î_rw_block
(
REQ_OP_READ
, 0, 
nbufs
, 
bufs
);

114 
”r
 = 0;

116 
çed
:

117 ià(
nbufs
)

118 
	`jouº®_b»l£_¬¿y
(
bufs
, 
nbufs
);

119  
”r
;

120 
	}
}

129 
	$j»ad
(
bufãr_h—d
 **
bhp
, 
jouº®_t
 *
jouº®
,

130 
off£t
)

132 
”r
;

133 
blockÄ
;

134 
bufãr_h—d
 *
bh
;

136 *
bhp
 = 
NULL
;

138 ià(
off£t
 >ğ
jouº®
->
j_maxËn
) {

139 
	`´štk
(
KERN_ERR
 "JBD2: corrupted journal superblock\n");

140  -
EFSCORRUPTED
;

143 
”r
 = 
	`jbd2_jouº®_bm­
(
jouº®
, 
off£t
, &
blockÄ
);

145 ià(
”r
) {

146 
	`´štk
(
KERN_ERR
 "JBD2: bad block‡t offset %u\n",

147 
off£t
);

148  
”r
;

151 
bh
 = 
	`__g‘blk
(
jouº®
->
j_dev
, 
blockÄ
, jouº®->
j_blocksize
);

152 ià(!
bh
)

153  -
ENOMEM
;

155 ià(!
	`bufãr_u±od©e
(
bh
)) {

158 ià(!
	`bufãr_»q
(
bh
))

159 
	`do_»adah—d
(
jouº®
, 
off£t
);

160 
	`wa™_Ú_bufãr
(
bh
);

163 ià(!
	`bufãr_u±od©e
(
bh
)) {

164 
	`´štk
(
KERN_ERR
 "JBD2: Failedo„ead block‡t offset %u\n",

165 
off£t
);

166 
	`b»l£
(
bh
);

167  -
EIO
;

170 *
bhp
 = 
bh
;

172 
	}
}

174 
	$jbd2_desütÜ_block_csum_v”ify
(
jouº®_t
 *
j
, *
buf
)

176 
jbd2_jouº®_block_
 *

;

177 
__be32
 
´ovided
;

178 
__u32
 
ÿlcuÏ‹d
;

180 ià(!
	`jbd2_jouº®_has_csum_v2Ü3
(
j
))

183 

 = (
jbd2_jouº®_block_
 *)(
buf
 + 
j
->
j_blocksize
 -

184 (
jbd2_jouº®_block_
));

185 
´ovided
 = 

->
t_checksum
;

186 

->
t_checksum
 = 0;

187 
ÿlcuÏ‹d
 = 
	`jbd2_chksum
(
j
, j->
j_csum_£ed
, 
buf
, j->
j_blocksize
);

188 

->
t_checksum
 = 
´ovided
;

190  
´ovided
 =ğ
	`ıu_to_be32
(
ÿlcuÏ‹d
);

191 
	}
}

197 
	$couÁ_gs
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
)

199 * 
gp
;

200 
jouº®_block_g_t
 * 
g
;

201 
Ä
 = 0, 
size
 = 
jouº®
->
j_blocksize
;

202 
g_by‹s
 = 
	`jouº®_g_by‹s
(
jouº®
);

204 ià(
	`jbd2_jouº®_has_csum_v2Ü3
(
jouº®
))

205 
size
 -ğ(
jbd2_jouº®_block_
);

207 
gp
 = &
bh
->
b_d©a
[(
jouº®_h—d”_t
)];

209 (
gp
 - 
bh
->
b_d©a
 + 
g_by‹s
è<ğ
size
) {

210 
g
 = (
jouº®_block_g_t
 *è
gp
;

212 
Ä
++;

213 
gp
 +ğ
g_by‹s
;

214 ià(!(
g
->
t_æags
 & 
	`ıu_to_be16
(
JBD2_FLAG_SAME_UUID
)))

215 
gp
 += 16;

217 ià(
g
->
t_æags
 & 
	`ıu_to_be16
(
JBD2_FLAG_LAST_TAG
))

221  
Ä
;

222 
	}
}

226 
	#w¿p
(
jouº®
, 
v¬
) \

228 ià(
v¬
 >ğ(
jouº®
)->
j_Ï¡
) \

229 
v¬
 -ğ((
jouº®
)->
j_Ï¡
 - (jouº®)->
j_fœ¡
); \

230 } 0)

	)

244 
	$jbd2_jouº®_»cov”
(
jouº®_t
 *
jouº®
)

246 
”r
, 
”r2
;

247 
jouº®_su³rblock_t
 * 
sb
;

249 
»cov”y_šfo
 
šfo
;

251 
	`mem£t
(&
šfo
, 0, (info));

252 
sb
 = 
jouº®
->
j_su³rblock
;

260 ià(!
sb
->
s_¡¬t
) {

261 
	`jbd_debug
(1, "No„ecovery„equired,†astransaction %d\n",

262 
	`be32_to_ıu
(
sb
->
s_£qu’û
));

263 
jouº®
->
j_Œª§ùiÚ_£qu’û
 = 
	`be32_to_ıu
(
sb
->
s_£qu’û
) + 1;

267 
”r
 = 
	`do_Úe_·ss
(
jouº®
, &
šfo
, 
PASS_SCAN
);

268 ià(!
”r
)

269 
”r
 = 
	`do_Úe_·ss
(
jouº®
, &
šfo
, 
PASS_REVOKE
);

270 ià(!
”r
)

271 
”r
 = 
	`do_Úe_·ss
(
jouº®
, &
šfo
, 
PASS_REPLAY
);

273 
	`jbd_debug
(1, "JBD2:„ecovery,ƒxit status %d, "

275 
”r
, 
šfo
.
¡¬t_Œª§ùiÚ
, info.
’d_Œª§ùiÚ
);

276 
	`jbd_debug
(1, "JBD2: Replayed %d‡nd„evoked %d/%d blocks\n",

277 
šfo
.
Ä_»¶ays
, info.
Ä_»voke_h™s
, info.
Ä_»vokes
);

281 
jouº®
->
j_Œª§ùiÚ_£qu’û
 = ++
šfo
.
’d_Œª§ùiÚ
;

283 
	`jbd2_jouº®_ş—r_»voke
(
jouº®
);

284 
”r2
 = 
	`sync_blockdev
(
jouº®
->
j_fs_dev
);

285 ià(!
”r
)

286 
”r
 = 
”r2
;

288 ià(
jouº®
->
j_æags
 & 
JBD2_BARRIER
) {

289 
”r2
 = 
	`blkdev_issue_æush
(
jouº®
->
j_fs_dev
, 
GFP_KERNEL
, 
NULL
);

290 ià(!
”r
)

291 
”r
 = 
”r2
;

293  
”r
;

294 
	}
}

309 
	$jbd2_jouº®_sk_»cov”y
(
jouº®_t
 *
jouº®
)

311 
”r
;

313 
»cov”y_šfo
 
šfo
;

315 
	`mem£t
 (&
šfo
, 0, (info));

317 
”r
 = 
	`do_Úe_·ss
(
jouº®
, &
šfo
, 
PASS_SCAN
);

319 ià(
”r
) {

320 
	`´štk
(
KERN_ERR
 "JBD2:ƒ¼Ü %d sÿÂšg jouº®\n", 
”r
);

321 ++
jouº®
->
j_Œª§ùiÚ_£qu’û
;

323 #ifdeà
CONFIG_JBD2_DEBUG


324 
drİ³d
 = 
šfo
.
’d_Œª§ùiÚ
 -

325 
	`be32_to_ıu
(
jouº®
->
j_su³rblock
->
s_£qu’û
);

326 
	`jbd_debug
(1,

328 
drİ³d
, (dropped == 1) ? "" : "s");

330 
jouº®
->
j_Œª§ùiÚ_£qu’û
 = ++
šfo
.
’d_Œª§ùiÚ
;

333 
jouº®
->
j_
 = 0;

334  
”r
;

335 
	}
}

337 
šlše
 
	$»ad_g_block
(
jouº®_t
 *
jouº®
,

338 
jouº®_block_g_t
 *
g
)

340 
block
 = 
	`be32_to_ıu
(
g
->
t_blockÄ
);

341 ià(
	`jbd2_has_ã©u»_64b™
(
jouº®
))

342 
block
 |ğ(
u64
)
	`be32_to_ıu
(
g
->
t_blockÄ_high
) << 32;

343  
block
;

344 
	}
}

350 
	$ÿlc_chksums
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
,

351 *
Ãxt_log_block
, 
__u32
 *
üc32_sum
)

353 
i
, 
num_blks
, 
”r
;

354 
io_block
;

355 
bufãr_h—d
 *
obh
;

357 
num_blks
 = 
	`couÁ_gs
(
jouº®
, 
bh
);

359 *
üc32_sum
 = 
	`üc32_be
(*üc32_sum, (*)
bh
->
b_d©a
, bh->
b_size
);

361 
i
 = 0; i < 
num_blks
; i++) {

362 
io_block
 = (*
Ãxt_log_block
)++;

363 
	`w¿p
(
jouº®
, *
Ãxt_log_block
);

364 
”r
 = 
	`j»ad
(&
obh
, 
jouº®
, 
io_block
);

365 ià(
”r
) {

366 
	`´štk
(
KERN_ERR
 "JBD2: IOƒrror %d„ecovering block "

367 "%lu iÀlog\n", 
”r
, 
io_block
);

370 *
üc32_sum
 = 
	`üc32_be
(*üc32_sum, (*)
obh
->
b_d©a
,

371 
obh
->
b_size
);

373 
	`put_bh
(
obh
);

376 
	}
}

378 
	$jbd2_comm™_block_csum_v”ify
(
jouº®_t
 *
j
, *
buf
)

380 
comm™_h—d”
 *
h
;

381 
__be32
 
´ovided
;

382 
__u32
 
ÿlcuÏ‹d
;

384 ià(!
	`jbd2_jouº®_has_csum_v2Ü3
(
j
))

387 
h
 = 
buf
;

388 
´ovided
 = 
h
->
h_chksum
[0];

389 
h
->
h_chksum
[0] = 0;

390 
ÿlcuÏ‹d
 = 
	`jbd2_chksum
(
j
, j->
j_csum_£ed
, 
buf
, j->
j_blocksize
);

391 
h
->
h_chksum
[0] = 
´ovided
;

393  
´ovided
 =ğ
	`ıu_to_be32
(
ÿlcuÏ‹d
);

394 
	}
}

396 
	$jbd2_block_g_csum_v”ify
(
jouº®_t
 *
j
, 
jouº®_block_g_t
 *
g
,

397 *
buf
, 
__u32
 
£qu’û
)

399 
jouº®_block_g3_t
 *
g3
 = (jouº®_block_g3_ˆ*)
g
;

400 
__u32
 
csum32
;

401 
__be32
 
£q
;

403 ià(!
	`jbd2_jouº®_has_csum_v2Ü3
(
j
))

406 
£q
 = 
	`ıu_to_be32
(
£qu’û
);

407 
csum32
 = 
	`jbd2_chksum
(
j
, j->
j_csum_£ed
, (
__u8
 *)&
£q
, (seq));

408 
csum32
 = 
	`jbd2_chksum
(
j
, csum32, 
buf
, j->
j_blocksize
);

410 ià(
	`jbd2_has_ã©u»_csum3
(
j
))

411  
g3
->
t_checksum
 =ğ
	`ıu_to_be32
(
csum32
);

413  
g
->
t_checksum
 =ğ
	`ıu_to_be16
(
csum32
);

414 
	}
}

416 
	$do_Úe_·ss
(
jouº®_t
 *
jouº®
,

417 
»cov”y_šfo
 *
šfo
, 
·s¡y³
 
·ss
)

419 
fœ¡_comm™_ID
, 
Ãxt_comm™_ID
;

420 
Ãxt_log_block
;

421 
”r
, 
sucûss
 = 0;

422 
jouº®_su³rblock_t
 * 
sb
;

423 
jouº®_h—d”_t
 * 
tmp
;

424 
bufãr_h—d
 * 
bh
;

425 
£qu’û
;

426 
blockty³
;

427 
g_by‹s
 = 
	`jouº®_g_by‹s
(
jouº®
);

428 
__u32
 
üc32_sum
 = ~0;

429 
desü_csum_size
 = 0;

430 
block_”rÜ
 = 0;

438 
sb
 = 
jouº®
->
j_su³rblock
;

439 
Ãxt_comm™_ID
 = 
	`be32_to_ıu
(
sb
->
s_£qu’û
);

440 
Ãxt_log_block
 = 
	`be32_to_ıu
(
sb
->
s_¡¬t
);

442 
fœ¡_comm™_ID
 = 
Ãxt_comm™_ID
;

443 ià(
·ss
 =ğ
PASS_SCAN
)

444 
šfo
->
¡¬t_Œª§ùiÚ
 = 
fœ¡_comm™_ID
;

446 
	`jbd_debug
(1, "S¹šg„ecov”y…as %d\n", 
·ss
);

456 
æags
;

457 * 
gp
;

458 
jouº®_block_g_t
 * 
g
;

459 
bufãr_h—d
 * 
obh
;

460 
bufãr_h—d
 * 
nbh
;

462 
	`cÚd_»sched
();

468 ià(
·ss
 !ğ
PASS_SCAN
)

469 ià(
	`tid_geq
(
Ãxt_comm™_ID
, 
šfo
->
’d_Œª§ùiÚ
))

472 
	`jbd_debug
(2, "Scanning for sequence ID %u‡t %lu/%lu\n",

473 
Ãxt_comm™_ID
, 
Ãxt_log_block
, 
jouº®
->
j_Ï¡
);

479 
	`jbd_debug
(3, "JBD2: checkšg block %ld\n", 
Ãxt_log_block
);

480 
”r
 = 
	`j»ad
(&
bh
, 
jouº®
, 
Ãxt_log_block
);

481 ià(
”r
)

482 
çed
;

484 
Ãxt_log_block
++;

485 
	`w¿p
(
jouº®
, 
Ãxt_log_block
);

493 
tmp
 = (
jouº®_h—d”_t
 *)
bh
->
b_d©a
;

495 ià(
tmp
->
h_magic
 !ğ
	`ıu_to_be32
(
JBD2_MAGIC_NUMBER
)) {

496 
	`b»l£
(
bh
);

500 
blockty³
 = 
	`be32_to_ıu
(
tmp
->
h_blockty³
);

501 
£qu’û
 = 
	`be32_to_ıu
(
tmp
->
h_£qu’û
);

502 
	`jbd_debug
(3, "Found magic %d, sequence %d\n",

503 
blockty³
, 
£qu’û
);

505 ià(
£qu’û
 !ğ
Ãxt_comm™_ID
) {

506 
	`b»l£
(
bh
);

514 
blockty³
) {

515 
JBD2_DESCRIPTOR_BLOCK
:

517 ià(
	`jbd2_jouº®_has_csum_v2Ü3
(
jouº®
))

518 
desü_csum_size
 =

519 (
jbd2_jouº®_block_
);

520 ià(
desü_csum_size
 > 0 &&

521 !
	`jbd2_desütÜ_block_csum_v”ify
(
jouº®
,

522 
bh
->
b_d©a
)) {

523 
	`´štk
(
KERN_ERR
 "JBD2: Invalid checksum "

525 
Ãxt_log_block
);

526 
”r
 = -
EFSBADCRC
;

527 
	`b»l£
(
bh
);

528 
çed
;

535 ià(
·ss
 !ğ
PASS_REPLAY
) {

536 ià(
·ss
 =ğ
PASS_SCAN
 &&

537 
	`jbd2_has_ã©u»_checksum
(
jouº®
) &&

538 !
šfo
->
’d_Œª§ùiÚ
) {

539 ià(
	`ÿlc_chksums
(
jouº®
, 
bh
,

540 &
Ãxt_log_block
,

541 &
üc32_sum
)) {

542 
	`put_bh
(
bh
);

545 
	`put_bh
(
bh
);

548 
Ãxt_log_block
 +ğ
	`couÁ_gs
(
jouº®
, 
bh
);

549 
	`w¿p
(
jouº®
, 
Ãxt_log_block
);

550 
	`put_bh
(
bh
);

558 
gp
 = &
bh
->
b_d©a
[(
jouº®_h—d”_t
)];

559 (
gp
 - 
bh
->
b_d©a
 + 
g_by‹s
)

560 <ğ
jouº®
->
j_blocksize
 - 
desü_csum_size
) {

561 
io_block
;

563 
g
 = (
jouº®_block_g_t
 *è
gp
;

564 
æags
 = 
	`be16_to_ıu
(
g
->
t_æags
);

566 
io_block
 = 
Ãxt_log_block
++;

567 
	`w¿p
(
jouº®
, 
Ãxt_log_block
);

568 
”r
 = 
	`j»ad
(&
obh
, 
jouº®
, 
io_block
);

569 ià(
”r
) {

572 
sucûss
 = 
”r
;

573 
	`´štk
(
KERN_ERR


576 
”r
, 
io_block
);

578 
blockÄ
;

580 
	`J_ASSERT
(
obh
 !ğ
NULL
);

581 
blockÄ
 = 
	`»ad_g_block
(
jouº®
,

582 
g
);

587 ià(
jbd2_jouº®_‹¡_»voke


588 (
jouº®
, 
blockÄ
,

589 
Ãxt_comm™_ID
)) {

590 
	`b»l£
(
obh
);

591 ++
šfo
->
Ä_»voke_h™s
;

592 
sk_wr™e
;

596 ià(!
	`jbd2_block_g_csum_v”ify
(

597 
jouº®
, 
g
, 
obh
->
b_d©a
,

598 
	`be32_to_ıu
(
tmp
->
h_£qu’û
))) {

599 
	`b»l£
(
obh
);

600 
sucûss
 = -
EFSBADCRC
;

601 
	`´štk
(
KERN_ERR
 "JBD2: Invalid "

604 "log\n", 
blockÄ
);

605 
block_”rÜ
 = 1;

606 
sk_wr™e
;

611 
nbh
 = 
	`__g‘blk
(
jouº®
->
j_fs_dev
,

612 
blockÄ
,

613 
jouº®
->
j_blocksize
);

614 ià(
nbh
 =ğ
NULL
) {

615 
	`´štk
(
KERN_ERR


618 
”r
 = -
ENOMEM
;

619 
	`b»l£
(
bh
);

620 
	`b»l£
(
obh
);

621 
çed
;

624 
	`lock_bufãr
(
nbh
);

625 
	`memıy
(
nbh
->
b_d©a
, 
obh
->b_data,

626 
jouº®
->
j_blocksize
);

627 ià(
æags
 & 
JBD2_FLAG_ESCAPE
) {

628 *((
__be32
 *)
nbh
->
b_d©a
) =

629 
	`ıu_to_be32
(
JBD2_MAGIC_NUMBER
);

632 
	`BUFFER_TRACE
(
nbh
, "marking dirty");

633 
	`£t_bufãr_u±od©e
(
nbh
);

634 
	`m¬k_bufãr_dœty
(
nbh
);

635 
	`BUFFER_TRACE
(
nbh
, "marking uptodate");

636 ++
šfo
->
Ä_»¶ays
;

638 
	`uÆock_bufãr
(
nbh
);

639 
	`b»l£
(
obh
);

640 
	`b»l£
(
nbh
);

643 
sk_wr™e
:

644 
gp
 +ğ
g_by‹s
;

645 ià(!(
æags
 & 
JBD2_FLAG_SAME_UUID
))

646 
gp
 += 16;

648 ià(
æags
 & 
JBD2_FLAG_LAST_TAG
)

652 
	`b»l£
(
bh
);

655 
JBD2_COMMIT_BLOCK
:

691 ià(
·ss
 =ğ
PASS_SCAN
 &&

692 
	`jbd2_has_ã©u»_checksum
(
jouº®
)) {

693 
chksum_”r
, 
chksum_£’
;

694 
comm™_h—d”
 *
cbh
 =

695 (
comm™_h—d”
 *)
bh
->
b_d©a
;

696 
found_chksum
 =

697 
	`be32_to_ıu
(
cbh
->
h_chksum
[0]);

699 
chksum_”r
 = 
chksum_£’
 = 0;

701 ià(
šfo
->
’d_Œª§ùiÚ
) {

702 
jouº®
->
j_çed_comm™
 =

703 
šfo
->
’d_Œª§ùiÚ
;

704 
	`b»l£
(
bh
);

708 ià(
üc32_sum
 =ğ
found_chksum
 &&

709 
cbh
->
h_chksum_ty³
 =ğ
JBD2_CRC32_CHKSUM
 &&

710 
cbh
->
h_chksum_size
 ==

711 
JBD2_CRC32_CHKSUM_SIZE
)

712 
chksum_£’
 = 1;

713 ià(!(
cbh
->
h_chksum_ty³
 == 0 &&

714 
cbh
->
h_chksum_size
 == 0 &&

715 
found_chksum
 == 0 &&

716 !
chksum_£’
))

727 
chksum_”r
 = 1;

729 ià(
chksum_”r
) {

730 
šfo
->
’d_Œª§ùiÚ
 = 
Ãxt_comm™_ID
;

732 ià(!
	`jbd2_has_ã©u»_async_comm™
(
jouº®
)) {

733 
jouº®
->
j_çed_comm™
 =

734 
Ãxt_comm™_ID
;

735 
	`b»l£
(
bh
);

739 
üc32_sum
 = ~0;

741 ià(
·ss
 =ğ
PASS_SCAN
 &&

742 !
	`jbd2_comm™_block_csum_v”ify
(
jouº®
,

743 
bh
->
b_d©a
)) {

744 
šfo
->
’d_Œª§ùiÚ
 = 
Ãxt_comm™_ID
;

746 ià(!
	`jbd2_has_ã©u»_async_comm™
(
jouº®
)) {

747 
jouº®
->
j_çed_comm™
 =

748 
Ãxt_comm™_ID
;

749 
	`b»l£
(
bh
);

753 
	`b»l£
(
bh
);

754 
Ãxt_comm™_ID
++;

757 
JBD2_REVOKE_BLOCK
:

760 ià(
·ss
 !ğ
PASS_REVOKE
) {

761 
	`b»l£
(
bh
);

765 
”r
 = 
	`sÿn_»voke_»cÜds
(
jouº®
, 
bh
,

766 
Ãxt_comm™_ID
, 
šfo
);

767 
	`b»l£
(
bh
);

768 ià(
”r
)

769 
çed
;

773 
	`jbd_debug
(3, "Unrecognised magic %d,ƒnd of scan.\n",

774 
blockty³
);

775 
	`b»l£
(
bh
);

776 
dÚe
;

780 
dÚe
:

788 ià(
·ss
 =ğ
PASS_SCAN
) {

789 ià(!
šfo
->
’d_Œª§ùiÚ
)

790 
šfo
->
’d_Œª§ùiÚ
 = 
Ãxt_comm™_ID
;

794 ià(
šfo
->
’d_Œª§ùiÚ
 !ğ
Ãxt_comm™_ID
) {

795 
	`´štk
(
KERN_ERR
 "JBD2:„ecovery…ass %dƒnded‡t "

797 
·ss
, 
Ãxt_comm™_ID
, 
šfo
->
’d_Œª§ùiÚ
);

798 ià(!
sucûss
)

799 
sucûss
 = -
EIO
;

802 ià(
block_”rÜ
 && 
sucûss
 == 0)

803 
sucûss
 = -
EIO
;

804  
sucûss
;

806 
çed
:

807  
”r
;

808 
	}
}

812 
	$sÿn_»voke_»cÜds
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
,

813 
tid_t
 
£qu’û
, 
»cov”y_šfo
 *
šfo
)

815 
jbd2_jouº®_»voke_h—d”_t
 *
h—d”
;

816 
off£t
, 
max
;

817 
csum_size
 = 0;

818 
__u32
 
rcouÁ
;

819 
»cÜd_Ën
 = 4;

821 
h—d”
 = (
jbd2_jouº®_»voke_h—d”_t
 *è
bh
->
b_d©a
;

822 
off£t
 = (
jbd2_jouº®_»voke_h—d”_t
);

823 
rcouÁ
 = 
	`be32_to_ıu
(
h—d”
->
r_couÁ
);

825 ià(!
	`jbd2_desütÜ_block_csum_v”ify
(
jouº®
, 
h—d”
))

826  -
EFSBADCRC
;

828 ià(
	`jbd2_jouº®_has_csum_v2Ü3
(
jouº®
))

829 
csum_size
 = (
jbd2_jouº®_block_
);

830 ià(
rcouÁ
 > 
jouº®
->
j_blocksize
 - 
csum_size
)

831  -
EINVAL
;

832 
max
 = 
rcouÁ
;

834 ià(
	`jbd2_has_ã©u»_64b™
(
jouº®
))

835 
»cÜd_Ën
 = 8;

837 
off£t
 + 
»cÜd_Ën
 <ğ
max
) {

838 
blockÄ
;

839 
”r
;

841 ià(
»cÜd_Ën
 == 4)

842 
blockÄ
 = 
	`be32_to_ıu
(* ((
__be32
 *è(
bh
->
b_d©a
+
off£t
)));

844 
blockÄ
 = 
	`be64_to_ıu
(* ((
__be64
 *è(
bh
->
b_d©a
+
off£t
)));

845 
off£t
 +ğ
»cÜd_Ën
;

846 
”r
 = 
	`jbd2_jouº®_£t_»voke
(
jouº®
, 
blockÄ
, 
£qu’û
);

847 ià(
”r
)

848  
”r
;

849 ++
šfo
->
Ä_»vokes
;

852 
	}
}

	@jbd3/revoke.c

80 #iâdeà
__KERNEL__


81 
	~"jfs_u£r.h
"

83 
	~<lšux/time.h
>

84 
	~<lšux/fs.h
>

85 
	~<lšux/jbd2.h
>

86 
	~<lšux/”ºo.h
>

87 
	~<lšux/¦ab.h
>

88 
	~<lšux/li¡.h
>

89 
	~<lšux/š™.h
>

90 
	~<lšux/bio.h
>

91 
	~<lšux/log2.h
>

92 
	~<lšux/hash.h
>

95 
kmem_ÿche
 *
	gjbd2_»voke_»cÜd_ÿche
;

96 
kmem_ÿche
 *
	gjbd2_»voke_bË_ÿche
;

102 
	sjbd2_»voke_»cÜd_s


104 
li¡_h—d
 
	mhash
;

105 
tid_t
 
	m£qu’û
;

106 
	mblockÄ
;

111 
	sjbd2_»voke_bË_s


115 
	mhash_size
;

116 
	mhash_shiá
;

117 
li¡_h—d
 *
	mhash_bË
;

121 #ifdeà
__KERNEL__


122 
wr™e_Úe_»voke_»cÜd
(
Œª§ùiÚ_t
 *,

123 
li¡_h—d
 *,

124 
bufãr_h—d
 **, *,

125 
jbd2_»voke_»cÜd_s
 *);

126 
æush_desütÜ
(
jouº®_t
 *, 
bufãr_h—d
 *, );

131 
šlše
 
	$hash
(
jouº®_t
 *
jouº®
, 
block
)

133  
	`hash_64
(
block
, 
jouº®
->
j_»voke
->
hash_shiá
);

134 
	}
}

136 
	$š£¹_»voke_hash
(
jouº®_t
 *
jouº®
, 
blockÄ
,

137 
tid_t
 
£q
)

139 
li¡_h—d
 *
hash_li¡
;

140 
jbd2_»voke_»cÜd_s
 *
»cÜd
;

141 
gå_t
 
gå_mask
 = 
GFP_NOFS
;

143 ià(
jouº®_oom_»Œy
)

144 
gå_mask
 |ğ
__GFP_NOFAIL
;

145 
»cÜd
 = 
	`kmem_ÿche_®loc
(
jbd2_»voke_»cÜd_ÿche
, 
gå_mask
);

146 ià(!
»cÜd
)

147  -
ENOMEM
;

149 
»cÜd
->
£qu’û
 = 
£q
;

150 
»cÜd
->
blockÄ
 = blocknr;

151 
hash_li¡
 = &
jouº®
->
j_»voke
->
hash_bË
[
	`hash
(jouº®, 
blockÄ
)];

152 
	`¥š_lock
(&
jouº®
->
j_»voke_lock
);

153 
	`li¡_add
(&
»cÜd
->
hash
, 
hash_li¡
);

154 
	`¥š_uÆock
(&
jouº®
->
j_»voke_lock
);

156 
	}
}

160 
jbd2_»voke_»cÜd_s
 *
	$fšd_»voke_»cÜd
(
jouº®_t
 *
jouº®
,

161 
blockÄ
)

163 
li¡_h—d
 *
hash_li¡
;

164 
jbd2_»voke_»cÜd_s
 *
»cÜd
;

166 
hash_li¡
 = &
jouº®
->
j_»voke
->
hash_bË
[
	`hash
(jouº®, 
blockÄ
)];

168 
	`¥š_lock
(&
jouº®
->
j_»voke_lock
);

169 
»cÜd
 = (
jbd2_»voke_»cÜd_s
 *è
hash_li¡
->
Ãxt
;

170 &(
»cÜd
->
hash
è!ğ
hash_li¡
) {

171 ià(
»cÜd
->
blockÄ
 == blocknr) {

172 
	`¥š_uÆock
(&
jouº®
->
j_»voke_lock
);

173  
»cÜd
;

175 
»cÜd
 = (
jbd2_»voke_»cÜd_s
 *è»cÜd->
hash
.
Ãxt
;

177 
	`¥š_uÆock
(&
jouº®
->
j_»voke_lock
);

178  
NULL
;

179 
	}
}

181 
	$jbd2_jouº®_de¡roy_»voke_»cÜd_ÿche
()

183 
	`kmem_ÿche_de¡roy
(
jbd2_»voke_»cÜd_ÿche
);

184 
jbd2_»voke_»cÜd_ÿche
 = 
NULL
;

185 
	}
}

187 
	$jbd2_jouº®_de¡roy_»voke_bË_ÿche
()

189 
	`kmem_ÿche_de¡roy
(
jbd2_»voke_bË_ÿche
);

190 
jbd2_»voke_bË_ÿche
 = 
NULL
;

191 
	}
}

193 
__š™
 
	$jbd2_jouº®_š™_»voke_»cÜd_ÿche
()

195 
	`J_ASSERT
(!
jbd2_»voke_»cÜd_ÿche
);

196 
jbd2_»voke_»cÜd_ÿche
 = 
	`KMEM_CACHE
(
jbd2_»voke_»cÜd_s
,

197 
SLAB_HWCACHE_ALIGN
|
SLAB_TEMPORARY
);

199 ià(!
jbd2_»voke_»cÜd_ÿche
) {

200 
	`´_em”g
("JBD2: failedo create„evoke_record cache\n");

201  -
ENOMEM
;

204 
	}
}

206 
__š™
 
	$jbd2_jouº®_š™_»voke_bË_ÿche
()

208 
	`J_ASSERT
(!
jbd2_»voke_bË_ÿche
);

209 
jbd2_»voke_bË_ÿche
 = 
	`KMEM_CACHE
(
jbd2_»voke_bË_s
,

210 
SLAB_TEMPORARY
);

211 ià(!
jbd2_»voke_bË_ÿche
) {

212 
	`´_em”g
("JBD2: failedo create„evoke_table cache\n");

213  -
ENOMEM
;

216 
	}
}

218 
jbd2_»voke_bË_s
 *
	$jbd2_jouº®_š™_»voke_bË
(
hash_size
)

220 
shiá
 = 0;

221 
tmp
 = 
hash_size
;

222 
jbd2_»voke_bË_s
 *
bË
;

224 
bË
 = 
	`kmem_ÿche_®loc
(
jbd2_»voke_bË_ÿche
, 
GFP_KERNEL
);

225 ià(!
bË
)

226 
out
;

228 (
tmp
 >>= 1UL) != 0UL)

229 
shiá
++;

231 
bË
->
hash_size
 = hash_size;

232 
bË
->
hash_shiá
 = 
shiá
;

233 
bË
->
hash_bË
 =

234 
	`km®loc_¬¿y
(
hash_size
, (
li¡_h—d
), 
GFP_KERNEL
);

235 ià(!
bË
->
hash_bË
) {

236 
	`kmem_ÿche_ä“
(
jbd2_»voke_bË_ÿche
, 
bË
);

237 
bË
 = 
NULL
;

238 
out
;

241 
tmp
 = 0;m°< 
hash_size
;mp++)

242 
	`INIT_LIST_HEAD
(&
bË
->
hash_bË
[
tmp
]);

244 
out
:

245  
bË
;

246 
	}
}

248 
	$jbd2_jouº®_de¡roy_»voke_bË
(
jbd2_»voke_bË_s
 *
bË
)

250 
i
;

251 
li¡_h—d
 *
hash_li¡
;

253 
i
 = 0; i < 
bË
->
hash_size
; i++) {

254 
hash_li¡
 = &
bË
->
hash_bË
[
i
];

255 
	`J_ASSERT
(
	`li¡_em±y
(
hash_li¡
));

258 
	`kä“
(
bË
->
hash_bË
);

259 
	`kmem_ÿche_ä“
(
jbd2_»voke_bË_ÿche
, 
bË
);

260 
	}
}

263 
	$jbd2_jouº®_š™_»voke
(
jouº®_t
 *
jouº®
, 
hash_size
)

265 
	`J_ASSERT
(
jouº®
->
j_»voke_bË
[0] =ğ
NULL
);

266 
	`J_ASSERT
(
	`is_pow”_of_2
(
hash_size
));

268 
jouº®
->
j_»voke_bË
[0] = 
	`jbd2_jouº®_š™_»voke_bË
(
hash_size
);

269 ià(!
jouº®
->
j_»voke_bË
[0])

270 
ç0
;

272 
jouº®
->
j_»voke_bË
[1] = 
	`jbd2_jouº®_š™_»voke_bË
(
hash_size
);

273 ià(!
jouº®
->
j_»voke_bË
[1])

274 
ç1
;

276 
jouº®
->
j_»voke
 = jouº®->
j_»voke_bË
[1];

278 
	`¥š_lock_š™
(&
jouº®
->
j_»voke_lock
);

282 
ç1
:

283 
	`jbd2_jouº®_de¡roy_»voke_bË
(
jouº®
->
j_»voke_bË
[0]);

284 
jouº®
->
j_»voke_bË
[0] = 
NULL
;

285 
ç0
:

286  -
ENOMEM
;

287 
	}
}

290 
	$jbd2_jouº®_de¡roy_»voke
(
jouº®_t
 *
jouº®
)

292 
jouº®
->
j_»voke
 = 
NULL
;

293 ià(
jouº®
->
j_»voke_bË
[0])

294 
	`jbd2_jouº®_de¡roy_»voke_bË
(
jouº®
->
j_»voke_bË
[0]);

295 ià(
jouº®
->
j_»voke_bË
[1])

296 
	`jbd2_jouº®_de¡roy_»voke_bË
(
jouº®
->
j_»voke_bË
[1]);

297 
	}
}

300 #ifdeà
__KERNEL__


326 
	$jbd2_jouº®_»voke
(
hªdË_t
 *
hªdË
, 
blockÄ
,

327 
bufãr_h—d
 *
bh_š
)

329 
bufãr_h—d
 *
bh
 = 
NULL
;

330 
jouº®_t
 *
jouº®
;

331 
block_deviû
 *
bdev
;

332 
”r
;

334 
	`might_¦“p
();

335 ià(
bh_š
)

336 
	`BUFFER_TRACE
(
bh_š
, "enter");

338 
jouº®
 = 
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
;

339 ià(!
	`jbd2_jouº®_£t_ã©u»s
(
jouº®
, 0, 0, 
JBD2_FEATURE_INCOMPAT_REVOKE
)){

340 
	`J_ASSERT
 (!"Cannot set„evoke feature!");

341  -
EINVAL
;

344 
bdev
 = 
jouº®
->
j_fs_dev
;

345 
bh
 = 
bh_š
;

347 ià(!
bh
) {

348 
bh
 = 
	`__fšd_g‘_block
(
bdev
, 
blockÄ
, 
jouº®
->
j_blocksize
);

349 ià(
bh
)

350 
	`BUFFER_TRACE
(
bh
, "found on hash");

352 #ifdeà
JBD2_EXPENSIVE_CHECKING


354 
bufãr_h—d
 *
bh2
;

358 
bh2
 = 
	`__fšd_g‘_block
(
bdev
, 
blockÄ
, 
jouº®
->
j_blocksize
);

359 ià(
bh2
) {

361 ià(
bh2
 !ğ
bh
 && 
	`bufãr_»vokev®id
(bh2))

368 
	`J_ASSERT_BH
(
bh2
, 
	`bufãr_»voked
(bh2));

369 
	`put_bh
(
bh2
);

377 ià(
bh
) {

378 ià(!
	`J_EXPECT_BH
(
bh
, !
	`bufãr_»voked
(bh),

380 ià(!
bh_š
)

381 
	`b»l£
(
bh
);

382  -
EIO
;

384 
	`£t_bufãr_»voked
(
bh
);

385 
	`£t_bufãr_»vokev®id
(
bh
);

386 ià(
bh_š
) {

387 
	`BUFFER_TRACE
(
bh_š
, "call jbd2_journal_forget");

388 
	`jbd2_jouº®_fÜg‘
(
hªdË
, 
bh_š
);

390 
	`BUFFER_TRACE
(
bh
, "call brelse");

391 
	`__b»l£
(
bh
);

395 
	`jbd_debug
(2, "š£¹„evokfÜ block %Îu, bh_š=%p\n",
blockÄ
, 
bh_š
);

396 
”r
 = 
	`š£¹_»voke_hash
(
jouº®
, 
blockÄ
,

397 
hªdË
->
h_Œª§ùiÚ
->
t_tid
);

398 
	`BUFFER_TRACE
(
bh_š
, "exit");

399  
”r
;

400 
	}
}

417 
	$jbd2_jouº®_ÿnûl_»voke
(
hªdË_t
 *
hªdË
, 
jouº®_h—d
 *
jh
)

419 
jbd2_»voke_»cÜd_s
 *
»cÜd
;

420 
jouº®_t
 *
jouº®
 = 
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
;

421 
Ãed_ÿnûl
;

422 
did_»voke
 = 0;

423 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

425 
	`jbd_debug
(4, "jouº®_h—d %p, cªûÎšg„evoke\n", 
jh
);

431 ià(
	`‹¡_£t_bufãr_»vokev®id
(
bh
)) {

432 
Ãed_ÿnûl
 = 
	`‹¡_ş—r_bufãr_»voked
(
bh
);

434 
Ãed_ÿnûl
 = 1;

435 
	`ş—r_bufãr_»voked
(
bh
);

438 ià(
Ãed_ÿnûl
) {

439 
»cÜd
 = 
	`fšd_»voke_»cÜd
(
jouº®
, 
bh
->
b_blockÄ
);

440 ià(
»cÜd
) {

441 
	`jbd_debug
(4, "cancelledƒxisting„evoke on "

442 "blockÄ %Îu\n", ()
bh
->
b_blockÄ
);

443 
	`¥š_lock
(&
jouº®
->
j_»voke_lock
);

444 
	`li¡_d–
(&
»cÜd
->
hash
);

445 
	`¥š_uÆock
(&
jouº®
->
j_»voke_lock
);

446 
	`kmem_ÿche_ä“
(
jbd2_»voke_»cÜd_ÿche
, 
»cÜd
);

447 
did_»voke
 = 1;

451 #ifdeà
JBD2_EXPENSIVE_CHECKING


453 
»cÜd
 = 
	`fšd_»voke_»cÜd
(
jouº®
, 
bh
->
b_blockÄ
);

454 
	`J_ASSERT_JH
(
jh
, 
»cÜd
 =ğ
NULL
);

461 ià(
Ãed_ÿnûl
) {

462 
bufãr_h—d
 *
bh2
;

463 
bh2
 = 
	`__fšd_g‘_block
(
bh
->
b_bdev
, bh->
b_blockÄ
, bh->
b_size
);

464 ià(
bh2
) {

465 ià(
bh2
 !ğ
bh
)

466 
	`ş—r_bufãr_»voked
(
bh2
);

467 
	`__b»l£
(
bh2
);

470  
did_»voke
;

471 
	}
}

478 
	$jbd2_ş—r_bufãr_»voked_æags
(
jouº®_t
 *
jouº®
)

480 
jbd2_»voke_bË_s
 *
»voke
 = 
jouº®
->
j_»voke
;

481 
i
 = 0;

483 
i
 = 0; i < 
»voke
->
hash_size
; i++) {

484 
li¡_h—d
 *
hash_li¡
;

485 
li¡_h—d
 *
li¡_’Œy
;

486 
hash_li¡
 = &
»voke
->
hash_bË
[
i
];

488 
	`li¡_fÜ_—ch
(
li¡_’Œy
, 
hash_li¡
) {

489 
jbd2_»voke_»cÜd_s
 *
»cÜd
;

490 
bufãr_h—d
 *
bh
;

491 
»cÜd
 = (
jbd2_»voke_»cÜd_s
 *)
li¡_’Œy
;

492 
bh
 = 
	`__fšd_g‘_block
(
jouº®
->
j_fs_dev
,

493 
»cÜd
->
blockÄ
,

494 
jouº®
->
j_blocksize
);

495 ià(
bh
) {

496 
	`ş—r_bufãr_»voked
(
bh
);

497 
	`__b»l£
(
bh
);

501 
	}
}

507 
	$jbd2_jouº®_sw™ch_»voke_bË
(
jouº®_t
 *
jouº®
)

509 
i
;

511 ià(
jouº®
->
j_»voke
 =ğjouº®->
j_»voke_bË
[0])

512 
jouº®
->
j_»voke
 = jouº®->
j_»voke_bË
[1];

514 
jouº®
->
j_»voke
 = jouº®->
j_»voke_bË
[0];

516 
i
 = 0; i < 
jouº®
->
j_»voke
->
hash_size
; i++)

517 
	`INIT_LIST_HEAD
(&
jouº®
->
j_»voke
->
hash_bË
[
i
]);

518 
	}
}

524 
	$jbd2_jouº®_wr™e_»voke_»cÜds
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
,

525 
li¡_h—d
 *
log_bufs
)

527 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

528 
bufãr_h—d
 *
desütÜ
;

529 
jbd2_»voke_»cÜd_s
 *
»cÜd
;

530 
jbd2_»voke_bË_s
 *
»voke
;

531 
li¡_h—d
 *
hash_li¡
;

532 
i
, 
off£t
, 
couÁ
;

534 
desütÜ
 = 
NULL
;

535 
off£t
 = 0;

536 
couÁ
 = 0;

539 
»voke
 = 
jouº®
->
j_»voke
 =ğjouº®->
j_»voke_bË
[0] ?

540 
jouº®
->
j_»voke_bË
[1] : journal->j_revoke_table[0];

542 
i
 = 0; i < 
»voke
->
hash_size
; i++) {

543 
hash_li¡
 = &
»voke
->
hash_bË
[
i
];

545 !
	`li¡_em±y
(
hash_li¡
)) {

546 
»cÜd
 = (
jbd2_»voke_»cÜd_s
 *)

547 
hash_li¡
->
Ãxt
;

548 
	`wr™e_Úe_»voke_»cÜd
(
Œª§ùiÚ
, 
log_bufs
,

549 &
desütÜ
, &
off£t
, 
»cÜd
);

550 
couÁ
++;

551 
	`li¡_d–
(&
»cÜd
->
hash
);

552 
	`kmem_ÿche_ä“
(
jbd2_»voke_»cÜd_ÿche
, 
»cÜd
);

555 ià(
desütÜ
)

556 
	`æush_desütÜ
(
jouº®
, 
desütÜ
, 
off£t
);

557 
	`jbd_debug
(1, "WrÙ%d„evok»cÜds\n", 
couÁ
);

558 
	}
}

565 
	$wr™e_Úe_»voke_»cÜd
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
,

566 
li¡_h—d
 *
log_bufs
,

567 
bufãr_h—d
 **
desütÜp
,

568 *
off£
,

569 
jbd2_»voke_»cÜd_s
 *
»cÜd
)

571 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

572 
csum_size
 = 0;

573 
bufãr_h—d
 *
desütÜ
;

574 
sz
, 
off£t
;

580 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

583 
desütÜ
 = *
desütÜp
;

584 
off£t
 = *
off£
;

587 ià(
	`jbd2_jouº®_has_csum_v2Ü3
(
jouº®
))

588 
csum_size
 = (
jbd2_jouº®_block_
);

590 ià(
	`jbd2_has_ã©u»_64b™
(
jouº®
))

591 
sz
 = 8;

593 
sz
 = 4;

596 ià(
desütÜ
) {

597 ià(
off£t
 + 
sz
 > 
jouº®
->
j_blocksize
 - 
csum_size
) {

598 
	`æush_desütÜ
(
jouº®
, 
desütÜ
, 
off£t
);

599 
desütÜ
 = 
NULL
;

603 ià(!
desütÜ
) {

604 
desütÜ
 = 
	`jbd2_jouº®_g‘_desütÜ_bufãr
(
Œª§ùiÚ
,

605 
JBD2_REVOKE_BLOCK
);

606 ià(!
desütÜ
)

610 
	`BUFFER_TRACE
(
desütÜ
, "file in†og_bufs");

611 
	`jbd2_fe_log_bh
(
log_bufs
, 
desütÜ
);

613 
off£t
 = (
jbd2_jouº®_»voke_h—d”_t
);

614 *
desütÜp
 = 
desütÜ
;

617 ià(
	`jbd2_has_ã©u»_64b™
(
jouº®
))

618 * ((
__be64
 *)(&
desütÜ
->
b_d©a
[
off£t
])) =

619 
	`ıu_to_be64
(
»cÜd
->
blockÄ
);

621 * ((
__be32
 *)(&
desütÜ
->
b_d©a
[
off£t
])) =

622 
	`ıu_to_be32
(
»cÜd
->
blockÄ
);

623 
off£t
 +ğ
sz
;

625 *
off£
 = 
off£t
;

626 
	}
}

635 
	$æush_desütÜ
(
jouº®_t
 *
jouº®
,

636 
bufãr_h—d
 *
desütÜ
,

637 
off£t
)

639 
jbd2_jouº®_»voke_h—d”_t
 *
h—d”
;

641 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

644 
h—d”
 = (
jbd2_jouº®_»voke_h—d”_t
 *)
desütÜ
->
b_d©a
;

645 
h—d”
->
r_couÁ
 = 
	`ıu_to_be32
(
off£t
);

646 
	`jbd2_desütÜ_block_csum_£t
(
jouº®
, 
desütÜ
);

648 
	`£t_bufãr_jwr™e
(
desütÜ
);

649 
	`BUFFER_TRACE
(
desütÜ
, "write");

650 
	`£t_bufãr_dœty
(
desütÜ
);

651 
	`wr™e_dœty_bufãr
(
desütÜ
, 
REQ_SYNC
);

652 
	}
}

677 
	$jbd2_jouº®_£t_»voke
(
jouº®_t
 *
jouº®
,

678 
blockÄ
,

679 
tid_t
 
£qu’û
)

681 
jbd2_»voke_»cÜd_s
 *
»cÜd
;

683 
»cÜd
 = 
	`fšd_»voke_»cÜd
(
jouº®
, 
blockÄ
);

684 ià(
»cÜd
) {

687 ià(
	`tid_gt
(
£qu’û
, 
»cÜd
->sequence))

688 
»cÜd
->
£qu’û
 = sequence;

691  
	`š£¹_»voke_hash
(
jouº®
, 
blockÄ
, 
£qu’û
);

692 
	}
}

701 
	$jbd2_jouº®_‹¡_»voke
(
jouº®_t
 *
jouº®
,

702 
blockÄ
,

703 
tid_t
 
£qu’û
)

705 
jbd2_»voke_»cÜd_s
 *
»cÜd
;

707 
»cÜd
 = 
	`fšd_»voke_»cÜd
(
jouº®
, 
blockÄ
);

708 ià(!
»cÜd
)

710 ià(
	`tid_gt
(
£qu’û
, 
»cÜd
->sequence))

713 
	}
}

720 
	$jbd2_jouº®_ş—r_»voke
(
jouº®_t
 *
jouº®
)

722 
i
;

723 
li¡_h—d
 *
hash_li¡
;

724 
jbd2_»voke_»cÜd_s
 *
»cÜd
;

725 
jbd2_»voke_bË_s
 *
»voke
;

727 
»voke
 = 
jouº®
->
j_»voke
;

729 
i
 = 0; i < 
»voke
->
hash_size
; i++) {

730 
hash_li¡
 = &
»voke
->
hash_bË
[
i
];

731 !
	`li¡_em±y
(
hash_li¡
)) {

732 
»cÜd
 = (
jbd2_»voke_»cÜd_s
*è
hash_li¡
->
Ãxt
;

733 
	`li¡_d–
(&
»cÜd
->
hash
);

734 
	`kmem_ÿche_ä“
(
jbd2_»voke_»cÜd_ÿche
, 
»cÜd
);

737 
	}
}

	@jbd3/transaction.c

17 
	~<lšux/time.h
>

18 
	~<lšux/fs.h
>

19 
	~<lšux/jbd2.h
>

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/¦ab.h
>

22 
	~<lšux/tim”.h
>

23 
	~<lšux/mm.h
>

24 
	~<lšux/highmem.h
>

25 
	~<lšux/h¹im”.h
>

26 
	~<lšux/backšg-dev.h
>

27 
	~<lšux/bug.h
>

28 
	~<lšux/moduË.h
>

29 
	~<lšux/sched/mm.h
>

31 
	~<Œaû/ev’ts/jbd2.h
>

33 
__jbd2_jouº®_‹mp_uÆšk_bufãr
(
jouº®_h—d
 *
jh
);

34 
__jbd2_jouº®_unfe_bufãr
(
jouº®_h—d
 *
jh
);

36 
kmem_ÿche
 *
	gŒª§ùiÚ_ÿche
;

37 
__š™
 
	$jbd2_jouº®_š™_Œª§ùiÚ_ÿche
()

39 
	`J_ASSERT
(!
Œª§ùiÚ_ÿche
);

40 
Œª§ùiÚ_ÿche
 = 
	`kmem_ÿche_ü—‹
("jbd2_transaction_s",

41 (
Œª§ùiÚ_t
),

43 
SLAB_HWCACHE_ALIGN
|
SLAB_TEMPORARY
,

44 
NULL
);

45 ià(!
Œª§ùiÚ_ÿche
) {

46 
	`´_em”g
("JBD2: failedo createransaction cache\n");

47  -
ENOMEM
;

50 
	}
}

52 
	$jbd2_jouº®_de¡roy_Œª§ùiÚ_ÿche
()

54 
	`kmem_ÿche_de¡roy
(
Œª§ùiÚ_ÿche
);

55 
Œª§ùiÚ_ÿche
 = 
NULL
;

56 
	}
}

58 
	$jbd2_jouº®_ä“_Œª§ùiÚ
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

60 ià(
	`uÆik–y
(
	`ZERO_OR_NULL_PTR
(
Œª§ùiÚ
)))

62 
	`kmem_ÿche_ä“
(
Œª§ùiÚ_ÿche
, 
Œª§ùiÚ
);

63 
	}
}

80 
	$jbd2_g‘_Œª§ùiÚ
(
jouº®_t
 *
jouº®
,

81 
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

83 
Œª§ùiÚ
->
t_jouº®
 = 
jouº®
;

84 
Œª§ùiÚ
->
t_¡©e
 = 
T_RUNNING
;

85 
Œª§ùiÚ
->
t_¡¬t_time
 = 
	`ktime_g‘
();

86 
Œª§ùiÚ
->
t_tid
 = 
jouº®
->
j_Œª§ùiÚ_£qu’û
++;

87 
Œª§ùiÚ
->
t_expœes
 = 
jiff›s
 + 
jouº®
->
j_comm™_š‹rv®
;

88 
	`¥š_lock_š™
(&
Œª§ùiÚ
->
t_hªdË_lock
);

89 
	`©omic_£t
(&
Œª§ùiÚ
->
t_upd©es
, 0);

90 
	`©omic_£t
(&
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
,

91 
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
));

92 
	`©omic_£t
(&
Œª§ùiÚ
->
t_hªdË_couÁ
, 0);

93 
	`INIT_LIST_HEAD
(&
Œª§ùiÚ
->
t_šode_li¡
);

94 
	`INIT_LIST_HEAD
(&
Œª§ùiÚ
->
t_´iv©e_li¡
);

97 
jouº®
->
j_comm™_tim”
.
expœes
 = 
	`round_jiff›s_up
(
Œª§ùiÚ
->
t_expœes
);

98 
	`add_tim”
(&
jouº®
->
j_comm™_tim”
);

100 
	`J_ASSERT
(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 =ğ
NULL
);

101 
jouº®
->
j_ruÂšg_Œª§ùiÚ
 = 
Œª§ùiÚ
;

102 
Œª§ùiÚ
->
t_max_wa™
 = 0;

103 
Œª§ùiÚ
->
t_¡¬t
 = 
jiff›s
;

104 
Œª§ùiÚ
->
t_»que¡ed
 = 0;

105 
	}
}

125 
šlše
 
	$upd©e_t_max_wa™
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
,

126 
ts
)

128 #ifdeà
CONFIG_JBD2_DEBUG


129 ià(
jbd2_jouº®_’abË_debug
 &&

130 
	`time_aá”
(
Œª§ùiÚ
->
t_¡¬t
, 
ts
)) {

131 
ts
 = 
	`jbd2_time_diff
Ñs, 
Œª§ùiÚ
->
t_¡¬t
);

132 
	`¥š_lock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

133 ià(
ts
 > 
Œª§ùiÚ
->
t_max_wa™
)

134 
Œª§ùiÚ
->
t_max_wa™
 = 
ts
;

135 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

138 
	}
}

145 
	$wa™_Œª§ùiÚ_locked
(
jouº®_t
 *
jouº®
)

146 
	`__»Ëa£s
(
jouº®
->
j_¡©e_lock
)

148 
	`DEFINE_WAIT
(
wa™
);

149 
Ãed_to_¡¬t
;

150 
tid_t
 
tid
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
;

152 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
, &
wa™
,

153 
TASK_UNINTERRUPTIBLE
);

154 
Ãed_to_¡¬t
 = !
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
tid
);

155 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

156 ià(
Ãed_to_¡¬t
)

157 
	`jbd2_log_¡¬t_comm™
(
jouº®
, 
tid
);

158 
	`jbd2_might_wa™_fÜ_comm™
(
jouº®
);

159 
	`scheduË
();

160 
	`fšish_wa™
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
, &
wa™
);

161 
	}
}

168 
	$wa™_Œª§ùiÚ_sw™chšg
(
jouº®_t
 *
jouº®
)

169 
	`__»Ëa£s
(
jouº®
->
j_¡©e_lock
)

171 
	`DEFINE_WAIT
(
wa™
);

173 ià(
	`WARN_ON
(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
 ||

174 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_¡©e
 !ğ
T_SWITCH
))

176 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
, &
wa™
,

177 
TASK_UNINTERRUPTIBLE
);

178 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

185 
	`scheduË
();

186 
	`fšish_wa™
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
, &
wa™
);

187 
	}
}

189 
	$sub_»£rved_üed™s
(
jouº®_t
 *
jouº®
, 
blocks
)

191 
	`©omic_sub
(
blocks
, &
jouº®
->
j_»£rved_üed™s
);

192 
	`wake_up
(&
jouº®
->
j_wa™_»£rved
);

193 
	}
}

201 
	$add_Œª§ùiÚ_üed™s
(
jouº®_t
 *
jouº®
, 
blocks
,

202 
rsv_blocks
)

204 
Œª§ùiÚ_t
 *
t
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

205 
Ãeded
;

206 
tÙ®
 = 
blocks
 + 
rsv_blocks
;

212 ià(
t
->
t_¡©e
 !ğ
T_RUNNING
) {

213 
	`WARN_ON_ONCE
(
t
->
t_¡©e
 >ğ
T_FLUSH
);

214 
	`wa™_Œª§ùiÚ_locked
(
jouº®
);

223 
Ãeded
 = 
	`©omic_add_»tuº
(
tÙ®
, &
t
->
t_out¡ªdšg_üed™s
);

224 ià(
Ãeded
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
) {

230 
	`©omic_sub
(
tÙ®
, &
t
->
t_out¡ªdšg_üed™s
);

236 ià(
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
è+ 
tÙ®
 >

237 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
) {

238 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

239 
	`jbd2_might_wa™_fÜ_comm™
(
jouº®
);

240 
	`wa™_ev’t
(
jouº®
->
j_wa™_»£rved
,

241 
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
è+ 
tÙ®
 <=

242 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
);

246 
	`wa™_Œª§ùiÚ_locked
(
jouº®
);

261 ià(
	`jbd2_log_¥aû_Ëá
(
jouº®
è< 
	`jbd2_¥aû_Ãeded
(journal)) {

262 
	`©omic_sub
(
tÙ®
, &
t
->
t_out¡ªdšg_üed™s
);

263 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

264 
	`jbd2_might_wa™_fÜ_comm™
(
jouº®
);

265 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

266 ià(
	`jbd2_log_¥aû_Ëá
(
jouº®
è< 
	`jbd2_¥aû_Ãeded
(journal))

267 
	`__jbd2_log_wa™_fÜ_¥aû
(
jouº®
);

268 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

273 ià(!
rsv_blocks
)

276 
Ãeded
 = 
	`©omic_add_»tuº
(
rsv_blocks
, &
jouº®
->
j_»£rved_üed™s
);

278 ià(
Ãeded
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
 / 2) {

279 
	`sub_»£rved_üed™s
(
jouº®
, 
rsv_blocks
);

280 
	`©omic_sub
(
tÙ®
, &
t
->
t_out¡ªdšg_üed™s
);

281 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

282 
	`jbd2_might_wa™_fÜ_comm™
(
jouº®
);

283 
	`wa™_ev’t
(
jouº®
->
j_wa™_»£rved
,

284 
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
è+ 
rsv_blocks


285 <ğ
jouº®
->
j_max_Œª§ùiÚ_bufãrs
 / 2);

289 
	}
}

298 
	$¡¬t_this_hªdË
(
jouº®_t
 *
jouº®
, 
hªdË_t
 *
hªdË
,

299 
gå_t
 
gå_mask
)

301 
Œª§ùiÚ_t
 *
Œª§ùiÚ
, *
Ãw_Œª§ùiÚ
 = 
NULL
;

302 
blocks
 = 
hªdË
->
h_bufãr_üed™s
;

303 
rsv_blocks
 = 0;

304 
ts
 = 
jiff›s
;

306 ià(
hªdË
->
h_rsv_hªdË
)

307 
rsv_blocks
 = 
hªdË
->
h_rsv_hªdË
->
h_bufãr_üed™s
;

314 ià((
rsv_blocks
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
 / 2) ||

315 (
rsv_blocks
 + 
blocks
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
)) {

316 
	`´štk
(
KERN_ERR
 "JBD2: %s wantsoo many credits "

318 
cu¼’t
->
comm
, 
blocks
, 
rsv_blocks
,

319 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
);

320 
	`WARN_ON
(1);

321  -
ENOSPC
;

324 
®loc_Œª§ùiÚ
:

325 ià(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

330 ià((
gå_mask
 & 
__GFP_FS
) == 0)

331 
gå_mask
 |ğ
__GFP_NOFAIL
;

332 
Ãw_Œª§ùiÚ
 = 
	`kmem_ÿche_z®loc
(
Œª§ùiÚ_ÿche
,

333 
gå_mask
);

334 ià(!
Ãw_Œª§ùiÚ
)

335  -
ENOMEM
;

338 
	`jbd_debug
(3, "New hªdË %°gošg†ive.\n", 
hªdË
);

344 
»³©
:

345 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

346 
	`BUG_ON
(
jouº®
->
j_æags
 & 
JBD2_UNMOUNT
);

347 ià(
	`is_jouº®_abÜ‹d
(
jouº®
) ||

348 (
jouº®
->
j_”ºo
 !ğ0 && !(jouº®->
j_æags
 & 
JBD2_ACK_ERR
))) {

349 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

350 
	`jbd2_jouº®_ä“_Œª§ùiÚ
(
Ãw_Œª§ùiÚ
);

351  -
EROFS
;

359 ià(!
hªdË
->
h_»£rved
 && 
jouº®
->
j_b¬r›r_couÁ
) {

360 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

361 
	`wa™_ev’t
(
jouº®
->
j_wa™_Œª§ùiÚ_locked
,

362 
jouº®
->
j_b¬r›r_couÁ
 == 0);

363 
»³©
;

366 ià(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

367 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

368 ià(!
Ãw_Œª§ùiÚ
)

369 
®loc_Œª§ùiÚ
;

370 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

371 ià(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
 &&

372 (
hªdË
->
h_»£rved
 || !
jouº®
->
j_b¬r›r_couÁ
)) {

373 
	`jbd2_g‘_Œª§ùiÚ
(
jouº®
, 
Ãw_Œª§ùiÚ
);

374 
Ãw_Œª§ùiÚ
 = 
NULL
;

376 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

377 
»³©
;

380 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

382 ià(!
hªdË
->
h_»£rved
) {

384 ià(
	`add_Œª§ùiÚ_üed™s
(
jouº®
, 
blocks
, 
rsv_blocks
))

385 
»³©
;

394 ià(
Œª§ùiÚ
->
t_¡©e
 =ğ
T_SWITCH
) {

395 
	`wa™_Œª§ùiÚ_sw™chšg
(
jouº®
);

396 
»³©
;

398 
	`sub_»£rved_üed™s
(
jouº®
, 
blocks
);

399 
hªdË
->
h_»£rved
 = 0;

405 
	`upd©e_t_max_wa™
(
Œª§ùiÚ
, 
ts
);

406 
hªdË
->
h_Œª§ùiÚ
 = 
Œª§ùiÚ
;

407 
hªdË
->
h_»que¡ed_üed™s
 = 
blocks
;

408 
hªdË
->
h_¡¬t_jiff›s
 = 
jiff›s
;

409 
	`©omic_šc
(&
Œª§ùiÚ
->
t_upd©es
);

410 
	`©omic_šc
(&
Œª§ùiÚ
->
t_hªdË_couÁ
);

411 
	`jbd_debug
(4, "Handle %p given %d credits (total %d, free %lu)\n",

412 
hªdË
, 
blocks
,

413 
	`©omic_»ad
(&
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
),

414 
	`jbd2_log_¥aû_Ëá
(
jouº®
));

415 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

416 
cu¼’t
->
jouº®_šfo
 = 
hªdË
;

418 
	`rw£m_acquœe_»ad
(&
jouº®
->
j_Œªs_comm™_m­
, 0, 0, 
_THIS_IP_
);

419 
	`jbd2_jouº®_ä“_Œª§ùiÚ
(
Ãw_Œª§ùiÚ
);

424 
hªdË
->
§ved_®loc_cÚ‹xt
 = 
	`mem®loc_nofs_§ve
();

426 
	}
}

429 
hªdË_t
 *
	$Ãw_hªdË
(
nblocks
)

431 
hªdË_t
 *
hªdË
 = 
	`jbd2_®loc_hªdË
(
GFP_NOFS
);

432 ià(!
hªdË
)

433  
NULL
;

434 
hªdË
->
h_bufãr_üed™s
 = 
nblocks
;

435 
hªdË
->
h_»f
 = 1;

437  
hªdË
;

438 
	}
}

440 
hªdË_t
 *
	$jbd2__jouº®_¡¬t
(
jouº®_t
 *
jouº®
, 
nblocks
, 
rsv_blocks
,

441 
gå_t
 
gå_mask
, 
ty³
,

442 
lše_no
)

444 
hªdË_t
 *
hªdË
 = 
	`jouº®_cu¼’t_hªdË
();

445 
”r
;

447 ià(!
jouº®
)

448  
	`ERR_PTR
(-
EROFS
);

450 ià(
hªdË
) {

451 
	`J_ASSERT
(
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
 =ğ
jouº®
);

452 
hªdË
->
h_»f
++;

453  
hªdË
;

456 
hªdË
 = 
	`Ãw_hªdË
(
nblocks
);

457 ià(!
hªdË
)

458  
	`ERR_PTR
(-
ENOMEM
);

459 ià(
rsv_blocks
) {

460 
hªdË_t
 *
rsv_hªdË
;

462 
rsv_hªdË
 = 
	`Ãw_hªdË
(
rsv_blocks
);

463 ià(!
rsv_hªdË
) {

464 
	`jbd2_ä“_hªdË
(
hªdË
);

465  
	`ERR_PTR
(-
ENOMEM
);

467 
rsv_hªdË
->
h_»£rved
 = 1;

468 
rsv_hªdË
->
h_jouº®
 = 
jouº®
;

469 
hªdË
->
h_rsv_hªdË
 = 
rsv_hªdË
;

472 
”r
 = 
	`¡¬t_this_hªdË
(
jouº®
, 
hªdË
, 
gå_mask
);

473 ià(
”r
 < 0) {

474 ià(
hªdË
->
h_rsv_hªdË
)

475 
	`jbd2_ä“_hªdË
(
hªdË
->
h_rsv_hªdË
);

476 
	`jbd2_ä“_hªdË
(
hªdË
);

477  
	`ERR_PTR
(
”r
);

479 
hªdË
->
h_ty³
 = 
ty³
;

480 
hªdË
->
h_lše_no
 = 
lše_no
;

481 
	`Œaû_jbd2_hªdË_¡¬t
(
jouº®
->
j_fs_dev
->
bd_dev
,

482 
hªdË
->
h_Œª§ùiÚ
->
t_tid
, 
ty³
,

483 
lše_no
, 
nblocks
);

485  
hªdË
;

486 
	}
}

487 
EXPORT_SYMBOL
(
jbd2__jouº®_¡¬t
);

509 
hªdË_t
 *
	$jbd2_jouº®_¡¬t
(
jouº®_t
 *
jouº®
, 
nblocks
)

511  
	`jbd2__jouº®_¡¬t
(
jouº®
, 
nblocks
, 0, 
GFP_NOFS
, 0, 0);

512 
	}
}

513 
EXPORT_SYMBOL
(
jbd2_jouº®_¡¬t
);

515 
	$jbd2_jouº®_ä“_»£rved
(
hªdË_t
 *
hªdË
)

517 
jouº®_t
 *
jouº®
 = 
hªdË
->
h_jouº®
;

519 
	`WARN_ON
(!
hªdË
->
h_»£rved
);

520 
	`sub_»£rved_üed™s
(
jouº®
, 
hªdË
->
h_bufãr_üed™s
);

521 
	`jbd2_ä“_hªdË
(
hªdË
);

522 
	}
}

523 
EXPORT_SYMBOL
(
jbd2_jouº®_ä“_»£rved
);

539 
	$jbd2_jouº®_¡¬t_»£rved
(
hªdË_t
 *
hªdË
, 
ty³
,

540 
lše_no
)

542 
jouº®_t
 *
jouº®
 = 
hªdË
->
h_jouº®
;

543 
»t
 = -
EIO
;

545 ià(
	`WARN_ON
(!
hªdË
->
h_»£rved
)) {

547 
	`jbd2_jouº®_¡İ
(
hªdË
);

548  
»t
;

554 ià(
	`WARN_ON
(
cu¼’t
->
jouº®_šfo
)) {

555 
	`jbd2_jouº®_ä“_»£rved
(
hªdË
);

556  
»t
;

559 
hªdË
->
h_jouº®
 = 
NULL
;

564 
»t
 = 
	`¡¬t_this_hªdË
(
jouº®
, 
hªdË
, 
GFP_NOFS
);

565 ià(
»t
 < 0) {

566 
hªdË
->
h_jouº®
 = 
jouº®
;

567 
	`jbd2_jouº®_ä“_»£rved
(
hªdË
);

568  
»t
;

570 
hªdË
->
h_ty³
 = 
ty³
;

571 
hªdË
->
h_lše_no
 = 
lše_no
;

572 
	`Œaû_jbd2_hªdË_¡¬t
(
jouº®
->
j_fs_dev
->
bd_dev
,

573 
hªdË
->
h_Œª§ùiÚ
->
t_tid
, 
ty³
,

574 
lše_no
, 
hªdË
->
h_bufãr_üed™s
);

576 
	}
}

577 
EXPORT_SYMBOL
(
jbd2_jouº®_¡¬t_»£rved
);

599 
	$jbd2_jouº®_ex‹nd
(
hªdË_t
 *
hªdË
, 
nblocks
)

601 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

602 
jouº®_t
 *
jouº®
;

603 
»suÉ
;

604 
wª‹d
;

606 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

607  -
EROFS
;

608 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

610 
»suÉ
 = 1;

612 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

615 ià(
Œª§ùiÚ
->
t_¡©e
 !ğ
T_RUNNING
) {

616 
	`jbd_debug
(3, "denied handle %p %d blocks: "

617 "Œª§ùiÚ‚Ù„uÂšg\n", 
hªdË
, 
nblocks
);

618 
”rÜ_out
;

621 
	`¥š_lock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

622 
wª‹d
 = 
	`©omic_add_»tuº
(
nblocks
,

623 &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

625 ià(
wª‹d
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
) {

626 
	`jbd_debug
(3, "denied handle %p %d blocks: "

627 "Œª§ùiÚoØÏrge\n", 
hªdË
, 
nblocks
);

628 
	`©omic_sub
(
nblocks
, &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

629 
uÆock
;

632 ià(
wª‹d
 + (wª‹d >> 
JBD2_CONTROL_BLOCKS_SHIFT
) >

633 
	`jbd2_log_¥aû_Ëá
(
jouº®
)) {

634 
	`jbd_debug
(3, "denied handle %p %d blocks: "

635 "šsuffic›Á†og s·û\n", 
hªdË
, 
nblocks
);

636 
	`©omic_sub
(
nblocks
, &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

637 
uÆock
;

640 
	`Œaû_jbd2_hªdË_ex‹nd
(
jouº®
->
j_fs_dev
->
bd_dev
,

641 
Œª§ùiÚ
->
t_tid
,

642 
hªdË
->
h_ty³
, hªdË->
h_lše_no
,

643 
hªdË
->
h_bufãr_üed™s
,

644 
nblocks
);

646 
hªdË
->
h_bufãr_üed™s
 +ğ
nblocks
;

647 
hªdË
->
h_»que¡ed_üed™s
 +ğ
nblocks
;

648 
»suÉ
 = 0;

650 
	`jbd_debug
(3, "ex‹nded hªdË %°by %d\n", 
hªdË
, 
nblocks
);

651 
uÆock
:

652 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

653 
”rÜ_out
:

654 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

655  
»suÉ
;

656 
	}
}

675 
	$jbd2__jouº®_»¡¬t
(
hªdË_t
 *
hªdË
, 
nblocks
, 
gå_t
 
gå_mask
)

677 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

678 
jouº®_t
 *
jouº®
;

679 
tid_t
 
tid
;

680 
Ãed_to_¡¬t
, 
»t
;

684 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

686 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

692 
	`J_ASSERT
(
	`©omic_»ad
(&
Œª§ùiÚ
->
t_upd©es
) > 0);

693 
	`J_ASSERT
(
	`jouº®_cu¼’t_hªdË
(è=ğ
hªdË
);

695 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

696 
	`¥š_lock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

697 
	`©omic_sub
(
hªdË
->
h_bufãr_üed™s
,

698 &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

699 ià(
hªdË
->
h_rsv_hªdË
) {

700 
	`sub_»£rved_üed™s
(
jouº®
,

701 
hªdË
->
h_rsv_hªdË
->
h_bufãr_üed™s
);

703 ià(
	`©omic_dec_ªd_‹¡
(&
Œª§ùiÚ
->
t_upd©es
))

704 
	`wake_up
(&
jouº®
->
j_wa™_upd©es
);

705 
tid
 = 
Œª§ùiÚ
->
t_tid
;

706 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

707 
hªdË
->
h_Œª§ùiÚ
 = 
NULL
;

708 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

710 
	`jbd_debug
(2, "»¡¬tšg hªdË %p\n", 
hªdË
);

711 
Ãed_to_¡¬t
 = !
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
tid
);

712 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

713 ià(
Ãed_to_¡¬t
)

714 
	`jbd2_log_¡¬t_comm™
(
jouº®
, 
tid
);

716 
	`rw£m_»Ëa£
(&
jouº®
->
j_Œªs_comm™_m­
, 1, 
_THIS_IP_
);

717 
hªdË
->
h_bufãr_üed™s
 = 
nblocks
;

723 
	`mem®loc_nofs_»¡Üe
(
hªdË
->
§ved_®loc_cÚ‹xt
);

724 
»t
 = 
	`¡¬t_this_hªdË
(
jouº®
, 
hªdË
, 
gå_mask
);

725  
»t
;

726 
	}
}

727 
EXPORT_SYMBOL
(
jbd2__jouº®_»¡¬t
);

730 
	$jbd2_jouº®_»¡¬t
(
hªdË_t
 *
hªdË
, 
nblocks
)

732  
	`jbd2__jouº®_»¡¬t
(
hªdË
, 
nblocks
, 
GFP_NOFS
);

733 
	}
}

734 
EXPORT_SYMBOL
(
jbd2_jouº®_»¡¬t
);

746 
	$jbd2_jouº®_lock_upd©es
(
jouº®_t
 *
jouº®
)

748 
	`DEFINE_WAIT
(
wa™
);

750 
	`jbd2_might_wa™_fÜ_comm™
(
jouº®
);

752 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

753 ++
jouº®
->
j_b¬r›r_couÁ
;

756 ià(
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
)) {

757 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

758 
	`wa™_ev’t
(
jouº®
->
j_wa™_»£rved
,

759 
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
) == 0);

760 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

765 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

767 ià(!
Œª§ùiÚ
)

770 
	`¥š_lock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

771 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
,

772 
TASK_UNINTERRUPTIBLE
);

773 ià(!
	`©omic_»ad
(&
Œª§ùiÚ
->
t_upd©es
)) {

774 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

775 
	`fšish_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
);

778 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

779 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

780 
	`scheduË
();

781 
	`fšish_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
);

782 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

784 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

792 
	`mu‹x_lock
(&
jouº®
->
j_b¬r›r
);

793 
	}
}

803 
	$jbd2_jouº®_uÆock_upd©es
 (
jouº®_t
 *
jouº®
)

805 
	`J_ASSERT
(
jouº®
->
j_b¬r›r_couÁ
 != 0);

807 
	`mu‹x_uÆock
(&
jouº®
->
j_b¬r›r
);

808 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

809 --
jouº®
->
j_b¬r›r_couÁ
;

810 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

811 
	`wake_up
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
);

812 
	}
}

814 
	$w¬n_dœty_bufãr
(
bufãr_h—d
 *
bh
)

816 
	`´štk
(
KERN_WARNING


820 
bh
->
b_bdev
, ()bh->
b_blockÄ
);

821 
	}
}

824 
	$jbd2_ä“ze_jh_d©a
(
jouº®_h—d
 *
jh
)

826 
·ge
 *page;

827 
off£t
;

828 *
sourû
;

829 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

831 
	`J_EXPECT_JH
(
jh
, 
	`bufãr_u±od©e
(
bh
), "Possible IO failure.\n");

832 
·ge
 = 
bh
->
b_·ge
;

833 
off£t
 = 
	`off£t_š_·ge
(
bh
->
b_d©a
);

834 
sourû
 = 
	`km­_©omic
(
·ge
);

836 
	`jbd2_bufãr_äoz’_Œigg”
(
jh
, 
sourû
 + 
off£t
, jh->
b_Œigg”s
);

837 
	`memıy
(
jh
->
b_äoz’_d©a
, 
sourû
 + 
off£t
, 
bh
->
b_size
);

838 
	`kunm­_©omic
(
sourû
);

844 
jh
->
b_äoz’_Œigg”s
 = jh->
b_Œigg”s
;

845 
	}
}

858 
	$do_g‘_wr™e_acûss
(
hªdË_t
 *
hªdË
, 
jouº®_h—d
 *
jh
,

859 
fÜû_cİy
)

861 
bufãr_h—d
 *
bh
;

862 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

863 
jouº®_t
 *
jouº®
;

864 
”rÜ
;

865 *
äoz’_bufãr
 = 
NULL
;

866 
¡¬t_lock
, 
time_lock
;

868 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

869  -
EROFS
;

870 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

872 
	`jbd_debug
(5, "jouº®_h—d %p, fÜû_cİy %d\n", 
jh
, 
fÜû_cİy
);

874 
	`JBUFFER_TRACE
(
jh
, "entry");

875 
»³©
:

876 
bh
 = 
	`jh2bh
(
jh
);

880 
¡¬t_lock
 = 
jiff›s
;

881 
	`lock_bufãr
(
bh
);

882 
	`jbd_lock_bh_¡©e
(
bh
);

885 
time_lock
 = 
	`jbd2_time_diff
(
¡¬t_lock
, 
jiff›s
);

886 ià(
time_lock
 > 
HZ
/10)

887 
	`Œaû_jbd2_lock_bufãr_¡®l
(
bh
->
b_bdev
->
bd_dev
,

888 
	`jiff›s_to_m£cs
(
time_lock
));

903 ià(
	`bufãr_dœty
(
bh
)) {

908 ià(
jh
->
b_Œª§ùiÚ
) {

909 
	`J_ASSERT_JH
(
jh
,

910 
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

911 
jh
->
b_Œª§ùiÚ
 ==

912 
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

913 ià(
jh
->
b_Ãxt_Œª§ùiÚ
)

914 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 ==

915 
Œª§ùiÚ
);

916 
	`w¬n_dœty_bufãr
(
bh
);

923 
	`JBUFFER_TRACE
(
jh
, "Journalling dirty buffer");

924 
	`ş—r_bufãr_dœty
(
bh
);

925 
	`£t_bufãr_jbddœty
(
bh
);

928 
	`uÆock_bufãr
(
bh
);

930 
”rÜ
 = -
EROFS
;

931 ià(
	`is_hªdË_abÜ‹d
(
hªdË
)) {

932 
	`jbd_uÆock_bh_¡©e
(
bh
);

933 
out
;

935 
”rÜ
 = 0;

941 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

942 
jh
->
b_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
)

943 
dÚe
;

949 
jh
->
b_modif›d
 = 0;

956 ià(!
jh
->
b_Œª§ùiÚ
) {

957 
	`JBUFFER_TRACE
(
jh
, "noransaction");

958 
	`J_ASSERT_JH
(
jh
, !jh->
b_Ãxt_Œª§ùiÚ
);

959 
	`JBUFFER_TRACE
(
jh
, "file‡s BJ_Reserved");

965 
	`smp_wmb
();

966 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

967 
	`__jbd2_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_Re£rved
);

968 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

969 
dÚe
;

975 ià(
jh
->
b_äoz’_d©a
) {

976 
	`JBUFFER_TRACE
(
jh
, "has frozen data");

977 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

978 
©ch_Ãxt
;

981 
	`JBUFFER_TRACE
(
jh
, "owned by olderransaction");

982 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

983 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

994 ià(
	`bufãr_shadow
(
bh
)) {

995 
	`JBUFFER_TRACE
(
jh
, "on shadow: sleep");

996 
	`jbd_uÆock_bh_¡©e
(
bh
);

997 
	`wa™_Ú_b™_io
(&
bh
->
b_¡©e
, 
BH_Shadow
, 
TASK_UNINTERRUPTIBLE
);

998 
»³©
;

1013 ià(
jh
->
b_jli¡
 =ğ
BJ_M‘ad©a
 || 
fÜû_cİy
) {

1014 
	`JBUFFER_TRACE
(
jh
, "generate frozen data");

1015 ià(!
äoz’_bufãr
) {

1016 
	`JBUFFER_TRACE
(
jh
, "allocate memory for buffer");

1017 
	`jbd_uÆock_bh_¡©e
(
bh
);

1018 
äoz’_bufãr
 = 
	`jbd2_®loc
(
	`jh2bh
(
jh
)->
b_size
,

1019 
GFP_NOFS
 | 
__GFP_NOFAIL
);

1020 
»³©
;

1022 
jh
->
b_äoz’_d©a
 = 
äoz’_bufãr
;

1023 
äoz’_bufãr
 = 
NULL
;

1024 
	`jbd2_ä“ze_jh_d©a
(
jh
);

1026 
©ch_Ãxt
:

1032 
	`smp_wmb
();

1033 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

1035 
dÚe
:

1036 
	`jbd_uÆock_bh_¡©e
(
bh
);

1042 
	`jbd2_jouº®_ÿnûl_»voke
(
hªdË
, 
jh
);

1044 
out
:

1045 ià(
	`uÆik–y
(
äoz’_bufãr
))

1046 
	`jbd2_ä“
(
äoz’_bufãr
, 
bh
->
b_size
);

1048 
	`JBUFFER_TRACE
(
jh
, "exit");

1049  
”rÜ
;

1050 
	}
}

1053 
boŞ
 
	$jbd2_wr™e_acûss_g¿Áed
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
,

1054 
boŞ
 
undo
)

1056 
jouº®_h—d
 *
jh
;

1057 
boŞ
 
»t
 = 
çl£
;

1060 ià(
	`bufãr_dœty
(
bh
))

1061  
çl£
;

1074 
	`rcu_»ad_lock
();

1075 ià(!
	`bufãr_jbd
(
bh
))

1076 
out
;

1078 
jh
 = 
	`READ_ONCE
(
bh
->
b_´iv©e
);

1079 ià(!
jh
)

1080 
out
;

1082 ià(
undo
 && !
jh
->
b_comm™‹d_d©a
)

1083 
out
;

1084 ià(
jh
->
b_Œª§ùiÚ
 !ğ
hªdË
->
h_Œª§ùiÚ
 &&

1085 
jh
->
b_Ãxt_Œª§ùiÚ
 !ğ
hªdË
->
h_Œª§ùiÚ
)

1086 
out
;

1096 
	`smp_mb
();

1097 ià(
	`uÆik–y
(
jh
->
b_bh
 !ğ
bh
))

1098 
out
;

1099 
»t
 = 
Œue
;

1100 
out
:

1101 
	`rcu_»ad_uÆock
();

1102  
»t
;

1103 
	}
}

1116 
	$jbd2_jouº®_g‘_wr™e_acûss
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1118 
jouº®_h—d
 *
jh
;

1119 
rc
;

1121 ià(
	`jbd2_wr™e_acûss_g¿Áed
(
hªdË
, 
bh
, 
çl£
))

1124 
jh
 = 
	`jbd2_jouº®_add_jouº®_h—d
(
bh
);

1128 
rc
 = 
	`do_g‘_wr™e_acûss
(
hªdË
, 
jh
, 0);

1129 
	`jbd2_jouº®_put_jouº®_h—d
(
jh
);

1130  
rc
;

1131 
	}
}

1153 
	$jbd2_jouº®_g‘_ü—‹_acûss
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1155 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

1156 
jouº®_t
 *
jouº®
;

1157 
jouº®_h—d
 *
jh
 = 
	`jbd2_jouº®_add_jouº®_h—d
(
bh
);

1158 
”r
;

1160 
	`jbd_debug
(5, "jouº®_h—d %p\n", 
jh
);

1161 
”r
 = -
EROFS
;

1162 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1163 
out
;

1164 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

1165 
”r
 = 0;

1167 
	`JBUFFER_TRACE
(
jh
, "entry");

1175 
	`jbd_lock_bh_¡©e
(
bh
);

1176 
	`J_ASSERT_JH
(
jh
, (jh->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

1177 
jh
->
b_Œª§ùiÚ
 =ğ
NULL
 ||

1178 (
jh
->
b_Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
 &&

1179 
jh
->
b_jli¡
 =ğ
BJ_FÜg‘
)));

1181 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

1182 
	`J_ASSERT_JH
(
jh
, 
	`bufãr_locked
(
	`jh2bh
(jh)));

1184 ià(
jh
->
b_Œª§ùiÚ
 =ğ
NULL
) {

1193 
	`ş—r_bufãr_dœty
(
	`jh2bh
(
jh
));

1195 
jh
->
b_modif›d
 = 0;

1197 
	`JBUFFER_TRACE
(
jh
, "file‡s BJ_Reserved");

1198 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1199 
	`__jbd2_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_Re£rved
);

1200 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1201 } ià(
jh
->
b_Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
) {

1203 
jh
->
b_modif›d
 = 0;

1205 
	`JBUFFER_TRACE
(
jh
, "set‚extransaction");

1206 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1207 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

1208 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1210 
	`jbd_uÆock_bh_¡©e
(
bh
);

1219 
	`JBUFFER_TRACE
(
jh
, "cancelling„evoke");

1220 
	`jbd2_jouº®_ÿnûl_»voke
(
hªdË
, 
jh
);

1221 
out
:

1222 
	`jbd2_jouº®_put_jouº®_h—d
(
jh
);

1223  
”r
;

1224 
	}
}

1252 
	$jbd2_jouº®_g‘_undo_acûss
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1254 
”r
;

1255 
jouº®_h—d
 *
jh
;

1256 *
comm™‹d_d©a
 = 
NULL
;

1258 ià(
	`jbd2_wr™e_acûss_g¿Áed
(
hªdË
, 
bh
, 
Œue
))

1261 
jh
 = 
	`jbd2_jouº®_add_jouº®_h—d
(
bh
);

1262 
	`JBUFFER_TRACE
(
jh
, "entry");

1269 
”r
 = 
	`do_g‘_wr™e_acûss
(
hªdË
, 
jh
, 1);

1270 ià(
”r
)

1271 
out
;

1273 
»³©
:

1274 ià(!
jh
->
b_comm™‹d_d©a
)

1275 
comm™‹d_d©a
 = 
	`jbd2_®loc
(
	`jh2bh
(
jh
)->
b_size
,

1276 
GFP_NOFS
|
__GFP_NOFAIL
);

1278 
	`jbd_lock_bh_¡©e
(
bh
);

1279 ià(!
jh
->
b_comm™‹d_d©a
) {

1282 
	`JBUFFER_TRACE
(
jh
, "generate b_committed data");

1283 ià(!
comm™‹d_d©a
) {

1284 
	`jbd_uÆock_bh_¡©e
(
bh
);

1285 
»³©
;

1288 
jh
->
b_comm™‹d_d©a
 = 
comm™‹d_d©a
;

1289 
comm™‹d_d©a
 = 
NULL
;

1290 
	`memıy
(
jh
->
b_comm™‹d_d©a
, 
bh
->
b_d©a
, bh->
b_size
);

1292 
	`jbd_uÆock_bh_¡©e
(
bh
);

1293 
out
:

1294 
	`jbd2_jouº®_put_jouº®_h—d
(
jh
);

1295 ià(
	`uÆik–y
(
comm™‹d_d©a
))

1296 
	`jbd2_ä“
(
comm™‹d_d©a
, 
bh
->
b_size
);

1297  
”r
;

1298 
	}
}

1311 
	$jbd2_jouº®_£t_Œigg”s
(
bufãr_h—d
 *
bh
,

1312 
jbd2_bufãr_Œigg”_ty³
 *
ty³
)

1314 
jouº®_h—d
 *
jh
 = 
	`jbd2_jouº®_g¿b_jouº®_h—d
(
bh
);

1316 ià(
	`WARN_ON
(!
jh
))

1318 
jh
->
b_Œigg”s
 = 
ty³
;

1319 
	`jbd2_jouº®_put_jouº®_h—d
(
jh
);

1320 
	}
}

1322 
	$jbd2_bufãr_äoz’_Œigg”
(
jouº®_h—d
 *
jh
, *
m­³d_d©a
,

1323 
jbd2_bufãr_Œigg”_ty³
 *
Œigg”s
)

1325 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

1327 ià(!
Œigg”s
 || !Œigg”s->
t_äoz’
)

1330 
Œigg”s
->
	`t_äoz’
Ñrigg”s, 
bh
, 
m­³d_d©a
, bh->
b_size
);

1331 
	}
}

1333 
	$jbd2_bufãr_abÜt_Œigg”
(
jouº®_h—d
 *
jh
,

1334 
jbd2_bufãr_Œigg”_ty³
 *
Œigg”s
)

1336 ià(!
Œigg”s
 || !Œigg”s->
t_abÜt
)

1339 
Œigg”s
->
	`t_abÜt
Ñrigg”s, 
	`jh2bh
(
jh
));

1340 
	}
}

1365 
	$jbd2_jouº®_dœty_m‘ad©a
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1367 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

1368 
jouº®_t
 *
jouº®
;

1369 
jouº®_h—d
 *
jh
;

1370 
»t
 = 0;

1372 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1373  -
EROFS
;

1374 ià(!
	`bufãr_jbd
(
bh
))

1375  -
EUCLEAN
;

1381 
jh
 = 
	`bh2jh
(
bh
);

1382 
	`jbd_debug
(5, "jouº®_h—d %p\n", 
jh
);

1383 
	`JBUFFER_TRACE
(
jh
, "entry");

1391 ià(
jh
->
b_Œª§ùiÚ
 !ğ
Œª§ùiÚ
 &&

1392 
jh
->
b_Ãxt_Œª§ùiÚ
 !ğ
Œª§ùiÚ
) {

1393 
	`jbd_lock_bh_¡©e
(
bh
);

1394 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

1395 
jh
->
b_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
);

1396 
	`jbd_uÆock_bh_¡©e
(
bh
);

1398 ià(
jh
->
b_modif›d
 == 1) {

1400 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 &&

1401 
jh
->
b_jli¡
 !ğ
BJ_M‘ad©a
) {

1402 
	`jbd_lock_bh_¡©e
(
bh
);

1403 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 &&

1404 
jh
->
b_jli¡
 !ğ
BJ_M‘ad©a
)

1405 
	`´_”r
("JBD2:‡ssertion failure: h_type=%u "

1407 
hªdË
->
h_ty³
, hªdË->
h_lše_no
,

1408 (è
bh
->
b_blockÄ
,

1409 
jh
->
b_jli¡
);

1410 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 !ğ
Œª§ùiÚ
 ||

1411 
jh
->
b_jli¡
 =ğ
BJ_M‘ad©a
);

1412 
	`jbd_uÆock_bh_¡©e
(
bh
);

1414 
out
;

1417 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

1418 
	`jbd_lock_bh_¡©e
(
bh
);

1420 ià(
jh
->
b_modif›d
 == 0) {

1426 ià(
hªdË
->
h_bufãr_üed™s
 <= 0) {

1427 
»t
 = -
ENOSPC
;

1428 
out_uÆock_bh
;

1430 
jh
->
b_modif›d
 = 1;

1431 
hªdË
->
h_bufãr_üed™s
--;

1441 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 && jh->
b_jli¡
 =ğ
BJ_M‘ad©a
) {

1442 
	`JBUFFER_TRACE
(
jh
, "fastpath");

1443 ià(
	`uÆik–y
(
jh
->
b_Œª§ùiÚ
 !=

1444 
jouº®
->
j_ruÂšg_Œª§ùiÚ
)) {

1445 
	`´štk
(
KERN_ERR
 "JBD2: %s: "

1448 
jouº®
->
j_devÇme
,

1449 (è
bh
->
b_blockÄ
,

1450 
jh
->
b_Œª§ùiÚ
,

1451 
jh
->
b_Œª§ùiÚ
 ? jh->b_Œª§ùiÚ->
t_tid
 : 0,

1452 
jouº®
->
j_ruÂšg_Œª§ùiÚ
,

1453 
jouº®
->
j_ruÂšg_Œª§ùiÚ
 ?

1454 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 : 0);

1455 
»t
 = -
EINVAL
;

1457 
out_uÆock_bh
;

1460 
	`£t_bufãr_jbddœty
(
bh
);

1468 ià(
jh
->
b_Œª§ùiÚ
 !ğ
Œª§ùiÚ
) {

1469 
	`JBUFFER_TRACE
(
jh
, "already on otherransaction");

1470 ià(
	`uÆik–y
(((
jh
->
b_Œª§ùiÚ
 !=

1471 
jouº®
->
j_comm™tšg_Œª§ùiÚ
)) ||

1472 (
jh
->
b_Ãxt_Œª§ùiÚ
 !ğ
Œª§ùiÚ
))) {

1473 
	`´štk
(
KERN_ERR
 "jbd2_journal_dirty_metadata: %s: "

1478 
jouº®
->
j_devÇme
,

1479 (è
bh
->
b_blockÄ
,

1480 
Œª§ùiÚ
,¿n§ùiÚ->
t_tid
,

1481 
jh
->
b_Œª§ùiÚ
,

1482 
jh
->
b_Œª§ùiÚ
 ?

1483 
jh
->
b_Œª§ùiÚ
->
t_tid
 : 0,

1484 
jh
->
b_Ãxt_Œª§ùiÚ
,

1485 
jh
->
b_Ãxt_Œª§ùiÚ
 ?

1486 
jh
->
b_Ãxt_Œª§ùiÚ
->
t_tid
 : 0,

1487 
jh
->
b_jli¡
);

1488 
	`WARN_ON
(1);

1489 
»t
 = -
EINVAL
;

1493 
out_uÆock_bh
;

1497 
	`J_ASSERT_JH
(
jh
, jh->
b_äoz’_d©a
 =ğ
NULL
);

1499 
	`JBUFFER_TRACE
(
jh
, "file‡s BJ_Metadata");

1500 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1501 
	`__jbd2_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_M‘ad©a
);

1502 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1503 
out_uÆock_bh
:

1504 
	`jbd_uÆock_bh_¡©e
(
bh
);

1505 
out
:

1506 
	`JBUFFER_TRACE
(
jh
, "exit");

1507  
»t
;

1508 
	}
}

1527 
	$jbd2_jouº®_fÜg‘
 (
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1529 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

1530 
jouº®_t
 *
jouº®
;

1531 
jouº®_h—d
 *
jh
;

1532 
drİ_»£rve
 = 0;

1533 
”r
 = 0;

1534 
was_modif›d
 = 0;

1536 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1537  -
EROFS
;

1538 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

1540 
	`BUFFER_TRACE
(
bh
, "entry");

1542 
	`jbd_lock_bh_¡©e
(
bh
);

1544 ià(!
	`bufãr_jbd
(
bh
))

1545 
nÙ_jbd
;

1546 
jh
 = 
	`bh2jh
(
bh
);

1550 ià(!
	`J_EXPECT_JH
(
jh
, !jh->
b_comm™‹d_d©a
,

1552 
”r
 = -
EIO
;

1553 
nÙ_jbd
;

1557 
was_modif›d
 = 
jh
->
b_modif›d
;

1563 
jh
->
b_modif›d
 = 0;

1565 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
) {

1566 
	`J_ASSERT_JH
(
jh
, !jh->
b_äoz’_d©a
);

1571 
	`ş—r_bufãr_dœty
(
bh
);

1572 
	`ş—r_bufãr_jbddœty
(
bh
);

1574 
	`JBUFFER_TRACE
(
jh
, "belongso currentransaction: unfile");

1580 ià(
was_modif›d
)

1581 
drİ_»£rve
 = 1;

1595 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1596 ià(
jh
->
b_ı_Œª§ùiÚ
) {

1597 
	`__jbd2_jouº®_‹mp_uÆšk_bufãr
(
jh
);

1598 
	`__jbd2_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_FÜg‘
);

1600 
	`__jbd2_jouº®_unfe_bufãr
(
jh
);

1601 ià(!
	`bufãr_jbd
(
bh
)) {

1602 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1603 
nÙ_jbd
;

1606 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1607 } ià(
jh
->
b_Œª§ùiÚ
) {

1608 
	`J_ASSERT_JH
(
jh
, (jh->
b_Œª§ùiÚ
 ==

1609 
jouº®
->
j_comm™tšg_Œª§ùiÚ
));

1612 
	`JBUFFER_TRACE
(
jh
, "belongso olderransaction");

1620 
	`£t_bufãr_ä“d
(
bh
);

1622 ià(!
jh
->
b_Ãxt_Œª§ùiÚ
) {

1623 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1624 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

1625 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1627 
	`J_ASSERT
(
jh
->
b_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
);

1633 ià(
was_modif›d
)

1634 
drİ_»£rve
 = 1;

1642 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1643 ià(!
jh
->
b_ı_Œª§ùiÚ
) {

1644 
	`JBUFFER_TRACE
(
jh
, "belongso‚oneransaction");

1645 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1646 
nÙ_jbd
;

1653 ià(!
	`bufãr_dœty
(
bh
)) {

1654 
	`__jbd2_jouº®_»move_checkpošt
(
jh
);

1655 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1656 
nÙ_jbd
;

1665 
	`ş—r_bufãr_dœty
(
bh
);

1666 
	`__jbd2_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_FÜg‘
);

1667 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1670 
	`jbd_uÆock_bh_¡©e
(
bh
);

1671 
	`__b»l£
(
bh
);

1672 
drİ
:

1673 ià(
drİ_»£rve
) {

1675 
hªdË
->
h_bufãr_üed™s
++;

1677  
”r
;

1679 
nÙ_jbd
:

1680 
	`jbd_uÆock_bh_¡©e
(
bh
);

1681 
	`__bfÜg‘
(
bh
);

1682 
drİ
;

1683 
	}
}

1701 
	$jbd2_jouº®_¡İ
(
hªdË_t
 *
hªdË
)

1703 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

1704 
jouº®_t
 *
jouº®
;

1705 
”r
 = 0, 
wa™_fÜ_comm™
 = 0;

1706 
tid_t
 
tid
;

1707 
pid_t
 
pid
;

1709 ià(!
Œª§ùiÚ
) {

1715 ià(--
hªdË
->
h_»f
 > 0) {

1716 
	`jbd_debug
(4, "h_»à%d -> %d\n", 
hªdË
->
h_»f
 + 1,

1717 
hªdË
->
h_»f
);

1718  
”r
;

1720 ià(
hªdË
->
h_rsv_hªdË
)

1721 
	`jbd2_ä“_hªdË
(
hªdË
->
h_rsv_hªdË
);

1722 
ä“_ªd_ex™
;

1725 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

1727 
	`J_ASSERT
(
	`jouº®_cu¼’t_hªdË
(è=ğ
hªdË
);

1729 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1730 
”r
 = -
EIO
;

1732 
	`J_ASSERT
(
	`©omic_»ad
(&
Œª§ùiÚ
->
t_upd©es
) > 0);

1734 ià(--
hªdË
->
h_»f
 > 0) {

1735 
	`jbd_debug
(4, "h_»à%d -> %d\n", 
hªdË
->
h_»f
 + 1,

1736 
hªdË
->
h_»f
);

1737  
”r
;

1740 
	`jbd_debug
(4, "HªdË %°gošg down\n", 
hªdË
);

1741 
	`Œaû_jbd2_hªdË_¡©s
(
jouº®
->
j_fs_dev
->
bd_dev
,

1742 
Œª§ùiÚ
->
t_tid
,

1743 
hªdË
->
h_ty³
, hªdË->
h_lše_no
,

1744 
jiff›s
 - 
hªdË
->
h_¡¬t_jiff›s
,

1745 
hªdË
->
h_sync
, hªdË->
h_»que¡ed_üed™s
,

1746 (
hªdË
->
h_»que¡ed_üed™s
 -

1747 
hªdË
->
h_bufãr_üed™s
));

1778 
pid
 = 
cu¼’t
->pid;

1779 ià(
hªdË
->
h_sync
 && 
jouº®
->
j_Ï¡_sync_wr™”
 !ğ
pid
 &&

1780 
jouº®
->
j_max_b©ch_time
) {

1781 
u64
 
comm™_time
, 
Œªs_time
;

1783 
jouº®
->
j_Ï¡_sync_wr™”
 = 
pid
;

1785 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

1786 
comm™_time
 = 
jouº®
->
j_av”age_comm™_time
;

1787 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

1789 
Œªs_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_g‘
(),

1790 
Œª§ùiÚ
->
t_¡¬t_time
));

1792 
comm™_time
 = 
	`max_t
(
u64
, commit_time,

1793 1000*
jouº®
->
j_mš_b©ch_time
);

1794 
comm™_time
 = 
	`mš_t
(
u64
, commit_time,

1795 1000*
jouº®
->
j_max_b©ch_time
);

1797 ià(
Œªs_time
 < 
comm™_time
) {

1798 
ktime_t
 
expœes
 = 
	`ktime_add_ns
(
	`ktime_g‘
(),

1799 
comm™_time
);

1800 
	`£t_cu¼’t_¡©e
(
TASK_UNINTERRUPTIBLE
);

1801 
	`scheduË_h¹imeout
(&
expœes
, 
HRTIMER_MODE_ABS
);

1805 ià(
hªdË
->
h_sync
)

1806 
Œª§ùiÚ
->
t_synchrÚous_comm™
 = 1;

1807 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

1808 
	`©omic_sub
(
hªdË
->
h_bufãr_üed™s
,

1809 &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

1817 ià(
hªdË
->
h_sync
 ||

1818 (
	`©omic_»ad
(&
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
) >

1819 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
) ||

1820 
	`time_aá”_eq
(
jiff›s
, 
Œª§ùiÚ
->
t_expœes
)) {

1825 
	`jbd_debug
(2, "transactionoo old,„equesting commit for "

1826 "hªdË %p\n", 
hªdË
);

1828 
	`jbd2_log_¡¬t_comm™
(
jouº®
, 
Œª§ùiÚ
->
t_tid
);

1834 ià(
hªdË
->
h_sync
 && !(
cu¼’t
->
æags
 & 
PF_MEMALLOC
))

1835 
wa™_fÜ_comm™
 = 1;

1844 
tid
 = 
Œª§ùiÚ
->
t_tid
;

1845 ià(
	`©omic_dec_ªd_‹¡
(&
Œª§ùiÚ
->
t_upd©es
)) {

1846 
	`wake_up
(&
jouº®
->
j_wa™_upd©es
);

1847 ià(
jouº®
->
j_b¬r›r_couÁ
)

1848 
	`wake_up
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
);

1851 
	`rw£m_»Ëa£
(&
jouº®
->
j_Œªs_comm™_m­
, 1, 
_THIS_IP_
);

1853 ià(
wa™_fÜ_comm™
)

1854 
”r
 = 
	`jbd2_log_wa™_comm™
(
jouº®
, 
tid
);

1856 ià(
hªdË
->
h_rsv_hªdË
)

1857 
	`jbd2_jouº®_ä“_»£rved
(
hªdË
->
h_rsv_hªdË
);

1858 
ä“_ªd_ex™
:

1863 
	`mem®loc_nofs_»¡Üe
(
hªdË
->
§ved_®loc_cÚ‹xt
);

1864 
	`jbd2_ä“_hªdË
(
hªdË
);

1865  
”r
;

1866 
	}
}

1884 
šlše
 

1885 
	$__bli¡_add_bufãr
(
jouº®_h—d
 **
li¡
, jouº®_h—d *
jh
)

1887 ià(!*
li¡
) {

1888 
jh
->
b_Šext
 = jh->
b_»v
 = jh;

1889 *
li¡
 = 
jh
;

1892 
jouº®_h—d
 *
fœ¡
 = *
li¡
, *
Ï¡
 = fœ¡->
b_»v
;

1893 
jh
->
b_»v
 = 
Ï¡
;

1894 
jh
->
b_Šext
 = 
fœ¡
;

1895 
Ï¡
->
b_Šext
 = 
fœ¡
->
b_»v
 = 
jh
;

1897 
	}
}

1908 
šlše
 

1909 
	$__bli¡_d–_bufãr
(
jouº®_h—d
 **
li¡
, jouº®_h—d *
jh
)

1911 ià(*
li¡
 =ğ
jh
) {

1912 *
li¡
 = 
jh
->
b_Šext
;

1913 ià(*
li¡
 =ğ
jh
)

1914 *
li¡
 = 
NULL
;

1916 
jh
->
b_»v
->
b_Šext
 = jh->b_tnext;

1917 
jh
->
b_Šext
->
b_»v
 = jh->b_tprev;

1918 
	}
}

1931 
	$__jbd2_jouº®_‹mp_uÆšk_bufãr
(
jouº®_h—d
 *
jh
)

1933 
jouº®_h—d
 **
li¡
 = 
NULL
;

1934 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

1935 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

1937 
	`J_ASSERT_JH
(
jh
, 
	`jbd_is_locked_bh_¡©e
(
bh
));

1938 
Œª§ùiÚ
 = 
jh
->
b_Œª§ùiÚ
;

1939 ià(
Œª§ùiÚ
)

1940 
	`as£¹_¥š_locked
(&
Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

1942 
	`J_ASSERT_JH
(
jh
, jh->
b_jli¡
 < 
BJ_Ty³s
);

1943 ià(
jh
->
b_jli¡
 !ğ
BJ_NÚe
)

1944 
	`J_ASSERT_JH
(
jh
, 
Œª§ùiÚ
 !ğ
NULL
);

1946 
jh
->
b_jli¡
) {

1947 
BJ_NÚe
:

1949 
BJ_M‘ad©a
:

1950 
Œª§ùiÚ
->
t_Ä_bufãrs
--;

1951 
	`J_ASSERT_JH
(
jh
, 
Œª§ùiÚ
->
t_Ä_bufãrs
 >= 0);

1952 
li¡
 = &
Œª§ùiÚ
->
t_bufãrs
;

1954 
BJ_FÜg‘
:

1955 
li¡
 = &
Œª§ùiÚ
->
t_fÜg‘
;

1957 
BJ_Shadow
:

1958 
li¡
 = &
Œª§ùiÚ
->
t_shadow_li¡
;

1960 
BJ_Re£rved
:

1961 
li¡
 = &
Œª§ùiÚ
->
t_»£rved_li¡
;

1965 
	`__bli¡_d–_bufãr
(
li¡
, 
jh
);

1966 
jh
->
b_jli¡
 = 
BJ_NÚe
;

1967 ià(
Œª§ùiÚ
 && 
	`is_jouº®_abÜ‹d
Ñ¿n§ùiÚ->
t_jouº®
))

1968 
	`ş—r_bufãr_jbddœty
(
bh
);

1969 ià(
	`‹¡_ş—r_bufãr_jbddœty
(
bh
))

1970 
	`m¬k_bufãr_dœty
(
bh
);

1971 
	}
}

1980 
	$__jbd2_jouº®_unfe_bufãr
(
jouº®_h—d
 *
jh
)

1982 
	`__jbd2_jouº®_‹mp_uÆšk_bufãr
(
jh
);

1983 
jh
->
b_Œª§ùiÚ
 = 
NULL
;

1984 
	`jbd2_jouº®_put_jouº®_h—d
(
jh
);

1985 
	}
}

1987 
	$jbd2_jouº®_unfe_bufãr
(
jouº®_t
 *
jouº®
, 
jouº®_h—d
 *
jh
)

1989 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

1992 
	`g‘_bh
(
bh
);

1993 
	`jbd_lock_bh_¡©e
(
bh
);

1994 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1995 
	`__jbd2_jouº®_unfe_bufãr
(
jh
);

1996 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1997 
	`jbd_uÆock_bh_¡©e
(
bh
);

1998 
	`__b»l£
(
bh
);

1999 
	}
}

2007 
	$__jouº®_Œy_to_ä“_bufãr
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
)

2009 
jouº®_h—d
 *
jh
;

2011 
jh
 = 
	`bh2jh
(
bh
);

2013 ià(
	`bufãr_locked
(
bh
è|| 
	`bufãr_dœty
(bh))

2014 
out
;

2016 ià(
jh
->
b_Ãxt_Œª§ùiÚ
 !ğ
NULL
 || jh->
b_Œª§ùiÚ
 != NULL)

2017 
out
;

2019 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2020 ià(
jh
->
b_ı_Œª§ùiÚ
 !ğ
NULL
) {

2022 
	`JBUFFER_TRACE
(
jh
, "remove from checkpoint†ist");

2023 
	`__jbd2_jouº®_»move_checkpošt
(
jh
);

2025 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2026 
out
:

2028 
	}
}

2068 
	$jbd2_jouº®_Œy_to_ä“_bufãrs
(
jouº®_t
 *
jouº®
,

2069 
·ge
 *·ge, 
gå_t
 
gå_mask
)

2071 
bufãr_h—d
 *
h—d
;

2072 
bufãr_h—d
 *
bh
;

2073 
»t
 = 0;

2075 
	`J_ASSERT
(
	`PageLocked
(
·ge
));

2077 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

2078 
bh
 = 
h—d
;

2080 
jouº®_h—d
 *
jh
;

2087 
jh
 = 
	`jbd2_jouº®_g¿b_jouº®_h—d
(
bh
);

2088 ià(!
jh
)

2091 
	`jbd_lock_bh_¡©e
(
bh
);

2092 
	`__jouº®_Œy_to_ä“_bufãr
(
jouº®
, 
bh
);

2093 
	`jbd2_jouº®_put_jouº®_h—d
(
jh
);

2094 
	`jbd_uÆock_bh_¡©e
(
bh
);

2095 ià(
	`bufãr_jbd
(
bh
))

2096 
busy
;

2097 } (
bh
 = bh->
b_this_·ge
è!ğ
h—d
);

2099 
»t
 = 
	`Œy_to_ä“_bufãrs
(
·ge
);

2101 
busy
:

2102  
»t
;

2103 
	}
}

2117 
	$__di¥o£_bufãr
(
jouº®_h—d
 *
jh
, 
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

2119 
may_ä“
 = 1;

2120 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2122 ià(
jh
->
b_ı_Œª§ùiÚ
) {

2123 
	`JBUFFER_TRACE
(
jh
, "on„unning+cpransaction");

2124 
	`__jbd2_jouº®_‹mp_uÆšk_bufãr
(
jh
);

2130 
	`ş—r_bufãr_dœty
(
bh
);

2131 
	`__jbd2_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_FÜg‘
);

2132 
may_ä“
 = 0;

2134 
	`JBUFFER_TRACE
(
jh
, "on„unningransaction");

2135 
	`__jbd2_jouº®_unfe_bufãr
(
jh
);

2137  
may_ä“
;

2138 
	}
}

2187 
	$jouº®_unm­_bufãr
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
,

2188 
·¹Ÿl_·ge
)

2190 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

2191 
jouº®_h—d
 *
jh
;

2192 
may_ä“
 = 1;

2194 
	`BUFFER_TRACE
(
bh
, "entry");

2202 ià(!
	`bufãr_jbd
(
bh
))

2203 
z­_bufãr_uÆocked
;

2206 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2207 
	`jbd_lock_bh_¡©e
(
bh
);

2208 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2210 
jh
 = 
	`jbd2_jouº®_g¿b_jouº®_h—d
(
bh
);

2211 ià(!
jh
)

2212 
z­_bufãr_no_jh
;

2237 
Œª§ùiÚ
 = 
jh
->
b_Œª§ùiÚ
;

2238 ià(
Œª§ùiÚ
 =ğ
NULL
) {

2243 ià(!
jh
->
b_ı_Œª§ùiÚ
) {

2244 
	`JBUFFER_TRACE
(
jh
, "not on‡nyransaction: zap");

2245 
z­_bufãr
;

2248 ià(!
	`bufãr_dœty
(
bh
)) {

2250 
	`__jbd2_jouº®_»move_checkpošt
(
jh
);

2251 
z­_bufãr
;

2258 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

2262 
	`JBUFFER_TRACE
(
jh
, "checkpointed:‡ddo BJ_Forget");

2263 
may_ä“
 = 
	`__di¥o£_bufãr
(
jh
,

2264 
jouº®
->
j_ruÂšg_Œª§ùiÚ
);

2265 
z­_bufãr
;

2271 ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
) {

2272 
	`JBUFFER_TRACE
(
jh
, "giveo committingrans");

2273 
may_ä“
 = 
	`__di¥o£_bufãr
(
jh
,

2274 
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

2275 
z­_bufãr
;

2279 
	`ş—r_bufãr_jbddœty
(
bh
);

2280 
	`__jbd2_jouº®_»move_checkpošt
(
jh
);

2281 
z­_bufãr
;

2284 } ià(
Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
) {

2285 
	`JBUFFER_TRACE
(
jh
, "on committingransaction");

2291 ià(
·¹Ÿl_·ge
) {

2292 
	`jbd2_jouº®_put_jouº®_h—d
(
jh
);

2293 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2294 
	`jbd_uÆock_bh_¡©e
(
bh
);

2295 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2296  -
EBUSY
;

2304 
	`£t_bufãr_ä“d
(
bh
);

2305 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 && 
	`bufãr_jbddœty
(
bh
))

2306 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

2307 
	`jbd2_jouº®_put_jouº®_h—d
(
jh
);

2308 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2309 
	`jbd_uÆock_bh_¡©e
(
bh
);

2310 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2319 
	`J_ASSERT_JH
(
jh
, 
Œª§ùiÚ
 =ğ
jouº®
->
j_ruÂšg_Œª§ùiÚ
);

2320 
	`JBUFFER_TRACE
(
jh
, "on„unningransaction");

2321 
may_ä“
 = 
	`__di¥o£_bufãr
(
jh
, 
Œª§ùiÚ
);

2324 
z­_bufãr
:

2333 
jh
->
b_modif›d
 = 0;

2334 
	`jbd2_jouº®_put_jouº®_h—d
(
jh
);

2335 
z­_bufãr_no_jh
:

2336 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2337 
	`jbd_uÆock_bh_¡©e
(
bh
);

2338 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2339 
z­_bufãr_uÆocked
:

2340 
	`ş—r_bufãr_dœty
(
bh
);

2341 
	`J_ASSERT_BH
(
bh
, !
	`bufãr_jbddœty
(bh));

2342 
	`ş—r_bufãr_m­³d
(
bh
);

2343 
	`ş—r_bufãr_»q
(
bh
);

2344 
	`ş—r_bufãr_Ãw
(
bh
);

2345 
	`ş—r_bufãr_d–ay
(
bh
);

2346 
	`ş—r_bufãr_unwr™‹n
(
bh
);

2347 
bh
->
b_bdev
 = 
NULL
;

2348  
may_ä“
;

2349 
	}
}

2363 
	$jbd2_jouº®_šv®id©•age
(
jouº®_t
 *
jouº®
,

2364 
·ge
 *page,

2365 
off£t
,

2366 
Ëngth
)

2368 
bufãr_h—d
 *
h—d
, *
bh
, *
Ãxt
;

2369 
¡İ
 = 
off£t
 + 
Ëngth
;

2370 
cu¼_off
 = 0;

2371 
·¹Ÿl_·ge
 = (
off£t
 || 
Ëngth
 < 
PAGE_SIZE
);

2372 
may_ä“
 = 1;

2373 
»t
 = 0;

2375 ià(!
	`PageLocked
(
·ge
))

2376 
	`BUG
();

2377 ià(!
	`·ge_has_bufãrs
(
·ge
))

2380 
	`BUG_ON
(
¡İ
 > 
PAGE_SIZE
 || stİ < 
Ëngth
);

2386 
h—d
 = 
bh
 = 
	`·ge_bufãrs
(
·ge
);

2388 
Ãxt_off
 = 
cu¼_off
 + 
bh
->
b_size
;

2389 
Ãxt
 = 
bh
->
b_this_·ge
;

2391 ià(
Ãxt_off
 > 
¡İ
)

2394 ià(
off£t
 <ğ
cu¼_off
) {

2396 
	`lock_bufãr
(
bh
);

2397 
»t
 = 
	`jouº®_unm­_bufãr
(
jouº®
, 
bh
, 
·¹Ÿl_·ge
);

2398 
	`uÆock_bufãr
(
bh
);

2399 ià(
»t
 < 0)

2400  
»t
;

2401 
may_ä“
 &ğ
»t
;

2403 
cu¼_off
 = 
Ãxt_off
;

2404 
bh
 = 
Ãxt
;

2406 } 
bh
 !ğ
h—d
);

2408 ià(!
·¹Ÿl_·ge
) {

2409 ià(
may_ä“
 && 
	`Œy_to_ä“_bufãrs
(
·ge
))

2410 
	`J_ASSERT
(!
	`·ge_has_bufãrs
(
·ge
));

2413 
	}
}

2418 
	$__jbd2_jouº®_fe_bufãr
(
jouº®_h—d
 *
jh
,

2419 
Œª§ùiÚ_t
 *
Œª§ùiÚ
, 
jli¡
)

2421 
jouº®_h—d
 **
li¡
 = 
NULL
;

2422 
was_dœty
 = 0;

2423 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2425 
	`J_ASSERT_JH
(
jh
, 
	`jbd_is_locked_bh_¡©e
(
bh
));

2426 
	`as£¹_¥š_locked
(&
Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

2428 
	`J_ASSERT_JH
(
jh
, jh->
b_jli¡
 < 
BJ_Ty³s
);

2429 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

2430 
jh
->
b_Œª§ùiÚ
 =ğ
NULL
);

2432 ià(
jh
->
b_Œª§ùiÚ
 && jh->
b_jli¡
 =ğ
jli¡
)

2435 ià(
jli¡
 =ğ
BJ_M‘ad©a
 || jli¡ =ğ
BJ_Re£rved
 ||

2436 
jli¡
 =ğ
BJ_Shadow
 || jli¡ =ğ
BJ_FÜg‘
) {

2444 ià(
	`bufãr_dœty
(
bh
))

2445 
	`w¬n_dœty_bufãr
(
bh
);

2446 ià(
	`‹¡_ş—r_bufãr_dœty
(
bh
) ||

2447 
	`‹¡_ş—r_bufãr_jbddœty
(
bh
))

2448 
was_dœty
 = 1;

2451 ià(
jh
->
b_Œª§ùiÚ
)

2452 
	`__jbd2_jouº®_‹mp_uÆšk_bufãr
(
jh
);

2454 
	`jbd2_jouº®_g¿b_jouº®_h—d
(
bh
);

2455 
jh
->
b_Œª§ùiÚ
 = 
Œª§ùiÚ
;

2457 
jli¡
) {

2458 
BJ_NÚe
:

2459 
	`J_ASSERT_JH
(
jh
, !jh->
b_comm™‹d_d©a
);

2460 
	`J_ASSERT_JH
(
jh
, !jh->
b_äoz’_d©a
);

2462 
BJ_M‘ad©a
:

2463 
Œª§ùiÚ
->
t_Ä_bufãrs
++;

2464 
li¡
 = &
Œª§ùiÚ
->
t_bufãrs
;

2466 
BJ_FÜg‘
:

2467 
li¡
 = &
Œª§ùiÚ
->
t_fÜg‘
;

2469 
BJ_Shadow
:

2470 
li¡
 = &
Œª§ùiÚ
->
t_shadow_li¡
;

2472 
BJ_Re£rved
:

2473 
li¡
 = &
Œª§ùiÚ
->
t_»£rved_li¡
;

2477 
	`__bli¡_add_bufãr
(
li¡
, 
jh
);

2478 
jh
->
b_jli¡
 = 
jli¡
;

2480 ià(
was_dœty
)

2481 
	`£t_bufãr_jbddœty
(
bh
);

2482 
	}
}

2484 
	$jbd2_jouº®_fe_bufãr
(
jouº®_h—d
 *
jh
,

2485 
Œª§ùiÚ_t
 *
Œª§ùiÚ
, 
jli¡
)

2487 
	`jbd_lock_bh_¡©e
(
	`jh2bh
(
jh
));

2488 
	`¥š_lock
(&
Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

2489 
	`__jbd2_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
jli¡
);

2490 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

2491 
	`jbd_uÆock_bh_¡©e
(
	`jh2bh
(
jh
));

2492 
	}
}

2505 
	$__jbd2_jouº®_»fe_bufãr
(
jouº®_h—d
 *
jh
)

2507 
was_dœty
, 
jli¡
;

2508 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2510 
	`J_ASSERT_JH
(
jh
, 
	`jbd_is_locked_bh_¡©e
(
bh
));

2511 ià(
jh
->
b_Œª§ùiÚ
)

2512 
	`as£¹_¥š_locked
(&
jh
->
b_Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

2515 ià(
jh
->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
) {

2516 
	`__jbd2_jouº®_unfe_bufãr
(
jh
);

2525 
was_dœty
 = 
	`‹¡_ş—r_bufãr_jbddœty
(
bh
);

2526 
	`__jbd2_jouº®_‹mp_uÆšk_bufãr
(
jh
);

2532 
jh
->
b_Œª§ùiÚ
 = jh->
b_Ãxt_Œª§ùiÚ
;

2533 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
NULL
;

2534 ià(
	`bufãr_ä“d
(
bh
))

2535 
jli¡
 = 
BJ_FÜg‘
;

2536 ià(
jh
->
b_modif›d
)

2537 
jli¡
 = 
BJ_M‘ad©a
;

2539 
jli¡
 = 
BJ_Re£rved
;

2540 
	`__jbd2_jouº®_fe_bufãr
(
jh
, jh->
b_Œª§ùiÚ
, 
jli¡
);

2541 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
->
t_¡©e
 =ğ
T_RUNNING
);

2543 ià(
was_dœty
)

2544 
	`£t_bufãr_jbddœty
(
bh
);

2545 
	}
}

2553 
	$jbd2_jouº®_»fe_bufãr
(
jouº®_t
 *
jouº®
, 
jouº®_h—d
 *
jh
)

2555 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2558 
	`g‘_bh
(
bh
);

2559 
	`jbd_lock_bh_¡©e
(
bh
);

2560 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2561 
	`__jbd2_jouº®_»fe_bufãr
(
jh
);

2562 
	`jbd_uÆock_bh_¡©e
(
bh
);

2563 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2564 
	`__b»l£
(
bh
);

2565 
	}
}

2570 
	$jbd2_jouº®_fe_šode
(
hªdË_t
 *
hªdË
, 
jbd2_šode
 *
jšode
,

2571 
æags
, 
loff_t
 
¡¬t_by‹
,†off_ˆ
’d_by‹
)

2573 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

2574 
jouº®_t
 *
jouº®
;

2576 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

2577  -
EROFS
;

2578 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

2580 
	`jbd_debug
(4, "Addšg inod%lu,id:%d\n", 
jšode
->
i_vfs_šode
->
i_šo
,

2581 
Œª§ùiÚ
->
t_tid
);

2583 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2584 
jšode
->
i_æags
 |ğ
æags
;

2586 ià(
jšode
->
i_dœty_’d
) {

2587 
jšode
->
i_dœty_¡¬t
 = 
	`mš
(jšode->i_dœty_¡¬t, 
¡¬t_by‹
);

2588 
jšode
->
i_dœty_’d
 = 
	`max
(jšode->i_dœty_’d, 
’d_by‹
);

2590 
jšode
->
i_dœty_¡¬t
 = 
¡¬t_by‹
;

2591 
jšode
->
i_dœty_’d
 = 
’d_by‹
;

2595 ià(
jšode
->
i_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

2596 
jšode
->
i_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
)

2597 
dÚe
;

2604 ià(!
Œª§ùiÚ
->
t_Ãed_d©a_æush
)

2605 
Œª§ùiÚ
->
t_Ãed_d©a_æush
 = 1;

2608 ià(
jšode
->
i_Œª§ùiÚ
) {

2609 
	`J_ASSERT
(
jšode
->
i_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

2610 
	`J_ASSERT
(
jšode
->
i_Œª§ùiÚ
 ==

2611 
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

2612 
jšode
->
i_Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

2613 
dÚe
;

2616 
	`J_ASSERT
(!
jšode
->
i_Ãxt_Œª§ùiÚ
);

2617 
jšode
->
i_Œª§ùiÚ
 = 
Œª§ùiÚ
;

2618 
	`li¡_add
(&
jšode
->
i_li¡
, &
Œª§ùiÚ
->
t_šode_li¡
);

2619 
dÚe
:

2620 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2623 
	}
}

2625 
	$jbd2_jouº®_šode_¿nged_wr™e
(
hªdË_t
 *
hªdË
,

2626 
jbd2_šode
 *
jšode
, 
loff_t
 
¡¬t_by‹
,†off_ˆ
Ëngth
)

2628  
	`jbd2_jouº®_fe_šode
(
hªdË
, 
jšode
,

2629 
JI_WRITE_DATA
 | 
JI_WAIT_DATA
, 
¡¬t_by‹
,

2630 
¡¬t_by‹
 + 
Ëngth
 - 1);

2631 
	}
}

2633 
	$jbd2_jouº®_šode_¿nged_wa™
(
hªdË_t
 *
hªdË
, 
jbd2_šode
 *
jšode
,

2634 
loff_t
 
¡¬t_by‹
,†off_ˆ
Ëngth
)

2636  
	`jbd2_jouº®_fe_šode
(
hªdË
, 
jšode
, 
JI_WAIT_DATA
,

2637 
¡¬t_by‹
, s¹_by‹ + 
Ëngth
 - 1);

2638 
	}
}

2660 
	$jbd2_jouº®_begš_Üd”ed_Œunÿ‹
(
jouº®_t
 *
jouº®
,

2661 
jbd2_šode
 *
jšode
,

2662 
loff_t
 
Ãw_size
)

2664 
Œª§ùiÚ_t
 *
šode_Œªs
, *
comm™_Œªs
;

2665 
»t
 = 0;

2668 ià(!
jšode
->
i_Œª§ùiÚ
)

2669 
out
;

2673 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

2674 
comm™_Œªs
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

2675 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

2676 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2677 
šode_Œªs
 = 
jšode
->
i_Œª§ùiÚ
;

2678 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2679 ià(
šode_Œªs
 =ğ
comm™_Œªs
) {

2680 
»t
 = 
	`fem­_fd©awr™e_¿nge
(
jšode
->
i_vfs_šode
->
i_m­pšg
,

2681 
Ãw_size
, 
LLONG_MAX
);

2682 ià(
»t
)

2683 
	`jbd2_jouº®_abÜt
(
jouº®
, 
»t
);

2685 
out
:

2686  
»t
;

2687 
	}
}

	@pxt4/acl.c

8 
	~<lšux/quÙaİs.h
>

9 
	~"ext4_jbd2.h
"

10 
	~"ext4.h
"

11 
	~"x©Œ.h
"

12 
	~"aş.h
"

17 
posix_aş
 *

18 
	$ext4_aş_äom_disk
(cÚ¡ *
v®ue
, 
size_t
 
size
)

20 cÚ¡ *
’d
 = (*)
v®ue
 + 
size
;

21 
n
, 
couÁ
;

22 
posix_aş
 *
aş
;

24 ià(!
v®ue
)

25  
NULL
;

26 ià(
size
 < (
ext4_aş_h—d”
))

27  
	`ERR_PTR
(-
EINVAL
);

28 ià(((
ext4_aş_h—d”
 *)
v®ue
)->
a_v”siÚ
 !=

29 
	`ıu_to_Ë32
(
EXT4_ACL_VERSION
))

30  
	`ERR_PTR
(-
EINVAL
);

31 
v®ue
 = (*)v®u+ (
ext4_aş_h—d”
);

32 
couÁ
 = 
	`ext4_aş_couÁ
(
size
);

33 ià(
couÁ
 < 0)

34  
	`ERR_PTR
(-
EINVAL
);

35 ià(
couÁ
 == 0)

36  
NULL
;

37 
aş
 = 
	`posix_aş_®loc
(
couÁ
, 
GFP_NOFS
);

38 ià(!
aş
)

39  
	`ERR_PTR
(-
ENOMEM
);

40 
n
 = 0;‚ < 
couÁ
;‚++) {

41 
ext4_aş_’Œy
 *
’Œy
 =

42 (
ext4_aş_’Œy
 *)
v®ue
;

43 ià((*)
v®ue
 + (
ext4_aş_’Œy_shÜt
è> 
’d
)

44 
ç
;

45 
aş
->
a_’Œ›s
[
n
].
e_g
 = 
	`Ë16_to_ıu
(
’Œy
->e_tag);

46 
aş
->
a_’Œ›s
[
n
].
e_³rm
 = 
	`Ë16_to_ıu
(
’Œy
->e_perm);

48 
aş
->
a_’Œ›s
[
n
].
e_g
) {

49 
ACL_USER_OBJ
:

50 
ACL_GROUP_OBJ
:

51 
ACL_MASK
:

52 
ACL_OTHER
:

53 
v®ue
 = (*)value +

54 (
ext4_aş_’Œy_shÜt
);

57 
ACL_USER
:

58 
v®ue
 = (*)v®u+ (
ext4_aş_’Œy
);

59 ià((*)
v®ue
 > 
’d
)

60 
ç
;

61 
aş
->
a_’Œ›s
[
n
].
e_uid
 =

62 
	`make_kuid
(&
š™_u£r_ns
,

63 
	`Ë32_to_ıu
(
’Œy
->
e_id
));

65 
ACL_GROUP
:

66 
v®ue
 = (*)v®u+ (
ext4_aş_’Œy
);

67 ià((*)
v®ue
 > 
’d
)

68 
ç
;

69 
aş
->
a_’Œ›s
[
n
].
e_gid
 =

70 
	`make_kgid
(&
š™_u£r_ns
,

71 
	`Ë32_to_ıu
(
’Œy
->
e_id
));

75 
ç
;

78 ià(
v®ue
 !ğ
’d
)

79 
ç
;

80  
aş
;

82 
ç
:

83 
	`posix_aş_»Ëa£
(
aş
);

84  
	`ERR_PTR
(-
EINVAL
);

85 
	}
}

91 
	$ext4_aş_to_disk
(cÚ¡ 
posix_aş
 *
aş
, 
size_t
 *
size
)

93 
ext4_aş_h—d”
 *
ext_aş
;

94 *
e
;

95 
size_t
 
n
;

97 *
size
 = 
	`ext4_aş_size
(
aş
->
a_couÁ
);

98 
ext_aş
 = 
	`km®loc
((
ext4_aş_h—d”
è+ 
aş
->
a_couÁ
 *

99 (
ext4_aş_’Œy
), 
GFP_NOFS
);

100 ià(!
ext_aş
)

101  
	`ERR_PTR
(-
ENOMEM
);

102 
ext_aş
->
a_v”siÚ
 = 
	`ıu_to_Ë32
(
EXT4_ACL_VERSION
);

103 
e
 = (*)
ext_aş
 + (
ext4_aş_h—d”
);

104 
n
 = 0;‚ < 
aş
->
a_couÁ
;‚++) {

105 cÚ¡ 
posix_aş_’Œy
 *
aş_e
 = &
aş
->
a_’Œ›s
[
n
];

106 
ext4_aş_’Œy
 *
’Œy
 = (ext4_aş_’Œy *)
e
;

107 
’Œy
->
e_g
 = 
	`ıu_to_Ë16
(
aş_e
->e_tag);

108 
’Œy
->
e_³rm
 = 
	`ıu_to_Ë16
(
aş_e
->e_perm);

109 
aş_e
->
e_g
) {

110 
ACL_USER
:

111 
’Œy
->
e_id
 = 
	`ıu_to_Ë32
(

112 
	`äom_kuid
(&
š™_u£r_ns
, 
aş_e
->
e_uid
));

113 
e
 +ğ(
ext4_aş_’Œy
);

115 
ACL_GROUP
:

116 
’Œy
->
e_id
 = 
	`ıu_to_Ë32
(

117 
	`äom_kgid
(&
š™_u£r_ns
, 
aş_e
->
e_gid
));

118 
e
 +ğ(
ext4_aş_’Œy
);

121 
ACL_USER_OBJ
:

122 
ACL_GROUP_OBJ
:

123 
ACL_MASK
:

124 
ACL_OTHER
:

125 
e
 +ğ(
ext4_aş_’Œy_shÜt
);

129 
ç
;

132  (*)
ext_aş
;

134 
ç
:

135 
	`kä“
(
ext_aş
);

136  
	`ERR_PTR
(-
EINVAL
);

137 
	}
}

144 
posix_aş
 *

145 
	$ext4_g‘_aş
(
šode
 *šode, 
ty³
)

147 
Çme_šdex
;

148 *
v®ue
 = 
NULL
;

149 
posix_aş
 *
aş
;

150 
»tv®
;

152 
ty³
) {

153 
ACL_TYPE_ACCESS
:

154 
Çme_šdex
 = 
EXT4_XATTR_INDEX_POSIX_ACL_ACCESS
;

156 
ACL_TYPE_DEFAULT
:

157 
Çme_šdex
 = 
EXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
;

160 
	`BUG
();

162 
»tv®
 = 
	`ext4_x©Œ_g‘
(
šode
, 
Çme_šdex
, "", 
NULL
, 0);

163 ià(
»tv®
 > 0) {

164 
v®ue
 = 
	`km®loc
(
»tv®
, 
GFP_NOFS
);

165 ià(!
v®ue
)

166  
	`ERR_PTR
(-
ENOMEM
);

167 
»tv®
 = 
	`ext4_x©Œ_g‘
(
šode
, 
Çme_šdex
, "", 
v®ue
,„etval);

169 ià(
»tv®
 > 0)

170 
aş
 = 
	`ext4_aş_äom_disk
(
v®ue
, 
»tv®
);

171 ià(
»tv®
 =ğ-
ENODATA
 ||„‘v® =ğ-
ENOSYS
)

172 
aş
 = 
NULL
;

174 
aş
 = 
	`ERR_PTR
(
»tv®
);

175 
	`kä“
(
v®ue
);

177  
aş
;

178 
	}
}

186 
	$__ext4_£t_aş
(
hªdË_t
 *
hªdË
, 
šode
 *šode, 
ty³
,

187 
posix_aş
 *
aş
, 
x©Œ_æags
)

189 
Çme_šdex
;

190 *
v®ue
 = 
NULL
;

191 
size_t
 
size
 = 0;

192 
”rÜ
;

194 
ty³
) {

195 
ACL_TYPE_ACCESS
:

196 
Çme_šdex
 = 
EXT4_XATTR_INDEX_POSIX_ACL_ACCESS
;

199 
ACL_TYPE_DEFAULT
:

200 
Çme_šdex
 = 
EXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
;

201 ià(!
	`S_ISDIR
(
šode
->
i_mode
))

202  
aş
 ? -
EACCES
 : 0;

206  -
EINVAL
;

208 ià(
aş
) {

209 
v®ue
 = 
	`ext4_aş_to_disk
(
aş
, &
size
);

210 ià(
	`IS_ERR
(
v®ue
))

211  ()
	`PTR_ERR
(
v®ue
);

214 
”rÜ
 = 
	`ext4_x©Œ_£t_hªdË
(
hªdË
, 
šode
, 
Çme_šdex
, "",

215 
v®ue
, 
size
, 
x©Œ_æags
);

217 
	`kä“
(
v®ue
);

218 ià(!
”rÜ
) {

219 
	`£t_ÿched_aş
(
šode
, 
ty³
, 
aş
);

222  
”rÜ
;

223 
	}
}

226 
	$ext4_£t_aş
(
šode
 *šode, 
posix_aş
 *
aş
, 
ty³
)

228 
hªdË_t
 *
hªdË
;

229 
”rÜ
, 
üed™s
, 
»Œ›s
 = 0;

230 
size_t
 
aş_size
 = 
aş
 ? 
	`ext4_aş_size
×ş->
a_couÁ
) : 0;

231 
umode_t
 
mode
 = 
šode
->
i_mode
;

232 
upd©e_mode
 = 0;

234 
”rÜ
 = 
	`dquÙ_š™Ÿlize
(
šode
);

235 ià(
”rÜ
)

236  
”rÜ
;

237 
»Œy
:

238 
”rÜ
 = 
	`ext4_x©Œ_£t_üed™s
(
šode
, 
aş_size
, 
çl£
 ,

239 &
üed™s
);

240 ià(
”rÜ
)

241  
”rÜ
;

243 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_XATTR
, 
üed™s
);

244 ià(
	`IS_ERR
(
hªdË
))

245  
	`PTR_ERR
(
hªdË
);

247 ià((
ty³
 =ğ
ACL_TYPE_ACCESS
è&& 
aş
) {

248 
”rÜ
 = 
	`posix_aş_upd©e_mode
(
šode
, &
mode
, &
aş
);

249 ià(
”rÜ
)

250 
out_¡İ
;

251 ià(
mode
 !ğ
šode
->
i_mode
)

252 
upd©e_mode
 = 1;

255 
”rÜ
 = 
	`__ext4_£t_aş
(
hªdË
, 
šode
, 
ty³
, 
aş
, 0 );

256 ià(!
”rÜ
 && 
upd©e_mode
) {

257 
šode
->
i_mode
 = 
mode
;

258 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

259 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

261 
out_¡İ
:

262 
	`ext4_jouº®_¡İ
(
hªdË
);

263 ià(
”rÜ
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

264 
»Œy
;

265  
”rÜ
;

266 
	}
}

275 
	$ext4_š™_aş
(
hªdË_t
 *
hªdË
, 
šode
 *šode, šod*
dœ
)

277 
posix_aş
 *
deçuÉ_aş
, *
aş
;

278 
”rÜ
;

280 
”rÜ
 = 
	`posix_aş_ü—‹
(
dœ
, &
šode
->
i_mode
, &
deçuÉ_aş
, &
aş
);

281 ià(
”rÜ
)

282  
”rÜ
;

284 ià(
deçuÉ_aş
) {

285 
”rÜ
 = 
	`__ext4_£t_aş
(
hªdË
, 
šode
, 
ACL_TYPE_DEFAULT
,

286 
deçuÉ_aş
, 
XATTR_CREATE
);

287 
	`posix_aş_»Ëa£
(
deçuÉ_aş
);

289 
šode
->
i_deçuÉ_aş
 = 
NULL
;

291 ià(
aş
) {

292 ià(!
”rÜ
)

293 
”rÜ
 = 
	`__ext4_£t_aş
(
hªdË
, 
šode
, 
ACL_TYPE_ACCESS
,

294 
aş
, 
XATTR_CREATE
);

295 
	`posix_aş_»Ëa£
(
aş
);

297 
šode
->
i_aş
 = 
NULL
;

299  
”rÜ
;

300 
	}
}

	@pxt4/acl.h

8 
	~<lšux/posix_aş_x©Œ.h
>

10 
	#EXT4_ACL_VERSION
 0x0001

	)

13 
__Ë16
 
	me_g
;

14 
__Ë16
 
	me_³rm
;

15 
__Ë32
 
	me_id
;

16 } 
	text4_aş_’Œy
;

19 
__Ë16
 
	me_g
;

20 
__Ë16
 
	me_³rm
;

21 } 
	text4_aş_’Œy_shÜt
;

24 
__Ë32
 
	ma_v”siÚ
;

25 } 
	text4_aş_h—d”
;

27 
šlše
 
size_t
 
	$ext4_aş_size
(
couÁ
)

29 ià(
couÁ
 <= 4) {

30  (
ext4_aş_h—d”
) +

31 
couÁ
 * (
ext4_aş_’Œy_shÜt
);

33  (
ext4_aş_h—d”
) +

34 4 * (
ext4_aş_’Œy_shÜt
) +

35 (
couÁ
 - 4è* (
ext4_aş_’Œy
);

37 
	}
}

39 
šlše
 
	$ext4_aş_couÁ
(
size_t
 
size
)

41 
ssize_t
 
s
;

42 
size
 -ğ(
ext4_aş_h—d”
);

43 
s
 = 
size
 - 4 * (
ext4_aş_’Œy_shÜt
);

44 ià(
s
 < 0) {

45 ià(
size
 % (
ext4_aş_’Œy_shÜt
))

47  
size
 / (
ext4_aş_’Œy_shÜt
);

49 ià(
s
 % (
ext4_aş_’Œy
))

51  
s
 / (
ext4_aş_’Œy
) + 4;

53 
	}
}

55 #ifdeà
CONFIG_EXT4_FS_POSIX_ACL


58 
posix_aş
 *
ext4_g‘_aş
(
šode
 *šode, 
ty³
);

59 
ext4_£t_aş
(
šode
 *šode, 
posix_aş
 *
aş
, 
ty³
);

60 
ext4_š™_aş
(
hªdË_t
 *, 
šode
 *, inode *);

63 
	~<lšux/sched.h
>

64 
	#ext4_g‘_aş
 
NULL


	)

65 
	#ext4_£t_aş
 
NULL


	)

67 
šlše
 

68 
	$ext4_š™_aş
(
hªdË_t
 *
hªdË
, 
šode
 *šode, šod*
dœ
)

71 
	}
}

	@pxt4/balloc.c

15 
	~<lšux/time.h
>

16 
	~<lšux/ÿ·b™y.h
>

17 
	~<lšux/fs.h
>

18 
	~<lšux/quÙaİs.h
>

19 
	~<lšux/bufãr_h—d.h
>

20 
	~"ext4.h
"

21 
	~"ext4_jbd2.h
"

22 
	~"mb®loc.h
"

24 
	~<Œaû/ev’ts/ext4.h
>

26 
ext4_num_ba£_m‘a_şu¡”s
(
su³r_block
 *
sb
,

27 
ext4_group_t
 
block_group
);

35 
ext4_group_t
 
	$ext4_g‘_group_numb”
(
su³r_block
 *
sb
,

36 
ext4_fsblk_t
 
block
)

38 
ext4_group_t
 
group
;

40 ià(
	`‹¡_İt2
(
sb
, 
STD_GROUP_SIZE
))

41 
group
 = (
block
 -

42 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_fœ¡_d©a_block
)) >>

43 (
	`EXT4_BLOCK_SIZE_BITS
(
sb
è+ 
	`EXT4_CLUSTER_BITS
(sb) + 3);

45 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
block
, &
group
, 
NULL
);

46  
group
;

47 
	}
}

53 
	$ext4_g‘_group_no_ªd_off£t
(
su³r_block
 *
sb
, 
ext4_fsblk_t
 
blockÄ
,

54 
ext4_group_t
 *
blockg½p
, 
ext4_g½blk_t
 *
off£
)

56 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

57 
ext4_g½blk_t
 
off£t
;

59 
blockÄ
 = blockÄ - 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
);

60 
off£t
 = 
	`do_div
(
blockÄ
, 
	`EXT4_BLOCKS_PER_GROUP
(
sb
)) >>

61 
	`EXT4_SB
(
sb
)->
s_şu¡”_b™s
;

62 ià(
off£
)

63 *
off£
 = 
off£t
;

64 ià(
blockg½p
)

65 *
blockg½p
 = 
blockÄ
;

67 
	}
}

73 
šlše
 
	$ext4_block_š_group
(
su³r_block
 *
sb
,

74 
ext4_fsblk_t
 
block
,

75 
ext4_group_t
 
block_group
)

77 
ext4_group_t
 
aùu®_group
;

79 
aùu®_group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
block
);

80  (
aùu®_group
 =ğ
block_group
) ? 1 : 0;

81 
	}
}

86 
	$ext4_num_ov”h—d_şu¡”s
(
su³r_block
 *
sb
,

87 
ext4_group_t
 
block_group
,

88 
ext4_group_desc
 *
gdp
)

90 
num_şu¡”s
;

91 
block_şu¡”
 = -1, 
šode_şu¡”
 = -1, 
™bl_şu¡”
 = -1, 
i
, 
c
;

92 
ext4_fsblk_t
 
¡¬t
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
block_group
);

93 
ext4_fsblk_t
 
™bl_blk
;

94 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

99 
num_şu¡”s
 = 
	`ext4_num_ba£_m‘a_şu¡”s
(
sb
, 
block_group
);

113 ià(
	`ext4_block_š_group
(
sb
, 
	`ext4_block_b™m­
(sb, 
gdp
), 
block_group
)) {

114 
block_şu¡”
 = 
	`EXT4_B2C
(
sbi
,

115 
	`ext4_block_b™m­
(
sb
, 
gdp
è- 
¡¬t
);

116 ià(
block_şu¡”
 < 
num_şu¡”s
)

117 
block_şu¡”
 = -1;

118 ià(
block_şu¡”
 =ğ
num_şu¡”s
) {

119 
num_şu¡”s
++;

120 
block_şu¡”
 = -1;

124 ià(
	`ext4_block_š_group
(
sb
, 
	`ext4_šode_b™m­
(sb, 
gdp
), 
block_group
)) {

125 
šode_şu¡”
 = 
	`EXT4_B2C
(
sbi
,

126 
	`ext4_šode_b™m­
(
sb
, 
gdp
è- 
¡¬t
);

127 ià(
šode_şu¡”
 < 
num_şu¡”s
)

128 
šode_şu¡”
 = -1;

129 ià(
šode_şu¡”
 =ğ
num_şu¡”s
) {

130 
num_şu¡”s
++;

131 
šode_şu¡”
 = -1;

135 
™bl_blk
 = 
	`ext4_šode_bË
(
sb
, 
gdp
);

136 
i
 = 0; i < 
sbi
->
s_™b_³r_group
; i++) {

137 ià(
	`ext4_block_š_group
(
sb
, 
™bl_blk
 + 
i
, 
block_group
)) {

138 
c
 = 
	`EXT4_B2C
(
sbi
, 
™bl_blk
 + 
i
 - 
¡¬t
);

139 ià((
c
 < 
num_şu¡”s
è|| (ø=ğ
šode_şu¡”
) ||

140 (
c
 =ğ
block_şu¡”
è|| (ø=ğ
™bl_şu¡”
))

142 ià(
c
 =ğ
num_şu¡”s
) {

143 
num_şu¡”s
++;

146 
num_şu¡”s
++;

147 
™bl_şu¡”
 = 
c
;

151 ià(
block_şu¡”
 != -1)

152 
num_şu¡”s
++;

153 ià(
šode_şu¡”
 != -1)

154 
num_şu¡”s
++;

156  
num_şu¡”s
;

157 
	}
}

159 
	$num_şu¡”s_š_group
(
su³r_block
 *
sb
,

160 
ext4_group_t
 
block_group
)

162 
blocks
;

164 ià(
block_group
 =ğ
	`ext4_g‘_groups_couÁ
(
sb
) - 1) {

171 
blocks
 = 
	`ext4_blocks_couÁ
(
	`EXT4_SB
(
sb
)->
s_es
) -

172 
	`ext4_group_fœ¡_block_no
(
sb
, 
block_group
);

174 
blocks
 = 
	`EXT4_BLOCKS_PER_GROUP
(
sb
);

175  
	`EXT4_NUM_B2C
(
	`EXT4_SB
(
sb
), 
blocks
);

176 
	}
}

179 
	$ext4_š™_block_b™m­
(
su³r_block
 *
sb
,

180 
bufãr_h—d
 *
bh
,

181 
ext4_group_t
 
block_group
,

182 
ext4_group_desc
 *
gdp
)

184 
b™
, 
b™_max
;

185 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

186 
ext4_fsblk_t
 
¡¬t
, 
tmp
;

188 
	`J_ASSERT_BH
(
bh
, 
	`bufãr_locked
(bh));

192 ià(!
	`ext4_group_desc_csum_v”ify
(
sb
, 
block_group
, 
gdp
)) {

193 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
sb
, 
block_group
,

194 
EXT4_GROUP_INFO_BBITMAP_CORRUPT
 |

195 
EXT4_GROUP_INFO_IBITMAP_CORRUPT
);

196  -
EFSBADCRC
;

198 
	`mem£t
(
bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

200 
b™_max
 = 
	`ext4_num_ba£_m‘a_şu¡”s
(
sb
, 
block_group
);

201 ià((
b™_max
 >> 3è>ğ
bh
->
b_size
)

202  -
EFSCORRUPTED
;

204 
b™
 = 0; b™ < 
b™_max
; bit++)

205 
	`ext4_£t_b™
(
b™
, 
bh
->
b_d©a
);

207 
¡¬t
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
block_group
);

210 
tmp
 = 
	`ext4_block_b™m­
(
sb
, 
gdp
);

211 ià(
	`ext4_block_š_group
(
sb
, 
tmp
, 
block_group
))

212 
	`ext4_£t_b™
(
	`EXT4_B2C
(
sbi
, 
tmp
 - 
¡¬t
), 
bh
->
b_d©a
);

214 
tmp
 = 
	`ext4_šode_b™m­
(
sb
, 
gdp
);

215 ià(
	`ext4_block_š_group
(
sb
, 
tmp
, 
block_group
))

216 
	`ext4_£t_b™
(
	`EXT4_B2C
(
sbi
, 
tmp
 - 
¡¬t
), 
bh
->
b_d©a
);

218 
tmp
 = 
	`ext4_šode_bË
(
sb
, 
gdp
);

219 ; 
tmp
 < 
	`ext4_šode_bË
(
sb
, 
gdp
) +

220 
sbi
->
s_™b_³r_group
; 
tmp
++) {

221 ià(
	`ext4_block_š_group
(
sb
, 
tmp
, 
block_group
))

222 
	`ext4_£t_b™
(
	`EXT4_B2C
(
sbi
, 
tmp
 - 
¡¬t
), 
bh
->
b_d©a
);

230 
	`ext4_m¬k_b™m­_’d
(
	`num_şu¡”s_š_group
(
sb
, 
block_group
),

231 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

233 
	}
}

238 
	$ext4_ä“_şu¡”s_aá”_š™
(
su³r_block
 *
sb
,

239 
ext4_group_t
 
block_group
,

240 
ext4_group_desc
 *
gdp
)

242  
	`num_şu¡”s_š_group
(
sb
, 
block_group
) -

243 
	`ext4_num_ov”h—d_şu¡”s
(
sb
, 
block_group
, 
gdp
);

244 
	}
}

264 
ext4_group_desc
 * 
	$ext4_g‘_group_desc
(
su³r_block
 *
sb
,

265 
ext4_group_t
 
block_group
,

266 
bufãr_h—d
 **
bh
)

268 
group_desc
;

269 
off£t
;

270 
ext4_group_t
 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

271 
ext4_group_desc
 *
desc
;

272 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

274 ià(
block_group
 >ğ
ngroups
) {

275 
	`ext4_”rÜ
(
sb
, "block_group >= groups_count - block_group = %u,"

276 " groups_couÁ = %u", 
block_group
, 
ngroups
);

278  
NULL
;

281 
group_desc
 = 
block_group
 >> 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
);

282 
off£t
 = 
block_group
 & (
	`EXT4_DESC_PER_BLOCK
(
sb
) - 1);

283 ià(!
sbi
->
s_group_desc
[
group_desc
]) {

284 
	`ext4_”rÜ
(
sb
, "Group descriptor‚ot†oaded - "

286 
block_group
, 
group_desc
, 
off£t
);

287  
NULL
;

290 
desc
 = (
ext4_group_desc
 *)(

291 (
__u8
 *)
sbi
->
s_group_desc
[
group_desc
]->
b_d©a
 +

292 
off£t
 * 
	`EXT4_DESC_SIZE
(
sb
));

293 ià(
bh
)

294 *
bh
 = 
sbi
->
s_group_desc
[
group_desc
];

295  
desc
;

296 
	}
}

302 
ext4_fsblk_t
 
	$ext4_v®id_block_b™m­
(
su³r_block
 *
sb
,

303 
ext4_group_desc
 *
desc
,

304 
ext4_group_t
 
block_group
,

305 
bufãr_h—d
 *
bh
)

307 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

308 
ext4_g½blk_t
 
off£t
;

309 
ext4_g½blk_t
 
Ãxt_z”o_b™
;

310 
ext4_g½blk_t
 
max_b™
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
);

311 
ext4_fsblk_t
 
blk
;

312 
ext4_fsblk_t
 
group_fœ¡_block
;

314 ià(
	`ext4_has_ã©u»_æex_bg
(
sb
)) {

323 
group_fœ¡_block
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
block_group
);

326 
blk
 = 
	`ext4_block_b™m­
(
sb
, 
desc
);

327 
off£t
 = 
blk
 - 
group_fœ¡_block
;

328 ià(
off£t
 < 0 || 
	`EXT4_B2C
(
sbi
, off£tè>ğ
max_b™
 ||

329 !
	`ext4_‹¡_b™
(
	`EXT4_B2C
(
sbi
, 
off£t
), 
bh
->
b_d©a
))

331  
blk
;

334 
blk
 = 
	`ext4_šode_b™m­
(
sb
, 
desc
);

335 
off£t
 = 
blk
 - 
group_fœ¡_block
;

336 ià(
off£t
 < 0 || 
	`EXT4_B2C
(
sbi
, off£tè>ğ
max_b™
 ||

337 !
	`ext4_‹¡_b™
(
	`EXT4_B2C
(
sbi
, 
off£t
), 
bh
->
b_d©a
))

339  
blk
;

342 
blk
 = 
	`ext4_šode_bË
(
sb
, 
desc
);

343 
off£t
 = 
blk
 - 
group_fœ¡_block
;

344 ià(
off£t
 < 0 || 
	`EXT4_B2C
(
sbi
, off£tè>ğ
max_b™
 ||

345 
	`EXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_™b_³r_group
è>ğ
max_b™
)

346  
blk
;

347 
Ãxt_z”o_b™
 = 
	`ext4_fšd_Ãxt_z”o_b™
(
bh
->
b_d©a
,

348 
	`EXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_™b_³r_group
),

349 
	`EXT4_B2C
(
sbi
, 
off£t
));

350 ià(
Ãxt_z”o_b™
 <

351 
	`EXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_™b_³r_group
))

353  
blk
;

355 
	}
}

357 
	$ext4_v®id©e_block_b™m­
(
su³r_block
 *
sb
,

358 
ext4_group_desc
 *
desc
,

359 
ext4_group_t
 
block_group
,

360 
bufãr_h—d
 *
bh
)

362 
ext4_fsblk_t
 
blk
;

363 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
block_group
);

365 ià(
	`bufãr_v”if›d
(
bh
))

367 ià(
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(
g½
))

368  -
EFSCORRUPTED
;

370 
	`ext4_lock_group
(
sb
, 
block_group
);

371 ià(
	`bufãr_v”if›d
(
bh
))

372 
v”if›d
;

373 ià(
	`uÆik–y
(!
	`ext4_block_b™m­_csum_v”ify
(
sb
, 
block_group
,

374 
desc
, 
bh
))) {

375 
	`ext4_uÆock_group
(
sb
, 
block_group
);

376 
	`ext4_”rÜ
(
sb
, "bg %u: bad block b™m­ checksum", 
block_group
);

377 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
sb
, 
block_group
,

378 
EXT4_GROUP_INFO_BBITMAP_CORRUPT
);

379  -
EFSBADCRC
;

381 
blk
 = 
	`ext4_v®id_block_b™m­
(
sb
, 
desc
, 
block_group
, 
bh
);

382 ià(
	`uÆik–y
(
blk
 != 0)) {

383 
	`ext4_uÆock_group
(
sb
, 
block_group
);

384 
	`ext4_”rÜ
(
sb
, "bg %u: block %llu: invalid block bitmap",

385 
block_group
, 
blk
);

386 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
sb
, 
block_group
,

387 
EXT4_GROUP_INFO_BBITMAP_CORRUPT
);

388  -
EFSCORRUPTED
;

390 
	`£t_bufãr_v”if›d
(
bh
);

391 
v”if›d
:

392 
	`ext4_uÆock_group
(
sb
, 
block_group
);

394 
	}
}

406 
bufãr_h—d
 *

407 
	$ext4_»ad_block_b™m­_nowa™
(
su³r_block
 *
sb
, 
ext4_group_t
 
block_group
)

409 
ext4_group_desc
 *
desc
;

410 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

411 
bufãr_h—d
 *
bh
;

412 
ext4_fsblk_t
 
b™m­_blk
;

413 
”r
;

415 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
block_group
, 
NULL
);

416 ià(!
desc
)

417  
	`ERR_PTR
(-
EFSCORRUPTED
);

418 
b™m­_blk
 = 
	`ext4_block_b™m­
(
sb
, 
desc
);

419 ià((
b™m­_blk
 <ğ
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_d©a_block
)) ||

420 (
b™m­_blk
 >ğ
	`ext4_blocks_couÁ
(
sbi
->
s_es
))) {

421 
	`ext4_”rÜ
(
sb
, "Invalid block bitmap block %llu in "

422 "block_grou°%u", 
b™m­_blk
, 
block_group
);

423 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
sb
, 
block_group
,

424 
EXT4_GROUP_INFO_BBITMAP_CORRUPT
);

425  
	`ERR_PTR
(-
EFSCORRUPTED
);

427 
bh
 = 
	`sb_g‘blk
(
sb
, 
b™m­_blk
);

428 ià(
	`uÆik–y
(!
bh
)) {

429 
	`ext4_w¬nšg
(
sb
, "Cannot get buffer for block bitmap - "

431 
block_group
, 
b™m­_blk
);

432  
	`ERR_PTR
(-
ENOMEM
);

435 ià(
	`b™m­_u±od©e
(
bh
))

436 
v”ify
;

438 
	`lock_bufãr
(
bh
);

439 ià(
	`b™m­_u±od©e
(
bh
)) {

440 
	`uÆock_bufãr
(
bh
);

441 
v”ify
;

443 
	`ext4_lock_group
(
sb
, 
block_group
);

444 ià(
	`ext4_has_group_desc_csum
(
sb
) &&

445 (
desc
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_BLOCK_UNINIT
))) {

446 ià(
block_group
 == 0) {

447 
	`ext4_uÆock_group
(
sb
, 
block_group
);

448 
	`uÆock_bufãr
(
bh
);

449 
	`ext4_”rÜ
(
sb
, "Block bitmap for bg 0 marked "

451 
”r
 = -
EFSCORRUPTED
;

452 
out
;

454 
”r
 = 
	`ext4_š™_block_b™m­
(
sb
, 
bh
, 
block_group
, 
desc
);

455 
	`£t_b™m­_u±od©e
(
bh
);

456 
	`£t_bufãr_u±od©e
(
bh
);

457 
	`£t_bufãr_v”if›d
(
bh
);

458 
	`ext4_uÆock_group
(
sb
, 
block_group
);

459 
	`uÆock_bufãr
(
bh
);

460 ià(
”r
) {

461 
	`ext4_”rÜ
(
sb
, "Failedo init block bitmap for group "

462 "%u: %d", 
block_group
, 
”r
);

463 
out
;

465 
v”ify
;

467 
	`ext4_uÆock_group
(
sb
, 
block_group
);

468 ià(
	`bufãr_u±od©e
(
bh
)) {

473 
	`£t_b™m­_u±od©e
(
bh
);

474 
	`uÆock_bufãr
(
bh
);

475 
v”ify
;

480 
	`£t_bufãr_Ãw
(
bh
);

481 
	`Œaû_ext4_»ad_block_b™m­_lßd
(
sb
, 
block_group
);

482 
bh
->
b_’d_io
 = 
ext4_’d_b™m­_»ad
;

483 
	`g‘_bh
(
bh
);

484 
	`subm™_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

485  
bh
;

486 
v”ify
:

487 
”r
 = 
	`ext4_v®id©e_block_b™m­
(
sb
, 
desc
, 
block_group
, 
bh
);

488 ià(
”r
)

489 
out
;

490  
bh
;

491 
out
:

492 
	`put_bh
(
bh
);

493  
	`ERR_PTR
(
”r
);

494 
	}
}

497 
	$ext4_wa™_block_b™m­
(
su³r_block
 *
sb
, 
ext4_group_t
 
block_group
,

498 
bufãr_h—d
 *
bh
)

500 
ext4_group_desc
 *
desc
;

502 ià(!
	`bufãr_Ãw
(
bh
))

504 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
block_group
, 
NULL
);

505 ià(!
desc
)

506  -
EFSCORRUPTED
;

507 
	`wa™_Ú_bufãr
(
bh
);

508 ià(!
	`bufãr_u±od©e
(
bh
)) {

509 
	`ext4_”rÜ
(
sb
, "Cannot„ead block bitmap - "

511 
block_group
, (è
bh
->
b_blockÄ
);

512 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
sb
, 
block_group
,

513 
EXT4_GROUP_INFO_BBITMAP_CORRUPT
);

514  -
EIO
;

516 
	`ş—r_bufãr_Ãw
(
bh
);

518  
	`ext4_v®id©e_block_b™m­
(
sb
, 
desc
, 
block_group
, 
bh
);

519 
	}
}

521 
bufãr_h—d
 *

522 
	$ext4_»ad_block_b™m­
(
su³r_block
 *
sb
, 
ext4_group_t
 
block_group
)

524 
bufãr_h—d
 *
bh
;

525 
”r
;

527 
bh
 = 
	`ext4_»ad_block_b™m­_nowa™
(
sb
, 
block_group
);

528 ià(
	`IS_ERR
(
bh
))

529  
bh
;

530 
”r
 = 
	`ext4_wa™_block_b™m­
(
sb
, 
block_group
, 
bh
);

531 ià(
”r
) {

532 
	`put_bh
(
bh
);

533  
	`ERR_PTR
(
”r
);

535  
bh
;

536 
	}
}

547 
	$ext4_has_ä“_şu¡”s
(
ext4_sb_šfo
 *
sbi
,

548 
s64
 
nşu¡”s
, 
æags
)

550 
s64
 
ä“_şu¡”s
, 
dœty_şu¡”s
, 
rsv
, 
»sv_şu¡”s
;

551 
³rıu_couÁ”
 *
fcc
 = &
sbi
->
s_ä“şu¡”s_couÁ”
;

552 
³rıu_couÁ”
 *
dcc
 = &
sbi
->
s_dœtyşu¡”s_couÁ”
;

554 
ä“_şu¡”s
 = 
	`³rıu_couÁ”_»ad_pos™ive
(
fcc
);

555 
dœty_şu¡”s
 = 
	`³rıu_couÁ”_»ad_pos™ive
(
dcc
);

556 
»sv_şu¡”s
 = 
	`©omic64_»ad
(&
sbi
->
s_»sv_şu¡”s
);

562 
rsv
 = (
	`ext4_r_blocks_couÁ
(
sbi
->
s_es
è>> sbi->
s_şu¡”_b™s
) +

563 
»sv_şu¡”s
;

565 ià(
ä“_şu¡”s
 - (
nşu¡”s
 + 
rsv
 + 
dœty_şu¡”s
) <

566 
EXT4_FREECLUSTERS_WATERMARK
) {

567 
ä“_şu¡”s
 = 
	`³rıu_couÁ”_sum_pos™ive
(
fcc
);

568 
dœty_şu¡”s
 = 
	`³rıu_couÁ”_sum_pos™ive
(
dcc
);

573 ià(
ä“_şu¡”s
 >ğ(
rsv
 + 
nşu¡”s
 + 
dœty_şu¡”s
))

577 ià(
	`uid_eq
(
sbi
->
s_»suid
, 
	`cu¼’t_fsuid
()) ||

578 (!
	`gid_eq
(
sbi
->
s_»sgid
, 
GLOBAL_ROOT_GID
è&& 
	`š_group_p
(sbi->s_resgid)) ||

579 
	`ÿ·bË
(
CAP_SYS_RESOURCE
) ||

580 (
æags
 & 
EXT4_MB_USE_ROOT_BLOCKS
)) {

582 ià(
ä“_şu¡”s
 >ğ(
nşu¡”s
 + 
dœty_şu¡”s
 +

583 
»sv_şu¡”s
))

587 ià(
æags
 & 
EXT4_MB_USE_RESERVED
) {

588 ià(
ä“_şu¡”s
 >ğ(
nşu¡”s
 + 
dœty_şu¡”s
))

593 
	}
}

595 
	$ext4_şaim_ä“_şu¡”s
(
ext4_sb_šfo
 *
sbi
,

596 
s64
 
nşu¡”s
, 
æags
)

598 ià(
	`ext4_has_ä“_şu¡”s
(
sbi
, 
nşu¡”s
, 
æags
)) {

599 
	`³rıu_couÁ”_add
(&
sbi
->
s_dœtyşu¡”s_couÁ”
, 
nşu¡”s
);

602  -
ENOSPC
;

603 
	}
}

615 
	$ext4_should_»Œy_®loc
(
su³r_block
 *
sb
, *
»Œ›s
)

617 ià(!
	`ext4_has_ä“_şu¡”s
(
	`EXT4_SB
(
sb
), 1, 0) ||

618 (*
»Œ›s
)++ > 1 ||

619 !
	`EXT4_SB
(
sb
)->
s_jouº®
)

622 
	`smp_mb
();

623 ià(
	`EXT4_SB
(
sb
)->
s_mb_ä“_³ndšg
 == 0)

626 
	`jbd_debug
(1, "%s:„‘ryšg o³¿tiÚ‡á” ENOSPC\n", 
sb
->
s_id
);

627 
	`jbd2_jouº®_fÜû_comm™_Ã¡ed
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

629 
	}
}

643 
ext4_fsblk_t
 
	$ext4_Ãw_m‘a_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

644 
ext4_fsblk_t
 
gßl
, 
æags
,

645 *
couÁ
, *
”½
)

647 
ext4_®loÿtiÚ_»que¡
 
¬
;

648 
ext4_fsblk_t
 
»t
;

650 
	`mem£t
(&
¬
, 0, (ar));

652 
¬
.
šode
 = inode;

653 
¬
.
gßl
 = goal;

654 
¬
.
Ën
 = 
couÁ
 ? *count : 1;

655 
¬
.
æags
 = flags;

657 
»t
 = 
	`ext4_mb_Ãw_blocks
(
hªdË
, &
¬
, 
”½
);

658 ià(
couÁ
)

659 *
couÁ
 = 
¬
.
Ën
;

664 ià(!(*
”½
è&& (
æags
 & 
EXT4_MB_DELALLOC_RESERVED
)) {

665 
	`dquÙ_®loc_block_noç
(
šode
,

666 
	`EXT4_C2B
(
	`EXT4_SB
(
šode
->
i_sb
), 
¬
.
Ën
));

668  
»t
;

669 
	}
}

677 
ext4_fsblk_t
 
	$ext4_couÁ_ä“_şu¡”s
(
su³r_block
 *
sb
)

679 
ext4_fsblk_t
 
desc_couÁ
;

680 
ext4_group_desc
 *
gdp
;

681 
ext4_group_t
 
i
;

682 
ext4_group_t
 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

683 
ext4_group_šfo
 *
g½
;

684 #ifdeà
EXT4FS_DEBUG


685 
ext4_su³r_block
 *
es
;

686 
ext4_fsblk_t
 
b™m­_couÁ
;

687 
x
;

688 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

690 
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

691 
desc_couÁ
 = 0;

692 
b™m­_couÁ
 = 0;

693 
gdp
 = 
NULL
;

695 
i
 = 0; i < 
ngroups
; i++) {

696 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

697 ià(!
gdp
)

699 
g½
 = 
NULL
;

700 ià(
	`EXT4_SB
(
sb
)->
s_group_šfo
)

701 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
i
);

702 ià(!
g½
 || !
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(grp))

703 
desc_couÁ
 +ğ
	`ext4_ä“_group_şu¡”s
(
sb
, 
gdp
);

704 
	`b»l£
(
b™m­_bh
);

705 
b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
i
);

706 ià(
	`IS_ERR
(
b™m­_bh
)) {

707 
b™m­_bh
 = 
NULL
;

711 
x
 = 
	`ext4_couÁ_ä“
(
b™m­_bh
->
b_d©a
,

712 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) / 8);

713 
	`´štk
(
KERN_DEBUG
 "group %u: stored = %d, counted = %u\n",

714 
i
, 
	`ext4_ä“_group_şu¡”s
(
sb
, 
gdp
), 
x
);

715 
b™m­_couÁ
 +ğ
x
;

717 
	`b»l£
(
b™m­_bh
);

718 
	`´štk
(
KERN_DEBUG
 "ext4_count_free_clusters: stored = %llu"

720 
	`EXT4_NUM_B2C
(
	`EXT4_SB
(
sb
), 
	`ext4_ä“_blocks_couÁ
(
es
)),

721 
desc_couÁ
, 
b™m­_couÁ
);

722  
b™m­_couÁ
;

724 
desc_couÁ
 = 0;

725 
i
 = 0; i < 
ngroups
; i++) {

726 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

727 ià(!
gdp
)

729 
g½
 = 
NULL
;

730 ià(
	`EXT4_SB
(
sb
)->
s_group_šfo
)

731 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
i
);

732 ià(!
g½
 || !
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(grp))

733 
desc_couÁ
 +ğ
	`ext4_ä“_group_şu¡”s
(
sb
, 
gdp
);

736  
desc_couÁ
;

738 
	}
}

740 
šlše
 
	$‹¡_roÙ
(
ext4_group_t
 
a
, 
b
)

743 ià(
a
 < 
b
)

745 ià(
a
 =ğ
b
)

747 ià((
a
 % 
b
) != 0)

749 
a
 =‡ / 
b
;

751 
	}
}

761 
	$ext4_bg_has_su³r
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
)

763 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

765 ià(
group
 == 0)

767 ià(
	`ext4_has_ã©u»_¥¬£_su³r2
(
sb
)) {

768 ià(
group
 =ğ
	`Ë32_to_ıu
(
es
->
s_backup_bgs
[0]) ||

769 
group
 =ğ
	`Ë32_to_ıu
(
es
->
s_backup_bgs
[1]))

773 ià((
group
 <ğ1è|| !
	`ext4_has_ã©u»_¥¬£_su³r
(
sb
))

775 ià(!(
group
 & 1))

777 ià(
	`‹¡_roÙ
(
group
, 3) || (test_root(group, 5)) ||

778 
	`‹¡_roÙ
(
group
, 7))

782 
	}
}

784 
	$ext4_bg_num_gdb_m‘a
(
su³r_block
 *
sb
,

785 
ext4_group_t
 
group
)

787 
m‘agroup
 = 
group
 / 
	`EXT4_DESC_PER_BLOCK
(
sb
);

788 
ext4_group_t
 
fœ¡
 = 
m‘agroup
 * 
	`EXT4_DESC_PER_BLOCK
(
sb
);

789 
ext4_group_t
 
Ï¡
 = 
fœ¡
 + 
	`EXT4_DESC_PER_BLOCK
(
sb
) - 1;

791 ià(
group
 =ğ
fœ¡
 || grou°=ğfœ¡ + 1 || grou°=ğ
Ï¡
)

794 
	}
}

796 
	$ext4_bg_num_gdb_nom‘a
(
su³r_block
 *
sb
,

797 
ext4_group_t
 
group
)

799 ià(!
	`ext4_bg_has_su³r
(
sb
, 
group
))

802 ià(
	`ext4_has_ã©u»_m‘a_bg
(
sb
))

803  
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_fœ¡_m‘a_bg
);

805  
	`EXT4_SB
(
sb
)->
s_gdb_couÁ
;

806 
	}
}

817 
	$ext4_bg_num_gdb
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
)

819 
fœ¡_m‘a_bg
 =

820 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_fœ¡_m‘a_bg
);

821 
m‘agroup
 = 
group
 / 
	`EXT4_DESC_PER_BLOCK
(
sb
);

823 ià(!
	`ext4_has_ã©u»_m‘a_bg
(
sb
è|| 
m‘agroup
 < 
fœ¡_m‘a_bg
)

824  
	`ext4_bg_num_gdb_nom‘a
(
sb
, 
group
);

826  
	`ext4_bg_num_gdb_m‘a
(
sb
,
group
);

828 
	}
}

834 
	$ext4_num_ba£_m‘a_şu¡”s
(
su³r_block
 *
sb
,

835 
ext4_group_t
 
block_group
)

837 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

838 
num
;

841 
num
 = 
	`ext4_bg_has_su³r
(
sb
, 
block_group
);

843 ià(!
	`ext4_has_ã©u»_m‘a_bg
(
sb
) ||

844 
block_group
 < 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_m‘a_bg
) *

845 
sbi
->
s_desc_³r_block
) {

846 ià(
num
) {

847 
num
 +ğ
	`ext4_bg_num_gdb
(
sb
, 
block_group
);

848 
num
 +ğ
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_»£rved_gdt_blocks
);

851 
num
 +ğ
	`ext4_bg_num_gdb
(
sb
, 
block_group
);

853  
	`EXT4_NUM_B2C
(
sbi
, 
num
);

854 
	}
}

862 
ext4_fsblk_t
 
	$ext4_šode_to_gßl_block
(
šode
 *inode)

864 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

865 
ext4_group_t
 
block_group
;

866 
ext4_g½blk_t
 
cŞour
;

867 
æex_size
 = 
	`ext4_æex_bg_size
(
	`EXT4_SB
(
šode
->
i_sb
));

868 
ext4_fsblk_t
 
bg_¡¬t
;

869 
ext4_fsblk_t
 
Ï¡_block
;

871 
block_group
 = 
ei
->
i_block_group
;

872 ià(
æex_size
 >ğ
EXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
) {

881 
block_group
 &ğ~(
æex_size
-1);

882 ià(
	`S_ISREG
(
šode
->
i_mode
))

883 
block_group
++;

885 
bg_¡¬t
 = 
	`ext4_group_fœ¡_block_no
(
šode
->
i_sb
, 
block_group
);

886 
Ï¡_block
 = 
	`ext4_blocks_couÁ
(
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
) - 1;

892 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DELALLOC
))

893  
bg_¡¬t
;

895 ià(
bg_¡¬t
 + 
	`EXT4_BLOCKS_PER_GROUP
(
šode
->
i_sb
è<ğ
Ï¡_block
)

896 
cŞour
 = (
cu¼’t
->
pid
 % 16) *

897 (
	`EXT4_BLOCKS_PER_GROUP
(
šode
->
i_sb
) / 16);

899 
cŞour
 = (
cu¼’t
->
pid
 % 16è* ((
Ï¡_block
 - 
bg_¡¬t
) / 16);

900  
bg_¡¬t
 + 
cŞour
;

901 
	}
}

	@pxt4/bitmap.c

11 
	~<lšux/bufãr_h—d.h
>

12 
	~"ext4.h
"

14 
	$ext4_couÁ_ä“
(*
b™m­
, 
numch¬s
)

16  
numch¬s
 * 
BITS_PER_BYTE
 - 
	`memweight
(
b™m­
,‚umchars);

17 
	}
}

19 
	$ext4_šode_b™m­_csum_v”ify
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

20 
ext4_group_desc
 *
gdp
,

21 
bufãr_h—d
 *
bh
, 
sz
)

23 
__u32
 
hi
;

24 
__u32
 
´ovided
, 
ÿlcuÏ‹d
;

25 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

27 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

30 
´ovided
 = 
	`Ë16_to_ıu
(
gdp
->
bg_šode_b™m­_csum_lo
);

31 
ÿlcuÏ‹d
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

32 ià(
sbi
->
s_desc_size
 >ğ
EXT4_BG_INODE_BITMAP_CSUM_HI_END
) {

33 
hi
 = 
	`Ë16_to_ıu
(
gdp
->
bg_šode_b™m­_csum_hi
);

34 
´ovided
 |ğ(
hi
 << 16);

36 
ÿlcuÏ‹d
 &= 0xFFFF;

38  
´ovided
 =ğ
ÿlcuÏ‹d
;

39 
	}
}

41 
	$ext4_šode_b™m­_csum_£t
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

42 
ext4_group_desc
 *
gdp
,

43 
bufãr_h—d
 *
bh
, 
sz
)

45 
__u32
 
csum
;

46 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

48 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

51 
csum
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

52 
gdp
->
bg_šode_b™m­_csum_lo
 = 
	`ıu_to_Ë16
(
csum
 & 0xFFFF);

53 ià(
sbi
->
s_desc_size
 >ğ
EXT4_BG_INODE_BITMAP_CSUM_HI_END
)

54 
gdp
->
bg_šode_b™m­_csum_hi
 = 
	`ıu_to_Ë16
(
csum
 >> 16);

55 
	}
}

57 
	$ext4_block_b™m­_csum_v”ify
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

58 
ext4_group_desc
 *
gdp
,

59 
bufãr_h—d
 *
bh
)

61 
__u32
 
hi
;

62 
__u32
 
´ovided
, 
ÿlcuÏ‹d
;

63 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

64 
sz
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) / 8;

66 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

69 
´ovided
 = 
	`Ë16_to_ıu
(
gdp
->
bg_block_b™m­_csum_lo
);

70 
ÿlcuÏ‹d
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

71 ià(
sbi
->
s_desc_size
 >ğ
EXT4_BG_BLOCK_BITMAP_CSUM_HI_END
) {

72 
hi
 = 
	`Ë16_to_ıu
(
gdp
->
bg_block_b™m­_csum_hi
);

73 
´ovided
 |ğ(
hi
 << 16);

75 
ÿlcuÏ‹d
 &= 0xFFFF;

77 ià(
´ovided
 =ğ
ÿlcuÏ‹d
)

81 
	}
}

83 
	$ext4_block_b™m­_csum_£t
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

84 
ext4_group_desc
 *
gdp
,

85 
bufãr_h—d
 *
bh
)

87 
sz
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) / 8;

88 
__u32
 
csum
;

89 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

91 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

94 
csum
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

95 
gdp
->
bg_block_b™m­_csum_lo
 = 
	`ıu_to_Ë16
(
csum
 & 0xFFFF);

96 ià(
sbi
->
s_desc_size
 >ğ
EXT4_BG_BLOCK_BITMAP_CSUM_HI_END
)

97 
gdp
->
bg_block_b™m­_csum_hi
 = 
	`ıu_to_Ë16
(
csum
 >> 16);

98 
	}
}

	@pxt4/block_validity.c

12 
	~<lšux/time.h
>

13 
	~<lšux/fs.h
>

14 
	~<lšux/Çmei.h
>

15 
	~<lšux/quÙaİs.h
>

16 
	~<lšux/bufãr_h—d.h
>

17 
	~<lšux/sw­.h
>

18 
	~<lšux/·gem­.h
>

19 
	~<lšux/blkdev.h
>

20 
	~<lšux/¦ab.h
>

21 
	~"ext4.h
"

23 
	sext4_sy¡em_zÚe
 {

24 
rb_node
 
	mnode
;

25 
ext4_fsblk_t
 
	m¡¬t_blk
;

26 
	mcouÁ
;

29 
kmem_ÿche
 *
	gext4_sy¡em_zÚe_ÿch•
;

31 
__š™
 
	$ext4_š™_sy¡em_zÚe
()

33 
ext4_sy¡em_zÚe_ÿch•
 = 
	`KMEM_CACHE
(
ext4_sy¡em_zÚe
, 0);

34 ià(
ext4_sy¡em_zÚe_ÿch•
 =ğ
NULL
)

35  -
ENOMEM
;

37 
	}
}

39 
	$ext4_ex™_sy¡em_zÚe
()

41 
	`rcu_b¬r›r
();

42 
	`kmem_ÿche_de¡roy
(
ext4_sy¡em_zÚe_ÿch•
);

43 
	}
}

45 
šlše
 
	$ÿn_m”ge
(
ext4_sy¡em_zÚe
 *
’Œy1
,

46 
ext4_sy¡em_zÚe
 *
’Œy2
)

48 ià((
’Œy1
->
¡¬t_blk
 +ƒÁry1->
couÁ
è=ğ
’Œy2
->start_blk)

51 
	}
}

53 
	$»Ëa£_sy¡em_zÚe
(
ext4_sy¡em_blocks
 *
sy¡em_blks
)

55 
ext4_sy¡em_zÚe
 *
’Œy
, *
n
;

57 
	`rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
’Œy
, 
n
,

58 &
sy¡em_blks
->
roÙ
, 
node
)

59 
	`kmem_ÿche_ä“
(
ext4_sy¡em_zÚe_ÿch•
, 
’Œy
);

60 
	}
}

67 
	$add_sy¡em_zÚe
(
ext4_sy¡em_blocks
 *
sy¡em_blks
,

68 
ext4_fsblk_t
 
¡¬t_blk
,

69 
couÁ
)

71 
ext4_sy¡em_zÚe
 *
Ãw_’Œy
 = 
NULL
, *
’Œy
;

72 
rb_node
 **
n
 = &
sy¡em_blks
->
roÙ
.rb_node, *
node
;

73 
rb_node
 *
·»Á
 = 
NULL
, *
Ãw_node
 = NULL;

75 *
n
) {

76 
·»Á
 = *
n
;

77 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
ext4_sy¡em_zÚe
, 
node
);

78 ià(
¡¬t_blk
 < 
’Œy
->start_blk)

79 
n
 = &(*n)->
rb_Ëá
;

80 ià(
¡¬t_blk
 >ğ(
’Œy
->¡¬t_blk +ƒÁry->
couÁ
))

81 
n
 = &(*n)->
rb_right
;

83 ià(
¡¬t_blk
 + 
couÁ
 > (
’Œy
->start_blk +

84 
’Œy
->
couÁ
))

85 
’Œy
->
couÁ
 = (
¡¬t_blk
 + count -

86 
’Œy
->
¡¬t_blk
);

87 
Ãw_node
 = *
n
;

88 
Ãw_’Œy
 = 
	`rb_’Œy
(
Ãw_node
, 
ext4_sy¡em_zÚe
,

89 
node
);

94 ià(!
Ãw_’Œy
) {

95 
Ãw_’Œy
 = 
	`kmem_ÿche_®loc
(
ext4_sy¡em_zÚe_ÿch•
,

96 
GFP_KERNEL
);

97 ià(!
Ãw_’Œy
)

98  -
ENOMEM
;

99 
Ãw_’Œy
->
¡¬t_blk
 = start_blk;

100 
Ãw_’Œy
->
couÁ
 = count;

101 
Ãw_node
 = &
Ãw_’Œy
->
node
;

103 
	`rb_lšk_node
(
Ãw_node
, 
·»Á
, 
n
);

104 
	`rb_š£¹_cŞÜ
(
Ãw_node
, &
sy¡em_blks
->
roÙ
);

108 
node
 = 
	`rb_´ev
(
Ãw_node
);

109 ià(
node
) {

110 
’Œy
 = 
	`rb_’Œy
(
node
, 
ext4_sy¡em_zÚe
,‚ode);

111 ià(
	`ÿn_m”ge
(
’Œy
, 
Ãw_’Œy
)) {

112 
Ãw_’Œy
->
¡¬t_blk
 = 
’Œy
->start_blk;

113 
Ãw_’Œy
->
couÁ
 +ğ
’Œy
->count;

114 
	`rb_”a£
(
node
, &
sy¡em_blks
->
roÙ
);

115 
	`kmem_ÿche_ä“
(
ext4_sy¡em_zÚe_ÿch•
, 
’Œy
);

120 
node
 = 
	`rb_Ãxt
(
Ãw_node
);

121 ià(
node
) {

122 
’Œy
 = 
	`rb_’Œy
(
node
, 
ext4_sy¡em_zÚe
,‚ode);

123 ià(
	`ÿn_m”ge
(
Ãw_’Œy
, 
’Œy
)) {

124 
Ãw_’Œy
->
couÁ
 +ğ
’Œy
->count;

125 
	`rb_”a£
(
node
, &
sy¡em_blks
->
roÙ
);

126 
	`kmem_ÿche_ä“
(
ext4_sy¡em_zÚe_ÿch•
, 
’Œy
);

130 
	}
}

132 
	$debug_´št_Œ“
(
ext4_sb_šfo
 *
sbi
)

134 
rb_node
 *
node
;

135 
ext4_sy¡em_zÚe
 *
’Œy
;

136 
fœ¡
 = 1;

138 
	`´štk
(
KERN_INFO
 "System zones: ");

139 
node
 = 
	`rb_fœ¡
(&
sbi
->
sy¡em_blks
->
roÙ
);

140 
node
) {

141 
’Œy
 = 
	`rb_’Œy
(
node
, 
ext4_sy¡em_zÚe
,‚ode);

142 
	`´štk
(
KERN_CONT
 "%s%Îu-%Îu", 
fœ¡
 ? "" : ", ",

143 
’Œy
->
¡¬t_blk
,ƒÁry->¡¬t_blk +ƒÁry->
couÁ
 - 1);

144 
fœ¡
 = 0;

145 
node
 = 
	`rb_Ãxt
(node);

147 
	`´štk
(
KERN_CONT
 "\n");

148 
	}
}

155 
	$ext4_d©a_block_v®id_rcu
(
ext4_sb_šfo
 *
sbi
,

156 
ext4_sy¡em_blocks
 *
sy¡em_blks
,

157 
ext4_fsblk_t
 
¡¬t_blk
,

158 
couÁ
)

160 
ext4_sy¡em_zÚe
 *
’Œy
;

161 
rb_node
 *
n
;

163 ià((
¡¬t_blk
 <ğ
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_d©a_block
)) ||

164 (
¡¬t_blk
 + 
couÁ
 < start_blk) ||

165 (
¡¬t_blk
 + 
couÁ
 > 
	`ext4_blocks_couÁ
(
sbi
->
s_es
))) {

166 
sbi
->
s_es
->
s_Ï¡_”rÜ_block
 = 
	`ıu_to_Ë64
(
¡¬t_blk
);

170 ià(
sy¡em_blks
 =ğ
NULL
)

173 
n
 = 
sy¡em_blks
->
roÙ
.
rb_node
;

174 
n
) {

175 
’Œy
 = 
	`rb_’Œy
(
n
, 
ext4_sy¡em_zÚe
, 
node
);

176 ià(
¡¬t_blk
 + 
couÁ
 - 1 < 
’Œy
->start_blk)

177 
n
 =‚->
rb_Ëá
;

178 ià(
¡¬t_blk
 >ğ(
’Œy
->¡¬t_blk +ƒÁry->
couÁ
))

179 
n
 =‚->
rb_right
;

181 
sbi
->
s_es
->
s_Ï¡_”rÜ_block
 = 
	`ıu_to_Ë64
(
¡¬t_blk
);

186 
	}
}

188 
	$ext4_´Ùeù_»£rved_šode
(
su³r_block
 *
sb
,

189 
ext4_sy¡em_blocks
 *
sy¡em_blks
,

190 
u32
 
šo
)

192 
šode
 *inode;

193 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

194 
ext4_m­_blocks
 
m­
;

195 
u32
 
i
 = 0, 
num
;

196 
”r
 = 0, 
n
;

198 ià((
šo
 < 
EXT4_ROOT_INO
) ||

199 (
šo
 > 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_šodes_couÁ
)))

200  -
EINVAL
;

201 
šode
 = 
	`ext4_ig‘
(
sb
, 
šo
, 
EXT4_IGET_SPECIAL
);

202 ià(
	`IS_ERR
(
šode
))

203  
	`PTR_ERR
(
šode
);

204 
num
 = (
šode
->
i_size
 + 
sb
->
s_blocksize
 - 1è>> sb->
s_blocksize_b™s
;

205 
i
 < 
num
) {

206 
m­
.
m_lblk
 = 
i
;

207 
m­
.
m_Ën
 = 
num
 - 
i
;

208 
n
 = 
	`ext4_m­_blocks
(
NULL
, 
šode
, &
m­
, 0);

209 ià(
n
 < 0) {

210 
”r
 = 
n
;

213 ià(
n
 == 0) {

214 
i
++;

216 ià(!
	`ext4_d©a_block_v®id_rcu
(
sbi
, 
sy¡em_blks
,

217 
m­
.
m_pblk
, 
n
)) {

218 
	`ext4_”rÜ
(
sb
, "blocks %llu-%llu from inode %u "

219 "ov”Ï°sy¡em zÚe", 
m­
.
m_pblk
,

220 
m­
.
m_pblk
 + m­.
m_Ën
 - 1, 
šo
);

221 
”r
 = -
EFSCORRUPTED
;

224 
”r
 = 
	`add_sy¡em_zÚe
(
sy¡em_blks
, 
m­
.
m_pblk
, 
n
);

225 ià(
”r
 < 0)

227 
i
 +ğ
n
;

230 
	`ut
(
šode
);

231  
”r
;

232 
	}
}

234 
	$ext4_de¡roy_sy¡em_zÚe
(
rcu_h—d
 *
rcu
)

236 
ext4_sy¡em_blocks
 *
sy¡em_blks
;

238 
sy¡em_blks
 = 
	`cÚš”_of
(
rcu
, 
ext4_sy¡em_blocks
,„cu);

239 
	`»Ëa£_sy¡em_zÚe
(
sy¡em_blks
);

240 
	`kä“
(
sy¡em_blks
);

241 
	}
}

252 
	$ext4_£tup_sy¡em_zÚe
(
su³r_block
 *
sb
)

254 
ext4_group_t
 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

255 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

256 
ext4_sy¡em_blocks
 *
sy¡em_blks
;

257 
ext4_group_desc
 *
gdp
;

258 
ext4_group_t
 
i
;

259 
æex_size
 = 
	`ext4_æex_bg_size
(
sbi
);

260 
»t
;

262 ià(!
	`‹¡_İt
(
sb
, 
BLOCK_VALIDITY
)) {

263 ià(
sbi
->
sy¡em_blks
)

264 
	`ext4_»Ëa£_sy¡em_zÚe
(
sb
);

267 ià(
sbi
->
sy¡em_blks
)

270 
sy¡em_blks
 = 
	`kz®loc
((*sy¡em_blks), 
GFP_KERNEL
);

271 ià(!
sy¡em_blks
)

272  -
ENOMEM
;

274 
i
=0; i < 
ngroups
; i++) {

275 
	`cÚd_»sched
();

276 ià(
	`ext4_bg_has_su³r
(
sb
, 
i
) &&

277 ((
i
 < 5è|| ((˜% 
æex_size
) == 0)))

278 
	`add_sy¡em_zÚe
(
sy¡em_blks
,

279 
	`ext4_group_fœ¡_block_no
(
sb
, 
i
),

280 
	`ext4_bg_num_gdb
(
sb
, 
i
) + 1);

281 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

282 
»t
 = 
	`add_sy¡em_zÚe
(
sy¡em_blks
,

283 
	`ext4_block_b™m­
(
sb
, 
gdp
), 1);

284 ià(
»t
)

285 
”r
;

286 
»t
 = 
	`add_sy¡em_zÚe
(
sy¡em_blks
,

287 
	`ext4_šode_b™m­
(
sb
, 
gdp
), 1);

288 ià(
»t
)

289 
”r
;

290 
»t
 = 
	`add_sy¡em_zÚe
(
sy¡em_blks
,

291 
	`ext4_šode_bË
(
sb
, 
gdp
),

292 
sbi
->
s_™b_³r_group
);

293 ià(
»t
)

294 
”r
;

296 ià(
	`ext4_has_ã©u»_jouº®
(
sb
è&& 
sbi
->
s_es
->
s_jouº®_šum
) {

297 
»t
 = 
	`ext4_´Ùeù_»£rved_šode
(
sb
, 
sy¡em_blks
,

298 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_jouº®_šum
));

299 ià(
»t
)

300 
”r
;

308 
	`rcu_assign_poš‹r
(
sbi
->
sy¡em_blks
, system_blks);

310 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

311 
	`debug_´št_Œ“
(
sbi
);

313 
”r
:

314 
	`»Ëa£_sy¡em_zÚe
(
sy¡em_blks
);

315 
	`kä“
(
sy¡em_blks
);

316  
»t
;

317 
	}
}

329 
	$ext4_»Ëa£_sy¡em_zÚe
(
su³r_block
 *
sb
)

331 
ext4_sy¡em_blocks
 *
sy¡em_blks
;

333 
sy¡em_blks
 = 
	`rcu_d”eã»nû_´Ùeùed
(
	`EXT4_SB
(
sb
)->system_blks,

334 
	`lockd•_is_h–d
(&
sb
->
s_umouÁ
));

335 
	`rcu_assign_poš‹r
(
	`EXT4_SB
(
sb
)->
sy¡em_blks
, 
NULL
);

337 ià(
sy¡em_blks
)

338 
	`ÿÎ_rcu
(&
sy¡em_blks
->
rcu
, 
ext4_de¡roy_sy¡em_zÚe
);

339 
	}
}

341 
	$ext4_d©a_block_v®id
(
ext4_sb_šfo
 *
sbi
, 
ext4_fsblk_t
 
¡¬t_blk
,

342 
couÁ
)

344 
ext4_sy¡em_blocks
 *
sy¡em_blks
;

345 
»t
;

352 
	`rcu_»ad_lock
();

353 
sy¡em_blks
 = 
	`rcu_d”eã»nû
(
sbi
->system_blks);

354 
»t
 = 
	`ext4_d©a_block_v®id_rcu
(
sbi
, 
sy¡em_blks
, 
¡¬t_blk
,

355 
couÁ
);

356 
	`rcu_»ad_uÆock
();

357  
»t
;

358 
	}
}

360 
	$ext4_check_block»f
(cÚ¡ *
funùiÚ
, 
lše
,

361 
šode
 *šode, 
__Ë32
 *
p
, 
max
)

363 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
;

364 
__Ë32
 *
b»f
 = 
p
;

365 
blk
;

367 ià(
	`ext4_has_ã©u»_jouº®
(
šode
->
i_sb
) &&

368 (
šode
->
i_šo
 ==

369 
	`Ë32_to_ıu
(
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
->
s_jouº®_šum
)))

372 
b»f
 < 
p
+
max
) {

373 
blk
 = 
	`Ë32_to_ıu
(*
b»f
++);

374 ià(
blk
 &&

375 
	`uÆik–y
(!
	`ext4_d©a_block_v®id
(
	`EXT4_SB
(
šode
->
i_sb
),

376 
blk
, 1))) {

377 
es
->
s_Ï¡_”rÜ_block
 = 
	`ıu_to_Ë64
(
blk
);

378 
	`ext4_”rÜ_šode
(
šode
, 
funùiÚ
, 
lše
, 
blk
,

380  -
EFSCORRUPTED
;

384 
	}
}

	@pxt4/dir.c

25 
	~<lšux/fs.h
>

26 
	~<lšux/bufãr_h—d.h
>

27 
	~<lšux/¦ab.h
>

28 
	~<lšux/iv”siÚ.h
>

29 
	~<lšux/unicode.h
>

30 
	~"ext4.h
"

31 
	~"x©Œ.h
"

33 
ext4_dx_»addœ
(
fe
 *, 
dœ_cÚ‹xt
 *);

45 
	$is_dx_dœ
(
šode
 *inode)

47 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

49 ià(
	`ext4_has_ã©u»_dœ_šdex
(
šode
->
i_sb
) &&

50 ((
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_INDEX
)) ||

51 ((
šode
->
i_size
 >> 
sb
->
s_blocksize_b™s
) == 1) ||

52 
	`ext4_has_šlše_d©a
(
šode
)))

56 
	}
}

66 
	$__ext4_check_dœ_’Œy
(cÚ¡ *
funùiÚ
, 
lše
,

67 
šode
 *
dœ
, 
fe
 *
fp
,

68 
ext4_dœ_’Œy_2
 *
de
,

69 
bufãr_h—d
 *
bh
, *
buf
, 
size
,

70 
off£t
)

72 cÚ¡ *
”rÜ_msg
 = 
NULL
;

73 cÚ¡ 
¾’
 = 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
,

74 
dœ
->
i_sb
->
s_blocksize
);

76 ià(
	`uÆik–y
(
¾’
 < 
	`EXT4_DIR_REC_LEN
(1)))

77 
”rÜ_msg
 = "rec_len is smallerhan minimal";

78 ià(
	`uÆik–y
(
¾’
 % 4 != 0))

79 
”rÜ_msg
 = "rec_len % 4 != 0";

80 ià(
	`uÆik–y
(
¾’
 < 
	`EXT4_DIR_REC_LEN
(
de
->
Çme_Ën
)))

81 
”rÜ_msg
 = "rec_len isoo small for‚ame_len";

82 ià(
	`uÆik–y
(((*è
de
 - 
buf
è+ 
¾’
 > 
size
))

83 
”rÜ_msg
 = "directoryƒntry overrun";

84 ià(
	`uÆik–y
(
	`Ë32_to_ıu
(
de
->
šode
) >

85 
	`Ë32_to_ıu
(
	`EXT4_SB
(
dœ
->
i_sb
)->
s_es
->
s_šodes_couÁ
)))

86 
”rÜ_msg
 = "inode out of bounds";

90 ià(
fp
)

91 
	`ext4_”rÜ_fe
(
fp
, 
funùiÚ
, 
lše
, 
bh
->
b_blockÄ
,

94 
”rÜ_msg
, 
off£t
, 
	`Ë32_to_ıu
(
de
->
šode
),

95 
¾’
, 
de
->
Çme_Ën
, 
size
);

97 
	`ext4_”rÜ_šode
(
dœ
, 
funùiÚ
, 
lše
, 
bh
->
b_blockÄ
,

100 
”rÜ_msg
, 
off£t
, 
	`Ë32_to_ıu
(
de
->
šode
),

101 
¾’
, 
de
->
Çme_Ën
, 
size
);

104 
	}
}

106 
	$ext4_»addœ
(
fe
 *fe, 
dœ_cÚ‹xt
 *
ùx
)

108 
off£t
;

109 
i
;

110 
ext4_dœ_’Œy_2
 *
de
;

111 
”r
;

112 
šode
 *šodğ
	`fe_šode
(
fe
);

113 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

114 
bufãr_h—d
 *
bh
 = 
NULL
;

115 
fsüy±_¡r
 
f¡r
 = 
	`FSTR_INIT
(
NULL
, 0);

117 ià(
	`IS_ENCRYPTED
(
šode
)) {

118 
”r
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
šode
);

119 ià(
”r
 &&ƒ¼ !ğ-
ENOKEY
)

120  
”r
;

123 ià(
	`is_dx_dœ
(
šode
)) {

124 
”r
 = 
	`ext4_dx_»addœ
(
fe
, 
ùx
);

125 ià(
”r
 !ğ
ERR_BAD_DX_DIR
) {

126  
”r
;

132 
	`ext4_ş—r_šode_æag
(
	`fe_šode
(
fe
),

133 
EXT4_INODE_INDEX
);

136 ià(
	`ext4_has_šlše_d©a
(
šode
)) {

137 
has_šlše_d©a
 = 1;

138 
”r
 = 
	`ext4_»ad_šlše_dœ
(
fe
, 
ùx
,

139 &
has_šlše_d©a
);

140 ià(
has_šlše_d©a
)

141  
”r
;

144 ià(
	`IS_ENCRYPTED
(
šode
)) {

145 
”r
 = 
	`fsüy±_âame_®loc_bufãr
(
šode
, 
EXT4_NAME_LEN
, &
f¡r
);

146 ià(
”r
 < 0)

147  
”r
;

150 
ùx
->
pos
 < 
šode
->
i_size
) {

151 
ext4_m­_blocks
 
m­
;

153 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

154 
”r
 = -
ERESTARTSYS
;

155 
”rout
;

157 
	`cÚd_»sched
();

158 
off£t
 = 
ùx
->
pos
 & (
sb
->
s_blocksize
 - 1);

159 
m­
.
m_lblk
 = 
ùx
->
pos
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

160 
m­
.
m_Ën
 = 1;

161 
”r
 = 
	`ext4_m­_blocks
(
NULL
, 
šode
, &
m­
, 0);

162 ià(
”r
 == 0) {

165 ià(
m­
.
m_Ën
 == 0)

166 
m­
.
m_Ën
 = 1;

167 
ùx
->
pos
 +ğ
m­
.
m_Ën
 * 
sb
->
s_blocksize
;

170 ià(
”r
 > 0) {

171 
pgoff_t
 
šdex
 = 
m­
.
m_pblk
 >>

172 (
PAGE_SHIFT
 - 
šode
->
i_blkb™s
);

173 ià(!
	`¿_has_šdex
(&
fe
->
f_¿
, 
šdex
))

174 
	`·ge_ÿche_sync_»adah—d
(

175 
sb
->
s_bdev
->
bd_šode
->
i_m­pšg
,

176 &
fe
->
f_¿
, file,

177 
šdex
, 1);

178 
fe
->
f_¿
.
´ev_pos
 = (
loff_t
)
šdex
 << 
PAGE_SHIFT
;

179 
bh
 = 
	`ext4_b»ad
(
NULL
, 
šode
, 
m­
.
m_lblk
, 0);

180 ià(
	`IS_ERR
(
bh
)) {

181 
”r
 = 
	`PTR_ERR
(
bh
);

182 
bh
 = 
NULL
;

183 
”rout
;

187 ià(!
bh
) {

189 ià(
ùx
->
pos
 > 
šode
->
i_blocks
 << 9)

191 
ùx
->
pos
 +ğ
sb
->
s_blocksize
 - 
off£t
;

196 ià(!
	`bufãr_v”if›d
(
bh
) &&

197 !
	`ext4_dœblock_csum_v”ify
(
šode
, 
bh
)) {

198 
	`EXT4_ERROR_FILE
(
fe
, 0, "directory fails checksum "

200 ()
ùx
->
pos
);

201 
ùx
->
pos
 +ğ
sb
->
s_blocksize
 - 
off£t
;

202 
	`b»l£
(
bh
);

203 
bh
 = 
NULL
;

206 
	`£t_bufãr_v”if›d
(
bh
);

212 ià(!
	`šode_eq_iv”siÚ
(
šode
, 
fe
->
f_v”siÚ
)) {

213 
i
 = 0; i < 
sb
->
s_blocksize
 && i < 
off£t
; ) {

214 
de
 = (
ext4_dœ_’Œy_2
 *)

215 (
bh
->
b_d©a
 + 
i
);

222 ià(
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
,

223 
sb
->
s_blocksize
è< 
	`EXT4_DIR_REC_LEN
(1))

225 
i
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
,

226 
sb
->
s_blocksize
);

228 
off£t
 = 
i
;

229 
ùx
->
pos
 = (ùx->po & ~(
sb
->
s_blocksize
 - 1))

230 | 
off£t
;

231 
fe
->
f_v”siÚ
 = 
	`šode_qu”y_iv”siÚ
(
šode
);

234 
ùx
->
pos
 < 
šode
->
i_size


235 && 
off£t
 < 
sb
->
s_blocksize
) {

236 
de
 = (
ext4_dœ_’Œy_2
 *è(
bh
->
b_d©a
 + 
off£t
);

237 ià(
	`ext4_check_dœ_’Œy
(
šode
, 
fe
, 
de
, 
bh
,

238 
bh
->
b_d©a
, bh->
b_size
,

239 
off£t
)) {

243 
ùx
->
pos
 = (ctx->pos |

244 (
sb
->
s_blocksize
 - 1)) + 1;

247 
off£t
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
,

248 
sb
->
s_blocksize
);

249 ià(
	`Ë32_to_ıu
(
de
->
šode
)) {

250 ià(!
	`IS_ENCRYPTED
(
šode
)) {

251 ià(!
	`dœ_em™
(
ùx
, 
de
->
Çme
,

252 
de
->
Çme_Ën
,

253 
	`Ë32_to_ıu
(
de
->
šode
),

254 
	`g‘_dty³
(
sb
, 
de
->
fe_ty³
)))

255 
dÚe
;

257 
§ve_Ën
 = 
f¡r
.
Ën
;

258 
fsüy±_¡r
 
de_Çme
 =

259 
	`FSTR_INIT
(
de
->
Çme
,

260 
de
->
Çme_Ën
);

263 
”r
 = 
	`fsüy±_âame_disk_to_u¤
(
šode
,

264 0, 0, &
de_Çme
, &
f¡r
);

265 
de_Çme
 = 
f¡r
;

266 
f¡r
.
Ën
 = 
§ve_Ën
;

267 ià(
”r
)

268 
”rout
;

269 ià(!
	`dœ_em™
(
ùx
,

270 
de_Çme
.
Çme
, de_Çme.
Ën
,

271 
	`Ë32_to_ıu
(
de
->
šode
),

272 
	`g‘_dty³
(
sb
, 
de
->
fe_ty³
)))

273 
dÚe
;

276 
ùx
->
pos
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
,

277 
sb
->
s_blocksize
);

279 ià((
ùx
->
pos
 < 
šode
->
i_size
è&& !
	`dœ_»Ïx_sh¬ed
(inode))

280 
dÚe
;

281 
	`b»l£
(
bh
);

282 
bh
 = 
NULL
;

283 
off£t
 = 0;

285 
dÚe
:

286 
”r
 = 0;

287 
”rout
:

288 
	`fsüy±_âame_ä“_bufãr
(&
f¡r
);

289 
	`b»l£
(
bh
);

290  
”r
;

291 
	}
}

293 
šlše
 
	$is_32b™_­i
()

295 #ifdeà
CONFIG_COMPAT


296  
	`š_com·t_sysÿÎ
();

298  (
BITS_PER_LONG
 == 32);

300 
	}
}

311 
šlše
 
loff_t
 
	$hash2pos
(
fe
 *
fp
, 
__u32
 
majÜ
, __u32 
mšÜ
)

313 ià((
fp
->
f_mode
 & 
FMODE_32BITHASH
) ||

314 (!(
fp
->
f_mode
 & 
FMODE_64BITHASH
è&& 
	`is_32b™_­i
()))

315  
majÜ
 >> 1;

317  ((
__u64
)(
majÜ
 >> 1è<< 32è| (__u64)
mšÜ
;

318 
	}
}

320 
šlše
 
__u32
 
	$pos2maj_hash
(
fe
 *
fp
, 
loff_t
 
pos
)

322 ià((
fp
->
f_mode
 & 
FMODE_32BITHASH
) ||

323 (!(
fp
->
f_mode
 & 
FMODE_64BITHASH
è&& 
	`is_32b™_­i
()))

324  (
pos
 << 1) & 0xffffffff;

326  ((
pos
 >> 32) << 1) & 0xffffffff;

327 
	}
}

329 
šlše
 
__u32
 
	$pos2mš_hash
(
fe
 *
fp
, 
loff_t
 
pos
)

331 ià((
fp
->
f_mode
 & 
FMODE_32BITHASH
) ||

332 (!(
fp
->
f_mode
 & 
FMODE_64BITHASH
è&& 
	`is_32b™_­i
()))

335  
pos
 & 0xffffffff;

336 
	}
}

341 
šlše
 
loff_t
 
	$ext4_g‘_hŒ“_eof
(
fe
 *
fp
)

343 ià((
fp
->
f_mode
 & 
FMODE_32BITHASH
) ||

344 (!(
fp
->
f_mode
 & 
FMODE_64BITHASH
è&& 
	`is_32b™_­i
()))

345  
EXT4_HTREE_EOF_32BIT
;

347  
EXT4_HTREE_EOF_64BIT
;

348 
	}
}

362 
loff_t
 
	$ext4_dœ_Î£ek
(
fe
 *fe, 
loff_t
 
off£t
, 
wh’û
)

364 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

365 
dx_dœ
 = 
	`is_dx_dœ
(
šode
);

366 
loff_t
 
»t
, 
hŒ“_max
 = 
	`ext4_g‘_hŒ“_eof
(
fe
);

368 ià(
	`lik–y
(
dx_dœ
))

369 
»t
 = 
	`g’”ic_fe_Î£ek_size
(
fe
, 
off£t
, 
wh’û
,

370 
hŒ“_max
, htree_max);

372 
»t
 = 
	`ext4_Î£ek
(
fe
, 
off£t
, 
wh’û
);

373 
fe
->
f_v”siÚ
 = 
	`šode_³ek_iv”siÚ
(
šode
) - 1;

374  
»t
;

375 
	}
}

381 
	sâame
 {

382 
__u32
 
	mhash
;

383 
__u32
 
	mmšÜ_hash
;

384 
rb_node
 
	mrb_hash
;

385 
âame
 *
	mÃxt
;

386 
__u32
 
	mšode
;

387 
__u8
 
	mÇme_Ën
;

388 
__u8
 
	mfe_ty³
;

389 
	mÇme
[0];

396 
	$ä“_rb_Œ“_âame
(
rb_roÙ
 *
roÙ
)

398 
âame
 *âame, *
Ãxt
;

400 
	`rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
âame
, 
Ãxt
, 
roÙ
, 
rb_hash
)

401 
âame
) {

402 
âame
 *
Şd
 = fname;

403 
âame
 = fÇme->
Ãxt
;

404 
	`kä“
(
Şd
);

407 *
roÙ
 = 
RB_ROOT
;

408 
	}
}

411 
dœ_´iv©e_šfo
 *
	$ext4_hŒ“_ü—‹_dœ_šfo
(
fe
 *
fp
,

412 
loff_t
 
pos
)

414 
dœ_´iv©e_šfo
 *
p
;

416 
p
 = 
	`kz®loc
((*p), 
GFP_KERNEL
);

417 ià(!
p
)

418  
NULL
;

419 
p
->
cu¼_hash
 = 
	`pos2maj_hash
(
fp
, 
pos
);

420 
p
->
cu¼_mšÜ_hash
 = 
	`pos2mš_hash
(
fp
, 
pos
);

421  
p
;

422 
	}
}

424 
	$ext4_hŒ“_ä“_dœ_šfo
(
dœ_´iv©e_šfo
 *
p
)

426 
	`ä“_rb_Œ“_âame
(&
p
->
roÙ
);

427 
	`kä“
(
p
);

428 
	}
}

437 
	$ext4_hŒ“_¡Üe_dœ’t
(
fe
 *
dœ_fe
, 
__u32
 
hash
,

438 
__u32
 
mšÜ_hash
,

439 
ext4_dœ_’Œy_2
 *
dœ’t
,

440 
fsüy±_¡r
 *
’t_Çme
)

442 
rb_node
 **
p
, *
·»Á
 = 
NULL
;

443 
âame
 *âame, *
Ãw_â
;

444 
dœ_´iv©e_šfo
 *
šfo
;

445 
Ën
;

447 
šfo
 = 
dœ_fe
->
´iv©e_d©a
;

448 
p
 = &
šfo
->
roÙ
.
rb_node
;

451 
Ën
 = (
âame
è+ 
’t_Çme
->len + 1;

452 
Ãw_â
 = 
	`kz®loc
(
Ën
, 
GFP_KERNEL
);

453 ià(!
Ãw_â
)

454  -
ENOMEM
;

455 
Ãw_â
->
hash
 = hash;

456 
Ãw_â
->
mšÜ_hash
 = minor_hash;

457 
Ãw_â
->
šode
 = 
	`Ë32_to_ıu
(
dœ’t
->inode);

458 
Ãw_â
->
Çme_Ën
 = 
’t_Çme
->
Ën
;

459 
Ãw_â
->
fe_ty³
 = 
dœ’t
->file_type;

460 
	`memıy
(
Ãw_â
->
Çme
, 
’t_Çme
->Çme,ƒÁ_Çme->
Ën
);

461 
Ãw_â
->
Çme
[
’t_Çme
->
Ën
] = 0;

463 *
p
) {

464 
·»Á
 = *
p
;

465 
âame
 = 
	`rb_’Œy
(
·»Á
, âame, 
rb_hash
);

471 ià((
Ãw_â
->
hash
 =ğ
âame
->hash) &&

472 (
Ãw_â
->
mšÜ_hash
 =ğ
âame
->minor_hash)) {

473 
Ãw_â
->
Ãxt
 = 
âame
->next;

474 
âame
->
Ãxt
 = 
Ãw_â
;

478 ià(
Ãw_â
->
hash
 < 
âame
->hash)

479 
p
 = &(*p)->
rb_Ëá
;

480 ià(
Ãw_â
->
hash
 > 
âame
->hash)

481 
p
 = &(*p)->
rb_right
;

482 ià(
Ãw_â
->
mšÜ_hash
 < 
âame
->minor_hash)

483 
p
 = &(*p)->
rb_Ëá
;

485 
p
 = &(*p)->
rb_right
;

488 
	`rb_lšk_node
(&
Ãw_â
->
rb_hash
, 
·»Á
, 
p
);

489 
	`rb_š£¹_cŞÜ
(&
Ãw_â
->
rb_hash
, &
šfo
->
roÙ
);

491 
	}
}

500 
	$ÿÎ_fldœ
(
fe
 *fe, 
dœ_cÚ‹xt
 *
ùx
,

501 
âame
 *fname)

503 
dœ_´iv©e_šfo
 *
šfo
 = 
fe
->
´iv©e_d©a
;

504 
šode
 *šodğ
	`fe_šode
(
fe
);

505 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

507 ià(!
âame
) {

508 
	`ext4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu: comm %s: "

509 "ÿÎed w™h‚uÎ fÇme?!?", 
__func__
, 
__LINE__
,

510 
šode
->
i_šo
, 
cu¼’t
->
comm
);

513 
ùx
->
pos
 = 
	`hash2pos
(
fe
, 
âame
->
hash
, fÇme->
mšÜ_hash
);

514 
âame
) {

515 ià(!
	`dœ_em™
(
ùx
, 
âame
->
Çme
,

516 
âame
->
Çme_Ën
,

517 
âame
->
šode
,

518 
	`g‘_dty³
(
sb
, 
âame
->
fe_ty³
))) {

519 
šfo
->
exŒa_âame
 = 
âame
;

522 
âame
 = fÇme->
Ãxt
;

525 
	}
}

527 
	$ext4_dx_»addœ
(
fe
 *fe, 
dœ_cÚ‹xt
 *
ùx
)

529 
dœ_´iv©e_šfo
 *
šfo
 = 
fe
->
´iv©e_d©a
;

530 
šode
 *šodğ
	`fe_šode
(
fe
);

531 
âame
 *fname;

532 
»t
;

534 ià(!
šfo
) {

535 
šfo
 = 
	`ext4_hŒ“_ü—‹_dœ_šfo
(
fe
, 
ùx
->
pos
);

536 ià(!
šfo
)

537  -
ENOMEM
;

538 
fe
->
´iv©e_d©a
 = 
šfo
;

541 ià(
ùx
->
pos
 =ğ
	`ext4_g‘_hŒ“_eof
(
fe
))

545 ià(
šfo
->
Ï¡_pos
 !ğ
ùx
->
pos
) {

546 
	`ä“_rb_Œ“_âame
(&
šfo
->
roÙ
);

547 
šfo
->
cu¼_node
 = 
NULL
;

548 
šfo
->
exŒa_âame
 = 
NULL
;

549 
šfo
->
cu¼_hash
 = 
	`pos2maj_hash
(
fe
, 
ùx
->
pos
);

550 
šfo
->
cu¼_mšÜ_hash
 = 
	`pos2mš_hash
(
fe
, 
ùx
->
pos
);

557 ià(
šfo
->
exŒa_âame
) {

558 ià(
	`ÿÎ_fldœ
(
fe
, 
ùx
, 
šfo
->
exŒa_âame
))

559 
fšished
;

560 
šfo
->
exŒa_âame
 = 
NULL
;

561 
Ãxt_node
;

562 } ià(!
šfo
->
cu¼_node
)

563 
šfo
->
cu¼_node
 = 
	`rb_fœ¡
(&šfo->
roÙ
);

571 ià((!
šfo
->
cu¼_node
) ||

572 !
	`šode_eq_iv”siÚ
(
šode
, 
fe
->
f_v”siÚ
)) {

573 
šfo
->
cu¼_node
 = 
NULL
;

574 
	`ä“_rb_Œ“_âame
(&
šfo
->
roÙ
);

575 
fe
->
f_v”siÚ
 = 
	`šode_qu”y_iv”siÚ
(
šode
);

576 
»t
 = 
	`ext4_hŒ“_fl_Œ“
(
fe
, 
šfo
->
cu¼_hash
,

577 
šfo
->
cu¼_mšÜ_hash
,

578 &
šfo
->
Ãxt_hash
);

579 ià(
»t
 < 0)

580  
»t
;

581 ià(
»t
 == 0) {

582 
ùx
->
pos
 = 
	`ext4_g‘_hŒ“_eof
(
fe
);

585 
šfo
->
cu¼_node
 = 
	`rb_fœ¡
(&šfo->
roÙ
);

588 
âame
 = 
	`rb_’Œy
(
šfo
->
cu¼_node
, âame, 
rb_hash
);

589 
šfo
->
cu¼_hash
 = 
âame
->
hash
;

590 
šfo
->
cu¼_mšÜ_hash
 = 
âame
->
mšÜ_hash
;

591 ià(
	`ÿÎ_fldœ
(
fe
, 
ùx
, 
âame
))

593 
Ãxt_node
:

594 
šfo
->
cu¼_node
 = 
	`rb_Ãxt
(info->curr_node);

595 ià(
šfo
->
cu¼_node
) {

596 
âame
 = 
	`rb_’Œy
(
šfo
->
cu¼_node
, fname,

597 
rb_hash
);

598 
šfo
->
cu¼_hash
 = 
âame
->
hash
;

599 
šfo
->
cu¼_mšÜ_hash
 = 
âame
->
mšÜ_hash
;

601 ià(
šfo
->
Ãxt_hash
 == ~0) {

602 
ùx
->
pos
 = 
	`ext4_g‘_hŒ“_eof
(
fe
);

605 
šfo
->
cu¼_hash
 = info->
Ãxt_hash
;

606 
šfo
->
cu¼_mšÜ_hash
 = 0;

609 
fšished
:

610 
šfo
->
Ï¡_pos
 = 
ùx
->
pos
;

612 
	}
}

614 
	$ext4_dœ_İ’
(
šode
 * inode, 
fe
 * 
fp
)

616 ià(
	`IS_ENCRYPTED
(
šode
))

617  
	`fsüy±_g‘_’üy±iÚ_šfo
(
šode
è? -
EACCES
 : 0;

619 
	}
}

621 
	$ext4_»Ëa£_dœ
(
šode
 *šode, 
fe
 *
fp
)

623 ià(
fp
->
´iv©e_d©a
)

624 
	`ext4_hŒ“_ä“_dœ_šfo
(
fp
->
´iv©e_d©a
);

627 
	}
}

629 
	$ext4_check_®l_de
(
šode
 *
dœ
, 
bufãr_h—d
 *
bh
, *
buf
,

630 
buf_size
)

632 
ext4_dœ_’Œy_2
 *
de
;

633 
¾’
;

634 
off£t
 = 0;

635 *
tİ
;

637 
de
 = (
ext4_dœ_’Œy_2
 *)
buf
;

638 
tİ
 = 
buf
 + 
buf_size
;

639 (*è
de
 < 
tİ
) {

640 ià(
	`ext4_check_dœ_’Œy
(
dœ
, 
NULL
, 
de
, 
bh
,

641 
buf
, 
buf_size
, 
off£t
))

642  -
EFSCORRUPTED
;

643 
¾’
 = 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
buf_size
);

644 
de
 = (
ext4_dœ_’Œy_2
 *)((*)d+ 
¾’
);

645 
off£t
 +ğ
¾’
;

647 ià((*è
de
 > 
tİ
)

648  -
EFSCORRUPTED
;

651 
	}
}

653 cÚ¡ 
fe_İ”©iÚs
 
	gext4_dœ_İ”©iÚs
 = {

654 .
Î£ek
 = 
ext4_dœ_Î£ek
,

655 .
	g»ad
 = 
g’”ic_»ad_dœ
,

656 .
	g™”©e_sh¬ed
 = 
ext4_»addœ
,

657 .
	guÆocked_ioùl
 = 
ext4_ioùl
,

658 #ifdeà
CONFIG_COMPAT


659 .
	gcom·t_ioùl
 = 
ext4_com·t_ioùl
,

661 .
	gfsync
 = 
ext4_sync_fe
,

662 .
	gİ’
 = 
ext4_dœ_İ’
,

663 .
	g»Ëa£
 = 
ext4_»Ëa£_dœ
,

666 #ifdeà
CONFIG_UNICODE


667 
	$ext4_d_com·»
(cÚ¡ 
d’Œy
 *d’Œy, 
Ën
,

668 cÚ¡ *
¡r
, cÚ¡ 
q¡r
 *
Çme
)

670 
q¡r
 q¡¸ğ{.
Çme
 = 
¡r
, .
Ën
 =†en };

671 
šode
 *šodğ
d’Œy
->
d_·»Á
->
d_šode
;

673 ià(!
	`IS_CASEFOLDED
(
šode
è|| !
	`EXT4_SB
(šode->
i_sb
)->
s_’codšg
) {

674 ià(
Ën
 !ğ
Çme
->len)

676  
	`memcmp
(
¡r
, 
Çme
->Çme, 
Ën
);

679  
	`ext4_ci_com·»
(
šode
, 
Çme
, &
q¡r
, 
çl£
);

680 
	}
}

682 
	$ext4_d_hash
(cÚ¡ 
d’Œy
 *d’Œy, 
q¡r
 *
¡r
)

684 cÚ¡ 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
d’Œy
->
d_sb
);

685 cÚ¡ 
unicode_m­
 *
um
 = 
sbi
->
s_’codšg
;

686 *
nÜm
;

687 
Ën
, 
»t
 = 0;

689 ià(!
	`IS_CASEFOLDED
(
d’Œy
->
d_šode
è|| !
um
)

692 
nÜm
 = 
	`km®loc
(
PATH_MAX
, 
GFP_ATOMIC
);

693 ià(!
nÜm
)

694  -
ENOMEM
;

696 
Ën
 = 
	`utf8_ÿ£fŞd
(
um
, 
¡r
, 
nÜm
, 
PATH_MAX
);

697 ià(
Ën
 < 0) {

698 ià(
	`ext4_has_¡riù_mode
(
sbi
))

699 
»t
 = -
EINVAL
;

700 
out
;

702 
¡r
->
hash
 = 
	`fuÎ_Çme_hash
(
d’Œy
, 
nÜm
, 
Ën
);

703 
out
:

704 
	`kä“
(
nÜm
);

705  
»t
;

706 
	}
}

708 cÚ¡ 
d’Œy_İ”©iÚs
 
	gext4_d’Œy_İs
 = {

709 .
d_hash
 = 
ext4_d_hash
,

710 .
	gd_com·»
 = 
ext4_d_com·»
,

	@pxt4/ext4.h

17 #iâdeà
_EXT4_H


18 
	#_EXT4_H


	)

20 
	~<lšux/ty³s.h
>

21 
	~<lšux/blkdev.h
>

22 
	~<lšux/magic.h
>

23 
	~<lšux/jbd2.h
>

24 
	~<lšux/quÙa.h
>

25 
	~<lšux/rw£m.h
>

26 
	~<lšux/rbŒ“.h
>

27 
	~<lšux/£qlock.h
>

28 
	~<lšux/mu‹x.h
>

29 
	~<lšux/tim”.h
>

30 
	~<lšux/v”siÚ.h
>

31 
	~<lšux/wa™.h
>

32 
	~<lšux/sched/sigÇl.h
>

33 
	~<lšux/blockgroup_lock.h
>

34 
	~<lšux/³rıu_couÁ”.h
>

35 
	~<lšux/¿‹lim™.h
>

36 
	~<üy±o/hash.h
>

37 
	~<lšux/çÎoc.h
>

38 
	~<lšux/³rıu-rw£m.h
>

39 #ifdeà
__KERNEL__


40 
	~<lšux/com·t.h
>

43 
	~<lšux/fsüy±.h
>

44 
	~<lšux/fsv”™y.h
>

46 
	~<lšux/comp”.h
>

56 
	#AGGRESSIVE_CHECK__


	)

62 
	#DOUBLE_CHECK__


	)

67 #undeà
EXT4FS_DEBUG


72 #ifdeà
EXT4FS_DEBUG


73 
	#ext4_debug
(
f
, 
a
...) \

75 
	`´štk
(
KERN_DEBUG
 "EXT4-fs DEBUG (%s, %d): %s:", \

76 
__FILE__
, 
__LINE__
, 
__func__
); \

77 
	`´štk
(
KERN_DEBUG
 
f
, ## 
a
); \

78 } 0)

	)

80 
	#ext4_debug
(
fmt
, ...è
	`no_´štk
(fmt, ##
__VA_ARGS__
)

	)

86 
	#EXT_DEBUG__


	)

87 #ifdeà
EXT_DEBUG


88 
	#ext_debug
(
fmt
, ...è
	`´štk
(fmt, ##
__VA_ARGS__
)

	)

90 
	#ext_debug
(
fmt
, ...è
	`no_´štk
(fmt, ##
__VA_ARGS__
)

	)

94 
	text4_g½blk_t
;

97 
	text4_fsblk_t
;

100 
__u32
 
	text4_lblk_t
;

103 
	text4_group_t
;

105 
	eSHIFT_DIRECTION
 {

106 
	mSHIFT_LEFT
 = 0,

107 
	mSHIFT_RIGHT
,

118 
	#EXT4_MB_HINT_MERGE
 0x0001

	)

120 
	#EXT4_MB_HINT_RESERVED
 0x0002

	)

122 
	#EXT4_MB_HINT_METADATA
 0x0004

	)

124 
	#EXT4_MB_HINT_FIRST
 0x0008

	)

126 
	#EXT4_MB_HINT_BEST
 0x0010

	)

128 
	#EXT4_MB_HINT_DATA
 0x0020

	)

130 
	#EXT4_MB_HINT_NOPREALLOC
 0x0040

	)

132 
	#EXT4_MB_HINT_GROUP_ALLOC
 0x0080

	)

134 
	#EXT4_MB_HINT_GOAL_ONLY
 0x0100

	)

136 
	#EXT4_MB_HINT_TRY_GOAL
 0x0200

	)

138 
	#EXT4_MB_DELALLOC_RESERVED
 0x0400

	)

140 
	#EXT4_MB_STREAM_ALLOC
 0x0800

	)

142 
	#EXT4_MB_USE_ROOT_BLOCKS
 0x1000

	)

144 
	#EXT4_MB_USE_RESERVED
 0x2000

	)

146 
	sext4_®loÿtiÚ_»que¡
 {

148 
šode
 *
	mšode
;

150 
	mËn
;

152 
ext4_lblk_t
 
	mlogiÿl
;

154 
ext4_lblk_t
 
	mÎeá
;

156 
ext4_lblk_t
 
	mÌight
;

158 
ext4_fsblk_t
 
	mgßl
;

160 
ext4_fsblk_t
 
	m¶eá
;

162 
ext4_fsblk_t
 
	m´ight
;

164 
	mæags
;

174 
	#EXT4_MAP_NEW
 (1 << 
BH_New
)

	)

175 
	#EXT4_MAP_MAPPED
 (1 << 
BH_M­³d
)

	)

176 
	#EXT4_MAP_UNWRITTEN
 (1 << 
BH_Unwr™‹n
)

	)

177 
	#EXT4_MAP_BOUNDARY
 (1 << 
BH_Bound¬y
)

	)

178 
	#EXT4_MAP_FLAGS
 (
EXT4_MAP_NEW
 | 
EXT4_MAP_MAPPED
 |\

179 
EXT4_MAP_UNWRITTEN
 | 
EXT4_MAP_BOUNDARY
)

	)

181 
	sext4_m­_blocks
 {

182 
ext4_fsblk_t
 
	mm_pblk
;

183 
ext4_lblk_t
 
	mm_lblk
;

184 
	mm_Ën
;

185 
	mm_æags
;

191 
	sext4_sy¡em_blocks
 {

192 
rb_roÙ
 
	mroÙ
;

193 
rcu_h—d
 
	mrcu
;

199 
	#EXT4_IO_END_UNWRITTEN
 0x0001

	)

205 
	sext4_io_’d
 {

206 
li¡_h—d
 
	mli¡
;

207 
hªdË_t
 *
	mhªdË
;

209 
šode
 *
	mšode
;

210 
bio
 *
	mbio
;

212 
	mæag
;

213 
©omic_t
 
	mcouÁ
;

214 
loff_t
 
	moff£t
;

215 
ssize_t
 
	msize
;

216 } 
	text4_io_’d_t
;

218 
	sext4_io_subm™
 {

219 
wr™eback_cÚŒŞ
 *
	mio_wbc
;

220 
bio
 *
	mio_bio
;

221 
ext4_io_’d_t
 *
	mio_’d
;

222 
£ùÜ_t
 
	mio_Ãxt_block
;

228 
	#EXT4_BAD_INO
 1

	)

229 
	#EXT4_ROOT_INO
 2

	)

230 
	#EXT4_USR_QUOTA_INO
 3

	)

231 
	#EXT4_GRP_QUOTA_INO
 4

	)

232 
	#EXT4_BOOT_LOADER_INO
 5

	)

233 
	#EXT4_UNDEL_DIR_INO
 6

	)

234 
	#EXT4_RESIZE_INO
 7

	)

235 
	#EXT4_JOURNAL_INO
 8

	)

238 
	#EXT4_GOOD_OLD_FIRST_INO
 11

	)

243 
	#EXT4_LINK_MAX
 65000

	)

248 
	#EXT4_MIN_BLOCK_SIZE
 1024

	)

249 
	#EXT4_MAX_BLOCK_SIZE
 65536

	)

250 
	#EXT4_MIN_BLOCK_LOG_SIZE
 10

	)

251 
	#EXT4_MAX_BLOCK_LOG_SIZE
 16

	)

252 
	#EXT4_MAX_CLUSTER_LOG_SIZE
 30

	)

253 #ifdeà
__KERNEL__


254 
	#EXT4_BLOCK_SIZE
(
s
è((s)->
s_blocksize
)

	)

256 
	#EXT4_BLOCK_SIZE
(
s
è(
EXT4_MIN_BLOCK_SIZE
 << (s)->
s_log_block_size
)

	)

258 
	#EXT4_ADDR_PER_BLOCK
(
s
è(
	`EXT4_BLOCK_SIZE
(sè/ (
__u32
))

	)

259 
	#EXT4_CLUSTER_SIZE
(
s
è(
	`EXT4_BLOCK_SIZE
(s) << \

260 
	`EXT4_SB
(
s
)->
s_şu¡”_b™s
)

	)

261 #ifdeà
__KERNEL__


262 
	#EXT4_BLOCK_SIZE_BITS
(
s
è((s)->
s_blocksize_b™s
)

	)

263 
	#EXT4_CLUSTER_BITS
(
s
è(
	`EXT4_SB
(s)->
s_şu¡”_b™s
)

	)

265 
	#EXT4_BLOCK_SIZE_BITS
(
s
è((s)->
s_log_block_size
 + 10)

	)

267 #ifdeà
__KERNEL__


268 
	#EXT4_ADDR_PER_BLOCK_BITS
(
s
è(
	`EXT4_SB
(s)->
s_addr_³r_block_b™s
)

	)

269 
	#EXT4_INODE_SIZE
(
s
è(
	`EXT4_SB
(s)->
s_šode_size
)

	)

270 
	#EXT4_FIRST_INO
(
s
è(
	`EXT4_SB
(s)->
s_fœ¡_šo
)

	)

272 
	#EXT4_INODE_SIZE
(
s
è(((s)->
s_»v_Ëv–
 =ğ
EXT4_GOOD_OLD_REV
) ? \

273 
EXT4_GOOD_OLD_INODE_SIZE
 : \

274 (
s
)->
s_šode_size
)

	)

275 
	#EXT4_FIRST_INO
(
s
è(((s)->
s_»v_Ëv–
 =ğ
EXT4_GOOD_OLD_REV
) ? \

276 
EXT4_GOOD_OLD_FIRST_INO
 : \

277 (
s
)->
s_fœ¡_šo
)

	)

279 
	#EXT4_BLOCK_ALIGN
(
size
, 
blkb™s
è
	`ALIGN
((size), (1 << (blkb™s)))

	)

280 
	#EXT4_MAX_BLOCKS
(
size
, 
off£t
, 
blkb™s
) \

281 ((
	`EXT4_BLOCK_ALIGN
(
size
 + 
off£t
, 
blkb™s
) >> blkbits) - (offset >> \

282 
blkb™s
))

	)

285 
	#EXT4_B2C
(
sbi
, 
blk
è((blkè>> (sbi)->
s_şu¡”_b™s
)

	)

287 
	#EXT4_C2B
(
sbi
, 
şu¡”
è((şu¡”è<< (sbi)->
s_şu¡”_b™s
)

	)

289 
	#EXT4_NUM_B2C
(
sbi
, 
blks
è(((blksè+ (sbi)->
s_şu¡”_¿tio
 - 1) >> \

290 (
sbi
)->
s_şu¡”_b™s
)

	)

292 
	#EXT4_PBLK_CMASK
(
s
, 
pblk
) ((pblk) & \

293 ~((
ext4_fsblk_t
è(
s
)->
s_şu¡”_¿tio
 - 1))

	)

294 
	#EXT4_LBLK_CMASK
(
s
, 
lblk
) ((lblk) & \

295 ~((
ext4_lblk_t
è(
s
)->
s_şu¡”_¿tio
 - 1))

	)

297 
	#EXT4_LBLK_CFILL
(
sbi
, 
lblk
) ((lblk) | \

298 ((
ext4_lblk_t
è(
sbi
)->
s_şu¡”_¿tio
 - 1))

	)

300 
	#EXT4_PBLK_COFF
(
s
, 
pblk
) ((pblk) & \

301 ((
ext4_fsblk_t
è(
s
)->
s_şu¡”_¿tio
 - 1))

	)

302 
	#EXT4_LBLK_COFF
(
s
, 
lblk
) ((lblk) & \

303 ((
ext4_lblk_t
è(
s
)->
s_şu¡”_¿tio
 - 1))

	)

308 
	sext4_group_desc


310 
__Ë32
 
	mbg_block_b™m­_lo
;

311 
__Ë32
 
	mbg_šode_b™m­_lo
;

312 
__Ë32
 
	mbg_šode_bË_lo
;

313 
__Ë16
 
	mbg_ä“_blocks_couÁ_lo
;

314 
__Ë16
 
	mbg_ä“_šodes_couÁ_lo
;

315 
__Ë16
 
	mbg_u£d_dœs_couÁ_lo
;

316 
__Ë16
 
	mbg_æags
;

317 
__Ë32
 
	mbg_exşude_b™m­_lo
;

318 
__Ë16
 
	mbg_block_b™m­_csum_lo
;

319 
__Ë16
 
	mbg_šode_b™m­_csum_lo
;

320 
__Ë16
 
	mbg_™abË_unu£d_lo
;

321 
__Ë16
 
	mbg_checksum
;

322 
__Ë32
 
	mbg_block_b™m­_hi
;

323 
__Ë32
 
	mbg_šode_b™m­_hi
;

324 
__Ë32
 
	mbg_šode_bË_hi
;

325 
__Ë16
 
	mbg_ä“_blocks_couÁ_hi
;

326 
__Ë16
 
	mbg_ä“_šodes_couÁ_hi
;

327 
__Ë16
 
	mbg_u£d_dœs_couÁ_hi
;

328 
__Ë16
 
	mbg_™abË_unu£d_hi
;

329 
__Ë32
 
	mbg_exşude_b™m­_hi
;

330 
__Ë16
 
	mbg_block_b™m­_csum_hi
;

331 
__Ë16
 
	mbg_šode_b™m­_csum_hi
;

332 
__u32
 
	mbg_»£rved
;

335 
	#EXT4_BG_INODE_BITMAP_CSUM_HI_END
 \

336 (
	`off£tof
(
ext4_group_desc
, 
bg_šode_b™m­_csum_hi
) + \

337 (
__Ë16
))

	)

338 
	#EXT4_BG_BLOCK_BITMAP_CSUM_HI_END
 \

339 (
	`off£tof
(
ext4_group_desc
, 
bg_block_b™m­_csum_hi
) + \

340 (
__Ë16
))

	)

346 
	sæex_groups
 {

347 
©omic64_t
 
	mä“_şu¡”s
;

348 
©omic_t
 
	mä“_šodes
;

349 
©omic_t
 
	mu£d_dœs
;

352 
	#EXT4_BG_INODE_UNINIT
 0x0001

	)

353 
	#EXT4_BG_BLOCK_UNINIT
 0x0002

	)

354 
	#EXT4_BG_INODE_ZEROED
 0x0004

	)

359 
	#EXT4_MIN_DESC_SIZE
 32

	)

360 
	#EXT4_MIN_DESC_SIZE_64BIT
 64

	)

361 
	#EXT4_MAX_DESC_SIZE
 
EXT4_MIN_BLOCK_SIZE


	)

362 
	#EXT4_DESC_SIZE
(
s
è(
	`EXT4_SB
(s)->
s_desc_size
)

	)

363 #ifdeà
__KERNEL__


364 
	#EXT4_BLOCKS_PER_GROUP
(
s
è(
	`EXT4_SB
(s)->
s_blocks_³r_group
)

	)

365 
	#EXT4_CLUSTERS_PER_GROUP
(
s
è(
	`EXT4_SB
(s)->
s_şu¡”s_³r_group
)

	)

366 
	#EXT4_DESC_PER_BLOCK
(
s
è(
	`EXT4_SB
(s)->
s_desc_³r_block
)

	)

367 
	#EXT4_INODES_PER_GROUP
(
s
è(
	`EXT4_SB
(s)->
s_šodes_³r_group
)

	)

368 
	#EXT4_DESC_PER_BLOCK_BITS
(
s
è(
	`EXT4_SB
(s)->
s_desc_³r_block_b™s
)

	)

370 
	#EXT4_BLOCKS_PER_GROUP
(
s
è((s)->
s_blocks_³r_group
)

	)

371 
	#EXT4_DESC_PER_BLOCK
(
s
è(
	`EXT4_BLOCK_SIZE
(sè/ 
	`EXT4_DESC_SIZE
(s))

	)

372 
	#EXT4_INODES_PER_GROUP
(
s
è((s)->
s_šodes_³r_group
)

	)

378 
	#EXT4_NDIR_BLOCKS
 12

	)

379 
	#EXT4_IND_BLOCK
 
EXT4_NDIR_BLOCKS


	)

380 
	#EXT4_DIND_BLOCK
 (
EXT4_IND_BLOCK
 + 1)

	)

381 
	#EXT4_TIND_BLOCK
 (
EXT4_DIND_BLOCK
 + 1)

	)

382 
	#EXT4_N_BLOCKS
 (
EXT4_TIND_BLOCK
 + 1)

	)

387 
	#EXT4_SECRM_FL
 0x00000001

	)

388 
	#EXT4_UNRM_FL
 0x00000002

	)

389 
	#EXT4_COMPR_FL
 0x00000004

	)

390 
	#EXT4_SYNC_FL
 0x00000008

	)

391 
	#EXT4_IMMUTABLE_FL
 0x00000010

	)

392 
	#EXT4_APPEND_FL
 0x00000020

	)

393 
	#EXT4_NODUMP_FL
 0x00000040

	)

394 
	#EXT4_NOATIME_FL
 0x00000080

	)

396 
	#EXT4_DIRTY_FL
 0x00000100

	)

397 
	#EXT4_COMPRBLK_FL
 0x00000200

	)

398 
	#EXT4_NOCOMPR_FL
 0x00000400

	)

400 
	#EXT4_ENCRYPT_FL
 0x00000800

	)

402 
	#EXT4_INDEX_FL
 0x00001000

	)

403 
	#EXT4_IMAGIC_FL
 0x00002000

	)

404 
	#EXT4_JOURNAL_DATA_FL
 0x00004000

	)

405 
	#EXT4_NOTAIL_FL
 0x00008000

	)

406 
	#EXT4_DIRSYNC_FL
 0x00010000

	)

407 
	#EXT4_TOPDIR_FL
 0x00020000

	)

408 
	#EXT4_HUGE_FILE_FL
 0x00040000

	)

409 
	#EXT4_EXTENTS_FL
 0x00080000

	)

410 
	#EXT4_VERITY_FL
 0x00100000

	)

411 
	#EXT4_EA_INODE_FL
 0x00200000

	)

412 
	#EXT4_EOFBLOCKS_FL
 0x00400000

	)

413 
	#EXT4_INLINE_DATA_FL
 0x10000000

	)

414 
	#EXT4_PROJINHERIT_FL
 0x20000000

	)

415 
	#EXT4_CASEFOLD_FL
 0x40000000

	)

416 
	#EXT4_RESERVED_FL
 0x80000000

	)

418 
	#EXT4_FL_USER_VISIBLE
 0x705BDFFF

	)

419 
	#EXT4_FL_USER_MODIFIABLE
 0x604BC0FF

	)

422 
	#EXT4_FL_XFLAG_VISIBLE
 (
EXT4_SYNC_FL
 | \

423 
EXT4_IMMUTABLE_FL
 | \

424 
EXT4_APPEND_FL
 | \

425 
EXT4_NODUMP_FL
 | \

426 
EXT4_NOATIME_FL
 | \

427 
EXT4_PROJINHERIT_FL
)

	)

430 
	#EXT4_FL_INHERITED
 (
EXT4_SECRM_FL
 | 
EXT4_UNRM_FL
 | 
EXT4_COMPR_FL
 |\

431 
EXT4_SYNC_FL
 | 
EXT4_NODUMP_FL
 | 
EXT4_NOATIME_FL
 |\

432 
EXT4_NOCOMPR_FL
 | 
EXT4_JOURNAL_DATA_FL
 |\

433 
EXT4_NOTAIL_FL
 | 
EXT4_DIRSYNC_FL
 |\

434 
EXT4_PROJINHERIT_FL
 | 
EXT4_CASEFOLD_FL
)

	)

437 
	#EXT4_REG_FLMASK
 (~(
EXT4_DIRSYNC_FL
 | 
EXT4_TOPDIR_FL
 | 
EXT4_CASEFOLD_FL
 |\

438 
EXT4_PROJINHERIT_FL
))

	)

441 
	#EXT4_OTHER_FLMASK
 (
EXT4_NODUMP_FL
 | 
EXT4_NOATIME_FL
)

	)

444 
	#EXT4_FL_SHOULD_SWAP
 (
EXT4_HUGE_FILE_FL
 | 
EXT4_EXTENTS_FL
)

	)

447 
šlše
 
__u32
 
	$ext4_mask_æags
(
umode_t
 
mode
, 
__u32
 
æags
)

449 ià(
	`S_ISDIR
(
mode
))

450  
æags
;

451 ià(
	`S_ISREG
(
mode
))

452  
æags
 & 
EXT4_REG_FLMASK
;

454  
æags
 & 
EXT4_OTHER_FLMASK
;

455 
	}
}

461 
	mEXT4_INODE_SECRM
 = 0,

462 
	mEXT4_INODE_UNRM
 = 1,

463 
	mEXT4_INODE_COMPR
 = 2,

464 
	mEXT4_INODE_SYNC
 = 3,

465 
	mEXT4_INODE_IMMUTABLE
 = 4,

466 
	mEXT4_INODE_APPEND
 = 5,

467 
	mEXT4_INODE_NODUMP
 = 6,

468 
	mEXT4_INODE_NOATIME
 = 7,

470 
	mEXT4_INODE_DIRTY
 = 8,

471 
	mEXT4_INODE_COMPRBLK
 = 9,

472 
	mEXT4_INODE_NOCOMPR
 = 10,

473 
	mEXT4_INODE_ENCRYPT
 = 11,

475 
	mEXT4_INODE_INDEX
 = 12,

476 
	mEXT4_INODE_IMAGIC
 = 13,

477 
	mEXT4_INODE_JOURNAL_DATA
 = 14,

478 
	mEXT4_INODE_NOTAIL
 = 15,

479 
	mEXT4_INODE_DIRSYNC
 = 16,

480 
	mEXT4_INODE_TOPDIR
 = 17,

481 
	mEXT4_INODE_HUGE_FILE
 = 18,

482 
	mEXT4_INODE_EXTENTS
 = 19,

483 
	mEXT4_INODE_VERITY
 = 20,

484 
	mEXT4_INODE_EA_INODE
 = 21,

485 
	mEXT4_INODE_EOFBLOCKS
 = 22,

486 
	mEXT4_INODE_INLINE_DATA
 = 28,

487 
	mEXT4_INODE_PROJINHERIT
 = 29,

488 
	mEXT4_INODE_RESERVED
 = 31,

504 
	#TEST_FLAG_VALUE
(
FLAG
è(
EXT4_
##FLAG##
_FL
 =ğ(1 << 
EXT4_INODE_
##FLAG))

	)

505 
	#CHECK_FLAG_VALUE
(
FLAG
è
	`BUILD_BUG_ON
(!
	`TEST_FLAG_VALUE
(FLAG))

	)

507 
šlše
 
	$ext4_check_æag_v®ues
()

509 
	`CHECK_FLAG_VALUE
(
SECRM
);

510 
	`CHECK_FLAG_VALUE
(
UNRM
);

511 
	`CHECK_FLAG_VALUE
(
COMPR
);

512 
	`CHECK_FLAG_VALUE
(
SYNC
);

513 
	`CHECK_FLAG_VALUE
(
IMMUTABLE
);

514 
	`CHECK_FLAG_VALUE
(
APPEND
);

515 
	`CHECK_FLAG_VALUE
(
NODUMP
);

516 
	`CHECK_FLAG_VALUE
(
NOATIME
);

517 
	`CHECK_FLAG_VALUE
(
DIRTY
);

518 
	`CHECK_FLAG_VALUE
(
COMPRBLK
);

519 
	`CHECK_FLAG_VALUE
(
NOCOMPR
);

520 
	`CHECK_FLAG_VALUE
(
ENCRYPT
);

521 
	`CHECK_FLAG_VALUE
(
INDEX
);

522 
	`CHECK_FLAG_VALUE
(
IMAGIC
);

523 
	`CHECK_FLAG_VALUE
(
JOURNAL_DATA
);

524 
	`CHECK_FLAG_VALUE
(
NOTAIL
);

525 
	`CHECK_FLAG_VALUE
(
DIRSYNC
);

526 
	`CHECK_FLAG_VALUE
(
TOPDIR
);

527 
	`CHECK_FLAG_VALUE
(
HUGE_FILE
);

528 
	`CHECK_FLAG_VALUE
(
EXTENTS
);

529 
	`CHECK_FLAG_VALUE
(
VERITY
);

530 
	`CHECK_FLAG_VALUE
(
EA_INODE
);

531 
	`CHECK_FLAG_VALUE
(
EOFBLOCKS
);

532 
	`CHECK_FLAG_VALUE
(
INLINE_DATA
);

533 
	`CHECK_FLAG_VALUE
(
PROJINHERIT
);

534 
	`CHECK_FLAG_VALUE
(
RESERVED
);

535 
	}
}

538 
	sext4_Ãw_group_šput
 {

539 
__u32
 
	mgroup
;

540 
__u64
 
	mblock_b™m­
;

541 
__u64
 
	mšode_b™m­
;

542 
__u64
 
	mšode_bË
;

543 
__u32
 
	mblocks_couÁ
;

544 
__u16
 
	m»£rved_blocks
;

545 
__u16
 
	munu£d
;

548 #ià
defšed
(
__KERNEL__
è&& defšed(
CONFIG_COMPAT
)

549 
	scom·t_ext4_Ãw_group_šput
 {

550 
u32
 
	mgroup
;

551 
com·t_u64
 
	mblock_b™m­
;

552 
com·t_u64
 
	mšode_b™m­
;

553 
com·t_u64
 
	mšode_bË
;

554 
u32
 
	mblocks_couÁ
;

555 
u16
 
	m»£rved_blocks
;

556 
u16
 
	munu£d
;

561 
	sext4_Ãw_group_d©a
 {

562 
__u32
 
	mgroup
;

563 
__u64
 
	mblock_b™m­
;

564 
__u64
 
	mšode_b™m­
;

565 
__u64
 
	mšode_bË
;

566 
__u32
 
	mblocks_couÁ
;

567 
__u16
 
	m»£rved_blocks
;

568 
__u16
 
	mmd©a_blocks
;

569 
__u32
 
	mä“_şu¡”s_couÁ
;

574 
	mBLOCK_BITMAP
 = 0,

575 
	mINODE_BITMAP
,

576 
	mINODE_TABLE
,

577 
	mGROUP_TABLE_COUNT
,

585 
	#EXT4_GET_BLOCKS_CREATE
 0x0001

	)

587 
	#EXT4_GET_BLOCKS_UNWRIT_EXT
 0x0002

	)

588 
	#EXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
 (
EXT4_GET_BLOCKS_UNWRIT_EXT
|\

589 
EXT4_GET_BLOCKS_CREATE
)

	)

592 
	#EXT4_GET_BLOCKS_DELALLOC_RESERVE
 0x0004

	)

596 
	#EXT4_GET_BLOCKS_PRE_IO
 0x0008

	)

597 
	#EXT4_GET_BLOCKS_CONVERT
 0x0010

	)

598 
	#EXT4_GET_BLOCKS_IO_CREATE_EXT
 (
EXT4_GET_BLOCKS_PRE_IO
|\

599 
EXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
)

	)

601 
	#EXT4_GET_BLOCKS_IO_CONVERT_EXT
 (
EXT4_GET_BLOCKS_CONVERT
|\

602 
EXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
)

	)

605 
	#EXT4_GET_BLOCKS_METADATA_NOFAIL
 0x0020

	)

607 
	#EXT4_GET_BLOCKS_NO_NORMALIZE
 0x0040

	)

609 
	#EXT4_GET_BLOCKS_KEEP_SIZE
 0x0080

	)

611 
	#EXT4_GET_BLOCKS_CONVERT_UNWRITTEN
 0x0100

	)

613 
	#EXT4_GET_BLOCKS_ZERO
 0x0200

	)

614 
	#EXT4_GET_BLOCKS_CREATE_ZERO
 (
EXT4_GET_BLOCKS_CREATE
 |\

615 
EXT4_GET_BLOCKS_ZERO
)

	)

618 
	#EXT4_GET_BLOCKS_IO_SUBMIT
 0x0400

	)

629 
	#EXT4_EX_NOCACHE
 0x40000000

	)

630 
	#EXT4_EX_FORCE_CACHE
 0x20000000

	)

635 
	#EXT4_FREE_BLOCKS_METADATA
 0x0001

	)

636 
	#EXT4_FREE_BLOCKS_FORGET
 0x0002

	)

637 
	#EXT4_FREE_BLOCKS_VALIDATED
 0x0004

	)

638 
	#EXT4_FREE_BLOCKS_NO_QUOT_UPDATE
 0x0008

	)

639 
	#EXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
 0x0010

	)

640 
	#EXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
 0x0020

	)

641 
	#EXT4_FREE_BLOCKS_RERESERVE_CLUSTER
 0x0040

	)

646 
	#EXT4_IOC_GETFLAGS
 
FS_IOC_GETFLAGS


	)

647 
	#EXT4_IOC_SETFLAGS
 
FS_IOC_SETFLAGS


	)

648 
	#EXT4_IOC_GETVERSION
 
	`_IOR
('f', 3, )

	)

649 
	#EXT4_IOC_SETVERSION
 
	`_IOW
('f', 4, )

	)

650 
	#EXT4_IOC_GETVERSION_OLD
 
FS_IOC_GETVERSION


	)

651 
	#EXT4_IOC_SETVERSION_OLD
 
FS_IOC_SETVERSION


	)

652 
	#EXT4_IOC_GETRSVSZ
 
	`_IOR
('f', 5, )

	)

653 
	#EXT4_IOC_SETRSVSZ
 
	`_IOW
('f', 6, )

	)

654 
	#EXT4_IOC_GROUP_EXTEND
 
	`_IOW
('f', 7, )

	)

655 
	#EXT4_IOC_GROUP_ADD
 
	`_IOW
('f', 8, 
ext4_Ãw_group_šput
)

	)

656 
	#EXT4_IOC_MIGRATE
 
	`_IO
('f', 9)

	)

659 
	#EXT4_IOC_ALLOC_DA_BLKS
 
	`_IO
('f', 12)

	)

660 
	#EXT4_IOC_MOVE_EXT
 
	`_IOWR
('f', 15, 
move_ex‹Á
)

	)

661 
	#EXT4_IOC_RESIZE_FS
 
	`_IOW
('f', 16, 
__u64
)

	)

662 
	#EXT4_IOC_SWAP_BOOT
 
	`_IO
('f', 17)

	)

663 
	#EXT4_IOC_PRECACHE_EXTENTS
 
	`_IO
('f', 18)

	)

664 
	#EXT4_IOC_SET_ENCRYPTION_POLICY
 
FS_IOC_SET_ENCRYPTION_POLICY


	)

665 
	#EXT4_IOC_GET_ENCRYPTION_PWSALT
 
FS_IOC_GET_ENCRYPTION_PWSALT


	)

666 
	#EXT4_IOC_GET_ENCRYPTION_POLICY
 
FS_IOC_GET_ENCRYPTION_POLICY


	)

668 
	#EXT4_IOC_CLEAR_ES_CACHE
 
	`_IO
('f', 40)

	)

669 
	#EXT4_IOC_GETSTATE
 
	`_IOW
('f', 41, 
__u32
)

	)

670 
	#EXT4_IOC_GET_ES_CACHE
 
	`_IOWR
('f', 42, 
f›m­
)

	)

672 
	#EXT4_IOC_FSGETXATTR
 
FS_IOC_FSGETXATTR


	)

673 
	#EXT4_IOC_FSSETXATTR
 
FS_IOC_FSSETXATTR


	)

675 
	#EXT4_IOC_SHUTDOWN
 
	`_IOR
 ('X', 125, 
__u32
)

	)

680 
	#EXT4_GOING_FLAGS_DEFAULT
 0x0

	)

681 
	#EXT4_GOING_FLAGS_LOGFLUSH
 0x1

	)

682 
	#EXT4_GOING_FLAGS_NOLOGFLUSH
 0x2

	)

690 
	#EXT4_STATE_FLAG_EXT_PRECACHED
 0x00000001

	)

691 
	#EXT4_STATE_FLAG_NEW
 0x00000002

	)

692 
	#EXT4_STATE_FLAG_NEWENTRY
 0x00000004

	)

693 
	#EXT4_STATE_FLAG_DA_ALLOC_CLOSE
 0x00000008

	)

695 #ià
defšed
(
__KERNEL__
è&& defšed(
CONFIG_COMPAT
)

699 
	#EXT4_IOC32_GETFLAGS
 
FS_IOC32_GETFLAGS


	)

700 
	#EXT4_IOC32_SETFLAGS
 
FS_IOC32_SETFLAGS


	)

701 
	#EXT4_IOC32_GETVERSION
 
	`_IOR
('f', 3, )

	)

702 
	#EXT4_IOC32_SETVERSION
 
	`_IOW
('f', 4, )

	)

703 
	#EXT4_IOC32_GETRSVSZ
 
	`_IOR
('f', 5, )

	)

704 
	#EXT4_IOC32_SETRSVSZ
 
	`_IOW
('f', 6, )

	)

705 
	#EXT4_IOC32_GROUP_EXTEND
 
	`_IOW
('f', 7, )

	)

706 
	#EXT4_IOC32_GROUP_ADD
 
	`_IOW
('f', 8, 
com·t_ext4_Ãw_group_šput
)

	)

707 
	#EXT4_IOC32_GETVERSION_OLD
 
FS_IOC32_GETVERSION


	)

708 
	#EXT4_IOC32_SETVERSION_OLD
 
FS_IOC32_SETVERSION


	)

715 
	#EXT4_FIEMAP_EXTENT_HOLE
 0x08000000

	)

718 
	#EXT4_MAX_BLOCK_FILE_PHYS
 0xFFFFFFFF

	)

721 
	#EXT4_MAX_LOGICAL_BLOCK
 0xFFFFFFFF

	)

726 
	sext4_šode
 {

727 
__Ë16
 
	mi_mode
;

728 
__Ë16
 
	mi_uid
;

729 
__Ë32
 
	mi_size_lo
;

730 
__Ë32
 
	mi_©ime
;

731 
__Ë32
 
	mi_ùime
;

732 
__Ë32
 
	mi_mtime
;

733 
__Ë32
 
	mi_dtime
;

734 
__Ë16
 
	mi_gid
;

735 
__Ë16
 
	mi_lšks_couÁ
;

736 
__Ë32
 
	mi_blocks_lo
;

737 
__Ë32
 
	mi_æags
;

740 
__Ë32
 
	ml_i_v”siÚ
;

741 } 
	mlšux1
;

743 
__u32
 
	mh_i_Œª¦©Ü
;

744 } 
	mhurd1
;

746 
__u32
 
	mm_i_»£rved1
;

747 } 
	mmasix1
;

748 } 
	mosd1
;

749 
__Ë32
 
	mi_block
[
EXT4_N_BLOCKS
];

750 
__Ë32
 
	mi_g’”©iÚ
;

751 
__Ë32
 
	mi_fe_aş_lo
;

752 
__Ë32
 
	mi_size_high
;

753 
__Ë32
 
	mi_obso_çddr
;

756 
__Ë16
 
	ml_i_blocks_high
;

757 
__Ë16
 
	ml_i_fe_aş_high
;

758 
__Ë16
 
	ml_i_uid_high
;

759 
__Ë16
 
	ml_i_gid_high
;

760 
__Ë16
 
	ml_i_checksum_lo
;

761 
__Ë16
 
	ml_i_»£rved
;

762 } 
	mlšux2
;

764 
__Ë16
 
	mh_i_»£rved1
;

765 
__u16
 
	mh_i_mode_high
;

766 
__u16
 
	mh_i_uid_high
;

767 
__u16
 
	mh_i_gid_high
;

768 
__u32
 
	mh_i_authÜ
;

769 } 
	mhurd2
;

771 
__Ë16
 
	mh_i_»£rved1
;

772 
__Ë16
 
	mm_i_fe_aş_high
;

773 
__u32
 
	mm_i_»£rved2
[2];

774 } 
	mmasix2
;

775 } 
	mosd2
;

776 
__Ë16
 
	mi_exŒa_isize
;

777 
__Ë16
 
	mi_checksum_hi
;

778 
__Ë32
 
	mi_ùime_exŒa
;

779 
__Ë32
 
	mi_mtime_exŒa
;

780 
__Ë32
 
	mi_©ime_exŒa
;

781 
__Ë32
 
	mi_ütime
;

782 
__Ë32
 
	mi_ütime_exŒa
;

783 
__Ë32
 
	mi_v”siÚ_hi
;

784 
__Ë32
 
	mi_´ojid
;

787 
	smove_ex‹Á
 {

788 
__u32
 
	m»£rved
;

789 
__u32
 
	mdÚÜ_fd
;

790 
__u64
 
	mÜig_¡¬t
;

791 
__u64
 
	mdÚÜ_¡¬t
;

792 
__u64
 
	mËn
;

793 
__u64
 
	mmoved_Ën
;

796 
	#EXT4_EPOCH_BITS
 2

	)

797 
	#EXT4_EPOCH_MASK
 ((1 << 
EXT4_EPOCH_BITS
è- 1)

	)

798 
	#EXT4_NSEC_MASK
 (~0UL << 
EXT4_EPOCH_BITS
)

	)

810 
	#EXT4_FITS_IN_INODE
(
ext4_šode
, 
ešode
, 
f›ld
) \

811 ((
	`off£tof
(
	`ty³of
(*
ext4_šode
), 
f›ld
) + \

812 ((
ext4_šode
)->
f›ld
)) \

813 <ğ(
EXT4_GOOD_OLD_INODE_SIZE
 + \

814 (
ešode
)->
i_exŒa_isize
)) \

815 

	)

837 
šlše
 
__Ë32
 
	$ext4_’code_exŒa_time
(
time¥ec64
 *
time
)

839 
u32
 
exŒa
 =((
time
->
tv_£c
 - (
s32
éime->tv_£cè>> 32è& 
EXT4_EPOCH_MASK
;

840  
	`ıu_to_Ë32
(
exŒa
 | (
time
->
tv_n£c
 << 
EXT4_EPOCH_BITS
));

841 
	}
}

843 
šlše
 
	$ext4_decode_exŒa_time
(
time¥ec64
 *
time
,

844 
__Ë32
 
exŒa
)

846 ià(
	`uÆik–y
(
exŒa
 & 
	`ıu_to_Ë32
(
EXT4_EPOCH_MASK
)))

847 
time
->
tv_£c
 +ğ(
u64
)(
	`Ë32_to_ıu
(
exŒa
è& 
EXT4_EPOCH_MASK
) << 32;

848 
time
->
tv_n£c
 = (
	`Ë32_to_ıu
(
exŒa
è& 
EXT4_NSEC_MASK
è>> 
EXT4_EPOCH_BITS
;

849 
	}
}

851 
	#EXT4_INODE_SET_XTIME
(
xtime
, 
šode
, 
¿w_šode
) \

853 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
	`EXT4_I
(
šode
), 
xtime
 ## 
_exŒa
)) {\

854 (
¿w_šode
)->
xtime
 = 
	`ıu_to_Ë32
((
šode
)->xtime.
tv_£c
); \

855 (
¿w_šode
)->
xtime
 ## 
_exŒa
 = \

856 
	`ext4_’code_exŒa_time
(&(
šode
)->
xtime
); \

859 (
¿w_šode
)->
xtime
 = 
	`ıu_to_Ë32
(
	`şamp_t
(
št32_t
, (
šode
)->xtime.
tv_£c
, 
S32_MIN
, 
S32_MAX
)); \

860 } 0)

	)

862 
	#EXT4_EINODE_SET_XTIME
(
xtime
, 
ešode
, 
¿w_šode
) \

864 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ešode
, 
xtime
)) \

865 (
¿w_šode
)->
xtime
 = 
	`ıu_to_Ë32
((
ešode
)->xtime.
tv_£c
); \

866 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ešode
, 
xtime
 ## 
_exŒa
)) \

867 (
¿w_šode
)->
xtime
 ## 
_exŒa
 = \

868 
	`ext4_’code_exŒa_time
(&(
ešode
)->
xtime
); \

869 } 0)

	)

871 
	#EXT4_INODE_GET_XTIME
(
xtime
, 
šode
, 
¿w_šode
) \

873 (
šode
)->
xtime
.
tv_£c
 = (sigÃd)
	`Ë32_to_ıu
((
¿w_šode
)->xtime); \

874 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
	`EXT4_I
(
šode
), 
xtime
 ## 
_exŒa
)) { \

875 
	`ext4_decode_exŒa_time
(&(
šode
)->
xtime
, \

876 
¿w_šode
->
xtime
 ## 
_exŒa
); \

879 (
šode
)->
xtime
.
tv_n£c
 = 0; \

880 } 0)

	)

883 
	#EXT4_EINODE_GET_XTIME
(
xtime
, 
ešode
, 
¿w_šode
) \

885 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ešode
, 
xtime
)) \

886 (
ešode
)->
xtime
.
tv_£c
 = \

887 (sigÃd)
	`Ë32_to_ıu
((
¿w_šode
)->
xtime
); \

889 (
ešode
)->
xtime
.
tv_£c
 = 0; \

890 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ešode
, 
xtime
 ## 
_exŒa
)) \

891 
	`ext4_decode_exŒa_time
(&(
ešode
)->
xtime
, \

892 
¿w_šode
->
xtime
 ## 
_exŒa
); \

894 (
ešode
)->
xtime
.
tv_n£c
 = 0; \

895 } 0)

	)

897 
	#i_disk_v”siÚ
 
osd1
.
lšux1
.
l_i_v”siÚ


	)

899 #ià
defšed
(
__KERNEL__
è|| defšed(
__lšux__
)

900 
	#i_»£rved1
 
osd1
.
lšux1
.
l_i_»£rved1


	)

901 
	#i_fe_aş_high
 
osd2
.
lšux2
.
l_i_fe_aş_high


	)

902 
	#i_blocks_high
 
osd2
.
lšux2
.
l_i_blocks_high


	)

903 
	#i_uid_low
 
i_uid


	)

904 
	#i_gid_low
 
i_gid


	)

905 
	#i_uid_high
 
osd2
.
lšux2
.
l_i_uid_high


	)

906 
	#i_gid_high
 
osd2
.
lšux2
.
l_i_gid_high


	)

907 
	#i_checksum_lo
 
osd2
.
lšux2
.
l_i_checksum_lo


	)

909 #–ià
defšed
(
__GNU__
)

911 
	#i_Œª¦©Ü
 
osd1
.
hurd1
.
h_i_Œª¦©Ü


	)

912 
	#i_uid_high
 
osd2
.
hurd2
.
h_i_uid_high


	)

913 
	#i_gid_high
 
osd2
.
hurd2
.
h_i_gid_high


	)

914 
	#i_authÜ
 
osd2
.
hurd2
.
h_i_authÜ


	)

916 #–ià
defšed
(
__masix__
)

918 
	#i_»£rved1
 
osd1
.
masix1
.
m_i_»£rved1


	)

919 
	#i_fe_aş_high
 
osd2
.
masix2
.
m_i_fe_aş_high


	)

920 
	#i_»£rved2
 
osd2
.
masix2
.
m_i_»£rved2


	)

924 
	~"ex‹Ás_¡©us.h
"

943 
	mI_DATA_SEM_NORMAL
 = 0,

944 
	mI_DATA_SEM_OTHER
,

945 
	mI_DATA_SEM_QUOTA
,

952 
	sext4_šode_šfo
 {

953 
__Ë32
 
	mi_d©a
[15];

954 
__u32
 
	mi_dtime
;

955 
ext4_fsblk_t
 
	mi_fe_aş
;

964 
ext4_group_t
 
	mi_block_group
;

965 
ext4_lblk_t
 
	mi_dœ_¡¬t_lookup
;

966 #ià(
BITS_PER_LONG
 < 64)

967 
	mi_¡©e_æags
;

969 
	mi_æags
;

978 
rw_£m­hÜe
 
	mx©Œ_£m
;

980 
li¡_h—d
 
	mi_Üphª
;

997 
loff_t
 
	mi_disksize
;

1009 
rw_£m­hÜe
 
	mi_d©a_£m
;

1018 
rw_£m­hÜe
 
	mi_mm­_£m
;

1019 
šode
 
	mvfs_šode
;

1020 
jbd2_šode
 *
	mjšode
;

1022 
¥šlock_t
 
	mi_¿w_lock
;

1028 
time¥ec64
 
	mi_ütime
;

1031 
li¡_h—d
 
	mi_´—Îoc_li¡
;

1032 
¥šlock_t
 
	mi_´—Îoc_lock
;

1035 
ext4_es_Œ“
 
	mi_es_Œ“
;

1036 
rwlock_t
 
	mi_es_lock
;

1037 
li¡_h—d
 
	mi_es_li¡
;

1038 
	mi_es_®l_Ä
;

1039 
	mi_es_shk_Ä
;

1040 
ext4_lblk_t
 
	mi_es_shršk_lblk
;

1045 
ext4_group_t
 
	mi_Ï¡_®loc_group
;

1049 
	mi_»£rved_d©a_blocks
;

1050 
ext4_lblk_t
 
	mi_da_m‘ad©a_ÿlc_Ï¡_lblock
;

1051 
	mi_da_m‘ad©a_ÿlc_Ën
;

1054 
ext4_³ndšg_Œ“
 
	mi_³ndšg_Œ“
;

1057 
__u16
 
	mi_exŒa_isize
;

1060 
u16
 
	mi_šlše_off
;

1061 
u16
 
	mi_šlše_size
;

1063 #ifdeà
CONFIG_QUOTA


1065 
qsize_t
 
	mi_»£rved_quÙa
;

1069 
¥šlock_t
 
	mi_com¶‘ed_io_lock
;

1074 
li¡_h—d
 
	mi_rsv_cÚv”siÚ_li¡
;

1075 
wÜk_¡ruù
 
	mi_rsv_cÚv”siÚ_wÜk
;

1076 
©omic_t
 
	mi_unwr™‹n
;

1078 
¥šlock_t
 
	mi_block_»£rv©iÚ_lock
;

1084 
tid_t
 
	mi_sync_tid
;

1085 
tid_t
 
	mi_d©async_tid
;

1087 #ifdeà
CONFIG_QUOTA


1088 
dquÙ
 *
	mi_dquÙ
[
MAXQUOTAS
];

1092 
__u32
 
	mi_csum_£ed
;

1094 
k´ojid_t
 
	mi_´ojid
;

1100 
	#EXT4_VALID_FS
 0x0001

	)

1101 
	#EXT4_ERROR_FS
 0x0002

	)

1102 
	#EXT4_ORPHAN_FS
 0x0004

	)

1107 
	#EXT2_FLAGS_SIGNED_HASH
 0x0001

	)

1108 
	#EXT2_FLAGS_UNSIGNED_HASH
 0x0002

	)

1109 
	#EXT2_FLAGS_TEST_FILESYS
 0x0004

	)

1114 
	#EXT4_MOUNT_NO_MBCACHE
 0x00001

	)

1115 
	#EXT4_MOUNT_GRPID
 0x00004

	)

1116 
	#EXT4_MOUNT_DEBUG
 0x00008

	)

1117 
	#EXT4_MOUNT_ERRORS_CONT
 0x00010

	)

1118 
	#EXT4_MOUNT_ERRORS_RO
 0x00020

	)

1119 
	#EXT4_MOUNT_ERRORS_PANIC
 0x00040

	)

1120 
	#EXT4_MOUNT_ERRORS_MASK
 0x00070

	)

1121 
	#EXT4_MOUNT_MINIX_DF
 0x00080

	)

1122 
	#EXT4_MOUNT_NOLOAD
 0x00100

	)

1123 #ifdeà
CONFIG_FS_DAX


1124 
	#EXT4_MOUNT_DAX
 0x00200

	)

1126 
	#EXT4_MOUNT_DAX
 0

	)

1128 
	#EXT4_MOUNT_DATA_FLAGS
 0x00C00

	)

1129 
	#EXT4_MOUNT_JOURNAL_DATA
 0x00400

	)

1130 
	#EXT4_MOUNT_ORDERED_DATA
 0x00800

	)

1131 
	#EXT4_MOUNT_WRITEBACK_DATA
 0x00C00

	)

1132 
	#EXT4_MOUNT_UPDATE_JOURNAL
 0x01000

	)

1133 
	#EXT4_MOUNT_NO_UID32
 0x02000

	)

1134 
	#EXT4_MOUNT_XATTR_USER
 0x04000

	)

1135 
	#EXT4_MOUNT_POSIX_ACL
 0x08000

	)

1136 
	#EXT4_MOUNT_NO_AUTO_DA_ALLOC
 0x10000

	)

1137 
	#EXT4_MOUNT_BARRIER
 0x20000

	)

1138 
	#EXT4_MOUNT_QUOTA
 0x40000

	)

1139 
	#EXT4_MOUNT_USRQUOTA
 0x80000

	)

1142 
	#EXT4_MOUNT_GRPQUOTA
 0x100000

	)

1145 
	#EXT4_MOUNT_PRJQUOTA
 0x200000

	)

1147 
	#EXT4_MOUNT_DIOREAD_NOLOCK
 0x400000

	)

1148 
	#EXT4_MOUNT_JOURNAL_CHECKSUM
 0x800000

	)

1149 
	#EXT4_MOUNT_JOURNAL_ASYNC_COMMIT
 0x1000000

	)

1150 
	#EXT4_MOUNT_WARN_ON_ERROR
 0x2000000

	)

1151 
	#EXT4_MOUNT_DELALLOC
 0x8000000

	)

1152 
	#EXT4_MOUNT_DATA_ERR_ABORT
 0x10000000

	)

1153 
	#EXT4_MOUNT_BLOCK_VALIDITY
 0x20000000

	)

1154 
	#EXT4_MOUNT_DISCARD
 0x40000000

	)

1155 
	#EXT4_MOUNT_INIT_INODE_TABLE
 0x80000000

	)

1162 
	#EXT4_MOUNT2_EXPLICIT_DELALLOC
 0x00000001

	)

1164 
	#EXT4_MOUNT2_STD_GROUP_SIZE
 0x00000002

	)

1167 
	#EXT4_MOUNT2_HURD_COMPAT
 0x00000004

	)

1170 
	#EXT4_MOUNT2_EXPLICIT_JOURNAL_CHECKSUM
 0x00000008

	)

1173 
	#ş—r_İt
(
sb
, 
İt
è
	`EXT4_SB
(sb)->
s_mouÁ_İt
 &= \

1174 ~
EXT4_MOUNT_
##
İt


	)

1175 
	#£t_İt
(
sb
, 
İt
è
	`EXT4_SB
(sb)->
s_mouÁ_İt
 |= \

1176 
EXT4_MOUNT_
##
İt


	)

1177 
	#‹¡_İt
(
sb
, 
İt
è(
	`EXT4_SB
(sb)->
s_mouÁ_İt
 & \

1178 
EXT4_MOUNT_
##
İt
)

	)

1180 
	#ş—r_İt2
(
sb
, 
İt
è
	`EXT4_SB
(sb)->
s_mouÁ_İt2
 &= \

1181 ~
EXT4_MOUNT2_
##
İt


	)

1182 
	#£t_İt2
(
sb
, 
İt
è
	`EXT4_SB
(sb)->
s_mouÁ_İt2
 |= \

1183 
EXT4_MOUNT2_
##
İt


	)

1184 
	#‹¡_İt2
(
sb
, 
İt
è(
	`EXT4_SB
(sb)->
s_mouÁ_İt2
 & \

1185 
EXT4_MOUNT2_
##
İt
)

	)

1187 
	#ext4_‹¡_ªd_£t_b™
 
__‹¡_ªd_£t_b™_Ë


	)

1188 
	#ext4_£t_b™
 
__£t_b™_Ë


	)

1189 
	#ext4_£t_b™_©omic
 
ext2_£t_b™_©omic


	)

1190 
	#ext4_‹¡_ªd_ş—r_b™
 
__‹¡_ªd_ş—r_b™_Ë


	)

1191 
	#ext4_ş—r_b™
 
__ş—r_b™_Ë


	)

1192 
	#ext4_ş—r_b™_©omic
 
ext2_ş—r_b™_©omic


	)

1193 
	#ext4_‹¡_b™
 
‹¡_b™_Ë


	)

1194 
	#ext4_fšd_Ãxt_z”o_b™
 
fšd_Ãxt_z”o_b™_Ë


	)

1195 
	#ext4_fšd_Ãxt_b™
 
fšd_Ãxt_b™_Ë


	)

1197 
ext4_£t_b™s
(*
bm
, 
cur
, 
Ën
);

1202 
	#EXT4_DFL_MAX_MNT_COUNT
 20

	)

1203 
	#EXT4_DFL_CHECKINTERVAL
 0

	)

1208 
	#EXT4_ERRORS_CONTINUE
 1

	)

1209 
	#EXT4_ERRORS_RO
 2

	)

1210 
	#EXT4_ERRORS_PANIC
 3

	)

1211 
	#EXT4_ERRORS_DEFAULT
 
EXT4_ERRORS_CONTINUE


	)

1214 
	#EXT4_CRC32C_CHKSUM
 1

	)

1219 
	sext4_su³r_block
 {

1220  
__Ë32
 
	ms_šodes_couÁ
;

1221 
__Ë32
 
	ms_blocks_couÁ_lo
;

1222 
__Ë32
 
	ms_r_blocks_couÁ_lo
;

1223 
__Ë32
 
	ms_ä“_blocks_couÁ_lo
;

1224  
__Ë32
 
	ms_ä“_šodes_couÁ
;

1225 
__Ë32
 
	ms_fœ¡_d©a_block
;

1226 
__Ë32
 
	ms_log_block_size
;

1227 
__Ë32
 
	ms_log_şu¡”_size
;

1228  
__Ë32
 
	ms_blocks_³r_group
;

1229 
__Ë32
 
	ms_şu¡”s_³r_group
;

1230 
__Ë32
 
	ms_šodes_³r_group
;

1231 
__Ë32
 
	ms_mtime
;

1232  
__Ë32
 
	ms_wtime
;

1233 
__Ë16
 
	ms_mÁ_couÁ
;

1234 
__Ë16
 
	ms_max_mÁ_couÁ
;

1235 
__Ë16
 
	ms_magic
;

1236 
__Ë16
 
	ms_¡©e
;

1237 
__Ë16
 
	ms_”rÜs
;

1238 
__Ë16
 
	ms_mšÜ_»v_Ëv–
;

1239  
__Ë32
 
	ms_Ï¡check
;

1240 
__Ë32
 
	ms_checkš‹rv®
;

1241 
__Ë32
 
	ms_ü—tÜ_os
;

1242 
__Ë32
 
	ms_»v_Ëv–
;

1243  
__Ë16
 
	ms_def_»suid
;

1244 
__Ë16
 
	ms_def_»sgid
;

1258 
__Ë32
 
	ms_fœ¡_šo
;

1259 
__Ë16
 
	ms_šode_size
;

1260 
__Ë16
 
	ms_block_group_Ä
;

1261 
__Ë32
 
	ms_ã©u»_com·t
;

1262  
__Ë32
 
	ms_ã©u»_šcom·t
;

1263 
__Ë32
 
	ms_ã©u»_ro_com·t
;

1264  
__u8
 
	ms_uuid
[16];

1265  
	ms_vŞume_Çme
[16];

1266  
	ms_Ï¡_mouÁed
[64] 
	m__nÚ¡ršg
;

1267  
__Ë32
 
	ms_®gÜ™hm_u§ge_b™m­
;

1272 
__u8
 
	ms_´—Îoc_blocks
;

1273 
__u8
 
	ms_´—Îoc_dœ_blocks
;

1274 
__Ë16
 
	ms_»£rved_gdt_blocks
;

1278  
__u8
 
	ms_jouº®_uuid
[16];

1279  
__Ë32
 
	ms_jouº®_šum
;

1280 
__Ë32
 
	ms_jouº®_dev
;

1281 
__Ë32
 
	ms_Ï¡_Üphª
;

1282 
__Ë32
 
	ms_hash_£ed
[4];

1283 
__u8
 
	ms_def_hash_v”siÚ
;

1284 
__u8
 
	ms_jÆ_backup_ty³
;

1285 
__Ë16
 
	ms_desc_size
;

1286  
__Ë32
 
	ms_deçuÉ_mouÁ_İts
;

1287 
__Ë32
 
	ms_fœ¡_m‘a_bg
;

1288 
__Ë32
 
	ms_mkfs_time
;

1289 
__Ë32
 
	ms_jÆ_blocks
[17];

1291  
__Ë32
 
	ms_blocks_couÁ_hi
;

1292 
__Ë32
 
	ms_r_blocks_couÁ_hi
;

1293 
__Ë32
 
	ms_ä“_blocks_couÁ_hi
;

1294 
__Ë16
 
	ms_mš_exŒa_isize
;

1295 
__Ë16
 
	ms_wªt_exŒa_isize
;

1296 
__Ë32
 
	ms_æags
;

1297 
__Ë16
 
	ms_¿id_¡ride
;

1298 
__Ë16
 
	ms_mmp_upd©e_š‹rv®
;

1299 
__Ë64
 
	ms_mmp_block
;

1300 
__Ë32
 
	ms_¿id_¡re_width
;

1301 
__u8
 
	ms_log_groups_³r_æex
;

1302 
__u8
 
	ms_checksum_ty³
;

1303 
__u8
 
	ms_’üy±iÚ_Ëv–
;

1304 
__u8
 
	ms_»£rved_·d
;

1305 
__Ë64
 
	ms_kby‹s_wr™‹n
;

1306 
__Ë32
 
	ms_¢­shÙ_šum
;

1307 
__Ë32
 
	ms_¢­shÙ_id
;

1308 
__Ë64
 
	ms_¢­shÙ_r_blocks_couÁ
;

1310 
__Ë32
 
	ms_¢­shÙ_li¡
;

1312 
	#EXT4_S_ERR_START
 
	`off£tof
(
ext4_su³r_block
, 
s_”rÜ_couÁ
)

	)

1313 
__Ë32
 
	ms_”rÜ_couÁ
;

1314 
__Ë32
 
	ms_fœ¡_”rÜ_time
;

1315 
__Ë32
 
	ms_fœ¡_”rÜ_šo
;

1316 
__Ë64
 
	ms_fœ¡_”rÜ_block
;

1317 
__u8
 
	ms_fœ¡_”rÜ_func
[32] 
	m__nÚ¡ršg
;

1318 
__Ë32
 
	ms_fœ¡_”rÜ_lše
;

1319 
__Ë32
 
	ms_Ï¡_”rÜ_time
;

1320 
__Ë32
 
	ms_Ï¡_”rÜ_šo
;

1321 
__Ë32
 
	ms_Ï¡_”rÜ_lše
;

1322 
__Ë64
 
	ms_Ï¡_”rÜ_block
;

1323 
__u8
 
	ms_Ï¡_”rÜ_func
[32] 
	m__nÚ¡ršg
;

1324 
	#EXT4_S_ERR_END
 
	`off£tof
(
ext4_su³r_block
, 
s_mouÁ_İts
)

	)

1325 
__u8
 
	ms_mouÁ_İts
[64];

1326 
__Ë32
 
	ms_u¤_quÙa_šum
;

1327 
__Ë32
 
	ms_g½_quÙa_šum
;

1328 
__Ë32
 
	ms_ov”h—d_şu¡”s
;

1329 
__Ë32
 
	ms_backup_bgs
[2];

1330 
__u8
 
	ms_’üy±_®gos
[4];

1331 
__u8
 
	ms_’üy±_pw_§É
[16];

1332 
__Ë32
 
	ms_Íf_šo
;

1333 
__Ë32
 
	ms_´j_quÙa_šum
;

1334 
__Ë32
 
	ms_checksum_£ed
;

1335 
__u8
 
	ms_wtime_hi
;

1336 
__u8
 
	ms_mtime_hi
;

1337 
__u8
 
	ms_mkfs_time_hi
;

1338 
__u8
 
	ms_Ï¡check_hi
;

1339 
__u8
 
	ms_fœ¡_”rÜ_time_hi
;

1340 
__u8
 
	ms_Ï¡_”rÜ_time_hi
;

1341 
__u8
 
	ms_·d
[2];

1342 
__Ë16
 
	ms_’codšg
;

1343 
__Ë16
 
	ms_’codšg_æags
;

1344 
__Ë32
 
	ms_»£rved
[95];

1345 
__Ë32
 
	ms_checksum
;

1348 
	#EXT4_S_ERR_LEN
 (
EXT4_S_ERR_END
 - 
EXT4_S_ERR_START
)

	)

1350 #ifdeà
__KERNEL__


1355 
	#EXT4_MF_MNTDIR_SAMPLED
 0x0001

	)

1356 
	#EXT4_MF_FS_ABORTED
 0x0002

	)

1357 
	#EXT4_MF_TEST_DUMMY_ENCRYPTION
 0x0004

	)

1359 #ifdeà
CONFIG_FS_ENCRYPTION


1360 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
è(
	`uÆik–y
((sbi)->
s_mouÁ_æags
 & \

1361 
EXT4_MF_TEST_DUMMY_ENCRYPTION
))

	)

1363 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
è(0)

	)

1367 
	#EXT4_MAXQUOTAS
 3

	)

1369 
	#EXT4_ENC_UTF8_12_1
 1

	)

1374 
	#EXT4_ENC_STRICT_MODE_FL
 (1 << 0)

	)

1376 
	#ext4_has_¡riù_mode
(
sbi
) \

1377 (
sbi
->
s_’codšg_æags
 & 
EXT4_ENC_STRICT_MODE_FL
)

	)

1382 
	sext4_sb_šfo
 {

1383 
	ms_desc_size
;

1384 
	ms_šodes_³r_block
;

1385 
	ms_blocks_³r_group
;

1386 
	ms_şu¡”s_³r_group
;

1387 
	ms_šodes_³r_group
;

1388 
	ms_™b_³r_group
;

1389 
	ms_gdb_couÁ
;

1390 
	ms_desc_³r_block
;

1391 
ext4_group_t
 
	ms_groups_couÁ
;

1392 
ext4_group_t
 
	ms_blockfe_groups
;

1393 
	ms_ov”h—d
;

1394 
	ms_şu¡”_¿tio
;

1395 
	ms_şu¡”_b™s
;

1396 
loff_t
 
	ms_b™m­_maxby‹s
;

1397 
bufãr_h—d
 * 
	ms_sbh
;

1398 
ext4_su³r_block
 *
	ms_es
;

1399 
bufãr_h—d
 **
	ms_group_desc
;

1400 
	ms_mouÁ_İt
;

1401 
	ms_mouÁ_İt2
;

1402 
	ms_mouÁ_æags
;

1403 
	ms_def_mouÁ_İt
;

1404 
ext4_fsblk_t
 
	ms_sb_block
;

1405 
©omic64_t
 
	ms_»sv_şu¡”s
;

1406 
kuid_t
 
	ms_»suid
;

1407 
kgid_t
 
	ms_»sgid
;

1408 
	ms_mouÁ_¡©e
;

1409 
	ms_·d
;

1410 
	ms_addr_³r_block_b™s
;

1411 
	ms_desc_³r_block_b™s
;

1412 
	ms_šode_size
;

1413 
	ms_fœ¡_šo
;

1414 
	ms_šode_»adah—d_blks
;

1415 
	ms_šode_gßl
;

1416 
u32
 
	ms_hash_£ed
[4];

1417 
	ms_def_hash_v”siÚ
;

1418 
	ms_hash_unsigÃd
;

1419 
³rıu_couÁ”
 
	ms_ä“şu¡”s_couÁ”
;

1420 
³rıu_couÁ”
 
	ms_ä“šodes_couÁ”
;

1421 
³rıu_couÁ”
 
	ms_dœs_couÁ”
;

1422 
³rıu_couÁ”
 
	ms_dœtyşu¡”s_couÁ”
;

1423 
blockgroup_lock
 *
	ms_blockgroup_lock
;

1424 
´oc_dœ_’Œy
 *
	ms_´oc
;

1425 
kobjeù
 
	ms_kobj
;

1426 
com¶‘iÚ
 
	ms_kobj_uÄegi¡”
;

1427 
su³r_block
 *
	ms_sb
;

1428 #ifdeà
CONFIG_UNICODE


1429 
unicode_m­
 *
	ms_’codšg
;

1430 
__u16
 
	ms_’codšg_æags
;

1434 
jouº®_s
 *
	ms_jouº®
;

1435 
li¡_h—d
 
	ms_Üphª
;

1436 
mu‹x
 
	ms_Üphª_lock
;

1437 
	ms_ext4_æags
;

1438 
	ms_comm™_š‹rv®
;

1439 
u32
 
	ms_max_b©ch_time
;

1440 
u32
 
	ms_mš_b©ch_time
;

1441 
block_deviû
 *
	mjouº®_bdev
;

1442 #ifdeà
CONFIG_QUOTA


1444 
__rcu
 *
	ms_qf_Çmes
[
EXT4_MAXQUOTAS
];

1445 
	ms_jquÙa_fmt
;

1447 
	ms_wªt_exŒa_isize
;

1448 
ext4_sy¡em_blocks
 
__rcu
 *
	msy¡em_blks
;

1450 #ifdeà
EXTENTS_STATS


1452 
	ms_ext_mš
;

1453 
	ms_ext_max
;

1454 
	ms_d•th_max
;

1455 
¥šlock_t
 
	ms_ext_¡©s_lock
;

1456 
	ms_ext_blocks
;

1457 
	ms_ext_ex‹Ás
;

1461 
ext4_group_šfo
 ***
	ms_group_šfo
;

1462 
šode
 *
	ms_buddy_ÿche
;

1463 
¥šlock_t
 
	ms_md_lock
;

1464 *
	ms_mb_off£ts
;

1465 *
	ms_mb_maxs
;

1466 
	ms_group_šfo_size
;

1467 
	ms_mb_ä“_³ndšg
;

1468 
li¡_h—d
 
	ms_ä“d_d©a_li¡
;

1472 
	ms_¡re
;

1473 
	ms_mb_¡»am_»que¡
;

1474 
	ms_mb_max_to_sÿn
;

1475 
	ms_mb_mš_to_sÿn
;

1476 
	ms_mb_¡©s
;

1477 
	ms_mb_Üd”2_»qs
;

1478 
	ms_mb_group_´—Îoc
;

1479 
	ms_max_dœ_size_kb
;

1481 
	ms_mb_Ï¡_group
;

1482 
	ms_mb_Ï¡_¡¬t
;

1485 
©omic_t
 
	ms_b®_»qs
;

1486 
©omic_t
 
	ms_b®_sucûss
;

1487 
©omic_t
 
	ms_b®_®loÿ‹d
;

1488 
©omic_t
 
	ms_b®_ex_sÿÂed
;

1489 
©omic_t
 
	ms_b®_gßls
;

1490 
©omic_t
 
	ms_b®_b»aks
;

1491 
©omic_t
 
	ms_b®_2Üd”s
;

1492 
¥šlock_t
 
	ms_b®_lock
;

1493 
	ms_mb_budd›s_g’”©ed
;

1494 
	ms_mb_g’”©iÚ_time
;

1495 
©omic_t
 
	ms_mb_lo¡_chunks
;

1496 
©omic_t
 
	ms_mb_´—Îoÿ‹d
;

1497 
©omic_t
 
	ms_mb_disÿrded
;

1498 
©omic_t
 
	ms_lock_busy
;

1501 
ext4_loÿl™y_group
 
__³rıu
 *
	ms_loÿl™y_groups
;

1504 
	ms_£ùÜs_wr™‹n_¡¬t
;

1505 
u64
 
	ms_kby‹s_wr™‹n
;

1508 
	ms_ex‹Á_max_z”oout_kb
;

1510 
	ms_log_groups_³r_æex
;

1511 
æex_groups
 *
	ms_æex_groups
;

1512 
ext4_group_t
 
	ms_æex_groups_®loÿ‹d
;

1515 
wÜkqueue_¡ruù
 *
	mrsv_cÚv”siÚ_wq
;

1518 
tim”_li¡
 
	ms_”r_»pÜt
;

1521 
ext4_li_»que¡
 *
	ms_li_»que¡
;

1523 
	ms_li_wa™_muÉ
;

1526 
sk_¡ruù
 *
	ms_mmp_tsk
;

1529 
©omic_t
 
	ms_Ï¡_Œim_mšblks
;

1532 
üy±o_shash
 *
	ms_chksum_driv”
;

1535 
__u32
 
	ms_csum_£ed
;

1538 
shršk”
 
	ms_es_shršk”
;

1539 
li¡_h—d
 
	ms_es_li¡
;

1540 
	ms_es_Ä_šode
;

1541 
ext4_es_¡©s
 
	ms_es_¡©s
;

1542 
mb_ÿche
 *
	ms_—_block_ÿche
;

1543 
mb_ÿche
 *
	ms_—_šode_ÿche
;

1544 
¥šlock_t
 
s_es_lock
 
	m____ÿch–še_®igÃd_š_smp
;

1547 
¿‹lim™_¡©e
 
	ms_”r_¿‹lim™_¡©e
;

1548 
¿‹lim™_¡©e
 
	ms_w¬nšg_¿‹lim™_¡©e
;

1549 
¿‹lim™_¡©e
 
	ms_msg_¿‹lim™_¡©e
;

1552 
³rıu_rw_£m­hÜe
 
	ms_jouº®_æag_rw£m
;

1553 
dax_deviû
 *
	ms_daxdev
;

1556 
šlše
 
ext4_sb_šfo
 *
	$EXT4_SB
(
su³r_block
 *
sb
)

1558  
sb
->
s_fs_šfo
;

1559 
	}
}

1560 
šlše
 
ext4_šode_šfo
 *
	$EXT4_I
(
šode
 *inode)

1562  
	`cÚš”_of
(
šode
, 
ext4_šode_šfo
, 
vfs_šode
);

1563 
	}
}

1565 
šlše
 
	$ext4_v®id_šum
(
su³r_block
 *
sb
, 
šo
)

1567  
šo
 =ğ
EXT4_ROOT_INO
 ||

1568 (
šo
 >ğ
	`EXT4_FIRST_INO
(
sb
) &&

1569 
šo
 <ğ
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_šodes_couÁ
));

1570 
	}
}

1576 
	mEXT4_STATE_JDATA
,

1577 
	mEXT4_STATE_NEW
,

1578 
	mEXT4_STATE_XATTR
,

1579 
	mEXT4_STATE_NO_EXPAND
,

1580 
	mEXT4_STATE_DA_ALLOC_CLOSE
,

1581 
	mEXT4_STATE_EXT_MIGRATE
,

1582 
	mEXT4_STATE_DIO_UNWRITTEN
,

1583 
	mEXT4_STATE_NEWENTRY
,

1584 
	mEXT4_STATE_MAY_INLINE_DATA
,

1585 
	mEXT4_STATE_EXT_PRECACHED
,

1586 
	mEXT4_STATE_LUSTRE_EA_INODE
,

1587 
	mEXT4_STATE_VERITY_IN_PROGRESS
,

1590 
	#EXT4_INODE_BIT_FNS
(
Çme
, 
f›ld
, 
off£t
) \

1591 
šlše
 
ext4_‹¡_šode_
##
	`Çme
(
šode
 *šode, 
b™
) \

1593  
	`‹¡_b™
(
b™
 + (
off£t
), &
	`EXT4_I
(
šode
)->
i_
##
f›ld
); \

1595 
šlše
 
ext4_£t_šode_
##
	`Çme
(
šode
 *šode, 
b™
) \

1597 
	`£t_b™
(
b™
 + (
off£t
), &
	`EXT4_I
(
šode
)->
i_
##
f›ld
); \

1599 
šlše
 
ext4_ş—r_šode_
##
	`Çme
(
šode
 *šode, 
b™
) \

1601 
	`ş—r_b™
(
b™
 + (
off£t
), &
	`EXT4_I
(
šode
)->
i_
##
f›ld
); \

1602 }

	)

1606 
šlše
 
ext4_‹¡_šode_æag
(
šode
 *šode, 
b™
);

1607 
šlše
 
ext4_£t_šode_æag
(
šode
 *šode, 
b™
);

1608 
šlše
 
ext4_ş—r_šode_æag
(
šode
 *šode, 
b™
);

1609 
	$EXT4_INODE_BIT_FNS
(
æag
, 
æags
, 0)

1613 
šlše
 
	`ext4_‹¡_šode_¡©e
(
šode
 *šode, 
b™
);

1614 
šlše
 
	`ext4_£t_šode_¡©e
(
šode
 *šode, 
b™
);

1615 
šlše
 
	`ext4_ş—r_šode_¡©e
(
šode
 *šode, 
b™
);

1616 #ià(
BITS_PER_LONG
 < 64)

1617 
	$EXT4_INODE_BIT_FNS
(
¡©e
, 
¡©e_æags
, 0)

1619 
šlše
 
	$ext4_ş—r_¡©e_æags
(
ext4_šode_šfo
 *
ei
)

1621 (
ei
)->
i_¡©e_æags
 = 0;

1622 
	}
}

1624 
	$EXT4_INODE_BIT_FNS
(
¡©e
, 
æags
, 32)

1626 
šlše
 
	$ext4_ş—r_¡©e_æags
(
ext4_šode_šfo
 *
ei
)

1629 
	}
}

1635 
	#EXT4_SB
(
sb
è(sb)

	)

1638 
šlše
 
boŞ
 
	$ext4_v”™y_š_´og»ss
(
šode
 *inode)

1640  
	`IS_ENABLED
(
CONFIG_FS_VERITY
) &&

1641 
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_VERITY_IN_PROGRESS
);

1642 
	}
}

1644 
	#NEXT_ORPHAN
(
šode
è
	`EXT4_I
(šode)->
i_dtime


	)

1649 
	#EXT4_OS_LINUX
 0

	)

1650 
	#EXT4_OS_HURD
 1

	)

1651 
	#EXT4_OS_MASIX
 2

	)

1652 
	#EXT4_OS_FREEBSD
 3

	)

1653 
	#EXT4_OS_LITES
 4

	)

1658 
	#EXT4_GOOD_OLD_REV
 0

	)

1659 
	#EXT4_DYNAMIC_REV
 1

	)

1661 
	#EXT4_CURRENT_REV
 
EXT4_GOOD_OLD_REV


	)

1662 
	#EXT4_MAX_SUPP_REV
 
EXT4_DYNAMIC_REV


	)

1664 
	#EXT4_GOOD_OLD_INODE_SIZE
 128

	)

1666 
	#EXT4_EXTRA_TIMESTAMP_MAX
 (((
s64
)1 << 34è- 1 + 
S32_MIN
)

	)

1667 
	#EXT4_NON_EXTRA_TIMESTAMP_MAX
 
S32_MAX


	)

1668 
	#EXT4_TIMESTAMP_MIN
 
S32_MIN


	)

1674 
	#EXT4_FEATURE_COMPAT_DIR_PREALLOC
 0x0001

	)

1675 
	#EXT4_FEATURE_COMPAT_IMAGIC_INODES
 0x0002

	)

1676 
	#EXT4_FEATURE_COMPAT_HAS_JOURNAL
 0x0004

	)

1677 
	#EXT4_FEATURE_COMPAT_EXT_ATTR
 0x0008

	)

1678 
	#EXT4_FEATURE_COMPAT_RESIZE_INODE
 0x0010

	)

1679 
	#EXT4_FEATURE_COMPAT_DIR_INDEX
 0x0020

	)

1680 
	#EXT4_FEATURE_COMPAT_SPARSE_SUPER2
 0x0200

	)

1682 
	#EXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
 0x0001

	)

1683 
	#EXT4_FEATURE_RO_COMPAT_LARGE_FILE
 0x0002

	)

1684 
	#EXT4_FEATURE_RO_COMPAT_BTREE_DIR
 0x0004

	)

1685 
	#EXT4_FEATURE_RO_COMPAT_HUGE_FILE
 0x0008

	)

1686 
	#EXT4_FEATURE_RO_COMPAT_GDT_CSUM
 0x0010

	)

1687 
	#EXT4_FEATURE_RO_COMPAT_DIR_NLINK
 0x0020

	)

1688 
	#EXT4_FEATURE_RO_COMPAT_EXTRA_ISIZE
 0x0040

	)

1689 
	#EXT4_FEATURE_RO_COMPAT_QUOTA
 0x0100

	)

1690 
	#EXT4_FEATURE_RO_COMPAT_BIGALLOC
 0x0200

	)

1697 
	#EXT4_FEATURE_RO_COMPAT_METADATA_CSUM
 0x0400

	)

1698 
	#EXT4_FEATURE_RO_COMPAT_READONLY
 0x1000

	)

1699 
	#EXT4_FEATURE_RO_COMPAT_PROJECT
 0x2000

	)

1700 
	#EXT4_FEATURE_RO_COMPAT_VERITY
 0x8000

	)

1702 
	#EXT4_FEATURE_INCOMPAT_COMPRESSION
 0x0001

	)

1703 
	#EXT4_FEATURE_INCOMPAT_FILETYPE
 0x0002

	)

1704 
	#EXT4_FEATURE_INCOMPAT_RECOVER
 0x0004

	)

1705 
	#EXT4_FEATURE_INCOMPAT_JOURNAL_DEV
 0x0008

	)

1706 
	#EXT4_FEATURE_INCOMPAT_META_BG
 0x0010

	)

1707 
	#EXT4_FEATURE_INCOMPAT_EXTENTS
 0x0040

	)

1708 
	#EXT4_FEATURE_INCOMPAT_64BIT
 0x0080

	)

1709 
	#EXT4_FEATURE_INCOMPAT_MMP
 0x0100

	)

1710 
	#EXT4_FEATURE_INCOMPAT_FLEX_BG
 0x0200

	)

1711 
	#EXT4_FEATURE_INCOMPAT_EA_INODE
 0x0400

	)

1712 
	#EXT4_FEATURE_INCOMPAT_DIRDATA
 0x1000

	)

1713 
	#EXT4_FEATURE_INCOMPAT_CSUM_SEED
 0x2000

	)

1714 
	#EXT4_FEATURE_INCOMPAT_LARGEDIR
 0x4000

	)

1715 
	#EXT4_FEATURE_INCOMPAT_INLINE_DATA
 0x8000

	)

1716 
	#EXT4_FEATURE_INCOMPAT_ENCRYPT
 0x10000

	)

1717 
	#EXT4_FEATURE_INCOMPAT_CASEFOLD
 0x20000

	)

1719 
ext4_upd©e_dyÇmic_»v
(
su³r_block
 *
sb
);

1721 
	#EXT4_FEATURE_COMPAT_FUNCS
(
Çme
, 
æagÇme
) \

1722 
šlše
 
boŞ
 
ext4_has_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1724  ((
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_com·t
 & \

1725 
	`ıu_to_Ë32
(
EXT4_FEATURE_COMPAT_
##
æagÇme
)) != 0); \

1727 
šlše
 
ext4_£t_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1729 
	`ext4_upd©e_dyÇmic_»v
(
sb
); \

1730 
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_com·t
 |= \

1731 
	`ıu_to_Ë32
(
EXT4_FEATURE_COMPAT_
##
æagÇme
); \

1733 
šlše
 
ext4_ş—r_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1735 
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_com·t
 &= \

1736 ~
	`ıu_to_Ë32
(
EXT4_FEATURE_COMPAT_
##
æagÇme
); \

1737 }

	)

1739 
	#EXT4_FEATURE_RO_COMPAT_FUNCS
(
Çme
, 
æagÇme
) \

1740 
šlše
 
boŞ
 
ext4_has_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1742  ((
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_ro_com·t
 & \

1743 
	`ıu_to_Ë32
(
EXT4_FEATURE_RO_COMPAT_
##
æagÇme
)) != 0); \

1745 
šlše
 
ext4_£t_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1747 
	`ext4_upd©e_dyÇmic_»v
(
sb
); \

1748 
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_ro_com·t
 |= \

1749 
	`ıu_to_Ë32
(
EXT4_FEATURE_RO_COMPAT_
##
æagÇme
); \

1751 
šlše
 
ext4_ş—r_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1753 
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_ro_com·t
 &= \

1754 ~
	`ıu_to_Ë32
(
EXT4_FEATURE_RO_COMPAT_
##
æagÇme
); \

1755 }

	)

1757 
	#EXT4_FEATURE_INCOMPAT_FUNCS
(
Çme
, 
æagÇme
) \

1758 
šlše
 
boŞ
 
ext4_has_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1760  ((
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_šcom·t
 & \

1761 
	`ıu_to_Ë32
(
EXT4_FEATURE_INCOMPAT_
##
æagÇme
)) != 0); \

1763 
šlše
 
ext4_£t_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1765 
	`ext4_upd©e_dyÇmic_»v
(
sb
); \

1766 
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_šcom·t
 |= \

1767 
	`ıu_to_Ë32
(
EXT4_FEATURE_INCOMPAT_
##
æagÇme
); \

1769 
šlše
 
ext4_ş—r_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1771 
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_šcom·t
 &= \

1772 ~
	`ıu_to_Ë32
(
EXT4_FEATURE_INCOMPAT_
##
æagÇme
); \

1773 }

	)

1775 
	$EXT4_FEATURE_COMPAT_FUNCS
(
dœ_´—Îoc
, 
DIR_PREALLOC
)

1776 
	$EXT4_FEATURE_COMPAT_FUNCS
(
imagic_šodes
, 
IMAGIC_INODES
)

1777 
	$EXT4_FEATURE_COMPAT_FUNCS
(
jouº®
, 
HAS_JOURNAL
)

1778 
	$EXT4_FEATURE_COMPAT_FUNCS
(
x©Œ
, 
EXT_ATTR
)

1779 
	$EXT4_FEATURE_COMPAT_FUNCS
(
»size_šode
, 
RESIZE_INODE
)

1780 
	$EXT4_FEATURE_COMPAT_FUNCS
(
dœ_šdex
, 
DIR_INDEX
)

1781 
	$EXT4_FEATURE_COMPAT_FUNCS
(
¥¬£_su³r2
, 
SPARSE_SUPER2
)

1783 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
¥¬£_su³r
, 
SPARSE_SUPER
)

1784 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
Ïrge_fe
, 
LARGE_FILE
)

1785 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
bŒ“_dœ
, 
BTREE_DIR
)

1786 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
huge_fe
, 
HUGE_FILE
)

1787 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
gdt_csum
, 
GDT_CSUM
)

1788 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
dœ_Æšk
, 
DIR_NLINK
)

1789 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
exŒa_isize
, 
EXTRA_ISIZE
)

1790 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
quÙa
, 
QUOTA
)

1791 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
big®loc
, 
BIGALLOC
)

1792 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
m‘ad©a_csum
, 
METADATA_CSUM
)

1793 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
»adÚly
, 
READONLY
)

1794 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
´ojeù
, 
PROJECT
)

1795 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
v”™y
, 
VERITY
)

1797 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
com´essiÚ
, 
COMPRESSION
)

1798 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
f‘y³
, 
FILETYPE
)

1799 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
jouº®_Ãeds_»cov”y
, 
RECOVER
)

1800 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
jouº®_dev
, 
JOURNAL_DEV
)

1801 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
m‘a_bg
, 
META_BG
)

1802 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
ex‹Ás
, 
EXTENTS
)

1803 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(64b
™
, 64B
IT
)

1804 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
mmp
, 
MMP
)

1805 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
æex_bg
, 
FLEX_BG
)

1806 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
—_šode
, 
EA_INODE
)

1807 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
dœd©a
, 
DIRDATA
)

1808 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
csum_£ed
, 
CSUM_SEED
)

1809 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
Ïrgedœ
, 
LARGEDIR
)

1810 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
šlše_d©a
, 
INLINE_DATA
)

1811 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
’üy±
, 
ENCRYPT
)

1812 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
ÿ£fŞd
, 
CASEFOLD
)

1814 
	#EXT2_FEATURE_COMPAT_SUPP
 
EXT4_FEATURE_COMPAT_EXT_ATTR


	)

1815 
	#EXT2_FEATURE_INCOMPAT_SUPP
 (
EXT4_FEATURE_INCOMPAT_FILETYPE
| \

1816 
EXT4_FEATURE_INCOMPAT_META_BG
)

	)

1817 
	#EXT2_FEATURE_RO_COMPAT_SUPP
 (
EXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1818 
EXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1819 
EXT4_FEATURE_RO_COMPAT_BTREE_DIR
)

	)

1821 
	#EXT3_FEATURE_COMPAT_SUPP
 
EXT4_FEATURE_COMPAT_EXT_ATTR


	)

1822 
	#EXT3_FEATURE_INCOMPAT_SUPP
 (
EXT4_FEATURE_INCOMPAT_FILETYPE
| \

1823 
EXT4_FEATURE_INCOMPAT_RECOVER
| \

1824 
EXT4_FEATURE_INCOMPAT_META_BG
)

	)

1825 
	#EXT3_FEATURE_RO_COMPAT_SUPP
 (
EXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1826 
EXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1827 
EXT4_FEATURE_RO_COMPAT_BTREE_DIR
)

	)

1829 
	#EXT4_FEATURE_COMPAT_SUPP
 
EXT4_FEATURE_COMPAT_EXT_ATTR


	)

1830 
	#EXT4_FEATURE_INCOMPAT_SUPP
 (
EXT4_FEATURE_INCOMPAT_FILETYPE
| \

1831 
EXT4_FEATURE_INCOMPAT_RECOVER
| \

1832 
EXT4_FEATURE_INCOMPAT_META_BG
| \

1833 
EXT4_FEATURE_INCOMPAT_EXTENTS
| \

1834 
EXT4_FEATURE_INCOMPAT_64BIT
| \

1835 
EXT4_FEATURE_INCOMPAT_FLEX_BG
| \

1836 
EXT4_FEATURE_INCOMPAT_EA_INODE
| \

1837 
EXT4_FEATURE_INCOMPAT_MMP
 | \

1838 
EXT4_FEATURE_INCOMPAT_INLINE_DATA
 | \

1839 
EXT4_FEATURE_INCOMPAT_ENCRYPT
 | \

1840 
EXT4_FEATURE_INCOMPAT_CASEFOLD
 | \

1841 
EXT4_FEATURE_INCOMPAT_CSUM_SEED
 | \

1842 
EXT4_FEATURE_INCOMPAT_LARGEDIR
)

	)

1843 
	#EXT4_FEATURE_RO_COMPAT_SUPP
 (
EXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1844 
EXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1845 
EXT4_FEATURE_RO_COMPAT_GDT_CSUM
| \

1846 
EXT4_FEATURE_RO_COMPAT_DIR_NLINK
 | \

1847 
EXT4_FEATURE_RO_COMPAT_EXTRA_ISIZE
 | \

1848 
EXT4_FEATURE_RO_COMPAT_BTREE_DIR
 |\

1849 
EXT4_FEATURE_RO_COMPAT_HUGE_FILE
 |\

1850 
EXT4_FEATURE_RO_COMPAT_BIGALLOC
 |\

1851 
EXT4_FEATURE_RO_COMPAT_METADATA_CSUM
|\

1852 
EXT4_FEATURE_RO_COMPAT_QUOTA
 |\

1853 
EXT4_FEATURE_RO_COMPAT_PROJECT
 |\

1854 
EXT4_FEATURE_RO_COMPAT_VERITY
)

	)

1856 
	#EXTN_FEATURE_FUNCS
(
v”
) \

1857 
šlše
 
boŞ
 
ext4_has_unknown_ext
##
v”
##
	`_com·t_ã©u»s
(
su³r_block
 *
sb
) \

1859  ((
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_com·t
 & \

1860 
	`ıu_to_Ë32
(~
EXT
##
v”
##
_FEATURE_COMPAT_SUPP
)) != 0); \

1861 
	}
} \

1862 
šlše
 
boŞ
 
ext4_has_unknown_ext
##
v”
##
	`_ro_com·t_ã©u»s
(
su³r_block
 *
sb
) \

1864  ((
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_ro_com·t
 & \

1865 
	`ıu_to_Ë32
(~
EXT
##
v”
##
_FEATURE_RO_COMPAT_SUPP
)) != 0); \

1867 
šlše
 
boŞ
 
ext4_has_unknown_ext
##
v”
##
	`_šcom·t_ã©u»s
(
su³r_block
 *
sb
) \

1869  ((
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_šcom·t
 & \

1870 
	`ıu_to_Ë32
(~
EXT
##
v”
##
_FEATURE_INCOMPAT_SUPP
)) != 0); \

1871 }

	)

1873 
	$EXTN_FEATURE_FUNCS
(2)

1874 
	$EXTN_FEATURE_FUNCS
(3)

1875 
	$EXTN_FEATURE_FUNCS
(4)

1877 
šlše
 
boŞ
 
	$ext4_has_com·t_ã©u»s
(
su³r_block
 *
sb
)

1879  (
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_com·t
 != 0);

1880 
	}
}

1881 
šlše
 
boŞ
 
	$ext4_has_ro_com·t_ã©u»s
(
su³r_block
 *
sb
)

1883  (
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_ro_com·t
 != 0);

1884 
	}
}

1885 
šlše
 
boŞ
 
	$ext4_has_šcom·t_ã©u»s
(
su³r_block
 *
sb
)

1887  (
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_šcom·t
 != 0);

1888 
	}
}

1893 
	#EXT4_FLAGS_RESIZING
 0

	)

1894 
	#EXT4_FLAGS_SHUTDOWN
 1

	)

1896 
šlše
 
	$ext4_fÜûd_shutdown
(
ext4_sb_šfo
 *
sbi
)

1898  
	`‹¡_b™
(
EXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_ext4_æags
);

1899 
	}
}

1905 
	#EXT4_DEF_RESUID
 0

	)

1906 
	#EXT4_DEF_RESGID
 0

	)

1911 
	#EXT4_DEF_PROJID
 0

	)

1913 
	#EXT4_DEF_INODE_READAHEAD_BLKS
 32

	)

1918 
	#EXT4_DEFM_DEBUG
 0x0001

	)

1919 
	#EXT4_DEFM_BSDGROUPS
 0x0002

	)

1920 
	#EXT4_DEFM_XATTR_USER
 0x0004

	)

1921 
	#EXT4_DEFM_ACL
 0x0008

	)

1922 
	#EXT4_DEFM_UID16
 0x0010

	)

1923 
	#EXT4_DEFM_JMODE
 0x0060

	)

1924 
	#EXT4_DEFM_JMODE_DATA
 0x0020

	)

1925 
	#EXT4_DEFM_JMODE_ORDERED
 0x0040

	)

1926 
	#EXT4_DEFM_JMODE_WBACK
 0x0060

	)

1927 
	#EXT4_DEFM_NOBARRIER
 0x0100

	)

1928 
	#EXT4_DEFM_BLOCK_VALIDITY
 0x0200

	)

1929 
	#EXT4_DEFM_DISCARD
 0x0400

	)

1930 
	#EXT4_DEFM_NODELALLOC
 0x0800

	)

1935 
	#EXT4_DEF_MIN_BATCH_TIME
 0

	)

1936 
	#EXT4_DEF_MAX_BATCH_TIME
 15000

	)

1942 
	#EXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
 4

	)

1947 
	#EXT4_NAME_LEN
 255

	)

1949 
	sext4_dœ_’Œy
 {

1950 
__Ë32
 
	mšode
;

1951 
__Ë16
 
	m»c_Ën
;

1952 
__Ë16
 
	mÇme_Ën
;

1953 
	mÇme
[
EXT4_NAME_LEN
];

1962 
	sext4_dœ_’Œy_2
 {

1963 
__Ë32
 
	mšode
;

1964 
__Ë16
 
	m»c_Ën
;

1965 
__u8
 
	mÇme_Ën
;

1966 
__u8
 
	mfe_ty³
;

1967 
	mÇme
[
EXT4_NAME_LEN
];

1974 
	sext4_dœ_’Œy_
 {

1975 
__Ë32
 
	md‘_»£rved_z”o1
;

1976 
__Ë16
 
	md‘_»c_Ën
;

1977 
__u8
 
	md‘_»£rved_z”o2
;

1978 
__u8
 
	md‘_»£rved_á
;

1979 
__Ë32
 
	md‘_checksum
;

1982 
	#EXT4_DIRENT_TAIL
(
block
, 
blocksize
) \

1983 ((
ext4_dœ_’Œy_
 *)(((*)(
block
)) + \

1984 ((
blocksize
) - \

1985 (
ext4_dœ_’Œy_
))))

	)

1991 
	#EXT4_FT_UNKNOWN
 0

	)

1992 
	#EXT4_FT_REG_FILE
 1

	)

1993 
	#EXT4_FT_DIR
 2

	)

1994 
	#EXT4_FT_CHRDEV
 3

	)

1995 
	#EXT4_FT_BLKDEV
 4

	)

1996 
	#EXT4_FT_FIFO
 5

	)

1997 
	#EXT4_FT_SOCK
 6

	)

1998 
	#EXT4_FT_SYMLINK
 7

	)

2000 
	#EXT4_FT_MAX
 8

	)

2002 
	#EXT4_FT_DIR_CSUM
 0xDE

	)

2009 
	#EXT4_DIR_PAD
 4

	)

2010 
	#EXT4_DIR_ROUND
 (
EXT4_DIR_PAD
 - 1)

	)

2011 
	#EXT4_DIR_REC_LEN
(
Çme_Ën
è((Òame_Ënè+ 8 + 
EXT4_DIR_ROUND
) & \

2012 ~
EXT4_DIR_ROUND
)

	)

2013 
	#EXT4_MAX_REC_LEN
 ((1<<16)-1)

	)

2019 
šlše
 

2020 
	$ext4_»c_Ën_äom_disk
(
__Ë16
 
dËn
, 
blocksize
)

2022 
Ën
 = 
	`Ë16_to_ıu
(
dËn
);

2024 #ià(
PAGE_SIZE
 >= 65536)

2025 ià(
Ën
 =ğ
EXT4_MAX_REC_LEN
 ||†en == 0)

2026  
blocksize
;

2027  (
Ën
 & 65532) | ((len & 3) << 16);

2029  
Ën
;

2031 
	}
}

2033 
šlše
 
__Ë16
 
	$ext4_»c_Ën_to_disk
(
Ën
, 
blocksize
)

2035 ià((
Ën
 > 
blocksize
) || (blocksize > (1 << 18)) || (len & 3))

2036 
	`BUG
();

2037 #ià(
PAGE_SIZE
 >= 65536)

2038 ià(
Ën
 < 65536)

2039  
	`ıu_to_Ë16
(
Ën
);

2040 ià(
Ën
 =ğ
blocksize
) {

2041 ià(
blocksize
 == 65536)

2042  
	`ıu_to_Ë16
(
EXT4_MAX_REC_LEN
);

2044  
	`ıu_to_Ë16
(0);

2046  
	`ıu_to_Ë16
((
Ën
 & 65532) | ((len >> 16) & 3));

2048  
	`ıu_to_Ë16
(
Ën
);

2050 
	}
}

2057 
	#is_dx
(
dœ
è(
	`ext4_has_ã©u»_dœ_šdex
((dœ)->
i_sb
) && \

2058 
	`ext4_‹¡_šode_æag
((
dœ
), 
EXT4_INODE_INDEX
))

	)

2059 
	#EXT4_DIR_LINK_MAX
(
dœ
è
	`uÆik–y
((dœ)->
i_Æšk
 >ğ
EXT4_LINK_MAX
 && \

2060 !(
	`ext4_has_ã©u»_dœ_Æšk
((
dœ
)->
i_sb
è&& 
	`is_dx
(dœ)))

	)

2061 
	#EXT4_DIR_LINK_EMPTY
(
dœ
è((dœ)->
i_Æšk
 =ğ2 || (dœ)->i_Æšk =ğ1)

	)

2065 
	#DX_HASH_LEGACY
 0

	)

2066 
	#DX_HASH_HALF_MD4
 1

	)

2067 
	#DX_HASH_TEA
 2

	)

2068 
	#DX_HASH_LEGACY_UNSIGNED
 3

	)

2069 
	#DX_HASH_HALF_MD4_UNSIGNED
 4

	)

2070 
	#DX_HASH_TEA_UNSIGNED
 5

	)

2072 
šlše
 
u32
 
	$ext4_chksum
(
ext4_sb_šfo
 *
sbi
, 
u32
 
üc
,

2073 cÚ¡ *
add»ss
, 
Ëngth
)

2076 
shash_desc
 
shash
;

2077 
ùx
[4];

2078 } 
desc
;

2080 
	`BUG_ON
(
	`üy±o_shash_descsize
(
sbi
->
s_chksum_driv”
)!=(
desc
.
ùx
));

2082 
desc
.
shash
.
tfm
 = 
sbi
->
s_chksum_driv”
;

2083 *(
u32
 *)
desc
.
ùx
 = 
üc
;

2085 
	`BUG_ON
(
	`üy±o_shash_upd©e
(&
desc
.
shash
, 
add»ss
, 
Ëngth
));

2087  *(
u32
 *)
desc
.
ùx
;

2088 
	}
}

2090 #ifdeà
__KERNEL__


2093 
	sdx_hash_šfo


2095 
u32
 
	mhash
;

2096 
u32
 
	mmšÜ_hash
;

2097 
	mhash_v”siÚ
;

2098 
u32
 *
	m£ed
;

2103 
	#EXT4_HTREE_EOF_32BIT
 ((1UL << (32 - 1)è- 1)

	)

2104 
	#EXT4_HTREE_EOF_64BIT
 ((1ULL << (64 - 1)è- 1)

	)

2110 
	#HASH_NB_ALWAYS
 1

	)

2112 
	sext4_f’ame
 {

2113 cÚ¡ 
q¡r
 *
	mu¤_âame
;

2114 
fsüy±_¡r
 
	mdisk_Çme
;

2115 
dx_hash_šfo
 
	mhšfo
;

2116 #ifdeà
CONFIG_FS_ENCRYPTION


2117 
fsüy±_¡r
 
	müy±o_buf
;

2119 #ifdeà
CONFIG_UNICODE


2120 
fsüy±_¡r
 
	mcf_Çme
;

2124 
	#âame_Çme
(
p
è(Õ)->
disk_Çme
.
Çme
)

	)

2125 
	#âame_Ën
(
p
è(Õ)->
disk_Çme
.
Ën
)

	)

2130 
	sext4_oc


2132 
bufãr_h—d
 *
	mbh
;

2133 
	moff£t
;

2134 
ext4_group_t
 
	mblock_group
;

2137 
šlše
 
ext4_šode
 *
	$ext4_¿w_šode
(
ext4_oc
 *
oc
)

2139  (
ext4_šode
 *è(
oc
->
bh
->
b_d©a
 + iloc->
off£t
);

2140 
	}
}

2142 
šlše
 
boŞ
 
	$ext4_is_quÙa_fe
(
šode
 *inode)

2144  
	`IS_NOQUOTA
(
šode
) &&

2145 !(
	`EXT4_I
(
šode
)->
i_æags
 & 
EXT4_EA_INODE_FL
);

2146 
	}
}

2153 
	sdœ_´iv©e_šfo
 {

2154 
rb_roÙ
 
	mroÙ
;

2155 
rb_node
 *
	mcu¼_node
;

2156 
âame
 *
	mexŒa_âame
;

2157 
loff_t
 
	mÏ¡_pos
;

2158 
__u32
 
	mcu¼_hash
;

2159 
__u32
 
	mcu¼_mšÜ_hash
;

2160 
__u32
 
	mÃxt_hash
;

2164 
šlše
 
ext4_fsblk_t


2165 
	$ext4_group_fœ¡_block_no
(
su³r_block
 *
sb
, 
ext4_group_t
 
group_no
)

2167  
group_no
 * (
ext4_fsblk_t
)
	`EXT4_BLOCKS_PER_GROUP
(
sb
) +

2168 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_fœ¡_d©a_block
);

2169 
	}
}

2174 
	#ERR_BAD_DX_DIR
 (-(
MAX_ERRNO
 - 1))

	)

2177 
	#EXT4_HTREE_LEVEL_COMPAT
 2

	)

2178 
	#EXT4_HTREE_LEVEL
 3

	)

2180 
šlše
 
	$ext4_dœ_hŒ“_Ëv–
(
su³r_block
 *
sb
)

2182  
	`ext4_has_ã©u»_Ïrgedœ
(
sb
) ?

2183 
EXT4_HTREE_LEVEL
 : 
EXT4_HTREE_LEVEL_COMPAT
;

2184 
	}
}

2189 
	#EXT4_DEF_LI_WAIT_MULT
 10

	)

2190 
	#EXT4_DEF_LI_MAX_START_DELAY
 5

	)

2191 
	#EXT4_LAZYINIT_QUIT
 0x0001

	)

2192 
	#EXT4_LAZYINIT_RUNNING
 0x0002

	)

2197 
	sext4_Ïzy_š™
 {

2198 
	mli_¡©e
;

2199 
li¡_h—d
 
	mli_»que¡_li¡
;

2200 
mu‹x
 
	mli_li¡_mtx
;

2203 
	sext4_li_»que¡
 {

2204 
su³r_block
 *
	mÌ_su³r
;

2205 
ext4_sb_šfo
 *
	mÌ_sbi
;

2206 
ext4_group_t
 
	mÌ_Ãxt_group
;

2207 
li¡_h—d
 
	mÌ_»que¡
;

2208 
	mÌ_Ãxt_sched
;

2209 
	mÌ_timeout
;

2212 
	sext4_ã©u»s
 {

2213 
kobjeù
 
	mf_kobj
;

2214 
com¶‘iÚ
 
	mf_kobj_uÄegi¡”
;

2224 
	#EXT4_MMP_MAGIC
 0x004D4D50U

	)

2225 
	#EXT4_MMP_SEQ_CLEAN
 0xFF4D4D50U

	)

2226 
	#EXT4_MMP_SEQ_FSCK
 0xE24D4D50U

	)

2227 
	#EXT4_MMP_SEQ_MAX
 0xE24D4D4FU

	)

2229 
	smmp_¡ruù
 {

2230 
__Ë32
 
	mmmp_magic
;

2231 
__Ë32
 
	mmmp_£q
;

2237 
__Ë64
 
	mmmp_time
;

2238 
	mmmp_nod’ame
[64];

2239 
	mmmp_bdevÇme
[32];

2246 
__Ë16
 
	mmmp_check_š‹rv®
;

2248 
__Ë16
 
	mmmp_·d1
;

2249 
__Ë32
 
	mmmp_·d2
[226];

2250 
__Ë32
 
	mmmp_checksum
;

2254 
	smmpd_d©a
 {

2255 
bufãr_h—d
 *
	mbh
;

2256 
su³r_block
 *
	msb
;

2267 
	#EXT4_MMP_CHECK_MULT
 2UL

	)

2272 
	#EXT4_MMP_MIN_CHECK_INTERVAL
 5UL

	)

2277 
	#EXT4_MMP_MAX_CHECK_INTERVAL
 300UL

	)

2287 
	#NORET_TYPE


	)

2288 
	#ATTRIB_NORET
 
	`__©Œibu‹__
((
nÜ‘uº
))

	)

2289 
	#NORET_AND
 
nÜ‘uº
,

	)

2292 
ext4_couÁ_ä“
(*
b™m­
, 
numch¬s
);

2293 
ext4_šode_b™m­_csum_£t
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

2294 
ext4_group_desc
 *
gdp
,

2295 
bufãr_h—d
 *
bh
, 
sz
);

2296 
ext4_šode_b™m­_csum_v”ify
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

2297 
ext4_group_desc
 *
gdp
,

2298 
bufãr_h—d
 *
bh
, 
sz
);

2299 
ext4_block_b™m­_csum_£t
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

2300 
ext4_group_desc
 *
gdp
,

2301 
bufãr_h—d
 *
bh
);

2302 
ext4_block_b™m­_csum_v”ify
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

2303 
ext4_group_desc
 *
gdp
,

2304 
bufãr_h—d
 *
bh
);

2307 
ext4_g‘_group_no_ªd_off£t
(
su³r_block
 *
sb
,

2308 
ext4_fsblk_t
 
blockÄ
,

2309 
ext4_group_t
 *
blockg½p
,

2310 
ext4_g½blk_t
 *
off£
);

2311 
ext4_group_t
 
ext4_g‘_group_numb”
(
su³r_block
 *
sb
,

2312 
ext4_fsblk_t
 
block
);

2314 
ext4_block_group
(
su³r_block
 *
sb
,

2315 
ext4_fsblk_t
 
blockÄ
);

2316 
ext4_g½blk_t
 
ext4_block_group_off£t
(
su³r_block
 *
sb
,

2317 
ext4_fsblk_t
 
blockÄ
);

2318 
ext4_bg_has_su³r
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
);

2319 
ext4_bg_num_gdb
(
su³r_block
 *
sb
,

2320 
ext4_group_t
 
group
);

2321 
ext4_fsblk_t
 
ext4_Ãw_m‘a_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2322 
ext4_fsblk_t
 
gßl
,

2323 
æags
,

2324 *
couÁ
,

2325 *
”½
);

2326 
ext4_şaim_ä“_şu¡”s
(
ext4_sb_šfo
 *
sbi
,

2327 
s64
 
nşu¡”s
, 
æags
);

2328 
ext4_fsblk_t
 
ext4_couÁ_ä“_şu¡”s
(
su³r_block
 *);

2329 
ext4_check_blocks_b™m­
(
su³r_block
 *);

2330 
ext4_group_desc
 * 
ext4_g‘_group_desc
(
su³r_block
 * 
sb
,

2331 
ext4_group_t
 
block_group
,

2332 
bufãr_h—d
 ** 
bh
);

2333 
ext4_should_»Œy_®loc
(
su³r_block
 *
sb
, *
»Œ›s
);

2335 
bufãr_h—d
 *
ext4_»ad_block_b™m­_nowa™
(
su³r_block
 *
sb
,

2336 
ext4_group_t
 
block_group
);

2337 
ext4_wa™_block_b™m­
(
su³r_block
 *
sb
,

2338 
ext4_group_t
 
block_group
,

2339 
bufãr_h—d
 *
bh
);

2340 
bufãr_h—d
 *
ext4_»ad_block_b™m­
(
su³r_block
 *
sb
,

2341 
ext4_group_t
 
block_group
);

2342 
ext4_ä“_şu¡”s_aá”_š™
(
su³r_block
 *
sb
,

2343 
ext4_group_t
 
block_group
,

2344 
ext4_group_desc
 *
gdp
);

2345 
ext4_fsblk_t
 
ext4_šode_to_gßl_block
(
šode
 *);

2347 #ifdeà
CONFIG_UNICODE


2348 
ext4_âame_£tup_ci_f’ame
(
šode
 *
dœ
,

2349 cÚ¡ 
q¡r
 *
šame
,

2350 
fsüy±_¡r
 *
âame
);

2353 #ifdeà
CONFIG_FS_ENCRYPTION


2354 
šlše
 
	$ext4_âame_äom_fsüy±_Çme
(
ext4_f’ame
 *
d¡
,

2355 cÚ¡ 
fsüy±_Çme
 *
¤c
)

2357 
	`mem£t
(
d¡
, 0, (*dst));

2359 
d¡
->
u¤_âame
 = 
¤c
->usr_fname;

2360 
d¡
->
disk_Çme
 = 
¤c
->disk_name;

2361 
d¡
->
hšfo
.
hash
 = 
¤c
->hash;

2362 
d¡
->
hšfo
.
mšÜ_hash
 = 
¤c
->minor_hash;

2363 
d¡
->
üy±o_buf
 = 
¤c
->crypto_buf;

2364 
	}
}

2366 
šlše
 
	$ext4_âame_£tup_f’ame
(
šode
 *
dœ
,

2367 cÚ¡ 
q¡r
 *
šame
,

2368 
lookup
,

2369 
ext4_f’ame
 *
âame
)

2371 
fsüy±_Çme
 
Çme
;

2372 
”r
;

2374 
”r
 = 
	`fsüy±_£tup_f’ame
(
dœ
, 
šame
, 
lookup
, &
Çme
);

2375 ià(
”r
)

2376  
”r
;

2378 
	`ext4_âame_äom_fsüy±_Çme
(
âame
, &
Çme
);

2380 #ifdeà
CONFIG_UNICODE


2381 
	`ext4_âame_£tup_ci_f’ame
(
dœ
, 
šame
, &
âame
->
cf_Çme
);

2384 
	}
}

2386 
šlše
 
	$ext4_âame_´•¬e_lookup
(
šode
 *
dœ
,

2387 
d’Œy
 *dentry,

2388 
ext4_f’ame
 *
âame
)

2390 
fsüy±_Çme
 
Çme
;

2391 
”r
;

2393 
”r
 = 
	`fsüy±_´•¬e_lookup
(
dœ
, 
d’Œy
, &
Çme
);

2394 ià(
”r
)

2395  
”r
;

2397 
	`ext4_âame_äom_fsüy±_Çme
(
âame
, &
Çme
);

2399 #ifdeà
CONFIG_UNICODE


2400 
	`ext4_âame_£tup_ci_f’ame
(
dœ
, &
d’Œy
->
d_Çme
, &
âame
->
cf_Çme
);

2403 
	}
}

2405 
šlše
 
	$ext4_âame_ä“_f’ame
(
ext4_f’ame
 *
âame
)

2407 
fsüy±_Çme
 
Çme
;

2409 
Çme
.
üy±o_buf
 = 
âame
->crypto_buf;

2410 
	`fsüy±_ä“_f’ame
(&
Çme
);

2412 
âame
->
üy±o_buf
.
Çme
 = 
NULL
;

2413 
âame
->
u¤_âame
 = 
NULL
;

2414 
âame
->
disk_Çme
.
Çme
 = 
NULL
;

2416 #ifdeà
CONFIG_UNICODE


2417 
	`kä“
(
âame
->
cf_Çme
.
Çme
);

2418 
âame
->
cf_Çme
.
Çme
 = 
NULL
;

2420 
	}
}

2422 
šlše
 
	$ext4_âame_£tup_f’ame
(
šode
 *
dœ
,

2423 cÚ¡ 
q¡r
 *
šame
,

2424 
lookup
,

2425 
ext4_f’ame
 *
âame
)

2427 
âame
->
u¤_âame
 = 
šame
;

2428 
âame
->
disk_Çme
.
Çme
 = (*è
šame
->name;

2429 
âame
->
disk_Çme
.
Ën
 = 
šame
->len;

2431 #ifdeà
CONFIG_UNICODE


2432 
	`ext4_âame_£tup_ci_f’ame
(
dœ
, 
šame
, &
âame
->
cf_Çme
);

2436 
	}
}

2438 
šlše
 
	$ext4_âame_´•¬e_lookup
(
šode
 *
dœ
,

2439 
d’Œy
 *dentry,

2440 
ext4_f’ame
 *
âame
)

2442  
	`ext4_âame_£tup_f’ame
(
dœ
, &
d’Œy
->
d_Çme
, 1, 
âame
);

2443 
	}
}

2445 
šlše
 
	$ext4_âame_ä“_f’ame
(
ext4_f’ame
 *
âame
)

2447 #ifdeà
CONFIG_UNICODE


2448 
	`kä“
(
âame
->
cf_Çme
.
Çme
);

2449 
âame
->
cf_Çme
.
Çme
 = 
NULL
;

2451 
	}
}

2455 
__ext4_check_dœ_’Œy
(cÚ¡ *, , 
šode
 *,

2456 
fe
 *,

2457 
ext4_dœ_’Œy_2
 *,

2458 
bufãr_h—d
 *, *, ,

2460 
	#ext4_check_dœ_’Œy
(
dœ
, 
fp
, 
de
, 
bh
, 
buf
, 
size
, 
off£t
) \

2461 
	`uÆik–y
(
	`__ext4_check_dœ_’Œy
(
__func__
, 
__LINE__
, (
dœ
), (
fp
), \

2462 (
de
), (
bh
), (
buf
), (
size
), (
off£t
)))

	)

2463 
ext4_hŒ“_¡Üe_dœ’t
(
fe
 *
dœ_fe
, 
__u32
 
hash
,

2464 
__u32
 
mšÜ_hash
,

2465 
ext4_dœ_’Œy_2
 *
dœ’t
,

2466 
fsüy±_¡r
 *
’t_Çme
);

2467 
ext4_hŒ“_ä“_dœ_šfo
(
dœ_´iv©e_šfo
 *
p
);

2468 
ext4_fšd_de¡_de
(
šode
 *
dœ
, inode *inode,

2469 
bufãr_h—d
 *
bh
,

2470 *
buf
, 
buf_size
,

2471 
ext4_f’ame
 *
âame
,

2472 
ext4_dœ_’Œy_2
 **
de¡_de
);

2473 
ext4_š£¹_d’Œy
(
šode
 *inode,

2474 
ext4_dœ_’Œy_2
 *
de
,

2475 
buf_size
,

2476 
ext4_f’ame
 *
âame
);

2477 
šlše
 
	$ext4_upd©e_dx_æag
(
šode
 *inode)

2479 ià(!
	`ext4_has_ã©u»_dœ_šdex
(
šode
->
i_sb
))

2480 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_INDEX
);

2481 
	}
}

2482 cÚ¡ 
	gext4_f‘y³_bË
[] = {

2483 
DT_UNKNOWN
, 
DT_REG
, 
DT_DIR
, 
DT_CHR
, 
DT_BLK
, 
DT_FIFO
, 
DT_SOCK
, 
DT_LNK


2486 
šlše
 
	$g‘_dty³
(
su³r_block
 *
sb
, 
f‘y³
)

2488 ià(!
	`ext4_has_ã©u»_f‘y³
(
sb
è|| 
f‘y³
 >ğ
EXT4_FT_MAX
)

2489  
DT_UNKNOWN
;

2491  
ext4_f‘y³_bË
[
f‘y³
];

2492 
	}
}

2493 
ext4_check_®l_de
(
šode
 *
dœ
, 
bufãr_h—d
 *
bh
,

2494 *
buf
, 
buf_size
);

2497 
ext4_sync_fe
(
fe
 *, 
loff_t
,†off_t, );

2500 
ext4fs_dœhash
(cÚ¡ 
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
,

2501 
dx_hash_šfo
 *
hšfo
);

2504 
šode
 *
__ext4_Ãw_šode
(
hªdË_t
 *, šod*, 
umode_t
,

2505 cÚ¡ 
q¡r
 *q¡r, 
__u32
 
gßl
,

2506 
uid_t
 *
owÃr
, 
__u32
 
i_æags
,

2507 
hªdË_ty³
, 
lše_no
,

2508 
nblocks
);

2510 
	#ext4_Ãw_šode
(
hªdË
, 
dœ
, 
mode
, 
q¡r
, 
gßl
, 
owÃr
, 
i_æags
) \

2511 
	`__ext4_Ãw_šode
((
hªdË
), (
dœ
), (
mode
), (
q¡r
), (
gßl
), (
owÃr
), \

2512 
i_æags
, 0, 0, 0)

	)

2513 
	#ext4_Ãw_šode_¡¬t_hªdË
(
dœ
, 
mode
, 
q¡r
, 
gßl
, 
owÃr
, \

2514 
ty³
, 
nblocks
) \

2515 
	`__ext4_Ãw_šode
(
NULL
, (
dœ
), (
mode
), (
q¡r
), (
gßl
), (
owÃr
), \

2516 0, (
ty³
), 
__LINE__
, (
nblocks
))

	)

2519 
ext4_ä“_šode
(
hªdË_t
 *, 
šode
 *);

2520 
šode
 * 
ext4_Üphª_g‘
(
su³r_block
 *, );

2521 
ext4_couÁ_ä“_šodes
(
su³r_block
 *);

2522 
ext4_couÁ_dœs
(
su³r_block
 *);

2523 
ext4_check_šodes_b™m­
(
su³r_block
 *);

2524 
ext4_m¬k_b™m­_’d
(
¡¬t_b™
, 
’d_b™
, *
b™m­
);

2525 
ext4_š™_šode_bË
(
su³r_block
 *
sb
,

2526 
ext4_group_t
 
group
, 
b¬r›r
);

2527 
ext4_’d_b™m­_»ad
(
bufãr_h—d
 *
bh
, 
u±od©e
);

2530 cÚ¡ 
£q_İ”©iÚs
 
ext4_mb_£q_groups_İs
;

2531 
ext4_mb_¡©s
;

2532 
ext4_mb_max_to_sÿn
;

2533 
ext4_mb_š™
(
su³r_block
 *);

2534 
ext4_mb_»Ëa£
(
su³r_block
 *);

2535 
ext4_fsblk_t
 
ext4_mb_Ãw_blocks
(
hªdË_t
 *,

2536 
ext4_®loÿtiÚ_»que¡
 *, *);

2537 
ext4_mb_»£rve_blocks
(
su³r_block
 *, );

2538 
ext4_disÿrd_´—ÎoÿtiÚs
(
šode
 *);

2539 
__š™
 
ext4_š™_mb®loc
();

2540 
ext4_ex™_mb®loc
();

2541 
ext4_ä“_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2542 
bufãr_h—d
 *
bh
, 
ext4_fsblk_t
 
block
,

2543 
couÁ
, 
æags
);

2544 
ext4_mb_®loc_groupšfo
(
su³r_block
 *
sb
,

2545 
ext4_group_t
 
ngroups
);

2546 
ext4_mb_add_groupšfo
(
su³r_block
 *
sb
,

2547 
ext4_group_t
 
i
, 
ext4_group_desc
 *
desc
);

2548 
ext4_group_add_blocks
(
hªdË_t
 *
hªdË
, 
su³r_block
 *
sb
,

2549 
ext4_fsblk_t
 
block
, 
couÁ
);

2550 
ext4_Œim_fs
(
su³r_block
 *, 
f¡rim_¿nge
 *);

2551 
ext4_´oûss_ä“d_d©a
(
su³r_block
 *
sb
, 
tid_t
 
comm™_tid
);

2554 
ext4_šode_is_ç¡_symlšk
(
šode
 *inode);

2555 
bufãr_h—d
 *
ext4_g‘blk
(
hªdË_t
 *, 
šode
 *, 
ext4_lblk_t
, );

2556 
bufãr_h—d
 *
ext4_b»ad
(
hªdË_t
 *, 
šode
 *, 
ext4_lblk_t
, );

2557 
ext4_b»ad_b©ch
(
šode
 *šode, 
ext4_lblk_t
 
block
, 
bh_couÁ
,

2558 
boŞ
 
wa™
, 
bufãr_h—d
 **
bhs
);

2559 
ext4_g‘_block_unwr™‹n
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

2560 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
);

2561 
ext4_g‘_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

2562 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
);

2563 
ext4_dio_g‘_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

2564 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
);

2565 
ext4_da_g‘_block_´•
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

2566 
bufãr_h—d
 *
bh
, 
ü—‹
);

2567 
ext4_w®k_·ge_bufãrs
(
hªdË_t
 *
hªdË
,

2568 
bufãr_h—d
 *
h—d
,

2569 
äom
,

2570 
to
,

2571 *
·¹Ÿl
,

2572 (*
â
)(
hªdË_t
 *
hªdË
,

2573 
bufãr_h—d
 *
bh
));

2574 
	`do_jouº®_g‘_wr™e_acûss
(
hªdË_t
 *
hªdË
,

2575 
bufãr_h—d
 *
bh
);

2576 
	#FALL_BACK_TO_NONDELALLOC
 1

	)

2577 
	#CONVERT_INLINE_DATA
 2

	)

2580 
EXT4_IGET_NORMAL
 = 0,

2581 
EXT4_IGET_SPECIAL
 = 0x0001,

2582 
EXT4_IGET_HANDLE
 = 0x0002

2583 } 
	text4_ig‘_æags
;

2585 
šode
 *
	`__ext4_ig‘
(
su³r_block
 *
sb
, 
šo
,

2586 
ext4_ig‘_æags
 
æags
, cÚ¡ *
funùiÚ
,

2587 
lše
);

2589 
	#ext4_ig‘
(
sb
, 
šo
, 
æags
) \

2590 
	`__ext4_ig‘
((
sb
), (
šo
), (
æags
), 
__func__
, 
__LINE__
)

	)

2592 
	`ext4_wr™e_šode
(
šode
 *, 
wr™eback_cÚŒŞ
 *);

2593 
	`ext4_£‰r
(
d’Œy
 *, 
Ÿ‰r
 *);

2594 
	`ext4_g‘©Œ
(cÚ¡ 
·th
 *, 
k¡©
 *, 
u32
, );

2595 
	`ext4_eviù_šode
(
šode
 *);

2596 
	`ext4_ş—r_šode
(
šode
 *);

2597 
	`ext4_fe_g‘©Œ
(cÚ¡ 
·th
 *, 
k¡©
 *, 
u32
, );

2598 
	`ext4_sync_šode
(
hªdË_t
 *, 
šode
 *);

2599 
	`ext4_dœty_šode
(
šode
 *, );

2600 
	`ext4_chªge_šode_jouº®_æag
(
šode
 *, );

2601 
	`ext4_g‘_šode_loc
(
šode
 *, 
ext4_oc
 *);

2602 
	`ext4_šode_©ch_jšode
(
šode
 *inode);

2603 
	`ext4_ÿn_Œunÿ‹
(
šode
 *inode);

2604 
	`ext4_Œunÿ‹
(
šode
 *);

2605 
	`ext4_b»ak_Ïyouts
(
šode
 *);

2606 
	`ext4_punch_hŞe
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ëngth
);

2607 
	`ext4_Œunÿ‹_»¡¬t_Œªs
(
hªdË_t
 *, 
šode
 *, 
nblocks
);

2608 
	`ext4_£t_šode_æags
(
šode
 *);

2609 
	`ext4_®loc_da_blocks
(
šode
 *inode);

2610 
	`ext4_£t_aİs
(
šode
 *inode);

2611 
	`ext4_wr™•age_Œªs_blocks
(
šode
 *);

2612 
	`ext4_chunk_Œªs_blocks
(
šode
 *, 
Äblocks
);

2613 
	`ext4_z”o_·¹Ÿl_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2614 
loff_t
 
l¡¬t
,†off_ˆ
Ënd
);

2615 
vm_çuÉ_t
 
	`ext4_·ge_mkwr™e
(
vm_çuÉ
 *
vmf
);

2616 
vm_çuÉ_t
 
	`ext4_fem­_çuÉ
(
vm_çuÉ
 *
vmf
);

2617 
qsize_t
 *
	`ext4_g‘_»£rved_¥aû
(
šode
 *inode);

2618 
	`ext4_g‘_´ojid
(
šode
 *šode, 
k´ojid_t
 *
´ojid
);

2619 
	`ext4_da_»Ëa£_¥aû
(
šode
 *šode, 
to_ä“
);

2620 
	`ext4_da_upd©e_»£rve_¥aû
(
šode
 *inode,

2621 
u£d
, 
quÙa_şaim
);

2622 
	`ext4_issue_z”oout
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

2623 
ext4_fsblk_t
 
pblk
, 
ext4_lblk_t
 
Ën
);

2626 
	`ext4_šd_m­_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2627 
ext4_m­_blocks
 *
m­
, 
æags
);

2628 
	`ext4_šd_ÿlc_m‘ad©a_amouÁ
(
šode
 *šode, 
£ùÜ_t
 
lblock
);

2629 
	`ext4_šd_Œªs_blocks
(
šode
 *šode, 
Äblocks
);

2630 
	`ext4_šd_Œunÿ‹
(
hªdË_t
 *, 
šode
 *inode);

2631 
	`ext4_šd_»move_¥aû
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2632 
ext4_lblk_t
 
¡¬t
,ƒxt4_lblk_ˆ
’d
);

2635 
	`ext4_ioùl
(
fe
 *, , );

2636 
	`ext4_com·t_ioùl
(
fe
 *, , );

2639 
	`ext4_ext_mig¿‹
(
šode
 *);

2640 
	`ext4_šd_mig¿‹
(
šode
 *inode);

2643 
	`ext4_dœblock_csum_v”ify
(
šode
 *inode,

2644 
bufãr_h—d
 *
bh
);

2645 
	`ext4_Üphª_add
(
hªdË_t
 *, 
šode
 *);

2646 
	`ext4_Üphª_d–
(
hªdË_t
 *, 
šode
 *);

2647 
	`ext4_hŒ“_fl_Œ“
(
fe
 *
dœ_fe
, 
__u32
 
¡¬t_hash
,

2648 
__u32
 
¡¬t_mšÜ_hash
, __u32 *
Ãxt_hash
);

2649 
	`ext4_£¬ch_dœ
(
bufãr_h—d
 *
bh
,

2650 *
£¬ch_buf
,

2651 
buf_size
,

2652 
šode
 *
dœ
,

2653 
ext4_f’ame
 *
âame
,

2654 
off£t
,

2655 
ext4_dœ_’Œy_2
 **
»s_dœ
);

2656 
	`ext4_g’”ic_d–‘e_’Œy
(
hªdË_t
 *
hªdË
,

2657 
šode
 *
dœ
,

2658 
ext4_dœ_’Œy_2
 *
de_d–
,

2659 
bufãr_h—d
 *
bh
,

2660 *
’Œy_buf
,

2661 
buf_size
,

2662 
csum_size
);

2663 
boŞ
 
	`ext4_em±y_dœ
(
šode
 *inode);

2666 
	`ext4_group_add
(
su³r_block
 *
sb
,

2667 
ext4_Ãw_group_d©a
 *
šput
);

2668 
	`ext4_group_ex‹nd
(
su³r_block
 *
sb
,

2669 
ext4_su³r_block
 *
es
,

2670 
ext4_fsblk_t
 
n_blocks_couÁ
);

2671 
	`ext4_»size_fs
(
su³r_block
 *
sb
, 
ext4_fsblk_t
 
n_blocks_couÁ
);

2674 
bufãr_h—d
 *
	`ext4_sb_b»ad
(
su³r_block
 *
sb
,

2675 
£ùÜ_t
 
block
, 
İ_æags
);

2676 
	`ext4_£q_İtiÚs_show
(
£q_fe
 *
£q
, *
off£t
);

2677 
	`ext4_ÿlcuÏ‹_ov”h—d
(
su³r_block
 *
sb
);

2678 
	`ext4_su³rblock_csum_£t
(
su³r_block
 *
sb
);

2679 *
	`ext4_kvm®loc
(
size_t
 
size
, 
gå_t
 
æags
);

2680 *
	`ext4_kvz®loc
(
size_t
 
size
, 
gå_t
 
æags
);

2681 
	`ext4_®loc_æex_bg_¬¿y
(
su³r_block
 *
sb
,

2682 
ext4_group_t
 
ngroup
);

2683 cÚ¡ *
	`ext4_decode_”rÜ
(
su³r_block
 *
sb
, 
”ºo
,

2684 
nbuf
[16]);

2685 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
su³r_block
 *
sb
,

2686 
ext4_group_t
 
block_group
,

2687 
æags
);

2689 
	$__´štf
(4, 5)

2690 
	`__ext4_”rÜ
(
su³r_block
 *, const *, ,

2692 
	$__´štf
(5, 6)

2693 
	`__ext4_”rÜ_šode
(
šode
 *, cÚ¡ *, , 
ext4_fsblk_t
,

2695 
	$__´štf
(5, 6)

2696 
	`__ext4_”rÜ_fe
(
fe
 *, cÚ¡ *, , 
ext4_fsblk_t
,

2698 
	`__ext4_¡d_”rÜ
(
su³r_block
 *, const *,

2700 
	$__´štf
(4, 5)

2701 
	`__ext4_abÜt
(
su³r_block
 *, const *, ,

2703 
	$__´štf
(4, 5)

2704 
	`__ext4_w¬nšg
(
su³r_block
 *, const *, ,

2706 
	$__´štf
(4, 5)

2707 
	`__ext4_w¬nšg_šode
(cÚ¡ 
šode
 *šode, cÚ¡ *
funùiÚ
,

2708 
lše
, cÚ¡ *
fmt
, ...);

2709 
	$__´štf
(3, 4)

2710 
	`__ext4_msg
(
su³r_block
 *, const *, const *, ...);

2711 
	`__dump_mmp_msg
(
su³r_block
 *, 
mmp_¡ruù
 *
mmp
,

2713 
	$__´štf
(7, 8)

2714 
	`__ext4_g½_locked_”rÜ
(const *, ,

2715 
su³r_block
 *, 
ext4_group_t
,

2716 , 
ext4_fsblk_t
,

2719 
	#EXT4_ERROR_INODE
(
šode
, 
fmt
, 
a
...) \

2720 
	`ext4_”rÜ_šode
((
šode
), 
__func__
, 
__LINE__
, 0, (
fmt
), ## 
a
)

	)

2722 
	#EXT4_ERROR_INODE_BLOCK
(
šode
, 
block
, 
fmt
, 
a
...) \

2723 
	`ext4_”rÜ_šode
((
šode
), 
__func__
, 
__LINE__
, (
block
), (
fmt
), ## 
a
)

	)

2725 
	#EXT4_ERROR_FILE
(
fe
, 
block
, 
fmt
, 
a
...) \

2726 
	`ext4_”rÜ_fe
((
fe
), 
__func__
, 
__LINE__
, (
block
), (
fmt
), ## 
a
)

	)

2728 #ifdeà
CONFIG_PRINTK


2730 
	#ext4_”rÜ_šode
(
šode
, 
func
, 
lše
, 
block
, 
fmt
, ...) \

2731 
	`__ext4_”rÜ_šode
(
šode
, 
func
, 
lše
, 
block
, 
fmt
, ##
__VA_ARGS__
)

	)

2732 
	#ext4_”rÜ_fe
(
fe
, 
func
, 
lše
, 
block
, 
fmt
, ...) \

2733 
	`__ext4_”rÜ_fe
(
fe
, 
func
, 
lše
, 
block
, 
fmt
, ##
__VA_ARGS__
)

	)

2734 
	#ext4_”rÜ
(
sb
, 
fmt
, ...) \

2735 
	`__ext4_”rÜ
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2736 
	#ext4_abÜt
(
sb
, 
fmt
, ...) \

2737 
	`__ext4_abÜt
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2738 
	#ext4_w¬nšg
(
sb
, 
fmt
, ...) \

2739 
	`__ext4_w¬nšg
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2740 
	#ext4_w¬nšg_šode
(
šode
, 
fmt
, ...) \

2741 
	`__ext4_w¬nšg_šode
(
šode
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2742 
	#ext4_msg
(
sb
, 
Ëv–
, 
fmt
, ...) \

2743 
	`__ext4_msg
(
sb
, 
Ëv–
, 
fmt
, ##
__VA_ARGS__
)

	)

2744 
	#dump_mmp_msg
(
sb
, 
mmp
, 
msg
) \

2745 
	`__dump_mmp_msg
(
sb
, 
mmp
, 
__func__
, 
__LINE__
, 
msg
)

	)

2746 
	#ext4_g½_locked_”rÜ
(
sb
, 
g½
, 
šo
, 
block
, 
fmt
, ...) \

2747 
	`__ext4_g½_locked_”rÜ
(
__func__
, 
__LINE__
, 
sb
, 
g½
, 
šo
, 
block
, \

2748 
fmt
, ##
__VA_ARGS__
)

	)

2752 
	#ext4_”rÜ_šode
(
šode
, 
func
, 
lše
, 
block
, 
fmt
, ...) \

2754 
	`no_´štk
(
fmt
, ##
__VA_ARGS__
); \

2755 
	`__ext4_”rÜ_šode
(
šode
, "", 0, 
block
, " "); \

2756 
	}
} 0)

	)

2757 
	#ext4_”rÜ_fe
(
fe
, 
func
, 
lše
, 
block
, 
fmt
, ...) \

2759 
	`no_´štk
(
fmt
, ##
__VA_ARGS__
); \

2760 
	`__ext4_”rÜ_fe
(
fe
, "", 0, 
block
, " "); \

2761 } 0)

	)

2762 
	#ext4_”rÜ
(
sb
, 
fmt
, ...) \

2764 
	`no_´štk
(
fmt
, ##
__VA_ARGS__
); \

2765 
	`__ext4_”rÜ
(
sb
, "", 0, " "); \

2766 } 0)

	)

2767 
	#ext4_abÜt
(
sb
, 
fmt
, ...) \

2769 
	`no_´štk
(
fmt
, ##
__VA_ARGS__
); \

2770 
	`__ext4_abÜt
(
sb
, "", 0, " "); \

2771 } 0)

	)

2772 
	#ext4_w¬nšg
(
sb
, 
fmt
, ...) \

2774 
	`no_´štk
(
fmt
, ##
__VA_ARGS__
); \

2775 
	`__ext4_w¬nšg
(
sb
, "", 0, " "); \

2776 } 0)

	)

2777 
	#ext4_w¬nšg_šode
(
šode
, 
fmt
, ...) \

2779 
	`no_´štk
(
fmt
, ##
__VA_ARGS__
); \

2780 
	`__ext4_w¬nšg_šode
(
šode
, "", 0, " "); \

2781 } 0)

	)

2782 
	#ext4_msg
(
sb
, 
Ëv–
, 
fmt
, ...) \

2784 
	`no_´štk
(
fmt
, ##
__VA_ARGS__
); \

2785 
	`__ext4_msg
(
sb
, "", " "); \

2786 } 0)

	)

2787 
	#dump_mmp_msg
(
sb
, 
mmp
, 
msg
) \

2788 
	`__dump_mmp_msg
(
sb
, 
mmp
, "", 0, "")

	)

2789 
	#ext4_g½_locked_”rÜ
(
sb
, 
g½
, 
šo
, 
block
, 
fmt
, ...) \

2791 
	`no_´štk
(
fmt
, ##
__VA_ARGS__
); \

2792 
	`__ext4_g½_locked_”rÜ
("", 0, 
sb
, 
g½
, 
šo
, 
block
, " "); \

2793 } 0)

	)

2797 
ext4_upd©e_com·t_ã©u»
(
hªdË_t
 *
hªdË
, 
su³r_block
 *
sb
,

2798 
__u32
 
com·t
);

2799 
ext4_upd©e_rocom·t_ã©u»
(
hªdË_t
 *
hªdË
,

2800 
su³r_block
 *
sb
, 
__u32
 
rocom·t
);

2801 
ext4_upd©e_šcom·t_ã©u»
(
hªdË_t
 *
hªdË
,

2802 
su³r_block
 *
sb
, 
__u32
 
šcom·t
);

2803 
ext4_fsblk_t
 
ext4_block_b™m­
(
su³r_block
 *
sb
,

2804 
ext4_group_desc
 *
bg
);

2805 
ext4_fsblk_t
 
ext4_šode_b™m­
(
su³r_block
 *
sb
,

2806 
ext4_group_desc
 *
bg
);

2807 
ext4_fsblk_t
 
ext4_šode_bË
(
su³r_block
 *
sb
,

2808 
ext4_group_desc
 *
bg
);

2809 
__u32
 
ext4_ä“_group_şu¡”s
(
su³r_block
 *
sb
,

2810 
ext4_group_desc
 *
bg
);

2811 
__u32
 
ext4_ä“_šodes_couÁ
(
su³r_block
 *
sb
,

2812 
ext4_group_desc
 *
bg
);

2813 
__u32
 
ext4_u£d_dœs_couÁ
(
su³r_block
 *
sb
,

2814 
ext4_group_desc
 *
bg
);

2815 
__u32
 
ext4_™abË_unu£d_couÁ
(
su³r_block
 *
sb
,

2816 
ext4_group_desc
 *
bg
);

2817 
ext4_block_b™m­_£t
(
su³r_block
 *
sb
,

2818 
ext4_group_desc
 *
bg
, 
ext4_fsblk_t
 
blk
);

2819 
ext4_šode_b™m­_£t
(
su³r_block
 *
sb
,

2820 
ext4_group_desc
 *
bg
, 
ext4_fsblk_t
 
blk
);

2821 
ext4_šode_bË_£t
(
su³r_block
 *
sb
,

2822 
ext4_group_desc
 *
bg
, 
ext4_fsblk_t
 
blk
);

2823 
ext4_ä“_group_şu¡”s_£t
(
su³r_block
 *
sb
,

2824 
ext4_group_desc
 *
bg
,

2825 
__u32
 
couÁ
);

2826 
ext4_ä“_šodes_£t
(
su³r_block
 *
sb
,

2827 
ext4_group_desc
 *
bg
, 
__u32
 
couÁ
);

2828 
ext4_u£d_dœs_£t
(
su³r_block
 *
sb
,

2829 
ext4_group_desc
 *
bg
, 
__u32
 
couÁ
);

2830 
ext4_™abË_unu£d_£t
(
su³r_block
 *
sb
,

2831 
ext4_group_desc
 *
bg
, 
__u32
 
couÁ
);

2832 
ext4_group_desc_csum_v”ify
(
su³r_block
 *
sb
, 
__u32
 
group
,

2833 
ext4_group_desc
 *
gdp
);

2834 
ext4_group_desc_csum_£t
(
su³r_block
 *
sb
, 
__u32
 
group
,

2835 
ext4_group_desc
 *
gdp
);

2836 
ext4_»gi¡”_li_»que¡
(
su³r_block
 *
sb
,

2837 
ext4_group_t
 
fœ¡_nÙ_z”Ûd
);

2839 
šlše
 
	$ext4_has_m‘ad©a_csum
(
su³r_block
 *
sb
)

2841 
	`WARN_ON_ONCE
(
	`ext4_has_ã©u»_m‘ad©a_csum
(
sb
) &&

2842 !
	`EXT4_SB
(
sb
)->
s_chksum_driv”
);

2844  
	`ext4_has_ã©u»_m‘ad©a_csum
(
sb
) &&

2845 (
	`EXT4_SB
(
sb
)->
s_chksum_driv”
 !ğ
NULL
);

2846 
	}
}

2848 
šlše
 
	$ext4_has_group_desc_csum
(
su³r_block
 *
sb
)

2850  
	`ext4_has_ã©u»_gdt_csum
(
sb
è|| 
	`ext4_has_m‘ad©a_csum
(sb);

2851 
	}
}

2853 
šlše
 
ext4_fsblk_t
 
	$ext4_blocks_couÁ
(
ext4_su³r_block
 *
es
)

2855  ((
ext4_fsblk_t
)
	`Ë32_to_ıu
(
es
->
s_blocks_couÁ_hi
) << 32) |

2856 
	`Ë32_to_ıu
(
es
->
s_blocks_couÁ_lo
);

2857 
	}
}

2859 
šlše
 
ext4_fsblk_t
 
	$ext4_r_blocks_couÁ
(
ext4_su³r_block
 *
es
)

2861  ((
ext4_fsblk_t
)
	`Ë32_to_ıu
(
es
->
s_r_blocks_couÁ_hi
) << 32) |

2862 
	`Ë32_to_ıu
(
es
->
s_r_blocks_couÁ_lo
);

2863 
	}
}

2865 
šlše
 
ext4_fsblk_t
 
	$ext4_ä“_blocks_couÁ
(
ext4_su³r_block
 *
es
)

2867  ((
ext4_fsblk_t
)
	`Ë32_to_ıu
(
es
->
s_ä“_blocks_couÁ_hi
) << 32) |

2868 
	`Ë32_to_ıu
(
es
->
s_ä“_blocks_couÁ_lo
);

2869 
	}
}

2871 
šlše
 
	$ext4_blocks_couÁ_£t
(
ext4_su³r_block
 *
es
,

2872 
ext4_fsblk_t
 
blk
)

2874 
es
->
s_blocks_couÁ_lo
 = 
	`ıu_to_Ë32
((
u32
)
blk
);

2875 
es
->
s_blocks_couÁ_hi
 = 
	`ıu_to_Ë32
(
blk
 >> 32);

2876 
	}
}

2878 
šlše
 
	$ext4_ä“_blocks_couÁ_£t
(
ext4_su³r_block
 *
es
,

2879 
ext4_fsblk_t
 
blk
)

2881 
es
->
s_ä“_blocks_couÁ_lo
 = 
	`ıu_to_Ë32
((
u32
)
blk
);

2882 
es
->
s_ä“_blocks_couÁ_hi
 = 
	`ıu_to_Ë32
(
blk
 >> 32);

2883 
	}
}

2885 
šlše
 
	$ext4_r_blocks_couÁ_£t
(
ext4_su³r_block
 *
es
,

2886 
ext4_fsblk_t
 
blk
)

2888 
es
->
s_r_blocks_couÁ_lo
 = 
	`ıu_to_Ë32
((
u32
)
blk
);

2889 
es
->
s_r_blocks_couÁ_hi
 = 
	`ıu_to_Ë32
(
blk
 >> 32);

2890 
	}
}

2892 
šlše
 
loff_t
 
	$ext4_isize
(
su³r_block
 *
sb
,

2893 
ext4_šode
 *
¿w_šode
)

2895 ià(
	`ext4_has_ã©u»_Ïrgedœ
(
sb
) ||

2896 
	`S_ISREG
(
	`Ë16_to_ıu
(
¿w_šode
->
i_mode
)))

2897  ((
loff_t
)
	`Ë32_to_ıu
(
¿w_šode
->
i_size_high
) << 32) |

2898 
	`Ë32_to_ıu
(
¿w_šode
->
i_size_lo
);

2900  (
loff_t
è
	`Ë32_to_ıu
(
¿w_šode
->
i_size_lo
);

2901 
	}
}

2903 
šlše
 
	$ext4_isize_£t
(
ext4_šode
 *
¿w_šode
, 
loff_t
 
i_size
)

2905 
¿w_šode
->
i_size_lo
 = 
	`ıu_to_Ë32
(
i_size
);

2906 
¿w_šode
->
i_size_high
 = 
	`ıu_to_Ë32
(
i_size
 >> 32);

2907 
	}
}

2909 
šlše


2910 
ext4_group_šfo
 *
	$ext4_g‘_group_šfo
(
su³r_block
 *
sb
,

2911 
ext4_group_t
 
group
)

2913 
ext4_group_šfo
 ***
g½_šfo
;

2914 
šdexv
, 
šdexh
;

2915 
	`BUG_ON
(
group
 >ğ
	`EXT4_SB
(
sb
)->
s_groups_couÁ
);

2916 
g½_šfo
 = 
	`EXT4_SB
(
sb
)->
s_group_šfo
;

2917 
šdexv
 = 
group
 >> (
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
));

2918 
šdexh
 = 
group
 & ((
	`EXT4_DESC_PER_BLOCK
(
sb
)) - 1);

2919  
g½_šfo
[
šdexv
][
šdexh
];

2920 
	}
}

2927 
šlše
 
ext4_group_t
 
	$ext4_g‘_groups_couÁ
(
su³r_block
 *
sb
)

2929 
ext4_group_t
 
ngroups
 = 
	`EXT4_SB
(
sb
)->
s_groups_couÁ
;

2931 
	`smp_rmb
();

2932  
ngroups
;

2933 
	}
}

2935 
šlše
 
ext4_group_t
 
	$ext4_æex_group
(
ext4_sb_šfo
 *
sbi
,

2936 
ext4_group_t
 
block_group
)

2938  
block_group
 >> 
sbi
->
s_log_groups_³r_æex
;

2939 
	}
}

2941 
šlše
 
	$ext4_æex_bg_size
(
ext4_sb_šfo
 *
sbi
)

2943  1 << 
sbi
->
s_log_groups_³r_æex
;

2944 
	}
}

2946 
	#ext4_¡d_”rÜ
(
sb
, 
”ºo
) \

2948 ià((
”ºo
)) \

2949 
	`__ext4_¡d_”rÜ
((
sb
), 
__func__
, 
__LINE__
, (
”ºo
)); \

2950 } 0)

	)

2952 #ifdeà
CONFIG_SMP


2957 
	#EXT4_FREECLUSTERS_WATERMARK
 (4 * (
³rıu_couÁ”_b©ch
 * 
Ä_ıu_ids
))

	)

2959 
	#EXT4_FREECLUSTERS_WATERMARK
 0

	)

2963 
šlše
 
	$ext4_upd©e_i_disksize
(
šode
 *šode, 
loff_t
 
Ãwsize
)

2965 
	`WARN_ON_ONCE
(
	`S_ISREG
(
šode
->
i_mode
) &&

2966 !
	`šode_is_locked
(
šode
));

2967 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

2968 ià(
Ãwsize
 > 
	`EXT4_I
(
šode
)->
i_disksize
)

2969 
	`EXT4_I
(
šode
)->
i_disksize
 = 
Ãwsize
;

2970 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

2971 
	}
}

2974 
šlše
 
	$ext4_upd©e_šode_size
(
šode
 *šode, 
loff_t
 
Ãwsize
)

2976 
chªged
 = 0;

2978 ià(
Ãwsize
 > 
šode
->
i_size
) {

2979 
	`i_size_wr™e
(
šode
, 
Ãwsize
);

2980 
chªged
 = 1;

2982 ià(
Ãwsize
 > 
	`EXT4_I
(
šode
)->
i_disksize
) {

2983 
	`ext4_upd©e_i_disksize
(
šode
, 
Ãwsize
);

2984 
chªged
 |= 2;

2986  
chªged
;

2987 
	}
}

2989 
ext4_upd©e_disksize_befÜe_punch
(
šode
 *šode, 
loff_t
 
off£t
,

2990 
loff_t
 
Ën
);

2992 
	sext4_group_šfo
 {

2993 
	mbb_¡©e
;

2994 
rb_roÙ
 
	mbb_ä“_roÙ
;

2995 
ext4_g½blk_t
 
	mbb_fœ¡_ä“
;

2996 
ext4_g½blk_t
 
	mbb_ä“
;

2997 
ext4_g½blk_t
 
	mbb_äagm’ts
;

2998 
ext4_g½blk_t
 
	mbb_Ïrge¡_ä“_Üd”
;

2999 
li¡_h—d
 
	mbb_´—Îoc_li¡
;

3000 #ifdeà
DOUBLE_CHECK


3001 *
	mbb_b™m­
;

3003 
rw_£m­hÜe
 
	m®loc_£m
;

3004 
ext4_g½blk_t
 
	mbb_couÁ”s
[];

3010 
	#EXT4_GROUP_INFO_NEED_INIT_BIT
 0

	)

3011 
	#EXT4_GROUP_INFO_WAS_TRIMMED_BIT
 1

	)

3012 
	#EXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
 2

	)

3013 
	#EXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
 3

	)

3014 
	#EXT4_GROUP_INFO_BBITMAP_CORRUPT
 \

3015 (1 << 
EXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
)

	)

3016 
	#EXT4_GROUP_INFO_IBITMAP_CORRUPT
 \

3017 (1 << 
EXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
)

	)

3019 
	#EXT4_MB_GRP_NEED_INIT
(
g½
) \

3020 (
	`‹¡_b™
(
EXT4_GROUP_INFO_NEED_INIT_BIT
, &((
g½
)->
bb_¡©e
)))

	)

3021 
	#EXT4_MB_GRP_BBITMAP_CORRUPT
(
g½
) \

3022 (
	`‹¡_b™
(
EXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
, &((
g½
)->
bb_¡©e
)))

	)

3023 
	#EXT4_MB_GRP_IBITMAP_CORRUPT
(
g½
) \

3024 (
	`‹¡_b™
(
EXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
, &((
g½
)->
bb_¡©e
)))

	)

3026 
	#EXT4_MB_GRP_WAS_TRIMMED
(
g½
) \

3027 (
	`‹¡_b™
(
EXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
g½
)->
bb_¡©e
)))

	)

3028 
	#EXT4_MB_GRP_SET_TRIMMED
(
g½
) \

3029 (
	`£t_b™
(
EXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
g½
)->
bb_¡©e
)))

	)

3030 
	#EXT4_MB_GRP_CLEAR_TRIMMED
(
g½
) \

3031 (
	`ş—r_b™
(
EXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
g½
)->
bb_¡©e
)))

	)

3033 
	#EXT4_MAX_CONTENTION
 8

	)

3034 
	#EXT4_CONTENTION_THRESHOLD
 2

	)

3036 
šlše
 
¥šlock_t
 *
	$ext4_group_lock_±r
(
su³r_block
 *
sb
,

3037 
ext4_group_t
 
group
)

3039  
	`bgl_lock_±r
(
	`EXT4_SB
(
sb
)->
s_blockgroup_lock
, 
group
);

3040 
	}
}

3046 
šlše
 
	$ext4_fs_is_busy
(
ext4_sb_šfo
 *
sbi
)

3048  (
	`©omic_»ad
(&
sbi
->
s_lock_busy
è> 
EXT4_CONTENTION_THRESHOLD
);

3049 
	}
}

3051 
šlše
 
	$ext4_lock_group
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
)

3053 
¥šlock_t
 *
lock
 = 
	`ext4_group_lock_±r
(
sb
, 
group
);

3054 ià(
	`¥š_Œylock
(
lock
))

3059 
	`©omic_add_uÆess
(&
	`EXT4_SB
(
sb
)->
s_lock_busy
, -1, 0);

3065 
	`©omic_add_uÆess
(&
	`EXT4_SB
(
sb
)->
s_lock_busy
, 1,

3066 
EXT4_MAX_CONTENTION
);

3067 
	`¥š_lock
(
lock
);

3069 
	}
}

3071 
šlše
 
	$ext4_uÆock_group
(
su³r_block
 *
sb
,

3072 
ext4_group_t
 
group
)

3074 
	`¥š_uÆock
(
	`ext4_group_lock_±r
(
sb
, 
group
));

3075 
	}
}

3080 
	#ext4_check_šdœeù_block»f
(
šode
, 
bh
) \

3081 
	`ext4_check_block»f
(
__func__
, 
__LINE__
, 
šode
, \

3082 (
__Ë32
 *)(
bh
)->
b_d©a
, \

3083 
	`EXT4_ADDR_PER_BLOCK
((
šode
)->
i_sb
))

	)

3085 
	#ext4_šd_check_šode
(
šode
) \

3086 
	`ext4_check_block»f
(
__func__
, 
__LINE__
, 
šode
, \

3087 
	`EXT4_I
(
šode
)->
i_d©a
, \

3088 
EXT4_NDIR_BLOCKS
)

	)

3095 cÚ¡ 
fe_İ”©iÚs
 
ext4_dœ_İ”©iÚs
;

3097 #ifdeà
CONFIG_UNICODE


3098 cÚ¡ 
d’Œy_İ”©iÚs
 
ext4_d’Œy_İs
;

3102 cÚ¡ 
šode_İ”©iÚs
 
ext4_fe_šode_İ”©iÚs
;

3103 cÚ¡ 
fe_İ”©iÚs
 
ext4_fe_İ”©iÚs
;

3104 
loff_t
 
ext4_Î£ek
(
fe
 *fe,†off_ˆ
off£t
, 
Üigš
);

3107 
ext4_g‘_max_šlše_size
(
šode
 *inode);

3108 
ext4_fšd_šlše_d©a_nŞock
(
šode
 *inode);

3109 
ext4_š™_šlše_d©a
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

3110 
Ën
);

3111 
ext4_de¡roy_šlše_d©a
(
hªdË_t
 *
hªdË
, 
šode
 *inode);

3113 
ext4_»ad·ge_šlše
(
šode
 *šode, 
·ge
 *page);

3114 
ext4_Œy_to_wr™e_šlše_d©a
(
add»ss_¥aû
 *
m­pšg
,

3115 
šode
 *inode,

3116 
loff_t
 
pos
, 
Ën
,

3117 
æags
,

3118 
·ge
 **
·g•
);

3119 
ext4_wr™e_šlše_d©a_’d
(
šode
 *inode,

3120 
loff_t
 
pos
, 
Ën
,

3121 
cİ›d
,

3122 
·ge
 *page);

3123 
bufãr_h—d
 *

3124 
ext4_jouº®Ëd_wr™e_šlše_d©a
(
šode
 *inode,

3125 
Ën
,

3126 
·ge
 *page);

3127 
ext4_da_wr™e_šlše_d©a_begš
(
add»ss_¥aû
 *
m­pšg
,

3128 
šode
 *inode,

3129 
loff_t
 
pos
, 
Ën
,

3130 
æags
,

3131 
·ge
 **
·g•
,

3132 **
fsd©a
);

3133 
ext4_da_wr™e_šlše_d©a_’d
(
šode
 *šode, 
loff_t
 
pos
,

3134 
Ën
, 
cİ›d
,

3135 
·ge
 *page);

3136 
ext4_Œy_add_šlše_’Œy
(
hªdË_t
 *
hªdË
,

3137 
ext4_f’ame
 *
âame
,

3138 
šode
 *
dœ
, inode *inode);

3139 
ext4_Œy_ü—‹_šlše_dœ
(
hªdË_t
 *
hªdË
,

3140 
šode
 *
·»Á
,

3141 
šode
 *inode);

3142 
ext4_»ad_šlše_dœ
(
fe
 *
fp
,

3143 
dœ_cÚ‹xt
 *
ùx
,

3144 *
has_šlše_d©a
);

3145 
ext4_šlšedœ_to_Œ“
(
fe
 *
dœ_fe
,

3146 
šode
 *
dœ
, 
ext4_lblk_t
 
block
,

3147 
dx_hash_šfo
 *
hšfo
,

3148 
__u32
 
¡¬t_hash
, __u32 
¡¬t_mšÜ_hash
,

3149 *
has_šlše_d©a
);

3150 
bufãr_h—d
 *
ext4_fšd_šlše_’Œy
(
šode
 *
dœ
,

3151 
ext4_f’ame
 *
âame
,

3152 
ext4_dœ_’Œy_2
 **
»s_dœ
,

3153 *
has_šlše_d©a
);

3154 
ext4_d–‘e_šlše_’Œy
(
hªdË_t
 *
hªdË
,

3155 
šode
 *
dœ
,

3156 
ext4_dœ_’Œy_2
 *
de_d–
,

3157 
bufãr_h—d
 *
bh
,

3158 *
has_šlše_d©a
);

3159 
boŞ
 
em±y_šlše_dœ
(
šode
 *
dœ
, *
has_šlše_d©a
);

3160 
bufãr_h—d
 *
ext4_g‘_fœ¡_šlše_block
(
šode
 *inode,

3161 
ext4_dœ_’Œy_2
 **
·»Á_de
,

3162 *
»tv®
);

3163 
ext4_šlše_d©a_f›m­
(
šode
 *inode,

3164 
f›m­_ex‹Á_šfo
 *
f›šfo
,

3165 *
has_šlše
, 
__u64
 
¡¬t
, __u64 
Ën
);

3167 
	giom­
;

3168 
ext4_šlše_d©a_iom­
(
šode
 *šode, 
iom­
 *iomap);

3170 
ext4_šlše_d©a_Œunÿ‹
(
šode
 *šode, *
has_šlše
);

3172 
ext4_cÚv”t_šlše_d©a
(
šode
 *inode);

3174 
šlše
 
	$ext4_has_šlše_d©a
(
šode
 *inode)

3176  
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_INLINE_DATA
) &&

3177 
	`EXT4_I
(
šode
)->
i_šlše_off
;

3178 
	}
}

3181 cÚ¡ 
šode_İ”©iÚs
 
ext4_dœ_šode_İ”©iÚs
;

3182 cÚ¡ 
šode_İ”©iÚs
 
ext4_¥ecŸl_šode_İ”©iÚs
;

3183 
d’Œy
 *
ext4_g‘_·»Á
(d’Œy *
chd
);

3184 
ext4_dœ_’Œy_2
 *
ext4_š™_dÙ_dÙdÙ
(
šode
 *inode,

3185 
ext4_dœ_’Œy_2
 *
de
,

3186 
blocksize
, 
csum_size
,

3187 
·»Á_šo
, 
dÙdÙ_»®_Ën
);

3188 
ext4_š™Ÿlize_dœ’t_
(
bufãr_h—d
 *
bh
,

3189 
blocksize
);

3190 
ext4_hªdË_dœty_dœblock
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

3191 
bufãr_h—d
 *
bh
);

3192 
ext4_ci_com·»
(cÚ¡ 
šode
 *
·»Á
,

3193 cÚ¡ 
q¡r
 *
âame
,

3194 cÚ¡ 
q¡r
 *
’Œy
, 
boŞ
 
quick
);

3196 
	#S_SHIFT
 12

	)

3197 cÚ¡ 
	gext4_ty³_by_mode
[(
S_IFMT
 >> 
S_SHIFT
) + 1] = {

3198 [
S_IFREG
 >> 
S_SHIFT
] = 
EXT4_FT_REG_FILE
,

3199 [
S_IFDIR
 >> 
S_SHIFT
] = 
EXT4_FT_DIR
,

3200 [
S_IFCHR
 >> 
S_SHIFT
] = 
EXT4_FT_CHRDEV
,

3201 [
S_IFBLK
 >> 
S_SHIFT
] = 
EXT4_FT_BLKDEV
,

3202 [
S_IFIFO
 >> 
S_SHIFT
] = 
EXT4_FT_FIFO
,

3203 [
S_IFSOCK
 >> 
S_SHIFT
] = 
EXT4_FT_SOCK
,

3204 [
S_IFLNK
 >> 
S_SHIFT
] = 
EXT4_FT_SYMLINK
,

3207 
šlše
 
	$ext4_£t_de_ty³
(
su³r_block
 *
sb
,

3208 
ext4_dœ_’Œy_2
 *
de
,

3209 
umode_t
 
mode
) {

3210 ià(
	`ext4_has_ã©u»_f‘y³
(
sb
))

3211 
de
->
fe_ty³
 = 
ext4_ty³_by_mode
[(
mode
 & 
S_IFMT
)>>
S_SHIFT
];

3212 
	}
}

3215 
ext4_m·ge_»ad·ges
(
add»ss_¥aû
 *
m­pšg
,

3216 
li¡_h—d
 *
·ges
, 
·ge
 *page,

3217 
Ä_·ges
, 
boŞ
 
is_»adah—d
);

3218 
__š™
 
ext4_š™_po¡_»ad_´oûssšg
();

3219 
ext4_ex™_po¡_»ad_´oûssšg
();

3222 cÚ¡ 
šode_İ”©iÚs
 
ext4_’üy±ed_symlšk_šode_İ”©iÚs
;

3223 cÚ¡ 
šode_İ”©iÚs
 
ext4_symlšk_šode_İ”©iÚs
;

3224 cÚ¡ 
šode_İ”©iÚs
 
ext4_ç¡_symlšk_šode_İ”©iÚs
;

3227 
ext4_»gi¡”_sysfs
(
su³r_block
 *
sb
);

3228 
ext4_uÄegi¡”_sysfs
(
su³r_block
 *
sb
);

3229 
__š™
 
ext4_š™_sysfs
();

3230 
ext4_ex™_sysfs
();

3233 
ext4_»Ëa£_sy¡em_zÚe
(
su³r_block
 *
sb
);

3234 
ext4_£tup_sy¡em_zÚe
(
su³r_block
 *
sb
);

3235 
__š™
 
ext4_š™_sy¡em_zÚe
();

3236 
ext4_ex™_sy¡em_zÚe
();

3237 
ext4_d©a_block_v®id
(
ext4_sb_šfo
 *
sbi
,

3238 
ext4_fsblk_t
 
¡¬t_blk
,

3239 
couÁ
);

3240 
ext4_check_block»f
(const *, ,

3241 
šode
 *, 
__Ë32
 *, );

3244 
	gext4_ext_·th
;

3245 
	gext4_ex‹Á
;

3251 
	#EXT_MAX_BLOCKS
 0xffffffff

	)

3253 
ext4_ext_Œ“_š™
(
hªdË_t
 *
hªdË
, 
šode
 *);

3254 
ext4_ext_wr™•age_Œªs_blocks
(
šode
 *, );

3255 
ext4_ext_šdex_Œªs_blocks
(
šode
 *šode, 
ex‹Ás
);

3256 
ext4_ext_m­_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

3257 
ext4_m­_blocks
 *
m­
, 
æags
);

3258 
ext4_ext_Œunÿ‹
(
hªdË_t
 *, 
šode
 *);

3259 
ext4_ext_»move_¥aû
(
šode
 *šode, 
ext4_lblk_t
 
¡¬t
,

3260 
ext4_lblk_t
 
’d
);

3261 
ext4_ext_š™
(
su³r_block
 *);

3262 
ext4_ext_»Ëa£
(
su³r_block
 *);

3263 
ext4_çÎoÿ‹
(
fe
 *fe, 
mode
, 
loff_t
 
off£t
,

3264 
loff_t
 
Ën
);

3265 
ext4_cÚv”t_unwr™‹n_ex‹Ás
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

3266 
loff_t
 
off£t
, 
ssize_t
 
Ën
);

3267 
ext4_m­_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

3268 
ext4_m­_blocks
 *
m­
, 
æags
);

3269 
ext4_ext_ÿlc_m‘ad©a_amouÁ
(
šode
 *inode,

3270 
ext4_lblk_t
 
lblocks
);

3271 
ext4_ext_ÿlc_üed™s_fÜ_sšgË_ex‹Á
(
šode
 *inode,

3272 
num
,

3273 
ext4_ext_·th
 *
·th
);

3274 
ext4_ÿn_ex‹Ás_be_m”ged
(
šode
 *inode,

3275 
ext4_ex‹Á
 *
ex1
,

3276 
ext4_ex‹Á
 *
ex2
);

3277 
ext4_ext_š£¹_ex‹Á
(
hªdË_t
 *, 
šode
 *,

3278 
ext4_ext_·th
 **,

3279 
ext4_ex‹Á
 *, );

3280 
ext4_ext_·th
 *
ext4_fšd_ex‹Á
(
šode
 *, 
ext4_lblk_t
,

3281 
ext4_ext_·th
 **,

3282 
æags
);

3283 
ext4_ext_drİ_»fs
(
ext4_ext_·th
 *);

3284 
ext4_ext_check_šode
(
šode
 *inode);

3285 
ext4_lblk_t
 
ext4_ext_Ãxt_®loÿ‹d_block
(
ext4_ext_·th
 *
·th
);

3286 
ext4_f›m­
(
šode
 *šode, 
f›m­_ex‹Á_šfo
 *
f›šfo
,

3287 
__u64
 
¡¬t
, __u64 
Ën
);

3288 
ext4_g‘_es_ÿche
(
šode
 *inode,

3289 
f›m­_ex‹Á_šfo
 *
f›šfo
,

3290 
__u64
 
¡¬t
, __u64 
Ën
);

3291 
ext4_ext_´eÿche
(
šode
 *inode);

3292 
ext4_cŞÏp£_¿nge
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
);

3293 
ext4_š£¹_¿nge
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
);

3294 
ext4_sw­_ex‹Ás
(
hªdË_t
 *
hªdË
, 
šode
 *
šode1
,

3295 
šode
 *
šode2
, 
ext4_lblk_t
 
lblk1
,

3296 
ext4_lblk_t
 
lblk2
,ƒxt4_lblk_ˆ
couÁ
,

3297 
m¬k_unwr™‹n
,*
”r
);

3298 
ext4_şu_m­³d
(
šode
 *šode, 
ext4_lblk_t
 
lşu
);

3301 
ext4_doubË_down_wr™e_d©a_£m
(
šode
 *
fœ¡
,

3302 
šode
 *
£cÚd
);

3303 
ext4_doubË_up_wr™e_d©a_£m
(
šode
 *
Üig_šode
,

3304 
šode
 *
dÚÜ_šode
);

3305 
ext4_move_ex‹Ás
(
fe
 *
o_fp
, f*
d_fp
,

3306 
__u64
 
¡¬t_Üig
, __u64 
¡¬t_dÚÜ
,

3307 
__u64
 
Ën
, __u64 *
moved_Ën
);

3310 
__š™
 
ext4_š™_·geio
();

3311 
ext4_ex™_·geio
();

3312 
ext4_io_’d_t
 *
ext4_š™_io_’d
(
šode
 *šode, 
gå_t
 
æags
);

3313 
ext4_io_’d_t
 *
ext4_g‘_io_’d
Óxt4_io_’d_ˆ*
io_’d
);

3314 
ext4_put_io_’d
(
ext4_io_’d_t
 *
io_’d
);

3315 
ext4_put_io_’d_deãr
(
ext4_io_’d_t
 *
io_’d
);

3316 
ext4_io_subm™_š™
(
ext4_io_subm™
 *
io
,

3317 
wr™eback_cÚŒŞ
 *
wbc
);

3318 
ext4_’d_io_rsv_wÜk
(
wÜk_¡ruù
 *
wÜk
);

3319 
ext4_io_subm™
(ext4_io_subm™ *
io
);

3320 
ext4_bio_wr™e_·ge
(
ext4_io_subm™
 *
io
,

3321 
·ge
 *page,

3322 
Ën
,

3323 
wr™eback_cÚŒŞ
 *
wbc
,

3324 
boŞ
 
k“p_towr™e
);

3327 
ext4_muÉi_mouÁ_´Ùeù
(
su³r_block
 *, 
ext4_fsblk_t
);

3330 cÚ¡ 
fsv”™y_İ”©iÚs
 
ext4_v”™yİs
;

3337 
	#BH_BITMAP_UPTODATE
 
BH_JBDPriv©eS¹


	)

3339 
šlše
 
	$b™m­_u±od©e
(
bufãr_h—d
 *
bh
)

3341  (
	`bufãr_u±od©e
(
bh
) &&

3342 
	`‹¡_b™
(
BH_BITMAP_UPTODATE
, &(
bh
)->
b_¡©e
));

3343 
	}
}

3344 
šlše
 
	$£t_b™m­_u±od©e
(
bufãr_h—d
 *
bh
)

3346 
	`£t_b™
(
BH_BITMAP_UPTODATE
, &(
bh
)->
b_¡©e
);

3347 
	}
}

3349 
	#š_¿nge
(
b
, 
fœ¡
, 
Ën
è((bè>ğ(fœ¡è&& (bè<ğ(fœ¡è+ (Ënè- 1)

	)

3352 
	#EXT4_WQ_HASH_SZ
 37

	)

3353 
	#ext4_iÛnd_wq
(
v
è(&
ext4__iÛnd_wq
[(()(v)) %\

3354 
EXT4_WQ_HASH_SZ
])

	)

3355 
wa™_queue_h—d_t
 
ext4__iÛnd_wq
[
EXT4_WQ_HASH_SZ
];

3357 
ext4_»size_begš
(
su³r_block
 *
sb
);

3358 
ext4_»size_’d
(
su³r_block
 *
sb
);

3360 
šlše
 
	$ext4_£t_io_unwr™‹n_æag
(
šode
 *inode,

3361 
ext4_io_’d
 *
io_’d
)

3363 ià(!(
io_’d
->
æag
 & 
EXT4_IO_END_UNWRITTEN
)) {

3364 
io_’d
->
æag
 |ğ
EXT4_IO_END_UNWRITTEN
;

3365 
	`©omic_šc
(&
	`EXT4_I
(
šode
)->
i_unwr™‹n
);

3367 
	}
}

3369 
šlše
 
	$ext4_ş—r_io_unwr™‹n_æag
(
ext4_io_’d_t
 *
io_’d
)

3371 
šode
 *šodğ
io_’d
->inode;

3373 ià(
io_’d
->
æag
 & 
EXT4_IO_END_UNWRITTEN
) {

3374 
io_’d
->
æag
 &ğ~
EXT4_IO_END_UNWRITTEN
;

3376 ià(
	`©omic_dec_ªd_‹¡
(&
	`EXT4_I
(
šode
)->
i_unwr™‹n
))

3377 
	`wake_up_®l
(
	`ext4_iÛnd_wq
(
šode
));

3379 
	}
}

3381 cÚ¡ 
iom­_İs
 
ext4_iom­_İs
;

3383 
šlše
 
	$ext4_bufãr_u±od©e
(
bufãr_h—d
 *
bh
)

3391 ià(!
	`bufãr_u±od©e
(
bh
è&& 
	`bufãr_wr™e_io_”rÜ
(bh))

3392 
	`£t_bufãr_u±od©e
(
bh
);

3393  
	`bufãr_u±od©e
(
bh
);

3394 
	}
}

3398 
	#EFSBADCRC
 
EBADMSG


	)

3399 
	#EFSCORRUPTED
 
EUCLEAN


	)

	@pxt4/ext4_extents.h

7 #iâdeà
_EXT4_EXTENTS


8 
	#_EXT4_EXTENTS


	)

10 
	~"ext4.h
"

18 
	#AGGRESSIVE_TEST_


	)

25 
	#EXTENTS_STATS__


	)

31 
	#CHECK_BINSEARCH__


	)

37 
	#EXT_STATS_


	)

55 
	sext4_ex‹Á_
 {

56 
__Ë32
 
	m‘_checksum
;

63 
	sext4_ex‹Á
 {

64 
__Ë32
 
	m“_block
;

65 
__Ë16
 
	m“_Ën
;

66 
__Ë16
 
	m“_¡¬t_hi
;

67 
__Ë32
 
	m“_¡¬t_lo
;

74 
	sext4_ex‹Á_idx
 {

75 
__Ë32
 
	mei_block
;

76 
__Ë32
 
	mei_Ëaf_lo
;

78 
__Ë16
 
	mei_Ëaf_hi
;

79 
__u16
 
	mei_unu£d
;

85 
	sext4_ex‹Á_h—d”
 {

86 
__Ë16
 
	meh_magic
;

87 
__Ë16
 
	meh_’Œ›s
;

88 
__Ë16
 
	meh_max
;

89 
__Ë16
 
	meh_d•th
;

90 
__Ë32
 
	meh_g’”©iÚ
;

93 
	#EXT4_EXT_MAGIC
 
	`ıu_to_Ë16
(0xf30a)

	)

94 
	#EXT4_MAX_EXTENT_DEPTH
 5

	)

96 
	#EXT4_EXTENT_TAIL_OFFSET
(
hdr
) \

97 ((
ext4_ex‹Á_h—d”
) + \

98 ((
ext4_ex‹Á
è* 
	`Ë16_to_ıu
((
hdr
)->
eh_max
)))

	)

100 
šlše
 
ext4_ex‹Á_
 *

101 
	$fšd_ext4_ex‹Á_
(
ext4_ex‹Á_h—d”
 *
eh
)

103  (
ext4_ex‹Á_
 *)(((*)
eh
) +

104 
	`EXT4_EXTENT_TAIL_OFFSET
(
eh
));

105 
	}
}

112 
	sext4_ext_·th
 {

113 
ext4_fsblk_t
 
	mp_block
;

114 
__u16
 
	mp_d•th
;

115 
__u16
 
	mp_maxd•th
;

116 
ext4_ex‹Á
 *
	mp_ext
;

117 
ext4_ex‹Á_idx
 *
	mp_idx
;

118 
ext4_ex‹Á_h—d”
 *
	mp_hdr
;

119 
bufãr_h—d
 *
	mp_bh
;

129 
	s·¹Ÿl_şu¡”
 {

130 
ext4_fsblk_t
 
	mpşu
;

131 
ext4_lblk_t
 
	mlblk
;

132 ’um {
	mš™Ÿl
, 
	mtoä“
, 
	mnoä“
} 
	m¡©e
;

156 
	#EXT_INIT_MAX_LEN
 (1UL << 15)

	)

157 
	#EXT_UNWRITTEN_MAX_LEN
 (
EXT_INIT_MAX_LEN
 - 1)

	)

160 
	#EXT_FIRST_EXTENT
(
__hdr__
) \

161 ((
ext4_ex‹Á
 *è(((*è(
__hdr__
)) + \

162 (
ext4_ex‹Á_h—d”
)))

	)

163 
	#EXT_FIRST_INDEX
(
__hdr__
) \

164 ((
ext4_ex‹Á_idx
 *è(((*è(
__hdr__
)) + \

165 (
ext4_ex‹Á_h—d”
)))

	)

166 
	#EXT_HAS_FREE_INDEX
(
__·th__
) \

167 (
	`Ë16_to_ıu
((
__·th__
)->
p_hdr
->
eh_’Œ›s
) \

168 < 
	`Ë16_to_ıu
((
__·th__
)->
p_hdr
->
eh_max
))

	)

169 
	#EXT_LAST_EXTENT
(
__hdr__
) \

170 (
	`EXT_FIRST_EXTENT
((
__hdr__
)è+ 
	`Ë16_to_ıu
((__hdr__)->
eh_’Œ›s
è- 1)

	)

171 
	#EXT_LAST_INDEX
(
__hdr__
) \

172 (
	`EXT_FIRST_INDEX
((
__hdr__
)è+ 
	`Ë16_to_ıu
((__hdr__)->
eh_’Œ›s
è- 1)

	)

173 
	#EXT_MAX_EXTENT
(
__hdr__
) \

174 (
	`EXT_FIRST_EXTENT
((
__hdr__
)è+ 
	`Ë16_to_ıu
((__hdr__)->
eh_max
è- 1)

	)

175 
	#EXT_MAX_INDEX
(
__hdr__
) \

176 (
	`EXT_FIRST_INDEX
((
__hdr__
)è+ 
	`Ë16_to_ıu
((__hdr__)->
eh_max
è- 1)

	)

178 
šlše
 
ext4_ex‹Á_h—d”
 *
	$ext_šode_hdr
(
šode
 *inode)

180  (
ext4_ex‹Á_h—d”
 *è
	`EXT4_I
(
šode
)->
i_d©a
;

181 
	}
}

183 
šlše
 
ext4_ex‹Á_h—d”
 *
	$ext_block_hdr
(
bufãr_h—d
 *
bh
)

185  (
ext4_ex‹Á_h—d”
 *è
bh
->
b_d©a
;

186 
	}
}

188 
šlše
 
	$ext_d•th
(
šode
 *inode)

190  
	`Ë16_to_ıu
(
	`ext_šode_hdr
(
šode
)->
eh_d•th
);

191 
	}
}

193 
šlše
 
	$ext4_ext_m¬k_unwr™‹n
(
ext4_ex‹Á
 *
ext
)

196 
	`BUG_ON
((
	`Ë16_to_ıu
(
ext
->
“_Ën
è& ~
EXT_INIT_MAX_LEN
) == 0);

197 
ext
->
“_Ën
 |ğ
	`ıu_to_Ë16
(
EXT_INIT_MAX_LEN
);

198 
	}
}

200 
šlše
 
	$ext4_ext_is_unwr™‹n
(
ext4_ex‹Á
 *
ext
)

203  (
	`Ë16_to_ıu
(
ext
->
“_Ën
è> 
EXT_INIT_MAX_LEN
);

204 
	}
}

206 
šlše
 
	$ext4_ext_g‘_aùu®_Ën
(
ext4_ex‹Á
 *
ext
)

208  (
	`Ë16_to_ıu
(
ext
->
“_Ën
è<ğ
EXT_INIT_MAX_LEN
 ?

209 
	`Ë16_to_ıu
(
ext
->
“_Ën
) :

210 (
	`Ë16_to_ıu
(
ext
->
“_Ën
è- 
EXT_INIT_MAX_LEN
));

211 
	}
}

213 
šlše
 
	$ext4_ext_m¬k_š™Ÿlized
(
ext4_ex‹Á
 *
ext
)

215 
ext
->
“_Ën
 = 
	`ıu_to_Ë16
(
	`ext4_ext_g‘_aùu®_Ën
(ext));

216 
	}
}

222 
šlše
 
ext4_fsblk_t
 
	$ext4_ext_pblock
(
ext4_ex‹Á
 *
ex
)

224 
ext4_fsblk_t
 
block
;

226 
block
 = 
	`Ë32_to_ıu
(
ex
->
“_¡¬t_lo
);

227 
block
 |ğ((
ext4_fsblk_t
è
	`Ë16_to_ıu
(
ex
->
“_¡¬t_hi
) << 31) << 1;

228  
block
;

229 
	}
}

235 
šlše
 
ext4_fsblk_t
 
	$ext4_idx_pblock
(
ext4_ex‹Á_idx
 *
ix
)

237 
ext4_fsblk_t
 
block
;

239 
block
 = 
	`Ë32_to_ıu
(
ix
->
ei_Ëaf_lo
);

240 
block
 |ğ((
ext4_fsblk_t
è
	`Ë16_to_ıu
(
ix
->
ei_Ëaf_hi
) << 31) << 1;

241  
block
;

242 
	}
}

249 
šlše
 
	$ext4_ext_¡Üe_pblock
(
ext4_ex‹Á
 *
ex
,

250 
ext4_fsblk_t
 
pb
)

252 
ex
->
“_¡¬t_lo
 = 
	`ıu_to_Ë32
((è(
pb
 & 0xffffffff));

253 
ex
->
“_¡¬t_hi
 = 
	`ıu_to_Ë16
((è((
pb
 >> 31) >> 1) &

255 
	}
}

262 
šlše
 
	$ext4_idx_¡Üe_pblock
(
ext4_ex‹Á_idx
 *
ix
,

263 
ext4_fsblk_t
 
pb
)

265 
ix
->
ei_Ëaf_lo
 = 
	`ıu_to_Ë32
((è(
pb
 & 0xffffffff));

266 
ix
->
ei_Ëaf_hi
 = 
	`ıu_to_Ë16
((è((
pb
 >> 31) >> 1) &

268 
	}
}

270 
	#ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
) \

271 
	`__ext4_ext_dœty
(
__func__
, 
__LINE__
, (
hªdË
), (
šode
), (
·th
))

	)

272 
__ext4_ext_dœty
(cÚ¡ *
wh”e
, 
lše
, 
hªdË_t
 *
hªdË
,

273 
šode
 *šode, 
ext4_ext_·th
 *
·th
);

	@pxt4/ext4_jbd2.c

6 
	~"ext4_jbd2.h
"

8 
	~<Œaû/ev’ts/ext4.h
>

11 
hªdË_t
 *
	$ext4_g‘_nojouº®
()

13 
hªdË_t
 *
hªdË
 = 
cu¼’t
->
jouº®_šfo
;

14 
»f_út
 = ()
hªdË
;

16 
	`BUG_ON
(
»f_út
 >ğ
EXT4_NOJOURNAL_MAX_REF_COUNT
);

18 
»f_út
++;

19 
hªdË
 = (
hªdË_t
 *)
»f_út
;

21 
cu¼’t
->
jouº®_šfo
 = 
hªdË
;

22  
hªdË
;

23 
	}
}

27 
	$ext4_put_nojouº®
(
hªdË_t
 *
hªdË
)

29 
»f_út
 = ()
hªdË
;

31 
	`BUG_ON
(
»f_út
 == 0);

33 
»f_út
--;

34 
hªdË
 = (
hªdË_t
 *)
»f_út
;

36 
cu¼’t
->
jouº®_šfo
 = 
hªdË
;

37 
	}
}

42 
	$ext4_jouº®_check_¡¬t
(
su³r_block
 *
sb
)

44 
jouº®_t
 *
jouº®
;

46 
	`might_¦“p
();

48 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
sb
))))

49  -
EIO
;

51 ià(
	`sb_rdÚly
(
sb
))

52  -
EROFS
;

53 
	`WARN_ON
(
sb
->
s_wr™”s
.
äoz’
 =ğ
SB_FREEZE_COMPLETE
);

54 
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

60 ià(
jouº®
 && 
	`is_jouº®_abÜ‹d
(journal)) {

61 
	`ext4_abÜt
(
sb
, "Detected‡borted journal");

62  -
EROFS
;

65 
	}
}

67 
hªdË_t
 *
	$__ext4_jouº®_¡¬t_sb
(
su³r_block
 *
sb
, 
lše
,

68 
ty³
, 
blocks
, 
rsv_blocks
)

70 
jouº®_t
 *
jouº®
;

71 
”r
;

73 
	`Œaû_ext4_jouº®_¡¬t
(
sb
, 
blocks
, 
rsv_blocks
, 
_RET_IP_
);

74 
”r
 = 
	`ext4_jouº®_check_¡¬t
(
sb
);

75 ià(
”r
 < 0)

76  
	`ERR_PTR
(
”r
);

78 
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

79 ià(!
jouº®
)

80  
	`ext4_g‘_nojouº®
();

81  
	`jbd2__jouº®_¡¬t
(
jouº®
, 
blocks
, 
rsv_blocks
, 
GFP_NOFS
,

82 
ty³
, 
lše
);

83 
	}
}

85 
	$__ext4_jouº®_¡İ
(cÚ¡ *
wh”e
, 
lše
, 
hªdË_t
 *
hªdË
)

87 
su³r_block
 *
sb
;

88 
”r
;

89 
rc
;

91 ià(!
	`ext4_hªdË_v®id
(
hªdË
)) {

92 
	`ext4_put_nojouº®
(
hªdË
);

96 
”r
 = 
hªdË
->
h_”r
;

97 ià(!
hªdË
->
h_Œª§ùiÚ
) {

98 
rc
 = 
	`jbd2_jouº®_¡İ
(
hªdË
);

99  
”r
 ?ƒ¼ : 
rc
;

102 
sb
 = 
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
->
j_´iv©e
;

103 
rc
 = 
	`jbd2_jouº®_¡İ
(
hªdË
);

105 ià(!
”r
)

106 
”r
 = 
rc
;

107 ià(
”r
)

108 
	`__ext4_¡d_”rÜ
(
sb
, 
wh”e
, 
lše
, 
”r
);

109  
”r
;

110 
	}
}

112 
hªdË_t
 *
	$__ext4_jouº®_¡¬t_»£rved
(
hªdË_t
 *
hªdË
, 
lše
,

113 
ty³
)

115 
su³r_block
 *
sb
;

116 
”r
;

118 ià(!
	`ext4_hªdË_v®id
(
hªdË
))

119  
	`ext4_g‘_nojouº®
();

121 
sb
 = 
hªdË
->
h_jouº®
->
j_´iv©e
;

122 
	`Œaû_ext4_jouº®_¡¬t_»£rved
(
sb
, 
hªdË
->
h_bufãr_üed™s
,

123 
_RET_IP_
);

124 
”r
 = 
	`ext4_jouº®_check_¡¬t
(
sb
);

125 ià(
”r
 < 0) {

126 
	`jbd2_jouº®_ä“_»£rved
(
hªdË
);

127  
	`ERR_PTR
(
”r
);

130 
”r
 = 
	`jbd2_jouº®_¡¬t_»£rved
(
hªdË
, 
ty³
, 
lše
);

131 ià(
”r
 < 0)

132  
	`ERR_PTR
(
”r
);

133  
hªdË
;

134 
	}
}

136 
	$ext4_jouº®_abÜt_hªdË
(cÚ¡ *
ÿÎ”
, 
lše
,

137 cÚ¡ *
”r_â
,

138 
bufãr_h—d
 *
bh
,

139 
hªdË_t
 *
hªdË
, 
”r
)

141 
nbuf
[16];

142 cÚ¡ *
”r¡r
 = 
	`ext4_decode_”rÜ
(
NULL
, 
”r
, 
nbuf
);

144 
	`BUG_ON
(!
	`ext4_hªdË_v®id
(
hªdË
));

146 ià(
bh
)

147 
	`BUFFER_TRACE
(
bh
, "abort");

149 ià(!
hªdË
->
h_”r
)

150 
hªdË
->
h_”r
 = 
”r
;

152 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

155 
	`´štk
(
KERN_ERR
 "EXT4-fs: %s:%d:‡bortingransaction: %s in %s\n",

156 
ÿÎ”
, 
lše
, 
”r¡r
, 
”r_â
);

158 
	`jbd2_jouº®_abÜt_hªdË
(
hªdË
);

159 
	}
}

161 
	$__ext4_jouº®_g‘_wr™e_acûss
(cÚ¡ *
wh”e
, 
lše
,

162 
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

164 
”r
 = 0;

166 
	`might_¦“p
();

168 ià(
	`ext4_hªdË_v®id
(
hªdË
)) {

169 
”r
 = 
	`jbd2_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

170 ià(
”r
)

171 
	`ext4_jouº®_abÜt_hªdË
(
wh”e
, 
lše
, 
__func__
, 
bh
,

172 
hªdË
, 
”r
);

174  
”r
;

175 
	}
}

189 
	$__ext4_fÜg‘
(cÚ¡ *
wh”e
, 
lše
, 
hªdË_t
 *
hªdË
,

190 
is_m‘ad©a
, 
šode
 *inode,

191 
bufãr_h—d
 *
bh
, 
ext4_fsblk_t
 
blockÄ
)

193 
”r
;

195 
	`might_¦“p
();

197 
	`Œaû_ext4_fÜg‘
(
šode
, 
is_m‘ad©a
, 
blockÄ
);

198 
	`BUFFER_TRACE
(
bh
, "enter");

200 
	`jbd_debug
(4, "forgetting bh %p: is_metadata = %d, mode %o, "

202 
bh
, 
is_m‘ad©a
, 
šode
->
i_mode
,

203 
	`‹¡_İt
(
šode
->
i_sb
, 
DATA_FLAGS
));

206 ià(!
	`ext4_hªdË_v®id
(
hªdË
)) {

207 
	`bfÜg‘
(
bh
);

216 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_JOURNAL_DATA
 ||

217 (!
is_m‘ad©a
 && !
	`ext4_should_jouº®_d©a
(
šode
))) {

218 ià(
bh
) {

219 
	`BUFFER_TRACE
(
bh
, "call jbd2_journal_forget");

220 
”r
 = 
	`jbd2_jouº®_fÜg‘
(
hªdË
, 
bh
);

221 ià(
”r
)

222 
	`ext4_jouº®_abÜt_hªdË
(
wh”e
, 
lše
, 
__func__
,

223 
bh
, 
hªdË
, 
”r
);

224  
”r
;

232 
	`BUFFER_TRACE
(
bh
, "call jbd2_journal_revoke");

233 
”r
 = 
	`jbd2_jouº®_»voke
(
hªdË
, 
blockÄ
, 
bh
);

234 ià(
”r
) {

235 
	`ext4_jouº®_abÜt_hªdË
(
wh”e
, 
lše
, 
__func__
,

236 
bh
, 
hªdË
, 
”r
);

237 
	`__ext4_abÜt
(
šode
->
i_sb
, 
wh”e
, 
lše
,

238 "”rÜ %d wh’‡‰em±šg„evoke", 
”r
);

240 
	`BUFFER_TRACE
(
bh
, "exit");

241  
”r
;

242 
	}
}

244 
	$__ext4_jouº®_g‘_ü—‹_acûss
(cÚ¡ *
wh”e
, 
lše
,

245 
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

247 
”r
 = 0;

249 ià(
	`ext4_hªdË_v®id
(
hªdË
)) {

250 
”r
 = 
	`jbd2_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
bh
);

251 ià(
”r
)

252 
	`ext4_jouº®_abÜt_hªdË
(
wh”e
, 
lše
, 
__func__
,

253 
bh
, 
hªdË
, 
”r
);

255  
”r
;

256 
	}
}

258 
	$__ext4_hªdË_dœty_m‘ad©a
(cÚ¡ *
wh”e
, 
lše
,

259 
hªdË_t
 *
hªdË
, 
šode
 *inode,

260 
bufãr_h—d
 *
bh
)

262 
”r
 = 0;

264 
	`might_¦“p
();

266 
	`£t_bufãr_m‘a
(
bh
);

267 
	`£t_bufãr_´io
(
bh
);

268 ià(
	`ext4_hªdË_v®id
(
hªdË
)) {

269 
”r
 = 
	`jbd2_jouº®_dœty_m‘ad©a
(
hªdË
, 
bh
);

271 ià(!
	`is_hªdË_abÜ‹d
(
hªdË
è&& 
	`WARN_ON_ONCE
(
”r
)) {

272 
	`ext4_jouº®_abÜt_hªdË
(
wh”e
, 
lše
, 
__func__
, 
bh
,

273 
hªdË
, 
”r
);

274 ià(
šode
 =ğ
NULL
) {

275 
	`´_”r
("EXT4: jbd2_journal_dirty_metadata "

278 
hªdË
->
h_ty³
,

279 
hªdË
->
h_lše_no
,

280 
hªdË
->
h_»que¡ed_üed™s
,

281 
hªdË
->
h_bufãr_üed™s
, 
”r
);

282  
”r
;

284 
	`ext4_”rÜ_šode
(
šode
, 
wh”e
, 
lše
,

285 
bh
->
b_blockÄ
,

289 
hªdË
->
h_ty³
,

290 
hªdË
->
h_lše_no
,

291 
hªdË
->
h_»que¡ed_üed™s
,

292 
hªdË
->
h_bufãr_üed™s
, 
”r
);

295 ià(
šode
)

296 
	`m¬k_bufãr_dœty_šode
(
bh
, 
šode
);

298 
	`m¬k_bufãr_dœty
(
bh
);

299 ià(
šode
 && 
	`šode_Ãeds_sync
(inode)) {

300 
	`sync_dœty_bufãr
(
bh
);

301 ià(
	`bufãr_»q
(
bh
è&& !
	`bufãr_u±od©e
(bh)) {

302 
ext4_su³r_block
 *
es
;

304 
es
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
;

305 
es
->
s_Ï¡_”rÜ_block
 =

306 
	`ıu_to_Ë64
(
bh
->
b_blockÄ
);

307 
	`ext4_”rÜ_šode
(
šode
, 
wh”e
, 
lše
,

308 
bh
->
b_blockÄ
,

310 
”r
 = -
EIO
;

314  
”r
;

315 
	}
}

317 
	$__ext4_hªdË_dœty_su³r
(cÚ¡ *
wh”e
, 
lše
,

318 
hªdË_t
 *
hªdË
, 
su³r_block
 *
sb
)

320 
bufãr_h—d
 *
bh
 = 
	`EXT4_SB
(
sb
)->
s_sbh
;

321 
”r
 = 0;

323 
	`ext4_su³rblock_csum_£t
(
sb
);

324 ià(
	`ext4_hªdË_v®id
(
hªdË
)) {

325 
”r
 = 
	`jbd2_jouº®_dœty_m‘ad©a
(
hªdË
, 
bh
);

326 ià(
”r
)

327 
	`ext4_jouº®_abÜt_hªdË
(
wh”e
, 
lše
, 
__func__
,

328 
bh
, 
hªdË
, 
”r
);

330 
	`m¬k_bufãr_dœty
(
bh
);

331  
”r
;

332 
	}
}

	@pxt4/ext4_jbd2.h

12 #iâdeà
_EXT4_JBD2_H


13 
	#_EXT4_JBD2_H


	)

15 
	~<lšux/fs.h
>

16 
	~<lšux/jbd2.h
>

17 
	~"ext4.h
"

19 
	#EXT4_JOURNAL
(
šode
è(
	`EXT4_SB
((šode)->
i_sb
)->
s_jouº®
)

	)

33 
	#EXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
) \

34 (
	`ext4_has_ã©u»_ex‹Ás
(
sb
è? 20U : 8U)

	)

40 
	#EXT4_XATTR_TRANS_BLOCKS
 6U

	)

48 
	#EXT4_DATA_TRANS_BLOCKS
(
sb
è(
	`EXT4_SINGLEDATA_TRANS_BLOCKS
(sb) + \

49 
EXT4_XATTR_TRANS_BLOCKS
 - 2 + \

50 
	`EXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
))

	)

57 
	#EXT4_META_TRANS_BLOCKS
(
sb
è(
EXT4_XATTR_TRANS_BLOCKS
 + \

58 
	`EXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
))

	)

66 
	#EXT4_MAX_TRANS_DATA
 64U

	)

75 
	#EXT4_RESERVE_TRANS_BLOCKS
 12U

	)

84 
	#EXT4_INDEX_EXTRA_TRANS_BLOCKS
 12U

	)

86 #ifdeà
CONFIG_QUOTA


89 
	#EXT4_QUOTA_TRANS_BLOCKS
(
sb
è((
	`‹¡_İt
(sb, 
QUOTA
) ||\

90 
	`ext4_has_ã©u»_quÙa
(
sb
)è? 1 : 0)

	)

93 
	#EXT4_QUOTA_INIT_BLOCKS
(
sb
è((
	`‹¡_İt
(sb, 
QUOTA
) ||\

94 
	`ext4_has_ã©u»_quÙa
(
sb
)) ?\

95 (
DQUOT_INIT_ALLOC
*(
	`EXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
)-3)\

96 +3+
DQUOT_INIT_REWRITE
è: 0)

	)

98 
	#EXT4_QUOTA_DEL_BLOCKS
(
sb
è((
	`‹¡_İt
(sb, 
QUOTA
) ||\

99 
	`ext4_has_ã©u»_quÙa
(
sb
)) ?\

100 (
DQUOT_DEL_ALLOC
*(
	`EXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
)-3)\

101 +3+
DQUOT_DEL_REWRITE
è: 0)

	)

103 
	#EXT4_QUOTA_TRANS_BLOCKS
(
sb
è0

	)

104 
	#EXT4_QUOTA_INIT_BLOCKS
(
sb
è0

	)

105 
	#EXT4_QUOTA_DEL_BLOCKS
(
sb
è0

	)

107 
	#EXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
è(
EXT4_MAXQUOTAS
*
	`EXT4_QUOTA_TRANS_BLOCKS
(sb))

	)

108 
	#EXT4_MAXQUOTAS_INIT_BLOCKS
(
sb
è(
EXT4_MAXQUOTAS
*
	`EXT4_QUOTA_INIT_BLOCKS
(sb))

	)

109 
	#EXT4_MAXQUOTAS_DEL_BLOCKS
(
sb
è(
EXT4_MAXQUOTAS
*
	`EXT4_QUOTA_DEL_BLOCKS
(sb))

	)

114 
	#EXT4_HT_MISC
 0

	)

115 
	#EXT4_HT_INODE
 1

	)

116 
	#EXT4_HT_WRITE_PAGE
 2

	)

117 
	#EXT4_HT_MAP_BLOCKS
 3

	)

118 
	#EXT4_HT_DIR
 4

	)

119 
	#EXT4_HT_TRUNCATE
 5

	)

120 
	#EXT4_HT_QUOTA
 6

	)

121 
	#EXT4_HT_RESIZE
 7

	)

122 
	#EXT4_HT_MIGRATE
 8

	)

123 
	#EXT4_HT_MOVE_EXTENTS
 9

	)

124 
	#EXT4_HT_XATTR
 10

	)

125 
	#EXT4_HT_EXT_CONVERT
 11

	)

126 
	#EXT4_HT_MAX
 12

	)

136 
	sext4_jouº®_cb_’Œy
 {

138 
li¡_h—d
 
	mjû_li¡
;

141 (*
	mjû_func
)(
su³r_block
 *
	msb
,

142 
ext4_jouº®_cb_’Œy
 *
	mjû
, 
	m”rÜ
);

168 
šlše
 
	$_ext4_jouº®_ÿÎback_add
(
hªdË_t
 *
hªdË
,

169 
ext4_jouº®_cb_’Œy
 *
jû
)

172 
	`li¡_add_
(&
jû
->
jû_li¡
, &
hªdË
->
h_Œª§ùiÚ
->
t_´iv©e_li¡
);

173 
	}
}

175 
šlše
 
	$ext4_jouº®_ÿÎback_add
(
hªdË_t
 *
hªdË
,

176 (*
func
)(
su³r_block
 *
sb
,

177 
ext4_jouº®_cb_’Œy
 *
jû
,

178 
rc
),

179 
ext4_jouº®_cb_’Œy
 *
jû
)

181 
ext4_sb_šfo
 *
sbi
 =

182 
	`EXT4_SB
(
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
->
j_´iv©e
);

185 
jû
->
jû_func
 = 
func
;

186 
	`¥š_lock
(&
sbi
->
s_md_lock
);

187 
	`_ext4_jouº®_ÿÎback_add
(
hªdË
, 
jû
);

188 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

189 
	}
}

198 
šlše
 
boŞ
 
	$ext4_jouº®_ÿÎback_Œy_d–
(
hªdË_t
 *
hªdË
,

199 
ext4_jouº®_cb_’Œy
 *
jû
)

201 
boŞ
 
d–‘ed
;

202 
ext4_sb_šfo
 *
sbi
 =

203 
	`EXT4_SB
(
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
->
j_´iv©e
);

205 
	`¥š_lock
(&
sbi
->
s_md_lock
);

206 
d–‘ed
 = !
	`li¡_em±y
(&
jû
->
jû_li¡
);

207 
	`li¡_d–_š™
(&
jû
->
jû_li¡
);

208 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

209  
d–‘ed
;

210 
	}
}

213 
ext4_m¬k_oc_dœty
(
hªdË_t
 *
hªdË
,

214 
šode
 *inode,

215 
ext4_oc
 *
oc
);

222 
ext4_»£rve_šode_wr™e
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

223 
ext4_oc
 *
oc
);

225 
ext4_m¬k_šode_dœty
(
hªdË_t
 *
hªdË
, 
šode
 *inode);

227 
ext4_ex·nd_exŒa_isize
(
šode
 *inode,

228 
Ãw_exŒa_isize
,

229 
ext4_oc
 *
oc
);

233 
__ext4_jouº®_g‘_wr™e_acûss
(cÚ¡ *
wh”e
, 
lše
,

234 
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
);

236 
__ext4_fÜg‘
(cÚ¡ *
wh”e
, 
lše
, 
hªdË_t
 *
hªdË
,

237 
is_m‘ad©a
, 
šode
 *inode,

238 
bufãr_h—d
 *
bh
, 
ext4_fsblk_t
 
blockÄ
);

240 
__ext4_jouº®_g‘_ü—‹_acûss
(cÚ¡ *
wh”e
, 
lše
,

241 
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
);

243 
__ext4_hªdË_dœty_m‘ad©a
(cÚ¡ *
wh”e
, 
lše
,

244 
hªdË_t
 *
hªdË
, 
šode
 *inode,

245 
bufãr_h—d
 *
bh
);

247 
__ext4_hªdË_dœty_su³r
(cÚ¡ *
wh”e
, 
lše
,

248 
hªdË_t
 *
hªdË
, 
su³r_block
 *
sb
);

250 
	#ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
) \

251 
	`__ext4_jouº®_g‘_wr™e_acûss
(
__func__
, 
__LINE__
, (
hªdË
), (
bh
))

	)

252 
	#ext4_fÜg‘
(
hªdË
, 
is_m‘ad©a
, 
šode
, 
bh
, 
block_Ä
) \

253 
	`__ext4_fÜg‘
(
__func__
, 
__LINE__
, (
hªdË
), (
is_m‘ad©a
), (
šode
), \

254 (
bh
), (
block_Ä
))

	)

255 
	#ext4_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
bh
) \

256 
	`__ext4_jouº®_g‘_ü—‹_acûss
(
__func__
, 
__LINE__
, (
hªdË
), (
bh
))

	)

257 
	#ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
) \

258 
	`__ext4_hªdË_dœty_m‘ad©a
(
__func__
, 
__LINE__
, (
hªdË
), (
šode
), \

259 (
bh
))

	)

260 
	#ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
) \

261 
	`__ext4_hªdË_dœty_su³r
(
__func__
, 
__LINE__
, (
hªdË
), (
sb
))

	)

263 
hªdË_t
 *
__ext4_jouº®_¡¬t_sb
(
su³r_block
 *
sb
, 
lše
,

264 
ty³
, 
blocks
, 
rsv_blocks
);

265 
__ext4_jouº®_¡İ
(cÚ¡ *
wh”e
, 
lše
, 
hªdË_t
 *
hªdË
);

267 
	#EXT4_NOJOURNAL_MAX_REF_COUNT
 ((è4096)

	)

271 
šlše
 
	$ext4_hªdË_v®id
(
hªdË_t
 *
hªdË
)

273 ià(()
hªdË
 < 
EXT4_NOJOURNAL_MAX_REF_COUNT
)

276 
	}
}

278 
šlše
 
	$ext4_hªdË_sync
(
hªdË_t
 *
hªdË
)

280 ià(
	`ext4_hªdË_v®id
(
hªdË
))

281 
hªdË
->
h_sync
 = 1;

282 
	}
}

284 
šlše
 
	$ext4_hªdË_is_abÜ‹d
(
hªdË_t
 *
hªdË
)

286 ià(
	`ext4_hªdË_v®id
(
hªdË
))

287  
	`is_hªdË_abÜ‹d
(
hªdË
);

289 
	}
}

291 
šlše
 
	$ext4_hªdË_has_’ough_üed™s
(
hªdË_t
 *
hªdË
, 
Ãeded
)

293 ià(
	`ext4_hªdË_v®id
(
hªdË
è&& hªdË->
h_bufãr_üed™s
 < 
Ãeded
)

296 
	}
}

298 
	#ext4_jouº®_¡¬t_sb
(
sb
, 
ty³
, 
nblocks
) \

299 
	`__ext4_jouº®_¡¬t_sb
((
sb
), 
__LINE__
, (
ty³
), (
nblocks
), 0)

	)

301 
	#ext4_jouº®_¡¬t
(
šode
, 
ty³
, 
nblocks
) \

302 
	`__ext4_jouº®_¡¬t
((
šode
), 
__LINE__
, (
ty³
), (
nblocks
), 0)

	)

304 
	#ext4_jouº®_¡¬t_w™h_»£rve
(
šode
, 
ty³
, 
blocks
, 
rsv_blocks
) \

305 
	`__ext4_jouº®_¡¬t
((
šode
), 
__LINE__
, (
ty³
), (
blocks
), (
rsv_blocks
))

	)

307 
šlše
 
hªdË_t
 *
	$__ext4_jouº®_¡¬t
(
šode
 *inode,

308 
lše
, 
ty³
,

309 
blocks
, 
rsv_blocks
)

311  
	`__ext4_jouº®_¡¬t_sb
(
šode
->
i_sb
, 
lše
, 
ty³
, 
blocks
,

312 
rsv_blocks
);

313 
	}
}

315 
	#ext4_jouº®_¡İ
(
hªdË
) \

316 
	`__ext4_jouº®_¡İ
(
__func__
, 
__LINE__
, (
hªdË
))

	)

318 
	#ext4_jouº®_¡¬t_»£rved
(
hªdË
, 
ty³
) \

319 
	`__ext4_jouº®_¡¬t_»£rved
((
hªdË
), 
__LINE__
, (
ty³
))

	)

321 
hªdË_t
 *
__ext4_jouº®_¡¬t_»£rved
(hªdË_ˆ*
hªdË
, 
lše
,

322 
ty³
);

324 
šlše
 
	$ext4_jouº®_ä“_»£rved
(
hªdË_t
 *
hªdË
)

326 ià(
	`ext4_hªdË_v®id
(
hªdË
))

327 
	`jbd2_jouº®_ä“_»£rved
(
hªdË
);

328 
	}
}

330 
šlše
 
hªdË_t
 *
	$ext4_jouº®_cu¼’t_hªdË
()

332  
	`jouº®_cu¼’t_hªdË
();

333 
	}
}

335 
šlše
 
	$ext4_jouº®_ex‹nd
(
hªdË_t
 *
hªdË
, 
nblocks
)

337 ià(
	`ext4_hªdË_v®id
(
hªdË
))

338  
	`jbd2_jouº®_ex‹nd
(
hªdË
, 
nblocks
);

340 
	}
}

342 
šlše
 
	$ext4_jouº®_»¡¬t
(
hªdË_t
 *
hªdË
, 
nblocks
)

344 ià(
	`ext4_hªdË_v®id
(
hªdË
))

345  
	`jbd2_jouº®_»¡¬t
(
hªdË
, 
nblocks
);

347 
	}
}

349 
šlše
 
	$ext4_jouº®_blocks_³r_·ge
(
šode
 *inode)

351 ià(
	`EXT4_JOURNAL
(
šode
è!ğ
NULL
)

352  
	`jbd2_jouº®_blocks_³r_·ge
(
šode
);

354 
	}
}

356 
šlše
 
	$ext4_jouº®_fÜû_comm™
(
jouº®_t
 *
jouº®
)

358 ià(
jouº®
)

359  
	`jbd2_jouº®_fÜû_comm™
(
jouº®
);

361 
	}
}

363 
šlše
 
	$ext4_jbd2_šode_add_wr™e
(
hªdË_t
 *
hªdË
,

364 
šode
 *šode, 
loff_t
 
¡¬t_by‹
,†off_ˆ
Ëngth
)

366 ià(
	`ext4_hªdË_v®id
(
hªdË
))

367  
	`jbd2_jouº®_šode_¿nged_wr™e
(
hªdË
,

368 
	`EXT4_I
(
šode
)->
jšode
, 
¡¬t_by‹
, 
Ëngth
);

370 
	}
}

372 
šlše
 
	$ext4_jbd2_šode_add_wa™
(
hªdË_t
 *
hªdË
,

373 
šode
 *šode, 
loff_t
 
¡¬t_by‹
,†off_ˆ
Ëngth
)

375 ià(
	`ext4_hªdË_v®id
(
hªdË
))

376  
	`jbd2_jouº®_šode_¿nged_wa™
(
hªdË
,

377 
	`EXT4_I
(
šode
)->
jšode
, 
¡¬t_by‹
, 
Ëngth
);

379 
	}
}

381 
šlše
 
	$ext4_upd©e_šode_fsync_Œªs
(
hªdË_t
 *
hªdË
,

382 
šode
 *inode,

383 
d©async
)

385 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

387 ià(
	`ext4_hªdË_v®id
(
hªdË
è&& !
	`is_hªdË_abÜ‹d
(handle)) {

388 
ei
->
i_sync_tid
 = 
hªdË
->
h_Œª§ùiÚ
->
t_tid
;

389 ià(
d©async
)

390 
ei
->
i_d©async_tid
 = 
hªdË
->
h_Œª§ùiÚ
->
t_tid
;

392 
	}
}

395 
ext4_fÜû_comm™
(
su³r_block
 *
sb
);

400 
	#EXT4_INODE_JOURNAL_DATA_MODE
 0x01

	)

401 
	#EXT4_INODE_ORDERED_DATA_MODE
 0x02

	)

402 
	#EXT4_INODE_WRITEBACK_DATA_MODE
 0x04

	)

404 
šlše
 
	$ext4_šode_jouº®_mode
(
šode
 *inode)

406 ià(
	`EXT4_JOURNAL
(
šode
è=ğ
NULL
)

407  
EXT4_INODE_WRITEBACK_DATA_MODE
;

409 ià(!
	`S_ISREG
(
šode
->
i_mode
) ||

410 
	`‹¡_İt
(
šode
->
i_sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_JOURNAL_DATA
 ||

411 (
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_JOURNAL_DATA
) &&

412 !
	`‹¡_İt
(
šode
->
i_sb
, 
DELALLOC
))) {

414 ià(
	`S_ISREG
(
šode
->
i_mode
è&& 
	`IS_ENCRYPTED
(inode))

415  
EXT4_INODE_ORDERED_DATA_MODE
;

416  
EXT4_INODE_JOURNAL_DATA_MODE
;

418 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_ORDERED_DATA
)

419  
EXT4_INODE_ORDERED_DATA_MODE
;

420 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_WRITEBACK_DATA
)

421  
EXT4_INODE_WRITEBACK_DATA_MODE
;

422 
	`BUG
();

423 
	}
}

425 
šlše
 
	$ext4_should_jouº®_d©a
(
šode
 *inode)

427  
	`ext4_šode_jouº®_mode
(
šode
è& 
EXT4_INODE_JOURNAL_DATA_MODE
;

428 
	}
}

430 
šlše
 
	$ext4_should_Üd”_d©a
(
šode
 *inode)

432  
	`ext4_šode_jouº®_mode
(
šode
è& 
EXT4_INODE_ORDERED_DATA_MODE
;

433 
	}
}

435 
šlše
 
	$ext4_should_wr™eback_d©a
(
šode
 *inode)

437  
	`ext4_šode_jouº®_mode
(
šode
è& 
EXT4_INODE_WRITEBACK_DATA_MODE
;

438 
	}
}

449 
šlše
 
	$ext4_should_diÜ—d_nŞock
(
šode
 *inode)

451 ià(!
	`‹¡_İt
(
šode
->
i_sb
, 
DIOREAD_NOLOCK
))

453 ià(!
	`S_ISREG
(
šode
->
i_mode
))

455 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)))

457 ià(
	`ext4_should_jouº®_d©a
(
šode
))

460 
	}
}

	@pxt4/extents.c

20 
	~<lšux/fs.h
>

21 
	~<lšux/time.h
>

22 
	~<lšux/jbd2.h
>

23 
	~<lšux/highuid.h
>

24 
	~<lšux/·gem­.h
>

25 
	~<lšux/quÙaİs.h
>

26 
	~<lšux/¡ršg.h
>

27 
	~<lšux/¦ab.h
>

28 
	~<lšux/uacûss.h
>

29 
	~<lšux/f›m­.h
>

30 
	~<lšux/backšg-dev.h
>

31 
	~"ext4_jbd2.h
"

32 
	~"ext4_ex‹Ás.h
"

33 
	~"x©Œ.h
"

35 
	~<Œaû/ev’ts/ext4.h
>

40 
	#EXT4_EXT_MAY_ZEROOUT
 0x1

	)

42 
	#EXT4_EXT_MARK_UNWRIT1
 0x2

	)

43 
	#EXT4_EXT_MARK_UNWRIT2
 0x4

	)

45 
	#EXT4_EXT_DATA_VALID1
 0x8

	)

46 
	#EXT4_EXT_DATA_VALID2
 0x10

	)

48 
__Ë32
 
	$ext4_ex‹Á_block_csum
(
šode
 *inode,

49 
ext4_ex‹Á_h—d”
 *
eh
)

51 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

52 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

53 
__u32
 
csum
;

55 
csum
 = 
	`ext4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
eh
,

56 
	`EXT4_EXTENT_TAIL_OFFSET
(
eh
));

57  
	`ıu_to_Ë32
(
csum
);

58 
	}
}

60 
	$ext4_ex‹Á_block_csum_v”ify
(
šode
 *inode,

61 
ext4_ex‹Á_h—d”
 *
eh
)

63 
ext4_ex‹Á_
 *
‘
;

65 ià(!
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

68 
‘
 = 
	`fšd_ext4_ex‹Á_
(
eh
);

69 ià(
‘
->
‘_checksum
 !ğ
	`ext4_ex‹Á_block_csum
(
šode
, 
eh
))

72 
	}
}

74 
	$ext4_ex‹Á_block_csum_£t
(
šode
 *inode,

75 
ext4_ex‹Á_h—d”
 *
eh
)

77 
ext4_ex‹Á_
 *
‘
;

79 ià(!
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

82 
‘
 = 
	`fšd_ext4_ex‹Á_
(
eh
);

83 
‘
->
‘_checksum
 = 
	`ext4_ex‹Á_block_csum
(
šode
, 
eh
);

84 
	}
}

86 
ext4_¥l™_ex‹Á
(
hªdË_t
 *
hªdË
,

87 
šode
 *inode,

88 
ext4_ext_·th
 **
µ©h
,

89 
ext4_m­_blocks
 *
m­
,

90 
¥l™_æag
,

91 
æags
);

93 
ext4_¥l™_ex‹Á_©
(
hªdË_t
 *
hªdË
,

94 
šode
 *inode,

95 
ext4_ext_·th
 **
µ©h
,

96 
ext4_lblk_t
 
¥l™
,

97 
¥l™_æag
,

98 
æags
);

100 
ext4_fšd_d–ayed_ex‹Á
(
šode
 *inode,

101 
ex‹Á_¡©us
 *
Ãwes
);

103 
	$ext4_ext_Œunÿ‹_ex‹nd_»¡¬t
(
hªdË_t
 *
hªdË
,

104 
šode
 *inode,

105 
Ãeded
)

107 
”r
;

109 ià(!
	`ext4_hªdË_v®id
(
hªdË
))

111 ià(
hªdË
->
h_bufãr_üed™s
 >ğ
Ãeded
)

117 
Ãeded
 += 3;

118 
”r
 = 
	`ext4_jouº®_ex‹nd
(
hªdË
, 
Ãeded
 - hªdË->
h_bufãr_üed™s
);

119 ià(
”r
 <= 0)

120  
”r
;

121 
”r
 = 
	`ext4_Œunÿ‹_»¡¬t_Œªs
(
hªdË
, 
šode
, 
Ãeded
);

122 ià(
”r
 == 0)

123 
”r
 = -
EAGAIN
;

125  
”r
;

126 
	}
}

133 
	$ext4_ext_g‘_acûss
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

134 
ext4_ext_·th
 *
·th
)

136 ià(
·th
->
p_bh
) {

138 
	`BUFFER_TRACE
(
·th
->
p_bh
, "get_write_access");

139  
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
·th
->
p_bh
);

144 
	}
}

152 
	$__ext4_ext_dœty
(cÚ¡ *
wh”e
, 
lše
, 
hªdË_t
 *
hªdË
,

153 
šode
 *šode, 
ext4_ext_·th
 *
·th
)

155 
”r
;

157 
	`WARN_ON
(!
	`rw£m_is_locked
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

158 ià(
·th
->
p_bh
) {

159 
	`ext4_ex‹Á_block_csum_£t
(
šode
, 
	`ext_block_hdr
(
·th
->
p_bh
));

161 
”r
 = 
	`__ext4_hªdË_dœty_m‘ad©a
(
wh”e
, 
lše
, 
hªdË
,

162 
šode
, 
·th
->
p_bh
);

165 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

167  
”r
;

168 
	}
}

170 
ext4_fsblk_t
 
	$ext4_ext_fšd_gßl
(
šode
 *inode,

171 
ext4_ext_·th
 *
·th
,

172 
ext4_lblk_t
 
block
)

174 ià(
·th
) {

175 
d•th
 = 
·th
->
p_d•th
;

176 
ext4_ex‹Á
 *
ex
;

195 
ex
 = 
·th
[
d•th
].
p_ext
;

196 ià(
ex
) {

197 
ext4_fsblk_t
 
ext_pblk
 = 
	`ext4_ext_pblock
(
ex
);

198 
ext4_lblk_t
 
ext_block
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

200 ià(
block
 > 
ext_block
)

201  
ext_pblk
 + (
block
 - 
ext_block
);

203  
ext_pblk
 - (
ext_block
 - 
block
);

208 ià(
·th
[
d•th
].
p_bh
)

209  
·th
[
d•th
].
p_bh
->
b_blockÄ
;

213  
	`ext4_šode_to_gßl_block
(
šode
);

214 
	}
}

219 
ext4_fsblk_t


220 
	$ext4_ext_Ãw_m‘a_block
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

221 
ext4_ext_·th
 *
·th
,

222 
ext4_ex‹Á
 *
ex
, *
”r
, 
æags
)

224 
ext4_fsblk_t
 
gßl
, 
Ãwblock
;

226 
gßl
 = 
	`ext4_ext_fšd_gßl
(
šode
, 
·th
, 
	`Ë32_to_ıu
(
ex
->
“_block
));

227 
Ãwblock
 = 
	`ext4_Ãw_m‘a_blocks
(
hªdË
, 
šode
, 
gßl
, 
æags
,

228 
NULL
, 
”r
);

229  
Ãwblock
;

230 
	}
}

232 
šlše
 
	$ext4_ext_¥aû_block
(
šode
 *šode, 
check
)

234 
size
;

236 
size
 = (
šode
->
i_sb
->
s_blocksize
 - (
ext4_ex‹Á_h—d”
))

237 / (
ext4_ex‹Á
);

238 #ifdeà
AGGRESSIVE_TEST


239 ià(!
check
 && 
size
 > 6)

240 
size
 = 6;

242  
size
;

243 
	}
}

245 
šlše
 
	$ext4_ext_¥aû_block_idx
(
šode
 *šode, 
check
)

247 
size
;

249 
size
 = (
šode
->
i_sb
->
s_blocksize
 - (
ext4_ex‹Á_h—d”
))

250 / (
ext4_ex‹Á_idx
);

251 #ifdeà
AGGRESSIVE_TEST


252 ià(!
check
 && 
size
 > 5)

253 
size
 = 5;

255  
size
;

256 
	}
}

258 
šlše
 
	$ext4_ext_¥aû_roÙ
(
šode
 *šode, 
check
)

260 
size
;

262 
size
 = (
	`EXT4_I
(
šode
)->
i_d©a
);

263 
size
 -ğ(
ext4_ex‹Á_h—d”
);

264 
size
 /ğ(
ext4_ex‹Á
);

265 #ifdeà
AGGRESSIVE_TEST


266 ià(!
check
 && 
size
 > 3)

267 
size
 = 3;

269  
size
;

270 
	}
}

272 
šlše
 
	$ext4_ext_¥aû_roÙ_idx
(
šode
 *šode, 
check
)

274 
size
;

276 
size
 = (
	`EXT4_I
(
šode
)->
i_d©a
);

277 
size
 -ğ(
ext4_ex‹Á_h—d”
);

278 
size
 /ğ(
ext4_ex‹Á_idx
);

279 #ifdeà
AGGRESSIVE_TEST


280 ià(!
check
 && 
size
 > 4)

281 
size
 = 4;

283  
size
;

284 
	}
}

286 
šlše
 

287 
	$ext4_fÜû_¥l™_ex‹Á_©
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

288 
ext4_ext_·th
 **
µ©h
, 
ext4_lblk_t
 
lblk
,

289 
noç
)

291 
ext4_ext_·th
 *
·th
 = *
µ©h
;

292 
unwr™‹n
 = 
	`ext4_ext_is_unwr™‹n
(
·th
[·th->
p_d•th
].
p_ext
);

294  
	`ext4_¥l™_ex‹Á_©
(
hªdË
, 
šode
, 
µ©h
, 
lblk
, 
unwr™‹n
 ?

295 
EXT4_EXT_MARK_UNWRIT1
|
EXT4_EXT_MARK_UNWRIT2
 : 0,

296 
EXT4_EX_NOCACHE
 | 
EXT4_GET_BLOCKS_PRE_IO
 |

297 (
noç
 ? 
EXT4_GET_BLOCKS_METADATA_NOFAIL
:0));

298 
	}
}

305 
	$ext4_ext_ÿlc_m‘ad©a_amouÁ
(
šode
 *šode, 
ext4_lblk_t
 
lblock
)

307 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

308 
idxs
;

310 
idxs
 = ((
šode
->
i_sb
->
s_blocksize
 - (
ext4_ex‹Á_h—d”
))

311 / (
ext4_ex‹Á_idx
));

321 ià(
ei
->
i_da_m‘ad©a_ÿlc_Ën
 &&

322 
ei
->
i_da_m‘ad©a_ÿlc_Ï¡_lblock
+1 =ğ
lblock
) {

323 
num
 = 0;

325 ià((
ei
->
i_da_m‘ad©a_ÿlc_Ën
 % 
idxs
) == 0)

326 
num
++;

327 ià((
ei
->
i_da_m‘ad©a_ÿlc_Ën
 % (
idxs
*idxs)) == 0)

328 
num
++;

329 ià((
ei
->
i_da_m‘ad©a_ÿlc_Ën
 % (
idxs
*idxs*idxs)) == 0) {

330 
num
++;

331 
ei
->
i_da_m‘ad©a_ÿlc_Ën
 = 0;

333 
ei
->
i_da_m‘ad©a_ÿlc_Ën
++;

334 
ei
->
i_da_m‘ad©a_ÿlc_Ï¡_lblock
++;

335  
num
;

342 
ei
->
i_da_m‘ad©a_ÿlc_Ën
 = 1;

343 
ei
->
i_da_m‘ad©a_ÿlc_Ï¡_lblock
 = 
lblock
;

344  
	`ext_d•th
(
šode
) + 1;

345 
	}
}

348 
	$ext4_ext_max_’Œ›s
(
šode
 *šode, 
d•th
)

350 
max
;

352 ià(
d•th
 =ğ
	`ext_d•th
(
šode
)) {

353 ià(
d•th
 == 0)

354 
max
 = 
	`ext4_ext_¥aû_roÙ
(
šode
, 1);

356 
max
 = 
	`ext4_ext_¥aû_roÙ_idx
(
šode
, 1);

358 ià(
d•th
 == 0)

359 
max
 = 
	`ext4_ext_¥aû_block
(
šode
, 1);

361 
max
 = 
	`ext4_ext_¥aû_block_idx
(
šode
, 1);

364  
max
;

365 
	}
}

367 
	$ext4_v®id_ex‹Á
(
šode
 *šode, 
ext4_ex‹Á
 *
ext
)

369 
ext4_fsblk_t
 
block
 = 
	`ext4_ext_pblock
(
ext
);

370 
Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ext
);

371 
ext4_lblk_t
 
lblock
 = 
	`Ë32_to_ıu
(
ext
->
“_block
);

378 ià(
lblock
 + 
Ën
 <=†block)

380  
	`ext4_d©a_block_v®id
(
	`EXT4_SB
(
šode
->
i_sb
), 
block
, 
Ën
);

381 
	}
}

383 
	$ext4_v®id_ex‹Á_idx
(
šode
 *inode,

384 
ext4_ex‹Á_idx
 *
ext_idx
)

386 
ext4_fsblk_t
 
block
 = 
	`ext4_idx_pblock
(
ext_idx
);

388  
	`ext4_d©a_block_v®id
(
	`EXT4_SB
(
šode
->
i_sb
), 
block
, 1);

389 
	}
}

391 
	$ext4_v®id_ex‹Á_’Œ›s
(
šode
 *inode,

392 
ext4_ex‹Á_h—d”
 *
eh
,

393 
d•th
)

395 
’Œ›s
;

396 ià(
eh
->
eh_’Œ›s
 == 0)

399 
’Œ›s
 = 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
);

401 ià(
d•th
 == 0) {

403 
ext4_ex‹Á
 *
ext
 = 
	`EXT_FIRST_EXTENT
(
eh
);

404 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
;

405 
ext4_fsblk_t
 
pblock
 = 0;

406 
ext4_lblk_t
 
lblock
 = 0;

407 
ext4_lblk_t
 
´ev
 = 0;

408 
Ën
 = 0;

409 
’Œ›s
) {

410 ià(!
	`ext4_v®id_ex‹Á
(
šode
, 
ext
))

414 
lblock
 = 
	`Ë32_to_ıu
(
ext
->
“_block
);

415 
Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ext
);

416 ià((
lblock
 <ğ
´ev
) &&…rev) {

417 
pblock
 = 
	`ext4_ext_pblock
(
ext
);

418 
es
->
s_Ï¡_”rÜ_block
 = 
	`ıu_to_Ë64
(
pblock
);

421 
ext
++;

422 
’Œ›s
--;

423 
´ev
 = 
lblock
 + 
Ën
 - 1;

426 
ext4_ex‹Á_idx
 *
ext_idx
 = 
	`EXT_FIRST_INDEX
(
eh
);

427 
’Œ›s
) {

428 ià(!
	`ext4_v®id_ex‹Á_idx
(
šode
, 
ext_idx
))

430 
ext_idx
++;

431 
’Œ›s
--;

435 
	}
}

437 
	$__ext4_ext_check
(cÚ¡ *
funùiÚ
, 
lše
,

438 
šode
 *šode, 
ext4_ex‹Á_h—d”
 *
eh
,

439 
d•th
, 
ext4_fsblk_t
 
pblk
)

441 cÚ¡ *
”rÜ_msg
;

442 
max
 = 0, 
”r
 = -
EFSCORRUPTED
;

444 ià(
	`uÆik–y
(
eh
->
eh_magic
 !ğ
EXT4_EXT_MAGIC
)) {

445 
”rÜ_msg
 = "invalid magic";

446 
cÜru±ed
;

448 ià(
	`uÆik–y
(
	`Ë16_to_ıu
(
eh
->
eh_d•th
è!ğ
d•th
)) {

449 
”rÜ_msg
 = "unexpectedƒh_depth";

450 
cÜru±ed
;

452 ià(
	`uÆik–y
(
eh
->
eh_max
 == 0)) {

453 
”rÜ_msg
 = "invalidƒh_max";

454 
cÜru±ed
;

456 
max
 = 
	`ext4_ext_max_’Œ›s
(
šode
, 
d•th
);

457 ià(
	`uÆik–y
(
	`Ë16_to_ıu
(
eh
->
eh_max
è> 
max
)) {

458 
”rÜ_msg
 = "too†argeƒh_max";

459 
cÜru±ed
;

461 ià(
	`uÆik–y
(
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
è>†e16_to_ıuÓh->
eh_max
))) {

462 
”rÜ_msg
 = "invalidƒh_entries";

463 
cÜru±ed
;

465 ià(!
	`ext4_v®id_ex‹Á_’Œ›s
(
šode
, 
eh
, 
d•th
)) {

466 
”rÜ_msg
 = "invalidƒxtentƒntries";

467 
cÜru±ed
;

469 ià(
	`uÆik–y
(
d•th
 > 32)) {

470 
”rÜ_msg
 = "too†argeƒh_depth";

471 
cÜru±ed
;

474 ià(
	`ext_d•th
(
šode
è!ğ
d•th
 &&

475 !
	`ext4_ex‹Á_block_csum_v”ify
(
šode
, 
eh
)) {

476 
”rÜ_msg
 = "extentree corrupted";

477 
”r
 = -
EFSBADCRC
;

478 
cÜru±ed
;

482 
cÜru±ed
:

483 
	`ext4_”rÜ_šode
(
šode
, 
funùiÚ
, 
lše
, 0,

486 (è
pblk
, 
”rÜ_msg
,

487 
	`Ë16_to_ıu
(
eh
->
eh_magic
),

488 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
),†e16_to_ıuÓh->
eh_max
),

489 
max
, 
	`Ë16_to_ıu
(
eh
->
eh_d•th
), 
d•th
);

490  
”r
;

491 
	}
}

493 
	#ext4_ext_check
(
šode
, 
eh
, 
d•th
, 
pblk
) \

494 
	`__ext4_ext_check
(
__func__
, 
__LINE__
, (
šode
), (
eh
), (
d•th
), (
pblk
))

	)

496 
	$ext4_ext_check_šode
(
šode
 *inode)

498  
	`ext4_ext_check
(
šode
, 
	`ext_šode_hdr
(šode), 
	`ext_d•th
(inode), 0);

499 
	}
}

501 
bufãr_h—d
 *

502 
	$__»ad_ex‹Á_Œ“_block
(cÚ¡ *
funùiÚ
, 
lše
,

503 
šode
 *šode, 
ext4_fsblk_t
 
pblk
, 
d•th
,

504 
æags
)

506 
bufãr_h—d
 *
bh
;

507 
”r
;

509 
bh
 = 
	`sb_g‘blk_gå
(
šode
->
i_sb
, 
pblk
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

510 ià(
	`uÆik–y
(!
bh
))

511  
	`ERR_PTR
(-
ENOMEM
);

513 ià(!
	`bh_u±od©e_Ü_lock
(
bh
)) {

514 
	`Œaû_ext4_ext_lßd_ex‹Á
(
šode
, 
pblk
, 
_RET_IP_
);

515 
”r
 = 
	`bh_subm™_»ad
(
bh
);

516 ià(
”r
 < 0)

517 
”rout
;

519 ià(
	`bufãr_v”if›d
(
bh
è&& !(
æags
 & 
EXT4_EX_FORCE_CACHE
))

520  
bh
;

521 ià(!
	`ext4_has_ã©u»_jouº®
(
šode
->
i_sb
) ||

522 (
šode
->
i_šo
 !=

523 
	`Ë32_to_ıu
(
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
->
s_jouº®_šum
))) {

524 
”r
 = 
	`__ext4_ext_check
(
funùiÚ
, 
lše
, 
šode
,

525 
	`ext_block_hdr
(
bh
), 
d•th
, 
pblk
);

526 ià(
”r
)

527 
”rout
;

529 
	`£t_bufãr_v”if›d
(
bh
);

533 ià(!(
æags
 & 
EXT4_EX_NOCACHE
è&& 
d•th
 == 0) {

534 
ext4_ex‹Á_h—d”
 *
eh
 = 
	`ext_block_hdr
(
bh
);

535 
ext4_ex‹Á
 *
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

536 
ext4_lblk_t
 
´ev
 = 0;

537 
i
;

539 
i
 = 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
); i > 0; i--, 
ex
++) {

540 
¡©us
 = 
EXTENT_STATUS_WRITTEN
;

541 
ext4_lblk_t
 
lblk
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

542 
Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

544 ià(
´ev
 && (´ev !ğ
lblk
))

545 
	`ext4_es_ÿche_ex‹Á
(
šode
, 
´ev
,

546 
lblk
 - 
´ev
, ~0,

547 
EXTENT_STATUS_HOLE
);

549 ià(
	`ext4_ext_is_unwr™‹n
(
ex
))

550 
¡©us
 = 
EXTENT_STATUS_UNWRITTEN
;

551 
	`ext4_es_ÿche_ex‹Á
(
šode
, 
lblk
, 
Ën
,

552 
	`ext4_ext_pblock
(
ex
), 
¡©us
);

553 
´ev
 = 
lblk
 + 
Ën
;

556  
bh
;

557 
”rout
:

558 
	`put_bh
(
bh
);

559  
	`ERR_PTR
(
”r
);

561 
	}
}

563 
	#»ad_ex‹Á_Œ“_block
(
šode
, 
pblk
, 
d•th
, 
æags
) \

564 
	`__»ad_ex‹Á_Œ“_block
(
__func__
, 
__LINE__
, (
šode
), (
pblk
), \

565 (
d•th
), (
æags
))

	)

571 
	$ext4_ext_´eÿche
(
šode
 *inode)

573 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

574 
ext4_ext_·th
 *
·th
 = 
NULL
;

575 
bufãr_h—d
 *
bh
;

576 
i
 = 0, 
d•th
, 
»t
 = 0;

578 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

581 
	`down_»ad
(&
ei
->
i_d©a_£m
);

582 
d•th
 = 
	`ext_d•th
(
šode
);

584 
·th
 = 
	`kÿÎoc
(
d•th
 + 1, (
ext4_ext_·th
),

585 
GFP_NOFS
);

586 ià(
·th
 =ğ
NULL
) {

587 
	`up_»ad
(&
ei
->
i_d©a_£m
);

588  -
ENOMEM
;

592 ià(
d•th
 == 0)

593 
out
;

594 
·th
[0].
p_hdr
 = 
	`ext_šode_hdr
(
šode
);

595 
»t
 = 
	`ext4_ext_check
(
šode
, 
·th
[0].
p_hdr
, 
d•th
, 0);

596 ià(
»t
)

597 
out
;

598 
·th
[0].
p_idx
 = 
	`EXT_FIRST_INDEX
Õ©h[0].
p_hdr
);

599 
i
 >= 0) {

604 ià((
i
 =ğ
d•th
) ||

605 
·th
[
i
].
p_idx
 > 
	`EXT_LAST_INDEX
Õ©h[i].
p_hdr
)) {

606 
	`b»l£
(
·th
[
i
].
p_bh
);

607 
·th
[
i
].
p_bh
 = 
NULL
;

608 
i
--;

611 
bh
 = 
	`»ad_ex‹Á_Œ“_block
(
šode
,

612 
	`ext4_idx_pblock
(
·th
[
i
].
p_idx
++),

613 
d•th
 - 
i
 - 1,

614 
EXT4_EX_FORCE_CACHE
);

615 ià(
	`IS_ERR
(
bh
)) {

616 
»t
 = 
	`PTR_ERR
(
bh
);

619 
i
++;

620 
·th
[
i
].
p_bh
 = 
bh
;

621 
·th
[
i
].
p_hdr
 = 
	`ext_block_hdr
(
bh
);

622 
·th
[
i
].
p_idx
 = 
	`EXT_FIRST_INDEX
Õ©h[i].
p_hdr
);

624 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_EXT_PRECACHED
);

625 
out
:

626 
	`up_»ad
(&
ei
->
i_d©a_£m
);

627 
	`ext4_ext_drİ_»fs
(
·th
);

628 
	`kä“
(
·th
);

629  
»t
;

630 
	}
}

632 #ifdeà
EXT_DEBUG


633 
	$ext4_ext_show_·th
(
šode
 *šode, 
ext4_ext_·th
 *
·th
)

635 
k
, 
l
 = 
·th
->
p_d•th
;

637 
	`ext_debug
("path:");

638 
k
 = 0; k <ğ
l
; k++, 
·th
++) {

639 ià(
·th
->
p_idx
) {

640 
	`ext_debug
(" %d->%Îu", 
	`Ë32_to_ıu
(
·th
->
p_idx
->
ei_block
),

641 
	`ext4_idx_pblock
(
·th
->
p_idx
));

642 } ià(
·th
->
p_ext
) {

643 
	`ext_debug
(" %d:[%d]%d:%llu ",

644 
	`Ë32_to_ıu
(
·th
->
p_ext
->
“_block
),

645 
	`ext4_ext_is_unwr™‹n
(
·th
->
p_ext
),

646 
	`ext4_ext_g‘_aùu®_Ën
(
·th
->
p_ext
),

647 
	`ext4_ext_pblock
(
·th
->
p_ext
));

649 
	`ext_debug
(" []");

651 
	`ext_debug
("\n");

652 
	}
}

654 
	$ext4_ext_show_Ëaf
(
šode
 *šode, 
ext4_ext_·th
 *
·th
)

656 
d•th
 = 
	`ext_d•th
(
šode
);

657 
ext4_ex‹Á_h—d”
 *
eh
;

658 
ext4_ex‹Á
 *
ex
;

659 
i
;

661 ià(!
·th
)

664 
eh
 = 
·th
[
d•th
].
p_hdr
;

665 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

667 
	`ext_debug
("Di¥Ïyšg†—àex‹Á fÜ inod%lu\n", 
šode
->
i_šo
);

669 
i
 = 0; i < 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
); i++, 
ex
++) {

670 
	`ext_debug
("%d:[%d]%d:%Îu ", 
	`Ë32_to_ıu
(
ex
->
“_block
),

671 
	`ext4_ext_is_unwr™‹n
(
ex
),

672 
	`ext4_ext_g‘_aùu®_Ën
(
ex
), 
	`ext4_ext_pblock
(ex));

674 
	`ext_debug
("\n");

675 
	}
}

677 
	$ext4_ext_show_move
(
šode
 *šode, 
ext4_ext_·th
 *
·th
,

678 
ext4_fsblk_t
 
Ãwblock
, 
Ëv–
)

680 
d•th
 = 
	`ext_d•th
(
šode
);

681 
ext4_ex‹Á
 *
ex
;

683 ià(
d•th
 !ğ
Ëv–
) {

684 
ext4_ex‹Á_idx
 *
idx
;

685 
idx
 = 
·th
[
Ëv–
].
p_idx
;

686 
idx
 <ğ
	`EXT_MAX_INDEX
(
·th
[
Ëv–
].
p_hdr
)) {

687 
	`ext_debug
("%d: mov%d:%Îu iÀÃw index %Îu\n", 
Ëv–
,

688 
	`Ë32_to_ıu
(
idx
->
ei_block
),

689 
	`ext4_idx_pblock
(
idx
),

690 
Ãwblock
);

691 
idx
++;

697 
ex
 = 
·th
[
d•th
].
p_ext
;

698 
ex
 <ğ
	`EXT_MAX_EXTENT
(
·th
[
d•th
].
p_hdr
)) {

699 
	`ext_debug
("move %d:%llu:[%d]%d in‚ew†eaf %llu\n",

700 
	`Ë32_to_ıu
(
ex
->
“_block
),

701 
	`ext4_ext_pblock
(
ex
),

702 
	`ext4_ext_is_unwr™‹n
(
ex
),

703 
	`ext4_ext_g‘_aùu®_Ën
(
ex
),

704 
Ãwblock
);

705 
ex
++;

707 
	}
}

710 
	#ext4_ext_show_·th
(
šode
, 
·th
)

	)

711 
	#ext4_ext_show_Ëaf
(
šode
, 
·th
)

	)

712 
	#ext4_ext_show_move
(
šode
, 
·th
, 
Ãwblock
, 
Ëv–
)

	)

715 
	$ext4_ext_drİ_»fs
(
ext4_ext_·th
 *
·th
)

717 
d•th
, 
i
;

719 ià(!
·th
)

721 
d•th
 = 
·th
->
p_d•th
;

722 
i
 = 0; i <ğ
d•th
; i++, 
·th
++)

723 ià(
·th
->
p_bh
) {

724 
	`b»l£
(
·th
->
p_bh
);

725 
·th
->
p_bh
 = 
NULL
;

727 
	}
}

735 
	$ext4_ext_bš£¬ch_idx
(
šode
 *inode,

736 
ext4_ext_·th
 *
·th
, 
ext4_lblk_t
 
block
)

738 
ext4_ex‹Á_h—d”
 *
eh
 = 
·th
->
p_hdr
;

739 
ext4_ex‹Á_idx
 *
r
, *
l
, *
m
;

742 
	`ext_debug
("bš£¬ch fÜ %u(idx): ", 
block
);

744 
l
 = 
	`EXT_FIRST_INDEX
(
eh
) + 1;

745 
r
 = 
	`EXT_LAST_INDEX
(
eh
);

746 
l
 <ğ
r
) {

747 
m
 = 
l
 + (
r
 -†) / 2;

748 ià(
block
 < 
	`Ë32_to_ıu
(
m
->
ei_block
))

749 
r
 = 
m
 - 1;

751 
l
 = 
m
 + 1;

752 
	`ext_debug
("%p(%u):%p(%u):%p(%uè", 
l
, 
	`Ë32_to_ıu
Ö->
ei_block
),

753 
m
, 
	`Ë32_to_ıu
(m->
ei_block
),

754 
r
, 
	`Ë32_to_ıu
Ô->
ei_block
));

757 
·th
->
p_idx
 = 
l
 - 1;

758 
	`ext_debug
(" -> %u->%Îd ", 
	`Ë32_to_ıu
(
·th
->
p_idx
->
ei_block
),

759 
	`ext4_idx_pblock
(
·th
->
p_idx
));

761 #ifdeà
CHECK_BINSEARCH


763 
ext4_ex‹Á_idx
 *
chix
, *
ix
;

764 
k
;

766 
chix
 = 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

767 
k
 = 0; k < 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
); k++, 
ix
++) {

768 ià(
k
 != 0 &&

769 
	`Ë32_to_ıu
(
ix
->
ei_block
) <=†e32_to_cpu(ix[-1].ei_block)) {

770 
	`´štk
(
KERN_DEBUG
 "k=%d, ix=0x%p, "

771 "fœ¡=0x%p\n", 
k
,

772 
ix
, 
	`EXT_FIRST_INDEX
(
eh
));

773 
	`´štk
(
KERN_DEBUG
 "%u <= %u\n",

774 
	`Ë32_to_ıu
(
ix
->
ei_block
),

775 
	`Ë32_to_ıu
(
ix
[-1].
ei_block
));

777 
	`BUG_ON
(
k
 && 
	`Ë32_to_ıu
(
ix
->
ei_block
)

778 <ğ
	`Ë32_to_ıu
(
ix
[-1].
ei_block
));

779 ià(
block
 < 
	`Ë32_to_ıu
(
ix
->
ei_block
))

781 
chix
 = 
ix
;

783 
	`BUG_ON
(
chix
 !ğ
·th
->
p_idx
);

787 
	}
}

795 
	$ext4_ext_bš£¬ch
(
šode
 *inode,

796 
ext4_ext_·th
 *
·th
, 
ext4_lblk_t
 
block
)

798 
ext4_ex‹Á_h—d”
 *
eh
 = 
·th
->
p_hdr
;

799 
ext4_ex‹Á
 *
r
, *
l
, *
m
;

801 ià(
eh
->
eh_’Œ›s
 == 0) {

809 
	`ext_debug
("bš£¬ch fÜ %u: ", 
block
);

811 
l
 = 
	`EXT_FIRST_EXTENT
(
eh
) + 1;

812 
r
 = 
	`EXT_LAST_EXTENT
(
eh
);

814 
l
 <ğ
r
) {

815 
m
 = 
l
 + (
r
 -†) / 2;

816 ià(
block
 < 
	`Ë32_to_ıu
(
m
->
“_block
))

817 
r
 = 
m
 - 1;

819 
l
 = 
m
 + 1;

820 
	`ext_debug
("%p(%u):%p(%u):%p(%uè", 
l
, 
	`Ë32_to_ıu
Ö->
“_block
),

821 
m
, 
	`Ë32_to_ıu
(m->
“_block
),

822 
r
, 
	`Ë32_to_ıu
Ô->
“_block
));

825 
·th
->
p_ext
 = 
l
 - 1;

826 
	`ext_debug
(" -> %d:%llu:[%d]%d ",

827 
	`Ë32_to_ıu
(
·th
->
p_ext
->
“_block
),

828 
	`ext4_ext_pblock
(
·th
->
p_ext
),

829 
	`ext4_ext_is_unwr™‹n
(
·th
->
p_ext
),

830 
	`ext4_ext_g‘_aùu®_Ën
(
·th
->
p_ext
));

832 #ifdeà
CHECK_BINSEARCH


834 
ext4_ex‹Á
 *
chex
, *
ex
;

835 
k
;

837 
chex
 = 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

838 
k
 = 0; k < 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
); k++, 
ex
++) {

839 
	`BUG_ON
(
k
 && 
	`Ë32_to_ıu
(
ex
->
“_block
)

840 <ğ
	`Ë32_to_ıu
(
ex
[-1].
“_block
));

841 ià(
block
 < 
	`Ë32_to_ıu
(
ex
->
“_block
))

843 
chex
 = 
ex
;

845 
	`BUG_ON
(
chex
 !ğ
·th
->
p_ext
);

849 
	}
}

851 
	$ext4_ext_Œ“_š™
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

853 
ext4_ex‹Á_h—d”
 *
eh
;

855 
eh
 = 
	`ext_šode_hdr
(
šode
);

856 
eh
->
eh_d•th
 = 0;

857 
eh
->
eh_’Œ›s
 = 0;

858 
eh
->
eh_magic
 = 
EXT4_EXT_MAGIC
;

859 
eh
->
eh_max
 = 
	`ıu_to_Ë16
(
	`ext4_ext_¥aû_roÙ
(
šode
, 0));

860 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

862 
	}
}

864 
ext4_ext_·th
 *

865 
	$ext4_fšd_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
block
,

866 
ext4_ext_·th
 **
Üig_·th
, 
æags
)

868 
ext4_ex‹Á_h—d”
 *
eh
;

869 
bufãr_h—d
 *
bh
;

870 
ext4_ext_·th
 *
·th
 = 
Üig_·th
 ? *Üig_·th : 
NULL
;

871 
d•th
, 
i
, 
µos
 = 0;

872 
»t
;

874 
eh
 = 
	`ext_šode_hdr
(
šode
);

875 
d•th
 = 
	`ext_d•th
(
šode
);

876 ià(
d•th
 < 0 || d•th > 
EXT4_MAX_EXTENT_DEPTH
) {

877 
	`EXT4_ERROR_INODE
(
šode
, "inode has invalidƒxtent depth: %d",

878 
d•th
);

879 
»t
 = -
EFSCORRUPTED
;

880 
”r
;

883 ià(
·th
) {

884 
	`ext4_ext_drİ_»fs
(
·th
);

885 ià(
d•th
 > 
·th
[0].
p_maxd•th
) {

886 
	`kä“
(
·th
);

887 *
Üig_·th
 = 
·th
 = 
NULL
;

890 ià(!
·th
) {

892 
·th
 = 
	`kÿÎoc
(
d•th
 + 2, (
ext4_ext_·th
),

893 
GFP_NOFS
);

894 ià(
	`uÆik–y
(!
·th
))

895  
	`ERR_PTR
(-
ENOMEM
);

896 
·th
[0].
p_maxd•th
 = 
d•th
 + 1;

898 
·th
[0].
p_hdr
 = 
eh
;

899 
·th
[0].
p_bh
 = 
NULL
;

901 
i
 = 
d•th
;

903 
i
) {

904 
	`ext_debug
("depth %d:‚um %d, max %d\n",

905 
µos
, 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
),†e16_to_ıuÓh->
eh_max
));

907 
	`ext4_ext_bš£¬ch_idx
(
šode
, 
·th
 + 
µos
, 
block
);

908 
·th
[
µos
].
p_block
 = 
	`ext4_idx_pblock
Õ©h[µos].
p_idx
);

909 
·th
[
µos
].
p_d•th
 = 
i
;

910 
·th
[
µos
].
p_ext
 = 
NULL
;

912 
bh
 = 
	`»ad_ex‹Á_Œ“_block
(
šode
, 
·th
[
µos
].
p_block
, --
i
,

913 
æags
);

914 ià(
	`IS_ERR
(
bh
)) {

915 
»t
 = 
	`PTR_ERR
(
bh
);

916 
”r
;

919 
eh
 = 
	`ext_block_hdr
(
bh
);

920 
µos
++;

921 
·th
[
µos
].
p_bh
 = 
bh
;

922 
·th
[
µos
].
p_hdr
 = 
eh
;

925 
·th
[
µos
].
p_d•th
 = 
i
;

926 
·th
[
µos
].
p_ext
 = 
NULL
;

927 
·th
[
µos
].
p_idx
 = 
NULL
;

930 
	`ext4_ext_bš£¬ch
(
šode
, 
·th
 + 
µos
, 
block
);

932 ià(
·th
[
µos
].
p_ext
)

933 
·th
[
µos
].
p_block
 = 
	`ext4_ext_pblock
Õ©h[µos].
p_ext
);

935 
	`ext4_ext_show_·th
(
šode
, 
·th
);

937  
·th
;

939 
”r
:

940 
	`ext4_ext_drİ_»fs
(
·th
);

941 
	`kä“
(
·th
);

942 ià(
Üig_·th
)

943 *
Üig_·th
 = 
NULL
;

944  
	`ERR_PTR
(
»t
);

945 
	}
}

952 
	$ext4_ext_š£¹_šdex
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

953 
ext4_ext_·th
 *
cu½
,

954 
logiÿl
, 
ext4_fsblk_t
 
±r
)

956 
ext4_ex‹Á_idx
 *
ix
;

957 
Ën
, 
”r
;

959 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
cu½
);

960 ià(
”r
)

961  
”r
;

963 ià(
	`uÆik–y
(
logiÿl
 =ğ
	`Ë32_to_ıu
(
cu½
->
p_idx
->
ei_block
))) {

964 
	`EXT4_ERROR_INODE
(
šode
,

966 
logiÿl
, 
	`Ë32_to_ıu
(
cu½
->
p_idx
->
ei_block
));

967  -
EFSCORRUPTED
;

970 ià(
	`uÆik–y
(
	`Ë16_to_ıu
(
cu½
->
p_hdr
->
eh_’Œ›s
)

971 >ğ
	`Ë16_to_ıu
(
cu½
->
p_hdr
->
eh_max
))) {

972 
	`EXT4_ERROR_INODE
(
šode
,

974 
	`Ë16_to_ıu
(
cu½
->
p_hdr
->
eh_’Œ›s
),

975 
	`Ë16_to_ıu
(
cu½
->
p_hdr
->
eh_max
));

976  -
EFSCORRUPTED
;

979 ià(
logiÿl
 > 
	`Ë32_to_ıu
(
cu½
->
p_idx
->
ei_block
)) {

981 
	`ext_debug
("š£¹‚ew index %d‡á”: %Îu\n", 
logiÿl
, 
±r
);

982 
ix
 = 
cu½
->
p_idx
 + 1;

985 
	`ext_debug
("š£¹‚ew index %d befÜe: %Îu\n", 
logiÿl
, 
±r
);

986 
ix
 = 
cu½
->
p_idx
;

989 
Ën
 = 
	`EXT_LAST_INDEX
(
cu½
->
p_hdr
è- 
ix
 + 1;

990 
	`BUG_ON
(
Ën
 < 0);

991 ià(
Ën
 > 0) {

992 
	`ext_debug
("insert‚ew index %d: "

994 
logiÿl
, 
Ën
, 
ix
, ix + 1);

995 
	`memmove
(
ix
 + 1, ix, 
Ën
 * (
ext4_ex‹Á_idx
));

998 ià(
	`uÆik–y
(
ix
 > 
	`EXT_MAX_INDEX
(
cu½
->
p_hdr
))) {

999 
	`EXT4_ERROR_INODE
(
šode
, "ix > EXT_MAX_INDEX!");

1000  -
EFSCORRUPTED
;

1003 
ix
->
ei_block
 = 
	`ıu_to_Ë32
(
logiÿl
);

1004 
	`ext4_idx_¡Üe_pblock
(
ix
, 
±r
);

1005 
	`Ë16_add_ıu
(&
cu½
->
p_hdr
->
eh_’Œ›s
, 1);

1007 ià(
	`uÆik–y
(
ix
 > 
	`EXT_LAST_INDEX
(
cu½
->
p_hdr
))) {

1008 
	`EXT4_ERROR_INODE
(
šode
, "ix > EXT_LAST_INDEX!");

1009  -
EFSCORRUPTED
;

1012 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
cu½
);

1013 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”r
);

1015  
”r
;

1016 
	}
}

1028 
	$ext4_ext_¥l™
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1029 
æags
,

1030 
ext4_ext_·th
 *
·th
,

1031 
ext4_ex‹Á
 *
Ãwext
, 
©
)

1033 
bufãr_h—d
 *
bh
 = 
NULL
;

1034 
d•th
 = 
	`ext_d•th
(
šode
);

1035 
ext4_ex‹Á_h—d”
 *
Ãh
;

1036 
ext4_ex‹Á_idx
 *
fidx
;

1037 
i
 = 
©
, 
k
, 
m
, 
a
;

1038 
ext4_fsblk_t
 
Ãwblock
, 
Şdblock
;

1039 
__Ë32
 
bÜd”
;

1040 
ext4_fsblk_t
 *
ablocks
 = 
NULL
;

1041 
”r
 = 0;

1042 
size_t
 
ext_size
 = 0;

1049 ià(
	`uÆik–y
(
·th
[
d•th
].
p_ext
 > 
	`EXT_MAX_EXTENT
Õ©h[d•th].
p_hdr
))) {

1050 
	`EXT4_ERROR_INODE
(
šode
, "p_ext > EXT_MAX_EXTENT!");

1051  -
EFSCORRUPTED
;

1053 ià(
·th
[
d•th
].
p_ext
 !ğ
	`EXT_MAX_EXTENT
Õ©h[d•th].
p_hdr
)) {

1054 
bÜd”
 = 
·th
[
d•th
].
p_ext
[1].
“_block
;

1055 
	`ext_debug
("leaf will be split."

1057 
	`Ë32_to_ıu
(
bÜd”
));

1059 
bÜd”
 = 
Ãwext
->
“_block
;

1060 
	`ext_debug
("leaf will be‡dded."

1062 
	`Ë32_to_ıu
(
bÜd”
));

1077 
ablocks
 = 
	`kÿÎoc
(
d•th
, (
ext4_fsblk_t
), 
GFP_NOFS
);

1078 ià(!
ablocks
)

1079  -
ENOMEM
;

1082 
	`ext_debug
("®loÿ‹ %d block fÜ indexes/Ëaf\n", 
d•th
 - 
©
);

1083 
a
 = 0;‡ < 
d•th
 - 
©
;‡++) {

1084 
Ãwblock
 = 
	`ext4_ext_Ãw_m‘a_block
(
hªdË
, 
šode
, 
·th
,

1085 
Ãwext
, &
”r
, 
æags
);

1086 ià(
Ãwblock
 == 0)

1087 
ş—nup
;

1088 
ablocks
[
a
] = 
Ãwblock
;

1092 
Ãwblock
 = 
ablocks
[--
a
];

1093 ià(
	`uÆik–y
(
Ãwblock
 == 0)) {

1094 
	`EXT4_ERROR_INODE
(
šode
, "newblock == 0!");

1095 
”r
 = -
EFSCORRUPTED
;

1096 
ş—nup
;

1098 
bh
 = 
	`sb_g‘blk_gå
(
šode
->
i_sb
, 
Ãwblock
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

1099 ià(
	`uÆik–y
(!
bh
)) {

1100 
”r
 = -
ENOMEM
;

1101 
ş—nup
;

1103 
	`lock_bufãr
(
bh
);

1105 
”r
 = 
	`ext4_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
bh
);

1106 ià(
”r
)

1107 
ş—nup
;

1109 
Ãh
 = 
	`ext_block_hdr
(
bh
);

1110 
Ãh
->
eh_’Œ›s
 = 0;

1111 
Ãh
->
eh_max
 = 
	`ıu_to_Ë16
(
	`ext4_ext_¥aû_block
(
šode
, 0));

1112 
Ãh
->
eh_magic
 = 
EXT4_EXT_MAGIC
;

1113 
Ãh
->
eh_d•th
 = 0;

1116 ià(
	`uÆik–y
(
·th
[
d•th
].
p_hdr
->
eh_’Œ›s
 !=

1117 
·th
[
d•th
].
p_hdr
->
eh_max
)) {

1118 
	`EXT4_ERROR_INODE
(
šode
, "eh_entries %d !=ƒh_max %d!",

1119 
·th
[
d•th
].
p_hdr
->
eh_’Œ›s
,

1120 
·th
[
d•th
].
p_hdr
->
eh_max
);

1121 
”r
 = -
EFSCORRUPTED
;

1122 
ş—nup
;

1125 
m
 = 
	`EXT_MAX_EXTENT
(
·th
[
d•th
].
p_hdr
è-…©h[d•th].
p_ext
++;

1126 
	`ext4_ext_show_move
(
šode
, 
·th
, 
Ãwblock
, 
d•th
);

1127 ià(
m
) {

1128 
ext4_ex‹Á
 *
ex
;

1129 
ex
 = 
	`EXT_FIRST_EXTENT
(
Ãh
);

1130 
	`memmove
(
ex
, 
·th
[
d•th
].
p_ext
, (
ext4_ex‹Á
è* 
m
);

1131 
	`Ë16_add_ıu
(&
Ãh
->
eh_’Œ›s
, 
m
);

1135 
ext_size
 = (
ext4_ex‹Á_h—d”
) +

1136 (
ext4_ex‹Á
è* 
	`Ë16_to_ıu
(
Ãh
->
eh_’Œ›s
);

1137 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0, 
šode
->
i_sb
->
s_blocksize
 -ƒxt_size);

1138 
	`ext4_ex‹Á_block_csum_£t
(
šode
, 
Ãh
);

1139 
	`£t_bufãr_u±od©e
(
bh
);

1140 
	`uÆock_bufãr
(
bh
);

1142 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

1143 ià(
”r
)

1144 
ş—nup
;

1145 
	`b»l£
(
bh
);

1146 
bh
 = 
NULL
;

1149 ià(
m
) {

1150 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

1151 ià(
”r
)

1152 
ş—nup
;

1153 
	`Ë16_add_ıu
(&
·th
[
d•th
].
p_hdr
->
eh_’Œ›s
, -
m
);

1154 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

1155 ià(
”r
)

1156 
ş—nup
;

1161 
k
 = 
d•th
 - 
©
 - 1;

1162 ià(
	`uÆik–y
(
k
 < 0)) {

1163 
	`EXT4_ERROR_INODE
(
šode
, "k %d < 0!", 
k
);

1164 
”r
 = -
EFSCORRUPTED
;

1165 
ş—nup
;

1167 ià(
k
)

1168 
	`ext_debug
("ü—‹ %d iÁ”medŸ‹ indiûs\n", 
k
);

1171 
i
 = 
d•th
 - 1;

1172 
k
--) {

1173 
Şdblock
 = 
Ãwblock
;

1174 
Ãwblock
 = 
ablocks
[--
a
];

1175 
bh
 = 
	`sb_g‘blk
(
šode
->
i_sb
, 
Ãwblock
);

1176 ià(
	`uÆik–y
(!
bh
)) {

1177 
”r
 = -
ENOMEM
;

1178 
ş—nup
;

1180 
	`lock_bufãr
(
bh
);

1182 
”r
 = 
	`ext4_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
bh
);

1183 ià(
”r
)

1184 
ş—nup
;

1186 
Ãh
 = 
	`ext_block_hdr
(
bh
);

1187 
Ãh
->
eh_’Œ›s
 = 
	`ıu_to_Ë16
(1);

1188 
Ãh
->
eh_magic
 = 
EXT4_EXT_MAGIC
;

1189 
Ãh
->
eh_max
 = 
	`ıu_to_Ë16
(
	`ext4_ext_¥aû_block_idx
(
šode
, 0));

1190 
Ãh
->
eh_d•th
 = 
	`ıu_to_Ë16
(
d•th
 - 
i
);

1191 
fidx
 = 
	`EXT_FIRST_INDEX
(
Ãh
);

1192 
fidx
->
ei_block
 = 
bÜd”
;

1193 
	`ext4_idx_¡Üe_pblock
(
fidx
, 
Şdblock
);

1195 
	`ext_debug
("int.index‡t %d (block %llu): %u -> %llu\n",

1196 
i
, 
Ãwblock
, 
	`Ë32_to_ıu
(
bÜd”
), 
Şdblock
);

1199 ià(
	`uÆik–y
(
	`EXT_MAX_INDEX
(
·th
[
i
].
p_hdr
) !=

1200 
	`EXT_LAST_INDEX
(
·th
[
i
].
p_hdr
))) {

1201 
	`EXT4_ERROR_INODE
(
šode
,

1203 
	`Ë32_to_ıu
(
·th
[
i
].
p_ext
->
“_block
));

1204 
”r
 = -
EFSCORRUPTED
;

1205 
ş—nup
;

1208 
m
 = 
	`EXT_MAX_INDEX
(
·th
[
i
].
p_hdr
è-…©h[i].
p_idx
++;

1209 
	`ext_debug
("cu¸0x%p,†a¡ 0x%p\n", 
·th
[
i
].
p_idx
,

1210 
	`EXT_MAX_INDEX
(
·th
[
i
].
p_hdr
));

1211 
	`ext4_ext_show_move
(
šode
, 
·th
, 
Ãwblock
, 
i
);

1212 ià(
m
) {

1213 
	`memmove
(++
fidx
, 
·th
[
i
].
p_idx
,

1214 (
ext4_ex‹Á_idx
è* 
m
);

1215 
	`Ë16_add_ıu
(&
Ãh
->
eh_’Œ›s
, 
m
);

1218 
ext_size
 = (
ext4_ex‹Á_h—d”
) +

1219 ((
ext4_ex‹Á
è* 
	`Ë16_to_ıu
(
Ãh
->
eh_’Œ›s
));

1220 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0,

1221 
šode
->
i_sb
->
s_blocksize
 - 
ext_size
);

1222 
	`ext4_ex‹Á_block_csum_£t
(
šode
, 
Ãh
);

1223 
	`£t_bufãr_u±od©e
(
bh
);

1224 
	`uÆock_bufãr
(
bh
);

1226 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

1227 ià(
”r
)

1228 
ş—nup
;

1229 
	`b»l£
(
bh
);

1230 
bh
 = 
NULL
;

1233 ià(
m
) {

1234 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
i
);

1235 ià(
”r
)

1236 
ş—nup
;

1237 
	`Ë16_add_ıu
(&
·th
[
i
].
p_hdr
->
eh_’Œ›s
, -
m
);

1238 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
i
);

1239 ià(
”r
)

1240 
ş—nup
;

1243 
i
--;

1247 
”r
 = 
	`ext4_ext_š£¹_šdex
(
hªdË
, 
šode
, 
·th
 + 
©
,

1248 
	`Ë32_to_ıu
(
bÜd”
), 
Ãwblock
);

1250 
ş—nup
:

1251 ià(
bh
) {

1252 ià(
	`bufãr_locked
(
bh
))

1253 
	`uÆock_bufãr
(
bh
);

1254 
	`b»l£
(
bh
);

1257 ià(
”r
) {

1259 
i
 = 0; i < 
d•th
; i++) {

1260 ià(!
ablocks
[
i
])

1262 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
ablocks
[
i
], 1,

1263 
EXT4_FREE_BLOCKS_METADATA
);

1266 
	`kä“
(
ablocks
);

1268  
”r
;

1269 
	}
}

1279 
	$ext4_ext_grow_šd•th
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1280 
æags
)

1282 
ext4_ex‹Á_h—d”
 *
Ãh
;

1283 
bufãr_h—d
 *
bh
;

1284 
ext4_fsblk_t
 
Ãwblock
, 
gßl
 = 0;

1285 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
;

1286 
”r
 = 0;

1287 
size_t
 
ext_size
 = 0;

1290 ià(
	`ext_d•th
(
šode
))

1291 
gßl
 = 
	`ext4_idx_pblock
(
	`EXT_FIRST_INDEX
(
	`ext_šode_hdr
(
šode
)));

1292 ià(
gßl
 > 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
)) {

1293 
æags
 |ğ
EXT4_MB_HINT_TRY_GOAL
;

1294 
gßl
--;

1296 
gßl
 = 
	`ext4_šode_to_gßl_block
(
šode
);

1297 
Ãwblock
 = 
	`ext4_Ãw_m‘a_blocks
(
hªdË
, 
šode
, 
gßl
, 
æags
,

1298 
NULL
, &
”r
);

1299 ià(
Ãwblock
 == 0)

1300  
”r
;

1302 
bh
 = 
	`sb_g‘blk_gå
(
šode
->
i_sb
, 
Ãwblock
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

1303 ià(
	`uÆik–y
(!
bh
))

1304  -
ENOMEM
;

1305 
	`lock_bufãr
(
bh
);

1307 
”r
 = 
	`ext4_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
bh
);

1308 ià(
”r
) {

1309 
	`uÆock_bufãr
(
bh
);

1310 
out
;

1313 
ext_size
 = (
	`EXT4_I
(
šode
)->
i_d©a
);

1315 
	`memmove
(
bh
->
b_d©a
, 
	`EXT4_I
(
šode
)->
i_d©a
, 
ext_size
);

1317 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0, 
šode
->
i_sb
->
s_blocksize
 -ƒxt_size);

1320 
Ãh
 = 
	`ext_block_hdr
(
bh
);

1323 ià(
	`ext_d•th
(
šode
))

1324 
Ãh
->
eh_max
 = 
	`ıu_to_Ë16
(
	`ext4_ext_¥aû_block_idx
(
šode
, 0));

1326 
Ãh
->
eh_max
 = 
	`ıu_to_Ë16
(
	`ext4_ext_¥aû_block
(
šode
, 0));

1327 
Ãh
->
eh_magic
 = 
EXT4_EXT_MAGIC
;

1328 
	`ext4_ex‹Á_block_csum_£t
(
šode
, 
Ãh
);

1329 
	`£t_bufãr_u±od©e
(
bh
);

1330 
	`uÆock_bufãr
(
bh
);

1332 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

1333 ià(
”r
)

1334 
out
;

1337 
Ãh
 = 
	`ext_šode_hdr
(
šode
);

1338 
Ãh
->
eh_’Œ›s
 = 
	`ıu_to_Ë16
(1);

1339 
	`ext4_idx_¡Üe_pblock
(
	`EXT_FIRST_INDEX
(
Ãh
), 
Ãwblock
);

1340 ià(
Ãh
->
eh_d•th
 == 0) {

1342 
Ãh
->
eh_max
 = 
	`ıu_to_Ë16
(
	`ext4_ext_¥aû_roÙ_idx
(
šode
, 0));

1343 
	`EXT_FIRST_INDEX
(
Ãh
)->
ei_block
 =

1344 
	`EXT_FIRST_EXTENT
(
Ãh
)->
“_block
;

1346 
	`ext_debug
("new„oot:‚um %d(%d),†block %d,…tr %llu\n",

1347 
	`Ë16_to_ıu
(
Ãh
->
eh_’Œ›s
),†e16_to_ıuÒeh->
eh_max
),

1348 
	`Ë32_to_ıu
(
	`EXT_FIRST_INDEX
(
Ãh
)->
ei_block
),

1349 
	`ext4_idx_pblock
(
	`EXT_FIRST_INDEX
(
Ãh
)));

1351 
	`Ë16_add_ıu
(&
Ãh
->
eh_d•th
, 1);

1352 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1353 
out
:

1354 
	`b»l£
(
bh
);

1356  
”r
;

1357 
	}
}

1364 
	$ext4_ext_ü—‹_Ãw_Ëaf
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1365 
mb_æags
,

1366 
gb_æags
,

1367 
ext4_ext_·th
 **
µ©h
,

1368 
ext4_ex‹Á
 *
Ãwext
)

1370 
ext4_ext_·th
 *
·th
 = *
µ©h
;

1371 
ext4_ext_·th
 *
cu½
;

1372 
d•th
, 
i
, 
”r
 = 0;

1374 
»³©
:

1375 
i
 = 
d•th
 = 
	`ext_d•th
(
šode
);

1378 
cu½
 = 
·th
 + 
d•th
;

1379 
i
 > 0 && !
	`EXT_HAS_FREE_INDEX
(
cu½
)) {

1380 
i
--;

1381 
cu½
--;

1386 ià(
	`EXT_HAS_FREE_INDEX
(
cu½
)) {

1389 
”r
 = 
	`ext4_ext_¥l™
(
hªdË
, 
šode
, 
mb_æags
, 
·th
, 
Ãwext
, 
i
);

1390 ià(
”r
)

1391 
out
;

1394 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
,

1395 (
ext4_lblk_t
)
	`Ë32_to_ıu
(
Ãwext
->
“_block
),

1396 
µ©h
, 
gb_æags
);

1397 ià(
	`IS_ERR
(
·th
))

1398 
”r
 = 
	`PTR_ERR
(
·th
);

1401 
”r
 = 
	`ext4_ext_grow_šd•th
(
hªdË
, 
šode
, 
mb_æags
);

1402 ià(
”r
)

1403 
out
;

1406 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
,

1407 (
ext4_lblk_t
)
	`Ë32_to_ıu
(
Ãwext
->
“_block
),

1408 
µ©h
, 
gb_æags
);

1409 ià(
	`IS_ERR
(
·th
)) {

1410 
”r
 = 
	`PTR_ERR
(
·th
);

1411 
out
;

1418 
d•th
 = 
	`ext_d•th
(
šode
);

1419 ià(
·th
[
d•th
].
p_hdr
->
eh_’Œ›s
 =ğ·th[d•th].p_hdr->
eh_max
) {

1421 
»³©
;

1425 
out
:

1426  
”r
;

1427 
	}
}

1436 
	$ext4_ext_£¬ch_Ëá
(
šode
 *inode,

1437 
ext4_ext_·th
 *
·th
,

1438 
ext4_lblk_t
 *
logiÿl
, 
ext4_fsblk_t
 *
phys
)

1440 
ext4_ex‹Á_idx
 *
ix
;

1441 
ext4_ex‹Á
 *
ex
;

1442 
d•th
, 
“_Ën
;

1444 ià(
	`uÆik–y
(
·th
 =ğ
NULL
)) {

1445 
	`EXT4_ERROR_INODE
(
šode
, "·th =ğNULL *logiÿÈ%d!", *
logiÿl
);

1446  -
EFSCORRUPTED
;

1448 
d•th
 = 
·th
->
p_d•th
;

1449 *
phys
 = 0;

1451 ià(
d•th
 =ğ0 && 
·th
->
p_ext
 =ğ
NULL
)

1458 
ex
 = 
·th
[
d•th
].
p_ext
;

1459 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

1460 ià(*
logiÿl
 < 
	`Ë32_to_ıu
(
ex
->
“_block
)) {

1461 ià(
	`uÆik–y
(
	`EXT_FIRST_EXTENT
(
·th
[
d•th
].
p_hdr
è!ğ
ex
)) {

1462 
	`EXT4_ERROR_INODE
(
šode
,

1464 *
logiÿl
, 
	`Ë32_to_ıu
(
ex
->
“_block
));

1465  -
EFSCORRUPTED
;

1467 --
d•th
 >= 0) {

1468 
ix
 = 
·th
[
d•th
].
p_idx
;

1469 ià(
	`uÆik–y
(
ix
 !ğ
	`EXT_FIRST_INDEX
(
·th
[
d•th
].
p_hdr
))) {

1470 
	`EXT4_ERROR_INODE
(
šode
,

1472 
ix
 !ğ
NULL
 ? 
	`Ë32_to_ıu
(ix->
ei_block
) : 0,

1473 
	`EXT_FIRST_INDEX
(
·th
[
d•th
].
p_hdr
è!ğ
NULL
 ?

1474 
	`Ë32_to_ıu
(
	`EXT_FIRST_INDEX
(
·th
[
d•th
].
p_hdr
)->
ei_block
) : 0,

1475 
d•th
);

1476  -
EFSCORRUPTED
;

1482 ià(
	`uÆik–y
(*
logiÿl
 < (
	`Ë32_to_ıu
(
ex
->
“_block
è+ 
“_Ën
))) {

1483 
	`EXT4_ERROR_INODE
(
šode
,

1485 *
logiÿl
, 
	`Ë32_to_ıu
(
ex
->
“_block
), 
“_Ën
);

1486  -
EFSCORRUPTED
;

1489 *
logiÿl
 = 
	`Ë32_to_ıu
(
ex
->
“_block
è+ 
“_Ën
 - 1;

1490 *
phys
 = 
	`ext4_ext_pblock
(
ex
è+ 
“_Ën
 - 1;

1492 
	}
}

1501 
	$ext4_ext_£¬ch_right
(
šode
 *inode,

1502 
ext4_ext_·th
 *
·th
,

1503 
ext4_lblk_t
 *
logiÿl
, 
ext4_fsblk_t
 *
phys
,

1504 
ext4_ex‹Á
 **
»t_ex
)

1506 
bufãr_h—d
 *
bh
 = 
NULL
;

1507 
ext4_ex‹Á_h—d”
 *
eh
;

1508 
ext4_ex‹Á_idx
 *
ix
;

1509 
ext4_ex‹Á
 *
ex
;

1510 
ext4_fsblk_t
 
block
;

1511 
d•th
;

1512 
“_Ën
;

1514 ià(
	`uÆik–y
(
·th
 =ğ
NULL
)) {

1515 
	`EXT4_ERROR_INODE
(
šode
, "·th =ğNULL *logiÿÈ%d!", *
logiÿl
);

1516  -
EFSCORRUPTED
;

1518 
d•th
 = 
·th
->
p_d•th
;

1519 *
phys
 = 0;

1521 ià(
d•th
 =ğ0 && 
·th
->
p_ext
 =ğ
NULL
)

1528 
ex
 = 
·th
[
d•th
].
p_ext
;

1529 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

1530 ià(*
logiÿl
 < 
	`Ë32_to_ıu
(
ex
->
“_block
)) {

1531 ià(
	`uÆik–y
(
	`EXT_FIRST_EXTENT
(
·th
[
d•th
].
p_hdr
è!ğ
ex
)) {

1532 
	`EXT4_ERROR_INODE
(
šode
,

1534 
d•th
);

1535  -
EFSCORRUPTED
;

1537 --
d•th
 >= 0) {

1538 
ix
 = 
·th
[
d•th
].
p_idx
;

1539 ià(
	`uÆik–y
(
ix
 !ğ
	`EXT_FIRST_INDEX
(
·th
[
d•th
].
p_hdr
))) {

1540 
	`EXT4_ERROR_INODE
(
šode
,

1542 *
logiÿl
);

1543  -
EFSCORRUPTED
;

1546 
found_ex‹Á
;

1549 ià(
	`uÆik–y
(*
logiÿl
 < (
	`Ë32_to_ıu
(
ex
->
“_block
è+ 
“_Ën
))) {

1550 
	`EXT4_ERROR_INODE
(
šode
,

1552 *
logiÿl
, 
	`Ë32_to_ıu
(
ex
->
“_block
), 
“_Ën
);

1553  -
EFSCORRUPTED
;

1556 ià(
ex
 !ğ
	`EXT_LAST_EXTENT
(
·th
[
d•th
].
p_hdr
)) {

1558 
ex
++;

1559 
found_ex‹Á
;

1563 --
d•th
 >= 0) {

1564 
ix
 = 
·th
[
d•th
].
p_idx
;

1565 ià(
ix
 !ğ
	`EXT_LAST_INDEX
(
·th
[
d•th
].
p_hdr
))

1566 
gÙ_šdex
;

1572 
gÙ_šdex
:

1576 
ix
++;

1577 
block
 = 
	`ext4_idx_pblock
(
ix
);

1578 ++
d•th
 < 
·th
->
p_d•th
) {

1580 
bh
 = 
	`»ad_ex‹Á_Œ“_block
(
šode
, 
block
,

1581 
·th
->
p_d•th
 - 
d•th
, 0);

1582 ià(
	`IS_ERR
(
bh
))

1583  
	`PTR_ERR
(
bh
);

1584 
eh
 = 
	`ext_block_hdr
(
bh
);

1585 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

1586 
block
 = 
	`ext4_idx_pblock
(
ix
);

1587 
	`put_bh
(
bh
);

1590 
bh
 = 
	`»ad_ex‹Á_Œ“_block
(
šode
, 
block
, 
·th
->
p_d•th
 - 
d•th
, 0);

1591 ià(
	`IS_ERR
(
bh
))

1592  
	`PTR_ERR
(
bh
);

1593 
eh
 = 
	`ext_block_hdr
(
bh
);

1594 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

1595 
found_ex‹Á
:

1596 *
logiÿl
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

1597 *
phys
 = 
	`ext4_ext_pblock
(
ex
);

1598 *
»t_ex
 = 
ex
;

1599 ià(
bh
)

1600 
	`put_bh
(
bh
);

1602 
	}
}

1611 
ext4_lblk_t


1612 
	$ext4_ext_Ãxt_®loÿ‹d_block
(
ext4_ext_·th
 *
·th
)

1614 
d•th
;

1616 
	`BUG_ON
(
·th
 =ğ
NULL
);

1617 
d•th
 = 
·th
->
p_d•th
;

1619 ià(
d•th
 =ğ0 && 
·th
->
p_ext
 =ğ
NULL
)

1620  
EXT_MAX_BLOCKS
;

1622 
d•th
 >= 0) {

1623 ià(
d•th
 =ğ
·th
->
p_d•th
) {

1625 ià(
·th
[
d•th
].
p_ext
 &&

1626 
·th
[
d•th
].
p_ext
 !=

1627 
	`EXT_LAST_EXTENT
(
·th
[
d•th
].
p_hdr
))

1628  
	`Ë32_to_ıu
(
·th
[
d•th
].
p_ext
[1].
“_block
);

1631 ià(
·th
[
d•th
].
p_idx
 !=

1632 
	`EXT_LAST_INDEX
(
·th
[
d•th
].
p_hdr
))

1633  
	`Ë32_to_ıu
(
·th
[
d•th
].
p_idx
[1].
ei_block
);

1635 
d•th
--;

1638  
EXT_MAX_BLOCKS
;

1639 
	}
}

1645 
ext4_lblk_t
 
	$ext4_ext_Ãxt_Ëaf_block
(
ext4_ext_·th
 *
·th
)

1647 
d•th
;

1649 
	`BUG_ON
(
·th
 =ğ
NULL
);

1650 
d•th
 = 
·th
->
p_d•th
;

1653 ià(
d•th
 == 0)

1654  
EXT_MAX_BLOCKS
;

1657 
d•th
--;

1659 
d•th
 >= 0) {

1660 ià(
·th
[
d•th
].
p_idx
 !=

1661 
	`EXT_LAST_INDEX
(
·th
[
d•th
].
p_hdr
))

1662  (
ext4_lblk_t
)

1663 
	`Ë32_to_ıu
(
·th
[
d•th
].
p_idx
[1].
ei_block
);

1664 
d•th
--;

1667  
EXT_MAX_BLOCKS
;

1668 
	}
}

1676 
	$ext4_ext_cÜ»ù_šdexes
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1677 
ext4_ext_·th
 *
·th
)

1679 
ext4_ex‹Á_h—d”
 *
eh
;

1680 
d•th
 = 
	`ext_d•th
(
šode
);

1681 
ext4_ex‹Á
 *
ex
;

1682 
__Ë32
 
bÜd”
;

1683 
k
, 
”r
 = 0;

1685 
eh
 = 
·th
[
d•th
].
p_hdr
;

1686 
ex
 = 
·th
[
d•th
].
p_ext
;

1688 ià(
	`uÆik–y
(
ex
 =ğ
NULL
 || 
eh
 == NULL)) {

1689 
	`EXT4_ERROR_INODE
(
šode
,

1690 "ex %°=ğNULL o¸eh %°=ğNULL", 
ex
, 
eh
);

1691  -
EFSCORRUPTED
;

1694 ià(
d•th
 == 0) {

1699 ià(
ex
 !ğ
	`EXT_FIRST_EXTENT
(
eh
)) {

1707 
k
 = 
d•th
 - 1;

1708 
bÜd”
 = 
·th
[
d•th
].
p_ext
->
“_block
;

1709 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
k
);

1710 ià(
”r
)

1711  
”r
;

1712 
·th
[
k
].
p_idx
->
ei_block
 = 
bÜd”
;

1713 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
k
);

1714 ià(
”r
)

1715  
”r
;

1717 
k
--) {

1719 ià(
·th
[
k
+1].
p_idx
 !ğ
	`EXT_FIRST_INDEX
Õ©h[k+1].
p_hdr
))

1721 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
k
);

1722 ià(
”r
)

1724 
·th
[
k
].
p_idx
->
ei_block
 = 
bÜd”
;

1725 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
k
);

1726 ià(
”r
)

1730  
”r
;

1731 
	}
}

1734 
	$ext4_ÿn_ex‹Ás_be_m”ged
(
šode
 *šode, 
ext4_ex‹Á
 *
ex1
,

1735 
ext4_ex‹Á
 *
ex2
)

1737 
ext1_“_Ën
, 
ext2_“_Ën
;

1739 ià(
	`ext4_ext_is_unwr™‹n
(
ex1
è!ğext4_ext_is_unwr™‹n(
ex2
))

1742 
ext1_“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex1
);

1743 
ext2_“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex2
);

1745 ià(
	`Ë32_to_ıu
(
ex1
->
“_block
è+ 
ext1_“_Ën
 !=

1746 
	`Ë32_to_ıu
(
ex2
->
“_block
))

1754 ià(
ext1_“_Ën
 + 
ext2_“_Ën
 > 
EXT_INIT_MAX_LEN
)

1762 ià(
	`ext4_ext_is_unwr™‹n
(
ex1
) &&

1763 (
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_DIO_UNWRITTEN
) ||

1764 
	`©omic_»ad
(&
	`EXT4_I
(
šode
)->
i_unwr™‹n
) ||

1765 (
ext1_“_Ën
 + 
ext2_“_Ën
 > 
EXT_UNWRITTEN_MAX_LEN
)))

1767 #ifdeà
AGGRESSIVE_TEST


1768 ià(
ext1_“_Ën
 >= 4)

1772 ià(
	`ext4_ext_pblock
(
ex1
è+ 
ext1_“_Ën
 =ğext4_ext_pblock(
ex2
))

1775 
	}
}

1784 
	$ext4_ext_Œy_to_m”ge_right
(
šode
 *inode,

1785 
ext4_ext_·th
 *
·th
,

1786 
ext4_ex‹Á
 *
ex
)

1788 
ext4_ex‹Á_h—d”
 *
eh
;

1789 
d•th
, 
Ën
;

1790 
m”ge_dÚe
 = 0, 
unwr™‹n
;

1792 
d•th
 = 
	`ext_d•th
(
šode
);

1793 
	`BUG_ON
(
·th
[
d•th
].
p_hdr
 =ğ
NULL
);

1794 
eh
 = 
·th
[
d•th
].
p_hdr
;

1796 
ex
 < 
	`EXT_LAST_EXTENT
(
eh
)) {

1797 ià(!
	`ext4_ÿn_ex‹Ás_be_m”ged
(
šode
, 
ex
,ƒx + 1))

1800 
unwr™‹n
 = 
	`ext4_ext_is_unwr™‹n
(
ex
);

1801 
ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
	`ext4_ext_g‘_aùu®_Ën
(ex)

1802 + 
	`ext4_ext_g‘_aùu®_Ën
(
ex
 + 1));

1803 ià(
unwr™‹n
)

1804 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

1806 ià(
ex
 + 1 < 
	`EXT_LAST_EXTENT
(
eh
)) {

1807 
Ën
 = (
	`EXT_LAST_EXTENT
(
eh
è- 
ex
 - 1)

1808 * (
ext4_ex‹Á
);

1809 
	`memmove
(
ex
 + 1,ƒx + 2, 
Ën
);

1811 
	`Ë16_add_ıu
(&
eh
->
eh_’Œ›s
, -1);

1812 
m”ge_dÚe
 = 1;

1813 
	`WARN_ON
(
eh
->
eh_’Œ›s
 == 0);

1814 ià(!
eh
->
eh_’Œ›s
)

1815 
	`EXT4_ERROR_INODE
(
šode
, "eh->eh_entries = 0!");

1818  
m”ge_dÚe
;

1819 
	}
}

1825 
	$ext4_ext_Œy_to_m”ge_up
(
hªdË_t
 *
hªdË
,

1826 
šode
 *inode,

1827 
ext4_ext_·th
 *
·th
)

1829 
size_t
 
s
;

1830 
max_roÙ
 = 
	`ext4_ext_¥aû_roÙ
(
šode
, 0);

1831 
ext4_fsblk_t
 
blk
;

1833 ià((
·th
[0].
p_d•th
 != 1) ||

1834 (
	`Ë16_to_ıu
(
·th
[0].
p_hdr
->
eh_’Œ›s
) != 1) ||

1835 (
	`Ë16_to_ıu
(
·th
[1].
p_hdr
->
eh_’Œ›s
è> 
max_roÙ
))

1843 ià(
	`ext4_jouº®_ex‹nd
(
hªdË
, 2))

1849 
blk
 = 
	`ext4_idx_pblock
(
·th
[0].
p_idx
);

1850 
s
 = 
	`Ë16_to_ıu
(
·th
[1].
p_hdr
->
eh_’Œ›s
) *

1851 (
ext4_ex‹Á_idx
);

1852 
s
 +ğ(
ext4_ex‹Á_h—d”
);

1854 
·th
[1].
p_maxd•th
 =…ath[0].p_maxdepth;

1855 
	`memıy
(
·th
[0].
p_hdr
,…©h[1].p_hdr, 
s
);

1856 
·th
[0].
p_d•th
 = 0;

1857 
·th
[0].
p_ext
 = 
	`EXT_FIRST_EXTENT
Õ©h[0].
p_hdr
) +

1858 (
·th
[1].
p_ext
 - 
	`EXT_FIRST_EXTENT
Õ©h[1].
p_hdr
));

1859 
·th
[0].
p_hdr
->
eh_max
 = 
	`ıu_to_Ë16
(
max_roÙ
);

1861 
	`b»l£
(
·th
[1].
p_bh
);

1862 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
blk
, 1,

1863 
EXT4_FREE_BLOCKS_METADATA
 | 
EXT4_FREE_BLOCKS_FORGET
);

1864 
	}
}

1870 
	$ext4_ext_Œy_to_m”ge
(
hªdË_t
 *
hªdË
,

1871 
šode
 *inode,

1872 
ext4_ext_·th
 *
·th
,

1873 
ext4_ex‹Á
 *
ex
) {

1874 
ext4_ex‹Á_h—d”
 *
eh
;

1875 
d•th
;

1876 
m”ge_dÚe
 = 0;

1878 
d•th
 = 
	`ext_d•th
(
šode
);

1879 
	`BUG_ON
(
·th
[
d•th
].
p_hdr
 =ğ
NULL
);

1880 
eh
 = 
·th
[
d•th
].
p_hdr
;

1882 ià(
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
))

1883 
m”ge_dÚe
 = 
	`ext4_ext_Œy_to_m”ge_right
(
šode
, 
·th
, 
ex
 - 1);

1885 ià(!
m”ge_dÚe
)

1886 (è
	`ext4_ext_Œy_to_m”ge_right
(
šode
, 
·th
, 
ex
);

1888 
	`ext4_ext_Œy_to_m”ge_up
(
hªdË
, 
šode
, 
·th
);

1889 
	}
}

1899 
	$ext4_ext_check_ov”Ïp
(
ext4_sb_šfo
 *
sbi
,

1900 
šode
 *inode,

1901 
ext4_ex‹Á
 *
Ãwext
,

1902 
ext4_ext_·th
 *
·th
)

1904 
ext4_lblk_t
 
b1
, 
b2
;

1905 
d•th
, 
Ën1
;

1906 
»t
 = 0;

1908 
b1
 = 
	`Ë32_to_ıu
(
Ãwext
->
“_block
);

1909 
Ën1
 = 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
);

1910 
d•th
 = 
	`ext_d•th
(
šode
);

1911 ià(!
·th
[
d•th
].
p_ext
)

1912 
out
;

1913 
b2
 = 
	`EXT4_LBLK_CMASK
(
sbi
, 
	`Ë32_to_ıu
(
·th
[
d•th
].
p_ext
->
“_block
));

1919 ià(
b2
 < 
b1
) {

1920 
b2
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th
);

1921 ià(
b2
 =ğ
EXT_MAX_BLOCKS
)

1922 
out
;

1923 
b2
 = 
	`EXT4_LBLK_CMASK
(
sbi
, b2);

1927 ià(
b1
 + 
Ën1
 < b1) {

1928 
Ën1
 = 
EXT_MAX_BLOCKS
 - 
b1
;

1929 
Ãwext
->
“_Ën
 = 
	`ıu_to_Ë16
(
Ën1
);

1930 
»t
 = 1;

1934 ià(
b1
 + 
Ën1
 > 
b2
) {

1935 
Ãwext
->
“_Ën
 = 
	`ıu_to_Ë16
(
b2
 - 
b1
);

1936 
»t
 = 1;

1938 
out
:

1939  
»t
;

1940 
	}
}

1948 
	$ext4_ext_š£¹_ex‹Á
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1949 
ext4_ext_·th
 **
µ©h
,

1950 
ext4_ex‹Á
 *
Ãwext
, 
gb_æags
)

1952 
ext4_ext_·th
 *
·th
 = *
µ©h
;

1953 
ext4_ex‹Á_h—d”
 *
eh
;

1954 
ext4_ex‹Á
 *
ex
, *
ãx
;

1955 
ext4_ex‹Á
 *
Ã¬ex
;

1956 
ext4_ext_·th
 *
Å©h
 = 
NULL
;

1957 
d•th
, 
Ën
, 
”r
;

1958 
ext4_lblk_t
 
Ãxt
;

1959 
mb_æags
 = 0, 
unwr™‹n
;

1961 ià(
gb_æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
)

1962 
mb_æags
 |ğ
EXT4_MB_DELALLOC_RESERVED
;

1963 ià(
	`uÆik–y
(
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
) == 0)) {

1964 
	`EXT4_ERROR_INODE
(
šode
, "ext4_ext_get_actual_len(newext) == 0");

1965  -
EFSCORRUPTED
;

1967 
d•th
 = 
	`ext_d•th
(
šode
);

1968 
ex
 = 
·th
[
d•th
].
p_ext
;

1969 
eh
 = 
·th
[
d•th
].
p_hdr
;

1970 ià(
	`uÆik–y
(
·th
[
d•th
].
p_hdr
 =ğ
NULL
)) {

1971 
	`EXT4_ERROR_INODE
(
šode
, "·th[%d].p_hd¸=ğNULL", 
d•th
);

1972  -
EFSCORRUPTED
;

1976 ià(
ex
 && !(
gb_æags
 & 
EXT4_GET_BLOCKS_PRE_IO
)) {

1985 ià(
ex
 < 
	`EXT_LAST_EXTENT
(
eh
) &&

1986 (
	`Ë32_to_ıu
(
ex
->
“_block
) +

1987 
	`ext4_ext_g‘_aùu®_Ën
(
ex
) <

1988 
	`Ë32_to_ıu
(
Ãwext
->
“_block
))) {

1989 
ex
 += 1;

1990 
´•’d
;

1991 } ià((
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
)) &&

1992 (
	`Ë32_to_ıu
(
Ãwext
->
“_block
) +

1993 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
) <

1994 
	`Ë32_to_ıu
(
ex
->
“_block
)))

1995 
ex
 -= 1;

1998 ià(
	`ext4_ÿn_ex‹Ás_be_m”ged
(
šode
, 
ex
, 
Ãwext
)) {

1999 
	`ext_debug
("append [%d]%d blocko %u:[%d]%d"

2001 
	`ext4_ext_is_unwr™‹n
(
Ãwext
),

2002 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
),

2003 
	`Ë32_to_ıu
(
ex
->
“_block
),

2004 
	`ext4_ext_is_unwr™‹n
(
ex
),

2005 
	`ext4_ext_g‘_aùu®_Ën
(
ex
),

2006 
	`ext4_ext_pblock
(
ex
));

2007 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
,

2008 
·th
 + 
d•th
);

2009 ià(
”r
)

2010  
”r
;

2011 
unwr™‹n
 = 
	`ext4_ext_is_unwr™‹n
(
ex
);

2012 
ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
	`ext4_ext_g‘_aùu®_Ën
(ex)

2013 + 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
));

2014 ià(
unwr™‹n
)

2015 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

2016 
eh
 = 
·th
[
d•th
].
p_hdr
;

2017 
Ã¬ex
 = 
ex
;

2018 
m”ge
;

2021 
´•’d
:

2023 ià(
	`ext4_ÿn_ex‹Ás_be_m”ged
(
šode
, 
Ãwext
, 
ex
)) {

2024 
	`ext_debug
("prepend %u[%d]%d blocko %u:[%d]%d"

2026 
	`Ë32_to_ıu
(
Ãwext
->
“_block
),

2027 
	`ext4_ext_is_unwr™‹n
(
Ãwext
),

2028 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
),

2029 
	`Ë32_to_ıu
(
ex
->
“_block
),

2030 
	`ext4_ext_is_unwr™‹n
(
ex
),

2031 
	`ext4_ext_g‘_aùu®_Ën
(
ex
),

2032 
	`ext4_ext_pblock
(
ex
));

2033 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
,

2034 
·th
 + 
d•th
);

2035 ià(
”r
)

2036  
”r
;

2038 
unwr™‹n
 = 
	`ext4_ext_is_unwr™‹n
(
ex
);

2039 
ex
->
“_block
 = 
Ãwext
->ee_block;

2040 
	`ext4_ext_¡Üe_pblock
(
ex
, 
	`ext4_ext_pblock
(
Ãwext
));

2041 
ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
	`ext4_ext_g‘_aùu®_Ën
(ex)

2042 + 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
));

2043 ià(
unwr™‹n
)

2044 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

2045 
eh
 = 
·th
[
d•th
].
p_hdr
;

2046 
Ã¬ex
 = 
ex
;

2047 
m”ge
;

2051 
d•th
 = 
	`ext_d•th
(
šode
);

2052 
eh
 = 
·th
[
d•th
].
p_hdr
;

2053 ià(
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
è<†e16_to_ıuÓh->
eh_max
))

2054 
has_¥aû
;

2057 
ãx
 = 
	`EXT_LAST_EXTENT
(
eh
);

2058 
Ãxt
 = 
EXT_MAX_BLOCKS
;

2059 ià(
	`Ë32_to_ıu
(
Ãwext
->
“_block
è>†e32_to_ıu(
ãx
->ee_block))

2060 
Ãxt
 = 
	`ext4_ext_Ãxt_Ëaf_block
(
·th
);

2061 ià(
Ãxt
 !ğ
EXT_MAX_BLOCKS
) {

2062 
	`ext_debug
("ÃxˆËaàblock - %u\n", 
Ãxt
);

2063 
	`BUG_ON
(
Å©h
 !ğ
NULL
);

2064 
Å©h
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
Ãxt
, 
NULL
, 0);

2065 ià(
	`IS_ERR
(
Å©h
))

2066  
	`PTR_ERR
(
Å©h
);

2067 
	`BUG_ON
(
Å©h
->
p_d•th
 !ğ
·th
->p_depth);

2068 
eh
 = 
Å©h
[
d•th
].
p_hdr
;

2069 ià(
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
è<†e16_to_ıuÓh->
eh_max
)) {

2070 
	`ext_debug
("next†eaf isn't full(%d)\n",

2071 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
));

2072 
·th
 = 
Å©h
;

2073 
has_¥aû
;

2075 
	`ext_debug
("next†eaf has‚o free space(%d,%d)\n",

2076 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
),†e16_to_ıuÓh->
eh_max
));

2083 ià(
gb_æags
 & 
EXT4_GET_BLOCKS_METADATA_NOFAIL
)

2084 
mb_æags
 |ğ
EXT4_MB_USE_RESERVED
;

2085 
”r
 = 
	`ext4_ext_ü—‹_Ãw_Ëaf
(
hªdË
, 
šode
, 
mb_æags
, 
gb_æags
,

2086 
µ©h
, 
Ãwext
);

2087 ià(
”r
)

2088 
ş—nup
;

2089 
d•th
 = 
	`ext_d•th
(
šode
);

2090 
eh
 = 
·th
[
d•th
].
p_hdr
;

2092 
has_¥aû
:

2093 
Ã¬ex
 = 
·th
[
d•th
].
p_ext
;

2095 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

2096 ià(
”r
)

2097 
ş—nup
;

2099 ià(!
Ã¬ex
) {

2101 
	`ext_debug
("firstƒxtent inhe†eaf: %u:%llu:[%d]%d\n",

2102 
	`Ë32_to_ıu
(
Ãwext
->
“_block
),

2103 
	`ext4_ext_pblock
(
Ãwext
),

2104 
	`ext4_ext_is_unwr™‹n
(
Ãwext
),

2105 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
));

2106 
Ã¬ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

2108 ià(
	`Ë32_to_ıu
(
Ãwext
->
“_block
)

2109 > 
	`Ë32_to_ıu
(
Ã¬ex
->
“_block
)) {

2111 
	`ext_debug
("insert %u:%llu:[%d]%d before: "

2113 
	`Ë32_to_ıu
(
Ãwext
->
“_block
),

2114 
	`ext4_ext_pblock
(
Ãwext
),

2115 
	`ext4_ext_is_unwr™‹n
(
Ãwext
),

2116 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
),

2117 
Ã¬ex
);

2118 
Ã¬ex
++;

2121 
	`BUG_ON
(
Ãwext
->
“_block
 =ğ
Ã¬ex
->ee_block);

2122 
	`ext_debug
("insert %u:%llu:[%d]%d‡fter: "

2124 
	`Ë32_to_ıu
(
Ãwext
->
“_block
),

2125 
	`ext4_ext_pblock
(
Ãwext
),

2126 
	`ext4_ext_is_unwr™‹n
(
Ãwext
),

2127 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
),

2128 
Ã¬ex
);

2130 
Ën
 = 
	`EXT_LAST_EXTENT
(
eh
è- 
Ã¬ex
 + 1;

2131 ià(
Ën
 > 0) {

2132 
	`ext_debug
("insert %u:%llu:[%d]%d: "

2134 
	`Ë32_to_ıu
(
Ãwext
->
“_block
),

2135 
	`ext4_ext_pblock
(
Ãwext
),

2136 
	`ext4_ext_is_unwr™‹n
(
Ãwext
),

2137 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
),

2138 
Ën
, 
Ã¬ex
,‚earex + 1);

2139 
	`memmove
(
Ã¬ex
 + 1,‚earex,

2140 
Ën
 * (
ext4_ex‹Á
));

2144 
	`Ë16_add_ıu
(&
eh
->
eh_’Œ›s
, 1);

2145 
·th
[
d•th
].
p_ext
 = 
Ã¬ex
;

2146 
Ã¬ex
->
“_block
 = 
Ãwext
->ee_block;

2147 
	`ext4_ext_¡Üe_pblock
(
Ã¬ex
, 
	`ext4_ext_pblock
(
Ãwext
));

2148 
Ã¬ex
->
“_Ën
 = 
Ãwext
->ee_len;

2150 
m”ge
:

2152 ià(!(
gb_æags
 & 
EXT4_GET_BLOCKS_PRE_IO
))

2153 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
šode
, 
·th
, 
Ã¬ex
);

2157 
”r
 = 
	`ext4_ext_cÜ»ù_šdexes
(
hªdË
, 
šode
, 
·th
);

2158 ià(
”r
)

2159 
ş—nup
;

2161 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 +…©h->
p_d•th
);

2163 
ş—nup
:

2164 
	`ext4_ext_drİ_»fs
(
Å©h
);

2165 
	`kä“
(
Å©h
);

2166  
”r
;

2167 
	}
}

2169 
	$ext4_fl_f›m­_ex‹Ás
(
šode
 *inode,

2170 
ext4_lblk_t
 
block
,ƒxt4_lblk_ˆ
num
,

2171 
f›m­_ex‹Á_šfo
 *
f›šfo
)

2173 
ext4_ext_·th
 *
·th
 = 
NULL
;

2174 
ext4_ex‹Á
 *
ex
;

2175 
ex‹Á_¡©us
 
es
;

2176 
ext4_lblk_t
 
Ãxt
, 
Ãxt_d–
, 
¡¬t
 = 0, 
’d
 = 0;

2177 
ext4_lblk_t
 
Ï¡
 = 
block
 + 
num
;

2178 
exi¡s
, 
d•th
 = 0, 
”r
 = 0;

2179 
æags
 = 0;

2180 
blksize_b™s
 = 
šode
->
i_sb
->
s_blocksize_b™s
;

2182 
block
 < 
Ï¡
 && block !ğ
EXT_MAX_BLOCKS
) {

2183 
num
 = 
Ï¡
 - 
block
;

2185 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

2187 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
block
, &path, 0);

2188 ià(
	`IS_ERR
(
·th
)) {

2189 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

2190 
”r
 = 
	`PTR_ERR
(
·th
);

2191 
·th
 = 
NULL
;

2195 
d•th
 = 
	`ext_d•th
(
šode
);

2196 ià(
	`uÆik–y
(
·th
[
d•th
].
p_hdr
 =ğ
NULL
)) {

2197 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

2198 
	`EXT4_ERROR_INODE
(
šode
, "·th[%d].p_hd¸=ğNULL", 
d•th
);

2199 
”r
 = -
EFSCORRUPTED
;

2202 
ex
 = 
·th
[
d•th
].
p_ext
;

2203 
Ãxt
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th
);

2205 
æags
 = 0;

2206 
exi¡s
 = 0;

2207 ià(!
ex
) {

2210 
¡¬t
 = 
block
;

2211 
’d
 = 
block
 + 
num
;

2212 } ià(
	`Ë32_to_ıu
(
ex
->
“_block
è> 
block
) {

2214 
¡¬t
 = 
block
;

2215 
’d
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

2216 ià(
block
 + 
num
 < 
’d
)

2217 
’d
 = 
block
 + 
num
;

2218 } ià(
block
 >ğ
	`Ë32_to_ıu
(
ex
->
“_block
)

2219 + 
	`ext4_ext_g‘_aùu®_Ën
(
ex
)) {

2221 
¡¬t
 = 
block
;

2222 
’d
 = 
block
 + 
num
;

2223 ià(
’d
 >ğ
Ãxt
)

2224 
’d
 = 
Ãxt
;

2225 } ià(
block
 >ğ
	`Ë32_to_ıu
(
ex
->
“_block
)) {

2230 
¡¬t
 = 
block
;

2231 
’d
 = 
	`Ë32_to_ıu
(
ex
->
“_block
)

2232 + 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

2233 ià(
block
 + 
num
 < 
’d
)

2234 
’d
 = 
block
 + 
num
;

2235 
exi¡s
 = 1;

2237 
	`BUG
();

2239 
	`BUG_ON
(
’d
 <ğ
¡¬t
);

2241 ià(!
exi¡s
) {

2242 
es
.
es_lblk
 = 
¡¬t
;

2243 
es
.
es_Ën
 = 
’d
 - 
¡¬t
;

2244 
es
.
es_pblk
 = 0;

2246 
es
.
es_lblk
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

2247 
es
.
es_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

2248 
es
.
es_pblk
 = 
	`ext4_ext_pblock
(
ex
);

2249 ià(
	`ext4_ext_is_unwr™‹n
(
ex
))

2250 
æags
 |ğ
FIEMAP_EXTENT_UNWRITTEN
;

2258 
Ãxt_d–
 = 
	`ext4_fšd_d–ayed_ex‹Á
(
šode
, &
es
);

2259 ià(!
exi¡s
 && 
Ãxt_d–
) {

2260 
exi¡s
 = 1;

2261 
æags
 |ğ(
FIEMAP_EXTENT_DELALLOC
 |

2262 
FIEMAP_EXTENT_UNKNOWN
);

2264 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

2266 ià(
	`uÆik–y
(
es
.
es_Ën
 == 0)) {

2267 
	`EXT4_ERROR_INODE
(
šode
, "es.es_len == 0");

2268 
”r
 = -
EFSCORRUPTED
;

2283 ià(
Ãxt
 =ğ
Ãxt_d–
 &&‚exˆ=ğ
EXT_MAX_BLOCKS
) {

2284 
æags
 |ğ
FIEMAP_EXTENT_LAST
;

2285 ià(
	`uÆik–y
(
Ãxt_d–
 !ğ
EXT_MAX_BLOCKS
 ||

2286 
Ãxt
 !ğ
EXT_MAX_BLOCKS
)) {

2287 
	`EXT4_ERROR_INODE
(
šode
,

2290 
Ãxt
, 
Ãxt_d–
);

2291 
”r
 = -
EFSCORRUPTED
;

2296 ià(
exi¡s
) {

2297 
”r
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
,

2298 (
__u64
)
es
.
es_lblk
 << 
blksize_b™s
,

2299 (
__u64
)
es
.
es_pblk
 << 
blksize_b™s
,

2300 (
__u64
)
es
.
es_Ën
 << 
blksize_b™s
,

2301 
æags
);

2302 ià(
”r
 < 0)

2304 ià(
”r
 == 1) {

2305 
”r
 = 0;

2310 
block
 = 
es
.
es_lblk
 +ƒs.
es_Ën
;

2313 
	`ext4_ext_drİ_»fs
(
·th
);

2314 
	`kä“
(
·th
);

2315  
”r
;

2316 
	}
}

2318 
	$ext4_fl_es_ÿche_šfo
(
šode
 *inode,

2319 
ext4_lblk_t
 
block
,ƒxt4_lblk_ˆ
num
,

2320 
f›m­_ex‹Á_šfo
 *
f›šfo
)

2322 
ext4_lblk_t
 
Ãxt
, 
’d
 = 
block
 + 
num
 - 1;

2323 
ex‹Á_¡©us
 
es
;

2324 
blksize_b™s
 = 
šode
->
i_sb
->
s_blocksize_b™s
;

2325 
æags
;

2326 
”r
;

2328 
block
 <ğ
’d
) {

2329 
Ãxt
 = 0;

2330 
æags
 = 0;

2331 ià(!
	`ext4_es_lookup_ex‹Á
(
šode
, 
block
, &
Ãxt
, &
es
))

2333 ià(
	`ext4_es_is_unwr™‹n
(&
es
))

2334 
æags
 |ğ
FIEMAP_EXTENT_UNWRITTEN
;

2335 ià(
	`ext4_es_is_d–ayed
(&
es
))

2336 
æags
 |ğ(
FIEMAP_EXTENT_DELALLOC
 |

2337 
FIEMAP_EXTENT_UNKNOWN
);

2338 ià(
	`ext4_es_is_hŞe
(&
es
))

2339 
æags
 |ğ
EXT4_FIEMAP_EXTENT_HOLE
;

2340 ià(
Ãxt
 == 0)

2341 
æags
 |ğ
FIEMAP_EXTENT_LAST
;

2342 ià(
æags
 & (
FIEMAP_EXTENT_DELALLOC
|

2343 
EXT4_FIEMAP_EXTENT_HOLE
))

2344 
es
.
es_pblk
 = 0;

2346 
es
.
es_pblk
 = 
	`ext4_es_pblock
(&es);

2347 
”r
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
,

2348 (
__u64
)
es
.
es_lblk
 << 
blksize_b™s
,

2349 (
__u64
)
es
.
es_pblk
 << 
blksize_b™s
,

2350 (
__u64
)
es
.
es_Ën
 << 
blksize_b™s
,

2351 
æags
);

2352 ià(
Ãxt
 == 0)

2354 
block
 = 
Ãxt
;

2355 ià(
”r
 < 0)

2356  
”r
;

2357 ià(
”r
 == 1)

2361 
	}
}

2377 
ext4_lblk_t
 
	$ext4_ext_d‘”mše_hŞe
(
šode
 *inode,

2378 
ext4_ext_·th
 *
·th
,

2379 
ext4_lblk_t
 *
lblk
)

2381 
d•th
 = 
	`ext_d•th
(
šode
);

2382 
ext4_ex‹Á
 *
ex
;

2383 
ext4_lblk_t
 
Ën
;

2385 
ex
 = 
·th
[
d•th
].
p_ext
;

2386 ià(
ex
 =ğ
NULL
) {

2388 *
lblk
 = 0;

2389 
Ën
 = 
EXT_MAX_BLOCKS
;

2390 } ià(*
lblk
 < 
	`Ë32_to_ıu
(
ex
->
“_block
)) {

2391 
Ën
 = 
	`Ë32_to_ıu
(
ex
->
“_block
è- *
lblk
;

2392 } ià(*
lblk
 >ğ
	`Ë32_to_ıu
(
ex
->
“_block
)

2393 + 
	`ext4_ext_g‘_aùu®_Ën
(
ex
)) {

2394 
ext4_lblk_t
 
Ãxt
;

2396 *
lblk
 = 
	`Ë32_to_ıu
(
ex
->
“_block
è+ 
	`ext4_ext_g‘_aùu®_Ën
(ex);

2397 
Ãxt
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th
);

2398 
	`BUG_ON
(
Ãxt
 =ğ*
lblk
);

2399 
Ën
 = 
Ãxt
 - *
lblk
;

2401 
	`BUG
();

2403  
Ën
;

2404 
	}
}

2412 
	$ext4_ext_put_g­_š_ÿche
(
šode
 *šode, 
ext4_lblk_t
 
hŞe_¡¬t
,

2413 
ext4_lblk_t
 
hŞe_Ën
)

2415 
ex‹Á_¡©us
 
es
;

2417 
	`ext4_es_fšd_ex‹Á_¿nge
(
šode
, &
ext4_es_is_d–ayed
, 
hŞe_¡¬t
,

2418 
hŞe_¡¬t
 + 
hŞe_Ën
 - 1, &
es
);

2419 ià(
es
.
es_Ën
) {

2421 ià(
es
.
es_lblk
 <ğ
hŞe_¡¬t
)

2423 
hŞe_Ën
 = 
	`mš
(
es
.
es_lblk
 - 
hŞe_¡¬t
, hole_len);

2425 
	`ext_debug
(" -> %u:%u\n", 
hŞe_¡¬t
, 
hŞe_Ën
);

2426 
	`ext4_es_š£¹_ex‹Á
(
šode
, 
hŞe_¡¬t
, 
hŞe_Ën
, ~0,

2427 
EXTENT_STATUS_HOLE
);

2428 
	}
}

2434 
	$ext4_ext_rm_idx
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2435 
ext4_ext_·th
 *
·th
, 
d•th
)

2437 
”r
;

2438 
ext4_fsblk_t
 
Ëaf
;

2441 
d•th
--;

2442 
·th
 =…©h + 
d•th
;

2443 
Ëaf
 = 
	`ext4_idx_pblock
(
·th
->
p_idx
);

2444 ià(
	`uÆik–y
(
·th
->
p_hdr
->
eh_’Œ›s
 == 0)) {

2445 
	`EXT4_ERROR_INODE
(
šode
, "path->p_hdr->eh_entries == 0");

2446  -
EFSCORRUPTED
;

2448 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
);

2449 ià(
”r
)

2450  
”r
;

2452 ià(
·th
->
p_idx
 !ğ
	`EXT_LAST_INDEX
Õ©h->
p_hdr
)) {

2453 
Ën
 = 
	`EXT_LAST_INDEX
(
·th
->
p_hdr
è-…©h->
p_idx
;

2454 
Ën
 *ğ(
ext4_ex‹Á_idx
);

2455 
	`memmove
(
·th
->
p_idx
,…©h->p_idx + 1, 
Ën
);

2458 
	`Ë16_add_ıu
(&
·th
->
p_hdr
->
eh_’Œ›s
, -1);

2459 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
);

2460 ià(
”r
)

2461  
”r
;

2462 
	`ext_debug
("šdex i em±y,„emov™, f»block %Îu\n", 
Ëaf
);

2463 
	`Œaû_ext4_ext_rm_idx
(
šode
, 
Ëaf
);

2465 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
Ëaf
, 1,

2466 
EXT4_FREE_BLOCKS_METADATA
 | 
EXT4_FREE_BLOCKS_FORGET
);

2468 --
d•th
 >= 0) {

2469 ià(
·th
->
p_idx
 !ğ
	`EXT_FIRST_INDEX
Õ©h->
p_hdr
))

2471 
·th
--;

2472 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
);

2473 ià(
”r
)

2475 
·th
->
p_idx
->
ei_block
 = (path+1)->p_idx->ei_block;

2476 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
);

2477 ià(
”r
)

2480  
”r
;

2481 
	}
}

2490 
	$ext4_ext_ÿlc_üed™s_fÜ_sšgË_ex‹Á
(
šode
 *šode, 
Äblocks
,

2491 
ext4_ext_·th
 *
·th
)

2493 ià(
·th
) {

2494 
d•th
 = 
	`ext_d•th
(
šode
);

2495 
»t
 = 0;

2498 ià(
	`Ë16_to_ıu
(
·th
[
d•th
].
p_hdr
->
eh_’Œ›s
)

2499 < 
	`Ë16_to_ıu
(
·th
[
d•th
].
p_hdr
->
eh_max
)) {

2510 
»t
 = 2 + 
	`EXT4_META_TRANS_BLOCKS
(
šode
->
i_sb
);

2511  
»t
;

2515  
	`ext4_chunk_Œªs_blocks
(
šode
, 
Äblocks
);

2516 
	}
}

2527 
	$ext4_ext_šdex_Œªs_blocks
(
šode
 *šode, 
ex‹Ás
)

2529 
šdex
;

2530 
d•th
;

2533 ià(
	`ext4_has_šlše_d©a
(
šode
))

2536 
d•th
 = 
	`ext_d•th
(
šode
);

2538 ià(
ex‹Ás
 <= 1)

2539 
šdex
 = 
d•th
 * 2;

2541 
šdex
 = 
d•th
 * 3;

2543  
šdex
;

2544 
	}
}

2546 
šlše
 
	$g‘_deçuÉ_ä“_blocks_æags
(
šode
 *inode)

2548 ià(
	`S_ISDIR
(
šode
->
i_mode
è|| 
	`S_ISLNK
(inode->i_mode) ||

2549 
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EA_INODE
))

2550  
EXT4_FREE_BLOCKS_METADATA
 | 
EXT4_FREE_BLOCKS_FORGET
;

2551 ià(
	`ext4_should_jouº®_d©a
(
šode
))

2552  
EXT4_FREE_BLOCKS_FORGET
;

2554 
	}
}

2571 
	$ext4_»»£rve_şu¡”
(
šode
 *šode, 
ext4_lblk_t
 
lblk
)

2573 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

2574 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

2576 
	`dquÙ_»şaim_block
(
šode
, 
	`EXT4_C2B
(
sbi
, 1));

2578 
	`¥š_lock
(&
ei
->
i_block_»£rv©iÚ_lock
);

2579 
ei
->
i_»£rved_d©a_blocks
++;

2580 
	`³rıu_couÁ”_add
(&
sbi
->
s_dœtyşu¡”s_couÁ”
, 1);

2581 
	`¥š_uÆock
(&
ei
->
i_block_»£rv©iÚ_lock
);

2583 
	`³rıu_couÁ”_add
(&
sbi
->
s_ä“şu¡”s_couÁ”
, 1);

2584 
	`ext4_»move_³ndšg
(
šode
, 
lblk
);

2585 
	}
}

2587 
	$ext4_»move_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2588 
ext4_ex‹Á
 *
ex
,

2589 
·¹Ÿl_şu¡”
 *
·¹Ÿl
,

2590 
ext4_lblk_t
 
äom
,ƒxt4_lblk_ˆ
to
)

2592 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

2593 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

2594 
ext4_fsblk_t
 
Ï¡_pblk
, 
pblk
;

2595 
ext4_lblk_t
 
num
;

2596 
æags
;

2599 ià(
äom
 < 
	`Ë32_to_ıu
(
ex
->
“_block
) ||

2600 
to
 !ğ
	`Ë32_to_ıu
(
ex
->
“_block
è+ 
“_Ën
 - 1) {

2601 
	`ext4_”rÜ
(
sbi
->
s_sb
,

2603 
äom
, 
to
, 
	`Ë32_to_ıu
(
ex
->
“_block
), 
“_Ën
);

2607 #ifdeà
EXTENTS_STATS


2608 
	`¥š_lock
(&
sbi
->
s_ext_¡©s_lock
);

2609 
sbi
->
s_ext_blocks
 +ğ
“_Ën
;

2610 
sbi
->
s_ext_ex‹Ás
++;

2611 ià(
“_Ën
 < 
sbi
->
s_ext_mš
)

2612 
sbi
->
s_ext_mš
 = 
“_Ën
;

2613 ià(
“_Ën
 > 
sbi
->
s_ext_max
)

2614 
sbi
->
s_ext_max
 = 
“_Ën
;

2615 ià(
	`ext_d•th
(
šode
è> 
sbi
->
s_d•th_max
)

2616 
sbi
->
s_d•th_max
 = 
	`ext_d•th
(
šode
);

2617 
	`¥š_uÆock
(&
sbi
->
s_ext_¡©s_lock
);

2620 
	`Œaû_ext4_»move_blocks
(
šode
, 
ex
, 
äom
, 
to
, 
·¹Ÿl
);

2626 
Ï¡_pblk
 = 
	`ext4_ext_pblock
(
ex
è+ 
“_Ën
 - 1;

2628 ià(
·¹Ÿl
->
¡©e
 !ğ
š™Ÿl
 &&

2629 
·¹Ÿl
->
pşu
 !ğ
	`EXT4_B2C
(
sbi
, 
Ï¡_pblk
)) {

2630 ià(
·¹Ÿl
->
¡©e
 =ğ
toä“
) {

2631 
æags
 = 
	`g‘_deçuÉ_ä“_blocks_æags
(
šode
);

2632 ià(
	`ext4_is_³ndšg
(
šode
, 
·¹Ÿl
->
lblk
))

2633 
æags
 |ğ
EXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2634 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
,

2635 
	`EXT4_C2B
(
sbi
, 
·¹Ÿl
->
pşu
),

2636 
sbi
->
s_şu¡”_¿tio
, 
æags
);

2637 ià(
æags
 & 
EXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2638 
	`ext4_»»£rve_şu¡”
(
šode
, 
·¹Ÿl
->
lblk
);

2640 
·¹Ÿl
->
¡©e
 = 
š™Ÿl
;

2643 
num
 = 
	`Ë32_to_ıu
(
ex
->
“_block
è+ 
“_Ën
 - 
äom
;

2644 
pblk
 = 
	`ext4_ext_pblock
(
ex
è+ 
“_Ën
 - 
num
;

2652 
æags
 = 
	`g‘_deçuÉ_ä“_blocks_æags
(
šode
);

2655 ià((
	`EXT4_LBLK_COFF
(
sbi
, 
to
è!ğsbi->
s_şu¡”_¿tio
 - 1) &&

2656 (
	`EXT4_LBLK_CMASK
(
sbi
, 
to
è>ğ
äom
) &&

2657 (
·¹Ÿl
->
¡©e
 !ğ
noä“
)) {

2658 ià(
	`ext4_is_³ndšg
(
šode
, 
to
))

2659 
æags
 |ğ
EXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2660 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
,

2661 
	`EXT4_PBLK_CMASK
(
sbi
, 
Ï¡_pblk
),

2662 
sbi
->
s_şu¡”_¿tio
, 
æags
);

2663 ià(
æags
 & 
EXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2664 
	`ext4_»»£rve_şu¡”
(
šode
, 
to
);

2665 
·¹Ÿl
->
¡©e
 = 
š™Ÿl
;

2666 
æags
 = 
	`g‘_deçuÉ_ä“_blocks_æags
(
šode
);

2669 
æags
 |ğ
EXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
;

2677 
æags
 |ğ
EXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
;

2678 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
pblk
, 
num
, 
æags
);

2681 ià(
·¹Ÿl
->
¡©e
 !ğ
š™Ÿl
 &&…¬tŸl->
pşu
 !ğ
	`EXT4_B2C
(
sbi
, 
pblk
))

2682 
·¹Ÿl
->
¡©e
 = 
š™Ÿl
;

2694 ià(
	`EXT4_LBLK_COFF
(
sbi
, 
äom
è&& 
num
 =ğ
“_Ën
) {

2695 ià(
·¹Ÿl
->
¡©e
 =ğ
š™Ÿl
) {

2696 
·¹Ÿl
->
pşu
 = 
	`EXT4_B2C
(
sbi
, 
pblk
);

2697 
·¹Ÿl
->
lblk
 = 
äom
;

2698 
·¹Ÿl
->
¡©e
 = 
toä“
;

2701 
·¹Ÿl
->
¡©e
 = 
š™Ÿl
;

2705 
	}
}

2723 
	$ext4_ext_rm_Ëaf
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2724 
ext4_ext_·th
 *
·th
,

2725 
·¹Ÿl_şu¡”
 *
·¹Ÿl
,

2726 
ext4_lblk_t
 
¡¬t
,ƒxt4_lblk_ˆ
’d
)

2728 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

2729 
”r
 = 0, 
cÜ»ù_šdex
 = 0;

2730 
d•th
 = 
	`ext_d•th
(
šode
), 
üed™s
;

2731 
ext4_ex‹Á_h—d”
 *
eh
;

2732 
ext4_lblk_t
 
a
, 
b
;

2733 
num
;

2734 
ext4_lblk_t
 
ex_“_block
;

2735 
ex_“_Ën
;

2736 
unwr™‹n
 = 0;

2737 
ext4_ex‹Á
 *
ex
;

2738 
ext4_fsblk_t
 
pblk
;

2741 
	`ext_debug
("Œunÿ‹ sšû %u iÀËaàtØ%u\n", 
¡¬t
, 
’d
);

2742 ià(!
·th
[
d•th
].
p_hdr
)

2743 
·th
[
d•th
].
p_hdr
 = 
	`ext_block_hdr
Õ©h[d•th].
p_bh
);

2744 
eh
 = 
·th
[
d•th
].
p_hdr
;

2745 ià(
	`uÆik–y
(
·th
[
d•th
].
p_hdr
 =ğ
NULL
)) {

2746 
	`EXT4_ERROR_INODE
(
šode
, "·th[%d].p_hd¸=ğNULL", 
d•th
);

2747  -
EFSCORRUPTED
;

2750 
ex
 = 
·th
[
d•th
].
p_ext
;

2751 ià(!
ex
)

2752 
ex
 = 
	`EXT_LAST_EXTENT
(
eh
);

2754 
ex_“_block
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

2755 
ex_“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

2757 
	`Œaû_ext4_ext_rm_Ëaf
(
šode
, 
¡¬t
, 
ex
, 
·¹Ÿl
);

2759 
ex
 >ğ
	`EXT_FIRST_EXTENT
(
eh
) &&

2760 
ex_“_block
 + 
ex_“_Ën
 > 
¡¬t
) {

2762 ià(
	`ext4_ext_is_unwr™‹n
(
ex
))

2763 
unwr™‹n
 = 1;

2765 
unwr™‹n
 = 0;

2767 
	`ext_debug
("»movexˆ%u:[%d]%d\n", 
ex_“_block
,

2768 
unwr™‹n
, 
ex_“_Ën
);

2769 
·th
[
d•th
].
p_ext
 = 
ex
;

2771 
a
 = 
ex_“_block
 > 
¡¬t
 ?ƒx_ee_block : start;

2772 
b
 = 
ex_“_block
+
ex_“_Ën
 - 1 < 
’d
 ?

2773 
ex_“_block
+
ex_“_Ën
 - 1 : 
’d
;

2775 
	`ext_debug
(" bÜd” %u:%u\n", 
a
, 
b
);

2778 ià(
’d
 < 
ex_“_block
) {

2786 ià(
sbi
->
s_şu¡”_¿tio
 > 1) {

2787 
pblk
 = 
	`ext4_ext_pblock
(
ex
);

2788 
·¹Ÿl
->
pşu
 = 
	`EXT4_B2C
(
sbi
, 
pblk
);

2789 
·¹Ÿl
->
¡©e
 = 
noä“
;

2791 
ex
--;

2792 
ex_“_block
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

2793 
ex_“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

2795 } ià(
b
 !ğ
ex_“_block
 + 
ex_“_Ën
 - 1) {

2796 
	`EXT4_ERROR_INODE
(
šode
,

2799 
¡¬t
, 
’d
, 
ex_“_block
,

2800 
ex_“_block
 + 
ex_“_Ën
 - 1);

2801 
”r
 = -
EFSCORRUPTED
;

2802 
out
;

2803 } ià(
a
 !ğ
ex_“_block
) {

2805 
num
 = 
a
 - 
ex_“_block
;

2808 
num
 = 0;

2816 
üed™s
 = 7 + 2*(
ex_“_Ën
/
	`EXT4_BLOCKS_PER_GROUP
(
šode
->
i_sb
));

2817 ià(
ex
 =ğ
	`EXT_FIRST_EXTENT
(
eh
)) {

2818 
cÜ»ù_šdex
 = 1;

2819 
üed™s
 +ğ(
	`ext_d•th
(
šode
)) + 1;

2821 
üed™s
 +ğ
	`EXT4_MAXQUOTAS_TRANS_BLOCKS
(
šode
->
i_sb
);

2823 
”r
 = 
	`ext4_ext_Œunÿ‹_ex‹nd_»¡¬t
(
hªdË
, 
šode
, 
üed™s
);

2824 ià(
”r
)

2825 
out
;

2827 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

2828 ià(
”r
)

2829 
out
;

2831 
”r
 = 
	`ext4_»move_blocks
(
hªdË
, 
šode
, 
ex
, 
·¹Ÿl
, 
a
, 
b
);

2832 ià(
”r
)

2833 
out
;

2835 ià(
num
 == 0)

2837 
	`ext4_ext_¡Üe_pblock
(
ex
, 0);

2839 
ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
num
);

2844 ià(
unwr™‹n
 && 
num
)

2845 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

2850 ià(
num
 == 0) {

2851 ià(
’d
 !ğ
EXT_MAX_BLOCKS
 - 1) {

2857 
	`memmove
(
ex
,ƒx+1, (
	`EXT_LAST_EXTENT
(
eh
) -ƒx) *

2858 (
ext4_ex‹Á
));

2861 
	`mem£t
(
	`EXT_LAST_EXTENT
(
eh
), 0,

2862 (
ext4_ex‹Á
));

2864 
	`Ë16_add_ıu
(&
eh
->
eh_’Œ›s
, -1);

2867 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

2868 ià(
”r
)

2869 
out
;

2871 
	`ext_debug
("Ãwƒx‹Á: %u:%u:%Îu\n", 
ex_“_block
, 
num
,

2872 
	`ext4_ext_pblock
(
ex
));

2873 
ex
--;

2874 
ex_“_block
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

2875 
ex_“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

2878 ià(
cÜ»ù_šdex
 && 
eh
->
eh_’Œ›s
)

2879 
”r
 = 
	`ext4_ext_cÜ»ù_šdexes
(
hªdË
, 
šode
, 
·th
);

2888 ià(
·¹Ÿl
->
¡©e
 =ğ
toä“
 && 
ex
 >ğ
	`EXT_FIRST_EXTENT
(
eh
)) {

2889 
pblk
 = 
	`ext4_ext_pblock
(
ex
è+ 
ex_“_Ën
 - 1;

2890 ià(
·¹Ÿl
->
pşu
 !ğ
	`EXT4_B2C
(
sbi
, 
pblk
)) {

2891 
æags
 = 
	`g‘_deçuÉ_ä“_blocks_æags
(
šode
);

2893 ià(
	`ext4_is_³ndšg
(
šode
, 
·¹Ÿl
->
lblk
))

2894 
æags
 |ğ
EXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2895 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
,

2896 
	`EXT4_C2B
(
sbi
, 
·¹Ÿl
->
pşu
),

2897 
sbi
->
s_şu¡”_¿tio
, 
æags
);

2898 ià(
æags
 & 
EXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2899 
	`ext4_»»£rve_şu¡”
(
šode
, 
·¹Ÿl
->
lblk
);

2901 
·¹Ÿl
->
¡©e
 = 
š™Ÿl
;

2906 ià(
”r
 =ğ0 && 
eh
->
eh_’Œ›s
 =ğ0 && 
·th
[
d•th
].
p_bh
 !ğ
NULL
)

2907 
”r
 = 
	`ext4_ext_rm_idx
(
hªdË
, 
šode
, 
·th
, 
d•th
);

2909 
out
:

2910  
”r
;

2911 
	}
}

2918 
	$ext4_ext_mÜe_to_rm
(
ext4_ext_·th
 *
·th
)

2920 
	`BUG_ON
(
·th
->
p_idx
 =ğ
NULL
);

2922 ià(
·th
->
p_idx
 < 
	`EXT_FIRST_INDEX
Õ©h->
p_hdr
))

2929 ià(
	`Ë16_to_ıu
(
·th
->
p_hdr
->
eh_’Œ›s
è=ğ·th->
p_block
)

2932 
	}
}

2934 
	$ext4_ext_»move_¥aû
(
šode
 *šode, 
ext4_lblk_t
 
¡¬t
,

2935 
ext4_lblk_t
 
’d
)

2937 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

2938 
d•th
 = 
	`ext_d•th
(
šode
);

2939 
ext4_ext_·th
 *
·th
 = 
NULL
;

2940 
·¹Ÿl_şu¡”
 
·¹Ÿl
;

2941 
hªdË_t
 *
hªdË
;

2942 
i
 = 0, 
”r
 = 0;

2944 
·¹Ÿl
.
pşu
 = 0;

2945 
·¹Ÿl
.
lblk
 = 0;

2946 
·¹Ÿl
.
¡©e
 = 
š™Ÿl
;

2948 
	`ext_debug
("Œunÿ‹ sšû %uØ%u\n", 
¡¬t
, 
’d
);

2951 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_TRUNCATE
, 
d•th
 + 1);

2952 ià(
	`IS_ERR
(
hªdË
))

2953  
	`PTR_ERR
(
hªdË
);

2955 
agaš
:

2956 
	`Œaû_ext4_ext_»move_¥aû
(
šode
, 
¡¬t
, 
’d
, 
d•th
);

2965 ià(
’d
 < 
EXT_MAX_BLOCKS
 - 1) {

2966 
ext4_ex‹Á
 *
ex
;

2967 
ext4_lblk_t
 
“_block
, 
ex_’d
, 
lblk
;

2968 
ext4_fsblk_t
 
pblk
;

2971 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
’d
, 
NULL
, 
EXT4_EX_NOCACHE
);

2972 ià(
	`IS_ERR
(
·th
)) {

2973 
	`ext4_jouº®_¡İ
(
hªdË
);

2974  
	`PTR_ERR
(
·th
);

2976 
d•th
 = 
	`ext_d•th
(
šode
);

2978 
ex
 = 
·th
[
d•th
].
p_ext
;

2979 ià(!
ex
) {

2980 ià(
d•th
) {

2981 
	`EXT4_ERROR_INODE
(
šode
,

2983 
d•th
);

2984 
”r
 = -
EFSCORRUPTED
;

2986 
out
;

2989 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

2990 
ex_’d
 = 
“_block
 + 
	`ext4_ext_g‘_aùu®_Ën
(
ex
) - 1;

2998 ià(
’d
 >ğ
“_block
 &&ƒnd < 
ex_’d
) {

3005 ià(
sbi
->
s_şu¡”_¿tio
 > 1) {

3006 
pblk
 = 
	`ext4_ext_pblock
(
ex
è+ 
’d
 - 
“_block
 + 2;

3007 
·¹Ÿl
.
pşu
 = 
	`EXT4_B2C
(
sbi
, 
pblk
);

3008 
·¹Ÿl
.
¡©e
 = 
noä“
;

3017 
”r
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
šode
, &
·th
,

3018 
’d
 + 1, 1);

3019 ià(
”r
 < 0)

3020 
out
;

3022 } ià(
sbi
->
s_şu¡”_¿tio
 > 1 && 
’d
 >ğ
ex_’d
 &&

3023 
·¹Ÿl
.
¡©e
 =ğ
š™Ÿl
) {

3034 
lblk
 = 
ex_’d
 + 1;

3035 
”r
 = 
	`ext4_ext_£¬ch_right
(
šode
, 
·th
, &
lblk
, &
pblk
,

3036 &
ex
);

3037 ià(
”r
)

3038 
out
;

3039 ià(
pblk
) {

3040 
·¹Ÿl
.
pşu
 = 
	`EXT4_B2C
(
sbi
, 
pblk
);

3041 
·¹Ÿl
.
¡©e
 = 
noä“
;

3049 
d•th
 = 
	`ext_d•th
(
šode
);

3050 ià(
·th
) {

3051 
k
 = 
i
 = 
d•th
;

3052 --
k
 > 0)

3053 
·th
[
k
].
p_block
 =

3054 
	`Ë16_to_ıu
(
·th
[
k
].
p_hdr
->
eh_’Œ›s
)+1;

3056 
·th
 = 
	`kÿÎoc
(
d•th
 + 1, (
ext4_ext_·th
),

3057 
GFP_NOFS
);

3058 ià(
·th
 =ğ
NULL
) {

3059 
	`ext4_jouº®_¡İ
(
hªdË
);

3060  -
ENOMEM
;

3062 
·th
[0].
p_maxd•th
 =…©h[0].
p_d•th
 = 
d•th
;

3063 
·th
[0].
p_hdr
 = 
	`ext_šode_hdr
(
šode
);

3064 
i
 = 0;

3066 ià(
	`ext4_ext_check
(
šode
, 
·th
[0].
p_hdr
, 
d•th
, 0)) {

3067 
”r
 = -
EFSCORRUPTED
;

3068 
out
;

3071 
”r
 = 0;

3073 
i
 >ğ0 && 
”r
 == 0) {

3074 ià(
i
 =ğ
d•th
) {

3076 
”r
 = 
	`ext4_ext_rm_Ëaf
(
hªdË
, 
šode
, 
·th
,

3077 &
·¹Ÿl
, 
¡¬t
, 
’d
);

3079 
	`b»l£
(
·th
[
i
].
p_bh
);

3080 
·th
[
i
].
p_bh
 = 
NULL
;

3081 
i
--;

3086 ià(!
·th
[
i
].
p_hdr
) {

3087 
	`ext_debug
("initialize header\n");

3088 
·th
[
i
].
p_hdr
 = 
	`ext_block_hdr
Õ©h[i].
p_bh
);

3091 ià(!
·th
[
i
].
p_idx
) {

3093 
·th
[
i
].
p_idx
 = 
	`EXT_LAST_INDEX
Õ©h[i].
p_hdr
);

3094 
·th
[
i
].
p_block
 = 
	`Ë16_to_ıu
Õ©h[i].
p_hdr
->
eh_’Œ›s
)+1;

3095 
	`ext_debug
("init index…tr: hdr 0x%p,‚um %d\n",

3096 
·th
[
i
].
p_hdr
,

3097 
	`Ë16_to_ıu
(
·th
[
i
].
p_hdr
->
eh_’Œ›s
));

3100 
·th
[
i
].
p_idx
--;

3103 
	`ext_debug
("level %d - index, first 0x%p, cur 0x%p\n",

3104 
i
, 
	`EXT_FIRST_INDEX
(
·th
[i].
p_hdr
),

3105 
·th
[
i
].
p_idx
);

3106 ià(
	`ext4_ext_mÜe_to_rm
(
·th
 + 
i
)) {

3107 
bufãr_h—d
 *
bh
;

3109 
	`ext_debug
("moveo†evel %d (block %llu)\n",

3110 
i
 + 1, 
	`ext4_idx_pblock
(
·th
[i].
p_idx
));

3111 
	`mem£t
(
·th
 + 
i
 + 1, 0, (*path));

3112 
bh
 = 
	`»ad_ex‹Á_Œ“_block
(
šode
,

3113 
	`ext4_idx_pblock
(
·th
[
i
].
p_idx
), 
d•th
 - i - 1,

3114 
EXT4_EX_NOCACHE
);

3115 ià(
	`IS_ERR
(
bh
)) {

3117 
”r
 = 
	`PTR_ERR
(
bh
);

3122 
	`cÚd_»sched
();

3123 ià(
	`WARN_ON
(
i
 + 1 > 
d•th
)) {

3124 
”r
 = -
EFSCORRUPTED
;

3127 
·th
[
i
 + 1].
p_bh
 = 
bh
;

3131 
·th
[
i
].
p_block
 = 
	`Ë16_to_ıu
Õ©h[i].
p_hdr
->
eh_’Œ›s
);

3132 
i
++;

3135 ià(
·th
[
i
].
p_hdr
->
eh_’Œ›s
 == 0 && i > 0) {

3139 
”r
 = 
	`ext4_ext_rm_idx
(
hªdË
, 
šode
, 
·th
, 
i
);

3142 
	`b»l£
(
·th
[
i
].
p_bh
);

3143 
·th
[
i
].
p_bh
 = 
NULL
;

3144 
i
--;

3145 
	`ext_debug
("»tuºØËv– %d\n", 
i
);

3149 
	`Œaû_ext4_ext_»move_¥aû_dÚe
(
šode
, 
¡¬t
, 
’d
, 
d•th
, &
·¹Ÿl
,

3150 
·th
->
p_hdr
->
eh_’Œ›s
);

3156 ià(
·¹Ÿl
.
¡©e
 =ğ
toä“
 && 
”r
 == 0) {

3157 
æags
 = 
	`g‘_deçuÉ_ä“_blocks_æags
(
šode
);

3159 ià(
	`ext4_is_³ndšg
(
šode
, 
·¹Ÿl
.
lblk
))

3160 
æags
 |ğ
EXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

3161 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
,

3162 
	`EXT4_C2B
(
sbi
, 
·¹Ÿl
.
pşu
),

3163 
sbi
->
s_şu¡”_¿tio
, 
æags
);

3164 ià(
æags
 & 
EXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

3165 
	`ext4_»»£rve_şu¡”
(
šode
, 
·¹Ÿl
.
lblk
);

3166 
·¹Ÿl
.
¡©e
 = 
š™Ÿl
;

3170 ià(
·th
->
p_hdr
->
eh_’Œ›s
 == 0) {

3175 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
);

3176 ià(
”r
 == 0) {

3177 
	`ext_šode_hdr
(
šode
)->
eh_d•th
 = 0;

3178 
	`ext_šode_hdr
(
šode
)->
eh_max
 =

3179 
	`ıu_to_Ë16
(
	`ext4_ext_¥aû_roÙ
(
šode
, 0));

3180 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
);

3183 
out
:

3184 
	`ext4_ext_drİ_»fs
(
·th
);

3185 
	`kä“
(
·th
);

3186 
·th
 = 
NULL
;

3187 ià(
”r
 =ğ-
EAGAIN
)

3188 
agaš
;

3189 
	`ext4_jouº®_¡İ
(
hªdË
);

3191  
”r
;

3192 
	}
}

3197 
	$ext4_ext_š™
(
su³r_block
 *
sb
)

3203 ià(
	`ext4_has_ã©u»_ex‹Ás
(
sb
)) {

3204 #ià
	`defšed
(
AGGRESSIVE_TEST
è|| defšed(
CHECK_BINSEARCH
è|| defšed(
EXTENTS_STATS
)

3205 
	`´štk
(
KERN_INFO
 "EXT4-fs: fileƒxtentsƒnabled"

3206 #ifdeà
AGGRESSIVE_TEST


3209 #ifdeà
CHECK_BINSEARCH


3212 #ifdeà
EXTENTS_STATS


3217 #ifdeà
EXTENTS_STATS


3218 
	`¥š_lock_š™
(&
	`EXT4_SB
(
sb
)->
s_ext_¡©s_lock
);

3219 
	`EXT4_SB
(
sb
)->
s_ext_mš
 = 1 << 30;

3220 
	`EXT4_SB
(
sb
)->
s_ext_max
 = 0;

3223 
	}
}

3228 
	$ext4_ext_»Ëa£
(
su³r_block
 *
sb
)

3230 ià(!
	`ext4_has_ã©u»_ex‹Ás
(
sb
))

3233 #ifdeà
EXTENTS_STATS


3234 ià(
	`EXT4_SB
(
sb
)->
s_ext_blocks
 && EXT4_SB(sb)->
s_ext_ex‹Ás
) {

3235 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3236 
	`´štk
(
KERN_ERR
 "EXT4-fs: %lu blocks in %luƒxtents (%lu‡ve)\n",

3237 
sbi
->
s_ext_blocks
, sbi->
s_ext_ex‹Ás
,

3238 
sbi
->
s_ext_blocks
 / sbi->
s_ext_ex‹Ás
);

3239 
	`´štk
(
KERN_ERR
 "EXT4-fs:ƒxtents: %lu min, %lu max, max depth %lu\n",

3240 
sbi
->
s_ext_mš
, sbi->
s_ext_max
, sbi->
s_d•th_max
);

3243 
	}
}

3245 
	$ext4_z”oout_es
(
šode
 *šode, 
ext4_ex‹Á
 *
ex
)

3247 
ext4_lblk_t
 
“_block
;

3248 
ext4_fsblk_t
 
“_pblock
;

3249 
“_Ën
;

3251 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

3252 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

3253 
“_pblock
 = 
	`ext4_ext_pblock
(
ex
);

3255 ià(
“_Ën
 == 0)

3258  
	`ext4_es_š£¹_ex‹Á
(
šode
, 
“_block
, 
“_Ën
, 
“_pblock
,

3259 
EXTENT_STATUS_WRITTEN
);

3260 
	}
}

3263 
	$ext4_ext_z”oout
(
šode
 *šode, 
ext4_ex‹Á
 *
ex
)

3265 
ext4_fsblk_t
 
“_pblock
;

3266 
“_Ën
;

3268 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

3269 
“_pblock
 = 
	`ext4_ext_pblock
(
ex
);

3270  
	`ext4_issue_z”oout
(
šode
, 
	`Ë32_to_ıu
(
ex
->
“_block
), 
“_pblock
,

3271 
“_Ën
);

3272 
	}
}

3295 
	$ext4_¥l™_ex‹Á_©
(
hªdË_t
 *
hªdË
,

3296 
šode
 *inode,

3297 
ext4_ext_·th
 **
µ©h
,

3298 
ext4_lblk_t
 
¥l™
,

3299 
¥l™_æag
,

3300 
æags
)

3302 
ext4_ext_·th
 *
·th
 = *
µ©h
;

3303 
ext4_fsblk_t
 
Ãwblock
;

3304 
ext4_lblk_t
 
“_block
;

3305 
ext4_ex‹Á
 *
ex
, 
Ãwex
, 
Üig_ex
, 
z”o_ex
;

3306 
ext4_ex‹Á
 *
ex2
 = 
NULL
;

3307 
“_Ën
, 
d•th
;

3308 
”r
 = 0;

3310 
	`BUG_ON
((
¥l™_æag
 & (
EXT4_EXT_DATA_VALID1
 | 
EXT4_EXT_DATA_VALID2
)) ==

3311 (
EXT4_EXT_DATA_VALID1
 | 
EXT4_EXT_DATA_VALID2
));

3313 
	`ext_debug
("ext4_split_extents_at: inode %lu,†ogical"

3314 "block %Îu\n", 
šode
->
i_šo
, ()
¥l™
);

3316 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

3318 
d•th
 = 
	`ext_d•th
(
šode
);

3319 
ex
 = 
·th
[
d•th
].
p_ext
;

3320 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

3321 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

3322 
Ãwblock
 = 
¥l™
 - 
“_block
 + 
	`ext4_ext_pblock
(
ex
);

3324 
	`BUG_ON
(
¥l™
 < 
“_block
 || s¶™ >ğÓe_block + 
“_Ën
));

3325 
	`BUG_ON
(!
	`ext4_ext_is_unwr™‹n
(
ex
) &&

3326 
¥l™_æag
 & (
EXT4_EXT_MAY_ZEROOUT
 |

3327 
EXT4_EXT_MARK_UNWRIT1
 |

3328 
EXT4_EXT_MARK_UNWRIT2
));

3330 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

3331 ià(
”r
)

3332 
out
;

3334 ià(
¥l™
 =ğ
“_block
) {

3340 ià(
¥l™_æag
 & 
EXT4_EXT_MARK_UNWRIT2
)

3341 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

3343 
	`ext4_ext_m¬k_š™Ÿlized
(
ex
);

3345 ià(!(
æags
 & 
EXT4_GET_BLOCKS_PRE_IO
))

3346 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
šode
, 
·th
, 
ex
);

3348 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 +…©h->
p_d•th
);

3349 
out
;

3353 
	`memıy
(&
Üig_ex
, 
ex
, (orig_ex));

3354 
ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
¥l™
 - 
“_block
);

3355 ià(
¥l™_æag
 & 
EXT4_EXT_MARK_UNWRIT1
)

3356 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

3362 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

3363 ià(
”r
)

3364 
fix_ex‹Á_Ën
;

3366 
ex2
 = &
Ãwex
;

3367 
ex2
->
“_block
 = 
	`ıu_to_Ë32
(
¥l™
);

3368 
ex2
->
“_Ën
 = 
	`ıu_to_Ë16
Óe_ËÀ- (
¥l™
 - 
“_block
));

3369 
	`ext4_ext_¡Üe_pblock
(
ex2
, 
Ãwblock
);

3370 ià(
¥l™_æag
 & 
EXT4_EXT_MARK_UNWRIT2
)

3371 
	`ext4_ext_m¬k_unwr™‹n
(
ex2
);

3373 
”r
 = 
	`ext4_ext_š£¹_ex‹Á
(
hªdË
, 
šode
, 
µ©h
, &
Ãwex
, 
æags
);

3374 ià(
”r
 =ğ-
ENOSPC
 && (
EXT4_EXT_MAY_ZEROOUT
 & 
¥l™_æag
)) {

3375 ià(
¥l™_æag
 & (
EXT4_EXT_DATA_VALID1
|
EXT4_EXT_DATA_VALID2
)) {

3376 ià(
¥l™_æag
 & 
EXT4_EXT_DATA_VALID1
) {

3377 
”r
 = 
	`ext4_ext_z”oout
(
šode
, 
ex2
);

3378 
z”o_ex
.
“_block
 = 
ex2
->ee_block;

3379 
z”o_ex
.
“_Ën
 = 
	`ıu_to_Ë16
(

3380 
	`ext4_ext_g‘_aùu®_Ën
(
ex2
));

3381 
	`ext4_ext_¡Üe_pblock
(&
z”o_ex
,

3382 
	`ext4_ext_pblock
(
ex2
));

3384 
”r
 = 
	`ext4_ext_z”oout
(
šode
, 
ex
);

3385 
z”o_ex
.
“_block
 = 
ex
->ee_block;

3386 
z”o_ex
.
“_Ën
 = 
	`ıu_to_Ë16
(

3387 
	`ext4_ext_g‘_aùu®_Ën
(
ex
));

3388 
	`ext4_ext_¡Üe_pblock
(&
z”o_ex
,

3389 
	`ext4_ext_pblock
(
ex
));

3392 
”r
 = 
	`ext4_ext_z”oout
(
šode
, &
Üig_ex
);

3393 
z”o_ex
.
“_block
 = 
Üig_ex
.ee_block;

3394 
z”o_ex
.
“_Ën
 = 
	`ıu_to_Ë16
(

3395 
	`ext4_ext_g‘_aùu®_Ën
(&
Üig_ex
));

3396 
	`ext4_ext_¡Üe_pblock
(&
z”o_ex
,

3397 
	`ext4_ext_pblock
(&
Üig_ex
));

3400 ià(
”r
)

3401 
fix_ex‹Á_Ën
;

3403 
ex
->
“_Ën
 = 
	`ıu_to_Ë16
(ee_len);

3404 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
šode
, 
·th
, 
ex
);

3405 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 +…©h->
p_d•th
);

3406 ià(
”r
)

3407 
fix_ex‹Á_Ën
;

3410 
”r
 = 
	`ext4_z”oout_es
(
šode
, &
z”o_ex
);

3412 
out
;

3413 } ià(
”r
)

3414 
fix_ex‹Á_Ën
;

3416 
out
:

3417 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

3418  
”r
;

3420 
fix_ex‹Á_Ën
:

3421 
ex
->
“_Ën
 = 
Üig_ex
.ee_len;

3422 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 +…©h->
p_d•th
);

3423  
”r
;

3424 
	}
}

3437 
	$ext4_¥l™_ex‹Á
(
hªdË_t
 *
hªdË
,

3438 
šode
 *inode,

3439 
ext4_ext_·th
 **
µ©h
,

3440 
ext4_m­_blocks
 *
m­
,

3441 
¥l™_æag
,

3442 
æags
)

3444 
ext4_ext_·th
 *
·th
 = *
µ©h
;

3445 
ext4_lblk_t
 
“_block
;

3446 
ext4_ex‹Á
 *
ex
;

3447 
“_Ën
, 
d•th
;

3448 
”r
 = 0;

3449 
unwr™‹n
;

3450 
¥l™_æag1
, 
æags1
;

3451 
®loÿ‹d
 = 
m­
->
m_Ën
;

3453 
d•th
 = 
	`ext_d•th
(
šode
);

3454 
ex
 = 
·th
[
d•th
].
p_ext
;

3455 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

3456 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

3457 
unwr™‹n
 = 
	`ext4_ext_is_unwr™‹n
(
ex
);

3459 ià(
m­
->
m_lblk
 + m­->
m_Ën
 < 
“_block
 + 
“_Ën
) {

3460 
¥l™_æag1
 = 
¥l™_æag
 & 
EXT4_EXT_MAY_ZEROOUT
;

3461 
æags1
 = 
æags
 | 
EXT4_GET_BLOCKS_PRE_IO
;

3462 ià(
unwr™‹n
)

3463 
¥l™_æag1
 |ğ
EXT4_EXT_MARK_UNWRIT1
 |

3464 
EXT4_EXT_MARK_UNWRIT2
;

3465 ià(
¥l™_æag
 & 
EXT4_EXT_DATA_VALID2
)

3466 
¥l™_æag1
 |ğ
EXT4_EXT_DATA_VALID1
;

3467 
”r
 = 
	`ext4_¥l™_ex‹Á_©
(
hªdË
, 
šode
, 
µ©h
,

3468 
m­
->
m_lblk
 + m­->
m_Ën
, 
¥l™_æag1
, 
æags1
);

3469 ià(
”r
)

3470 
out
;

3472 
®loÿ‹d
 = 
“_Ën
 - (
m­
->
m_lblk
 - 
“_block
);

3478 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
m­
->
m_lblk
, 
µ©h
, 0);

3479 ià(
	`IS_ERR
(
·th
))

3480  
	`PTR_ERR
(
·th
);

3481 
d•th
 = 
	`ext_d•th
(
šode
);

3482 
ex
 = 
·th
[
d•th
].
p_ext
;

3483 ià(!
ex
) {

3484 
	`EXT4_ERROR_INODE
(
šode
, "unexpected hole‡t %lu",

3485 (è
m­
->
m_lblk
);

3486  -
EFSCORRUPTED
;

3488 
unwr™‹n
 = 
	`ext4_ext_is_unwr™‹n
(
ex
);

3489 
¥l™_æag1
 = 0;

3491 ià(
m­
->
m_lblk
 >ğ
“_block
) {

3492 
¥l™_æag1
 = 
¥l™_æag
 & 
EXT4_EXT_DATA_VALID2
;

3493 ià(
unwr™‹n
) {

3494 
¥l™_æag1
 |ğ
EXT4_EXT_MARK_UNWRIT1
;

3495 
¥l™_æag1
 |ğ
¥l™_æag
 & (
EXT4_EXT_MAY_ZEROOUT
 |

3496 
EXT4_EXT_MARK_UNWRIT2
);

3498 
”r
 = 
	`ext4_¥l™_ex‹Á_©
(
hªdË
, 
šode
, 
µ©h
,

3499 
m­
->
m_lblk
, 
¥l™_æag1
, 
æags
);

3500 ià(
”r
)

3501 
out
;

3504 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

3505 
out
:

3506  
”r
 ?ƒ¼ : 
®loÿ‹d
;

3507 
	}
}

3529 
	$ext4_ext_cÚv”t_to_š™Ÿlized
(
hªdË_t
 *
hªdË
,

3530 
šode
 *inode,

3531 
ext4_m­_blocks
 *
m­
,

3532 
ext4_ext_·th
 **
µ©h
,

3533 
æags
)

3535 
ext4_ext_·th
 *
·th
 = *
µ©h
;

3536 
ext4_sb_šfo
 *
sbi
;

3537 
ext4_ex‹Á_h—d”
 *
eh
;

3538 
ext4_m­_blocks
 
¥l™_m­
;

3539 
ext4_ex‹Á
 
z”o_ex1
, 
z”o_ex2
;

3540 
ext4_ex‹Á
 *
ex
, *
abut_ex
;

3541 
ext4_lblk_t
 
“_block
, 
eof_block
;

3542 
“_Ën
, 
d•th
, 
m­_Ën
 = 
m­
->
m_Ën
;

3543 
®loÿ‹d
 = 0, 
max_z”oout
 = 0;

3544 
”r
 = 0;

3545 
¥l™_æag
 = 
EXT4_EXT_DATA_VALID2
;

3547 
	`ext_debug
("ext4_ext_convert_to_initialized: inode %lu,†ogical"

3548 "block %Îu, max_block %u\n", 
šode
->
i_šo
,

3549 ()
m­
->
m_lblk
, 
m­_Ën
);

3551 
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

3552 
eof_block
 = (
šode
->
i_size
 + inode->
i_sb
->
s_blocksize
 - 1) >>

3553 
šode
->
i_sb
->
s_blocksize_b™s
;

3554 ià(
eof_block
 < 
m­
->
m_lblk
 + 
m­_Ën
)

3555 
eof_block
 = 
m­
->
m_lblk
 + 
m­_Ën
;

3557 
d•th
 = 
	`ext_d•th
(
šode
);

3558 
eh
 = 
·th
[
d•th
].
p_hdr
;

3559 
ex
 = 
·th
[
d•th
].
p_ext
;

3560 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

3561 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

3562 
z”o_ex1
.
“_Ën
 = 0;

3563 
z”o_ex2
.
“_Ën
 = 0;

3565 
	`Œaû_ext4_ext_cÚv”t_to_š™Ÿlized_’‹r
(
šode
, 
m­
, 
ex
);

3568 
	`BUG_ON
(!
	`ext4_ext_is_unwr™‹n
(
ex
));

3569 
	`BUG_ON
(!
	`š_¿nge
(
m­
->
m_lblk
, 
“_block
, 
“_Ën
));

3586 ià((
m­
->
m_lblk
 =ğ
“_block
) &&

3588 (
m­_Ën
 < 
“_Ën
) &&

3589 (
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
))) {

3590 
ext4_lblk_t
 
´ev_lblk
;

3591 
ext4_fsblk_t
 
´ev_pblk
, 
“_pblk
;

3592 
´ev_Ën
;

3594 
abut_ex
 = 
ex
 - 1;

3595 
´ev_lblk
 = 
	`Ë32_to_ıu
(
abut_ex
->
“_block
);

3596 
´ev_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
abut_ex
);

3597 
´ev_pblk
 = 
	`ext4_ext_pblock
(
abut_ex
);

3598 
“_pblk
 = 
	`ext4_ext_pblock
(
ex
);

3609 ià((!
	`ext4_ext_is_unwr™‹n
(
abut_ex
)) &&

3610 ((
´ev_lblk
 + 
´ev_Ën
è=ğ
“_block
) &&

3611 ((
´ev_pblk
 + 
´ev_Ën
è=ğ
“_pblk
) &&

3612 (
´ev_Ën
 < (
EXT_INIT_MAX_LEN
 - 
m­_Ën
))) {

3613 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

3614 ià(
”r
)

3615 
out
;

3617 
	`Œaû_ext4_ext_cÚv”t_to_š™Ÿlized_ç¡·th
(
šode
,

3618 
m­
, 
ex
, 
abut_ex
);

3621 
ex
->
“_block
 = 
	`ıu_to_Ë32
Óe_block + 
m­_Ën
);

3622 
	`ext4_ext_¡Üe_pblock
(
ex
, 
“_pblk
 + 
m­_Ën
);

3623 
ex
->
“_Ën
 = 
	`ıu_to_Ë16
Óe_ËÀ- 
m­_Ën
);

3624 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

3627 
abut_ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
´ev_Ën
 + 
m­_Ën
);

3630 
®loÿ‹d
 = 
m­_Ën
;

3632 } ià(((
m­
->
m_lblk
 + 
m­_Ën
è=ğ(
“_block
 + 
“_Ën
)) &&

3633 (
m­_Ën
 < 
“_Ën
) &&

3634 
ex
 < 
	`EXT_LAST_EXTENT
(
eh
)) {

3636 
ext4_lblk_t
 
Ãxt_lblk
;

3637 
ext4_fsblk_t
 
Ãxt_pblk
, 
“_pblk
;

3638 
Ãxt_Ën
;

3640 
abut_ex
 = 
ex
 + 1;

3641 
Ãxt_lblk
 = 
	`Ë32_to_ıu
(
abut_ex
->
“_block
);

3642 
Ãxt_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
abut_ex
);

3643 
Ãxt_pblk
 = 
	`ext4_ext_pblock
(
abut_ex
);

3644 
“_pblk
 = 
	`ext4_ext_pblock
(
ex
);

3655 ià((!
	`ext4_ext_is_unwr™‹n
(
abut_ex
)) &&

3656 ((
m­
->
m_lblk
 + 
m­_Ën
è=ğ
Ãxt_lblk
) &&

3657 ((
“_pblk
 + 
“_Ën
è=ğ
Ãxt_pblk
) &&

3658 (
Ãxt_Ën
 < (
EXT_INIT_MAX_LEN
 - 
m­_Ën
))) {

3659 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

3660 ià(
”r
)

3661 
out
;

3663 
	`Œaû_ext4_ext_cÚv”t_to_š™Ÿlized_ç¡·th
(
šode
,

3664 
m­
, 
ex
, 
abut_ex
);

3667 
abut_ex
->
“_block
 = 
	`ıu_to_Ë32
(
Ãxt_lblk
 - 
m­_Ën
);

3668 
	`ext4_ext_¡Üe_pblock
(
abut_ex
, 
Ãxt_pblk
 - 
m­_Ën
);

3669 
ex
->
“_Ën
 = 
	`ıu_to_Ë16
Óe_ËÀ- 
m­_Ën
);

3670 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

3673 
abut_ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
Ãxt_Ën
 + 
m­_Ën
);

3676 
®loÿ‹d
 = 
m­_Ën
;

3679 ià(
®loÿ‹d
) {

3681 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

3684 
·th
[
d•th
].
p_ext
 = 
abut_ex
;

3685 
out
;

3687 
®loÿ‹d
 = 
“_Ën
 - (
m­
->
m_lblk
 - 
“_block
);

3689 
	`WARN_ON
(
m­
->
m_lblk
 < 
“_block
);

3694 
¥l™_æag
 |ğ
“_block
 + 
“_Ën
 <ğ
eof_block
 ? 
EXT4_EXT_MAY_ZEROOUT
 : 0;

3696 ià(
EXT4_EXT_MAY_ZEROOUT
 & 
¥l™_æag
)

3697 
max_z”oout
 = 
sbi
->
s_ex‹Á_max_z”oout_kb
 >>

3698 (
šode
->
i_sb
->
s_blocksize_b™s
 - 10);

3700 ià(
	`IS_ENCRYPTED
(
šode
))

3701 
max_z”oout
 = 0;

3714 
¥l™_m­
.
m_lblk
 = 
m­
->m_lblk;

3715 
¥l™_m­
.
m_Ën
 = 
m­
->m_len;

3717 ià(
max_z”oout
 && (
®loÿ‹d
 > 
¥l™_m­
.
m_Ën
)) {

3718 ià(
®loÿ‹d
 <ğ
max_z”oout
) {

3720 
z”o_ex1
.
“_block
 =

3721 
	`ıu_to_Ë32
(
¥l™_m­
.
m_lblk
 +

3722 
¥l™_m­
.
m_Ën
);

3723 
z”o_ex1
.
“_Ën
 =

3724 
	`ıu_to_Ë16
(
®loÿ‹d
 - 
¥l™_m­
.
m_Ën
);

3725 
	`ext4_ext_¡Üe_pblock
(&
z”o_ex1
,

3726 
	`ext4_ext_pblock
(
ex
è+ 
¥l™_m­
.
m_lblk
 +

3727 
¥l™_m­
.
m_Ën
 - 
“_block
);

3728 
”r
 = 
	`ext4_ext_z”oout
(
šode
, &
z”o_ex1
);

3729 ià(
”r
)

3730 
out
;

3731 
¥l™_m­
.
m_Ën
 = 
®loÿ‹d
;

3733 ià(
¥l™_m­
.
m_lblk
 - 
“_block
 + s¶™_m­.
m_Ën
 <

3734 
max_z”oout
) {

3736 ià(
¥l™_m­
.
m_lblk
 !ğ
“_block
) {

3737 
z”o_ex2
.
“_block
 = 
ex
->ee_block;

3738 
z”o_ex2
.
“_Ën
 = 
	`ıu_to_Ë16
(
¥l™_m­
.
m_lblk
 -

3739 
“_block
);

3740 
	`ext4_ext_¡Üe_pblock
(&
z”o_ex2
,

3741 
	`ext4_ext_pblock
(
ex
));

3742 
”r
 = 
	`ext4_ext_z”oout
(
šode
, &
z”o_ex2
);

3743 ià(
”r
)

3744 
out
;

3747 
¥l™_m­
.
m_Ën
 +ğ¥l™_m­.
m_lblk
 - 
“_block
;

3748 
¥l™_m­
.
m_lblk
 = 
“_block
;

3749 
®loÿ‹d
 = 
m­
->
m_Ën
;

3753 
”r
 = 
	`ext4_¥l™_ex‹Á
(
hªdË
, 
šode
, 
µ©h
, &
¥l™_m­
, 
¥l™_æag
,

3754 
æags
);

3755 ià(
”r
 > 0)

3756 
”r
 = 0;

3757 
out
:

3759 ià(!
”r
) {

3760 
”r
 = 
	`ext4_z”oout_es
(
šode
, &
z”o_ex1
);

3761 ià(!
”r
)

3762 
”r
 = 
	`ext4_z”oout_es
(
šode
, &
z”o_ex2
);

3764  
”r
 ?ƒ¼ : 
®loÿ‹d
;

3765 
	}
}

3791 
	$ext4_¥l™_cÚv”t_ex‹Ás
(
hªdË_t
 *
hªdË
,

3792 
šode
 *inode,

3793 
ext4_m­_blocks
 *
m­
,

3794 
ext4_ext_·th
 **
µ©h
,

3795 
æags
)

3797 
ext4_ext_·th
 *
·th
 = *
µ©h
;

3798 
ext4_lblk_t
 
eof_block
;

3799 
ext4_lblk_t
 
“_block
;

3800 
ext4_ex‹Á
 *
ex
;

3801 
“_Ën
;

3802 
¥l™_æag
 = 0, 
d•th
;

3804 
	`ext_debug
("%s: inode %lu,†ogical block %llu, max_blocks %u\n",

3805 
__func__
, 
šode
->
i_šo
,

3806 ()
m­
->
m_lblk
, m­->
m_Ën
);

3808 
eof_block
 = (
šode
->
i_size
 + inode->
i_sb
->
s_blocksize
 - 1) >>

3809 
šode
->
i_sb
->
s_blocksize_b™s
;

3810 ià(
eof_block
 < 
m­
->
m_lblk
 + m­->
m_Ën
)

3811 
eof_block
 = 
m­
->
m_lblk
 + m­->
m_Ën
;

3816 
d•th
 = 
	`ext_d•th
(
šode
);

3817 
ex
 = 
·th
[
d•th
].
p_ext
;

3818 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

3819 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

3822 ià(
æags
 & 
EXT4_GET_BLOCKS_CONVERT_UNWRITTEN
) {

3823 
¥l™_æag
 |ğ
EXT4_EXT_DATA_VALID1
;

3825 } ià(
æags
 & 
EXT4_GET_BLOCKS_CONVERT
) {

3826 
¥l™_æag
 |ğ
“_block
 + 
“_Ën
 <ğ
eof_block
 ?

3827 
EXT4_EXT_MAY_ZEROOUT
 : 0;

3828 
¥l™_æag
 |ğ(
EXT4_EXT_MARK_UNWRIT2
 | 
EXT4_EXT_DATA_VALID2
);

3830 
æags
 |ğ
EXT4_GET_BLOCKS_PRE_IO
;

3831  
	`ext4_¥l™_ex‹Á
(
hªdË
, 
šode
, 
µ©h
, 
m­
, 
¥l™_æag
, 
æags
);

3832 
	}
}

3834 
	$ext4_cÚv”t_unwr™‹n_ex‹Ás_’dio
(
hªdË_t
 *
hªdË
,

3835 
šode
 *inode,

3836 
ext4_m­_blocks
 *
m­
,

3837 
ext4_ext_·th
 **
µ©h
)

3839 
ext4_ext_·th
 *
·th
 = *
µ©h
;

3840 
ext4_ex‹Á
 *
ex
;

3841 
ext4_lblk_t
 
“_block
;

3842 
“_Ën
;

3843 
d•th
;

3844 
”r
 = 0;

3846 
d•th
 = 
	`ext_d•th
(
šode
);

3847 
ex
 = 
·th
[
d•th
].
p_ext
;

3848 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

3849 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

3851 
	`ext_debug
("ext4_convert_unwritten_extents_endio: inode %lu,†ogical"

3852 "block %Îu, max_block %u\n", 
šode
->
i_šo
,

3853 ()
“_block
, 
“_Ën
);

3861 ià(
“_block
 !ğ
m­
->
m_lblk
 || 
“_Ën
 > m­->
m_Ën
) {

3862 #ifdeà
CONFIG_EXT4_DEBUG


3863 
	`ext4_w¬nšg
(
šode
->
i_sb
, "Inode (%ld) finished:ƒxtent†ogical block %llu,"

3865 
šode
->
i_šo
, ()
“_block
, 
“_Ën
,

3866 ()
m­
->
m_lblk
, m­->
m_Ën
);

3868 
”r
 = 
	`ext4_¥l™_cÚv”t_ex‹Ás
(
hªdË
, 
šode
, 
m­
, 
µ©h
,

3869 
EXT4_GET_BLOCKS_CONVERT
);

3870 ià(
”r
 < 0)

3871  
”r
;

3872 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
m­
->
m_lblk
, 
µ©h
, 0);

3873 ià(
	`IS_ERR
(
·th
))

3874  
	`PTR_ERR
(
·th
);

3875 
d•th
 = 
	`ext_d•th
(
šode
);

3876 
ex
 = 
·th
[
d•th
].
p_ext
;

3879 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

3880 ià(
”r
)

3881 
out
;

3883 
	`ext4_ext_m¬k_š™Ÿlized
(
ex
);

3888 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
šode
, 
·th
, 
ex
);

3891 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 +…©h->
p_d•th
);

3892 
out
:

3893 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

3894  
”r
;

3895 
	}
}

3900 
	$check_eofblocks_æ
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

3901 
ext4_lblk_t
 
lblk
,

3902 
ext4_ext_·th
 *
·th
,

3903 
Ën
)

3905 
i
, 
d•th
;

3906 
ext4_ex‹Á_h—d”
 *
eh
;

3907 
ext4_ex‹Á
 *
Ï¡_ex
;

3909 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EOFBLOCKS
))

3912 
d•th
 = 
	`ext_d•th
(
šode
);

3913 
eh
 = 
·th
[
d•th
].
p_hdr
;

3920 ià(
	`uÆik–y
(!
eh
->
eh_’Œ›s
))

3921 
out
;

3922 
Ï¡_ex
 = 
	`EXT_LAST_EXTENT
(
eh
);

3932 ià(
lblk
 + 
Ën
 < 
	`Ë32_to_ıu
(
Ï¡_ex
->
“_block
) +

3933 
	`ext4_ext_g‘_aùu®_Ën
(
Ï¡_ex
))

3942 
i
 = 
d•th
-1; i >= 0; i--)

3943 ià(
·th
[
i
].
p_idx
 !ğ
	`EXT_LAST_INDEX
Õ©h[i].
p_hdr
))

3945 
out
:

3946 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_EOFBLOCKS
);

3947  
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

3948 
	}
}

3951 
	$cÚv”t_š™Ÿlized_ex‹Á
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

3952 
ext4_m­_blocks
 *
m­
,

3953 
ext4_ext_·th
 **
µ©h
,

3954 
®loÿ‹d
)

3956 
ext4_ext_·th
 *
·th
 = *
µ©h
;

3957 
ext4_ex‹Á
 *
ex
;

3958 
ext4_lblk_t
 
“_block
;

3959 
“_Ën
;

3960 
d•th
;

3961 
”r
 = 0;

3967 ià(
m­
->
m_Ën
 > 
EXT_UNWRITTEN_MAX_LEN
)

3968 
m­
->
m_Ën
 = 
EXT_UNWRITTEN_MAX_LEN
 / 2;

3970 
d•th
 = 
	`ext_d•th
(
šode
);

3971 
ex
 = 
·th
[
d•th
].
p_ext
;

3972 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

3973 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

3975 
	`ext_debug
("%s: inode %lu,†ogical"

3976 "block %Îu, max_block %u\n", 
__func__
, 
šode
->
i_šo
,

3977 ()
“_block
, 
“_Ën
);

3979 ià(
“_block
 !ğ
m­
->
m_lblk
 || 
“_Ën
 > m­->
m_Ën
) {

3980 
”r
 = 
	`ext4_¥l™_cÚv”t_ex‹Ás
(
hªdË
, 
šode
, 
m­
, 
µ©h
,

3981 
EXT4_GET_BLOCKS_CONVERT_UNWRITTEN
);

3982 ià(
”r
 < 0)

3983  
”r
;

3984 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
m­
->
m_lblk
, 
µ©h
, 0);

3985 ià(
	`IS_ERR
(
·th
))

3986  
	`PTR_ERR
(
·th
);

3987 
d•th
 = 
	`ext_d•th
(
šode
);

3988 
ex
 = 
·th
[
d•th
].
p_ext
;

3989 ià(!
ex
) {

3990 
	`EXT4_ERROR_INODE
(
šode
, "unexpected hole‡t %lu",

3991 (è
m­
->
m_lblk
);

3992  -
EFSCORRUPTED
;

3996 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

3997 ià(
”r
)

3998  
”r
;

4000 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

4005 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
šode
, 
·th
, 
ex
);

4008 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 +…©h->
p_d•th
);

4009 ià(
”r
)

4010  
”r
;

4011 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

4013 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

4014 
”r
 = 
	`check_eofblocks_æ
(
hªdË
, 
šode
, 
m­
->
m_lblk
, 
·th
, m­->
m_Ën
);

4015 ià(
”r
)

4016  
”r
;

4017 
m­
->
m_æags
 |ğ
EXT4_MAP_UNWRITTEN
;

4018 ià(
®loÿ‹d
 > 
m­
->
m_Ën
)

4019 
®loÿ‹d
 = 
m­
->
m_Ën
;

4020 
m­
->
m_Ën
 = 
®loÿ‹d
;

4021  
®loÿ‹d
;

4022 
	}
}

4025 
	$ext4_ext_hªdË_unwr™‹n_ex‹Ás
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

4026 
ext4_m­_blocks
 *
m­
,

4027 
ext4_ext_·th
 **
µ©h
, 
æags
,

4028 
®loÿ‹d
, 
ext4_fsblk_t
 
Ãwblock
)

4030 
ext4_ext_·th
 *
·th
 = *
µ©h
;

4031 
»t
 = 0;

4032 
”r
 = 0;

4034 
	`ext_debug
("ext4_ext_handle_unwritten_extents: inode %lu,†ogical "

4036 
šode
->
i_šo
, ()
m­
->
m_lblk
, m­->
m_Ën
,

4037 
æags
, 
®loÿ‹d
);

4038 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

4044 
æags
 |ğ
EXT4_GET_BLOCKS_METADATA_NOFAIL
;

4046 
	`Œaû_ext4_ext_hªdË_unwr™‹n_ex‹Ás
(
šode
, 
m­
, 
æags
,

4047 
®loÿ‹d
, 
Ãwblock
);

4050 ià(
æags
 & 
EXT4_GET_BLOCKS_PRE_IO
) {

4051 
»t
 = 
	`ext4_¥l™_cÚv”t_ex‹Ás
(
hªdË
, 
šode
, 
m­
, 
µ©h
,

4052 
æags
 | 
EXT4_GET_BLOCKS_CONVERT
);

4053 ià(
»t
 <= 0)

4054 
out
;

4055 
m­
->
m_æags
 |ğ
EXT4_MAP_UNWRITTEN
;

4056 
out
;

4059 ià(
æags
 & 
EXT4_GET_BLOCKS_CONVERT
) {

4060 ià(
æags
 & 
EXT4_GET_BLOCKS_ZERO
) {

4061 ià(
®loÿ‹d
 > 
m­
->
m_Ën
)

4062 
®loÿ‹d
 = 
m­
->
m_Ën
;

4063 
”r
 = 
	`ext4_issue_z”oout
(
šode
, 
m­
->
m_lblk
, 
Ãwblock
,

4064 
®loÿ‹d
);

4065 ià(
”r
 < 0)

4066 
out2
;

4068 
»t
 = 
	`ext4_cÚv”t_unwr™‹n_ex‹Ás_’dio
(
hªdË
, 
šode
, 
m­
,

4069 
µ©h
);

4070 ià(
»t
 >= 0) {

4071 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

4072 
”r
 = 
	`check_eofblocks_æ
(
hªdË
, 
šode
, 
m­
->
m_lblk
,

4073 
·th
, 
m­
->
m_Ën
);

4075 
”r
 = 
»t
;

4076 
m­
->
m_æags
 |ğ
EXT4_MAP_MAPPED
;

4077 
m­
->
m_pblk
 = 
Ãwblock
;

4078 ià(
®loÿ‹d
 > 
m­
->
m_Ën
)

4079 
®loÿ‹d
 = 
m­
->
m_Ën
;

4080 
m­
->
m_Ën
 = 
®loÿ‹d
;

4081 
out2
;

4088 ià(
æags
 & 
EXT4_GET_BLOCKS_UNWRIT_EXT
) {

4089 
m­
->
m_æags
 |ğ
EXT4_MAP_UNWRITTEN
;

4090 
m­_out
;

4094 ià((
æags
 & 
EXT4_GET_BLOCKS_CREATE
) == 0) {

4102 
m­
->
m_æags
 |ğ
EXT4_MAP_UNWRITTEN
;

4103 
out1
;

4107 
»t
 = 
	`ext4_ext_cÚv”t_to_š™Ÿlized
(
hªdË
, 
šode
, 
m­
, 
µ©h
, 
æags
);

4108 ià(
»t
 >= 0)

4109 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

4110 
out
:

4111 ià(
»t
 <= 0) {

4112 
”r
 = 
»t
;

4113 
out2
;

4115 
®loÿ‹d
 = 
»t
;

4116 
m­
->
m_æags
 |ğ
EXT4_MAP_NEW
;

4117 ià(
®loÿ‹d
 > 
m­
->
m_Ën
)

4118 
®loÿ‹d
 = 
m­
->
m_Ën
;

4119 
m­
->
m_Ën
 = 
®loÿ‹d
;

4121 
m­_out
:

4122 
m­
->
m_æags
 |ğ
EXT4_MAP_MAPPED
;

4123 ià((
æags
 & 
EXT4_GET_BLOCKS_KEEP_SIZE
) == 0) {

4124 
”r
 = 
	`check_eofblocks_æ
(
hªdË
, 
šode
, 
m­
->
m_lblk
, 
·th
,

4125 
m­
->
m_Ën
);

4126 ià(
”r
 < 0)

4127 
out2
;

4129 
out1
:

4130 ià(
®loÿ‹d
 > 
m­
->
m_Ën
)

4131 
®loÿ‹d
 = 
m­
->
m_Ën
;

4132 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

4133 
m­
->
m_pblk
 = 
Ãwblock
;

4134 
m­
->
m_Ën
 = 
®loÿ‹d
;

4135 
out2
:

4136  
”r
 ?ƒ¼ : 
®loÿ‹d
;

4137 
	}
}

4180 
	$g‘_im¶›d_şu¡”_®loc
(
su³r_block
 *
sb
,

4181 
ext4_m­_blocks
 *
m­
,

4182 
ext4_ex‹Á
 *
ex
,

4183 
ext4_ext_·th
 *
·th
)

4185 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

4186 
ext4_lblk_t
 
c_off£t
 = 
	`EXT4_LBLK_COFF
(
sbi
, 
m­
->
m_lblk
);

4187 
ext4_lblk_t
 
ex_şu¡”_¡¬t
, 
ex_şu¡”_’d
;

4188 
ext4_lblk_t
 
¼_şu¡”_¡¬t
;

4189 
ext4_lblk_t
 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

4190 
ext4_fsblk_t
 
“_¡¬t
 = 
	`ext4_ext_pblock
(
ex
);

4191 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

4194 
ex_şu¡”_¡¬t
 = 
	`EXT4_B2C
(
sbi
, 
“_block
);

4195 
ex_şu¡”_’d
 = 
	`EXT4_B2C
(
sbi
, 
“_block
 + 
“_Ën
 - 1);

4198 
¼_şu¡”_¡¬t
 = 
	`EXT4_B2C
(
sbi
, 
m­
->
m_lblk
);

4200 ià((
¼_şu¡”_¡¬t
 =ğ
ex_şu¡”_’d
) ||

4201 (
¼_şu¡”_¡¬t
 =ğ
ex_şu¡”_¡¬t
)) {

4202 ià(
¼_şu¡”_¡¬t
 =ğ
ex_şu¡”_’d
)

4203 
“_¡¬t
 +ğ
“_Ën
 - 1;

4204 
m­
->
m_pblk
 = 
	`EXT4_PBLK_CMASK
(
sbi
, 
“_¡¬t
è+ 
c_off£t
;

4205 
m­
->
m_Ën
 = 
	`mš
(map->m_len,

4206 (è
sbi
->
s_şu¡”_¿tio
 - 
c_off£t
);

4216 ià(
m­
->
m_lblk
 < 
“_block
)

4217 
m­
->
m_Ën
 = 
	`mš
(m­->m_Ën, 
“_block
 - m­->
m_lblk
);

4228 ià(
m­
->
m_lblk
 > 
“_block
) {

4229 
ext4_lblk_t
 
Ãxt
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th
);

4230 
m­
->
m_Ën
 = 
	`mš
(m­->m_Ën, 
Ãxt
 - m­->
m_lblk
);

4233 
	`Œaû_ext4_g‘_im¶›d_şu¡”_®loc_ex™
(
sb
, 
m­
, 1);

4237 
	`Œaû_ext4_g‘_im¶›d_şu¡”_®loc_ex™
(
sb
, 
m­
, 0);

4239 
	}
}

4260 
	$ext4_ext_m­_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

4261 
ext4_m­_blocks
 *
m­
, 
æags
)

4263 
ext4_ext_·th
 *
·th
 = 
NULL
;

4264 
ext4_ex‹Á
 
Ãwex
, *
ex
, *
ex2
;

4265 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

4266 
ext4_fsblk_t
 
Ãwblock
 = 0;

4267 
ä“_Ú_”r
 = 0, 
”r
 = 0, 
d•th
, 
»t
;

4268 
®loÿ‹d
 = 0, 
off£t
 = 0;

4269 
®loÿ‹d_şu¡”s
 = 0;

4270 
ext4_®loÿtiÚ_»que¡
 
¬
;

4271 
ext4_lblk_t
 
şu¡”_off£t
;

4272 
boŞ
 
m­_äom_şu¡”
 = 
çl£
;

4274 
	`ext_debug
("blocks %u/%u„equested for inode %lu\n",

4275 
m­
->
m_lblk
, m­->
m_Ën
, 
šode
->
i_šo
);

4276 
	`Œaû_ext4_ext_m­_blocks_’‹r
(
šode
, 
m­
->
m_lblk
, m­->
m_Ën
, 
æags
);

4279 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
m­
->
m_lblk
, 
NULL
, 0);

4280 ià(
	`IS_ERR
(
·th
)) {

4281 
”r
 = 
	`PTR_ERR
(
·th
);

4282 
·th
 = 
NULL
;

4283 
out2
;

4286 
d•th
 = 
	`ext_d•th
(
šode
);

4293 ià(
	`uÆik–y
(
·th
[
d•th
].
p_ext
 =ğ
NULL
 && depth != 0)) {

4294 
	`EXT4_ERROR_INODE
(
šode
, "badƒxtent‡ddress "

4296 (è
m­
->
m_lblk
, 
d•th
,

4297 
·th
[
d•th
].
p_block
);

4298 
”r
 = -
EFSCORRUPTED
;

4299 
out2
;

4302 
ex
 = 
·th
[
d•th
].
p_ext
;

4303 ià(
ex
) {

4304 
ext4_lblk_t
 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

4305 
ext4_fsblk_t
 
“_¡¬t
 = 
	`ext4_ext_pblock
(
ex
);

4306 
“_Ën
;

4313 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

4315 
	`Œaû_ext4_ext_show_ex‹Á
(
šode
, 
“_block
, 
“_¡¬t
, 
“_Ën
);

4318 ià(
	`š_¿nge
(
m­
->
m_lblk
, 
“_block
, 
“_Ën
)) {

4319 
Ãwblock
 = 
m­
->
m_lblk
 - 
“_block
 + 
“_¡¬t
;

4321 
®loÿ‹d
 = 
“_Ën
 - (
m­
->
m_lblk
 - 
“_block
);

4322 
	`ext_debug
("%u f™ iÁØ%u:%d -> %Îu\n", 
m­
->
m_lblk
,

4323 
“_block
, 
“_Ën
, 
Ãwblock
);

4329 ià((!
	`ext4_ext_is_unwr™‹n
(
ex
)) &&

4330 (
æags
 & 
EXT4_GET_BLOCKS_CONVERT_UNWRITTEN
)) {

4331 
®loÿ‹d
 = 
	`cÚv”t_š™Ÿlized_ex‹Á
(

4332 
hªdË
, 
šode
, 
m­
, &
·th
,

4333 
®loÿ‹d
);

4334 
out2
;

4335 } ià(!
	`ext4_ext_is_unwr™‹n
(
ex
))

4336 
out
;

4338 
»t
 = 
	`ext4_ext_hªdË_unwr™‹n_ex‹Ás
(

4339 
hªdË
, 
šode
, 
m­
, &
·th
, 
æags
,

4340 
®loÿ‹d
, 
Ãwblock
);

4341 ià(
»t
 < 0)

4342 
”r
 = 
»t
;

4344 
®loÿ‹d
 = 
»t
;

4345 
out2
;

4353 ià((
æags
 & 
EXT4_GET_BLOCKS_CREATE
) == 0) {

4354 
ext4_lblk_t
 
hŞe_¡¬t
, 
hŞe_Ën
;

4356 
hŞe_¡¬t
 = 
m­
->
m_lblk
;

4357 
hŞe_Ën
 = 
	`ext4_ext_d‘”mše_hŞe
(
šode
, 
·th
, &
hŞe_¡¬t
);

4362 
	`ext4_ext_put_g­_š_ÿche
(
šode
, 
hŞe_¡¬t
, 
hŞe_Ën
);

4365 ià(
hŞe_¡¬t
 !ğ
m­
->
m_lblk
)

4366 
hŞe_Ën
 -ğ
m­
->
m_lblk
 - 
hŞe_¡¬t
;

4367 
m­
->
m_pblk
 = 0;

4368 
m­
->
m_Ën
 = 
	`mš_t
(, m­->m_Ën, 
hŞe_Ën
);

4370 
out2
;

4376 
Ãwex
.
“_block
 = 
	`ıu_to_Ë32
(
m­
->
m_lblk
);

4377 
şu¡”_off£t
 = 
	`EXT4_LBLK_COFF
(
sbi
, 
m­
->
m_lblk
);

4383 ià(
şu¡”_off£t
 && 
ex
 &&

4384 
	`g‘_im¶›d_şu¡”_®loc
(
šode
->
i_sb
, 
m­
, 
ex
, 
·th
)) {

4385 
¬
.
Ën
 = 
®loÿ‹d
 = 
m­
->
m_Ën
;

4386 
Ãwblock
 = 
m­
->
m_pblk
;

4387 
m­_äom_şu¡”
 = 
Œue
;

4388 
gÙ_®loÿ‹d_blocks
;

4392 
¬
.
Îeá
 = 
m­
->
m_lblk
;

4393 
”r
 = 
	`ext4_ext_£¬ch_Ëá
(
šode
, 
·th
, &
¬
.
Îeá
, &¬.
¶eá
);

4394 ià(
”r
)

4395 
out2
;

4396 
¬
.
Ìight
 = 
m­
->
m_lblk
;

4397 
ex2
 = 
NULL
;

4398 
”r
 = 
	`ext4_ext_£¬ch_right
(
šode
, 
·th
, &
¬
.
Ìight
, &¬.
´ight
, &
ex2
);

4399 ià(
”r
)

4400 
out2
;

4404 ià((
sbi
->
s_şu¡”_¿tio
 > 1è&& 
ex2
 &&

4405 
	`g‘_im¶›d_şu¡”_®loc
(
šode
->
i_sb
, 
m­
, 
ex2
, 
·th
)) {

4406 
¬
.
Ën
 = 
®loÿ‹d
 = 
m­
->
m_Ën
;

4407 
Ãwblock
 = 
m­
->
m_pblk
;

4408 
m­_äom_şu¡”
 = 
Œue
;

4409 
gÙ_®loÿ‹d_blocks
;

4418 ià(
m­
->
m_Ën
 > 
EXT_INIT_MAX_LEN
 &&

4419 !(
æags
 & 
EXT4_GET_BLOCKS_UNWRIT_EXT
))

4420 
m­
->
m_Ën
 = 
EXT_INIT_MAX_LEN
;

4421 ià(
m­
->
m_Ën
 > 
EXT_UNWRITTEN_MAX_LEN
 &&

4422 (
æags
 & 
EXT4_GET_BLOCKS_UNWRIT_EXT
))

4423 
m­
->
m_Ën
 = 
EXT_UNWRITTEN_MAX_LEN
;

4426 
Ãwex
.
“_Ën
 = 
	`ıu_to_Ë16
(
m­
->
m_Ën
);

4427 
”r
 = 
	`ext4_ext_check_ov”Ïp
(
sbi
, 
šode
, &
Ãwex
, 
·th
);

4428 ià(
”r
)

4429 
®loÿ‹d
 = 
	`ext4_ext_g‘_aùu®_Ën
(&
Ãwex
);

4431 
®loÿ‹d
 = 
m­
->
m_Ën
;

4434 
¬
.
šode
 = inode;

4435 
¬
.
gßl
 = 
	`ext4_ext_fšd_gßl
(
šode
, 
·th
, 
m­
->
m_lblk
);

4436 
¬
.
logiÿl
 = 
m­
->
m_lblk
;

4445 
off£t
 = 
	`EXT4_LBLK_COFF
(
sbi
, 
m­
->
m_lblk
);

4446 
¬
.
Ën
 = 
	`EXT4_NUM_B2C
(
sbi
, 
off£t
+
®loÿ‹d
);

4447 
¬
.
gßl
 -ğ
off£t
;

4448 
¬
.
logiÿl
 -ğ
off£t
;

4449 ià(
	`S_ISREG
(
šode
->
i_mode
))

4450 
¬
.
æags
 = 
EXT4_MB_HINT_DATA
;

4453 
¬
.
æags
 = 0;

4454 ià(
æags
 & 
EXT4_GET_BLOCKS_NO_NORMALIZE
)

4455 
¬
.
æags
 |ğ
EXT4_MB_HINT_NOPREALLOC
;

4456 ià(
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
)

4457 
¬
.
æags
 |ğ
EXT4_MB_DELALLOC_RESERVED
;

4458 ià(
æags
 & 
EXT4_GET_BLOCKS_METADATA_NOFAIL
)

4459 
¬
.
æags
 |ğ
EXT4_MB_USE_RESERVED
;

4460 
Ãwblock
 = 
	`ext4_mb_Ãw_blocks
(
hªdË
, &
¬
, &
”r
);

4461 ià(!
Ãwblock
)

4462 
out2
;

4463 
	`ext_debug
("allocate‚ew block: goal %llu, found %llu/%u\n",

4464 
¬
.
gßl
, 
Ãwblock
, 
®loÿ‹d
);

4465 
ä“_Ú_”r
 = 1;

4466 
®loÿ‹d_şu¡”s
 = 
¬
.
Ën
;

4467 
¬
.
Ën
 = 
	`EXT4_C2B
(
sbi
,‡r.Ënè- 
off£t
;

4468 ià(
¬
.
Ën
 > 
®loÿ‹d
)

4469 
¬
.
Ën
 = 
®loÿ‹d
;

4471 
gÙ_®loÿ‹d_blocks
:

4473 
	`ext4_ext_¡Üe_pblock
(&
Ãwex
, 
Ãwblock
 + 
off£t
);

4474 
Ãwex
.
“_Ën
 = 
	`ıu_to_Ë16
(
¬
.
Ën
);

4476 ià(
æags
 & 
EXT4_GET_BLOCKS_UNWRIT_EXT
){

4477 
	`ext4_ext_m¬k_unwr™‹n
(&
Ãwex
);

4478 
m­
->
m_æags
 |ğ
EXT4_MAP_UNWRITTEN
;

4481 
”r
 = 0;

4482 ià((
æags
 & 
EXT4_GET_BLOCKS_KEEP_SIZE
) == 0)

4483 
”r
 = 
	`check_eofblocks_æ
(
hªdË
, 
šode
, 
m­
->
m_lblk
,

4484 
·th
, 
¬
.
Ën
);

4485 ià(!
”r
)

4486 
”r
 = 
	`ext4_ext_š£¹_ex‹Á
(
hªdË
, 
šode
, &
·th
,

4487 &
Ãwex
, 
æags
);

4489 ià(
”r
 && 
ä“_Ú_”r
) {

4490 
fb_æags
 = 
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
 ?

4491 
EXT4_FREE_BLOCKS_NO_QUOT_UPDATE
 : 0;

4495 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

4496 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
Ãwblock
,

4497 
	`EXT4_C2B
(
sbi
, 
®loÿ‹d_şu¡”s
), 
fb_æags
);

4498 
out2
;

4502 
Ãwblock
 = 
	`ext4_ext_pblock
(&
Ãwex
);

4503 
®loÿ‹d
 = 
	`ext4_ext_g‘_aùu®_Ën
(&
Ãwex
);

4504 ià(
®loÿ‹d
 > 
m­
->
m_Ën
)

4505 
®loÿ‹d
 = 
m­
->
m_Ën
;

4506 
m­
->
m_æags
 |ğ
EXT4_MAP_NEW
;

4514 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DELALLOC
è&& !
m­_äom_şu¡”
) {

4515 ià(
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
) {

4520 
	`ext4_da_upd©e_»£rve_¥aû
(
šode
, 
®loÿ‹d_şu¡”s
,

4523 
ext4_lblk_t
 
lblk
, 
Ën
;

4524 
n
;

4537 
lblk
 = 
	`EXT4_LBLK_CMASK
(
sbi
, 
m­
->
m_lblk
);

4538 
Ën
 = 
®loÿ‹d_şu¡”s
 << 
sbi
->
s_şu¡”_b™s
;

4539 
n
 = 
	`ext4_es_d–ayed_şu
(
šode
, 
lblk
, 
Ën
);

4540 ià(
n
 > 0)

4541 
	`ext4_da_upd©e_»£rve_¥aû
(
šode
, (è
n
, 0);

4549 ià((
æags
 & 
EXT4_GET_BLOCKS_UNWRIT_EXT
) == 0)

4550 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

4552 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 0);

4553 
out
:

4554 ià(
®loÿ‹d
 > 
m­
->
m_Ën
)

4555 
®loÿ‹d
 = 
m­
->
m_Ën
;

4556 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

4557 
m­
->
m_æags
 |ğ
EXT4_MAP_MAPPED
;

4558 
m­
->
m_pblk
 = 
Ãwblock
;

4559 
m­
->
m_Ën
 = 
®loÿ‹d
;

4560 
out2
:

4561 
	`ext4_ext_drİ_»fs
(
·th
);

4562 
	`kä“
(
·th
);

4564 
	`Œaû_ext4_ext_m­_blocks_ex™
(
šode
, 
æags
, 
m­
,

4565 
”r
 ?ƒ¼ : 
®loÿ‹d
);

4566  
”r
 ?ƒ¼ : 
®loÿ‹d
;

4567 
	}
}

4569 
	$ext4_ext_Œunÿ‹
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

4571 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

4572 
ext4_lblk_t
 
Ï¡_block
;

4573 
”r
 = 0;

4582 
	`EXT4_I
(
šode
)->
i_disksize
 = inode->
i_size
;

4583 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

4584 ià(
”r
)

4585  
”r
;

4587 
Ï¡_block
 = (
šode
->
i_size
 + 
sb
->
s_blocksize
 - 1)

4588 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

4589 
»Œy
:

4590 
”r
 = 
	`ext4_es_»move_ex‹Á
(
šode
, 
Ï¡_block
,

4591 
EXT_MAX_BLOCKS
 - 
Ï¡_block
);

4592 ià(
”r
 =ğ-
ENOMEM
) {

4593 
	`cÚd_»sched
();

4594 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

4595 
»Œy
;

4597 ià(
”r
)

4598  
”r
;

4599  
	`ext4_ext_»move_¥aû
(
šode
, 
Ï¡_block
, 
EXT_MAX_BLOCKS
 - 1);

4600 
	}
}

4602 
	$ext4_®loc_fe_blocks
(
fe
 *fe, 
ext4_lblk_t
 
off£t
,

4603 
ext4_lblk_t
 
Ën
, 
loff_t
 
Ãw_size
,

4604 
æags
)

4606 
šode
 *šodğ
	`fe_šode
(
fe
);

4607 
hªdË_t
 *
hªdË
;

4608 
»t
 = 0;

4609 
»t2
 = 0;

4610 
»Œ›s
 = 0;

4611 
d•th
 = 0;

4612 
ext4_m­_blocks
 
m­
;

4613 
üed™s
;

4614 
loff_t
 
•os
;

4616 
	`BUG_ON
(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
));

4617 
m­
.
m_lblk
 = 
off£t
;

4618 
m­
.
m_Ën
 = 
Ën
;

4624 ià(
Ën
 <ğ
EXT_UNWRITTEN_MAX_LEN
)

4625 
æags
 |ğ
EXT4_GET_BLOCKS_NO_NORMALIZE
;

4630 
üed™s
 = 
	`ext4_chunk_Œªs_blocks
(
šode
, 
Ën
);

4631 
d•th
 = 
	`ext_d•th
(
šode
);

4633 
»Œy
:

4634 
»t
 >ğ0 && 
Ën
) {

4638 ià(
d•th
 !ğ
	`ext_d•th
(
šode
)) {

4639 
üed™s
 = 
	`ext4_chunk_Œªs_blocks
(
šode
, 
Ën
);

4640 
d•th
 = 
	`ext_d•th
(
šode
);

4643 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MAP_BLOCKS
,

4644 
üed™s
);

4645 ià(
	`IS_ERR
(
hªdË
)) {

4646 
»t
 = 
	`PTR_ERR
(
hªdË
);

4649 
»t
 = 
	`ext4_m­_blocks
(
hªdË
, 
šode
, &
m­
, 
æags
);

4650 ià(
»t
 <= 0) {

4651 
	`ext4_debug
("inode #%lu: block %u:†en %u: "

4653 
šode
->
i_šo
, 
m­
.
m_lblk
,

4654 
m­
.
m_Ën
, 
»t
);

4655 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

4656 
»t2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

4659 
m­
.
m_lblk
 +ğ
»t
;

4660 
m­
.
m_Ën
 = 
Ën
 =†’ - 
»t
;

4661 
•os
 = (
loff_t
)
m­
.
m_lblk
 << 
šode
->
i_blkb™s
;

4662 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

4663 ià(
Ãw_size
) {

4664 ià(
•os
 > 
Ãw_size
)

4665 
•os
 = 
Ãw_size
;

4666 ià(
	`ext4_upd©e_šode_size
(
šode
, 
•os
) & 0x1)

4667 
šode
->
i_mtime
 = inode->
i_ùime
;

4669 ià(
•os
 > 
šode
->
i_size
)

4670 
	`ext4_£t_šode_æag
(
šode
,

4671 
EXT4_INODE_EOFBLOCKS
);

4673 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

4674 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

4675 
»t2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

4676 ià(
»t2
)

4679 ià(
»t
 =ğ-
ENOSPC
 &&

4680 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
)) {

4681 
»t
 = 0;

4682 
»Œy
;

4685  
»t
 > 0 ? 
»t2
 :„et;

4686 
	}
}

4688 
	$ext4_z”o_¿nge
(
fe
 *fe, 
loff_t
 
off£t
,

4689 
loff_t
 
Ën
, 
mode
)

4691 
šode
 *šodğ
	`fe_šode
(
fe
);

4692 
hªdË_t
 *
hªdË
 = 
NULL
;

4693 
max_blocks
;

4694 
loff_t
 
Ãw_size
 = 0;

4695 
»t
 = 0;

4696 
æags
;

4697 
üed™s
;

4698 
·¹Ÿl_begš
, 
·¹Ÿl_’d
;

4699 
loff_t
 
¡¬t
, 
’d
;

4700 
ext4_lblk_t
 
lblk
;

4701 
blkb™s
 = 
šode
->
i_blkb™s
;

4703 
	`Œaû_ext4_z”o_¿nge
(
šode
, 
off£t
, 
Ën
, 
mode
);

4705 ià(!
	`S_ISREG
(
šode
->
i_mode
))

4706  -
EINVAL
;

4709 ià(
	`ext4_should_jouº®_d©a
(
šode
)) {

4710 
»t
 = 
	`ext4_fÜû_comm™
(
šode
->
i_sb
);

4711 ià(
»t
)

4712  
»t
;

4721 
¡¬t
 = 
	`round_up
(
off£t
, 1 << 
blkb™s
);

4722 
’d
 = 
	`round_down
((
off£t
 + 
Ën
), 1 << 
blkb™s
);

4724 ià(
¡¬t
 < 
off£t
 || 
’d
 > off£ˆ+ 
Ën
)

4725  -
EINVAL
;

4726 
·¹Ÿl_begš
 = 
off£t
 & ((1 << 
blkb™s
) - 1);

4727 
·¹Ÿl_’d
 = (
off£t
 + 
Ën
è& ((1 << 
blkb™s
) - 1);

4729 
lblk
 = 
¡¬t
 >> 
blkb™s
;

4730 
max_blocks
 = (
’d
 >> 
blkb™s
);

4731 ià(
max_blocks
 < 
lblk
)

4732 
max_blocks
 = 0;

4734 
max_blocks
 -ğ
lblk
;

4736 
	`šode_lock
(
šode
);

4741 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))) {

4742 
»t
 = -
EOPNOTSUPP
;

4743 
out_mu‹x
;

4746 ià(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

4747 (
off£t
 + 
Ën
 > 
	`i_size_»ad
(
šode
) ||

4748 
off£t
 + 
Ën
 > 
	`EXT4_I
(
šode
)->
i_disksize
)) {

4749 
Ãw_size
 = 
off£t
 + 
Ën
;

4750 
»t
 = 
	`šode_Ãwsize_ok
(
šode
, 
Ãw_size
);

4751 ià(
»t
)

4752 
out_mu‹x
;

4755 
æags
 = 
EXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
;

4756 ià(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

4757 
æags
 |ğ
EXT4_GET_BLOCKS_KEEP_SIZE
;

4760 
	`šode_dio_wa™
(
šode
);

4763 ià(
·¹Ÿl_begš
 || 
·¹Ÿl_’d
) {

4764 
»t
 = 
	`ext4_®loc_fe_blocks
(
fe
,

4765 
	`round_down
(
off£t
, 1 << 
blkb™s
) >> blkbits,

4766 (
	`round_up
((
off£t
 + 
Ën
), 1 << 
blkb™s
) -

4767 
	`round_down
(
off£t
, 1 << 
blkb™s
)) >> blkbits,

4768 
Ãw_size
, 
æags
);

4769 ià(
»t
)

4770 
out_mu‹x
;

4775 ià(
max_blocks
 > 0) {

4776 
æags
 |ğ(
EXT4_GET_BLOCKS_CONVERT_UNWRITTEN
 |

4777 
EXT4_EX_NOCACHE
);

4783 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

4785 
»t
 = 
	`ext4_b»ak_Ïyouts
(
šode
);

4786 ià(
»t
) {

4787 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

4788 
out_mu‹x
;

4791 
»t
 = 
	`ext4_upd©e_disksize_befÜe_punch
(
šode
, 
off£t
, 
Ën
);

4792 ià(
»t
) {

4793 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

4794 
out_mu‹x
;

4797 
	`Œunÿ‹_·geÿche_¿nge
(
šode
, 
¡¬t
, 
’d
 - 1);

4798 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

4800 
»t
 = 
	`ext4_®loc_fe_blocks
(
fe
, 
lblk
, 
max_blocks
, 
Ãw_size
,

4801 
æags
);

4802 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

4803 ià(
»t
)

4804 
out_mu‹x
;

4806 ià(!
·¹Ÿl_begš
 && !
·¹Ÿl_’d
)

4807 
out_mu‹x
;

4813 
üed™s
 = (2 * 
	`ext4_ext_šdex_Œªs_blocks
(
šode
, 2)) + 1;

4814 ià(
	`ext4_should_jouº®_d©a
(
šode
))

4815 
üed™s
 += 2;

4816 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MISC
, 
üed™s
);

4817 ià(
	`IS_ERR
(
hªdË
)) {

4818 
»t
 = 
	`PTR_ERR
(
hªdË
);

4819 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
»t
);

4820 
out_mu‹x
;

4823 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

4824 ià(
Ãw_size
) {

4825 
	`ext4_upd©e_šode_size
(
šode
, 
Ãw_size
);

4831 ià((
off£t
 + 
Ën
è> 
	`i_size_»ad
(
šode
))

4832 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_EOFBLOCKS
);

4834 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

4837 
»t
 = 
	`ext4_z”o_·¹Ÿl_blocks
(
hªdË
, 
šode
, 
off£t
, 
Ën
);

4838 ià(
»t
 >= 0)

4839 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

4841 ià(
fe
->
f_æags
 & 
O_SYNC
)

4842 
	`ext4_hªdË_sync
(
hªdË
);

4844 
	`ext4_jouº®_¡İ
(
hªdË
);

4845 
out_mu‹x
:

4846 
	`šode_uÆock
(
šode
);

4847  
»t
;

4848 
	}
}

4857 
	$ext4_çÎoÿ‹
(
fe
 *fe, 
mode
, 
loff_t
 
off£t
,†off_ˆ
Ën
)

4859 
šode
 *šodğ
	`fe_šode
(
fe
);

4860 
loff_t
 
Ãw_size
 = 0;

4861 
max_blocks
;

4862 
»t
 = 0;

4863 
æags
;

4864 
ext4_lblk_t
 
lblk
;

4865 
blkb™s
 = 
šode
->
i_blkb™s
;

4877 ià(
	`IS_ENCRYPTED
(
šode
) &&

4878 (
mode
 & (
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_INSERT_RANGE
 |

4879 
FALLOC_FL_ZERO_RANGE
)))

4880  -
EOPNOTSUPP
;

4883 ià(
mode
 & ~(
FALLOC_FL_KEEP_SIZE
 | 
FALLOC_FL_PUNCH_HOLE
 |

4884 
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_ZERO_RANGE
 |

4885 
FALLOC_FL_INSERT_RANGE
))

4886  -
EOPNOTSUPP
;

4888 ià(
mode
 & 
FALLOC_FL_PUNCH_HOLE
)

4889  
	`ext4_punch_hŞe
(
šode
, 
off£t
, 
Ën
);

4891 
»t
 = 
	`ext4_cÚv”t_šlše_d©a
(
šode
);

4892 ià(
»t
)

4893  
»t
;

4895 ià(
mode
 & 
FALLOC_FL_COLLAPSE_RANGE
)

4896  
	`ext4_cŞÏp£_¿nge
(
šode
, 
off£t
, 
Ën
);

4898 ià(
mode
 & 
FALLOC_FL_INSERT_RANGE
)

4899  
	`ext4_š£¹_¿nge
(
šode
, 
off£t
, 
Ën
);

4901 ià(
mode
 & 
FALLOC_FL_ZERO_RANGE
)

4902  
	`ext4_z”o_¿nge
(
fe
, 
off£t
, 
Ën
, 
mode
);

4904 
	`Œaû_ext4_çÎoÿ‹_’‹r
(
šode
, 
off£t
, 
Ën
, 
mode
);

4905 
lblk
 = 
off£t
 >> 
blkb™s
;

4907 
max_blocks
 = 
	`EXT4_MAX_BLOCKS
(
Ën
, 
off£t
, 
blkb™s
);

4908 
æags
 = 
EXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
;

4909 ià(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

4910 
æags
 |ğ
EXT4_GET_BLOCKS_KEEP_SIZE
;

4912 
	`šode_lock
(
šode
);

4917 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))) {

4918 
»t
 = -
EOPNOTSUPP
;

4919 
out
;

4922 ià(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

4923 (
off£t
 + 
Ën
 > 
	`i_size_»ad
(
šode
) ||

4924 
off£t
 + 
Ën
 > 
	`EXT4_I
(
šode
)->
i_disksize
)) {

4925 
Ãw_size
 = 
off£t
 + 
Ën
;

4926 
»t
 = 
	`šode_Ãwsize_ok
(
šode
, 
Ãw_size
);

4927 ià(
»t
)

4928 
out
;

4932 
	`šode_dio_wa™
(
šode
);

4934 
»t
 = 
	`ext4_®loc_fe_blocks
(
fe
, 
lblk
, 
max_blocks
, 
Ãw_size
, 
æags
);

4935 ià(
»t
)

4936 
out
;

4938 ià(
fe
->
f_æags
 & 
O_SYNC
 && 
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
) {

4939 
»t
 = 
	`jbd2_com¶‘e_Œª§ùiÚ
(
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
,

4940 
	`EXT4_I
(
šode
)->
i_sync_tid
);

4942 
out
:

4943 
	`šode_uÆock
(
šode
);

4944 
	`Œaû_ext4_çÎoÿ‹_ex™
(
šode
, 
off£t
, 
max_blocks
, 
»t
);

4945  
»t
;

4946 
	}
}

4958 
	$ext4_cÚv”t_unwr™‹n_ex‹Ás
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

4959 
loff_t
 
off£t
, 
ssize_t
 
Ën
)

4961 
max_blocks
;

4962 
»t
 = 0;

4963 
»t2
 = 0;

4964 
ext4_m­_blocks
 
m­
;

4965 
üed™s
, 
blkb™s
 = 
šode
->
i_blkb™s
;

4967 
m­
.
m_lblk
 = 
off£t
 >> 
blkb™s
;

4968 
max_blocks
 = 
	`EXT4_MAX_BLOCKS
(
Ën
, 
off£t
, 
blkb™s
);

4975 ià(
hªdË
) {

4976 
hªdË
 = 
	`ext4_jouº®_¡¬t_»£rved
(handle,

4977 
EXT4_HT_EXT_CONVERT
);

4978 ià(
	`IS_ERR
(
hªdË
))

4979  
	`PTR_ERR
(
hªdË
);

4980 
üed™s
 = 0;

4985 
üed™s
 = 
	`ext4_chunk_Œªs_blocks
(
šode
, 
max_blocks
);

4987 
»t
 >ğ0 &&„‘ < 
max_blocks
) {

4988 
m­
.
m_lblk
 +ğ
»t
;

4989 
m­
.
m_Ën
 = (
max_blocks
 -ğ
»t
);

4990 ià(
üed™s
) {

4991 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MAP_BLOCKS
,

4992 
üed™s
);

4993 ià(
	`IS_ERR
(
hªdË
)) {

4994 
»t
 = 
	`PTR_ERR
(
hªdË
);

4998 
»t
 = 
	`ext4_m­_blocks
(
hªdË
, 
šode
, &
m­
,

4999 
EXT4_GET_BLOCKS_IO_CONVERT_EXT
);

5000 ià(
»t
 <= 0)

5001 
	`ext4_w¬nšg
(
šode
->
i_sb
,

5004 
šode
->
i_šo
, 
m­
.
m_lblk
,

5005 
m­
.
m_Ën
, 
»t
);

5006 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

5007 ià(
üed™s
)

5008 
»t2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

5009 ià(
»t
 <ğ0 || 
»t2
)

5012 ià(!
üed™s
)

5013 
»t2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

5014  
»t
 > 0 ? 
»t2
 :„et;

5015 
	}
}

5026 
	$ext4_fšd_d–ayed_ex‹Á
(
šode
 *inode,

5027 
ex‹Á_¡©us
 *
Ãwes
)

5029 
ex‹Á_¡©us
 
es
;

5030 
ext4_lblk_t
 
block
, 
Ãxt_d–
;

5032 ià(
Ãwes
->
es_pblk
 == 0) {

5033 
	`ext4_es_fšd_ex‹Á_¿nge
(
šode
, &
ext4_es_is_d–ayed
,

5034 
Ãwes
->
es_lblk
,

5035 
Ãwes
->
es_lblk
 +‚ewes->
es_Ën
 - 1,

5036 &
es
);

5042 ià(
es
.
es_Ën
 == 0)

5046 ià(
es
.
es_lblk
 > 
Ãwes
->es_lblk) {

5048 
Ãwes
->
es_Ën
 = 
	`mš
(
es
.
es_lblk
 -‚ewes->es_lblk,

5049 
Ãwes
->
es_Ën
);

5053 
Ãwes
->
es_Ën
 = 
es
.
es_lblk
 +ƒs.es_len -‚ewes->es_lblk;

5056 
block
 = 
Ãwes
->
es_lblk
 +‚ewes->
es_Ën
;

5057 
	`ext4_es_fšd_ex‹Á_¿nge
(
šode
, &
ext4_es_is_d–ayed
, 
block
,

5058 
EXT_MAX_BLOCKS
, &
es
);

5059 ià(
es
.
es_Ën
 == 0)

5060 
Ãxt_d–
 = 
EXT_MAX_BLOCKS
;

5062 
Ãxt_d–
 = 
es
.
es_lblk
;

5064  
Ãxt_d–
;

5065 
	}
}

5067 
	$ext4_x©Œ_f›m­
(
šode
 *inode,

5068 
f›m­_ex‹Á_šfo
 *
f›šfo
)

5070 
__u64
 
physiÿl
 = 0;

5071 
__u64
 
Ëngth
;

5072 
__u32
 
æags
 = 
FIEMAP_EXTENT_LAST
;

5073 
blockb™s
 = 
šode
->
i_sb
->
s_blocksize_b™s
;

5074 
”rÜ
 = 0;

5077 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
)) {

5078 
ext4_oc
 
oc
;

5079 
off£t
;

5081 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

5082 ià(
”rÜ
)

5083  
”rÜ
;

5084 
physiÿl
 = (
__u64
)
oc
.
bh
->
b_blockÄ
 << 
blockb™s
;

5085 
off£t
 = 
EXT4_GOOD_OLD_INODE_SIZE
 +

5086 
	`EXT4_I
(
šode
)->
i_exŒa_isize
;

5087 
physiÿl
 +ğ
off£t
;

5088 
Ëngth
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
 - 
off£t
;

5089 
æags
 |ğ
FIEMAP_EXTENT_DATA_INLINE
;

5090 
	`b»l£
(
oc
.
bh
);

5092 
physiÿl
 = (
__u64
)
	`EXT4_I
(
šode
)->
i_fe_aş
 << 
blockb™s
;

5093 
Ëngth
 = 
šode
->
i_sb
->
s_blocksize
;

5096 ià(
physiÿl
)

5097 
”rÜ
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
, 0, 
physiÿl
,

5098 
Ëngth
, 
æags
);

5099  (
”rÜ
 < 0 ?ƒrror : 0);

5100 
	}
}

5102 
	$_ext4_f›m­
(
šode
 *inode,

5103 
f›m­_ex‹Á_šfo
 *
f›šfo
,

5104 
__u64
 
¡¬t
, __u64 
Ën
,

5105 (*
fl
)(
šode
 *, 
ext4_lblk_t
,

5106 
ext4_lblk_t
,

5107 
f›m­_ex‹Á_šfo
 *))

5109 
ext4_lblk_t
 
¡¬t_blk
;

5110 
u32
 
ext4_f›m­_æags
 = 
FIEMAP_FLAG_SYNC
|
FIEMAP_FLAG_XATTR
;

5112 
”rÜ
 = 0;

5114 ià(
	`ext4_has_šlše_d©a
(
šode
)) {

5115 
has_šlše
 = 1;

5117 
”rÜ
 = 
	`ext4_šlše_d©a_f›m­
(
šode
, 
f›šfo
, &
has_šlše
,

5118 
¡¬t
, 
Ën
);

5120 ià(
has_šlše
)

5121  
”rÜ
;

5124 ià(
f›šfo
->
fi_æags
 & 
FIEMAP_FLAG_CACHE
) {

5125 
”rÜ
 = 
	`ext4_ext_´eÿche
(
šode
);

5126 ià(
”rÜ
)

5127  
”rÜ
;

5128 
f›šfo
->
fi_æags
 &ğ~
FIEMAP_FLAG_CACHE
;

5132 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)) &&

5133 
fl
 =ğ
ext4_fl_f›m­_ex‹Ás
)

5134  
	`g’”ic_block_f›m­
(
šode
, 
f›šfo
, 
¡¬t
, 
Ën
,

5135 
ext4_g‘_block
);

5137 ià(
fl
 =ğ
ext4_fl_es_ÿche_šfo
)

5138 
ext4_f›m­_æags
 &ğ
FIEMAP_FLAG_XATTR
;

5139 ià(
	`f›m­_check_æags
(
f›šfo
, 
ext4_f›m­_æags
))

5140  -
EBADR
;

5142 ià(
f›šfo
->
fi_æags
 & 
FIEMAP_FLAG_XATTR
) {

5143 
”rÜ
 = 
	`ext4_x©Œ_f›m­
(
šode
, 
f›šfo
);

5145 
ext4_lblk_t
 
Ën_blks
;

5146 
__u64
 
Ï¡_blk
;

5148 
¡¬t_blk
 = 
¡¬t
 >> 
šode
->
i_sb
->
s_blocksize_b™s
;

5149 
Ï¡_blk
 = (
¡¬t
 + 
Ën
 - 1è>> 
šode
->
i_sb
->
s_blocksize_b™s
;

5150 ià(
Ï¡_blk
 >ğ
EXT_MAX_BLOCKS
)

5151 
Ï¡_blk
 = 
EXT_MAX_BLOCKS
-1;

5152 
Ën_blks
 = ((
ext4_lblk_t
è
Ï¡_blk
è- 
¡¬t_blk
 + 1;

5158 
”rÜ
 = 
	`fl
(
šode
, 
¡¬t_blk
, 
Ën_blks
, 
f›šfo
);

5160  
”rÜ
;

5161 
	}
}

5163 
	$ext4_f›m­
(
šode
 *šode, 
f›m­_ex‹Á_šfo
 *
f›šfo
,

5164 
__u64
 
¡¬t
, __u64 
Ën
)

5166  
	`_ext4_f›m­
(
šode
, 
f›šfo
, 
¡¬t
, 
Ën
,

5167 
ext4_fl_f›m­_ex‹Ás
);

5168 
	}
}

5170 
	$ext4_g‘_es_ÿche
(
šode
 *šode, 
f›m­_ex‹Á_šfo
 *
f›šfo
,

5171 
__u64
 
¡¬t
, __u64 
Ën
)

5173 ià(
	`ext4_has_šlše_d©a
(
šode
)) {

5174 
has_šlše
;

5176 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

5177 
has_šlše
 = 
	`ext4_has_šlše_d©a
(
šode
);

5178 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

5179 ià(
has_šlše
)

5183  
	`_ext4_f›m­
(
šode
, 
f›šfo
, 
¡¬t
, 
Ën
,

5184 
ext4_fl_es_ÿche_šfo
);

5185 
	}
}

5195 
	$ext4_acûss_·th
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

5196 
ext4_ext_·th
 *
·th
)

5198 
üed™s
, 
”r
;

5200 ià(!
	`ext4_hªdË_v®id
(
hªdË
))

5209 ià(
hªdË
->
h_bufãr_üed™s
 < 7) {

5210 
üed™s
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

5211 
”r
 = 
	`ext4_ext_Œunÿ‹_ex‹nd_»¡¬t
(
hªdË
, 
šode
, 
üed™s
);

5213 ià(
”r
 &&ƒ¼ !ğ-
EAGAIN
)

5214  
”r
;

5217 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
);

5218  
”r
;

5219 
	}
}

5228 
	$ext4_ext_shiá_·th_ex‹Ás
(
ext4_ext_·th
 *
·th
, 
ext4_lblk_t
 
shiá
,

5229 
šode
 *šode, 
hªdË_t
 *
hªdË
,

5230 
SHIFT_DIRECTION
 
SHIFT
)

5232 
d•th
, 
”r
 = 0;

5233 
ext4_ex‹Á
 *
ex_¡¬t
, *
ex_Ï¡
;

5234 
boŞ
 
upd©e
 = 0;

5235 
d•th
 = 
·th
->
p_d•th
;

5237 
d•th
 >= 0) {

5238 ià(
d•th
 =ğ
·th
->
p_d•th
) {

5239 
ex_¡¬t
 = 
·th
[
d•th
].
p_ext
;

5240 ià(!
ex_¡¬t
)

5241  -
EFSCORRUPTED
;

5243 
ex_Ï¡
 = 
	`EXT_LAST_EXTENT
(
·th
[
d•th
].
p_hdr
);

5245 
”r
 = 
	`ext4_acûss_·th
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

5246 ià(
”r
)

5247 
out
;

5249 ià(
ex_¡¬t
 =ğ
	`EXT_FIRST_EXTENT
(
·th
[
d•th
].
p_hdr
))

5250 
upd©e
 = 1;

5252 
ex_¡¬t
 <ğ
ex_Ï¡
) {

5253 ià(
SHIFT
 =ğ
SHIFT_LEFT
) {

5254 
	`Ë32_add_ıu
(&
ex_¡¬t
->
“_block
,

5255 -
shiá
);

5257 ià((
ex_¡¬t
 >

5258 
	`EXT_FIRST_EXTENT
(
·th
[
d•th
].
p_hdr
))

5260 
	`ext4_ext_Œy_to_m”ge_right
(
šode
,

5261 
·th
, 
ex_¡¬t
 - 1))

5262 
ex_Ï¡
--;

5264 
ex_¡¬t
++;

5266 
	`Ë32_add_ıu
(&
ex_Ï¡
->
“_block
, 
shiá
);

5267 
	`ext4_ext_Œy_to_m”ge_right
(
šode
, 
·th
,

5268 
ex_Ï¡
);

5269 
ex_Ï¡
--;

5272 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

5273 ià(
”r
)

5274 
out
;

5276 ià(--
d•th
 < 0 || !
upd©e
)

5281 
”r
 = 
	`ext4_acûss_·th
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

5282 ià(
”r
)

5283 
out
;

5285 ià(
SHIFT
 =ğ
SHIFT_LEFT
)

5286 
	`Ë32_add_ıu
(&
·th
[
d•th
].
p_idx
->
ei_block
, -
shiá
);

5288 
	`Ë32_add_ıu
(&
·th
[
d•th
].
p_idx
->
ei_block
, 
shiá
);

5289 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

5290 ià(
”r
)

5291 
out
;

5294 ià(
·th
[
d•th
].
p_idx
 !ğ
	`EXT_FIRST_INDEX
Õ©h[d•th].
p_hdr
))

5297 
d•th
--;

5300 
out
:

5301  
”r
;

5302 
	}
}

5312 
	$ext4_ext_shiá_ex‹Ás
(
šode
 *šode, 
hªdË_t
 *
hªdË
,

5313 
ext4_lblk_t
 
¡¬t
,ƒxt4_lblk_ˆ
shiá
,

5314 
SHIFT_DIRECTION
 
SHIFT
)

5316 
ext4_ext_·th
 *
·th
;

5317 
»t
 = 0, 
d•th
;

5318 
ext4_ex‹Á
 *
ex‹Á
;

5319 
ext4_lblk_t
 
¡İ
, *
™”©Ü
, 
ex_¡¬t
, 
ex_’d
;

5322 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
EXT_MAX_BLOCKS
 - 1, 
NULL
,

5323 
EXT4_EX_NOCACHE
);

5324 ià(
	`IS_ERR
(
·th
))

5325  
	`PTR_ERR
(
·th
);

5327 
d•th
 = 
·th
->
p_d•th
;

5328 
ex‹Á
 = 
·th
[
d•th
].
p_ext
;

5329 ià(!
ex‹Á
)

5330 
out
;

5332 
¡İ
 = 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
);

5339 ià(
SHIFT
 =ğ
SHIFT_LEFT
) {

5340 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
¡¬t
 - 1, &path,

5341 
EXT4_EX_NOCACHE
);

5342 ià(
	`IS_ERR
(
·th
))

5343  
	`PTR_ERR
(
·th
);

5344 
d•th
 = 
·th
->
p_d•th
;

5345 
ex‹Á
 = 
·th
[
d•th
].
p_ext
;

5346 ià(
ex‹Á
) {

5347 
ex_¡¬t
 = 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
);

5348 
ex_’d
 = 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
) +

5349 
	`ext4_ext_g‘_aùu®_Ën
(
ex‹Á
);

5351 
ex_¡¬t
 = 0;

5352 
ex_’d
 = 0;

5355 ià((
¡¬t
 =ğ
ex_¡¬t
 && 
shiá
 >ƒx_start) ||

5356 (
shiá
 > 
¡¬t
 - 
ex_’d
)) {

5357 
»t
 = -
EINVAL
;

5358 
out
;

5361 ià(
shiá
 > 
EXT_MAX_BLOCKS
 -

5362 (
¡İ
 + 
	`ext4_ext_g‘_aùu®_Ën
(
ex‹Á
))) {

5363 
»t
 = -
EINVAL
;

5364 
out
;

5373 ià(
SHIFT
 =ğ
SHIFT_LEFT
)

5374 
™”©Ü
 = &
¡¬t
;

5376 
™”©Ü
 = &
¡İ
;

5383 
™”©Ü
 && 
¡¬t
 <ğ
¡İ
) {

5384 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, *
™”©Ü
, &path,

5385 
EXT4_EX_NOCACHE
);

5386 ià(
	`IS_ERR
(
·th
))

5387  
	`PTR_ERR
(
·th
);

5388 
d•th
 = 
·th
->
p_d•th
;

5389 
ex‹Á
 = 
·th
[
d•th
].
p_ext
;

5390 ià(!
ex‹Á
) {

5391 
	`EXT4_ERROR_INODE
(
šode
, "unexpected hole‡t %lu",

5392 (è*
™”©Ü
);

5393  -
EFSCORRUPTED
;

5395 ià(
SHIFT
 =ğ
SHIFT_LEFT
 && *
™”©Ü
 >

5396 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
)) {

5398 ià(
ex‹Á
 < 
	`EXT_LAST_EXTENT
(
·th
[
d•th
].
p_hdr
)) {

5399 
·th
[
d•th
].
p_ext
++;

5401 *
™”©Ü
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th
);

5406 ià(
SHIFT
 =ğ
SHIFT_LEFT
) {

5407 
ex‹Á
 = 
	`EXT_LAST_EXTENT
(
·th
[
d•th
].
p_hdr
);

5408 *
™”©Ü
 = 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
) +

5409 
	`ext4_ext_g‘_aùu®_Ën
(
ex‹Á
);

5411 
ex‹Á
 = 
	`EXT_FIRST_EXTENT
(
·th
[
d•th
].
p_hdr
);

5412 ià(
	`Ë32_to_ıu
(
ex‹Á
->
“_block
) > 0)

5413 *
™”©Ü
 = 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
) - 1;

5416 
™”©Ü
 = 
NULL
;

5418 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
è< 
¡¬t
)

5419 
ex‹Á
++;

5420 
·th
[
d•th
].
p_ext
 = 
ex‹Á
;

5422 
»t
 = 
	`ext4_ext_shiá_·th_ex‹Ás
(
·th
, 
shiá
, 
šode
,

5423 
hªdË
, 
SHIFT
);

5424 ià(
»t
)

5427 
out
:

5428 
	`ext4_ext_drİ_»fs
(
·th
);

5429 
	`kä“
(
·th
);

5430  
»t
;

5431 
	}
}

5438 
	$ext4_cŞÏp£_¿nge
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
)

5440 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

5441 
ext4_lblk_t
 
punch_¡¬t
, 
punch_¡İ
;

5442 
hªdË_t
 *
hªdË
;

5443 
üed™s
;

5444 
loff_t
 
Ãw_size
, 
ioff£t
;

5445 
»t
;

5452 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

5453  -
EOPNOTSUPP
;

5456 ià(
off£t
 & (
	`EXT4_CLUSTER_SIZE
(
sb
) - 1) ||

5457 
Ën
 & (
	`EXT4_CLUSTER_SIZE
(
sb
) - 1))

5458  -
EINVAL
;

5460 ià(!
	`S_ISREG
(
šode
->
i_mode
))

5461  -
EINVAL
;

5463 
	`Œaû_ext4_cŞÏp£_¿nge
(
šode
, 
off£t
, 
Ën
);

5465 
punch_¡¬t
 = 
off£t
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

5466 
punch_¡İ
 = (
off£t
 + 
Ën
è>> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

5469 ià(
	`ext4_should_jouº®_d©a
(
šode
)) {

5470 
»t
 = 
	`ext4_fÜû_comm™
(
šode
->
i_sb
);

5471 ià(
»t
)

5472  
»t
;

5475 
	`šode_lock
(
šode
);

5480 ià(
off£t
 + 
Ën
 >ğ
	`i_size_»ad
(
šode
)) {

5481 
»t
 = -
EINVAL
;

5482 
out_mu‹x
;

5486 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)) {

5487 
»t
 = -
EOPNOTSUPP
;

5488 
out_mu‹x
;

5492 
	`šode_dio_wa™
(
šode
);

5498 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

5500 
»t
 = 
	`ext4_b»ak_Ïyouts
(
šode
);

5501 ià(
»t
)

5502 
out_mm­
;

5508 
ioff£t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

5513 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
ioff£t
, 
off£t
);

5514 ià(
»t
)

5515 
out_mm­
;

5521 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
off£t
 + 
Ën
,

5522 
LLONG_MAX
);

5523 ià(
»t
)

5524 
out_mm­
;

5525 
	`Œunÿ‹_·geÿche
(
šode
, 
ioff£t
);

5527 
üed™s
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

5528 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_TRUNCATE
, 
üed™s
);

5529 ià(
	`IS_ERR
(
hªdË
)) {

5530 
»t
 = 
	`PTR_ERR
(
hªdË
);

5531 
out_mm­
;

5534 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

5535 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

5537 
»t
 = 
	`ext4_es_»move_ex‹Á
(
šode
, 
punch_¡¬t
,

5538 
EXT_MAX_BLOCKS
 - 
punch_¡¬t
);

5539 ià(
»t
) {

5540 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

5541 
out_¡İ
;

5544 
»t
 = 
	`ext4_ext_»move_¥aû
(
šode
, 
punch_¡¬t
, 
punch_¡İ
 - 1);

5545 ià(
»t
) {

5546 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

5547 
out_¡İ
;

5549 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

5551 
»t
 = 
	`ext4_ext_shiá_ex‹Ás
(
šode
, 
hªdË
, 
punch_¡İ
,

5552 
punch_¡İ
 - 
punch_¡¬t
, 
SHIFT_LEFT
);

5553 ià(
»t
) {

5554 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

5555 
out_¡İ
;

5558 
Ãw_size
 = 
	`i_size_»ad
(
šode
è- 
Ën
;

5559 
	`i_size_wr™e
(
šode
, 
Ãw_size
);

5560 
	`EXT4_I
(
šode
)->
i_disksize
 = 
Ãw_size
;

5562 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

5563 ià(
	`IS_SYNC
(
šode
))

5564 
	`ext4_hªdË_sync
(
hªdË
);

5565 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

5566 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

5567 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

5569 
out_¡İ
:

5570 
	`ext4_jouº®_¡İ
(
hªdË
);

5571 
out_mm­
:

5572 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

5573 
out_mu‹x
:

5574 
	`šode_uÆock
(
šode
);

5575  
»t
;

5576 
	}
}

5586 
	$ext4_š£¹_¿nge
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
)

5588 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

5589 
hªdË_t
 *
hªdË
;

5590 
ext4_ext_·th
 *
·th
;

5591 
ext4_ex‹Á
 *
ex‹Á
;

5592 
ext4_lblk_t
 
off£t_lblk
, 
Ën_lblk
, 
“_¡¬t_lblk
 = 0;

5593 
üed™s
, 
“_Ën
;

5594 
»t
 = 0, 
d•th
, 
¥l™_æag
 = 0;

5595 
loff_t
 
ioff£t
;

5602 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

5603  -
EOPNOTSUPP
;

5606 ià(
off£t
 & (
	`EXT4_CLUSTER_SIZE
(
sb
) - 1) ||

5607 
Ën
 & (
	`EXT4_CLUSTER_SIZE
(
sb
) - 1))

5608  -
EINVAL
;

5610 ià(!
	`S_ISREG
(
šode
->
i_mode
))

5611  -
EOPNOTSUPP
;

5613 
	`Œaû_ext4_š£¹_¿nge
(
šode
, 
off£t
, 
Ën
);

5615 
off£t_lblk
 = 
off£t
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

5616 
Ën_lblk
 = 
Ën
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

5619 ià(
	`ext4_should_jouº®_d©a
(
šode
)) {

5620 
»t
 = 
	`ext4_fÜû_comm™
(
šode
->
i_sb
);

5621 ià(
»t
)

5622  
»t
;

5625 
	`šode_lock
(
šode
);

5627 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)) {

5628 
»t
 = -
EOPNOTSUPP
;

5629 
out_mu‹x
;

5633 ià(
šode
->
i_size
 + 
Ën
 > inode->
i_sb
->
s_maxby‹s
) {

5634 
»t
 = -
EFBIG
;

5635 
out_mu‹x
;

5639 ià(
off£t
 >ğ
	`i_size_»ad
(
šode
)) {

5640 
»t
 = -
EINVAL
;

5641 
out_mu‹x
;

5645 
	`šode_dio_wa™
(
šode
);

5651 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

5653 
»t
 = 
	`ext4_b»ak_Ïyouts
(
šode
);

5654 ià(
»t
)

5655 
out_mm­
;

5661 
ioff£t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

5663 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
ioff£t
,

5664 
LLONG_MAX
);

5665 ià(
»t
)

5666 
out_mm­
;

5667 
	`Œunÿ‹_·geÿche
(
šode
, 
ioff£t
);

5669 
üed™s
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

5670 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_TRUNCATE
, 
üed™s
);

5671 ià(
	`IS_ERR
(
hªdË
)) {

5672 
»t
 = 
	`PTR_ERR
(
hªdË
);

5673 
out_mm­
;

5677 
šode
->
i_size
 +ğ
Ën
;

5678 
	`EXT4_I
(
šode
)->
i_disksize
 +ğ
Ën
;

5679 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

5680 
»t
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

5681 ià(
»t
)

5682 
out_¡İ
;

5684 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

5685 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

5687 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
off£t_lblk
, 
NULL
, 0);

5688 ià(
	`IS_ERR
(
·th
)) {

5689 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

5690 
out_¡İ
;

5693 
d•th
 = 
	`ext_d•th
(
šode
);

5694 
ex‹Á
 = 
·th
[
d•th
].
p_ext
;

5695 ià(
ex‹Á
) {

5696 
“_¡¬t_lblk
 = 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
);

5697 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex‹Á
);

5703 ià((
off£t_lblk
 > 
“_¡¬t_lblk
) &&

5704 (
off£t_lblk
 < (
“_¡¬t_lblk
 + 
“_Ën
))) {

5705 ià(
	`ext4_ext_is_unwr™‹n
(
ex‹Á
))

5706 
¥l™_æag
 = 
EXT4_EXT_MARK_UNWRIT1
 |

5707 
EXT4_EXT_MARK_UNWRIT2
;

5708 
»t
 = 
	`ext4_¥l™_ex‹Á_©
(
hªdË
, 
šode
, &
·th
,

5709 
off£t_lblk
, 
¥l™_æag
,

5710 
EXT4_EX_NOCACHE
 |

5711 
EXT4_GET_BLOCKS_PRE_IO
 |

5712 
EXT4_GET_BLOCKS_METADATA_NOFAIL
);

5715 
	`ext4_ext_drİ_»fs
(
·th
);

5716 
	`kä“
(
·th
);

5717 ià(
»t
 < 0) {

5718 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

5719 
out_¡İ
;

5722 
	`ext4_ext_drİ_»fs
(
·th
);

5723 
	`kä“
(
·th
);

5726 
»t
 = 
	`ext4_es_»move_ex‹Á
(
šode
, 
off£t_lblk
,

5727 
EXT_MAX_BLOCKS
 - 
off£t_lblk
);

5728 ià(
»t
) {

5729 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

5730 
out_¡İ
;

5737 
»t
 = 
	`ext4_ext_shiá_ex‹Ás
(
šode
, 
hªdË
,

5738 
“_¡¬t_lblk
 > 
off£t_lblk
 ?ƒe_start_lblk : offset_lblk,

5739 
Ën_lblk
, 
SHIFT_RIGHT
);

5741 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

5742 ià(
	`IS_SYNC
(
šode
))

5743 
	`ext4_hªdË_sync
(
hªdË
);

5744 ià(
»t
 >= 0)

5745 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

5747 
out_¡İ
:

5748 
	`ext4_jouº®_¡İ
(
hªdË
);

5749 
out_mm­
:

5750 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

5751 
out_mu‹x
:

5752 
	`šode_uÆock
(
šode
);

5753  
»t
;

5754 
	}
}

5777 
	$ext4_sw­_ex‹Ás
(
hªdË_t
 *
hªdË
, 
šode
 *
šode1
,

5778 
šode
 *
šode2
, 
ext4_lblk_t
 
lblk1
,ƒxt4_lblk_ˆ
lblk2
,

5779 
ext4_lblk_t
 
couÁ
, 
unwr™‹n
, *
”p
)

5781 
ext4_ext_·th
 *
·th1
 = 
NULL
;

5782 
ext4_ext_·th
 *
·th2
 = 
NULL
;

5783 
»¶aûd_couÁ
 = 0;

5785 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`EXT4_I
(
šode1
)->
i_d©a_£m
));

5786 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`EXT4_I
(
šode2
)->
i_d©a_£m
));

5787 
	`BUG_ON
(!
	`šode_is_locked
(
šode1
));

5788 
	`BUG_ON
(!
	`šode_is_locked
(
šode2
));

5790 *
”p
 = 
	`ext4_es_»move_ex‹Á
(
šode1
, 
lblk1
, 
couÁ
);

5791 ià(
	`uÆik–y
(*
”p
))

5793 *
”p
 = 
	`ext4_es_»move_ex‹Á
(
šode2
, 
lblk2
, 
couÁ
);

5794 ià(
	`uÆik–y
(*
”p
))

5797 
couÁ
) {

5798 
ext4_ex‹Á
 *
ex1
, *
ex2
, 
tmp_ex
;

5799 
ext4_lblk_t
 
e1_blk
, 
e2_blk
;

5800 
e1_Ën
, 
e2_Ën
, 
Ën
;

5801 
¥l™
 = 0;

5803 
·th1
 = 
	`ext4_fšd_ex‹Á
(
šode1
, 
lblk1
, 
NULL
, 
EXT4_EX_NOCACHE
);

5804 ià(
	`IS_ERR
(
·th1
)) {

5805 *
”p
 = 
	`PTR_ERR
(
·th1
);

5806 
·th1
 = 
NULL
;

5807 
fšish
:

5808 
couÁ
 = 0;

5809 
»³©
;

5811 
·th2
 = 
	`ext4_fšd_ex‹Á
(
šode2
, 
lblk2
, 
NULL
, 
EXT4_EX_NOCACHE
);

5812 ià(
	`IS_ERR
(
·th2
)) {

5813 *
”p
 = 
	`PTR_ERR
(
·th2
);

5814 
·th2
 = 
NULL
;

5815 
fšish
;

5817 
ex1
 = 
·th1
[·th1->
p_d•th
].
p_ext
;

5818 
ex2
 = 
·th2
[·th2->
p_d•th
].
p_ext
;

5820 ià(
	`uÆik–y
(!
ex2
 || !
ex1
))

5821 
fšish
;

5823 
e1_blk
 = 
	`Ë32_to_ıu
(
ex1
->
“_block
);

5824 
e2_blk
 = 
	`Ë32_to_ıu
(
ex2
->
“_block
);

5825 
e1_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex1
);

5826 
e2_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex2
);

5829 ià(!
	`š_¿nge
(
lblk1
, 
e1_blk
, 
e1_Ën
) ||

5830 !
	`š_¿nge
(
lblk2
, 
e2_blk
, 
e2_Ën
)) {

5831 
ext4_lblk_t
 
Ãxt1
, 
Ãxt2
;

5834 
Ãxt1
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th1
);

5835 
Ãxt2
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th2
);

5837 ià(
e1_blk
 > 
lblk1
)

5838 
Ãxt1
 = 
e1_blk
;

5839 ià(
e2_blk
 > 
lblk2
)

5840 
Ãxt2
 = 
e2_blk
;

5842 ià(
Ãxt1
 =ğ
EXT_MAX_BLOCKS
 || 
Ãxt2
 == EXT_MAX_BLOCKS)

5843 
fšish
;

5845 
Ën
 = 
Ãxt1
 - 
lblk1
;

5846 ià(
Ën
 < 
Ãxt2
 - 
lblk2
)

5847 
Ën
 = 
Ãxt2
 - 
lblk2
;

5848 ià(
Ën
 > 
couÁ
)

5849 
Ën
 = 
couÁ
;

5850 
lblk1
 +ğ
Ën
;

5851 
lblk2
 +ğ
Ën
;

5852 
couÁ
 -ğ
Ën
;

5853 
»³©
;

5857 ià(
e1_blk
 < 
lblk1
) {

5858 
¥l™
 = 1;

5859 *
”p
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
šode1
,

5860 &
·th1
, 
lblk1
, 0);

5861 ià(
	`uÆik–y
(*
”p
))

5862 
fšish
;

5864 ià(
e2_blk
 < 
lblk2
) {

5865 
¥l™
 = 1;

5866 *
”p
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
šode2
,

5867 &
·th2
, 
lblk2
, 0);

5868 ià(
	`uÆik–y
(*
”p
))

5869 
fšish
;

5873 ià(
¥l™
)

5874 
»³©
;

5877 
Ën
 = 
couÁ
;

5878 ià(
Ën
 > 
e1_blk
 + 
e1_Ën
 - 
lblk1
)

5879 
Ën
 = 
e1_blk
 + 
e1_Ën
 - 
lblk1
;

5880 ià(
Ën
 > 
e2_blk
 + 
e2_Ën
 - 
lblk2
)

5881 
Ën
 = 
e2_blk
 + 
e2_Ën
 - 
lblk2
;

5883 ià(
Ën
 !ğ
e1_Ën
) {

5884 
¥l™
 = 1;

5885 *
”p
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
šode1
,

5886 &
·th1
, 
lblk1
 + 
Ën
, 0);

5887 ià(
	`uÆik–y
(*
”p
))

5888 
fšish
;

5890 ià(
Ën
 !ğ
e2_Ën
) {

5891 
¥l™
 = 1;

5892 *
”p
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
šode2
,

5893 &
·th2
, 
lblk2
 + 
Ën
, 0);

5894 ià(*
”p
)

5895 
fšish
;

5899 ià(
¥l™
)

5900 
»³©
;

5902 
	`BUG_ON
(
e2_Ën
 !ğ
e1_Ën
);

5903 *
”p
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode1
, 
·th1
 +…©h1->
p_d•th
);

5904 ià(
	`uÆik–y
(*
”p
))

5905 
fšish
;

5906 *
”p
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode2
, 
·th2
 +…©h2->
p_d•th
);

5907 ià(
	`uÆik–y
(*
”p
))

5908 
fšish
;

5911 
tmp_ex
 = *
ex1
;

5912 
	`ext4_ext_¡Üe_pblock
(
ex1
, 
	`ext4_ext_pblock
(
ex2
));

5913 
	`ext4_ext_¡Üe_pblock
(
ex2
, 
	`ext4_ext_pblock
(&
tmp_ex
));

5914 
ex1
->
“_Ën
 = 
	`ıu_to_Ë16
(
e2_Ën
);

5915 
ex2
->
“_Ën
 = 
	`ıu_to_Ë16
(
e1_Ën
);

5916 ià(
unwr™‹n
)

5917 
	`ext4_ext_m¬k_unwr™‹n
(
ex2
);

5918 ià(
	`ext4_ext_is_unwr™‹n
(&
tmp_ex
))

5919 
	`ext4_ext_m¬k_unwr™‹n
(
ex1
);

5921 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
šode2
, 
·th2
, 
ex2
);

5922 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
šode1
, 
·th1
, 
ex1
);

5923 *
”p
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode2
, 
·th2
 +

5924 
·th2
->
p_d•th
);

5925 ià(
	`uÆik–y
(*
”p
))

5926 
fšish
;

5927 *
”p
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode1
, 
·th1
 +

5928 
·th1
->
p_d•th
);

5935 ià(
	`uÆik–y
(*
”p
))

5936 
fšish
;

5937 
lblk1
 +ğ
Ën
;

5938 
lblk2
 +ğ
Ën
;

5939 
»¶aûd_couÁ
 +ğ
Ën
;

5940 
couÁ
 -ğ
Ën
;

5942 
»³©
:

5943 
	`ext4_ext_drİ_»fs
(
·th1
);

5944 
	`kä“
(
·th1
);

5945 
	`ext4_ext_drİ_»fs
(
·th2
);

5946 
	`kä“
(
·th2
);

5947 
·th1
 = 
·th2
 = 
NULL
;

5949  
»¶aûd_couÁ
;

5950 
	}
}

5964 
	$ext4_şu_m­³d
(
šode
 *šode, 
ext4_lblk_t
 
lşu
)

5966 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

5967 
ext4_ext_·th
 *
·th
;

5968 
d•th
, 
m­³d
 = 0, 
”r
 = 0;

5969 
ext4_ex‹Á
 *
ex‹Á
;

5970 
ext4_lblk_t
 
fœ¡_lblk
, 
fœ¡_lşu
, 
Ï¡_lşu
;

5973 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
	`EXT4_C2B
(
sbi
, 
lşu
), 
NULL
, 0);

5974 ià(
	`IS_ERR
(
·th
)) {

5975 
”r
 = 
	`PTR_ERR
(
·th
);

5976 
·th
 = 
NULL
;

5977 
out
;

5980 
d•th
 = 
	`ext_d•th
(
šode
);

5987 ià(
	`uÆik–y
(
·th
[
d•th
].
p_ext
 =ğ
NULL
 && depth != 0)) {

5988 
	`EXT4_ERROR_INODE
(
šode
,

5990 (è
	`EXT4_C2B
(
sbi
, 
lşu
),

5991 
d•th
, 
·th
[d•th].
p_block
);

5992 
”r
 = -
EFSCORRUPTED
;

5993 
out
;

5996 
ex‹Á
 = 
·th
[
d•th
].
p_ext
;

5999 ià(
ex‹Á
 =ğ
NULL
)

6000 
out
;

6002 
fœ¡_lblk
 = 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
);

6003 
fœ¡_lşu
 = 
	`EXT4_B2C
(
sbi
, 
fœ¡_lblk
);

6011 ià(
lşu
 >ğ
fœ¡_lşu
) {

6012 
Ï¡_lşu
 = 
	`EXT4_B2C
(
sbi
, 
fœ¡_lblk
 +

6013 
	`ext4_ext_g‘_aùu®_Ën
(
ex‹Á
) - 1);

6014 ià(
lşu
 <ğ
Ï¡_lşu
) {

6015 
m­³d
 = 1;

6017 
fœ¡_lblk
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th
);

6018 
fœ¡_lşu
 = 
	`EXT4_B2C
(
sbi
, 
fœ¡_lblk
);

6019 ià(
lşu
 =ğ
fœ¡_lşu
)

6020 
m­³d
 = 1;

6024 
out
:

6025 
	`ext4_ext_drİ_»fs
(
·th
);

6026 
	`kä“
(
·th
);

6028  
”r
 ?ƒ¼ : 
m­³d
;

6029 
	}
}

	@pxt4/extents_status.c

13 
	~<lšux/li¡_sÜt.h
>

14 
	~<lšux/´oc_fs.h
>

15 
	~<lšux/£q_fe.h
>

16 
	~"ext4.h
"

18 
	~<Œaû/ev’ts/ext4.h
>

144 
kmem_ÿche
 *
	gext4_es_ÿch•
;

145 
kmem_ÿche
 *
	gext4_³ndšg_ÿch•
;

147 
__es_š£¹_ex‹Á
(
šode
 *šode, 
ex‹Á_¡©us
 *
Ãwes
);

148 
__es_»move_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

149 
ext4_lblk_t
 
’d
, *
»£rved
);

150 
es_»şaim_ex‹Ás
(
ext4_šode_šfo
 *
ei
, *
Ä_to_sÿn
);

151 
__es_shršk
(
ext4_sb_šfo
 *
sbi
, 
Ä_to_sÿn
,

152 
ext4_šode_šfo
 *
locked_ei
);

153 
__»vi£_³ndšg
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

154 
ext4_lblk_t
 
Ën
);

156 
__š™
 
	$ext4_š™_es
()

158 
ext4_es_ÿch•
 = 
	`kmem_ÿche_ü—‹
("ext4_extent_status",

159 (
ex‹Á_¡©us
),

160 0, (
SLAB_RECLAIM_ACCOUNT
), 
NULL
);

161 ià(
ext4_es_ÿch•
 =ğ
NULL
)

162  -
ENOMEM
;

164 
	}
}

166 
	$ext4_ex™_es
()

168 
	`kmem_ÿche_de¡roy
(
ext4_es_ÿch•
);

169 
	}
}

171 
	$ext4_es_š™_Œ“
(
ext4_es_Œ“
 *
Œ“
)

173 
Œ“
->
roÙ
 = 
RB_ROOT
;

174 
Œ“
->
ÿche_es
 = 
NULL
;

175 
	}
}

177 #ifdeà
ES_DEBUG__


178 
	$ext4_es_´št_Œ“
(
šode
 *inode)

180 
ext4_es_Œ“
 *
Œ“
;

181 
rb_node
 *
node
;

183 
	`´štk
(
KERN_DEBUG
 "¡©u ex‹Á fÜ inod%lu:", 
šode
->
i_šo
);

184 
Œ“
 = &
	`EXT4_I
(
šode
)->
i_es_Œ“
;

185 
node
 = 
	`rb_fœ¡
(&
Œ“
->
roÙ
);

186 
node
) {

187 
ex‹Á_¡©us
 *
es
;

188 
es
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

189 
	`´štk
(
KERN_DEBUG
 " [%u/%u) %llu %x",

190 
es
->
es_lblk
,ƒs->
es_Ën
,

191 
	`ext4_es_pblock
(
es
), 
	`ext4_es_¡©us
(es));

192 
node
 = 
	`rb_Ãxt
(node);

194 
	`´štk
(
KERN_DEBUG
 "\n");

195 
	}
}

197 
	#ext4_es_´št_Œ“
(
šode
)

	)

200 
šlše
 
ext4_lblk_t
 
	$ext4_es_’d
(
ex‹Á_¡©us
 *
es
)

202 
	`BUG_ON
(
es
->
es_lblk
 +ƒs->
es_Ën
 <ƒs->es_lblk);

203  
es
->
es_lblk
 +ƒs->
es_Ën
 - 1;

204 
	}
}

210 
ex‹Á_¡©us
 *
	$__es_Œ“_£¬ch
(
rb_roÙ
 *
roÙ
,

211 
ext4_lblk_t
 
lblk
)

213 
rb_node
 *
node
 = 
roÙ
->rb_node;

214 
ex‹Á_¡©us
 *
es
 = 
NULL
;

216 
node
) {

217 
es
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

218 ià(
lblk
 < 
es
->
es_lblk
)

219 
node
 =‚ode->
rb_Ëá
;

220 ià(
lblk
 > 
	`ext4_es_’d
(
es
))

221 
node
 =‚ode->
rb_right
;

223  
es
;

226 ià(
es
 && 
lblk
 <ƒs->
es_lblk
)

227  
es
;

229 ià(
es
 && 
lblk
 > 
	`ext4_es_’d
(es)) {

230 
node
 = 
	`rb_Ãxt
(&
es
->
rb_node
);

231  
node
 ? 
	`rb_’Œy
Òode, 
ex‹Á_¡©us
, 
rb_node
) :

232 
NULL
;

235  
NULL
;

236 
	}
}

256 
	$__es_fšd_ex‹Á_¿nge
(
šode
 *inode,

257 (*
m©chšg_â
)(
ex‹Á_¡©us
 *
es
),

258 
ext4_lblk_t
 
lblk
,ƒxt4_lblk_ˆ
’d
,

259 
ex‹Á_¡©us
 *
es
)

261 
ext4_es_Œ“
 *
Œ“
 = 
NULL
;

262 
ex‹Á_¡©us
 *
es1
 = 
NULL
;

263 
rb_node
 *
node
;

265 
	`WARN_ON
(
es
 =ğ
NULL
);

266 
	`WARN_ON
(
’d
 < 
lblk
);

268 
Œ“
 = &
	`EXT4_I
(
šode
)->
i_es_Œ“
;

271 
es
->
es_lblk
 =ƒs->
es_Ën
 =ƒs->
es_pblk
 = 0;

272 ià(
Œ“
->
ÿche_es
) {

273 
es1
 = 
Œ“
->
ÿche_es
;

274 ià(
	`š_¿nge
(
lblk
, 
es1
->
es_lblk
,ƒs1->
es_Ën
)) {

275 
	`es_debug
("%u cached by [%u/%u) %llu %x\n",

276 
lblk
, 
es1
->
es_lblk
,ƒs1->
es_Ën
,

277 
	`ext4_es_pblock
(
es1
), 
	`ext4_es_¡©us
(es1));

278 
out
;

282 
es1
 = 
	`__es_Œ“_£¬ch
(&
Œ“
->
roÙ
, 
lblk
);

284 
out
:

285 ià(
es1
 && !
	`m©chšg_â
(es1)) {

286 (
node
 = 
	`rb_Ãxt
(&
es1
->
rb_node
)è!ğ
NULL
) {

287 
es1
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

288 ià(
es1
->
es_lblk
 > 
’d
) {

289 
es1
 = 
NULL
;

292 ià(
	`m©chšg_â
(
es1
))

297 ià(
es1
 && 
	`m©chšg_â
(es1)) {

298 
Œ“
->
ÿche_es
 = 
es1
;

299 
es
->
es_lblk
 = 
es1
->es_lblk;

300 
es
->
es_Ën
 = 
es1
->es_len;

301 
es
->
es_pblk
 = 
es1
->es_pblk;

304 
	}
}

309 
	$ext4_es_fšd_ex‹Á_¿nge
(
šode
 *inode,

310 (*
m©chšg_â
)(
ex‹Á_¡©us
 *
es
),

311 
ext4_lblk_t
 
lblk
,ƒxt4_lblk_ˆ
’d
,

312 
ex‹Á_¡©us
 *
es
)

314 
	`Œaû_ext4_es_fšd_ex‹Á_¿nge_’‹r
(
šode
, 
lblk
);

316 
	`»ad_lock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

317 
	`__es_fšd_ex‹Á_¿nge
(
šode
, 
m©chšg_â
, 
lblk
, 
’d
, 
es
);

318 
	`»ad_uÆock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

320 
	`Œaû_ext4_es_fšd_ex‹Á_¿nge_ex™
(
šode
, 
es
);

321 
	}
}

338 
boŞ
 
	$__es_sÿn_¿nge
(
šode
 *inode,

339 (*
m©chšg_â
)(
ex‹Á_¡©us
 *
es
),

340 
ext4_lblk_t
 
¡¬t
,ƒxt4_lblk_ˆ
’d
)

342 
ex‹Á_¡©us
 
es
;

344 
	`__es_fšd_ex‹Á_¿nge
(
šode
, 
m©chšg_â
, 
¡¬t
, 
’d
, &
es
);

345 ià(
es
.
es_Ën
 == 0)

346  
çl£
;

347 ià(
es
.
es_lblk
 <ğ
¡¬t
 &&

348 
¡¬t
 < 
es
.
es_lblk
 +ƒs.
es_Ën
)

349  
Œue
;

350 ià(
¡¬t
 <ğ
es
.
es_lblk
 &&ƒs.es_lblk <ğ
’d
)

351  
Œue
;

353  
çl£
;

354 
	}
}

358 
boŞ
 
	$ext4_es_sÿn_¿nge
(
šode
 *inode,

359 (*
m©chšg_â
)(
ex‹Á_¡©us
 *
es
),

360 
ext4_lblk_t
 
lblk
,ƒxt4_lblk_ˆ
’d
)

362 
boŞ
 
»t
;

364 
	`»ad_lock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

365 
»t
 = 
	`__es_sÿn_¿nge
(
šode
, 
m©chšg_â
, 
lblk
, 
’d
);

366 
	`»ad_uÆock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

368  
»t
;

369 
	}
}

385 
boŞ
 
	$__es_sÿn_şu
(
šode
 *inode,

386 (*
m©chšg_â
)(
ex‹Á_¡©us
 *
es
),

387 
ext4_lblk_t
 
lblk
)

389 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

390 
ext4_lblk_t
 
lblk_¡¬t
, 
lblk_’d
;

392 
lblk_¡¬t
 = 
	`EXT4_LBLK_CMASK
(
sbi
, 
lblk
);

393 
lblk_’d
 = 
lblk_¡¬t
 + 
sbi
->
s_şu¡”_¿tio
 - 1;

395  
	`__es_sÿn_¿nge
(
šode
, 
m©chšg_â
, 
lblk_¡¬t
, 
lblk_’d
);

396 
	}
}

401 
boŞ
 
	$ext4_es_sÿn_şu
(
šode
 *inode,

402 (*
m©chšg_â
)(
ex‹Á_¡©us
 *
es
),

403 
ext4_lblk_t
 
lblk
)

405 
boŞ
 
»t
;

407 
	`»ad_lock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

408 
»t
 = 
	`__es_sÿn_şu
(
šode
, 
m©chšg_â
, 
lblk
);

409 
	`»ad_uÆock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

411  
»t
;

412 
	}
}

414 
	$ext4_es_li¡_add
(
šode
 *inode)

416 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

417 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

419 ià(!
	`li¡_em±y
(&
ei
->
i_es_li¡
))

422 
	`¥š_lock
(&
sbi
->
s_es_lock
);

423 ià(
	`li¡_em±y
(&
ei
->
i_es_li¡
)) {

424 
	`li¡_add_
(&
ei
->
i_es_li¡
, &
sbi
->
s_es_li¡
);

425 
sbi
->
s_es_Ä_šode
++;

427 
	`¥š_uÆock
(&
sbi
->
s_es_lock
);

428 
	}
}

430 
	$ext4_es_li¡_d–
(
šode
 *inode)

432 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

433 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

435 
	`¥š_lock
(&
sbi
->
s_es_lock
);

436 ià(!
	`li¡_em±y
(&
ei
->
i_es_li¡
)) {

437 
	`li¡_d–_š™
(&
ei
->
i_es_li¡
);

438 
sbi
->
s_es_Ä_šode
--;

439 
	`WARN_ON_ONCE
(
sbi
->
s_es_Ä_šode
 < 0);

441 
	`¥š_uÆock
(&
sbi
->
s_es_lock
);

442 
	}
}

444 
ex‹Á_¡©us
 *

445 
	$ext4_es_®loc_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,ƒxt4_lblk_ˆ
Ën
,

446 
ext4_fsblk_t
 
pblk
)

448 
ex‹Á_¡©us
 *
es
;

449 
es
 = 
	`kmem_ÿche_®loc
(
ext4_es_ÿch•
, 
GFP_ATOMIC
);

450 ià(
es
 =ğ
NULL
)

451  
NULL
;

452 
es
->
es_lblk
 = 
lblk
;

453 
es
->
es_Ën
 = 
Ën
;

454 
es
->
es_pblk
 = 
pblk
;

459 ià(!
	`ext4_es_is_d–ayed
(
es
)) {

460 ià(!
	`EXT4_I
(
šode
)->
i_es_shk_Ä
++)

461 
	`ext4_es_li¡_add
(
šode
);

462 
	`³rıu_couÁ”_šc
(&
	`EXT4_SB
(
šode
->
i_sb
)->

463 
s_es_¡©s
.
es_¡©s_shk_út
);

466 
	`EXT4_I
(
šode
)->
i_es_®l_Ä
++;

467 
	`³rıu_couÁ”_šc
(&
	`EXT4_SB
(
šode
->
i_sb
)->
s_es_¡©s
.
es_¡©s_®l_út
);

469  
es
;

470 
	}
}

472 
	$ext4_es_ä“_ex‹Á
(
šode
 *šode, 
ex‹Á_¡©us
 *
es
)

474 
	`EXT4_I
(
šode
)->
i_es_®l_Ä
--;

475 
	`³rıu_couÁ”_dec
(&
	`EXT4_SB
(
šode
->
i_sb
)->
s_es_¡©s
.
es_¡©s_®l_út
);

478 ià(!
	`ext4_es_is_d–ayed
(
es
)) {

479 
	`BUG_ON
(
	`EXT4_I
(
šode
)->
i_es_shk_Ä
 == 0);

480 ià(!--
	`EXT4_I
(
šode
)->
i_es_shk_Ä
)

481 
	`ext4_es_li¡_d–
(
šode
);

482 
	`³rıu_couÁ”_dec
(&
	`EXT4_SB
(
šode
->
i_sb
)->

483 
s_es_¡©s
.
es_¡©s_shk_út
);

486 
	`kmem_ÿche_ä“
(
ext4_es_ÿch•
, 
es
);

487 
	}
}

496 
	$ext4_es_ÿn_be_m”ged
(
ex‹Á_¡©us
 *
es1
,

497 
ex‹Á_¡©us
 *
es2
)

499 ià(
	`ext4_es_ty³
(
es1
è!ğext4_es_ty³(
es2
))

502 ià(((
__u64
è
es1
->
es_Ën
è+ 
es2
->es_ËÀ> 
EXT_MAX_BLOCKS
) {

503 
	`´_w¬n
("ES‡ssertion failed when mergingƒxtents. "

506 
es1
->
es_Ën
, 
es2
->es_Ën, 
EXT_MAX_BLOCKS
);

507 
	`WARN_ON
(1);

511 ià(((
__u64
è
es1
->
es_lblk
è+ƒs1->
es_Ën
 !ğ
es2
->es_lblk)

514 ià((
	`ext4_es_is_wr™‹n
(
es1
è|| 
	`ext4_es_is_unwr™‹n
(es1)) &&

515 (
	`ext4_es_pblock
(
es1
è+ƒs1->
es_Ën
 =ğext4_es_pblock(
es2
)))

518 ià(
	`ext4_es_is_hŞe
(
es1
))

522 ià(
	`ext4_es_is_d–ayed
(
es1
è&& !
	`ext4_es_is_unwr™‹n
(es1))

526 
	}
}

528 
ex‹Á_¡©us
 *

529 
	$ext4_es_Œy_to_m”ge_Ëá
(
šode
 *šode, 
ex‹Á_¡©us
 *
es
)

531 
ext4_es_Œ“
 *
Œ“
 = &
	`EXT4_I
(
šode
)->
i_es_Œ“
;

532 
ex‹Á_¡©us
 *
es1
;

533 
rb_node
 *
node
;

535 
node
 = 
	`rb_´ev
(&
es
->
rb_node
);

536 ià(!
node
)

537  
es
;

539 
es1
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

540 ià(
	`ext4_es_ÿn_be_m”ged
(
es1
, 
es
)) {

541 
es1
->
es_Ën
 +ğ
es
->es_len;

542 ià(
	`ext4_es_is_»ã»nûd
(
es
))

543 
	`ext4_es_£t_»ã»nûd
(
es1
);

544 
	`rb_”a£
(&
es
->
rb_node
, &
Œ“
->
roÙ
);

545 
	`ext4_es_ä“_ex‹Á
(
šode
, 
es
);

546 
es
 = 
es1
;

549  
es
;

550 
	}
}

552 
ex‹Á_¡©us
 *

553 
	$ext4_es_Œy_to_m”ge_right
(
šode
 *šode, 
ex‹Á_¡©us
 *
es
)

555 
ext4_es_Œ“
 *
Œ“
 = &
	`EXT4_I
(
šode
)->
i_es_Œ“
;

556 
ex‹Á_¡©us
 *
es1
;

557 
rb_node
 *
node
;

559 
node
 = 
	`rb_Ãxt
(&
es
->
rb_node
);

560 ià(!
node
)

561  
es
;

563 
es1
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

564 ià(
	`ext4_es_ÿn_be_m”ged
(
es
, 
es1
)) {

565 
es
->
es_Ën
 +ğ
es1
->es_len;

566 ià(
	`ext4_es_is_»ã»nûd
(
es1
))

567 
	`ext4_es_£t_»ã»nûd
(
es
);

568 
	`rb_”a£
(
node
, &
Œ“
->
roÙ
);

569 
	`ext4_es_ä“_ex‹Á
(
šode
, 
es1
);

572  
es
;

573 
	}
}

575 #ifdeà
ES_AGGRESSIVE_TEST


576 
	~"ext4_ex‹Ás.h
"

578 
	$ext4_es_š£¹_ex‹Á_ext_check
(
šode
 *inode,

579 
ex‹Á_¡©us
 *
es
)

581 
ext4_ext_·th
 *
·th
 = 
NULL
;

582 
ext4_ex‹Á
 *
ex
;

583 
ext4_lblk_t
 
“_block
;

584 
ext4_fsblk_t
 
“_¡¬t
;

585 
“_Ën
;

586 
d•th
, 
“_¡©us
, 
es_¡©us
;

588 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
es
->
es_lblk
, 
NULL
, 
EXT4_EX_NOCACHE
);

589 ià(
	`IS_ERR
(
·th
))

592 
d•th
 = 
	`ext_d•th
(
šode
);

593 
ex
 = 
·th
[
d•th
].
p_ext
;

595 ià(
ex
) {

597 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

598 
“_¡¬t
 = 
	`ext4_ext_pblock
(
ex
);

599 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

601 
“_¡©us
 = 
	`ext4_ext_is_unwr™‹n
(
ex
) ? 1 : 0;

602 
es_¡©us
 = 
	`ext4_es_is_unwr™‹n
(
es
) ? 1 : 0;

608 ià(!
	`ext4_es_is_wr™‹n
(
es
è&& !
	`ext4_es_is_unwr™‹n
(es)) {

609 ià(
	`š_¿nge
(
es
->
es_lblk
, 
“_block
, 
“_Ën
)) {

610 
	`´_w¬n
("ES insert‡ssertion failed for "

615 
šode
->
i_šo
, 
“_block
, 
“_Ën
,

616 
“_¡¬t
, 
“_¡©us
 ? 'u' : 'w',

617 
es
->
es_lblk
,ƒs->
es_Ën
,

618 
	`ext4_es_pblock
(
es
), 
	`ext4_es_¡©us
(es));

620 
out
;

627 ià(
es
->
es_lblk
 < 
“_block
 ||

628 
	`ext4_es_pblock
(
es
è!ğ
“_¡¬t
 +ƒs->
es_lblk
 - 
“_block
) {

629 
	`´_w¬n
("ES insert‡ssertion failed for inode: %lu "

631 "es_¡©u [%d/%d/%Îu/%c]\n", 
šode
->
i_šo
,

632 
“_block
, 
“_Ën
, 
“_¡¬t
,

633 
“_¡©us
 ? 'u' : 'w', 
es
->
es_lblk
,ƒs->
es_Ën
,

634 
	`ext4_es_pblock
(
es
), 
es_¡©us
 ? 'u' : 'w');

635 
out
;

638 ià(
“_¡©us
 ^ 
es_¡©us
) {

639 
	`´_w¬n
("ES insert‡ssertion failed for inode: %lu "

641 "es_¡©u [%d/%d/%Îu/%c]\n", 
šode
->
i_šo
,

642 
“_block
, 
“_Ën
, 
“_¡¬t
,

643 
“_¡©us
 ? 'u' : 'w', 
es
->
es_lblk
,ƒs->
es_Ën
,

644 
	`ext4_es_pblock
(
es
), 
es_¡©us
 ? 'u' : 'w');

651 ià(!
	`ext4_es_is_d–ayed
(
es
è&& !
	`ext4_es_is_hŞe
(es)) {

652 
	`´_w¬n
("ES insert‡ssertion failed for inode: %lu "

655 "[%d/%d/%Îu/%x]\n", 
šode
->
i_šo
,

656 
es
->
es_lblk
,ƒs->es_lblk,ƒs->
es_Ën
,

657 
	`ext4_es_pblock
(
es
), 
	`ext4_es_¡©us
(es));

660 
out
:

661 
	`ext4_ext_drİ_»fs
(
·th
);

662 
	`kä“
(
·th
);

663 
	}
}

665 
	$ext4_es_š£¹_ex‹Á_šd_check
(
šode
 *inode,

666 
ex‹Á_¡©us
 *
es
)

668 
ext4_m­_blocks
 
m­
;

669 
»tv®
;

678 
m­
.
m_lblk
 = 
es
->
es_lblk
;

679 
m­
.
m_Ën
 = 
es
->
es_Ën
;

681 
»tv®
 = 
	`ext4_šd_m­_blocks
(
NULL
, 
šode
, &
m­
, 0);

682 ià(
»tv®
 > 0) {

683 ià(
	`ext4_es_is_d–ayed
(
es
è|| 
	`ext4_es_is_hŞe
(es)) {

688 
	`´_w¬n
("ES insert‡ssertion failed for inode: %lu "

691 
šode
->
i_šo
, 
es
->
es_lblk
,ƒs->
es_Ën
,

692 
	`ext4_es_pblock
(
es
), 
	`ext4_es_¡©us
(es));

694 } ià(
	`ext4_es_is_wr™‹n
(
es
)) {

695 ià(
»tv®
 !ğ
es
->
es_Ën
) {

696 
	`´_w¬n
("ES insert‡ssertion failed for "

698 
šode
->
i_šo
, 
»tv®
, 
es
->
es_Ën
);

701 ià(
m­
.
m_pblk
 !ğ
	`ext4_es_pblock
(
es
)) {

702 
	`´_w¬n
("ES insert‡ssertion failed for "

705 
šode
->
i_šo
, 
m­
.
m_pblk
,

706 
	`ext4_es_pblock
(
es
));

714 
	`BUG
();

716 } ià(
»tv®
 == 0) {

717 ià(
	`ext4_es_is_wr™‹n
(
es
)) {

718 
	`´_w¬n
("ES insert‡ssertion failed for inode: %lu "

721 
šode
->
i_šo
, 
es
->
es_lblk
,ƒs->
es_Ën
,

722 
	`ext4_es_pblock
(
es
), 
	`ext4_es_¡©us
(es));

726 
	}
}

728 
šlše
 
	$ext4_es_š£¹_ex‹Á_check
(
šode
 *inode,

729 
ex‹Á_¡©us
 *
es
)

735 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

736 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

737 
	`ext4_es_š£¹_ex‹Á_ext_check
(
šode
, 
es
);

739 
	`ext4_es_š£¹_ex‹Á_šd_check
(
šode
, 
es
);

740 
	}
}

742 
šlše
 
	$ext4_es_š£¹_ex‹Á_check
(
šode
 *inode,

743 
ex‹Á_¡©us
 *
es
)

745 
	}
}

748 
	$__es_š£¹_ex‹Á
(
šode
 *šode, 
ex‹Á_¡©us
 *
Ãwes
)

750 
ext4_es_Œ“
 *
Œ“
 = &
	`EXT4_I
(
šode
)->
i_es_Œ“
;

751 
rb_node
 **
p
 = &
Œ“
->
roÙ
.rb_node;

752 
rb_node
 *
·»Á
 = 
NULL
;

753 
ex‹Á_¡©us
 *
es
;

755 *
p
) {

756 
·»Á
 = *
p
;

757 
es
 = 
	`rb_’Œy
(
·»Á
, 
ex‹Á_¡©us
, 
rb_node
);

759 ià(
Ãwes
->
es_lblk
 < 
es
->es_lblk) {

760 ià(
	`ext4_es_ÿn_be_m”ged
(
Ãwes
, 
es
)) {

765 
es
->
es_lblk
 = 
Ãwes
->es_lblk;

766 
es
->
es_Ën
 +ğ
Ãwes
->es_len;

767 ià(
	`ext4_es_is_wr™‹n
(
es
) ||

768 
	`ext4_es_is_unwr™‹n
(
es
))

769 
	`ext4_es_¡Üe_pblock
(
es
,

770 
Ãwes
->
es_pblk
);

771 
es
 = 
	`ext4_es_Œy_to_m”ge_Ëá
(
šode
,ƒs);

772 
out
;

774 
p
 = &(*p)->
rb_Ëá
;

775 } ià(
Ãwes
->
es_lblk
 > 
	`ext4_es_’d
(
es
)) {

776 ià(
	`ext4_es_ÿn_be_m”ged
(
es
, 
Ãwes
)) {

777 
es
->
es_Ën
 +ğ
Ãwes
->es_len;

778 
es
 = 
	`ext4_es_Œy_to_m”ge_right
(
šode
,ƒs);

779 
out
;

781 
p
 = &(*p)->
rb_right
;

783 
	`BUG
();

784  -
EINVAL
;

788 
es
 = 
	`ext4_es_®loc_ex‹Á
(
šode
, 
Ãwes
->
es_lblk
,‚ewes->
es_Ën
,

789 
Ãwes
->
es_pblk
);

790 ià(!
es
)

791  -
ENOMEM
;

792 
	`rb_lšk_node
(&
es
->
rb_node
, 
·»Á
, 
p
);

793 
	`rb_š£¹_cŞÜ
(&
es
->
rb_node
, &
Œ“
->
roÙ
);

795 
out
:

796 
Œ“
->
ÿche_es
 = 
es
;

798 
	}
}

806 
	$ext4_es_š£¹_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

807 
ext4_lblk_t
 
Ën
, 
ext4_fsblk_t
 
pblk
,

808 
¡©us
)

810 
ex‹Á_¡©us
 
Ãwes
;

811 
ext4_lblk_t
 
’d
 = 
lblk
 + 
Ën
 - 1;

812 
”r
 = 0;

813 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

815 
	`es_debug
("add [%u/%u) %llu %xoƒxtent statusree of inode %lu\n",

816 
lblk
, 
Ën
, 
pblk
, 
¡©us
, 
šode
->
i_šo
);

818 ià(!
Ën
)

821 
	`BUG_ON
(
’d
 < 
lblk
);

823 ià((
¡©us
 & 
EXTENT_STATUS_DELAYED
) &&

824 (
¡©us
 & 
EXTENT_STATUS_WRITTEN
)) {

825 
	`ext4_w¬nšg
(
šode
->
i_sb
, "Insertingƒxtent [%u/%u]‡s "

827 " cau£ d©¨loss.", 
lblk
, 
Ën
);

828 
	`WARN_ON
(1);

831 
Ãwes
.
es_lblk
 = 
lblk
;

832 
Ãwes
.
es_Ën
 = 
Ën
;

833 
	`ext4_es_¡Üe_pblock_¡©us
(&
Ãwes
, 
pblk
, 
¡©us
);

834 
	`Œaû_ext4_es_š£¹_ex‹Á
(
šode
, &
Ãwes
);

836 
	`ext4_es_š£¹_ex‹Á_check
(
šode
, &
Ãwes
);

838 
	`wr™e_lock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

839 
”r
 = 
	`__es_»move_ex‹Á
(
šode
, 
lblk
, 
’d
, 
NULL
);

840 ià(
”r
 != 0)

841 
”rÜ
;

842 
»Œy
:

843 
”r
 = 
	`__es_š£¹_ex‹Á
(
šode
, &
Ãwes
);

844 ià(
”r
 =ğ-
ENOMEM
 && 
	`__es_shršk
(
	`EXT4_SB
(
šode
->
i_sb
),

845 128, 
	`EXT4_I
(
šode
)))

846 
»Œy
;

847 ià(
”r
 =ğ-
ENOMEM
 && !
	`ext4_es_is_d–ayed
(&
Ãwes
))

848 
”r
 = 0;

850 ià(
sbi
->
s_şu¡”_¿tio
 > 1 && 
	`‹¡_İt
(
šode
->
i_sb
, 
DELALLOC
) &&

851 (
¡©us
 & 
EXTENT_STATUS_WRITTEN
 ||

852 
¡©us
 & 
EXTENT_STATUS_UNWRITTEN
))

853 
	`__»vi£_³ndšg
(
šode
, 
lblk
, 
Ën
);

855 
”rÜ
:

856 
	`wr™e_uÆock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

858 
	`ext4_es_´št_Œ“
(
šode
);

860  
”r
;

861 
	}
}

868 
	$ext4_es_ÿche_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

869 
ext4_lblk_t
 
Ën
, 
ext4_fsblk_t
 
pblk
,

870 
¡©us
)

872 
ex‹Á_¡©us
 *
es
;

873 
ex‹Á_¡©us
 
Ãwes
;

874 
ext4_lblk_t
 
’d
 = 
lblk
 + 
Ën
 - 1;

876 
Ãwes
.
es_lblk
 = 
lblk
;

877 
Ãwes
.
es_Ën
 = 
Ën
;

878 
	`ext4_es_¡Üe_pblock_¡©us
(&
Ãwes
, 
pblk
, 
¡©us
);

879 
	`Œaû_ext4_es_ÿche_ex‹Á
(
šode
, &
Ãwes
);

881 ià(!
Ën
)

884 
	`BUG_ON
(
’d
 < 
lblk
);

886 
	`wr™e_lock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

888 
es
 = 
	`__es_Œ“_£¬ch
(&
	`EXT4_I
(
šode
)->
i_es_Œ“
.
roÙ
, 
lblk
);

889 ià(!
es
 ||ƒs->
es_lblk
 > 
’d
)

890 
	`__es_š£¹_ex‹Á
(
šode
, &
Ãwes
);

891 
	`wr™e_uÆock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

892 
	}
}

901 
	$ext4_es_lookup_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

902 
ext4_lblk_t
 *
Ãxt_lblk
,

903 
ex‹Á_¡©us
 *
es
)

905 
ext4_es_Œ“
 *
Œ“
;

906 
ext4_es_¡©s
 *
¡©s
;

907 
ex‹Á_¡©us
 *
es1
 = 
NULL
;

908 
rb_node
 *
node
;

909 
found
 = 0;

911 
	`Œaû_ext4_es_lookup_ex‹Á_’‹r
(
šode
, 
lblk
);

912 
	`es_debug
("looku°ex‹Á iÀblock %u\n", 
lblk
);

914 
Œ“
 = &
	`EXT4_I
(
šode
)->
i_es_Œ“
;

915 
	`»ad_lock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

918 
es
->
es_lblk
 =ƒs->
es_Ën
 =ƒs->
es_pblk
 = 0;

919 ià(
Œ“
->
ÿche_es
) {

920 
es1
 = 
Œ“
->
ÿche_es
;

921 ià(
	`š_¿nge
(
lblk
, 
es1
->
es_lblk
,ƒs1->
es_Ën
)) {

922 
	`es_debug
("%u cached by [%u/%u)\n",

923 
lblk
, 
es1
->
es_lblk
,ƒs1->
es_Ën
);

924 
found
 = 1;

925 
out
;

929 
node
 = 
Œ“
->
roÙ
.
rb_node
;

930 
node
) {

931 
es1
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

932 ià(
lblk
 < 
es1
->
es_lblk
)

933 
node
 =‚ode->
rb_Ëá
;

934 ià(
lblk
 > 
	`ext4_es_’d
(
es1
))

935 
node
 =‚ode->
rb_right
;

937 
found
 = 1;

942 
out
:

943 
¡©s
 = &
	`EXT4_SB
(
šode
->
i_sb
)->
s_es_¡©s
;

944 ià(
found
) {

945 
	`BUG_ON
(!
es1
);

946 
es
->
es_lblk
 = 
es1
->es_lblk;

947 
es
->
es_Ën
 = 
es1
->es_len;

948 
es
->
es_pblk
 = 
es1
->es_pblk;

949 ià(!
	`ext4_es_is_»ã»nûd
(
es1
))

950 
	`ext4_es_£t_»ã»nûd
(
es1
);

951 
	`³rıu_couÁ”_šc
(&
¡©s
->
es_¡©s_ÿche_h™s
);

952 ià(
Ãxt_lblk
) {

953 
node
 = 
	`rb_Ãxt
(&
es1
->
rb_node
);

954 ià(
node
) {

955 
es1
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
,

956 
rb_node
);

957 *
Ãxt_lblk
 = 
es1
->
es_lblk
;

959 *
Ãxt_lblk
 = 0;

962 
	`³rıu_couÁ”_šc
(&
¡©s
->
es_¡©s_ÿche_mis£s
);

965 
	`»ad_uÆock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

967 
	`Œaû_ext4_es_lookup_ex‹Á_ex™
(
šode
, 
es
, 
found
);

968  
found
;

969 
	}
}

971 
	srsvd_couÁ
 {

972 
	mnd–Úly
;

973 
boŞ
 
	mfœ¡_do_lblk_found
;

974 
ext4_lblk_t
 
	mfœ¡_do_lblk
;

975 
ext4_lblk_t
 
	mÏ¡_do_lblk
;

976 
ex‹Á_¡©us
 *
	mËá_es
;

977 
boŞ
 
	m·¹Ÿl
;

978 
ext4_lblk_t
 
	mlşu
;

992 
	$š™_rsvd
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

993 
ex‹Á_¡©us
 *
es
, 
rsvd_couÁ
 *
rc
)

995 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

996 
rb_node
 *
node
;

998 
rc
->
nd–Úly
 = 0;

1006 ià(
sbi
->
s_şu¡”_¿tio
 > 1) {

1007 
rc
->
fœ¡_do_lblk_found
 = 
çl£
;

1008 ià(
lblk
 > 
es
->
es_lblk
) {

1009 
rc
->
Ëá_es
 = 
es
;

1011 
node
 = 
	`rb_´ev
(&
es
->
rb_node
);

1012 
rc
->
Ëá_es
 = 
node
 ? 
	`rb_’Œy
(node,

1013 
ex‹Á_¡©us
,

1014 
rb_node
è: 
NULL
;

1016 
rc
->
·¹Ÿl
 = 
çl£
;

1018 
	}
}

1034 
	$couÁ_rsvd
(
šode
 *šode, 
ext4_lblk_t
 
lblk
, 
Ën
,

1035 
ex‹Á_¡©us
 *
es
, 
rsvd_couÁ
 *
rc
)

1037 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

1038 
ext4_lblk_t
 
i
, 
’d
, 
nşu
;

1040 ià(!
	`ext4_es_is_d–Úly
(
es
))

1043 
	`WARN_ON
(
Ën
 <= 0);

1045 ià(
sbi
->
s_şu¡”_¿tio
 == 1) {

1046 
rc
->
nd–Úly
 +ğ(è
Ën
;

1052 
i
 = (
lblk
 < 
es
->
es_lblk
) ?ƒs->es_lblk :†blk;

1053 
’d
 = 
lblk
 + (
ext4_lblk_t
è
Ën
 - 1;

1054 
’d
 = (’d > 
	`ext4_es_’d
(
es
)) ?ƒxt4_es_end(es) :ƒnd;

1057 ià(
rc
->
fœ¡_do_lblk_found
 =ğ
çl£
) {

1058 
rc
->
fœ¡_do_lblk
 = 
i
;

1059 
rc
->
fœ¡_do_lblk_found
 = 
Œue
;

1063 
rc
->
Ï¡_do_lblk
 = 
’d
;

1069 ià(
rc
->
·¹Ÿl
 && (rc->
lşu
 !ğ
	`EXT4_B2C
(
sbi
, 
i
))) {

1070 
rc
->
nd–Úly
++;

1071 
rc
->
·¹Ÿl
 = 
çl£
;

1078 ià(
	`EXT4_LBLK_COFF
(
sbi
, 
i
) != 0) {

1079 ià(
’d
 >ğ
	`EXT4_LBLK_CFILL
(
sbi
, 
i
)) {

1080 
rc
->
nd–Úly
++;

1081 
rc
->
·¹Ÿl
 = 
çl£
;

1082 
i
 = 
	`EXT4_LBLK_CFILL
(
sbi
, i) + 1;

1090 ià((
i
 + 
sbi
->
s_şu¡”_¿tio
 - 1è<ğ
’d
) {

1091 
nşu
 = (
’d
 - 
i
 + 1è>> 
sbi
->
s_şu¡”_b™s
;

1092 
rc
->
nd–Úly
 +ğ
nşu
;

1093 
i
 +ğ
nşu
 << 
sbi
->
s_şu¡”_b™s
;

1100 ià(!
rc
->
·¹Ÿl
 && 
i
 <ğ
’d
) {

1101 
rc
->
·¹Ÿl
 = 
Œue
;

1102 
rc
->
lşu
 = 
	`EXT4_B2C
(
sbi
, 
i
);

1104 
	}
}

1116 
³ndšg_»£rv©iÚ
 *
	$__´_Œ“_£¬ch
(
rb_roÙ
 *
roÙ
,

1117 
ext4_lblk_t
 
lşu
)

1119 
rb_node
 *
node
 = 
roÙ
->rb_node;

1120 
³ndšg_»£rv©iÚ
 *
´
 = 
NULL
;

1122 
node
) {

1123 
´
 = 
	`rb_’Œy
(
node
, 
³ndšg_»£rv©iÚ
, 
rb_node
);

1124 ià(
lşu
 < 
´
->lclu)

1125 
node
 =‚ode->
rb_Ëá
;

1126 ià(
lşu
 > 
´
->lclu)

1127 
node
 =‚ode->
rb_right
;

1129  
´
;

1131 ià(
´
 && 
lşu
 <…r->lclu)

1132  
´
;

1133 ià(
´
 && 
lşu
 >…r->lclu) {

1134 
node
 = 
	`rb_Ãxt
(&
´
->
rb_node
);

1135  
node
 ? 
	`rb_’Œy
Òode, 
³ndšg_»£rv©iÚ
,

1136 
rb_node
è: 
NULL
;

1138  
NULL
;

1139 
	}
}

1157 
	$g‘_rsvd
(
šode
 *šode, 
ext4_lblk_t
 
’d
,

1158 
ex‹Á_¡©us
 *
right_es
,

1159 
rsvd_couÁ
 *
rc
)

1161 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

1162 
³ndšg_»£rv©iÚ
 *
´
;

1163 
ext4_³ndšg_Œ“
 *
Œ“
 = &
	`EXT4_I
(
šode
)->
i_³ndšg_Œ“
;

1164 
rb_node
 *
node
;

1165 
ext4_lblk_t
 
fœ¡_lşu
, 
Ï¡_lşu
;

1166 
boŞ
 
Ëá_d–Úly
, 
right_d–Úly
, 
couÁ_³ndšg
;

1167 
ex‹Á_¡©us
 *
es
;

1169 ià(
sbi
->
s_şu¡”_¿tio
 > 1) {

1171 ià(
rc
->
·¹Ÿl
)

1172 
rc
->
nd–Úly
++;

1174 ià(
rc
->
nd–Úly
 == 0)

1177 
fœ¡_lşu
 = 
	`EXT4_B2C
(
sbi
, 
rc
->
fœ¡_do_lblk
);

1178 
Ï¡_lşu
 = 
	`EXT4_B2C
(
sbi
, 
rc
->
Ï¡_do_lblk
);

1185 
Ëá_d–Úly
 = 
right_d–Úly
 = 
çl£
;

1187 
es
 = 
rc
->
Ëá_es
;

1188 
es
 && 
	`ext4_es_’d
(es) >=

1189 
	`EXT4_LBLK_CMASK
(
sbi
, 
rc
->
fœ¡_do_lblk
)) {

1190 ià(
	`ext4_es_is_d–Úly
(
es
)) {

1191 
rc
->
nd–Úly
--;

1192 
Ëá_d–Úly
 = 
Œue
;

1195 
node
 = 
	`rb_´ev
(&
es
->
rb_node
);

1196 ià(!
node
)

1198 
es
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

1200 ià(
right_es
 && (!
Ëá_d–Úly
 || 
fœ¡_lşu
 !ğ
Ï¡_lşu
)) {

1201 ià(
’d
 < 
	`ext4_es_’d
(
right_es
)) {

1202 
es
 = 
right_es
;

1204 
node
 = 
	`rb_Ãxt
(&
right_es
->
rb_node
);

1205 
es
 = 
node
 ? 
	`rb_’Œy
Òode, 
ex‹Á_¡©us
,

1206 
rb_node
è: 
NULL
;

1208 
es
 &&ƒs->
es_lblk
 <=

1209 
	`EXT4_LBLK_CFILL
(
sbi
, 
rc
->
Ï¡_do_lblk
)) {

1210 ià(
	`ext4_es_is_d–Úly
(
es
)) {

1211 
rc
->
nd–Úly
--;

1212 
right_d–Úly
 = 
Œue
;

1215 
node
 = 
	`rb_Ãxt
(&
es
->
rb_node
);

1216 ià(!
node
)

1218 
es
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
,

1219 
rb_node
);

1232 ià(
fœ¡_lşu
 =ğ
Ï¡_lşu
) {

1233 ià(
Ëá_d–Úly
 | 
right_d–Úly
)

1234 
couÁ_³ndšg
 = 
çl£
;

1236 
couÁ_³ndšg
 = 
Œue
;

1238 ià(
Ëá_d–Úly
)

1239 
fœ¡_lşu
++;

1240 ià(
right_d–Úly
)

1241 
Ï¡_lşu
--;

1242 ià(
fœ¡_lşu
 <ğ
Ï¡_lşu
)

1243 
couÁ_³ndšg
 = 
Œue
;

1245 
couÁ_³ndšg
 = 
çl£
;

1254 ià(
couÁ_³ndšg
) {

1255 
´
 = 
	`__´_Œ“_£¬ch
(&
Œ“
->
roÙ
, 
fœ¡_lşu
);

1256 
´
 &&…r->
lşu
 <ğ
Ï¡_lşu
) {

1257 
rc
->
nd–Úly
--;

1258 
node
 = 
	`rb_Ãxt
(&
´
->
rb_node
);

1259 
	`rb_”a£
(&
´
->
rb_node
, &
Œ“
->
roÙ
);

1260 
	`kmem_ÿche_ä“
(
ext4_³ndšg_ÿch•
, 
´
);

1261 ià(!
node
)

1263 
´
 = 
	`rb_’Œy
(
node
, 
³ndšg_»£rv©iÚ
,

1264 
rb_node
);

1268  
rc
->
nd–Úly
;

1269 
	}
}

1285 
	$__es_»move_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

1286 
ext4_lblk_t
 
’d
, *
»£rved
)

1288 
ext4_es_Œ“
 *
Œ“
 = &
	`EXT4_I
(
šode
)->
i_es_Œ“
;

1289 
rb_node
 *
node
;

1290 
ex‹Á_¡©us
 *
es
;

1291 
ex‹Á_¡©us
 
Üig_es
;

1292 
ext4_lblk_t
 
Ën1
, 
Ën2
;

1293 
ext4_fsblk_t
 
block
;

1294 
”r
;

1295 
boŞ
 
couÁ_»£rved
 = 
Œue
;

1296 
rsvd_couÁ
 
rc
;

1298 ià(
»£rved
 =ğ
NULL
 || !
	`‹¡_İt
(
šode
->
i_sb
, 
DELALLOC
))

1299 
couÁ_»£rved
 = 
çl£
;

1300 
»Œy
:

1301 
”r
 = 0;

1303 
es
 = 
	`__es_Œ“_£¬ch
(&
Œ“
->
roÙ
, 
lblk
);

1304 ià(!
es
)

1305 
out
;

1306 ià(
es
->
es_lblk
 > 
’d
)

1307 
out
;

1310 
Œ“
->
ÿche_es
 = 
NULL
;

1311 ià(
couÁ_»£rved
)

1312 
	`š™_rsvd
(
šode
, 
lblk
, 
es
, &
rc
);

1314 
Üig_es
.
es_lblk
 = 
es
->es_lblk;

1315 
Üig_es
.
es_Ën
 = 
es
->es_len;

1316 
Üig_es
.
es_pblk
 = 
es
->es_pblk;

1318 
Ën1
 = 
lblk
 > 
es
->
es_lblk
 ?†blk -ƒs->es_lblk : 0;

1319 
Ën2
 = 
	`ext4_es_’d
(
es
è> 
’d
 ?ƒxt4_es_end(es) -ƒnd : 0;

1320 ià(
Ën1
 > 0)

1321 
es
->
es_Ën
 = 
Ën1
;

1322 ià(
Ën2
 > 0) {

1323 ià(
Ën1
 > 0) {

1324 
ex‹Á_¡©us
 
Ãwes
;

1326 
Ãwes
.
es_lblk
 = 
’d
 + 1;

1327 
Ãwes
.
es_Ën
 = 
Ën2
;

1328 
block
 = 0x7FDEADBEEFULL;

1329 ià(
	`ext4_es_is_wr™‹n
(&
Üig_es
) ||

1330 
	`ext4_es_is_unwr™‹n
(&
Üig_es
))

1331 
block
 = 
	`ext4_es_pblock
(&
Üig_es
) +

1332 
Üig_es
.
es_Ën
 - 
Ën2
;

1333 
	`ext4_es_¡Üe_pblock_¡©us
(&
Ãwes
, 
block
,

1334 
	`ext4_es_¡©us
(&
Üig_es
));

1335 
”r
 = 
	`__es_š£¹_ex‹Á
(
šode
, &
Ãwes
);

1336 ià(
”r
) {

1337 
es
->
es_lblk
 = 
Üig_es
.es_lblk;

1338 
es
->
es_Ën
 = 
Üig_es
.es_len;

1339 ià((
”r
 =ğ-
ENOMEM
) &&

1340 
	`__es_shršk
(
	`EXT4_SB
(
šode
->
i_sb
),

1341 128, 
	`EXT4_I
(
šode
)))

1342 
»Œy
;

1343 
out
;

1346 
es
->
es_lblk
 = 
’d
 + 1;

1347 
es
->
es_Ën
 = 
Ën2
;

1348 ià(
	`ext4_es_is_wr™‹n
(
es
) ||

1349 
	`ext4_es_is_unwr™‹n
(
es
)) {

1350 
block
 = 
Üig_es
.
es_pblk
 + orig_es.
es_Ën
 - 
Ën2
;

1351 
	`ext4_es_¡Üe_pblock
(
es
, 
block
);

1354 ià(
couÁ_»£rved
)

1355 
	`couÁ_rsvd
(
šode
, 
lblk
, 
Üig_es
.
es_Ën
 - 
Ën1
 - 
Ën2
,

1356 &
Üig_es
, &
rc
);

1357 
out
;

1360 ià(
Ën1
 > 0) {

1361 ià(
couÁ_»£rved
)

1362 
	`couÁ_rsvd
(
šode
, 
lblk
, 
Üig_es
.
es_Ën
 - 
Ën1
,

1363 &
Üig_es
, &
rc
);

1364 
node
 = 
	`rb_Ãxt
(&
es
->
rb_node
);

1365 ià(
node
)

1366 
es
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

1368 
es
 = 
NULL
;

1371 
es
 && 
	`ext4_es_’d
Ósè<ğ
’d
) {

1372 ià(
couÁ_»£rved
)

1373 
	`couÁ_rsvd
(
šode
, 
es
->
es_lblk
,ƒs->
es_Ën
,ƒs, &
rc
);

1374 
node
 = 
	`rb_Ãxt
(&
es
->
rb_node
);

1375 
	`rb_”a£
(&
es
->
rb_node
, &
Œ“
->
roÙ
);

1376 
	`ext4_es_ä“_ex‹Á
(
šode
, 
es
);

1377 ià(!
node
) {

1378 
es
 = 
NULL
;

1381 
es
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

1384 ià(
es
 &&ƒs->
es_lblk
 < 
’d
 + 1) {

1385 
ext4_lblk_t
 
Üig_Ën
 = 
es
->
es_Ën
;

1387 
Ën1
 = 
	`ext4_es_’d
(
es
è- 
’d
;

1388 ià(
couÁ_»£rved
)

1389 
	`couÁ_rsvd
(
šode
, 
es
->
es_lblk
, 
Üig_Ën
 - 
Ën1
,

1390 
es
, &
rc
);

1391 
es
->
es_lblk
 = 
’d
 + 1;

1392 
es
->
es_Ën
 = 
Ën1
;

1393 ià(
	`ext4_es_is_wr™‹n
(
es
è|| 
	`ext4_es_is_unwr™‹n
(es)) {

1394 
block
 = 
es
->
es_pblk
 + 
Üig_Ën
 - 
Ën1
;

1395 
	`ext4_es_¡Üe_pblock
(
es
, 
block
);

1399 ià(
couÁ_»£rved
)

1400 *
»£rved
 = 
	`g‘_rsvd
(
šode
, 
’d
, 
es
, &
rc
);

1401 
out
:

1402  
”r
;

1403 
	}
}

1415 
	$ext4_es_»move_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

1416 
ext4_lblk_t
 
Ën
)

1418 
ext4_lblk_t
 
’d
;

1419 
”r
 = 0;

1420 
»£rved
 = 0;

1422 
	`Œaû_ext4_es_»move_ex‹Á
(
šode
, 
lblk
, 
Ën
);

1423 
	`es_debug
("remove [%u/%u) fromƒxtent statusree of inode %lu\n",

1424 
lblk
, 
Ën
, 
šode
->
i_šo
);

1426 ià(!
Ën
)

1427  
”r
;

1429 
’d
 = 
lblk
 + 
Ën
 - 1;

1430 
	`BUG_ON
(
’d
 < 
lblk
);

1437 
	`wr™e_lock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

1438 
”r
 = 
	`__es_»move_ex‹Á
(
šode
, 
lblk
, 
’d
, &
»£rved
);

1439 
	`wr™e_uÆock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

1440 
	`ext4_es_´št_Œ“
(
šode
);

1441 
	`ext4_da_»Ëa£_¥aû
(
šode
, 
»£rved
);

1442  
”r
;

1443 
	}
}

1445 
	$__es_shršk
(
ext4_sb_šfo
 *
sbi
, 
Ä_to_sÿn
,

1446 
ext4_šode_šfo
 *
locked_ei
)

1448 
ext4_šode_šfo
 *
ei
;

1449 
ext4_es_¡©s
 *
es_¡©s
;

1450 
ktime_t
 
¡¬t_time
;

1451 
u64
 
sÿn_time
;

1452 
Ä_to_w®k
;

1453 
Ä_shrunk
 = 0;

1454 
»Œ›d
 = 0, 
Ä_sk³d
 = 0;

1456 
es_¡©s
 = &
sbi
->
s_es_¡©s
;

1457 
¡¬t_time
 = 
	`ktime_g‘
();

1459 
»Œy
:

1460 
	`¥š_lock
(&
sbi
->
s_es_lock
);

1461 
Ä_to_w®k
 = 
sbi
->
s_es_Ä_šode
;

1462 
Ä_to_w®k
-- > 0) {

1463 ià(
	`li¡_em±y
(&
sbi
->
s_es_li¡
)) {

1464 
	`¥š_uÆock
(&
sbi
->
s_es_lock
);

1465 
out
;

1467 
ei
 = 
	`li¡_fœ¡_’Œy
(&
sbi
->
s_es_li¡
, 
ext4_šode_šfo
,

1468 
i_es_li¡
);

1470 
	`li¡_move_
(&
ei
->
i_es_li¡
, &
sbi
->
s_es_li¡
);

1476 ià(!
»Œ›d
 && 
	`ext4_‹¡_šode_¡©e
(&
ei
->
vfs_šode
,

1477 
EXT4_STATE_EXT_PRECACHED
)) {

1478 
Ä_sk³d
++;

1482 ià(
ei
 =ğ
locked_ei
 || !
	`wr™e_Œylock
(&ei->
i_es_lock
)) {

1483 
Ä_sk³d
++;

1490 
	`¥š_uÆock
(&
sbi
->
s_es_lock
);

1492 
Ä_shrunk
 +ğ
	`es_»şaim_ex‹Ás
(
ei
, &
Ä_to_sÿn
);

1493 
	`wr™e_uÆock
(&
ei
->
i_es_lock
);

1495 ià(
Ä_to_sÿn
 <= 0)

1496 
out
;

1497 
	`¥š_lock
(&
sbi
->
s_es_lock
);

1499 
	`¥š_uÆock
(&
sbi
->
s_es_lock
);

1505 ià((
Ä_shrunk
 =ğ0è&& 
Ä_sk³d
 && !
»Œ›d
) {

1506 
»Œ›d
++;

1507 
»Œy
;

1510 ià(
locked_ei
 && 
Ä_shrunk
 == 0)

1511 
Ä_shrunk
 = 
	`es_»şaim_ex‹Ás
(
locked_ei
, &
Ä_to_sÿn
);

1513 
out
:

1514 
sÿn_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_g‘
(), 
¡¬t_time
));

1515 ià(
	`lik–y
(
es_¡©s
->
es_¡©s_sÿn_time
))

1516 
es_¡©s
->
es_¡©s_sÿn_time
 = (
sÿn_time
 +

1517 
es_¡©s
->
es_¡©s_sÿn_time
*3) / 4;

1519 
es_¡©s
->
es_¡©s_sÿn_time
 = 
sÿn_time
;

1520 ià(
sÿn_time
 > 
es_¡©s
->
es_¡©s_max_sÿn_time
)

1521 
es_¡©s
->
es_¡©s_max_sÿn_time
 = 
sÿn_time
;

1522 ià(
	`lik–y
(
es_¡©s
->
es_¡©s_shrunk
))

1523 
es_¡©s
->
es_¡©s_shrunk
 = (
Ä_shrunk
 +

1524 
es_¡©s
->
es_¡©s_shrunk
*3) / 4;

1526 
es_¡©s
->
es_¡©s_shrunk
 = 
Ä_shrunk
;

1528 
	`Œaû_ext4_es_shršk
(
sbi
->
s_sb
, 
Ä_shrunk
, 
sÿn_time
,

1529 
Ä_sk³d
, 
»Œ›d
);

1530  
Ä_shrunk
;

1531 
	}
}

1533 
	$ext4_es_couÁ
(
shršk”
 *
shršk
,

1534 
shršk_cÚŒŞ
 *
sc
)

1536 
Ä
;

1537 
ext4_sb_šfo
 *
sbi
;

1539 
sbi
 = 
	`cÚš”_of
(
shršk
, 
ext4_sb_šfo
, 
s_es_shršk”
);

1540 
Ä
 = 
	`³rıu_couÁ”_»ad_pos™ive
(&
sbi
->
s_es_¡©s
.
es_¡©s_shk_út
);

1541 
	`Œaû_ext4_es_shršk_couÁ
(
sbi
->
s_sb
, 
sc
->
Ä_to_sÿn
, 
Ä
);

1542  
Ä
;

1543 
	}
}

1545 
	$ext4_es_sÿn
(
shršk”
 *
shršk
,

1546 
shršk_cÚŒŞ
 *
sc
)

1548 
ext4_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
shršk
,

1549 
ext4_sb_šfo
, 
s_es_shršk”
);

1550 
Ä_to_sÿn
 = 
sc
->nr_to_scan;

1551 
»t
, 
Ä_shrunk
;

1553 
»t
 = 
	`³rıu_couÁ”_»ad_pos™ive
(&
sbi
->
s_es_¡©s
.
es_¡©s_shk_út
);

1554 
	`Œaû_ext4_es_shršk_sÿn_’‹r
(
sbi
->
s_sb
, 
Ä_to_sÿn
, 
»t
);

1556 ià(!
Ä_to_sÿn
)

1557  
»t
;

1559 
Ä_shrunk
 = 
	`__es_shršk
(
sbi
, 
Ä_to_sÿn
, 
NULL
);

1561 
	`Œaû_ext4_es_shršk_sÿn_ex™
(
sbi
->
s_sb
, 
Ä_shrunk
, 
»t
);

1562  
Ä_shrunk
;

1563 
	}
}

1565 
	$ext4_£q_es_shršk”_šfo_show
(
£q_fe
 *
£q
, *
v
)

1567 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
((
su³r_block
 *è
£q
->
´iv©e
);

1568 
ext4_es_¡©s
 *
es_¡©s
 = &
sbi
->
s_es_¡©s
;

1569 
ext4_šode_šfo
 *
ei
, *
max
 = 
NULL
;

1570 
šode_út
 = 0;

1572 ià(
v
 !ğ
SEQ_START_TOKEN
)

1576 
	`¥š_lock
(&
sbi
->
s_es_lock
);

1577 
	`li¡_fÜ_—ch_’Œy
(
ei
, &
sbi
->
s_es_li¡
, 
i_es_li¡
) {

1578 
šode_út
++;

1579 ià(
max
 && max->
i_es_®l_Ä
 < 
ei
->i_es_all_nr)

1580 
max
 = 
ei
;

1581 ià(!
max
)

1582 
max
 = 
ei
;

1584 
	`¥š_uÆock
(&
sbi
->
s_es_lock
);

1586 
	`£q_´štf
(
£q
, "stats:\n %lld objects\n %lld„eclaimable objects\n",

1587 
	`³rıu_couÁ”_sum_pos™ive
(&
es_¡©s
->
es_¡©s_®l_út
),

1588 
	`³rıu_couÁ”_sum_pos™ive
(&
es_¡©s
->
es_¡©s_shk_út
));

1589 
	`£q_´štf
(
£q
, " %lld/%lld cache hits/misses\n",

1590 
	`³rıu_couÁ”_sum_pos™ive
(&
es_¡©s
->
es_¡©s_ÿche_h™s
),

1591 
	`³rıu_couÁ”_sum_pos™ive
(&
es_¡©s
->
es_¡©s_ÿche_mis£s
));

1592 ià(
šode_út
)

1593 
	`£q_´štf
(
£q
, " %d inode Ú†i¡\n", 
šode_út
);

1595 
	`£q_´štf
(
£q
, "average:\n %llu us scanime\n",

1596 
	`div_u64
(
es_¡©s
->
es_¡©s_sÿn_time
, 1000));

1597 
	`£q_´štf
(
£q
, " %lu shrunk objeùs\n", 
es_¡©s
->
es_¡©s_shrunk
);

1598 ià(
šode_út
)

1599 
	`£q_´štf
(
£q
,

1602 
max
->
vfs_šode
.
i_šo
, max->
i_es_®l_Ä
, max->
i_es_shk_Ä
,

1603 
	`div_u64
(
es_¡©s
->
es_¡©s_max_sÿn_time
, 1000));

1606 
	}
}

1608 
	$ext4_es_»gi¡”_shršk”
(
ext4_sb_šfo
 *
sbi
)

1610 
”r
;

1613 
	`BUILD_BUG_ON
(
ES_SHIFT
 < 48);

1614 
	`INIT_LIST_HEAD
(&
sbi
->
s_es_li¡
);

1615 
sbi
->
s_es_Ä_šode
 = 0;

1616 
	`¥š_lock_š™
(&
sbi
->
s_es_lock
);

1617 
sbi
->
s_es_¡©s
.
es_¡©s_shrunk
 = 0;

1618 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
s_es_¡©s
.
es_¡©s_ÿche_h™s
, 0,

1619 
GFP_KERNEL
);

1620 ià(
”r
)

1621  
”r
;

1622 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
s_es_¡©s
.
es_¡©s_ÿche_mis£s
, 0,

1623 
GFP_KERNEL
);

1624 ià(
”r
)

1625 
”r1
;

1626 
sbi
->
s_es_¡©s
.
es_¡©s_sÿn_time
 = 0;

1627 
sbi
->
s_es_¡©s
.
es_¡©s_max_sÿn_time
 = 0;

1628 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
s_es_¡©s
.
es_¡©s_®l_út
, 0, 
GFP_KERNEL
);

1629 ià(
”r
)

1630 
”r2
;

1631 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
s_es_¡©s
.
es_¡©s_shk_út
, 0, 
GFP_KERNEL
);

1632 ià(
”r
)

1633 
”r3
;

1635 
sbi
->
s_es_shršk”
.
sÿn_objeùs
 = 
ext4_es_sÿn
;

1636 
sbi
->
s_es_shršk”
.
couÁ_objeùs
 = 
ext4_es_couÁ
;

1637 
sbi
->
s_es_shršk”
.
£eks
 = 
DEFAULT_SEEKS
;

1638 
”r
 = 
	`»gi¡”_shršk”
(&
sbi
->
s_es_shršk”
);

1639 ià(
”r
)

1640 
”r4
;

1643 
”r4
:

1644 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_es_¡©s
.
es_¡©s_shk_út
);

1645 
”r3
:

1646 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_es_¡©s
.
es_¡©s_®l_út
);

1647 
”r2
:

1648 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_es_¡©s
.
es_¡©s_ÿche_mis£s
);

1649 
”r1
:

1650 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_es_¡©s
.
es_¡©s_ÿche_h™s
);

1651  
”r
;

1652 
	}
}

1654 
	$ext4_es_uÄegi¡”_shršk”
(
ext4_sb_šfo
 *
sbi
)

1656 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_es_¡©s
.
es_¡©s_ÿche_h™s
);

1657 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_es_¡©s
.
es_¡©s_ÿche_mis£s
);

1658 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_es_¡©s
.
es_¡©s_®l_út
);

1659 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_es_¡©s
.
es_¡©s_shk_út
);

1660 
	`uÄegi¡”_shršk”
(&
sbi
->
s_es_shršk”
);

1661 
	}
}

1671 
	$es_do_»şaim_ex‹Ás
(
ext4_šode_šfo
 *
ei
, 
ext4_lblk_t
 
’d
,

1672 *
Ä_to_sÿn
, *
Ä_shrunk
)

1674 
šode
 *šodğ&
ei
->
vfs_šode
;

1675 
ext4_es_Œ“
 *
Œ“
 = &
ei
->
i_es_Œ“
;

1676 
ex‹Á_¡©us
 *
es
;

1677 
rb_node
 *
node
;

1679 
es
 = 
	`__es_Œ“_£¬ch
(&
Œ“
->
roÙ
, 
ei
->
i_es_shršk_lblk
);

1680 ià(!
es
)

1681 
out_w¿p
;

1683 *
Ä_to_sÿn
 > 0) {

1684 ià(
es
->
es_lblk
 > 
’d
) {

1685 
ei
->
i_es_shršk_lblk
 = 
’d
 + 1;

1689 (*
Ä_to_sÿn
)--;

1690 
node
 = 
	`rb_Ãxt
(&
es
->
rb_node
);

1695 ià(
	`ext4_es_is_d–ayed
(
es
))

1696 
Ãxt
;

1697 ià(
	`ext4_es_is_»ã»nûd
(
es
)) {

1698 
	`ext4_es_ş—r_»ã»nûd
(
es
);

1699 
Ãxt
;

1702 
	`rb_”a£
(&
es
->
rb_node
, &
Œ“
->
roÙ
);

1703 
	`ext4_es_ä“_ex‹Á
(
šode
, 
es
);

1704 (*
Ä_shrunk
)++;

1705 
Ãxt
:

1706 ià(!
node
)

1707 
out_w¿p
;

1708 
es
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

1710 
ei
->
i_es_shršk_lblk
 = 
es
->
es_lblk
;

1712 
out_w¿p
:

1713 
ei
->
i_es_shršk_lblk
 = 0;

1715 
	}
}

1717 
	$es_»şaim_ex‹Ás
(
ext4_šode_šfo
 *
ei
, *
Ä_to_sÿn
)

1719 
šode
 *šodğ&
ei
->
vfs_šode
;

1720 
Ä_shrunk
 = 0;

1721 
ext4_lblk_t
 
¡¬t
 = 
ei
->
i_es_shršk_lblk
;

1722 
	`DEFINE_RATELIMIT_STATE
(
_rs
, 
DEFAULT_RATELIMIT_INTERVAL
,

1723 
DEFAULT_RATELIMIT_BURST
);

1725 ià(
ei
->
i_es_shk_Ä
 == 0)

1728 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_EXT_PRECACHED
) &&

1729 
	`__¿‹lim™
(&
_rs
))

1730 
	`ext4_w¬nšg
(
šode
->
i_sb
, "forced shrink of…recachedƒxtents");

1732 ià(!
	`es_do_»şaim_ex‹Ás
(
ei
, 
EXT_MAX_BLOCKS
, 
Ä_to_sÿn
, &
Ä_shrunk
) &&

1733 
¡¬t
 != 0)

1734 
	`es_do_»şaim_ex‹Ás
(
ei
, 
¡¬t
 - 1, 
Ä_to_sÿn
, &
Ä_shrunk
);

1736 
ei
->
i_es_Œ“
.
ÿche_es
 = 
NULL
;

1737  
Ä_shrunk
;

1738 
	}
}

1745 
	$ext4_ş—r_šode_es
(
šode
 *inode)

1747 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

1748 
ex‹Á_¡©us
 *
es
;

1749 
ext4_es_Œ“
 *
Œ“
;

1750 
rb_node
 *
node
;

1752 
	`wr™e_lock
(&
ei
->
i_es_lock
);

1753 
Œ“
 = &
	`EXT4_I
(
šode
)->
i_es_Œ“
;

1754 
Œ“
->
ÿche_es
 = 
NULL
;

1755 
node
 = 
	`rb_fœ¡
(&
Œ“
->
roÙ
);

1756 
node
) {

1757 
es
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

1758 
node
 = 
	`rb_Ãxt
(node);

1759 ià(!
	`ext4_es_is_d–ayed
(
es
)) {

1760 
	`rb_”a£
(&
es
->
rb_node
, &
Œ“
->
roÙ
);

1761 
	`ext4_es_ä“_ex‹Á
(
šode
, 
es
);

1764 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_EXT_PRECACHED
);

1765 
	`wr™e_uÆock
(&
ei
->
i_es_lock
);

1766 
	}
}

1768 #ifdeà
ES_DEBUG__


1769 
	$ext4_´št_³ndšg_Œ“
(
šode
 *inode)

1771 
ext4_³ndšg_Œ“
 *
Œ“
;

1772 
rb_node
 *
node
;

1773 
³ndšg_»£rv©iÚ
 *
´
;

1775 
	`´štk
(
KERN_DEBUG
 "³ndšg„e£rv©iÚ fÜ inod%lu:", 
šode
->
i_šo
);

1776 
Œ“
 = &
	`EXT4_I
(
šode
)->
i_³ndšg_Œ“
;

1777 
node
 = 
	`rb_fœ¡
(&
Œ“
->
roÙ
);

1778 
node
) {

1779 
´
 = 
	`rb_’Œy
(
node
, 
³ndšg_»£rv©iÚ
, 
rb_node
);

1780 
	`´štk
(
KERN_DEBUG
 " %u", 
´
->
lşu
);

1781 
node
 = 
	`rb_Ãxt
(node);

1783 
	`´štk
(
KERN_DEBUG
 "\n");

1784 
	}
}

1786 
	#ext4_´št_³ndšg_Œ“
(
šode
)

	)

1789 
__š™
 
	$ext4_š™_³ndšg
()

1791 
ext4_³ndšg_ÿch•
 = 
	`kmem_ÿche_ü—‹
("ext4_pending_reservation",

1792 (
³ndšg_»£rv©iÚ
),

1793 0, (
SLAB_RECLAIM_ACCOUNT
), 
NULL
);

1794 ià(
ext4_³ndšg_ÿch•
 =ğ
NULL
)

1795  -
ENOMEM
;

1797 
	}
}

1799 
	$ext4_ex™_³ndšg
()

1801 
	`kmem_ÿche_de¡roy
(
ext4_³ndšg_ÿch•
);

1802 
	}
}

1804 
	$ext4_š™_³ndšg_Œ“
(
ext4_³ndšg_Œ“
 *
Œ“
)

1806 
Œ“
->
roÙ
 = 
RB_ROOT
;

1807 
	}
}

1818 
³ndšg_»£rv©iÚ
 *
	$__g‘_³ndšg
(
šode
 *inode,

1819 
ext4_lblk_t
 
lşu
)

1821 
ext4_³ndšg_Œ“
 *
Œ“
;

1822 
rb_node
 *
node
;

1823 
³ndšg_»£rv©iÚ
 *
´
 = 
NULL
;

1825 
Œ“
 = &
	`EXT4_I
(
šode
)->
i_³ndšg_Œ“
;

1826 
node
 = (&
Œ“
->
roÙ
)->
rb_node
;

1828 
node
) {

1829 
´
 = 
	`rb_’Œy
(
node
, 
³ndšg_»£rv©iÚ
, 
rb_node
);

1830 ià(
lşu
 < 
´
->lclu)

1831 
node
 =‚ode->
rb_Ëá
;

1832 ià(
lşu
 > 
´
->lclu)

1833 
node
 =‚ode->
rb_right
;

1834 ià(
lşu
 =ğ
´
->lclu)

1835  
´
;

1837  
NULL
;

1838 
	}
}

1850 
	$__š£¹_³ndšg
(
šode
 *šode, 
ext4_lblk_t
 
lblk
)

1852 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

1853 
ext4_³ndšg_Œ“
 *
Œ“
 = &
	`EXT4_I
(
šode
)->
i_³ndšg_Œ“
;

1854 
rb_node
 **
p
 = &
Œ“
->
roÙ
.rb_node;

1855 
rb_node
 *
·»Á
 = 
NULL
;

1856 
³ndšg_»£rv©iÚ
 *
´
;

1857 
ext4_lblk_t
 
lşu
;

1858 
»t
 = 0;

1860 
lşu
 = 
	`EXT4_B2C
(
sbi
, 
lblk
);

1862 *
p
) {

1863 
·»Á
 = *
p
;

1864 
´
 = 
	`rb_’Œy
(
·»Á
, 
³ndšg_»£rv©iÚ
, 
rb_node
);

1866 ià(
lşu
 < 
´
->lclu) {

1867 
p
 = &(*p)->
rb_Ëá
;

1868 } ià(
lşu
 > 
´
->lclu) {

1869 
p
 = &(*p)->
rb_right
;

1872 
out
;

1876 
´
 = 
	`kmem_ÿche_®loc
(
ext4_³ndšg_ÿch•
, 
GFP_ATOMIC
);

1877 ià(
´
 =ğ
NULL
) {

1878 
»t
 = -
ENOMEM
;

1879 
out
;

1881 
´
->
lşu
 =†clu;

1883 
	`rb_lšk_node
(&
´
->
rb_node
, 
·»Á
, 
p
);

1884 
	`rb_š£¹_cŞÜ
(&
´
->
rb_node
, &
Œ“
->
roÙ
);

1886 
out
:

1887  
»t
;

1888 
	}
}

1899 
	$__»move_³ndšg
(
šode
 *šode, 
ext4_lblk_t
 
lblk
)

1901 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

1902 
³ndšg_»£rv©iÚ
 *
´
;

1903 
ext4_³ndšg_Œ“
 *
Œ“
;

1905 
´
 = 
	`__g‘_³ndšg
(
šode
, 
	`EXT4_B2C
(
sbi
, 
lblk
));

1906 ià(
´
 !ğ
NULL
) {

1907 
Œ“
 = &
	`EXT4_I
(
šode
)->
i_³ndšg_Œ“
;

1908 
	`rb_”a£
(&
´
->
rb_node
, &
Œ“
->
roÙ
);

1909 
	`kmem_ÿche_ä“
(
ext4_³ndšg_ÿch•
, 
´
);

1911 
	}
}

1922 
	$ext4_»move_³ndšg
(
šode
 *šode, 
ext4_lblk_t
 
lblk
)

1924 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

1926 
	`wr™e_lock
(&
ei
->
i_es_lock
);

1927 
	`__»move_³ndšg
(
šode
, 
lblk
);

1928 
	`wr™e_uÆock
(&
ei
->
i_es_lock
);

1929 
	}
}

1941 
boŞ
 
	$ext4_is_³ndšg
(
šode
 *šode, 
ext4_lblk_t
 
lblk
)

1943 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

1944 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

1945 
boŞ
 
»t
;

1947 
	`»ad_lock
(&
ei
->
i_es_lock
);

1948 
»t
 = (
boŞ
)(
	`__g‘_³ndšg
(
šode
, 
	`EXT4_B2C
(
sbi
, 
lblk
)è!ğ
NULL
);

1949 
	`»ad_uÆock
(&
ei
->
i_es_lock
);

1951  
»t
;

1952 
	}
}

1966 
	$ext4_es_š£¹_d–ayed_block
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

1967 
boŞ
 
®loÿ‹d
)

1969 
ex‹Á_¡©us
 
Ãwes
;

1970 
”r
 = 0;

1972 
	`es_debug
("add [%u/1) delayedoƒxtent statusree of inode %lu\n",

1973 
lblk
, 
šode
->
i_šo
);

1975 
Ãwes
.
es_lblk
 = 
lblk
;

1976 
Ãwes
.
es_Ën
 = 1;

1977 
	`ext4_es_¡Üe_pblock_¡©us
(&
Ãwes
, ~0, 
EXTENT_STATUS_DELAYED
);

1978 
	`Œaû_ext4_es_š£¹_d–ayed_block
(
šode
, &
Ãwes
, 
®loÿ‹d
);

1980 
	`ext4_es_š£¹_ex‹Á_check
(
šode
, &
Ãwes
);

1982 
	`wr™e_lock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

1984 
”r
 = 
	`__es_»move_ex‹Á
(
šode
, 
lblk
,†blk, 
NULL
);

1985 ià(
”r
 != 0)

1986 
”rÜ
;

1987 
»Œy
:

1988 
”r
 = 
	`__es_š£¹_ex‹Á
(
šode
, &
Ãwes
);

1989 ià(
”r
 =ğ-
ENOMEM
 && 
	`__es_shršk
(
	`EXT4_SB
(
šode
->
i_sb
),

1990 128, 
	`EXT4_I
(
šode
)))

1991 
»Œy
;

1992 ià(
”r
 != 0)

1993 
”rÜ
;

1995 ià(
®loÿ‹d
)

1996 
	`__š£¹_³ndšg
(
šode
, 
lblk
);

1998 
”rÜ
:

1999 
	`wr™e_uÆock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

2001 
	`ext4_es_´št_Œ“
(
šode
);

2002 
	`ext4_´št_³ndšg_Œ“
(
šode
);

2004  
”r
;

2005 
	}
}

2020 
	$__es_d–ayed_şu
(
šode
 *šode, 
ext4_lblk_t
 
¡¬t
,

2021 
ext4_lblk_t
 
’d
)

2023 
ext4_es_Œ“
 *
Œ“
 = &
	`EXT4_I
(
šode
)->
i_es_Œ“
;

2024 
ex‹Á_¡©us
 *
es
;

2025 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

2026 
rb_node
 *
node
;

2027 
ext4_lblk_t
 
fœ¡_lşu
, 
Ï¡_lşu
;

2028 
Ï¡_couÁed_lşu
;

2029 
n
 = 0;

2032 
Ï¡_couÁed_lşu
 = ~0ULL;

2034 
es
 = 
	`__es_Œ“_£¬ch
(&
Œ“
->
roÙ
, 
¡¬t
);

2036 
es
 && (es->
es_lblk
 <ğ
’d
)) {

2037 ià(
	`ext4_es_is_d–Úly
(
es
)) {

2038 ià(
es
->
es_lblk
 <ğ
¡¬t
)

2039 
fœ¡_lşu
 = 
	`EXT4_B2C
(
sbi
, 
¡¬t
);

2041 
fœ¡_lşu
 = 
	`EXT4_B2C
(
sbi
, 
es
->
es_lblk
);

2043 ià(
	`ext4_es_’d
(
es
è>ğ
’d
)

2044 
Ï¡_lşu
 = 
	`EXT4_B2C
(
sbi
, 
’d
);

2046 
Ï¡_lşu
 = 
	`EXT4_B2C
(
sbi
, 
	`ext4_es_’d
(
es
));

2048 ià(
fœ¡_lşu
 =ğ
Ï¡_couÁed_lşu
)

2049 
n
 +ğ
Ï¡_lşu
 - 
fœ¡_lşu
;

2051 
n
 +ğ
Ï¡_lşu
 - 
fœ¡_lşu
 + 1;

2052 
Ï¡_couÁed_lşu
 = 
Ï¡_lşu
;

2054 
node
 = 
	`rb_Ãxt
(&
es
->
rb_node
);

2055 ià(!
node
)

2057 
es
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

2060  
n
;

2061 
	}
}

2073 
	$ext4_es_d–ayed_şu
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

2074 
ext4_lblk_t
 
Ën
)

2076 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

2077 
ext4_lblk_t
 
’d
;

2078 
n
;

2080 ià(
Ën
 == 0)

2083 
’d
 = 
lblk
 + 
Ën
 - 1;

2084 
	`WARN_ON
(
’d
 < 
lblk
);

2086 
	`»ad_lock
(&
ei
->
i_es_lock
);

2088 
n
 = 
	`__es_d–ayed_şu
(
šode
, 
lblk
, 
’d
);

2090 
	`»ad_uÆock
(&
ei
->
i_es_lock
);

2092  
n
;

2093 
	}
}

2110 
	$__»vi£_³ndšg
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

2111 
ext4_lblk_t
 
Ën
)

2113 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

2114 
ext4_lblk_t
 
’d
 = 
lblk
 + 
Ën
 - 1;

2115 
ext4_lblk_t
 
fœ¡
, 
Ï¡
;

2116 
boŞ
 
f_d–
 = 
çl£
, 
l_d–
 = false;

2118 ià(
Ën
 == 0)

2134 ià(
	`EXT4_B2C
(
sbi
, 
lblk
è=ğEXT4_B2C(sbi, 
’d
)) {

2135 
fœ¡
 = 
	`EXT4_LBLK_CMASK
(
sbi
, 
lblk
);

2136 ià(
fœ¡
 !ğ
lblk
)

2137 
f_d–
 = 
	`__es_sÿn_¿nge
(
šode
, &
ext4_es_is_d–Úly
,

2138 
fœ¡
, 
lblk
 - 1);

2139 ià(
f_d–
) {

2140 
	`__š£¹_³ndšg
(
šode
, 
fœ¡
);

2142 
Ï¡
 = 
	`EXT4_LBLK_CMASK
(
sbi
, 
’d
) +

2143 
sbi
->
s_şu¡”_¿tio
 - 1;

2144 ià(
Ï¡
 !ğ
’d
)

2145 
l_d–
 = 
	`__es_sÿn_¿nge
(
šode
,

2146 &
ext4_es_is_d–Úly
,

2147 
’d
 + 1, 
Ï¡
);

2148 ià(
l_d–
)

2149 
	`__š£¹_³ndšg
(
šode
, 
Ï¡
);

2151 
	`__»move_³ndšg
(
šode
, 
Ï¡
);

2154 
fœ¡
 = 
	`EXT4_LBLK_CMASK
(
sbi
, 
lblk
);

2155 ià(
fœ¡
 !ğ
lblk
)

2156 
f_d–
 = 
	`__es_sÿn_¿nge
(
šode
, &
ext4_es_is_d–Úly
,

2157 
fœ¡
, 
lblk
 - 1);

2158 ià(
f_d–
)

2159 
	`__š£¹_³ndšg
(
šode
, 
fœ¡
);

2161 
	`__»move_³ndšg
(
šode
, 
fœ¡
);

2163 
Ï¡
 = 
	`EXT4_LBLK_CMASK
(
sbi
, 
’d
è+ sbi->
s_şu¡”_¿tio
 - 1;

2164 ià(
Ï¡
 !ğ
’d
)

2165 
l_d–
 = 
	`__es_sÿn_¿nge
(
šode
, &
ext4_es_is_d–Úly
,

2166 
’d
 + 1, 
Ï¡
);

2167 ià(
l_d–
)

2168 
	`__š£¹_³ndšg
(
šode
, 
Ï¡
);

2170 
	`__»move_³ndšg
(
šode
, 
Ï¡
);

2172 
	}
}

	@pxt4/extents_status.h

12 #iâdeà
_EXT4_EXTENTS_STATUS_H


13 
	#_EXT4_EXTENTS_STATUS_H


	)

18 #ifdeà
ES_DEBUG__


19 
	#es_debug
(
fmt
, ...è
	`´štk
(fmt, ##
__VA_ARGS__
)

	)

21 
	#es_debug
(
fmt
, ...è
	`no_´štk
(fmt, ##
__VA_ARGS__
)

	)

28 
	#ES_AGGRESSIVE_TEST__


	)

34 
	mES_WRITTEN_B
,

35 
	mES_UNWRITTEN_B
,

36 
	mES_DELAYED_B
,

37 
	mES_HOLE_B
,

38 
	mES_REFERENCED_B
,

39 
	mES_FLAGS


42 
	#ES_SHIFT
 ((
ext4_fsblk_t
)*8 - 
ES_FLAGS
)

	)

43 
	#ES_MASK
 (~((
ext4_fsblk_t
)0è<< 
ES_SHIFT
)

	)

45 
	#EXTENT_STATUS_WRITTEN
 (1 << 
ES_WRITTEN_B
)

	)

46 
	#EXTENT_STATUS_UNWRITTEN
 (1 << 
ES_UNWRITTEN_B
)

	)

47 
	#EXTENT_STATUS_DELAYED
 (1 << 
ES_DELAYED_B
)

	)

48 
	#EXTENT_STATUS_HOLE
 (1 << 
ES_HOLE_B
)

	)

49 
	#EXTENT_STATUS_REFERENCED
 (1 << 
ES_REFERENCED_B
)

	)

51 
	#ES_TYPE_MASK
 ((
ext4_fsblk_t
)(
EXTENT_STATUS_WRITTEN
 | \

52 
EXTENT_STATUS_UNWRITTEN
 | \

53 
EXTENT_STATUS_DELAYED
 | \

54 
EXTENT_STATUS_HOLE
è<< 
ES_SHIFT
)

	)

56 
	gext4_sb_šfo
;

57 
	gext4_ex‹Á
;

59 
	sex‹Á_¡©us
 {

60 
rb_node
 
	mrb_node
;

61 
ext4_lblk_t
 
	mes_lblk
;

62 
ext4_lblk_t
 
	mes_Ën
;

63 
ext4_fsblk_t
 
	mes_pblk
;

66 
	sext4_es_Œ“
 {

67 
rb_roÙ
 
	mroÙ
;

68 
ex‹Á_¡©us
 *
	mÿche_es
;

71 
	sext4_es_¡©s
 {

72 
	mes_¡©s_shrunk
;

73 
³rıu_couÁ”
 
	mes_¡©s_ÿche_h™s
;

74 
³rıu_couÁ”
 
	mes_¡©s_ÿche_mis£s
;

75 
u64
 
	mes_¡©s_sÿn_time
;

76 
u64
 
	mes_¡©s_max_sÿn_time
;

77 
³rıu_couÁ”
 
	mes_¡©s_®l_út
;

78 
³rıu_couÁ”
 
	mes_¡©s_shk_út
;

117 
	s³ndšg_»£rv©iÚ
 {

118 
rb_node
 
	mrb_node
;

119 
ext4_lblk_t
 
	mlşu
;

122 
	sext4_³ndšg_Œ“
 {

123 
rb_roÙ
 
	mroÙ
;

126 
__š™
 
ext4_š™_es
();

127 
ext4_ex™_es
();

128 
ext4_es_š™_Œ“
(
ext4_es_Œ“
 *
Œ“
);

130 
ext4_es_š£¹_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

131 
ext4_lblk_t
 
Ën
, 
ext4_fsblk_t
 
pblk
,

132 
¡©us
);

133 
ext4_es_ÿche_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

134 
ext4_lblk_t
 
Ën
, 
ext4_fsblk_t
 
pblk
,

135 
¡©us
);

136 
ext4_es_»move_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

137 
ext4_lblk_t
 
Ën
);

138 
ext4_es_fšd_ex‹Á_¿nge
(
šode
 *inode,

139 (*
m©ch_â
)(
ex‹Á_¡©us
 *
es
),

140 
ext4_lblk_t
 
lblk
,ƒxt4_lblk_ˆ
’d
,

141 
ex‹Á_¡©us
 *
es
);

142 
	`ext4_es_lookup_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

143 
ext4_lblk_t
 *
Ãxt_lblk
,

144 
ex‹Á_¡©us
 *
es
);

145 
boŞ
 
	`ext4_es_sÿn_¿nge
(
šode
 *inode,

146 (*
m©chšg_â
)(
ex‹Á_¡©us
 *
es
),

147 
ext4_lblk_t
 
lblk
,ƒxt4_lblk_ˆ
’d
);

148 
boŞ
 
	`ext4_es_sÿn_şu
(
šode
 *inode,

149 (*
m©chšg_â
)(
ex‹Á_¡©us
 *
es
),

150 
ext4_lblk_t
 
lblk
);

152 
šlše
 
	$ext4_es_¡©us
(
ex‹Á_¡©us
 *
es
)

154  
es
->
es_pblk
 >> 
ES_SHIFT
;

155 
	}
}

157 
šlše
 
	$ext4_es_ty³
(
ex‹Á_¡©us
 *
es
)

159  (
es
->
es_pblk
 & 
ES_TYPE_MASK
è>> 
ES_SHIFT
;

160 
	}
}

162 
šlše
 
	$ext4_es_is_wr™‹n
(
ex‹Á_¡©us
 *
es
)

164  (
	`ext4_es_ty³
(
es
è& 
EXTENT_STATUS_WRITTEN
) != 0;

165 
	}
}

167 
šlše
 
	$ext4_es_is_unwr™‹n
(
ex‹Á_¡©us
 *
es
)

169  (
	`ext4_es_ty³
(
es
è& 
EXTENT_STATUS_UNWRITTEN
) != 0;

170 
	}
}

172 
šlše
 
	$ext4_es_is_d–ayed
(
ex‹Á_¡©us
 *
es
)

174  (
	`ext4_es_ty³
(
es
è& 
EXTENT_STATUS_DELAYED
) != 0;

175 
	}
}

177 
šlše
 
	$ext4_es_is_hŞe
(
ex‹Á_¡©us
 *
es
)

179  (
	`ext4_es_ty³
(
es
è& 
EXTENT_STATUS_HOLE
) != 0;

180 
	}
}

182 
šlše
 
	$ext4_es_is_m­³d
(
ex‹Á_¡©us
 *
es
)

184  (
	`ext4_es_is_wr™‹n
(
es
è|| 
	`ext4_es_is_unwr™‹n
(es));

185 
	}
}

187 
šlše
 
	$ext4_es_is_d–Úly
(
ex‹Á_¡©us
 *
es
)

189  (
	`ext4_es_is_d–ayed
(
es
è&& !
	`ext4_es_is_unwr™‹n
(es));

190 
	}
}

192 
šlše
 
	$ext4_es_£t_»ã»nûd
(
ex‹Á_¡©us
 *
es
)

194 
es
->
es_pblk
 |ğ((
ext4_fsblk_t
)
EXTENT_STATUS_REFERENCED
è<< 
ES_SHIFT
;

195 
	}
}

197 
šlše
 
	$ext4_es_ş—r_»ã»nûd
(
ex‹Á_¡©us
 *
es
)

199 
es
->
es_pblk
 &ğ~(((
ext4_fsblk_t
)
EXTENT_STATUS_REFERENCED
è<< 
ES_SHIFT
);

200 
	}
}

202 
šlše
 
	$ext4_es_is_»ã»nûd
(
ex‹Á_¡©us
 *
es
)

204  (
	`ext4_es_¡©us
(
es
è& 
EXTENT_STATUS_REFERENCED
) != 0;

205 
	}
}

207 
šlše
 
ext4_fsblk_t
 
	$ext4_es_pblock
(
ex‹Á_¡©us
 *
es
)

209  
es
->
es_pblk
 & ~
ES_MASK
;

210 
	}
}

212 
šlše
 
	$ext4_es_¡Üe_pblock
(
ex‹Á_¡©us
 *
es
,

213 
ext4_fsblk_t
 
pb
)

215 
ext4_fsblk_t
 
block
;

217 
block
 = (
pb
 & ~
ES_MASK
è| (
es
->
es_pblk
 & ES_MASK);

218 
es
->
es_pblk
 = 
block
;

219 
	}
}

221 
šlše
 
	$ext4_es_¡Üe_¡©us
(
ex‹Á_¡©us
 *
es
,

222 
¡©us
)

224 
es
->
es_pblk
 = (((
ext4_fsblk_t
)
¡©us
 << 
ES_SHIFT
è& 
ES_MASK
) |

225 (
es
->
es_pblk
 & ~
ES_MASK
);

226 
	}
}

228 
šlše
 
	$ext4_es_¡Üe_pblock_¡©us
(
ex‹Á_¡©us
 *
es
,

229 
ext4_fsblk_t
 
pb
,

230 
¡©us
)

232 
es
->
es_pblk
 = (((
ext4_fsblk_t
)
¡©us
 << 
ES_SHIFT
è& 
ES_MASK
) |

233 (
pb
 & ~
ES_MASK
);

234 
	}
}

236 
ext4_es_»gi¡”_shršk”
(
ext4_sb_šfo
 *
sbi
);

237 
ext4_es_uÄegi¡”_shršk”
(
ext4_sb_šfo
 *
sbi
);

239 
ext4_£q_es_shršk”_šfo_show
(
£q_fe
 *
£q
, *
v
);

241 
__š™
 
ext4_š™_³ndšg
();

242 
ext4_ex™_³ndšg
();

243 
ext4_š™_³ndšg_Œ“
(
ext4_³ndšg_Œ“
 *
Œ“
);

244 
ext4_»move_³ndšg
(
šode
 *šode, 
ext4_lblk_t
 
lblk
);

245 
boŞ
 
ext4_is_³ndšg
(
šode
 *šode, 
ext4_lblk_t
 
lblk
);

246 
ext4_es_š£¹_d–ayed_block
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

247 
boŞ
 
®loÿ‹d
);

248 
ext4_es_d–ayed_şu
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

249 
ext4_lblk_t
 
Ën
);

250 
ext4_ş—r_šode_es
(
šode
 *inode);

	@pxt4/file.c

22 
	~<lšux/time.h
>

23 
	~<lšux/fs.h
>

24 
	~<lšux/iom­.h
>

25 
	~<lšux/mouÁ.h
>

26 
	~<lšux/·th.h
>

27 
	~<lšux/dax.h
>

28 
	~<lšux/quÙaİs.h
>

29 
	~<lšux/·gevec.h
>

30 
	~<lšux/uio.h
>

31 
	~<lšux/mmª.h
>

32 
	~"ext4.h
"

33 
	~"ext4_jbd2.h
"

34 
	~"x©Œ.h
"

35 
	~"aş.h
"

37 #ifdeà
CONFIG_FS_DAX


38 
ssize_t
 
	$ext4_dax_»ad_™”
(
kiocb
 *
iocb
, 
iov_™”
 *
to
)

40 
šode
 *šodğ
	`fe_šode
(
iocb
->
ki_fp
);

41 
ssize_t
 
»t
;

43 ià(!
	`šode_Œylock_sh¬ed
(
šode
)) {

44 ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
)

45  -
EAGAIN
;

46 
	`šode_lock_sh¬ed
(
šode
);

52 ià(!
	`IS_DAX
(
šode
)) {

53 
	`šode_uÆock_sh¬ed
(
šode
);

55  
	`g’”ic_fe_»ad_™”
(
iocb
, 
to
);

57 
»t
 = 
	`dax_iom­_rw
(
iocb
, 
to
, &
ext4_iom­_İs
);

58 
	`šode_uÆock_sh¬ed
(
šode
);

60 
	`fe_acûs£d
(
iocb
->
ki_fp
);

61  
»t
;

62 
	}
}

65 
ssize_t
 
	$ext4_fe_»ad_™”
(
kiocb
 *
iocb
, 
iov_™”
 *
to
)

67 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
	`fe_šode
(
iocb
->
ki_fp
)->
i_sb
))))

68  -
EIO
;

70 ià(!
	`iov_™”_couÁ
(
to
))

73 #ifdeà
CONFIG_FS_DAX


74 ià(
	`IS_DAX
(
	`fe_šode
(
iocb
->
ki_fp
)))

75  
	`ext4_dax_»ad_™”
(
iocb
, 
to
);

77  
	`g’”ic_fe_»ad_™”
(
iocb
, 
to
);

78 
	}
}

85 
	$ext4_»Ëa£_fe
(
šode
 *šode, 
fe
 *
fp
)

87 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_DA_ALLOC_CLOSE
)) {

88 
	`ext4_®loc_da_blocks
(
šode
);

89 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_DA_ALLOC_CLOSE
);

92 ià((
fp
->
f_mode
 & 
FMODE_WRITE
) &&

93 (
	`©omic_»ad
(&
šode
->
i_wr™ecouÁ
) == 1) &&

94 !
	`EXT4_I
(
šode
)->
i_»£rved_d©a_blocks
)

96 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

97 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

98 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

100 ià(
	`is_dx
(
šode
è&& 
fp
->
´iv©e_d©a
)

101 
	`ext4_hŒ“_ä“_dœ_šfo
(
fp
->
´iv©e_d©a
);

104 
	}
}

106 
	$ext4_unwr™‹n_wa™
(
šode
 *inode)

108 
wa™_queue_h—d_t
 *
wq
 = 
	`ext4_iÛnd_wq
(
šode
);

110 
	`wa™_ev’t
(*
wq
, (
	`©omic_»ad
(&
	`EXT4_I
(
šode
)->
i_unwr™‹n
) == 0));

111 
	}
}

123 
	$ext4_uÇligÃd_aio
(
šode
 *šode, 
iov_™”
 *
äom
, 
loff_t
 
pos
)

125 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

126 
blockmask
 = 
sb
->
s_blocksize
 - 1;

128 ià(
pos
 >ğ
	`ALIGN
(
	`i_size_»ad
(
šode
), 
sb
->
s_blocksize
))

131 ià((
pos
 | 
	`iov_™”_®ignm’t
(
äom
)è& 
blockmask
)

135 
	}
}

138 
boŞ
 
	$ext4_ov”wr™e_io
(
šode
 *šode, 
loff_t
 
pos
,†off_ˆ
Ën
)

140 
ext4_m­_blocks
 
m­
;

141 
blkb™s
 = 
šode
->
i_blkb™s
;

142 
”r
, 
blkËn
;

144 ià(
pos
 + 
Ën
 > 
	`i_size_»ad
(
šode
))

145  
çl£
;

147 
m­
.
m_lblk
 = 
pos
 >> 
blkb™s
;

148 
m­
.
m_Ën
 = 
	`EXT4_MAX_BLOCKS
(
Ën
, 
pos
, 
blkb™s
);

149 
blkËn
 = 
m­
.
m_Ën
;

151 
”r
 = 
	`ext4_m­_blocks
(
NULL
, 
šode
, &
m­
, 0);

157  
”r
 =ğ
blkËn
 && (
m­
.
m_æags
 & 
EXT4_MAP_MAPPED
);

158 
	}
}

160 
ssize_t
 
	$ext4_wr™e_checks
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
)

162 
šode
 *šodğ
	`fe_šode
(
iocb
->
ki_fp
);

163 
ssize_t
 
»t
;

165 
»t
 = 
	`g’”ic_wr™e_checks
(
iocb
, 
äom
);

166 ià(
»t
 <= 0)

167  
»t
;

169 ià(
	`uÆik–y
(
	`IS_IMMUTABLE
(
šode
)))

170  -
EPERM
;

176 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))) {

177 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

179 ià(
iocb
->
ki_pos
 >ğ
sbi
->
s_b™m­_maxby‹s
)

180  -
EFBIG
;

181 
	`iov_™”_Œunÿ‹
(
äom
, 
sbi
->
s_b™m­_maxby‹s
 - 
iocb
->
ki_pos
);

183  
	`iov_™”_couÁ
(
äom
);

184 
	}
}

186 #ifdeà
CONFIG_FS_DAX


187 
ssize_t


188 
	$ext4_dax_wr™e_™”
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
)

190 
šode
 *šodğ
	`fe_šode
(
iocb
->
ki_fp
);

191 
ssize_t
 
»t
;

193 ià(!
	`šode_Œylock
(
šode
)) {

194 ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
)

195  -
EAGAIN
;

196 
	`šode_lock
(
šode
);

198 
»t
 = 
	`ext4_wr™e_checks
(
iocb
, 
äom
);

199 ià(
»t
 <= 0)

200 
out
;

201 
»t
 = 
	`fe_»move_´ivs
(
iocb
->
ki_fp
);

202 ià(
»t
)

203 
out
;

204 
»t
 = 
	`fe_upd©e_time
(
iocb
->
ki_fp
);

205 ià(
»t
)

206 
out
;

208 
»t
 = 
	`dax_iom­_rw
(
iocb
, 
äom
, &
ext4_iom­_İs
);

209 
out
:

210 
	`šode_uÆock
(
šode
);

211 ià(
»t
 > 0)

212 
»t
 = 
	`g’”ic_wr™e_sync
(
iocb
,„et);

213  
»t
;

214 
	}
}

217 
ssize_t


218 
	$ext4_fe_wr™e_™”
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
)

220 
šode
 *šodğ
	`fe_šode
(
iocb
->
ki_fp
);

221 
o_dœeù
 = 
iocb
->
ki_æags
 & 
IOCB_DIRECT
;

222 
uÇligÃd_aio
 = 0;

223 
ov”wr™e
 = 0;

224 
ssize_t
 
»t
;

226 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

227  -
EIO
;

229 #ifdeà
CONFIG_FS_DAX


230 ià(
	`IS_DAX
(
šode
))

231  
	`ext4_dax_wr™e_™”
(
iocb
, 
äom
);

234 ià(!
	`šode_Œylock
(
šode
)) {

235 ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
)

236  -
EAGAIN
;

237 
	`šode_lock
(
šode
);

240 
»t
 = 
	`ext4_wr™e_checks
(
iocb
, 
äom
);

241 ià(
»t
 <= 0)

242 
out
;

249 ià(
o_dœeù
 && 
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
) &&

250 !
	`is_sync_kiocb
(
iocb
) &&

251 
	`ext4_uÇligÃd_aio
(
šode
, 
äom
, 
iocb
->
ki_pos
)) {

252 
uÇligÃd_aio
 = 1;

253 
	`ext4_unwr™‹n_wa™
(
šode
);

256 
iocb
->
´iv©e
 = &
ov”wr™e
;

258 ià(
o_dœeù
 && !
uÇligÃd_aio
) {

259 ià(
	`ext4_ov”wr™e_io
(
šode
, 
iocb
->
ki_pos
, 
	`iov_™”_couÁ
(
äom
))) {

260 ià(
	`ext4_should_diÜ—d_nŞock
(
šode
))

261 
ov”wr™e
 = 1;

262 } ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
) {

263 
»t
 = -
EAGAIN
;

264 
out
;

268 
»t
 = 
	`__g’”ic_fe_wr™e_™”
(
iocb
, 
äom
);

274 ià(
»t
 =ğ-
EIOCBQUEUED
 && 
uÇligÃd_aio
)

275 
	`ext4_unwr™‹n_wa™
(
šode
);

276 
	`šode_uÆock
(
šode
);

278 ià(
»t
 > 0)

279 
»t
 = 
	`g’”ic_wr™e_sync
(
iocb
,„et);

281  
»t
;

283 
out
:

284 
	`šode_uÆock
(
šode
);

285  
»t
;

286 
	}
}

288 #ifdeà
CONFIG_FS_DAX


289 
vm_çuÉ_t
 
	$ext4_dax_huge_çuÉ
(
vm_çuÉ
 *
vmf
,

290 
·ge_’Œy_size
 
³_size
)

292 
”rÜ
 = 0;

293 
vm_çuÉ_t
 
»suÉ
;

294 
»Œ›s
 = 0;

295 
hªdË_t
 *
hªdË
 = 
NULL
;

296 
šode
 *šodğ
	`fe_šode
(
vmf
->
vma
->
vm_fe
);

297 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

310 
boŞ
 
wr™e
 = (
vmf
->
æags
 & 
FAULT_FLAG_WRITE
) &&

311 (
vmf
->
vma
->
vm_æags
 & 
VM_SHARED
);

312 
pâ_t
 
pâ
;

314 ià(
wr™e
) {

315 
	`sb_¡¬t_·geçuÉ
(
sb
);

316 
	`fe_upd©e_time
(
vmf
->
vma
->
vm_fe
);

317 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

318 
»Œy
:

319 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_WRITE_PAGE
,

320 
	`EXT4_DATA_TRANS_BLOCKS
(
sb
));

321 ià(
	`IS_ERR
(
hªdË
)) {

322 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

323 
	`sb_’d_·geçuÉ
(
sb
);

324  
VM_FAULT_SIGBUS
;

327 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

329 
»suÉ
 = 
	`dax_iom­_çuÉ
(
vmf
, 
³_size
, &
pâ
, &
”rÜ
, &
ext4_iom­_İs
);

330 ià(
wr™e
) {

331 
	`ext4_jouº®_¡İ
(
hªdË
);

333 ià((
»suÉ
 & 
VM_FAULT_ERROR
è&& 
”rÜ
 =ğ-
ENOSPC
 &&

334 
	`ext4_should_»Œy_®loc
(
sb
, &
»Œ›s
))

335 
»Œy
;

337 ià(
»suÉ
 & 
VM_FAULT_NEEDDSYNC
)

338 
»suÉ
 = 
	`dax_fšish_sync_çuÉ
(
vmf
, 
³_size
, 
pâ
);

339 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

340 
	`sb_’d_·geçuÉ
(
sb
);

342 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

345  
»suÉ
;

346 
	}
}

348 
vm_çuÉ_t
 
	$ext4_dax_çuÉ
(
vm_çuÉ
 *
vmf
)

350  
	`ext4_dax_huge_çuÉ
(
vmf
, 
PE_SIZE_PTE
);

351 
	}
}

353 cÚ¡ 
vm_İ”©iÚs_¡ruù
 
	gext4_dax_vm_İs
 = {

354 .
çuÉ
 = 
ext4_dax_çuÉ
,

355 .
	ghuge_çuÉ
 = 
ext4_dax_huge_çuÉ
,

356 .
	g·ge_mkwr™e
 = 
ext4_dax_çuÉ
,

357 .
	gpâ_mkwr™e
 = 
ext4_dax_çuÉ
,

360 
	#ext4_dax_vm_İs
 
ext4_fe_vm_İs


	)

363 cÚ¡ 
vm_İ”©iÚs_¡ruù
 
	gext4_fe_vm_İs
 = {

364 .
çuÉ
 = 
ext4_fem­_çuÉ
,

365 .
	gm­_·ges
 = 
fem­_m­_·ges
,

366 .
	g·ge_mkwr™e
 = 
ext4_·ge_mkwr™e
,

369 
	$ext4_fe_mm­
(
fe
 *fe, 
vm_¬—_¡ruù
 *
vma
)

371 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

372 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

373 
dax_deviû
 *
dax_dev
 = 
sbi
->
s_daxdev
;

375 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
sbi
)))

376  -
EIO
;

382 ià(!
	`daxdev_m­pšg_suµÜ‹d
(
vma
, 
dax_dev
))

383  -
EOPNOTSUPP
;

385 
	`fe_acûs£d
(
fe
);

386 ià(
	`IS_DAX
(
	`fe_šode
(
fe
))) {

387 
vma
->
vm_İs
 = &
ext4_dax_vm_İs
;

388 
vma
->
vm_æags
 |ğ
VM_HUGEPAGE
;

390 
vma
->
vm_İs
 = &
ext4_fe_vm_İs
;

393 
	}
}

395 
	$ext4_§m¶e_Ï¡_mouÁed
(
su³r_block
 *
sb
,

396 
vfsmouÁ
 *
mÁ
)

398 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

399 
·th
…ath;

400 
buf
[64], *
ı
;

401 
hªdË_t
 *
hªdË
;

402 
”r
;

404 ià(
	`lik–y
(
sbi
->
s_mouÁ_æags
 & 
EXT4_MF_MNTDIR_SAMPLED
))

407 ià(
	`sb_rdÚly
(
sb
è|| !
	`sb_¡¬t_štwr™e_Œylock
(sb))

410 
sbi
->
s_mouÁ_æags
 |ğ
EXT4_MF_MNTDIR_SAMPLED
;

417 
	`mem£t
(
buf
, 0, (buf));

418 
·th
.
mÁ
 = mnt;

419 
·th
.
d’Œy
 = 
mÁ
->
mÁ_roÙ
;

420 
ı
 = 
	`d_·th
(&
·th
, 
buf
, (buf));

421 
”r
 = 0;

422 ià(
	`IS_ERR
(
ı
))

423 
out
;

425 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_MISC
, 1);

426 
”r
 = 
	`PTR_ERR
(
hªdË
);

427 ià(
	`IS_ERR
(
hªdË
))

428 
out
;

429 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

430 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
sbi
->
s_sbh
);

431 ià(
”r
)

432 
out_jouº®
;

433 
	`¡¾ıy
(
sbi
->
s_es
->
s_Ï¡_mouÁed
, 
ı
,

434 (
sbi
->
s_es
->
s_Ï¡_mouÁed
));

435 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
);

436 
out_jouº®
:

437 
	`ext4_jouº®_¡İ
(
hªdË
);

438 
out
:

439 
	`sb_’d_štwr™e
(
sb
);

440  
”r
;

441 
	}
}

443 
	$ext4_fe_İ’
(
šode
 * inode, 
fe
 * 
fp
)

445 
»t
;

447 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

448  -
EIO
;

450 
»t
 = 
	`ext4_§m¶e_Ï¡_mouÁed
(
šode
->
i_sb
, 
fp
->
f_·th
.
mÁ
);

451 ià(
»t
)

452  
»t
;

454 
»t
 = 
	`fsüy±_fe_İ’
(
šode
, 
fp
);

455 ià(
»t
)

456  
»t
;

458 
»t
 = 
	`fsv”™y_fe_İ’
(
šode
, 
fp
);

459 ià(
»t
)

460  
»t
;

466 ià(
fp
->
f_mode
 & 
FMODE_WRITE
) {

467 
»t
 = 
	`ext4_šode_©ch_jšode
(
šode
);

468 ià(
»t
 < 0)

469  
»t
;

472 
fp
->
f_mode
 |ğ
FMODE_NOWAIT
;

473  
	`dquÙ_fe_İ’
(
šode
, 
fp
);

474 
	}
}

481 
loff_t
 
	$ext4_Î£ek
(
fe
 *fe, 
loff_t
 
off£t
, 
wh’û
)

483 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

484 
loff_t
 
maxby‹s
;

486 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)))

487 
maxby‹s
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_b™m­_maxby‹s
;

489 
maxby‹s
 = 
šode
->
i_sb
->
s_maxby‹s
;

491 
wh’û
) {

493  
	`g’”ic_fe_Î£ek_size
(
fe
, 
off£t
, 
wh’û
,

494 
maxby‹s
, 
	`i_size_»ad
(
šode
));

495 
SEEK_HOLE
:

496 
	`šode_lock_sh¬ed
(
šode
);

497 
off£t
 = 
	`iom­_£ek_hŞe
(
šode
, off£t, &
ext4_iom­_İs
);

498 
	`šode_uÆock_sh¬ed
(
šode
);

500 
SEEK_DATA
:

501 
	`šode_lock_sh¬ed
(
šode
);

502 
off£t
 = 
	`iom­_£ek_d©a
(
šode
, off£t, &
ext4_iom­_İs
);

503 
	`šode_uÆock_sh¬ed
(
šode
);

507 ià(
off£t
 < 0)

508  
off£t
;

509  
	`vfs_£os
(
fe
, 
off£t
, 
maxby‹s
);

510 
	}
}

512 cÚ¡ 
fe_İ”©iÚs
 
	gext4_fe_İ”©iÚs
 = {

513 .
Î£ek
 = 
ext4_Î£ek
,

514 .
	g»ad_™”
 = 
ext4_fe_»ad_™”
,

515 .
	gwr™e_™”
 = 
ext4_fe_wr™e_™”
,

516 .
	guÆocked_ioùl
 = 
ext4_ioùl
,

517 #ifdeà
CONFIG_COMPAT


518 .
	gcom·t_ioùl
 = 
ext4_com·t_ioùl
,

520 .
	gmm­
 = 
ext4_fe_mm­
,

521 .
	gmm­_suµÜ‹d_æags
 = 
MAP_SYNC
,

522 .
	gİ’
 = 
ext4_fe_İ’
,

523 .
	g»Ëa£
 = 
ext4_»Ëa£_fe
,

524 .
	gfsync
 = 
ext4_sync_fe
,

525 .
	gg‘_unm­³d_¬—
 = 
thp_g‘_unm­³d_¬—
,

526 .
	g¥liû_»ad
 = 
g’”ic_fe_¥liû_»ad
,

527 .
	g¥liû_wr™e
 = 
™”_fe_¥liû_wr™e
,

528 .
	gçÎoÿ‹
 = 
ext4_çÎoÿ‹
,

531 cÚ¡ 
šode_İ”©iÚs
 
	gext4_fe_šode_İ”©iÚs
 = {

532 .
£‰r
 = 
ext4_£‰r
,

533 .
	gg‘©Œ
 = 
ext4_fe_g‘©Œ
,

534 .
	gli¡x©Œ
 = 
ext4_li¡x©Œ
,

535 .
	gg‘_aş
 = 
ext4_g‘_aş
,

536 .
	g£t_aş
 = 
ext4_£t_aş
,

537 .
	gf›m­
 = 
ext4_f›m­
,

	@pxt4/fsmap.c

7 
	~"ext4.h
"

8 
	~<lšux/fsm­.h
>

9 
	~"fsm­.h
"

10 
	~"mb®loc.h
"

11 
	~<lšux/sÜt.h
>

12 
	~<lšux/li¡_sÜt.h
>

13 
	~<Œaû/ev’ts/ext4.h
>

16 
	$ext4_fsm­_äom_š‹º®
(
su³r_block
 *
sb
, 
fsm­
 *
de¡
,

17 
ext4_fsm­
 *
¤c
)

19 
de¡
->
fmr_deviû
 = 
¤c
->fmr_device;

20 
de¡
->
fmr_æags
 = 
¤c
->fmr_flags;

21 
de¡
->
fmr_physiÿl
 = 
¤c
->fmr_physiÿÈ<< 
sb
->
s_blocksize_b™s
;

22 
de¡
->
fmr_owÃr
 = 
¤c
->fmr_owner;

23 
de¡
->
fmr_off£t
 = 0;

24 
de¡
->
fmr_Ëngth
 = 
¤c
->fmr_Ëngth << 
sb
->
s_blocksize_b™s
;

25 
de¡
->
fmr_»£rved
[0] = 0;

26 
de¡
->
fmr_»£rved
[1] = 0;

27 
de¡
->
fmr_»£rved
[2] = 0;

28 
	}
}

31 
	$ext4_fsm­_to_š‹º®
(
su³r_block
 *
sb
, 
ext4_fsm­
 *
de¡
,

32 
fsm­
 *
¤c
)

34 
de¡
->
fmr_deviû
 = 
¤c
->fmr_device;

35 
de¡
->
fmr_æags
 = 
¤c
->fmr_flags;

36 
de¡
->
fmr_physiÿl
 = 
¤c
->fmr_physiÿÈ>> 
sb
->
s_blocksize_b™s
;

37 
de¡
->
fmr_owÃr
 = 
¤c
->fmr_owner;

38 
de¡
->
fmr_Ëngth
 = 
¤c
->fmr_Ëngth >> 
sb
->
s_blocksize_b™s
;

39 
	}
}

42 
	sext4_g‘fsm­_šfo
 {

43 
ext4_fsm­_h—d
 *
	mgfi_h—d
;

44 
ext4_fsm­_fÜm©_t
 
	mgfi_fÜm©‹r
;

45 *
	mgfi_fÜm©_¬g
;

46 
ext4_fsblk_t
 
	mgfi_Ãxt_fsblk
;

47 
u32
 
	mgfi_dev
;

48 
ext4_group_t
 
	mgfi_agno
;

49 
ext4_fsm­
 
	mgfi_low
;

50 
ext4_fsm­
 
	mgfi_high
;

51 
ext4_fsm­
 
	mgfi_Ï¡ä“
;

52 
li¡_h—d
 
	mgfi_m‘a_li¡
;

53 
boŞ
 
	mgfi_Ï¡
;

57 
	sext4_g‘fsm­_dev
 {

58 (*
	mgfd_â
)(
su³r_block
 *
	msb
,

59 
ext4_fsm­
 *
	mkeys
,

60 
ext4_g‘fsm­_šfo
 *
	mšfo
);

61 
u32
 
	mgfd_dev
;

65 
	$ext4_g‘fsm­_dev_com·»
(cÚ¡ *
p1
, cÚ¡ *
p2
)

67 cÚ¡ 
ext4_g‘fsm­_dev
 *
d1
 = 
p1
;

68 cÚ¡ 
ext4_g‘fsm­_dev
 *
d2
 = 
p2
;

70  
d1
->
gfd_dev
 - 
d2
->gfd_dev;

71 
	}
}

74 
boŞ
 
	$ext4_g‘fsm­_»c_befÜe_low_key
(
ext4_g‘fsm­_šfo
 *
šfo
,

75 
ext4_fsm­
 *
»c
)

77  
»c
->
fmr_physiÿl
 < 
šfo
->
gfi_low
.fmr_physical;

78 
	}
}

84 
	$ext4_g‘fsm­_h–³r
(
su³r_block
 *
sb
,

85 
ext4_g‘fsm­_šfo
 *
šfo
,

86 
ext4_fsm­
 *
»c
)

88 
ext4_fsm­
 
fmr
;

89 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

90 
ext4_fsblk_t
 
»c_fsblk
 = 
»c
->
fmr_physiÿl
;

91 
ext4_group_t
 
agno
;

92 
ext4_g½blk_t
 
úo
;

93 
”rÜ
;

95 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

96  -
EINTR
;

102 ià(
	`ext4_g‘fsm­_»c_befÜe_low_key
(
šfo
, 
»c
)) {

103 
»c_fsblk
 +ğ
»c
->
fmr_Ëngth
;

104 ià(
šfo
->
gfi_Ãxt_fsblk
 < 
»c_fsblk
)

105 
šfo
->
gfi_Ãxt_fsblk
 = 
»c_fsblk
;

106  
EXT4_QUERY_RANGE_CONTINUE
;

110 ià(
šfo
->
gfi_h—d
->
fmh_couÁ
 == 0) {

111 ià(
»c_fsblk
 > 
šfo
->
gfi_Ãxt_fsblk
)

112 
šfo
->
gfi_h—d
->
fmh_’Œ›s
++;

114 ià(
šfo
->
gfi_Ï¡
)

115  
EXT4_QUERY_RANGE_CONTINUE
;

117 
šfo
->
gfi_h—d
->
fmh_’Œ›s
++;

119 
»c_fsblk
 +ğ
»c
->
fmr_Ëngth
;

120 ià(
šfo
->
gfi_Ãxt_fsblk
 < 
»c_fsblk
)

121 
šfo
->
gfi_Ãxt_fsblk
 = 
»c_fsblk
;

122  
EXT4_QUERY_RANGE_CONTINUE
;

130 ià(
»c_fsblk
 > 
šfo
->
gfi_Ãxt_fsblk
) {

131 ià(
šfo
->
gfi_h—d
->
fmh_’Œ›s
 >ğšfo->gfi_h—d->
fmh_couÁ
)

132  
EXT4_QUERY_RANGE_ABORT
;

134 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
šfo
->
gfi_Ãxt_fsblk
,

135 &
agno
, &
úo
);

136 
	`Œaû_ext4_fsm­_m­pšg
(
sb
, 
šfo
->
gfi_dev
, 
agno
,

137 
	`EXT4_C2B
(
sbi
, 
úo
),

138 
»c_fsblk
 - 
šfo
->
gfi_Ãxt_fsblk
,

139 
EXT4_FMR_OWN_UNKNOWN
);

141 
fmr
.
fmr_deviû
 = 
šfo
->
gfi_dev
;

142 
fmr
.
fmr_physiÿl
 = 
šfo
->
gfi_Ãxt_fsblk
;

143 
fmr
.
fmr_owÃr
 = 
EXT4_FMR_OWN_UNKNOWN
;

144 
fmr
.
fmr_Ëngth
 = 
»c_fsblk
 - 
šfo
->
gfi_Ãxt_fsblk
;

145 
fmr
.
fmr_æags
 = 
FMR_OF_SPECIAL_OWNER
;

146 
”rÜ
 = 
šfo
->
	`gfi_fÜm©‹r
(&
fmr
, info->
gfi_fÜm©_¬g
);

147 ià(
”rÜ
)

148  
”rÜ
;

149 
šfo
->
gfi_h—d
->
fmh_’Œ›s
++;

152 ià(
šfo
->
gfi_Ï¡
)

153 
out
;

156 ià(
šfo
->
gfi_h—d
->
fmh_’Œ›s
 >ğšfo->gfi_h—d->
fmh_couÁ
)

157  
EXT4_QUERY_RANGE_ABORT
;

159 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
»c_fsblk
, &
agno
, &
úo
);

160 
	`Œaû_ext4_fsm­_m­pšg
(
sb
, 
šfo
->
gfi_dev
, 
agno
, 
	`EXT4_C2B
(
sbi
, 
úo
),

161 
»c
->
fmr_Ëngth
,„ec->
fmr_owÃr
);

163 
fmr
.
fmr_deviû
 = 
šfo
->
gfi_dev
;

164 
fmr
.
fmr_physiÿl
 = 
»c_fsblk
;

165 
fmr
.
fmr_owÃr
 = 
»c
->fmr_owner;

166 
fmr
.
fmr_æags
 = 
FMR_OF_SPECIAL_OWNER
;

167 
fmr
.
fmr_Ëngth
 = 
»c
->fmr_length;

168 
”rÜ
 = 
šfo
->
	`gfi_fÜm©‹r
(&
fmr
, info->
gfi_fÜm©_¬g
);

169 ià(
”rÜ
)

170  
”rÜ
;

171 
šfo
->
gfi_h—d
->
fmh_’Œ›s
++;

173 
out
:

174 
»c_fsblk
 +ğ
»c
->
fmr_Ëngth
;

175 ià(
šfo
->
gfi_Ãxt_fsblk
 < 
»c_fsblk
)

176 
šfo
->
gfi_Ãxt_fsblk
 = 
»c_fsblk
;

177  
EXT4_QUERY_RANGE_CONTINUE
;

178 
	}
}

180 
šlše
 
ext4_fsblk_t
 
	$ext4_fsm­_Ãxt_pblk
(
ext4_fsm­
 *
fmr
)

182  
fmr
->
fmr_physiÿl
 + fmr->
fmr_Ëngth
;

183 
	}
}

186 
	$ext4_g‘fsm­_d©adev_h–³r
(
su³r_block
 *
sb
,

187 
ext4_group_t
 
agno
, 
ext4_g½blk_t
 
¡¬t
,

188 
ext4_g½blk_t
 
Ën
, *
´iv
)

190 
ext4_fsm­
 
œec
;

191 
ext4_g‘fsm­_šfo
 *
šfo
 = 
´iv
;

192 
ext4_fsm­
 *
p
;

193 
ext4_fsm­
 *
tmp
;

194 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

195 
ext4_fsblk_t
 
fsb
;

196 
ext4_fsblk_t
 
f¦’
;

197 
”rÜ
;

199 
fsb
 = (
	`EXT4_C2B
(
sbi
, 
¡¬t
è+ 
	`ext4_group_fœ¡_block_no
(
sb
, 
agno
));

200 
f¦’
 = 
	`EXT4_C2B
(
sbi
, 
Ën
);

203 ià(
šfo
->
gfi_Ï¡ä“
.
fmr_owÃr
) {

205 ià(
	`ext4_fsm­_Ãxt_pblk
(&
šfo
->
gfi_Ï¡ä“
è=ğ
fsb
) {

206 
šfo
->
gfi_Ï¡ä“
.
fmr_Ëngth
 +ğ
f¦’
;

214 
”rÜ
 = 
	`ext4_g‘fsm­_h–³r
(
sb
, 
šfo
, &šfo->
gfi_Ï¡ä“
);

215 ià(
”rÜ
)

216  
”rÜ
;

217 
šfo
->
gfi_Ï¡ä“
.
fmr_owÃr
 = 0;

221 
	`li¡_fÜ_—ch_’Œy_§ã
(
p
, 
tmp
, &
šfo
->
gfi_m‘a_li¡
, 
fmr_li¡
) {

222 ià(
p
->
fmr_physiÿl
 +…->
fmr_Ëngth
 <ğ
šfo
->
gfi_Ãxt_fsblk
) {

223 
	`li¡_d–
(&
p
->
fmr_li¡
);

224 
	`kä“
(
p
);

225 } ià(
p
->
fmr_physiÿl
 < 
fsb
) {

226 
”rÜ
 = 
	`ext4_g‘fsm­_h–³r
(
sb
, 
šfo
, 
p
);

227 ià(
”rÜ
)

228  
”rÜ
;

230 
	`li¡_d–
(&
p
->
fmr_li¡
);

231 
	`kä“
(
p
);

235 
œec
.
fmr_deviû
 = 0;

236 
œec
.
fmr_physiÿl
 = 
fsb
;

237 
œec
.
fmr_Ëngth
 = 
f¦’
;

238 
œec
.
fmr_owÃr
 = 
EXT4_FMR_OWN_FREE
;

239 
œec
.
fmr_æags
 = 0;

242 ià(
	`ext4_fsm­_Ãxt_pblk
(&
œec
) ==

243 
	`ext4_group_fœ¡_block_no
(
sb
, 
agno
 + 1)) {

244 
šfo
->
gfi_Ï¡ä“
 = 
œec
;

249  
	`ext4_g‘fsm­_h–³r
(
sb
, 
šfo
, &
œec
);

250 
	}
}

253 
	$ext4_g‘fsm­_logdev
(
su³r_block
 *
sb
, 
ext4_fsm­
 *
keys
,

254 
ext4_g‘fsm­_šfo
 *
šfo
)

256 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

257 
ext4_fsm­
 
œec
;

260 
šfo
->
gfi_low
 = 
keys
[0];

261 
šfo
->
gfi_low
.
fmr_Ëngth
 = 0;

263 
	`mem£t
(&
šfo
->
gfi_high
, 0xFF, (info->gfi_high));

265 
	`Œaû_ext4_fsm­_low_key
(
sb
, 
šfo
->
gfi_dev
, 0,

266 
šfo
->
gfi_low
.
fmr_physiÿl
,

267 
šfo
->
gfi_low
.
fmr_Ëngth
,

268 
šfo
->
gfi_low
.
fmr_owÃr
);

270 
	`Œaû_ext4_fsm­_high_key
(
sb
, 
šfo
->
gfi_dev
, 0,

271 
šfo
->
gfi_high
.
fmr_physiÿl
,

272 
šfo
->
gfi_high
.
fmr_Ëngth
,

273 
šfo
->
gfi_high
.
fmr_owÃr
);

275 ià(
keys
[0].
fmr_physiÿl
 > 0)

279 
œec
.
fmr_physiÿl
 = 
jouº®
->
j_blk_off£t
;

280 
œec
.
fmr_Ëngth
 = 
jouº®
->
j_maxËn
;

281 
œec
.
fmr_owÃr
 = 
EXT4_FMR_OWN_LOG
;

282 
œec
.
fmr_æags
 = 0;

284  
	`ext4_g‘fsm­_h–³r
(
sb
, 
šfo
, &
œec
);

285 
	}
}

288 
šlše
 
	$ext4_g‘fsm­_fl
(
li¡_h—d
 *
m‘a_li¡
,

289 
ext4_fsblk_t
 
fsb
,ƒxt4_fsblk_ˆ
Ën
,

290 
ušt64_t
 
owÃr
)

292 
ext4_fsm­
 *
fsm
;

294 
fsm
 = 
	`km®loc
((*fsm), 
GFP_NOFS
);

295 ià(!
fsm
)

296  -
ENOMEM
;

297 
fsm
->
fmr_deviû
 = 0;

298 
fsm
->
fmr_æags
 = 0;

299 
fsm
->
fmr_physiÿl
 = 
fsb
;

300 
fsm
->
fmr_owÃr
 = 
owÃr
;

301 
fsm
->
fmr_Ëngth
 = 
Ën
;

302 
	`li¡_add_
(&
fsm
->
fmr_li¡
, 
m‘a_li¡
);

305 
	}
}

311 
	$ext4_g‘fsm­_fšd_sb
(
su³r_block
 *
sb
,

312 
ext4_group_t
 
agno
,

313 
li¡_h—d
 *
m‘a_li¡
)

315 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

316 
ext4_fsblk_t
 
fsb
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
agno
);

317 
ext4_fsblk_t
 
Ën
;

318 
fœ¡_m‘a_bg
 = 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_m‘a_bg
);

319 
m‘agroup
 = 
agno
 / 
	`EXT4_DESC_PER_BLOCK
(
sb
);

320 
”rÜ
;

323 ià(
	`ext4_bg_has_su³r
(
sb
, 
agno
)) {

324 
”rÜ
 = 
	`ext4_g‘fsm­_fl
(
m‘a_li¡
, 
fsb
, 1, 
EXT4_FMR_OWN_FS
);

325 ià(
”rÜ
)

326  
”rÜ
;

327 
fsb
++;

331 
Ën
 = 
	`ext4_bg_num_gdb
(
sb
, 
agno
);

332 ià(!
Ën
)

334 
”rÜ
 = 
	`ext4_g‘fsm­_fl
(
m‘a_li¡
, 
fsb
, 
Ën
,

335 
EXT4_FMR_OWN_GDT
);

336 ià(
”rÜ
)

337  
”rÜ
;

338 
fsb
 +ğ
Ën
;

341 ià(!
	`ext4_has_ã©u»_m‘a_bg
(
sb
è|| 
m‘agroup
 < 
fœ¡_m‘a_bg
) {

342 
Ën
 = 
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_»£rved_gdt_blocks
);

343 
”rÜ
 = 
	`ext4_g‘fsm­_fl
(
m‘a_li¡
, 
fsb
, 
Ën
,

344 
EXT4_FMR_OWN_RESV_GDT
);

345 ià(
”rÜ
)

346  
”rÜ
;

350 
	}
}

353 
	$ext4_g‘fsm­_com·»
(*
´iv
,

354 
li¡_h—d
 *
a
,

355 
li¡_h—d
 *
b
)

357 
ext4_fsm­
 *
ç
;

358 
ext4_fsm­
 *
fb
;

360 
ç
 = 
	`cÚš”_of
(
a
, 
ext4_fsm­
, 
fmr_li¡
);

361 
fb
 = 
	`cÚš”_of
(
b
, 
ext4_fsm­
, 
fmr_li¡
);

362 ià(
ç
->
fmr_physiÿl
 < 
fb
->fmr_physical)

364 ià(
ç
->
fmr_physiÿl
 > 
fb
->fmr_physical)

367 
	}
}

370 
	$ext4_g‘fsm­_m”ge_fixed_m‘ad©a
(
li¡_h—d
 *
m‘a_li¡
)

372 
ext4_fsm­
 *
p
;

373 
ext4_fsm­
 *
´ev
 = 
NULL
;

374 
ext4_fsm­
 *
tmp
;

376 
	`li¡_fÜ_—ch_’Œy_§ã
(
p
, 
tmp
, 
m‘a_li¡
, 
fmr_li¡
) {

377 ià(!
´ev
) {

378 
´ev
 = 
p
;

382 ià(
´ev
->
fmr_owÃr
 =ğ
p
->fmr_owner &&

383 
´ev
->
fmr_physiÿl
 +…»v->
fmr_Ëngth
 =ğ
p
->fmr_physical) {

384 
´ev
->
fmr_Ëngth
 +ğ
p
->fmr_length;

385 
	`li¡_d–
(&
p
->
fmr_li¡
);

386 
	`kä“
(
p
);

388 
´ev
 = 
p
;

390 
	}
}

393 
	$ext4_g‘fsm­_ä“_fixed_m‘ad©a
(
li¡_h—d
 *
m‘a_li¡
)

395 
ext4_fsm­
 *
p
;

396 
ext4_fsm­
 *
tmp
;

398 
	`li¡_fÜ_—ch_’Œy_§ã
(
p
, 
tmp
, 
m‘a_li¡
, 
fmr_li¡
) {

399 
	`li¡_d–
(&
p
->
fmr_li¡
);

400 
	`kä“
(
p
);

402 
	}
}

405 
	$ext4_g‘fsm­_fšd_fixed_m‘ad©a
(
su³r_block
 *
sb
,

406 
li¡_h—d
 *
m‘a_li¡
)

408 
ext4_group_desc
 *
gdp
;

409 
ext4_group_t
 
agno
;

410 
”rÜ
;

412 
	`INIT_LIST_HEAD
(
m‘a_li¡
);

415 
agno
 = 0;‡gnØ< 
	`EXT4_SB
(
sb
)->
s_groups_couÁ
;‡gno++) {

416 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
agno
, 
NULL
);

417 ià(!
gdp
) {

418 
”rÜ
 = -
EFSCORRUPTED
;

419 
”r
;

423 
”rÜ
 = 
	`ext4_g‘fsm­_fšd_sb
(
sb
, 
agno
, 
m‘a_li¡
);

424 ià(
”rÜ
)

425 
”r
;

428 
”rÜ
 = 
	`ext4_g‘fsm­_fl
(
m‘a_li¡
,

429 
	`ext4_block_b™m­
(
sb
, 
gdp
), 1,

430 
EXT4_FMR_OWN_BLKBM
);

431 ià(
”rÜ
)

432 
”r
;

435 
”rÜ
 = 
	`ext4_g‘fsm­_fl
(
m‘a_li¡
,

436 
	`ext4_šode_b™m­
(
sb
, 
gdp
), 1,

437 
EXT4_FMR_OWN_INOBM
);

438 ià(
”rÜ
)

439 
”r
;

442 
”rÜ
 = 
	`ext4_g‘fsm­_fl
(
m‘a_li¡
,

443 
	`ext4_šode_bË
(
sb
, 
gdp
),

444 
	`EXT4_SB
(
sb
)->
s_™b_³r_group
,

445 
EXT4_FMR_OWN_INODES
);

446 ià(
”rÜ
)

447 
”r
;

451 
	`li¡_sÜt
(
NULL
, 
m‘a_li¡
, 
ext4_g‘fsm­_com·»
);

454 
	`ext4_g‘fsm­_m”ge_fixed_m‘ad©a
(
m‘a_li¡
);

457 
”r
:

458 
	`ext4_g‘fsm­_ä“_fixed_m‘ad©a
(
m‘a_li¡
);

459  
”rÜ
;

460 
	}
}

463 
	$ext4_g‘fsm­_d©adev
(
su³r_block
 *
sb
,

464 
ext4_fsm­
 *
keys
,

465 
ext4_g‘fsm­_šfo
 *
šfo
)

467 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

468 
ext4_fsblk_t
 
¡¬t_fsb
;

469 
ext4_fsblk_t
 
’d_fsb
;

470 
ext4_fsblk_t
 
bofs
;

471 
ext4_fsblk_t
 
eofs
;

472 
ext4_group_t
 
¡¬t_ag
;

473 
ext4_group_t
 
’d_ag
;

474 
ext4_g½blk_t
 
fœ¡_şu¡”
;

475 
ext4_g½blk_t
 
Ï¡_şu¡”
;

476 
”rÜ
 = 0;

478 
bofs
 = 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_d©a_block
);

479 
eofs
 = 
	`ext4_blocks_couÁ
(
sbi
->
s_es
);

480 ià(
keys
[0].
fmr_physiÿl
 >ğ
eofs
)

482 ià(
keys
[0].
fmr_physiÿl
 < 
bofs
)

483 
keys
[0].
fmr_physiÿl
 = 
bofs
;

484 ià(
keys
[1].
fmr_physiÿl
 >ğ
eofs
)

485 
keys
[1].
fmr_physiÿl
 = 
eofs
 - 1;

486 
¡¬t_fsb
 = 
keys
[0].
fmr_physiÿl
;

487 
’d_fsb
 = 
keys
[1].
fmr_physiÿl
;

490 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
¡¬t_fsb
, &
¡¬t_ag
, &
fœ¡_şu¡”
);

491 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
’d_fsb
, &
’d_ag
, &
Ï¡_şu¡”
);

498 
šfo
->
gfi_low
 = 
keys
[0];

499 
šfo
->
gfi_low
.
fmr_physiÿl
 = 
	`EXT4_C2B
(
sbi
, 
fœ¡_şu¡”
);

500 
šfo
->
gfi_low
.
fmr_Ëngth
 = 0;

502 
	`mem£t
(&
šfo
->
gfi_high
, 0xFF, (info->gfi_high));

505 
”rÜ
 = 
	`ext4_g‘fsm­_fšd_fixed_m‘ad©a
(
sb
, &
šfo
->
gfi_m‘a_li¡
);

506 ià(
”rÜ
)

507 
”r
;

510 
šfo
->
gfi_agno
 = 
¡¬t_ag
;

511 
šfo
->
gfi_agno
 <ğ
’d_ag
;

512 
šfo
->
gfi_agno
++) {

517 ià(
šfo
->
gfi_agno
 =ğ
’d_ag
) {

518 
šfo
->
gfi_high
 = 
keys
[1];

519 
šfo
->
gfi_high
.
fmr_physiÿl
 = 
	`EXT4_C2B
(
sbi
,

520 
Ï¡_şu¡”
);

521 
šfo
->
gfi_high
.
fmr_Ëngth
 = 0;

524 
	`Œaû_ext4_fsm­_low_key
(
sb
, 
šfo
->
gfi_dev
, info->
gfi_agno
,

525 
šfo
->
gfi_low
.
fmr_physiÿl
,

526 
šfo
->
gfi_low
.
fmr_Ëngth
,

527 
šfo
->
gfi_low
.
fmr_owÃr
);

529 
	`Œaû_ext4_fsm­_high_key
(
sb
, 
šfo
->
gfi_dev
, info->
gfi_agno
,

530 
šfo
->
gfi_high
.
fmr_physiÿl
,

531 
šfo
->
gfi_high
.
fmr_Ëngth
,

532 
šfo
->
gfi_high
.
fmr_owÃr
);

534 
”rÜ
 = 
	`ext4_mb®loc_qu”y_¿nge
(
sb
, 
šfo
->
gfi_agno
,

535 
	`EXT4_B2C
(
sbi
, 
šfo
->
gfi_low
.
fmr_physiÿl
),

536 
	`EXT4_B2C
(
sbi
, 
šfo
->
gfi_high
.
fmr_physiÿl
),

537 
ext4_g‘fsm­_d©adev_h–³r
, 
šfo
);

538 ià(
”rÜ
)

539 
”r
;

545 ià(
šfo
->
gfi_agno
 =ğ
¡¬t_ag
)

546 
	`mem£t
(&
šfo
->
gfi_low
, 0, (info->gfi_low));

550 ià(
šfo
->
gfi_Ï¡ä“
.
fmr_owÃr
) {

551 
”rÜ
 = 
	`ext4_g‘fsm­_h–³r
(
sb
, 
šfo
, &šfo->
gfi_Ï¡ä“
);

552 ià(
”rÜ
)

553 
”r
;

557 
šfo
->
gfi_Ï¡
 = 
Œue
;

558 
”rÜ
 = 
	`ext4_g‘fsm­_d©adev_h–³r
(
sb
, 
’d_ag
, 
Ï¡_şu¡”
, 0, 
šfo
);

559 ià(
”rÜ
)

560 
”r
;

562 
”r
:

563 
	`ext4_g‘fsm­_ä“_fixed_m‘ad©a
(&
šfo
->
gfi_m‘a_li¡
);

564  
”rÜ
;

565 
	}
}

568 
boŞ
 
	$ext4_g‘fsm­_is_v®id_deviû
(
su³r_block
 *
sb
,

569 
ext4_fsm­
 *
fm
)

571 ià(
fm
->
fmr_deviû
 =ğ0 || fm->fmr_deviû =ğ
UINT_MAX
 ||

572 
fm
->
fmr_deviû
 =ğ
	`Ãw_’code_dev
(
sb
->
s_bdev
->
bd_dev
))

573  
Œue
;

574 ià(
	`EXT4_SB
(
sb
)->
jouº®_bdev
 &&

575 
fm
->
fmr_deviû
 =ğ
	`Ãw_’code_dev
(
	`EXT4_SB
(
sb
)->
jouº®_bdev
->
bd_dev
))

576  
Œue
;

577  
çl£
;

578 
	}
}

581 
boŞ
 
	$ext4_g‘fsm­_check_keys
(
ext4_fsm­
 *
low_key
,

582 
ext4_fsm­
 *
high_key
)

584 ià(
low_key
->
fmr_deviû
 > 
high_key
->fmr_device)

585  
çl£
;

586 ià(
low_key
->
fmr_deviû
 < 
high_key
->fmr_device)

587  
Œue
;

589 ià(
low_key
->
fmr_physiÿl
 > 
high_key
->fmr_physical)

590  
çl£
;

591 ià(
low_key
->
fmr_physiÿl
 < 
high_key
->fmr_physical)

592  
Œue
;

594 ià(
low_key
->
fmr_owÃr
 > 
high_key
->fmr_owner)

595  
çl£
;

596 ià(
low_key
->
fmr_owÃr
 < 
high_key
->fmr_owner)

597  
Œue
;

599  
çl£
;

600 
	}
}

602 
	#EXT4_GETFSMAP_DEVS
 2

	)

624 
	$ext4_g‘fsm­
(
su³r_block
 *
sb
, 
ext4_fsm­_h—d
 *
h—d
,

625 
ext4_fsm­_fÜm©_t
 
fÜm©‹r
, *
¬g
)

627 
ext4_fsm­
 
dkeys
[2];

628 
ext4_g‘fsm­_dev
 
hªdËrs
[
EXT4_GETFSMAP_DEVS
];

629 
ext4_g‘fsm­_šfo
 
šfo
 = { 
NULL
 };

630 
i
;

631 
”rÜ
 = 0;

633 ià(
h—d
->
fmh_iæags
 & ~
FMH_IF_VALID
)

634  -
EINVAL
;

635 ià(!
	`ext4_g‘fsm­_is_v®id_deviû
(
sb
, &
h—d
->
fmh_keys
[0]) ||

636 !
	`ext4_g‘fsm­_is_v®id_deviû
(
sb
, &
h—d
->
fmh_keys
[1]))

637  -
EINVAL
;

639 
h—d
->
fmh_’Œ›s
 = 0;

642 
	`mem£t
(
hªdËrs
, 0, (handlers));

643 
hªdËrs
[0].
gfd_dev
 = 
	`Ãw_’code_dev
(
sb
->
s_bdev
->
bd_dev
);

644 
hªdËrs
[0].
gfd_â
 = 
ext4_g‘fsm­_d©adev
;

645 ià(
	`EXT4_SB
(
sb
)->
jouº®_bdev
) {

646 
hªdËrs
[1].
gfd_dev
 = 
	`Ãw_’code_dev
(

647 
	`EXT4_SB
(
sb
)->
jouº®_bdev
->
bd_dev
);

648 
hªdËrs
[1].
gfd_â
 = 
ext4_g‘fsm­_logdev
;

651 
	`sÜt
(
hªdËrs
, 
EXT4_GETFSMAP_DEVS
, (
ext4_g‘fsm­_dev
),

652 
ext4_g‘fsm­_dev_com·»
, 
NULL
);

665 
dkeys
[0] = 
h—d
->
fmh_keys
[0];

666 
dkeys
[0].
fmr_physiÿl
 +ğdkeys[0].
fmr_Ëngth
;

667 
dkeys
[0].
fmr_owÃr
 = 0;

668 
dkeys
[0].
fmr_Ëngth
 = 0;

669 
	`mem£t
(&
dkeys
[1], 0xFF, (
ext4_fsm­
));

671 ià(!
	`ext4_g‘fsm­_check_keys
(
dkeys
, &
h—d
->
fmh_keys
[1]))

672  -
EINVAL
;

674 
šfo
.
gfi_Ãxt_fsblk
 = 
h—d
->
fmh_keys
[0].
fmr_physiÿl
 +

675 
h—d
->
fmh_keys
[0].
fmr_Ëngth
;

676 
šfo
.
gfi_fÜm©‹r
 = 
fÜm©‹r
;

677 
šfo
.
gfi_fÜm©_¬g
 = 
¬g
;

678 
šfo
.
gfi_h—d
 = 
h—d
;

681 
i
 = 0; i < 
EXT4_GETFSMAP_DEVS
; i++) {

683 ià(!
hªdËrs
[
i
].
gfd_â
)

685 ià(
h—d
->
fmh_keys
[0].
fmr_deviû
 > 
hªdËrs
[
i
].
gfd_dev
)

687 ià(
h—d
->
fmh_keys
[1].
fmr_deviû
 < 
hªdËrs
[
i
].
gfd_dev
)

697 ià(
hªdËrs
[
i
].
gfd_dev
 =ğ
h—d
->
fmh_keys
[1].
fmr_deviû
)

698 
dkeys
[1] = 
h—d
->
fmh_keys
[1];

699 ià(
hªdËrs
[
i
].
gfd_dev
 > 
h—d
->
fmh_keys
[0].
fmr_deviû
)

700 
	`mem£t
(&
dkeys
[0], 0, (
ext4_fsm­
));

702 
šfo
.
gfi_dev
 = 
hªdËrs
[
i
].
gfd_dev
;

703 
šfo
.
gfi_Ï¡
 = 
çl£
;

704 
šfo
.
gfi_agno
 = -1;

705 
”rÜ
 = 
hªdËrs
[
i
].
	`gfd_â
(
sb
, 
dkeys
, &
šfo
);

706 ià(
”rÜ
)

708 
šfo
.
gfi_Ãxt_fsblk
 = 0;

711 
h—d
->
fmh_oæags
 = 
FMH_OF_DEV_T
;

712  
”rÜ
;

713 
	}
}

	@pxt4/fsmap.h

7 #iâdeà
__EXT4_FSMAP_H__


8 
	#__EXT4_FSMAP_H__


	)

10 
	gfsm­
;

13 
	sext4_fsm­
 {

14 
li¡_h—d
 
	mfmr_li¡
;

15 
dev_t
 
	mfmr_deviû
;

16 
ušt32_t
 
	mfmr_æags
;

17 
ušt64_t
 
	mfmr_physiÿl
;

18 
ušt64_t
 
	mfmr_owÃr
;

19 
ušt64_t
 
	mfmr_Ëngth
;

22 
	sext4_fsm­_h—d
 {

23 
ušt32_t
 
	mfmh_iæags
;

24 
ušt32_t
 
	mfmh_oæags
;

25 
	mfmh_couÁ
;

26 
	mfmh_’Œ›s
;

28 
ext4_fsm­
 
	mfmh_keys
[2];

31 
ext4_fsm­_äom_š‹º®
(
su³r_block
 *
sb
, 
fsm­
 *
de¡
,

32 
ext4_fsm­
 *
¤c
);

33 
ext4_fsm­_to_š‹º®
(
su³r_block
 *
sb
, 
ext4_fsm­
 *
de¡
,

34 
fsm­
 *
¤c
);

37 (*
	text4_fsm­_fÜm©_t
)(
	text4_fsm­
 *, *);

39 
	`ext4_g‘fsm­
(
su³r_block
 *
sb
, 
ext4_fsm­_h—d
 *
h—d
,

40 
ext4_fsm­_fÜm©_t
 
fÜm©‹r
, *
¬g
);

42 
	#EXT4_QUERY_RANGE_ABORT
 1

	)

43 
	#EXT4_QUERY_RANGE_CONTINUE
 0

	)

46 
	#EXT4_FMR_OWN_FREE
 
FMR_OWN_FREE


	)

47 
	#EXT4_FMR_OWN_UNKNOWN
 
FMR_OWN_UNKNOWN


	)

48 
	#EXT4_FMR_OWN_FS
 
	`FMR_OWNER
('X', 1è

	)

49 
	#EXT4_FMR_OWN_LOG
 
	`FMR_OWNER
('X', 2è

	)

50 
	#EXT4_FMR_OWN_INODES
 
	`FMR_OWNER
('X', 5è

	)

51 
	#EXT4_FMR_OWN_GDT
 
	`FMR_OWNER
('f', 1è

	)

52 
	#EXT4_FMR_OWN_RESV_GDT
 
	`FMR_OWNER
('f', 2è

	)

53 
	#EXT4_FMR_OWN_BLKBM
 
	`FMR_OWNER
('f', 3è

	)

54 
	#EXT4_FMR_OWN_INOBM
 
	`FMR_OWNER
('f', 4è

	)

	@pxt4/fsync.c

26 
	~<lšux/time.h
>

27 
	~<lšux/fs.h
>

28 
	~<lšux/sched.h
>

29 
	~<lšux/wr™eback.h
>

30 
	~<lšux/blkdev.h
>

32 
	~"ext4.h
"

33 
	~"ext4_jbd2.h
"

35 
	~<Œaû/ev’ts/ext4.h
>

45 
	$ext4_sync_·»Á
(
šode
 *inode)

47 
d’Œy
 *d’Œy = 
NULL
;

48 
šode
 *
Ãxt
;

49 
»t
 = 0;

51 ià(!
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NEWENTRY
))

53 
šode
 = 
	`ig¿b
(inode);

54 
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NEWENTRY
)) {

55 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_NEWENTRY
);

56 
d’Œy
 = 
	`d_fšd_ªy_®Ÿs
(
šode
);

57 ià(!
d’Œy
)

59 
Ãxt
 = 
	`ig¿b
(
	`d_šode
(
d’Œy
->
d_·»Á
));

60 
	`dput
(
d’Œy
);

61 ià(!
Ãxt
)

63 
	`ut
(
šode
);

64 
šode
 = 
Ãxt
;

72 
»t
 = 
	`sync_m­pšg_bufãrs
(
šode
->
i_m­pšg
);

73 ià(
»t
)

75 
»t
 = 
	`sync_šode_m‘ad©a
(
šode
, 1);

76 ià(
»t
)

79 
	`ut
(
šode
);

80  
»t
;

81 
	}
}

95 
	$ext4_sync_fe
(
fe
 *fe, 
loff_t
 
¡¬t
,†off_ˆ
’d
, 
d©async
)

97 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

98 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

99 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
;

100 
»t
 = 0, 
”r
;

101 
tid_t
 
comm™_tid
;

102 
boŞ
 
Ãeds_b¬r›r
 = 
çl£
;

104 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

105  -
EIO
;

107 
	`J_ASSERT
(
	`ext4_jouº®_cu¼’t_hªdË
(è=ğ
NULL
);

109 
	`Œaû_ext4_sync_fe_’‹r
(
fe
, 
d©async
);

111 ià(
	`sb_rdÚly
(
šode
->
i_sb
)) {

113 
	`smp_rmb
();

114 ià(
	`EXT4_SB
(
šode
->
i_sb
)->
s_mouÁ_æags
 & 
EXT4_MF_FS_ABORTED
)

115 
»t
 = -
EROFS
;

116 
out
;

119 ià(!
jouº®
) {

120 
»t
 = 
	`__g’”ic_fe_fsync
(
fe
, 
¡¬t
, 
’d
, 
d©async
);

121 ià(!
»t
)

122 
»t
 = 
	`ext4_sync_·»Á
(
šode
);

123 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
BARRIER
))

124 
issue_æush
;

125 
out
;

128 
»t
 = 
	`fe_wr™e_ªd_wa™_¿nge
(
fe
, 
¡¬t
, 
’d
);

129 ià(
»t
)

130  
»t
;

145 ià(
	`ext4_should_jouº®_d©a
(
šode
)) {

146 
»t
 = 
	`ext4_fÜû_comm™
(
šode
->
i_sb
);

147 
out
;

150 
comm™_tid
 = 
d©async
 ? 
ei
->
i_d©async_tid
 :ƒi->
i_sync_tid
;

151 ià(
jouº®
->
j_æags
 & 
JBD2_BARRIER
 &&

152 !
	`jbd2_Œªs_wl_£nd_d©a_b¬r›r
(
jouº®
, 
comm™_tid
))

153 
Ãeds_b¬r›r
 = 
Œue
;

154 
»t
 = 
	`jbd2_com¶‘e_Œª§ùiÚ
(
jouº®
, 
comm™_tid
);

155 ià(
Ãeds_b¬r›r
) {

156 
issue_æush
:

157 
”r
 = 
	`blkdev_issue_æush
(
šode
->
i_sb
->
s_bdev
, 
GFP_KERNEL
, 
NULL
);

158 ià(!
»t
)

159 
»t
 = 
”r
;

161 
out
:

162 
”r
 = 
	`fe_check_ªd_advªû_wb_”r
(
fe
);

163 ià(
»t
 == 0)

164 
»t
 = 
”r
;

165 
	`Œaû_ext4_sync_fe_ex™
(
šode
, 
»t
);

166  
»t
;

167 
	}
}

	@pxt4/hash.c

8 
	~<lšux/fs.h
>

9 
	~<lšux/unicode.h
>

10 
	~<lšux/comp”.h
>

11 
	~<lšux/b™İs.h
>

12 
	~"ext4.h
"

14 
	#DELTA
 0x9E3779B9

	)

16 
	$TEA_ŒªsfÜm
(
__u32
 
buf
[4], __u32 cÚ¡ 
š
[])

18 
__u32
 
sum
 = 0;

19 
__u32
 
b0
 = 
buf
[0], 
b1
 = buf[1];

20 
__u32
 
a
 = 
š
[0], 
b
 = in[1], 
c
 = in[2], 
d
 = in[3];

21 
n
 = 16;

24 
sum
 +ğ
DELTA
;

25 
b0
 +ğ((
b1
 << 4)+
a
è^ (b1+
sum
è^ ((b1 >> 5)+
b
);

26 
b1
 +ğ((
b0
 << 4)+
c
è^ (b0+
sum
è^ ((b0 >> 5)+
d
);

27 } --
n
);

29 
buf
[0] +ğ
b0
;

30 
buf
[1] +ğ
b1
;

31 
	}
}

34 
	#F
(
x
, 
y
, 
z
è((zè^ ((xè& ((yè^ (z))))

	)

35 
	#G
(
x
, 
y
, 
z
è(((xè& (y)è+ (((xè^ (y)è& (z)))

	)

36 
	#H
(
x
, 
y
, 
z
è((xè^ (yè^ (z))

	)

44 
	#ROUND
(
f
, 
a
, 
b
, 
c
, 
d
, 
x
, 
s
) \

45 (
a
 +ğ
	`f
(
b
, 
c
, 
d
è+ 
x
,‡ = 
	`rŞ32
×, 
s
))

	)

46 
	#K1
 0

	)

47 
	#K2
 013240474631UL

	)

48 
	#K3
 015666365641UL

	)

53 
__u32
 
	$h®f_md4_ŒªsfÜm
(
__u32
 
buf
[4], __u32 cÚ¡ 
š
[8])

55 
__u32
 
a
 = 
buf
[0], 
b
 = buf[1], 
c
 = buf[2], 
d
 = buf[3];

58 
	`ROUND
(
F
, 
a
, 
b
, 
c
, 
d
, 
š
[0] + 
K1
, 3);

59 
	`ROUND
(
F
, 
d
, 
a
, 
b
, 
c
, 
š
[1] + 
K1
, 7);

60 
	`ROUND
(
F
, 
c
, 
d
, 
a
, 
b
, 
š
[2] + 
K1
, 11);

61 
	`ROUND
(
F
, 
b
, 
c
, 
d
, 
a
, 
š
[3] + 
K1
, 19);

62 
	`ROUND
(
F
, 
a
, 
b
, 
c
, 
d
, 
š
[4] + 
K1
, 3);

63 
	`ROUND
(
F
, 
d
, 
a
, 
b
, 
c
, 
š
[5] + 
K1
, 7);

64 
	`ROUND
(
F
, 
c
, 
d
, 
a
, 
b
, 
š
[6] + 
K1
, 11);

65 
	`ROUND
(
F
, 
b
, 
c
, 
d
, 
a
, 
š
[7] + 
K1
, 19);

68 
	`ROUND
(
G
, 
a
, 
b
, 
c
, 
d
, 
š
[1] + 
K2
, 3);

69 
	`ROUND
(
G
, 
d
, 
a
, 
b
, 
c
, 
š
[3] + 
K2
, 5);

70 
	`ROUND
(
G
, 
c
, 
d
, 
a
, 
b
, 
š
[5] + 
K2
, 9);

71 
	`ROUND
(
G
, 
b
, 
c
, 
d
, 
a
, 
š
[7] + 
K2
, 13);

72 
	`ROUND
(
G
, 
a
, 
b
, 
c
, 
d
, 
š
[0] + 
K2
, 3);

73 
	`ROUND
(
G
, 
d
, 
a
, 
b
, 
c
, 
š
[2] + 
K2
, 5);

74 
	`ROUND
(
G
, 
c
, 
d
, 
a
, 
b
, 
š
[4] + 
K2
, 9);

75 
	`ROUND
(
G
, 
b
, 
c
, 
d
, 
a
, 
š
[6] + 
K2
, 13);

78 
	`ROUND
(
H
, 
a
, 
b
, 
c
, 
d
, 
š
[3] + 
K3
, 3);

79 
	`ROUND
(
H
, 
d
, 
a
, 
b
, 
c
, 
š
[7] + 
K3
, 9);

80 
	`ROUND
(
H
, 
c
, 
d
, 
a
, 
b
, 
š
[2] + 
K3
, 11);

81 
	`ROUND
(
H
, 
b
, 
c
, 
d
, 
a
, 
š
[6] + 
K3
, 15);

82 
	`ROUND
(
H
, 
a
, 
b
, 
c
, 
d
, 
š
[1] + 
K3
, 3);

83 
	`ROUND
(
H
, 
d
, 
a
, 
b
, 
c
, 
š
[5] + 
K3
, 9);

84 
	`ROUND
(
H
, 
c
, 
d
, 
a
, 
b
, 
š
[0] + 
K3
, 11);

85 
	`ROUND
(
H
, 
b
, 
c
, 
d
, 
a
, 
š
[4] + 
K3
, 15);

87 
buf
[0] +ğ
a
;

88 
buf
[1] +ğ
b
;

89 
buf
[2] +ğ
c
;

90 
buf
[3] +ğ
d
;

92  
buf
[1];

93 
	}
}

94 #undeà
ROUND


95 #undeà
K1


96 #undeà
K2


97 #undeà
K3


98 #undeà
F


99 #undeà
G


100 #undeà
H


103 
__u32
 
	$dx_hack_hash_unsigÃd
(cÚ¡ *
Çme
, 
Ën
)

105 
__u32
 
hash
, 
hash0
 = 0x12a3ã2d, 
hash1
 = 0x37abe8f9;

106 cÚ¡ *
uı
 = (cÚ¡ *è
Çme
;

108 
Ën
--) {

109 
hash
 = 
hash1
 + (
hash0
 ^ (((è*
uı
++) * 7152373));

111 ià(
hash
 & 0x80000000)

112 
hash
 -= 0x7fffffff;

113 
hash1
 = 
hash0
;

114 
hash0
 = 
hash
;

116  
hash0
 << 1;

117 
	}
}

119 
__u32
 
	$dx_hack_hash_sigÃd
(cÚ¡ *
Çme
, 
Ën
)

121 
__u32
 
hash
, 
hash0
 = 0x12a3ã2d, 
hash1
 = 0x37abe8f9;

122 cÚ¡ sigÃd *
sı
 = (cÚ¡ sigÃd *è
Çme
;

124 
Ën
--) {

125 
hash
 = 
hash1
 + (
hash0
 ^ (((è*
sı
++) * 7152373));

127 ià(
hash
 & 0x80000000)

128 
hash
 -= 0x7fffffff;

129 
hash1
 = 
hash0
;

130 
hash0
 = 
hash
;

132  
hash0
 << 1;

133 
	}
}

135 
	$¡r2hashbuf_sigÃd
(cÚ¡ *
msg
, 
Ën
, 
__u32
 *
buf
, 
num
)

137 
__u32
 
·d
, 
v®
;

138 
i
;

139 cÚ¡ sigÃd *
sı
 = (cÚ¡ sigÃd *è
msg
;

141 
·d
 = (
__u32
)
Ën
 | ((__u32)len << 8);

142 
·d
 |=…ad << 16;

144 
v®
 = 
·d
;

145 ià(
Ën
 > 
num
*4)

146 
Ën
 = 
num
 * 4;

147 
i
 = 0; i < 
Ën
; i++) {

148 
v®
 = ((è
sı
[
i
]) + (val << 8);

149 ià((
i
 % 4) == 3) {

150 *
buf
++ = 
v®
;

151 
v®
 = 
·d
;

152 
num
--;

155 ià(--
num
 >= 0)

156 *
buf
++ = 
v®
;

157 --
num
 >= 0)

158 *
buf
++ = 
·d
;

159 
	}
}

161 
	$¡r2hashbuf_unsigÃd
(cÚ¡ *
msg
, 
Ën
, 
__u32
 *
buf
, 
num
)

163 
__u32
 
·d
, 
v®
;

164 
i
;

165 cÚ¡ *
uı
 = (cÚ¡ *è
msg
;

167 
·d
 = (
__u32
)
Ën
 | ((__u32)len << 8);

168 
·d
 |=…ad << 16;

170 
v®
 = 
·d
;

171 ià(
Ën
 > 
num
*4)

172 
Ën
 = 
num
 * 4;

173 
i
 = 0; i < 
Ën
; i++) {

174 
v®
 = ((è
uı
[
i
]) + (val << 8);

175 ià((
i
 % 4) == 3) {

176 *
buf
++ = 
v®
;

177 
v®
 = 
·d
;

178 
num
--;

181 ià(--
num
 >= 0)

182 *
buf
++ = 
v®
;

183 --
num
 >= 0)

184 *
buf
++ = 
·d
;

185 
	}
}

200 
	$__ext4fs_dœhash
(cÚ¡ *
Çme
, 
Ën
,

201 
dx_hash_šfo
 *
hšfo
)

203 
__u32
 
hash
;

204 
__u32
 
mšÜ_hash
 = 0;

205 cÚ¡ *
p
;

206 
i
;

207 
__u32
 
š
[8], 
buf
[4];

208 (*
¡r2hashbuf
)(cÚ¡ *, , 
__u32
 *, ) =

209 
¡r2hashbuf_sigÃd
;

212 
buf
[0] = 0x67452301;

213 
buf
[1] = 0xefcdab89;

214 
buf
[2] = 0x98badcfe;

215 
buf
[3] = 0x10325476;

218 ià(
hšfo
->
£ed
) {

219 
i
 = 0; i < 4; i++) {

220 ià(
hšfo
->
£ed
[
i
]) {

221 
	`memıy
(
buf
, 
hšfo
->
£ed
, (buf));

227 
hšfo
->
hash_v”siÚ
) {

228 
DX_HASH_LEGACY_UNSIGNED
:

229 
hash
 = 
	`dx_hack_hash_unsigÃd
(
Çme
, 
Ën
);

231 
DX_HASH_LEGACY
:

232 
hash
 = 
	`dx_hack_hash_sigÃd
(
Çme
, 
Ën
);

234 
DX_HASH_HALF_MD4_UNSIGNED
:

235 
¡r2hashbuf
 = 
¡r2hashbuf_unsigÃd
;

237 
DX_HASH_HALF_MD4
:

238 
p
 = 
Çme
;

239 
Ën
 > 0) {

240 (*
¡r2hashbuf
)(
p
, 
Ën
, 
š
, 8);

241 
	`h®f_md4_ŒªsfÜm
(
buf
, 
š
);

242 
Ën
 -= 32;

243 
p
 += 32;

245 
mšÜ_hash
 = 
buf
[2];

246 
hash
 = 
buf
[1];

248 
DX_HASH_TEA_UNSIGNED
:

249 
¡r2hashbuf
 = 
¡r2hashbuf_unsigÃd
;

251 
DX_HASH_TEA
:

252 
p
 = 
Çme
;

253 
Ën
 > 0) {

254 (*
¡r2hashbuf
)(
p
, 
Ën
, 
š
, 4);

255 
	`TEA_ŒªsfÜm
(
buf
, 
š
);

256 
Ën
 -= 16;

257 
p
 += 16;

259 
hash
 = 
buf
[0];

260 
mšÜ_hash
 = 
buf
[1];

263 
hšfo
->
hash
 = 0;

266 
hash
 = hash & ~1;

267 ià(
hash
 =ğ(
EXT4_HTREE_EOF_32BIT
 << 1))

268 
hash
 = (
EXT4_HTREE_EOF_32BIT
 - 1) << 1;

269 
hšfo
->
hash
 = hash;

270 
hšfo
->
mšÜ_hash
 = minor_hash;

272 
	}
}

274 
	$ext4fs_dœhash
(cÚ¡ 
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
,

275 
dx_hash_šfo
 *
hšfo
)

277 #ifdeà
CONFIG_UNICODE


278 cÚ¡ 
unicode_m­
 *
um
 = 
	`EXT4_SB
(
dœ
->
i_sb
)->
s_’codšg
;

279 
r
, 
dËn
;

280 *
buff
;

281 
q¡r
 q¡¸ğ{.
Çme
 =‚ame, .
Ën
 =†en };

283 ià(
Ën
 && 
	`IS_CASEFOLDED
(
dœ
è&& 
um
) {

284 
buff
 = 
	`kz®loc
((è* 
PATH_MAX
, 
GFP_KERNEL
);

285 ià(!
buff
)

286  -
ENOMEM
;

288 
dËn
 = 
	`utf8_ÿ£fŞd
(
um
, &
q¡r
, 
buff
, 
PATH_MAX
);

289 ià(
dËn
 < 0) {

290 
	`kä“
(
buff
);

291 
İaque_£q
;

294 
r
 = 
	`__ext4fs_dœhash
(
buff
, 
dËn
, 
hšfo
);

296 
	`kä“
(
buff
);

297  
r
;

299 
İaque_£q
:

301  
	`__ext4fs_dœhash
(
Çme
, 
Ën
, 
hšfo
);

302 
	}
}

	@pxt4/ialloc.c

16 
	~<lšux/time.h
>

17 
	~<lšux/fs.h
>

18 
	~<lšux/¡©.h
>

19 
	~<lšux/¡ršg.h
>

20 
	~<lšux/quÙaİs.h
>

21 
	~<lšux/bufãr_h—d.h
>

22 
	~<lšux/¿ndom.h
>

23 
	~<lšux/b™İs.h
>

24 
	~<lšux/blkdev.h
>

25 
	~<lšux/üed.h
>

27 
	~<asm/by‹Üd”.h
>

29 
	~"ext4.h
"

30 
	~"ext4_jbd2.h
"

31 
	~"x©Œ.h
"

32 
	~"aş.h
"

34 
	~<Œaû/ev’ts/ext4.h
>

55 
	$ext4_m¬k_b™m­_’d
(
¡¬t_b™
, 
’d_b™
, *
b™m­
)

57 
i
;

59 ià(
¡¬t_b™
 >ğ
’d_b™
)

62 
	`ext4_debug
("m¬kƒnd b™ +%dhrough +%d u£d\n", 
¡¬t_b™
, 
’d_b™
);

63 
i
 = 
¡¬t_b™
; i < ((start_bit + 7) & ~7UL); i++)

64 
	`ext4_£t_b™
(
i
, 
b™m­
);

65 ià(
i
 < 
’d_b™
)

66 
	`mem£t
(
b™m­
 + (
i
 >> 3), 0xff, (
’d_b™
 - i) >> 3);

67 
	}
}

69 
	$ext4_’d_b™m­_»ad
(
bufãr_h—d
 *
bh
, 
u±od©e
)

71 ià(
u±od©e
) {

72 
	`£t_bufãr_u±od©e
(
bh
);

73 
	`£t_b™m­_u±od©e
(
bh
);

75 
	`uÆock_bufãr
(
bh
);

76 
	`put_bh
(
bh
);

77 
	}
}

79 
	$ext4_v®id©e_šode_b™m­
(
su³r_block
 *
sb
,

80 
ext4_group_desc
 *
desc
,

81 
ext4_group_t
 
block_group
,

82 
bufãr_h—d
 *
bh
)

84 
ext4_fsblk_t
 
blk
;

85 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
block_group
);

87 ià(
	`bufãr_v”if›d
(
bh
))

89 ià(
	`EXT4_MB_GRP_IBITMAP_CORRUPT
(
g½
))

90  -
EFSCORRUPTED
;

92 
	`ext4_lock_group
(
sb
, 
block_group
);

93 ià(
	`bufãr_v”if›d
(
bh
))

94 
v”if›d
;

95 
blk
 = 
	`ext4_šode_b™m­
(
sb
, 
desc
);

96 ià(!
	`ext4_šode_b™m­_csum_v”ify
(
sb
, 
block_group
, 
desc
, 
bh
,

97 
	`EXT4_INODES_PER_GROUP
(
sb
) / 8)) {

98 
	`ext4_uÆock_group
(
sb
, 
block_group
);

99 
	`ext4_”rÜ
(
sb
, "Corrupt inode bitmap - block_group = %u, "

100 "šode_b™m­ = %Îu", 
block_group
, 
blk
);

101 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
sb
, 
block_group
,

102 
EXT4_GROUP_INFO_IBITMAP_CORRUPT
);

103  -
EFSBADCRC
;

105 
	`£t_bufãr_v”if›d
(
bh
);

106 
v”if›d
:

107 
	`ext4_uÆock_group
(
sb
, 
block_group
);

109 
	}
}

117 
bufãr_h—d
 *

118 
	$ext4_»ad_šode_b™m­
(
su³r_block
 *
sb
, 
ext4_group_t
 
block_group
)

120 
ext4_group_desc
 *
desc
;

121 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

122 
bufãr_h—d
 *
bh
 = 
NULL
;

123 
ext4_fsblk_t
 
b™m­_blk
;

124 
”r
;

126 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
block_group
, 
NULL
);

127 ià(!
desc
)

128  
	`ERR_PTR
(-
EFSCORRUPTED
);

130 
b™m­_blk
 = 
	`ext4_šode_b™m­
(
sb
, 
desc
);

131 ià((
b™m­_blk
 <ğ
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_d©a_block
)) ||

132 (
b™m­_blk
 >ğ
	`ext4_blocks_couÁ
(
sbi
->
s_es
))) {

133 
	`ext4_”rÜ
(
sb
, "Invalid inode bitmap blk %llu in "

134 "block_grou°%u", 
b™m­_blk
, 
block_group
);

135 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
sb
, 
block_group
,

136 
EXT4_GROUP_INFO_IBITMAP_CORRUPT
);

137  
	`ERR_PTR
(-
EFSCORRUPTED
);

139 
bh
 = 
	`sb_g‘blk
(
sb
, 
b™m­_blk
);

140 ià(
	`uÆik–y
(!
bh
)) {

141 
	`ext4_w¬nšg
(
sb
, "Cannot„ead inode bitmap - "

143 
block_group
, 
b™m­_blk
);

144  
	`ERR_PTR
(-
ENOMEM
);

146 ià(
	`b™m­_u±od©e
(
bh
))

147 
v”ify
;

149 
	`lock_bufãr
(
bh
);

150 ià(
	`b™m­_u±od©e
(
bh
)) {

151 
	`uÆock_bufãr
(
bh
);

152 
v”ify
;

155 
	`ext4_lock_group
(
sb
, 
block_group
);

156 ià(
	`ext4_has_group_desc_csum
(
sb
) &&

157 (
desc
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_INODE_UNINIT
))) {

158 ià(
block_group
 == 0) {

159 
	`ext4_uÆock_group
(
sb
, 
block_group
);

160 
	`uÆock_bufãr
(
bh
);

161 
	`ext4_”rÜ
(
sb
, "Inode bitmap for bg 0 marked "

163 
”r
 = -
EFSCORRUPTED
;

164 
out
;

166 
	`mem£t
(
bh
->
b_d©a
, 0, (
	`EXT4_INODES_PER_GROUP
(
sb
) + 7) / 8);

167 
	`ext4_m¬k_b™m­_’d
(
	`EXT4_INODES_PER_GROUP
(
sb
),

168 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

169 
	`£t_b™m­_u±od©e
(
bh
);

170 
	`£t_bufãr_u±od©e
(
bh
);

171 
	`£t_bufãr_v”if›d
(
bh
);

172 
	`ext4_uÆock_group
(
sb
, 
block_group
);

173 
	`uÆock_bufãr
(
bh
);

174  
bh
;

176 
	`ext4_uÆock_group
(
sb
, 
block_group
);

178 ià(
	`bufãr_u±od©e
(
bh
)) {

183 
	`£t_b™m­_u±od©e
(
bh
);

184 
	`uÆock_bufãr
(
bh
);

185 
v”ify
;

190 
	`Œaû_ext4_lßd_šode_b™m­
(
sb
, 
block_group
);

191 
bh
->
b_’d_io
 = 
ext4_’d_b™m­_»ad
;

192 
	`g‘_bh
(
bh
);

193 
	`subm™_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

194 
	`wa™_Ú_bufãr
(
bh
);

195 ià(!
	`bufãr_u±od©e
(
bh
)) {

196 
	`put_bh
(
bh
);

197 
	`ext4_”rÜ
(
sb
, "Cannot„ead inode bitmap - "

199 
block_group
, 
b™m­_blk
);

200 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
sb
, 
block_group
,

201 
EXT4_GROUP_INFO_IBITMAP_CORRUPT
);

202  
	`ERR_PTR
(-
EIO
);

205 
v”ify
:

206 
”r
 = 
	`ext4_v®id©e_šode_b™m­
(
sb
, 
desc
, 
block_group
, 
bh
);

207 ià(
”r
)

208 
out
;

209  
bh
;

210 
out
:

211 
	`put_bh
(
bh
);

212  
	`ERR_PTR
(
”r
);

213 
	}
}

231 
	$ext4_ä“_šode
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

233 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

234 
is_dœeùÜy
;

235 
šo
;

236 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

237 
bufãr_h—d
 *
bh2
;

238 
ext4_group_t
 
block_group
;

239 
b™
;

240 
ext4_group_desc
 *
gdp
;

241 
ext4_su³r_block
 *
es
;

242 
ext4_sb_šfo
 *
sbi
;

243 
çl
 = 0, 
”r
, 
couÁ
, 
ş—»d
;

244 
ext4_group_šfo
 *
g½
;

246 ià(!
sb
) {

247 
	`´štk
(
KERN_ERR
 "EXT4-fs: %s:%d: inode on "

248 "nÚexi¡’ˆdeviû\n", 
__func__
, 
__LINE__
);

251 ià(
	`©omic_»ad
(&
šode
->
i_couÁ
) > 1) {

252 
	`ext4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu: count=%d",

253 
__func__
, 
__LINE__
, 
šode
->
i_šo
,

254 
	`©omic_»ad
(&
šode
->
i_couÁ
));

257 ià(
šode
->
i_Æšk
) {

258 
	`ext4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu:‚link=%d\n",

259 
__func__
, 
__LINE__
, 
šode
->
i_šo
, inode->
i_Æšk
);

262 
sbi
 = 
	`EXT4_SB
(
sb
);

264 
šo
 = 
šode
->
i_šo
;

265 
	`ext4_debug
("ä“šg inod%lu\n", 
šo
);

266 
	`Œaû_ext4_ä“_šode
(
šode
);

272 
	`dquÙ_š™Ÿlize
(
šode
);

273 
	`dquÙ_ä“_šode
(
šode
);

274 
	`dquÙ_drİ
(
šode
);

276 
is_dœeùÜy
 = 
	`S_ISDIR
(
šode
->
i_mode
);

279 
	`ext4_ş—r_šode
(
šode
);

281 
es
 = 
sbi
->
s_es
;

282 ià(
šo
 < 
	`EXT4_FIRST_INO
(
sb
è|| inØ> 
	`Ë32_to_ıu
(
es
->
s_šodes_couÁ
)) {

283 
	`ext4_”rÜ
(
sb
, "»£rved o¸nÚexi¡’ˆšod%lu", 
šo
);

284 
”rÜ_»tuº
;

286 
block_group
 = (
šo
 - 1è/ 
	`EXT4_INODES_PER_GROUP
(
sb
);

287 
b™
 = (
šo
 - 1è% 
	`EXT4_INODES_PER_GROUP
(
sb
);

288 
b™m­_bh
 = 
	`ext4_»ad_šode_b™m­
(
sb
, 
block_group
);

290 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
block_group
);

291 ià(
	`IS_ERR
(
b™m­_bh
)) {

292 
çl
 = 
	`PTR_ERR
(
b™m­_bh
);

293 
b™m­_bh
 = 
NULL
;

294 
”rÜ_»tuº
;

296 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_IBITMAP_CORRUPT
(
g½
))) {

297 
çl
 = -
EFSCORRUPTED
;

298 
”rÜ_»tuº
;

301 
	`BUFFER_TRACE
(
b™m­_bh
, "get_write_access");

302 
çl
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
b™m­_bh
);

303 ià(
çl
)

304 
”rÜ_»tuº
;

306 
çl
 = -
ESRCH
;

307 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
block_group
, &
bh2
);

308 ià(
gdp
) {

309 
	`BUFFER_TRACE
(
bh2
, "get_write_access");

310 
çl
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh2
);

312 
	`ext4_lock_group
(
sb
, 
block_group
);

313 
ş—»d
 = 
	`ext4_‹¡_ªd_ş—r_b™
(
b™
, 
b™m­_bh
->
b_d©a
);

314 ià(
çl
 || !
ş—»d
) {

315 
	`ext4_uÆock_group
(
sb
, 
block_group
);

316 
out
;

319 
couÁ
 = 
	`ext4_ä“_šodes_couÁ
(
sb
, 
gdp
) + 1;

320 
	`ext4_ä“_šodes_£t
(
sb
, 
gdp
, 
couÁ
);

321 ià(
is_dœeùÜy
) {

322 
couÁ
 = 
	`ext4_u£d_dœs_couÁ
(
sb
, 
gdp
) - 1;

323 
	`ext4_u£d_dœs_£t
(
sb
, 
gdp
, 
couÁ
);

324 
	`³rıu_couÁ”_dec
(&
sbi
->
s_dœs_couÁ”
);

326 
	`ext4_šode_b™m­_csum_£t
(
sb
, 
block_group
, 
gdp
, 
b™m­_bh
,

327 
	`EXT4_INODES_PER_GROUP
(
sb
) / 8);

328 
	`ext4_group_desc_csum_£t
(
sb
, 
block_group
, 
gdp
);

329 
	`ext4_uÆock_group
(
sb
, 
block_group
);

331 
	`³rıu_couÁ”_šc
(&
sbi
->
s_ä“šodes_couÁ”
);

332 ià(
sbi
->
s_log_groups_³r_æex
) {

333 
ext4_group_t
 
f
 = 
	`ext4_æex_group
(
sbi
, 
block_group
);

335 
	`©omic_šc
(&
sbi
->
s_æex_groups
[
f
].
ä“_šodes
);

336 ià(
is_dœeùÜy
)

337 
	`©omic_dec
(&
sbi
->
s_æex_groups
[
f
].
u£d_dœs
);

339 
	`BUFFER_TRACE
(
bh2
, "callƒxt4_handle_dirty_metadata");

340 
çl
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh2
);

341 
out
:

342 ià(
ş—»d
) {

343 
	`BUFFER_TRACE
(
b™m­_bh
, "callƒxt4_handle_dirty_metadata");

344 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
b™m­_bh
);

345 ià(!
çl
)

346 
çl
 = 
”r
;

348 
	`ext4_”rÜ
(
sb
, "b™‡Ì—dy cË¬ed fÜ inod%lu", 
šo
);

349 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
sb
, 
block_group
,

350 
EXT4_GROUP_INFO_IBITMAP_CORRUPT
);

353 
”rÜ_»tuº
:

354 
	`b»l£
(
b™m­_bh
);

355 
	`ext4_¡d_”rÜ
(
sb
, 
çl
);

356 
	}
}

358 
	sÜlov_¡©s
 {

359 
__u64
 
	mä“_şu¡”s
;

360 
__u32
 
	mä“_šodes
;

361 
__u32
 
	mu£d_dœs
;

369 
	$g‘_Ülov_¡©s
(
su³r_block
 *
sb
, 
ext4_group_t
 
g
,

370 
æex_size
, 
Ülov_¡©s
 *
¡©s
)

372 
ext4_group_desc
 *
desc
;

373 
æex_groups
 *
æex_group
 = 
	`EXT4_SB
(
sb
)->
s_æex_groups
;

375 ià(
æex_size
 > 1) {

376 
¡©s
->
ä“_šodes
 = 
	`©omic_»ad
(&
æex_group
[
g
].free_inodes);

377 
¡©s
->
ä“_şu¡”s
 = 
	`©omic64_»ad
(&
æex_group
[
g
].free_clusters);

378 
¡©s
->
u£d_dœs
 = 
	`©omic_»ad
(&
æex_group
[
g
].used_dirs);

382 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
g
, 
NULL
);

383 ià(
desc
) {

384 
¡©s
->
ä“_šodes
 = 
	`ext4_ä“_šodes_couÁ
(
sb
, 
desc
);

385 
¡©s
->
ä“_şu¡”s
 = 
	`ext4_ä“_group_şu¡”s
(
sb
, 
desc
);

386 
¡©s
->
u£d_dœs
 = 
	`ext4_u£d_dœs_couÁ
(
sb
, 
desc
);

388 
¡©s
->
ä“_šodes
 = 0;

389 
¡©s
->
ä“_şu¡”s
 = 0;

390 
¡©s
->
u£d_dœs
 = 0;

392 
	}
}

415 
	$fšd_group_Ülov
(
su³r_block
 *
sb
, 
šode
 *
·»Á
,

416 
ext4_group_t
 *
group
, 
umode_t
 
mode
,

417 cÚ¡ 
q¡r
 *qstr)

419 
ext4_group_t
 
·»Á_group
 = 
	`EXT4_I
(
·»Á
)->
i_block_group
;

420 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

421 
ext4_group_t
 
»®_ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

422 
šodes_³r_group
 = 
	`EXT4_INODES_PER_GROUP
(
sb
);

423 
ä“i
, 
aveä“i
, 
g½_ä“
;

424 
ext4_fsblk_t
 
ä“b
, 
aveä“c
;

425 
ndœs
;

426 
max_dœs
, 
mš_šodes
;

427 
ext4_g½blk_t
 
mš_şu¡”s
;

428 
ext4_group_t
 
i
, 
g½
, 
g
, 
ngroups
;

429 
ext4_group_desc
 *
desc
;

430 
Ülov_¡©s
 
¡©s
;

431 
æex_size
 = 
	`ext4_æex_bg_size
(
sbi
);

432 
dx_hash_šfo
 
hšfo
;

434 
ngroups
 = 
»®_ngroups
;

435 ià(
æex_size
 > 1) {

436 
ngroups
 = (
»®_ngroups
 + 
æex_size
 - 1) >>

437 
sbi
->
s_log_groups_³r_æex
;

438 
·»Á_group
 >>ğ
sbi
->
s_log_groups_³r_æex
;

441 
ä“i
 = 
	`³rıu_couÁ”_»ad_pos™ive
(&
sbi
->
s_ä“šodes_couÁ”
);

442 
aveä“i
 = 
ä“i
 / 
ngroups
;

443 
ä“b
 = 
	`EXT4_C2B
(
sbi
,

444 
	`³rıu_couÁ”_»ad_pos™ive
(&
sbi
->
s_ä“şu¡”s_couÁ”
));

445 
aveä“c
 = 
ä“b
;

446 
	`do_div
(
aveä“c
, 
ngroups
);

447 
ndœs
 = 
	`³rıu_couÁ”_»ad_pos™ive
(&
sbi
->
s_dœs_couÁ”
);

449 ià(
	`S_ISDIR
(
mode
) &&

450 ((
·»Á
 =ğ
	`d_šode
(
sb
->
s_roÙ
)) ||

451 (
	`ext4_‹¡_šode_æag
(
·»Á
, 
EXT4_INODE_TOPDIR
)))) {

452 
be¡_ndœ
 = 
šodes_³r_group
;

453 
»t
 = -1;

455 ià(
q¡r
) {

456 
hšfo
.
hash_v”siÚ
 = 
DX_HASH_HALF_MD4
;

457 
hšfo
.
£ed
 = 
sbi
->
s_hash_£ed
;

458 
	`ext4fs_dœhash
(
·»Á
, 
q¡r
->
Çme
, q¡r->
Ën
, &
hšfo
);

459 
g½
 = 
hšfo
.
hash
;

461 
g½
 = 
	`´ªdom_u32
();

462 
·»Á_group
 = ()
g½
 % 
ngroups
;

463 
i
 = 0; i < 
ngroups
; i++) {

464 
g
 = (
·»Á_group
 + 
i
è% 
ngroups
;

465 
	`g‘_Ülov_¡©s
(
sb
, 
g
, 
æex_size
, &
¡©s
);

466 ià(!
¡©s
.
ä“_šodes
)

468 ià(
¡©s
.
u£d_dœs
 >ğ
be¡_ndœ
)

470 ià(
¡©s
.
ä“_šodes
 < 
aveä“i
)

472 ià(
¡©s
.
ä“_şu¡”s
 < 
aveä“c
)

474 
g½
 = 
g
;

475 
»t
 = 0;

476 
be¡_ndœ
 = 
¡©s
.
u£d_dœs
;

478 ià(
»t
)

479 
çÎback
;

480 
found_æex_bg
:

481 ià(
æex_size
 == 1) {

482 *
group
 = 
g½
;

493 
g½
 *ğ
æex_size
;

494 
i
 = 0; i < 
æex_size
; i++) {

495 ià(
g½
+
i
 >ğ
»®_ngroups
)

497 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
g½
+
i
, 
NULL
);

498 ià(
desc
 && 
	`ext4_ä“_šodes_couÁ
(
sb
, desc)) {

499 *
group
 = 
g½
+
i
;

503 
çÎback
;

506 
max_dœs
 = 
ndœs
 / 
ngroups
 + 
šodes_³r_group
 / 16;

507 
mš_šodes
 = 
aveä“i
 - 
šodes_³r_group
*
æex_size
 / 4;

508 ià(
mš_šodes
 < 1)

509 
mš_šodes
 = 1;

510 
mš_şu¡”s
 = 
aveä“c
 - 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
)*
æex_size
 / 4;

516 ià(
	`EXT4_I
(
·»Á
)->
i_Ï¡_®loc_group
 != ~0) {

517 
·»Á_group
 = 
	`EXT4_I
(
·»Á
)->
i_Ï¡_®loc_group
;

518 ià(
æex_size
 > 1)

519 
·»Á_group
 >>ğ
sbi
->
s_log_groups_³r_æex
;

522 
i
 = 0; i < 
ngroups
; i++) {

523 
g½
 = (
·»Á_group
 + 
i
è% 
ngroups
;

524 
	`g‘_Ülov_¡©s
(
sb
, 
g½
, 
æex_size
, &
¡©s
);

525 ià(
¡©s
.
u£d_dœs
 >ğ
max_dœs
)

527 ià(
¡©s
.
ä“_šodes
 < 
mš_šodes
)

529 ià(
¡©s
.
ä“_şu¡”s
 < 
mš_şu¡”s
)

531 
found_æex_bg
;

534 
çÎback
:

535 
ngroups
 = 
»®_ngroups
;

536 
aveä“i
 = 
ä“i
 / 
ngroups
;

537 
çÎback_»Œy
:

538 
·»Á_group
 = 
	`EXT4_I
(
·»Á
)->
i_block_group
;

539 
i
 = 0; i < 
ngroups
; i++) {

540 
g½
 = (
·»Á_group
 + 
i
è% 
ngroups
;

541 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
g½
, 
NULL
);

542 ià(
desc
) {

543 
g½_ä“
 = 
	`ext4_ä“_šodes_couÁ
(
sb
, 
desc
);

544 ià(
g½_ä“
 && g½_ä“ >ğ
aveä“i
) {

545 *
group
 = 
g½
;

551 ià(
aveä“i
) {

556 
aveä“i
 = 0;

557 
çÎback_»Œy
;

561 
	}
}

563 
	$fšd_group_Ùh”
(
su³r_block
 *
sb
, 
šode
 *
·»Á
,

564 
ext4_group_t
 *
group
, 
umode_t
 
mode
)

566 
ext4_group_t
 
·»Á_group
 = 
	`EXT4_I
(
·»Á
)->
i_block_group
;

567 
ext4_group_t
 
i
, 
Ï¡
, 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

568 
ext4_group_desc
 *
desc
;

569 
æex_size
 = 
	`ext4_æex_bg_size
(
	`EXT4_SB
(
sb
));

578 ià(
æex_size
 > 1) {

579 
»Œy
 = 0;

581 
Œy_agaš
:

582 
·»Á_group
 &ğ~(
æex_size
-1);

583 
Ï¡
 = 
·»Á_group
 + 
æex_size
;

584 ià(
Ï¡
 > 
ngroups
)

585 
Ï¡
 = 
ngroups
;

586 
i
 = 
·»Á_group
; i < 
Ï¡
; i++) {

587 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

588 ià(
desc
 && 
	`ext4_ä“_šodes_couÁ
(
sb
, desc)) {

589 *
group
 = 
i
;

593 ià(!
»Œy
 && 
	`EXT4_I
(
·»Á
)->
i_Ï¡_®loc_group
 != ~0) {

594 
»Œy
 = 1;

595 
·»Á_group
 = 
	`EXT4_I
(
·»Á
)->
i_Ï¡_®loc_group
;

596 
Œy_agaš
;

603 *
group
 = 
·»Á_group
 + 
æex_size
;

604 ià(*
group
 > 
ngroups
)

605 *
group
 = 0;

606  
	`fšd_group_Ülov
(
sb
, 
·»Á
, 
group
, 
mode
, 
NULL
);

612 *
group
 = 
·»Á_group
;

613 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, *
group
, 
NULL
);

614 ià(
desc
 && 
	`ext4_ä“_šodes_couÁ
(
sb
, desc) &&

615 
	`ext4_ä“_group_şu¡”s
(
sb
, 
desc
))

627 *
group
 = (*grou°+ 
·»Á
->
i_šo
è% 
ngroups
;

633 
i
 = 1; i < 
ngroups
; i <<= 1) {

634 *
group
 +ğ
i
;

635 ià(*
group
 >ğ
ngroups
)

636 *
group
 -ğ
ngroups
;

637 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, *
group
, 
NULL
);

638 ià(
desc
 && 
	`ext4_ä“_šodes_couÁ
(
sb
, desc) &&

639 
	`ext4_ä“_group_şu¡”s
(
sb
, 
desc
))

647 *
group
 = 
·»Á_group
;

648 
i
 = 0; i < 
ngroups
; i++) {

649 ià(++*
group
 >ğ
ngroups
)

650 *
group
 = 0;

651 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, *
group
, 
NULL
);

652 ià(
desc
 && 
	`ext4_ä“_šodes_couÁ
(
sb
, desc))

657 
	}
}

665 
	#RECENTCY_MIN
 5

	)

666 
	#RECENTCY_DIRTY
 300

	)

668 
	$»ûÁly_d–‘ed
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
, 
šo
)

670 
ext4_group_desc
 *
gdp
;

671 
ext4_šode
 *
¿w_šode
;

672 
bufãr_h—d
 *
bh
;

673 
šodes_³r_block
 = 
	`EXT4_SB
(
sb
)->
s_šodes_³r_block
;

674 
off£t
, 
»t
 = 0;

675 
»ûÁcy
 = 
RECENTCY_MIN
;

676 
u32
 
dtime
, 
now
;

678 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
group
, 
NULL
);

679 ià(
	`uÆik–y
(!
gdp
))

682 
bh
 = 
	`sb_fšd_g‘_block
(
sb
, 
	`ext4_šode_bË
(sb, 
gdp
) +

683 (
šo
 / 
šodes_³r_block
));

684 ià(!
bh
 || !
	`bufãr_u±od©e
(bh))

689 
out
;

691 
off£t
 = (
šo
 % 
šodes_³r_block
è* 
	`EXT4_INODE_SIZE
(
sb
);

692 
¿w_šode
 = (
ext4_šode
 *è(
bh
->
b_d©a
 + 
off£t
);

698 
dtime
 = 
	`Ë32_to_ıu
(
¿w_šode
->
i_dtime
);

699 
now
 = 
	`ktime_g‘_»®_£cÚds
();

700 ià(
	`bufãr_dœty
(
bh
))

701 
»ûÁcy
 +ğ
RECENTCY_DIRTY
;

703 ià(
dtime
 && 
	`time_befÜe32
(dtime, 
now
) &&

704 
	`time_befÜe32
(
now
, 
dtime
 + 
»ûÁcy
))

705 
»t
 = 1;

706 
out
:

707 
	`b»l£
(
bh
);

708  
»t
;

709 
	}
}

711 
	$fšd_šode_b™
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

712 
bufãr_h—d
 *
b™m­
, *
šo
)

714 
Ãxt
:

715 *
šo
 = 
	`ext4_fšd_Ãxt_z”o_b™
((*)

716 
b™m­
->
b_d©a
,

717 
	`EXT4_INODES_PER_GROUP
(
sb
), *
šo
);

718 ià(*
šo
 >ğ
	`EXT4_INODES_PER_GROUP
(
sb
))

721 ià((
	`EXT4_SB
(
sb
)->
s_jouº®
 =ğ
NULL
) &&

722 
	`»ûÁly_d–‘ed
(
sb
, 
group
, *
šo
)) {

723 *
šo
 = *ino + 1;

724 ià(*
šo
 < 
	`EXT4_INODES_PER_GROUP
(
sb
))

725 
Ãxt
;

730 
	}
}

742 
šode
 *
	$__ext4_Ãw_šode
(
hªdË_t
 *
hªdË
, 
šode
 *
dœ
,

743 
umode_t
 
mode
, cÚ¡ 
q¡r
 *qstr,

744 
__u32
 
gßl
, 
uid_t
 *
owÃr
, __u32 
i_æags
,

745 
hªdË_ty³
, 
lše_no
,

746 
nblocks
)

748 
su³r_block
 *
sb
;

749 
bufãr_h—d
 *
šode_b™m­_bh
 = 
NULL
;

750 
bufãr_h—d
 *
group_desc_bh
;

751 
ext4_group_t
 
ngroups
, 
group
 = 0;

752 
šo
 = 0;

753 
šode
 *inode;

754 
ext4_group_desc
 *
gdp
 = 
NULL
;

755 
ext4_šode_šfo
 *
ei
;

756 
ext4_sb_šfo
 *
sbi
;

757 
»t2
, 
”r
;

758 
šode
 *
»t
;

759 
ext4_group_t
 
i
;

760 
ext4_group_t
 
æex_group
;

761 
ext4_group_šfo
 *
g½
;

762 
’üy±
 = 0;

765 ià(!
dœ
 || !dœ->
i_Æšk
)

766  
	`ERR_PTR
(-
EPERM
);

768 
sb
 = 
dœ
->
i_sb
;

769 
sbi
 = 
	`EXT4_SB
(
sb
);

771 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
sbi
)))

772  
	`ERR_PTR
(-
EIO
);

774 ià((
	`IS_ENCRYPTED
(
dœ
è|| 
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
)) &&

775 (
	`S_ISREG
(
mode
è|| 
	`S_ISDIR
(modeè|| 
	`S_ISLNK
(mode)) &&

776 !(
i_æags
 & 
EXT4_EA_INODE_FL
)) {

777 
”r
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
dœ
);

778 ià(
”r
)

779  
	`ERR_PTR
(
”r
);

780 ià(!
	`fsüy±_has_’üy±iÚ_key
(
dœ
))

781  
	`ERR_PTR
(-
ENOKEY
);

782 
’üy±
 = 1;

785 ià(!
hªdË
 && 
sbi
->
s_jouº®
 && !(
i_æags
 & 
EXT4_EA_INODE_FL
)) {

786 #ifdeà
CONFIG_EXT4_FS_POSIX_ACL


787 
posix_aş
 *
p
 = 
	`g‘_aş
(
dœ
, 
ACL_TYPE_DEFAULT
);

789 ià(
	`IS_ERR
(
p
))

790  
	`ERR_CAST
(
p
);

791 ià(
p
) {

792 
aş_size
 = 
p
->
a_couÁ
 * (
ext4_aş_’Œy
);

794 
nblocks
 +ğ(
	`S_ISDIR
(
mode
) ? 2 : 1) *

795 
	`__ext4_x©Œ_£t_üed™s
(
sb
, 
NULL
 ,

796 
NULL
 , 
aş_size
,

797 
Œue
 );

798 
	`posix_aş_»Ëa£
(
p
);

802 #ifdeà
CONFIG_SECURITY


804 
num_£cur™y_x©Œs
 = 1;

806 #ifdeà
CONFIG_INTEGRITY


807 
num_£cur™y_x©Œs
++;

814 
nblocks
 +ğ
num_£cur™y_x©Œs
 *

815 
	`__ext4_x©Œ_£t_üed™s
(
sb
, 
NULL
 ,

816 
NULL
 , 1024,

817 
Œue
 );

820 ià(
’üy±
)

821 
nblocks
 +ğ
	`__ext4_x©Œ_£t_üed™s
(
sb
,

822 
NULL
 , NULL ,

823 
FSCRYPT_SET_CONTEXT_MAX_SIZE
,

824 
Œue
 );

827 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

828 
	`Œaû_ext4_»que¡_šode
(
dœ
, 
mode
);

829 
šode
 = 
	`Ãw_šode
(
sb
);

830 ià(!
šode
)

831  
	`ERR_PTR
(-
ENOMEM
);

832 
ei
 = 
	`EXT4_I
(
šode
);

839 ià(
owÃr
) {

840 
šode
->
i_mode
 = 
mode
;

841 
	`i_uid_wr™e
(
šode
, 
owÃr
[0]);

842 
	`i_gid_wr™e
(
šode
, 
owÃr
[1]);

843 } ià(
	`‹¡_İt
(
sb
, 
GRPID
)) {

844 
šode
->
i_mode
 = 
mode
;

845 
šode
->
i_uid
 = 
	`cu¼’t_fsuid
();

846 
šode
->
i_gid
 = 
dœ
->i_gid;

848 
	`šode_š™_owÃr
(
šode
, 
dœ
, 
mode
);

850 ià(
	`ext4_has_ã©u»_´ojeù
(
sb
) &&

851 
	`ext4_‹¡_šode_æag
(
dœ
, 
EXT4_INODE_PROJINHERIT
))

852 
ei
->
i_´ojid
 = 
	`EXT4_I
(
dœ
)->i_projid;

854 
ei
->
i_´ojid
 = 
	`make_k´ojid
(&
š™_u£r_ns
, 
EXT4_DEF_PROJID
);

856 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

857 ià(
”r
)

858 
out
;

860 ià(!
gßl
)

861 
gßl
 = 
sbi
->
s_šode_gßl
;

863 ià(
gßl
 && gßÈ<ğ
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_šodes_couÁ
)) {

864 
group
 = (
gßl
 - 1è/ 
	`EXT4_INODES_PER_GROUP
(
sb
);

865 
šo
 = (
gßl
 - 1è% 
	`EXT4_INODES_PER_GROUP
(
sb
);

866 
»t2
 = 0;

867 
gÙ_group
;

870 ià(
	`S_ISDIR
(
mode
))

871 
»t2
 = 
	`fšd_group_Ülov
(
sb
, 
dœ
, &
group
, 
mode
, 
q¡r
);

873 
»t2
 = 
	`fšd_group_Ùh”
(
sb
, 
dœ
, &
group
, 
mode
);

875 
gÙ_group
:

876 
	`EXT4_I
(
dœ
)->
i_Ï¡_®loc_group
 = 
group
;

877 
”r
 = -
ENOSPC
;

878 ià(
»t2
 == -1)

879 
out
;

886 
i
 = 0; i < 
ngroups
; i++, 
šo
 = 0) {

887 
”r
 = -
EIO
;

889 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
group
, &
group_desc_bh
);

890 ià(!
gdp
)

891 
out
;

896 ià(
	`ext4_ä“_šodes_couÁ
(
sb
, 
gdp
) == 0)

897 
Ãxt_group
;

899 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

901 ià(
	`EXT4_MB_GRP_IBITMAP_CORRUPT
(
g½
))

902 
Ãxt_group
;

904 
	`b»l£
(
šode_b™m­_bh
);

905 
šode_b™m­_bh
 = 
	`ext4_»ad_šode_b™m­
(
sb
, 
group
);

907 ià(
	`EXT4_MB_GRP_IBITMAP_CORRUPT
(
g½
) ||

908 
	`IS_ERR
(
šode_b™m­_bh
)) {

909 
šode_b™m­_bh
 = 
NULL
;

910 
Ãxt_group
;

913 
»³©_š_this_group
:

914 
»t2
 = 
	`fšd_šode_b™
(
sb
, 
group
, 
šode_b™m­_bh
, &
šo
);

915 ià(!
»t2
)

916 
Ãxt_group
;

918 ià(
group
 =ğ0 && (
šo
 + 1è< 
	`EXT4_FIRST_INO
(
sb
)) {

919 
	`ext4_”rÜ
(
sb
, "reserved inode found cleared - "

920 "šode=%lu", 
šo
 + 1);

921 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
sb
, 
group
,

922 
EXT4_GROUP_INFO_IBITMAP_CORRUPT
);

923 
Ãxt_group
;

926 ià(!
hªdË
) {

927 
	`BUG_ON
(
nblocks
 <= 0);

928 
hªdË
 = 
	`__ext4_jouº®_¡¬t_sb
(
dœ
->
i_sb
, 
lše_no
,

929 
hªdË_ty³
, 
nblocks
,

931 ià(
	`IS_ERR
(
hªdË
)) {

932 
”r
 = 
	`PTR_ERR
(
hªdË
);

933 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

934 
out
;

937 
	`BUFFER_TRACE
(
šode_b™m­_bh
, "get_write_access");

938 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
šode_b™m­_bh
);

939 ià(
”r
) {

940 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

941 
out
;

943 
	`ext4_lock_group
(
sb
, 
group
);

944 
»t2
 = 
	`ext4_‹¡_ªd_£t_b™
(
šo
, 
šode_b™m­_bh
->
b_d©a
);

945 ià(
»t2
) {

949 
»t2
 = 
	`fšd_šode_b™
(
sb
, 
group
, 
šode_b™m­_bh
, &
šo
);

950 ià(
»t2
) {

951 
	`ext4_£t_b™
(
šo
, 
šode_b™m­_bh
->
b_d©a
);

952 
»t2
 = 0;

954 
»t2
 = 1;

957 
	`ext4_uÆock_group
(
sb
, 
group
);

958 
šo
++;

959 ià(!
»t2
)

960 
gÙ
;

962 ià(
šo
 < 
	`EXT4_INODES_PER_GROUP
(
sb
))

963 
»³©_š_this_group
;

964 
Ãxt_group
:

965 ià(++
group
 =ğ
ngroups
)

966 
group
 = 0;

968 
”r
 = -
ENOSPC
;

969 
out
;

971 
gÙ
:

972 
	`BUFFER_TRACE
(
šode_b™m­_bh
, "callƒxt4_handle_dirty_metadata");

973 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
šode_b™m­_bh
);

974 ià(
”r
) {

975 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

976 
out
;

979 
	`BUFFER_TRACE
(
group_desc_bh
, "get_write_access");

980 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
group_desc_bh
);

981 ià(
”r
) {

982 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

983 
out
;

987 ià(
	`ext4_has_group_desc_csum
(
sb
) &&

988 
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_BLOCK_UNINIT
)) {

989 
bufãr_h—d
 *
block_b™m­_bh
;

991 
block_b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
group
);

992 ià(
	`IS_ERR
(
block_b™m­_bh
)) {

993 
”r
 = 
	`PTR_ERR
(
block_b™m­_bh
);

994 
out
;

996 
	`BUFFER_TRACE
(
block_b™m­_bh
, "get block bitmap‡ccess");

997 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
block_b™m­_bh
);

998 ià(
”r
) {

999 
	`b»l£
(
block_b™m­_bh
);

1000 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1001 
out
;

1004 
	`BUFFER_TRACE
(
block_b™m­_bh
, "dirty block bitmap");

1005 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
block_b™m­_bh
);

1008 
	`ext4_lock_group
(
sb
, 
group
);

1009 ià(
	`ext4_has_group_desc_csum
(
sb
) &&

1010 (
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_BLOCK_UNINIT
))) {

1011 
gdp
->
bg_æags
 &ğ
	`ıu_to_Ë16
(~
EXT4_BG_BLOCK_UNINIT
);

1012 
	`ext4_ä“_group_şu¡”s_£t
(
sb
, 
gdp
,

1013 
	`ext4_ä“_şu¡”s_aá”_š™
(
sb
, 
group
, 
gdp
));

1014 
	`ext4_block_b™m­_csum_£t
(
sb
, 
group
, 
gdp
,

1015 
block_b™m­_bh
);

1016 
	`ext4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1018 
	`ext4_uÆock_group
(
sb
, 
group
);

1019 
	`b»l£
(
block_b™m­_bh
);

1021 ià(
”r
) {

1022 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1023 
out
;

1028 ià(
	`ext4_has_group_desc_csum
(
sb
)) {

1029 
ä“
;

1030 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

1032 
	`down_»ad
(&
g½
->
®loc_£m
);

1033 
	`ext4_lock_group
(
sb
, 
group
);

1034 
ä“
 = 
	`EXT4_INODES_PER_GROUP
(
sb
) -

1035 
	`ext4_™abË_unu£d_couÁ
(
sb
, 
gdp
);

1036 ià(
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_INODE_UNINIT
)) {

1037 
gdp
->
bg_æags
 &ğ
	`ıu_to_Ë16
(~
EXT4_BG_INODE_UNINIT
);

1038 
ä“
 = 0;

1045 ià(
šo
 > 
ä“
)

1046 
	`ext4_™abË_unu£d_£t
(
sb
, 
gdp
,

1047 (
	`EXT4_INODES_PER_GROUP
(
sb
è- 
šo
));

1048 
	`up_»ad
(&
g½
->
®loc_£m
);

1050 
	`ext4_lock_group
(
sb
, 
group
);

1053 
	`ext4_ä“_šodes_£t
(
sb
, 
gdp
, 
	`ext4_ä“_šodes_couÁ
(sb, gdp) - 1);

1054 ià(
	`S_ISDIR
(
mode
)) {

1055 
	`ext4_u£d_dœs_£t
(
sb
, 
gdp
, 
	`ext4_u£d_dœs_couÁ
(sb, gdp) + 1);

1056 ià(
sbi
->
s_log_groups_³r_æex
) {

1057 
ext4_group_t
 
f
 = 
	`ext4_æex_group
(
sbi
, 
group
);

1059 
	`©omic_šc
(&
sbi
->
s_æex_groups
[
f
].
u£d_dœs
);

1062 ià(
	`ext4_has_group_desc_csum
(
sb
)) {

1063 
	`ext4_šode_b™m­_csum_£t
(
sb
, 
group
, 
gdp
, 
šode_b™m­_bh
,

1064 
	`EXT4_INODES_PER_GROUP
(
sb
) / 8);

1065 
	`ext4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1067 
	`ext4_uÆock_group
(
sb
, 
group
);

1069 
	`BUFFER_TRACE
(
group_desc_bh
, "callƒxt4_handle_dirty_metadata");

1070 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
group_desc_bh
);

1071 ià(
”r
) {

1072 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1073 
out
;

1076 
	`³rıu_couÁ”_dec
(&
sbi
->
s_ä“šodes_couÁ”
);

1077 ià(
	`S_ISDIR
(
mode
))

1078 
	`³rıu_couÁ”_šc
(&
sbi
->
s_dœs_couÁ”
);

1080 ià(
sbi
->
s_log_groups_³r_æex
) {

1081 
æex_group
 = 
	`ext4_æex_group
(
sbi
, 
group
);

1082 
	`©omic_dec
(&
sbi
->
s_æex_groups
[
æex_group
].
ä“_šodes
);

1085 
šode
->
i_šo
 = 
šo
 + 
group
 * 
	`EXT4_INODES_PER_GROUP
(
sb
);

1087 
šode
->
i_blocks
 = 0;

1088 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

1089 
ei
->
i_ütime
 = 
šode
->
i_mtime
;

1091 
	`mem£t
(
ei
->
i_d©a
, 0, (ei->i_data));

1092 
ei
->
i_dœ_¡¬t_lookup
 = 0;

1093 
ei
->
i_disksize
 = 0;

1096 
ei
->
i_æags
 =

1097 
	`ext4_mask_æags
(
mode
, 
	`EXT4_I
(
dœ
)->
i_æags
 & 
EXT4_FL_INHERITED
);

1098 
ei
->
i_æags
 |= i_flags;

1099 
ei
->
i_fe_aş
 = 0;

1100 
ei
->
i_dtime
 = 0;

1101 
ei
->
i_block_group
 = 
group
;

1102 
ei
->
i_Ï¡_®loc_group
 = ~0;

1104 
	`ext4_£t_šode_æags
(
šode
);

1105 ià(
	`IS_DIRSYNC
(
šode
))

1106 
	`ext4_hªdË_sync
(
hªdË
);

1107 ià(
	`š£¹_šode_locked
(
šode
) < 0) {

1112 
”r
 = -
EIO
;

1113 
	`ext4_”rÜ
(
sb
, "failedo insert inode %lu: doubly‡llocated?",

1114 
šode
->
i_šo
);

1115 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
sb
, 
group
,

1116 
EXT4_GROUP_INFO_IBITMAP_CORRUPT
);

1117 
out
;

1119 
šode
->
i_g’”©iÚ
 = 
	`´ªdom_u32
();

1122 ià(
	`ext4_has_m‘ad©a_csum
(
sb
)) {

1123 
__u32
 
csum
;

1124 
__Ë32
 
šum
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

1125 
__Ë32
 
g’
 = 
	`ıu_to_Ë32
(
šode
->
i_g’”©iÚ
);

1126 
csum
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
šum
,

1127 (
šum
));

1128 
ei
->
i_csum_£ed
 = 
	`ext4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
g’
,

1129 (
g’
));

1132 
	`ext4_ş—r_¡©e_æags
(
ei
);

1133 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_NEW
);

1135 
ei
->
i_exŒa_isize
 = 
sbi
->
s_wªt_exŒa_isize
;

1136 
ei
->
i_šlše_off
 = 0;

1137 ià(
	`ext4_has_ã©u»_šlše_d©a
(
sb
))

1138 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

1139 
»t
 = 
šode
;

1140 
”r
 = 
	`dquÙ_®loc_šode
(
šode
);

1141 ià(
”r
)

1142 
ç_drİ
;

1149 ià(
’üy±
) {

1150 
”r
 = 
	`fsüy±_šh”™_cÚ‹xt
(
dœ
, 
šode
, 
hªdË
, 
Œue
);

1151 ià(
”r
)

1152 
ç_ä“_drİ
;

1155 ià(!(
ei
->
i_æags
 & 
EXT4_EA_INODE_FL
)) {

1156 
”r
 = 
	`ext4_š™_aş
(
hªdË
, 
šode
, 
dœ
);

1157 ià(
”r
)

1158 
ç_ä“_drİ
;

1160 
”r
 = 
	`ext4_š™_£cur™y
(
hªdË
, 
šode
, 
dœ
, 
q¡r
);

1161 ià(
”r
)

1162 
ç_ä“_drİ
;

1165 ià(
	`ext4_has_ã©u»_ex‹Ás
(
sb
)) {

1167 ià(
	`S_ISDIR
(
mode
è|| 
	`S_ISREG
(modeè|| 
	`S_ISLNK
(mode)) {

1168 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
);

1169 
	`ext4_ext_Œ“_š™
(
hªdË
, 
šode
);

1173 ià(
	`ext4_hªdË_v®id
(
hªdË
)) {

1174 
ei
->
i_sync_tid
 = 
hªdË
->
h_Œª§ùiÚ
->
t_tid
;

1175 
ei
->
i_d©async_tid
 = 
hªdË
->
h_Œª§ùiÚ
->
t_tid
;

1178 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1179 ià(
”r
) {

1180 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1181 
ç_ä“_drİ
;

1184 
	`ext4_debug
("®loÿtšg inod%lu\n", 
šode
->
i_šo
);

1185 
	`Œaû_ext4_®loÿ‹_šode
(
šode
, 
dœ
, 
mode
);

1186 
	`b»l£
(
šode_b™m­_bh
);

1187  
»t
;

1189 
ç_ä“_drİ
:

1190 
	`dquÙ_ä“_šode
(
šode
);

1191 
ç_drİ
:

1192 
	`ş—r_Æšk
(
šode
);

1193 
	`uÆock_Ãw_šode
(
šode
);

1194 
out
:

1195 
	`dquÙ_drİ
(
šode
);

1196 
šode
->
i_æags
 |ğ
S_NOQUOTA
;

1197 
	`ut
(
šode
);

1198 
	`b»l£
(
šode_b™m­_bh
);

1199  
	`ERR_PTR
(
”r
);

1200 
	}
}

1203 
šode
 *
	$ext4_Üphª_g‘
(
su³r_block
 *
sb
, 
šo
)

1205 
max_šo
 = 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_šodes_couÁ
);

1206 
ext4_group_t
 
block_group
;

1207 
b™
;

1208 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

1209 
šode
 *šodğ
NULL
;

1210 
”r
 = -
EFSCORRUPTED
;

1212 ià(
šo
 < 
	`EXT4_FIRST_INO
(
sb
è|| inØ> 
max_šo
)

1213 
bad_Üphª
;

1215 
block_group
 = (
šo
 - 1è/ 
	`EXT4_INODES_PER_GROUP
(
sb
);

1216 
b™
 = (
šo
 - 1è% 
	`EXT4_INODES_PER_GROUP
(
sb
);

1217 
b™m­_bh
 = 
	`ext4_»ad_šode_b™m­
(
sb
, 
block_group
);

1218 ià(
	`IS_ERR
(
b™m­_bh
))

1219  
	`ERR_CAST
(
b™m­_bh
);

1225 ià(!
	`ext4_‹¡_b™
(
b™
, 
b™m­_bh
->
b_d©a
))

1226 
bad_Üphª
;

1228 
šode
 = 
	`ext4_ig‘
(
sb
, 
šo
, 
EXT4_IGET_NORMAL
);

1229 ià(
	`IS_ERR
(
šode
)) {

1230 
”r
 = 
	`PTR_ERR
(
šode
);

1231 
	`ext4_”rÜ
(
sb
, "couldn't„ead orphan inode %lu (err %d)",

1232 
šo
, 
”r
);

1233  
šode
;

1242 ià((
šode
->
i_Æšk
 && !
	`ext4_ÿn_Œunÿ‹
(inode)) ||

1243 
	`is_bad_šode
(
šode
))

1244 
bad_Üphª
;

1246 ià(
	`NEXT_ORPHAN
(
šode
è> 
max_šo
)

1247 
bad_Üphª
;

1248 
	`b»l£
(
b™m­_bh
);

1249  
šode
;

1251 
bad_Üphª
:

1252 
	`ext4_”rÜ
(
sb
, "bad o½hª inod%lu", 
šo
);

1253 ià(
b™m­_bh
)

1254 
	`´štk
(
KERN_ERR
 "ext4_test_bit(bit=%d, block=%llu) = %d\n",

1255 
b™
, ()
b™m­_bh
->
b_blockÄ
,

1256 
	`ext4_‹¡_b™
(
b™
, 
b™m­_bh
->
b_d©a
));

1257 ià(
šode
) {

1258 
	`´štk
(
KERN_ERR
 "is_bad_inode(inode)=%d\n",

1259 
	`is_bad_šode
(
šode
));

1260 
	`´štk
(
KERN_ERR
 "NEXT_ORPHAN(inode)=%u\n",

1261 
	`NEXT_ORPHAN
(
šode
));

1262 
	`´štk
(
KERN_ERR
 "max_šo=%lu\n", 
max_šo
);

1263 
	`´štk
(
KERN_ERR
 "i_Æšk=%u\n", 
šode
->
i_Æšk
);

1265 ià(
šode
->
i_Æšk
 == 0)

1266 
šode
->
i_blocks
 = 0;

1267 
	`ut
(
šode
);

1269 
	`b»l£
(
b™m­_bh
);

1270  
	`ERR_PTR
(
”r
);

1271 
	}
}

1273 
	$ext4_couÁ_ä“_šodes
(
su³r_block
 *
sb
)

1275 
desc_couÁ
;

1276 
ext4_group_desc
 *
gdp
;

1277 
ext4_group_t
 
i
, 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

1278 #ifdeà
EXT4FS_DEBUG


1279 
ext4_su³r_block
 *
es
;

1280 
b™m­_couÁ
, 
x
;

1281 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

1283 
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

1284 
desc_couÁ
 = 0;

1285 
b™m­_couÁ
 = 0;

1286 
gdp
 = 
NULL
;

1287 
i
 = 0; i < 
ngroups
; i++) {

1288 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

1289 ià(!
gdp
)

1291 
desc_couÁ
 +ğ
	`ext4_ä“_šodes_couÁ
(
sb
, 
gdp
);

1292 
	`b»l£
(
b™m­_bh
);

1293 
b™m­_bh
 = 
	`ext4_»ad_šode_b™m­
(
sb
, 
i
);

1294 ià(
	`IS_ERR
(
b™m­_bh
)) {

1295 
b™m­_bh
 = 
NULL
;

1299 
x
 = 
	`ext4_couÁ_ä“
(
b™m­_bh
->
b_d©a
,

1300 
	`EXT4_INODES_PER_GROUP
(
sb
) / 8);

1301 
	`´štk
(
KERN_DEBUG
 "group %lu: stored = %d, counted = %lu\n",

1302 (è
i
, 
	`ext4_ä“_šodes_couÁ
(
sb
, 
gdp
), 
x
);

1303 
b™m­_couÁ
 +ğ
x
;

1305 
	`b»l£
(
b™m­_bh
);

1306 
	`´štk
(
KERN_DEBUG
 "ext4_count_free_inodes: "

1308 
	`Ë32_to_ıu
(
es
->
s_ä“_šodes_couÁ
), 
desc_couÁ
, 
b™m­_couÁ
);

1309  
desc_couÁ
;

1311 
desc_couÁ
 = 0;

1312 
i
 = 0; i < 
ngroups
; i++) {

1313 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

1314 ià(!
gdp
)

1316 
desc_couÁ
 +ğ
	`ext4_ä“_šodes_couÁ
(
sb
, 
gdp
);

1317 
	`cÚd_»sched
();

1319  
desc_couÁ
;

1321 
	}
}

1324 
	$ext4_couÁ_dœs
(
su³r_block
 * 
sb
)

1326 
couÁ
 = 0;

1327 
ext4_group_t
 
i
, 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

1329 
i
 = 0; i < 
ngroups
; i++) {

1330 
ext4_group_desc
 *
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

1331 ià(!
gdp
)

1333 
couÁ
 +ğ
	`ext4_u£d_dœs_couÁ
(
sb
, 
gdp
);

1335  
couÁ
;

1336 
	}
}

1346 
	$ext4_š™_šode_bË
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

1347 
b¬r›r
)

1349 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

1350 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1351 
ext4_group_desc
 *
gdp
 = 
NULL
;

1352 
bufãr_h—d
 *
group_desc_bh
;

1353 
hªdË_t
 *
hªdË
;

1354 
ext4_fsblk_t
 
blk
;

1355 
num
, 
»t
 = 0, 
u£d_blks
 = 0;

1358 ià(
	`sb_rdÚly
(
sb
)) {

1359 
»t
 = 1;

1360 
out
;

1363 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
group
, &
group_desc_bh
);

1364 ià(!
gdp
)

1365 
out
;

1371 ià(
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_INODE_ZEROED
))

1372 
out
;

1374 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_MISC
, 1);

1375 ià(
	`IS_ERR
(
hªdË
)) {

1376 
»t
 = 
	`PTR_ERR
(
hªdË
);

1377 
out
;

1380 
	`down_wr™e
(&
g½
->
®loc_£m
);

1386 ià(!(
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_INODE_UNINIT
)))

1387 
u£d_blks
 = 
	`DIV_ROUND_UP
((
	`EXT4_INODES_PER_GROUP
(
sb
) -

1388 
	`ext4_™abË_unu£d_couÁ
(
sb
, 
gdp
)),

1389 
sbi
->
s_šodes_³r_block
);

1391 ià((
u£d_blks
 < 0è|| (u£d_blk > 
sbi
->
s_™b_³r_group
) ||

1392 ((
group
 =ğ0è&& ((
	`EXT4_INODES_PER_GROUP
(
sb
) -

1393 
	`ext4_™abË_unu£d_couÁ
(
sb
, 
gdp
)) <

1394 
	`EXT4_FIRST_INO
(
sb
)))) {

1395 
	`ext4_”rÜ
(
sb
, "Something is wrong with group %u: "

1398 
group
, 
u£d_blks
,

1399 
	`ext4_™abË_unu£d_couÁ
(
sb
, 
gdp
));

1400 
»t
 = 1;

1401 
”r_out
;

1404 
blk
 = 
	`ext4_šode_bË
(
sb
, 
gdp
è+ 
u£d_blks
;

1405 
num
 = 
sbi
->
s_™b_³r_group
 - 
u£d_blks
;

1407 
	`BUFFER_TRACE
(
group_desc_bh
, "get_write_access");

1408 
»t
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
,

1409 
group_desc_bh
);

1410 ià(
»t
)

1411 
”r_out
;

1418 ià(
	`uÆik–y
(
num
 == 0))

1419 
sk_z”oout
;

1421 
	`ext4_debug
("goingo zero out inodeable in group %d\n",

1422 
group
);

1423 
»t
 = 
	`sb_issue_z”oout
(
sb
, 
blk
, 
num
, 
GFP_NOFS
);

1424 ià(
»t
 < 0)

1425 
”r_out
;

1426 ià(
b¬r›r
)

1427 
	`blkdev_issue_æush
(
sb
->
s_bdev
, 
GFP_NOFS
, 
NULL
);

1429 
sk_z”oout
:

1430 
	`ext4_lock_group
(
sb
, 
group
);

1431 
gdp
->
bg_æags
 |ğ
	`ıu_to_Ë16
(
EXT4_BG_INODE_ZEROED
);

1432 
	`ext4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1433 
	`ext4_uÆock_group
(
sb
, 
group
);

1435 
	`BUFFER_TRACE
(
group_desc_bh
,

1437 
»t
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
,

1438 
group_desc_bh
);

1440 
”r_out
:

1441 
	`up_wr™e
(&
g½
->
®loc_£m
);

1442 
	`ext4_jouº®_¡İ
(
hªdË
);

1443 
out
:

1444  
»t
;

1445 
	}
}

	@pxt4/indirect.c

24 
	~"ext4_jbd2.h
"

25 
	~"Œunÿ‹.h
"

26 
	~<lšux/dax.h
>

27 
	~<lšux/uio.h
>

29 
	~<Œaû/ev’ts/ext4.h
>

32 
__Ë32
 *
	mp
;

33 
__Ë32
 
	mkey
;

34 
bufãr_h—d
 *
	mbh
;

35 } 
	tIndœeù
;

37 
šlše
 
	$add_chaš
(
Indœeù
 *
p
, 
bufãr_h—d
 *
bh
, 
__Ë32
 *
v
)

39 
p
->
key
 = *Õ->°ğ
v
);

40 
p
->
bh
 = bh;

41 
	}
}

74 
	$ext4_block_to_·th
(
šode
 *inode,

75 
ext4_lblk_t
 
i_block
,

76 
ext4_lblk_t
 
off£ts
[4], *
bound¬y
)

78 
±rs
 = 
	`EXT4_ADDR_PER_BLOCK
(
šode
->
i_sb
);

79 
±rs_b™s
 = 
	`EXT4_ADDR_PER_BLOCK_BITS
(
šode
->
i_sb
);

80 cÚ¡ 
dœeù_blocks
 = 
EXT4_NDIR_BLOCKS
,

81 
šdœeù_blocks
 = 
±rs
,

82 
doubË_blocks
 = (1 << (
±rs_b™s
 * 2));

83 
n
 = 0;

84 
fš®
 = 0;

86 ià(
i_block
 < 
dœeù_blocks
) {

87 
off£ts
[
n
++] = 
i_block
;

88 
fš®
 = 
dœeù_blocks
;

89 } ià((
i_block
 -ğ
dœeù_blocks
è< 
šdœeù_blocks
) {

90 
off£ts
[
n
++] = 
EXT4_IND_BLOCK
;

91 
off£ts
[
n
++] = 
i_block
;

92 
fš®
 = 
±rs
;

93 } ià((
i_block
 -ğ
šdœeù_blocks
è< 
doubË_blocks
) {

94 
off£ts
[
n
++] = 
EXT4_DIND_BLOCK
;

95 
off£ts
[
n
++] = 
i_block
 >> 
±rs_b™s
;

96 
off£ts
[
n
++] = 
i_block
 & (
±rs
 - 1);

97 
fš®
 = 
±rs
;

98 } ià(((
i_block
 -ğ
doubË_blocks
è>> (
±rs_b™s
 * 2)è< 
±rs
) {

99 
off£ts
[
n
++] = 
EXT4_TIND_BLOCK
;

100 
off£ts
[
n
++] = 
i_block
 >> (
±rs_b™s
 * 2);

101 
off£ts
[
n
++] = (
i_block
 >> 
±rs_b™s
è& (
±rs
 - 1);

102 
off£ts
[
n
++] = 
i_block
 & (
±rs
 - 1);

103 
fš®
 = 
±rs
;

105 
	`ext4_w¬nšg
(
šode
->
i_sb
, "block %lu > max in inode %lu",

106 
i_block
 + 
dœeù_blocks
 +

107 
šdœeù_blocks
 + 
doubË_blocks
, 
šode
->
i_šo
);

109 ià(
bound¬y
)

110 *
bound¬y
 = 
fš®
 - 1 - (
i_block
 & (
±rs
 - 1));

111  
n
;

112 
	}
}

144 
Indœeù
 *
	$ext4_g‘_b¿nch
(
šode
 *šode, 
d•th
,

145 
ext4_lblk_t
 *
off£ts
,

146 
Indœeù
 
chaš
[4], *
”r
)

148 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

149 
Indœeù
 *
p
 = 
chaš
;

150 
bufãr_h—d
 *
bh
;

151 
»t
 = -
EIO
;

153 *
”r
 = 0;

155 
	`add_chaš
(
chaš
, 
NULL
, 
	`EXT4_I
(
šode
)->
i_d©a
 + *
off£ts
);

156 ià(!
p
->
key
)

157 
no_block
;

158 --
d•th
) {

159 
bh
 = 
	`sb_g‘blk
(
sb
, 
	`Ë32_to_ıu
(
p
->
key
));

160 ià(
	`uÆik–y
(!
bh
)) {

161 
»t
 = -
ENOMEM
;

162 
çu»
;

165 ià(!
	`bh_u±od©e_Ü_lock
(
bh
)) {

166 ià(
	`bh_subm™_»ad
(
bh
) < 0) {

167 
	`put_bh
(
bh
);

168 
çu»
;

171 ià(
	`ext4_check_šdœeù_block»f
(
šode
, 
bh
)) {

172 
	`put_bh
(
bh
);

173 
çu»
;

177 
	`add_chaš
(++
p
, 
bh
, (
__Ë32
 *)bh->
b_d©a
 + *++
off£ts
);

179 ià(!
p
->
key
)

180 
no_block
;

182  
NULL
;

184 
çu»
:

185 *
”r
 = 
»t
;

186 
no_block
:

187  
p
;

188 
	}
}

210 
ext4_fsblk_t
 
	$ext4_fšd_Ã¬
(
šode
 *šode, 
Indœeù
 *
šd
)

212 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

213 
__Ë32
 *
¡¬t
 = 
šd
->
bh
 ? (__Ë32 *èšd->bh->
b_d©a
 : 
ei
->
i_d©a
;

214 
__Ë32
 *
p
;

217 
p
 = 
šd
->°- 1;… >ğ
¡¬t
;…--) {

218 ià(*
p
)

219  
	`Ë32_to_ıu
(*
p
);

223 ià(
šd
->
bh
)

224  
šd
->
bh
->
b_blockÄ
;

230  
	`ext4_šode_to_gßl_block
(
šode
);

231 
	}
}

244 
ext4_fsblk_t
 
	$ext4_fšd_gßl
(
šode
 *šode, 
ext4_lblk_t
 
block
,

245 
Indœeù
 *
·¹Ÿl
)

247 
ext4_fsblk_t
 
gßl
;

253 
gßl
 = 
	`ext4_fšd_Ã¬
(
šode
, 
·¹Ÿl
);

254 
gßl
 = gßÈ& 
EXT4_MAX_BLOCK_FILE_PHYS
;

255  
gßl
;

256 
	}
}

270 
	$ext4_blks_to_®loÿ‹
(
Indœeù
 *
b¿nch
, 
k
, 
blks
,

271 
blocks_to_bound¬y
)

273 
couÁ
 = 0;

279 ià(
k
 > 0) {

281 ià(
blks
 < 
blocks_to_bound¬y
 + 1)

282 
couÁ
 +ğ
blks
;

284 
couÁ
 +ğ
blocks_to_bound¬y
 + 1;

285  
couÁ
;

288 
couÁ
++;

289 
couÁ
 < 
blks
 && couÁ <ğ
blocks_to_bound¬y
 &&

290 
	`Ë32_to_ıu
(*(
b¿nch
[0].
p
 + 
couÁ
)) == 0) {

291 
couÁ
++;

293  
couÁ
;

294 
	}
}

321 
	$ext4_®loc_b¿nch
(
hªdË_t
 *
hªdË
,

322 
ext4_®loÿtiÚ_»que¡
 *
¬
,

323 
šdœeù_blks
, 
ext4_lblk_t
 *
off£ts
,

324 
Indœeù
 *
b¿nch
)

326 
bufãr_h—d
 * 
bh
;

327 
ext4_fsblk_t
 
b
, 
Ãw_blocks
[4];

328 
__Ë32
 *
p
;

329 
i
, 
j
, 
”r
, 
Ën
 = 1;

331 
i
 = 0; i <ğ
šdœeù_blks
; i++) {

332 ià(
i
 =ğ
šdœeù_blks
) {

333 
Ãw_blocks
[
i
] = 
	`ext4_mb_Ãw_blocks
(
hªdË
, 
¬
, &
”r
);

335 
¬
->
gßl
 = 
Ãw_blocks
[
i
] = 
	`ext4_Ãw_m‘a_blocks
(
hªdË
,

336 
¬
->
šode
,‡r->
gßl
,

337 
¬
->
æags
 & 
EXT4_MB_DELALLOC_RESERVED
,

338 
NULL
, &
”r
);

339 ià(
”r
) {

340 
i
--;

341 
çed
;

343 
b¿nch
[
i
].
key
 = 
	`ıu_to_Ë32
(
Ãw_blocks
[i]);

344 ià(
i
 == 0)

347 
bh
 = 
b¿nch
[
i
].bh = 
	`sb_g‘blk
(
¬
->
šode
->
i_sb
, 
Ãw_blocks
[i-1]);

348 ià(
	`uÆik–y
(!
bh
)) {

349 
”r
 = -
ENOMEM
;

350 
çed
;

352 
	`lock_bufãr
(
bh
);

353 
	`BUFFER_TRACE
(
bh
, "call get_create_access");

354 
”r
 = 
	`ext4_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
bh
);

355 ià(
”r
) {

356 
	`uÆock_bufãr
(
bh
);

357 
çed
;

360 
	`mem£t
(
bh
->
b_d©a
, 0, bh->
b_size
);

361 
p
 = 
b¿nch
[
i
].°ğ(
__Ë32
 *è
bh
->
b_d©a
 + 
off£ts
[i];

362 
b
 = 
Ãw_blocks
[
i
];

364 ià(
i
 =ğ
šdœeù_blks
)

365 
Ën
 = 
¬
->len;

366 
j
 = 0; j < 
Ën
; j++)

367 *
p
++ = 
	`ıu_to_Ë32
(
b
++);

369 
	`BUFFER_TRACE
(
bh
, "marking uptodate");

370 
	`£t_bufãr_u±od©e
(
bh
);

371 
	`uÆock_bufãr
(
bh
);

373 
	`BUFFER_TRACE
(
bh
, "callƒxt4_handle_dirty_metadata");

374 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
¬
->
šode
, 
bh
);

375 ià(
”r
)

376 
çed
;

379 
çed
:

380 ; 
i
 >= 0; i--) {

387 ià(
i
 > 0 && i !ğ
šdœeù_blks
 && 
b¿nch
[i].
bh
)

388 
	`ext4_fÜg‘
(
hªdË
, 1, 
¬
->
šode
, 
b¿nch
[
i
].
bh
,

389 
b¿nch
[
i
].
bh
->
b_blockÄ
);

390 
	`ext4_ä“_blocks
(
hªdË
, 
¬
->
šode
, 
NULL
, 
Ãw_blocks
[
i
],

391 (
i
 =ğ
šdœeù_blks
è? 
¬
->
Ën
 : 1, 0);

393  
”r
;

394 
	}
}

407 
	$ext4_¥liû_b¿nch
(
hªdË_t
 *
hªdË
,

408 
ext4_®loÿtiÚ_»que¡
 *
¬
,

409 
Indœeù
 *
wh”e
, 
num
)

411 
i
;

412 
”r
 = 0;

413 
ext4_fsblk_t
 
cu¼’t_block
;

420 ià(
wh”e
->
bh
) {

421 
	`BUFFER_TRACE
(
wh”e
->
bh
, "get_write_access");

422 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
wh”e
->
bh
);

423 ià(
”r
)

424 
”r_out
;

428 *
wh”e
->
p
 = wh”e->
key
;

434 ià(
num
 =ğ0 && 
¬
->
Ën
 > 1) {

435 
cu¼’t_block
 = 
	`Ë32_to_ıu
(
wh”e
->
key
) + 1;

436 
i
 = 1; i < 
¬
->
Ën
; i++)

437 *(
wh”e
->
p
 + 
i
èğ
	`ıu_to_Ë32
(
cu¼’t_block
++);

442 ià(
wh”e
->
bh
) {

451 
	`jbd_debug
(5, "splicing indirect only\n");

452 
	`BUFFER_TRACE
(
wh”e
->
bh
, "callƒxt4_handle_dirty_metadata");

453 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
¬
->
šode
, 
wh”e
->
bh
);

454 ià(
”r
)

455 
”r_out
;

460 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
¬
->
šode
);

461 
	`jbd_debug
(5, "splicing direct\n");

463  
”r
;

465 
”r_out
:

466 
i
 = 1; i <ğ
num
; i++) {

472 
	`ext4_ä“_blocks
(
hªdË
, 
¬
->
šode
, 
wh”e
[
i
].
bh
, 0, 1,

473 
EXT4_FREE_BLOCKS_FORGET
);

475 
	`ext4_ä“_blocks
(
hªdË
, 
¬
->
šode
, 
NULL
, 
	`Ë32_to_ıu
(
wh”e
[
num
].
key
),

476 
¬
->
Ën
, 0);

478  
”r
;

479 
	}
}

509 
	$ext4_šd_m­_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

510 
ext4_m­_blocks
 *
m­
,

511 
æags
)

513 
ext4_®loÿtiÚ_»que¡
 
¬
;

514 
”r
 = -
EIO
;

515 
ext4_lblk_t
 
off£ts
[4];

516 
Indœeù
 
chaš
[4];

517 
Indœeù
 *
·¹Ÿl
;

518 
šdœeù_blks
;

519 
blocks_to_bound¬y
 = 0;

520 
d•th
;

521 
couÁ
 = 0;

522 
ext4_fsblk_t
 
fœ¡_block
 = 0;

524 
	`Œaû_ext4_šd_m­_blocks_’‹r
(
šode
, 
m­
->
m_lblk
, m­->
m_Ën
, 
æags
);

525 
	`J_ASSERT
(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)));

526 
	`J_ASSERT
(
hªdË
 !ğ
NULL
 || (
æags
 & 
EXT4_GET_BLOCKS_CREATE
) == 0);

527 
d•th
 = 
	`ext4_block_to_·th
(
šode
, 
m­
->
m_lblk
, 
off£ts
,

528 &
blocks_to_bound¬y
);

530 ià(
d•th
 == 0)

531 
out
;

533 
·¹Ÿl
 = 
	`ext4_g‘_b¿nch
(
šode
, 
d•th
, 
off£ts
, 
chaš
, &
”r
);

536 ià(!
·¹Ÿl
) {

537 
fœ¡_block
 = 
	`Ë32_to_ıu
(
chaš
[
d•th
 - 1].
key
);

538 
couÁ
++;

540 
couÁ
 < 
m­
->
m_Ën
 && couÁ <ğ
blocks_to_bound¬y
) {

541 
ext4_fsblk_t
 
blk
;

543 
blk
 = 
	`Ë32_to_ıu
(*(
chaš
[
d•th
-1].
p
 + 
couÁ
));

545 ià(
blk
 =ğ
fœ¡_block
 + 
couÁ
)

546 
couÁ
++;

550 
gÙ_™
;

554 ià((
æags
 & 
EXT4_GET_BLOCKS_CREATE
) == 0) {

555 
•b
 = 
šode
->
i_sb
->
s_blocksize
 / (
u32
);

556 
i
;

564 
couÁ
 = 0;

565 
i
 = 
·¹Ÿl
 - 
chaš
 + 1; i < 
d•th
; i++)

566 
couÁ
 = couÁ * 
•b
 + (•b - 
off£ts
[
i
] - 1);

567 
couÁ
++;

569 
m­
->
m_pblk
 = 0;

570 
m­
->
m_Ën
 = 
	`mš_t
(, m­->m_Ën, 
couÁ
);

571 
ş—nup
;

575 ià(
”r
 =ğ-
EIO
)

576 
ş—nup
;

581 ià(
	`ext4_has_ã©u»_big®loc
(
šode
->
i_sb
)) {

582 
	`EXT4_ERROR_INODE
(
šode
, "Can't‡llocate blocks for "

584  -
EFSCORRUPTED
;

588 
	`mem£t
(&
¬
, 0, (ar));

589 
¬
.
šode
 = inode;

590 
¬
.
logiÿl
 = 
m­
->
m_lblk
;

591 ià(
	`S_ISREG
(
šode
->
i_mode
))

592 
¬
.
æags
 = 
EXT4_MB_HINT_DATA
;

593 ià(
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
)

594 
¬
.
æags
 |ğ
EXT4_MB_DELALLOC_RESERVED
;

595 ià(
æags
 & 
EXT4_GET_BLOCKS_METADATA_NOFAIL
)

596 
¬
.
æags
 |ğ
EXT4_MB_USE_RESERVED
;

598 
¬
.
gßl
 = 
	`ext4_fšd_gßl
(
šode
, 
m­
->
m_lblk
, 
·¹Ÿl
);

601 
šdœeù_blks
 = (
chaš
 + 
d•th
è- 
·¹Ÿl
 - 1;

607 
¬
.
Ën
 = 
	`ext4_blks_to_®loÿ‹
(
·¹Ÿl
, 
šdœeù_blks
,

608 
m­
->
m_Ën
, 
blocks_to_bound¬y
);

613 
”r
 = 
	`ext4_®loc_b¿nch
(
hªdË
, &
¬
, 
šdœeù_blks
,

614 
off£ts
 + (
·¹Ÿl
 - 
chaš
),…artial);

623 ià(!
”r
)

624 
”r
 = 
	`ext4_¥liû_b¿nch
(
hªdË
, &
¬
, 
·¹Ÿl
, 
šdœeù_blks
);

625 ià(
”r
)

626 
ş—nup
;

628 
m­
->
m_æags
 |ğ
EXT4_MAP_NEW
;

630 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

631 
couÁ
 = 
¬
.
Ën
;

632 
gÙ_™
:

633 
m­
->
m_æags
 |ğ
EXT4_MAP_MAPPED
;

634 
m­
->
m_pblk
 = 
	`Ë32_to_ıu
(
chaš
[
d•th
-1].
key
);

635 
m­
->
m_Ën
 = 
couÁ
;

636 ià(
couÁ
 > 
blocks_to_bound¬y
)

637 
m­
->
m_æags
 |ğ
EXT4_MAP_BOUNDARY
;

638 
”r
 = 
couÁ
;

640 
·¹Ÿl
 = 
chaš
 + 
d•th
 - 1;

641 
ş—nup
:

642 
·¹Ÿl
 > 
chaš
) {

643 
	`BUFFER_TRACE
(
·¹Ÿl
->
bh
, "call brelse");

644 
	`b»l£
(
·¹Ÿl
->
bh
);

645 
·¹Ÿl
--;

647 
out
:

648 
	`Œaû_ext4_šd_m­_blocks_ex™
(
šode
, 
æags
, 
m­
, 
”r
);

649  
”r
;

650 
	}
}

656 
	$ext4_šd_ÿlc_m‘ad©a_amouÁ
(
šode
 *šode, 
£ùÜ_t
 
lblock
)

658 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

659 
£ùÜ_t
 
dšd_mask
 = ~((£ùÜ_t)
	`EXT4_ADDR_PER_BLOCK
(
šode
->
i_sb
) - 1);

660 
blk_b™s
;

662 ià(
lblock
 < 
EXT4_NDIR_BLOCKS
)

665 
lblock
 -ğ
EXT4_NDIR_BLOCKS
;

667 ià(
ei
->
i_da_m‘ad©a_ÿlc_Ën
 &&

668 (
lblock
 & 
dšd_mask
è=ğ
ei
->
i_da_m‘ad©a_ÿlc_Ï¡_lblock
) {

669 
ei
->
i_da_m‘ad©a_ÿlc_Ën
++;

672 
ei
->
i_da_m‘ad©a_ÿlc_Ï¡_lblock
 = 
lblock
 & 
dšd_mask
;

673 
ei
->
i_da_m‘ad©a_ÿlc_Ën
 = 1;

674 
blk_b™s
 = 
	`Üd”_ba£_2
(
lblock
);

675  (
blk_b™s
 / 
	`EXT4_ADDR_PER_BLOCK_BITS
(
šode
->
i_sb
)) + 1;

676 
	}
}

682 
	$ext4_šd_Œªs_blocks
(
šode
 *šode, 
Äblocks
)

689  
	`DIV_ROUND_UP
(
Äblocks
, 
	`EXT4_ADDR_PER_BLOCK
(
šode
->
i_sb
)) + 4;

690 
	}
}

704 
	$Œy_to_ex‹nd_Œª§ùiÚ
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

706 ià(!
	`ext4_hªdË_v®id
(
hªdË
))

708 ià(
	`ext4_hªdË_has_’ough_üed™s
(
hªdË
, 
EXT4_RESERVE_TRANS_BLOCKS
+1))

710 ià(!
	`ext4_jouº®_ex‹nd
(
hªdË
, 
	`ext4_blocks_fÜ_Œunÿ‹
(
šode
)))

713 
	}
}

720 
šlše
 
	$®l_z”Ûs
(
__Ë32
 *
p
, __Ë32 *
q
)

722 
p
 < 
q
)

723 ià(*
p
++)

726 
	}
}

763 
Indœeù
 *
	$ext4_fšd_sh¬ed
(
šode
 *šode, 
d•th
,

764 
ext4_lblk_t
 
off£ts
[4], 
Indœeù
 
chaš
[4],

765 
__Ë32
 *
tİ
)

767 
Indœeù
 *
·¹Ÿl
, *
p
;

768 
k
, 
”r
;

770 *
tİ
 = 0;

772 
k
 = 
d•th
; k > 1 && !
off£ts
[k-1]; k--)

774 
·¹Ÿl
 = 
	`ext4_g‘_b¿nch
(
šode
, 
k
, 
off£ts
, 
chaš
, &
”r
);

776 ià(!
·¹Ÿl
)

777 
·¹Ÿl
 = 
chaš
 + 
k
-1;

782 ià(!
·¹Ÿl
->
key
 && *·¹Ÿl->
p
)

784 
no_tİ
;

785 
p
 = 
·¹Ÿl
; (°> 
chaš
è&& 
	`®l_z”Ûs
((
__Ë32
 *èp->
bh
->
b_d©a
,…->p);…--)

793 ià(
p
 =ğ
chaš
 + 
k
 - 1 &&… > chain) {

794 
p
->p--;

796 *
tİ
 = *
p
->p;

799 *
p
->p = 0;

804 
·¹Ÿl
 > 
p
) {

805 
	`b»l£
(
·¹Ÿl
->
bh
);

806 
·¹Ÿl
--;

808 
no_tİ
:

809  
·¹Ÿl
;

810 
	}
}

823 
	$ext4_ş—r_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

824 
bufãr_h—d
 *
bh
,

825 
ext4_fsblk_t
 
block_to_ä“
,

826 
couÁ
, 
__Ë32
 *
fœ¡
,

827 
__Ë32
 *
Ï¡
)

829 
__Ë32
 *
p
;

830 
æags
 = 
EXT4_FREE_BLOCKS_VALIDATED
;

831 
”r
;

833 ià(
	`S_ISDIR
(
šode
->
i_mode
è|| 
	`S_ISLNK
(inode->i_mode) ||

834 
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EA_INODE
))

835 
æags
 |ğ
EXT4_FREE_BLOCKS_FORGET
 | 
EXT4_FREE_BLOCKS_METADATA
;

836 ià(
	`ext4_should_jouº®_d©a
(
šode
))

837 
æags
 |ğ
EXT4_FREE_BLOCKS_FORGET
;

839 ià(!
	`ext4_d©a_block_v®id
(
	`EXT4_SB
(
šode
->
i_sb
), 
block_to_ä“
,

840 
couÁ
)) {

841 
	`EXT4_ERROR_INODE
(
šode
, "attempto clear invalid "

843 (è
block_to_ä“
, 
couÁ
);

847 ià(
	`Œy_to_ex‹nd_Œª§ùiÚ
(
hªdË
, 
šode
)) {

848 ià(
bh
) {

849 
	`BUFFER_TRACE
(
bh
, "callƒxt4_handle_dirty_metadata");

850 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

851 ià(
	`uÆik–y
(
”r
))

852 
out_”r
;

854 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

855 ià(
	`uÆik–y
(
”r
))

856 
out_”r
;

857 
”r
 = 
	`ext4_Œunÿ‹_»¡¬t_Œªs
(
hªdË
, 
šode
,

858 
	`ext4_blocks_fÜ_Œunÿ‹
(
šode
));

859 ià(
	`uÆik–y
(
”r
))

860 
out_”r
;

861 ià(
bh
) {

862 
	`BUFFER_TRACE
(
bh
, "retaking write‡ccess");

863 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

864 ià(
	`uÆik–y
(
”r
))

865 
out_”r
;

869 
p
 = 
fœ¡
;… < 
Ï¡
;…++)

870 *
p
 = 0;

872 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
block_to_ä“
, 
couÁ
, 
æags
);

874 
out_”r
:

875 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”r
);

876  
”r
;

877 
	}
}

898 
	$ext4_ä“_d©a
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

899 
bufãr_h—d
 *
this_bh
,

900 
__Ë32
 *
fœ¡
, __Ë32 *
Ï¡
)

902 
ext4_fsblk_t
 
block_to_ä“
 = 0;

903 
couÁ
 = 0;

904 
__Ë32
 *
block_to_ä“_p
 = 
NULL
;

907 
ext4_fsblk_t
 
Ä
;

908 
__Ë32
 *
p
;

910 
”r
 = 0;

912 ià(
this_bh
) {

913 
	`BUFFER_TRACE
(
this_bh
, "get_write_access");

914 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
this_bh
);

917 ià(
”r
)

921 
p
 = 
fœ¡
;… < 
Ï¡
;…++) {

922 
Ä
 = 
	`Ë32_to_ıu
(*
p
);

923 ià(
Ä
) {

925 ià(
couÁ
 == 0) {

926 
block_to_ä“
 = 
Ä
;

927 
block_to_ä“_p
 = 
p
;

928 
couÁ
 = 1;

929 } ià(
Ä
 =ğ
block_to_ä“
 + 
couÁ
) {

930 
couÁ
++;

932 
”r
 = 
	`ext4_ş—r_blocks
(
hªdË
, 
šode
, 
this_bh
,

933 
block_to_ä“
, 
couÁ
,

934 
block_to_ä“_p
, 
p
);

935 ià(
”r
)

937 
block_to_ä“
 = 
Ä
;

938 
block_to_ä“_p
 = 
p
;

939 
couÁ
 = 1;

944 ià(!
”r
 && 
couÁ
 > 0)

945 
”r
 = 
	`ext4_ş—r_blocks
(
hªdË
, 
šode
, 
this_bh
, 
block_to_ä“
,

946 
couÁ
, 
block_to_ä“_p
, 
p
);

947 ià(
”r
 < 0)

951 ià(
this_bh
) {

952 
	`BUFFER_TRACE
(
this_bh
, "callƒxt4_handle_dirty_metadata");

960 ià((
	`EXT4_JOURNAL
(
šode
è=ğ
NULL
è|| 
	`bh2jh
(
this_bh
))

961 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
this_bh
);

963 
	`EXT4_ERROR_INODE
(
šode
,

966 (è
this_bh
->
b_blockÄ
);

968 
	}
}

983 
	$ext4_ä“_b¿nches
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

984 
bufãr_h—d
 *
·»Á_bh
,

985 
__Ë32
 *
fœ¡
, __Ë32 *
Ï¡
, 
d•th
)

987 
ext4_fsblk_t
 
Ä
;

988 
__Ë32
 *
p
;

990 ià(
	`ext4_hªdË_is_abÜ‹d
(
hªdË
))

993 ià(
d•th
--) {

994 
bufãr_h—d
 *
bh
;

995 
addr_³r_block
 = 
	`EXT4_ADDR_PER_BLOCK
(
šode
->
i_sb
);

996 
p
 = 
Ï¡
;

997 --
p
 >ğ
fœ¡
) {

998 
Ä
 = 
	`Ë32_to_ıu
(*
p
);

999 ià(!
Ä
)

1002 ià(!
	`ext4_d©a_block_v®id
(
	`EXT4_SB
(
šode
->
i_sb
),

1003 
Ä
, 1)) {

1004 
	`EXT4_ERROR_INODE
(
šode
,

1007 (è
Ä
, 
d•th
);

1012 
bh
 = 
	`sb_b»ad
(
šode
->
i_sb
, 
Ä
);

1018 ià(!
bh
) {

1019 
	`EXT4_ERROR_INODE_BLOCK
(
šode
, 
Ä
,

1025 
	`BUFFER_TRACE
(
bh
, "free child branches");

1026 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
bh
,

1027 (
__Ë32
 *è
bh
->
b_d©a
,

1028 (
__Ë32
 *è
bh
->
b_d©a
 + 
addr_³r_block
,

1029 
d•th
);

1030 
	`b»l£
(
bh
);

1048 ià(
	`ext4_hªdË_is_abÜ‹d
(
hªdË
))

1050 ià(
	`Œy_to_ex‹nd_Œª§ùiÚ
(
hªdË
, 
šode
)) {

1051 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1052 
	`ext4_Œunÿ‹_»¡¬t_Œªs
(
hªdË
, 
šode
,

1053 
	`ext4_blocks_fÜ_Œunÿ‹
(
šode
));

1067 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
Ä
, 1,

1068 
EXT4_FREE_BLOCKS_METADATA
|

1069 
EXT4_FREE_BLOCKS_FORGET
);

1071 ià(
·»Á_bh
) {

1076 
	`BUFFER_TRACE
(
·»Á_bh
, "get_write_access");

1077 ià(!
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
,

1078 
·»Á_bh
)){

1079 *
p
 = 0;

1080 
	`BUFFER_TRACE
(
·»Á_bh
,

1082 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
,

1083 
šode
,

1084 
·»Á_bh
);

1090 
	`BUFFER_TRACE
(
·»Á_bh
, "free data blocks");

1091 
	`ext4_ä“_d©a
(
hªdË
, 
šode
, 
·»Á_bh
, 
fœ¡
, 
Ï¡
);

1093 
	}
}

1095 
	$ext4_šd_Œunÿ‹
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

1097 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

1098 
__Ë32
 *
i_d©a
 = 
ei
->i_data;

1099 
addr_³r_block
 = 
	`EXT4_ADDR_PER_BLOCK
(
šode
->
i_sb
);

1100 
ext4_lblk_t
 
off£ts
[4];

1101 
Indœeù
 
chaš
[4];

1102 
Indœeù
 *
·¹Ÿl
;

1103 
__Ë32
 
Ä
 = 0;

1104 
n
 = 0;

1105 
ext4_lblk_t
 
Ï¡_block
, 
max_block
;

1106 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

1108 
Ï¡_block
 = (
šode
->
i_size
 + 
blocksize
-1)

1109 >> 
	`EXT4_BLOCK_SIZE_BITS
(
šode
->
i_sb
);

1110 
max_block
 = (
	`EXT4_SB
(
šode
->
i_sb
)->
s_b™m­_maxby‹s
 + 
blocksize
-1)

1111 >> 
	`EXT4_BLOCK_SIZE_BITS
(
šode
->
i_sb
);

1113 ià(
Ï¡_block
 !ğ
max_block
) {

1114 
n
 = 
	`ext4_block_to_·th
(
šode
, 
Ï¡_block
, 
off£ts
, 
NULL
);

1115 ià(
n
 == 0)

1119 
	`ext4_es_»move_ex‹Á
(
šode
, 
Ï¡_block
, 
EXT_MAX_BLOCKS
 -†ast_block);

1128 
ei
->
i_disksize
 = 
šode
->
i_size
;

1130 ià(
Ï¡_block
 =ğ
max_block
) {

1136 } ià(
n
 == 1) {

1137 
	`ext4_ä“_d©a
(
hªdË
, 
šode
, 
NULL
, 
i_d©a
+
off£ts
[0],

1138 
i_d©a
 + 
EXT4_NDIR_BLOCKS
);

1139 
do_šdœeùs
;

1142 
·¹Ÿl
 = 
	`ext4_fšd_sh¬ed
(
šode
, 
n
, 
off£ts
, 
chaš
, &
Ä
);

1144 ià(
Ä
) {

1145 ià(
·¹Ÿl
 =ğ
chaš
) {

1147 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
,

1148 &
Ä
, &Ä+1, (
chaš
+
n
-1è- 
·¹Ÿl
);

1149 *
·¹Ÿl
->
p
 = 0;

1156 
	`BUFFER_TRACE
(
·¹Ÿl
->
bh
, "get_write_access");

1157 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl
->
bh
,

1158 
·¹Ÿl
->
p
,

1159 
·¹Ÿl
->
p
+1, (
chaš
+
n
-1) -…artial);

1163 
·¹Ÿl
 > 
chaš
) {

1164 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl
->
bh
,…¬tŸl->
p
 + 1,

1165 (
__Ë32
*)
·¹Ÿl
->
bh
->
b_d©a
+
addr_³r_block
,

1166 (
chaš
+
n
-1è- 
·¹Ÿl
);

1167 
	`BUFFER_TRACE
(
·¹Ÿl
->
bh
, "call brelse");

1168 
	`b»l£
(
·¹Ÿl
->
bh
);

1169 
·¹Ÿl
--;

1171 
do_šdœeùs
:

1173 
off£ts
[0]) {

1175 
Ä
 = 
i_d©a
[
EXT4_IND_BLOCK
];

1176 ià(
Ä
) {

1177 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
, &
Ä
, &nr+1, 1);

1178 
i_d©a
[
EXT4_IND_BLOCK
] = 0;

1181 
EXT4_IND_BLOCK
:

1182 
Ä
 = 
i_d©a
[
EXT4_DIND_BLOCK
];

1183 ià(
Ä
) {

1184 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
, &
Ä
, &nr+1, 2);

1185 
i_d©a
[
EXT4_DIND_BLOCK
] = 0;

1188 
EXT4_DIND_BLOCK
:

1189 
Ä
 = 
i_d©a
[
EXT4_TIND_BLOCK
];

1190 ià(
Ä
) {

1191 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
, &
Ä
, &nr+1, 3);

1192 
i_d©a
[
EXT4_TIND_BLOCK
] = 0;

1195 
EXT4_TIND_BLOCK
:

1198 
	}
}

1210 
	$ext4_šd_»move_¥aû
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1211 
ext4_lblk_t
 
¡¬t
,ƒxt4_lblk_ˆ
’d
)

1213 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

1214 
__Ë32
 *
i_d©a
 = 
ei
->i_data;

1215 
addr_³r_block
 = 
	`EXT4_ADDR_PER_BLOCK
(
šode
->
i_sb
);

1216 
ext4_lblk_t
 
off£ts
[4], 
off£ts2
[4];

1217 
Indœeù
 
chaš
[4], 
chaš2
[4];

1218 
Indœeù
 *
·¹Ÿl
, *
·¹Ÿl2
;

1219 
Indœeù
 *
p
 = 
NULL
, *
p2
 = NULL;

1220 
ext4_lblk_t
 
max_block
;

1221 
__Ë32
 
Ä
 = 0, 
Ä2
 = 0;

1222 
n
 = 0, 
n2
 = 0;

1223 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

1225 
max_block
 = (
	`EXT4_SB
(
šode
->
i_sb
)->
s_b™m­_maxby‹s
 + 
blocksize
-1)

1226 >> 
	`EXT4_BLOCK_SIZE_BITS
(
šode
->
i_sb
);

1227 ià(
’d
 >ğ
max_block
)

1228 
’d
 = 
max_block
;

1229 ià((
¡¬t
 >ğ
’d
è|| (¡¬ˆ> 
max_block
))

1232 
n
 = 
	`ext4_block_to_·th
(
šode
, 
¡¬t
, 
off£ts
, 
NULL
);

1233 
n2
 = 
	`ext4_block_to_·th
(
šode
, 
’d
, 
off£ts2
, 
NULL
);

1235 
	`BUG_ON
(
n
 > 
n2
);

1237 ià((
n
 =ğ1è&& (À=ğ
n2
)) {

1239 
	`ext4_ä“_d©a
(
hªdË
, 
šode
, 
NULL
, 
i_d©a
 + 
off£ts
[0],

1240 
i_d©a
 + 
off£ts2
[0]);

1242 } ià(
n2
 > 
n
) {

1250 ià(
n
 == 1) {

1255 
	`ext4_ä“_d©a
(
hªdË
, 
šode
, 
NULL
, 
i_d©a
 + 
off£ts
[0],

1256 
i_d©a
 + 
EXT4_NDIR_BLOCKS
);

1257 
’d_¿nge
;

1261 
·¹Ÿl
 = 
p
 = 
	`ext4_fšd_sh¬ed
(
šode
, 
n
, 
off£ts
, 
chaš
, &
Ä
);

1262 ià(
Ä
) {

1263 ià(
·¹Ÿl
 =ğ
chaš
) {

1265 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
,

1266 &
Ä
, &Ä+1, (
chaš
+
n
-1è- 
·¹Ÿl
);

1267 *
·¹Ÿl
->
p
 = 0;

1270 
	`BUFFER_TRACE
(
·¹Ÿl
->
bh
, "get_write_access");

1271 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl
->
bh
,

1272 
·¹Ÿl
->
p
,

1273 
·¹Ÿl
->
p
+1, (
chaš
+
n
-1) -…artial);

1281 
·¹Ÿl
 > 
chaš
) {

1282 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl
->
bh
,

1283 
·¹Ÿl
->
p
 + 1,

1284 (
__Ë32
 *)
·¹Ÿl
->
bh
->
b_d©a
+
addr_³r_block
,

1285 (
chaš
+
n
-1è- 
·¹Ÿl
);

1286 
·¹Ÿl
--;

1289 
’d_¿nge
:

1290 
·¹Ÿl2
 = 
p2
 = 
	`ext4_fšd_sh¬ed
(
šode
, 
n2
, 
off£ts2
, 
chaš2
, &
Ä2
);

1291 ià(
Ä2
) {

1292 ià(
·¹Ÿl2
 =ğ
chaš2
) {

1299 
do_šdœeùs
;

1308 
·¹Ÿl2
->
p
++;

1315 
·¹Ÿl2
 > 
chaš2
) {

1316 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl2
->
bh
,

1317 (
__Ë32
 *)
·¹Ÿl2
->
bh
->
b_d©a
,

1318 
·¹Ÿl2
->
p
,

1319 (
chaš2
+
n2
-1è- 
·¹Ÿl2
);

1320 
·¹Ÿl2
--;

1322 
do_šdœeùs
;

1326 
·¹Ÿl
 = 
p
 = 
	`ext4_fšd_sh¬ed
(
šode
, 
n
, 
off£ts
, 
chaš
, &
Ä
);

1327 
·¹Ÿl2
 = 
p2
 = 
	`ext4_fšd_sh¬ed
(
šode
, 
n2
, 
off£ts2
, 
chaš2
, &
Ä2
);

1330 ià(
Ä
) {

1331 
Ëv–
 = 
	`mš
(
·¹Ÿl
 - 
chaš
, 
·¹Ÿl2
 - 
chaš2
);

1332 
i
;

1333 
subŒ“
 = 1;

1335 
i
 = 0; i <ğ
Ëv–
; i++) {

1336 ià(
off£ts
[
i
] !ğ
off£ts2
[i]) {

1337 
subŒ“
 = 0;

1342 ià(!
subŒ“
) {

1343 ià(
·¹Ÿl
 =ğ
chaš
) {

1345 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
,

1346 &
Ä
, &nr+1,

1347 (
chaš
+
n
-1è- 
·¹Ÿl
);

1348 *
·¹Ÿl
->
p
 = 0;

1351 
	`BUFFER_TRACE
(
·¹Ÿl
->
bh
, "get_write_access");

1352 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl
->
bh
,

1353 
·¹Ÿl
->
p
,

1354 
·¹Ÿl
->
p
+1,

1355 (
chaš
+
n
-1è- 
·¹Ÿl
);

1360 ià(!
Ä2
) {

1367 
·¹Ÿl2
->
p
++;

1370 
·¹Ÿl
 > 
chaš
 || 
·¹Ÿl2
 > 
chaš2
) {

1371 
d•th
 = (
chaš
+
n
-1è- 
·¹Ÿl
;

1372 
d•th2
 = (
chaš2
+
n2
-1è- 
·¹Ÿl2
;

1374 ià(
·¹Ÿl
 > 
chaš
 && 
·¹Ÿl2
 > 
chaš2
 &&

1375 
·¹Ÿl
->
bh
->
b_blockÄ
 =ğ
·¹Ÿl2
->bh->b_blocknr) {

1380 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl
->
bh
,

1381 
·¹Ÿl
->
p
 + 1,

1382 
·¹Ÿl2
->
p
,

1383 (
chaš
+
n
-1è- 
·¹Ÿl
);

1384 
ş—nup
;

1394 ià(
·¹Ÿl
 > 
chaš
 && 
d•th
 <ğ
d•th2
) {

1395 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl
->
bh
,

1396 
·¹Ÿl
->
p
 + 1,

1397 (
__Ë32
 *)
·¹Ÿl
->
bh
->
b_d©a
+
addr_³r_block
,

1398 (
chaš
+
n
-1è- 
·¹Ÿl
);

1399 
·¹Ÿl
--;

1401 ià(
·¹Ÿl2
 > 
chaš2
 && 
d•th2
 <ğ
d•th
) {

1402 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl2
->
bh
,

1403 (
__Ë32
 *)
·¹Ÿl2
->
bh
->
b_d©a
,

1404 
·¹Ÿl2
->
p
,

1405 (
chaš2
+
n2
-1è- 
·¹Ÿl2
);

1406 
·¹Ÿl2
--;

1410 
ş—nup
:

1411 
p
 &&… > 
chaš
) {

1412 
	`BUFFER_TRACE
(
p
->
bh
, "call brelse");

1413 
	`b»l£
(
p
->
bh
);

1414 
p
--;

1416 
p2
 &&…2 > 
chaš2
) {

1417 
	`BUFFER_TRACE
(
p2
->
bh
, "call brelse");

1418 
	`b»l£
(
p2
->
bh
);

1419 
p2
--;

1423 
do_šdœeùs
:

1425 
off£ts
[0]) {

1427 ià(++
n
 >ğ
n2
)

1429 
Ä
 = 
i_d©a
[
EXT4_IND_BLOCK
];

1430 ià(
Ä
) {

1431 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
, &
Ä
, &nr+1, 1);

1432 
i_d©a
[
EXT4_IND_BLOCK
] = 0;

1435 
EXT4_IND_BLOCK
:

1436 ià(++
n
 >ğ
n2
)

1438 
Ä
 = 
i_d©a
[
EXT4_DIND_BLOCK
];

1439 ià(
Ä
) {

1440 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
, &
Ä
, &nr+1, 2);

1441 
i_d©a
[
EXT4_DIND_BLOCK
] = 0;

1444 
EXT4_DIND_BLOCK
:

1445 ià(++
n
 >ğ
n2
)

1447 
Ä
 = 
i_d©a
[
EXT4_TIND_BLOCK
];

1448 ià(
Ä
) {

1449 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
, &
Ä
, &nr+1, 3);

1450 
i_d©a
[
EXT4_TIND_BLOCK
] = 0;

1453 
EXT4_TIND_BLOCK
:

1456 
ş—nup
;

1457 
	}
}

	@pxt4/inline.c

7 
	~<lšux/iom­.h
>

8 
	~<lšux/f›m­.h
>

9 
	~<lšux/iv”siÚ.h
>

11 
	~"ext4_jbd2.h
"

12 
	~"ext4.h
"

13 
	~"x©Œ.h
"

14 
	~"Œunÿ‹.h
"

16 
	#EXT4_XATTR_SYSTEM_DATA
 "d©a"

	)

17 
	#EXT4_MIN_INLINE_DATA_SIZE
 (((
__Ë32
è* 
EXT4_N_BLOCKS
))

	)

18 
	#EXT4_INLINE_DOTDOT_OFFSET
 2

	)

19 
	#EXT4_INLINE_DOTDOT_SIZE
 4

	)

21 
	$ext4_g‘_šlše_size
(
šode
 *inode)

23 ià(
	`EXT4_I
(
šode
)->
i_šlše_off
)

24  
	`EXT4_I
(
šode
)->
i_šlše_size
;

27 
	}
}

29 
	$g‘_max_šlše_x©Œ_v®ue_size
(
šode
 *inode,

30 
ext4_oc
 *
oc
)

32 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

33 
ext4_x©Œ_’Œy
 *
’Œy
;

34 
ext4_šode
 *
¿w_šode
;

35 
ä“
, 
mš_offs
;

37 
mš_offs
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
 -

38 
EXT4_GOOD_OLD_INODE_SIZE
 -

39 
	`EXT4_I
(
šode
)->
i_exŒa_isize
 -

40 (
ext4_x©Œ_ibody_h—d”
);

47 ià(!
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
))

48  
	`EXT4_XATTR_SIZE
(
mš_offs
 -

49 
	`EXT4_XATTR_LEN
(
	`¡¾’
(
EXT4_XATTR_SYSTEM_DATA
)) -

50 
EXT4_XATTR_ROUND
 - (
__u32
));

52 
¿w_šode
 = 
	`ext4_¿w_šode
(
oc
);

53 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

54 
’Œy
 = 
	`IFIRST
(
h—d”
);

57 ; !
	`IS_LAST_ENTRY
(
’Œy
);ƒÁry = 
	`EXT4_XATTR_NEXT
(entry)) {

58 ià(!
’Œy
->
e_v®ue_šum
 &&ƒÁry->
e_v®ue_size
) {

59 
size_t
 
offs
 = 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_offs
);

60 ià(
offs
 < 
mš_offs
)

61 
mš_offs
 = 
offs
;

64 
ä“
 = 
mš_offs
 -

65 ((*)
’Œy
 - (*)
	`IFIRST
(
h—d”
)è- (
__u32
);

67 ià(
	`EXT4_I
(
šode
)->
i_šlše_off
) {

68 
’Œy
 = (
ext4_x©Œ_’Œy
 *)

69 ((*)
¿w_šode
 + 
	`EXT4_I
(
šode
)->
i_šlše_off
);

71 
ä“
 +ğ
	`EXT4_XATTR_SIZE
(
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
));

72 
out
;

75 
ä“
 -ğ
	`EXT4_XATTR_LEN
(
	`¡¾’
(
EXT4_XATTR_SYSTEM_DATA
));

77 ià(
ä“
 > 
EXT4_XATTR_ROUND
)

78 
ä“
 = 
	`EXT4_XATTR_SIZE
(ä“ - 
EXT4_XATTR_ROUND
);

80 
ä“
 = 0;

82 
out
:

83  
ä“
;

84 
	}
}

91 
	$ext4_g‘_max_šlše_size
(
šode
 *inode)

93 
”rÜ
, 
max_šlše_size
;

94 
ext4_oc
 
oc
;

96 ià(
	`EXT4_I
(
šode
)->
i_exŒa_isize
 == 0)

99 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

100 ià(
”rÜ
) {

101 
	`ext4_”rÜ_šode
(
šode
, 
__func__
, 
__LINE__
, 0,

103 
šode
->
i_šo
);

107 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

108 
max_šlše_size
 = 
	`g‘_max_šlše_x©Œ_v®ue_size
(
šode
, &
oc
);

109 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

111 
	`b»l£
(
oc
.
bh
);

113 ià(!
max_šlše_size
)

116  
max_šlše_size
 + 
EXT4_MIN_INLINE_DATA_SIZE
;

117 
	}
}

124 
	$ext4_fšd_šlše_d©a_nŞock
(
šode
 *inode)

126 
ext4_x©Œ_ibody_fšd
 
is
 = {

127 .
s
 = { .
nÙ_found
 = -
ENODATA
, },

129 
ext4_x©Œ_šfo
 
i
 = {

130 .
Çme_šdex
 = 
EXT4_XATTR_INDEX_SYSTEM
,

131 .
Çme
 = 
EXT4_XATTR_SYSTEM_DATA
,

133 
”rÜ
;

135 ià(
	`EXT4_I
(
šode
)->
i_exŒa_isize
 == 0)

138 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
is
.
oc
);

139 ià(
”rÜ
)

140  
”rÜ
;

142 
”rÜ
 = 
	`ext4_x©Œ_ibody_fšd
(
šode
, &
i
, &
is
);

143 ià(
”rÜ
)

144 
out
;

146 ià(!
is
.
s
.
nÙ_found
) {

147 ià(
is
.
s
.
h”e
->
e_v®ue_šum
) {

148 
	`EXT4_ERROR_INODE
(
šode
, "inline data xattr„efers "

150 
”rÜ
 = -
EFSCORRUPTED
;

151 
out
;

153 
	`EXT4_I
(
šode
)->
i_šlše_off
 = (
u16
)((*)
is
.
s
.
h”e
 -

154 (*)
	`ext4_¿w_šode
(&
is
.
oc
));

155 
	`EXT4_I
(
šode
)->
i_šlše_size
 = 
EXT4_MIN_INLINE_DATA_SIZE
 +

156 
	`Ë32_to_ıu
(
is
.
s
.
h”e
->
e_v®ue_size
);

157 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

159 
out
:

160 
	`b»l£
(
is
.
oc
.
bh
);

161  
”rÜ
;

162 
	}
}

164 
	$ext4_»ad_šlše_d©a
(
šode
 *šode, *
bufãr
,

165 
Ën
,

166 
ext4_oc
 *
oc
)

168 
ext4_x©Œ_’Œy
 *
’Œy
;

169 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

170 
ı_Ën
 = 0;

171 
ext4_šode
 *
¿w_šode
;

173 ià(!
Ën
)

176 
	`BUG_ON
(
Ën
 > 
	`EXT4_I
(
šode
)->
i_šlše_size
);

178 
ı_Ën
 = 
Ën
 < 
EXT4_MIN_INLINE_DATA_SIZE
 ?

179 
Ën
 : 
EXT4_MIN_INLINE_DATA_SIZE
;

181 
¿w_šode
 = 
	`ext4_¿w_šode
(
oc
);

182 
	`memıy
(
bufãr
, (*)(
¿w_šode
->
i_block
), 
ı_Ën
);

184 
Ën
 -ğ
ı_Ën
;

185 
bufãr
 +ğ
ı_Ën
;

187 ià(!
Ën
)

188 
out
;

190 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

191 
’Œy
 = (
ext4_x©Œ_’Œy
 *)((*)
¿w_šode
 +

192 
	`EXT4_I
(
šode
)->
i_šlše_off
);

193 
Ën
 = 
	`mš_t
(,†en,

194 ()
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
));

196 
	`memıy
(
bufãr
,

197 (*)
	`IFIRST
(
h—d”
è+ 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_offs
), 
Ën
);

198 
ı_Ën
 +ğ
Ën
;

200 
out
:

201  
ı_Ën
;

202 
	}
}

210 
	$ext4_wr™e_šlše_d©a
(
šode
 *šode, 
ext4_oc
 *
oc
,

211 *
bufãr
, 
loff_t
 
pos
, 
Ën
)

213 
ext4_x©Œ_’Œy
 *
’Œy
;

214 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

215 
ext4_šode
 *
¿w_šode
;

216 
ı_Ën
 = 0;

218 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

221 
	`BUG_ON
(!
	`EXT4_I
(
šode
)->
i_šlše_off
);

222 
	`BUG_ON
(
pos
 + 
Ën
 > 
	`EXT4_I
(
šode
)->
i_šlše_size
);

224 
¿w_šode
 = 
	`ext4_¿w_šode
(
oc
);

225 
bufãr
 +ğ
pos
;

227 ià(
pos
 < 
EXT4_MIN_INLINE_DATA_SIZE
) {

228 
ı_Ën
 = 
pos
 + 
Ën
 > 
EXT4_MIN_INLINE_DATA_SIZE
 ?

229 
EXT4_MIN_INLINE_DATA_SIZE
 - 
pos
 : 
Ën
;

230 
	`memıy
((*)
¿w_šode
->
i_block
 + 
pos
, 
bufãr
, 
ı_Ën
);

232 
Ën
 -ğ
ı_Ën
;

233 
bufãr
 +ğ
ı_Ën
;

234 
pos
 +ğ
ı_Ën
;

237 ià(!
Ën
)

240 
pos
 -ğ
EXT4_MIN_INLINE_DATA_SIZE
;

241 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

242 
’Œy
 = (
ext4_x©Œ_’Œy
 *)((*)
¿w_šode
 +

243 
	`EXT4_I
(
šode
)->
i_šlše_off
);

245 
	`memıy
((*)
	`IFIRST
(
h—d”
è+ 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_offs
è+ 
pos
,

246 
bufãr
, 
Ën
);

247 
	}
}

249 
	$ext4_ü—‹_šlše_d©a
(
hªdË_t
 *
hªdË
,

250 
šode
 *šode, 
Ën
)

252 
”rÜ
;

253 *
v®ue
 = 
NULL
;

254 
ext4_x©Œ_ibody_fšd
 
is
 = {

255 .
s
 = { .
nÙ_found
 = -
ENODATA
, },

257 
ext4_x©Œ_šfo
 
i
 = {

258 .
Çme_šdex
 = 
EXT4_XATTR_INDEX_SYSTEM
,

259 .
Çme
 = 
EXT4_XATTR_SYSTEM_DATA
,

262 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
is
.
oc
);

263 ià(
”rÜ
)

264  
”rÜ
;

266 
	`BUFFER_TRACE
(
is
.
oc
.
bh
, "get_write_access");

267 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
is
.
oc
.
bh
);

268 ià(
”rÜ
)

269 
out
;

271 ià(
Ën
 > 
EXT4_MIN_INLINE_DATA_SIZE
) {

272 
v®ue
 = 
EXT4_ZERO_XATTR_VALUE
;

273 
Ën
 -ğ
EXT4_MIN_INLINE_DATA_SIZE
;

275 
v®ue
 = "";

276 
Ën
 = 0;

280 
i
.
v®ue
 = value;

281 
i
.
v®ue_Ën
 = 
Ën
;

283 
”rÜ
 = 
	`ext4_x©Œ_ibody_fšd
(
šode
, &
i
, &
is
);

284 ià(
”rÜ
)

285 
out
;

287 
	`BUG_ON
(!
is
.
s
.
nÙ_found
);

289 
”rÜ
 = 
	`ext4_x©Œ_ibody_šlše_£t
(
hªdË
, 
šode
, &
i
, &
is
);

290 ià(
”rÜ
) {

291 ià(
”rÜ
 =ğ-
ENOSPC
)

292 
	`ext4_ş—r_šode_¡©e
(
šode
,

293 
EXT4_STATE_MAY_INLINE_DATA
);

294 
out
;

297 
	`mem£t
((*)
	`ext4_¿w_šode
(&
is
.
oc
)->
i_block
,

298 0, 
EXT4_MIN_INLINE_DATA_SIZE
);

300 
	`EXT4_I
(
šode
)->
i_šlše_off
 = (
u16
)((*)
is
.
s
.
h”e
 -

301 (*)
	`ext4_¿w_šode
(&
is
.
oc
));

302 
	`EXT4_I
(
šode
)->
i_šlše_size
 = 
Ën
 + 
EXT4_MIN_INLINE_DATA_SIZE
;

303 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
);

304 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_INLINE_DATA
);

305 
	`g‘_bh
(
is
.
oc
.
bh
);

306 
”rÜ
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
is
.
oc
);

308 
out
:

309 
	`b»l£
(
is
.
oc
.
bh
);

310  
”rÜ
;

311 
	}
}

313 
	$ext4_upd©e_šlše_d©a
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

314 
Ën
)

316 
”rÜ
;

317 *
v®ue
 = 
NULL
;

318 
ext4_x©Œ_ibody_fšd
 
is
 = {

319 .
s
 = { .
nÙ_found
 = -
ENODATA
, },

321 
ext4_x©Œ_šfo
 
i
 = {

322 .
Çme_šdex
 = 
EXT4_XATTR_INDEX_SYSTEM
,

323 .
Çme
 = 
EXT4_XATTR_SYSTEM_DATA
,

327 ià(
Ën
 <ğ
	`EXT4_I
(
šode
)->
i_šlše_size
)

330 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
is
.
oc
);

331 ià(
”rÜ
)

332  
”rÜ
;

334 
”rÜ
 = 
	`ext4_x©Œ_ibody_fšd
(
šode
, &
i
, &
is
);

335 ià(
”rÜ
)

336 
out
;

338 
	`BUG_ON
(
is
.
s
.
nÙ_found
);

340 
Ën
 -ğ
EXT4_MIN_INLINE_DATA_SIZE
;

341 
v®ue
 = 
	`kz®loc
(
Ën
, 
GFP_NOFS
);

342 ià(!
v®ue
) {

343 
”rÜ
 = -
ENOMEM
;

344 
out
;

347 
”rÜ
 = 
	`ext4_x©Œ_ibody_g‘
(
šode
, 
i
.
Çme_šdex
, i.
Çme
,

348 
v®ue
, 
Ën
);

349 ià(
”rÜ
 =ğ-
ENODATA
)

350 
out
;

352 
	`BUFFER_TRACE
(
is
.
oc
.
bh
, "get_write_access");

353 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
is
.
oc
.
bh
);

354 ià(
”rÜ
)

355 
out
;

358 
i
.
v®ue
 = value;

359 
i
.
v®ue_Ën
 = 
Ën
;

361 
”rÜ
 = 
	`ext4_x©Œ_ibody_šlše_£t
(
hªdË
, 
šode
, &
i
, &
is
);

362 ià(
”rÜ
)

363 
out
;

365 
	`EXT4_I
(
šode
)->
i_šlše_off
 = (
u16
)((*)
is
.
s
.
h”e
 -

366 (*)
	`ext4_¿w_šode
(&
is
.
oc
));

367 
	`EXT4_I
(
šode
)->
i_šlše_size
 = 
EXT4_MIN_INLINE_DATA_SIZE
 +

368 
	`Ë32_to_ıu
(
is
.
s
.
h”e
->
e_v®ue_size
);

369 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

370 
	`g‘_bh
(
is
.
oc
.
bh
);

371 
”rÜ
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
is
.
oc
);

373 
out
:

374 
	`kä“
(
v®ue
);

375 
	`b»l£
(
is
.
oc
.
bh
);

376  
”rÜ
;

377 
	}
}

379 
	$ext4_´•¬e_šlše_d©a
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

380 
Ën
)

382 
»t
, 
size
, 
no_ex·nd
;

383 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

385 ià(!
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
))

386  -
ENOSPC
;

388 
size
 = 
	`ext4_g‘_max_šlše_size
(
šode
);

389 ià(
size
 < 
Ën
)

390  -
ENOSPC
;

392 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

394 ià(
ei
->
i_šlše_off
)

395 
»t
 = 
	`ext4_upd©e_šlše_d©a
(
hªdË
, 
šode
, 
Ën
);

397 
»t
 = 
	`ext4_ü—‹_šlše_d©a
(
hªdË
, 
šode
, 
Ën
);

399 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

400  
»t
;

401 
	}
}

403 
	$ext4_de¡roy_šlše_d©a_nŞock
(
hªdË_t
 *
hªdË
,

404 
šode
 *inode)

406 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

407 
ext4_x©Œ_ibody_fšd
 
is
 = {

408 .
s
 = { .
nÙ_found
 = 0, },

410 
ext4_x©Œ_šfo
 
i
 = {

411 .
Çme_šdex
 = 
EXT4_XATTR_INDEX_SYSTEM
,

412 .
Çme
 = 
EXT4_XATTR_SYSTEM_DATA
,

413 .
v®ue
 = 
NULL
,

414 .
v®ue_Ën
 = 0,

416 
”rÜ
;

418 ià(!
ei
->
i_šlše_off
)

421 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
is
.
oc
);

422 ià(
”rÜ
)

423  
”rÜ
;

425 
”rÜ
 = 
	`ext4_x©Œ_ibody_fšd
(
šode
, &
i
, &
is
);

426 ià(
”rÜ
)

427 
out
;

429 
	`BUFFER_TRACE
(
is
.
oc
.
bh
, "get_write_access");

430 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
is
.
oc
.
bh
);

431 ià(
”rÜ
)

432 
out
;

434 
”rÜ
 = 
	`ext4_x©Œ_ibody_šlše_£t
(
hªdË
, 
šode
, &
i
, &
is
);

435 ià(
”rÜ
)

436 
out
;

438 
	`mem£t
((*)
	`ext4_¿w_šode
(&
is
.
oc
)->
i_block
,

439 0, 
EXT4_MIN_INLINE_DATA_SIZE
);

440 
	`mem£t
(
ei
->
i_d©a
, 0, 
EXT4_MIN_INLINE_DATA_SIZE
);

442 ià(
	`ext4_has_ã©u»_ex‹Ás
(
šode
->
i_sb
)) {

443 ià(
	`S_ISDIR
(
šode
->
i_mode
) ||

444 
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISLNK
(inode->i_mode)) {

445 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
);

446 
	`ext4_ext_Œ“_š™
(
hªdË
, 
šode
);

449 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_INLINE_DATA
);

451 
	`g‘_bh
(
is
.
oc
.
bh
);

452 
”rÜ
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
is
.
oc
);

454 
	`EXT4_I
(
šode
)->
i_šlše_off
 = 0;

455 
	`EXT4_I
(
šode
)->
i_šlše_size
 = 0;

456 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

457 
out
:

458 
	`b»l£
(
is
.
oc
.
bh
);

459 ià(
”rÜ
 =ğ-
ENODATA
)

460 
”rÜ
 = 0;

461  
”rÜ
;

462 
	}
}

464 
	$ext4_»ad_šlše_·ge
(
šode
 *šode, 
·ge
 *page)

466 *
kaddr
;

467 
»t
 = 0;

468 
size_t
 
Ën
;

469 
ext4_oc
 
oc
;

471 
	`BUG_ON
(!
	`PageLocked
(
·ge
));

472 
	`BUG_ON
(!
	`ext4_has_šlše_d©a
(
šode
));

473 
	`BUG_ON
(
·ge
->
šdex
);

475 ià(!
	`EXT4_I
(
šode
)->
i_šlše_off
) {

476 
	`ext4_w¬nšg
(
šode
->
i_sb
, "inode %lu doesn't have inline data.",

477 
šode
->
i_šo
);

478 
out
;

481 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

482 ià(
»t
)

483 
out
;

485 
Ën
 = 
	`mš_t
(
size_t
, 
	`ext4_g‘_šlše_size
(
šode
), 
	`i_size_»ad
(inode));

486 
kaddr
 = 
	`km­_©omic
(
·ge
);

487 
»t
 = 
	`ext4_»ad_šlše_d©a
(
šode
, 
kaddr
, 
Ën
, &
oc
);

488 
	`æush_dÿche_·ge
(
·ge
);

489 
	`kunm­_©omic
(
kaddr
);

490 
	`z”o_u£r_£gm’t
(
·ge
, 
Ën
, 
PAGE_SIZE
);

491 
	`S‘PageU±od©e
(
·ge
);

492 
	`b»l£
(
oc
.
bh
);

494 
out
:

495  
»t
;

496 
	}
}

498 
	$ext4_»ad·ge_šlše
(
šode
 *šode, 
·ge
 *page)

500 
»t
 = 0;

502 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

503 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

504 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

505  -
EAGAIN
;

512 ià(!
·ge
->
šdex
)

513 
»t
 = 
	`ext4_»ad_šlše_·ge
(
šode
, 
·ge
);

514 ià(!
	`PageU±od©e
(
·ge
)) {

515 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_SIZE
);

516 
	`S‘PageU±od©e
(
·ge
);

519 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

521 
	`uÆock_·ge
(
·ge
);

522  
»t
 >= 0 ? 0 :„et;

523 
	}
}

525 
	$ext4_cÚv”t_šlše_d©a_to_ex‹Á
(
add»ss_¥aû
 *
m­pšg
,

526 
šode
 *inode,

527 
æags
)

529 
»t
, 
Ãeded_blocks
, 
no_ex·nd
;

530 
hªdË_t
 *
hªdË
 = 
NULL
;

531 
»Œ›s
 = 0, 
£m_h–d
 = 0;

532 
·ge
 *·gğ
NULL
;

533 
äom
, 
to
;

534 
ext4_oc
 
oc
;

536 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

541 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

545 
Ãeded_blocks
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

547 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

548 ià(
»t
)

549  
»t
;

551 
»Œy
:

552 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_WRITE_PAGE
, 
Ãeded_blocks
);

553 ià(
	`IS_ERR
(
hªdË
)) {

554 
»t
 = 
	`PTR_ERR
(
hªdË
);

555 
hªdË
 = 
NULL
;

556 
out
;

561 
æags
 |ğ
AOP_FLAG_NOFS
;

563 
·ge
 = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
, 0, 
æags
);

564 ià(!
·ge
) {

565 
»t
 = -
ENOMEM
;

566 
out
;

569 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

570 
£m_h–d
 = 1;

572 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

573 
»t
 = 0;

574 
out
;

577 
äom
 = 0;

578 
to
 = 
	`ext4_g‘_šlše_size
(
šode
);

579 ià(!
	`PageU±od©e
(
·ge
)) {

580 
»t
 = 
	`ext4_»ad_šlše_·ge
(
šode
, 
·ge
);

581 ià(
»t
 < 0)

582 
out
;

585 
»t
 = 
	`ext4_de¡roy_šlše_d©a_nŞock
(
hªdË
, 
šode
);

586 ià(
»t
)

587 
out
;

589 ià(
	`ext4_should_diÜ—d_nŞock
(
šode
)) {

590 
»t
 = 
	`__block_wr™e_begš
(
·ge
, 
äom
, 
to
,

591 
ext4_g‘_block_unwr™‹n
);

593 
»t
 = 
	`__block_wr™e_begš
(
·ge
, 
äom
, 
to
, 
ext4_g‘_block
);

595 ià(!
»t
 && 
	`ext4_should_jouº®_d©a
(
šode
)) {

596 
»t
 = 
	`ext4_w®k_·ge_bufãrs
(
hªdË
, 
	`·ge_bufãrs
(
·ge
),

597 
äom
, 
to
, 
NULL
,

598 
do_jouº®_g‘_wr™e_acûss
);

601 ià(
»t
) {

602 
	`uÆock_·ge
(
·ge
);

603 
	`put_·ge
(
·ge
);

604 
·ge
 = 
NULL
;

605 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

606 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

607 
£m_h–d
 = 0;

608 
	`ext4_jouº®_¡İ
(
hªdË
);

609 
hªdË
 = 
NULL
;

610 
	`ext4_Œunÿ‹_çed_wr™e
(
šode
);

617 ià(
šode
->
i_Æšk
)

618 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

621 ià(
»t
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

622 
»Œy
;

624 ià(
·ge
)

625 
	`block_comm™_wr™e
(
·ge
, 
äom
, 
to
);

626 
out
:

627 ià(
·ge
) {

628 
	`uÆock_·ge
(
·ge
);

629 
	`put_·ge
(
·ge
);

631 ià(
£m_h–d
)

632 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

633 ià(
hªdË
)

634 
	`ext4_jouº®_¡İ
(
hªdË
);

635 
	`b»l£
(
oc
.
bh
);

636  
»t
;

637 
	}
}

645 
	$ext4_Œy_to_wr™e_šlše_d©a
(
add»ss_¥aû
 *
m­pšg
,

646 
šode
 *inode,

647 
loff_t
 
pos
, 
Ën
,

648 
æags
,

649 
·ge
 **
·g•
)

651 
»t
;

652 
hªdË_t
 *
hªdË
;

653 
·ge
 *page;

654 
ext4_oc
 
oc
;

656 ià(
pos
 + 
Ën
 > 
	`ext4_g‘_max_šlše_size
(
šode
))

657 
cÚv”t
;

659 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

660 ià(
»t
)

661  
»t
;

667 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 1);

668 ià(
	`IS_ERR
(
hªdË
)) {

669 
»t
 = 
	`PTR_ERR
(
hªdË
);

670 
hªdË
 = 
NULL
;

671 
out
;

674 
»t
 = 
	`ext4_´•¬e_šlše_d©a
(
hªdË
, 
šode
, 
pos
 + 
Ën
);

675 ià(
»t
 &&„‘ !ğ-
ENOSPC
)

676 
out
;

679 ià(
»t
 =ğ-
ENOSPC
) {

680 
	`ext4_jouº®_¡İ
(
hªdË
);

681 
	`b»l£
(
oc
.
bh
);

682 
cÚv”t
;

685 
»t
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
oc
.
bh
);

686 ià(
»t
)

687 
out
;

689 
æags
 |ğ
AOP_FLAG_NOFS
;

691 
·ge
 = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
, 0, 
æags
);

692 ià(!
·ge
) {

693 
»t
 = -
ENOMEM
;

694 
out
;

697 *
·g•
 = 
·ge
;

698 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

699 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

700 
»t
 = 0;

701 
	`uÆock_·ge
(
·ge
);

702 
	`put_·ge
(
·ge
);

703 
out_up_»ad
;

706 ià(!
	`PageU±od©e
(
·ge
)) {

707 
»t
 = 
	`ext4_»ad_šlše_·ge
(
šode
, 
·ge
);

708 ià(
»t
 < 0) {

709 
	`uÆock_·ge
(
·ge
);

710 
	`put_·ge
(
·ge
);

711 
out_up_»ad
;

715 
»t
 = 1;

716 
hªdË
 = 
NULL
;

717 
out_up_»ad
:

718 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

719 
out
:

720 ià(
hªdË
 && (
»t
 != 1))

721 
	`ext4_jouº®_¡İ
(
hªdË
);

722 
	`b»l£
(
oc
.
bh
);

723  
»t
;

724 
cÚv”t
:

725  
	`ext4_cÚv”t_šlše_d©a_to_ex‹Á
(
m­pšg
,

726 
šode
, 
æags
);

727 
	}
}

729 
	$ext4_wr™e_šlše_d©a_’d
(
šode
 *šode, 
loff_t
 
pos
, 
Ën
,

730 
cİ›d
, 
·ge
 *page)

732 
»t
, 
no_ex·nd
;

733 *
kaddr
;

734 
ext4_oc
 
oc
;

736 ià(
	`uÆik–y
(
cİ›d
 < 
Ën
)) {

737 ià(!
	`PageU±od©e
(
·ge
)) {

738 
cİ›d
 = 0;

739 
out
;

743 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

744 ià(
»t
) {

745 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
»t
);

746 
cİ›d
 = 0;

747 
out
;

750 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

751 
	`BUG_ON
(!
	`ext4_has_šlše_d©a
(
šode
));

753 
kaddr
 = 
	`km­_©omic
(
·ge
);

754 
	`ext4_wr™e_šlše_d©a
(
šode
, &
oc
, 
kaddr
, 
pos
, 
Ën
);

755 
	`kunm­_©omic
(
kaddr
);

756 
	`S‘PageU±od©e
(
·ge
);

758 
	`CË¬PageDœty
(
·ge
);

760 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

761 
	`b»l£
(
oc
.
bh
);

762 
	`m¬k_šode_dœty
(
šode
);

763 
out
:

764  
cİ›d
;

765 
	}
}

767 
bufãr_h—d
 *

768 
	$ext4_jouº®Ëd_wr™e_šlše_d©a
(
šode
 *inode,

769 
Ën
,

770 
·ge
 *page)

772 
»t
, 
no_ex·nd
;

773 *
kaddr
;

774 
ext4_oc
 
oc
;

776 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

777 ià(
»t
) {

778 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
»t
);

779  
NULL
;

782 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

783 
kaddr
 = 
	`km­_©omic
(
·ge
);

784 
	`ext4_wr™e_šlše_d©a
(
šode
, &
oc
, 
kaddr
, 0, 
Ën
);

785 
	`kunm­_©omic
(
kaddr
);

786 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

788  
oc
.
bh
;

789 
	}
}

800 
	$ext4_da_cÚv”t_šlše_d©a_to_ex‹Á
(
add»ss_¥aû
 *
m­pšg
,

801 
šode
 *inode,

802 
æags
,

803 **
fsd©a
)

805 
»t
 = 0, 
šlše_size
;

806 
·ge
 *page;

808 
·ge
 = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
, 0, 
æags
);

809 ià(!
·ge
)

810  -
ENOMEM
;

812 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

813 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

814 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

815 
out
;

818 
šlše_size
 = 
	`ext4_g‘_šlše_size
(
šode
);

820 ià(!
	`PageU±od©e
(
·ge
)) {

821 
»t
 = 
	`ext4_»ad_šlše_·ge
(
šode
, 
·ge
);

822 ià(
»t
 < 0)

823 
out
;

826 
»t
 = 
	`__block_wr™e_begš
(
·ge
, 0, 
šlše_size
,

827 
ext4_da_g‘_block_´•
);

828 ià(
»t
) {

829 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

830 
	`uÆock_·ge
(
·ge
);

831 
	`put_·ge
(
·ge
);

832 
	`ext4_Œunÿ‹_çed_wr™e
(
šode
);

833  
»t
;

836 
	`S‘PageDœty
(
·ge
);

837 
	`S‘PageU±od©e
(
·ge
);

838 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

839 *
fsd©a
 = (*)
CONVERT_INLINE_DATA
;

841 
out
:

842 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

843 ià(
·ge
) {

844 
	`uÆock_·ge
(
·ge
);

845 
	`put_·ge
(
·ge
);

847  
»t
;

848 
	}
}

858 
	$ext4_da_wr™e_šlše_d©a_begš
(
add»ss_¥aû
 *
m­pšg
,

859 
šode
 *inode,

860 
loff_t
 
pos
, 
Ën
,

861 
æags
,

862 
·ge
 **
·g•
,

863 **
fsd©a
)

865 
»t
, 
šlše_size
;

866 
hªdË_t
 *
hªdË
;

867 
·ge
 *page;

868 
ext4_oc
 
oc
;

869 
»Œ›s
 = 0;

871 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

872 ià(
»t
)

873  
»t
;

875 
»Œy_jouº®
:

876 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 1);

877 ià(
	`IS_ERR
(
hªdË
)) {

878 
»t
 = 
	`PTR_ERR
(
hªdË
);

879 
out
;

882 
šlše_size
 = 
	`ext4_g‘_max_šlše_size
(
šode
);

884 
»t
 = -
ENOSPC
;

885 ià(
šlše_size
 >ğ
pos
 + 
Ën
) {

886 
»t
 = 
	`ext4_´•¬e_šlše_d©a
(
hªdË
, 
šode
, 
pos
 + 
Ën
);

887 ià(
»t
 &&„‘ !ğ-
ENOSPC
)

888 
out_jouº®
;

895 
æags
 |ğ
AOP_FLAG_NOFS
;

897 ià(
»t
 =ğ-
ENOSPC
) {

898 
	`ext4_jouº®_¡İ
(
hªdË
);

899 
»t
 = 
	`ext4_da_cÚv”t_šlše_d©a_to_ex‹Á
(
m­pšg
,

900 
šode
,

901 
æags
,

902 
fsd©a
);

903 ià(
»t
 =ğ-
ENOSPC
 &&

904 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

905 
»Œy_jouº®
;

906 
out
;

909 
·ge
 = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
, 0, 
æags
);

910 ià(!
·ge
) {

911 
»t
 = -
ENOMEM
;

912 
out_jouº®
;

915 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

916 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

917 
»t
 = 0;

918 
out_»Ëa£_·ge
;

921 ià(!
	`PageU±od©e
(
·ge
)) {

922 
»t
 = 
	`ext4_»ad_šlše_·ge
(
šode
, 
·ge
);

923 ià(
»t
 < 0)

924 
out_»Ëa£_·ge
;

926 
»t
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
oc
.
bh
);

927 ià(
»t
)

928 
out_»Ëa£_·ge
;

930 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

931 *
·g•
 = 
·ge
;

932 
	`b»l£
(
oc
.
bh
);

934 
out_»Ëa£_·ge
:

935 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

936 
	`uÆock_·ge
(
·ge
);

937 
	`put_·ge
(
·ge
);

938 
out_jouº®
:

939 
	`ext4_jouº®_¡İ
(
hªdË
);

940 
out
:

941 
	`b»l£
(
oc
.
bh
);

942  
»t
;

943 
	}
}

945 
	$ext4_da_wr™e_šlše_d©a_’d
(
šode
 *šode, 
loff_t
 
pos
,

946 
Ën
, 
cİ›d
,

947 
·ge
 *page)

949 
»t
;

951 
»t
 = 
	`ext4_wr™e_šlše_d©a_’d
(
šode
, 
pos
, 
Ën
, 
cİ›d
, 
·ge
);

952 ià(
»t
 < 0) {

953 
	`uÆock_·ge
(
·ge
);

954 
	`put_·ge
(
·ge
);

955  
»t
;

957 
cİ›d
 = 
»t
;

966 ià(
pos
+
cİ›d
 > 
šode
->
i_size
)

967 
	`i_size_wr™e
(
šode
, 
pos
+
cİ›d
);

968 
	`uÆock_·ge
(
·ge
);

969 
	`put_·ge
(
·ge
);

977 
	`m¬k_šode_dœty
(
šode
);

979  
cİ›d
;

980 
	}
}

982 #ifdeà
INLINE_DIR_DEBUG


983 
	$ext4_show_šlše_dœ
(
šode
 *
dœ
, 
bufãr_h—d
 *
bh
,

984 *
šlše_¡¬t
, 
šlše_size
)

986 
off£t
;

987 
de_Ën
;

988 
ext4_dœ_’Œy_2
 *
de
 = 
šlše_¡¬t
;

989 *
dlim™
 = 
šlše_¡¬t
 + 
šlše_size
;

991 
	`Œaû_´štk
("šod%lu\n", 
dœ
->
i_šo
);

992 
off£t
 = 0;

993 (*)
de
 < 
dlim™
) {

994 
de_Ën
 = 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
šlše_size
);

995 
	`Œaû_´štk
("de: off %u„len %u‚ame %.*s‚len %u ino %u\n",

996 
off£t
, 
de_Ën
, 
de
->
Çme_Ën
, de->
Çme
,

997 
de
->
Çme_Ën
, 
	`Ë32_to_ıu
(de->
šode
));

998 ià(
	`ext4_check_dœ_’Œy
(
dœ
, 
NULL
, 
de
, 
bh
,

999 
šlše_¡¬t
, 
šlše_size
, 
off£t
))

1000 
	`BUG
();

1002 
off£t
 +ğ
de_Ën
;

1003 
de
 = (
ext4_dœ_’Œy_2
 *è((*èd+ 
de_Ën
);

1005 
	}
}

1007 
	#ext4_show_šlše_dœ
(
dœ
, 
bh
, 
šlše_¡¬t
, 
šlše_size
)

	)

1015 
	$ext4_add_dœ’t_to_šlše
(
hªdË_t
 *
hªdË
,

1016 
ext4_f’ame
 *
âame
,

1017 
šode
 *
dœ
,

1018 
šode
 *inode,

1019 
ext4_oc
 *
oc
,

1020 *
šlše_¡¬t
, 
šlše_size
)

1022 
”r
;

1023 
ext4_dœ_’Œy_2
 *
de
;

1025 
”r
 = 
	`ext4_fšd_de¡_de
(
dœ
, 
šode
, 
oc
->
bh
, 
šlše_¡¬t
,

1026 
šlše_size
, 
âame
, &
de
);

1027 ià(
”r
)

1028  
”r
;

1030 
	`BUFFER_TRACE
(
oc
->
bh
, "get_write_access");

1031 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
oc
->
bh
);

1032 ià(
”r
)

1033  
”r
;

1034 
	`ext4_š£¹_d’Œy
(
šode
, 
de
, 
šlše_size
, 
âame
);

1036 
	`ext4_show_šlše_dœ
(
dœ
, 
oc
->
bh
, 
šlše_¡¬t
, 
šlše_size
);

1049 
dœ
->
i_mtime
 = dœ->
i_ùime
 = 
	`cu¼’t_time
(dir);

1050 
	`ext4_upd©e_dx_æag
(
dœ
);

1051 
	`šode_šc_iv”siÚ
(
dœ
);

1053 
	}
}

1055 *
	$ext4_g‘_šlše_x©Œ_pos
(
šode
 *inode,

1056 
ext4_oc
 *
oc
)

1058 
ext4_x©Œ_’Œy
 *
’Œy
;

1059 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

1061 
	`BUG_ON
(!
	`EXT4_I
(
šode
)->
i_šlše_off
);

1063 
h—d”
 = 
	`IHDR
(
šode
, 
	`ext4_¿w_šode
(
oc
));

1064 
’Œy
 = (
ext4_x©Œ_’Œy
 *)((*)
	`ext4_¿w_šode
(
oc
) +

1065 
	`EXT4_I
(
šode
)->
i_šlše_off
);

1067  (*)
	`IFIRST
(
h—d”
è+ 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_offs
);

1068 
	}
}

1071 
	$ext4_upd©e_fš®_de
(*
de_buf
, 
Şd_size
, 
Ãw_size
)

1073 
ext4_dœ_’Œy_2
 *
de
, *
´ev_de
;

1074 *
lim™
;

1075 
de_Ën
;

1077 
de
 = (
ext4_dœ_’Œy_2
 *)
de_buf
;

1078 ià(
Şd_size
) {

1079 
lim™
 = 
de_buf
 + 
Şd_size
;

1081 
´ev_de
 = 
de
;

1082 
de_Ën
 = 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
Şd_size
);

1083 
de_buf
 +ğ
de_Ën
;

1084 
de
 = (
ext4_dœ_’Œy_2
 *)
de_buf
;

1085 } 
de_buf
 < 
lim™
);

1087 
´ev_de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
de_Ën
 + 
Ãw_size
 -

1088 
Şd_size
, 
Ãw_size
);

1091 
de
->
šode
 = 0;

1092 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
Ãw_size
,‚ew_size);

1094 
	}
}

1096 
	$ext4_upd©e_šlše_dœ
(
hªdË_t
 *
hªdË
, 
šode
 *
dœ
,

1097 
ext4_oc
 *
oc
)

1099 
»t
;

1100 
Şd_size
 = 
	`EXT4_I
(
dœ
)->
i_šlše_size
 - 
EXT4_MIN_INLINE_DATA_SIZE
;

1101 
Ãw_size
 = 
	`g‘_max_šlše_x©Œ_v®ue_size
(
dœ
, 
oc
);

1103 ià(
Ãw_size
 - 
Şd_size
 <ğ
	`EXT4_DIR_REC_LEN
(1))

1104  -
ENOSPC
;

1106 
»t
 = 
	`ext4_upd©e_šlše_d©a
(
hªdË
, 
dœ
,

1107 
Ãw_size
 + 
EXT4_MIN_INLINE_DATA_SIZE
);

1108 ià(
»t
)

1109  
»t
;

1111 
	`ext4_upd©e_fš®_de
(
	`ext4_g‘_šlše_x©Œ_pos
(
dœ
, 
oc
), 
Şd_size
,

1112 
	`EXT4_I
(
dœ
)->
i_šlše_size
 -

1113 
EXT4_MIN_INLINE_DATA_SIZE
);

1114 
dœ
->
i_size
 = 
	`EXT4_I
(dœ)->
i_disksize
 = EXT4_I(dœ)->
i_šlše_size
;

1116 
	}
}

1118 
	$ext4_»¡Üe_šlše_d©a
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1119 
ext4_oc
 *
oc
,

1120 *
buf
, 
šlše_size
)

1122 
	`ext4_ü—‹_šlše_d©a
(
hªdË
, 
šode
, 
šlše_size
);

1123 
	`ext4_wr™e_šlše_d©a
(
šode
, 
oc
, 
buf
, 0, 
šlše_size
);

1124 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

1125 
	}
}

1127 
	$ext4_fšish_cÚv”t_šlše_dœ
(
hªdË_t
 *
hªdË
,

1128 
šode
 *inode,

1129 
bufãr_h—d
 *
dœ_block
,

1130 *
buf
,

1131 
šlše_size
)

1133 
”r
, 
csum_size
 = 0, 
h—d”_size
 = 0;

1134 
ext4_dœ_’Œy_2
 *
de
;

1135 *
rg‘
 = 
dœ_block
->
b_d©a
;

1141 
de
 = (
ext4_dœ_’Œy_2
 *)
rg‘
;

1142 
de
 = 
	`ext4_š™_dÙ_dÙdÙ
(
šode
, de,

1143 
šode
->
i_sb
->
s_blocksize
, 
csum_size
,

1144 
	`Ë32_to_ıu
(((
ext4_dœ_’Œy_2
 *)
buf
)->
šode
), 1);

1145 
h—d”_size
 = (*)
de
 - 
rg‘
;

1147 
	`memıy
((*)
de
, 
buf
 + 
EXT4_INLINE_DOTDOT_SIZE
,

1148 
šlše_size
 - 
EXT4_INLINE_DOTDOT_SIZE
);

1150 ià(
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

1151 
csum_size
 = (
ext4_dœ_’Œy_
);

1153 
šode
->
i_size
 = inode->
i_sb
->
s_blocksize
;

1154 
	`i_size_wr™e
(
šode
, inode->
i_sb
->
s_blocksize
);

1155 
	`EXT4_I
(
šode
)->
i_disksize
 = inode->
i_sb
->
s_blocksize
;

1156 
	`ext4_upd©e_fš®_de
(
dœ_block
->
b_d©a
,

1157 
šlše_size
 - 
EXT4_INLINE_DOTDOT_SIZE
 + 
h—d”_size
,

1158 
šode
->
i_sb
->
s_blocksize
 - 
csum_size
);

1160 ià(
csum_size
)

1161 
	`ext4_š™Ÿlize_dœ’t_
(
dœ_block
,

1162 
šode
->
i_sb
->
s_blocksize
);

1163 
	`£t_bufãr_u±od©e
(
dœ_block
);

1164 
”r
 = 
	`ext4_hªdË_dœty_dœblock
(
hªdË
, 
šode
, 
dœ_block
);

1165 ià(
”r
)

1166  
”r
;

1167 
	`£t_bufãr_v”if›d
(
dœ_block
);

1168  
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1169 
	}
}

1171 
	$ext4_cÚv”t_šlše_d©a_nŞock
(
hªdË_t
 *
hªdË
,

1172 
šode
 *inode,

1173 
ext4_oc
 *
oc
)

1175 
”rÜ
;

1176 *
buf
 = 
NULL
;

1177 
bufãr_h—d
 *
d©a_bh
 = 
NULL
;

1178 
ext4_m­_blocks
 
m­
;

1179 
šlše_size
;

1181 
šlše_size
 = 
	`ext4_g‘_šlše_size
(
šode
);

1182 
buf
 = 
	`km®loc
(
šlše_size
, 
GFP_NOFS
);

1183 ià(!
buf
) {

1184 
”rÜ
 = -
ENOMEM
;

1185 
out
;

1188 
”rÜ
 = 
	`ext4_»ad_šlše_d©a
(
šode
, 
buf
, 
šlše_size
, 
oc
);

1189 ià(
”rÜ
 < 0)

1190 
out
;

1196 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

1197 
”rÜ
 = 
	`ext4_check_®l_de
(
šode
, 
oc
->
bh
,

1198 
buf
 + 
EXT4_INLINE_DOTDOT_SIZE
,

1199 
šlše_size
 - 
EXT4_INLINE_DOTDOT_SIZE
);

1200 ià(
”rÜ
)

1201 
out
;

1204 
”rÜ
 = 
	`ext4_de¡roy_šlše_d©a_nŞock
(
hªdË
, 
šode
);

1205 ià(
”rÜ
)

1206 
out
;

1208 
m­
.
m_lblk
 = 0;

1209 
m­
.
m_Ën
 = 1;

1210 
m­
.
m_æags
 = 0;

1211 
”rÜ
 = 
	`ext4_m­_blocks
(
hªdË
, 
šode
, &
m­
, 
EXT4_GET_BLOCKS_CREATE
);

1212 ià(
”rÜ
 < 0)

1213 
out_»¡Üe
;

1214 ià(!(
m­
.
m_æags
 & 
EXT4_MAP_MAPPED
)) {

1215 
”rÜ
 = -
EIO
;

1216 
out_»¡Üe
;

1219 
d©a_bh
 = 
	`sb_g‘blk
(
šode
->
i_sb
, 
m­
.
m_pblk
);

1220 ià(!
d©a_bh
) {

1221 
”rÜ
 = -
ENOMEM
;

1222 
out_»¡Üe
;

1225 
	`lock_bufãr
(
d©a_bh
);

1226 
”rÜ
 = 
	`ext4_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
d©a_bh
);

1227 ià(
”rÜ
) {

1228 
	`uÆock_bufãr
(
d©a_bh
);

1229 
”rÜ
 = -
EIO
;

1230 
out_»¡Üe
;

1232 
	`mem£t
(
d©a_bh
->
b_d©a
, 0, 
šode
->
i_sb
->
s_blocksize
);

1234 ià(!
	`S_ISDIR
(
šode
->
i_mode
)) {

1235 
	`memıy
(
d©a_bh
->
b_d©a
, 
buf
, 
šlše_size
);

1236 
	`£t_bufãr_u±od©e
(
d©a_bh
);

1237 
”rÜ
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
,

1238 
šode
, 
d©a_bh
);

1240 
”rÜ
 = 
	`ext4_fšish_cÚv”t_šlše_dœ
(
hªdË
, 
šode
, 
d©a_bh
,

1241 
buf
, 
šlše_size
);

1244 
	`uÆock_bufãr
(
d©a_bh
);

1245 
out_»¡Üe
:

1246 ià(
”rÜ
)

1247 
	`ext4_»¡Üe_šlše_d©a
(
hªdË
, 
šode
, 
oc
, 
buf
, 
šlše_size
);

1249 
out
:

1250 
	`b»l£
(
d©a_bh
);

1251 
	`kä“
(
buf
);

1252  
”rÜ
;

1253 
	}
}

1260 
	$ext4_Œy_add_šlše_’Œy
(
hªdË_t
 *
hªdË
, 
ext4_f’ame
 *
âame
,

1261 
šode
 *
dœ
, inode *inode)

1263 
»t
, 
šlše_size
, 
no_ex·nd
;

1264 *
šlše_¡¬t
;

1265 
ext4_oc
 
oc
;

1267 
»t
 = 
	`ext4_g‘_šode_loc
(
dœ
, &
oc
);

1268 ià(
»t
)

1269  
»t
;

1271 
	`ext4_wr™e_lock_x©Œ
(
dœ
, &
no_ex·nd
);

1272 ià(!
	`ext4_has_šlše_d©a
(
dœ
))

1273 
out
;

1275 
šlše_¡¬t
 = (*)
	`ext4_¿w_šode
(&
oc
)->
i_block
 +

1276 
EXT4_INLINE_DOTDOT_SIZE
;

1277 
šlše_size
 = 
EXT4_MIN_INLINE_DATA_SIZE
 - 
EXT4_INLINE_DOTDOT_SIZE
;

1279 
»t
 = 
	`ext4_add_dœ’t_to_šlše
(
hªdË
, 
âame
, 
dœ
, 
šode
, &
oc
,

1280 
šlše_¡¬t
, 
šlše_size
);

1281 ià(
»t
 !ğ-
ENOSPC
)

1282 
out
;

1285 
šlše_size
 = 
	`EXT4_I
(
dœ
)->
i_šlše_size
 -

1286 
EXT4_MIN_INLINE_DATA_SIZE
;

1287 ià(!
šlše_size
) {

1289 
»t
 = 
	`ext4_upd©e_šlše_dœ
(
hªdË
, 
dœ
, &
oc
);

1290 ià(
»t
 &&„‘ !ğ-
ENOSPC
)

1291 
out
;

1293 
šlše_size
 = 
	`EXT4_I
(
dœ
)->
i_šlše_size
 -

1294 
EXT4_MIN_INLINE_DATA_SIZE
;

1297 ià(
šlše_size
) {

1298 
šlše_¡¬t
 = 
	`ext4_g‘_šlše_x©Œ_pos
(
dœ
, &
oc
);

1300 
»t
 = 
	`ext4_add_dœ’t_to_šlše
(
hªdË
, 
âame
, 
dœ
,

1301 
šode
, &
oc
, 
šlše_¡¬t
,

1302 
šlše_size
);

1304 ià(
»t
 !ğ-
ENOSPC
)

1305 
out
;

1313 
»t
 = 
	`ext4_cÚv”t_šlše_d©a_nŞock
(
hªdË
, 
dœ
, &
oc
);

1315 
out
:

1316 
	`ext4_wr™e_uÆock_x©Œ
(
dœ
, &
no_ex·nd
);

1317 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dœ
);

1318 
	`b»l£
(
oc
.
bh
);

1319  
»t
;

1320 
	}
}

1327 
	$ext4_šlšedœ_to_Œ“
(
fe
 *
dœ_fe
,

1328 
šode
 *
dœ
, 
ext4_lblk_t
 
block
,

1329 
dx_hash_šfo
 *
hšfo
,

1330 
__u32
 
¡¬t_hash
, __u32 
¡¬t_mšÜ_hash
,

1331 *
has_šlše_d©a
)

1333 
”r
 = 0, 
couÁ
 = 0;

1334 
·»Á_šo
;

1335 
pos
;

1336 
ext4_dœ_’Œy_2
 *
de
;

1337 
šode
 *šodğ
	`fe_šode
(
dœ_fe
);

1338 
»t
, 
šlše_size
 = 0;

1339 
ext4_oc
 
oc
;

1340 *
dœ_buf
 = 
NULL
;

1341 
ext4_dœ_’Œy_2
 
çke
;

1342 
fsüy±_¡r
 
tmp_¡r
;

1344 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

1345 ià(
»t
)

1346  
»t
;

1348 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1349 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

1350 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1351 *
has_šlše_d©a
 = 0;

1352 
out
;

1355 
šlše_size
 = 
	`ext4_g‘_šlše_size
(
šode
);

1356 
dœ_buf
 = 
	`km®loc
(
šlše_size
, 
GFP_NOFS
);

1357 ià(!
dœ_buf
) {

1358 
»t
 = -
ENOMEM
;

1359 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1360 
out
;

1363 
»t
 = 
	`ext4_»ad_šlše_d©a
(
šode
, 
dœ_buf
, 
šlše_size
, &
oc
);

1364 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1365 ià(
»t
 < 0)

1366 
out
;

1368 
pos
 = 0;

1369 
·»Á_šo
 = 
	`Ë32_to_ıu
(((
ext4_dœ_’Œy_2
 *)
dœ_buf
)->
šode
);

1370 
pos
 < 
šlše_size
) {

1376 ià(
pos
 == 0) {

1377 
çke
.
šode
 = 
	`ıu_to_Ë32
(šode->
i_šo
);

1378 
çke
.
Çme_Ën
 = 1;

1379 
	`¡rıy
(
çke
.
Çme
, ".");

1380 
çke
.
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(

1381 
	`EXT4_DIR_REC_LEN
(
çke
.
Çme_Ën
),

1382 
šlše_size
);

1383 
	`ext4_£t_de_ty³
(
šode
->
i_sb
, &
çke
, 
S_IFDIR
);

1384 
de
 = &
çke
;

1385 
pos
 = 
EXT4_INLINE_DOTDOT_OFFSET
;

1386 } ià(
pos
 =ğ
EXT4_INLINE_DOTDOT_OFFSET
) {

1387 
çke
.
šode
 = 
	`ıu_to_Ë32
(
·»Á_šo
);

1388 
çke
.
Çme_Ën
 = 2;

1389 
	`¡rıy
(
çke
.
Çme
, "..");

1390 
çke
.
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(

1391 
	`EXT4_DIR_REC_LEN
(
çke
.
Çme_Ën
),

1392 
šlše_size
);

1393 
	`ext4_£t_de_ty³
(
šode
->
i_sb
, &
çke
, 
S_IFDIR
);

1394 
de
 = &
çke
;

1395 
pos
 = 
EXT4_INLINE_DOTDOT_SIZE
;

1397 
de
 = (
ext4_dœ_’Œy_2
 *)(
dœ_buf
 + 
pos
);

1398 
pos
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
šlše_size
);

1399 ià(
	`ext4_check_dœ_’Œy
(
šode
, 
dœ_fe
, 
de
,

1400 
oc
.
bh
, 
dœ_buf
,

1401 
šlše_size
, 
pos
)) {

1402 
»t
 = 
couÁ
;

1403 
out
;

1407 
	`ext4fs_dœhash
(
dœ
, 
de
->
Çme
, de->
Çme_Ën
, 
hšfo
);

1408 ià((
hšfo
->
hash
 < 
¡¬t_hash
) ||

1409 ((
hšfo
->
hash
 =ğ
¡¬t_hash
) &&

1410 (
hšfo
->
mšÜ_hash
 < 
¡¬t_mšÜ_hash
)))

1412 ià(
de
->
šode
 == 0)

1414 
tmp_¡r
.
Çme
 = 
de
->name;

1415 
tmp_¡r
.
Ën
 = 
de
->
Çme_Ën
;

1416 
”r
 = 
	`ext4_hŒ“_¡Üe_dœ’t
(
dœ_fe
, 
hšfo
->
hash
,

1417 
hšfo
->
mšÜ_hash
, 
de
, &
tmp_¡r
);

1418 ià(
”r
) {

1419 
»t
 = 
”r
;

1420 
out
;

1422 
couÁ
++;

1424 
»t
 = 
couÁ
;

1425 
out
:

1426 
	`kä“
(
dœ_buf
);

1427 
	`b»l£
(
oc
.
bh
);

1428  
»t
;

1429 
	}
}

1439 
	$ext4_»ad_šlše_dœ
(
fe
 *file,

1440 
dœ_cÚ‹xt
 *
ùx
,

1441 *
has_šlše_d©a
)

1443 
off£t
, 
·»Á_šo
;

1444 
i
;

1445 
ext4_dœ_’Œy_2
 *
de
;

1446 
su³r_block
 *
sb
;

1447 
šode
 *šodğ
	`fe_šode
(
fe
);

1448 
»t
, 
šlše_size
 = 0;

1449 
ext4_oc
 
oc
;

1450 *
dœ_buf
 = 
NULL
;

1451 
dÙdÙ_off£t
, 
dÙdÙ_size
, 
exŒa_off£t
, 
exŒa_size
;

1453 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

1454 ià(
»t
)

1455  
»t
;

1457 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1458 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

1459 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1460 *
has_šlše_d©a
 = 0;

1461 
out
;

1464 
šlše_size
 = 
	`ext4_g‘_šlše_size
(
šode
);

1465 
dœ_buf
 = 
	`km®loc
(
šlše_size
, 
GFP_NOFS
);

1466 ià(!
dœ_buf
) {

1467 
»t
 = -
ENOMEM
;

1468 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1469 
out
;

1472 
»t
 = 
	`ext4_»ad_šlše_d©a
(
šode
, 
dœ_buf
, 
šlše_size
, &
oc
);

1473 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1474 ià(
»t
 < 0)

1475 
out
;

1477 
»t
 = 0;

1478 
sb
 = 
šode
->
i_sb
;

1479 
·»Á_šo
 = 
	`Ë32_to_ıu
(((
ext4_dœ_’Œy_2
 *)
dœ_buf
)->
šode
);

1480 
off£t
 = 
ùx
->
pos
;

1489 
dÙdÙ_off£t
 = 
	`EXT4_DIR_REC_LEN
(1);

1490 
dÙdÙ_size
 = 
dÙdÙ_off£t
 + 
	`EXT4_DIR_REC_LEN
(2);

1491 
exŒa_off£t
 = 
dÙdÙ_size
 - 
EXT4_INLINE_DOTDOT_SIZE
;

1492 
exŒa_size
 = 
exŒa_off£t
 + 
šlše_size
;

1500 ià(!
	`šode_eq_iv”siÚ
(
šode
, 
fe
->
f_v”siÚ
)) {

1501 
i
 = 0; i < 
exŒa_size
 && i < 
off£t
;) {

1506 ià(!
i
) {

1507 
i
 = 
dÙdÙ_off£t
;

1509 } ià(
i
 =ğ
dÙdÙ_off£t
) {

1510 
i
 = 
dÙdÙ_size
;

1516 
de
 = (
ext4_dœ_’Œy_2
 *)

1517 (
dœ_buf
 + 
i
 - 
exŒa_off£t
);

1524 ià(
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
exŒa_size
)

1525 < 
	`EXT4_DIR_REC_LEN
(1))

1527 
i
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
,

1528 
exŒa_size
);

1530 
off£t
 = 
i
;

1531 
ùx
->
pos
 = 
off£t
;

1532 
fe
->
f_v”siÚ
 = 
	`šode_qu”y_iv”siÚ
(
šode
);

1535 
ùx
->
pos
 < 
exŒa_size
) {

1536 ià(
ùx
->
pos
 == 0) {

1537 ià(!
	`dœ_em™
(
ùx
, ".", 1, 
šode
->
i_šo
, 
DT_DIR
))

1538 
out
;

1539 
ùx
->
pos
 = 
dÙdÙ_off£t
;

1543 ià(
ùx
->
pos
 =ğ
dÙdÙ_off£t
) {

1544 ià(!
	`dœ_em™
(
ùx
, "..", 2, 
·»Á_šo
, 
DT_DIR
))

1545 
out
;

1546 
ùx
->
pos
 = 
dÙdÙ_size
;

1550 
de
 = (
ext4_dœ_’Œy_2
 *)

1551 (
dœ_buf
 + 
ùx
->
pos
 - 
exŒa_off£t
);

1552 ià(
	`ext4_check_dœ_’Œy
(
šode
, 
fe
, 
de
, 
oc
.
bh
, 
dœ_buf
,

1553 
exŒa_size
, 
ùx
->
pos
))

1554 
out
;

1555 ià(
	`Ë32_to_ıu
(
de
->
šode
)) {

1556 ià(!
	`dœ_em™
(
ùx
, 
de
->
Çme
, de->
Çme_Ën
,

1557 
	`Ë32_to_ıu
(
de
->
šode
),

1558 
	`g‘_dty³
(
sb
, 
de
->
fe_ty³
)))

1559 
out
;

1561 
ùx
->
pos
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
exŒa_size
);

1563 
out
:

1564 
	`kä“
(
dœ_buf
);

1565 
	`b»l£
(
oc
.
bh
);

1566  
»t
;

1567 
	}
}

1569 
bufãr_h—d
 *
	$ext4_g‘_fœ¡_šlše_block
(
šode
 *inode,

1570 
ext4_dœ_’Œy_2
 **
·»Á_de
,

1571 *
»tv®
)

1573 
ext4_oc
 
oc
;

1575 *
»tv®
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

1576 ià(*
»tv®
)

1577  
NULL
;

1579 *
·»Á_de
 = (
ext4_dœ_’Œy_2
 *)
	`ext4_¿w_šode
(&
oc
)->
i_block
;

1581  
oc
.
bh
;

1582 
	}
}

1589 
	$ext4_Œy_ü—‹_šlše_dœ
(
hªdË_t
 *
hªdË
, 
šode
 *
·»Á
,

1590 
šode
 *inode)

1592 
»t
, 
šlše_size
 = 
EXT4_MIN_INLINE_DATA_SIZE
;

1593 
ext4_oc
 
oc
;

1594 
ext4_dœ_’Œy_2
 *
de
;

1596 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

1597 ià(
»t
)

1598  
»t
;

1600 
»t
 = 
	`ext4_´•¬e_šlše_d©a
(
hªdË
, 
šode
, 
šlše_size
);

1601 ià(
»t
)

1602 
out
;

1608 
de
 = (
ext4_dœ_’Œy_2
 *)
	`ext4_¿w_šode
(&
oc
)->
i_block
;

1609 
de
->
šode
 = 
	`ıu_to_Ë32
(
·»Á
->
i_šo
);

1610 
de
 = (
ext4_dœ_’Œy_2
 *)((*)d+ 
EXT4_INLINE_DOTDOT_SIZE
);

1611 
de
->
šode
 = 0;

1612 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(

1613 
šlše_size
 - 
EXT4_INLINE_DOTDOT_SIZE
,

1614 
šlše_size
);

1615 
	`£t_Æšk
(
šode
, 2);

1616 
šode
->
i_size
 = 
	`EXT4_I
(šode)->
i_disksize
 = 
šlše_size
;

1617 
out
:

1618 
	`b»l£
(
oc
.
bh
);

1619  
»t
;

1620 
	}
}

1622 
bufãr_h—d
 *
	$ext4_fšd_šlše_’Œy
(
šode
 *
dœ
,

1623 
ext4_f’ame
 *
âame
,

1624 
ext4_dœ_’Œy_2
 **
»s_dœ
,

1625 *
has_šlše_d©a
)

1627 
»t
;

1628 
ext4_oc
 
oc
;

1629 *
šlše_¡¬t
;

1630 
šlše_size
;

1632 ià(
	`ext4_g‘_šode_loc
(
dœ
, &
oc
))

1633  
NULL
;

1635 
	`down_»ad
(&
	`EXT4_I
(
dœ
)->
x©Œ_£m
);

1636 ià(!
	`ext4_has_šlše_d©a
(
dœ
)) {

1637 *
has_šlše_d©a
 = 0;

1638 
out
;

1641 
šlše_¡¬t
 = (*)
	`ext4_¿w_šode
(&
oc
)->
i_block
 +

1642 
EXT4_INLINE_DOTDOT_SIZE
;

1643 
šlše_size
 = 
EXT4_MIN_INLINE_DATA_SIZE
 - 
EXT4_INLINE_DOTDOT_SIZE
;

1644 
»t
 = 
	`ext4_£¬ch_dœ
(
oc
.
bh
, 
šlše_¡¬t
, 
šlše_size
,

1645 
dœ
, 
âame
, 0, 
»s_dœ
);

1646 ià(
»t
 == 1)

1647 
out_fšd
;

1648 ià(
»t
 < 0)

1649 
out
;

1651 ià(
	`ext4_g‘_šlše_size
(
dœ
è=ğ
EXT4_MIN_INLINE_DATA_SIZE
)

1652 
out
;

1654 
šlše_¡¬t
 = 
	`ext4_g‘_šlše_x©Œ_pos
(
dœ
, &
oc
);

1655 
šlše_size
 = 
	`ext4_g‘_šlše_size
(
dœ
è- 
EXT4_MIN_INLINE_DATA_SIZE
;

1657 
»t
 = 
	`ext4_£¬ch_dœ
(
oc
.
bh
, 
šlše_¡¬t
, 
šlše_size
,

1658 
dœ
, 
âame
, 0, 
»s_dœ
);

1659 ià(
»t
 == 1)

1660 
out_fšd
;

1662 
out
:

1663 
	`b»l£
(
oc
.
bh
);

1664 
oc
.
bh
 = 
NULL
;

1665 
out_fšd
:

1666 
	`up_»ad
(&
	`EXT4_I
(
dœ
)->
x©Œ_£m
);

1667  
oc
.
bh
;

1668 
	}
}

1670 
	$ext4_d–‘e_šlše_’Œy
(
hªdË_t
 *
hªdË
,

1671 
šode
 *
dœ
,

1672 
ext4_dœ_’Œy_2
 *
de_d–
,

1673 
bufãr_h—d
 *
bh
,

1674 *
has_šlše_d©a
)

1676 
”r
, 
šlše_size
, 
no_ex·nd
;

1677 
ext4_oc
 
oc
;

1678 *
šlše_¡¬t
;

1680 
”r
 = 
	`ext4_g‘_šode_loc
(
dœ
, &
oc
);

1681 ià(
”r
)

1682  
”r
;

1684 
	`ext4_wr™e_lock_x©Œ
(
dœ
, &
no_ex·nd
);

1685 ià(!
	`ext4_has_šlše_d©a
(
dœ
)) {

1686 *
has_šlše_d©a
 = 0;

1687 
out
;

1690 ià((*)
de_d–
 - ((*)
	`ext4_¿w_šode
(&
oc
)->
i_block
) <

1691 
EXT4_MIN_INLINE_DATA_SIZE
) {

1692 
šlše_¡¬t
 = (*)
	`ext4_¿w_šode
(&
oc
)->
i_block
 +

1693 
EXT4_INLINE_DOTDOT_SIZE
;

1694 
šlše_size
 = 
EXT4_MIN_INLINE_DATA_SIZE
 -

1695 
EXT4_INLINE_DOTDOT_SIZE
;

1697 
šlše_¡¬t
 = 
	`ext4_g‘_šlše_x©Œ_pos
(
dœ
, &
oc
);

1698 
šlše_size
 = 
	`ext4_g‘_šlše_size
(
dœ
) -

1699 
EXT4_MIN_INLINE_DATA_SIZE
;

1702 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1703 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

1704 ià(
”r
)

1705 
out
;

1707 
”r
 = 
	`ext4_g’”ic_d–‘e_’Œy
(
hªdË
, 
dœ
, 
de_d–
, 
bh
,

1708 
šlše_¡¬t
, 
šlše_size
, 0);

1709 ià(
”r
)

1710 
out
;

1712 
	`ext4_show_šlše_dœ
(
dœ
, 
oc
.
bh
, 
šlše_¡¬t
, 
šlše_size
);

1713 
out
:

1714 
	`ext4_wr™e_uÆock_x©Œ
(
dœ
, &
no_ex·nd
);

1715 ià(
	`lik–y
(
”r
 == 0))

1716 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dœ
);

1717 
	`b»l£
(
oc
.
bh
);

1718 ià(
”r
 !ğ-
ENOENT
)

1719 
	`ext4_¡d_”rÜ
(
dœ
->
i_sb
, 
”r
);

1720  
”r
;

1721 
	}
}

1726 
šlše
 
ext4_dœ_’Œy_2
 *

1727 
	$ext4_g‘_šlše_’Œy
(
šode
 *inode,

1728 
ext4_oc
 *
oc
,

1729 
off£t
,

1730 **
šlše_¡¬t
,

1731 *
šlše_size
)

1733 *
šlše_pos
;

1735 
	`BUG_ON
(
off£t
 > 
	`ext4_g‘_šlše_size
(
šode
));

1737 ià(
off£t
 < 
EXT4_MIN_INLINE_DATA_SIZE
) {

1738 
šlše_pos
 = (*)
	`ext4_¿w_šode
(
oc
)->
i_block
;

1739 *
šlše_size
 = 
EXT4_MIN_INLINE_DATA_SIZE
;

1741 
šlše_pos
 = 
	`ext4_g‘_šlše_x©Œ_pos
(
šode
, 
oc
);

1742 
off£t
 -ğ
EXT4_MIN_INLINE_DATA_SIZE
;

1743 *
šlše_size
 = 
	`ext4_g‘_šlše_size
(
šode
) -

1744 
EXT4_MIN_INLINE_DATA_SIZE
;

1747 ià(
šlše_¡¬t
)

1748 *
šlše_¡¬t
 = 
šlše_pos
;

1749  (
ext4_dœ_’Œy_2
 *)(
šlše_pos
 + 
off£t
);

1750 
	}
}

1752 
boŞ
 
	$em±y_šlše_dœ
(
šode
 *
dœ
, *
has_šlše_d©a
)

1754 
”r
, 
šlše_size
;

1755 
ext4_oc
 
oc
;

1756 
size_t
 
šlše_Ën
;

1757 *
šlše_pos
;

1758 
off£t
;

1759 
ext4_dœ_’Œy_2
 *
de
;

1760 
boŞ
 
»t
 = 
Œue
;

1762 
”r
 = 
	`ext4_g‘_šode_loc
(
dœ
, &
oc
);

1763 ià(
”r
) {

1764 
	`EXT4_ERROR_INODE
(
dœ
, "error %d getting inode %lu block",

1765 
”r
, 
dœ
->
i_šo
);

1766  
Œue
;

1769 
	`down_»ad
(&
	`EXT4_I
(
dœ
)->
x©Œ_£m
);

1770 ià(!
	`ext4_has_šlše_d©a
(
dœ
)) {

1771 *
has_šlše_d©a
 = 0;

1772 
out
;

1775 
de
 = (
ext4_dœ_’Œy_2
 *)
	`ext4_¿w_šode
(&
oc
)->
i_block
;

1776 ià(!
	`Ë32_to_ıu
(
de
->
šode
)) {

1777 
	`ext4_w¬nšg
(
dœ
->
i_sb
,

1779 
dœ
->
i_šo
);

1780 
»t
 = 
Œue
;

1781 
out
;

1784 
šlše_Ën
 = 
	`ext4_g‘_šlše_size
(
dœ
);

1785 
off£t
 = 
EXT4_INLINE_DOTDOT_SIZE
;

1786 
off£t
 < 
šlše_Ën
) {

1787 
de
 = 
	`ext4_g‘_šlše_’Œy
(
dœ
, &
oc
, 
off£t
,

1788 &
šlše_pos
, &
šlše_size
);

1789 ià(
	`ext4_check_dœ_’Œy
(
dœ
, 
NULL
, 
de
,

1790 
oc
.
bh
, 
šlše_pos
,

1791 
šlše_size
, 
off£t
)) {

1792 
	`ext4_w¬nšg
(
dœ
->
i_sb
,

1796 
dœ
->
i_šo
, 
	`Ë32_to_ıu
(
de
->
šode
),

1797 
	`Ë16_to_ıu
(
de
->
»c_Ën
), de->
Çme_Ën
,

1798 
šlše_size
);

1799 
»t
 = 
Œue
;

1800 
out
;

1802 ià(
	`Ë32_to_ıu
(
de
->
šode
)) {

1803 
»t
 = 
çl£
;

1804 
out
;

1806 
off£t
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
šlše_size
);

1809 
out
:

1810 
	`up_»ad
(&
	`EXT4_I
(
dœ
)->
x©Œ_£m
);

1811 
	`b»l£
(
oc
.
bh
);

1812  
»t
;

1813 
	}
}

1815 
	$ext4_de¡roy_šlše_d©a
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

1817 
»t
, 
no_ex·nd
;

1819 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

1820 
»t
 = 
	`ext4_de¡roy_šlše_d©a_nŞock
(
hªdË
, 
šode
);

1821 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

1823  
»t
;

1824 
	}
}

1826 
	$ext4_šlše_d©a_iom­
(
šode
 *šode, 
iom­
 *iomap)

1828 
__u64
 
addr
;

1829 
”rÜ
 = -
EAGAIN
;

1830 
ext4_oc
 
oc
;

1832 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1833 ià(!
	`ext4_has_šlše_d©a
(
šode
))

1834 
out
;

1836 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

1837 ià(
”rÜ
)

1838 
out
;

1840 
addr
 = (
__u64
)
oc
.
bh
->
b_blockÄ
 << 
šode
->
i_sb
->
s_blocksize_b™s
;

1841 
addr
 +ğ(*)
	`ext4_¿w_šode
(&
oc
è- iloc.
bh
->
b_d©a
;

1842 
addr
 +ğ
	`off£tof
(
ext4_šode
, 
i_block
);

1844 
	`b»l£
(
oc
.
bh
);

1846 
iom­
->
addr
 =‡ddr;

1847 
iom­
->
off£t
 = 0;

1848 
iom­
->
Ëngth
 = 
	`mš_t
(
loff_t
, 
	`ext4_g‘_šlše_size
(
šode
),

1849 
	`i_size_»ad
(
šode
));

1850 
iom­
->
ty³
 = 
IOMAP_INLINE
;

1851 
iom­
->
æags
 = 0;

1853 
out
:

1854 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1855  
”rÜ
;

1856 
	}
}

1858 
	$ext4_šlše_d©a_f›m­
(
šode
 *inode,

1859 
f›m­_ex‹Á_šfo
 *
f›šfo
,

1860 *
has_šlše
, 
__u64
 
¡¬t
, __u64 
Ën
)

1862 
__u64
 
physiÿl
 = 0;

1863 
__u64
 
šlše_Ën
;

1864 
__u32
 
æags
 = 
FIEMAP_EXTENT_DATA_INLINE
 | 
FIEMAP_EXTENT_NOT_ALIGNED
 |

1865 
FIEMAP_EXTENT_LAST
;

1866 
”rÜ
 = 0;

1867 
ext4_oc
 
oc
;

1869 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1870 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

1871 *
has_šlše
 = 0;

1872 
out
;

1874 
šlše_Ën
 = 
	`mš_t
(
size_t
, 
	`ext4_g‘_šlše_size
(
šode
),

1875 
	`i_size_»ad
(
šode
));

1876 ià(
¡¬t
 >ğ
šlše_Ën
)

1877 
out
;

1878 ià(
¡¬t
 + 
Ën
 < 
šlše_Ën
)

1879 
šlše_Ën
 = 
¡¬t
 + 
Ën
;

1880 
šlše_Ën
 -ğ
¡¬t
;

1882 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

1883 ià(
”rÜ
)

1884 
out
;

1886 
physiÿl
 = (
__u64
)
oc
.
bh
->
b_blockÄ
 << 
šode
->
i_sb
->
s_blocksize_b™s
;

1887 
physiÿl
 +ğ(*)
	`ext4_¿w_šode
(&
oc
è- iloc.
bh
->
b_d©a
;

1888 
physiÿl
 +ğ
	`off£tof
(
ext4_šode
, 
i_block
);

1890 
	`b»l£
(
oc
.
bh
);

1891 
out
:

1892 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1893 ià(
physiÿl
)

1894 
”rÜ
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
, 
¡¬t
, 
physiÿl
,

1895 
šlše_Ën
, 
æags
);

1896  (
”rÜ
 < 0 ?ƒrror : 0);

1897 
	}
}

1899 
	$ext4_šlše_d©a_Œunÿ‹
(
šode
 *šode, *
has_šlše
)

1901 
hªdË_t
 *
hªdË
;

1902 
šlše_size
, 
v®ue_Ën
, 
Ãeded_blocks
, 
no_ex·nd
, 
”r
 = 0;

1903 
size_t
 
i_size
;

1904 *
v®ue
 = 
NULL
;

1905 
ext4_x©Œ_ibody_fšd
 
is
 = {

1906 .
s
 = { .
nÙ_found
 = -
ENODATA
, },

1908 
ext4_x©Œ_šfo
 
i
 = {

1909 .
Çme_šdex
 = 
EXT4_XATTR_INDEX_SYSTEM
,

1910 .
Çme
 = 
EXT4_XATTR_SYSTEM_DATA
,

1914 
Ãeded_blocks
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

1915 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 
Ãeded_blocks
);

1916 ià(
	`IS_ERR
(
hªdË
))

1917  
	`PTR_ERR
(
hªdË
);

1919 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

1920 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

1921 *
has_šlše
 = 0;

1922 
	`ext4_jouº®_¡İ
(
hªdË
);

1926 ià((
”r
 = 
	`ext4_Üphª_add
(
hªdË
, 
šode
)) != 0)

1927 
out
;

1929 ià((
”r
 = 
	`ext4_g‘_šode_loc
(
šode
, &
is
.
oc
)) != 0)

1930 
out
;

1932 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

1933 
i_size
 = 
šode
->i_size;

1934 
šlše_size
 = 
	`ext4_g‘_šlše_size
(
šode
);

1935 
	`EXT4_I
(
šode
)->
i_disksize
 = 
i_size
;

1937 ià(
i_size
 < 
šlše_size
) {

1939 ià(
šlše_size
 > 
EXT4_MIN_INLINE_DATA_SIZE
) {

1940 ià((
”r
 = 
	`ext4_x©Œ_ibody_fšd
(
šode
, &
i
, &
is
)) != 0)

1941 
out_”rÜ
;

1943 
	`BUG_ON
(
is
.
s
.
nÙ_found
);

1945 
v®ue_Ën
 = 
	`Ë32_to_ıu
(
is
.
s
.
h”e
->
e_v®ue_size
);

1946 
v®ue
 = 
	`km®loc
(
v®ue_Ën
, 
GFP_NOFS
);

1947 ià(!
v®ue
) {

1948 
”r
 = -
ENOMEM
;

1949 
out_”rÜ
;

1952 
”r
 = 
	`ext4_x©Œ_ibody_g‘
(
šode
, 
i
.
Çme_šdex
,

1953 
i
.
Çme
, 
v®ue
, 
v®ue_Ën
);

1954 ià(
”r
 <= 0)

1955 
out_”rÜ
;

1957 
i
.
v®ue
 = value;

1958 
i
.
v®ue_Ën
 = 
i_size
 > 
EXT4_MIN_INLINE_DATA_SIZE
 ?

1959 
i_size
 - 
EXT4_MIN_INLINE_DATA_SIZE
 : 0;

1960 
”r
 = 
	`ext4_x©Œ_ibody_šlše_£t
(
hªdË
, 
šode
,

1961 &
i
, &
is
);

1962 ià(
”r
)

1963 
out_”rÜ
;

1967 ià(
i_size
 < 
EXT4_MIN_INLINE_DATA_SIZE
) {

1968 *
p
 = (*è
	`ext4_¿w_šode
(&
is
.
oc
)->
i_block
;

1969 
	`mem£t
(
p
 + 
i_size
, 0,

1970 
EXT4_MIN_INLINE_DATA_SIZE
 - 
i_size
);

1973 
	`EXT4_I
(
šode
)->
i_šlše_size
 = 
i_size
 <

1974 
EXT4_MIN_INLINE_DATA_SIZE
 ?

1975 
EXT4_MIN_INLINE_DATA_SIZE
 : 
i_size
;

1978 
out_”rÜ
:

1979 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

1980 
out
:

1981 
	`b»l£
(
is
.
oc
.
bh
);

1982 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

1983 
	`kä“
(
v®ue
);

1984 ià(
šode
->
i_Æšk
)

1985 
	`ext4_Üphª_d–
(
hªdË
, 
šode
);

1987 ià(
”r
 == 0) {

1988 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

1989 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1990 ià(
	`IS_SYNC
(
šode
))

1991 
	`ext4_hªdË_sync
(
hªdË
);

1993 
	`ext4_jouº®_¡İ
(
hªdË
);

1994  
”r
;

1995 
	}
}

1997 
	$ext4_cÚv”t_šlše_d©a
(
šode
 *inode)

1999 
”rÜ
, 
Ãeded_blocks
, 
no_ex·nd
;

2000 
hªdË_t
 *
hªdË
;

2001 
ext4_oc
 
oc
;

2003 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

2004 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

2008 
Ãeded_blocks
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

2010 
oc
.
bh
 = 
NULL
;

2011 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

2012 ià(
”rÜ
)

2013  
”rÜ
;

2015 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_WRITE_PAGE
, 
Ãeded_blocks
);

2016 ià(
	`IS_ERR
(
hªdË
)) {

2017 
”rÜ
 = 
	`PTR_ERR
(
hªdË
);

2018 
out_ä“
;

2021 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

2022 ià(
	`ext4_has_šlše_d©a
(
šode
))

2023 
”rÜ
 = 
	`ext4_cÚv”t_šlše_d©a_nŞock
(
hªdË
, 
šode
, &
oc
);

2024 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

2025 
	`ext4_jouº®_¡İ
(
hªdË
);

2026 
out_ä“
:

2027 
	`b»l£
(
oc
.
bh
);

2028  
”rÜ
;

2029 
	}
}

	@pxt4/inode.c

22 
	~<lšux/fs.h
>

23 
	~<lšux/time.h
>

24 
	~<lšux/highuid.h
>

25 
	~<lšux/·gem­.h
>

26 
	~<lšux/dax.h
>

27 
	~<lšux/quÙaİs.h
>

28 
	~<lšux/¡ršg.h
>

29 
	~<lšux/bufãr_h—d.h
>

30 
	~<lšux/wr™eback.h
>

31 
	~<lšux/·gevec.h
>

32 
	~<lšux/m·ge.h
>

33 
	~<lšux/Çmei.h
>

34 
	~<lšux/uio.h
>

35 
	~<lšux/bio.h
>

36 
	~<lšux/wÜkqueue.h
>

37 
	~<lšux/k”Ãl.h
>

38 
	~<lšux/´štk.h
>

39 
	~<lšux/¦ab.h
>

40 
	~<lšux/b™İs.h
>

41 
	~<lšux/iom­.h
>

42 
	~<lšux/iv”siÚ.h
>

44 
	~"ext4_jbd2.h
"

45 
	~"x©Œ.h
"

46 
	~"aş.h
"

47 
	~"Œunÿ‹.h
"

49 
	~<Œaû/ev’ts/ext4.h
>

51 
	#MPAGE_DA_EXTENT_TAIL
 0x01

	)

53 
__u32
 
	$ext4_šode_csum
(
šode
 *šode, 
ext4_šode
 *
¿w
,

54 
ext4_šode_šfo
 *
ei
)

56 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

57 
__u32
 
csum
;

58 
__u16
 
dummy_csum
 = 0;

59 
off£t
 = 
	`off£tof
(
ext4_šode
, 
i_checksum_lo
);

60 
csum_size
 = (
dummy_csum
);

62 
csum
 = 
	`ext4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
¿w
, 
off£t
);

63 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, 
csum_size
);

64 
off£t
 +ğ
csum_size
;

65 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)
¿w
 + 
off£t
,

66 
EXT4_GOOD_OLD_INODE_SIZE
 - 
off£t
);

68 ià(
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
) {

69 
off£t
 = 
	`off£tof
(
ext4_šode
, 
i_checksum_hi
);

70 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)
¿w
 +

71 
EXT4_GOOD_OLD_INODE_SIZE
,

72 
off£t
 - 
EXT4_GOOD_OLD_INODE_SIZE
);

73 ià(
	`EXT4_FITS_IN_INODE
(
¿w
, 
ei
, 
i_checksum_hi
)) {

74 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
,

75 
csum_size
);

76 
off£t
 +ğ
csum_size
;

78 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)
¿w
 + 
off£t
,

79 
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è- 
off£t
);

82  
csum
;

83 
	}
}

85 
	$ext4_šode_csum_v”ify
(
šode
 *šode, 
ext4_šode
 *
¿w
,

86 
ext4_šode_šfo
 *
ei
)

88 
__u32
 
´ovided
, 
ÿlcuÏ‹d
;

90 ià(
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
->
s_ü—tÜ_os
 !=

91 
	`ıu_to_Ë32
(
EXT4_OS_LINUX
) ||

92 !
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

95 
´ovided
 = 
	`Ë16_to_ıu
(
¿w
->
i_checksum_lo
);

96 
ÿlcuÏ‹d
 = 
	`ext4_šode_csum
(
šode
, 
¿w
, 
ei
);

97 ià(
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
 &&

98 
	`EXT4_FITS_IN_INODE
(
¿w
, 
ei
, 
i_checksum_hi
))

99 
´ovided
 |ğ((
__u32
)
	`Ë16_to_ıu
(
¿w
->
i_checksum_hi
)) << 16;

101 
ÿlcuÏ‹d
 &= 0xFFFF;

103  
´ovided
 =ğ
ÿlcuÏ‹d
;

104 
	}
}

106 
	$ext4_šode_csum_£t
(
šode
 *šode, 
ext4_šode
 *
¿w
,

107 
ext4_šode_šfo
 *
ei
)

109 
__u32
 
csum
;

111 ià(
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
->
s_ü—tÜ_os
 !=

112 
	`ıu_to_Ë32
(
EXT4_OS_LINUX
) ||

113 !
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

116 
csum
 = 
	`ext4_šode_csum
(
šode
, 
¿w
, 
ei
);

117 
¿w
->
i_checksum_lo
 = 
	`ıu_to_Ë16
(
csum
 & 0xFFFF);

118 ià(
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
 &&

119 
	`EXT4_FITS_IN_INODE
(
¿w
, 
ei
, 
i_checksum_hi
))

120 
¿w
->
i_checksum_hi
 = 
	`ıu_to_Ë16
(
csum
 >> 16);

121 
	}
}

123 
šlše
 
	$ext4_begš_Üd”ed_Œunÿ‹
(
šode
 *inode,

124 
loff_t
 
Ãw_size
)

126 
	`Œaû_ext4_begš_Üd”ed_Œunÿ‹
(
šode
, 
Ãw_size
);

133 ià(!
	`EXT4_I
(
šode
)->
jšode
)

135  
	`jbd2_jouº®_begš_Üd”ed_Œunÿ‹
(
	`EXT4_JOURNAL
(
šode
),

136 
	`EXT4_I
(
šode
)->
jšode
,

137 
Ãw_size
);

138 
	}
}

140 
ext4_šv®id©•age
(
·ge
 *·ge, 
off£t
,

141 
Ëngth
);

142 
__ext4_jouº®Ëd_wr™•age
(
·ge
 *·ge, 
Ën
);

143 
ext4_bh_d–ay_Ü_unwr™‹n
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
);

144 
ext4_m‘a_Œªs_blocks
(
šode
 *šode, 
lblocks
,

145 
³x‹Ás
);

151 
	$ext4_šode_is_ç¡_symlšk
(
šode
 *inode)

153 ià(!(
	`EXT4_I
(
šode
)->
i_æags
 & 
EXT4_EA_INODE_FL
)) {

154 
—_blocks
 = 
	`EXT4_I
(
šode
)->
i_fe_aş
 ?

155 
	`EXT4_CLUSTER_SIZE
(
šode
->
i_sb
) >> 9 : 0;

157 ià(
	`ext4_has_šlše_d©a
(
šode
))

160  (
	`S_ISLNK
(
šode
->
i_mode
è&& inode->
i_blocks
 - 
—_blocks
 == 0);

162  
	`S_ISLNK
(
šode
->
i_mode
è&& inode->
i_size
 &&

163 (
šode
->
i_size
 < 
EXT4_N_BLOCKS
 * 4);

164 
	}
}

171 
	$ext4_Œunÿ‹_»¡¬t_Œªs
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

172 
nblocks
)

174 
»t
;

182 
	`BUG_ON
(
	`EXT4_JOURNAL
(
šode
è=ğ
NULL
);

183 
	`jbd_debug
(2, "»¡¬tšg hªdË %p\n", 
hªdË
);

184 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

185 
»t
 = 
	`ext4_jouº®_»¡¬t
(
hªdË
, 
nblocks
);

186 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

187 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

189  
»t
;

190 
	}
}

195 
	$ext4_eviù_šode
(
šode
 *inode)

197 
hªdË_t
 *
hªdË
;

198 
”r
;

199 
exŒa_üed™s
 = 3;

200 
ext4_x©Œ_šode_¬¿y
 *
—_šode_¬¿y
 = 
NULL
;

202 
	`Œaû_ext4_eviù_šode
(
šode
);

204 ià(
šode
->
i_Æšk
) {

223 ià(
šode
->
i_šo
 !ğ
EXT4_JOURNAL_INO
 &&

224 
	`ext4_should_jouº®_d©a
(
šode
) &&

225 (
	`S_ISLNK
(
šode
->
i_mode
è|| 
	`S_ISREG
(inode->i_mode)) &&

226 
šode
->
i_d©a
.
Ä·ges
) {

227 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
;

228 
tid_t
 
comm™_tid
 = 
	`EXT4_I
(
šode
)->
i_d©async_tid
;

230 
	`jbd2_com¶‘e_Œª§ùiÚ
(
jouº®
, 
comm™_tid
);

231 
	`fem­_wr™e_ªd_wa™
(&
šode
->
i_d©a
);

233 
	`Œunÿ‹_šode_·ges_fš®
(&
šode
->
i_d©a
);

235 
no_d–‘e
;

238 ià(
	`is_bad_šode
(
šode
))

239 
no_d–‘e
;

240 
	`dquÙ_š™Ÿlize
(
šode
);

242 ià(
	`ext4_should_Üd”_d©a
(
šode
))

243 
	`ext4_begš_Üd”ed_Œunÿ‹
(
šode
, 0);

244 
	`Œunÿ‹_šode_·ges_fš®
(&
šode
->
i_d©a
);

250 
	`sb_¡¬t_štwr™e
(
šode
->
i_sb
);

252 ià(!
	`IS_NOQUOTA
(
šode
))

253 
exŒa_üed™s
 +ğ
	`EXT4_MAXQUOTAS_DEL_BLOCKS
(
šode
->
i_sb
);

255 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_TRUNCATE
,

256 
	`ext4_blocks_fÜ_Œunÿ‹
(
šode
)+
exŒa_üed™s
);

257 ià(
	`IS_ERR
(
hªdË
)) {

258 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
	`PTR_ERR
(
hªdË
));

264 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

265 
	`sb_’d_štwr™e
(
šode
->
i_sb
);

266 
no_d–‘e
;

269 ià(
	`IS_SYNC
(
šode
))

270 
	`ext4_hªdË_sync
(
hªdË
);

279 ià(
	`ext4_šode_is_ç¡_symlšk
(
šode
))

280 
	`mem£t
(
	`EXT4_I
(
šode
)->
i_d©a
, 0, (EXT4_I(inode)->i_data));

281 
šode
->
i_size
 = 0;

282 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

283 ià(
”r
) {

284 
	`ext4_w¬nšg
(
šode
->
i_sb
,

285 "couldn'ˆm¬k inoddœty (”¸%d)", 
”r
);

286 
¡İ_hªdË
;

288 ià(
šode
->
i_blocks
) {

289 
”r
 = 
	`ext4_Œunÿ‹
(
šode
);

290 ià(
”r
) {

291 
	`ext4_”rÜ
(
šode
->
i_sb
,

293 
šode
->
i_šo
, 
”r
);

294 
¡İ_hªdË
;

299 
”r
 = 
	`ext4_x©Œ_d–‘e_šode
(
hªdË
, 
šode
, &
—_šode_¬¿y
,

300 
exŒa_üed™s
);

301 ià(
”r
) {

302 
	`ext4_w¬nšg
(
šode
->
i_sb
, "x©Œ d–‘Ó¼ %d)", 
”r
);

303 
¡İ_hªdË
:

304 
	`ext4_jouº®_¡İ
(
hªdË
);

305 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

306 
	`sb_’d_štwr™e
(
šode
->
i_sb
);

307 
	`ext4_x©Œ_šode_¬¿y_ä“
(
—_šode_¬¿y
);

308 
no_d–‘e
;

319 
	`ext4_Üphª_d–
(
hªdË
, 
šode
);

320 
	`EXT4_I
(
šode
)->
i_dtime
 = (
__u32
)
	`ktime_g‘_»®_£cÚds
();

329 ià(
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
))

331 
	`ext4_ş—r_šode
(
šode
);

333 
	`ext4_ä“_šode
(
hªdË
, 
šode
);

334 
	`ext4_jouº®_¡İ
(
hªdË
);

335 
	`sb_’d_štwr™e
(
šode
->
i_sb
);

336 
	`ext4_x©Œ_šode_¬¿y_ä“
(
—_šode_¬¿y
);

338 
no_d–‘e
:

339 
	`ext4_ş—r_šode
(
šode
);

340 
	}
}

342 #ifdeà
CONFIG_QUOTA


343 
qsize_t
 *
	$ext4_g‘_»£rved_¥aû
(
šode
 *inode)

345  &
	`EXT4_I
(
šode
)->
i_»£rved_quÙa
;

346 
	}
}

353 
	$ext4_da_upd©e_»£rve_¥aû
(
šode
 *inode,

354 
u£d
, 
quÙa_şaim
)

356 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

357 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

359 
	`¥š_lock
(&
ei
->
i_block_»£rv©iÚ_lock
);

360 
	`Œaû_ext4_da_upd©e_»£rve_¥aû
(
šode
, 
u£d
, 
quÙa_şaim
);

361 ià(
	`uÆik–y
(
u£d
 > 
ei
->
i_»£rved_d©a_blocks
)) {

362 
	`ext4_w¬nšg
(
šode
->
i_sb
, "%s: ino %lu, used %d "

364 
__func__
, 
šode
->
i_šo
, 
u£d
,

365 
ei
->
i_»£rved_d©a_blocks
);

366 
	`WARN_ON
(1);

367 
u£d
 = 
ei
->
i_»£rved_d©a_blocks
;

371 
ei
->
i_»£rved_d©a_blocks
 -ğ
u£d
;

372 
	`³rıu_couÁ”_sub
(&
sbi
->
s_dœtyşu¡”s_couÁ”
, 
u£d
);

374 
	`¥š_uÆock
(&
	`EXT4_I
(
šode
)->
i_block_»£rv©iÚ_lock
);

377 ià(
quÙa_şaim
)

378 
	`dquÙ_şaim_block
(
šode
, 
	`EXT4_C2B
(
sbi
, 
u£d
));

385 
	`dquÙ_»Ëa£_»£rv©iÚ_block
(
šode
, 
	`EXT4_C2B
(
sbi
, 
u£d
));

393 ià((
ei
->
i_»£rved_d©a_blocks
 == 0) &&

394 !
	`šode_is_İ’_fÜ_wr™e
(
šode
))

395 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

396 
	}
}

398 
	$__check_block_v®id™y
(
šode
 *šode, cÚ¡ *
func
,

399 
lše
,

400 
ext4_m­_blocks
 *
m­
)

402 ià(
	`ext4_has_ã©u»_jouº®
(
šode
->
i_sb
) &&

403 (
šode
->
i_šo
 ==

404 
	`Ë32_to_ıu
(
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
->
s_jouº®_šum
)))

406 ià(!
	`ext4_d©a_block_v®id
(
	`EXT4_SB
(
šode
->
i_sb
), 
m­
->
m_pblk
,

407 
m­
->
m_Ën
)) {

408 
	`ext4_”rÜ_šode
(
šode
, 
func
, 
lše
, 
m­
->
m_pblk
,

410 "Ö’gth %d)", (è
m­
->
m_lblk
,

411 
m­
->
m_pblk
, m­->
m_Ën
);

412  -
EFSCORRUPTED
;

415 
	}
}

417 
	$ext4_issue_z”oout
(
šode
 *šode, 
ext4_lblk_t
 
lblk
, 
ext4_fsblk_t
 
pblk
,

418 
ext4_lblk_t
 
Ën
)

420 
»t
;

422 ià(
	`IS_ENCRYPTED
(
šode
))

423  
	`fsüy±_z”oout_¿nge
(
šode
, 
lblk
, 
pblk
, 
Ën
);

425 
»t
 = 
	`sb_issue_z”oout
(
šode
->
i_sb
, 
pblk
, 
Ën
, 
GFP_NOFS
);

426 ià(
»t
 > 0)

427 
»t
 = 0;

429  
»t
;

430 
	}
}

432 
	#check_block_v®id™y
(
šode
, 
m­
) \

433 
	`__check_block_v®id™y
((
šode
), 
__func__
, 
__LINE__
, (
m­
))

	)

435 #ifdeà
ES_AGGRESSIVE_TEST


436 
	$ext4_m­_blocks_es_»check
(
hªdË_t
 *
hªdË
,

437 
šode
 *inode,

438 
ext4_m­_blocks
 *
es_m­
,

439 
ext4_m­_blocks
 *
m­
,

440 
æags
)

442 
»tv®
;

444 
m­
->
m_æags
 = 0;

452 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

453 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)) {

454 
»tv®
 = 
	`ext4_ext_m­_blocks
(
hªdË
, 
šode
, 
m­
, 
æags
 &

455 
EXT4_GET_BLOCKS_KEEP_SIZE
);

457 
»tv®
 = 
	`ext4_šd_m­_blocks
(
hªdË
, 
šode
, 
m­
, 
æags
 &

458 
EXT4_GET_BLOCKS_KEEP_SIZE
);

460 
	`up_»ad
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

466 ià(
es_m­
->
m_lblk
 !ğ
m­
->m_lblk ||

467 
es_m­
->
m_æags
 !ğ
m­
->m_flags ||

468 
es_m­
->
m_pblk
 !ğ
m­
->m_pblk) {

469 
	`´štk
("ES cache‡ssertion failed for inode: %lu "

472 
šode
->
i_šo
, 
es_m­
->
m_lblk
,ƒs_m­->
m_Ën
,

473 
es_m­
->
m_pblk
,ƒs_m­->
m_æags
, 
m­
->
m_lblk
,

474 
m­
->
m_Ën
, m­->
m_pblk
, m­->
m_æags
,

475 
»tv®
, 
æags
);

477 
	}
}

502 
	$ext4_m­_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

503 
ext4_m­_blocks
 *
m­
, 
æags
)

505 
ex‹Á_¡©us
 
es
;

506 
»tv®
;

507 
»t
 = 0;

508 #ifdeà
ES_AGGRESSIVE_TEST


509 
ext4_m­_blocks
 
Üig_m­
;

511 
	`memıy
(&
Üig_m­
, 
m­
, (*map));

514 
m­
->
m_æags
 = 0;

515 
	`ext_debug
("ext4_map_blocks(): inode %lu, flag %d, max_blocks %u,"

516 "logiÿÈblock %lu\n", 
šode
->
i_šo
, 
æags
, 
m­
->
m_Ën
,

517 (è
m­
->
m_lblk
);

522 ià(
	`uÆik–y
(
m­
->
m_Ën
 > 
INT_MAX
))

523 
m­
->
m_Ën
 = 
INT_MAX
;

526 ià(
	`uÆik–y
(
m­
->
m_lblk
 >ğ
EXT_MAX_BLOCKS
))

527  -
EFSCORRUPTED
;

530 ià(
	`ext4_es_lookup_ex‹Á
(
šode
, 
m­
->
m_lblk
, 
NULL
, &
es
)) {

531 ià(
	`ext4_es_is_wr™‹n
(&
es
è|| 
	`ext4_es_is_unwr™‹n
(&es)) {

532 
m­
->
m_pblk
 = 
	`ext4_es_pblock
(&
es
) +

533 
m­
->
m_lblk
 - 
es
.
es_lblk
;

534 
m­
->
m_æags
 |ğ
	`ext4_es_is_wr™‹n
(&
es
) ?

535 
EXT4_MAP_MAPPED
 : 
EXT4_MAP_UNWRITTEN
;

536 
»tv®
 = 
es
.
es_Ën
 - (
m­
->
m_lblk
 -ƒs.
es_lblk
);

537 ià(
»tv®
 > 
m­
->
m_Ën
)

538 
»tv®
 = 
m­
->
m_Ën
;

539 
m­
->
m_Ën
 = 
»tv®
;

540 } ià(
	`ext4_es_is_d–ayed
(&
es
è|| 
	`ext4_es_is_hŞe
(&es)) {

541 
m­
->
m_pblk
 = 0;

542 
»tv®
 = 
es
.
es_Ën
 - (
m­
->
m_lblk
 -ƒs.
es_lblk
);

543 ià(
»tv®
 > 
m­
->
m_Ën
)

544 
»tv®
 = 
m­
->
m_Ën
;

545 
m­
->
m_Ën
 = 
»tv®
;

546 
»tv®
 = 0;

548 
	`BUG
();

550 #ifdeà
ES_AGGRESSIVE_TEST


551 
	`ext4_m­_blocks_es_»check
(
hªdË
, 
šode
, 
m­
,

552 &
Üig_m­
, 
æags
);

554 
found
;

561 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

562 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)) {

563 
»tv®
 = 
	`ext4_ext_m­_blocks
(
hªdË
, 
šode
, 
m­
, 
æags
 &

564 
EXT4_GET_BLOCKS_KEEP_SIZE
);

566 
»tv®
 = 
	`ext4_šd_m­_blocks
(
hªdË
, 
šode
, 
m­
, 
æags
 &

567 
EXT4_GET_BLOCKS_KEEP_SIZE
);

569 ià(
»tv®
 > 0) {

570 
¡©us
;

572 ià(
	`uÆik–y
(
»tv®
 !ğ
m­
->
m_Ën
)) {

573 
	`ext4_w¬nšg
(
šode
->
i_sb
,

576 
šode
->
i_šo
, 
»tv®
, 
m­
->
m_Ën
);

577 
	`WARN_ON
(1);

580 
¡©us
 = 
m­
->
m_æags
 & 
EXT4_MAP_UNWRITTEN
 ?

581 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

582 ià(!(
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
) &&

583 !(
¡©us
 & 
EXTENT_STATUS_WRITTEN
) &&

584 
	`ext4_es_sÿn_¿nge
(
šode
, &
ext4_es_is_d–ayed
, 
m­
->
m_lblk
,

585 
m­
->
m_lblk
 + m­->
m_Ën
 - 1))

586 
¡©us
 |ğ
EXTENT_STATUS_DELAYED
;

587 
»t
 = 
	`ext4_es_š£¹_ex‹Á
(
šode
, 
m­
->
m_lblk
,

588 
m­
->
m_Ën
, m­->
m_pblk
, 
¡©us
);

589 ià(
»t
 < 0)

590 
»tv®
 = 
»t
;

592 
	`up_»ad
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

594 
found
:

595 ià(
»tv®
 > 0 && 
m­
->
m_æags
 & 
EXT4_MAP_MAPPED
) {

596 
»t
 = 
	`check_block_v®id™y
(
šode
, 
m­
);

597 ià(
»t
 != 0)

598  
»t
;

602 ià((
æags
 & 
EXT4_GET_BLOCKS_CREATE
) == 0)

603  
»tv®
;

612 ià(
»tv®
 > 0 && 
m­
->
m_æags
 & 
EXT4_MAP_MAPPED
)

618 ià(!(
æags
 & 
EXT4_GET_BLOCKS_CONVERT_UNWRITTEN
))

619  
»tv®
;

625 
m­
->
m_æags
 &ğ~
EXT4_MAP_FLAGS
;

633 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

639 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)) {

640 
»tv®
 = 
	`ext4_ext_m­_blocks
(
hªdË
, 
šode
, 
m­
, 
æags
);

642 
»tv®
 = 
	`ext4_šd_m­_blocks
(
hªdË
, 
šode
, 
m­
, 
æags
);

644 ià(
»tv®
 > 0 && 
m­
->
m_æags
 & 
EXT4_MAP_NEW
) {

650 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_EXT_MIGRATE
);

659 ià((
»tv®
 > 0) &&

660 (
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
))

661 
	`ext4_da_upd©e_»£rve_¥aû
(
šode
, 
»tv®
, 1);

664 ià(
»tv®
 > 0) {

665 
¡©us
;

667 ià(
	`uÆik–y
(
»tv®
 !ğ
m­
->
m_Ën
)) {

668 
	`ext4_w¬nšg
(
šode
->
i_sb
,

671 
šode
->
i_šo
, 
»tv®
, 
m­
->
m_Ën
);

672 
	`WARN_ON
(1);

682 ià(
æags
 & 
EXT4_GET_BLOCKS_ZERO
 &&

683 
m­
->
m_æags
 & 
EXT4_MAP_MAPPED
 &&

684 
m­
->
m_æags
 & 
EXT4_MAP_NEW
) {

685 
»t
 = 
	`ext4_issue_z”oout
(
šode
, 
m­
->
m_lblk
,

686 
m­
->
m_pblk
, m­->
m_Ën
);

687 ià(
»t
) {

688 
»tv®
 = 
»t
;

689 
out_£m
;

697 ià((
æags
 & 
EXT4_GET_BLOCKS_PRE_IO
) &&

698 
	`ext4_es_lookup_ex‹Á
(
šode
, 
m­
->
m_lblk
, 
NULL
, &
es
)) {

699 ià(
	`ext4_es_is_wr™‹n
(&
es
))

700 
out_£m
;

702 
¡©us
 = 
m­
->
m_æags
 & 
EXT4_MAP_UNWRITTEN
 ?

703 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

704 ià(!(
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
) &&

705 !(
¡©us
 & 
EXTENT_STATUS_WRITTEN
) &&

706 
	`ext4_es_sÿn_¿nge
(
šode
, &
ext4_es_is_d–ayed
, 
m­
->
m_lblk
,

707 
m­
->
m_lblk
 + m­->
m_Ën
 - 1))

708 
¡©us
 |ğ
EXTENT_STATUS_DELAYED
;

709 
»t
 = 
	`ext4_es_š£¹_ex‹Á
(
šode
, 
m­
->
m_lblk
, m­->
m_Ën
,

710 
m­
->
m_pblk
, 
¡©us
);

711 ià(
»t
 < 0) {

712 
»tv®
 = 
»t
;

713 
out_£m
;

717 
out_£m
:

718 
	`up_wr™e
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

719 ià(
»tv®
 > 0 && 
m­
->
m_æags
 & 
EXT4_MAP_MAPPED
) {

720 
»t
 = 
	`check_block_v®id™y
(
šode
, 
m­
);

721 ià(
»t
 != 0)

722  
»t
;

729 ià(
m­
->
m_æags
 & 
EXT4_MAP_NEW
 &&

730 !(
m­
->
m_æags
 & 
EXT4_MAP_UNWRITTEN
) &&

731 !(
æags
 & 
EXT4_GET_BLOCKS_ZERO
) &&

732 !
	`ext4_is_quÙa_fe
(
šode
) &&

733 
	`ext4_should_Üd”_d©a
(
šode
)) {

734 
loff_t
 
¡¬t_by‹
 =

735 (
loff_t
)
m­
->
m_lblk
 << 
šode
->
i_blkb™s
;

736 
loff_t
 
Ëngth
 = (loff_t)
m­
->
m_Ën
 << 
šode
->
i_blkb™s
;

738 ià(
æags
 & 
EXT4_GET_BLOCKS_IO_SUBMIT
)

739 
»t
 = 
	`ext4_jbd2_šode_add_wa™
(
hªdË
, 
šode
,

740 
¡¬t_by‹
, 
Ëngth
);

742 
»t
 = 
	`ext4_jbd2_šode_add_wr™e
(
hªdË
, 
šode
,

743 
¡¬t_by‹
, 
Ëngth
);

744 ià(
»t
)

745  
»t
;

748  
»tv®
;

749 
	}
}

755 
	$ext4_upd©e_bh_¡©e
(
bufãr_h—d
 *
bh
, 
æags
)

757 
Şd_¡©e
;

758 
Ãw_¡©e
;

760 
æags
 &ğ
EXT4_MAP_FLAGS
;

763 ià(!
bh
->
b_·ge
) {

764 
bh
->
b_¡©e
 = (bh->b_¡©& ~
EXT4_MAP_FLAGS
è| 
æags
;

773 
Şd_¡©e
 = 
	`READ_ONCE
(
bh
->
b_¡©e
);

774 
Ãw_¡©e
 = (
Şd_¡©e
 & ~
EXT4_MAP_FLAGS
è| 
æags
;

775 } 
	`uÆik–y
(

776 
	`cmpxchg
(&
bh
->
b_¡©e
, 
Şd_¡©e
, 
Ãw_¡©e
) != old_state));

777 
	}
}

779 
	$_ext4_g‘_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

780 
bufãr_h—d
 *
bh
, 
æags
)

782 
ext4_m­_blocks
 
m­
;

783 
»t
 = 0;

785 ià(
	`ext4_has_šlše_d©a
(
šode
))

786  -
ERANGE
;

788 
m­
.
m_lblk
 = 
iblock
;

789 
m­
.
m_Ën
 = 
bh
->
b_size
 >> 
šode
->
i_blkb™s
;

791 
»t
 = 
	`ext4_m­_blocks
(
	`ext4_jouº®_cu¼’t_hªdË
(), 
šode
, &
m­
,

792 
æags
);

793 ià(
»t
 > 0) {

794 
	`m­_bh
(
bh
, 
šode
->
i_sb
, 
m­
.
m_pblk
);

795 
	`ext4_upd©e_bh_¡©e
(
bh
, 
m­
.
m_æags
);

796 
bh
->
b_size
 = 
šode
->
i_sb
->
s_blocksize
 * 
m­
.
m_Ën
;

797 
»t
 = 0;

798 } ià(
»t
 == 0) {

800 
bh
->
b_size
 = 
šode
->
i_sb
->
s_blocksize
 * 
m­
.
m_Ën
;

802  
»t
;

803 
	}
}

805 
	$ext4_g‘_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

806 
bufãr_h—d
 *
bh
, 
ü—‹
)

808  
	`_ext4_g‘_block
(
šode
, 
iblock
, 
bh
,

809 
ü—‹
 ? 
EXT4_GET_BLOCKS_CREATE
 : 0);

810 
	}
}

817 
	$ext4_g‘_block_unwr™‹n
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

818 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

820 
	`ext4_debug
("ext4_get_block_unwritten: inode %lu, create flag %d\n",

821 
šode
->
i_šo
, 
ü—‹
);

822  
	`_ext4_g‘_block
(
šode
, 
iblock
, 
bh_»suÉ
,

823 
EXT4_GET_BLOCKS_IO_CREATE_EXT
);

824 
	}
}

827 
	#DIO_MAX_BLOCKS
 4096

	)

834 
	$ext4_g‘_block_Œªs
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

835 
bufãr_h—d
 *
bh_»suÉ
, 
æags
)

837 
dio_üed™s
;

838 
hªdË_t
 *
hªdË
;

839 
»Œ›s
 = 0;

840 
»t
;

843 ià(
bh_»suÉ
->
b_size
 >> 
šode
->
i_blkb™s
 > 
DIO_MAX_BLOCKS
)

844 
bh_»suÉ
->
b_size
 = 
DIO_MAX_BLOCKS
 << 
šode
->
i_blkb™s
;

845 
dio_üed™s
 = 
	`ext4_chunk_Œªs_blocks
(
šode
,

846 
bh_»suÉ
->
b_size
 >> 
šode
->
i_blkb™s
);

847 
»Œy
:

848 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MAP_BLOCKS
, 
dio_üed™s
);

849 ià(
	`IS_ERR
(
hªdË
))

850  
	`PTR_ERR
(
hªdË
);

852 
»t
 = 
	`_ext4_g‘_block
(
šode
, 
iblock
, 
bh_»suÉ
, 
æags
);

853 
	`ext4_jouº®_¡İ
(
hªdË
);

855 ià(
»t
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

856 
»Œy
;

857  
»t
;

858 
	}
}

861 
	$ext4_dio_g‘_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

862 
bufãr_h—d
 *
bh
, 
ü—‹
)

865 
	`WARN_ON_ONCE
(
	`ext4_jouº®_cu¼’t_hªdË
());

867 ià(!
ü—‹
)

868  
	`_ext4_g‘_block
(
šode
, 
iblock
, 
bh
, 0);

869  
	`ext4_g‘_block_Œªs
(
šode
, 
iblock
, 
bh
, 
EXT4_GET_BLOCKS_CREATE
);

870 
	}
}

877 
	$ext4_dio_g‘_block_unwr™‹n_async
(
šode
 *inode,

878 
£ùÜ_t
 
iblock
, 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

880 
»t
;

883 
	`WARN_ON_ONCE
(
	`ext4_jouº®_cu¼’t_hªdË
());

885 
»t
 = 
	`ext4_g‘_block_Œªs
(
šode
, 
iblock
, 
bh_»suÉ
,

886 
EXT4_GET_BLOCKS_IO_CREATE_EXT
);

895 ià(!
»t
 && 
	`bufãr_unwr™‹n
(
bh_»suÉ
)) {

896 ià(!
bh_»suÉ
->
b_´iv©e
) {

897 
ext4_io_’d_t
 *
io_’d
;

899 
io_’d
 = 
	`ext4_š™_io_’d
(
šode
, 
GFP_KERNEL
);

900 ià(!
io_’d
)

901  -
ENOMEM
;

902 
bh_»suÉ
->
b_´iv©e
 = 
io_’d
;

903 
	`ext4_£t_io_unwr™‹n_æag
(
šode
, 
io_’d
);

905 
	`£t_bufãr_deãr_com¶‘iÚ
(
bh_»suÉ
);

908  
»t
;

909 
	}
}

916 
	$ext4_dio_g‘_block_unwr™‹n_sync
(
šode
 *inode,

917 
£ùÜ_t
 
iblock
, 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

919 
»t
;

922 
	`WARN_ON_ONCE
(
	`ext4_jouº®_cu¼’t_hªdË
());

924 
»t
 = 
	`ext4_g‘_block_Œªs
(
šode
, 
iblock
, 
bh_»suÉ
,

925 
EXT4_GET_BLOCKS_IO_CREATE_EXT
);

932 ià(!
»t
 && 
	`bufãr_unwr™‹n
(
bh_»suÉ
))

933 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_DIO_UNWRITTEN
);

935  
»t
;

936 
	}
}

938 
	$ext4_dio_g‘_block_ov”wr™e
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

939 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

941 
»t
;

943 
	`ext4_debug
("ext4_dio_get_block_overwrite: inode %lu, create flag %d\n",

944 
šode
->
i_šo
, 
ü—‹
);

946 
	`WARN_ON_ONCE
(
	`ext4_jouº®_cu¼’t_hªdË
());

948 
»t
 = 
	`_ext4_g‘_block
(
šode
, 
iblock
, 
bh_»suÉ
, 0);

953 
	`WARN_ON_ONCE
(!
	`bufãr_m­³d
(
bh_»suÉ
è|| 
	`bufãr_unwr™‹n
(bh_result));

955  
»t
;

956 
	}
}

962 
bufãr_h—d
 *
	$ext4_g‘blk
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

963 
ext4_lblk_t
 
block
, 
m­_æags
)

965 
ext4_m­_blocks
 
m­
;

966 
bufãr_h—d
 *
bh
;

967 
ü—‹
 = 
m­_æags
 & 
EXT4_GET_BLOCKS_CREATE
;

968 
”r
;

970 
	`J_ASSERT
(
hªdË
 !ğ
NULL
 || 
ü—‹
 == 0);

972 
m­
.
m_lblk
 = 
block
;

973 
m­
.
m_Ën
 = 1;

974 
”r
 = 
	`ext4_m­_blocks
(
hªdË
, 
šode
, &
m­
, 
m­_æags
);

976 ià(
”r
 == 0)

977  
ü—‹
 ? 
	`ERR_PTR
(-
ENOSPC
è: 
NULL
;

978 ià(
”r
 < 0)

979  
	`ERR_PTR
(
”r
);

981 
bh
 = 
	`sb_g‘blk
(
šode
->
i_sb
, 
m­
.
m_pblk
);

982 ià(
	`uÆik–y
(!
bh
))

983  
	`ERR_PTR
(-
ENOMEM
);

984 ià(
m­
.
m_æags
 & 
EXT4_MAP_NEW
) {

985 
	`J_ASSERT
(
ü—‹
 != 0);

986 
	`J_ASSERT
(
hªdË
 !ğ
NULL
);

995 
	`lock_bufãr
(
bh
);

996 
	`BUFFER_TRACE
(
bh
, "call get_create_access");

997 
”r
 = 
	`ext4_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
bh
);

998 ià(
	`uÆik–y
(
”r
)) {

999 
	`uÆock_bufãr
(
bh
);

1000 
”rout
;

1002 ià(!
	`bufãr_u±od©e
(
bh
)) {

1003 
	`mem£t
(
bh
->
b_d©a
, 0, 
šode
->
i_sb
->
s_blocksize
);

1004 
	`£t_bufãr_u±od©e
(
bh
);

1006 
	`uÆock_bufãr
(
bh
);

1007 
	`BUFFER_TRACE
(
bh
, "callƒxt4_handle_dirty_metadata");

1008 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

1009 ià(
	`uÆik–y
(
”r
))

1010 
”rout
;

1012 
	`BUFFER_TRACE
(
bh
, "not‡‚ew buffer");

1013  
bh
;

1014 
”rout
:

1015 
	`b»l£
(
bh
);

1016  
	`ERR_PTR
(
”r
);

1017 
	}
}

1019 
bufãr_h—d
 *
	$ext4_b»ad
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1020 
ext4_lblk_t
 
block
, 
m­_æags
)

1022 
bufãr_h—d
 *
bh
;

1024 
bh
 = 
	`ext4_g‘blk
(
hªdË
, 
šode
, 
block
, 
m­_æags
);

1025 ià(
	`IS_ERR
(
bh
))

1026  
bh
;

1027 ià(!
bh
 || 
	`ext4_bufãr_u±od©e
(bh))

1028  
bh
;

1029 
	`Î_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1, &
bh
);

1030 
	`wa™_Ú_bufãr
(
bh
);

1031 ià(
	`bufãr_u±od©e
(
bh
))

1032  
bh
;

1033 
	`put_bh
(
bh
);

1034  
	`ERR_PTR
(-
EIO
);

1035 
	}
}

1038 
	$ext4_b»ad_b©ch
(
šode
 *šode, 
ext4_lblk_t
 
block
, 
bh_couÁ
,

1039 
boŞ
 
wa™
, 
bufãr_h—d
 **
bhs
)

1041 
i
, 
”r
;

1043 
i
 = 0; i < 
bh_couÁ
; i++) {

1044 
bhs
[
i
] = 
	`ext4_g‘blk
(
NULL
, 
šode
, 
block
 + i, 0 );

1045 ià(
	`IS_ERR
(
bhs
[
i
])) {

1046 
”r
 = 
	`PTR_ERR
(
bhs
[
i
]);

1047 
bh_couÁ
 = 
i
;

1048 
out_b»l£
;

1052 
i
 = 0; i < 
bh_couÁ
; i++)

1054 ià(
bhs
[
i
] && !
	`ext4_bufãr_u±od©e
(bhs[i]))

1055 
	`Î_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1,

1056 &
bhs
[
i
]);

1058 ià(!
wa™
)

1061 
i
 = 0; i < 
bh_couÁ
; i++)

1062 ià(
bhs
[
i
])

1063 
	`wa™_Ú_bufãr
(
bhs
[
i
]);

1065 
i
 = 0; i < 
bh_couÁ
; i++) {

1066 ià(
bhs
[
i
] && !
	`bufãr_u±od©e
(bhs[i])) {

1067 
”r
 = -
EIO
;

1068 
out_b»l£
;

1073 
out_b»l£
:

1074 
i
 = 0; i < 
bh_couÁ
; i++) {

1075 
	`b»l£
(
bhs
[
i
]);

1076 
bhs
[
i
] = 
NULL
;

1078  
”r
;

1079 
	}
}

1081 
	$ext4_w®k_·ge_bufãrs
(
hªdË_t
 *
hªdË
,

1082 
bufãr_h—d
 *
h—d
,

1083 
äom
,

1084 
to
,

1085 *
·¹Ÿl
,

1086 (*
â
)(
hªdË_t
 *
hªdË
,

1087 
bufãr_h—d
 *
bh
))

1089 
bufãr_h—d
 *
bh
;

1090 
block_¡¬t
, 
block_’d
;

1091 
blocksize
 = 
h—d
->
b_size
;

1092 
”r
, 
»t
 = 0;

1093 
bufãr_h—d
 *
Ãxt
;

1095 
bh
 = 
h—d
, 
block_¡¬t
 = 0;

1096 
»t
 =ğ0 && (
bh
 !ğ
h—d
 || !
block_¡¬t
);

1097 
block_¡¬t
 = 
block_’d
, 
bh
 = 
Ãxt
) {

1098 
Ãxt
 = 
bh
->
b_this_·ge
;

1099 
block_’d
 = 
block_¡¬t
 + 
blocksize
;

1100 ià(
block_’d
 <ğ
äom
 || 
block_¡¬t
 >ğ
to
) {

1101 ià(
·¹Ÿl
 && !
	`bufãr_u±od©e
(
bh
))

1102 *
·¹Ÿl
 = 1;

1105 
”r
 = (*
â
)(
hªdË
, 
bh
);

1106 ià(!
»t
)

1107 
»t
 = 
”r
;

1109  
»t
;

1110 
	}
}

1136 
	$do_jouº®_g‘_wr™e_acûss
(
hªdË_t
 *
hªdË
,

1137 
bufãr_h—d
 *
bh
)

1139 
dœty
 = 
	`bufãr_dœty
(
bh
);

1140 
»t
;

1142 ià(!
	`bufãr_m­³d
(
bh
è|| 
	`bufãr_ä“d
(bh))

1152 ià(
dœty
)

1153 
	`ş—r_bufãr_dœty
(
bh
);

1154 
	`BUFFER_TRACE
(
bh
, "get write‡ccess");

1155 
»t
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

1156 ià(!
»t
 && 
dœty
)

1157 
»t
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

1158  
»t
;

1159 
	}
}

1161 #ifdeà
CONFIG_FS_ENCRYPTION


1162 
	$ext4_block_wr™e_begš
(
·ge
 *·ge, 
loff_t
 
pos
, 
Ën
,

1163 
g‘_block_t
 *
g‘_block
)

1165 
äom
 = 
pos
 & (
PAGE_SIZE
 - 1);

1166 
to
 = 
äom
 + 
Ën
;

1167 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

1168 
block_¡¬t
, 
block_’d
;

1169 
£ùÜ_t
 
block
;

1170 
”r
 = 0;

1171 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

1172 
bb™s
;

1173 
bufãr_h—d
 *
bh
, *
h—d
, *
wa™
[2];

1174 
Ä_wa™
 = 0;

1175 
i
;

1177 
	`BUG_ON
(!
	`PageLocked
(
·ge
));

1178 
	`BUG_ON
(
äom
 > 
PAGE_SIZE
);

1179 
	`BUG_ON
(
to
 > 
PAGE_SIZE
);

1180 
	`BUG_ON
(
äom
 > 
to
);

1182 ià(!
	`·ge_has_bufãrs
(
·ge
))

1183 
	`ü—‹_em±y_bufãrs
(
·ge
, 
blocksize
, 0);

1184 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

1185 
bb™s
 = 
	`og2
(
blocksize
);

1186 
block
 = (
£ùÜ_t
)
·ge
->
šdex
 << (
PAGE_SHIFT
 - 
bb™s
);

1188 
bh
 = 
h—d
, 
block_¡¬t
 = 0; bh != head || !block_start;

1189 
block
++, 
block_¡¬t
 = 
block_’d
, 
bh
 = bh->
b_this_·ge
) {

1190 
block_’d
 = 
block_¡¬t
 + 
blocksize
;

1191 ià(
block_’d
 <ğ
äom
 || 
block_¡¬t
 >ğ
to
) {

1192 ià(
	`PageU±od©e
(
·ge
)) {

1193 ià(!
	`bufãr_u±od©e
(
bh
))

1194 
	`£t_bufãr_u±od©e
(
bh
);

1198 ià(
	`bufãr_Ãw
(
bh
))

1199 
	`ş—r_bufãr_Ãw
(
bh
);

1200 ià(!
	`bufãr_m­³d
(
bh
)) {

1201 
	`WARN_ON
(
bh
->
b_size
 !ğ
blocksize
);

1202 
”r
 = 
	`g‘_block
(
šode
, 
block
, 
bh
, 1);

1203 ià(
”r
)

1205 ià(
	`bufãr_Ãw
(
bh
)) {

1206 ià(
	`PageU±od©e
(
·ge
)) {

1207 
	`ş—r_bufãr_Ãw
(
bh
);

1208 
	`£t_bufãr_u±od©e
(
bh
);

1209 
	`m¬k_bufãr_dœty
(
bh
);

1212 ià(
block_’d
 > 
to
 || 
block_¡¬t
 < 
äom
)

1213 
	`z”o_u£r_£gm’ts
(
·ge
, 
to
, 
block_’d
,

1214 
block_¡¬t
, 
äom
);

1218 ià(
	`PageU±od©e
(
·ge
)) {

1219 ià(!
	`bufãr_u±od©e
(
bh
))

1220 
	`£t_bufãr_u±od©e
(
bh
);

1223 ià(!
	`bufãr_u±od©e
(
bh
è&& !
	`bufãr_d–ay
(bh) &&

1224 !
	`bufãr_unwr™‹n
(
bh
) &&

1225 (
block_¡¬t
 < 
äom
 || 
block_’d
 > 
to
)) {

1226 
	`Î_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

1227 
wa™
[
Ä_wa™
++] = 
bh
;

1233 
i
 = 0; i < 
Ä_wa™
; i++) {

1234 
	`wa™_Ú_bufãr
(
wa™
[
i
]);

1235 ià(!
	`bufãr_u±od©e
(
wa™
[
i
]))

1236 
”r
 = -
EIO
;

1238 ià(
	`uÆik–y
(
”r
)) {

1239 
	`·ge_z”o_Ãw_bufãrs
(
·ge
, 
äom
, 
to
);

1240 } ià(
	`IS_ENCRYPTED
(
šode
è&& 
	`S_ISREG
(šode->
i_mode
)) {

1241 
i
 = 0; i < 
Ä_wa™
; i++) {

1242 
”r2
;

1244 
”r2
 = 
	`fsüy±_deüy±_·geÿche_blocks
(
·ge
, 
blocksize
,

1245 
	`bh_off£t
(
wa™
[
i
]));

1246 ià(
”r2
) {

1247 
	`ş—r_bufãr_u±od©e
(
wa™
[
i
]);

1248 
”r
 = 
”r2
;

1253  
”r
;

1254 
	}
}

1257 
	$ext4_wr™e_begš
(
fe
 *fe, 
add»ss_¥aû
 *
m­pšg
,

1258 
loff_t
 
pos
, 
Ën
, 
æags
,

1259 
·ge
 **
·g•
, **
fsd©a
)

1261 
šode
 *šodğ
m­pšg
->
ho¡
;

1262 
»t
, 
Ãeded_blocks
;

1263 
hªdË_t
 *
hªdË
;

1264 
»Œ›s
 = 0;

1265 
·ge
 *page;

1266 
pgoff_t
 
šdex
;

1267 
äom
, 
to
;

1269 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

1270  -
EIO
;

1272 
	`Œaû_ext4_wr™e_begš
(
šode
, 
pos
, 
Ën
, 
æags
);

1277 
Ãeded_blocks
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
) + 1;

1278 
šdex
 = 
pos
 >> 
PAGE_SHIFT
;

1279 
äom
 = 
pos
 & (
PAGE_SIZE
 - 1);

1280 
to
 = 
äom
 + 
Ën
;

1282 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
)) {

1283 
»t
 = 
	`ext4_Œy_to_wr™e_šlše_d©a
(
m­pšg
, 
šode
, 
pos
, 
Ën
,

1284 
æags
, 
·g•
);

1285 ià(
»t
 < 0)

1286  
»t
;

1287 ià(
»t
 == 1)

1298 
»Œy_g¿b
:

1299 
·ge
 = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
, 
šdex
, 
æags
);

1300 ià(!
·ge
)

1301  -
ENOMEM
;

1302 
	`uÆock_·ge
(
·ge
);

1304 
»Œy_jouº®
:

1305 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_WRITE_PAGE
, 
Ãeded_blocks
);

1306 ià(
	`IS_ERR
(
hªdË
)) {

1307 
	`put_·ge
(
·ge
);

1308  
	`PTR_ERR
(
hªdË
);

1311 
	`lock_·ge
(
·ge
);

1312 ià(
·ge
->
m­pšg
 != mapping) {

1314 
	`uÆock_·ge
(
·ge
);

1315 
	`put_·ge
(
·ge
);

1316 
	`ext4_jouº®_¡İ
(
hªdË
);

1317 
»Œy_g¿b
;

1320 
	`wa™_fÜ_¡abË_·ge
(
·ge
);

1322 #ifdeà
CONFIG_FS_ENCRYPTION


1323 ià(
	`ext4_should_diÜ—d_nŞock
(
šode
))

1324 
»t
 = 
	`ext4_block_wr™e_begš
(
·ge
, 
pos
, 
Ën
,

1325 
ext4_g‘_block_unwr™‹n
);

1327 
»t
 = 
	`ext4_block_wr™e_begš
(
·ge
, 
pos
, 
Ën
,

1328 
ext4_g‘_block
);

1330 ià(
	`ext4_should_diÜ—d_nŞock
(
šode
))

1331 
»t
 = 
	`__block_wr™e_begš
(
·ge
, 
pos
, 
Ën
,

1332 
ext4_g‘_block_unwr™‹n
);

1334 
»t
 = 
	`__block_wr™e_begš
(
·ge
, 
pos
, 
Ën
, 
ext4_g‘_block
);

1336 ià(!
»t
 && 
	`ext4_should_jouº®_d©a
(
šode
)) {

1337 
»t
 = 
	`ext4_w®k_·ge_bufãrs
(
hªdË
, 
	`·ge_bufãrs
(
·ge
),

1338 
äom
, 
to
, 
NULL
,

1339 
do_jouº®_g‘_wr™e_acûss
);

1342 ià(
»t
) {

1343 
boŞ
 
ex‹nded
 = (
pos
 + 
Ën
 > 
šode
->
i_size
) &&

1344 !
	`ext4_v”™y_š_´og»ss
(
šode
);

1346 
	`uÆock_·ge
(
·ge
);

1355 ià(
ex‹nded
 && 
	`ext4_ÿn_Œunÿ‹
(
šode
))

1356 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

1358 
	`ext4_jouº®_¡İ
(
hªdË
);

1359 ià(
ex‹nded
) {

1360 
	`ext4_Œunÿ‹_çed_wr™e
(
šode
);

1367 ià(
šode
->
i_Æšk
)

1368 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

1371 ià(
»t
 =ğ-
ENOSPC
 &&

1372 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

1373 
»Œy_jouº®
;

1374 
	`put_·ge
(
·ge
);

1375  
»t
;

1377 *
·g•
 = 
·ge
;

1378  
»t
;

1379 
	}
}

1382 
	$wr™e_’d_â
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1384 
»t
;

1385 ià(!
	`bufãr_m­³d
(
bh
è|| 
	`bufãr_ä“d
(bh))

1387 
	`£t_bufãr_u±od©e
(
bh
);

1388 
»t
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

1389 
	`ş—r_bufãr_m‘a
(
bh
);

1390 
	`ş—r_bufãr_´io
(
bh
);

1391  
»t
;

1392 
	}
}

1401 
	$ext4_wr™e_’d
(
fe
 *file,

1402 
add»ss_¥aû
 *
m­pšg
,

1403 
loff_t
 
pos
, 
Ën
, 
cİ›d
,

1404 
·ge
 *·ge, *
fsd©a
)

1406 
hªdË_t
 *
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

1407 
šode
 *šodğ
m­pšg
->
ho¡
;

1408 
loff_t
 
Şd_size
 = 
šode
->
i_size
;

1409 
»t
 = 0, 
»t2
;

1410 
i_size_chªged
 = 0;

1411 
šlše_d©a
 = 
	`ext4_has_šlše_d©a
(
šode
);

1412 
boŞ
 
v”™y
 = 
	`ext4_v”™y_š_´og»ss
(
šode
);

1414 
	`Œaû_ext4_wr™e_’d
(
šode
, 
pos
, 
Ën
, 
cİ›d
);

1415 ià(
šlše_d©a
) {

1416 
»t
 = 
	`ext4_wr™e_šlše_d©a_’d
(
šode
, 
pos
, 
Ën
,

1417 
cİ›d
, 
·ge
);

1418 ià(
»t
 < 0) {

1419 
	`uÆock_·ge
(
·ge
);

1420 
	`put_·ge
(
·ge
);

1421 
”rout
;

1423 
cİ›d
 = 
»t
;

1425 
cİ›d
 = 
	`block_wr™e_’d
(
fe
, 
m­pšg
, 
pos
,

1426 
Ën
, 
cİ›d
, 
·ge
, 
fsd©a
);

1434 ià(!
v”™y
)

1435 
i_size_chªged
 = 
	`ext4_upd©e_šode_size
(
šode
, 
pos
 + 
cİ›d
);

1436 
	`uÆock_·ge
(
·ge
);

1437 
	`put_·ge
(
·ge
);

1439 ià(
Şd_size
 < 
pos
 && !
v”™y
)

1440 
	`·geÿche_isize_ex‹nded
(
šode
, 
Şd_size
, 
pos
);

1447 ià(
i_size_chªged
 || 
šlše_d©a
)

1448 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1450 ià(
pos
 + 
Ën
 > 
šode
->
i_size
 && !
v”™y
 && 
	`ext4_ÿn_Œunÿ‹
(inode))

1455 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

1456 
”rout
:

1457 
»t2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

1458 ià(!
»t
)

1459 
»t
 = 
»t2
;

1461 ià(
pos
 + 
Ën
 > 
šode
->
i_size
 && !
v”™y
) {

1462 
	`ext4_Œunÿ‹_çed_wr™e
(
šode
);

1468 ià(
šode
->
i_Æšk
)

1469 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

1472  
»t
 ?„‘ : 
cİ›d
;

1473 
	}
}

1480 
	$ext4_jouº®Ëd_z”o_Ãw_bufãrs
(
hªdË_t
 *
hªdË
,

1481 
·ge
 *page,

1482 
äom
, 
to
)

1484 
block_¡¬t
 = 0, 
block_’d
;

1485 
bufãr_h—d
 *
h—d
, *
bh
;

1487 
bh
 = 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

1489 
block_’d
 = 
block_¡¬t
 + 
bh
->
b_size
;

1490 ià(
	`bufãr_Ãw
(
bh
)) {

1491 ià(
block_’d
 > 
äom
 && 
block_¡¬t
 < 
to
) {

1492 ià(!
	`PageU±od©e
(
·ge
)) {

1493 
¡¬t
, 
size
;

1495 
¡¬t
 = 
	`max
(
äom
, 
block_¡¬t
);

1496 
size
 = 
	`mš
(
to
, 
block_’d
è- 
¡¬t
;

1498 
	`z”o_u£r
(
·ge
, 
¡¬t
, 
size
);

1499 
	`wr™e_’d_â
(
hªdË
, 
bh
);

1501 
	`ş—r_bufãr_Ãw
(
bh
);

1504 
block_¡¬t
 = 
block_’d
;

1505 
bh
 = bh->
b_this_·ge
;

1506 } 
bh
 !ğ
h—d
);

1507 
	}
}

1509 
	$ext4_jouº®Ëd_wr™e_’d
(
fe
 *file,

1510 
add»ss_¥aû
 *
m­pšg
,

1511 
loff_t
 
pos
, 
Ën
, 
cİ›d
,

1512 
·ge
 *·ge, *
fsd©a
)

1514 
hªdË_t
 *
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

1515 
šode
 *šodğ
m­pšg
->
ho¡
;

1516 
loff_t
 
Şd_size
 = 
šode
->
i_size
;

1517 
»t
 = 0, 
»t2
;

1518 
·¹Ÿl
 = 0;

1519 
äom
, 
to
;

1520 
size_chªged
 = 0;

1521 
šlše_d©a
 = 
	`ext4_has_šlše_d©a
(
šode
);

1522 
boŞ
 
v”™y
 = 
	`ext4_v”™y_š_´og»ss
(
šode
);

1524 
	`Œaû_ext4_jouº®Ëd_wr™e_’d
(
šode
, 
pos
, 
Ën
, 
cİ›d
);

1525 
äom
 = 
pos
 & (
PAGE_SIZE
 - 1);

1526 
to
 = 
äom
 + 
Ën
;

1528 
	`BUG_ON
(!
	`ext4_hªdË_v®id
(
hªdË
));

1530 ià(
šlše_d©a
) {

1531 
»t
 = 
	`ext4_wr™e_šlše_d©a_’d
(
šode
, 
pos
, 
Ën
,

1532 
cİ›d
, 
·ge
);

1533 ià(
»t
 < 0) {

1534 
	`uÆock_·ge
(
·ge
);

1535 
	`put_·ge
(
·ge
);

1536 
”rout
;

1538 
cİ›d
 = 
»t
;

1539 } ià(
	`uÆik–y
(
cİ›d
 < 
Ën
è&& !
	`PageU±od©e
(
·ge
)) {

1540 
cİ›d
 = 0;

1541 
	`ext4_jouº®Ëd_z”o_Ãw_bufãrs
(
hªdË
, 
·ge
, 
äom
, 
to
);

1543 ià(
	`uÆik–y
(
cİ›d
 < 
Ën
))

1544 
	`ext4_jouº®Ëd_z”o_Ãw_bufãrs
(
hªdË
, 
·ge
,

1545 
äom
 + 
cİ›d
, 
to
);

1546 
»t
 = 
	`ext4_w®k_·ge_bufãrs
(
hªdË
, 
	`·ge_bufãrs
(
·ge
), 
äom
,

1547 
äom
 + 
cİ›d
, &
·¹Ÿl
,

1548 
wr™e_’d_â
);

1549 ià(!
·¹Ÿl
)

1550 
	`S‘PageU±od©e
(
·ge
);

1552 ià(!
v”™y
)

1553 
size_chªged
 = 
	`ext4_upd©e_šode_size
(
šode
, 
pos
 + 
cİ›d
);

1554 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_JDATA
);

1555 
	`EXT4_I
(
šode
)->
i_d©async_tid
 = 
hªdË
->
h_Œª§ùiÚ
->
t_tid
;

1556 
	`uÆock_·ge
(
·ge
);

1557 
	`put_·ge
(
·ge
);

1559 ià(
Şd_size
 < 
pos
 && !
v”™y
)

1560 
	`·geÿche_isize_ex‹nded
(
šode
, 
Şd_size
, 
pos
);

1562 ià(
size_chªged
 || 
šlše_d©a
) {

1563 
»t2
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1564 ià(!
»t
)

1565 
»t
 = 
»t2
;

1568 ià(
pos
 + 
Ën
 > 
šode
->
i_size
 && !
v”™y
 && 
	`ext4_ÿn_Œunÿ‹
(inode))

1573 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

1575 
”rout
:

1576 
»t2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

1577 ià(!
»t
)

1578 
»t
 = 
»t2
;

1579 ià(
pos
 + 
Ën
 > 
šode
->
i_size
 && !
v”™y
) {

1580 
	`ext4_Œunÿ‹_çed_wr™e
(
šode
);

1586 ià(
šode
->
i_Æšk
)

1587 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

1590  
»t
 ?„‘ : 
cİ›d
;

1591 
	}
}

1596 
	$ext4_da_»£rve_¥aû
(
šode
 *inode)

1598 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

1599 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

1600 
»t
;

1607 
»t
 = 
	`dquÙ_»£rve_block
(
šode
, 
	`EXT4_C2B
(
sbi
, 1));

1608 ià(
»t
)

1609  
»t
;

1611 
	`¥š_lock
(&
ei
->
i_block_»£rv©iÚ_lock
);

1612 ià(
	`ext4_şaim_ä“_şu¡”s
(
sbi
, 1, 0)) {

1613 
	`¥š_uÆock
(&
ei
->
i_block_»£rv©iÚ_lock
);

1614 
	`dquÙ_»Ëa£_»£rv©iÚ_block
(
šode
, 
	`EXT4_C2B
(
sbi
, 1));

1615  -
ENOSPC
;

1617 
ei
->
i_»£rved_d©a_blocks
++;

1618 
	`Œaû_ext4_da_»£rve_¥aû
(
šode
);

1619 
	`¥š_uÆock
(&
ei
->
i_block_»£rv©iÚ_lock
);

1622 
	}
}

1624 
	$ext4_da_»Ëa£_¥aû
(
šode
 *šode, 
to_ä“
)

1626 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

1627 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

1629 ià(!
to_ä“
)

1632 
	`¥š_lock
(&
	`EXT4_I
(
šode
)->
i_block_»£rv©iÚ_lock
);

1634 
	`Œaû_ext4_da_»Ëa£_¥aû
(
šode
, 
to_ä“
);

1635 ià(
	`uÆik–y
(
to_ä“
 > 
ei
->
i_»£rved_d©a_blocks
)) {

1642 
	`ext4_w¬nšg
(
šode
->
i_sb
, "ext4_da_release_space: "

1644 "d©¨blocks", 
šode
->
i_šo
, 
to_ä“
,

1645 
ei
->
i_»£rved_d©a_blocks
);

1646 
	`WARN_ON
(1);

1647 
to_ä“
 = 
ei
->
i_»£rved_d©a_blocks
;

1649 
ei
->
i_»£rved_d©a_blocks
 -ğ
to_ä“
;

1652 
	`³rıu_couÁ”_sub
(&
sbi
->
s_dœtyşu¡”s_couÁ”
, 
to_ä“
);

1654 
	`¥š_uÆock
(&
	`EXT4_I
(
šode
)->
i_block_»£rv©iÚ_lock
);

1656 
	`dquÙ_»Ëa£_»£rv©iÚ_block
(
šode
, 
	`EXT4_C2B
(
sbi
, 
to_ä“
));

1657 
	}
}

1663 
	sm·ge_da_d©a
 {

1664 
šode
 *
	mšode
;

1665 
wr™eback_cÚŒŞ
 *
	mwbc
;

1667 
pgoff_t
 
	mfœ¡_·ge
;

1668 
pgoff_t
 
	mÃxt_·ge
;

1669 
pgoff_t
 
	mÏ¡_·ge
;

1675 
ext4_m­_blocks
 
	mm­
;

1676 
ext4_io_subm™
 
	mio_subm™
;

1677 
	mdo_m­
:1;

1680 
	$m·ge_»Ëa£_unu£d_·ges
(
m·ge_da_d©a
 *
mpd
,

1681 
boŞ
 
šv®id©e
)

1683 
Ä_·ges
, 
i
;

1684 
pgoff_t
 
šdex
, 
’d
;

1685 
·gevec
 
pvec
;

1686 
šode
 *šodğ
mpd
->inode;

1687 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

1690 ià(
mpd
->
fœ¡_·ge
 >ğmpd->
Ãxt_·ge
)

1693 
šdex
 = 
mpd
->
fœ¡_·ge
;

1694 
’d
 = 
mpd
->
Ãxt_·ge
 - 1;

1695 ià(
šv®id©e
) {

1696 
ext4_lblk_t
 
¡¬t
, 
Ï¡
;

1697 
¡¬t
 = 
šdex
 << (
PAGE_SHIFT
 - 
šode
->
i_blkb™s
);

1698 
Ï¡
 = 
’d
 << (
PAGE_SHIFT
 - 
šode
->
i_blkb™s
);

1699 
	`ext4_es_»move_ex‹Á
(
šode
, 
¡¬t
, 
Ï¡
 - start + 1);

1702 
	`·gevec_š™
(&
pvec
);

1703 
šdex
 <ğ
’d
) {

1704 
Ä_·ges
 = 
	`·gevec_lookup_¿nge
(&
pvec
, 
m­pšg
, &
šdex
, 
’d
);

1705 ià(
Ä_·ges
 == 0)

1707 
i
 = 0; i < 
Ä_·ges
; i++) {

1708 
·ge
 *·gğ
pvec
.
·ges
[
i
];

1710 
	`BUG_ON
(!
	`PageLocked
(
·ge
));

1711 
	`BUG_ON
(
	`PageWr™eback
(
·ge
));

1712 ià(
šv®id©e
) {

1713 ià(
	`·ge_m­³d
(
·ge
))

1714 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

1715 
	`block_šv®id©•age
(
·ge
, 0, 
PAGE_SIZE
);

1716 
	`CË¬PageU±od©e
(
·ge
);

1718 
	`uÆock_·ge
(
·ge
);

1720 
	`·gevec_»Ëa£
(&
pvec
);

1722 
	}
}

1724 
	$ext4_´št_ä“_blocks
(
šode
 *inode)

1726 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

1727 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

1728 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

1730 
	`ext4_msg
(
sb
, 
KERN_CRIT
, "Total free blocks count %lld",

1731 
	`EXT4_C2B
(
	`EXT4_SB
(
šode
->
i_sb
),

1732 
	`ext4_couÁ_ä“_şu¡”s
(
sb
)));

1733 
	`ext4_msg
(
sb
, 
KERN_CRIT
, "Free/Dirty block details");

1734 
	`ext4_msg
(
sb
, 
KERN_CRIT
, "free_blocks=%lld",

1735 (è
	`EXT4_C2B
(
	`EXT4_SB
(
sb
),

1736 
	`³rıu_couÁ”_sum
(&
sbi
->
s_ä“şu¡”s_couÁ”
)));

1737 
	`ext4_msg
(
sb
, 
KERN_CRIT
, "dirty_blocks=%lld",

1738 (è
	`EXT4_C2B
(
	`EXT4_SB
(
sb
),

1739 
	`³rıu_couÁ”_sum
(&
sbi
->
s_dœtyşu¡”s_couÁ”
)));

1740 
	`ext4_msg
(
sb
, 
KERN_CRIT
, "Block„eservation details");

1741 
	`ext4_msg
(
sb
, 
KERN_CRIT
, "i_reserved_data_blocks=%u",

1742 
ei
->
i_»£rved_d©a_blocks
);

1744 
	}
}

1746 
	$ext4_bh_d–ay_Ü_unwr™‹n
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1748  (
	`bufãr_d–ay
(
bh
è|| 
	`bufãr_unwr™‹n
(bh)è&& 
	`bufãr_dœty
(bh);

1749 
	}
}

1762 
	$ext4_š£¹_d–ayed_block
(
šode
 *šode, 
ext4_lblk_t
 
lblk
)

1764 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

1765 
»t
;

1766 
boŞ
 
®loÿ‹d
 = 
çl£
;

1779 ià(
sbi
->
s_şu¡”_¿tio
 == 1) {

1780 
»t
 = 
	`ext4_da_»£rve_¥aû
(
šode
);

1781 ià(
»t
 != 0)

1782 
”rout
;

1784 ià(!
	`ext4_es_sÿn_şu
(
šode
, &
ext4_es_is_d–Úly
, 
lblk
)) {

1785 ià(!
	`ext4_es_sÿn_şu
(
šode
,

1786 &
ext4_es_is_m­³d
, 
lblk
)) {

1787 
»t
 = 
	`ext4_şu_m­³d
(
šode
,

1788 
	`EXT4_B2C
(
sbi
, 
lblk
));

1789 ià(
»t
 < 0)

1790 
”rout
;

1791 ià(
»t
 == 0) {

1792 
»t
 = 
	`ext4_da_»£rve_¥aû
(
šode
);

1793 ià(
»t
 != 0)

1794 
”rout
;

1796 
®loÿ‹d
 = 
Œue
;

1799 
®loÿ‹d
 = 
Œue
;

1804 
»t
 = 
	`ext4_es_š£¹_d–ayed_block
(
šode
, 
lblk
, 
®loÿ‹d
);

1806 
”rout
:

1807  
»t
;

1808 
	}
}

1816 
	$ext4_da_m­_blocks
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1817 
ext4_m­_blocks
 *
m­
,

1818 
bufãr_h—d
 *
bh
)

1820 
ex‹Á_¡©us
 
es
;

1821 
»tv®
;

1822 
£ùÜ_t
 
šv®id_block
 = ~((sector_t) 0xffff);

1823 #ifdeà
ES_AGGRESSIVE_TEST


1824 
ext4_m­_blocks
 
Üig_m­
;

1826 
	`memıy
(&
Üig_m­
, 
m­
, (*map));

1829 ià(
šv®id_block
 < 
	`ext4_blocks_couÁ
(
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
))

1830 
šv®id_block
 = ~0;

1832 
m­
->
m_æags
 = 0;

1833 
	`ext_debug
("ext4_da_map_blocks(): inode %lu, max_blocks %u,"

1834 "logiÿÈblock %lu\n", 
šode
->
i_šo
, 
m­
->
m_Ën
,

1835 (è
m­
->
m_lblk
);

1838 ià(
	`ext4_es_lookup_ex‹Á
(
šode
, 
iblock
, 
NULL
, &
es
)) {

1839 ià(
	`ext4_es_is_hŞe
(&
es
)) {

1840 
»tv®
 = 0;

1841 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

1842 
add_d–ayed
;

1849 ià(
	`ext4_es_is_d–ayed
(&
es
è&& !
	`ext4_es_is_unwr™‹n
(&es)) {

1850 
	`m­_bh
(
bh
, 
šode
->
i_sb
, 
šv®id_block
);

1851 
	`£t_bufãr_Ãw
(
bh
);

1852 
	`£t_bufãr_d–ay
(
bh
);

1856 
m­
->
m_pblk
 = 
	`ext4_es_pblock
(&
es
è+ 
iblock
 -ƒs.
es_lblk
;

1857 
»tv®
 = 
es
.
es_Ën
 - (
iblock
 -ƒs.
es_lblk
);

1858 ià(
»tv®
 > 
m­
->
m_Ën
)

1859 
»tv®
 = 
m­
->
m_Ën
;

1860 
m­
->
m_Ën
 = 
»tv®
;

1861 ià(
	`ext4_es_is_wr™‹n
(&
es
))

1862 
m­
->
m_æags
 |ğ
EXT4_MAP_MAPPED
;

1863 ià(
	`ext4_es_is_unwr™‹n
(&
es
))

1864 
m­
->
m_æags
 |ğ
EXT4_MAP_UNWRITTEN
;

1866 
	`BUG
();

1868 #ifdeà
ES_AGGRESSIVE_TEST


1869 
	`ext4_m­_blocks_es_»check
(
NULL
, 
šode
, 
m­
, &
Üig_m­
, 0);

1871  
»tv®
;

1878 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

1879 ià(
	`ext4_has_šlše_d©a
(
šode
))

1880 
»tv®
 = 0;

1881 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

1882 
»tv®
 = 
	`ext4_ext_m­_blocks
(
NULL
, 
šode
, 
m­
, 0);

1884 
»tv®
 = 
	`ext4_šd_m­_blocks
(
NULL
, 
šode
, 
m­
, 0);

1886 
add_d–ayed
:

1887 ià(
»tv®
 == 0) {

1888 
»t
;

1895 
»t
 = 
	`ext4_š£¹_d–ayed_block
(
šode
, 
m­
->
m_lblk
);

1896 ià(
»t
 != 0) {

1897 
»tv®
 = 
»t
;

1898 
out_uÆock
;

1901 
	`m­_bh
(
bh
, 
šode
->
i_sb
, 
šv®id_block
);

1902 
	`£t_bufãr_Ãw
(
bh
);

1903 
	`£t_bufãr_d–ay
(
bh
);

1904 } ià(
»tv®
 > 0) {

1905 
»t
;

1906 
¡©us
;

1908 ià(
	`uÆik–y
(
»tv®
 !ğ
m­
->
m_Ën
)) {

1909 
	`ext4_w¬nšg
(
šode
->
i_sb
,

1912 
šode
->
i_šo
, 
»tv®
, 
m­
->
m_Ën
);

1913 
	`WARN_ON
(1);

1916 
¡©us
 = 
m­
->
m_æags
 & 
EXT4_MAP_UNWRITTEN
 ?

1917 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

1918 
»t
 = 
	`ext4_es_š£¹_ex‹Á
(
šode
, 
m­
->
m_lblk
, m­->
m_Ën
,

1919 
m­
->
m_pblk
, 
¡©us
);

1920 ià(
»t
 != 0)

1921 
»tv®
 = 
»t
;

1924 
out_uÆock
:

1925 
	`up_»ad
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

1927  
»tv®
;

1928 
	}
}

1942 
	$ext4_da_g‘_block_´•
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1943 
bufãr_h—d
 *
bh
, 
ü—‹
)

1945 
ext4_m­_blocks
 
m­
;

1946 
»t
 = 0;

1948 
	`BUG_ON
(
ü—‹
 == 0);

1949 
	`BUG_ON
(
bh
->
b_size
 !ğ
šode
->
i_sb
->
s_blocksize
);

1951 
m­
.
m_lblk
 = 
iblock
;

1952 
m­
.
m_Ën
 = 1;

1959 
»t
 = 
	`ext4_da_m­_blocks
(
šode
, 
iblock
, &
m­
, 
bh
);

1960 ià(
»t
 <= 0)

1961  
»t
;

1963 
	`m­_bh
(
bh
, 
šode
->
i_sb
, 
m­
.
m_pblk
);

1964 
	`ext4_upd©e_bh_¡©e
(
bh
, 
m­
.
m_æags
);

1966 ià(
	`bufãr_unwr™‹n
(
bh
)) {

1973 
	`£t_bufãr_Ãw
(
bh
);

1974 
	`£t_bufãr_m­³d
(
bh
);

1977 
	}
}

1979 
	$bg‘_Úe
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1981 
	`g‘_bh
(
bh
);

1983 
	}
}

1985 
	$bput_Úe
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1987 
	`put_bh
(
bh
);

1989 
	}
}

1991 
	$__ext4_jouº®Ëd_wr™•age
(
·ge
 *page,

1992 
Ën
)

1994 
add»ss_¥aû
 *
m­pšg
 = 
·ge
->mapping;

1995 
šode
 *šodğ
m­pšg
->
ho¡
;

1996 
bufãr_h—d
 *
·ge_bufs
 = 
NULL
;

1997 
hªdË_t
 *
hªdË
 = 
NULL
;

1998 
»t
 = 0, 
”r
 = 0;

1999 
šlše_d©a
 = 
	`ext4_has_šlše_d©a
(
šode
);

2000 
bufãr_h—d
 *
šode_bh
 = 
NULL
;

2002 
	`CË¬PageChecked
(
·ge
);

2004 ià(
šlše_d©a
) {

2005 
	`BUG_ON
(
·ge
->
šdex
 != 0);

2006 
	`BUG_ON
(
Ën
 > 
	`ext4_g‘_max_šlše_size
(
šode
));

2007 
šode_bh
 = 
	`ext4_jouº®Ëd_wr™e_šlše_d©a
(
šode
, 
Ën
, 
·ge
);

2008 ià(
šode_bh
 =ğ
NULL
)

2009 
out
;

2011 
·ge_bufs
 = 
	`·ge_bufãrs
(
·ge
);

2012 ià(!
·ge_bufs
) {

2013 
	`BUG
();

2014 
out
;

2016 
	`ext4_w®k_·ge_bufãrs
(
hªdË
, 
·ge_bufs
, 0, 
Ën
,

2017 
NULL
, 
bg‘_Úe
);

2024 
	`g‘_·ge
(
·ge
);

2025 
	`uÆock_·ge
(
·ge
);

2027 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_WRITE_PAGE
,

2028 
	`ext4_wr™•age_Œªs_blocks
(
šode
));

2029 ià(
	`IS_ERR
(
hªdË
)) {

2030 
»t
 = 
	`PTR_ERR
(
hªdË
);

2031 
	`put_·ge
(
·ge
);

2032 
out_no_·g–ock
;

2034 
	`BUG_ON
(!
	`ext4_hªdË_v®id
(
hªdË
));

2036 
	`lock_·ge
(
·ge
);

2037 
	`put_·ge
(
·ge
);

2038 ià(
·ge
->
m­pšg
 != mapping) {

2040 
	`ext4_jouº®_¡İ
(
hªdË
);

2041 
»t
 = 0;

2042 
out
;

2045 ià(
šlše_d©a
) {

2046 
»t
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

2048 
»t
 = 
	`ext4_w®k_·ge_bufãrs
(
hªdË
, 
·ge_bufs
, 0, 
Ën
, 
NULL
,

2049 
do_jouº®_g‘_wr™e_acûss
);

2051 
”r
 = 
	`ext4_w®k_·ge_bufãrs
(
hªdË
, 
·ge_bufs
, 0, 
Ën
, 
NULL
,

2052 
wr™e_’d_â
);

2054 ià(
»t
 == 0)

2055 
»t
 = 
”r
;

2056 
	`EXT4_I
(
šode
)->
i_d©async_tid
 = 
hªdË
->
h_Œª§ùiÚ
->
t_tid
;

2057 
”r
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

2058 ià(!
»t
)

2059 
»t
 = 
”r
;

2061 ià(!
	`ext4_has_šlše_d©a
(
šode
))

2062 
	`ext4_w®k_·ge_bufãrs
(
NULL
, 
·ge_bufs
, 0, 
Ën
,

2063 
NULL
, 
bput_Úe
);

2064 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_JDATA
);

2065 
out
:

2066 
	`uÆock_·ge
(
·ge
);

2067 
out_no_·g–ock
:

2068 
	`b»l£
(
šode_bh
);

2069  
»t
;

2070 
	}
}

2113 
	$ext4_wr™•age
(
·ge
 *page,

2114 
wr™eback_cÚŒŞ
 *
wbc
)

2116 
»t
 = 0;

2117 
loff_t
 
size
;

2118 
Ën
;

2119 
bufãr_h—d
 *
·ge_bufs
 = 
NULL
;

2120 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

2121 
ext4_io_subm™
 
io_subm™
;

2122 
boŞ
 
k“p_towr™e
 = 
çl£
;

2124 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
)))) {

2125 
	`ext4_šv®id©•age
(
·ge
, 0, 
PAGE_SIZE
);

2126 
	`uÆock_·ge
(
·ge
);

2127  -
EIO
;

2130 
	`Œaû_ext4_wr™•age
(
·ge
);

2131 
size
 = 
	`i_size_»ad
(
šode
);

2132 ià(
·ge
->
šdex
 =ğ
size
 >> 
PAGE_SHIFT
 &&

2133 !
	`ext4_v”™y_š_´og»ss
(
šode
))

2134 
Ën
 = 
size
 & ~
PAGE_MASK
;

2136 
Ën
 = 
PAGE_SIZE
;

2138 
·ge_bufs
 = 
	`·ge_bufãrs
(
·ge
);

2156 ià(
	`ext4_w®k_·ge_bufãrs
(
NULL
, 
·ge_bufs
, 0, 
Ën
, NULL,

2157 
ext4_bh_d–ay_Ü_unwr™‹n
)) {

2158 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

2159 ià((
cu¼’t
->
æags
 & 
PF_MEMALLOC
) ||

2160 (
šode
->
i_sb
->
s_blocksize
 =ğ
PAGE_SIZE
)) {

2166 
	`WARN_ON_ONCE
((
cu¼’t
->
æags
 & (
PF_MEMALLOC
|
PF_KSWAPD
))

2167 =ğ
PF_MEMALLOC
);

2168 
	`uÆock_·ge
(
·ge
);

2171 
k“p_towr™e
 = 
Œue
;

2174 ià(
	`PageChecked
(
·ge
è&& 
	`ext4_should_jouº®_d©a
(
šode
))

2179  
	`__ext4_jouº®Ëd_wr™•age
(
·ge
, 
Ën
);

2181 
	`ext4_io_subm™_š™
(&
io_subm™
, 
wbc
);

2182 
io_subm™
.
io_’d
 = 
	`ext4_š™_io_’d
(
šode
, 
GFP_NOFS
);

2183 ià(!
io_subm™
.
io_’d
) {

2184 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

2185 
	`uÆock_·ge
(
·ge
);

2186  -
ENOMEM
;

2188 
»t
 = 
	`ext4_bio_wr™e_·ge
(&
io_subm™
, 
·ge
, 
Ën
, 
wbc
, 
k“p_towr™e
);

2189 
	`ext4_io_subm™
(&
io_subm™
);

2191 
	`ext4_put_io_’d_deãr
(
io_subm™
.
io_’d
);

2192  
»t
;

2193 
	}
}

2195 
	$m·ge_subm™_·ge
(
m·ge_da_d©a
 *
mpd
, 
·ge
 *page)

2197 
Ën
;

2198 
loff_t
 
size
;

2199 
”r
;

2201 
	`BUG_ON
(
·ge
->
šdex
 !ğ
mpd
->
fœ¡_·ge
);

2202 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

2216 
size
 = 
	`i_size_»ad
(
mpd
->
šode
);

2217 ià(
·ge
->
šdex
 =ğ
size
 >> 
PAGE_SHIFT
 &&

2218 !
	`ext4_v”™y_š_´og»ss
(
mpd
->
šode
))

2219 
Ën
 = 
size
 & ~
PAGE_MASK
;

2221 
Ën
 = 
PAGE_SIZE
;

2222 
”r
 = 
	`ext4_bio_wr™e_·ge
(&
mpd
->
io_subm™
, 
·ge
, 
Ën
, mpd->
wbc
, 
çl£
);

2223 ià(!
”r
)

2224 
mpd
->
wbc
->
Ä_to_wr™e
--;

2225 
mpd
->
fœ¡_·ge
++;

2227  
”r
;

2228 
	}
}

2230 
	#BH_FLAGS
 ((1 << 
BH_Unwr™‹n
è| (1 << 
BH_D–ay
))

	)

2237 
	#MAX_WRITEPAGES_EXTENT_LEN
 2048

	)

2253 
boŞ
 
	$m·ge_add_bh_to_ex‹Á
(
m·ge_da_d©a
 *
mpd
, 
ext4_lblk_t
 
lblk
,

2254 
bufãr_h—d
 *
bh
)

2256 
ext4_m­_blocks
 *
m­
 = &
mpd
->map;

2259 ià(!
	`bufãr_dœty
(
bh
è|| !
	`bufãr_m­³d
(bh) ||

2260 (!
	`bufãr_d–ay
(
bh
è&& !
	`bufãr_unwr™‹n
(bh))) {

2262 ià(
m­
->
m_Ën
 == 0)

2263  
Œue
;

2264  
çl£
;

2268 ià(
m­
->
m_Ën
 == 0) {

2270 ià(!
mpd
->
do_m­
)

2271  
çl£
;

2272 
m­
->
m_lblk
 = 
lblk
;

2273 
m­
->
m_Ën
 = 1;

2274 
m­
->
m_æags
 = 
bh
->
b_¡©e
 & 
BH_FLAGS
;

2275  
Œue
;

2279 ià(
m­
->
m_Ën
 >ğ
MAX_WRITEPAGES_EXTENT_LEN
)

2280  
çl£
;

2283 ià(
lblk
 =ğ
m­
->
m_lblk
 + m­->
m_Ën
 &&

2284 (
bh
->
b_¡©e
 & 
BH_FLAGS
è=ğ
m­
->
m_æags
) {

2285 
m­
->
m_Ën
++;

2286  
Œue
;

2288  
çl£
;

2289 
	}
}

2307 
	$m·ge_´oûss_·ge_bufs
(
m·ge_da_d©a
 *
mpd
,

2308 
bufãr_h—d
 *
h—d
,

2309 
bufãr_h—d
 *
bh
,

2310 
ext4_lblk_t
 
lblk
)

2312 
šode
 *šodğ
mpd
->inode;

2313 
”r
;

2314 
ext4_lblk_t
 
blocks
 = (
	`i_size_»ad
(
šode
è+ 
	`i_blocksize
(inode) - 1)

2315 >> 
šode
->
i_blkb™s
;

2317 ià(
	`ext4_v”™y_š_´og»ss
(
šode
))

2318 
blocks
 = 
EXT_MAX_BLOCKS
;

2321 
	`BUG_ON
(
	`bufãr_locked
(
bh
));

2323 ià(
lblk
 >ğ
blocks
 || !
	`m·ge_add_bh_to_ex‹Á
(
mpd
,†blk, 
bh
)) {

2325 ià(
mpd
->
m­
.
m_Ën
)

2328 ià(!
mpd
->
do_m­
)

2333 } 
lblk
++, (
bh
 = bh->
b_this_·ge
è!ğ
h—d
);

2335 ià(
mpd
->
m­
.
m_Ën
 == 0) {

2336 
”r
 = 
	`m·ge_subm™_·ge
(
mpd
, 
h—d
->
b_·ge
);

2337 ià(
”r
 < 0)

2338  
”r
;

2340  
lblk
 < 
blocks
;

2341 
	}
}

2357 
	$m·ge_m­_ªd_subm™_bufãrs
(
m·ge_da_d©a
 *
mpd
)

2359 
·gevec
 
pvec
;

2360 
Ä_·ges
, 
i
;

2361 
šode
 *šodğ
mpd
->inode;

2362 
bufãr_h—d
 *
h—d
, *
bh
;

2363 
bµ_b™s
 = 
PAGE_SHIFT
 - 
šode
->
i_blkb™s
;

2364 
pgoff_t
 
¡¬t
, 
’d
;

2365 
ext4_lblk_t
 
lblk
;

2366 
£ùÜ_t
 
pblock
;

2367 
”r
;

2369 
¡¬t
 = 
mpd
->
m­
.
m_lblk
 >> 
bµ_b™s
;

2370 
’d
 = (
mpd
->
m­
.
m_lblk
 + mpd->m­.
m_Ën
 - 1è>> 
bµ_b™s
;

2371 
lblk
 = 
¡¬t
 << 
bµ_b™s
;

2372 
pblock
 = 
mpd
->
m­
.
m_pblk
;

2374 
	`·gevec_š™
(&
pvec
);

2375 
¡¬t
 <ğ
’d
) {

2376 
Ä_·ges
 = 
	`·gevec_lookup_¿nge
(&
pvec
, 
šode
->
i_m­pšg
,

2377 &
¡¬t
, 
’d
);

2378 ià(
Ä_·ges
 == 0)

2380 
i
 = 0; i < 
Ä_·ges
; i++) {

2381 
·ge
 *·gğ
pvec
.
·ges
[
i
];

2383 
bh
 = 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

2385 ià(
lblk
 < 
mpd
->
m­
.
m_lblk
)

2387 ià(
lblk
 >ğ
mpd
->
m­
.
m_lblk
 + mpd->m­.
m_Ën
) {

2392 
mpd
->
m­
.
m_Ën
 = 0;

2393 
mpd
->
m­
.
m_æags
 = 0;

2401 
”r
 = 
	`m·ge_´oûss_·ge_bufs
(
mpd
, 
h—d
,

2402 
bh
, 
lblk
);

2403 
	`·gevec_»Ëa£
(&
pvec
);

2404 ià(
”r
 > 0)

2405 
”r
 = 0;

2406  
”r
;

2408 ià(
	`bufãr_d–ay
(
bh
)) {

2409 
	`ş—r_bufãr_d–ay
(
bh
);

2410 
bh
->
b_blockÄ
 = 
pblock
++;

2412 
	`ş—r_bufãr_unwr™‹n
(
bh
);

2413 } 
lblk
++, (
bh
 = bh->
b_this_·ge
è!ğ
h—d
);

2420 
mpd
->
io_subm™
.
io_’d
->
size
 +ğ
PAGE_SIZE
;

2422 
”r
 = 
	`m·ge_subm™_·ge
(
mpd
, 
·ge
);

2423 ià(
”r
 < 0) {

2424 
	`·gevec_»Ëa£
(&
pvec
);

2425  
”r
;

2428 
	`·gevec_»Ëa£
(&
pvec
);

2431 
mpd
->
m­
.
m_Ën
 = 0;

2432 
mpd
->
m­
.
m_æags
 = 0;

2434 
	}
}

2436 
	$m·ge_m­_Úe_ex‹Á
(
hªdË_t
 *
hªdË
, 
m·ge_da_d©a
 *
mpd
)

2438 
šode
 *šodğ
mpd
->inode;

2439 
ext4_m­_blocks
 *
m­
 = &
mpd
->map;

2440 
g‘_blocks_æags
;

2441 
”r
, 
diÜ—d_nŞock
;

2443 
	`Œaû_ext4_da_wr™e_·ges_ex‹Á
(
šode
, 
m­
);

2459 
g‘_blocks_æags
 = 
EXT4_GET_BLOCKS_CREATE
 |

2460 
EXT4_GET_BLOCKS_METADATA_NOFAIL
 |

2461 
EXT4_GET_BLOCKS_IO_SUBMIT
;

2462 
diÜ—d_nŞock
 = 
	`ext4_should_diÜ—d_nŞock
(
šode
);

2463 ià(
diÜ—d_nŞock
)

2464 
g‘_blocks_æags
 |ğ
EXT4_GET_BLOCKS_IO_CREATE_EXT
;

2465 ià(
m­
->
m_æags
 & (1 << 
BH_D–ay
))

2466 
g‘_blocks_æags
 |ğ
EXT4_GET_BLOCKS_DELALLOC_RESERVE
;

2468 
”r
 = 
	`ext4_m­_blocks
(
hªdË
, 
šode
, 
m­
, 
g‘_blocks_æags
);

2469 ià(
”r
 < 0)

2470  
”r
;

2471 ià(
diÜ—d_nŞock
 && (
m­
->
m_æags
 & 
EXT4_MAP_UNWRITTEN
)) {

2472 ià(!
mpd
->
io_subm™
.
io_’d
->
hªdË
 &&

2473 
	`ext4_hªdË_v®id
(
hªdË
)) {

2474 
mpd
->
io_subm™
.
io_’d
->
hªdË
 = hªdË->
h_rsv_hªdË
;

2475 
hªdË
->
h_rsv_hªdË
 = 
NULL
;

2477 
	`ext4_£t_io_unwr™‹n_æag
(
šode
, 
mpd
->
io_subm™
.
io_’d
);

2480 
	`BUG_ON
(
m­
->
m_Ën
 == 0);

2482 
	}
}

2504 
	$m·ge_m­_ªd_subm™_ex‹Á
(
hªdË_t
 *
hªdË
,

2505 
m·ge_da_d©a
 *
mpd
,

2506 
boŞ
 *
give_up_Ú_wr™e
)

2508 
šode
 *šodğ
mpd
->inode;

2509 
ext4_m­_blocks
 *
m­
 = &
mpd
->map;

2510 
”r
;

2511 
loff_t
 
disksize
;

2512 
´og»ss
 = 0;

2514 
mpd
->
io_subm™
.
io_’d
->
off£t
 =

2515 ((
loff_t
)
m­
->
m_lblk
è<< 
šode
->
i_blkb™s
;

2517 
”r
 = 
	`m·ge_m­_Úe_ex‹Á
(
hªdË
, 
mpd
);

2518 ià(
”r
 < 0) {

2519 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

2521 ià(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
sb
)) ||

2522 
	`EXT4_SB
(
sb
)->
s_mouÁ_æags
 & 
EXT4_MF_FS_ABORTED
)

2523 
šv®id©e_dœty_·ges
;

2529 ià((
”r
 =ğ-
ENOMEM
) ||

2530 (
”r
 =ğ-
ENOSPC
 && 
	`ext4_couÁ_ä“_şu¡”s
(
sb
))) {

2531 ià(
´og»ss
)

2532 
upd©e_disksize
;

2533  
”r
;

2535 
	`ext4_msg
(
sb
, 
KERN_CRIT
,

2539 
šode
->
i_šo
,

2540 ()
m­
->
m_lblk
,

2541 ()
m­
->
m_Ën
, -
”r
);

2542 
	`ext4_msg
(
sb
, 
KERN_CRIT
,

2545 ià(
”r
 =ğ-
ENOSPC
)

2546 
	`ext4_´št_ä“_blocks
(
šode
);

2547 
šv®id©e_dœty_·ges
:

2548 *
give_up_Ú_wr™e
 = 
Œue
;

2549  
”r
;

2551 
´og»ss
 = 1;

2556 
”r
 = 
	`m·ge_m­_ªd_subm™_bufãrs
(
mpd
);

2557 ià(
”r
 < 0)

2558 
upd©e_disksize
;

2559 } 
m­
->
m_Ën
);

2561 
upd©e_disksize
:

2566 
disksize
 = ((
loff_t
)
mpd
->
fœ¡_·ge
è<< 
PAGE_SHIFT
;

2567 ià(
disksize
 > 
	`EXT4_I
(
šode
)->
i_disksize
) {

2568 
”r2
;

2569 
loff_t
 
i_size
;

2571 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

2572 
i_size
 = 
	`i_size_»ad
(
šode
);

2573 ià(
disksize
 > 
i_size
)

2574 
disksize
 = 
i_size
;

2575 ià(
disksize
 > 
	`EXT4_I
(
šode
)->
i_disksize
)

2576 
	`EXT4_I
(
šode
)->
i_disksize
 = 
disksize
;

2577 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

2578 
”r2
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

2579 ià(
”r2
)

2580 
	`ext4_”rÜ
(
šode
->
i_sb
,

2582 
šode
->
i_šo
);

2583 ià(!
”r
)

2584 
”r
 = 
”r2
;

2586  
”r
;

2587 
	}
}

2596 
	$ext4_da_wr™•ages_Œªs_blocks
(
šode
 *inode)

2598 
bµ
 = 
	`ext4_jouº®_blocks_³r_·ge
(
šode
);

2600  
	`ext4_m‘a_Œªs_blocks
(
šode
,

2601 
MAX_WRITEPAGES_EXTENT_LEN
 + 
bµ
 - 1, bpp);

2602 
	}
}

2622 
	$m·ge_´•¬e_ex‹Á_to_m­
(
m·ge_da_d©a
 *
mpd
)

2624 
add»ss_¥aû
 *
m­pšg
 = 
mpd
->
šode
->
i_m­pšg
;

2625 
·gevec
 
pvec
;

2626 
Ä_·ges
;

2627 
Ëá
 = 
mpd
->
wbc
->
Ä_to_wr™e
;

2628 
pgoff_t
 
šdex
 = 
mpd
->
fœ¡_·ge
;

2629 
pgoff_t
 
’d
 = 
mpd
->
Ï¡_·ge
;

2630 
xa_m¬k_t
 
g
;

2631 
i
, 
”r
 = 0;

2632 
blkb™s
 = 
mpd
->
šode
->
i_blkb™s
;

2633 
ext4_lblk_t
 
lblk
;

2634 
bufãr_h—d
 *
h—d
;

2636 ià(
mpd
->
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
 || mpd->wbc->
gged_wr™•ages
)

2637 
g
 = 
PAGECACHE_TAG_TOWRITE
;

2639 
g
 = 
PAGECACHE_TAG_DIRTY
;

2641 
	`·gevec_š™
(&
pvec
);

2642 
mpd
->
m­
.
m_Ën
 = 0;

2643 
mpd
->
Ãxt_·ge
 = 
šdex
;

2644 
šdex
 <ğ
’d
) {

2645 
Ä_·ges
 = 
	`·gevec_lookup_¿nge_g
(&
pvec
, 
m­pšg
, &
šdex
, 
’d
,

2646 
g
);

2647 ià(
Ä_·ges
 == 0)

2648 
out
;

2650 
i
 = 0; i < 
Ä_·ges
; i++) {

2651 
·ge
 *·gğ
pvec
.
·ges
[
i
];

2661 ià(
mpd
->
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
 && 
Ëá
 <= 0)

2662 
out
;

2665 ià(
mpd
->
m­
.
m_Ën
 > 0 && mpd->
Ãxt_·ge
 !ğ
·ge
->
šdex
)

2666 
out
;

2668 
	`lock_·ge
(
·ge
);

2676 ià(!
	`PageDœty
(
·ge
) ||

2677 (
	`PageWr™eback
(
·ge
) &&

2678 (
mpd
->
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
)) ||

2679 
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

2680 
	`uÆock_·ge
(
·ge
);

2684 
	`wa™_Ú_·ge_wr™eback
(
·ge
);

2685 
	`BUG_ON
(
	`PageWr™eback
(
·ge
));

2687 ià(
mpd
->
m­
.
m_Ën
 == 0)

2688 
mpd
->
fœ¡_·ge
 = 
·ge
->
šdex
;

2689 
mpd
->
Ãxt_·ge
 = 
·ge
->
šdex
 + 1;

2691 
lblk
 = ((
ext4_lblk_t
)
·ge
->
šdex
) <<

2692 (
PAGE_SHIFT
 - 
blkb™s
);

2693 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

2694 
”r
 = 
	`m·ge_´oûss_·ge_bufs
(
mpd
, 
h—d
, h—d, 
lblk
);

2695 ià(
”r
 <= 0)

2696 
out
;

2697 
”r
 = 0;

2698 
Ëá
--;

2700 
	`·gevec_»Ëa£
(&
pvec
);

2701 
	`cÚd_»sched
();

2704 
out
:

2705 
	`·gevec_»Ëa£
(&
pvec
);

2706  
”r
;

2707 
	}
}

2709 
	$ext4_wr™•ages
(
add»ss_¥aû
 *
m­pšg
,

2710 
wr™eback_cÚŒŞ
 *
wbc
)

2712 
pgoff_t
 
wr™eback_šdex
 = 0;

2713 
Ä_to_wr™e
 = 
wbc
->nr_to_write;

2714 
¿nge_whŞe
 = 0;

2715 
cyşed
 = 1;

2716 
hªdË_t
 *
hªdË
 = 
NULL
;

2717 
m·ge_da_d©a
 
mpd
;

2718 
šode
 *šodğ
m­pšg
->
ho¡
;

2719 
Ãeded_blocks
, 
rsv_blocks
 = 0, 
»t
 = 0;

2720 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
m­pšg
->
ho¡
->
i_sb
);

2721 
boŞ
 
dÚe
;

2722 
blk_¶ug
 
¶ug
;

2723 
boŞ
 
give_up_Ú_wr™e
 = 
çl£
;

2725 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

2726  -
EIO
;

2728 
	`³rıu_down_»ad
(&
sbi
->
s_jouº®_æag_rw£m
);

2729 
	`Œaû_ext4_wr™•ages
(
šode
, 
wbc
);

2736 ià(!
m­pšg
->
Ä·ges
 || !
	`m­pšg_gged
(m­pšg, 
PAGECACHE_TAG_DIRTY
))

2737 
out_wr™•ages
;

2739 ià(
	`ext4_should_jouº®_d©a
(
šode
)) {

2740 
»t
 = 
	`g’”ic_wr™•ages
(
m­pšg
, 
wbc
);

2741 
out_wr™•ages
;

2754 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
m­pšg
->
ho¡
->
i_sb
)) ||

2755 
sbi
->
s_mouÁ_æags
 & 
EXT4_MF_FS_ABORTED
)) {

2756 
»t
 = -
EROFS
;

2757 
out_wr™•ages
;

2765 ià(
	`ext4_has_šlše_d©a
(
šode
)) {

2767 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 1);

2768 ià(
	`IS_ERR
(
hªdË
)) {

2769 
»t
 = 
	`PTR_ERR
(
hªdË
);

2770 
out_wr™•ages
;

2772 
	`BUG_ON
(
	`ext4_‹¡_šode_¡©e
(
šode
,

2773 
EXT4_STATE_MAY_INLINE_DATA
));

2774 
	`ext4_de¡roy_šlše_d©a
(
hªdË
, 
šode
);

2775 
	`ext4_jouº®_¡İ
(
hªdË
);

2778 ià(
	`ext4_should_diÜ—d_nŞock
(
šode
)) {

2783 
rsv_blocks
 = 1 + 
	`ext4_chunk_Œªs_blocks
(
šode
,

2784 
PAGE_SIZE
 >> 
šode
->
i_blkb™s
);

2787 ià(
wbc
->
¿nge_¡¬t
 =ğ0 && wbc->
¿nge_’d
 =ğ
LLONG_MAX
)

2788 
¿nge_whŞe
 = 1;

2790 ià(
wbc
->
¿nge_cyşic
) {

2791 
wr™eback_šdex
 = 
m­pšg
->writeback_index;

2792 ià(
wr™eback_šdex
)

2793 
cyşed
 = 0;

2794 
mpd
.
fœ¡_·ge
 = 
wr™eback_šdex
;

2795 
mpd
.
Ï¡_·ge
 = -1;

2797 
mpd
.
fœ¡_·ge
 = 
wbc
->
¿nge_¡¬t
 >> 
PAGE_SHIFT
;

2798 
mpd
.
Ï¡_·ge
 = 
wbc
->
¿nge_’d
 >> 
PAGE_SHIFT
;

2801 
mpd
.
šode
 = inode;

2802 
mpd
.
wbc
 = wbc;

2803 
	`ext4_io_subm™_š™
(&
mpd
.
io_subm™
, 
wbc
);

2804 
»Œy
:

2805 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
 || wbc->
gged_wr™•ages
)

2806 
	`g_·ges_fÜ_wr™eback
(
m­pšg
, 
mpd
.
fœ¡_·ge
, mpd.
Ï¡_·ge
);

2807 
dÚe
 = 
çl£
;

2808 
	`blk_¡¬t_¶ug
(&
¶ug
);

2816 
mpd
.
do_m­
 = 0;

2817 
mpd
.
io_subm™
.
io_’d
 = 
	`ext4_š™_io_’d
(
šode
, 
GFP_KERNEL
);

2818 ià(!
mpd
.
io_subm™
.
io_’d
) {

2819 
»t
 = -
ENOMEM
;

2820 
uÅlug
;

2822 
»t
 = 
	`m·ge_´•¬e_ex‹Á_to_m­
(&
mpd
);

2824 
	`m·ge_»Ëa£_unu£d_·ges
(&
mpd
, 
çl£
);

2826 
	`ext4_io_subm™
(&
mpd
.
io_subm™
);

2827 
	`ext4_put_io_’d_deãr
(
mpd
.
io_subm™
.
io_’d
);

2828 
mpd
.
io_subm™
.
io_’d
 = 
NULL
;

2829 ià(
»t
 < 0)

2830 
uÅlug
;

2832 !
dÚe
 && 
mpd
.
fœ¡_·ge
 <ğmpd.
Ï¡_·ge
) {

2834 
mpd
.
io_subm™
.
io_’d
 = 
	`ext4_š™_io_’d
(
šode
, 
GFP_KERNEL
);

2835 ià(!
mpd
.
io_subm™
.
io_’d
) {

2836 
»t
 = -
ENOMEM
;

2847 
	`BUG_ON
(
	`ext4_should_jouº®_d©a
(
šode
));

2848 
Ãeded_blocks
 = 
	`ext4_da_wr™•ages_Œªs_blocks
(
šode
);

2851 
hªdË
 = 
	`ext4_jouº®_¡¬t_w™h_»£rve
(
šode
,

2852 
EXT4_HT_WRITE_PAGE
, 
Ãeded_blocks
, 
rsv_blocks
);

2853 ià(
	`IS_ERR
(
hªdË
)) {

2854 
»t
 = 
	`PTR_ERR
(
hªdË
);

2855 
	`ext4_msg
(
šode
->
i_sb
, 
KERN_CRIT
, "%s: jbd2_start: "

2856 "%ld…ages, inØ%lu;ƒ¼ %d", 
__func__
,

2857 
wbc
->
Ä_to_wr™e
, 
šode
->
i_šo
, 
»t
);

2859 
	`ext4_put_io_’d
(
mpd
.
io_subm™
.
io_’d
);

2860 
mpd
.
io_subm™
.
io_’d
 = 
NULL
;

2863 
mpd
.
do_m­
 = 1;

2865 
	`Œaû_ext4_da_wr™e_·ges
(
šode
, 
mpd
.
fœ¡_·ge
, mpd.
wbc
);

2866 
»t
 = 
	`m·ge_´•¬e_ex‹Á_to_m­
(&
mpd
);

2867 ià(!
»t
) {

2868 ià(
mpd
.
m­
.
m_Ën
)

2869 
»t
 = 
	`m·ge_m­_ªd_subm™_ex‹Á
(
hªdË
, &
mpd
,

2870 &
give_up_Ú_wr™e
);

2878 
dÚe
 = 
Œue
;

2891 ià(!
	`ext4_hªdË_v®id
(
hªdË
è|| hªdË->
h_sync
 == 0) {

2892 
	`ext4_jouº®_¡İ
(
hªdË
);

2893 
hªdË
 = 
NULL
;

2894 
mpd
.
do_m­
 = 0;

2897 
	`m·ge_»Ëa£_unu£d_·ges
(&
mpd
, 
give_up_Ú_wr™e
);

2899 
	`ext4_io_subm™
(&
mpd
.
io_subm™
);

2908 ià(
hªdË
) {

2909 
	`ext4_put_io_’d_deãr
(
mpd
.
io_subm™
.
io_’d
);

2910 
	`ext4_jouº®_¡İ
(
hªdË
);

2912 
	`ext4_put_io_’d
(
mpd
.
io_subm™
.
io_’d
);

2913 
mpd
.
io_subm™
.
io_’d
 = 
NULL
;

2915 ià(
»t
 =ğ-
ENOSPC
 && 
sbi
->
s_jouº®
) {

2921 
	`jbd2_jouº®_fÜû_comm™_Ã¡ed
(
sbi
->
s_jouº®
);

2922 
»t
 = 0;

2926 ià(
»t
)

2929 
uÅlug
:

2930 
	`blk_fšish_¶ug
(&
¶ug
);

2931 ià(!
»t
 && !
cyşed
 && 
wbc
->
Ä_to_wr™e
 > 0) {

2932 
cyşed
 = 1;

2933 
mpd
.
Ï¡_·ge
 = 
wr™eback_šdex
 - 1;

2934 
mpd
.
fœ¡_·ge
 = 0;

2935 
»Œy
;

2939 ià(
wbc
->
¿nge_cyşic
 || (
¿nge_whŞe
 && wbc->
Ä_to_wr™e
 > 0))

2944 
m­pšg
->
wr™eback_šdex
 = 
mpd
.
fœ¡_·ge
;

2946 
out_wr™•ages
:

2947 
	`Œaû_ext4_wr™•ages_»suÉ
(
šode
, 
wbc
, 
»t
,

2948 
Ä_to_wr™e
 - 
wbc
->nr_to_write);

2949 
	`³rıu_up_»ad
(&
sbi
->
s_jouº®_æag_rw£m
);

2950  
»t
;

2951 
	}
}

2953 
	$ext4_dax_wr™•ages
(
add»ss_¥aû
 *
m­pšg
,

2954 
wr™eback_cÚŒŞ
 *
wbc
)

2956 
»t
;

2957 
Ä_to_wr™e
 = 
wbc
->nr_to_write;

2958 
šode
 *šodğ
m­pšg
->
ho¡
;

2959 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
m­pšg
->
ho¡
->
i_sb
);

2961 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

2962  -
EIO
;

2964 
	`³rıu_down_»ad
(&
sbi
->
s_jouº®_æag_rw£m
);

2965 
	`Œaû_ext4_wr™•ages
(
šode
, 
wbc
);

2967 
»t
 = 
	`dax_wr™eback_m­pšg_¿nge
(
m­pšg
, 
šode
->
i_sb
->
s_bdev
, 
wbc
);

2968 
	`Œaû_ext4_wr™•ages_»suÉ
(
šode
, 
wbc
, 
»t
,

2969 
Ä_to_wr™e
 - 
wbc
->nr_to_write);

2970 
	`³rıu_up_»ad
(&
sbi
->
s_jouº®_æag_rw£m
);

2971  
»t
;

2972 
	}
}

2974 
	$ext4_nÚda_sw™ch
(
su³r_block
 *
sb
)

2976 
s64
 
ä“_şu¡”s
, 
dœty_şu¡”s
;

2977 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2987 
ä“_şu¡”s
 =

2988 
	`³rıu_couÁ”_»ad_pos™ive
(&
sbi
->
s_ä“şu¡”s_couÁ”
);

2989 
dœty_şu¡”s
 =

2990 
	`³rıu_couÁ”_»ad_pos™ive
(&
sbi
->
s_dœtyşu¡”s_couÁ”
);

2994 ià(
dœty_şu¡”s
 && (
ä“_şu¡”s
 < 2 * dirty_clusters))

2995 
	`Œy_to_wr™eback_šodes_sb
(
sb
, 
WB_REASON_FS_FREE_SPACE
);

2997 ià(2 * 
ä“_şu¡”s
 < 3 * 
dœty_şu¡”s
 ||

2998 
ä“_şu¡”s
 < (
dœty_şu¡”s
 + 
EXT4_FREECLUSTERS_WATERMARK
)) {

3006 
	}
}

3009 
	$ext4_da_wr™e_üed™s
(
šode
 *šode, 
loff_t
 
pos
, 
Ën
)

3011 ià(
	`lik–y
(
	`ext4_has_ã©u»_Ïrge_fe
(
šode
->
i_sb
)))

3014 ià(
pos
 + 
Ën
 <= 0x7fffffffULL)

3019 
	}
}

3021 
	$ext4_da_wr™e_begš
(
fe
 *fe, 
add»ss_¥aû
 *
m­pšg
,

3022 
loff_t
 
pos
, 
Ën
, 
æags
,

3023 
·ge
 **
·g•
, **
fsd©a
)

3025 
»t
, 
»Œ›s
 = 0;

3026 
·ge
 *page;

3027 
pgoff_t
 
šdex
;

3028 
šode
 *šodğ
m­pšg
->
ho¡
;

3029 
hªdË_t
 *
hªdË
;

3031 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

3032  -
EIO
;

3034 
šdex
 = 
pos
 >> 
PAGE_SHIFT
;

3036 ià(
	`ext4_nÚda_sw™ch
(
šode
->
i_sb
è|| 
	`S_ISLNK
(šode->
i_mode
) ||

3037 
	`ext4_v”™y_š_´og»ss
(
šode
)) {

3038 *
fsd©a
 = (*)
FALL_BACK_TO_NONDELALLOC
;

3039  
	`ext4_wr™e_begš
(
fe
, 
m­pšg
, 
pos
,

3040 
Ën
, 
æags
, 
·g•
, 
fsd©a
);

3042 *
fsd©a
 = (*)0;

3043 
	`Œaû_ext4_da_wr™e_begš
(
šode
, 
pos
, 
Ën
, 
æags
);

3045 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
)) {

3046 
»t
 = 
	`ext4_da_wr™e_šlše_d©a_begš
(
m­pšg
, 
šode
,

3047 
pos
, 
Ën
, 
æags
,

3048 
·g•
, 
fsd©a
);

3049 ià(
»t
 < 0)

3050  
»t
;

3051 ià(
»t
 == 1)

3062 
»Œy_g¿b
:

3063 
·ge
 = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
, 
šdex
, 
æags
);

3064 ià(!
·ge
)

3065  -
ENOMEM
;

3066 
	`uÆock_·ge
(
·ge
);

3074 
»Œy_jouº®
:

3075 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_WRITE_PAGE
,

3076 
	`ext4_da_wr™e_üed™s
(
šode
, 
pos
, 
Ën
));

3077 ià(
	`IS_ERR
(
hªdË
)) {

3078 
	`put_·ge
(
·ge
);

3079  
	`PTR_ERR
(
hªdË
);

3082 
	`lock_·ge
(
·ge
);

3083 ià(
·ge
->
m­pšg
 != mapping) {

3085 
	`uÆock_·ge
(
·ge
);

3086 
	`put_·ge
(
·ge
);

3087 
	`ext4_jouº®_¡İ
(
hªdË
);

3088 
»Œy_g¿b
;

3091 
	`wa™_fÜ_¡abË_·ge
(
·ge
);

3093 #ifdeà
CONFIG_FS_ENCRYPTION


3094 
»t
 = 
	`ext4_block_wr™e_begš
(
·ge
, 
pos
, 
Ën
,

3095 
ext4_da_g‘_block_´•
);

3097 
»t
 = 
	`__block_wr™e_begš
(
·ge
, 
pos
, 
Ën
, 
ext4_da_g‘_block_´•
);

3099 ià(
»t
 < 0) {

3100 
	`uÆock_·ge
(
·ge
);

3101 
	`ext4_jouº®_¡İ
(
hªdË
);

3107 ià(
pos
 + 
Ën
 > 
šode
->
i_size
)

3108 
	`ext4_Œunÿ‹_çed_wr™e
(
šode
);

3110 ià(
»t
 =ğ-
ENOSPC
 &&

3111 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

3112 
»Œy_jouº®
;

3114 
	`put_·ge
(
·ge
);

3115  
»t
;

3118 *
·g•
 = 
·ge
;

3119  
»t
;

3120 
	}
}

3126 
	$ext4_da_should_upd©e_i_disksize
(
·ge
 *page,

3127 
off£t
)

3129 
bufãr_h—d
 *
bh
;

3130 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

3131 
idx
;

3132 
i
;

3134 
bh
 = 
	`·ge_bufãrs
(
·ge
);

3135 
idx
 = 
off£t
 >> 
šode
->
i_blkb™s
;

3137 
i
 = 0; i < 
idx
; i++)

3138 
bh
 = bh->
b_this_·ge
;

3140 ià(!
	`bufãr_m­³d
(
bh
è|| (
	`bufãr_d–ay
(bh)è|| 
	`bufãr_unwr™‹n
(bh))

3143 
	}
}

3145 
	$ext4_da_wr™e_’d
(
fe
 *file,

3146 
add»ss_¥aû
 *
m­pšg
,

3147 
loff_t
 
pos
, 
Ën
, 
cİ›d
,

3148 
·ge
 *·ge, *
fsd©a
)

3150 
šode
 *šodğ
m­pšg
->
ho¡
;

3151 
»t
 = 0, 
»t2
;

3152 
hªdË_t
 *
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

3153 
loff_t
 
Ãw_i_size
;

3154 
¡¬t
, 
’d
;

3155 
wr™e_mode
 = ()()
fsd©a
;

3157 ià(
wr™e_mode
 =ğ
FALL_BACK_TO_NONDELALLOC
)

3158  
	`ext4_wr™e_’d
(
fe
, 
m­pšg
, 
pos
,

3159 
Ën
, 
cİ›d
, 
·ge
, 
fsd©a
);

3161 
	`Œaû_ext4_da_wr™e_’d
(
šode
, 
pos
, 
Ën
, 
cİ›d
);

3162 
¡¬t
 = 
pos
 & (
PAGE_SIZE
 - 1);

3163 
’d
 = 
¡¬t
 + 
cİ›d
 - 1;

3170 
Ãw_i_size
 = 
pos
 + 
cİ›d
;

3171 ià(
cİ›d
 && 
Ãw_i_size
 > 
	`EXT4_I
(
šode
)->
i_disksize
) {

3172 ià(
	`ext4_has_šlše_d©a
(
šode
) ||

3173 
	`ext4_da_should_upd©e_i_disksize
(
·ge
, 
’d
)) {

3174 
	`ext4_upd©e_i_disksize
(
šode
, 
Ãw_i_size
);

3179 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

3183 ià(
wr™e_mode
 !ğ
CONVERT_INLINE_DATA
 &&

3184 
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
) &&

3185 
	`ext4_has_šlše_d©a
(
šode
))

3186 
»t2
 = 
	`ext4_da_wr™e_šlše_d©a_’d
(
šode
, 
pos
, 
Ën
, 
cİ›d
,

3187 
·ge
);

3189 
»t2
 = 
	`g’”ic_wr™e_’d
(
fe
, 
m­pšg
, 
pos
, 
Ën
, 
cİ›d
,

3190 
·ge
, 
fsd©a
);

3192 
cİ›d
 = 
»t2
;

3193 ià(
»t2
 < 0)

3194 
»t
 = 
»t2
;

3195 
»t2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

3196 ià(!
»t
)

3197 
»t
 = 
»t2
;

3199  
»t
 ?„‘ : 
cİ›d
;

3200 
	}
}

3205 
	$ext4_®loc_da_blocks
(
šode
 *inode)

3207 
	`Œaû_ext4_®loc_da_blocks
(
šode
);

3209 ià(!
	`EXT4_I
(
šode
)->
i_»£rved_d©a_blocks
)

3243  
	`fem­_æush
(
šode
->
i_m­pšg
);

3244 
	}
}

3260 
£ùÜ_t
 
	$ext4_bm­
(
add»ss_¥aû
 *
m­pšg
, 
£ùÜ_t
 
block
)

3262 
šode
 *šodğ
m­pšg
->
ho¡
;

3263 
jouº®_t
 *
jouº®
;

3264 
”r
;

3269 ià(
	`ext4_has_šlše_d©a
(
šode
))

3272 ià(
	`m­pšg_gged
(
m­pšg
, 
PAGECACHE_TAG_DIRTY
) &&

3273 
	`‹¡_İt
(
šode
->
i_sb
, 
DELALLOC
)) {

3279 
	`fem­_wr™e_ªd_wa™
(
m­pšg
);

3282 ià(
	`EXT4_JOURNAL
(
šode
) &&

3283 
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_JDATA
)) {

3302 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_JDATA
);

3303 
jouº®
 = 
	`EXT4_JOURNAL
(
šode
);

3304 
	`jbd2_jouº®_lock_upd©es
(
jouº®
);

3305 
”r
 = 
	`jbd2_jouº®_æush
(
jouº®
);

3306 
	`jbd2_jouº®_uÆock_upd©es
(
jouº®
);

3308 ià(
”r
)

3312  
	`g’”ic_block_bm­
(
m­pšg
, 
block
, 
ext4_g‘_block
);

3313 
	}
}

3315 
	$ext4_»ad·ge
(
fe
 *fe, 
·ge
 *page)

3317 
»t
 = -
EAGAIN
;

3318 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

3320 
	`Œaû_ext4_»ad·ge
(
·ge
);

3322 ià(
	`ext4_has_šlše_d©a
(
šode
))

3323 
»t
 = 
	`ext4_»ad·ge_šlše
(
šode
, 
·ge
);

3325 ià(
»t
 =ğ-
EAGAIN
)

3326  
	`ext4_m·ge_»ad·ges
(
·ge
->
m­pšg
, 
NULL
,…age, 1,

3327 
çl£
);

3329  
»t
;

3330 
	}
}

3333 
	$ext4_»ad·ges
(
fe
 *fe, 
add»ss_¥aû
 *
m­pšg
,

3334 
li¡_h—d
 *
·ges
, 
Ä_·ges
)

3336 
šode
 *šodğ
m­pšg
->
ho¡
;

3339 ià(
	`ext4_has_šlše_d©a
(
šode
))

3342  
	`ext4_m·ge_»ad·ges
(
m­pšg
, 
·ges
, 
NULL
, 
Ä_·ges
, 
Œue
);

3343 
	}
}

3345 
	$ext4_šv®id©•age
(
·ge
 *·ge, 
off£t
,

3346 
Ëngth
)

3348 
	`Œaû_ext4_šv®id©•age
(
·ge
, 
off£t
, 
Ëngth
);

3351 
	`WARN_ON
(
	`·ge_has_bufãrs
(
·ge
è&& 
	`bufãr_jbd
(
	`·ge_bufãrs
(page)));

3353 
	`block_šv®id©•age
(
·ge
, 
off£t
, 
Ëngth
);

3354 
	}
}

3356 
	$__ext4_jouº®Ëd_šv®id©•age
(
·ge
 *page,

3357 
off£t
,

3358 
Ëngth
)

3360 
jouº®_t
 *
jouº®
 = 
	`EXT4_JOURNAL
(
·ge
->
m­pšg
->
ho¡
);

3362 
	`Œaû_ext4_jouº®Ëd_šv®id©•age
(
·ge
, 
off£t
, 
Ëngth
);

3367 ià(
off£t
 =ğ0 && 
Ëngth
 =ğ
PAGE_SIZE
)

3368 
	`CË¬PageChecked
(
·ge
);

3370  
	`jbd2_jouº®_šv®id©•age
(
jouº®
, 
·ge
, 
off£t
, 
Ëngth
);

3371 
	}
}

3374 
	$ext4_jouº®Ëd_šv®id©•age
(
·ge
 *page,

3375 
off£t
,

3376 
Ëngth
)

3378 
	`WARN_ON
(
	`__ext4_jouº®Ëd_šv®id©•age
(
·ge
, 
off£t
, 
Ëngth
) < 0);

3379 
	}
}

3381 
	$ext4_»Ëa£·ge
(
·ge
 *·ge, 
gå_t
 
wa™
)

3383 
jouº®_t
 *
jouº®
 = 
	`EXT4_JOURNAL
(
·ge
->
m­pšg
->
ho¡
);

3385 
	`Œaû_ext4_»Ëa£·ge
(
·ge
);

3388 ià(
	`PageChecked
(
·ge
))

3390 ià(
jouº®
)

3391  
	`jbd2_jouº®_Œy_to_ä“_bufãrs
(
jouº®
, 
·ge
, 
wa™
);

3393  
	`Œy_to_ä“_bufãrs
(
·ge
);

3394 
	}
}

3396 
boŞ
 
	$ext4_šode_d©async_dœty
(
šode
 *inode)

3398 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
;

3400 ià(
jouº®
)

3401  !
	`jbd2_Œª§ùiÚ_comm™‹d
(
jouº®
,

3402 
	`EXT4_I
(
šode
)->
i_d©async_tid
);

3404 ià(!
	`li¡_em±y
(&
šode
->
i_m­pšg
->
´iv©e_li¡
))

3405  
Œue
;

3406  
šode
->
i_¡©e
 & 
I_DIRTY_DATASYNC
;

3407 
	}
}

3409 
	$ext4_iom­_begš
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ëngth
,

3410 
æags
, 
iom­
 *iomap)

3412 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

3413 
blkb™s
 = 
šode
->
i_blkb™s
;

3414 
fœ¡_block
, 
Ï¡_block
;

3415 
ext4_m­_blocks
 
m­
;

3416 
boŞ
 
d–®loc
 = 
çl£
;

3417 
»t
;

3419 ià((
off£t
 >> 
blkb™s
è> 
EXT4_MAX_LOGICAL_BLOCK
)

3420  -
EINVAL
;

3421 
fœ¡_block
 = 
off£t
 >> 
blkb™s
;

3422 
Ï¡_block
 = 
	`mš_t
(
loff_t
, (
off£t
 + 
Ëngth
 - 1è>> 
blkb™s
,

3423 
EXT4_MAX_LOGICAL_BLOCK
);

3425 ià(
æags
 & 
IOMAP_REPORT
) {

3426 ià(
	`ext4_has_šlše_d©a
(
šode
)) {

3427 
»t
 = 
	`ext4_šlše_d©a_iom­
(
šode
, 
iom­
);

3428 ià(
»t
 !ğ-
EAGAIN
) {

3429 ià(
»t
 =ğ0 && 
off£t
 >ğ
iom­
->
Ëngth
)

3430 
»t
 = -
ENOENT
;

3431  
»t
;

3435 ià(
	`WARN_ON_ONCE
(
	`ext4_has_šlše_d©a
(
šode
)))

3436  -
ERANGE
;

3439 
m­
.
m_lblk
 = 
fœ¡_block
;

3440 
m­
.
m_Ën
 = 
Ï¡_block
 - 
fœ¡_block
 + 1;

3442 ià(
æags
 & 
IOMAP_REPORT
) {

3443 
»t
 = 
	`ext4_m­_blocks
(
NULL
, 
šode
, &
m­
, 0);

3444 ià(
»t
 < 0)

3445  
»t
;

3447 ià(
»t
 == 0) {

3448 
ext4_lblk_t
 
’d
 = 
m­
.
m_lblk
 + m­.
m_Ën
 - 1;

3449 
ex‹Á_¡©us
 
es
;

3451 
	`ext4_es_fšd_ex‹Á_¿nge
(
šode
, &
ext4_es_is_d–ayed
,

3452 
m­
.
m_lblk
, 
’d
, &
es
);

3454 ià(!
es
.
es_Ën
 ||ƒs.
es_lblk
 > 
’d
) {

3456 } ià(
es
.
es_lblk
 > 
m­
.
m_lblk
) {

3458 
m­
.
m_Ën
 = 
es
.
es_lblk
 - m­.
m_lblk
;

3460 
ext4_lblk_t
 
offs
 = 0;

3462 ià(
es
.
es_lblk
 < 
m­
.
m_lblk
)

3463 
offs
 = 
m­
.
m_lblk
 - 
es
.
es_lblk
;

3464 
m­
.
m_lblk
 = 
es
.
es_lblk
 + 
offs
;

3465 
m­
.
m_Ën
 = 
es
.
es_Ën
 - 
offs
;

3466 
d–®loc
 = 
Œue
;

3469 } ià(
æags
 & 
IOMAP_WRITE
) {

3470 
dio_üed™s
;

3471 
hªdË_t
 *
hªdË
;

3472 
»Œ›s
 = 0;

3475 ià(
m­
.
m_Ën
 > 
DIO_MAX_BLOCKS
)

3476 
m­
.
m_Ën
 = 
DIO_MAX_BLOCKS
;

3477 
dio_üed™s
 = 
	`ext4_chunk_Œªs_blocks
(
šode
, 
m­
.
m_Ën
);

3478 
»Œy
:

3485 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MAP_BLOCKS
,

3486 
dio_üed™s
);

3487 ià(
	`IS_ERR
(
hªdË
))

3488  
	`PTR_ERR
(
hªdË
);

3490 
»t
 = 
	`ext4_m­_blocks
(
hªdË
, 
šode
, &
m­
,

3491 
EXT4_GET_BLOCKS_CREATE_ZERO
);

3492 ià(
»t
 < 0) {

3493 
	`ext4_jouº®_¡İ
(
hªdË
);

3494 ià(
»t
 =ğ-
ENOSPC
 &&

3495 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

3496 
»Œy
;

3497  
»t
;

3509 ià(!(
æags
 & 
IOMAP_FAULT
è&& 
fœ¡_block
 + 
m­
.
m_Ën
 >

3510 (
	`i_size_»ad
(
šode
è+ (1 << 
blkb™s
) - 1) >> blkbits) {

3511 
”r
;

3513 
”r
 = 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

3514 ià(
”r
 < 0) {

3515 
	`ext4_jouº®_¡İ
(
hªdË
);

3516  
”r
;

3519 
	`ext4_jouº®_¡İ
(
hªdË
);

3521 
»t
 = 
	`ext4_m­_blocks
(
NULL
, 
šode
, &
m­
, 0);

3522 ià(
»t
 < 0)

3523  
»t
;

3526 
iom­
->
æags
 = 0;

3527 ià(
	`ext4_šode_d©async_dœty
(
šode
))

3528 
iom­
->
æags
 |ğ
IOMAP_F_DIRTY
;

3529 
iom­
->
bdev
 = 
šode
->
i_sb
->
s_bdev
;

3530 
iom­
->
dax_dev
 = 
sbi
->
s_daxdev
;

3531 
iom­
->
off£t
 = (
u64
)
fœ¡_block
 << 
blkb™s
;

3532 
iom­
->
Ëngth
 = (
u64
)
m­
.
m_Ën
 << 
blkb™s
;

3534 ià(
»t
 == 0) {

3535 
iom­
->
ty³
 = 
d–®loc
 ? 
IOMAP_DELALLOC
 : 
IOMAP_HOLE
;

3536 
iom­
->
addr
 = 
IOMAP_NULL_ADDR
;

3538 ià(
m­
.
m_æags
 & 
EXT4_MAP_MAPPED
) {

3539 
iom­
->
ty³
 = 
IOMAP_MAPPED
;

3540 } ià(
m­
.
m_æags
 & 
EXT4_MAP_UNWRITTEN
) {

3541 
iom­
->
ty³
 = 
IOMAP_UNWRITTEN
;

3543 
	`WARN_ON_ONCE
(1);

3544  -
EIO
;

3546 
iom­
->
addr
 = (
u64
)
m­
.
m_pblk
 << 
blkb™s
;

3549 ià(
m­
.
m_æags
 & 
EXT4_MAP_NEW
)

3550 
iom­
->
æags
 |ğ
IOMAP_F_NEW
;

3553 
	}
}

3555 
	$ext4_iom­_’d
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ëngth
,

3556 
ssize_t
 
wr™‹n
, 
æags
, 
iom­
 *iomap)

3558 
»t
 = 0;

3559 
hªdË_t
 *
hªdË
;

3560 
blkb™s
 = 
šode
->
i_blkb™s
;

3561 
boŞ
 
Œunÿ‹
 = 
çl£
;

3563 ià(!(
æags
 & 
IOMAP_WRITE
è|| (æag & 
IOMAP_FAULT
))

3566 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 2);

3567 ià(
	`IS_ERR
(
hªdË
)) {

3568 
»t
 = 
	`PTR_ERR
(
hªdË
);

3569 
Üphª_d–
;

3571 ià(
	`ext4_upd©e_šode_size
(
šode
, 
off£t
 + 
wr™‹n
))

3572 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

3576 ià(
iom­
->
off£t
 + iom­->
Ëngth
 >

3577 
	`ALIGN
(
šode
->
i_size
, 1 << 
blkb™s
)) {

3578 
ext4_lblk_t
 
wr™‹n_blk
, 
’d_blk
;

3580 
wr™‹n_blk
 = (
off£t
 + 
wr™‹n
è>> 
blkb™s
;

3581 
’d_blk
 = (
off£t
 + 
Ëngth
è>> 
blkb™s
;

3582 ià(
wr™‹n_blk
 < 
’d_blk
 && 
	`ext4_ÿn_Œunÿ‹
(
šode
))

3583 
Œunÿ‹
 = 
Œue
;

3589 ià(!
Œunÿ‹
 && 
šode
->
i_Æšk
 &&

3590 !
	`li¡_em±y
(&
	`EXT4_I
(
šode
)->
i_Üphª
))

3591 
	`ext4_Üphª_d–
(
hªdË
, 
šode
);

3592 
	`ext4_jouº®_¡İ
(
hªdË
);

3593 ià(
Œunÿ‹
) {

3594 
	`ext4_Œunÿ‹_çed_wr™e
(
šode
);

3595 
Üphª_d–
:

3601 ià(
šode
->
i_Æšk
)

3602 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

3604  
»t
;

3605 
	}
}

3607 cÚ¡ 
iom­_İs
 
	gext4_iom­_İs
 = {

3608 .
iom­_begš
 = 
ext4_iom­_begš
,

3609 .
	giom­_’d
 = 
ext4_iom­_’d
,

3612 
	$ext4_’d_io_dio
(
kiocb
 *
iocb
, 
loff_t
 
off£t
,

3613 
ssize_t
 
size
, *
´iv©e
)

3615 
ext4_io_’d_t
 *
io_’d
 = 
´iv©e
;

3618 ià(!
io_’d
)

3621 
	`ext_debug
("ext4_end_io_dio(): io_end 0x%p "

3623 
io_’d
, io_’d->
šode
->
i_šo
, 
iocb
, 
off£t
, 
size
);

3629 ià(
size
 <= 0) {

3630 
	`ext4_ş—r_io_unwr™‹n_æag
(
io_’d
);

3631 
size
 = 0;

3633 
io_’d
->
off£t
 = offset;

3634 
io_’d
->
size
 = size;

3635 
	`ext4_put_io_’d
(
io_’d
);

3638 
	}
}

3661 
ssize_t
 
	$ext4_dœeù_IO_wr™e
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
)

3663 
fe
 *fğ
iocb
->
ki_fp
;

3664 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

3665 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

3666 
ssize_t
 
»t
;

3667 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

3668 
size_t
 
couÁ
 = 
	`iov_™”_couÁ
(
™”
);

3669 
ov”wr™e
 = 0;

3670 
g‘_block_t
 *
g‘_block_func
 = 
NULL
;

3671 
dio_æags
 = 0;

3672 
loff_t
 
fš®_size
 = 
off£t
 + 
couÁ
;

3673 
Üphª
 = 0;

3674 
hªdË_t
 *
hªdË
;

3676 ià(
fš®_size
 > 
šode
->
i_size
 || fš®_siz> 
ei
->
i_disksize
) {

3678 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 2);

3679 ià(
	`IS_ERR
(
hªdË
)) {

3680 
»t
 = 
	`PTR_ERR
(
hªdË
);

3681 
out
;

3683 
»t
 = 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

3684 ià(
»t
) {

3685 
	`ext4_jouº®_¡İ
(
hªdË
);

3686 
out
;

3688 
Üphª
 = 1;

3689 
	`ext4_upd©e_i_disksize
(
šode
, inode->
i_size
);

3690 
	`ext4_jouº®_¡İ
(
hªdË
);

3693 
	`BUG_ON
(
iocb
->
´iv©e
 =ğ
NULL
);

3700 
	`šode_dio_begš
(
šode
);

3703 
ov”wr™e
 = *((*)
iocb
->
´iv©e
);

3705 ià(
ov”wr™e
)

3706 
	`šode_uÆock
(
šode
);

3728 
iocb
->
´iv©e
 = 
NULL
;

3729 ià(
ov”wr™e
)

3730 
g‘_block_func
 = 
ext4_dio_g‘_block_ov”wr™e
;

3731 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
) ||

3732 
	`round_down
(
off£t
, 
	`i_blocksize
(
šode
)è>ğšode->
i_size
) {

3733 
g‘_block_func
 = 
ext4_dio_g‘_block
;

3734 
dio_æags
 = 
DIO_LOCKING
 | 
DIO_SKIP_HOLES
;

3735 } ià(
	`is_sync_kiocb
(
iocb
)) {

3736 
g‘_block_func
 = 
ext4_dio_g‘_block_unwr™‹n_sync
;

3737 
dio_æags
 = 
DIO_LOCKING
;

3739 
g‘_block_func
 = 
ext4_dio_g‘_block_unwr™‹n_async
;

3740 
dio_æags
 = 
DIO_LOCKING
;

3742 
»t
 = 
	`__blockdev_dœeù_IO
(
iocb
, 
šode
, inode->
i_sb
->
s_bdev
, 
™”
,

3743 
g‘_block_func
, 
ext4_’d_io_dio
, 
NULL
,

3744 
dio_æags
);

3746 ià(
»t
 > 0 && !
ov”wr™e
 && 
	`ext4_‹¡_šode_¡©e
(
šode
,

3747 
EXT4_STATE_DIO_UNWRITTEN
)) {

3748 
”r
;

3753 
”r
 = 
	`ext4_cÚv”t_unwr™‹n_ex‹Ás
(
NULL
, 
šode
,

3754 
off£t
, 
»t
);

3755 ià(
”r
 < 0)

3756 
»t
 = 
”r
;

3757 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_DIO_UNWRITTEN
);

3760 
	`šode_dio_’d
(
šode
);

3762 ià(
ov”wr™e
)

3763 
	`šode_lock
(
šode
);

3765 ià(
»t
 < 0 && 
fš®_size
 > 
šode
->
i_size
)

3766 
	`ext4_Œunÿ‹_çed_wr™e
(
šode
);

3769 ià(
Üphª
) {

3770 
”r
;

3773 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 2);

3774 ià(
	`IS_ERR
(
hªdË
)) {

3785 ià(!
»t
)

3786 
»t
 = 
	`PTR_ERR
(
hªdË
);

3787 ià(
šode
->
i_Æšk
)

3788 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

3790 
out
;

3792 ià(
šode
->
i_Æšk
)

3793 
	`ext4_Üphª_d–
(
hªdË
, 
šode
);

3794 ià(
»t
 > 0) {

3795 
loff_t
 
’d
 = 
off£t
 + 
»t
;

3796 ià(
’d
 > 
šode
->
i_size
 ||ƒnd > 
ei
->
i_disksize
) {

3797 
	`ext4_upd©e_i_disksize
(
šode
, 
’d
);

3798 ià(
’d
 > 
šode
->
i_size
)

3799 
	`i_size_wr™e
(
šode
, 
’d
);

3807 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

3810 
”r
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

3811 ià(
»t
 == 0)

3812 
»t
 = 
”r
;

3814 
out
:

3815  
»t
;

3816 
	}
}

3818 
ssize_t
 
	$ext4_dœeù_IO_»ad
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
)

3820 
add»ss_¥aû
 *
m­pšg
 = 
iocb
->
ki_fp
->
f_m­pšg
;

3821 
šode
 *šodğ
m­pšg
->
ho¡
;

3822 
size_t
 
couÁ
 = 
	`iov_™”_couÁ
(
™”
);

3823 
ssize_t
 
»t
;

3830 
	`šode_lock_sh¬ed
(
šode
);

3831 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
m­pšg
, 
iocb
->
ki_pos
,

3832 
iocb
->
ki_pos
 + 
couÁ
 - 1);

3833 ià(
»t
)

3834 
out_uÆock
;

3835 
»t
 = 
	`__blockdev_dœeù_IO
(
iocb
, 
šode
, inode->
i_sb
->
s_bdev
,

3836 
™”
, 
ext4_dio_g‘_block
, 
NULL
, NULL, 0);

3837 
out_uÆock
:

3838 
	`šode_uÆock_sh¬ed
(
šode
);

3839  
»t
;

3840 
	}
}

3842 
ssize_t
 
	$ext4_dœeù_IO
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
)

3844 
fe
 *fğ
iocb
->
ki_fp
;

3845 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

3846 
size_t
 
couÁ
 = 
	`iov_™”_couÁ
(
™”
);

3847 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

3848 
ssize_t
 
»t
;

3850 #ifdeà
CONFIG_FS_ENCRYPTION


3851 ià(
	`IS_ENCRYPTED
(
šode
è&& 
	`S_ISREG
(šode->
i_mode
))

3854 ià(
	`fsv”™y_aùive
(
šode
))

3860 ià(
	`ext4_should_jouº®_d©a
(
šode
))

3864 ià(
	`ext4_has_šlše_d©a
(
šode
))

3867 
	`Œaû_ext4_dœeù_IO_’‹r
(
šode
, 
off£t
, 
couÁ
, 
	`iov_™”_rw
(
™”
));

3868 ià(
	`iov_™”_rw
(
™”
è=ğ
READ
)

3869 
»t
 = 
	`ext4_dœeù_IO_»ad
(
iocb
, 
™”
);

3871 
»t
 = 
	`ext4_dœeù_IO_wr™e
(
iocb
, 
™”
);

3872 
	`Œaû_ext4_dœeù_IO_ex™
(
šode
, 
off£t
, 
couÁ
, 
	`iov_™”_rw
(
™”
), 
»t
);

3873  
»t
;

3874 
	}
}

3889 
	$ext4_jouº®Ëd_£t_·ge_dœty
(
·ge
 *page)

3891 
	`S‘PageChecked
(
·ge
);

3892  
	`__£t_·ge_dœty_nobufãrs
(
·ge
);

3893 
	}
}

3895 
	$ext4_£t_·ge_dœty
(
·ge
 *page)

3897 
	`WARN_ON_ONCE
(!
	`PageLocked
(
·ge
è&& !
	`PageDœty
(page));

3898 
	`WARN_ON_ONCE
(!
	`·ge_has_bufãrs
(
·ge
));

3899  
	`__£t_·ge_dœty_bufãrs
(
·ge
);

3900 
	}
}

3902 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gext4_aİs
 = {

3903 .
»ad·ge
 = 
ext4_»ad·ge
,

3904 .
	g»ad·ges
 = 
ext4_»ad·ges
,

3905 .
	gwr™•age
 = 
ext4_wr™•age
,

3906 .
	gwr™•ages
 = 
ext4_wr™•ages
,

3907 .
	gwr™e_begš
 = 
ext4_wr™e_begš
,

3908 .
	gwr™e_’d
 = 
ext4_wr™e_’d
,

3909 .
	g£t_·ge_dœty
 = 
ext4_£t_·ge_dœty
,

3910 .
	gbm­
 = 
ext4_bm­
,

3911 .
	gšv®id©•age
 = 
ext4_šv®id©•age
,

3912 .
	g»Ëa£·ge
 = 
ext4_»Ëa£·ge
,

3913 .
	gdœeù_IO
 = 
ext4_dœeù_IO
,

3914 .
	gmig¿‹·ge
 = 
bufãr_mig¿‹_·ge
,

3915 .
	gis_·¹ŸÎy_u±od©e
 = 
block_is_·¹ŸÎy_u±od©e
,

3916 .
	g”rÜ_»move_·ge
 = 
g’”ic_”rÜ_»move_·ge
,

3919 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gext4_jouº®Ëd_aİs
 = {

3920 .
»ad·ge
 = 
ext4_»ad·ge
,

3921 .
	g»ad·ges
 = 
ext4_»ad·ges
,

3922 .
	gwr™•age
 = 
ext4_wr™•age
,

3923 .
	gwr™•ages
 = 
ext4_wr™•ages
,

3924 .
	gwr™e_begš
 = 
ext4_wr™e_begš
,

3925 .
	gwr™e_’d
 = 
ext4_jouº®Ëd_wr™e_’d
,

3926 .
	g£t_·ge_dœty
 = 
ext4_jouº®Ëd_£t_·ge_dœty
,

3927 .
	gbm­
 = 
ext4_bm­
,

3928 .
	gšv®id©•age
 = 
ext4_jouº®Ëd_šv®id©•age
,

3929 .
	g»Ëa£·ge
 = 
ext4_»Ëa£·ge
,

3930 .
	gdœeù_IO
 = 
ext4_dœeù_IO
,

3931 .
	gis_·¹ŸÎy_u±od©e
 = 
block_is_·¹ŸÎy_u±od©e
,

3932 .
	g”rÜ_»move_·ge
 = 
g’”ic_”rÜ_»move_·ge
,

3935 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gext4_da_aİs
 = {

3936 .
»ad·ge
 = 
ext4_»ad·ge
,

3937 .
	g»ad·ges
 = 
ext4_»ad·ges
,

3938 .
	gwr™•age
 = 
ext4_wr™•age
,

3939 .
	gwr™•ages
 = 
ext4_wr™•ages
,

3940 .
	gwr™e_begš
 = 
ext4_da_wr™e_begš
,

3941 .
	gwr™e_’d
 = 
ext4_da_wr™e_’d
,

3942 .
	g£t_·ge_dœty
 = 
ext4_£t_·ge_dœty
,

3943 .
	gbm­
 = 
ext4_bm­
,

3944 .
	gšv®id©•age
 = 
ext4_šv®id©•age
,

3945 .
	g»Ëa£·ge
 = 
ext4_»Ëa£·ge
,

3946 .
	gdœeù_IO
 = 
ext4_dœeù_IO
,

3947 .
	gmig¿‹·ge
 = 
bufãr_mig¿‹_·ge
,

3948 .
	gis_·¹ŸÎy_u±od©e
 = 
block_is_·¹ŸÎy_u±od©e
,

3949 .
	g”rÜ_»move_·ge
 = 
g’”ic_”rÜ_»move_·ge
,

3952 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gext4_dax_aİs
 = {

3953 .
wr™•ages
 = 
ext4_dax_wr™•ages
,

3954 .
	gdœeù_IO
 = 
noİ_dœeù_IO
,

3955 .
	g£t_·ge_dœty
 = 
noİ_£t_·ge_dœty
,

3956 .
	gbm­
 = 
ext4_bm­
,

3957 .
	gšv®id©•age
 = 
noİ_šv®id©•age
,

3960 
	$ext4_£t_aİs
(
šode
 *inode)

3962 
	`ext4_šode_jouº®_mode
(
šode
)) {

3963 
EXT4_INODE_ORDERED_DATA_MODE
:

3964 
EXT4_INODE_WRITEBACK_DATA_MODE
:

3966 
EXT4_INODE_JOURNAL_DATA_MODE
:

3967 
šode
->
i_m­pšg
->
a_İs
 = &
ext4_jouº®Ëd_aİs
;

3970 
	`BUG
();

3972 ià(
	`IS_DAX
(
šode
))

3973 
šode
->
i_m­pšg
->
a_İs
 = &
ext4_dax_aİs
;

3974 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DELALLOC
))

3975 
šode
->
i_m­pšg
->
a_İs
 = &
ext4_da_aİs
;

3977 
šode
->
i_m­pšg
->
a_İs
 = &
ext4_aİs
;

3978 
	}
}

3980 
	$__ext4_block_z”o_·ge_¿nge
(
hªdË_t
 *
hªdË
,

3981 
add»ss_¥aû
 *
m­pšg
, 
loff_t
 
äom
,†off_ˆ
Ëngth
)

3983 
ext4_fsblk_t
 
šdex
 = 
äom
 >> 
PAGE_SHIFT
;

3984 
off£t
 = 
äom
 & (
PAGE_SIZE
-1);

3985 
blocksize
, 
pos
;

3986 
ext4_lblk_t
 
iblock
;

3987 
šode
 *šodğ
m­pšg
->
ho¡
;

3988 
bufãr_h—d
 *
bh
;

3989 
·ge
 *page;

3990 
”r
 = 0;

3992 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
m­pšg
, 
äom
 >> 
PAGE_SHIFT
,

3993 
	`m­pšg_gå_cÚ¡¿št
(
m­pšg
, ~
__GFP_FS
));

3994 ià(!
·ge
)

3995  -
ENOMEM
;

3997 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

3999 
iblock
 = 
šdex
 << (
PAGE_SHIFT
 - 
šode
->
i_sb
->
s_blocksize_b™s
);

4001 ià(!
	`·ge_has_bufãrs
(
·ge
))

4002 
	`ü—‹_em±y_bufãrs
(
·ge
, 
blocksize
, 0);

4005 
bh
 = 
	`·ge_bufãrs
(
·ge
);

4006 
pos
 = 
blocksize
;

4007 
off£t
 >ğ
pos
) {

4008 
bh
 = bh->
b_this_·ge
;

4009 
iblock
++;

4010 
pos
 +ğ
blocksize
;

4012 ià(
	`bufãr_ä“d
(
bh
)) {

4013 
	`BUFFER_TRACE
(
bh
, "freed: skip");

4014 
uÆock
;

4016 ià(!
	`bufãr_m­³d
(
bh
)) {

4017 
	`BUFFER_TRACE
(
bh
, "unmapped");

4018 
	`ext4_g‘_block
(
šode
, 
iblock
, 
bh
, 0);

4020 ià(!
	`bufãr_m­³d
(
bh
)) {

4021 
	`BUFFER_TRACE
(
bh
, "still unmapped");

4022 
uÆock
;

4027 ià(
	`PageU±od©e
(
·ge
))

4028 
	`£t_bufãr_u±od©e
(
bh
);

4030 ià(!
	`bufãr_u±od©e
(
bh
)) {

4031 
”r
 = -
EIO
;

4032 
	`Î_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

4033 
	`wa™_Ú_bufãr
(
bh
);

4035 ià(!
	`bufãr_u±od©e
(
bh
))

4036 
uÆock
;

4037 ià(
	`S_ISREG
(
šode
->
i_mode
è&& 
	`IS_ENCRYPTED
(inode)) {

4039 
	`BUG_ON
(!
	`fsüy±_has_’üy±iÚ_key
(
šode
));

4040 
	`WARN_ON_ONCE
(
	`fsüy±_deüy±_·geÿche_blocks
(

4041 
·ge
, 
blocksize
, 
	`bh_off£t
(
bh
)));

4044 ià(
	`ext4_should_jouº®_d©a
(
šode
)) {

4045 
	`BUFFER_TRACE
(
bh
, "get write‡ccess");

4046 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

4047 ià(
”r
)

4048 
uÆock
;

4050 
	`z”o_u£r
(
·ge
, 
off£t
, 
Ëngth
);

4051 
	`BUFFER_TRACE
(
bh
, "zeroedƒnd of block");

4053 ià(
	`ext4_should_jouº®_d©a
(
šode
)) {

4054 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

4056 
”r
 = 0;

4057 
	`m¬k_bufãr_dœty
(
bh
);

4058 ià(
	`ext4_should_Üd”_d©a
(
šode
))

4059 
”r
 = 
	`ext4_jbd2_šode_add_wr™e
(
hªdË
, 
šode
, 
äom
,

4060 
Ëngth
);

4063 
uÆock
:

4064 
	`uÆock_·ge
(
·ge
);

4065 
	`put_·ge
(
·ge
);

4066  
”r
;

4067 
	}
}

4076 
	$ext4_block_z”o_·ge_¿nge
(
hªdË_t
 *
hªdË
,

4077 
add»ss_¥aû
 *
m­pšg
, 
loff_t
 
äom
,†off_ˆ
Ëngth
)

4079 
šode
 *šodğ
m­pšg
->
ho¡
;

4080 
off£t
 = 
äom
 & (
PAGE_SIZE
-1);

4081 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

4082 
max
 = 
blocksize
 - (
off£t
 & (blocksize - 1));

4088 ià(
Ëngth
 > 
max
 ||†ength < 0)

4089 
Ëngth
 = 
max
;

4091 ià(
	`IS_DAX
(
šode
)) {

4092  
	`iom­_z”o_¿nge
(
šode
, 
äom
, 
Ëngth
, 
NULL
,

4093 &
ext4_iom­_İs
);

4095  
	`__ext4_block_z”o_·ge_¿nge
(
hªdË
, 
m­pšg
, 
äom
, 
Ëngth
);

4096 
	}
}

4104 
	$ext4_block_Œunÿ‹_·ge
(
hªdË_t
 *
hªdË
,

4105 
add»ss_¥aû
 *
m­pšg
, 
loff_t
 
äom
)

4107 
off£t
 = 
äom
 & (
PAGE_SIZE
-1);

4108 
Ëngth
;

4109 
blocksize
;

4110 
šode
 *šodğ
m­pšg
->
ho¡
;

4113 ià(
	`IS_ENCRYPTED
(
šode
è&& !
	`fsüy±_has_’üy±iÚ_key
(inode))

4116 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

4117 
Ëngth
 = 
blocksize
 - (
off£t
 & (blocksize - 1));

4119  
	`ext4_block_z”o_·ge_¿nge
(
hªdË
, 
m­pšg
, 
äom
, 
Ëngth
);

4120 
	}
}

4122 
	$ext4_z”o_·¹Ÿl_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

4123 
loff_t
 
l¡¬t
,†off_ˆ
Ëngth
)

4125 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

4126 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

4127 
·¹Ÿl_¡¬t
, 
·¹Ÿl_’d
;

4128 
ext4_fsblk_t
 
¡¬t
, 
’d
;

4129 
loff_t
 
by‹_’d
 = (
l¡¬t
 + 
Ëngth
 - 1);

4130 
”r
 = 0;

4132 
·¹Ÿl_¡¬t
 = 
l¡¬t
 & (
sb
->
s_blocksize
 - 1);

4133 
·¹Ÿl_’d
 = 
by‹_’d
 & (
sb
->
s_blocksize
 - 1);

4135 
¡¬t
 = 
l¡¬t
 >> 
sb
->
s_blocksize_b™s
;

4136 
’d
 = 
by‹_’d
 >> 
sb
->
s_blocksize_b™s
;

4139 ià(
¡¬t
 =ğ
’d
 &&

4140 (
·¹Ÿl_¡¬t
 || (
·¹Ÿl_’d
 !ğ
sb
->
s_blocksize
 - 1))) {

4141 
”r
 = 
	`ext4_block_z”o_·ge_¿nge
(
hªdË
, 
m­pšg
,

4142 
l¡¬t
, 
Ëngth
);

4143  
”r
;

4146 ià(
·¹Ÿl_¡¬t
) {

4147 
”r
 = 
	`ext4_block_z”o_·ge_¿nge
(
hªdË
, 
m­pšg
,

4148 
l¡¬t
, 
sb
->
s_blocksize
);

4149 ià(
”r
)

4150  
”r
;

4153 ià(
·¹Ÿl_’d
 !ğ
sb
->
s_blocksize
 - 1)

4154 
”r
 = 
	`ext4_block_z”o_·ge_¿nge
(
hªdË
, 
m­pšg
,

4155 
by‹_’d
 - 
·¹Ÿl_’d
,

4156 
·¹Ÿl_’d
 + 1);

4157  
”r
;

4158 
	}
}

4160 
	$ext4_ÿn_Œunÿ‹
(
šode
 *inode)

4162 ià(
	`S_ISREG
(
šode
->
i_mode
))

4164 ià(
	`S_ISDIR
(
šode
->
i_mode
))

4166 ià(
	`S_ISLNK
(
šode
->
i_mode
))

4167  !
	`ext4_šode_is_ç¡_symlšk
(
šode
);

4169 
	}
}

4177 
	$ext4_upd©e_disksize_befÜe_punch
(
šode
 *šode, 
loff_t
 
off£t
,

4178 
loff_t
 
Ën
)

4180 
hªdË_t
 *
hªdË
;

4181 
loff_t
 
size
 = 
	`i_size_»ad
(
šode
);

4183 
	`WARN_ON
(!
	`šode_is_locked
(
šode
));

4184 ià(
off£t
 > 
size
 || off£ˆ+ 
Ën
 < size)

4187 ià(
	`EXT4_I
(
šode
)->
i_disksize
 >ğ
size
)

4190 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MISC
, 1);

4191 ià(
	`IS_ERR
(
hªdË
))

4192  
	`PTR_ERR
(
hªdË
);

4193 
	`ext4_upd©e_i_disksize
(
šode
, 
size
);

4194 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

4195 
	`ext4_jouº®_¡İ
(
hªdË
);

4198 
	}
}

4200 
	$ext4_wa™_dax_·ge
(
ext4_šode_šfo
 *
ei
)

4202 
	`up_wr™e
(&
ei
->
i_mm­_£m
);

4203 
	`scheduË
();

4204 
	`down_wr™e
(&
ei
->
i_mm­_£m
);

4205 
	}
}

4207 
	$ext4_b»ak_Ïyouts
(
šode
 *inode)

4209 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

4210 
·ge
 *page;

4211 
”rÜ
;

4213 ià(
	`WARN_ON_ONCE
(!
	`rw£m_is_locked
(&
ei
->
i_mm­_£m
)))

4214  -
EINVAL
;

4217 
·ge
 = 
	`dax_Ïyout_busy_·ge
(
šode
->
i_m­pšg
);

4218 ià(!
·ge
)

4221 
”rÜ
 = 
	`___wa™_v¬_ev’t
(&
·ge
->
_»fcouÁ
,

4222 
	`©omic_»ad
(&
·ge
->
_»fcouÁ
) == 1,

4223 
TASK_INTERRUPTIBLE
, 0, 0,

4224 
	`ext4_wa™_dax_·ge
(
ei
));

4225 } 
”rÜ
 == 0);

4227  
”rÜ
;

4228 
	}
}

4241 
	$ext4_punch_hŞe
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ëngth
)

4243 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

4244 
ext4_lblk_t
 
fœ¡_block
, 
¡İ_block
;

4245 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

4246 
loff_t
 
fœ¡_block_off£t
, 
Ï¡_block_off£t
;

4247 
hªdË_t
 *
hªdË
;

4248 
üed™s
;

4249 
»t
 = 0;

4251 ià(!
	`S_ISREG
(
šode
->
i_mode
))

4252  -
EOPNOTSUPP
;

4254 
	`Œaû_ext4_punch_hŞe
(
šode
, 
off£t
, 
Ëngth
, 0);

4256 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

4257 ià(
	`ext4_has_šlše_d©a
(
šode
)) {

4258 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

4259 
»t
 = 
	`ext4_cÚv”t_šlše_d©a
(
šode
);

4260 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

4261 ià(
»t
)

4262  
»t
;

4269 ià(
	`m­pšg_gged
(
m­pšg
, 
PAGECACHE_TAG_DIRTY
)) {

4270 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
m­pšg
, 
off£t
,

4271 
off£t
 + 
Ëngth
 - 1);

4272 ià(
»t
)

4273  
»t
;

4276 
	`šode_lock
(
šode
);

4279 ià(
off£t
 >ğ
šode
->
i_size
)

4280 
out_mu‹x
;

4286 ià(
off£t
 + 
Ëngth
 > 
šode
->
i_size
) {

4287 
Ëngth
 = 
šode
->
i_size
 +

4288 
PAGE_SIZE
 - (
šode
->
i_size
 & (PAGE_SIZE - 1)) -

4289 
off£t
;

4292 ià(
off£t
 & (
sb
->
s_blocksize
 - 1) ||

4293 (
off£t
 + 
Ëngth
è& (
sb
->
s_blocksize
 - 1)) {

4298 
»t
 = 
	`ext4_šode_©ch_jšode
(
šode
);

4299 ià(
»t
 < 0)

4300 
out_mu‹x
;

4305 
	`šode_dio_wa™
(
šode
);

4311 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

4313 
»t
 = 
	`ext4_b»ak_Ïyouts
(
šode
);

4314 ià(
»t
)

4315 
out_dio
;

4317 
fœ¡_block_off£t
 = 
	`round_up
(
off£t
, 
sb
->
s_blocksize
);

4318 
Ï¡_block_off£t
 = 
	`round_down
((
off£t
 + 
Ëngth
), 
sb
->
s_blocksize
) - 1;

4321 ià(
Ï¡_block_off£t
 > 
fœ¡_block_off£t
) {

4322 
»t
 = 
	`ext4_upd©e_disksize_befÜe_punch
(
šode
, 
off£t
, 
Ëngth
);

4323 ià(
»t
)

4324 
out_dio
;

4325 
	`Œunÿ‹_·geÿche_¿nge
(
šode
, 
fœ¡_block_off£t
,

4326 
Ï¡_block_off£t
);

4329 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

4330 
üed™s
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

4332 
üed™s
 = 
	`ext4_blocks_fÜ_Œunÿ‹
(
šode
);

4333 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_TRUNCATE
, 
üed™s
);

4334 ià(
	`IS_ERR
(
hªdË
)) {

4335 
»t
 = 
	`PTR_ERR
(
hªdË
);

4336 
	`ext4_¡d_”rÜ
(
sb
, 
»t
);

4337 
out_dio
;

4340 
»t
 = 
	`ext4_z”o_·¹Ÿl_blocks
(
hªdË
, 
šode
, 
off£t
,

4341 
Ëngth
);

4342 ià(
»t
)

4343 
out_¡İ
;

4345 
fœ¡_block
 = (
off£t
 + 
sb
->
s_blocksize
 - 1) >>

4346 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

4347 
¡İ_block
 = (
off£t
 + 
Ëngth
è>> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

4350 ià(
¡İ_block
 > 
fœ¡_block
) {

4352 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

4353 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

4355 
»t
 = 
	`ext4_es_»move_ex‹Á
(
šode
, 
fœ¡_block
,

4356 
¡İ_block
 - 
fœ¡_block
);

4357 ià(
»t
) {

4358 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

4359 
out_¡İ
;

4362 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

4363 
»t
 = 
	`ext4_ext_»move_¥aû
(
šode
, 
fœ¡_block
,

4364 
¡İ_block
 - 1);

4366 
»t
 = 
	`ext4_šd_»move_¥aû
(
hªdË
, 
šode
, 
fœ¡_block
,

4367 
¡İ_block
);

4369 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

4371 ià(
	`IS_SYNC
(
šode
))

4372 
	`ext4_hªdË_sync
(
hªdË
);

4374 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

4375 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

4376 ià(
»t
 >= 0)

4377 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

4378 
out_¡İ
:

4379 
	`ext4_jouº®_¡İ
(
hªdË
);

4380 
out_dio
:

4381 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

4382 
out_mu‹x
:

4383 
	`šode_uÆock
(
šode
);

4384  
»t
;

4385 
	}
}

4387 
	$ext4_šode_©ch_jšode
(
šode
 *inode)

4389 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

4390 
jbd2_šode
 *
jšode
;

4392 ià(
ei
->
jšode
 || !
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
)

4395 
jšode
 = 
	`jbd2_®loc_šode
(
GFP_KERNEL
);

4396 
	`¥š_lock
(&
šode
->
i_lock
);

4397 ià(!
ei
->
jšode
) {

4398 ià(!
jšode
) {

4399 
	`¥š_uÆock
(&
šode
->
i_lock
);

4400  -
ENOMEM
;

4402 
ei
->
jšode
 = jinode;

4403 
	`jbd2_jouº®_š™_jbd_šode
(
ei
->
jšode
, 
šode
);

4404 
jšode
 = 
NULL
;

4406 
	`¥š_uÆock
(&
šode
->
i_lock
);

4407 ià(
	`uÆik–y
(
jšode
 !ğ
NULL
))

4408 
	`jbd2_ä“_šode
(
jšode
);

4410 
	}
}

4440 
	$ext4_Œunÿ‹
(
šode
 *inode)

4442 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

4443 
üed™s
;

4444 
”r
 = 0;

4445 
hªdË_t
 *
hªdË
;

4446 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

4453 ià(!(
šode
->
i_¡©e
 & (
I_NEW
|
I_FREEING
)))

4454 
	`WARN_ON
(!
	`šode_is_locked
(
šode
));

4455 
	`Œaû_ext4_Œunÿ‹_’‹r
(
šode
);

4457 ià(!
	`ext4_ÿn_Œunÿ‹
(
šode
))

4460 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_EOFBLOCKS
);

4462 ià(
šode
->
i_size
 =ğ0 && !
	`‹¡_İt
(šode->
i_sb
, 
NO_AUTO_DA_ALLOC
))

4463 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_DA_ALLOC_CLOSE
);

4465 ià(
	`ext4_has_šlše_d©a
(
šode
)) {

4466 
has_šlše
 = 1;

4468 
”r
 = 
	`ext4_šlše_d©a_Œunÿ‹
(
šode
, &
has_šlše
);

4469 ià(
”r
)

4470  
”r
;

4471 ià(
has_šlše
)

4476 ià(
šode
->
i_size
 & (šode->
i_sb
->
s_blocksize
 - 1)) {

4477 ià(
	`ext4_šode_©ch_jšode
(
šode
) < 0)

4481 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

4482 
üed™s
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

4484 
üed™s
 = 
	`ext4_blocks_fÜ_Œunÿ‹
(
šode
);

4486 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_TRUNCATE
, 
üed™s
);

4487 ià(
	`IS_ERR
(
hªdË
))

4488  
	`PTR_ERR
(
hªdË
);

4490 ià(
šode
->
i_size
 & (šode->
i_sb
->
s_blocksize
 - 1))

4491 
	`ext4_block_Œunÿ‹_·ge
(
hªdË
, 
m­pšg
, 
šode
->
i_size
);

4502 
”r
 = 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

4503 ià(
”r
)

4504 
out_¡İ
;

4506 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

4508 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

4510 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

4511 
”r
 = 
	`ext4_ext_Œunÿ‹
(
hªdË
, 
šode
);

4513 
	`ext4_šd_Œunÿ‹
(
hªdË
, 
šode
);

4515 
	`up_wr™e
(&
ei
->
i_d©a_£m
);

4516 ià(
”r
)

4517 
out_¡İ
;

4519 ià(
	`IS_SYNC
(
šode
))

4520 
	`ext4_hªdË_sync
(
hªdË
);

4522 
out_¡İ
:

4530 ià(
šode
->
i_Æšk
)

4531 
	`ext4_Üphª_d–
(
hªdË
, 
šode
);

4533 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

4534 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

4535 
	`ext4_jouº®_¡İ
(
hªdË
);

4537 
	`Œaû_ext4_Œunÿ‹_ex™
(
šode
);

4538  
”r
;

4539 
	}
}

4547 
	$__ext4_g‘_šode_loc
(
šode
 *inode,

4548 
ext4_oc
 *
oc
, 
š_mem
)

4550 
ext4_group_desc
 *
gdp
;

4551 
bufãr_h—d
 *
bh
;

4552 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

4553 
ext4_fsblk_t
 
block
;

4554 
blk_¶ug
 
¶ug
;

4555 
šodes_³r_block
, 
šode_off£t
;

4557 
oc
->
bh
 = 
NULL
;

4558 ià(
šode
->
i_šo
 < 
EXT4_ROOT_INO
 ||

4559 
šode
->
i_šo
 > 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_šodes_couÁ
))

4560  -
EFSCORRUPTED
;

4562 
oc
->
block_group
 = (
šode
->
i_šo
 - 1è/ 
	`EXT4_INODES_PER_GROUP
(
sb
);

4563 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
oc
->
block_group
, 
NULL
);

4564 ià(!
gdp
)

4565  -
EIO
;

4570 
šodes_³r_block
 = 
	`EXT4_SB
(
sb
)->
s_šodes_³r_block
;

4571 
šode_off£t
 = ((
šode
->
i_šo
 - 1) %

4572 
	`EXT4_INODES_PER_GROUP
(
sb
));

4573 
block
 = 
	`ext4_šode_bË
(
sb
, 
gdp
è+ (
šode_off£t
 / 
šodes_³r_block
);

4574 
oc
->
off£t
 = (
šode_off£t
 % 
šodes_³r_block
è* 
	`EXT4_INODE_SIZE
(
sb
);

4576 
bh
 = 
	`sb_g‘blk
(
sb
, 
block
);

4577 ià(
	`uÆik–y
(!
bh
))

4578  -
ENOMEM
;

4579 ià(!
	`bufãr_u±od©e
(
bh
)) {

4580 
	`lock_bufãr
(
bh
);

4588 ià(
	`bufãr_wr™e_io_”rÜ
(
bh
è&& !
	`bufãr_u±od©e
(bh))

4589 
	`£t_bufãr_u±od©e
(
bh
);

4591 ià(
	`bufãr_u±od©e
(
bh
)) {

4593 
	`uÆock_bufãr
(
bh
);

4594 
has_bufãr
;

4602 ià(
š_mem
) {

4603 
bufãr_h—d
 *
b™m­_bh
;

4604 
i
, 
¡¬t
;

4606 
¡¬t
 = 
šode_off£t
 & ~(
šodes_³r_block
 - 1);

4609 
b™m­_bh
 = 
	`sb_g‘blk
(
sb
, 
	`ext4_šode_b™m­
(sb, 
gdp
));

4610 ià(
	`uÆik–y
(!
b™m­_bh
))

4611 
make_io
;

4618 ià(!
	`bufãr_u±od©e
(
b™m­_bh
)) {

4619 
	`b»l£
(
b™m­_bh
);

4620 
make_io
;

4622 
i
 = 
¡¬t
; i < s¹ + 
šodes_³r_block
; i++) {

4623 ià(
i
 =ğ
šode_off£t
)

4625 ià(
	`ext4_‹¡_b™
(
i
, 
b™m­_bh
->
b_d©a
))

4628 
	`b»l£
(
b™m­_bh
);

4629 ià(
i
 =ğ
¡¬t
 + 
šodes_³r_block
) {

4631 
	`mem£t
(
bh
->
b_d©a
, 0, bh->
b_size
);

4632 
	`£t_bufãr_u±od©e
(
bh
);

4633 
	`uÆock_bufãr
(
bh
);

4634 
has_bufãr
;

4638 
make_io
:

4643 
	`blk_¡¬t_¶ug
(&
¶ug
);

4644 ià(
	`EXT4_SB
(
sb
)->
s_šode_»adah—d_blks
) {

4645 
ext4_fsblk_t
 
b
, 
’d
, 
bË
;

4646 
num
;

4647 
__u32
 
¿_blks
 = 
	`EXT4_SB
(
sb
)->
s_šode_»adah—d_blks
;

4649 
bË
 = 
	`ext4_šode_bË
(
sb
, 
gdp
);

4651 
b
 = 
block
 & ~((
ext4_fsblk_t
è
¿_blks
 - 1);

4652 ià(
bË
 > 
b
)

4653 
b
 = 
bË
;

4654 
’d
 = 
b
 + 
¿_blks
;

4655 
num
 = 
	`EXT4_INODES_PER_GROUP
(
sb
);

4656 ià(
	`ext4_has_group_desc_csum
(
sb
))

4657 
num
 -ğ
	`ext4_™abË_unu£d_couÁ
(
sb
, 
gdp
);

4658 
bË
 +ğ
num
 / 
šodes_³r_block
;

4659 ià(
’d
 > 
bË
)

4660 
’d
 = 
bË
;

4661 
b
 <ğ
’d
)

4662 
	`sb_b»adah—d
(
sb
, 
b
++);

4670 
	`Œaû_ext4_lßd_šode
(
šode
);

4671 
	`g‘_bh
(
bh
);

4672 
bh
->
b_’d_io
 = 
’d_bufãr_»ad_sync
;

4673 
	`subm™_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

4674 
	`blk_fšish_¶ug
(&
¶ug
);

4675 
	`wa™_Ú_bufãr
(
bh
);

4676 ià(!
	`bufãr_u±od©e
(
bh
)) {

4677 
	`EXT4_ERROR_INODE_BLOCK
(
šode
, 
block
,

4679 
	`b»l£
(
bh
);

4680  -
EIO
;

4683 
has_bufãr
:

4684 
oc
->
bh
 = bh;

4686 
	}
}

4688 
	$ext4_g‘_šode_loc
(
šode
 *šode, 
ext4_oc
 *
oc
)

4691  
	`__ext4_g‘_šode_loc
(
šode
, 
oc
,

4692 !
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
));

4693 
	}
}

4695 
boŞ
 
	$ext4_should_u£_dax
(
šode
 *inode)

4697 ià(!
	`‹¡_İt
(
šode
->
i_sb
, 
DAX
))

4698  
çl£
;

4699 ià(!
	`S_ISREG
(
šode
->
i_mode
))

4700  
çl£
;

4701 ià(
	`ext4_should_jouº®_d©a
(
šode
))

4702  
çl£
;

4703 ià(
	`ext4_has_šlše_d©a
(
šode
))

4704  
çl£
;

4705 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_ENCRYPT
))

4706  
çl£
;

4707 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_VERITY
))

4708  
çl£
;

4709  
Œue
;

4710 
	}
}

4712 
	$ext4_£t_šode_æags
(
šode
 *inode)

4714 
æags
 = 
	`EXT4_I
(
šode
)->
i_æags
;

4715 
Ãw_æ
 = 0;

4717 ià(
æags
 & 
EXT4_SYNC_FL
)

4718 
Ãw_æ
 |ğ
S_SYNC
;

4719 ià(
æags
 & 
EXT4_APPEND_FL
)

4720 
Ãw_æ
 |ğ
S_APPEND
;

4721 ià(
æags
 & 
EXT4_IMMUTABLE_FL
)

4722 
Ãw_æ
 |ğ
S_IMMUTABLE
;

4723 ià(
æags
 & 
EXT4_NOATIME_FL
)

4724 
Ãw_æ
 |ğ
S_NOATIME
;

4725 ià(
æags
 & 
EXT4_DIRSYNC_FL
)

4726 
Ãw_æ
 |ğ
S_DIRSYNC
;

4727 ià(
	`ext4_should_u£_dax
(
šode
))

4728 
Ãw_æ
 |ğ
S_DAX
;

4729 ià(
æags
 & 
EXT4_ENCRYPT_FL
)

4730 
Ãw_æ
 |ğ
S_ENCRYPTED
;

4731 ià(
æags
 & 
EXT4_CASEFOLD_FL
)

4732 
Ãw_æ
 |ğ
S_CASEFOLD
;

4733 ià(
æags
 & 
EXT4_VERITY_FL
)

4734 
Ãw_æ
 |ğ
S_VERITY
;

4735 
	`šode_£t_æags
(
šode
, 
Ãw_æ
,

4736 
S_SYNC
|
S_APPEND
|
S_IMMUTABLE
|
S_NOATIME
|
S_DIRSYNC
|
S_DAX
|

4737 
S_ENCRYPTED
|
S_CASEFOLD
|
S_VERITY
);

4738 
	}
}

4740 
blkút_t
 
	$ext4_šode_blocks
(
ext4_šode
 *
¿w_šode
,

4741 
ext4_šode_šfo
 *
ei
)

4743 
blkút_t
 
i_blocks
 ;

4744 
šode
 *šodğ&(
ei
->
vfs_šode
);

4745 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

4747 ià(
	`ext4_has_ã©u»_huge_fe
(
sb
)) {

4749 
i_blocks
 = ((
u64
)
	`Ë16_to_ıu
(
¿w_šode
->
i_blocks_high
)) << 32 |

4750 
	`Ë32_to_ıu
(
¿w_šode
->
i_blocks_lo
);

4751 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_HUGE_FILE
)) {

4753  
i_blocks
 << (
šode
->
i_blkb™s
 - 9);

4755  
i_blocks
;

4758  
	`Ë32_to_ıu
(
¿w_šode
->
i_blocks_lo
);

4760 
	}
}

4762 
šlše
 
	$ext4_ig‘_exŒa_šode
(
šode
 *inode,

4763 
ext4_šode
 *
¿w_šode
,

4764 
ext4_šode_šfo
 *
ei
)

4766 
__Ë32
 *
magic
 = (*)
¿w_šode
 +

4767 
EXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exŒa_isize
;

4769 ià(
EXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exŒa_isize
 + (
__Ë32
) <=

4770 
	`EXT4_INODE_SIZE
(
šode
->
i_sb
) &&

4771 *
magic
 =ğ
	`ıu_to_Ë32
(
EXT4_XATTR_MAGIC
)) {

4772 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
);

4773  
	`ext4_fšd_šlše_d©a_nŞock
(
šode
);

4775 
	`EXT4_I
(
šode
)->
i_šlše_off
 = 0;

4777 
	}
}

4779 
	$ext4_g‘_´ojid
(
šode
 *šode, 
k´ojid_t
 *
´ojid
)

4781 ià(!
	`ext4_has_ã©u»_´ojeù
(
šode
->
i_sb
))

4782  -
EOPNOTSUPP
;

4783 *
´ojid
 = 
	`EXT4_I
(
šode
)->
i_´ojid
;

4785 
	}
}

4792 
šlše
 
	$ext4_šode_£t_iv”siÚ_qu”›d
(
šode
 *šode, 
u64
 
v®
)

4794 ià(
	`uÆik–y
(
	`EXT4_I
(
šode
)->
i_æags
 & 
EXT4_EA_INODE_FL
))

4795 
	`šode_£t_iv”siÚ_¿w
(
šode
, 
v®
);

4797 
	`šode_£t_iv”siÚ_qu”›d
(
šode
, 
v®
);

4798 
	}
}

4799 
šlše
 
u64
 
	$ext4_šode_³ek_iv”siÚ
(cÚ¡ 
šode
 *inode)

4801 ià(
	`uÆik–y
(
	`EXT4_I
(
šode
)->
i_æags
 & 
EXT4_EA_INODE_FL
))

4802  
	`šode_³ek_iv”siÚ_¿w
(
šode
);

4804  
	`šode_³ek_iv”siÚ
(
šode
);

4805 
	}
}

4807 
šode
 *
	$__ext4_ig‘
(
su³r_block
 *
sb
, 
šo
,

4808 
ext4_ig‘_æags
 
æags
, cÚ¡ *
funùiÚ
,

4809 
lše
)

4811 
ext4_oc
 
oc
;

4812 
ext4_šode
 *
¿w_šode
;

4813 
ext4_šode_šfo
 *
ei
;

4814 
šode
 *inode;

4815 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

4816 
»t
;

4817 
loff_t
 
size
;

4818 
block
;

4819 
uid_t
 
i_uid
;

4820 
gid_t
 
i_gid
;

4821 
´ojid_t
 
i_´ojid
;

4823 ià((!(
æags
 & 
EXT4_IGET_SPECIAL
) &&

4824 (
šo
 < 
	`EXT4_FIRST_INO
(
sb
è&& inØ!ğ
EXT4_ROOT_INO
)) ||

4825 (
šo
 < 
EXT4_ROOT_INO
) ||

4826 (
šo
 > 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_šodes_couÁ
))) {

4827 ià(
æags
 & 
EXT4_IGET_HANDLE
)

4828  
	`ERR_PTR
(-
ESTALE
);

4829 
	`__ext4_”rÜ
(
sb
, 
funùiÚ
, 
lše
,

4831 
šo
, 
cu¼’t
->
comm
);

4832  
	`ERR_PTR
(-
EFSCORRUPTED
);

4835 
šode
 = 
	`ig‘_locked
(
sb
, 
šo
);

4836 ià(!
šode
)

4837  
	`ERR_PTR
(-
ENOMEM
);

4838 ià(!(
šode
->
i_¡©e
 & 
I_NEW
))

4839  
šode
;

4841 
ei
 = 
	`EXT4_I
(
šode
);

4842 
oc
.
bh
 = 
NULL
;

4844 
»t
 = 
	`__ext4_g‘_šode_loc
(
šode
, &
oc
, 0);

4845 ià(
»t
 < 0)

4846 
bad_šode
;

4847 
¿w_šode
 = 
	`ext4_¿w_šode
(&
oc
);

4849 ià((
šo
 =ğ
EXT4_ROOT_INO
è&& (
¿w_šode
->
i_lšks_couÁ
 == 0)) {

4850 
	`ext4_”rÜ_šode
(
šode
, 
funùiÚ
, 
lše
, 0,

4852 
»t
 = -
EFSCORRUPTED
;

4853 
bad_šode
;

4856 ià((
æags
 & 
EXT4_IGET_HANDLE
) &&

4857 (
¿w_šode
->
i_lšks_couÁ
 =ğ0è&& (¿w_šode->
i_mode
 == 0)) {

4858 
»t
 = -
ESTALE
;

4859 
bad_šode
;

4862 ià(
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
) {

4863 
ei
->
i_exŒa_isize
 = 
	`Ë16_to_ıu
(
¿w_šode
->i_extra_isize);

4864 ià(
EXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exŒa_isize
 >

4865 
	`EXT4_INODE_SIZE
(
šode
->
i_sb
) ||

4866 (
ei
->
i_exŒa_isize
 & 3)) {

4867 
	`ext4_”rÜ_šode
(
šode
, 
funùiÚ
, 
lše
, 0,

4870 
ei
->
i_exŒa_isize
,

4871 
	`EXT4_INODE_SIZE
(
šode
->
i_sb
));

4872 
»t
 = -
EFSCORRUPTED
;

4873 
bad_šode
;

4876 
ei
->
i_exŒa_isize
 = 0;

4879 ià(
	`ext4_has_m‘ad©a_csum
(
sb
)) {

4880 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

4881 
__u32
 
csum
;

4882 
__Ë32
 
šum
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

4883 
__Ë32
 
g’
 = 
¿w_šode
->
i_g’”©iÚ
;

4884 
csum
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
šum
,

4885 (
šum
));

4886 
ei
->
i_csum_£ed
 = 
	`ext4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
g’
,

4887 (
g’
));

4890 ià(!
	`ext4_šode_csum_v”ify
(
šode
, 
¿w_šode
, 
ei
)) {

4891 
	`ext4_”rÜ_šode
(
šode
, 
funùiÚ
, 
lše
, 0,

4893 
»t
 = -
EFSBADCRC
;

4894 
bad_šode
;

4897 
šode
->
i_mode
 = 
	`Ë16_to_ıu
(
¿w_šode
->i_mode);

4898 
i_uid
 = (
uid_t
)
	`Ë16_to_ıu
(
¿w_šode
->
i_uid_low
);

4899 
i_gid
 = (
gid_t
)
	`Ë16_to_ıu
(
¿w_šode
->
i_gid_low
);

4900 ià(
	`ext4_has_ã©u»_´ojeù
(
sb
) &&

4901 
	`EXT4_INODE_SIZE
(
sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
 &&

4902 
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ei
, 
i_´ojid
))

4903 
i_´ojid
 = (
´ojid_t
)
	`Ë32_to_ıu
(
¿w_šode
->i_projid);

4905 
i_´ojid
 = 
EXT4_DEF_PROJID
;

4907 ià(!(
	`‹¡_İt
(
šode
->
i_sb
, 
NO_UID32
))) {

4908 
i_uid
 |ğ
	`Ë16_to_ıu
(
¿w_šode
->
i_uid_high
) << 16;

4909 
i_gid
 |ğ
	`Ë16_to_ıu
(
¿w_šode
->
i_gid_high
) << 16;

4911 
	`i_uid_wr™e
(
šode
, 
i_uid
);

4912 
	`i_gid_wr™e
(
šode
, 
i_gid
);

4913 
ei
->
i_´ojid
 = 
	`make_k´ojid
(&
š™_u£r_ns
, i_projid);

4914 
	`£t_Æšk
(
šode
, 
	`Ë16_to_ıu
(
¿w_šode
->
i_lšks_couÁ
));

4916 
	`ext4_ş—r_¡©e_æags
(
ei
);

4917 
ei
->
i_šlše_off
 = 0;

4918 
ei
->
i_dœ_¡¬t_lookup
 = 0;

4919 
ei
->
i_dtime
 = 
	`Ë32_to_ıu
(
¿w_šode
->i_dtime);

4925 ià(
šode
->
i_Æšk
 == 0) {

4926 ià((
šode
->
i_mode
 == 0 ||

4927 !(
	`EXT4_SB
(
šode
->
i_sb
)->
s_mouÁ_¡©e
 & 
EXT4_ORPHAN_FS
)) &&

4928 
šo
 !ğ
EXT4_BOOT_LOADER_INO
) {

4930 
»t
 = -
ESTALE
;

4931 
bad_šode
;

4940 
ei
->
i_æags
 = 
	`Ë32_to_ıu
(
¿w_šode
->i_flags);

4941 
	`ext4_£t_šode_æags
(
šode
);

4942 
šode
->
i_blocks
 = 
	`ext4_šode_blocks
(
¿w_šode
, 
ei
);

4943 
ei
->
i_fe_aş
 = 
	`Ë32_to_ıu
(
¿w_šode
->
i_fe_aş_lo
);

4944 ià(
	`ext4_has_ã©u»_64b™
(
sb
))

4945 
ei
->
i_fe_aş
 |=

4946 ((
__u64
)
	`Ë16_to_ıu
(
¿w_šode
->
i_fe_aş_high
)) << 32;

4947 
šode
->
i_size
 = 
	`ext4_isize
(
sb
, 
¿w_šode
);

4948 ià((
size
 = 
	`i_size_»ad
(
šode
)) < 0) {

4949 
	`ext4_”rÜ_šode
(
šode
, 
funùiÚ
, 
lše
, 0,

4950 "ig‘: bad i_sizv®ue: %Îd", 
size
);

4951 
»t
 = -
EFSCORRUPTED
;

4952 
bad_šode
;

4954 
ei
->
i_disksize
 = 
šode
->
i_size
;

4955 #ifdeà
CONFIG_QUOTA


4956 
ei
->
i_»£rved_quÙa
 = 0;

4958 
šode
->
i_g’”©iÚ
 = 
	`Ë32_to_ıu
(
¿w_šode
->i_generation);

4959 
ei
->
i_block_group
 = 
oc
.
block_group
;

4960 
ei
->
i_Ï¡_®loc_group
 = ~0;

4965 
block
 = 0; block < 
EXT4_N_BLOCKS
; block++)

4966 
ei
->
i_d©a
[
block
] = 
¿w_šode
->
i_block
[block];

4967 
	`INIT_LIST_HEAD
(&
ei
->
i_Üphª
);

4976 ià(
jouº®
) {

4977 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

4978 
tid_t
 
tid
;

4980 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

4981 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
)

4982 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

4984 
Œª§ùiÚ
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

4985 ià(
Œª§ùiÚ
)

4986 
tid
 = 
Œª§ùiÚ
->
t_tid
;

4988 
tid
 = 
jouº®
->
j_comm™_£qu’û
;

4989 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

4990 
ei
->
i_sync_tid
 = 
tid
;

4991 
ei
->
i_d©async_tid
 = 
tid
;

4994 ià(
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
) {

4995 ià(
ei
->
i_exŒa_isize
 == 0) {

4997 
	`BUILD_BUG_ON
((
ext4_šode
) & 3);

4998 
ei
->
i_exŒa_isize
 = (
ext4_šode
) -

4999 
EXT4_GOOD_OLD_INODE_SIZE
;

5001 
»t
 = 
	`ext4_ig‘_exŒa_šode
(
šode
, 
¿w_šode
, 
ei
);

5002 ià(
»t
)

5003 
bad_šode
;

5007 
	`EXT4_INODE_GET_XTIME
(
i_ùime
, 
šode
, 
¿w_šode
);

5008 
	`EXT4_INODE_GET_XTIME
(
i_mtime
, 
šode
, 
¿w_šode
);

5009 
	`EXT4_INODE_GET_XTIME
(
i_©ime
, 
šode
, 
¿w_šode
);

5010 
	`EXT4_EINODE_GET_XTIME
(
i_ütime
, 
ei
, 
¿w_šode
);

5012 ià(
	`lik–y
(!
	`‹¡_İt2
(
šode
->
i_sb
, 
HURD_COMPAT
))) {

5013 
u64
 
iv”s
 = 
	`Ë32_to_ıu
(
¿w_šode
->
i_disk_v”siÚ
);

5015 ià(
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
) {

5016 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ei
, 
i_v”siÚ_hi
))

5017 
iv”s
 |=

5018 (
__u64
)(
	`Ë32_to_ıu
(
¿w_šode
->
i_v”siÚ_hi
)) << 32;

5020 
	`ext4_šode_£t_iv”siÚ_qu”›d
(
šode
, 
iv”s
);

5023 
»t
 = 0;

5024 ià(
ei
->
i_fe_aş
 &&

5025 !
	`ext4_d©a_block_v®id
(
	`EXT4_SB
(
sb
), 
ei
->
i_fe_aş
, 1)) {

5026 
	`ext4_”rÜ_šode
(
šode
, 
funùiÚ
, 
lše
, 0,

5028 
ei
->
i_fe_aş
);

5029 
»t
 = -
EFSCORRUPTED
;

5030 
bad_šode
;

5031 } ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

5033 ià(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

5034 (
	`S_ISLNK
(
šode
->
i_mode
) &&

5035 !
	`ext4_šode_is_ç¡_symlšk
(
šode
))) {

5036 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

5037 
»t
 = 
	`ext4_ext_check_šode
(
šode
);

5039 
»t
 = 
	`ext4_šd_check_šode
(
šode
);

5042 ià(
»t
)

5043 
bad_šode
;

5045 ià(
	`S_ISREG
(
šode
->
i_mode
)) {

5046 
šode
->
i_İ
 = &
ext4_fe_šode_İ”©iÚs
;

5047 
šode
->
i_fİ
 = &
ext4_fe_İ”©iÚs
;

5048 
	`ext4_£t_aİs
(
šode
);

5049 } ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

5050 
šode
->
i_İ
 = &
ext4_dœ_šode_İ”©iÚs
;

5051 
šode
->
i_fİ
 = &
ext4_dœ_İ”©iÚs
;

5052 } ià(
	`S_ISLNK
(
šode
->
i_mode
)) {

5054 ià(
	`IS_APPEND
(
šode
è|| 
	`IS_IMMUTABLE
(inode)) {

5055 
	`ext4_”rÜ_šode
(
šode
, 
funùiÚ
, 
lše
, 0,

5058 
»t
 = -
EFSCORRUPTED
;

5059 
bad_šode
;

5061 ià(
	`IS_ENCRYPTED
(
šode
)) {

5062 
šode
->
i_İ
 = &
ext4_’üy±ed_symlšk_šode_İ”©iÚs
;

5063 
	`ext4_£t_aİs
(
šode
);

5064 } ià(
	`ext4_šode_is_ç¡_symlšk
(
šode
)) {

5065 
šode
->
i_lšk
 = (*)
ei
->
i_d©a
;

5066 
šode
->
i_İ
 = &
ext4_ç¡_symlšk_šode_İ”©iÚs
;

5067 
	`nd_‹rmš©e_lšk
(
ei
->
i_d©a
, 
šode
->
i_size
,

5068 (
ei
->
i_d©a
) - 1);

5070 
šode
->
i_İ
 = &
ext4_symlšk_šode_İ”©iÚs
;

5071 
	`ext4_£t_aİs
(
šode
);

5073 
	`šode_nohighmem
(
šode
);

5074 } ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode) ||

5075 
	`S_ISFIFO
(
šode
->
i_mode
è|| 
	`S_ISSOCK
(inode->i_mode)) {

5076 
šode
->
i_İ
 = &
ext4_¥ecŸl_šode_İ”©iÚs
;

5077 ià(
¿w_šode
->
i_block
[0])

5078 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
,

5079 
	`Şd_decode_dev
(
	`Ë32_to_ıu
(
¿w_šode
->
i_block
[0])));

5081 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
,

5082 
	`Ãw_decode_dev
(
	`Ë32_to_ıu
(
¿w_šode
->
i_block
[1])));

5083 } ià(
šo
 =ğ
EXT4_BOOT_LOADER_INO
) {

5084 
	`make_bad_šode
(
šode
);

5086 
»t
 = -
EFSCORRUPTED
;

5087 
	`ext4_”rÜ_šode
(
šode
, 
funùiÚ
, 
lše
, 0,

5088 "ig‘: bogu i_mod(%o)", 
šode
->
i_mode
);

5089 
bad_šode
;

5091 ià(
	`IS_CASEFOLDED
(
šode
è&& !
	`ext4_has_ã©u»_ÿ£fŞd
(šode->
i_sb
))

5092 
	`ext4_”rÜ_šode
(
šode
, 
funùiÚ
, 
lše
, 0,

5094 
	`b»l£
(
oc
.
bh
);

5096 
	`uÆock_Ãw_šode
(
šode
);

5097  
šode
;

5099 
bad_šode
:

5100 
	`b»l£
(
oc
.
bh
);

5101 
	`ig‘_çed
(
šode
);

5102  
	`ERR_PTR
(
»t
);

5103 
	}
}

5105 
	$ext4_šode_blocks_£t
(
hªdË_t
 *
hªdË
,

5106 
ext4_šode
 *
¿w_šode
,

5107 
ext4_šode_šfo
 *
ei
)

5109 
šode
 *šodğ&(
ei
->
vfs_šode
);

5110 
u64
 
i_blocks
 = 
šode
->i_blocks;

5111 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

5113 ià(
i_blocks
 <= ~0U) {

5118 
¿w_šode
->
i_blocks_lo
 = 
	`ıu_to_Ë32
(
i_blocks
);

5119 
¿w_šode
->
i_blocks_high
 = 0;

5120 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_HUGE_FILE
);

5123 ià(!
	`ext4_has_ã©u»_huge_fe
(
sb
))

5124  -
EFBIG
;

5126 ià(
i_blocks
 <= 0xffffffffffffULL) {

5131 
¿w_šode
->
i_blocks_lo
 = 
	`ıu_to_Ë32
(
i_blocks
);

5132 
¿w_šode
->
i_blocks_high
 = 
	`ıu_to_Ë16
(
i_blocks
 >> 32);

5133 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_HUGE_FILE
);

5135 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_HUGE_FILE
);

5137 
i_blocks
 = i_block >> (
šode
->
i_blkb™s
 - 9);

5138 
¿w_šode
->
i_blocks_lo
 = 
	`ıu_to_Ë32
(
i_blocks
);

5139 
¿w_šode
->
i_blocks_high
 = 
	`ıu_to_Ë16
(
i_blocks
 >> 32);

5142 
	}
}

5144 
	sÙh”_šode
 {

5145 
	mÜig_šo
;

5146 
ext4_šode
 *
	m¿w_šode
;

5149 
	$Ùh”_šode_m©ch
(
šode
 * inode, 
šo
,

5150 *
d©a
)

5152 
Ùh”_šode
 *
oi
 = (Ùh”_šod*è
d©a
;

5154 ià((
šode
->
i_šo
 !ğ
šo
) ||

5155 (
šode
->
i_¡©e
 & (
I_FREEING
 | 
I_WILL_FREE
 | 
I_NEW
 |

5156 
I_DIRTY_INODE
)) ||

5157 ((
šode
->
i_¡©e
 & 
I_DIRTY_TIME
) == 0))

5159 
	`¥š_lock
(&
šode
->
i_lock
);

5160 ià(((
šode
->
i_¡©e
 & (
I_FREEING
 | 
I_WILL_FREE
 | 
I_NEW
 |

5161 
I_DIRTY_INODE
)) == 0) &&

5162 (
šode
->
i_¡©e
 & 
I_DIRTY_TIME
)) {

5163 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

5165 
šode
->
i_¡©e
 &ğ~(
I_DIRTY_TIME
 | 
I_DIRTY_TIME_EXPIRED
);

5166 
	`¥š_uÆock
(&
šode
->
i_lock
);

5168 
	`¥š_lock
(&
ei
->
i_¿w_lock
);

5169 
	`EXT4_INODE_SET_XTIME
(
i_ùime
, 
šode
, 
oi
->
¿w_šode
);

5170 
	`EXT4_INODE_SET_XTIME
(
i_mtime
, 
šode
, 
oi
->
¿w_šode
);

5171 
	`EXT4_INODE_SET_XTIME
(
i_©ime
, 
šode
, 
oi
->
¿w_šode
);

5172 
	`ext4_šode_csum_£t
(
šode
, 
oi
->
¿w_šode
, 
ei
);

5173 
	`¥š_uÆock
(&
ei
->
i_¿w_lock
);

5174 
	`Œaû_ext4_Ùh”_šode_upd©e_time
(
šode
, 
oi
->
Üig_šo
);

5177 
	`¥š_uÆock
(&
šode
->
i_lock
);

5179 
	}
}

5185 
	$ext4_upd©e_Ùh”_šodes_time
(
su³r_block
 *
sb
,

5186 
Üig_šo
, *
buf
)

5188 
Ùh”_šode
 
oi
;

5189 
šo
;

5190 
i
, 
šodes_³r_block
 = 
	`EXT4_SB
(
sb
)->
s_šodes_³r_block
;

5191 
šode_size
 = 
	`EXT4_INODE_SIZE
(
sb
);

5193 
oi
.
Üig_šo
 = orig_ino;

5199 
šo
 = ((
Üig_šo
 - 1è& ~(
šodes_³r_block
 - 1)) + 1;

5200 
i
 = 0; i < 
šodes_³r_block
; i++, 
šo
++, 
buf
 +ğ
šode_size
) {

5201 ià(
šo
 =ğ
Üig_šo
)

5203 
oi
.
¿w_šode
 = (
ext4_šode
 *è
buf
;

5204 (è
	`fšd_šode_nowa™
(
sb
, 
šo
, 
Ùh”_šode_m©ch
, &
oi
);

5206 
	}
}

5215 
	$ext4_do_upd©e_šode
(
hªdË_t
 *
hªdË
,

5216 
šode
 *inode,

5217 
ext4_oc
 *
oc
)

5219 
ext4_šode
 *
¿w_šode
 = 
	`ext4_¿w_šode
(
oc
);

5220 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

5221 
bufãr_h—d
 *
bh
 = 
oc
->bh;

5222 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

5223 
”r
 = 0, 
rc
, 
block
;

5224 
Ãed_d©async
 = 0, 
£t_Ïrge_fe
 = 0;

5225 
uid_t
 
i_uid
;

5226 
gid_t
 
i_gid
;

5227 
´ojid_t
 
i_´ojid
;

5229 
	`¥š_lock
(&
ei
->
i_¿w_lock
);

5233 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NEW
))

5234 
	`mem£t
(
¿w_šode
, 0, 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
);

5236 
¿w_šode
->
i_mode
 = 
	`ıu_to_Ë16
(
šode
->i_mode);

5237 
i_uid
 = 
	`i_uid_»ad
(
šode
);

5238 
i_gid
 = 
	`i_gid_»ad
(
šode
);

5239 
i_´ojid
 = 
	`äom_k´ojid
(&
š™_u£r_ns
, 
ei
->i_projid);

5240 ià(!(
	`‹¡_İt
(
šode
->
i_sb
, 
NO_UID32
))) {

5241 
¿w_šode
->
i_uid_low
 = 
	`ıu_to_Ë16
(
	`low_16_b™s
(
i_uid
));

5242 
¿w_šode
->
i_gid_low
 = 
	`ıu_to_Ë16
(
	`low_16_b™s
(
i_gid
));

5247 ià(
ei
->
i_dtime
 && 
	`li¡_em±y
(&ei->
i_Üphª
)) {

5248 
¿w_šode
->
i_uid_high
 = 0;

5249 
¿w_šode
->
i_gid_high
 = 0;

5251 
¿w_šode
->
i_uid_high
 =

5252 
	`ıu_to_Ë16
(
	`high_16_b™s
(
i_uid
));

5253 
¿w_šode
->
i_gid_high
 =

5254 
	`ıu_to_Ë16
(
	`high_16_b™s
(
i_gid
));

5257 
¿w_šode
->
i_uid_low
 = 
	`ıu_to_Ë16
(
	`fs_high2lowuid
(
i_uid
));

5258 
¿w_šode
->
i_gid_low
 = 
	`ıu_to_Ë16
(
	`fs_high2lowgid
(
i_gid
));

5259 
¿w_šode
->
i_uid_high
 = 0;

5260 
¿w_šode
->
i_gid_high
 = 0;

5262 
¿w_šode
->
i_lšks_couÁ
 = 
	`ıu_to_Ë16
(
šode
->
i_Æšk
);

5264 
	`EXT4_INODE_SET_XTIME
(
i_ùime
, 
šode
, 
¿w_šode
);

5265 
	`EXT4_INODE_SET_XTIME
(
i_mtime
, 
šode
, 
¿w_šode
);

5266 
	`EXT4_INODE_SET_XTIME
(
i_©ime
, 
šode
, 
¿w_šode
);

5267 
	`EXT4_EINODE_SET_XTIME
(
i_ütime
, 
ei
, 
¿w_šode
);

5269 
”r
 = 
	`ext4_šode_blocks_£t
(
hªdË
, 
¿w_šode
, 
ei
);

5270 ià(
”r
) {

5271 
	`¥š_uÆock
(&
ei
->
i_¿w_lock
);

5272 
out_b»l£
;

5274 
¿w_šode
->
i_dtime
 = 
	`ıu_to_Ë32
(
ei
->i_dtime);

5275 
¿w_šode
->
i_æags
 = 
	`ıu_to_Ë32
(
ei
->i_flags & 0xFFFFFFFF);

5276 ià(
	`lik–y
(!
	`‹¡_İt2
(
šode
->
i_sb
, 
HURD_COMPAT
)))

5277 
¿w_šode
->
i_fe_aş_high
 =

5278 
	`ıu_to_Ë16
(
ei
->
i_fe_aş
 >> 32);

5279 
¿w_šode
->
i_fe_aş_lo
 = 
	`ıu_to_Ë32
(
ei
->
i_fe_aş
);

5280 ià(
ei
->
i_disksize
 !ğ
	`ext4_isize
(
šode
->
i_sb
, 
¿w_šode
)) {

5281 
	`ext4_isize_£t
(
¿w_šode
, 
ei
->
i_disksize
);

5282 
Ãed_d©async
 = 1;

5284 ià(
ei
->
i_disksize
 > 0x7fffffffULL) {

5285 ià(!
	`ext4_has_ã©u»_Ïrge_fe
(
sb
) ||

5286 
	`EXT4_SB
(
sb
)->
s_es
->
s_»v_Ëv–
 ==

5287 
	`ıu_to_Ë32
(
EXT4_GOOD_OLD_REV
))

5288 
£t_Ïrge_fe
 = 1;

5290 
¿w_šode
->
i_g’”©iÚ
 = 
	`ıu_to_Ë32
(
šode
->i_generation);

5291 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode)) {

5292 ià(
	`Şd_v®id_dev
(
šode
->
i_rdev
)) {

5293 
¿w_šode
->
i_block
[0] =

5294 
	`ıu_to_Ë32
(
	`Şd_’code_dev
(
šode
->
i_rdev
));

5295 
¿w_šode
->
i_block
[1] = 0;

5297 
¿w_šode
->
i_block
[0] = 0;

5298 
¿w_šode
->
i_block
[1] =

5299 
	`ıu_to_Ë32
(
	`Ãw_’code_dev
(
šode
->
i_rdev
));

5300 
¿w_šode
->
i_block
[2] = 0;

5302 } ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

5303 
block
 = 0; block < 
EXT4_N_BLOCKS
; block++)

5304 
¿w_šode
->
i_block
[
block
] = 
ei
->
i_d©a
[block];

5307 ià(
	`lik–y
(!
	`‹¡_İt2
(
šode
->
i_sb
, 
HURD_COMPAT
))) {

5308 
u64
 
iv”s
 = 
	`ext4_šode_³ek_iv”siÚ
(
šode
);

5310 
¿w_šode
->
i_disk_v”siÚ
 = 
	`ıu_to_Ë32
(
iv”s
);

5311 ià(
ei
->
i_exŒa_isize
) {

5312 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ei
, 
i_v”siÚ_hi
))

5313 
¿w_šode
->
i_v”siÚ_hi
 =

5314 
	`ıu_to_Ë32
(
iv”s
 >> 32);

5315 
¿w_šode
->
i_exŒa_isize
 =

5316 
	`ıu_to_Ë16
(
ei
->
i_exŒa_isize
);

5320 
	`BUG_ON
(!
	`ext4_has_ã©u»_´ojeù
(
šode
->
i_sb
) &&

5321 
i_´ojid
 !ğ
EXT4_DEF_PROJID
);

5323 ià(
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
 &&

5324 
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ei
, 
i_´ojid
))

5325 
¿w_šode
->
i_´ojid
 = 
	`ıu_to_Ë32
(i_projid);

5327 
	`ext4_šode_csum_£t
(
šode
, 
¿w_šode
, 
ei
);

5328 
	`¥š_uÆock
(&
ei
->
i_¿w_lock
);

5329 ià(
šode
->
i_sb
->
s_æags
 & 
SB_LAZYTIME
)

5330 
	`ext4_upd©e_Ùh”_šodes_time
(
šode
->
i_sb
, inode->
i_šo
,

5331 
bh
->
b_d©a
);

5333 
	`BUFFER_TRACE
(
bh
, "callƒxt4_handle_dirty_metadata");

5334 
rc
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

5335 ià(!
”r
)

5336 
”r
 = 
rc
;

5337 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_NEW
);

5338 ià(
£t_Ïrge_fe
) {

5339 
	`BUFFER_TRACE
(
	`EXT4_SB
(
sb
)->
s_sbh
, "get write‡ccess");

5340 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
	`EXT4_SB
(
sb
)->
s_sbh
);

5341 ià(
”r
)

5342 
out_b»l£
;

5343 
	`ext4_£t_ã©u»_Ïrge_fe
(
sb
);

5344 
	`ext4_hªdË_sync
(
hªdË
);

5345 
”r
 = 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
);

5347 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 
Ãed_d©async
);

5348 
out_b»l£
:

5349 
	`b»l£
(
bh
);

5350 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”r
);

5351  
”r
;

5352 
	}
}

5388 
	$ext4_wr™e_šode
(
šode
 *šode, 
wr™eback_cÚŒŞ
 *
wbc
)

5390 
”r
;

5392 ià(
	`WARN_ON_ONCE
(
cu¼’t
->
æags
 & 
PF_MEMALLOC
) ||

5393 
	`sb_rdÚly
(
šode
->
i_sb
))

5396 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

5397  -
EIO
;

5399 ià(
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
) {

5400 ià(
	`ext4_jouº®_cu¼’t_hªdË
()) {

5401 
	`jbd_debug
(1, "called„ecursively,‚on-PF_MEMALLOC!\n");

5402 
	`dump_¡ack
();

5403  -
EIO
;

5411 ià(
wbc
->
sync_mode
 !ğ
WB_SYNC_ALL
 || wbc->
fÜ_sync
)

5414 
”r
 = 
	`jbd2_com¶‘e_Œª§ùiÚ
(
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
,

5415 
	`EXT4_I
(
šode
)->
i_sync_tid
);

5417 
ext4_oc
 
oc
;

5419 
”r
 = 
	`__ext4_g‘_šode_loc
(
šode
, &
oc
, 0);

5420 ià(
”r
)

5421  
”r
;

5426 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
 && !wbc->
fÜ_sync
)

5427 
	`sync_dœty_bufãr
(
oc
.
bh
);

5428 ià(
	`bufãr_»q
(
oc
.
bh
è&& !
	`bufãr_u±od©e
(iloc.bh)) {

5429 
	`EXT4_ERROR_INODE_BLOCK
(
šode
, 
oc
.
bh
->
b_blockÄ
,

5431 
”r
 = -
EIO
;

5433 
	`b»l£
(
oc
.
bh
);

5435  
”r
;

5436 
	}
}

5443 
	$ext4_wa™_fÜ__·ge_comm™
(
šode
 *inode)

5445 
·ge
 *page;

5446 
off£t
;

5447 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
;

5448 
tid_t
 
comm™_tid
 = 0;

5449 
»t
;

5451 
off£t
 = 
šode
->
i_size
 & (
PAGE_SIZE
 - 1);

5457 ià(
off£t
 > 
PAGE_SIZE
 - 
	`i_blocksize
(
šode
))

5460 
·ge
 = 
	`fšd_lock_·ge
(
šode
->
i_m­pšg
,

5461 
šode
->
i_size
 >> 
PAGE_SHIFT
);

5462 ià(!
·ge
)

5464 
»t
 = 
	`__ext4_jouº®Ëd_šv®id©•age
(
·ge
, 
off£t
,

5465 
PAGE_SIZE
 - 
off£t
);

5466 
	`uÆock_·ge
(
·ge
);

5467 
	`put_·ge
(
·ge
);

5468 ià(
»t
 !ğ-
EBUSY
)

5470 
comm™_tid
 = 0;

5471 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

5472 ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
)

5473 
comm™_tid
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
;

5474 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

5475 ià(
comm™_tid
)

5476 
	`jbd2_log_wa™_comm™
(
jouº®
, 
comm™_tid
);

5478 
	}
}

5504 
	$ext4_£‰r
(
d’Œy
 *d’Œy, 
Ÿ‰r
 *
©Œ
)

5506 
šode
 *šodğ
	`d_šode
(
d’Œy
);

5507 
”rÜ
, 
rc
 = 0;

5508 
Üphª
 = 0;

5509 cÚ¡ 
Ÿ_v®id
 = 
©Œ
->ia_valid;

5511 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

5512  -
EIO
;

5514 ià(
	`uÆik–y
(
	`IS_IMMUTABLE
(
šode
)))

5515  -
EPERM
;

5517 ià(
	`uÆik–y
(
	`IS_APPEND
(
šode
) &&

5518 (
Ÿ_v®id
 & (
ATTR_MODE
 | 
ATTR_UID
 |

5519 
ATTR_GID
 | 
ATTR_TIMES_SET
))))

5520  -
EPERM
;

5522 
”rÜ
 = 
	`£‰r_´•¬e
(
d’Œy
, 
©Œ
);

5523 ià(
”rÜ
)

5524  
”rÜ
;

5526 
”rÜ
 = 
	`fsüy±_´•¬e_£‰r
(
d’Œy
, 
©Œ
);

5527 ià(
”rÜ
)

5528  
”rÜ
;

5530 
”rÜ
 = 
	`fsv”™y_´•¬e_£‰r
(
d’Œy
, 
©Œ
);

5531 ià(
”rÜ
)

5532  
”rÜ
;

5534 ià(
	`is_quÙa_modifiÿtiÚ
(
šode
, 
©Œ
)) {

5535 
”rÜ
 = 
	`dquÙ_š™Ÿlize
(
šode
);

5536 ià(
”rÜ
)

5537  
”rÜ
;

5539 ià((
Ÿ_v®id
 & 
ATTR_UID
 && !
	`uid_eq
(
©Œ
->
Ÿ_uid
, 
šode
->
i_uid
)) ||

5540 (
Ÿ_v®id
 & 
ATTR_GID
 && !
	`gid_eq
(
©Œ
->
Ÿ_gid
, 
šode
->
i_gid
))) {

5541 
hªdË_t
 *
hªdË
;

5545 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_QUOTA
,

5546 (
	`EXT4_MAXQUOTAS_INIT_BLOCKS
(
šode
->
i_sb
) +

5547 
	`EXT4_MAXQUOTAS_DEL_BLOCKS
(
šode
->
i_sb
)) + 3);

5548 ià(
	`IS_ERR
(
hªdË
)) {

5549 
”rÜ
 = 
	`PTR_ERR
(
hªdË
);

5550 
”r_out
;

5556 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

5557 
”rÜ
 = 
	`dquÙ_Œªsãr
(
šode
, 
©Œ
);

5558 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

5560 ià(
”rÜ
) {

5561 
	`ext4_jouº®_¡İ
(
hªdË
);

5562  
”rÜ
;

5566 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_UID
)

5567 
šode
->
i_uid
 = 
©Œ
->
Ÿ_uid
;

5568 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_GID
)

5569 
šode
->
i_gid
 = 
©Œ
->
Ÿ_gid
;

5570 
”rÜ
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

5571 
	`ext4_jouº®_¡İ
(
hªdË
);

5574 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_SIZE
) {

5575 
hªdË_t
 *
hªdË
;

5576 
loff_t
 
Şdsize
 = 
šode
->
i_size
;

5577 
shršk
 = (
©Œ
->
Ÿ_size
 < 
šode
->
i_size
);

5579 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))) {

5580 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

5582 ià(
©Œ
->
Ÿ_size
 > 
sbi
->
s_b™m­_maxby‹s
)

5583  -
EFBIG
;

5585 ià(!
	`S_ISREG
(
šode
->
i_mode
))

5586  -
EINVAL
;

5588 ià(
	`IS_I_VERSION
(
šode
è&& 
©Œ
->
Ÿ_size
 !ğšode->
i_size
)

5589 
	`šode_šc_iv”siÚ
(
šode
);

5591 ià(
shršk
) {

5592 ià(
	`ext4_should_Üd”_d©a
(
šode
)) {

5593 
”rÜ
 = 
	`ext4_begš_Üd”ed_Œunÿ‹
(
šode
,

5594 
©Œ
->
Ÿ_size
);

5595 ià(
”rÜ
)

5596 
”r_out
;

5602 
	`šode_dio_wa™
(
šode
);

5605 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

5607 
rc
 = 
	`ext4_b»ak_Ïyouts
(
šode
);

5608 ià(
rc
) {

5609 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

5610  
rc
;

5613 ià(
©Œ
->
Ÿ_size
 !ğ
šode
->
i_size
) {

5614 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 3);

5615 ià(
	`IS_ERR
(
hªdË
)) {

5616 
”rÜ
 = 
	`PTR_ERR
(
hªdË
);

5617 
out_mm­_£m
;

5619 ià(
	`ext4_hªdË_v®id
(
hªdË
è&& 
shršk
) {

5620 
”rÜ
 = 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

5621 
Üphª
 = 1;

5627 ià(!
shršk
) {

5628 
šode
->
i_mtime
 = 
	`cu¼’t_time
(inode);

5629 
šode
->
i_ùime
 = inode->
i_mtime
;

5631 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

5632 
	`EXT4_I
(
šode
)->
i_disksize
 = 
©Œ
->
Ÿ_size
;

5633 
rc
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

5634 ià(!
”rÜ
)

5635 
”rÜ
 = 
rc
;

5641 ià(!
”rÜ
)

5642 
	`i_size_wr™e
(
šode
, 
©Œ
->
Ÿ_size
);

5643 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

5644 
	`ext4_jouº®_¡İ
(
hªdË
);

5645 ià(
”rÜ
)

5646 
out_mm­_£m
;

5647 ià(!
shršk
) {

5648 
	`·geÿche_isize_ex‹nded
(
šode
, 
Şdsize
,

5649 
šode
->
i_size
);

5650 } ià(
	`ext4_should_jouº®_d©a
(
šode
)) {

5651 
	`ext4_wa™_fÜ__·ge_comm™
(
šode
);

5659 
	`Œunÿ‹_·geÿche
(
šode
, inode->
i_size
);

5664 ià(
©Œ
->
Ÿ_size
 <ğ
Şdsize
) {

5665 
rc
 = 
	`ext4_Œunÿ‹
(
šode
);

5666 ià(
rc
)

5667 
”rÜ
 = 
rc
;

5669 
out_mm­_£m
:

5670 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

5673 ià(!
”rÜ
) {

5674 
	`£‰r_cİy
(
šode
, 
©Œ
);

5675 
	`m¬k_šode_dœty
(
šode
);

5682 ià(
Üphª
 && 
šode
->
i_Æšk
)

5683 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

5685 ià(!
”rÜ
 && (
Ÿ_v®id
 & 
ATTR_MODE
))

5686 
rc
 = 
	`posix_aş_chmod
(
šode
, inode->
i_mode
);

5688 
”r_out
:

5689 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”rÜ
);

5690 ià(!
”rÜ
)

5691 
”rÜ
 = 
rc
;

5692  
”rÜ
;

5693 
	}
}

5695 
	$ext4_g‘©Œ
(cÚ¡ 
·th
 *·th, 
k¡©
 *
¡©
,

5696 
u32
 
»que¡_mask
, 
qu”y_æags
)

5698 
šode
 *šodğ
	`d_šode
(
·th
->
d’Œy
);

5699 
ext4_šode
 *
¿w_šode
;

5700 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

5701 
æags
;

5703 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ei
, 
i_ütime
)) {

5704 
¡©
->
»suÉ_mask
 |ğ
STATX_BTIME
;

5705 
¡©
->
btime
.
tv_£c
 = 
ei
->
i_ütime
.tv_sec;

5706 
¡©
->
btime
.
tv_n£c
 = 
ei
->
i_ütime
.tv_nsec;

5709 
æags
 = 
ei
->
i_æags
 & 
EXT4_FL_USER_VISIBLE
;

5710 ià(
æags
 & 
EXT4_APPEND_FL
)

5711 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_APPEND
;

5712 ià(
æags
 & 
EXT4_COMPR_FL
)

5713 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_COMPRESSED
;

5714 ià(
æags
 & 
EXT4_ENCRYPT_FL
)

5715 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_ENCRYPTED
;

5716 ià(
æags
 & 
EXT4_IMMUTABLE_FL
)

5717 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_IMMUTABLE
;

5718 ià(
æags
 & 
EXT4_NODUMP_FL
)

5719 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_NODUMP
;

5721 
¡©
->
©Œibu‹s_mask
 |ğ(
STATX_ATTR_APPEND
 |

5722 
STATX_ATTR_COMPRESSED
 |

5723 
STATX_ATTR_ENCRYPTED
 |

5724 
STATX_ATTR_IMMUTABLE
 |

5725 
STATX_ATTR_NODUMP
);

5727 
	`g’”ic_fÏ‰r
(
šode
, 
¡©
);

5729 
	}
}

5731 
	$ext4_fe_g‘©Œ
(cÚ¡ 
·th
 *·th, 
k¡©
 *
¡©
,

5732 
u32
 
»que¡_mask
, 
qu”y_æags
)

5734 
šode
 *šodğ
	`d_šode
(
·th
->
d’Œy
);

5735 
u64
 
d–®loc_blocks
;

5737 
	`ext4_g‘©Œ
(
·th
, 
¡©
, 
»que¡_mask
, 
qu”y_æags
);

5745 ià(
	`uÆik–y
(
	`ext4_has_šlše_d©a
(
šode
)))

5746 
¡©
->
blocks
 +ğ(¡©->
size
 + 511) >> 9;

5758 
d–®loc_blocks
 = 
	`EXT4_C2B
(
	`EXT4_SB
(
šode
->
i_sb
),

5759 
	`EXT4_I
(
šode
)->
i_»£rved_d©a_blocks
);

5760 
¡©
->
blocks
 +ğ
d–®loc_blocks
 << (
šode
->
i_sb
->
s_blocksize_b™s
 - 9);

5762 
	}
}

5764 
	$ext4_šdex_Œªs_blocks
(
šode
 *šode, 
lblocks
,

5765 
³x‹Ás
)

5767 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)))

5768  
	`ext4_šd_Œªs_blocks
(
šode
, 
lblocks
);

5769  
	`ext4_ext_šdex_Œªs_blocks
(
šode
, 
³x‹Ás
);

5770 
	}
}

5783 
	$ext4_m‘a_Œªs_blocks
(
šode
 *šode, 
lblocks
,

5784 
³x‹Ás
)

5786 
ext4_group_t
 
groups
, 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
šode
->
i_sb
);

5787 
gdpblocks
;

5788 
idxblocks
;

5789 
»t
 = 0;

5795 
idxblocks
 = 
	`ext4_šdex_Œªs_blocks
(
šode
, 
lblocks
, 
³x‹Ás
);

5797 
»t
 = 
idxblocks
;

5803 
groups
 = 
idxblocks
 + 
³x‹Ás
;

5804 
gdpblocks
 = 
groups
;

5805 ià(
groups
 > 
ngroups
)

5806 
groups
 = 
ngroups
;

5807 ià(
groups
 > 
	`EXT4_SB
(
šode
->
i_sb
)->
s_gdb_couÁ
)

5808 
gdpblocks
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_gdb_couÁ
;

5811 
»t
 +ğ
groups
 + 
gdpblocks
;

5814 
»t
 +ğ
	`EXT4_META_TRANS_BLOCKS
(
šode
->
i_sb
);

5816  
»t
;

5817 
	}
}

5829 
	$ext4_wr™•age_Œªs_blocks
(
šode
 *inode)

5831 
bµ
 = 
	`ext4_jouº®_blocks_³r_·ge
(
šode
);

5832 
»t
;

5834 
»t
 = 
	`ext4_m‘a_Œªs_blocks
(
šode
, 
bµ
, bpp);

5837 ià(
	`ext4_should_jouº®_d©a
(
šode
))

5838 
»t
 +ğ
bµ
;

5839  
»t
;

5840 
	}
}

5851 
	$ext4_chunk_Œªs_blocks
(
šode
 *šode, 
Äblocks
)

5853  
	`ext4_m‘a_Œªs_blocks
(
šode
, 
Äblocks
, 1);

5854 
	}
}

5860 
	$ext4_m¬k_oc_dœty
(
hªdË_t
 *
hªdË
,

5861 
šode
 *šode, 
ext4_oc
 *
oc
)

5863 
”r
 = 0;

5865 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
)))) {

5866 
	`put_bh
(
oc
->
bh
);

5867  -
EIO
;

5869 ià(
	`IS_I_VERSION
(
šode
))

5870 
	`šode_šc_iv”siÚ
(
šode
);

5873 
	`g‘_bh
(
oc
->
bh
);

5876 
”r
 = 
	`ext4_do_upd©e_šode
(
hªdË
, 
šode
, 
oc
);

5877 
	`put_bh
(
oc
->
bh
);

5878  
”r
;

5879 
	}
}

5887 
	$ext4_»£rve_šode_wr™e
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

5888 
ext4_oc
 *
oc
)

5890 
”r
;

5892 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

5893  -
EIO
;

5895 
”r
 = 
	`ext4_g‘_šode_loc
(
šode
, 
oc
);

5896 ià(!
”r
) {

5897 
	`BUFFER_TRACE
(
oc
->
bh
, "get_write_access");

5898 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
oc
->
bh
);

5899 ià(
”r
) {

5900 
	`b»l£
(
oc
->
bh
);

5901 
oc
->
bh
 = 
NULL
;

5904 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”r
);

5905  
”r
;

5906 
	}
}

5908 
	$__ext4_ex·nd_exŒa_isize
(
šode
 *inode,

5909 
Ãw_exŒa_isize
,

5910 
ext4_oc
 *
oc
,

5911 
hªdË_t
 *
hªdË
, *
no_ex·nd
)

5913 
ext4_šode
 *
¿w_šode
;

5914 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

5915 
”rÜ
;

5917 
¿w_šode
 = 
	`ext4_¿w_šode
(
oc
);

5919 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

5922 ià(!
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
) ||

5923 
h—d”
->
h_magic
 !ğ
	`ıu_to_Ë32
(
EXT4_XATTR_MAGIC
)) {

5924 
	`mem£t
((*)
¿w_šode
 + 
EXT4_GOOD_OLD_INODE_SIZE
 +

5925 
	`EXT4_I
(
šode
)->
i_exŒa_isize
, 0,

5926 
Ãw_exŒa_isize
 - 
	`EXT4_I
(
šode
)->
i_exŒa_isize
);

5927 
	`EXT4_I
(
šode
)->
i_exŒa_isize
 = 
Ãw_exŒa_isize
;

5932 
”rÜ
 = 
	`ext4_ex·nd_exŒa_isize_—
(
šode
, 
Ãw_exŒa_isize
,

5933 
¿w_šode
, 
hªdË
);

5934 ià(
”rÜ
) {

5938 *
no_ex·nd
 = 1;

5941  
”rÜ
;

5942 
	}
}

5948 
	$ext4_Œy_to_ex·nd_exŒa_isize
(
šode
 *inode,

5949 
Ãw_exŒa_isize
,

5950 
ext4_oc
 
oc
,

5951 
hªdË_t
 *
hªdË
)

5953 
no_ex·nd
;

5954 
”rÜ
;

5956 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NO_EXPAND
))

5957  -
EOVERFLOW
;

5968 ià(
	`ext4_hªdË_v®id
(
hªdË
) &&

5969 
	`jbd2_jouº®_ex‹nd
(
hªdË
,

5970 
	`EXT4_DATA_TRANS_BLOCKS
(
šode
->
i_sb
)) != 0)

5971  -
ENOSPC
;

5973 ià(
	`ext4_wr™e_Œylock_x©Œ
(
šode
, &
no_ex·nd
) == 0)

5974  -
EBUSY
;

5976 
”rÜ
 = 
	`__ext4_ex·nd_exŒa_isize
(
šode
, 
Ãw_exŒa_isize
, &
oc
,

5977 
hªdË
, &
no_ex·nd
);

5978 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

5980  
”rÜ
;

5981 
	}
}

5983 
	$ext4_ex·nd_exŒa_isize
(
šode
 *inode,

5984 
Ãw_exŒa_isize
,

5985 
ext4_oc
 *
oc
)

5987 
hªdË_t
 *
hªdË
;

5988 
no_ex·nd
;

5989 
”rÜ
, 
rc
;

5991 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NO_EXPAND
)) {

5992 
	`b»l£
(
oc
->
bh
);

5993  -
EOVERFLOW
;

5996 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
,

5997 
	`EXT4_DATA_TRANS_BLOCKS
(
šode
->
i_sb
));

5998 ià(
	`IS_ERR
(
hªdË
)) {

5999 
”rÜ
 = 
	`PTR_ERR
(
hªdË
);

6000 
	`b»l£
(
oc
->
bh
);

6001  
”rÜ
;

6004 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

6006 
	`BUFFER_TRACE
(
oc
->
bh
, "get_write_access");

6007 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
oc
->
bh
);

6008 ià(
”rÜ
) {

6009 
	`b»l£
(
oc
->
bh
);

6010 
out_¡İ
;

6013 
”rÜ
 = 
	`__ext4_ex·nd_exŒa_isize
(
šode
, 
Ãw_exŒa_isize
, 
oc
,

6014 
hªdË
, &
no_ex·nd
);

6016 
rc
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, 
oc
);

6017 ià(!
”rÜ
)

6018 
”rÜ
 = 
rc
;

6020 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

6021 
out_¡İ
:

6022 
	`ext4_jouº®_¡İ
(
hªdË
);

6023  
”rÜ
;

6024 
	}
}

6039 
	$ext4_m¬k_šode_dœty
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

6041 
ext4_oc
 
oc
;

6042 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

6043 
”r
;

6045 
	`might_¦“p
();

6046 
	`Œaû_ext4_m¬k_šode_dœty
(
šode
, 
_RET_IP_
);

6047 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
);

6048 ià(
”r
)

6049  
”r
;

6051 ià(
	`EXT4_I
(
šode
)->
i_exŒa_isize
 < 
sbi
->
s_wªt_exŒa_isize
)

6052 
	`ext4_Œy_to_ex·nd_exŒa_isize
(
šode
, 
sbi
->
s_wªt_exŒa_isize
,

6053 
oc
, 
hªdË
);

6055  
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

6056 
	}
}

6076 
	$ext4_dœty_šode
(
šode
 *šode, 
æags
)

6078 
hªdË_t
 *
hªdË
;

6080 ià(
æags
 =ğ
I_DIRTY_TIME
)

6082 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 2);

6083 ià(
	`IS_ERR
(
hªdË
))

6084 
out
;

6086 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

6088 
	`ext4_jouº®_¡İ
(
hªdË
);

6089 
out
:

6091 
	}
}

6093 
	$ext4_chªge_šode_jouº®_æag
(
šode
 *šode, 
v®
)

6095 
jouº®_t
 *
jouº®
;

6096 
hªdË_t
 *
hªdË
;

6097 
”r
;

6098 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

6110 
jouº®
 = 
	`EXT4_JOURNAL
(
šode
);

6111 ià(!
jouº®
)

6113 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

6114  -
EROFS
;

6117 
	`šode_dio_wa™
(
šode
);

6127 ià(
v®
) {

6128 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6129 
”r
 = 
	`fem­_wr™e_ªd_wa™
(
šode
->
i_m­pšg
);

6130 ià(
”r
 < 0) {

6131 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6132  
”r
;

6136 
	`³rıu_down_wr™e
(&
sbi
->
s_jouº®_æag_rw£m
);

6137 
	`jbd2_jouº®_lock_upd©es
(
jouº®
);

6147 ià(
v®
)

6148 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_JOURNAL_DATA
);

6150 
”r
 = 
	`jbd2_jouº®_æush
(
jouº®
);

6151 ià(
”r
 < 0) {

6152 
	`jbd2_jouº®_uÆock_upd©es
(
jouº®
);

6153 
	`³rıu_up_wr™e
(&
sbi
->
s_jouº®_æag_rw£m
);

6154  
”r
;

6156 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_JOURNAL_DATA
);

6158 
	`ext4_£t_aİs
(
šode
);

6160 
	`jbd2_jouº®_uÆock_upd©es
(
jouº®
);

6161 
	`³rıu_up_wr™e
(&
sbi
->
s_jouº®_æag_rw£m
);

6163 ià(
v®
)

6164 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6168 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 1);

6169 ià(
	`IS_ERR
(
hªdË
))

6170  
	`PTR_ERR
(
hªdË
);

6172 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

6173 
	`ext4_hªdË_sync
(
hªdË
);

6174 
	`ext4_jouº®_¡İ
(
hªdË
);

6175 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”r
);

6177  
”r
;

6178 
	}
}

6180 
	$ext4_bh_unm­³d
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

6182  !
	`bufãr_m­³d
(
bh
);

6183 
	}
}

6185 
vm_çuÉ_t
 
	$ext4_·ge_mkwr™e
(
vm_çuÉ
 *
vmf
)

6187 
vm_¬—_¡ruù
 *
vma
 = 
vmf
->vma;

6188 
·ge
 *·gğ
vmf
->page;

6189 
loff_t
 
size
;

6190 
Ën
;

6191 
”r
;

6192 
vm_çuÉ_t
 
»t
;

6193 
fe
 *fğ
vma
->
vm_fe
;

6194 
šode
 *šodğ
	`fe_šode
(
fe
);

6195 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

6196 
hªdË_t
 *
hªdË
;

6197 
g‘_block_t
 *
g‘_block
;

6198 
»Œ›s
 = 0;

6200 ià(
	`uÆik–y
(
	`IS_IMMUTABLE
(
šode
)))

6201  
VM_FAULT_SIGBUS
;

6203 
	`sb_¡¬t_·geçuÉ
(
šode
->
i_sb
);

6204 
	`fe_upd©e_time
(
vma
->
vm_fe
);

6206 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6208 
”r
 = 
	`ext4_cÚv”t_šlše_d©a
(
šode
);

6209 ià(
”r
)

6210 
out_»t
;

6213 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DELALLOC
) &&

6214 !
	`ext4_should_jouº®_d©a
(
šode
) &&

6215 !
	`ext4_nÚda_sw™ch
(
šode
->
i_sb
)) {

6217 
”r
 = 
	`block_·ge_mkwr™e
(
vma
, 
vmf
,

6218 
ext4_da_g‘_block_´•
);

6219 } 
”r
 =ğ-
ENOSPC
 &&

6220 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
));

6221 
out_»t
;

6224 
	`lock_·ge
(
·ge
);

6225 
size
 = 
	`i_size_»ad
(
šode
);

6227 ià(
·ge
->
m­pšg
 !ğm­pšg || 
	`·ge_off£t
Õageè> 
size
) {

6228 
	`uÆock_·ge
(
·ge
);

6229 
»t
 = 
VM_FAULT_NOPAGE
;

6230 
out
;

6233 ià(
·ge
->
šdex
 =ğ
size
 >> 
PAGE_SHIFT
)

6234 
Ën
 = 
size
 & ~
PAGE_MASK
;

6236 
Ën
 = 
PAGE_SIZE
;

6241 ià(
	`·ge_has_bufãrs
(
·ge
)) {

6242 ià(!
	`ext4_w®k_·ge_bufãrs
(
NULL
, 
	`·ge_bufãrs
(
·ge
),

6243 0, 
Ën
, 
NULL
,

6244 
ext4_bh_unm­³d
)) {

6246 
	`wa™_fÜ_¡abË_·ge
(
·ge
);

6247 
»t
 = 
VM_FAULT_LOCKED
;

6248 
out
;

6251 
	`uÆock_·ge
(
·ge
);

6253 ià(
	`ext4_should_diÜ—d_nŞock
(
šode
))

6254 
g‘_block
 = 
ext4_g‘_block_unwr™‹n
;

6256 
g‘_block
 = 
ext4_g‘_block
;

6257 
»Œy_®loc
:

6258 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_WRITE_PAGE
,

6259 
	`ext4_wr™•age_Œªs_blocks
(
šode
));

6260 ià(
	`IS_ERR
(
hªdË
)) {

6261 
»t
 = 
VM_FAULT_SIGBUS
;

6262 
out
;

6264 
”r
 = 
	`block_·ge_mkwr™e
(
vma
, 
vmf
, 
g‘_block
);

6265 ià(!
”r
 && 
	`ext4_should_jouº®_d©a
(
šode
)) {

6266 ià(
	`ext4_w®k_·ge_bufãrs
(
hªdË
, 
	`·ge_bufãrs
(
·ge
), 0,

6267 
PAGE_SIZE
, 
NULL
, 
do_jouº®_g‘_wr™e_acûss
)) {

6268 
	`uÆock_·ge
(
·ge
);

6269 
»t
 = 
VM_FAULT_SIGBUS
;

6270 
	`ext4_jouº®_¡İ
(
hªdË
);

6271 
out
;

6273 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_JDATA
);

6275 
	`ext4_jouº®_¡İ
(
hªdË
);

6276 ià(
”r
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

6277 
»Œy_®loc
;

6278 
out_»t
:

6279 
»t
 = 
	`block_·ge_mkwr™e_»tuº
(
”r
);

6280 
out
:

6281 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6282 
	`sb_’d_·geçuÉ
(
šode
->
i_sb
);

6283  
»t
;

6284 
	}
}

6286 
vm_çuÉ_t
 
	$ext4_fem­_çuÉ
(
vm_çuÉ
 *
vmf
)

6288 
šode
 *šodğ
	`fe_šode
(
vmf
->
vma
->
vm_fe
);

6289 
vm_çuÉ_t
 
»t
;

6291 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6292 
»t
 = 
	`fem­_çuÉ
(
vmf
);

6293 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6295  
»t
;

6296 
	}
}

	@pxt4/ioctl.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/ÿ·b™y.h
>

13 
	~<lšux/time.h
>

14 
	~<lšux/com·t.h
>

15 
	~<lšux/mouÁ.h
>

16 
	~<lšux/fe.h
>

17 
	~<lšux/quÙaİs.h
>

18 
	~<lšux/¿ndom.h
>

19 
	~<lšux/uuid.h
>

20 
	~<lšux/uacûss.h
>

21 
	~<lšux/d–ay.h
>

22 
	~<lšux/iv”siÚ.h
>

23 
	~"ext4_jbd2.h
"

24 
	~"ext4.h
"

25 
	~<lšux/fsm­.h
>

26 
	~"fsm­.h
"

27 
	~<Œaû/ev’ts/ext4.h
>

37 
	$memsw­
(*
a
, *
b
, 
size_t
 
Ën
)

39 *
­
, *
bp
;

41 
­
 = (*)
a
;

42 
bp
 = (*)
b
;

43 
Ën
-- > 0) {

44 
	`sw­
(*
­
, *
bp
);

45 
­
++;

46 
bp
++;

48 
	}
}

61 
	$sw­_šode_d©a
(
šode
 *
šode1
, šod*
šode2
)

63 
loff_t
 
isize
;

64 
ext4_šode_šfo
 *
ei1
;

65 
ext4_šode_šfo
 *
ei2
;

66 
tmp
;

68 
ei1
 = 
	`EXT4_I
(
šode1
);

69 
ei2
 = 
	`EXT4_I
(
šode2
);

71 
	`sw­
(
šode1
->
i_v”siÚ
, 
šode2
->i_version);

72 
	`sw­
(
šode1
->
i_©ime
, 
šode2
->i_atime);

73 
	`sw­
(
šode1
->
i_mtime
, 
šode2
->i_mtime);

75 
	`memsw­
(
ei1
->
i_d©a
, 
ei2
->i_data, (ei1->i_data));

76 
tmp
 = 
ei1
->
i_æags
 & 
EXT4_FL_SHOULD_SWAP
;

77 
ei1
->
i_æags
 = (
ei2
->i_æag & 
EXT4_FL_SHOULD_SWAP
) |

78 (
ei1
->
i_æags
 & ~
EXT4_FL_SHOULD_SWAP
);

79 
ei2
->
i_æags
 = 
tmp
 | (ei2->i_æag & ~
EXT4_FL_SHOULD_SWAP
);

80 
	`sw­
(
ei1
->
i_disksize
, 
ei2
->i_disksize);

81 
	`ext4_es_»move_ex‹Á
(
šode1
, 0, 
EXT_MAX_BLOCKS
);

82 
	`ext4_es_»move_ex‹Á
(
šode2
, 0, 
EXT_MAX_BLOCKS
);

84 
isize
 = 
	`i_size_»ad
(
šode1
);

85 
	`i_size_wr™e
(
šode1
, 
	`i_size_»ad
(
šode2
));

86 
	`i_size_wr™e
(
šode2
, 
isize
);

87 
	}
}

89 
	$»£t_šode_£ed
(
šode
 *inode)

91 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

92 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

93 
__Ë32
 
šum
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

94 
__Ë32
 
g’
 = 
	`ıu_to_Ë32
(
šode
->
i_g’”©iÚ
);

95 
__u32
 
csum
;

97 ià(!
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

100 
csum
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
šum
, (inum));

101 
ei
->
i_csum_£ed
 = 
	`ext4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
g’
, (gen));

102 
	}
}

113 
	$sw­_šode_boÙ_lßd”
(
su³r_block
 *
sb
,

114 
šode
 *inode)

116 
hªdË_t
 *
hªdË
;

117 
”r
;

118 
šode
 *
šode_bl
;

119 
ext4_šode_šfo
 *
ei_bl
;

120 
qsize_t
 
size
, 
size_bl
, 
diff
;

121 
blkút_t
 
blocks
;

122 
by‹s
;

124 
šode_bl
 = 
	`ext4_ig‘
(
sb
, 
EXT4_BOOT_LOADER_INO
, 
EXT4_IGET_SPECIAL
);

125 ià(
	`IS_ERR
(
šode_bl
))

126  
	`PTR_ERR
(
šode_bl
);

127 
ei_bl
 = 
	`EXT4_I
(
šode_bl
);

131 
	`lock_two_nÚdœeùÜ›s
(
šode
, 
šode_bl
);

133 ià(
šode
->
i_Æšk
 !ğ1 || !
	`S_ISREG
(šode->
i_mode
) ||

134 
	`IS_SWAPFILE
(
šode
è|| 
	`IS_ENCRYPTED
(inode) ||

135 (
	`EXT4_I
(
šode
)->
i_æags
 & 
EXT4_JOURNAL_DATA_FL
) ||

136 
	`ext4_has_šlše_d©a
(
šode
)) {

137 
”r
 = -
EINVAL
;

138 
jouº®_”r_out
;

141 ià(
	`IS_RDONLY
(
šode
è|| 
	`IS_APPEND
(šodeè|| 
	`IS_IMMUTABLE
(inode) ||

142 !
	`šode_owÃr_Ü_ÿ·bË
(
šode
è|| !
	`ÿ·bË
(
CAP_SYS_ADMIN
)) {

143 
”r
 = -
EPERM
;

144 
jouº®_”r_out
;

147 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

148 
”r
 = 
	`fem­_wr™e_ªd_wa™
(
šode
->
i_m­pšg
);

149 ià(
”r
)

150 
”r_out
;

152 
”r
 = 
	`fem­_wr™e_ªd_wa™
(
šode_bl
->
i_m­pšg
);

153 ià(
”r
)

154 
”r_out
;

157 
	`šode_dio_wa™
(
šode
);

158 
	`šode_dio_wa™
(
šode_bl
);

160 
	`Œunÿ‹_šode_·ges
(&
šode
->
i_d©a
, 0);

161 
	`Œunÿ‹_šode_·ges
(&
šode_bl
->
i_d©a
, 0);

163 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode_bl
, 
EXT4_HT_MOVE_EXTENTS
, 2);

164 ià(
	`IS_ERR
(
hªdË
)) {

165 
”r
 = -
EINVAL
;

166 
”r_out
;

170 
	`ext4_doubË_down_wr™e_d©a_£m
(
šode
, 
šode_bl
);

172 ià(
šode_bl
->
i_Æšk
 == 0) {

174 
	`£t_Æšk
(
šode_bl
, 1);

175 
	`i_uid_wr™e
(
šode_bl
, 0);

176 
	`i_gid_wr™e
(
šode_bl
, 0);

177 
šode_bl
->
i_æags
 = 0;

178 
ei_bl
->
i_æags
 = 0;

179 
	`šode_£t_iv”siÚ
(
šode_bl
, 1);

180 
	`i_size_wr™e
(
šode_bl
, 0);

181 
šode_bl
->
i_mode
 = 
S_IFREG
;

182 ià(
	`ext4_has_ã©u»_ex‹Ás
(
sb
)) {

183 
	`ext4_£t_šode_æag
(
šode_bl
, 
EXT4_INODE_EXTENTS
);

184 
	`ext4_ext_Œ“_š™
(
hªdË
, 
šode_bl
);

186 
	`mem£t
(
ei_bl
->
i_d©a
, 0, (ei_bl->i_data));

189 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

190 ià(
”r
)

191 
”r_out1
;

193 
size
 = (
qsize_t
)(
šode
->
i_blocks
è* (1 << 9è+ inode->
i_by‹s
;

194 
size_bl
 = (
qsize_t
)(
šode_bl
->
i_blocks
è* (1 << 9è+ inode_bl->
i_by‹s
;

195 
diff
 = 
size
 - 
size_bl
;

196 
	`sw­_šode_d©a
(
šode
, 
šode_bl
);

198 
šode
->
i_ùime
 = 
šode_bl
->i_ùimğ
	`cu¼’t_time
(inode);

200 
šode
->
i_g’”©iÚ
 = 
	`´ªdom_u32
();

201 
šode_bl
->
i_g’”©iÚ
 = 
	`´ªdom_u32
();

202 
	`»£t_šode_£ed
(
šode
);

203 
	`»£t_šode_£ed
(
šode_bl
);

205 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

207 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

208 ià(
”r
 < 0) {

210 
	`ext4_w¬nšg
(
šode
->
i_sb
,

212 
šode
->
i_šo
, 
”r
);

214 
	`sw­_šode_d©a
(
šode
, 
šode_bl
);

215 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

216 
”r_out1
;

219 
blocks
 = 
šode_bl
->
i_blocks
;

220 
by‹s
 = 
šode_bl
->
i_by‹s
;

221 
šode_bl
->
i_blocks
 = 
šode
->i_blocks;

222 
šode_bl
->
i_by‹s
 = 
šode
->i_bytes;

223 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode_bl
);

224 ià(
”r
 < 0) {

226 
	`ext4_w¬nšg
(
šode_bl
->
i_sb
,

228 
šode_bl
->
i_šo
, 
”r
);

229 
»v”t
;

233 ià(
diff
 > 0)

234 
	`dquÙ_ä“_¥aû
(
šode
, 
diff
);

236 
”r
 = 
	`dquÙ_®loc_¥aû
(
šode
, -1 * 
diff
);

238 ià(
”r
 < 0) {

239 
»v”t
:

241 
šode_bl
->
i_blocks
 = 
blocks
;

242 
šode_bl
->
i_by‹s
 = 
by‹s
;

243 
	`sw­_šode_d©a
(
šode
, 
šode_bl
);

244 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

245 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode_bl
);

248 
”r_out1
:

249 
	`ext4_jouº®_¡İ
(
hªdË
);

250 
	`ext4_doubË_up_wr™e_d©a_£m
(
šode
, 
šode_bl
);

252 
”r_out
:

253 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

254 
jouº®_”r_out
:

255 
	`uÆock_two_nÚdœeùÜ›s
(
šode
, 
šode_bl
);

256 
	`ut
(
šode_bl
);

257  
”r
;

258 
	}
}

260 #ifdeà
CONFIG_FS_ENCRYPTION


261 
	$uuid_is_z”o
(
__u8
 
u
[16])

263 
i
;

265 
i
 = 0; i < 16; i++)

266 ià(
u
[
i
])

269 
	}
}

277 
	$ext4_ioùl_check_immubË
(
šode
 *šode, 
__u32
 
Ãw_´ojid
,

278 
æags
)

280 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

281 
Şdæags
 = 
ei
->
i_æags
;

283 ià(!(
Şdæags
 & 
EXT4_IMMUTABLE_FL
è|| !(
æags
 & EXT4_IMMUTABLE_FL))

286 ià((
Şdæags
 & ~
EXT4_IMMUTABLE_FL
è!ğ(
æags
 & ~EXT4_IMMUTABLE_FL))

287  -
EPERM
;

288 ià(
	`ext4_has_ã©u»_´ojeù
(
šode
->
i_sb
) &&

289 
	`__k´ojid_v®
(
ei
->
i_´ojid
è!ğ
Ãw_´ojid
)

290  -
EPERM
;

293 
	}
}

295 
	$ext4_ioùl_£tæags
(
šode
 *inode,

296 
æags
)

298 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

299 
hªdË_t
 *
hªdË
 = 
NULL
;

300 
”r
 = -
EPERM
, 
mig¿‹
 = 0;

301 
ext4_oc
 
oc
;

302 
Şdæags
, 
mask
, 
i
;

303 
jæag
;

304 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

307 ià(
	`ext4_is_quÙa_fe
(
šode
))

308 
æags_out
;

310 
Şdæags
 = 
ei
->
i_æags
;

313 
jæag
 = 
æags
 & 
EXT4_JOURNAL_DATA_FL
;

315 
”r
 = 
	`vfs_ioc_£tæags_´•¬e
(
šode
, 
Şdæags
, 
æags
);

316 ià(
”r
)

317 
æags_out
;

323 ià((
jæag
 ^ 
Şdæags
è& (
EXT4_JOURNAL_DATA_FL
)) {

324 ià(!
	`ÿ·bË
(
CAP_SYS_RESOURCE
))

325 
æags_out
;

327 ià((
æags
 ^ 
Şdæags
è& 
EXT4_EXTENTS_FL
)

328 
mig¿‹
 = 1;

330 ià(
æags
 & 
EXT4_EOFBLOCKS_FL
) {

332 ià(!(
Şdæags
 & 
EXT4_EOFBLOCKS_FL
)) {

333 
”r
 = -
EOPNOTSUPP
;

334 
æags_out
;

336 } ià(
Şdæags
 & 
EXT4_EOFBLOCKS_FL
) {

337 
”r
 = 
	`ext4_Œunÿ‹
(
šode
);

338 ià(
”r
)

339 
æags_out
;

342 ià((
æags
 ^ 
Şdæags
è& 
EXT4_CASEFOLD_FL
) {

343 ià(!
	`ext4_has_ã©u»_ÿ£fŞd
(
sb
)) {

344 
”r
 = -
EOPNOTSUPP
;

345 
æags_out
;

348 ià(!
	`S_ISDIR
(
šode
->
i_mode
)) {

349 
”r
 = -
ENOTDIR
;

350 
æags_out
;

353 ià(!
	`ext4_em±y_dœ
(
šode
)) {

354 
”r
 = -
ENOTEMPTY
;

355 
æags_out
;

365 ià(
	`S_ISREG
(
šode
->
i_mode
è&& !
	`IS_IMMUTABLE
(inode) &&

366 (
æags
 & 
EXT4_IMMUTABLE_FL
)) {

367 
	`šode_dio_wa™
(
šode
);

368 
”r
 = 
	`fem­_wr™e_ªd_wa™
(
šode
->
i_m­pšg
);

369 ià(
”r
)

370 
æags_out
;

373 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 1);

374 ià(
	`IS_ERR
(
hªdË
)) {

375 
”r
 = 
	`PTR_ERR
(
hªdË
);

376 
æags_out
;

378 ià(
	`IS_SYNC
(
šode
))

379 
	`ext4_hªdË_sync
(
hªdË
);

380 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
);

381 ià(
”r
)

382 
æags_”r
;

384 
i
 = 0, 
mask
 = 1; i < 32; i++, mask <<= 1) {

385 ià(!(
mask
 & 
EXT4_FL_USER_MODIFIABLE
))

388 ià(
mask
 =ğ
EXT4_JOURNAL_DATA_FL
 || mask =ğ
EXT4_EXTENTS_FL
)

390 ià(
mask
 & 
æags
)

391 
	`ext4_£t_šode_æag
(
šode
, 
i
);

393 
	`ext4_ş—r_šode_æag
(
šode
, 
i
);

396 
	`ext4_£t_šode_æags
(
šode
);

397 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

399 
”r
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

400 
æags_”r
:

401 
	`ext4_jouº®_¡İ
(
hªdË
);

402 ià(
”r
)

403 
æags_out
;

405 ià((
jæag
 ^ 
Şdæags
è& (
EXT4_JOURNAL_DATA_FL
)) {

410 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DAX
)) {

411 
”r
 = -
EBUSY
;

412 
æags_out
;

415 
”r
 = 
	`ext4_chªge_šode_jouº®_æag
(
šode
, 
jæag
);

416 ià(
”r
)

417 
æags_out
;

419 ià(
mig¿‹
) {

420 ià(
æags
 & 
EXT4_EXTENTS_FL
)

421 
”r
 = 
	`ext4_ext_mig¿‹
(
šode
);

423 
”r
 = 
	`ext4_šd_mig¿‹
(
šode
);

426 
æags_out
:

427  
”r
;

428 
	}
}

430 #ifdeà
CONFIG_QUOTA


431 
	$ext4_ioùl_£rojeù
(
fe
 *
fp
, 
__u32
 
´ojid
)

433 
šode
 *šodğ
	`fe_šode
(
fp
);

434 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

435 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

436 
”r
, 
rc
;

437 
hªdË_t
 *
hªdË
;

438 
k´ojid_t
 
k´ojid
;

439 
ext4_oc
 
oc
;

440 
ext4_šode
 *
¿w_šode
;

441 
dquÙ
 *
Œªsãr_to
[
MAXQUOTAS
] = { };

443 ià(!
	`ext4_has_ã©u»_´ojeù
(
sb
)) {

444 ià(
´ojid
 !ğ
EXT4_DEF_PROJID
)

445  -
EOPNOTSUPP
;

450 ià(
	`EXT4_INODE_SIZE
(
sb
è<ğ
EXT4_GOOD_OLD_INODE_SIZE
)

451  -
EOPNOTSUPP
;

453 
k´ojid
 = 
	`make_k´ojid
(&
š™_u£r_ns
, (
´ojid_t
)
´ojid
);

455 ià(
	`´ojid_eq
(
k´ojid
, 
	`EXT4_I
(
šode
)->
i_´ojid
))

458 
”r
 = -
EPERM
;

460 ià(
	`ext4_is_quÙa_fe
(
šode
))

461  
”r
;

463 
”r
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

464 ià(
”r
)

465  
”r
;

467 
¿w_šode
 = 
	`ext4_¿w_šode
(&
oc
);

468 ià(!
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ei
, 
i_´ojid
)) {

469 
”r
 = 
	`ext4_ex·nd_exŒa_isize
(
šode
,

470 
	`EXT4_SB
(
sb
)->
s_wªt_exŒa_isize
,

471 &
oc
);

472 ià(
”r
)

473  
”r
;

475 
	`b»l£
(
oc
.
bh
);

478 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

479 ià(
”r
)

480  
”r
;

482 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_QUOTA
,

483 
	`EXT4_QUOTA_INIT_BLOCKS
(
sb
) +

484 
	`EXT4_QUOTA_DEL_BLOCKS
(
sb
) + 3);

485 ià(
	`IS_ERR
(
hªdË
))

486  
	`PTR_ERR
(
hªdË
);

488 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
);

489 ià(
”r
)

490 
out_¡İ
;

492 
Œªsãr_to
[
PRJQUOTA
] = 
	`dqg‘
(
sb
, 
	`make_kqid_´ojid
(
k´ojid
));

493 ià(!
	`IS_ERR
(
Œªsãr_to
[
PRJQUOTA
])) {

498 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

499 
”r
 = 
	`__dquÙ_Œªsãr
(
šode
, 
Œªsãr_to
);

500 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

501 
	`dqput
(
Œªsãr_to
[
PRJQUOTA
]);

502 ià(
”r
)

503 
out_dœty
;

506 
	`EXT4_I
(
šode
)->
i_´ojid
 = 
k´ojid
;

507 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

508 
out_dœty
:

509 
rc
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

510 ià(!
”r
)

511 
”r
 = 
rc
;

512 
out_¡İ
:

513 
	`ext4_jouº®_¡İ
(
hªdË
);

514  
”r
;

515 
	}
}

517 
	$ext4_ioùl_£rojeù
(
fe
 *
fp
, 
__u32
 
´ojid
)

519 ià(
´ojid
 !ğ
EXT4_DEF_PROJID
)

520  -
EOPNOTSUPP
;

522 
	}
}

526 
šlše
 
__u32
 
	$ext4_iæags_to_xæags
(
iæags
)

528 
__u32
 
xæags
 = 0;

530 ià(
iæags
 & 
EXT4_SYNC_FL
)

531 
xæags
 |ğ
FS_XFLAG_SYNC
;

532 ià(
iæags
 & 
EXT4_IMMUTABLE_FL
)

533 
xæags
 |ğ
FS_XFLAG_IMMUTABLE
;

534 ià(
iæags
 & 
EXT4_APPEND_FL
)

535 
xæags
 |ğ
FS_XFLAG_APPEND
;

536 ià(
iæags
 & 
EXT4_NODUMP_FL
)

537 
xæags
 |ğ
FS_XFLAG_NODUMP
;

538 ià(
iæags
 & 
EXT4_NOATIME_FL
)

539 
xæags
 |ğ
FS_XFLAG_NOATIME
;

540 ià(
iæags
 & 
EXT4_PROJINHERIT_FL
)

541 
xæags
 |ğ
FS_XFLAG_PROJINHERIT
;

542  
xæags
;

543 
	}
}

545 
	#EXT4_SUPPORTED_FS_XFLAGS
 (
FS_XFLAG_SYNC
 | 
FS_XFLAG_IMMUTABLE
 | \

546 
FS_XFLAG_APPEND
 | 
FS_XFLAG_NODUMP
 | \

547 
FS_XFLAG_NOATIME
 | 
FS_XFLAG_PROJINHERIT
)

	)

550 
šlše
 
	$ext4_xæags_to_iæags
(
__u32
 
xæags
)

552 
iæags
 = 0;

554 ià(
xæags
 & 
FS_XFLAG_SYNC
)

555 
iæags
 |ğ
EXT4_SYNC_FL
;

556 ià(
xæags
 & 
FS_XFLAG_IMMUTABLE
)

557 
iæags
 |ğ
EXT4_IMMUTABLE_FL
;

558 ià(
xæags
 & 
FS_XFLAG_APPEND
)

559 
iæags
 |ğ
EXT4_APPEND_FL
;

560 ià(
xæags
 & 
FS_XFLAG_NODUMP
)

561 
iæags
 |ğ
EXT4_NODUMP_FL
;

562 ià(
xæags
 & 
FS_XFLAG_NOATIME
)

563 
iæags
 |ğ
EXT4_NOATIME_FL
;

564 ià(
xæags
 & 
FS_XFLAG_PROJINHERIT
)

565 
iæags
 |ğ
EXT4_PROJINHERIT_FL
;

567  
iæags
;

568 
	}
}

570 
	$ext4_shutdown
(
su³r_block
 *
sb
, 
¬g
)

572 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

573 
__u32
 
æags
;

575 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

576  -
EPERM
;

578 ià(
	`g‘_u£r
(
æags
, (
__u32
 
__u£r
 *)
¬g
))

579  -
EFAULT
;

581 ià(
æags
 > 
EXT4_GOING_FLAGS_NOLOGFLUSH
)

582  -
EINVAL
;

584 ià(
	`ext4_fÜûd_shutdown
(
sbi
))

587 
	`ext4_msg
(
sb
, 
KERN_ALERT
, "shuˆdowÀ»que¡ed (%d)", 
æags
);

588 
	`Œaû_ext4_shutdown
(
sb
, 
æags
);

590 
æags
) {

591 
EXT4_GOING_FLAGS_DEFAULT
:

592 
	`ä“ze_bdev
(
sb
->
s_bdev
);

593 
	`£t_b™
(
EXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_ext4_æags
);

594 
	`thaw_bdev
(
sb
->
s_bdev
, sb);

596 
EXT4_GOING_FLAGS_LOGFLUSH
:

597 
	`£t_b™
(
EXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_ext4_æags
);

598 ià(
sbi
->
s_jouº®
 && !
	`is_jouº®_abÜ‹d
(sbi->s_journal)) {

599 (è
	`ext4_fÜû_comm™
(
sb
);

600 
	`jbd2_jouº®_abÜt
(
sbi
->
s_jouº®
, -
ESHUTDOWN
);

603 
EXT4_GOING_FLAGS_NOLOGFLUSH
:

604 
	`£t_b™
(
EXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_ext4_æags
);

605 ià(
sbi
->
s_jouº®
 && !
	`is_jouº®_abÜ‹d
(sbi->s_journal))

606 
	`jbd2_jouº®_abÜt
(
sbi
->
s_jouº®
, -
ESHUTDOWN
);

609  -
EINVAL
;

611 
	`ş—r_İt
(
sb
, 
DISCARD
);

613 
	}
}

615 
	sg‘fsm­_šfo
 {

616 
su³r_block
 *
	mgi_sb
;

617 
fsm­_h—d
 
__u£r
 *
	mgi_d©a
;

618 
	mgi_idx
;

619 
__u32
 
	mgi_Ï¡_æags
;

622 
	$ext4_g‘fsm­_fÜm©
(
ext4_fsm­
 *
xfm
, *
´iv
)

624 
g‘fsm­_šfo
 *
šfo
 = 
´iv
;

625 
fsm­
 
fm
;

627 
	`Œaû_ext4_g‘fsm­_m­pšg
(
šfo
->
gi_sb
, 
xfm
);

629 
šfo
->
gi_Ï¡_æags
 = 
xfm
->
fmr_æags
;

630 
	`ext4_fsm­_äom_š‹º®
(
šfo
->
gi_sb
, &
fm
, 
xfm
);

631 ià(
	`cİy_to_u£r
(&
šfo
->
gi_d©a
->
fmh_»cs
[šfo->
gi_idx
++], &
fm
,

632 (
fsm­
)))

633  -
EFAULT
;

636 
	}
}

638 
	$ext4_ioc_g‘fsm­
(
su³r_block
 *
sb
,

639 
fsm­_h—d
 
__u£r
 *
¬g
)

641 
g‘fsm­_šfo
 
šfo
 = { 
NULL
 };

642 
ext4_fsm­_h—d
 
xh—d
 = {0};

643 
fsm­_h—d
 
h—d
;

644 
boŞ
 
abÜ‹d
 = 
çl£
;

645 
”rÜ
;

647 ià(
	`cİy_äom_u£r
(&
h—d
, 
¬g
, (
fsm­_h—d
)))

648  -
EFAULT
;

649 ià(
	`memchr_šv
(
h—d
.
fmh_»£rved
, 0, (head.fmh_reserved)) ||

650 
	`memchr_šv
(
h—d
.
fmh_keys
[0].
fmr_»£rved
, 0,

651 (
h—d
.
fmh_keys
[0].
fmr_»£rved
)) ||

652 
	`memchr_šv
(
h—d
.
fmh_keys
[1].
fmr_»£rved
, 0,

653 (
h—d
.
fmh_keys
[1].
fmr_»£rved
)))

654  -
EINVAL
;

659 ià(
h—d
.
fmh_keys
[0].
fmr_off£t
 ||

660 (
h—d
.
fmh_keys
[1].
fmr_off£t
 != 0 &&

661 
h—d
.
fmh_keys
[1].
fmr_off£t
 != -1ULL))

662  -
EINVAL
;

664 
xh—d
.
fmh_iæags
 = 
h—d
.fmh_iflags;

665 
xh—d
.
fmh_couÁ
 = 
h—d
.fmh_count;

666 
	`ext4_fsm­_to_š‹º®
(
sb
, &
xh—d
.
fmh_keys
[0], &
h—d
.fmh_keys[0]);

667 
	`ext4_fsm­_to_š‹º®
(
sb
, &
xh—d
.
fmh_keys
[1], &
h—d
.fmh_keys[1]);

669 
	`Œaû_ext4_g‘fsm­_low_key
(
sb
, &
xh—d
.
fmh_keys
[0]);

670 
	`Œaû_ext4_g‘fsm­_high_key
(
sb
, &
xh—d
.
fmh_keys
[1]);

672 
šfo
.
gi_sb
 = 
sb
;

673 
šfo
.
gi_d©a
 = 
¬g
;

674 
”rÜ
 = 
	`ext4_g‘fsm­
(
sb
, &
xh—d
, 
ext4_g‘fsm­_fÜm©
, &
šfo
);

675 ià(
”rÜ
 =ğ
EXT4_QUERY_RANGE_ABORT
) {

676 
”rÜ
 = 0;

677 
abÜ‹d
 = 
Œue
;

678 } ià(
”rÜ
)

679  
”rÜ
;

682 ià(!
abÜ‹d
 && 
šfo
.
gi_idx
) {

683 
šfo
.
gi_Ï¡_æags
 |ğ
FMR_OF_LAST
;

684 ià(
	`cİy_to_u£r
(&
šfo
.
gi_d©a
->
fmh_»cs
[šfo.
gi_idx
 - 1].
fmr_æags
,

685 &
šfo
.
gi_Ï¡_æags
,

686 (
šfo
.
gi_Ï¡_æags
)))

687  -
EFAULT
;

691 
h—d
.
fmh_’Œ›s
 = 
xh—d
.fmh_entries;

692 
h—d
.
fmh_oæags
 = 
xh—d
.fmh_oflags;

693 ià(
	`cİy_to_u£r
(
¬g
, &
h—d
, (
fsm­_h—d
)))

694  -
EFAULT
;

697 
	}
}

699 
	$ext4_ioùl_group_add
(
fe
 *file,

700 
ext4_Ãw_group_d©a
 *
šput
)

702 
su³r_block
 *
sb
 = 
	`fe_šode
(
fe
)->
i_sb
;

703 
”r
, 
”r2
=0;

705 
”r
 = 
	`ext4_»size_begš
(
sb
);

706 ià(
”r
)

707  
”r
;

709 ià(
	`ext4_has_ã©u»_big®loc
(
sb
)) {

710 
	`ext4_msg
(
sb
, 
KERN_ERR
,

712 
”r
 = -
EOPNOTSUPP
;

713 
group_add_out
;

716 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

717 ià(
”r
)

718 
group_add_out
;

720 
”r
 = 
	`ext4_group_add
(
sb
, 
šput
);

721 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
) {

722 
	`jbd2_jouº®_lock_upd©es
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

723 
”r2
 = 
	`jbd2_jouº®_æush
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

724 
	`jbd2_jouº®_uÆock_upd©es
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

726 ià(
”r
 == 0)

727 
”r
 = 
”r2
;

728 
	`mÁ_drİ_wr™e_fe
(
fe
);

729 ià(!
”r
 && 
	`ext4_has_group_desc_csum
(
sb
) &&

730 
	`‹¡_İt
(
sb
, 
INIT_INODE_TABLE
))

731 
”r
 = 
	`ext4_»gi¡”_li_»que¡
(
sb
, 
šput
->
group
);

732 
group_add_out
:

733 
	`ext4_»size_’d
(
sb
);

734  
”r
;

735 
	}
}

737 
	$ext4_fl_fsx©Œ
(
šode
 *šode, 
fsx©Œ
 *
ç
)

739 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

741 
	`sim¶e_fl_fsx©Œ
(
ç
, 
	`ext4_iæags_to_xæags
(
ei
->
i_æags
 &

742 
EXT4_FL_USER_VISIBLE
));

744 ià(
	`ext4_has_ã©u»_´ojeù
(
šode
->
i_sb
))

745 
ç
->
fsx_´ojid
 = 
	`äom_k´ojid
(&
š™_u£r_ns
, 
ei
->
i_´ojid
);

746 
	}
}

749 
	$f›m­_check_¿nges
(
su³r_block
 *
sb
,

750 
u64
 
¡¬t
, u64 
Ën
, u64 *
Ãw_Ën
)

752 
u64
 
maxby‹s
 = (u64è
sb
->
s_maxby‹s
;

754 *
Ãw_Ën
 = 
Ën
;

756 ià(
Ën
 == 0)

757  -
EINVAL
;

759 ià(
¡¬t
 > 
maxby‹s
)

760  -
EFBIG
;

765 ià(
Ën
 > 
maxby‹s
 || (maxby‹ -†’è< 
¡¬t
)

766 *
Ãw_Ën
 = 
maxby‹s
 - 
¡¬t
;

769 
	}
}

772 
	#FIEMAP_MAX_EXTENTS
 (
UINT_MAX
 / (
f›m­_ex‹Á
))

	)

774 
	$ext4_ioùl_g‘_es_ÿche
(
fe
 *
fp
, 
¬g
)

776 
f›m­
 fiemap;

777 
f›m­
 
__u£r
 *
uf›m­
 = (f›m­ __u£¸*è
¬g
;

778 
f›m­_ex‹Á_šfo
 
f›šfo
 = { 0, };

779 
šode
 *šodğ
	`fe_šode
(
fp
);

780 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

781 
u64
 
Ën
;

782 
”rÜ
;

784 ià(
	`cİy_äom_u£r
(&
f›m­
, 
uf›m­
, (fiemap)))

785  -
EFAULT
;

787 ià(
f›m­
.
fm_ex‹Á_couÁ
 > 
FIEMAP_MAX_EXTENTS
)

788  -
EINVAL
;

790 
”rÜ
 = 
	`f›m­_check_¿nges
(
sb
, 
f›m­
.
fm_¡¬t
, f›m­.
fm_Ëngth
,

791 &
Ën
);

792 ià(
”rÜ
)

793  
”rÜ
;

795 
f›šfo
.
fi_æags
 = 
f›m­
.
fm_æags
;

796 
f›šfo
.
fi_ex‹Ás_max
 = 
f›m­
.
fm_ex‹Á_couÁ
;

797 
f›šfo
.
fi_ex‹Ás_¡¬t
 = 
uf›m­
->
fm_ex‹Ás
;

799 ià(
f›m­
.
fm_ex‹Á_couÁ
 != 0 &&

800 !
	`acûss_ok
(
f›šfo
.
fi_ex‹Ás_¡¬t
,

801 
f›šfo
.
fi_ex‹Ás_max
 * (
f›m­_ex‹Á
)))

802  -
EFAULT
;

804 ià(
f›šfo
.
fi_æags
 & 
FIEMAP_FLAG_SYNC
)

805 
	`fem­_wr™e_ªd_wa™
(
šode
->
i_m­pšg
);

807 
”rÜ
 = 
	`ext4_g‘_es_ÿche
(
šode
, &
f›šfo
, 
f›m­
.
fm_¡¬t
, 
Ën
);

808 
f›m­
.
fm_æags
 = 
f›šfo
.
fi_æags
;

809 
f›m­
.
fm_m­³d_ex‹Ás
 = 
f›šfo
.
fi_ex‹Ás_m­³d
;

810 ià(
	`cİy_to_u£r
(
uf›m­
, &
f›m­
, (fiemap)))

811 
”rÜ
 = -
EFAULT
;

813  
”rÜ
;

814 
	}
}

816 
	$ext4_ioùl
(
fe
 *
fp
, 
cmd
, 
¬g
)

818 
šode
 *šodğ
	`fe_šode
(
fp
);

819 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

820 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

821 
æags
;

823 
	`ext4_debug
("cmd = %u,‡rg = %lu\n", 
cmd
, 
¬g
);

825 
cmd
) {

826 
FS_IOC_GETFSMAP
:

827  
	`ext4_ioc_g‘fsm­
(
sb
, (
__u£r
 *)
¬g
);

828 
EXT4_IOC_GETFLAGS
:

829 
æags
 = 
ei
->
i_æags
 & 
EXT4_FL_USER_VISIBLE
;

830 ià(
	`S_ISREG
(
šode
->
i_mode
))

831 
æags
 &ğ~
EXT4_PROJINHERIT_FL
;

832  
	`put_u£r
(
æags
, (
__u£r
 *è
¬g
);

833 
EXT4_IOC_SETFLAGS
: {

834 
”r
;

836 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

837  -
EACCES
;

839 ià(
	`g‘_u£r
(
æags
, (
__u£r
 *è
¬g
))

840  -
EFAULT
;

842 ià(
æags
 & ~
EXT4_FL_USER_VISIBLE
)

843  -
EOPNOTSUPP
;

850 
æags
 &ğ
EXT4_FL_USER_MODIFIABLE
;

851 ià(
	`ext4_mask_æags
(
šode
->
i_mode
, 
æags
) != flags)

852  -
EOPNOTSUPP
;

854 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

855 ià(
”r
)

856  
”r
;

858 
	`šode_lock
(
šode
);

859 
”r
 = 
	`ext4_ioùl_check_immubË
(
šode
,

860 
	`äom_k´ojid
(&
š™_u£r_ns
, 
ei
->
i_´ojid
),

861 
æags
);

862 ià(!
”r
)

863 
”r
 = 
	`ext4_ioùl_£tæags
(
šode
, 
æags
);

864 
	`šode_uÆock
(
šode
);

865 
	`mÁ_drİ_wr™e_fe
(
fp
);

866  
”r
;

868 
EXT4_IOC_GETVERSION
:

869 
EXT4_IOC_GETVERSION_OLD
:

870  
	`put_u£r
(
šode
->
i_g’”©iÚ
, (
__u£r
 *è
¬g
);

871 
EXT4_IOC_SETVERSION
:

872 
EXT4_IOC_SETVERSION_OLD
: {

873 
hªdË_t
 *
hªdË
;

874 
ext4_oc
 
oc
;

875 
__u32
 
g’”©iÚ
;

876 
”r
;

878 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

879  -
EPERM
;

881 ià(
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
)) {

882 
	`ext4_w¬nšg
(
sb
, "Setting inode version is‚ot "

884  -
ENOTTY
;

887 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

888 ià(
”r
)

889  
”r
;

890 ià(
	`g‘_u£r
(
g’”©iÚ
, (
__u£r
 *è
¬g
)) {

891 
”r
 = -
EFAULT
;

892 
£tv”siÚ_out
;

895 
	`šode_lock
(
šode
);

896 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 1);

897 ià(
	`IS_ERR
(
hªdË
)) {

898 
”r
 = 
	`PTR_ERR
(
hªdË
);

899 
uÆock_out
;

901 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
);

902 ià(
”r
 == 0) {

903 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

904 
šode
->
i_g’”©iÚ
 = 
g’”©iÚ
;

905 
”r
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

907 
	`ext4_jouº®_¡İ
(
hªdË
);

909 
uÆock_out
:

910 
	`šode_uÆock
(
šode
);

911 
£tv”siÚ_out
:

912 
	`mÁ_drİ_wr™e_fe
(
fp
);

913  
”r
;

915 
EXT4_IOC_GROUP_EXTEND
: {

916 
ext4_fsblk_t
 
n_blocks_couÁ
;

917 
”r
, 
”r2
=0;

919 
”r
 = 
	`ext4_»size_begš
(
sb
);

920 ià(
”r
)

921  
”r
;

923 ià(
	`g‘_u£r
(
n_blocks_couÁ
, (
__u32
 
__u£r
 *)
¬g
)) {

924 
”r
 = -
EFAULT
;

925 
group_ex‹nd_out
;

928 ià(
	`ext4_has_ã©u»_big®loc
(
sb
)) {

929 
	`ext4_msg
(
sb
, 
KERN_ERR
,

931 
”r
 = -
EOPNOTSUPP
;

932 
group_ex‹nd_out
;

935 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

936 ià(
”r
)

937 
group_ex‹nd_out
;

939 
”r
 = 
	`ext4_group_ex‹nd
(
sb
, 
	`EXT4_SB
(sb)->
s_es
, 
n_blocks_couÁ
);

940 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
) {

941 
	`jbd2_jouº®_lock_upd©es
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

942 
”r2
 = 
	`jbd2_jouº®_æush
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

943 
	`jbd2_jouº®_uÆock_upd©es
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

945 ià(
”r
 == 0)

946 
”r
 = 
”r2
;

947 
	`mÁ_drİ_wr™e_fe
(
fp
);

948 
group_ex‹nd_out
:

949 
	`ext4_»size_’d
(
sb
);

950  
”r
;

953 
EXT4_IOC_MOVE_EXT
: {

954 
move_ex‹Á
 
me
;

955 
fd
 
dÚÜ
;

956 
”r
;

958 ià(!(
fp
->
f_mode
 & 
FMODE_READ
) ||

959 !(
fp
->
f_mode
 & 
FMODE_WRITE
))

960  -
EBADF
;

962 ià(
	`cİy_äom_u£r
(&
me
,

963 (
move_ex‹Á
 
__u£r
 *)
¬g
, (
me
)))

964  -
EFAULT
;

965 
me
.
moved_Ën
 = 0;

967 
dÚÜ
 = 
	`fdg‘
(
me
.
dÚÜ_fd
);

968 ià(!
dÚÜ
.
fe
)

969  -
EBADF
;

971 ià(!(
dÚÜ
.
fe
->
f_mode
 & 
FMODE_WRITE
)) {

972 
”r
 = -
EBADF
;

973 
mext_out
;

976 ià(
	`ext4_has_ã©u»_big®loc
(
sb
)) {

977 
	`ext4_msg
(
sb
, 
KERN_ERR
,

979 
”r
 = -
EOPNOTSUPP
;

980 
mext_out
;

981 } ià(
	`IS_DAX
(
šode
)) {

982 
	`ext4_msg
(
sb
, 
KERN_ERR
,

984 
”r
 = -
EOPNOTSUPP
;

985 
mext_out
;

988 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

989 ià(
”r
)

990 
mext_out
;

992 
”r
 = 
	`ext4_move_ex‹Ás
(
fp
, 
dÚÜ
.
fe
, 
me
.
Üig_¡¬t
,

993 
me
.
dÚÜ_¡¬t
, me.
Ën
, &me.
moved_Ën
);

994 
	`mÁ_drİ_wr™e_fe
(
fp
);

996 ià(
	`cİy_to_u£r
((
move_ex‹Á
 
__u£r
 *)
¬g
,

997 &
me
, (me)))

998 
”r
 = -
EFAULT
;

999 
mext_out
:

1000 
	`fdput
(
dÚÜ
);

1001  
”r
;

1004 
EXT4_IOC_GROUP_ADD
: {

1005 
ext4_Ãw_group_d©a
 
šput
;

1007 ià(
	`cİy_äom_u£r
(&
šput
, (
ext4_Ãw_group_šput
 
__u£r
 *)
¬g
,

1008 (
šput
)))

1009  -
EFAULT
;

1011  
	`ext4_ioùl_group_add
(
fp
, &
šput
);

1014 
EXT4_IOC_MIGRATE
:

1016 
”r
;

1017 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1018  -
EACCES
;

1020 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1021 ià(
”r
)

1022  
”r
;

1029 
	`šode_lock
((
šode
));

1030 
”r
 = 
	`ext4_ext_mig¿‹
(
šode
);

1031 
	`šode_uÆock
((
šode
));

1032 
	`mÁ_drİ_wr™e_fe
(
fp
);

1033  
”r
;

1036 
EXT4_IOC_ALLOC_DA_BLKS
:

1038 
”r
;

1039 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1040  -
EACCES
;

1042 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1043 ià(
”r
)

1044  
”r
;

1045 
”r
 = 
	`ext4_®loc_da_blocks
(
šode
);

1046 
	`mÁ_drİ_wr™e_fe
(
fp
);

1047  
”r
;

1050 
EXT4_IOC_SWAP_BOOT
:

1052 
”r
;

1053 ià(!(
fp
->
f_mode
 & 
FMODE_WRITE
))

1054  -
EBADF
;

1055 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1056 ià(
”r
)

1057  
”r
;

1058 
”r
 = 
	`sw­_šode_boÙ_lßd”
(
sb
, 
šode
);

1059 
	`mÁ_drİ_wr™e_fe
(
fp
);

1060  
”r
;

1063 
EXT4_IOC_RESIZE_FS
: {

1064 
ext4_fsblk_t
 
n_blocks_couÁ
;

1065 
”r
 = 0, 
”r2
 = 0;

1066 
ext4_group_t
 
o_group
 = 
	`EXT4_SB
(
sb
)->
s_groups_couÁ
;

1068 ià(
	`cİy_äom_u£r
(&
n_blocks_couÁ
, (
__u64
 
__u£r
 *)
¬g
,

1069 (
__u64
))) {

1070  -
EFAULT
;

1073 
”r
 = 
	`ext4_»size_begš
(
sb
);

1074 ià(
”r
)

1075  
”r
;

1077 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1078 ià(
”r
)

1079 
»sizefs_out
;

1081 
”r
 = 
	`ext4_»size_fs
(
sb
, 
n_blocks_couÁ
);

1082 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
) {

1083 
	`jbd2_jouº®_lock_upd©es
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

1084 
”r2
 = 
	`jbd2_jouº®_æush
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

1085 
	`jbd2_jouº®_uÆock_upd©es
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

1087 ià(
”r
 == 0)

1088 
”r
 = 
”r2
;

1089 
	`mÁ_drİ_wr™e_fe
(
fp
);

1090 ià(!
”r
 && (
o_group
 < 
	`EXT4_SB
(
sb
)->
s_groups_couÁ
) &&

1091 
	`ext4_has_group_desc_csum
(
sb
) &&

1092 
	`‹¡_İt
(
sb
, 
INIT_INODE_TABLE
))

1093 
”r
 = 
	`ext4_»gi¡”_li_»que¡
(
sb
, 
o_group
);

1095 
»sizefs_out
:

1096 
	`ext4_»size_’d
(
sb
);

1097  
”r
;

1100 
FITRIM
:

1102 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
sb
->
s_bdev
);

1103 
f¡rim_¿nge
 
¿nge
;

1104 
»t
 = 0;

1106 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1107  -
EPERM
;

1109 ià(!
	`blk_queue_disÿrd
(
q
))

1110  -
EOPNOTSUPP
;

1116 ià(
	`‹¡_İt
(
sb
, 
NOLOAD
è&& 
	`ext4_has_ã©u»_jouº®
(sb))

1117  -
EROFS
;

1119 ià(
	`cİy_äom_u£r
(&
¿nge
, (
f¡rim_¿nge
 
__u£r
 *)
¬g
,

1120 (
¿nge
)))

1121  -
EFAULT
;

1123 
¿nge
.
mšËn
 = 
	`max
(()range.minlen,

1124 
q
->
lim™s
.
disÿrd_g¿nuÏr™y
);

1125 
»t
 = 
	`ext4_Œim_fs
(
sb
, &
¿nge
);

1126 ià(
»t
 < 0)

1127  
»t
;

1129 ià(
	`cİy_to_u£r
((
f¡rim_¿nge
 
__u£r
 *)
¬g
, &
¿nge
,

1130 (
¿nge
)))

1131  -
EFAULT
;

1135 
EXT4_IOC_PRECACHE_EXTENTS
:

1136  
	`ext4_ext_´eÿche
(
šode
);

1138 
EXT4_IOC_SET_ENCRYPTION_POLICY
:

1139 ià(!
	`ext4_has_ã©u»_’üy±
(
sb
))

1140  -
EOPNOTSUPP
;

1141  
	`fsüy±_ioùl_£t_pŞicy
(
fp
, (cÚ¡ 
__u£r
 *)
¬g
);

1143 
EXT4_IOC_GET_ENCRYPTION_PWSALT
: {

1144 #ifdeà
CONFIG_FS_ENCRYPTION


1145 
”r
, 
”r2
;

1146 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1147 
hªdË_t
 *
hªdË
;

1149 ià(!
	`ext4_has_ã©u»_’üy±
(
sb
))

1150  -
EOPNOTSUPP
;

1151 ià(
	`uuid_is_z”o
(
sbi
->
s_es
->
s_’üy±_pw_§É
)) {

1152 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1153 ià(
”r
)

1154  
”r
;

1155 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_MISC
, 1);

1156 ià(
	`IS_ERR
(
hªdË
)) {

1157 
”r
 = 
	`PTR_ERR
(
hªdË
);

1158 
pw§É_”r_ex™
;

1160 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
sbi
->
s_sbh
);

1161 ià(
”r
)

1162 
pw§É_”r_jouº®
;

1163 
	`g’”©e_¿ndom_uuid
(
sbi
->
s_es
->
s_’üy±_pw_§É
);

1164 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
,

1165 
sbi
->
s_sbh
);

1166 
pw§É_”r_jouº®
:

1167 
”r2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

1168 ià(
”r2
 && !
”r
)

1169 
”r
 = 
”r2
;

1170 
pw§É_”r_ex™
:

1171 
	`mÁ_drİ_wr™e_fe
(
fp
);

1172 ià(
”r
)

1173  
”r
;

1175 ià(
	`cİy_to_u£r
((
__u£r
 *è
¬g
,

1176 
sbi
->
s_es
->
s_’üy±_pw_§É
, 16))

1177  -
EFAULT
;

1180  -
EOPNOTSUPP
;

1183 
EXT4_IOC_GET_ENCRYPTION_POLICY
:

1184 ià(!
	`ext4_has_ã©u»_’üy±
(
sb
))

1185  -
EOPNOTSUPP
;

1186  
	`fsüy±_ioùl_g‘_pŞicy
(
fp
, (
__u£r
 *)
¬g
);

1188 
FS_IOC_GET_ENCRYPTION_POLICY_EX
:

1189 ià(!
	`ext4_has_ã©u»_’üy±
(
sb
))

1190  -
EOPNOTSUPP
;

1191  
	`fsüy±_ioùl_g‘_pŞicy_ex
(
fp
, (
__u£r
 *)
¬g
);

1193 
FS_IOC_ADD_ENCRYPTION_KEY
:

1194 ià(!
	`ext4_has_ã©u»_’üy±
(
sb
))

1195  -
EOPNOTSUPP
;

1196  
	`fsüy±_ioùl_add_key
(
fp
, (
__u£r
 *)
¬g
);

1198 
FS_IOC_REMOVE_ENCRYPTION_KEY
:

1199 ià(!
	`ext4_has_ã©u»_’üy±
(
sb
))

1200  -
EOPNOTSUPP
;

1201  
	`fsüy±_ioùl_»move_key
(
fp
, (
__u£r
 *)
¬g
);

1203 
FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
:

1204 ià(!
	`ext4_has_ã©u»_’üy±
(
sb
))

1205  -
EOPNOTSUPP
;

1206  
	`fsüy±_ioùl_»move_key_®l_u£rs
(
fp
,

1207 (
__u£r
 *)
¬g
);

1208 
FS_IOC_GET_ENCRYPTION_KEY_STATUS
:

1209 ià(!
	`ext4_has_ã©u»_’üy±
(
sb
))

1210  -
EOPNOTSUPP
;

1211  
	`fsüy±_ioùl_g‘_key_¡©us
(
fp
, (
__u£r
 *)
¬g
);

1213 
EXT4_IOC_CLEAR_ES_CACHE
:

1215 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1216  -
EACCES
;

1217 
	`ext4_ş—r_šode_es
(
šode
);

1221 
EXT4_IOC_GETSTATE
:

1223 
__u32
 
¡©e
 = 0;

1225 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_EXT_PRECACHED
))

1226 
¡©e
 |ğ
EXT4_STATE_FLAG_EXT_PRECACHED
;

1227 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NEW
))

1228 
¡©e
 |ğ
EXT4_STATE_FLAG_NEW
;

1229 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NEWENTRY
))

1230 
¡©e
 |ğ
EXT4_STATE_FLAG_NEWENTRY
;

1231 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_DA_ALLOC_CLOSE
))

1232 
¡©e
 |ğ
EXT4_STATE_FLAG_DA_ALLOC_CLOSE
;

1234  
	`put_u£r
(
¡©e
, (
__u32
 
__u£r
 *è
¬g
);

1237 
EXT4_IOC_GET_ES_CACHE
:

1238  
	`ext4_ioùl_g‘_es_ÿche
(
fp
, 
¬g
);

1240 
EXT4_IOC_FSGETXATTR
:

1242 
fsx©Œ
 
ç
;

1244 
	`ext4_fl_fsx©Œ
(
šode
, &
ç
);

1246 ià(
	`cİy_to_u£r
((
fsx©Œ
 
__u£r
 *)
¬g
,

1247 &
ç
, (fa)))

1248  -
EFAULT
;

1251 
EXT4_IOC_FSSETXATTR
:

1253 
fsx©Œ
 
ç
, 
Şd_ç
;

1254 
”r
;

1256 ià(
	`cİy_äom_u£r
(&
ç
, (
fsx©Œ
 
__u£r
 *)
¬g
,

1257 (
ç
)))

1258  -
EFAULT
;

1261 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1262  -
EACCES
;

1264 ià(
ç
.
fsx_xæags
 & ~
EXT4_SUPPORTED_FS_XFLAGS
)

1265  -
EOPNOTSUPP
;

1267 
æags
 = 
	`ext4_xæags_to_iæags
(
ç
.
fsx_xæags
);

1268 ià(
	`ext4_mask_æags
(
šode
->
i_mode
, 
æags
) != flags)

1269  -
EOPNOTSUPP
;

1271 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1272 ià(
”r
)

1273  
”r
;

1275 
	`šode_lock
(
šode
);

1276 
	`ext4_fl_fsx©Œ
(
šode
, &
Şd_ç
);

1277 
”r
 = 
	`vfs_ioc_fs£tx©Œ_check
(
šode
, &
Şd_ç
, &
ç
);

1278 ià(
”r
)

1279 
out
;

1280 
æags
 = (
ei
->
i_æags
 & ~
EXT4_FL_XFLAG_VISIBLE
) |

1281 (
æags
 & 
EXT4_FL_XFLAG_VISIBLE
);

1282 
”r
 = 
	`ext4_ioùl_check_immubË
(
šode
, 
ç
.
fsx_´ojid
, 
æags
);

1283 ià(
”r
)

1284 
out
;

1285 
”r
 = 
	`ext4_ioùl_£tæags
(
šode
, 
æags
);

1286 ià(
”r
)

1287 
out
;

1288 
”r
 = 
	`ext4_ioùl_£rojeù
(
fp
, 
ç
.
fsx_´ojid
);

1289 
out
:

1290 
	`šode_uÆock
(
šode
);

1291 
	`mÁ_drİ_wr™e_fe
(
fp
);

1292  
”r
;

1294 
EXT4_IOC_SHUTDOWN
:

1295  
	`ext4_shutdown
(
sb
, 
¬g
);

1297 
FS_IOC_ENABLE_VERITY
:

1298 ià(!
	`ext4_has_ã©u»_v”™y
(
sb
))

1299  -
EOPNOTSUPP
;

1300  
	`fsv”™y_ioùl_’abË
(
fp
, (cÚ¡ 
__u£r
 *)
¬g
);

1302 
FS_IOC_MEASURE_VERITY
:

1303 ià(!
	`ext4_has_ã©u»_v”™y
(
sb
))

1304  -
EOPNOTSUPP
;

1305  
	`fsv”™y_ioùl_m—su»
(
fp
, (
__u£r
 *)
¬g
);

1308  -
ENOTTY
;

1310 
	}
}

1312 #ifdeà
CONFIG_COMPAT


1313 
	$ext4_com·t_ioùl
(
fe
 *fe, 
cmd
, 
¬g
)

1316 
cmd
) {

1317 
EXT4_IOC32_GETFLAGS
:

1318 
cmd
 = 
EXT4_IOC_GETFLAGS
;

1320 
EXT4_IOC32_SETFLAGS
:

1321 
cmd
 = 
EXT4_IOC_SETFLAGS
;

1323 
EXT4_IOC32_GETVERSION
:

1324 
cmd
 = 
EXT4_IOC_GETVERSION
;

1326 
EXT4_IOC32_SETVERSION
:

1327 
cmd
 = 
EXT4_IOC_SETVERSION
;

1329 
EXT4_IOC32_GROUP_EXTEND
:

1330 
cmd
 = 
EXT4_IOC_GROUP_EXTEND
;

1332 
EXT4_IOC32_GETVERSION_OLD
:

1333 
cmd
 = 
EXT4_IOC_GETVERSION_OLD
;

1335 
EXT4_IOC32_SETVERSION_OLD
:

1336 
cmd
 = 
EXT4_IOC_SETVERSION_OLD
;

1338 
EXT4_IOC32_GETRSVSZ
:

1339 
cmd
 = 
EXT4_IOC_GETRSVSZ
;

1341 
EXT4_IOC32_SETRSVSZ
:

1342 
cmd
 = 
EXT4_IOC_SETRSVSZ
;

1344 
EXT4_IOC32_GROUP_ADD
: {

1345 
com·t_ext4_Ãw_group_šput
 
__u£r
 *
ušput
;

1346 
ext4_Ãw_group_d©a
 
šput
;

1347 
”r
;

1349 
ušput
 = 
	`com·t_±r
(
¬g
);

1350 
”r
 = 
	`g‘_u£r
(
šput
.
group
, &
ušput
->group);

1351 
”r
 |ğ
	`g‘_u£r
(
šput
.
block_b™m­
, &
ušput
->block_bitmap);

1352 
”r
 |ğ
	`g‘_u£r
(
šput
.
šode_b™m­
, &
ušput
->inode_bitmap);

1353 
”r
 |ğ
	`g‘_u£r
(
šput
.
šode_bË
, &
ušput
->inode_table);

1354 
”r
 |ğ
	`g‘_u£r
(
šput
.
blocks_couÁ
, &
ušput
->blocks_count);

1355 
”r
 |ğ
	`g‘_u£r
(
šput
.
»£rved_blocks
,

1356 &
ušput
->
»£rved_blocks
);

1357 ià(
”r
)

1358  -
EFAULT
;

1359  
	`ext4_ioùl_group_add
(
fe
, &
šput
);

1361 
EXT4_IOC_MOVE_EXT
:

1362 
EXT4_IOC_RESIZE_FS
:

1363 
EXT4_IOC_PRECACHE_EXTENTS
:

1364 
EXT4_IOC_SET_ENCRYPTION_POLICY
:

1365 
EXT4_IOC_GET_ENCRYPTION_PWSALT
:

1366 
EXT4_IOC_GET_ENCRYPTION_POLICY
:

1367 
FS_IOC_GET_ENCRYPTION_POLICY_EX
:

1368 
FS_IOC_ADD_ENCRYPTION_KEY
:

1369 
FS_IOC_REMOVE_ENCRYPTION_KEY
:

1370 
FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
:

1371 
FS_IOC_GET_ENCRYPTION_KEY_STATUS
:

1372 
EXT4_IOC_SHUTDOWN
:

1373 
FS_IOC_GETFSMAP
:

1374 
FS_IOC_ENABLE_VERITY
:

1375 
FS_IOC_MEASURE_VERITY
:

1376 
EXT4_IOC_CLEAR_ES_CACHE
:

1377 
EXT4_IOC_GETSTATE
:

1378 
EXT4_IOC_GET_ES_CACHE
:

1381  -
ENOIOCTLCMD
;

1383  
	`ext4_ioùl
(
fe
, 
cmd
, (è
	`com·t_±r
(
¬g
));

1384 
	}
}

	@pxt4/mballoc.c

12 
	~"ext4_jbd2.h
"

13 
	~"mb®loc.h
"

14 
	~<lšux/log2.h
>

15 
	~<lšux/moduË.h
>

16 
	~<lšux/¦ab.h
>

17 
	~<lšux/no¥ec.h
>

18 
	~<lšux/backšg-dev.h
>

19 
	~<Œaû/ev’ts/ext4.h
>

21 #ifdeà
CONFIG_EXT4_DEBUG


22 
ushÜt
 
ext4_mb®loc_debug
 
	g__»ad_mo¡ly
;

24 
moduË_·¿m_Çmed
(
mb®loc_debug
, 
ext4_mb®loc_debug
, 
ushÜt
, 0644);

25 
MODULE_PARM_DESC
(
mb®loc_debug
, "Debugging†evel forƒxt4's mballoc");

339 
kmem_ÿche
 *
	gext4_p¥aû_ÿch•
;

340 
kmem_ÿche
 *
	gext4_ac_ÿch•
;

341 
kmem_ÿche
 *
	gext4_ä“_d©a_ÿch•
;

346 
	#NR_GRPINFO_CACHES
 8

	)

347 
kmem_ÿche
 *
	gext4_groupšfo_ÿches
[
NR_GRPINFO_CACHES
];

349 cÚ¡ * cÚ¡ 
	gext4_groupšfo_¦ab_Çmes
[
NR_GRPINFO_CACHES
] = {

355 
ext4_mb_g’”©e_äom_·
(
su³r_block
 *
sb
, *
b™m­
,

356 
ext4_group_t
 
group
);

357 
ext4_mb_g’”©e_äom_ä“li¡
(
su³r_block
 *
sb
, *
b™m­
,

358 
ext4_group_t
 
group
);

360 
šlše
 *
	$mb_cÜ»ù_addr_ªd_b™
(*
b™
, *
addr
)

362 #ià
BITS_PER_LONG
 == 64

363 *
b™
 +ğ((è
addr
 & 7UL) << 3;

364 
addr
 = (*) (()‡ddr & ~7UL);

365 #–ià
BITS_PER_LONG
 == 32

366 *
b™
 +ğ((è
addr
 & 3UL) << 3;

367 
addr
 = (*) (()‡ddr & ~3UL);

371  
addr
;

372 
	}
}

374 
šlše
 
	$mb_‹¡_b™
(
b™
, *
addr
)

380 
addr
 = 
	`mb_cÜ»ù_addr_ªd_b™
(&
b™
,‡ddr);

381  
	`ext4_‹¡_b™
(
b™
, 
addr
);

382 
	}
}

384 
šlše
 
	$mb_£t_b™
(
b™
, *
addr
)

386 
addr
 = 
	`mb_cÜ»ù_addr_ªd_b™
(&
b™
,‡ddr);

387 
	`ext4_£t_b™
(
b™
, 
addr
);

388 
	}
}

390 
šlše
 
	$mb_ş—r_b™
(
b™
, *
addr
)

392 
addr
 = 
	`mb_cÜ»ù_addr_ªd_b™
(&
b™
,‡ddr);

393 
	`ext4_ş—r_b™
(
b™
, 
addr
);

394 
	}
}

396 
šlše
 
	$mb_‹¡_ªd_ş—r_b™
(
b™
, *
addr
)

398 
addr
 = 
	`mb_cÜ»ù_addr_ªd_b™
(&
b™
,‡ddr);

399  
	`ext4_‹¡_ªd_ş—r_b™
(
b™
, 
addr
);

400 
	}
}

402 
šlše
 
	$mb_fšd_Ãxt_z”o_b™
(*
addr
, 
max
, 
¡¬t
)

404 
fix
 = 0, 
»t
, 
tmpmax
;

405 
addr
 = 
	`mb_cÜ»ù_addr_ªd_b™
(&
fix
,‡ddr);

406 
tmpmax
 = 
max
 + 
fix
;

407 
¡¬t
 +ğ
fix
;

409 
»t
 = 
	`ext4_fšd_Ãxt_z”o_b™
(
addr
, 
tmpmax
, 
¡¬t
è- 
fix
;

410 ià(
»t
 > 
max
)

411  
max
;

412  
»t
;

413 
	}
}

415 
šlše
 
	$mb_fšd_Ãxt_b™
(*
addr
, 
max
, 
¡¬t
)

417 
fix
 = 0, 
»t
, 
tmpmax
;

418 
addr
 = 
	`mb_cÜ»ù_addr_ªd_b™
(&
fix
,‡ddr);

419 
tmpmax
 = 
max
 + 
fix
;

420 
¡¬t
 +ğ
fix
;

422 
»t
 = 
	`ext4_fšd_Ãxt_b™
(
addr
, 
tmpmax
, 
¡¬t
è- 
fix
;

423 ià(
»t
 > 
max
)

424  
max
;

425  
»t
;

426 
	}
}

428 *
	$mb_fšd_buddy
(
ext4_buddy
 *
e4b
, 
Üd”
, *
max
)

430 *
bb
;

432 
	`BUG_ON
(
e4b
->
bd_b™m­
 =ğe4b->
bd_buddy
);

433 
	`BUG_ON
(
max
 =ğ
NULL
);

435 ià(
Üd”
 > 
e4b
->
bd_blkb™s
 + 1) {

436 *
max
 = 0;

437  
NULL
;

441 ià(
Üd”
 == 0) {

442 *
max
 = 1 << (
e4b
->
bd_blkb™s
 + 3);

443  
e4b
->
bd_b™m­
;

446 
bb
 = 
e4b
->
bd_buddy
 + 
	`EXT4_SB
Ó4b->
bd_sb
)->
s_mb_off£ts
[
Üd”
];

447 *
max
 = 
	`EXT4_SB
(
e4b
->
bd_sb
)->
s_mb_maxs
[
Üd”
];

449  
bb
;

450 
	}
}

452 #ifdeà
DOUBLE_CHECK


453 
	$mb_ä“_blocks_doubË
(
šode
 *šode, 
ext4_buddy
 *
e4b
,

454 
fœ¡
, 
couÁ
)

456 
i
;

457 
su³r_block
 *
sb
 = 
e4b
->
bd_sb
;

459 ià(
	`uÆik–y
(
e4b
->
bd_šfo
->
bb_b™m­
 =ğ
NULL
))

461 
	`as£¹_¥š_locked
(
	`ext4_group_lock_±r
(
sb
, 
e4b
->
bd_group
));

462 
i
 = 0; i < 
couÁ
; i++) {

463 ià(!
	`mb_‹¡_b™
(
fœ¡
 + 
i
, 
e4b
->
bd_šfo
->
bb_b™m­
)) {

464 
ext4_fsblk_t
 
blockÄ
;

466 
blockÄ
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
e4b
->
bd_group
);

467 
blockÄ
 +ğ
	`EXT4_C2B
(
	`EXT4_SB
(
sb
), 
fœ¡
 + 
i
);

468 
	`ext4_g½_locked_”rÜ
(
sb
, 
e4b
->
bd_group
,

469 
šode
 ? inode->
i_šo
 : 0,

470 
blockÄ
,

473 
fœ¡
 + 
i
);

474 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
sb
, 
e4b
->
bd_group
,

475 
EXT4_GROUP_INFO_BBITMAP_CORRUPT
);

477 
	`mb_ş—r_b™
(
fœ¡
 + 
i
, 
e4b
->
bd_šfo
->
bb_b™m­
);

479 
	}
}

481 
	$mb_m¬k_u£d_doubË
(
ext4_buddy
 *
e4b
, 
fœ¡
, 
couÁ
)

483 
i
;

485 ià(
	`uÆik–y
(
e4b
->
bd_šfo
->
bb_b™m­
 =ğ
NULL
))

487 
	`as£¹_¥š_locked
(
	`ext4_group_lock_±r
(
e4b
->
bd_sb
,ƒ4b->
bd_group
));

488 
i
 = 0; i < 
couÁ
; i++) {

489 
	`BUG_ON
(
	`mb_‹¡_b™
(
fœ¡
 + 
i
, 
e4b
->
bd_šfo
->
bb_b™m­
));

490 
	`mb_£t_b™
(
fœ¡
 + 
i
, 
e4b
->
bd_šfo
->
bb_b™m­
);

492 
	}
}

494 
	$mb_cmp_b™m­s
(
ext4_buddy
 *
e4b
, *
b™m­
)

496 ià(
	`memcmp
(
e4b
->
bd_šfo
->
bb_b™m­
, 
b™m­
,ƒ4b->
bd_sb
->
s_blocksize
)) {

497 *
b1
, *
b2
;

498 
i
;

499 
b1
 = (*è
e4b
->
bd_šfo
->
bb_b™m­
;

500 
b2
 = (*è
b™m­
;

501 
i
 = 0; i < 
e4b
->
bd_sb
->
s_blocksize
; i++) {

502 ià(
b1
[
i
] !ğ
b2
[i]) {

503 
	`ext4_msg
(
e4b
->
bd_sb
, 
KERN_ERR
,

507 
e4b
->
bd_group
, 
i
, i * 8, 
b1
[i], 
b2
[i]);

508 
	`BUG
();

512 
	}
}

515 
šlše
 
	$mb_ä“_blocks_doubË
(
šode
 *inode,

516 
ext4_buddy
 *
e4b
, 
fœ¡
, 
couÁ
)

519 
	}
}

520 
šlše
 
	$mb_m¬k_u£d_doubË
(
ext4_buddy
 *
e4b
,

521 
fœ¡
, 
couÁ
)

524 
	}
}

525 
šlše
 
	$mb_cmp_b™m­s
(
ext4_buddy
 *
e4b
, *
b™m­
)

528 
	}
}

531 #ifdeà
AGGRESSIVE_CHECK


533 
	#MB_CHECK_ASSERT
(
as£¹
) \

535 ià(!(
as£¹
)) { \

536 
	`´štk
(
KERN_EMERG
 \

538 
funùiÚ
, 
fe
, 
lše
, #assert); \

539 
	`BUG
(); \

541 } 0)

	)

543 
	$__mb_check_buddy
(
ext4_buddy
 *
e4b
, *
fe
,

544 cÚ¡ *
funùiÚ
, 
lše
)

546 
su³r_block
 *
sb
 = 
e4b
->
bd_sb
;

547 
Üd”
 = 
e4b
->
bd_blkb™s
 + 1;

548 
max
;

549 
max2
;

550 
i
;

551 
j
;

552 
k
;

553 
couÁ
;

554 
ext4_group_šfo
 *
g½
;

555 
äagm’ts
 = 0;

556 
f¡¬t
;

557 
li¡_h—d
 *
cur
;

558 *
buddy
;

559 *
buddy2
;

562 
mb_check_couÁ”
;

563 ià(
mb_check_couÁ”
++ % 100 != 0)

567 
Üd”
 > 1) {

568 
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 
Üd”
, &
max
);

569 
	`MB_CHECK_ASSERT
(
buddy
);

570 
buddy2
 = 
	`mb_fšd_buddy
(
e4b
, 
Üd”
 - 1, &
max2
);

571 
	`MB_CHECK_ASSERT
(
buddy2
);

572 
	`MB_CHECK_ASSERT
(
buddy
 !ğ
buddy2
);

573 
	`MB_CHECK_ASSERT
(
max
 * 2 =ğ
max2
);

575 
couÁ
 = 0;

576 
i
 = 0; i < 
max
; i++) {

578 ià(
	`mb_‹¡_b™
(
i
, 
buddy
)) {

580 ià(!
	`mb_‹¡_b™
(
i
 << 1, 
buddy2
)) {

581 
	`MB_CHECK_ASSERT
(

582 
	`mb_‹¡_b™
((
i
<<1)+1, 
buddy2
));

583 } ià(!
	`mb_‹¡_b™
((
i
 << 1è+ 1, 
buddy2
)) {

584 
	`MB_CHECK_ASSERT
(

585 
	`mb_‹¡_b™
(
i
 << 1, 
buddy2
));

591 
	`MB_CHECK_ASSERT
(
	`mb_‹¡_b™
(
i
 << 1, 
buddy2
));

592 
	`MB_CHECK_ASSERT
(
	`mb_‹¡_b™
((
i
 << 1è+ 1, 
buddy2
));

594 
j
 = 0; j < (1 << 
Üd”
); j++) {

595 
k
 = (
i
 * (1 << 
Üd”
)è+ 
j
;

596 
	`MB_CHECK_ASSERT
(

597 !
	`mb_‹¡_b™
(
k
, 
e4b
->
bd_b™m­
));

599 
couÁ
++;

601 
	`MB_CHECK_ASSERT
(
e4b
->
bd_šfo
->
bb_couÁ”s
[
Üd”
] =ğ
couÁ
);

602 
Üd”
--;

605 
f¡¬t
 = -1;

606 
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 0, &
max
);

607 
i
 = 0; i < 
max
; i++) {

608 ià(!
	`mb_‹¡_b™
(
i
, 
buddy
)) {

609 
	`MB_CHECK_ASSERT
(
i
 >ğ
e4b
->
bd_šfo
->
bb_fœ¡_ä“
);

610 ià(
f¡¬t
 == -1) {

611 
äagm’ts
++;

612 
f¡¬t
 = 
i
;

616 
f¡¬t
 = -1;

618 
j
 = 0; j < 
e4b
->
bd_blkb™s
 + 1; j++) {

619 
buddy2
 = 
	`mb_fšd_buddy
(
e4b
, 
j
, &
max2
);

620 
k
 = 
i
 >> 
j
;

621 
	`MB_CHECK_ASSERT
(
k
 < 
max2
);

622 
	`MB_CHECK_ASSERT
(
	`mb_‹¡_b™
(
k
, 
buddy2
));

625 
	`MB_CHECK_ASSERT
(!
	`EXT4_MB_GRP_NEED_INIT
(
e4b
->
bd_šfo
));

626 
	`MB_CHECK_ASSERT
(
e4b
->
bd_šfo
->
bb_äagm’ts
 =ğ
äagm’ts
);

628 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
e4b
->
bd_group
);

629 
	`li¡_fÜ_—ch
(
cur
, &
g½
->
bb_´—Îoc_li¡
) {

630 
ext4_group_t
 
grou²r
;

631 
ext4_´—Îoc_¥aû
 *
·
;

632 
·
 = 
	`li¡_’Œy
(
cur
, 
ext4_´—Îoc_¥aû
, 
·_group_li¡
);

633 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
·
->
·_p¡¬t
, &
grou²r
, &
k
);

634 
	`MB_CHECK_ASSERT
(
grou²r
 =ğ
e4b
->
bd_group
);

635 
i
 = 0; i < 
·
->
·_Ën
; i++)

636 
	`MB_CHECK_ASSERT
(
	`mb_‹¡_b™
(
k
 + 
i
, 
buddy
));

639 
	}
}

640 #undeà
MB_CHECK_ASSERT


641 
	#mb_check_buddy
(
e4b
è
	`__mb_check_buddy
(e4b, \

642 
__FILE__
, 
__func__
, 
__LINE__
)

	)

644 
	#mb_check_buddy
(
e4b
)

	)

653 
	$ext4_mb_m¬k_ä“_sim¶e
(
su³r_block
 *
sb
,

654 *
buddy
, 
ext4_g½blk_t
 
fœ¡
,ƒxt4_g½blk_ˆ
Ën
,

655 
ext4_group_šfo
 *
g½
)

657 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

658 
ext4_g½blk_t
 
mš
;

659 
ext4_g½blk_t
 
max
;

660 
ext4_g½blk_t
 
chunk
;

661 
bÜd”
;

663 
	`BUG_ON
(
Ën
 > 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
));

665 
bÜd”
 = 2 << 
sb
->
s_blocksize_b™s
;

667 
Ën
 > 0) {

669 
max
 = 
	`ffs
(
fœ¡
 | 
bÜd”
) - 1;

672 
mš
 = 
	`æs
(
Ën
) - 1;

674 ià(
max
 < 
mš
)

675 
mš
 = 
max
;

676 
chunk
 = 1 << 
mš
;

679 
g½
->
bb_couÁ”s
[
mš
]++;

680 ià(
mš
 > 0)

681 
	`mb_ş—r_b™
(
fœ¡
 >> 
mš
,

682 
buddy
 + 
sbi
->
s_mb_off£ts
[
mš
]);

684 
Ën
 -ğ
chunk
;

685 
fœ¡
 +ğ
chunk
;

687 
	}
}

694 
	$mb_£t_Ïrge¡_ä“_Üd”
(
su³r_block
 *
sb
, 
ext4_group_šfo
 *
g½
)

696 
i
;

697 
b™s
;

699 
g½
->
bb_Ïrge¡_ä“_Üd”
 = -1;

701 
b™s
 = 
sb
->
s_blocksize_b™s
 + 1;

702 
i
 = 
b™s
; i >= 0; i--) {

703 ià(
g½
->
bb_couÁ”s
[
i
] > 0) {

704 
g½
->
bb_Ïrge¡_ä“_Üd”
 = 
i
;

708 
	}
}

710 
nošlše_fÜ_¡ack


711 
	$ext4_mb_g’”©e_buddy
(
su³r_block
 *
sb
,

712 *
buddy
, *
b™m­
, 
ext4_group_t
 
group
)

714 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

715 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

716 
ext4_g½blk_t
 
max
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
);

717 
ext4_g½blk_t
 
i
 = 0;

718 
ext4_g½blk_t
 
fœ¡
;

719 
ext4_g½blk_t
 
Ën
;

720 
ä“
 = 0;

721 
äagm’ts
 = 0;

722 
³riod
 = 
	`g‘_cyşes
();

726 
i
 = 
	`mb_fšd_Ãxt_z”o_b™
(
b™m­
, 
max
, 0);

727 
g½
->
bb_fœ¡_ä“
 = 
i
;

728 
i
 < 
max
) {

729 
äagm’ts
++;

730 
fœ¡
 = 
i
;

731 
i
 = 
	`mb_fšd_Ãxt_b™
(
b™m­
, 
max
, i);

732 
Ën
 = 
i
 - 
fœ¡
;

733 
ä“
 +ğ
Ën
;

734 ià(
Ën
 > 1)

735 
	`ext4_mb_m¬k_ä“_sim¶e
(
sb
, 
buddy
, 
fœ¡
, 
Ën
, 
g½
);

737 
g½
->
bb_couÁ”s
[0]++;

738 ià(
i
 < 
max
)

739 
i
 = 
	`mb_fšd_Ãxt_z”o_b™
(
b™m­
, 
max
, i);

741 
g½
->
bb_äagm’ts
 = 
äagm’ts
;

743 ià(
ä“
 !ğ
g½
->
bb_ä“
) {

744 
	`ext4_g½_locked_”rÜ
(
sb
, 
group
, 0, 0,

747 
ä“
, 
g½
->
bb_ä“
);

752 
g½
->
bb_ä“
 = 
ä“
;

753 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
sb
, 
group
,

754 
EXT4_GROUP_INFO_BBITMAP_CORRUPT
);

756 
	`mb_£t_Ïrge¡_ä“_Üd”
(
sb
, 
g½
);

758 
	`ş—r_b™
(
EXT4_GROUP_INFO_NEED_INIT_BIT
, &(
g½
->
bb_¡©e
));

760 
³riod
 = 
	`g‘_cyşes
() -…eriod;

761 
	`¥š_lock
(&
sbi
->
s_b®_lock
);

762 
sbi
->
s_mb_budd›s_g’”©ed
++;

763 
sbi
->
s_mb_g’”©iÚ_time
 +ğ
³riod
;

764 
	`¥š_uÆock
(&
sbi
->
s_b®_lock
);

765 
	}
}

767 
	$mb_»g’”©e_buddy
(
ext4_buddy
 *
e4b
)

769 
couÁ
;

770 
Üd”
 = 1;

771 *
buddy
;

773 (
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 
Üd”
++, &
couÁ
))) {

774 
	`ext4_£t_b™s
(
buddy
, 0, 
couÁ
);

776 
e4b
->
bd_šfo
->
bb_äagm’ts
 = 0;

777 
	`mem£t
(
e4b
->
bd_šfo
->
bb_couÁ”s
, 0,

778 (*
e4b
->
bd_šfo
->
bb_couÁ”s
) *

779 (
e4b
->
bd_sb
->
s_blocksize_b™s
 + 2));

781 
	`ext4_mb_g’”©e_buddy
(
e4b
->
bd_sb
,ƒ4b->
bd_buddy
,

782 
e4b
->
bd_b™m­
,ƒ4b->
bd_group
);

783 
	}
}

805 
	$ext4_mb_š™_ÿche
(
·ge
 *·ge, *
šcÜe
, 
gå_t
 
gå
)

807 
ext4_group_t
 
ngroups
;

808 
blocksize
;

809 
blocks_³r_·ge
;

810 
groups_³r_·ge
;

811 
”r
 = 0;

812 
i
;

813 
ext4_group_t
 
fœ¡_group
, 
group
;

814 
fœ¡_block
;

815 
su³r_block
 *
sb
;

816 
bufãr_h—d
 *
bhs
;

817 
bufãr_h—d
 **
bh
 = 
NULL
;

818 
šode
 *inode;

819 *
d©a
;

820 *
b™m­
;

821 
ext4_group_šfo
 *
gršfo
;

823 
	`mb_debug
(1, "š™…ag%lu\n", 
·ge
->
šdex
);

825 
šode
 = 
·ge
->
m­pšg
->
ho¡
;

826 
sb
 = 
šode
->
i_sb
;

827 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

828 
blocksize
 = 
	`i_blocksize
(
šode
);

829 
blocks_³r_·ge
 = 
PAGE_SIZE
 / 
blocksize
;

831 
groups_³r_·ge
 = 
blocks_³r_·ge
 >> 1;

832 ià(
groups_³r_·ge
 == 0)

833 
groups_³r_·ge
 = 1;

836 ià(
groups_³r_·ge
 > 1) {

837 
i
 = (
bufãr_h—d
 *è* 
groups_³r_·ge
;

838 
bh
 = 
	`kz®loc
(
i
, 
gå
);

839 ià(
bh
 =ğ
NULL
) {

840 
”r
 = -
ENOMEM
;

841 
out
;

844 
bh
 = &
bhs
;

846 
fœ¡_group
 = 
·ge
->
šdex
 * 
blocks_³r_·ge
 / 2;

849 
i
 = 0, 
group
 = 
fœ¡_group
; i < 
groups_³r_·ge
; i++, group++) {

850 ià(
group
 >ğ
ngroups
)

853 
gršfo
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

860 ià(
	`PageU±od©e
(
·ge
è&& !
	`EXT4_MB_GRP_NEED_INIT
(
gršfo
)) {

861 
bh
[
i
] = 
NULL
;

864 
bh
[
i
] = 
	`ext4_»ad_block_b™m­_nowa™
(
sb
, 
group
);

865 ià(
	`IS_ERR
(
bh
[
i
])) {

866 
”r
 = 
	`PTR_ERR
(
bh
[
i
]);

867 
bh
[
i
] = 
NULL
;

868 
out
;

870 
	`mb_debug
(1, "»ad b™m­ fÜ grou°%u\n", 
group
);

874 
i
 = 0, 
group
 = 
fœ¡_group
; i < 
groups_³r_·ge
; i++, group++) {

875 
”r2
;

877 ià(!
bh
[
i
])

879 
”r2
 = 
	`ext4_wa™_block_b™m­
(
sb
, 
group
, 
bh
[
i
]);

880 ià(!
”r
)

881 
”r
 = 
”r2
;

884 
fœ¡_block
 = 
·ge
->
šdex
 * 
blocks_³r_·ge
;

885 
i
 = 0; i < 
blocks_³r_·ge
; i++) {

886 
group
 = (
fœ¡_block
 + 
i
) >> 1;

887 ià(
group
 >ğ
ngroups
)

890 ià(!
bh
[
group
 - 
fœ¡_group
])

894 ià(!
	`bufãr_v”if›d
(
bh
[
group
 - 
fœ¡_group
]))

897 
”r
 = 0;

905 
d©a
 = 
	`·ge_add»ss
(
·ge
è+ (
i
 * 
blocksize
);

906 
b™m­
 = 
bh
[
group
 - 
fœ¡_group
]->
b_d©a
;

912 ià((
fœ¡_block
 + 
i
) & 1) {

914 
	`BUG_ON
(
šcÜe
 =ğ
NULL
);

915 
	`mb_debug
(1, "put buddy for group %u in…age %lu/%x\n",

916 
group
, 
·ge
->
šdex
, 
i
 * 
blocksize
);

917 
	`Œaû_ext4_mb_buddy_b™m­_lßd
(
sb
, 
group
);

918 
gršfo
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

919 
gršfo
->
bb_äagm’ts
 = 0;

920 
	`mem£t
(
gršfo
->
bb_couÁ”s
, 0,

921 (*
gršfo
->
bb_couÁ”s
) *

922 (
sb
->
s_blocksize_b™s
+2));

926 
	`ext4_lock_group
(
sb
, 
group
);

928 
	`mem£t
(
d©a
, 0xff, 
blocksize
);

929 
	`ext4_mb_g’”©e_buddy
(
sb
, 
d©a
, 
šcÜe
, 
group
);

930 
	`ext4_uÆock_group
(
sb
, 
group
);

931 
šcÜe
 = 
NULL
;

934 
	`BUG_ON
(
šcÜe
 !ğ
NULL
);

935 
	`mb_debug
(1, "put bitmap for group %u in…age %lu/%x\n",

936 
group
, 
·ge
->
šdex
, 
i
 * 
blocksize
);

937 
	`Œaû_ext4_mb_b™m­_lßd
(
sb
, 
group
);

940 
	`ext4_lock_group
(
sb
, 
group
);

941 
	`memıy
(
d©a
, 
b™m­
, 
blocksize
);

944 
	`ext4_mb_g’”©e_äom_·
(
sb
, 
d©a
, 
group
);

945 
	`ext4_mb_g’”©e_äom_ä“li¡
(
sb
, 
d©a
, 
group
);

946 
	`ext4_uÆock_group
(
sb
, 
group
);

951 
šcÜe
 = 
d©a
;

954 
	`S‘PageU±od©e
(
·ge
);

956 
out
:

957 ià(
bh
) {

958 
i
 = 0; i < 
groups_³r_·ge
; i++)

959 
	`b»l£
(
bh
[
i
]);

960 ià(
bh
 !ğ&
bhs
)

961 
	`kä“
(
bh
);

963  
”r
;

964 
	}
}

972 
	$ext4_mb_g‘_buddy_·ge_lock
(
su³r_block
 *
sb
,

973 
ext4_group_t
 
group
, 
ext4_buddy
 *
e4b
, 
gå_t
 
gå
)

975 
šode
 *šodğ
	`EXT4_SB
(
sb
)->
s_buddy_ÿche
;

976 
block
, 
²um
, 
poff
;

977 
blocks_³r_·ge
;

978 
·ge
 *page;

980 
e4b
->
bd_buddy_·ge
 = 
NULL
;

981 
e4b
->
bd_b™m­_·ge
 = 
NULL
;

983 
blocks_³r_·ge
 = 
PAGE_SIZE
 / 
sb
->
s_blocksize
;

989 
block
 = 
group
 * 2;

990 
²um
 = 
block
 / 
blocks_³r_·ge
;

991 
poff
 = 
block
 % 
blocks_³r_·ge
;

992 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
²um
, 
gå
);

993 ià(!
·ge
)

994  -
ENOMEM
;

995 
	`BUG_ON
(
·ge
->
m­pšg
 !ğ
šode
->
i_m­pšg
);

996 
e4b
->
bd_b™m­_·ge
 = 
·ge
;

997 
e4b
->
bd_b™m­
 = 
	`·ge_add»ss
(
·ge
è+ (
poff
 * 
sb
->
s_blocksize
);

999 ià(
blocks_³r_·ge
 >= 2) {

1004 
block
++;

1005 
²um
 = 
block
 / 
blocks_³r_·ge
;

1006 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
²um
, 
gå
);

1007 ià(!
·ge
)

1008  -
ENOMEM
;

1009 
	`BUG_ON
(
·ge
->
m­pšg
 !ğ
šode
->
i_m­pšg
);

1010 
e4b
->
bd_buddy_·ge
 = 
·ge
;

1012 
	}
}

1014 
	$ext4_mb_put_buddy_·ge_lock
(
ext4_buddy
 *
e4b
)

1016 ià(
e4b
->
bd_b™m­_·ge
) {

1017 
	`uÆock_·ge
(
e4b
->
bd_b™m­_·ge
);

1018 
	`put_·ge
(
e4b
->
bd_b™m­_·ge
);

1020 ià(
e4b
->
bd_buddy_·ge
) {

1021 
	`uÆock_·ge
(
e4b
->
bd_buddy_·ge
);

1022 
	`put_·ge
(
e4b
->
bd_buddy_·ge
);

1024 
	}
}

1031 
nošlše_fÜ_¡ack


1032 
	$ext4_mb_š™_group
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
, 
gå_t
 
gå
)

1035 
ext4_group_šfo
 *
this_g½
;

1036 
ext4_buddy
 
e4b
;

1037 
·ge
 *page;

1038 
»t
 = 0;

1040 
	`might_¦“p
();

1041 
	`mb_debug
(1, "š™ grou°%u\n", 
group
);

1042 
this_g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

1052 
»t
 = 
	`ext4_mb_g‘_buddy_·ge_lock
(
sb
, 
group
, &
e4b
, 
gå
);

1053 ià(
»t
 || !
	`EXT4_MB_GRP_NEED_INIT
(
this_g½
)) {

1058 
”r
;

1061 
·ge
 = 
e4b
.
bd_b™m­_·ge
;

1062 
»t
 = 
	`ext4_mb_š™_ÿche
(
·ge
, 
NULL
, 
gå
);

1063 ià(
»t
)

1064 
”r
;

1065 ià(!
	`PageU±od©e
(
·ge
)) {

1066 
»t
 = -
EIO
;

1067 
”r
;

1070 ià(
e4b
.
bd_buddy_·ge
 =ğ
NULL
) {

1076 
»t
 = 0;

1077 
”r
;

1080 
·ge
 = 
e4b
.
bd_buddy_·ge
;

1081 
»t
 = 
	`ext4_mb_š™_ÿche
(
·ge
, 
e4b
.
bd_b™m­
, 
gå
);

1082 ià(
»t
)

1083 
”r
;

1084 ià(!
	`PageU±od©e
(
·ge
)) {

1085 
»t
 = -
EIO
;

1086 
”r
;

1088 
”r
:

1089 
	`ext4_mb_put_buddy_·ge_lock
(&
e4b
);

1090  
»t
;

1091 
	}
}

1098 
nošlše_fÜ_¡ack
 

1099 
	$ext4_mb_lßd_buddy_gå
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

1100 
ext4_buddy
 *
e4b
, 
gå_t
 
gå
)

1102 
blocks_³r_·ge
;

1103 
block
;

1104 
²um
;

1105 
poff
;

1106 
·ge
 *page;

1107 
»t
;

1108 
ext4_group_šfo
 *
g½
;

1109 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1110 
šode
 *šodğ
sbi
->
s_buddy_ÿche
;

1112 
	`might_¦“p
();

1113 
	`mb_debug
(1, "lßd grou°%u\n", 
group
);

1115 
blocks_³r_·ge
 = 
PAGE_SIZE
 / 
sb
->
s_blocksize
;

1116 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

1118 
e4b
->
bd_blkb™s
 = 
sb
->
s_blocksize_b™s
;

1119 
e4b
->
bd_šfo
 = 
g½
;

1120 
e4b
->
bd_sb
 = 
sb
;

1121 
e4b
->
bd_group
 = 
group
;

1122 
e4b
->
bd_buddy_·ge
 = 
NULL
;

1123 
e4b
->
bd_b™m­_·ge
 = 
NULL
;

1125 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_NEED_INIT
(
g½
))) {

1130 
»t
 = 
	`ext4_mb_š™_group
(
sb
, 
group
, 
gå
);

1131 ià(
»t
)

1132  
»t
;

1140 
block
 = 
group
 * 2;

1141 
²um
 = 
block
 / 
blocks_³r_·ge
;

1142 
poff
 = 
block
 % 
blocks_³r_·ge
;

1146 
·ge
 = 
	`fšd_g‘_·ge_æags
(
šode
->
i_m­pšg
, 
²um
, 
FGP_ACCESSED
);

1147 ià(
·ge
 =ğ
NULL
 || !
	`PageU±od©e
(page)) {

1148 ià(
·ge
)

1157 
	`put_·ge
(
·ge
);

1158 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
²um
, 
gå
);

1159 ià(
·ge
) {

1160 
	`BUG_ON
(
·ge
->
m­pšg
 !ğ
šode
->
i_m­pšg
);

1161 ià(!
	`PageU±od©e
(
·ge
)) {

1162 
»t
 = 
	`ext4_mb_š™_ÿche
(
·ge
, 
NULL
, 
gå
);

1163 ià(
»t
) {

1164 
	`uÆock_·ge
(
·ge
);

1165 
”r
;

1167 
	`mb_cmp_b™m­s
(
e4b
, 
	`·ge_add»ss
(
·ge
) +

1168 (
poff
 * 
sb
->
s_blocksize
));

1170 
	`uÆock_·ge
(
·ge
);

1173 ià(
·ge
 =ğ
NULL
) {

1174 
»t
 = -
ENOMEM
;

1175 
”r
;

1177 ià(!
	`PageU±od©e
(
·ge
)) {

1178 
»t
 = -
EIO
;

1179 
”r
;

1183 
e4b
->
bd_b™m­_·ge
 = 
·ge
;

1184 
e4b
->
bd_b™m­
 = 
	`·ge_add»ss
(
·ge
è+ (
poff
 * 
sb
->
s_blocksize
);

1186 
block
++;

1187 
²um
 = 
block
 / 
blocks_³r_·ge
;

1188 
poff
 = 
block
 % 
blocks_³r_·ge
;

1190 
·ge
 = 
	`fšd_g‘_·ge_æags
(
šode
->
i_m­pšg
, 
²um
, 
FGP_ACCESSED
);

1191 ià(
·ge
 =ğ
NULL
 || !
	`PageU±od©e
(page)) {

1192 ià(
·ge
)

1193 
	`put_·ge
(
·ge
);

1194 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
²um
, 
gå
);

1195 ià(
·ge
) {

1196 
	`BUG_ON
(
·ge
->
m­pšg
 !ğ
šode
->
i_m­pšg
);

1197 ià(!
	`PageU±od©e
(
·ge
)) {

1198 
»t
 = 
	`ext4_mb_š™_ÿche
(
·ge
, 
e4b
->
bd_b™m­
,

1199 
gå
);

1200 ià(
»t
) {

1201 
	`uÆock_·ge
(
·ge
);

1202 
”r
;

1205 
	`uÆock_·ge
(
·ge
);

1208 ià(
·ge
 =ğ
NULL
) {

1209 
»t
 = -
ENOMEM
;

1210 
”r
;

1212 ià(!
	`PageU±od©e
(
·ge
)) {

1213 
»t
 = -
EIO
;

1214 
”r
;

1218 
e4b
->
bd_buddy_·ge
 = 
·ge
;

1219 
e4b
->
bd_buddy
 = 
	`·ge_add»ss
(
·ge
è+ (
poff
 * 
sb
->
s_blocksize
);

1221 
	`BUG_ON
(
e4b
->
bd_b™m­_·ge
 =ğ
NULL
);

1222 
	`BUG_ON
(
e4b
->
bd_buddy_·ge
 =ğ
NULL
);

1226 
”r
:

1227 ià(
·ge
)

1228 
	`put_·ge
(
·ge
);

1229 ià(
e4b
->
bd_b™m­_·ge
)

1230 
	`put_·ge
(
e4b
->
bd_b™m­_·ge
);

1231 ià(
e4b
->
bd_buddy_·ge
)

1232 
	`put_·ge
(
e4b
->
bd_buddy_·ge
);

1233 
e4b
->
bd_buddy
 = 
NULL
;

1234 
e4b
->
bd_b™m­
 = 
NULL
;

1235  
»t
;

1236 
	}
}

1238 
	$ext4_mb_lßd_buddy
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

1239 
ext4_buddy
 *
e4b
)

1241  
	`ext4_mb_lßd_buddy_gå
(
sb
, 
group
, 
e4b
, 
GFP_NOFS
);

1242 
	}
}

1244 
	$ext4_mb_uÆßd_buddy
(
ext4_buddy
 *
e4b
)

1246 ià(
e4b
->
bd_b™m­_·ge
)

1247 
	`put_·ge
(
e4b
->
bd_b™m­_·ge
);

1248 ià(
e4b
->
bd_buddy_·ge
)

1249 
	`put_·ge
(
e4b
->
bd_buddy_·ge
);

1250 
	}
}

1253 
	$mb_fšd_Üd”_fÜ_block
(
ext4_buddy
 *
e4b
, 
block
)

1255 
Üd”
 = 1;

1256 
bb_šü
 = 1 << (
e4b
->
bd_blkb™s
 - 1);

1257 *
bb
;

1259 
	`BUG_ON
(
e4b
->
bd_b™m­
 =ğe4b->
bd_buddy
);

1260 
	`BUG_ON
(
block
 >ğ(1 << (
e4b
->
bd_blkb™s
 + 3)));

1262 
bb
 = 
e4b
->
bd_buddy
;

1263 
Üd”
 <ğ
e4b
->
bd_blkb™s
 + 1) {

1264 
block
 = block >> 1;

1265 ià(!
	`mb_‹¡_b™
(
block
, 
bb
)) {

1267  
Üd”
;

1269 
bb
 +ğ
bb_šü
;

1270 
bb_šü
 >>= 1;

1271 
Üd”
++;

1274 
	}
}

1276 
	$mb_ş—r_b™s
(*
bm
, 
cur
, 
Ën
)

1278 
__u32
 *
addr
;

1280 
Ën
 = 
cur
 +†en;

1281 
cur
 < 
Ën
) {

1282 ià((
cur
 & 31è=ğ0 && (
Ën
 - cur) >= 32) {

1284 
addr
 = 
bm
 + (
cur
 >> 3);

1285 *
addr
 = 0;

1286 
cur
 += 32;

1289 
	`mb_ş—r_b™
(
cur
, 
bm
);

1290 
cur
++;

1292 
	}
}

1297 
	$mb_‹¡_ªd_ş—r_b™s
(*
bm
, 
cur
, 
Ën
)

1299 
__u32
 *
addr
;

1300 
z”o_b™
 = -1;

1302 
Ën
 = 
cur
 +†en;

1303 
cur
 < 
Ën
) {

1304 ià((
cur
 & 31è=ğ0 && (
Ën
 - cur) >= 32) {

1306 
addr
 = 
bm
 + (
cur
 >> 3);

1307 ià(*
addr
 !ğ(
__u32
)(-1è&& 
z”o_b™
 == -1)

1308 
z”o_b™
 = 
cur
 + 
	`mb_fšd_Ãxt_z”o_b™
(
addr
, 32, 0);

1309 *
addr
 = 0;

1310 
cur
 += 32;

1313 ià(!
	`mb_‹¡_ªd_ş—r_b™
(
cur
, 
bm
è&& 
z”o_b™
 == -1)

1314 
z”o_b™
 = 
cur
;

1315 
cur
++;

1318  
z”o_b™
;

1319 
	}
}

1321 
	$ext4_£t_b™s
(*
bm
, 
cur
, 
Ën
)

1323 
__u32
 *
addr
;

1325 
Ën
 = 
cur
 +†en;

1326 
cur
 < 
Ën
) {

1327 ià((
cur
 & 31è=ğ0 && (
Ën
 - cur) >= 32) {

1329 
addr
 = 
bm
 + (
cur
 >> 3);

1330 *
addr
 = 0xffffffff;

1331 
cur
 += 32;

1334 
	`mb_£t_b™
(
cur
, 
bm
);

1335 
cur
++;

1337 
	}
}

1342 
šlše
 
	$mb_buddy_adju¡_bÜd”
(* 
b™
, * 
b™m­
, 
side
)

1344 ià(
	`mb_‹¡_b™
(*
b™
 + 
side
, 
b™m­
)) {

1345 
	`mb_ş—r_b™
(*
b™
, 
b™m­
);

1346 (*
b™
è-ğ
side
;

1350 (*
b™
è+ğ
side
;

1351 
	`mb_£t_b™
(*
b™
, 
b™m­
);

1354 
	}
}

1356 
	$mb_buddy_m¬k_ä“
(
ext4_buddy
 *
e4b
, 
fœ¡
, 
Ï¡
)

1358 
max
;

1359 
Üd”
 = 1;

1360 *
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 
Üd”
, &
max
);

1362 
buddy
) {

1363 *
buddy2
;

1394 ià(
fœ¡
 & 1)

1395 
e4b
->
bd_šfo
->
bb_couÁ”s
[
Üd”
] +ğ
	`mb_buddy_adju¡_bÜd”
(&
fœ¡
, 
buddy
, -1);

1396 ià(!(
Ï¡
 & 1))

1397 
e4b
->
bd_šfo
->
bb_couÁ”s
[
Üd”
] +ğ
	`mb_buddy_adju¡_bÜd”
(&
Ï¡
, 
buddy
, 1);

1398 ià(
fœ¡
 > 
Ï¡
)

1400 
Üd”
++;

1402 ià(
fœ¡
 =ğ
Ï¡
 || !(
buddy2
 = 
	`mb_fšd_buddy
(
e4b
, 
Üd”
, &
max
))) {

1403 
	`mb_ş—r_b™s
(
buddy
, 
fœ¡
, 
Ï¡
 - first + 1);

1404 
e4b
->
bd_šfo
->
bb_couÁ”s
[
Üd”
 - 1] +ğ
Ï¡
 - 
fœ¡
 + 1;

1407 
fœ¡
 >>= 1;

1408 
Ï¡
 >>= 1;

1409 
buddy
 = 
buddy2
;

1411 
	}
}

1413 
	$mb_ä“_blocks
(
šode
 *šode, 
ext4_buddy
 *
e4b
,

1414 
fœ¡
, 
couÁ
)

1416 
Ëá_is_ä“
 = 0;

1417 
right_is_ä“
 = 0;

1418 
block
;

1419 
Ï¡
 = 
fœ¡
 + 
couÁ
 - 1;

1420 
su³r_block
 *
sb
 = 
e4b
->
bd_sb
;

1422 ià(
	`WARN_ON
(
couÁ
 == 0))

1424 
	`BUG_ON
(
Ï¡
 >ğ(
sb
->
s_blocksize
 << 3));

1425 
	`as£¹_¥š_locked
(
	`ext4_group_lock_±r
(
sb
, 
e4b
->
bd_group
));

1427 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(
e4b
->
bd_šfo
)))

1430 
	`mb_check_buddy
(
e4b
);

1431 
	`mb_ä“_blocks_doubË
(
šode
, 
e4b
, 
fœ¡
, 
couÁ
);

1433 
e4b
->
bd_šfo
->
bb_ä“
 +ğ
couÁ
;

1434 ià(
fœ¡
 < 
e4b
->
bd_šfo
->
bb_fœ¡_ä“
)

1435 
e4b
->
bd_šfo
->
bb_fœ¡_ä“
 = 
fœ¡
;

1440 ià(
fœ¡
 != 0)

1441 
Ëá_is_ä“
 = !
	`mb_‹¡_b™
(
fœ¡
 - 1, 
e4b
->
bd_b™m­
);

1442 
block
 = 
	`mb_‹¡_ªd_ş—r_b™s
(
e4b
->
bd_b™m­
, 
fœ¡
, 
couÁ
);

1443 ià(
Ï¡
 + 1 < 
	`EXT4_SB
(
sb
)->
s_mb_maxs
[0])

1444 
right_is_ä“
 = !
	`mb_‹¡_b™
(
Ï¡
 + 1, 
e4b
->
bd_b™m­
);

1446 ià(
	`uÆik–y
(
block
 != -1)) {

1447 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1448 
ext4_fsblk_t
 
blockÄ
;

1450 
blockÄ
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
e4b
->
bd_group
);

1451 
blockÄ
 +ğ
	`EXT4_C2B
(
sbi
, 
block
);

1452 
	`ext4_g½_locked_”rÜ
(
sb
, 
e4b
->
bd_group
,

1453 
šode
 ? inode->
i_šo
 : 0,

1454 
blockÄ
,

1457 
block
);

1458 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
sb
, 
e4b
->
bd_group
,

1459 
EXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1460 
	`mb_»g’”©e_buddy
(
e4b
);

1461 
dÚe
;

1465 ià(
Ëá_is_ä“
 && 
right_is_ä“
)

1466 
e4b
->
bd_šfo
->
bb_äagm’ts
--;

1467 ià(!
Ëá_is_ä“
 && !
right_is_ä“
)

1468 
e4b
->
bd_šfo
->
bb_äagm’ts
++;

1476 ià(
fœ¡
 & 1) {

1477 
fœ¡
 +ğ!
Ëá_is_ä“
;

1478 
e4b
->
bd_šfo
->
bb_couÁ”s
[0] +ğ
Ëá_is_ä“
 ? -1 : 1;

1480 ià(!(
Ï¡
 & 1)) {

1481 
Ï¡
 -ğ!
right_is_ä“
;

1482 
e4b
->
bd_šfo
->
bb_couÁ”s
[0] +ğ
right_is_ä“
 ? -1 : 1;

1485 ià(
fœ¡
 <ğ
Ï¡
)

1486 
	`mb_buddy_m¬k_ä“
(
e4b
, 
fœ¡
 >> 1, 
Ï¡
 >> 1);

1488 
dÚe
:

1489 
	`mb_£t_Ïrge¡_ä“_Üd”
(
sb
, 
e4b
->
bd_šfo
);

1490 
	`mb_check_buddy
(
e4b
);

1491 
	}
}

1493 
	$mb_fšd_ex‹Á
(
ext4_buddy
 *
e4b
, 
block
,

1494 
Ãeded
, 
ext4_ä“_ex‹Á
 *
ex
)

1496 
Ãxt
 = 
block
;

1497 
max
, 
Üd”
;

1498 *
buddy
;

1500 
	`as£¹_¥š_locked
(
	`ext4_group_lock_±r
(
e4b
->
bd_sb
,ƒ4b->
bd_group
));

1501 
	`BUG_ON
(
ex
 =ğ
NULL
);

1503 
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 0, &
max
);

1504 
	`BUG_ON
(
buddy
 =ğ
NULL
);

1505 
	`BUG_ON
(
block
 >ğ
max
);

1506 ià(
	`mb_‹¡_b™
(
block
, 
buddy
)) {

1507 
ex
->
ã_Ën
 = 0;

1508 
ex
->
ã_¡¬t
 = 0;

1509 
ex
->
ã_group
 = 0;

1514 
Üd”
 = 
	`mb_fšd_Üd”_fÜ_block
(
e4b
, 
block
);

1515 
block
 = block >> 
Üd”
;

1517 
ex
->
ã_Ën
 = 1 << 
Üd”
;

1518 
ex
->
ã_¡¬t
 = 
block
 << 
Üd”
;

1519 
ex
->
ã_group
 = 
e4b
->
bd_group
;

1522 
Ãxt
 =‚exˆ- 
ex
->
ã_¡¬t
;

1523 
ex
->
ã_Ën
 -ğ
Ãxt
;

1524 
ex
->
ã_¡¬t
 +ğ
Ãxt
;

1526 
Ãeded
 > 
ex
->
ã_Ën
 &&

1527 
	`mb_fšd_buddy
(
e4b
, 
Üd”
, &
max
)) {

1529 ià(
block
 + 1 >ğ
max
)

1532 
Ãxt
 = (
block
 + 1è* (1 << 
Üd”
);

1533 ià(
	`mb_‹¡_b™
(
Ãxt
, 
e4b
->
bd_b™m­
))

1536 
Üd”
 = 
	`mb_fšd_Üd”_fÜ_block
(
e4b
, 
Ãxt
);

1538 
block
 = 
Ãxt
 >> 
Üd”
;

1539 
ex
->
ã_Ën
 +ğ1 << 
Üd”
;

1542 ià(
ex
->
ã_¡¬t
 +ƒx->
ã_Ën
 > 
	`EXT4_CLUSTERS_PER_GROUP
(
e4b
->
bd_sb
)) {

1544 
	`WARN_ON
(1);

1545 
	`ext4_”rÜ
(
e4b
->
bd_sb
, "corruption or bug in mb_find_extent "

1547 
block
, 
Üd”
, 
Ãeded
, 
ex
->
ã_group
,ƒx->
ã_¡¬t
,

1548 
ex
->
ã_Ën
,ƒx->
ã_logiÿl
);

1549 
ex
->
ã_Ën
 = 0;

1550 
ex
->
ã_¡¬t
 = 0;

1551 
ex
->
ã_group
 = 0;

1553  
ex
->
ã_Ën
;

1554 
	}
}

1556 
	$mb_m¬k_u£d
(
ext4_buddy
 *
e4b
, 
ext4_ä“_ex‹Á
 *
ex
)

1558 
Üd
;

1559 
mËn
 = 0;

1560 
max
 = 0;

1561 
cur
;

1562 
¡¬t
 = 
ex
->
ã_¡¬t
;

1563 
Ën
 = 
ex
->
ã_Ën
;

1564 
»t
 = 0;

1565 
Ën0
 = 
Ën
;

1566 *
buddy
;

1568 
	`BUG_ON
(
¡¬t
 + 
Ën
 > (
e4b
->
bd_sb
->
s_blocksize
 << 3));

1569 
	`BUG_ON
(
e4b
->
bd_group
 !ğ
ex
->
ã_group
);

1570 
	`as£¹_¥š_locked
(
	`ext4_group_lock_±r
(
e4b
->
bd_sb
,ƒ4b->
bd_group
));

1571 
	`mb_check_buddy
(
e4b
);

1572 
	`mb_m¬k_u£d_doubË
(
e4b
, 
¡¬t
, 
Ën
);

1574 
e4b
->
bd_šfo
->
bb_ä“
 -ğ
Ën
;

1575 ià(
e4b
->
bd_šfo
->
bb_fœ¡_ä“
 =ğ
¡¬t
)

1576 
e4b
->
bd_šfo
->
bb_fœ¡_ä“
 +ğ
Ën
;

1579 ià(
¡¬t
 != 0)

1580 
mËn
 = !
	`mb_‹¡_b™
(
¡¬t
 - 1, 
e4b
->
bd_b™m­
);

1581 ià(
¡¬t
 + 
Ën
 < 
	`EXT4_SB
(
e4b
->
bd_sb
)->
s_mb_maxs
[0])

1582 
max
 = !
	`mb_‹¡_b™
(
¡¬t
 + 
Ën
, 
e4b
->
bd_b™m­
);

1583 ià(
mËn
 && 
max
)

1584 
e4b
->
bd_šfo
->
bb_äagm’ts
++;

1585 ià(!
mËn
 && !
max
)

1586 
e4b
->
bd_šfo
->
bb_äagm’ts
--;

1589 
Ën
) {

1590 
Üd
 = 
	`mb_fšd_Üd”_fÜ_block
(
e4b
, 
¡¬t
);

1592 ià(((
¡¬t
 >> 
Üd
è<< ordè=ğ¡¬ˆ&& 
Ën
 >= (1 << ord)) {

1594 
mËn
 = 1 << 
Üd
;

1595 
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 
Üd
, &
max
);

1596 
	`BUG_ON
((
¡¬t
 >> 
Üd
è>ğ
max
);

1597 
	`mb_£t_b™
(
¡¬t
 >> 
Üd
, 
buddy
);

1598 
e4b
->
bd_šfo
->
bb_couÁ”s
[
Üd
]--;

1599 
¡¬t
 +ğ
mËn
;

1600 
Ën
 -ğ
mËn
;

1601 
	`BUG_ON
(
Ën
 < 0);

1606 ià(
»t
 == 0)

1607 
»t
 = 
Ën
 | (
Üd
 << 16);

1610 
	`BUG_ON
(
Üd
 <= 0);

1611 
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 
Üd
, &
max
);

1612 
	`mb_£t_b™
(
¡¬t
 >> 
Üd
, 
buddy
);

1613 
e4b
->
bd_šfo
->
bb_couÁ”s
[
Üd
]--;

1615 
Üd
--;

1616 
cur
 = (
¡¬t
 >> 
Üd
) & ~1U;

1617 
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 
Üd
, &
max
);

1618 
	`mb_ş—r_b™
(
cur
, 
buddy
);

1619 
	`mb_ş—r_b™
(
cur
 + 1, 
buddy
);

1620 
e4b
->
bd_šfo
->
bb_couÁ”s
[
Üd
]++;

1621 
e4b
->
bd_šfo
->
bb_couÁ”s
[
Üd
]++;

1623 
	`mb_£t_Ïrge¡_ä“_Üd”
(
e4b
->
bd_sb
,ƒ4b->
bd_šfo
);

1625 
	`ext4_£t_b™s
(
e4b
->
bd_b™m­
, 
ex
->
ã_¡¬t
, 
Ën0
);

1626 
	`mb_check_buddy
(
e4b
);

1628  
»t
;

1629 
	}
}

1634 
	$ext4_mb_u£_be¡_found
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

1635 
ext4_buddy
 *
e4b
)

1637 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

1638 
»t
;

1640 
	`BUG_ON
(
ac
->
ac_b_ex
.
ã_group
 !ğ
e4b
->
bd_group
);

1641 
	`BUG_ON
(
ac
->
ac_¡©us
 =ğ
AC_STATUS_FOUND
);

1643 
ac
->
ac_b_ex
.
ã_Ën
 = 
	`mš
×c->ac_b_ex.ã_Ën,‡c->
ac_g_ex
.fe_len);

1644 
ac
->
ac_b_ex
.
ã_logiÿl
 =‡c->
ac_g_ex
.fe_logical;

1645 
»t
 = 
	`mb_m¬k_u£d
(
e4b
, &
ac
->
ac_b_ex
);

1649 
ac
->
ac_f_ex
 =‡c->
ac_b_ex
;

1651 
ac
->
ac_¡©us
 = 
AC_STATUS_FOUND
;

1652 
ac
->
ac_
 = 
»t
 & 0xffff;

1653 
ac
->
ac_buddy
 = 
»t
 >> 16;

1662 
ac
->
ac_b™m­_·ge
 = 
e4b
->
bd_b™m­_·ge
;

1663 
	`g‘_·ge
(
ac
->
ac_b™m­_·ge
);

1664 
ac
->
ac_buddy_·ge
 = 
e4b
->
bd_buddy_·ge
;

1665 
	`g‘_·ge
(
ac
->
ac_buddy_·ge
);

1667 ià(
ac
->
ac_æags
 & 
EXT4_MB_STREAM_ALLOC
) {

1668 
	`¥š_lock
(&
sbi
->
s_md_lock
);

1669 
sbi
->
s_mb_Ï¡_group
 = 
ac
->
ac_f_ex
.
ã_group
;

1670 
sbi
->
s_mb_Ï¡_¡¬t
 = 
ac
->
ac_f_ex
.
ã_¡¬t
;

1671 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

1673 
	}
}

1679 
	$ext4_mb_check_lim™s
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

1680 
ext4_buddy
 *
e4b
,

1681 
fšish_group
)

1683 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

1684 
ext4_ä“_ex‹Á
 *
bex
 = &
ac
->
ac_b_ex
;

1685 
ext4_ä“_ex‹Á
 *
gex
 = &
ac
->
ac_g_ex
;

1686 
ext4_ä“_ex‹Á
 
ex
;

1687 
max
;

1689 ià(
ac
->
ac_¡©us
 =ğ
AC_STATUS_FOUND
)

1694 ià(
ac
->
ac_found
 > 
sbi
->
s_mb_max_to_sÿn
 &&

1695 !(
ac
->
ac_æags
 & 
EXT4_MB_HINT_FIRST
)) {

1696 
ac
->
ac_¡©us
 = 
AC_STATUS_BREAK
;

1703 ià(
bex
->
ã_Ën
 < 
gex
->fe_len)

1706 ià((
fšish_group
 || 
ac
->
ac_found
 > 
sbi
->
s_mb_mš_to_sÿn
)

1707 && 
bex
->
ã_group
 =ğ
e4b
->
bd_group
) {

1711 
max
 = 
	`mb_fšd_ex‹Á
(
e4b
, 
bex
->
ã_¡¬t
, 
gex
->
ã_Ën
, &
ex
);

1712 ià(
max
 >ğ
gex
->
ã_Ën
) {

1713 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

1717 
	}
}

1729 
	$ext4_mb_m—su»_ex‹Á
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

1730 
ext4_ä“_ex‹Á
 *
ex
,

1731 
ext4_buddy
 *
e4b
)

1733 
ext4_ä“_ex‹Á
 *
bex
 = &
ac
->
ac_b_ex
;

1734 
ext4_ä“_ex‹Á
 *
gex
 = &
ac
->
ac_g_ex
;

1736 
	`BUG_ON
(
ex
->
ã_Ën
 <= 0);

1737 
	`BUG_ON
(
ex
->
ã_Ën
 > 
	`EXT4_CLUSTERS_PER_GROUP
(
ac
->
ac_sb
));

1738 
	`BUG_ON
(
ex
->
ã_¡¬t
 >ğ
	`EXT4_CLUSTERS_PER_GROUP
(
ac
->
ac_sb
));

1739 
	`BUG_ON
(
ac
->
ac_¡©us
 !ğ
AC_STATUS_CONTINUE
);

1741 
ac
->
ac_found
++;

1746 ià(
	`uÆik–y
(
ac
->
ac_æags
 & 
EXT4_MB_HINT_FIRST
)) {

1747 *
bex
 = *
ex
;

1748 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

1755 ià(
ex
->
ã_Ën
 =ğ
gex
->fe_len) {

1756 *
bex
 = *
ex
;

1757 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

1764 ià(
bex
->
ã_Ën
 == 0) {

1765 *
bex
 = *
ex
;

1772 ià(
bex
->
ã_Ën
 < 
gex
->fe_len) {

1775 ià(
ex
->
ã_Ën
 > 
bex
->fe_len)

1776 *
bex
 = *
ex
;

1777 } ià(
ex
->
ã_Ën
 > 
gex
->fe_len) {

1781 ià(
ex
->
ã_Ën
 < 
bex
->fe_len)

1782 *
bex
 = *
ex
;

1785 
	`ext4_mb_check_lim™s
(
ac
, 
e4b
, 0);

1786 
	}
}

1788 
nošlše_fÜ_¡ack


1789 
	$ext4_mb_Œy_be¡_found
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

1790 
ext4_buddy
 *
e4b
)

1792 
ext4_ä“_ex‹Á
 
ex
 = 
ac
->
ac_b_ex
;

1793 
ext4_group_t
 
group
 = 
ex
.
ã_group
;

1794 
max
;

1795 
”r
;

1797 
	`BUG_ON
(
ex
.
ã_Ën
 <= 0);

1798 
”r
 = 
	`ext4_mb_lßd_buddy
(
ac
->
ac_sb
, 
group
, 
e4b
);

1799 ià(
”r
)

1800  
”r
;

1802 
	`ext4_lock_group
(
ac
->
ac_sb
, 
group
);

1803 
max
 = 
	`mb_fšd_ex‹Á
(
e4b
, 
ex
.
ã_¡¬t
,ƒx.
ã_Ën
, &ex);

1805 ià(
max
 > 0) {

1806 
ac
->
ac_b_ex
 = 
ex
;

1807 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

1810 
	`ext4_uÆock_group
(
ac
->
ac_sb
, 
group
);

1811 
	`ext4_mb_uÆßd_buddy
(
e4b
);

1814 
	}
}

1816 
nošlše_fÜ_¡ack


1817 
	$ext4_mb_fšd_by_gßl
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

1818 
ext4_buddy
 *
e4b
)

1820 
ext4_group_t
 
group
 = 
ac
->
ac_g_ex
.
ã_group
;

1821 
max
;

1822 
”r
;

1823 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

1824 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
ac
->
ac_sb
, 
group
);

1825 
ext4_ä“_ex‹Á
 
ex
;

1827 ià(!(
ac
->
ac_æags
 & 
EXT4_MB_HINT_TRY_GOAL
))

1829 ià(
g½
->
bb_ä“
 == 0)

1832 
”r
 = 
	`ext4_mb_lßd_buddy
(
ac
->
ac_sb
, 
group
, 
e4b
);

1833 ià(
”r
)

1834  
”r
;

1836 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(
e4b
->
bd_šfo
))) {

1837 
	`ext4_mb_uÆßd_buddy
(
e4b
);

1841 
	`ext4_lock_group
(
ac
->
ac_sb
, 
group
);

1842 
max
 = 
	`mb_fšd_ex‹Á
(
e4b
, 
ac
->
ac_g_ex
.
ã_¡¬t
,

1843 
ac
->
ac_g_ex
.
ã_Ën
, &
ex
);

1844 
ex
.
ã_logiÿl
 = 0xDEADFA11;

1846 ià(
max
 >ğ
ac
->
ac_g_ex
.
ã_Ën
 &&‡c->ac_g_ex.ã_ËÀ=ğ
sbi
->
s_¡re
) {

1847 
ext4_fsblk_t
 
¡¬t
;

1849 
¡¬t
 = 
	`ext4_group_fœ¡_block_no
(
ac
->
ac_sb
, 
e4b
->
bd_group
) +

1850 
ex
.
ã_¡¬t
;

1852 ià(
	`do_div
(
¡¬t
, 
sbi
->
s_¡re
) == 0) {

1853 
ac
->
ac_found
++;

1854 
ac
->
ac_b_ex
 = 
ex
;

1855 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

1857 } ià(
max
 >ğ
ac
->
ac_g_ex
.
ã_Ën
) {

1858 
	`BUG_ON
(
ex
.
ã_Ën
 <= 0);

1859 
	`BUG_ON
(
ex
.
ã_group
 !ğ
ac
->
ac_g_ex
.fe_group);

1860 
	`BUG_ON
(
ex
.
ã_¡¬t
 !ğ
ac
->
ac_g_ex
.fe_start);

1861 
ac
->
ac_found
++;

1862 
ac
->
ac_b_ex
 = 
ex
;

1863 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

1864 } ià(
max
 > 0 && (
ac
->
ac_æags
 & 
EXT4_MB_HINT_MERGE
)) {

1867 
	`BUG_ON
(
ex
.
ã_Ën
 <= 0);

1868 
	`BUG_ON
(
ex
.
ã_group
 !ğ
ac
->
ac_g_ex
.fe_group);

1869 
	`BUG_ON
(
ex
.
ã_¡¬t
 !ğ
ac
->
ac_g_ex
.fe_start);

1870 
ac
->
ac_found
++;

1871 
ac
->
ac_b_ex
 = 
ex
;

1872 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

1874 
	`ext4_uÆock_group
(
ac
->
ac_sb
, 
group
);

1875 
	`ext4_mb_uÆßd_buddy
(
e4b
);

1878 
	}
}

1884 
nošlše_fÜ_¡ack


1885 
	$ext4_mb_sim¶e_sÿn_group
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

1886 
ext4_buddy
 *
e4b
)

1888 
su³r_block
 *
sb
 = 
ac
->
ac_sb
;

1889 
ext4_group_šfo
 *
g½
 = 
e4b
->
bd_šfo
;

1890 *
buddy
;

1891 
i
;

1892 
k
;

1893 
max
;

1895 
	`BUG_ON
(
ac
->
ac_2Üd”
 <= 0);

1896 
i
 = 
ac
->
ac_2Üd”
; i <ğ
sb
->
s_blocksize_b™s
 + 1; i++) {

1897 ià(
g½
->
bb_couÁ”s
[
i
] == 0)

1900 
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 
i
, &
max
);

1901 
	`BUG_ON
(
buddy
 =ğ
NULL
);

1903 
k
 = 
	`mb_fšd_Ãxt_z”o_b™
(
buddy
, 
max
, 0);

1904 
	`BUG_ON
(
k
 >ğ
max
);

1906 
ac
->
ac_found
++;

1908 
ac
->
ac_b_ex
.
ã_Ën
 = 1 << 
i
;

1909 
ac
->
ac_b_ex
.
ã_¡¬t
 = 
k
 << 
i
;

1910 
ac
->
ac_b_ex
.
ã_group
 = 
e4b
->
bd_group
;

1912 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

1914 
	`BUG_ON
(
ac
->
ac_b_ex
.
ã_Ën
 !ğac->
ac_g_ex
.fe_len);

1916 ià(
	`EXT4_SB
(
sb
)->
s_mb_¡©s
)

1917 
	`©omic_šc
(&
	`EXT4_SB
(
sb
)->
s_b®_2Üd”s
);

1921 
	}
}

1928 
nošlše_fÜ_¡ack


1929 
	$ext4_mb_com¶ex_sÿn_group
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

1930 
ext4_buddy
 *
e4b
)

1932 
su³r_block
 *
sb
 = 
ac
->
ac_sb
;

1933 *
b™m­
 = 
e4b
->
bd_b™m­
;

1934 
ext4_ä“_ex‹Á
 
ex
;

1935 
i
;

1936 
ä“
;

1938 
ä“
 = 
e4b
->
bd_šfo
->
bb_ä“
;

1939 
	`BUG_ON
(
ä“
 <= 0);

1941 
i
 = 
e4b
->
bd_šfo
->
bb_fœ¡_ä“
;

1943 
ä“
 && 
ac
->
ac_¡©us
 =ğ
AC_STATUS_CONTINUE
) {

1944 
i
 = 
	`mb_fšd_Ãxt_z”o_b™
(
b™m­
,

1945 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
), 
i
);

1946 ià(
i
 >ğ
	`EXT4_CLUSTERS_PER_GROUP
(
sb
)) {

1952 
	`ext4_g½_locked_”rÜ
(
sb
, 
e4b
->
bd_group
, 0, 0,

1955 
ä“
);

1956 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
sb
, 
e4b
->
bd_group
,

1957 
EXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1961 
	`mb_fšd_ex‹Á
(
e4b
, 
i
, 
ac
->
ac_g_ex
.
ã_Ën
, &
ex
);

1962 
	`BUG_ON
(
ex
.
ã_Ën
 <= 0);

1963 ià(
ä“
 < 
ex
.
ã_Ën
) {

1964 
	`ext4_g½_locked_”rÜ
(
sb
, 
e4b
->
bd_group
, 0, 0,

1967 
ä“
, 
ex
.
ã_Ën
);

1968 
	`ext4_m¬k_group_b™m­_cÜru±ed
(
sb
, 
e4b
->
bd_group
,

1969 
EXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1977 
ex
.
ã_logiÿl
 = 0xDEADC0DE;

1978 
	`ext4_mb_m—su»_ex‹Á
(
ac
, &
ex
, 
e4b
);

1980 
i
 +ğ
ex
.
ã_Ën
;

1981 
ä“
 -ğ
ex
.
ã_Ën
;

1984 
	`ext4_mb_check_lim™s
(
ac
, 
e4b
, 1);

1985 
	}
}

1991 
nošlše_fÜ_¡ack


1992 
	$ext4_mb_sÿn_®igÃd
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

1993 
ext4_buddy
 *
e4b
)

1995 
su³r_block
 *
sb
 = 
ac
->
ac_sb
;

1996 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1997 *
b™m­
 = 
e4b
->
bd_b™m­
;

1998 
ext4_ä“_ex‹Á
 
ex
;

1999 
ext4_fsblk_t
 
fœ¡_group_block
;

2000 
ext4_fsblk_t
 
a
;

2001 
ext4_g½blk_t
 
i
;

2002 
max
;

2004 
	`BUG_ON
(
sbi
->
s_¡re
 == 0);

2007 
fœ¡_group_block
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
e4b
->
bd_group
);

2009 
a
 = 
fœ¡_group_block
 + 
sbi
->
s_¡re
 - 1;

2010 
	`do_div
(
a
, 
sbi
->
s_¡re
);

2011 
i
 = (
a
 * 
sbi
->
s_¡re
è- 
fœ¡_group_block
;

2013 
i
 < 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
)) {

2014 ià(!
	`mb_‹¡_b™
(
i
, 
b™m­
)) {

2015 
max
 = 
	`mb_fšd_ex‹Á
(
e4b
, 
i
, 
sbi
->
s_¡re
, &
ex
);

2016 ià(
max
 >ğ
sbi
->
s_¡re
) {

2017 
ac
->
ac_found
++;

2018 
ex
.
ã_logiÿl
 = 0xDEADF00D;

2019 
ac
->
ac_b_ex
 = 
ex
;

2020 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

2024 
i
 +ğ
sbi
->
s_¡re
;

2026 
	}
}

2034 
	$ext4_mb_good_group
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

2035 
ext4_group_t
 
group
, 
ü
)

2037 
ä“
, 
äagm’ts
;

2038 
æex_size
 = 
	`ext4_æex_bg_size
(
	`EXT4_SB
(
ac
->
ac_sb
));

2039 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
ac
->
ac_sb
, 
group
);

2041 
	`BUG_ON
(
ü
 < 0 || cr >= 4);

2043 
ä“
 = 
g½
->
bb_ä“
;

2044 ià(
ä“
 == 0)

2046 ià(
ü
 <ğ2 && 
ä“
 < 
ac
->
ac_g_ex
.
ã_Ën
)

2049 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(
g½
)))

2053 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_NEED_INIT
(
g½
))) {

2054 
»t
 = 
	`ext4_mb_š™_group
(
ac
->
ac_sb
, 
group
, 
GFP_NOFS
);

2055 ià(
»t
)

2056  
»t
;

2059 
äagm’ts
 = 
g½
->
bb_äagm’ts
;

2060 ià(
äagm’ts
 == 0)

2063 
ü
) {

2065 
	`BUG_ON
(
ac
->
ac_2Üd”
 == 0);

2068 ià((
ac
->
ac_æags
 & 
EXT4_MB_HINT_DATA
) &&

2069 (
æex_size
 >ğ
EXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
) &&

2070 ((
group
 % 
æex_size
) == 0))

2073 ià((
ac
->
ac_2Üd”
 >‡c->
ac_sb
->
s_blocksize_b™s
+1) ||

2074 (
ä“
 / 
äagm’ts
è>ğ
ac
->
ac_g_ex
.
ã_Ën
)

2077 ià(
g½
->
bb_Ïrge¡_ä“_Üd”
 < 
ac
->
ac_2Üd”
)

2082 ià((
ä“
 / 
äagm’ts
è>ğ
ac
->
ac_g_ex
.
ã_Ën
)

2086 ià(
ä“
 >ğ
ac
->
ac_g_ex
.
ã_Ën
)

2092 
	`BUG
();

2096 
	}
}

2098 
nošlše_fÜ_¡ack
 

2099 
	$ext4_mb_»guÏr_®loÿtÜ
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

2101 
ext4_group_t
 
ngroups
, 
group
, 
i
;

2102 
ü
;

2103 
”r
 = 0, 
fœ¡_”r
 = 0;

2104 
ext4_sb_šfo
 *
sbi
;

2105 
su³r_block
 *
sb
;

2106 
ext4_buddy
 
e4b
;

2108 
sb
 = 
ac
->
ac_sb
;

2109 
sbi
 = 
	`EXT4_SB
(
sb
);

2110 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

2112 ià(!(
	`ext4_‹¡_šode_æag
(
ac
->
ac_šode
, 
EXT4_INODE_EXTENTS
)))

2113 
ngroups
 = 
sbi
->
s_blockfe_groups
;

2115 
	`BUG_ON
(
ac
->
ac_¡©us
 =ğ
AC_STATUS_FOUND
);

2118 
”r
 = 
	`ext4_mb_fšd_by_gßl
(
ac
, &
e4b
);

2119 ià(
”r
 || 
ac
->
ac_¡©us
 =ğ
AC_STATUS_FOUND
)

2120 
out
;

2122 ià(
	`uÆik–y
(
ac
->
ac_æags
 & 
EXT4_MB_HINT_GOAL_ONLY
))

2123 
out
;

2130 
i
 = 
	`æs
(
ac
->
ac_g_ex
.
ã_Ën
);

2131 
ac
->
ac_2Üd”
 = 0;

2139 ià(
i
 >ğ
sbi
->
s_mb_Üd”2_»qs
 && i <ğ
sb
->
s_blocksize_b™s
 + 2) {

2143 ià((
ac
->
ac_g_ex
.
ã_Ën
 & (~(1 << (
i
 - 1)))) == 0)

2144 
ac
->
ac_2Üd”
 = 
	`¬¿y_šdex_no¥ec
(
i
 - 1,

2145 
sb
->
s_blocksize_b™s
 + 2);

2149 ià(
ac
->
ac_æags
 & 
EXT4_MB_STREAM_ALLOC
) {

2151 
	`¥š_lock
(&
sbi
->
s_md_lock
);

2152 
ac
->
ac_g_ex
.
ã_group
 = 
sbi
->
s_mb_Ï¡_group
;

2153 
ac
->
ac_g_ex
.
ã_¡¬t
 = 
sbi
->
s_mb_Ï¡_¡¬t
;

2154 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

2158 
ü
 = 
ac
->
ac_2Üd”
 ? 0 : 1;

2163 
»³©
:

2164 ; 
ü
 < 4 && 
ac
->
ac_¡©us
 =ğ
AC_STATUS_CONTINUE
; cr++) {

2165 
ac
->
ac_ü™”Ÿ
 = 
ü
;

2170 
group
 = 
ac
->
ac_g_ex
.
ã_group
;

2172 
i
 = 0; i < 
ngroups
; 
group
++, i++) {

2173 
»t
 = 0;

2174 
	`cÚd_»sched
();

2179 ià(
group
 >ğ
ngroups
)

2180 
group
 = 0;

2183 
»t
 = 
	`ext4_mb_good_group
(
ac
, 
group
, 
ü
);

2184 ià(
»t
 <= 0) {

2185 ià(!
fœ¡_”r
)

2186 
fœ¡_”r
 = 
»t
;

2190 
”r
 = 
	`ext4_mb_lßd_buddy
(
sb
, 
group
, &
e4b
);

2191 ià(
”r
)

2192 
out
;

2194 
	`ext4_lock_group
(
sb
, 
group
);

2200 
»t
 = 
	`ext4_mb_good_group
(
ac
, 
group
, 
ü
);

2201 ià(
»t
 <= 0) {

2202 
	`ext4_uÆock_group
(
sb
, 
group
);

2203 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

2204 ià(!
fœ¡_”r
)

2205 
fœ¡_”r
 = 
»t
;

2209 
ac
->
ac_groups_sÿÂed
++;

2210 ià(
ü
 == 0)

2211 
	`ext4_mb_sim¶e_sÿn_group
(
ac
, &
e4b
);

2212 ià(
ü
 =ğ1 && 
sbi
->
s_¡re
 &&

2213 !(
ac
->
ac_g_ex
.
ã_Ën
 % 
sbi
->
s_¡re
))

2214 
	`ext4_mb_sÿn_®igÃd
(
ac
, &
e4b
);

2216 
	`ext4_mb_com¶ex_sÿn_group
(
ac
, &
e4b
);

2218 
	`ext4_uÆock_group
(
sb
, 
group
);

2219 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

2221 ià(
ac
->
ac_¡©us
 !ğ
AC_STATUS_CONTINUE
)

2226 ià(
ac
->
ac_b_ex
.
ã_Ën
 > 0 &&‡c->
ac_¡©us
 !ğ
AC_STATUS_FOUND
 &&

2227 !(
ac
->
ac_æags
 & 
EXT4_MB_HINT_FIRST
)) {

2233 
	`ext4_mb_Œy_be¡_found
(
ac
, &
e4b
);

2234 ià(
ac
->
ac_¡©us
 !ğ
AC_STATUS_FOUND
) {

2241 
ac
->
ac_b_ex
.
ã_group
 = 0;

2242 
ac
->
ac_b_ex
.
ã_¡¬t
 = 0;

2243 
ac
->
ac_b_ex
.
ã_Ën
 = 0;

2244 
ac
->
ac_¡©us
 = 
AC_STATUS_CONTINUE
;

2245 
ac
->
ac_æags
 |ğ
EXT4_MB_HINT_FIRST
;

2246 
ü
 = 3;

2247 
	`©omic_šc
(&
sbi
->
s_mb_lo¡_chunks
);

2248 
»³©
;

2251 
out
:

2252 ià(!
”r
 && 
ac
->
ac_¡©us
 !ğ
AC_STATUS_FOUND
 && 
fœ¡_”r
)

2253 
”r
 = 
fœ¡_”r
;

2254  
”r
;

2255 
	}
}

2257 *
	$ext4_mb_£q_groups_¡¬t
(
£q_fe
 *
£q
, 
loff_t
 *
pos
)

2259 
su³r_block
 *
sb
 = 
	`PDE_DATA
(
	`fe_šode
(
£q
->
fe
));

2260 
ext4_group_t
 
group
;

2262 ià(*
pos
 < 0 || *po >ğ
	`ext4_g‘_groups_couÁ
(
sb
))

2263  
NULL
;

2264 
group
 = *
pos
 + 1;

2265  (*è((è
group
);

2266 
	}
}

2268 *
	$ext4_mb_£q_groups_Ãxt
(
£q_fe
 *
£q
, *
v
, 
loff_t
 *
pos
)

2270 
su³r_block
 *
sb
 = 
	`PDE_DATA
(
	`fe_šode
(
£q
->
fe
));

2271 
ext4_group_t
 
group
;

2273 ++*
pos
;

2274 ià(*
pos
 < 0 || *po >ğ
	`ext4_g‘_groups_couÁ
(
sb
))

2275  
NULL
;

2276 
group
 = *
pos
 + 1;

2277  (*è((è
group
);

2278 
	}
}

2280 
	$ext4_mb_£q_groups_show
(
£q_fe
 *
£q
, *
v
)

2282 
su³r_block
 *
sb
 = 
	`PDE_DATA
(
	`fe_šode
(
£q
->
fe
));

2283 
ext4_group_t
 
group
 = (ext4_group_tè((è
v
);

2284 
i
;

2285 
”r
, 
buddy_lßded
 = 0;

2286 
ext4_buddy
 
e4b
;

2287 
ext4_group_šfo
 *
gršfo
;

2288 
blocksize_b™s
 = 
	`mš_t
(,

2289 
sb
->
s_blocksize_b™s
,

2290 
EXT4_MAX_BLOCK_LOG_SIZE
);

2291 
	ssg
 {

2292 
ext4_group_šfo
 
šfo
;

2293 
ext4_g½blk_t
 
couÁ”s
[
EXT4_MAX_BLOCK_LOG_SIZE
 + 2];

2294 } 
sg
;

2296 
group
--;

2297 ià(
group
 == 0)

2298 
	`£q_puts
(
£q
, "#group: free frags first ["

2302 
i
 = (
blocksize_b™s
 + 2è* (
sg
.
šfo
.
bb_couÁ”s
[0]) +

2303 (
ext4_group_šfo
);

2305 
gršfo
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

2307 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_NEED_INIT
(
gršfo
))) {

2308 
”r
 = 
	`ext4_mb_lßd_buddy
(
sb
, 
group
, &
e4b
);

2309 ià(
”r
) {

2310 
	`£q_´štf
(
£q
, "#%-5u: I/Oƒ¼Ü\n", 
group
);

2313 
buddy_lßded
 = 1;

2316 
	`memıy
(&
sg
, 
	`ext4_g‘_group_šfo
(
sb
, 
group
), 
i
);

2318 ià(
buddy_lßded
)

2319 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

2321 
	`£q_´štf
(
£q
, "#%-5u: %-5u %-5u %-5u [", 
group
, 
sg
.
šfo
.
bb_ä“
,

2322 
sg
.
šfo
.
bb_äagm’ts
, sg.šfo.
bb_fœ¡_ä“
);

2323 
i
 = 0; i <= 13; i++)

2324 
	`£q_´štf
(
£q
, " %-5u", 
i
 <ğ
blocksize_b™s
 + 1 ?

2325 
sg
.
šfo
.
bb_couÁ”s
[
i
] : 0);

2326 
	`£q_´štf
(
£q
, " ]\n");

2329 
	}
}

2331 
	$ext4_mb_£q_groups_¡İ
(
£q_fe
 *
£q
, *
v
)

2333 
	}
}

2335 cÚ¡ 
£q_İ”©iÚs
 
	gext4_mb_£q_groups_İs
 = {

2336 .
¡¬t
 = 
ext4_mb_£q_groups_¡¬t
,

2337 .
	gÃxt
 = 
ext4_mb_£q_groups_Ãxt
,

2338 .
	g¡İ
 = 
ext4_mb_£q_groups_¡İ
,

2339 .
	gshow
 = 
ext4_mb_£q_groups_show
,

2342 
kmem_ÿche
 *
	$g‘_groupšfo_ÿche
(
blocksize_b™s
)

2344 
ÿche_šdex
 = 
blocksize_b™s
 - 
EXT4_MIN_BLOCK_LOG_SIZE
;

2345 
kmem_ÿche
 *
ÿch•
 = 
ext4_groupšfo_ÿches
[
ÿche_šdex
];

2347 
	`BUG_ON
(!
ÿch•
);

2348  
ÿch•
;

2349 
	}
}

2355 
	$ext4_mb_®loc_groupšfo
(
su³r_block
 *
sb
, 
ext4_group_t
 
ngroups
)

2357 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2358 
size
;

2359 
ext4_group_šfo
 ***
Ãw_groupšfo
;

2361 
size
 = (
ngroups
 + 
	`EXT4_DESC_PER_BLOCK
(
sb
) - 1) >>

2362 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
);

2363 ià(
size
 <ğ
sbi
->
s_group_šfo_size
)

2366 
size
 = 
	`roundup_pow_of_two
((*
sbi
->
s_group_šfo
) * size);

2367 
Ãw_groupšfo
 = 
	`kvz®loc
(
size
, 
GFP_KERNEL
);

2368 ià(!
Ãw_groupšfo
) {

2369 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't‡llocate buddy meta group");

2370  -
ENOMEM
;

2372 ià(
sbi
->
s_group_šfo
) {

2373 
	`memıy
(
Ãw_groupšfo
, 
sbi
->
s_group_šfo
,

2374 
sbi
->
s_group_šfo_size
 * (*sbi->
s_group_šfo
));

2375 
	`kvä“
(
sbi
->
s_group_šfo
);

2377 
sbi
->
s_group_šfo
 = 
Ãw_groupšfo
;

2378 
sbi
->
s_group_šfo_size
 = 
size
 / (*sbi->
s_group_šfo
);

2379 
	`ext4_debug
("allocated s_groupinfo‡rray for %d meta_bg's\n",

2380 
sbi
->
s_group_šfo_size
);

2382 
	}
}

2385 
	$ext4_mb_add_groupšfo
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

2386 
ext4_group_desc
 *
desc
)

2388 
i
;

2389 
m‘®’
 = 0;

2390 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2391 
ext4_group_šfo
 **
m‘a_group_šfo
;

2392 
kmem_ÿche
 *
ÿch•
 = 
	`g‘_groupšfo_ÿche
(
sb
->
s_blocksize_b™s
);

2399 ià(
group
 % 
	`EXT4_DESC_PER_BLOCK
(
sb
) == 0) {

2400 
m‘®’
 = (*
m‘a_group_šfo
) <<

2401 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
);

2402 
m‘a_group_šfo
 = 
	`km®loc
(
m‘®’
, 
GFP_NOFS
);

2403 ià(
m‘a_group_šfo
 =ğ
NULL
) {

2404 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't‡llocate mem "

2406 
ex™_m‘a_group_šfo
;

2408 
sbi
->
s_group_šfo
[
group
 >> 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
)] =

2409 
m‘a_group_šfo
;

2412 
m‘a_group_šfo
 =

2413 
sbi
->
s_group_šfo
[
group
 >> 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
)];

2414 
i
 = 
group
 & (
	`EXT4_DESC_PER_BLOCK
(
sb
) - 1);

2416 
m‘a_group_šfo
[
i
] = 
	`kmem_ÿche_z®loc
(
ÿch•
, 
GFP_NOFS
);

2417 ià(
m‘a_group_šfo
[
i
] =ğ
NULL
) {

2418 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't‡llocate buddy mem");

2419 
ex™_group_šfo
;

2421 
	`£t_b™
(
EXT4_GROUP_INFO_NEED_INIT_BIT
,

2422 &(
m‘a_group_šfo
[
i
]->
bb_¡©e
));

2428 ià(
	`ext4_has_group_desc_csum
(
sb
) &&

2429 (
desc
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_BLOCK_UNINIT
))) {

2430 
m‘a_group_šfo
[
i
]->
bb_ä“
 =

2431 
	`ext4_ä“_şu¡”s_aá”_š™
(
sb
, 
group
, 
desc
);

2433 
m‘a_group_šfo
[
i
]->
bb_ä“
 =

2434 
	`ext4_ä“_group_şu¡”s
(
sb
, 
desc
);

2437 
	`INIT_LIST_HEAD
(&
m‘a_group_šfo
[
i
]->
bb_´—Îoc_li¡
);

2438 
	`š™_rw£m
(&
m‘a_group_šfo
[
i
]->
®loc_£m
);

2439 
m‘a_group_šfo
[
i
]->
bb_ä“_roÙ
 = 
RB_ROOT
;

2440 
m‘a_group_šfo
[
i
]->
bb_Ïrge¡_ä“_Üd”
 = -1;

2442 #ifdeà
DOUBLE_CHECK


2444 
bufãr_h—d
 *
bh
;

2445 
m‘a_group_šfo
[
i
]->
bb_b™m­
 =

2446 
	`km®loc
(
sb
->
s_blocksize
, 
GFP_NOFS
);

2447 
	`BUG_ON
(
m‘a_group_šfo
[
i
]->
bb_b™m­
 =ğ
NULL
);

2448 
bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
group
);

2449 
	`BUG_ON
(
	`IS_ERR_OR_NULL
(
bh
));

2450 
	`memıy
(
m‘a_group_šfo
[
i
]->
bb_b™m­
, 
bh
->
b_d©a
,

2451 
sb
->
s_blocksize
);

2452 
	`put_bh
(
bh
);

2458 
ex™_group_šfo
:

2460 ià(
group
 % 
	`EXT4_DESC_PER_BLOCK
(
sb
) == 0) {

2461 
	`kä“
(
sbi
->
s_group_šfo
[
group
 >> 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
)]);

2462 
sbi
->
s_group_šfo
[
group
 >> 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
)] = 
NULL
;

2464 
ex™_m‘a_group_šfo
:

2465  -
ENOMEM
;

2466 
	}
}

2468 
	$ext4_mb_š™_back’d
(
su³r_block
 *
sb
)

2470 
ext4_group_t
 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

2471 
ext4_group_t
 
i
;

2472 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2473 
”r
;

2474 
ext4_group_desc
 *
desc
;

2475 
kmem_ÿche
 *
ÿch•
;

2477 
”r
 = 
	`ext4_mb_®loc_groupšfo
(
sb
, 
ngroups
);

2478 ià(
”r
)

2479  
”r
;

2481 
sbi
->
s_buddy_ÿche
 = 
	`Ãw_šode
(
sb
);

2482 ià(
sbi
->
s_buddy_ÿche
 =ğ
NULL
) {

2483 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't get‚ew inode");

2484 
”r_ä“sgi
;

2490 
sbi
->
s_buddy_ÿche
->
i_šo
 = 
EXT4_BAD_INO
;

2491 
	`EXT4_I
(
sbi
->
s_buddy_ÿche
)->
i_disksize
 = 0;

2492 
i
 = 0; i < 
ngroups
; i++) {

2493 
	`cÚd_»sched
();

2494 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

2495 ià(
desc
 =ğ
NULL
) {

2496 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ÿn'ˆ»ad desütÜ %u", 
i
);

2497 
”r_ä“buddy
;

2499 ià(
	`ext4_mb_add_groupšfo
(
sb
, 
i
, 
desc
) != 0)

2500 
”r_ä“buddy
;

2505 
”r_ä“buddy
:

2506 
ÿch•
 = 
	`g‘_groupšfo_ÿche
(
sb
->
s_blocksize_b™s
);

2507 
i
-- > 0)

2508 
	`kmem_ÿche_ä“
(
ÿch•
, 
	`ext4_g‘_group_šfo
(
sb
, 
i
));

2509 
i
 = 
sbi
->
s_group_šfo_size
;

2510 
i
-- > 0)

2511 
	`kä“
(
sbi
->
s_group_šfo
[
i
]);

2512 
	`ut
(
sbi
->
s_buddy_ÿche
);

2513 
”r_ä“sgi
:

2514 
	`kvä“
(
sbi
->
s_group_šfo
);

2515  -
ENOMEM
;

2516 
	}
}

2518 
	$ext4_groupšfo_de¡roy_¦abs
()

2520 
i
;

2522 
i
 = 0; i < 
NR_GRPINFO_CACHES
; i++) {

2523 
	`kmem_ÿche_de¡roy
(
ext4_groupšfo_ÿches
[
i
]);

2524 
ext4_groupšfo_ÿches
[
i
] = 
NULL
;

2526 
	}
}

2528 
	$ext4_groupšfo_ü—‹_¦ab
(
size_t
 
size
)

2530 
	`DEFINE_MUTEX
(
ext4_g½šfo_¦ab_ü—‹_mu‹x
);

2531 
¦ab_size
;

2532 
blocksize_b™s
 = 
	`Üd”_ba£_2
(
size
);

2533 
ÿche_šdex
 = 
blocksize_b™s
 - 
EXT4_MIN_BLOCK_LOG_SIZE
;

2534 
kmem_ÿche
 *
ÿch•
;

2536 ià(
ÿche_šdex
 >ğ
NR_GRPINFO_CACHES
)

2537  -
EINVAL
;

2539 ià(
	`uÆik–y
(
ÿche_šdex
 < 0))

2540 
ÿche_šdex
 = 0;

2542 
	`mu‹x_lock
(&
ext4_g½šfo_¦ab_ü—‹_mu‹x
);

2543 ià(
ext4_groupšfo_ÿches
[
ÿche_šdex
]) {

2544 
	`mu‹x_uÆock
(&
ext4_g½šfo_¦ab_ü—‹_mu‹x
);

2548 
¦ab_size
 = 
	`off£tof
(
ext4_group_šfo
,

2549 
bb_couÁ”s
[
blocksize_b™s
 + 2]);

2551 
ÿch•
 = 
	`kmem_ÿche_ü—‹
(
ext4_groupšfo_¦ab_Çmes
[
ÿche_šdex
],

2552 
¦ab_size
, 0, 
SLAB_RECLAIM_ACCOUNT
,

2553 
NULL
);

2555 
ext4_groupšfo_ÿches
[
ÿche_šdex
] = 
ÿch•
;

2557 
	`mu‹x_uÆock
(&
ext4_g½šfo_¦ab_ü—‹_mu‹x
);

2558 ià(!
ÿch•
) {

2559 
	`´štk
(
KERN_EMERG


2561  -
ENOMEM
;

2565 
	}
}

2567 
	$ext4_mb_š™
(
su³r_block
 *
sb
)

2569 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2570 
i
, 
j
;

2571 
off£t
, 
off£t_šü
;

2572 
max
;

2573 
»t
;

2575 
i
 = (
sb
->
s_blocksize_b™s
 + 2è* (*
sbi
->
s_mb_off£ts
);

2577 
sbi
->
s_mb_off£ts
 = 
	`km®loc
(
i
, 
GFP_KERNEL
);

2578 ià(
sbi
->
s_mb_off£ts
 =ğ
NULL
) {

2579 
»t
 = -
ENOMEM
;

2580 
out
;

2583 
i
 = (
sb
->
s_blocksize_b™s
 + 2è* (*
sbi
->
s_mb_maxs
);

2584 
sbi
->
s_mb_maxs
 = 
	`km®loc
(
i
, 
GFP_KERNEL
);

2585 ià(
sbi
->
s_mb_maxs
 =ğ
NULL
) {

2586 
»t
 = -
ENOMEM
;

2587 
out
;

2590 
»t
 = 
	`ext4_groupšfo_ü—‹_¦ab
(
sb
->
s_blocksize
);

2591 ià(
»t
 < 0)

2592 
out
;

2595 
sbi
->
s_mb_maxs
[0] = 
sb
->
s_blocksize
 << 3;

2596 
sbi
->
s_mb_off£ts
[0] = 0;

2598 
i
 = 1;

2599 
off£t
 = 0;

2600 
off£t_šü
 = 1 << (
sb
->
s_blocksize_b™s
 - 1);

2601 
max
 = 
sb
->
s_blocksize
 << 2;

2603 
sbi
->
s_mb_off£ts
[
i
] = 
off£t
;

2604 
sbi
->
s_mb_maxs
[
i
] = 
max
;

2605 
off£t
 +ğ
off£t_šü
;

2606 
off£t_šü
 = offset_incr >> 1;

2607 
max
 = max >> 1;

2608 
i
++;

2609 } 
i
 <ğ
sb
->
s_blocksize_b™s
 + 1);

2611 
	`¥š_lock_š™
(&
sbi
->
s_md_lock
);

2612 
	`¥š_lock_š™
(&
sbi
->
s_b®_lock
);

2613 
sbi
->
s_mb_ä“_³ndšg
 = 0;

2614 
	`INIT_LIST_HEAD
(&
sbi
->
s_ä“d_d©a_li¡
);

2616 
sbi
->
s_mb_max_to_sÿn
 = 
MB_DEFAULT_MAX_TO_SCAN
;

2617 
sbi
->
s_mb_mš_to_sÿn
 = 
MB_DEFAULT_MIN_TO_SCAN
;

2618 
sbi
->
s_mb_¡©s
 = 
MB_DEFAULT_STATS
;

2619 
sbi
->
s_mb_¡»am_»que¡
 = 
MB_DEFAULT_STREAM_THRESHOLD
;

2620 
sbi
->
s_mb_Üd”2_»qs
 = 
MB_DEFAULT_ORDER2_REQS
;

2633 
sbi
->
s_mb_group_´—Îoc
 = 
	`max
(
MB_DEFAULT_GROUP_PREALLOC
 >>

2634 
sbi
->
s_şu¡”_b™s
, 32);

2643 ià(
sbi
->
s_¡re
 > 1) {

2644 
sbi
->
s_mb_group_´—Îoc
 = 
	`roundup
(

2645 
sbi
->
s_mb_group_´—Îoc
, sbi->
s_¡re
);

2648 
sbi
->
s_loÿl™y_groups
 = 
	`®loc_³rıu
(
ext4_loÿl™y_group
);

2649 ià(
sbi
->
s_loÿl™y_groups
 =ğ
NULL
) {

2650 
»t
 = -
ENOMEM
;

2651 
out
;

2653 
	`fÜ_—ch_possibË_ıu
(
i
) {

2654 
ext4_loÿl™y_group
 *
lg
;

2655 
lg
 = 
	`³r_ıu_±r
(
sbi
->
s_loÿl™y_groups
, 
i
);

2656 
	`mu‹x_š™
(&
lg
->
lg_mu‹x
);

2657 
j
 = 0; j < 
PREALLOC_TB_SIZE
; j++)

2658 
	`INIT_LIST_HEAD
(&
lg
->
lg_´—Îoc_li¡
[
j
]);

2659 
	`¥š_lock_š™
(&
lg
->
lg_´—Îoc_lock
);

2663 
»t
 = 
	`ext4_mb_š™_back’d
(
sb
);

2664 ià(
»t
 != 0)

2665 
out_ä“_loÿl™y_groups
;

2669 
out_ä“_loÿl™y_groups
:

2670 
	`ä“_³rıu
(
sbi
->
s_loÿl™y_groups
);

2671 
sbi
->
s_loÿl™y_groups
 = 
NULL
;

2672 
out
:

2673 
	`kä“
(
sbi
->
s_mb_off£ts
);

2674 
sbi
->
s_mb_off£ts
 = 
NULL
;

2675 
	`kä“
(
sbi
->
s_mb_maxs
);

2676 
sbi
->
s_mb_maxs
 = 
NULL
;

2677  
»t
;

2678 
	}
}

2681 
	$ext4_mb_ş—nup_·
(
ext4_group_šfo
 *
g½
)

2683 
ext4_´—Îoc_¥aû
 *
·
;

2684 
li¡_h—d
 *
cur
, *
tmp
;

2685 
couÁ
 = 0;

2687 
	`li¡_fÜ_—ch_§ã
(
cur
, 
tmp
, &
g½
->
bb_´—Îoc_li¡
) {

2688 
·
 = 
	`li¡_’Œy
(
cur
, 
ext4_´—Îoc_¥aû
, 
·_group_li¡
);

2689 
	`li¡_d–
(&
·
->
·_group_li¡
);

2690 
couÁ
++;

2691 
	`kmem_ÿche_ä“
(
ext4_p¥aû_ÿch•
, 
·
);

2693 ià(
couÁ
)

2694 
	`mb_debug
(1, "mb®loc: %u PA Ëá\n", 
couÁ
);

2696 
	}
}

2698 
	$ext4_mb_»Ëa£
(
su³r_block
 *
sb
)

2700 
ext4_group_t
 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

2701 
ext4_group_t
 
i
;

2702 
num_m‘a_group_šfos
;

2703 
ext4_group_šfo
 *
gršfo
;

2704 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2705 
kmem_ÿche
 *
ÿch•
 = 
	`g‘_groupšfo_ÿche
(
sb
->
s_blocksize_b™s
);

2707 ià(
sbi
->
s_group_šfo
) {

2708 
i
 = 0; i < 
ngroups
; i++) {

2709 
	`cÚd_»sched
();

2710 
gršfo
 = 
	`ext4_g‘_group_šfo
(
sb
, 
i
);

2711 #ifdeà
DOUBLE_CHECK


2712 
	`kä“
(
gršfo
->
bb_b™m­
);

2714 
	`ext4_lock_group
(
sb
, 
i
);

2715 
	`ext4_mb_ş—nup_·
(
gršfo
);

2716 
	`ext4_uÆock_group
(
sb
, 
i
);

2717 
	`kmem_ÿche_ä“
(
ÿch•
, 
gršfo
);

2719 
num_m‘a_group_šfos
 = (
ngroups
 +

2720 
	`EXT4_DESC_PER_BLOCK
(
sb
) - 1) >>

2721 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
);

2722 
i
 = 0; i < 
num_m‘a_group_šfos
; i++)

2723 
	`kä“
(
sbi
->
s_group_šfo
[
i
]);

2724 
	`kvä“
(
sbi
->
s_group_šfo
);

2726 
	`kä“
(
sbi
->
s_mb_off£ts
);

2727 
	`kä“
(
sbi
->
s_mb_maxs
);

2728 
	`ut
(
sbi
->
s_buddy_ÿche
);

2729 ià(
sbi
->
s_mb_¡©s
) {

2730 
	`ext4_msg
(
sb
, 
KERN_INFO
,

2732 
	`©omic_»ad
(&
sbi
->
s_b®_®loÿ‹d
),

2733 
	`©omic_»ad
(&
sbi
->
s_b®_»qs
),

2734 
	`©omic_»ad
(&
sbi
->
s_b®_sucûss
));

2735 
	`ext4_msg
(
sb
, 
KERN_INFO
,

2738 
	`©omic_»ad
(&
sbi
->
s_b®_ex_sÿÂed
),

2739 
	`©omic_»ad
(&
sbi
->
s_b®_gßls
),

2740 
	`©omic_»ad
(&
sbi
->
s_b®_2Üd”s
),

2741 
	`©omic_»ad
(&
sbi
->
s_b®_b»aks
),

2742 
	`©omic_»ad
(&
sbi
->
s_mb_lo¡_chunks
));

2743 
	`ext4_msg
(
sb
, 
KERN_INFO
,

2745 
sbi
->
s_mb_budd›s_g’”©ed
,

2746 
sbi
->
s_mb_g’”©iÚ_time
);

2747 
	`ext4_msg
(
sb
, 
KERN_INFO
,

2749 
	`©omic_»ad
(&
sbi
->
s_mb_´—Îoÿ‹d
),

2750 
	`©omic_»ad
(&
sbi
->
s_mb_disÿrded
));

2753 
	`ä“_³rıu
(
sbi
->
s_loÿl™y_groups
);

2756 
	}
}

2758 
šlše
 
	$ext4_issue_disÿrd
(
su³r_block
 *
sb
,

2759 
ext4_group_t
 
block_group
, 
ext4_g½blk_t
 
şu¡”
, 
couÁ
,

2760 
bio
 **
biİ
)

2762 
ext4_fsblk_t
 
disÿrd_block
;

2764 
disÿrd_block
 = (
	`EXT4_C2B
(
	`EXT4_SB
(
sb
), 
şu¡”
) +

2765 
	`ext4_group_fœ¡_block_no
(
sb
, 
block_group
));

2766 
couÁ
 = 
	`EXT4_C2B
(
	`EXT4_SB
(
sb
), count);

2767 
	`Œaû_ext4_disÿrd_blocks
(
sb
,

2768 (è
disÿrd_block
, 
couÁ
);

2769 ià(
biİ
) {

2770  
	`__blkdev_issue_disÿrd
(
sb
->
s_bdev
,

2771 (
£ùÜ_t
)
disÿrd_block
 << (
sb
->
s_blocksize_b™s
 - 9),

2772 (
£ùÜ_t
)
couÁ
 << (
sb
->
s_blocksize_b™s
 - 9),

2773 
GFP_NOFS
, 0, 
biİ
);

2775  
	`sb_issue_disÿrd
(
sb
, 
disÿrd_block
, 
couÁ
, 
GFP_NOFS
, 0);

2776 
	}
}

2778 
	$ext4_ä“_d©a_š_buddy
(
su³r_block
 *
sb
,

2779 
ext4_ä“_d©a
 *
’Œy
)

2781 
ext4_buddy
 
e4b
;

2782 
ext4_group_šfo
 *
db
;

2783 
”r
, 
couÁ
 = 0, 
couÁ2
 = 0;

2785 
	`mb_debug
(1, "gonna free %u blocks in group %u (0x%p):",

2786 
’Œy
->
efd_couÁ
,ƒÁry->
efd_group
,ƒntry);

2788 
”r
 = 
	`ext4_mb_lßd_buddy
(
sb
, 
’Œy
->
efd_group
, &
e4b
);

2790 
	`BUG_ON
(
”r
 != 0);

2792 
	`¥š_lock
(&
	`EXT4_SB
(
sb
)->
s_md_lock
);

2793 
	`EXT4_SB
(
sb
)->
s_mb_ä“_³ndšg
 -ğ
’Œy
->
efd_couÁ
;

2794 
	`¥š_uÆock
(&
	`EXT4_SB
(
sb
)->
s_md_lock
);

2796 
db
 = 
e4b
.
bd_šfo
;

2798 
couÁ
 +ğ
’Œy
->
efd_couÁ
;

2799 
couÁ2
++;

2800 
	`ext4_lock_group
(
sb
, 
’Œy
->
efd_group
);

2802 
	`rb_”a£
(&
’Œy
->
efd_node
, &(
db
->
bb_ä“_roÙ
));

2803 
	`mb_ä“_blocks
(
NULL
, &
e4b
, 
’Œy
->
efd_¡¬t_şu¡”
,ƒÁry->
efd_couÁ
);

2811 ià(!
	`‹¡_İt
(
sb
, 
DISCARD
))

2812 
	`EXT4_MB_GRP_CLEAR_TRIMMED
(
db
);

2814 ià(!
db
->
bb_ä“_roÙ
.
rb_node
) {

2818 
	`put_·ge
(
e4b
.
bd_buddy_·ge
);

2819 
	`put_·ge
(
e4b
.
bd_b™m­_·ge
);

2821 
	`ext4_uÆock_group
(
sb
, 
’Œy
->
efd_group
);

2822 
	`kmem_ÿche_ä“
(
ext4_ä“_d©a_ÿch•
, 
’Œy
);

2823 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

2825 
	`mb_debug
(1, "ä“d %u block š %u sŒuùu»s\n", 
couÁ
, 
couÁ2
);

2826 
	}
}

2832 
	$ext4_´oûss_ä“d_d©a
(
su³r_block
 *
sb
, 
tid_t
 
comm™_tid
)

2834 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2835 
ext4_ä“_d©a
 *
’Œy
, *
tmp
;

2836 
bio
 *
disÿrd_bio
 = 
NULL
;

2837 
li¡_h—d
 
ä“d_d©a_li¡
;

2838 
li¡_h—d
 *
cut_pos
 = 
NULL
;

2839 
”r
;

2841 
	`INIT_LIST_HEAD
(&
ä“d_d©a_li¡
);

2843 
	`¥š_lock
(&
sbi
->
s_md_lock
);

2844 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, &
sbi
->
s_ä“d_d©a_li¡
, 
efd_li¡
) {

2845 ià(
’Œy
->
efd_tid
 !ğ
comm™_tid
)

2847 
cut_pos
 = &
’Œy
->
efd_li¡
;

2849 ià(
cut_pos
)

2850 
	`li¡_cut_pos™iÚ
(&
ä“d_d©a_li¡
, &
sbi
->
s_ä“d_d©a_li¡
,

2851 
cut_pos
);

2852 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

2854 ià(
	`‹¡_İt
(
sb
, 
DISCARD
)) {

2855 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, &
ä“d_d©a_li¡
, 
efd_li¡
) {

2856 
”r
 = 
	`ext4_issue_disÿrd
(
sb
, 
’Œy
->
efd_group
,

2857 
’Œy
->
efd_¡¬t_şu¡”
,

2858 
’Œy
->
efd_couÁ
,

2859 &
disÿrd_bio
);

2860 ià(
”r
 &&ƒ¼ !ğ-
EOPNOTSUPP
) {

2861 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "discard„equest in"

2863 " w™h %d", 
’Œy
->
efd_group
,

2864 
’Œy
->
efd_¡¬t_şu¡”
,

2865 
’Œy
->
efd_couÁ
, 
”r
);

2866 } ià(
”r
 =ğ-
EOPNOTSUPP
)

2870 ià(
disÿrd_bio
) {

2871 
	`subm™_bio_wa™
(
disÿrd_bio
);

2872 
	`bio_put
(
disÿrd_bio
);

2876 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
tmp
, &
ä“d_d©a_li¡
, 
efd_li¡
)

2877 
	`ext4_ä“_d©a_š_buddy
(
sb
, 
’Œy
);

2878 
	}
}

2880 
__š™
 
	$ext4_š™_mb®loc
()

2882 
ext4_p¥aû_ÿch•
 = 
	`KMEM_CACHE
(
ext4_´—Îoc_¥aû
,

2883 
SLAB_RECLAIM_ACCOUNT
);

2884 ià(
ext4_p¥aû_ÿch•
 =ğ
NULL
)

2885  -
ENOMEM
;

2887 
ext4_ac_ÿch•
 = 
	`KMEM_CACHE
(
ext4_®loÿtiÚ_cÚ‹xt
,

2888 
SLAB_RECLAIM_ACCOUNT
);

2889 ià(
ext4_ac_ÿch•
 =ğ
NULL
) {

2890 
	`kmem_ÿche_de¡roy
(
ext4_p¥aû_ÿch•
);

2891  -
ENOMEM
;

2894 
ext4_ä“_d©a_ÿch•
 = 
	`KMEM_CACHE
(
ext4_ä“_d©a
,

2895 
SLAB_RECLAIM_ACCOUNT
);

2896 ià(
ext4_ä“_d©a_ÿch•
 =ğ
NULL
) {

2897 
	`kmem_ÿche_de¡roy
(
ext4_p¥aû_ÿch•
);

2898 
	`kmem_ÿche_de¡roy
(
ext4_ac_ÿch•
);

2899  -
ENOMEM
;

2902 
	}
}

2904 
	$ext4_ex™_mb®loc
()

2910 
	`rcu_b¬r›r
();

2911 
	`kmem_ÿche_de¡roy
(
ext4_p¥aû_ÿch•
);

2912 
	`kmem_ÿche_de¡roy
(
ext4_ac_ÿch•
);

2913 
	`kmem_ÿche_de¡roy
(
ext4_ä“_d©a_ÿch•
);

2914 
	`ext4_groupšfo_de¡roy_¦abs
();

2915 
	}
}

2922 
nošlše_fÜ_¡ack
 

2923 
	$ext4_mb_m¬k_disk¥aû_u£d
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

2924 
hªdË_t
 *
hªdË
, 
»£rv_ş¡rs
)

2926 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

2927 
ext4_group_desc
 *
gdp
;

2928 
bufãr_h—d
 *
gdp_bh
;

2929 
ext4_sb_šfo
 *
sbi
;

2930 
su³r_block
 *
sb
;

2931 
ext4_fsblk_t
 
block
;

2932 
”r
, 
Ën
;

2934 
	`BUG_ON
(
ac
->
ac_¡©us
 !ğ
AC_STATUS_FOUND
);

2935 
	`BUG_ON
(
ac
->
ac_b_ex
.
ã_Ën
 <= 0);

2937 
sb
 = 
ac
->
ac_sb
;

2938 
sbi
 = 
	`EXT4_SB
(
sb
);

2940 
b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

2941 ià(
	`IS_ERR
(
b™m­_bh
)) {

2942 
”r
 = 
	`PTR_ERR
(
b™m­_bh
);

2943 
b™m­_bh
 = 
NULL
;

2944 
out_”r
;

2947 
	`BUFFER_TRACE
(
b™m­_bh
, "getting write‡ccess");

2948 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
b™m­_bh
);

2949 ià(
”r
)

2950 
out_”r
;

2952 
”r
 = -
EIO
;

2953 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
ac
->
ac_b_ex
.
ã_group
, &
gdp_bh
);

2954 ià(!
gdp
)

2955 
out_”r
;

2957 
	`ext4_debug
("usšg block grou°%u(%d)\n", 
ac
->
ac_b_ex
.
ã_group
,

2958 
	`ext4_ä“_group_şu¡”s
(
sb
, 
gdp
));

2960 
	`BUFFER_TRACE
(
gdp_bh
, "get_write_access");

2961 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
gdp_bh
);

2962 ià(
”r
)

2963 
out_”r
;

2965 
block
 = 
	`ext4_g½_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

2967 
Ën
 = 
	`EXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
ã_Ën
);

2968 ià(!
	`ext4_d©a_block_v®id
(
sbi
, 
block
, 
Ën
)) {

2969 
	`ext4_”rÜ
(
sb
, "Allocating blocks %llu-%llu which overlap "

2970 "f m‘ad©a", 
block
, block+
Ën
);

2975 
	`ext4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

2976 
	`ext4_£t_b™s
(
b™m­_bh
->
b_d©a
, 
ac
->
ac_b_ex
.
ã_¡¬t
,

2977 
ac
->
ac_b_ex
.
ã_Ën
);

2978 
	`ext4_uÆock_group
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

2979 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
b™m­_bh
);

2980 ià(!
”r
)

2981 
”r
 = -
EFSCORRUPTED
;

2982 
out_”r
;

2985 
	`ext4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

2986 #ifdeà
AGGRESSIVE_CHECK


2988 
i
;

2989 
i
 = 0; i < 
ac
->
ac_b_ex
.
ã_Ën
; i++) {

2990 
	`BUG_ON
(
	`mb_‹¡_b™
(
ac
->
ac_b_ex
.
ã_¡¬t
 + 
i
,

2991 
b™m­_bh
->
b_d©a
));

2995 
	`ext4_£t_b™s
(
b™m­_bh
->
b_d©a
, 
ac
->
ac_b_ex
.
ã_¡¬t
,

2996 
ac
->
ac_b_ex
.
ã_Ën
);

2997 ià(
	`ext4_has_group_desc_csum
(
sb
) &&

2998 (
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_BLOCK_UNINIT
))) {

2999 
gdp
->
bg_æags
 &ğ
	`ıu_to_Ë16
(~
EXT4_BG_BLOCK_UNINIT
);

3000 
	`ext4_ä“_group_şu¡”s_£t
(
sb
, 
gdp
,

3001 
	`ext4_ä“_şu¡”s_aá”_š™
(
sb
,

3002 
ac
->
ac_b_ex
.
ã_group
, 
gdp
));

3004 
Ën
 = 
	`ext4_ä“_group_şu¡”s
(
sb
, 
gdp
è- 
ac
->
ac_b_ex
.
ã_Ën
;

3005 
	`ext4_ä“_group_şu¡”s_£t
(
sb
, 
gdp
, 
Ën
);

3006 
	`ext4_block_b™m­_csum_£t
(
sb
, 
ac
->
ac_b_ex
.
ã_group
, 
gdp
, 
b™m­_bh
);

3007 
	`ext4_group_desc_csum_£t
(
sb
, 
ac
->
ac_b_ex
.
ã_group
, 
gdp
);

3009 
	`ext4_uÆock_group
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3010 
	`³rıu_couÁ”_sub
(&
sbi
->
s_ä“şu¡”s_couÁ”
, 
ac
->
ac_b_ex
.
ã_Ën
);

3014 ià(!(
ac
->
ac_æags
 & 
EXT4_MB_DELALLOC_RESERVED
))

3016 
	`³rıu_couÁ”_sub
(&
sbi
->
s_dœtyşu¡”s_couÁ”
,

3017 
»£rv_ş¡rs
);

3019 ià(
sbi
->
s_log_groups_³r_æex
) {

3020 
ext4_group_t
 
æex_group
 = 
	`ext4_æex_group
(
sbi
,

3021 
ac
->
ac_b_ex
.
ã_group
);

3022 
	`©omic64_sub
(
ac
->
ac_b_ex
.
ã_Ën
,

3023 &
sbi
->
s_æex_groups
[
æex_group
].
ä“_şu¡”s
);

3026 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
b™m­_bh
);

3027 ià(
”r
)

3028 
out_”r
;

3029 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
gdp_bh
);

3031 
out_”r
:

3032 
	`b»l£
(
b™m­_bh
);

3033  
”r
;

3034 
	}
}

3045 
	$ext4_mb_nÜm®ize_group_»que¡
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

3047 
su³r_block
 *
sb
 = 
ac
->
ac_sb
;

3048 
ext4_loÿl™y_group
 *
lg
 = 
ac
->
ac_lg
;

3050 
	`BUG_ON
(
lg
 =ğ
NULL
);

3051 
ac
->
ac_g_ex
.
ã_Ën
 = 
	`EXT4_SB
(
sb
)->
s_mb_group_´—Îoc
;

3052 
	`mb_debug
(1, "#%u: goal %u blocks for†ocality group\n",

3053 
cu¼’t
->
pid
, 
ac
->
ac_g_ex
.
ã_Ën
);

3054 
	}
}

3060 
nošlše_fÜ_¡ack
 

3061 
	$ext4_mb_nÜm®ize_»que¡
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

3062 
ext4_®loÿtiÚ_»que¡
 *
¬
)

3064 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

3065 
bsb™s
, 
max
;

3066 
ext4_lblk_t
 
’d
;

3067 
loff_t
 
size
, 
¡¬t_off
;

3068 
loff_t
 
Üig_size
 
__maybe_unu£d
;

3069 
ext4_lblk_t
 
¡¬t
;

3070 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
ac
->
ac_šode
);

3071 
ext4_´—Îoc_¥aû
 *
·
;

3075 ià(!(
ac
->
ac_æags
 & 
EXT4_MB_HINT_DATA
))

3079 ià(
	`uÆik–y
(
ac
->
ac_æags
 & 
EXT4_MB_HINT_GOAL_ONLY
))

3084 ià(
ac
->
ac_æags
 & 
EXT4_MB_HINT_NOPREALLOC
)

3087 ià(
ac
->
ac_æags
 & 
EXT4_MB_HINT_GROUP_ALLOC
) {

3088 
	`ext4_mb_nÜm®ize_group_»que¡
(
ac
);

3092 
bsb™s
 = 
ac
->
ac_sb
->
s_blocksize_b™s
;

3096 
size
 = 
ac
->
ac_o_ex
.
ã_logiÿl
 + 
	`EXT4_C2B
(
sbi
,‡c->ac_o_ex.
ã_Ën
);

3097 
size
 = siz<< 
bsb™s
;

3098 ià(
size
 < 
	`i_size_»ad
(
ac
->
ac_šode
))

3099 
size
 = 
	`i_size_»ad
(
ac
->
ac_šode
);

3100 
Üig_size
 = 
size
;

3103 
max
 = 2 << 
bsb™s
;

3105 
	#NRL_CHECK_SIZE
(
»q
, 
size
, 
max
, 
chunk_size
) \

3106 (
»q
 <ğ(
size
è|| 
max
 <ğ(
chunk_size
))

	)

3110 
¡¬t_off
 = 0;

3111 ià(
size
 <= 16 * 1024) {

3112 
size
 = 16 * 1024;

3113 } ià(
size
 <= 32 * 1024) {

3114 
size
 = 32 * 1024;

3115 } ià(
size
 <= 64 * 1024) {

3116 
size
 = 64 * 1024;

3117 } ià(
size
 <= 128 * 1024) {

3118 
size
 = 128 * 1024;

3119 } ià(
size
 <= 256 * 1024) {

3120 
size
 = 256 * 1024;

3121 } ià(
size
 <= 512 * 1024) {

3122 
size
 = 512 * 1024;

3123 } ià(
size
 <= 1024 * 1024) {

3124 
size
 = 1024 * 1024;

3125 } ià(
	`NRL_CHECK_SIZE
(
size
, 4 * 1024 * 1024, 
max
, 2 * 1024)) {

3126 
¡¬t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
ã_logiÿl
 >>

3127 (21 - 
bsb™s
)) << 21;

3128 
size
 = 2 * 1024 * 1024;

3129 } ià(
	`NRL_CHECK_SIZE
(
size
, 8 * 1024 * 1024, 
max
, 4 * 1024)) {

3130 
¡¬t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
ã_logiÿl
 >>

3131 (22 - 
bsb™s
)) << 22;

3132 
size
 = 4 * 1024 * 1024;

3133 } ià(
	`NRL_CHECK_SIZE
(
ac
->
ac_o_ex
.
ã_Ën
,

3134 (8<<20)>>
bsb™s
, 
max
, 8 * 1024)) {

3135 
¡¬t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
ã_logiÿl
 >>

3136 (23 - 
bsb™s
)) << 23;

3137 
size
 = 8 * 1024 * 1024;

3139 
¡¬t_off
 = (
loff_t
è
ac
->
ac_o_ex
.
ã_logiÿl
 << 
bsb™s
;

3140 
size
 = (
loff_t
è
	`EXT4_C2B
(
	`EXT4_SB
(
ac
->
ac_sb
),

3141 
ac
->
ac_o_ex
.
ã_Ën
è<< 
bsb™s
;

3143 
size
 = siz>> 
bsb™s
;

3144 
¡¬t
 = 
¡¬t_off
 >> 
bsb™s
;

3147 ià(
¬
->
¶eá
 && 
¡¬t
 <ğ¬->
Îeá
) {

3148 
size
 -ğ
¬
->
Îeá
 + 1 - 
¡¬t
;

3149 
¡¬t
 = 
¬
->
Îeá
 + 1;

3151 ià(
¬
->
´ight
 && 
¡¬t
 + 
size
 - 1 >ğ¬->
Ìight
)

3152 
size
 -ğ
¡¬t
 + siz- 
¬
->
Ìight
;

3158 ià(
size
 > 
	`EXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
))

3159 
size
 = 
	`EXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
);

3161 
’d
 = 
¡¬t
 + 
size
;

3164 
	`rcu_»ad_lock
();

3165 
	`li¡_fÜ_—ch_’Œy_rcu
(
·
, &
ei
->
i_´—Îoc_li¡
, 
·_šode_li¡
) {

3166 
ext4_lblk_t
 
·_’d
;

3168 ià(
·
->
·_d–‘ed
)

3170 
	`¥š_lock
(&
·
->
·_lock
);

3171 ià(
·
->
·_d–‘ed
) {

3172 
	`¥š_uÆock
(&
·
->
·_lock
);

3176 
·_’d
 = 
·
->
·_l¡¬t
 + 
	`EXT4_C2B
(
	`EXT4_SB
(
ac
->
ac_sb
),

3177 
·
->
·_Ën
);

3180 
	`BUG_ON
(!(
ac
->
ac_o_ex
.
ã_logiÿl
 >ğ
·_’d
 ||

3181 
ac
->
ac_o_ex
.
ã_logiÿl
 < 
·
->
·_l¡¬t
));

3184 ià(
·
->
·_l¡¬t
 >ğ
’d
 || 
·_’d
 <ğ
¡¬t
) {

3185 
	`¥š_uÆock
(&
·
->
·_lock
);

3188 
	`BUG_ON
(
·
->
·_l¡¬t
 <ğ
¡¬t
 && 
·_’d
 >ğ
’d
);

3191 ià(
·_’d
 <ğ
ac
->
ac_o_ex
.
ã_logiÿl
) {

3192 
	`BUG_ON
(
·_’d
 < 
¡¬t
);

3193 
¡¬t
 = 
·_’d
;

3194 } ià(
·
->
·_l¡¬t
 > 
ac
->
ac_o_ex
.
ã_logiÿl
) {

3195 
	`BUG_ON
(
·
->
·_l¡¬t
 > 
’d
);

3196 
’d
 = 
·
->
·_l¡¬t
;

3198 
	`¥š_uÆock
(&
·
->
·_lock
);

3200 
	`rcu_»ad_uÆock
();

3201 
size
 = 
’d
 - 
¡¬t
;

3204 
	`rcu_»ad_lock
();

3205 
	`li¡_fÜ_—ch_’Œy_rcu
(
·
, &
ei
->
i_´—Îoc_li¡
, 
·_šode_li¡
) {

3206 
ext4_lblk_t
 
·_’d
;

3208 
	`¥š_lock
(&
·
->
·_lock
);

3209 ià(
·
->
·_d–‘ed
 == 0) {

3210 
·_’d
 = 
·
->
·_l¡¬t
 + 
	`EXT4_C2B
(
	`EXT4_SB
(
ac
->
ac_sb
),

3211 
·
->
·_Ën
);

3212 
	`BUG_ON
(!(
¡¬t
 >ğ
·_’d
 || 
’d
 <ğ
·
->
·_l¡¬t
));

3214 
	`¥š_uÆock
(&
·
->
·_lock
);

3216 
	`rcu_»ad_uÆock
();

3218 ià(
¡¬t
 + 
size
 <ğ
ac
->
ac_o_ex
.
ã_logiÿl
 &&

3219 
¡¬t
 > 
ac
->
ac_o_ex
.
ã_logiÿl
) {

3220 
	`ext4_msg
(
ac
->
ac_sb
, 
KERN_ERR
,

3222 (è
¡¬t
, (è
size
,

3223 (è
ac
->
ac_o_ex
.
ã_logiÿl
);

3224 
	`BUG
();

3226 
	`BUG_ON
(
size
 <ğ0 || siz> 
	`EXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
));

3232 
ac
->
ac_g_ex
.
ã_logiÿl
 = 
¡¬t
;

3233 
ac
->
ac_g_ex
.
ã_Ën
 = 
	`EXT4_NUM_B2C
(
sbi
, 
size
);

3236 ià(
¬
->
´ight
 && (¬->
Ìight
 =ğ(
¡¬t
 + 
size
))) {

3238 
	`ext4_g‘_group_no_ªd_off£t
(
ac
->
ac_sb
, 
¬
->
´ight
 - 
size
,

3239 &
ac
->
ac_f_ex
.
ã_group
,

3240 &
ac
->
ac_f_ex
.
ã_¡¬t
);

3241 
ac
->
ac_æags
 |ğ
EXT4_MB_HINT_TRY_GOAL
;

3243 ià(
¬
->
¶eá
 && (¬->
Îeá
 + 1 =ğ
¡¬t
)) {

3245 
	`ext4_g‘_group_no_ªd_off£t
(
ac
->
ac_sb
, 
¬
->
¶eá
 + 1,

3246 &
ac
->
ac_f_ex
.
ã_group
,

3247 &
ac
->
ac_f_ex
.
ã_¡¬t
);

3248 
ac
->
ac_æags
 |ğ
EXT4_MB_HINT_TRY_GOAL
;

3251 
	`mb_debug
(1, "gßl: %u(wa %uèblock © %u\n", (è
size
,

3252 (è
Üig_size
, (è
¡¬t
);

3253 
	}
}

3255 
	$ext4_mb_cŞËù_¡©s
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

3257 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

3259 ià(
sbi
->
s_mb_¡©s
 && 
ac
->
ac_g_ex
.
ã_Ën
 > 1) {

3260 
	`©omic_šc
(&
sbi
->
s_b®_»qs
);

3261 
	`©omic_add
(
ac
->
ac_b_ex
.
ã_Ën
, &
sbi
->
s_b®_®loÿ‹d
);

3262 ià(
ac
->
ac_b_ex
.
ã_Ën
 >ğac->
ac_o_ex
.fe_len)

3263 
	`©omic_šc
(&
sbi
->
s_b®_sucûss
);

3264 
	`©omic_add
(
ac
->
ac_found
, &
sbi
->
s_b®_ex_sÿÂed
);

3265 ià(
ac
->
ac_g_ex
.
ã_¡¬t
 =ğac->
ac_b_ex
.fe_start &&

3266 
ac
->
ac_g_ex
.
ã_group
 =ğac->
ac_b_ex
.fe_group)

3267 
	`©omic_šc
(&
sbi
->
s_b®_gßls
);

3268 ià(
ac
->
ac_found
 > 
sbi
->
s_mb_max_to_sÿn
)

3269 
	`©omic_šc
(&
sbi
->
s_b®_b»aks
);

3272 ià(
ac
->
ac_İ
 =ğ
EXT4_MB_HISTORY_ALLOC
)

3273 
	`Œaû_ext4_mb®loc_®loc
(
ac
);

3275 
	`Œaû_ext4_mb®loc_´—Îoc
(
ac
);

3276 
	}
}

3284 
	$ext4_disÿrd_®loÿ‹d_blocks
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

3286 
ext4_´—Îoc_¥aû
 *
·
 = 
ac
->
ac_·
;

3287 
ext4_buddy
 
e4b
;

3288 
”r
;

3290 ià(
·
 =ğ
NULL
) {

3291 ià(
ac
->
ac_f_ex
.
ã_Ën
 == 0)

3293 
”r
 = 
	`ext4_mb_lßd_buddy
(
ac
->
ac_sb
,‡c->
ac_f_ex
.
ã_group
, &
e4b
);

3294 ià(
”r
) {

3300 
	`WARN
(1, "mb_lßd_buddy faed (%d)", 
”r
);

3303 
	`ext4_lock_group
(
ac
->
ac_sb
,‡c->
ac_f_ex
.
ã_group
);

3304 
	`mb_ä“_blocks
(
ac
->
ac_šode
, &
e4b
,‡c->
ac_f_ex
.
ã_¡¬t
,

3305 
ac
->
ac_f_ex
.
ã_Ën
);

3306 
	`ext4_uÆock_group
(
ac
->
ac_sb
,‡c->
ac_f_ex
.
ã_group
);

3307 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

3310 ià(
·
->
·_ty³
 =ğ
MB_INODE_PA
)

3311 
·
->
·_ä“
 +ğ
ac
->
ac_b_ex
.
ã_Ën
;

3312 
	}
}

3317 
	$ext4_mb_u£_šode_·
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

3318 
ext4_´—Îoc_¥aû
 *
·
)

3320 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

3321 
ext4_fsblk_t
 
¡¬t
;

3322 
ext4_fsblk_t
 
’d
;

3323 
Ën
;

3326 
¡¬t
 = 
·
->
·_p¡¬t
 + (
ac
->
ac_o_ex
.
ã_logiÿl
 -…a->
·_l¡¬t
);

3327 
’d
 = 
	`mš
(
·
->
·_p¡¬t
 + 
	`EXT4_C2B
(
sbi
,…a->
·_Ën
),

3328 
¡¬t
 + 
	`EXT4_C2B
(
sbi
, 
ac
->
ac_o_ex
.
ã_Ën
));

3329 
Ën
 = 
	`EXT4_NUM_B2C
(
sbi
, 
’d
 - 
¡¬t
);

3330 
	`ext4_g‘_group_no_ªd_off£t
(
ac
->
ac_sb
, 
¡¬t
, &ac->
ac_b_ex
.
ã_group
,

3331 &
ac
->
ac_b_ex
.
ã_¡¬t
);

3332 
ac
->
ac_b_ex
.
ã_Ën
 = 
Ën
;

3333 
ac
->
ac_¡©us
 = 
AC_STATUS_FOUND
;

3334 
ac
->
ac_·
 = 
·
;

3336 
	`BUG_ON
(
¡¬t
 < 
·
->
·_p¡¬t
);

3337 
	`BUG_ON
(
’d
 > 
·
->
·_p¡¬t
 + 
	`EXT4_C2B
(
sbi
,…a->
·_Ën
));

3338 
	`BUG_ON
(
·
->
·_ä“
 < 
Ën
);

3339 
·
->
·_ä“
 -ğ
Ën
;

3341 
	`mb_debug
(1, "u£ %Îu/%u from inod· %p\n", 
¡¬t
, 
Ën
, 
·
);

3342 
	}
}

3347 
	$ext4_mb_u£_group_·
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

3348 
ext4_´—Îoc_¥aû
 *
·
)

3350 
Ën
 = 
ac
->
ac_o_ex
.
ã_Ën
;

3352 
	`ext4_g‘_group_no_ªd_off£t
(
ac
->
ac_sb
, 
·
->
·_p¡¬t
,

3353 &
ac
->
ac_b_ex
.
ã_group
,

3354 &
ac
->
ac_b_ex
.
ã_¡¬t
);

3355 
ac
->
ac_b_ex
.
ã_Ën
 = 
Ën
;

3356 
ac
->
ac_¡©us
 = 
AC_STATUS_FOUND
;

3357 
ac
->
ac_·
 = 
·
;

3365 
	`mb_debug
(1, "u£ %u/%u from grou°· %p\n", 
·
->
·_l¡¬t
-
Ën
,†en,…a);

3366 
	}
}

3374 
ext4_´—Îoc_¥aû
 *

3375 
	$ext4_mb_check_group_·
(
ext4_fsblk_t
 
gßl_block
,

3376 
ext4_´—Îoc_¥aû
 *
·
,

3377 
ext4_´—Îoc_¥aû
 *
ıa
)

3379 
ext4_fsblk_t
 
cur_di¡ªû
, 
Ãw_di¡ªû
;

3381 ià(
ıa
 =ğ
NULL
) {

3382 
	`©omic_šc
(&
·
->
·_couÁ
);

3383  
·
;

3385 
cur_di¡ªû
 = 
	`abs
(
gßl_block
 - 
ıa
->
·_p¡¬t
);

3386 
Ãw_di¡ªû
 = 
	`abs
(
gßl_block
 - 
·
->
·_p¡¬t
);

3388 ià(
cur_di¡ªû
 <ğ
Ãw_di¡ªû
)

3389  
ıa
;

3392 
	`©omic_dec
(&
ıa
->
·_couÁ
);

3393 
	`©omic_šc
(&
·
->
·_couÁ
);

3394  
·
;

3395 
	}
}

3400 
nošlše_fÜ_¡ack
 

3401 
	$ext4_mb_u£_´—Îoÿ‹d
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

3403 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

3404 
Üd”
, 
i
;

3405 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
ac
->
ac_šode
);

3406 
ext4_loÿl™y_group
 *
lg
;

3407 
ext4_´—Îoc_¥aû
 *
·
, *
ıa
 = 
NULL
;

3408 
ext4_fsblk_t
 
gßl_block
;

3411 ià(!(
ac
->
ac_æags
 & 
EXT4_MB_HINT_DATA
))

3415 
	`rcu_»ad_lock
();

3416 
	`li¡_fÜ_—ch_’Œy_rcu
(
·
, &
ei
->
i_´—Îoc_li¡
, 
·_šode_li¡
) {

3420 ià(
ac
->
ac_o_ex
.
ã_logiÿl
 < 
·
->
·_l¡¬t
 ||

3421 
ac
->
ac_o_ex
.
ã_logiÿl
 >ğ(
·
->
·_l¡¬t
 +

3422 
	`EXT4_C2B
(
sbi
, 
·
->
·_Ën
)))

3426 ià(!(
	`ext4_‹¡_šode_æag
(
ac
->
ac_šode
, 
EXT4_INODE_EXTENTS
)) &&

3427 (
·
->
·_p¡¬t
 + 
	`EXT4_C2B
(
sbi
,…a->
·_Ën
) >

3428 
EXT4_MAX_BLOCK_FILE_PHYS
))

3432 
	`¥š_lock
(&
·
->
·_lock
);

3433 ià(
·
->
·_d–‘ed
 =ğ0 &&…a->
·_ä“
) {

3434 
	`©omic_šc
(&
·
->
·_couÁ
);

3435 
	`ext4_mb_u£_šode_·
(
ac
, 
·
);

3436 
	`¥š_uÆock
(&
·
->
·_lock
);

3437 
ac
->
ac_ü™”Ÿ
 = 10;

3438 
	`rcu_»ad_uÆock
();

3441 
	`¥š_uÆock
(&
·
->
·_lock
);

3443 
	`rcu_»ad_uÆock
();

3446 ià(!(
ac
->
ac_æags
 & 
EXT4_MB_HINT_GROUP_ALLOC
))

3450 
lg
 = 
ac
->
ac_lg
;

3451 ià(
lg
 =ğ
NULL
)

3453 
Üd”
 = 
	`æs
(
ac
->
ac_o_ex
.
ã_Ën
) - 1;

3454 ià(
Üd”
 > 
PREALLOC_TB_SIZE
 - 1)

3456 
Üd”
 = 
PREALLOC_TB_SIZE
 - 1;

3458 
gßl_block
 = 
	`ext4_g½_offs_to_block
(
ac
->
ac_sb
, &ac->
ac_g_ex
);

3463 
i
 = 
Üd”
; i < 
PREALLOC_TB_SIZE
; i++) {

3464 
	`rcu_»ad_lock
();

3465 
	`li¡_fÜ_—ch_’Œy_rcu
(
·
, &
lg
->
lg_´—Îoc_li¡
[
i
],

3466 
·_šode_li¡
) {

3467 
	`¥š_lock
(&
·
->
·_lock
);

3468 ià(
·
->
·_d–‘ed
 == 0 &&

3469 
·
->
·_ä“
 >ğ
ac
->
ac_o_ex
.
ã_Ën
) {

3471 
ıa
 = 
	`ext4_mb_check_group_·
(
gßl_block
,

3472 
·
, 
ıa
);

3474 
	`¥š_uÆock
(&
·
->
·_lock
);

3476 
	`rcu_»ad_uÆock
();

3478 ià(
ıa
) {

3479 
	`ext4_mb_u£_group_·
(
ac
, 
ıa
);

3480 
ac
->
ac_ü™”Ÿ
 = 20;

3484 
	}
}

3492 
	$ext4_mb_g’”©e_äom_ä“li¡
(
su³r_block
 *
sb
, *
b™m­
,

3493 
ext4_group_t
 
group
)

3495 
rb_node
 *
n
;

3496 
ext4_group_šfo
 *
g½
;

3497 
ext4_ä“_d©a
 *
’Œy
;

3499 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

3500 
n
 = 
	`rb_fœ¡
(&(
g½
->
bb_ä“_roÙ
));

3502 
n
) {

3503 
’Œy
 = 
	`rb_’Œy
(
n
, 
ext4_ä“_d©a
, 
efd_node
);

3504 
	`ext4_£t_b™s
(
b™m­
, 
’Œy
->
efd_¡¬t_şu¡”
,ƒÁry->
efd_couÁ
);

3505 
n
 = 
	`rb_Ãxt
(n);

3508 
	}
}

3515 
nošlše_fÜ_¡ack


3516 
	$ext4_mb_g’”©e_äom_·
(
su³r_block
 *
sb
, *
b™m­
,

3517 
ext4_group_t
 
group
)

3519 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

3520 
ext4_´—Îoc_¥aû
 *
·
;

3521 
li¡_h—d
 *
cur
;

3522 
ext4_group_t
 
grou²r
;

3523 
ext4_g½blk_t
 
¡¬t
;

3524 
´—Îoÿ‹d
 = 0;

3525 
Ën
;

3535 
	`li¡_fÜ_—ch
(
cur
, &
g½
->
bb_´—Îoc_li¡
) {

3536 
·
 = 
	`li¡_’Œy
(
cur
, 
ext4_´—Îoc_¥aû
, 
·_group_li¡
);

3537 
	`¥š_lock
(&
·
->
·_lock
);

3538 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
·
->
·_p¡¬t
,

3539 &
grou²r
, &
¡¬t
);

3540 
Ën
 = 
·
->
·_Ën
;

3541 
	`¥š_uÆock
(&
·
->
·_lock
);

3542 ià(
	`uÆik–y
(
Ën
 == 0))

3544 
	`BUG_ON
(
grou²r
 !ğ
group
);

3545 
	`ext4_£t_b™s
(
b™m­
, 
¡¬t
, 
Ën
);

3546 
´—Îoÿ‹d
 +ğ
Ën
;

3548 
	`mb_debug
(1, "´—Îoÿ‹d %u fÜ grou°%u\n", 
´—Îoÿ‹d
, 
group
);

3549 
	}
}

3551 
	$ext4_mb_·_ÿÎback
(
rcu_h—d
 *
h—d
)

3553 
ext4_´—Îoc_¥aû
 *
·
;

3554 
·
 = 
	`cÚš”_of
(
h—d
, 
ext4_´—Îoc_¥aû
, 
u
.
·_rcu
);

3556 
	`BUG_ON
(
	`©omic_»ad
(&
·
->
·_couÁ
));

3557 
	`BUG_ON
(
·
->
·_d–‘ed
 == 0);

3558 
	`kmem_ÿche_ä“
(
ext4_p¥aû_ÿch•
, 
·
);

3559 
	}
}

3565 
	$ext4_mb_put_·
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

3566 
su³r_block
 *
sb
, 
ext4_´—Îoc_¥aû
 *
·
)

3568 
ext4_group_t
 
g½
;

3569 
ext4_fsblk_t
 
g½_blk
;

3572 
	`¥š_lock
(&
·
->
·_lock
);

3573 ià(!
	`©omic_dec_ªd_‹¡
(&
·
->
·_couÁ
è||…a->
·_ä“
 != 0) {

3574 
	`¥š_uÆock
(&
·
->
·_lock
);

3578 ià(
·
->
·_d–‘ed
 == 1) {

3579 
	`¥š_uÆock
(&
·
->
·_lock
);

3583 
·
->
·_d–‘ed
 = 1;

3584 
	`¥š_uÆock
(&
·
->
·_lock
);

3586 
g½_blk
 = 
·
->
·_p¡¬t
;

3591 ià(
·
->
·_ty³
 =ğ
MB_GROUP_PA
)

3592 
g½_blk
--;

3594 
g½
 = 
	`ext4_g‘_group_numb”
(
sb
, 
g½_blk
);

3610 
	`ext4_lock_group
(
sb
, 
g½
);

3611 
	`li¡_d–
(&
·
->
·_group_li¡
);

3612 
	`ext4_uÆock_group
(
sb
, 
g½
);

3614 
	`¥š_lock
(
·
->
·_obj_lock
);

3615 
	`li¡_d–_rcu
(&
·
->
·_šode_li¡
);

3616 
	`¥š_uÆock
(
·
->
·_obj_lock
);

3618 
	`ÿÎ_rcu
(&(
·
)->
u
.
·_rcu
, 
ext4_mb_·_ÿÎback
);

3619 
	}
}

3624 
nošlše_fÜ_¡ack
 

3625 
	$ext4_mb_Ãw_šode_·
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

3627 
su³r_block
 *
sb
 = 
ac
->
ac_sb
;

3628 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3629 
ext4_´—Îoc_¥aû
 *
·
;

3630 
ext4_group_šfo
 *
g½
;

3631 
ext4_šode_šfo
 *
ei
;

3634 
	`BUG_ON
(
ac
->
ac_o_ex
.
ã_Ën
 >ğac->
ac_b_ex
.fe_len);

3635 
	`BUG_ON
(
ac
->
ac_¡©us
 !ğ
AC_STATUS_FOUND
);

3636 
	`BUG_ON
(!
	`S_ISREG
(
ac
->
ac_šode
->
i_mode
));

3638 
·
 = 
	`kmem_ÿche_®loc
(
ext4_p¥aû_ÿch•
, 
GFP_NOFS
);

3639 ià(
·
 =ğ
NULL
)

3640  -
ENOMEM
;

3642 ià(
ac
->
ac_b_ex
.
ã_Ën
 <‡c->
ac_g_ex
.fe_len) {

3643 
wšl
;

3644 
wšs
;

3645 
wš
;

3646 
offs
;

3651 
	`BUG_ON
(
ac
->
ac_g_ex
.
ã_logiÿl
 >‡c->
ac_o_ex
.fe_logical);

3652 
	`BUG_ON
(
ac
->
ac_g_ex
.
ã_Ën
 <‡c->
ac_o_ex
.fe_len);

3657 
wšl
 = 
ac
->
ac_o_ex
.
ã_logiÿl
 -‡c->
ac_g_ex
.fe_logical;

3660 
wšs
 = 
	`EXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
ã_Ën
 -‡c->
ac_o_ex
.fe_len);

3663 
wš
 = 
	`mš
(
wšl
, 
wšs
);

3665 
offs
 = 
ac
->
ac_o_ex
.
ã_logiÿl
 %

3666 
	`EXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
ã_Ën
);

3667 ià(
offs
 && off < 
wš
)

3668 
wš
 = 
offs
;

3670 
ac
->
ac_b_ex
.
ã_logiÿl
 =‡c->
ac_o_ex
.fe_logical -

3671 
	`EXT4_NUM_B2C
(
sbi
, 
wš
);

3672 
	`BUG_ON
(
ac
->
ac_o_ex
.
ã_logiÿl
 <‡c->
ac_b_ex
.fe_logical);

3673 
	`BUG_ON
(
ac
->
ac_o_ex
.
ã_Ën
 >‡c->
ac_b_ex
.fe_len);

3678 
ac
->
ac_f_ex
 =‡c->
ac_b_ex
;

3680 
·
->
·_l¡¬t
 = 
ac
->
ac_b_ex
.
ã_logiÿl
;

3681 
·
->
·_p¡¬t
 = 
	`ext4_g½_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

3682 
·
->
·_Ën
 = 
ac
->
ac_b_ex
.
ã_Ën
;

3683 
·
->
·_ä“
 =…a->
·_Ën
;

3684 
	`©omic_£t
(&
·
->
·_couÁ
, 1);

3685 
	`¥š_lock_š™
(&
·
->
·_lock
);

3686 
	`INIT_LIST_HEAD
(&
·
->
·_šode_li¡
);

3687 
	`INIT_LIST_HEAD
(&
·
->
·_group_li¡
);

3688 
·
->
·_d–‘ed
 = 0;

3689 
·
->
·_ty³
 = 
MB_INODE_PA
;

3691 
	`mb_debug
(1, "Ãw inod· %p: %Îu/%u fÜ %u\n", 
·
,

3692 
·
->
·_p¡¬t
,…a->
·_Ën
,…a->
·_l¡¬t
);

3693 
	`Œaû_ext4_mb_Ãw_šode_·
(
ac
, 
·
);

3695 
	`ext4_mb_u£_šode_·
(
ac
, 
·
);

3696 
	`©omic_add
(
·
->
·_ä“
, &
sbi
->
s_mb_´—Îoÿ‹d
);

3698 
ei
 = 
	`EXT4_I
(
ac
->
ac_šode
);

3699 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3701 
·
->
·_obj_lock
 = &
ei
->
i_´—Îoc_lock
;

3702 
·
->
·_šode
 = 
ac
->
ac_šode
;

3704 
	`ext4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3705 
	`li¡_add
(&
·
->
·_group_li¡
, &
g½
->
bb_´—Îoc_li¡
);

3706 
	`ext4_uÆock_group
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3708 
	`¥š_lock
(
·
->
·_obj_lock
);

3709 
	`li¡_add_rcu
(&
·
->
·_šode_li¡
, &
ei
->
i_´—Îoc_li¡
);

3710 
	`¥š_uÆock
(
·
->
·_obj_lock
);

3713 
	}
}

3718 
nošlše_fÜ_¡ack
 

3719 
	$ext4_mb_Ãw_group_·
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

3721 
su³r_block
 *
sb
 = 
ac
->
ac_sb
;

3722 
ext4_loÿl™y_group
 *
lg
;

3723 
ext4_´—Îoc_¥aû
 *
·
;

3724 
ext4_group_šfo
 *
g½
;

3727 
	`BUG_ON
(
ac
->
ac_o_ex
.
ã_Ën
 >ğac->
ac_b_ex
.fe_len);

3728 
	`BUG_ON
(
ac
->
ac_¡©us
 !ğ
AC_STATUS_FOUND
);

3729 
	`BUG_ON
(!
	`S_ISREG
(
ac
->
ac_šode
->
i_mode
));

3731 
	`BUG_ON
(
ext4_p¥aû_ÿch•
 =ğ
NULL
);

3732 
·
 = 
	`kmem_ÿche_®loc
(
ext4_p¥aû_ÿch•
, 
GFP_NOFS
);

3733 ià(
·
 =ğ
NULL
)

3734  -
ENOMEM
;

3738 
ac
->
ac_f_ex
 =‡c->
ac_b_ex
;

3740 
·
->
·_p¡¬t
 = 
	`ext4_g½_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

3741 
·
->
·_l¡¬t
 =…a->
·_p¡¬t
;

3742 
·
->
·_Ën
 = 
ac
->
ac_b_ex
.
ã_Ën
;

3743 
·
->
·_ä“
 =…a->
·_Ën
;

3744 
	`©omic_£t
(&
·
->
·_couÁ
, 1);

3745 
	`¥š_lock_š™
(&
·
->
·_lock
);

3746 
	`INIT_LIST_HEAD
(&
·
->
·_šode_li¡
);

3747 
	`INIT_LIST_HEAD
(&
·
->
·_group_li¡
);

3748 
·
->
·_d–‘ed
 = 0;

3749 
·
->
·_ty³
 = 
MB_GROUP_PA
;

3751 
	`mb_debug
(1, "Ãw grou°· %p: %Îu/%u fÜ %u\n", 
·
,

3752 
·
->
·_p¡¬t
,…a->
·_Ën
,…a->
·_l¡¬t
);

3753 
	`Œaû_ext4_mb_Ãw_group_·
(
ac
, 
·
);

3755 
	`ext4_mb_u£_group_·
(
ac
, 
·
);

3756 
	`©omic_add
(
·
->
·_ä“
, &
	`EXT4_SB
(
sb
)->
s_mb_´—Îoÿ‹d
);

3758 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3759 
lg
 = 
ac
->
ac_lg
;

3760 
	`BUG_ON
(
lg
 =ğ
NULL
);

3762 
·
->
·_obj_lock
 = &
lg
->
lg_´—Îoc_lock
;

3763 
·
->
·_šode
 = 
NULL
;

3765 
	`ext4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3766 
	`li¡_add
(&
·
->
·_group_li¡
, &
g½
->
bb_´—Îoc_li¡
);

3767 
	`ext4_uÆock_group
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3774 
	}
}

3776 
	$ext4_mb_Ãw_´—ÎoÿtiÚ
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

3778 
”r
;

3780 ià(
ac
->
ac_æags
 & 
EXT4_MB_HINT_GROUP_ALLOC
)

3781 
”r
 = 
	`ext4_mb_Ãw_group_·
(
ac
);

3783 
”r
 = 
	`ext4_mb_Ãw_šode_·
(
ac
);

3784  
”r
;

3785 
	}
}

3795 
nošlše_fÜ_¡ack
 

3796 
	$ext4_mb_»Ëa£_šode_·
(
ext4_buddy
 *
e4b
, 
bufãr_h—d
 *
b™m­_bh
,

3797 
ext4_´—Îoc_¥aû
 *
·
)

3799 
su³r_block
 *
sb
 = 
e4b
->
bd_sb
;

3800 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3801 
’d
;

3802 
Ãxt
;

3803 
ext4_group_t
 
group
;

3804 
ext4_g½blk_t
 
b™
;

3805 
g½_blk_¡¬t
;

3806 
ä“
 = 0;

3808 
	`BUG_ON
(
·
->
·_d–‘ed
 == 0);

3809 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
·
->
·_p¡¬t
, &
group
, &
b™
);

3810 
g½_blk_¡¬t
 = 
·
->
·_p¡¬t
 - 
	`EXT4_C2B
(
sbi
, 
b™
);

3811 
	`BUG_ON
(
group
 !ğ
e4b
->
bd_group
 && 
·
->
·_Ën
 != 0);

3812 
’d
 = 
b™
 + 
·
->
·_Ën
;

3814 
b™
 < 
’d
) {

3815 
b™
 = 
	`mb_fšd_Ãxt_z”o_b™
(
b™m­_bh
->
b_d©a
, 
’d
, bit);

3816 ià(
b™
 >ğ
’d
)

3818 
Ãxt
 = 
	`mb_fšd_Ãxt_b™
(
b™m­_bh
->
b_d©a
, 
’d
, 
b™
);

3819 
	`mb_debug
(1, " free…reallocated %u/%u in group %u\n",

3820 (è
	`ext4_group_fœ¡_block_no
(
sb
, 
group
è+ 
b™
,

3821 (è
Ãxt
 - 
b™
, (è
group
);

3822 
ä“
 +ğ
Ãxt
 - 
b™
;

3824 
	`Œaû_ext4_mb®loc_disÿrd
(
sb
, 
NULL
, 
group
, 
b™
, 
Ãxt
 - bit);

3825 
	`Œaû_ext4_mb_»Ëa£_šode_·
(
·
, (
g½_blk_¡¬t
 +

3826 
	`EXT4_C2B
(
sbi
, 
b™
)),

3827 
Ãxt
 - 
b™
);

3828 
	`mb_ä“_blocks
(
·
->
·_šode
, 
e4b
, 
b™
, 
Ãxt
 - bit);

3829 
b™
 = 
Ãxt
 + 1;

3831 ià(
ä“
 !ğ
·
->
·_ä“
) {

3832 
	`ext4_msg
(
e4b
->
bd_sb
, 
KERN_CRIT
,

3834 
·
, (è·->
·_l¡¬t
,

3835 (è
·
->
·_p¡¬t
,

3836 (è
·
->
·_Ën
);

3837 
	`ext4_g½_locked_”rÜ
(
sb
, 
group
, 0, 0, "free %u,…a_free %u",

3838 
ä“
, 
·
->
·_ä“
);

3844 
	`©omic_add
(
ä“
, &
sbi
->
s_mb_disÿrded
);

3847 
	}
}

3849 
nošlše_fÜ_¡ack
 

3850 
	$ext4_mb_»Ëa£_group_·
(
ext4_buddy
 *
e4b
,

3851 
ext4_´—Îoc_¥aû
 *
·
)

3853 
su³r_block
 *
sb
 = 
e4b
->
bd_sb
;

3854 
ext4_group_t
 
group
;

3855 
ext4_g½blk_t
 
b™
;

3857 
	`Œaû_ext4_mb_»Ëa£_group_·
(
sb
, 
·
);

3858 
	`BUG_ON
(
·
->
·_d–‘ed
 == 0);

3859 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
·
->
·_p¡¬t
, &
group
, &
b™
);

3860 
	`BUG_ON
(
group
 !ğ
e4b
->
bd_group
 && 
·
->
·_Ën
 != 0);

3861 
	`mb_ä“_blocks
(
·
->
·_šode
, 
e4b
, 
b™
,…a->
·_Ën
);

3862 
	`©omic_add
(
·
->
·_Ën
, &
	`EXT4_SB
(
sb
)->
s_mb_disÿrded
);

3863 
	`Œaû_ext4_mb®loc_disÿrd
(
sb
, 
NULL
, 
group
, 
b™
, 
·
->
·_Ën
);

3866 
	}
}

3877 
nošlše_fÜ_¡ack
 

3878 
	$ext4_mb_disÿrd_group_´—ÎoÿtiÚs
(
su³r_block
 *
sb
,

3879 
ext4_group_t
 
group
, 
Ãeded
)

3881 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

3882 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

3883 
ext4_´—Îoc_¥aû
 *
·
, *
tmp
;

3884 
li¡_h—d
 
li¡
;

3885 
ext4_buddy
 
e4b
;

3886 
”r
;

3887 
busy
 = 0;

3888 
ä“
 = 0;

3890 
	`mb_debug
(1, "disÿrd…»®loÿtiÚ fÜ grou°%u\n", 
group
);

3892 ià(
	`li¡_em±y
(&
g½
->
bb_´—Îoc_li¡
))

3895 
b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
group
);

3896 ià(
	`IS_ERR
(
b™m­_bh
)) {

3897 
”r
 = 
	`PTR_ERR
(
b™m­_bh
);

3898 
	`ext4_”rÜ
(
sb
, "Error %d„eading block bitmap for %u",

3899 
”r
, 
group
);

3903 
”r
 = 
	`ext4_mb_lßd_buddy
(
sb
, 
group
, &
e4b
);

3904 ià(
”r
) {

3905 
	`ext4_w¬nšg
(
sb
, "Error %d†oading buddy information for %u",

3906 
”r
, 
group
);

3907 
	`put_bh
(
b™m­_bh
);

3911 ià(
Ãeded
 == 0)

3912 
Ãeded
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) + 1;

3914 
	`INIT_LIST_HEAD
(&
li¡
);

3915 
»³©
:

3916 
	`ext4_lock_group
(
sb
, 
group
);

3917 
	`li¡_fÜ_—ch_’Œy_§ã
(
·
, 
tmp
,

3918 &
g½
->
bb_´—Îoc_li¡
, 
·_group_li¡
) {

3919 
	`¥š_lock
(&
·
->
·_lock
);

3920 ià(
	`©omic_»ad
(&
·
->
·_couÁ
)) {

3921 
	`¥š_uÆock
(&
·
->
·_lock
);

3922 
busy
 = 1;

3925 ià(
·
->
·_d–‘ed
) {

3926 
	`¥š_uÆock
(&
·
->
·_lock
);

3931 
·
->
·_d–‘ed
 = 1;

3934 
ä“
 +ğ
·
->
·_ä“
;

3936 
	`¥š_uÆock
(&
·
->
·_lock
);

3938 
	`li¡_d–
(&
·
->
·_group_li¡
);

3939 
	`li¡_add
(&
·
->
u
.
·_tmp_li¡
, &
li¡
);

3943 ià(
ä“
 < 
Ãeded
 && 
busy
) {

3944 
busy
 = 0;

3945 
	`ext4_uÆock_group
(
sb
, 
group
);

3946 
	`cÚd_»sched
();

3947 
»³©
;

3951 ià(
	`li¡_em±y
(&
li¡
)) {

3952 
	`BUG_ON
(
ä“
 != 0);

3953 
out
;

3957 
	`li¡_fÜ_—ch_’Œy_§ã
(
·
, 
tmp
, &
li¡
, 
u
.
·_tmp_li¡
) {

3960 
	`¥š_lock
(
·
->
·_obj_lock
);

3961 
	`li¡_d–_rcu
(&
·
->
·_šode_li¡
);

3962 
	`¥š_uÆock
(
·
->
·_obj_lock
);

3964 ià(
·
->
·_ty³
 =ğ
MB_GROUP_PA
)

3965 
	`ext4_mb_»Ëa£_group_·
(&
e4b
, 
·
);

3967 
	`ext4_mb_»Ëa£_šode_·
(&
e4b
, 
b™m­_bh
, 
·
);

3969 
	`li¡_d–
(&
·
->
u
.
·_tmp_li¡
);

3970 
	`ÿÎ_rcu
(&(
·
)->
u
.
·_rcu
, 
ext4_mb_·_ÿÎback
);

3973 
out
:

3974 
	`ext4_uÆock_group
(
sb
, 
group
);

3975 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

3976 
	`put_bh
(
b™m­_bh
);

3977  
ä“
;

3978 
	}
}

3989 
	$ext4_disÿrd_´—ÎoÿtiÚs
(
šode
 *inode)

3991 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

3992 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

3993 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

3994 
ext4_´—Îoc_¥aû
 *
·
, *
tmp
;

3995 
ext4_group_t
 
group
 = 0;

3996 
li¡_h—d
 
li¡
;

3997 
ext4_buddy
 
e4b
;

3998 
”r
;

4000 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

4005 
	`mb_debug
(1, "disÿrd…»®loÿtiÚ fÜ inod%lu\n", 
šode
->
i_šo
);

4006 
	`Œaû_ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

4008 
	`INIT_LIST_HEAD
(&
li¡
);

4010 
»³©
:

4012 
	`¥š_lock
(&
ei
->
i_´—Îoc_lock
);

4013 !
	`li¡_em±y
(&
ei
->
i_´—Îoc_li¡
)) {

4014 
·
 = 
	`li¡_’Œy
(
ei
->
i_´—Îoc_li¡
.
Ãxt
,

4015 
ext4_´—Îoc_¥aû
, 
·_šode_li¡
);

4016 
	`BUG_ON
(
·
->
·_obj_lock
 !ğ&
ei
->
i_´—Îoc_lock
);

4017 
	`¥š_lock
(&
·
->
·_lock
);

4018 ià(
	`©omic_»ad
(&
·
->
·_couÁ
)) {

4021 
	`¥š_uÆock
(&
·
->
·_lock
);

4022 
	`¥š_uÆock
(&
ei
->
i_´—Îoc_lock
);

4023 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4025 
	`WARN_ON
(1);

4026 
	`scheduË_timeout_unš‹¼u±ibË
(
HZ
);

4027 
»³©
;

4030 ià(
·
->
·_d–‘ed
 == 0) {

4031 
·
->
·_d–‘ed
 = 1;

4032 
	`¥š_uÆock
(&
·
->
·_lock
);

4033 
	`li¡_d–_rcu
(&
·
->
·_šode_li¡
);

4034 
	`li¡_add
(&
·
->
u
.
·_tmp_li¡
, &
li¡
);

4039 
	`¥š_uÆock
(&
·
->
·_lock
);

4040 
	`¥š_uÆock
(&
ei
->
i_´—Îoc_lock
);

4054 
	`scheduË_timeout_unš‹¼u±ibË
(
HZ
);

4055 
»³©
;

4057 
	`¥š_uÆock
(&
ei
->
i_´—Îoc_lock
);

4059 
	`li¡_fÜ_—ch_’Œy_§ã
(
·
, 
tmp
, &
li¡
, 
u
.
·_tmp_li¡
) {

4060 
	`BUG_ON
(
·
->
·_ty³
 !ğ
MB_INODE_PA
);

4061 
group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
·
->
·_p¡¬t
);

4063 
”r
 = 
	`ext4_mb_lßd_buddy_gå
(
sb
, 
group
, &
e4b
,

4064 
GFP_NOFS
|
__GFP_NOFAIL
);

4065 ià(
”r
) {

4066 
	`ext4_”rÜ
(
sb
, "Error %d†oading buddy information for %u",

4067 
”r
, 
group
);

4071 
b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
group
);

4072 ià(
	`IS_ERR
(
b™m­_bh
)) {

4073 
”r
 = 
	`PTR_ERR
(
b™m­_bh
);

4074 
	`ext4_”rÜ
(
sb
, "Error %d„eading block bitmap for %u",

4075 
”r
, 
group
);

4076 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

4080 
	`ext4_lock_group
(
sb
, 
group
);

4081 
	`li¡_d–
(&
·
->
·_group_li¡
);

4082 
	`ext4_mb_»Ëa£_šode_·
(&
e4b
, 
b™m­_bh
, 
·
);

4083 
	`ext4_uÆock_group
(
sb
, 
group
);

4085 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

4086 
	`put_bh
(
b™m­_bh
);

4088 
	`li¡_d–
(&
·
->
u
.
·_tmp_li¡
);

4089 
	`ÿÎ_rcu
(&(
·
)->
u
.
·_rcu
, 
ext4_mb_·_ÿÎback
);

4091 
	}
}

4093 #ifdeà
CONFIG_EXT4_DEBUG


4094 
	$ext4_mb_show_ac
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

4096 
su³r_block
 *
sb
 = 
ac
->
ac_sb
;

4097 
ext4_group_t
 
ngroups
, 
i
;

4099 ià(!
ext4_mb®loc_debug
 ||

4100 (
	`EXT4_SB
(
sb
)->
s_mouÁ_æags
 & 
EXT4_MF_FS_ABORTED
))

4103 
	`ext4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "Can't‡llocate:"

4105 
	`ext4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "status %d flags %d",

4106 
ac
->
ac_¡©us
,‡c->
ac_æags
);

4107 
	`ext4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "orig %lu/%lu/%lu@%lu, "

4110 ()
ac
->
ac_o_ex
.
ã_group
,

4111 ()
ac
->
ac_o_ex
.
ã_¡¬t
,

4112 ()
ac
->
ac_o_ex
.
ã_Ën
,

4113 ()
ac
->
ac_o_ex
.
ã_logiÿl
,

4114 ()
ac
->
ac_g_ex
.
ã_group
,

4115 ()
ac
->
ac_g_ex
.
ã_¡¬t
,

4116 ()
ac
->
ac_g_ex
.
ã_Ën
,

4117 ()
ac
->
ac_g_ex
.
ã_logiÿl
,

4118 ()
ac
->
ac_b_ex
.
ã_group
,

4119 ()
ac
->
ac_b_ex
.
ã_¡¬t
,

4120 ()
ac
->
ac_b_ex
.
ã_Ën
,

4121 ()
ac
->
ac_b_ex
.
ã_logiÿl
,

4122 ()
ac
->
ac_ü™”Ÿ
);

4123 
	`ext4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "%d found",‡c->
ac_found
);

4124 
	`ext4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "groups: ");

4125 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

4126 
i
 = 0; i < 
ngroups
; i++) {

4127 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
i
);

4128 
ext4_´—Îoc_¥aû
 *
·
;

4129 
ext4_g½blk_t
 
¡¬t
;

4130 
li¡_h—d
 *
cur
;

4131 
	`ext4_lock_group
(
sb
, 
i
);

4132 
	`li¡_fÜ_—ch
(
cur
, &
g½
->
bb_´—Îoc_li¡
) {

4133 
·
 = 
	`li¡_’Œy
(
cur
, 
ext4_´—Îoc_¥aû
,

4134 
·_group_li¡
);

4135 
	`¥š_lock
(&
·
->
·_lock
);

4136 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
·
->
·_p¡¬t
,

4137 
NULL
, &
¡¬t
);

4138 
	`¥š_uÆock
(&
·
->
·_lock
);

4139 
	`´štk
(
KERN_ERR
 "PA:%u:%d:%u \n", 
i
,

4140 
¡¬t
, 
·
->
·_Ën
);

4142 
	`ext4_uÆock_group
(
sb
, 
i
);

4144 ià(
g½
->
bb_ä“
 == 0)

4146 
	`´štk
(
KERN_ERR
 "%u: %d/%d \n",

4147 
i
, 
g½
->
bb_ä“
, g½->
bb_äagm’ts
);

4149 
	`´štk
(
KERN_ERR
 "\n");

4150 
	}
}

4152 
šlše
 
	$ext4_mb_show_ac
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

4155 
	}
}

4165 
	$ext4_mb_group_Ü_fe
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

4167 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

4168 
bsb™s
 = 
ac
->
ac_sb
->
s_blocksize_b™s
;

4169 
loff_t
 
size
, 
isize
;

4171 ià(!(
ac
->
ac_æags
 & 
EXT4_MB_HINT_DATA
))

4174 ià(
	`uÆik–y
(
ac
->
ac_æags
 & 
EXT4_MB_HINT_GOAL_ONLY
))

4177 
size
 = 
ac
->
ac_o_ex
.
ã_logiÿl
 + 
	`EXT4_C2B
(
sbi
,‡c->ac_o_ex.
ã_Ën
);

4178 
isize
 = (
	`i_size_»ad
(
ac
->
ac_šode
è+‡c->
ac_sb
->
s_blocksize
 - 1)

4179 >> 
bsb™s
;

4181 ià((
size
 =ğ
isize
è&& !
	`ext4_fs_is_busy
(
sbi
) &&

4182 !
	`šode_is_İ’_fÜ_wr™e
(
ac
->
ac_šode
)) {

4183 
ac
->
ac_æags
 |ğ
EXT4_MB_HINT_NOPREALLOC
;

4187 ià(
sbi
->
s_mb_group_´—Îoc
 <= 0) {

4188 
ac
->
ac_æags
 |ğ
EXT4_MB_STREAM_ALLOC
;

4193 
size
 = 
	`max
(size, 
isize
);

4194 ià(
size
 > 
sbi
->
s_mb_¡»am_»que¡
) {

4195 
ac
->
ac_æags
 |ğ
EXT4_MB_STREAM_ALLOC
;

4199 
	`BUG_ON
(
ac
->
ac_lg
 !ğ
NULL
);

4205 
ac
->
ac_lg
 = 
	`¿w_ıu_±r
(
sbi
->
s_loÿl™y_groups
);

4208 
ac
->
ac_æags
 |ğ
EXT4_MB_HINT_GROUP_ALLOC
;

4211 
	`mu‹x_lock
(&
ac
->
ac_lg
->
lg_mu‹x
);

4212 
	}
}

4214 
nošlše_fÜ_¡ack
 

4215 
	$ext4_mb_š™Ÿlize_cÚ‹xt
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

4216 
ext4_®loÿtiÚ_»que¡
 *
¬
)

4218 
su³r_block
 *
sb
 = 
¬
->
šode
->
i_sb
;

4219 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

4220 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

4221 
ext4_group_t
 
group
;

4222 
Ën
;

4223 
ext4_fsblk_t
 
gßl
;

4224 
ext4_g½blk_t
 
block
;

4227 
Ën
 = 
¬
->len;

4230 ià(
Ën
 >ğ
	`EXT4_CLUSTERS_PER_GROUP
(
sb
))

4231 
Ën
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
);

4234 
gßl
 = 
¬
->goal;

4235 ià(
gßl
 < 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
) ||

4236 
gßl
 >ğ
	`ext4_blocks_couÁ
(
es
))

4237 
gßl
 = 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
);

4238 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
gßl
, &
group
, &
block
);

4241 
ac
->
ac_b_ex
.
ã_logiÿl
 = 
	`EXT4_LBLK_CMASK
(
sbi
, 
¬
->
logiÿl
);

4242 
ac
->
ac_¡©us
 = 
AC_STATUS_CONTINUE
;

4243 
ac
->
ac_sb
 = 
sb
;

4244 
ac
->
ac_šode
 = 
¬
->
šode
;

4245 
ac
->
ac_o_ex
.
ã_logiÿl
 =‡c->
ac_b_ex
.fe_logical;

4246 
ac
->
ac_o_ex
.
ã_group
 = 
group
;

4247 
ac
->
ac_o_ex
.
ã_¡¬t
 = 
block
;

4248 
ac
->
ac_o_ex
.
ã_Ën
 = 
Ën
;

4249 
ac
->
ac_g_ex
 =‡c->
ac_o_ex
;

4250 
ac
->
ac_æags
 = 
¬
->
æags
;

4254 
	`ext4_mb_group_Ü_fe
(
ac
);

4256 
	`mb_debug
(1, "init‡c: %u blocks @ %u, goal %u, flags %x, 2^%d, "

4258 (è
¬
->
Ën
, (è¬->
logiÿl
,

4259 (è
¬
->
gßl
, 
ac
->
ac_æags
,‡c->
ac_2Üd”
,

4260 (è
¬
->
Îeá
, (è¬->
¶eá
,

4261 (è
¬
->
Ìight
, (è¬->
´ight
,

4262 
	`šode_is_İ’_fÜ_wr™e
(
¬
->
šode
) ? "" : "non-");

4265 
	}
}

4267 
nošlše_fÜ_¡ack
 

4268 
	$ext4_mb_disÿrd_lg_´—ÎoÿtiÚs
(
su³r_block
 *
sb
,

4269 
ext4_loÿl™y_group
 *
lg
,

4270 
Üd”
, 
tÙ®_’Œ›s
)

4272 
ext4_group_t
 
group
 = 0;

4273 
ext4_buddy
 
e4b
;

4274 
li¡_h—d
 
disÿrd_li¡
;

4275 
ext4_´—Îoc_¥aû
 *
·
, *
tmp
;

4277 
	`mb_debug
(1, "discard†ocality group…reallocation\n");

4279 
	`INIT_LIST_HEAD
(&
disÿrd_li¡
);

4281 
	`¥š_lock
(&
lg
->
lg_´—Îoc_lock
);

4282 
	`li¡_fÜ_—ch_’Œy_rcu
(
·
, &
lg
->
lg_´—Îoc_li¡
[
Üd”
],

4283 
·_šode_li¡
) {

4284 
	`¥š_lock
(&
·
->
·_lock
);

4285 ià(
	`©omic_»ad
(&
·
->
·_couÁ
)) {

4291 
	`¥š_uÆock
(&
·
->
·_lock
);

4294 ià(
·
->
·_d–‘ed
) {

4295 
	`¥š_uÆock
(&
·
->
·_lock
);

4299 
	`BUG_ON
(
·
->
·_ty³
 !ğ
MB_GROUP_PA
);

4302 
·
->
·_d–‘ed
 = 1;

4303 
	`¥š_uÆock
(&
·
->
·_lock
);

4305 
	`li¡_d–_rcu
(&
·
->
·_šode_li¡
);

4306 
	`li¡_add
(&
·
->
u
.
·_tmp_li¡
, &
disÿrd_li¡
);

4308 
tÙ®_’Œ›s
--;

4309 ià(
tÙ®_’Œ›s
 <= 5) {

4319 
	`¥š_uÆock
(&
lg
->
lg_´—Îoc_lock
);

4321 
	`li¡_fÜ_—ch_’Œy_§ã
(
·
, 
tmp
, &
disÿrd_li¡
, 
u
.
·_tmp_li¡
) {

4322 
”r
;

4324 
group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
·
->
·_p¡¬t
);

4325 
”r
 = 
	`ext4_mb_lßd_buddy_gå
(
sb
, 
group
, &
e4b
,

4326 
GFP_NOFS
|
__GFP_NOFAIL
);

4327 ià(
”r
) {

4328 
	`ext4_”rÜ
(
sb
, "Error %d†oading buddy information for %u",

4329 
”r
, 
group
);

4332 
	`ext4_lock_group
(
sb
, 
group
);

4333 
	`li¡_d–
(&
·
->
·_group_li¡
);

4334 
	`ext4_mb_»Ëa£_group_·
(&
e4b
, 
·
);

4335 
	`ext4_uÆock_group
(
sb
, 
group
);

4337 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

4338 
	`li¡_d–
(&
·
->
u
.
·_tmp_li¡
);

4339 
	`ÿÎ_rcu
(&(
·
)->
u
.
·_rcu
, 
ext4_mb_·_ÿÎback
);

4341 
	}
}

4352 
	$ext4_mb_add_n_Œim
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

4354 
Üd”
, 
added
 = 0, 
lg_´—Îoc_couÁ
 = 1;

4355 
su³r_block
 *
sb
 = 
ac
->
ac_sb
;

4356 
ext4_loÿl™y_group
 *
lg
 = 
ac
->
ac_lg
;

4357 
ext4_´—Îoc_¥aû
 *
tmp_·
, *
·
 = 
ac
->
ac_·
;

4359 
Üd”
 = 
	`æs
(
·
->
·_ä“
) - 1;

4360 ià(
Üd”
 > 
PREALLOC_TB_SIZE
 - 1)

4362 
Üd”
 = 
PREALLOC_TB_SIZE
 - 1;

4364 
	`¥š_lock
(&
lg
->
lg_´—Îoc_lock
);

4365 
	`li¡_fÜ_—ch_’Œy_rcu
(
tmp_·
, &
lg
->
lg_´—Îoc_li¡
[
Üd”
],

4366 
·_šode_li¡
) {

4367 
	`¥š_lock
(&
tmp_·
->
·_lock
);

4368 ià(
tmp_·
->
·_d–‘ed
) {

4369 
	`¥š_uÆock
(&
tmp_·
->
·_lock
);

4372 ià(!
added
 && 
·
->
·_ä“
 < 
tmp_·
->pa_free) {

4374 
	`li¡_add__rcu
(&
·
->
·_šode_li¡
,

4375 &
tmp_·
->
·_šode_li¡
);

4376 
added
 = 1;

4382 
	`¥š_uÆock
(&
tmp_·
->
·_lock
);

4383 
lg_´—Îoc_couÁ
++;

4385 ià(!
added
)

4386 
	`li¡_add__rcu
(&
·
->
·_šode_li¡
,

4387 &
lg
->
lg_´—Îoc_li¡
[
Üd”
]);

4388 
	`¥š_uÆock
(&
lg
->
lg_´—Îoc_lock
);

4391 ià(
lg_´—Îoc_couÁ
 > 8) {

4392 
	`ext4_mb_disÿrd_lg_´—ÎoÿtiÚs
(
sb
, 
lg
,

4393 
Üd”
, 
lg_´—Îoc_couÁ
);

4397 
	}
}

4402 
	$ext4_mb_»Ëa£_cÚ‹xt
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

4404 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

4405 
ext4_´—Îoc_¥aû
 *
·
 = 
ac
->
ac_·
;

4406 ià(
·
) {

4407 ià(
·
->
·_ty³
 =ğ
MB_GROUP_PA
) {

4409 
	`¥š_lock
(&
·
->
·_lock
);

4410 
·
->
·_p¡¬t
 +ğ
	`EXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
ã_Ën
);

4411 
·
->
·_l¡¬t
 +ğ
	`EXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
ã_Ën
);

4412 
·
->
·_ä“
 -ğ
ac
->
ac_b_ex
.
ã_Ën
;

4413 
·
->
·_Ën
 -ğ
ac
->
ac_b_ex
.
ã_Ën
;

4414 
	`¥š_uÆock
(&
·
->
·_lock
);

4417 ià(
·
) {

4424 ià((
·
->
·_ty³
 =ğ
MB_GROUP_PA
è&& 
	`lik–y
Õa->
·_ä“
)) {

4425 
	`¥š_lock
(
·
->
·_obj_lock
);

4426 
	`li¡_d–_rcu
(&
·
->
·_šode_li¡
);

4427 
	`¥š_uÆock
(
·
->
·_obj_lock
);

4428 
	`ext4_mb_add_n_Œim
(
ac
);

4430 
	`ext4_mb_put_·
(
ac
,‡c->
ac_sb
, 
·
);

4432 ià(
ac
->
ac_b™m­_·ge
)

4433 
	`put_·ge
(
ac
->
ac_b™m­_·ge
);

4434 ià(
ac
->
ac_buddy_·ge
)

4435 
	`put_·ge
(
ac
->
ac_buddy_·ge
);

4436 ià(
ac
->
ac_æags
 & 
EXT4_MB_HINT_GROUP_ALLOC
)

4437 
	`mu‹x_uÆock
(&
ac
->
ac_lg
->
lg_mu‹x
);

4438 
	`ext4_mb_cŞËù_¡©s
(
ac
);

4440 
	}
}

4442 
	$ext4_mb_disÿrd_´—ÎoÿtiÚs
(
su³r_block
 *
sb
, 
Ãeded
)

4444 
ext4_group_t
 
i
, 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

4445 
»t
;

4446 
ä“d
 = 0;

4448 
	`Œaû_ext4_mb_disÿrd_´—ÎoÿtiÚs
(
sb
, 
Ãeded
);

4449 
i
 = 0; i < 
ngroups
 && 
Ãeded
 > 0; i++) {

4450 
»t
 = 
	`ext4_mb_disÿrd_group_´—ÎoÿtiÚs
(
sb
, 
i
, 
Ãeded
);

4451 
ä“d
 +ğ
»t
;

4452 
Ãeded
 -ğ
»t
;

4455  
ä“d
;

4456 
	}
}

4463 
ext4_fsblk_t
 
	$ext4_mb_Ãw_blocks
(
hªdË_t
 *
hªdË
,

4464 
ext4_®loÿtiÚ_»que¡
 *
¬
, *
”½
)

4466 
ä“d
;

4467 
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
 = 
NULL
;

4468 
ext4_sb_šfo
 *
sbi
;

4469 
su³r_block
 *
sb
;

4470 
ext4_fsblk_t
 
block
 = 0;

4471 
šquÙa
 = 0;

4472 
»£rv_ş¡rs
 = 0;

4474 
	`might_¦“p
();

4475 
sb
 = 
¬
->
šode
->
i_sb
;

4476 
sbi
 = 
	`EXT4_SB
(
sb
);

4478 
	`Œaû_ext4_»que¡_blocks
(
¬
);

4481 ià(
	`ext4_is_quÙa_fe
(
¬
->
šode
))

4482 
¬
->
æags
 |ğ
EXT4_MB_USE_ROOT_BLOCKS
;

4484 ià((
¬
->
æags
 & 
EXT4_MB_DELALLOC_RESERVED
) == 0) {

4489 
¬
->
Ën
 &&

4490 
	`ext4_şaim_ä“_şu¡”s
(
sbi
, 
¬
->
Ën
,‡r->
æags
)) {

4493 
	`cÚd_»sched
();

4494 
¬
->
Ën
 =‡r->len >> 1;

4496 ià(!
¬
->
Ën
) {

4497 *
”½
 = -
ENOSPC
;

4500 
»£rv_ş¡rs
 = 
¬
->
Ën
;

4501 ià(
¬
->
æags
 & 
EXT4_MB_USE_ROOT_BLOCKS
) {

4502 
	`dquÙ_®loc_block_noç
(
¬
->
šode
,

4503 
	`EXT4_C2B
(
sbi
, 
¬
->
Ën
));

4505 
¬
->
Ën
 &&

4506 
	`dquÙ_®loc_block
(
¬
->
šode
,

4507 
	`EXT4_C2B
(
sbi
, 
¬
->
Ën
))) {

4509 
¬
->
æags
 |ğ
EXT4_MB_HINT_NOPREALLOC
;

4510 
¬
->
Ën
--;

4513 
šquÙa
 = 
¬
->
Ën
;

4514 ià(
¬
->
Ën
 == 0) {

4515 *
”½
 = -
EDQUOT
;

4516 
out
;

4520 
ac
 = 
	`kmem_ÿche_z®loc
(
ext4_ac_ÿch•
, 
GFP_NOFS
);

4521 ià(!
ac
) {

4522 
¬
->
Ën
 = 0;

4523 *
”½
 = -
ENOMEM
;

4524 
out
;

4527 *
”½
 = 
	`ext4_mb_š™Ÿlize_cÚ‹xt
(
ac
, 
¬
);

4528 ià(*
”½
) {

4529 
¬
->
Ën
 = 0;

4530 
out
;

4533 
ac
->
ac_İ
 = 
EXT4_MB_HISTORY_PREALLOC
;

4534 ià(!
	`ext4_mb_u£_´—Îoÿ‹d
(
ac
)) {

4535 
ac
->
ac_İ
 = 
EXT4_MB_HISTORY_ALLOC
;

4536 
	`ext4_mb_nÜm®ize_»que¡
(
ac
, 
¬
);

4537 
»³©
:

4539 *
”½
 = 
	`ext4_mb_»guÏr_®loÿtÜ
(
ac
);

4540 ià(*
”½
)

4541 
disÿrd_ªd_ex™
;

4546 ià(
ac
->
ac_¡©us
 =ğ
AC_STATUS_FOUND
 &&

4547 
ac
->
ac_o_ex
.
ã_Ën
 <‡c->
ac_b_ex
.fe_len)

4548 *
”½
 = 
	`ext4_mb_Ãw_´—ÎoÿtiÚ
(
ac
);

4549 ià(*
”½
) {

4550 
disÿrd_ªd_ex™
:

4551 
	`ext4_disÿrd_®loÿ‹d_blocks
(
ac
);

4552 
”rout
;

4555 ià(
	`lik–y
(
ac
->
ac_¡©us
 =ğ
AC_STATUS_FOUND
)) {

4556 *
”½
 = 
	`ext4_mb_m¬k_disk¥aû_u£d
(
ac
, 
hªdË
, 
»£rv_ş¡rs
);

4557 ià(*
”½
) {

4558 
	`ext4_disÿrd_®loÿ‹d_blocks
(
ac
);

4559 
”rout
;

4561 
block
 = 
	`ext4_g½_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

4562 
¬
->
Ën
 = 
ac
->
ac_b_ex
.
ã_Ën
;

4565 
ä“d
 = 
	`ext4_mb_disÿrd_´—ÎoÿtiÚs
(
sb
, 
ac
->
ac_o_ex
.
ã_Ën
);

4566 ià(
ä“d
)

4567 
»³©
;

4568 *
”½
 = -
ENOSPC
;

4571 
”rout
:

4572 ià(*
”½
) {

4573 
ac
->
ac_b_ex
.
ã_Ën
 = 0;

4574 
¬
->
Ën
 = 0;

4575 
	`ext4_mb_show_ac
(
ac
);

4577 
	`ext4_mb_»Ëa£_cÚ‹xt
(
ac
);

4578 
out
:

4579 ià(
ac
)

4580 
	`kmem_ÿche_ä“
(
ext4_ac_ÿch•
, 
ac
);

4581 ià(
šquÙa
 && 
¬
->
Ën
 < inquota)

4582 
	`dquÙ_ä“_block
(
¬
->
šode
, 
	`EXT4_C2B
(
sbi
, 
šquÙa
 -‡r->
Ën
));

4583 ià(!
¬
->
Ën
) {

4584 ià((
¬
->
æags
 & 
EXT4_MB_DELALLOC_RESERVED
) == 0)

4586 
	`³rıu_couÁ”_sub
(&
sbi
->
s_dœtyşu¡”s_couÁ”
,

4587 
»£rv_ş¡rs
);

4590 
	`Œaû_ext4_®loÿ‹_blocks
(
¬
, ()
block
);

4592  
block
;

4593 
	}
}

4600 
	$ext4_Œy_m”ge_ä“d_ex‹Á
(
ext4_sb_šfo
 *
sbi
,

4601 
ext4_ä“_d©a
 *
’Œy
,

4602 
ext4_ä“_d©a
 *
Ãw_’Œy
,

4603 
rb_roÙ
 *
’Œy_rb_roÙ
)

4605 ià((
’Œy
->
efd_tid
 !ğ
Ãw_’Œy
->efd_tid) ||

4606 (
’Œy
->
efd_group
 !ğ
Ãw_’Œy
->efd_group))

4608 ià(
’Œy
->
efd_¡¬t_şu¡”
 +ƒÁry->
efd_couÁ
 ==

4609 
Ãw_’Œy
->
efd_¡¬t_şu¡”
) {

4610 
Ãw_’Œy
->
efd_¡¬t_şu¡”
 = 
’Œy
->efd_start_cluster;

4611 
Ãw_’Œy
->
efd_couÁ
 +ğ
’Œy
->efd_count;

4612 } ià(
Ãw_’Œy
->
efd_¡¬t_şu¡”
 +‚ew_’Œy->
efd_couÁ
 ==

4613 
’Œy
->
efd_¡¬t_şu¡”
) {

4614 
Ãw_’Œy
->
efd_couÁ
 +ğ
’Œy
->efd_count;

4617 
	`¥š_lock
(&
sbi
->
s_md_lock
);

4618 
	`li¡_d–
(&
’Œy
->
efd_li¡
);

4619 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

4620 
	`rb_”a£
(&
’Œy
->
efd_node
, 
’Œy_rb_roÙ
);

4621 
	`kmem_ÿche_ä“
(
ext4_ä“_d©a_ÿch•
, 
’Œy
);

4622 
	}
}

4624 
nošlše_fÜ_¡ack
 

4625 
	$ext4_mb_ä“_m‘ad©a
(
hªdË_t
 *
hªdË
, 
ext4_buddy
 *
e4b
,

4626 
ext4_ä“_d©a
 *
Ãw_’Œy
)

4628 
ext4_group_t
 
group
 = 
e4b
->
bd_group
;

4629 
ext4_g½blk_t
 
şu¡”
;

4630 
ext4_g½blk_t
 
şu¡”s
 = 
Ãw_’Œy
->
efd_couÁ
;

4631 
ext4_ä“_d©a
 *
’Œy
;

4632 
ext4_group_šfo
 *
db
 = 
e4b
->
bd_šfo
;

4633 
su³r_block
 *
sb
 = 
e4b
->
bd_sb
;

4634 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

4635 
rb_node
 **
n
 = &
db
->
bb_ä“_roÙ
.rb_node, *
node
;

4636 
rb_node
 *
·»Á
 = 
NULL
, *
Ãw_node
;

4638 
	`BUG_ON
(!
	`ext4_hªdË_v®id
(
hªdË
));

4639 
	`BUG_ON
(
e4b
->
bd_b™m­_·ge
 =ğ
NULL
);

4640 
	`BUG_ON
(
e4b
->
bd_buddy_·ge
 =ğ
NULL
);

4642 
Ãw_node
 = &
Ãw_’Œy
->
efd_node
;

4643 
şu¡”
 = 
Ãw_’Œy
->
efd_¡¬t_şu¡”
;

4645 ià(!*
n
) {

4651 
	`g‘_·ge
(
e4b
->
bd_buddy_·ge
);

4652 
	`g‘_·ge
(
e4b
->
bd_b™m­_·ge
);

4654 *
n
) {

4655 
·»Á
 = *
n
;

4656 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
ext4_ä“_d©a
, 
efd_node
);

4657 ià(
şu¡”
 < 
’Œy
->
efd_¡¬t_şu¡”
)

4658 
n
 = &(*n)->
rb_Ëá
;

4659 ià(
şu¡”
 >ğ(
’Œy
->
efd_¡¬t_şu¡”
 +ƒÁry->
efd_couÁ
))

4660 
n
 = &(*n)->
rb_right
;

4662 
	`ext4_g½_locked_”rÜ
(
sb
, 
group
, 0,

4663 
	`ext4_group_fœ¡_block_no
(
sb
, 
group
) +

4664 
	`EXT4_C2B
(
sbi
, 
şu¡”
),

4670 
	`rb_lšk_node
(
Ãw_node
, 
·»Á
, 
n
);

4671 
	`rb_š£¹_cŞÜ
(
Ãw_node
, &
db
->
bb_ä“_roÙ
);

4674 
node
 = 
	`rb_´ev
(
Ãw_node
);

4675 ià(
node
) {

4676 
’Œy
 = 
	`rb_’Œy
(
node
, 
ext4_ä“_d©a
, 
efd_node
);

4677 
	`ext4_Œy_m”ge_ä“d_ex‹Á
(
sbi
, 
’Œy
, 
Ãw_’Œy
,

4678 &(
db
->
bb_ä“_roÙ
));

4681 
node
 = 
	`rb_Ãxt
(
Ãw_node
);

4682 ià(
node
) {

4683 
’Œy
 = 
	`rb_’Œy
(
node
, 
ext4_ä“_d©a
, 
efd_node
);

4684 
	`ext4_Œy_m”ge_ä“d_ex‹Á
(
sbi
, 
’Œy
, 
Ãw_’Œy
,

4685 &(
db
->
bb_ä“_roÙ
));

4688 
	`¥š_lock
(&
sbi
->
s_md_lock
);

4689 
	`li¡_add_
(&
Ãw_’Œy
->
efd_li¡
, &
sbi
->
s_ä“d_d©a_li¡
);

4690 
sbi
->
s_mb_ä“_³ndšg
 +ğ
şu¡”s
;

4691 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

4693 
	}
}

4704 
	$ext4_ä“_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

4705 
bufãr_h—d
 *
bh
, 
ext4_fsblk_t
 
block
,

4706 
couÁ
, 
æags
)

4708 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

4709 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

4710 
ext4_group_desc
 *
gdp
;

4711 
ov”æow
;

4712 
ext4_g½blk_t
 
b™
;

4713 
bufãr_h—d
 *
gd_bh
;

4714 
ext4_group_t
 
block_group
;

4715 
ext4_sb_šfo
 *
sbi
;

4716 
ext4_buddy
 
e4b
;

4717 
couÁ_şu¡”s
;

4718 
”r
 = 0;

4719 
»t
;

4721 
	`might_¦“p
();

4722 ià(
bh
) {

4723 ià(
block
)

4724 
	`BUG_ON
(
block
 !ğ
bh
->
b_blockÄ
);

4726 
block
 = 
bh
->
b_blockÄ
;

4729 
sbi
 = 
	`EXT4_SB
(
sb
);

4730 ià(!(
æags
 & 
EXT4_FREE_BLOCKS_VALIDATED
) &&

4731 !
	`ext4_d©a_block_v®id
(
sbi
, 
block
, 
couÁ
)) {

4732 
	`ext4_”rÜ
(
sb
, "Freeing blocks‚ot in datazone - "

4733 "block = %Îu, couÁ = %lu", 
block
, 
couÁ
);

4734 
”rÜ_»tuº
;

4737 
	`ext4_debug
("ä“šg block %Îu\n", 
block
);

4738 
	`Œaû_ext4_ä“_blocks
(
šode
, 
block
, 
couÁ
, 
æags
);

4740 ià(
bh
 && (
æags
 & 
EXT4_FREE_BLOCKS_FORGET
)) {

4741 
	`BUG_ON
(
couÁ
 > 1);

4743 
	`ext4_fÜg‘
(
hªdË
, 
æags
 & 
EXT4_FREE_BLOCKS_METADATA
,

4744 
šode
, 
bh
, 
block
);

4754 
ov”æow
 = 
	`EXT4_PBLK_COFF
(
sbi
, 
block
);

4755 ià(
ov”æow
) {

4756 ià(
æags
 & 
EXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
) {

4757 
ov”æow
 = 
sbi
->
s_şu¡”_¿tio
 - overflow;

4758 
block
 +ğ
ov”æow
;

4759 ià(
couÁ
 > 
ov”æow
)

4760 
couÁ
 -ğ
ov”æow
;

4764 
block
 -ğ
ov”æow
;

4765 
couÁ
 +ğ
ov”æow
;

4768 
ov”æow
 = 
	`EXT4_LBLK_COFF
(
sbi
, 
couÁ
);

4769 ià(
ov”æow
) {

4770 ià(
æags
 & 
EXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
) {

4771 ià(
couÁ
 > 
ov”æow
)

4772 
couÁ
 -ğ
ov”æow
;

4776 
couÁ
 +ğ
sbi
->
s_şu¡”_¿tio
 - 
ov”æow
;

4779 ià(!
bh
 && (
æags
 & 
EXT4_FREE_BLOCKS_FORGET
)) {

4780 
i
;

4781 
is_m‘ad©a
 = 
æags
 & 
EXT4_FREE_BLOCKS_METADATA
;

4783 
i
 = 0; i < 
couÁ
; i++) {

4784 
	`cÚd_»sched
();

4785 ià(
is_m‘ad©a
)

4786 
bh
 = 
	`sb_fšd_g‘_block
(
šode
->
i_sb
, 
block
 + 
i
);

4787 
	`ext4_fÜg‘
(
hªdË
, 
is_m‘ad©a
, 
šode
, 
bh
, 
block
 + 
i
);

4791 
do_mÜe
:

4792 
ov”æow
 = 0;

4793 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
block
, &
block_group
, &
b™
);

4795 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(

4796 
	`ext4_g‘_group_šfo
(
sb
, 
block_group
))))

4803 ià(
	`EXT4_C2B
(
sbi
, 
b™
è+ 
couÁ
 > 
	`EXT4_BLOCKS_PER_GROUP
(
sb
)) {

4804 
ov”æow
 = 
	`EXT4_C2B
(
sbi
, 
b™
è+ 
couÁ
 -

4805 
	`EXT4_BLOCKS_PER_GROUP
(
sb
);

4806 
couÁ
 -ğ
ov”æow
;

4808 
couÁ_şu¡”s
 = 
	`EXT4_NUM_B2C
(
sbi
, 
couÁ
);

4809 
b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
block_group
);

4810 ià(
	`IS_ERR
(
b™m­_bh
)) {

4811 
”r
 = 
	`PTR_ERR
(
b™m­_bh
);

4812 
b™m­_bh
 = 
NULL
;

4813 
”rÜ_»tuº
;

4815 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
block_group
, &
gd_bh
);

4816 ià(!
gdp
) {

4817 
”r
 = -
EIO
;

4818 
”rÜ_»tuº
;

4821 ià(
	`š_¿nge
(
	`ext4_block_b™m­
(
sb
, 
gdp
), 
block
, 
couÁ
) ||

4822 
	`š_¿nge
(
	`ext4_šode_b™m­
(
sb
, 
gdp
), 
block
, 
couÁ
) ||

4823 
	`š_¿nge
(
block
, 
	`ext4_šode_bË
(
sb
, 
gdp
),

4824 
sbi
->
s_™b_³r_group
) ||

4825 
	`š_¿nge
(
block
 + 
couÁ
 - 1, 
	`ext4_šode_bË
(
sb
, 
gdp
),

4826 
sbi
->
s_™b_³r_group
)) {

4828 
	`ext4_”rÜ
(
sb
, "Freeing blocks in system zone - "

4829 "Block = %Îu, couÁ = %lu", 
block
, 
couÁ
);

4831 
”rÜ_»tuº
;

4834 
	`BUFFER_TRACE
(
b™m­_bh
, "getting write‡ccess");

4835 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
b™m­_bh
);

4836 ià(
”r
)

4837 
”rÜ_»tuº
;

4844 
	`BUFFER_TRACE
(
gd_bh
, "get_write_access");

4845 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
gd_bh
);

4846 ià(
”r
)

4847 
”rÜ_»tuº
;

4848 #ifdeà
AGGRESSIVE_CHECK


4850 
i
;

4851 
i
 = 0; i < 
couÁ_şu¡”s
; i++)

4852 
	`BUG_ON
(!
	`mb_‹¡_b™
(
b™
 + 
i
, 
b™m­_bh
->
b_d©a
));

4855 
	`Œaû_ext4_mb®loc_ä“
(
sb
, 
šode
, 
block_group
, 
b™
, 
couÁ_şu¡”s
);

4858 
”r
 = 
	`ext4_mb_lßd_buddy_gå
(
sb
, 
block_group
, &
e4b
,

4859 
GFP_NOFS
|
__GFP_NOFAIL
);

4860 ià(
”r
)

4861 
”rÜ_»tuº
;

4869 ià(
	`ext4_hªdË_v®id
(
hªdË
) &&

4870 ((
æags
 & 
EXT4_FREE_BLOCKS_METADATA
) ||

4871 !
	`ext4_should_wr™eback_d©a
(
šode
))) {

4872 
ext4_ä“_d©a
 *
Ãw_’Œy
;

4877 
Ãw_’Œy
 = 
	`kmem_ÿche_®loc
(
ext4_ä“_d©a_ÿch•
,

4878 
GFP_NOFS
|
__GFP_NOFAIL
);

4879 
Ãw_’Œy
->
efd_¡¬t_şu¡”
 = 
b™
;

4880 
Ãw_’Œy
->
efd_group
 = 
block_group
;

4881 
Ãw_’Œy
->
efd_couÁ
 = 
couÁ_şu¡”s
;

4882 
Ãw_’Œy
->
efd_tid
 = 
hªdË
->
h_Œª§ùiÚ
->
t_tid
;

4884 
	`ext4_lock_group
(
sb
, 
block_group
);

4885 
	`mb_ş—r_b™s
(
b™m­_bh
->
b_d©a
, 
b™
, 
couÁ_şu¡”s
);

4886 
	`ext4_mb_ä“_m‘ad©a
(
hªdË
, &
e4b
, 
Ãw_’Œy
);

4892 ià(
	`‹¡_İt
(
sb
, 
DISCARD
)) {

4893 
”r
 = 
	`ext4_issue_disÿrd
(
sb
, 
block_group
, 
b™
, 
couÁ
,

4894 
NULL
);

4895 ià(
”r
 &&ƒ¼ !ğ-
EOPNOTSUPP
)

4896 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "discard„equest in"

4898 " w™h %d", 
block_group
, 
b™
, 
couÁ
,

4899 
”r
);

4901 
	`EXT4_MB_GRP_CLEAR_TRIMMED
(
e4b
.
bd_šfo
);

4903 
	`ext4_lock_group
(
sb
, 
block_group
);

4904 
	`mb_ş—r_b™s
(
b™m­_bh
->
b_d©a
, 
b™
, 
couÁ_şu¡”s
);

4905 
	`mb_ä“_blocks
(
šode
, &
e4b
, 
b™
, 
couÁ_şu¡”s
);

4908 
»t
 = 
	`ext4_ä“_group_şu¡”s
(
sb
, 
gdp
è+ 
couÁ_şu¡”s
;

4909 
	`ext4_ä“_group_şu¡”s_£t
(
sb
, 
gdp
, 
»t
);

4910 
	`ext4_block_b™m­_csum_£t
(
sb
, 
block_group
, 
gdp
, 
b™m­_bh
);

4911 
	`ext4_group_desc_csum_£t
(
sb
, 
block_group
, 
gdp
);

4912 
	`ext4_uÆock_group
(
sb
, 
block_group
);

4914 ià(
sbi
->
s_log_groups_³r_æex
) {

4915 
ext4_group_t
 
æex_group
 = 
	`ext4_æex_group
(
sbi
, 
block_group
);

4916 
	`©omic64_add
(
couÁ_şu¡”s
,

4917 &
sbi
->
s_æex_groups
[
æex_group
].
ä“_şu¡”s
);

4925 ià(!(
æags
 & 
EXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)) {

4926 ià(!(
æags
 & 
EXT4_FREE_BLOCKS_NO_QUOT_UPDATE
))

4927 
	`dquÙ_ä“_block
(
šode
, 
	`EXT4_C2B
(
sbi
, 
couÁ_şu¡”s
));

4928 
	`³rıu_couÁ”_add
(&
sbi
->
s_ä“şu¡”s_couÁ”
,

4929 
couÁ_şu¡”s
);

4932 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

4935 
	`BUFFER_TRACE
(
b™m­_bh
, "dirtied bitmap block");

4936 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
b™m­_bh
);

4939 
	`BUFFER_TRACE
(
gd_bh
, "dirtied group descriptor block");

4940 
»t
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
gd_bh
);

4941 ià(!
”r
)

4942 
”r
 = 
»t
;

4944 ià(
ov”æow
 && !
”r
) {

4945 
block
 +ğ
couÁ
;

4946 
couÁ
 = 
ov”æow
;

4947 
	`put_bh
(
b™m­_bh
);

4948 
do_mÜe
;

4950 
”rÜ_»tuº
:

4951 
	`b»l£
(
b™m­_bh
);

4952 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

4954 
	}
}

4965 
	$ext4_group_add_blocks
(
hªdË_t
 *
hªdË
, 
su³r_block
 *
sb
,

4966 
ext4_fsblk_t
 
block
, 
couÁ
)

4968 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

4969 
bufãr_h—d
 *
gd_bh
;

4970 
ext4_group_t
 
block_group
;

4971 
ext4_g½blk_t
 
b™
;

4972 
i
;

4973 
ext4_group_desc
 *
desc
;

4974 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

4975 
ext4_buddy
 
e4b
;

4976 
”r
 = 0, 
»t
, 
ä“_şu¡”s_couÁ
;

4977 
ext4_g½blk_t
 
şu¡”s_ä“d
;

4978 
ext4_fsblk_t
 
fœ¡_şu¡”
 = 
	`EXT4_B2C
(
sbi
, 
block
);

4979 
ext4_fsblk_t
 
Ï¡_şu¡”
 = 
	`EXT4_B2C
(
sbi
, 
block
 + 
couÁ
 - 1);

4980 
şu¡”_couÁ
 = 
Ï¡_şu¡”
 - 
fœ¡_şu¡”
 + 1;

4982 
	`ext4_debug
("Addšg block(sè%Îu-%Îu\n", 
block
, block + 
couÁ
 - 1);

4984 ià(
couÁ
 == 0)

4987 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
block
, &
block_group
, &
b™
);

4992 ià(
b™
 + 
şu¡”_couÁ
 > 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
)) {

4993 
	`ext4_w¬nšg
(
sb
, "too many blocks‡ddedo group %u",

4994 
block_group
);

4995 
”r
 = -
EINVAL
;

4996 
”rÜ_»tuº
;

4999 
b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
block_group
);

5000 ià(
	`IS_ERR
(
b™m­_bh
)) {

5001 
”r
 = 
	`PTR_ERR
(
b™m­_bh
);

5002 
b™m­_bh
 = 
NULL
;

5003 
”rÜ_»tuº
;

5006 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
block_group
, &
gd_bh
);

5007 ià(!
desc
) {

5008 
”r
 = -
EIO
;

5009 
”rÜ_»tuº
;

5012 ià(
	`š_¿nge
(
	`ext4_block_b™m­
(
sb
, 
desc
), 
block
, 
couÁ
) ||

5013 
	`š_¿nge
(
	`ext4_šode_b™m­
(
sb
, 
desc
), 
block
, 
couÁ
) ||

5014 
	`š_¿nge
(
block
, 
	`ext4_šode_bË
(
sb
, 
desc
), 
sbi
->
s_™b_³r_group
) ||

5015 
	`š_¿nge
(
block
 + 
couÁ
 - 1, 
	`ext4_šode_bË
(
sb
, 
desc
),

5016 
sbi
->
s_™b_³r_group
)) {

5017 
	`ext4_”rÜ
(
sb
, "Adding blocks in system zones - "

5019 
block
, 
couÁ
);

5020 
”r
 = -
EINVAL
;

5021 
”rÜ_»tuº
;

5024 
	`BUFFER_TRACE
(
b™m­_bh
, "getting write‡ccess");

5025 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
b™m­_bh
);

5026 ià(
”r
)

5027 
”rÜ_»tuº
;

5034 
	`BUFFER_TRACE
(
gd_bh
, "get_write_access");

5035 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
gd_bh
);

5036 ià(
”r
)

5037 
”rÜ_»tuº
;

5039 
i
 = 0, 
şu¡”s_ä“d
 = 0; i < 
şu¡”_couÁ
; i++) {

5040 
	`BUFFER_TRACE
(
b™m­_bh
, "clear bit");

5041 ià(!
	`mb_‹¡_b™
(
b™
 + 
i
, 
b™m­_bh
->
b_d©a
)) {

5042 
	`ext4_”rÜ
(
sb
, "bit‡lready cleared for block %llu",

5043 (
ext4_fsblk_t
)(
block
 + 
i
));

5044 
	`BUFFER_TRACE
(
b™m­_bh
, "bit‡lready cleared");

5046 
şu¡”s_ä“d
++;

5050 
”r
 = 
	`ext4_mb_lßd_buddy
(
sb
, 
block_group
, &
e4b
);

5051 ià(
”r
)

5052 
”rÜ_»tuº
;

5059 
	`ext4_lock_group
(
sb
, 
block_group
);

5060 
	`mb_ş—r_b™s
(
b™m­_bh
->
b_d©a
, 
b™
, 
şu¡”_couÁ
);

5061 
	`mb_ä“_blocks
(
NULL
, &
e4b
, 
b™
, 
şu¡”_couÁ
);

5062 
ä“_şu¡”s_couÁ
 = 
şu¡”s_ä“d
 +

5063 
	`ext4_ä“_group_şu¡”s
(
sb
, 
desc
);

5064 
	`ext4_ä“_group_şu¡”s_£t
(
sb
, 
desc
, 
ä“_şu¡”s_couÁ
);

5065 
	`ext4_block_b™m­_csum_£t
(
sb
, 
block_group
, 
desc
, 
b™m­_bh
);

5066 
	`ext4_group_desc_csum_£t
(
sb
, 
block_group
, 
desc
);

5067 
	`ext4_uÆock_group
(
sb
, 
block_group
);

5068 
	`³rıu_couÁ”_add
(&
sbi
->
s_ä“şu¡”s_couÁ”
,

5069 
şu¡”s_ä“d
);

5071 ià(
sbi
->
s_log_groups_³r_æex
) {

5072 
ext4_group_t
 
æex_group
 = 
	`ext4_æex_group
(
sbi
, 
block_group
);

5073 
	`©omic64_add
(
şu¡”s_ä“d
,

5074 &
sbi
->
s_æex_groups
[
æex_group
].
ä“_şu¡”s
);

5077 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

5080 
	`BUFFER_TRACE
(
b™m­_bh
, "dirtied bitmap block");

5081 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
b™m­_bh
);

5084 
	`BUFFER_TRACE
(
gd_bh
, "dirtied group descriptor block");

5085 
»t
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
gd_bh
);

5086 ià(!
”r
)

5087 
”r
 = 
»t
;

5089 
”rÜ_»tuº
:

5090 
	`b»l£
(
b™m­_bh
);

5091 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

5092  
”r
;

5093 
	}
}

5107 
	$ext4_Œim_ex‹Á
(
su³r_block
 *
sb
, 
¡¬t
, 
couÁ
,

5108 
ext4_group_t
 
group
, 
ext4_buddy
 *
e4b
)

5109 
	$__»Ëa£s
(
b™lock
)

5110 
	$__acquœes
(
b™lock
)

5112 
ext4_ä“_ex‹Á
 
ex
;

5113 
»t
 = 0;

5115 
	`Œaû_ext4_Œim_ex‹Á
(
sb
, 
group
, 
¡¬t
, 
couÁ
);

5117 
	`as£¹_¥š_locked
(
	`ext4_group_lock_±r
(
sb
, 
group
));

5119 
ex
.
ã_¡¬t
 = 
¡¬t
;

5120 
ex
.
ã_group
 = 
group
;

5121 
ex
.
ã_Ën
 = 
couÁ
;

5127 
	`mb_m¬k_u£d
(
e4b
, &
ex
);

5128 
	`ext4_uÆock_group
(
sb
, 
group
);

5129 
»t
 = 
	`ext4_issue_disÿrd
(
sb
, 
group
, 
¡¬t
, 
couÁ
, 
NULL
);

5130 
	`ext4_lock_group
(
sb
, 
group
);

5131 
	`mb_ä“_blocks
(
NULL
, 
e4b
, 
¡¬t
, 
ex
.
ã_Ën
);

5132  
»t
;

5133 
	}
}

5153 
ext4_g½blk_t


5154 
	$ext4_Œim_®l_ä“
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

5155 
ext4_g½blk_t
 
¡¬t
,ƒxt4_g½blk_ˆ
max
,

5156 
ext4_g½blk_t
 
mšblocks
)

5158 *
b™m­
;

5159 
ext4_g½blk_t
 
Ãxt
, 
couÁ
 = 0, 
ä“_couÁ
 = 0;

5160 
ext4_buddy
 
e4b
;

5161 
»t
 = 0;

5163 
	`Œaû_ext4_Œim_®l_ä“
(
sb
, 
group
, 
¡¬t
, 
max
);

5165 
»t
 = 
	`ext4_mb_lßd_buddy
(
sb
, 
group
, &
e4b
);

5166 ià(
»t
) {

5167 
	`ext4_w¬nšg
(
sb
, "Error %d†oading buddy information for %u",

5168 
»t
, 
group
);

5169  
»t
;

5171 
b™m­
 = 
e4b
.
bd_b™m­
;

5173 
	`ext4_lock_group
(
sb
, 
group
);

5174 ià(
	`EXT4_MB_GRP_WAS_TRIMMED
(
e4b
.
bd_šfo
) &&

5175 
mšblocks
 >ğ
	`©omic_»ad
(&
	`EXT4_SB
(
sb
)->
s_Ï¡_Œim_mšblks
))

5176 
out
;

5178 
¡¬t
 = (
e4b
.
bd_šfo
->
bb_fœ¡_ä“
 > start) ?

5179 
e4b
.
bd_šfo
->
bb_fœ¡_ä“
 : 
¡¬t
;

5181 
¡¬t
 <ğ
max
) {

5182 
¡¬t
 = 
	`mb_fšd_Ãxt_z”o_b™
(
b™m­
, 
max
 + 1, start);

5183 ià(
¡¬t
 > 
max
)

5185 
Ãxt
 = 
	`mb_fšd_Ãxt_b™
(
b™m­
, 
max
 + 1, 
¡¬t
);

5187 ià((
Ãxt
 - 
¡¬t
è>ğ
mšblocks
) {

5188 
»t
 = 
	`ext4_Œim_ex‹Á
(
sb
, 
¡¬t
,

5189 
Ãxt
 - 
¡¬t
, 
group
, &
e4b
);

5190 ià(
»t
 &&„‘ !ğ-
EOPNOTSUPP
)

5192 
»t
 = 0;

5193 
couÁ
 +ğ
Ãxt
 - 
¡¬t
;

5195 
ä“_couÁ
 +ğ
Ãxt
 - 
¡¬t
;

5196 
¡¬t
 = 
Ãxt
 + 1;

5198 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

5199 
couÁ
 = -
ERESTARTSYS
;

5203 ià(
	`Ãed_»sched
()) {

5204 
	`ext4_uÆock_group
(
sb
, 
group
);

5205 
	`cÚd_»sched
();

5206 
	`ext4_lock_group
(
sb
, 
group
);

5209 ià((
e4b
.
bd_šfo
->
bb_ä“
 - 
ä“_couÁ
è< 
mšblocks
)

5213 ià(!
»t
) {

5214 
»t
 = 
couÁ
;

5215 
	`EXT4_MB_GRP_SET_TRIMMED
(
e4b
.
bd_šfo
);

5217 
out
:

5218 
	`ext4_uÆock_group
(
sb
, 
group
);

5219 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

5221 
	`ext4_debug
("trimmed %d blocks inhe group %d\n",

5222 
couÁ
, 
group
);

5224  
»t
;

5225 
	}
}

5239 
	$ext4_Œim_fs
(
su³r_block
 *
sb
, 
f¡rim_¿nge
 *
¿nge
)

5241 
ext4_group_šfo
 *
g½
;

5242 
ext4_group_t
 
group
, 
fœ¡_group
, 
Ï¡_group
;

5243 
ext4_g½blk_t
 
út
 = 0, 
fœ¡_şu¡”
, 
Ï¡_şu¡”
;

5244 
ušt64_t
 
¡¬t
, 
’d
, 
mšËn
, 
Œimmed
 = 0;

5245 
ext4_fsblk_t
 
fœ¡_d©a_blk
 =

5246 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_fœ¡_d©a_block
);

5247 
ext4_fsblk_t
 
max_blks
 = 
	`ext4_blocks_couÁ
(
	`EXT4_SB
(
sb
)->
s_es
);

5248 
»t
 = 0;

5250 
¡¬t
 = 
¿nge
->¡¬ˆ>> 
sb
->
s_blocksize_b™s
;

5251 
’d
 = 
¡¬t
 + (
¿nge
->
Ën
 >> 
sb
->
s_blocksize_b™s
) - 1;

5252 
mšËn
 = 
	`EXT4_NUM_B2C
(
	`EXT4_SB
(
sb
),

5253 
¿nge
->
mšËn
 >> 
sb
->
s_blocksize_b™s
);

5255 ià(
mšËn
 > 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) ||

5256 
¡¬t
 >ğ
max_blks
 ||

5257 
¿nge
->
Ën
 < 
sb
->
s_blocksize
)

5258  -
EINVAL
;

5259 ià(
’d
 >ğ
max_blks
)

5260 
’d
 = 
max_blks
 - 1;

5261 ià(
’d
 <ğ
fœ¡_d©a_blk
)

5262 
out
;

5263 ià(
¡¬t
 < 
fœ¡_d©a_blk
)

5264 
¡¬t
 = 
fœ¡_d©a_blk
;

5267 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, (
ext4_fsblk_t
è
¡¬t
,

5268 &
fœ¡_group
, &
fœ¡_şu¡”
);

5269 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, (
ext4_fsblk_t
è
’d
,

5270 &
Ï¡_group
, &
Ï¡_şu¡”
);

5273 
’d
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) - 1;

5275 
group
 = 
fœ¡_group
; grou°<ğ
Ï¡_group
; group++) {

5276 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

5278 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_NEED_INIT
(
g½
))) {

5279 
»t
 = 
	`ext4_mb_š™_group
(
sb
, 
group
, 
GFP_NOFS
);

5280 ià(
»t
)

5290 ià(
group
 =ğ
Ï¡_group
)

5291 
’d
 = 
Ï¡_şu¡”
;

5293 ià(
g½
->
bb_ä“
 >ğ
mšËn
) {

5294 
út
 = 
	`ext4_Œim_®l_ä“
(
sb
, 
group
, 
fœ¡_şu¡”
,

5295 
’d
, 
mšËn
);

5296 ià(
út
 < 0) {

5297 
»t
 = 
út
;

5300 
Œimmed
 +ğ
út
;

5307 
fœ¡_şu¡”
 = 0;

5310 ià(!
»t
)

5311 
	`©omic_£t
(&
	`EXT4_SB
(
sb
)->
s_Ï¡_Œim_mšblks
, 
mšËn
);

5313 
out
:

5314 
¿nge
->
Ën
 = 
	`EXT4_C2B
(
	`EXT4_SB
(
sb
), 
Œimmed
è<< sb->
s_blocksize_b™s
;

5315  
»t
;

5316 
	}
}

5320 
	$ext4_mb®loc_qu”y_¿nge
(

5321 
su³r_block
 *
sb
,

5322 
ext4_group_t
 
group
,

5323 
ext4_g½blk_t
 
¡¬t
,

5324 
ext4_g½blk_t
 
’d
,

5325 
ext4_mb®loc_qu”y_¿nge_â
 
fÜm©‹r
,

5326 *
´iv
)

5328 *
b™m­
;

5329 
ext4_g½blk_t
 
Ãxt
;

5330 
ext4_buddy
 
e4b
;

5331 
”rÜ
;

5333 
”rÜ
 = 
	`ext4_mb_lßd_buddy
(
sb
, 
group
, &
e4b
);

5334 ià(
”rÜ
)

5335  
”rÜ
;

5336 
b™m­
 = 
e4b
.
bd_b™m­
;

5338 
	`ext4_lock_group
(
sb
, 
group
);

5340 
¡¬t
 = (
e4b
.
bd_šfo
->
bb_fœ¡_ä“
 > start) ?

5341 
e4b
.
bd_šfo
->
bb_fœ¡_ä“
 : 
¡¬t
;

5342 ià(
’d
 >ğ
	`EXT4_CLUSTERS_PER_GROUP
(
sb
))

5343 
’d
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) - 1;

5345 
¡¬t
 <ğ
’d
) {

5346 
¡¬t
 = 
	`mb_fšd_Ãxt_z”o_b™
(
b™m­
, 
’d
 + 1, start);

5347 ià(
¡¬t
 > 
’d
)

5349 
Ãxt
 = 
	`mb_fšd_Ãxt_b™
(
b™m­
, 
’d
 + 1, 
¡¬t
);

5351 
	`ext4_uÆock_group
(
sb
, 
group
);

5352 
”rÜ
 = 
	`fÜm©‹r
(
sb
, 
group
, 
¡¬t
, 
Ãxt
 - s¹, 
´iv
);

5353 ià(
”rÜ
)

5354 
out_uÆßd
;

5355 
	`ext4_lock_group
(
sb
, 
group
);

5357 
¡¬t
 = 
Ãxt
 + 1;

5360 
	`ext4_uÆock_group
(
sb
, 
group
);

5361 
out_uÆßd
:

5362 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

5364  
”rÜ
;

5365 
	}
}

	@pxt4/mballoc.h

8 #iâdeà
_EXT4_MBALLOC_H


9 
	#_EXT4_MBALLOC_H


	)

11 
	~<lšux/time.h
>

12 
	~<lšux/fs.h
>

13 
	~<lšux/Çmei.h
>

14 
	~<lšux/quÙaİs.h
>

15 
	~<lšux/bufãr_h—d.h
>

16 
	~<lšux/moduË.h
>

17 
	~<lšux/sw­.h
>

18 
	~<lšux/´oc_fs.h
>

19 
	~<lšux/·gem­.h
>

20 
	~<lšux/£q_fe.h
>

21 
	~<lšux/blkdev.h
>

22 
	~<lšux/mu‹x.h
>

23 
	~"ext4_jbd2.h
"

24 
	~"ext4.h
"

28 #ifdeà
CONFIG_EXT4_DEBUG


29 
ushÜt
 
ext4_mb®loc_debug
;

31 
	#mb_debug
(
n
, 
fmt
, ...) \

33 ià((
n
è<ğ
ext4_mb®loc_debug
) { \

34 
	`´štk
(
KERN_DEBUG
 "(%s, %d): %s: " 
fmt
, \

35 
__FILE__
, 
__LINE__
, 
__func__
, ##
__VA_ARGS__
); \

37 } 0)

	)

39 
	#mb_debug
(
n
, 
fmt
, ...è
	`no_´štk
(fmt, ##
__VA_ARGS__
)

	)

42 
	#EXT4_MB_HISTORY_ALLOC
 1

	)

43 
	#EXT4_MB_HISTORY_PREALLOC
 2

	)

48 
	#MB_DEFAULT_MAX_TO_SCAN
 200

	)

53 
	#MB_DEFAULT_MIN_TO_SCAN
 10

	)

59 
	#MB_DEFAULT_STATS
 0

	)

68 
	#MB_DEFAULT_STREAM_THRESHOLD
 16

	)

73 
	#MB_DEFAULT_ORDER2_REQS
 2

	)

78 
	#MB_DEFAULT_GROUP_PREALLOC
 512

	)

81 
	sext4_ä“_d©a
 {

83 
li¡_h—d
 
	mefd_li¡
;

86 
rb_node
 
	mefd_node
;

89 
ext4_group_t
 
	mefd_group
;

92 
ext4_g½blk_t
 
	mefd_¡¬t_şu¡”
;

93 
ext4_g½blk_t
 
	mefd_couÁ
;

96 
tid_t
 
	mefd_tid
;

99 
	sext4_´—Îoc_¥aû
 {

100 
li¡_h—d
 
	m·_šode_li¡
;

101 
li¡_h—d
 
	m·_group_li¡
;

103 
li¡_h—d
 
	m·_tmp_li¡
;

104 
rcu_h—d
 
	m·_rcu
;

105 } 
	mu
;

106 
¥šlock_t
 
	m·_lock
;

107 
©omic_t
 
	m·_couÁ
;

108 
	m·_d–‘ed
;

109 
ext4_fsblk_t
 
	m·_p¡¬t
;

110 
ext4_lblk_t
 
	m·_l¡¬t
;

111 
ext4_g½blk_t
 
	m·_Ën
;

112 
ext4_g½blk_t
 
	m·_ä“
;

113 
	m·_ty³
;

114 
¥šlock_t
 *
	m·_obj_lock
;

115 
šode
 *
	m·_šode
;

119 
	mMB_INODE_PA
 = 0,

120 
	mMB_GROUP_PA
 = 1

123 
	sext4_ä“_ex‹Á
 {

124 
ext4_lblk_t
 
	mã_logiÿl
;

125 
ext4_g½blk_t
 
	mã_¡¬t
;

126 
ext4_group_t
 
	mã_group
;

127 
ext4_g½blk_t
 
	mã_Ën
;

138 
	#PREALLOC_TB_SIZE
 10

	)

139 
	sext4_loÿl™y_group
 {

142 
mu‹x
 
	mlg_mu‹x
;

144 
li¡_h—d
 
	mlg_´—Îoc_li¡
[
PREALLOC_TB_SIZE
];

145 
¥šlock_t
 
	mlg_´—Îoc_lock
;

148 
	sext4_®loÿtiÚ_cÚ‹xt
 {

149 
šode
 *
	mac_šode
;

150 
su³r_block
 *
	mac_sb
;

153 
ext4_ä“_ex‹Á
 
	mac_o_ex
;

156 
ext4_ä“_ex‹Á
 
	mac_g_ex
;

159 
ext4_ä“_ex‹Á
 
	mac_b_ex
;

162 
ext4_ä“_ex‹Á
 
	mac_f_ex
;

164 
__u16
 
	mac_groups_sÿÂed
;

165 
__u16
 
	mac_found
;

166 
__u16
 
	mac_
;

167 
__u16
 
	mac_buddy
;

168 
__u16
 
	mac_æags
;

169 
__u8
 
	mac_¡©us
;

170 
__u8
 
	mac_ü™”Ÿ
;

171 
__u8
 
	mac_2Üd”
;

173 
__u8
 
	mac_İ
;

174 
·ge
 *
	mac_b™m­_·ge
;

175 
·ge
 *
	mac_buddy_·ge
;

176 
ext4_´—Îoc_¥aû
 *
	mac_·
;

177 
ext4_loÿl™y_group
 *
	mac_lg
;

180 
	#AC_STATUS_CONTINUE
 1

	)

181 
	#AC_STATUS_FOUND
 2

	)

182 
	#AC_STATUS_BREAK
 3

	)

184 
	sext4_buddy
 {

185 
·ge
 *
	mbd_buddy_·ge
;

186 *
	mbd_buddy
;

187 
·ge
 *
	mbd_b™m­_·ge
;

188 *
	mbd_b™m­
;

189 
ext4_group_šfo
 *
	mbd_šfo
;

190 
su³r_block
 *
	mbd_sb
;

191 
__u16
 
	mbd_blkb™s
;

192 
ext4_group_t
 
	mbd_group
;

195 
šlše
 
ext4_fsblk_t
 
	$ext4_g½_offs_to_block
(
su³r_block
 *
sb
,

196 
ext4_ä“_ex‹Á
 *
ãx
)

198  
	`ext4_group_fœ¡_block_no
(
sb
, 
ãx
->
ã_group
) +

199 (
ãx
->
ã_¡¬t
 << 
	`EXT4_SB
(
sb
)->
s_şu¡”_b™s
);

200 
	}
}

202 (*
	text4_mb®loc_qu”y_¿nge_â
)(

203 
	tsu³r_block
 *
	tsb
,

204 
	text4_group_t
 
	tagno
,

205 
	text4_g½blk_t
 
	t¡¬t
,

206 
	text4_g½blk_t
 
	tËn
,

207 *
	t´iv
);

210 
	`ext4_mb®loc_qu”y_¿nge
(

211 
su³r_block
 *
sb
,

212 
ext4_group_t
 
agno
,

213 
ext4_g½blk_t
 
¡¬t
,

214 
ext4_g½blk_t
 
’d
,

215 
ext4_mb®loc_qu”y_¿nge_â
 
fÜm©‹r
,

216 *
´iv
);

	@pxt4/migrate.c

8 
	~<lšux/¦ab.h
>

9 
	~"ext4_jbd2.h
"

10 
	~"ext4_ex‹Ás.h
"

16 
	smig¿‹_¡ruù
 {

17 
ext4_lblk_t
 
	mfœ¡_block
, 
	mÏ¡_block
, 
	mcu¼_block
;

18 
ext4_fsblk_t
 
	mfœ¡_pblock
, 
	mÏ¡_pblock
;

21 
	$fšish_¿nge
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

22 
mig¿‹_¡ruù
 *
lb
)

25 
»tv®
 = 0, 
Ãeded
;

26 
ext4_ex‹Á
 
Ãwext
;

27 
ext4_ext_·th
 *
·th
;

28 ià(
lb
->
fœ¡_pblock
 == 0)

32 
Ãwext
.
“_block
 = 
	`ıu_to_Ë32
(
lb
->
fœ¡_block
);

33 
Ãwext
.
“_Ën
 = 
	`ıu_to_Ë16
(
lb
->
Ï¡_block
 -†b->
fœ¡_block
 + 1);

34 
	`ext4_ext_¡Üe_pblock
(&
Ãwext
, 
lb
->
fœ¡_pblock
);

36 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

37 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
lb
->
fœ¡_block
, 
NULL
, 0);

38 ià(
	`IS_ERR
(
·th
)) {

39 
»tv®
 = 
	`PTR_ERR
(
·th
);

40 
·th
 = 
NULL
;

41 
”r_out
;

50 
Ãeded
 = 
	`ext4_ext_ÿlc_üed™s_fÜ_sšgË_ex‹Á
(
šode
,

51 
lb
->
Ï¡_block
 -†b->
fœ¡_block
 + 1, 
·th
);

56 ià(
Ãeded
 && 
	`ext4_hªdË_has_’ough_üed™s
(
hªdË
,

57 
EXT4_RESERVE_TRANS_BLOCKS
)) {

58 
	`up_wr™e
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

59 
»tv®
 = 
	`ext4_jouº®_»¡¬t
(
hªdË
, 
Ãeded
);

60 
	`down_wr™e
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

61 ià(
»tv®
)

62 
”r_out
;

63 } ià(
Ãeded
) {

64 
»tv®
 = 
	`ext4_jouº®_ex‹nd
(
hªdË
, 
Ãeded
);

65 ià(
»tv®
) {

69 
	`up_wr™e
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

70 
»tv®
 = 
	`ext4_jouº®_»¡¬t
(
hªdË
, 
Ãeded
);

71 
	`down_wr™e
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

72 ià(
»tv®
)

73 
”r_out
;

76 
»tv®
 = 
	`ext4_ext_š£¹_ex‹Á
(
hªdË
, 
šode
, &
·th
, &
Ãwext
, 0);

77 
”r_out
:

78 
	`up_wr™e
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

79 
	`ext4_ext_drİ_»fs
(
·th
);

80 
	`kä“
(
·th
);

81 
lb
->
fœ¡_pblock
 = 0;

82  
»tv®
;

83 
	}
}

85 
	$upd©e_ex‹Á_¿nge
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

86 
ext4_fsblk_t
 
pblock
, 
mig¿‹_¡ruù
 *
lb
)

88 
»tv®
;

92 ià(
lb
->
fœ¡_pblock
 &&

93 (
lb
->
Ï¡_pblock
+1 =ğ
pblock
) &&

94 (
lb
->
Ï¡_block
+1 =ğlb->
cu¼_block
)) {

95 
lb
->
Ï¡_pblock
 = 
pblock
;

96 
lb
->
Ï¡_block
 =†b->
cu¼_block
;

97 
lb
->
cu¼_block
++;

103 
»tv®
 = 
	`fšish_¿nge
(
hªdË
, 
šode
, 
lb
);

104 
lb
->
fœ¡_pblock
 =†b->
Ï¡_pblock
 = 
pblock
;

105 
lb
->
fœ¡_block
 =†b->
Ï¡_block
 =†b->
cu¼_block
;

106 
lb
->
cu¼_block
++;

107  
»tv®
;

108 
	}
}

110 
	$upd©e_šd_ex‹Á_¿nge
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

111 
ext4_fsblk_t
 
pblock
,

112 
mig¿‹_¡ruù
 *
lb
)

114 
bufãr_h—d
 *
bh
;

115 
__Ë32
 *
i_d©a
;

116 
i
, 
»tv®
 = 0;

117 
max_’Œ›s
 = 
šode
->
i_sb
->
s_blocksize
 >> 2;

119 
bh
 = 
	`ext4_sb_b»ad
(
šode
->
i_sb
, 
pblock
, 0);

120 ià(
	`IS_ERR
(
bh
))

121  
	`PTR_ERR
(
bh
);

123 
i_d©a
 = (
__Ë32
 *)
bh
->
b_d©a
;

124 
i
 = 0; i < 
max_’Œ›s
; i++) {

125 ià(
i_d©a
[
i
]) {

126 
»tv®
 = 
	`upd©e_ex‹Á_¿nge
(
hªdË
, 
šode
,

127 
	`Ë32_to_ıu
(
i_d©a
[
i
]), 
lb
);

128 ià(
»tv®
)

131 
lb
->
cu¼_block
++;

134 
	`put_bh
(
bh
);

135  
»tv®
;

137 
	}
}

139 
	$upd©e_dšd_ex‹Á_¿nge
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

140 
ext4_fsblk_t
 
pblock
,

141 
mig¿‹_¡ruù
 *
lb
)

143 
bufãr_h—d
 *
bh
;

144 
__Ë32
 *
i_d©a
;

145 
i
, 
»tv®
 = 0;

146 
max_’Œ›s
 = 
šode
->
i_sb
->
s_blocksize
 >> 2;

148 
bh
 = 
	`ext4_sb_b»ad
(
šode
->
i_sb
, 
pblock
, 0);

149 ià(
	`IS_ERR
(
bh
))

150  
	`PTR_ERR
(
bh
);

152 
i_d©a
 = (
__Ë32
 *)
bh
->
b_d©a
;

153 
i
 = 0; i < 
max_’Œ›s
; i++) {

154 ià(
i_d©a
[
i
]) {

155 
»tv®
 = 
	`upd©e_šd_ex‹Á_¿nge
(
hªdË
, 
šode
,

156 
	`Ë32_to_ıu
(
i_d©a
[
i
]), 
lb
);

157 ià(
»tv®
)

161 
lb
->
cu¼_block
 +ğ
max_’Œ›s
;

164 
	`put_bh
(
bh
);

165  
»tv®
;

167 
	}
}

169 
	$upd©e_tšd_ex‹Á_¿nge
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

170 
ext4_fsblk_t
 
pblock
,

171 
mig¿‹_¡ruù
 *
lb
)

173 
bufãr_h—d
 *
bh
;

174 
__Ë32
 *
i_d©a
;

175 
i
, 
»tv®
 = 0;

176 
max_’Œ›s
 = 
šode
->
i_sb
->
s_blocksize
 >> 2;

178 
bh
 = 
	`ext4_sb_b»ad
(
šode
->
i_sb
, 
pblock
, 0);

179 ià(
	`IS_ERR
(
bh
))

180  
	`PTR_ERR
(
bh
);

182 
i_d©a
 = (
__Ë32
 *)
bh
->
b_d©a
;

183 
i
 = 0; i < 
max_’Œ›s
; i++) {

184 ià(
i_d©a
[
i
]) {

185 
»tv®
 = 
	`upd©e_dšd_ex‹Á_¿nge
(
hªdË
, 
šode
,

186 
	`Ë32_to_ıu
(
i_d©a
[
i
]), 
lb
);

187 ià(
»tv®
)

191 
lb
->
cu¼_block
 +ğ
max_’Œ›s
 * max_entries;

194 
	`put_bh
(
bh
);

195  
»tv®
;

197 
	}
}

199 
	$ex‹nd_üed™_fÜ_blkd–
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

201 
»tv®
 = 0, 
Ãeded
;

203 ià(
	`ext4_hªdË_has_’ough_üed™s
(
hªdË
, 
EXT4_RESERVE_TRANS_BLOCKS
+1))

211 
Ãeded
 = 3 + 
	`EXT4_MAXQUOTAS_TRANS_BLOCKS
(
šode
->
i_sb
);

213 ià(
	`ext4_jouº®_ex‹nd
(
hªdË
, 
Ãeded
) != 0)

214 
»tv®
 = 
	`ext4_jouº®_»¡¬t
(
hªdË
, 
Ãeded
);

216  
»tv®
;

217 
	}
}

219 
	$ä“_dšd_blocks
(
hªdË_t
 *
hªdË
,

220 
šode
 *šode, 
__Ë32
 
i_d©a
)

222 
i
;

223 
__Ë32
 *
tmp_id©a
;

224 
bufãr_h—d
 *
bh
;

225 
max_’Œ›s
 = 
šode
->
i_sb
->
s_blocksize
 >> 2;

227 
bh
 = 
	`ext4_sb_b»ad
(
šode
->
i_sb
, 
	`Ë32_to_ıu
(
i_d©a
), 0);

228 ià(
	`IS_ERR
(
bh
))

229  
	`PTR_ERR
(
bh
);

231 
tmp_id©a
 = (
__Ë32
 *)
bh
->
b_d©a
;

232 
i
 = 0; i < 
max_’Œ›s
; i++) {

233 ià(
tmp_id©a
[
i
]) {

234 
	`ex‹nd_üed™_fÜ_blkd–
(
hªdË
, 
šode
);

235 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
,

236 
	`Ë32_to_ıu
(
tmp_id©a
[
i
]), 1,

237 
EXT4_FREE_BLOCKS_METADATA
 |

238 
EXT4_FREE_BLOCKS_FORGET
);

241 
	`put_bh
(
bh
);

242 
	`ex‹nd_üed™_fÜ_blkd–
(
hªdË
, 
šode
);

243 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
	`Ë32_to_ıu
(
i_d©a
), 1,

244 
EXT4_FREE_BLOCKS_METADATA
 |

245 
EXT4_FREE_BLOCKS_FORGET
);

247 
	}
}

249 
	$ä“_tšd_blocks
(
hªdË_t
 *
hªdË
,

250 
šode
 *šode, 
__Ë32
 
i_d©a
)

252 
i
, 
»tv®
 = 0;

253 
__Ë32
 *
tmp_id©a
;

254 
bufãr_h—d
 *
bh
;

255 
max_’Œ›s
 = 
šode
->
i_sb
->
s_blocksize
 >> 2;

257 
bh
 = 
	`ext4_sb_b»ad
(
šode
->
i_sb
, 
	`Ë32_to_ıu
(
i_d©a
), 0);

258 ià(
	`IS_ERR
(
bh
))

259  
	`PTR_ERR
(
bh
);

261 
tmp_id©a
 = (
__Ë32
 *)
bh
->
b_d©a
;

262 
i
 = 0; i < 
max_’Œ›s
; i++) {

263 ià(
tmp_id©a
[
i
]) {

264 
»tv®
 = 
	`ä“_dšd_blocks
(
hªdË
,

265 
šode
, 
tmp_id©a
[
i
]);

266 ià(
»tv®
) {

267 
	`put_bh
(
bh
);

268  
»tv®
;

272 
	`put_bh
(
bh
);

273 
	`ex‹nd_üed™_fÜ_blkd–
(
hªdË
, 
šode
);

274 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
	`Ë32_to_ıu
(
i_d©a
), 1,

275 
EXT4_FREE_BLOCKS_METADATA
 |

276 
EXT4_FREE_BLOCKS_FORGET
);

278 
	}
}

280 
	$ä“_šd_block
(
hªdË_t
 *
hªdË
, 
šode
 *šode, 
__Ë32
 *
i_d©a
)

282 
»tv®
;

285 ià(
i_d©a
[0]) {

286 
	`ex‹nd_üed™_fÜ_blkd–
(
hªdË
, 
šode
);

287 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
,

288 
	`Ë32_to_ıu
(
i_d©a
[0]), 1,

289 
EXT4_FREE_BLOCKS_METADATA
 |

290 
EXT4_FREE_BLOCKS_FORGET
);

294 ià(
i_d©a
[1]) {

295 
»tv®
 = 
	`ä“_dšd_blocks
(
hªdË
, 
šode
, 
i_d©a
[1]);

296 ià(
»tv®
)

297  
»tv®
;

301 ià(
i_d©a
[2]) {

302 
»tv®
 = 
	`ä“_tšd_blocks
(
hªdË
, 
šode
, 
i_d©a
[2]);

303 ià(
»tv®
)

304  
»tv®
;

307 
	}
}

309 
	$ext4_ext_sw­_šode_d©a
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

310 
šode
 *
tmp_šode
)

312 
»tv®
;

313 
__Ë32
 
i_d©a
[3];

314 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

315 
ext4_šode_šfo
 *
tmp_ei
 = 
	`EXT4_I
(
tmp_šode
);

321 
»tv®
 = 
	`ext4_jouº®_ex‹nd
(
hªdË
, 1);

322 ià(
»tv®
) {

323 
»tv®
 = 
	`ext4_jouº®_»¡¬t
(
hªdË
, 1);

324 ià(
»tv®
)

325 
”r_out
;

328 
i_d©a
[0] = 
ei
->i_d©a[
EXT4_IND_BLOCK
];

329 
i_d©a
[1] = 
ei
->i_d©a[
EXT4_DIND_BLOCK
];

330 
i_d©a
[2] = 
ei
->i_d©a[
EXT4_TIND_BLOCK
];

332 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

338 ià(!
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_EXT_MIGRATE
)) {

339 
»tv®
 = -
EAGAIN
;

340 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

341 
”r_out
;

343 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_EXT_MIGRATE
);

348 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
);

349 
	`memıy
(
ei
->
i_d©a
, 
tmp_ei
->i_data, (ei->i_data));

360 
	`¥š_lock
(&
šode
->
i_lock
);

361 
šode
->
i_blocks
 +ğ
tmp_šode
->i_blocks;

362 
	`¥š_uÆock
(&
šode
->
i_lock
);

363 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

369 
»tv®
 = 
	`ä“_šd_block
(
hªdË
, 
šode
, 
i_d©a
);

370 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

372 
”r_out
:

373  
»tv®
;

374 
	}
}

376 
	$ä“_ext_idx
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

377 
ext4_ex‹Á_idx
 *
ix
)

379 
i
, 
»tv®
 = 0;

380 
ext4_fsblk_t
 
block
;

381 
bufãr_h—d
 *
bh
;

382 
ext4_ex‹Á_h—d”
 *
eh
;

384 
block
 = 
	`ext4_idx_pblock
(
ix
);

385 
bh
 = 
	`ext4_sb_b»ad
(
šode
->
i_sb
, 
block
, 0);

386 ià(
	`IS_ERR
(
bh
))

387  
	`PTR_ERR
(
bh
);

389 
eh
 = (
ext4_ex‹Á_h—d”
 *)
bh
->
b_d©a
;

390 ià(
eh
->
eh_d•th
 != 0) {

391 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

392 
i
 = 0; i < 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
); i++, 
ix
++) {

393 
»tv®
 = 
	`ä“_ext_idx
(
hªdË
, 
šode
, 
ix
);

394 ià(
»tv®
)

398 
	`put_bh
(
bh
);

399 
	`ex‹nd_üed™_fÜ_blkd–
(
hªdË
, 
šode
);

400 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
block
, 1,

401 
EXT4_FREE_BLOCKS_METADATA
 | 
EXT4_FREE_BLOCKS_FORGET
);

402  
»tv®
;

403 
	}
}

408 
	$ä“_ext_block
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

410 
i
, 
»tv®
 = 0;

411 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

412 
ext4_ex‹Á_h—d”
 *
eh
 = (ext4_ex‹Á_h—d” *)
ei
->
i_d©a
;

413 
ext4_ex‹Á_idx
 *
ix
;

414 ià(
eh
->
eh_d•th
 == 0)

419 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

420 
i
 = 0; i < 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
); i++, 
ix
++) {

421 
»tv®
 = 
	`ä“_ext_idx
(
hªdË
, 
šode
, 
ix
);

422 ià(
»tv®
)

423  
»tv®
;

425  
»tv®
;

426 
	}
}

428 
	$ext4_ext_mig¿‹
(
šode
 *inode)

430 
hªdË_t
 *
hªdË
;

431 
»tv®
 = 0, 
i
;

432 
__Ë32
 *
i_d©a
;

433 
ext4_šode_šfo
 *
ei
;

434 
šode
 *
tmp_šode
 = 
NULL
;

435 
mig¿‹_¡ruù
 
lb
;

436 
max_’Œ›s
;

437 
__u32
 
gßl
;

438 
uid_t
 
owÃr
[2];

444 ià(!
	`ext4_has_ã©u»_ex‹Ás
(
šode
->
i_sb
) ||

445 (
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)))

446  -
EINVAL
;

448 ià(
	`S_ISLNK
(
šode
->
i_mode
è&& inode->
i_blocks
 == 0)

452  
»tv®
;

459 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MIGRATE
,

460 4 + 
	`EXT4_MAXQUOTAS_TRANS_BLOCKS
(
šode
->
i_sb
));

462 ià(
	`IS_ERR
(
hªdË
)) {

463 
»tv®
 = 
	`PTR_ERR
(
hªdË
);

464  
»tv®
;

466 
gßl
 = (((
šode
->
i_šo
 - 1è/ 
	`EXT4_INODES_PER_GROUP
(šode->
i_sb
)) *

467 
	`EXT4_INODES_PER_GROUP
(
šode
->
i_sb
)) + 1;

468 
owÃr
[0] = 
	`i_uid_»ad
(
šode
);

469 
owÃr
[1] = 
	`i_gid_»ad
(
šode
);

470 
tmp_šode
 = 
	`ext4_Ãw_šode
(
hªdË
, 
	`d_šode
(
šode
->
i_sb
->
s_roÙ
),

471 
S_IFREG
, 
NULL
, 
gßl
, 
owÃr
, 0);

472 ià(
	`IS_ERR
(
tmp_šode
)) {

473 
»tv®
 = 
	`PTR_ERR
(
tmp_šode
);

474 
	`ext4_jouº®_¡İ
(
hªdË
);

475  
»tv®
;

477 
	`i_size_wr™e
(
tmp_šode
, 
	`i_size_»ad
(
šode
));

482 
	`ş—r_Æšk
(
tmp_šode
);

484 
	`ext4_ext_Œ“_š™
(
hªdË
, 
tmp_šode
);

485 
	`ext4_Üphª_add
(
hªdË
, 
tmp_šode
);

486 
	`ext4_jouº®_¡İ
(
hªdË
);

504 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

505 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_EXT_MIGRATE
);

506 
	`up_»ad
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

508 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MIGRATE
, 1);

509 ià(
	`IS_ERR
(
hªdË
)) {

515 
	`ext4_Üphª_d–
(
NULL
, 
tmp_šode
);

516 
»tv®
 = 
	`PTR_ERR
(
hªdË
);

517 
out
;

520 
ei
 = 
	`EXT4_I
(
šode
);

521 
i_d©a
 = 
ei
->i_data;

522 
	`mem£t
(&
lb
, 0, (lb));

525 
max_’Œ›s
 = 
šode
->
i_sb
->
s_blocksize
 >> 2;

526 
i
 = 0; i < 
EXT4_NDIR_BLOCKS
; i++) {

527 ià(
i_d©a
[
i
]) {

528 
»tv®
 = 
	`upd©e_ex‹Á_¿nge
(
hªdË
, 
tmp_šode
,

529 
	`Ë32_to_ıu
(
i_d©a
[
i
]), &
lb
);

530 ià(
»tv®
)

531 
”r_out
;

533 
lb
.
cu¼_block
++;

535 ià(
i_d©a
[
EXT4_IND_BLOCK
]) {

536 
»tv®
 = 
	`upd©e_šd_ex‹Á_¿nge
(
hªdË
, 
tmp_šode
,

537 
	`Ë32_to_ıu
(
i_d©a
[
EXT4_IND_BLOCK
]), &
lb
);

538 ià(
»tv®
)

539 
”r_out
;

541 
lb
.
cu¼_block
 +ğ
max_’Œ›s
;

542 ià(
i_d©a
[
EXT4_DIND_BLOCK
]) {

543 
»tv®
 = 
	`upd©e_dšd_ex‹Á_¿nge
(
hªdË
, 
tmp_šode
,

544 
	`Ë32_to_ıu
(
i_d©a
[
EXT4_DIND_BLOCK
]), &
lb
);

545 ià(
»tv®
)

546 
”r_out
;

548 
lb
.
cu¼_block
 +ğ
max_’Œ›s
 * max_entries;

549 ià(
i_d©a
[
EXT4_TIND_BLOCK
]) {

550 
»tv®
 = 
	`upd©e_tšd_ex‹Á_¿nge
(
hªdË
, 
tmp_šode
,

551 
	`Ë32_to_ıu
(
i_d©a
[
EXT4_TIND_BLOCK
]), &
lb
);

552 ià(
»tv®
)

553 
”r_out
;

558 
»tv®
 = 
	`fšish_¿nge
(
hªdË
, 
tmp_šode
, &
lb
);

559 
”r_out
:

560 ià(
»tv®
)

565 
	`ä“_ext_block
(
hªdË
, 
tmp_šode
);

567 
»tv®
 = 
	`ext4_ext_sw­_šode_d©a
(
hªdË
, 
šode
, 
tmp_šode
);

568 ià(
»tv®
)

573 
	`ä“_ext_block
(
hªdË
, 
tmp_šode
);

577 ià(
	`ext4_jouº®_ex‹nd
(
hªdË
, 1) != 0)

578 
	`ext4_jouº®_»¡¬t
(
hªdË
, 1);

583 
	`i_size_wr™e
(
tmp_šode
, 0);

593 
tmp_šode
->
i_blocks
 = 0;

596 
	`ext4_ext_Œ“_š™
(
hªdË
, 
tmp_šode
);

597 
	`ext4_jouº®_¡İ
(
hªdË
);

598 
out
:

599 
	`uÆock_Ãw_šode
(
tmp_šode
);

600 
	`ut
(
tmp_šode
);

602  
»tv®
;

603 
	}
}

608 
	$ext4_šd_mig¿‹
(
šode
 *inode)

610 
ext4_ex‹Á_h—d”
 *
eh
;

611 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
;

612 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

613 
ext4_ex‹Á
 *
ex
;

614 
i
, 
Ën
;

615 
ext4_lblk_t
 
¡¬t
, 
’d
;

616 
ext4_fsblk_t
 
blk
;

617 
hªdË_t
 *
hªdË
;

618 
»t
;

620 ià(!
	`ext4_has_ã©u»_ex‹Ás
(
šode
->
i_sb
) ||

621 (!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)))

622  -
EINVAL
;

624 ià(
	`ext4_has_ã©u»_big®loc
(
šode
->
i_sb
))

625  -
EOPNOTSUPP
;

632 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DELALLOC
))

633 
	`ext4_®loc_da_blocks
(
šode
);

635 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MIGRATE
, 1);

636 ià(
	`IS_ERR
(
hªdË
))

637  
	`PTR_ERR
(
hªdË
);

639 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

640 
»t
 = 
	`ext4_ext_check_šode
(
šode
);

641 ià(
»t
)

642 
”rout
;

644 
eh
 = 
	`ext_šode_hdr
(
šode
);

645 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

646 ià(
	`ext4_blocks_couÁ
(
es
è> 
EXT4_MAX_BLOCK_FILE_PHYS
 ||

647 
eh
->
eh_d•th
 !ğ0 || 
	`Ë16_to_ıu
Óh->
eh_’Œ›s
) > 1) {

648 
»t
 = -
EOPNOTSUPP
;

649 
”rout
;

651 ià(
eh
->
eh_’Œ›s
 == 0)

652 
blk
 = 
Ën
 = 
¡¬t
 = 
’d
 = 0;

654 
Ën
 = 
	`Ë16_to_ıu
(
ex
->
“_Ën
);

655 
blk
 = 
	`ext4_ext_pblock
(
ex
);

656 
¡¬t
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

657 
’d
 = 
¡¬t
 + 
Ën
 - 1;

658 ià(
’d
 >ğ
EXT4_NDIR_BLOCKS
) {

659 
»t
 = -
EOPNOTSUPP
;

660 
”rout
;

664 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
);

665 
	`mem£t
(
ei
->
i_d©a
, 0, (ei->i_data));

666 
i
 = 
¡¬t
; i <ğ
’d
; i++)

667 
ei
->
i_d©a
[
i
] = 
	`ıu_to_Ë32
(
blk
++);

668 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

669 
”rout
:

670 
	`ext4_jouº®_¡İ
(
hªdË
);

671 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

672  
»t
;

673 
	}
}

	@pxt4/mmp.c

2 
	~<lšux/fs.h
>

3 
	~<lšux/¿ndom.h
>

4 
	~<lšux/bufãr_h—d.h
>

5 
	~<lšux/ut¢ame.h
>

6 
	~<lšux/kth»ad.h
>

8 
	~"ext4.h
"

11 
__Ë32
 
	$ext4_mmp_csum
(
su³r_block
 *
sb
, 
mmp_¡ruù
 *
mmp
)

13 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

14 
off£t
 = 
	`off£tof
(
mmp_¡ruù
, 
mmp_checksum
);

15 
__u32
 
csum
;

17 
csum
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (*)
mmp
, 
off£t
);

19  
	`ıu_to_Ë32
(
csum
);

20 
	}
}

22 
	$ext4_mmp_csum_v”ify
(
su³r_block
 *
sb
, 
mmp_¡ruù
 *
mmp
)

24 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

27  
mmp
->
mmp_checksum
 =ğ
	`ext4_mmp_csum
(
sb
, mmp);

28 
	}
}

30 
	$ext4_mmp_csum_£t
(
su³r_block
 *
sb
, 
mmp_¡ruù
 *
mmp
)

32 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

35 
mmp
->
mmp_checksum
 = 
	`ext4_mmp_csum
(
sb
, mmp);

36 
	}
}

42 
	$wr™e_mmp_block
(
su³r_block
 *
sb
, 
bufãr_h—d
 *
bh
)

44 
mmp_¡ruù
 *
mmp
 = (mmp_¡ruù *)(
bh
->
b_d©a
);

50 
	`sb_¡¬t_wr™e
(
sb
);

51 
	`ext4_mmp_csum_£t
(
sb
, 
mmp
);

52 
	`lock_bufãr
(
bh
);

53 
bh
->
b_’d_io
 = 
’d_bufãr_wr™e_sync
;

54 
	`g‘_bh
(
bh
);

55 
	`subm™_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
 | 
REQ_META
 | 
REQ_PRIO
, 
bh
);

56 
	`wa™_Ú_bufãr
(
bh
);

57 
	`sb_’d_wr™e
(
sb
);

58 ià(
	`uÆik–y
(!
	`bufãr_u±od©e
(
bh
)))

62 
	}
}

68 
	$»ad_mmp_block
(
su³r_block
 *
sb
, 
bufãr_h—d
 **
bh
,

69 
ext4_fsblk_t
 
mmp_block
)

71 
mmp_¡ruù
 *
mmp
;

72 
»t
;

74 ià(*
bh
)

75 
	`ş—r_bufãr_u±od©e
(*
bh
);

80 ià(!*
bh
) {

81 *
bh
 = 
	`sb_g‘blk
(
sb
, 
mmp_block
);

82 ià(!*
bh
) {

83 
»t
 = -
ENOMEM
;

84 
w¬n_ex™
;

88 
	`g‘_bh
(*
bh
);

89 
	`lock_bufãr
(*
bh
);

90 (*
bh
)->
b_’d_io
 = 
’d_bufãr_»ad_sync
;

91 
	`subm™_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, *
bh
);

92 
	`wa™_Ú_bufãr
(*
bh
);

93 ià(!
	`bufãr_u±od©e
(*
bh
)) {

94 
»t
 = -
EIO
;

95 
w¬n_ex™
;

97 
mmp
 = (
mmp_¡ruù
 *)((*
bh
)->
b_d©a
);

98 ià(
	`Ë32_to_ıu
(
mmp
->
mmp_magic
è!ğ
EXT4_MMP_MAGIC
) {

99 
»t
 = -
EFSCORRUPTED
;

100 
w¬n_ex™
;

102 ià(!
	`ext4_mmp_csum_v”ify
(
sb
, 
mmp
)) {

103 
»t
 = -
EFSBADCRC
;

104 
w¬n_ex™
;

107 
w¬n_ex™
:

108 
	`b»l£
(*
bh
);

109 *
bh
 = 
NULL
;

110 
	`ext4_w¬nšg
(
sb
, "Error %d while„eading MMP block %llu",

111 
»t
, 
mmp_block
);

112  
»t
;

113 
	}
}

118 
	$__dump_mmp_msg
(
su³r_block
 *
sb
, 
mmp_¡ruù
 *
mmp
,

119 cÚ¡ *
funùiÚ
, 
lše
, cÚ¡ *
msg
)

121 
	`__ext4_w¬nšg
(
sb
, 
funùiÚ
, 
lše
, "%s", 
msg
);

122 
	`__ext4_w¬nšg
(
sb
, 
funùiÚ
, 
lše
,

125 (è
	`Ë64_to_ıu
(
mmp
->
mmp_time
),

126 
mmp
->
mmp_nod’ame
, mmp->
mmp_bdevÇme
);

127 
	}
}

132 
	$kmmpd
(*
d©a
)

134 
su³r_block
 *
sb
 = ((
mmpd_d©a
 *è
d©a
)->sb;

135 
bufãr_h—d
 *
bh
 = ((
mmpd_d©a
 *è
d©a
)->bh;

136 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

137 
mmp_¡ruù
 *
mmp
;

138 
ext4_fsblk_t
 
mmp_block
;

139 
u32
 
£q
 = 0;

140 
çed_wr™es
 = 0;

141 
mmp_upd©e_š‹rv®
 = 
	`Ë16_to_ıu
(
es
->
s_mmp_upd©e_š‹rv®
);

142 
mmp_check_š‹rv®
;

143 
Ï¡_upd©e_time
;

144 
diff
;

145 
»tv®
;

147 
mmp_block
 = 
	`Ë64_to_ıu
(
es
->
s_mmp_block
);

148 
mmp
 = (
mmp_¡ruù
 *)(
bh
->
b_d©a
);

149 
mmp
->
mmp_time
 = 
	`ıu_to_Ë64
(
	`ktime_g‘_»®_£cÚds
());

154 
mmp_check_š‹rv®
 = 
	`max
(
EXT4_MMP_CHECK_MULT
 * 
mmp_upd©e_š‹rv®
,

155 
EXT4_MMP_MIN_CHECK_INTERVAL
);

156 
mmp
->
mmp_check_š‹rv®
 = 
	`ıu_to_Ë16
(mmp_check_interval);

157 
	`bdevÇme
(
bh
->
b_bdev
, 
mmp
->
mmp_bdevÇme
);

159 
	`memıy
(
mmp
->
mmp_nod’ame
, 
	`š™_ut¢ame
()->
nod’ame
,

160 (
mmp
->
mmp_nod’ame
));

162 !
	`kth»ad_should_¡İ
()) {

163 ià(++
£q
 > 
EXT4_MMP_SEQ_MAX
)

164 
£q
 = 1;

166 
mmp
->
mmp_£q
 = 
	`ıu_to_Ë32
(
£q
);

167 
mmp
->
mmp_time
 = 
	`ıu_to_Ë64
(
	`ktime_g‘_»®_£cÚds
());

168 
Ï¡_upd©e_time
 = 
jiff›s
;

170 
»tv®
 = 
	`wr™e_mmp_block
(
sb
, 
bh
);

175 ià(
»tv®
) {

176 ià((
çed_wr™es
 % 60) == 0)

177 
	`ext4_”rÜ
(
sb
, "Error writingo MMP block");

178 
çed_wr™es
++;

181 ià(!(
	`Ë32_to_ıu
(
es
->
s_ã©u»_šcom·t
) &

182 
EXT4_FEATURE_INCOMPAT_MMP
)) {

183 
	`ext4_w¬nšg
(
sb
, "kmmpd being stopped since MMP feature"

185 
ex™_th»ad
;

188 ià(
	`sb_rdÚly
(
sb
))

191 
diff
 = 
jiff›s
 - 
Ï¡_upd©e_time
;

192 ià(
diff
 < 
mmp_upd©e_š‹rv®
 * 
HZ
)

193 
	`scheduË_timeout_š‹¼u±ibË
(
mmp_upd©e_š‹rv®
 *

194 
HZ
 - 
diff
);

201 
diff
 = 
jiff›s
 - 
Ï¡_upd©e_time
;

202 ià(
diff
 > 
mmp_check_š‹rv®
 * 
HZ
) {

203 
bufãr_h—d
 *
bh_check
 = 
NULL
;

204 
mmp_¡ruù
 *
mmp_check
;

206 
»tv®
 = 
	`»ad_mmp_block
(
sb
, &
bh_check
, 
mmp_block
);

207 ià(
»tv®
) {

208 
	`ext4_”rÜ
(
sb
, "error„eading MMP data: %d",

209 
»tv®
);

210 
ex™_th»ad
;

213 
mmp_check
 = (
mmp_¡ruù
 *)(
bh_check
->
b_d©a
);

214 ià(
mmp
->
mmp_£q
 !ğ
mmp_check
->mmp_seq ||

215 
	`memcmp
(
mmp
->
mmp_nod’ame
, 
mmp_check
->mmp_nodename,

216 (
mmp
->
mmp_nod’ame
))) {

217 
	`dump_mmp_msg
(
sb
, 
mmp_check
,

221 
	`ext4_”rÜ
(
sb
, "abort");

222 
	`put_bh
(
bh_check
);

223 
»tv®
 = -
EBUSY
;

224 
ex™_th»ad
;

226 
	`put_bh
(
bh_check
);

233 
mmp_check_š‹rv®
 = 
	`max
(
	`mš
(
EXT4_MMP_CHECK_MULT
 * 
diff
 / 
HZ
,

234 
EXT4_MMP_MAX_CHECK_INTERVAL
),

235 
EXT4_MMP_MIN_CHECK_INTERVAL
);

236 
mmp
->
mmp_check_š‹rv®
 = 
	`ıu_to_Ë16
(mmp_check_interval);

242 
mmp
->
mmp_£q
 = 
	`ıu_to_Ë32
(
EXT4_MMP_SEQ_CLEAN
);

243 
mmp
->
mmp_time
 = 
	`ıu_to_Ë64
(
	`ktime_g‘_»®_£cÚds
());

245 
»tv®
 = 
	`wr™e_mmp_block
(
sb
, 
bh
);

247 
ex™_th»ad
:

248 
	`EXT4_SB
(
sb
)->
s_mmp_tsk
 = 
NULL
;

249 
	`kä“
(
d©a
);

250 
	`b»l£
(
bh
);

251  
»tv®
;

252 
	}
}

258 
	$mmp_Ãw_£q
()

260 
u32
 
Ãw_£q
;

263 
Ãw_£q
 = 
	`´ªdom_u32
();

264 } 
Ãw_£q
 > 
EXT4_MMP_SEQ_MAX
);

266  
Ãw_£q
;

267 
	}
}

272 
	$ext4_muÉi_mouÁ_´Ùeù
(
su³r_block
 *
sb
,

273 
ext4_fsblk_t
 
mmp_block
)

275 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

276 
bufãr_h—d
 *
bh
 = 
NULL
;

277 
mmp_¡ruù
 *
mmp
 = 
NULL
;

278 
mmpd_d©a
 *mmpd_data;

279 
u32
 
£q
;

280 
mmp_check_š‹rv®
 = 
	`Ë16_to_ıu
(
es
->
s_mmp_upd©e_š‹rv®
);

281 
wa™_time
 = 0;

282 
»tv®
;

284 ià(
mmp_block
 < 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
) ||

285 
mmp_block
 >ğ
	`ext4_blocks_couÁ
(
es
)) {

286 
	`ext4_w¬nšg
(
sb
, "Invalid MMP block in superblock");

287 
çed
;

290 
»tv®
 = 
	`»ad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

291 ià(
»tv®
)

292 
çed
;

294 
mmp
 = (
mmp_¡ruù
 *)(
bh
->
b_d©a
);

296 ià(
mmp_check_š‹rv®
 < 
EXT4_MMP_MIN_CHECK_INTERVAL
)

297 
mmp_check_š‹rv®
 = 
EXT4_MMP_MIN_CHECK_INTERVAL
;

303 ià(
	`Ë16_to_ıu
(
mmp
->
mmp_check_š‹rv®
) > mmp_check_interval)

304 
mmp_check_š‹rv®
 = 
	`Ë16_to_ıu
(
mmp
->mmp_check_interval);

306 
£q
 = 
	`Ë32_to_ıu
(
mmp
->
mmp_£q
);

307 ià(
£q
 =ğ
EXT4_MMP_SEQ_CLEAN
)

308 
sk
;

310 ià(
£q
 =ğ
EXT4_MMP_SEQ_FSCK
) {

311 
	`dump_mmp_msg
(
sb
, 
mmp
, "fsck is„unning onhe filesystem");

312 
çed
;

315 
wa™_time
 = 
	`mš
(
mmp_check_š‹rv®
 * 2 + 1,

316 
mmp_check_š‹rv®
 + 60);

319 ià(
wa™_time
 > 
EXT4_MMP_MIN_CHECK_INTERVAL
 * 4)

320 
	`ext4_w¬nšg
(
sb
, "MMP interval %u higherhanƒxpected,…lease"

321 " wa™.\n", 
wa™_time
 * 2);

323 ià(
	`scheduË_timeout_š‹¼u±ibË
(
HZ
 * 
wa™_time
) != 0) {

324 
	`ext4_w¬nšg
(
sb
, "MMP startup interrupted, failing mount\n");

325 
çed
;

328 
»tv®
 = 
	`»ad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

329 ià(
»tv®
)

330 
çed
;

331 
mmp
 = (
mmp_¡ruù
 *)(
bh
->
b_d©a
);

332 ià(
£q
 !ğ
	`Ë32_to_ıu
(
mmp
->
mmp_£q
)) {

333 
	`dump_mmp_msg
(
sb
, 
mmp
,

335 
çed
;

338 
sk
:

342 
£q
 = 
	`mmp_Ãw_£q
();

343 
mmp
->
mmp_£q
 = 
	`ıu_to_Ë32
(
£q
);

345 
»tv®
 = 
	`wr™e_mmp_block
(
sb
, 
bh
);

346 ià(
»tv®
)

347 
çed
;

352 ià(
	`scheduË_timeout_š‹¼u±ibË
(
HZ
 * 
wa™_time
) != 0) {

353 
	`ext4_w¬nšg
(
sb
, "MMP startup interrupted, failing mount");

354 
çed
;

357 
»tv®
 = 
	`»ad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

358 ià(
»tv®
)

359 
çed
;

360 
mmp
 = (
mmp_¡ruù
 *)(
bh
->
b_d©a
);

361 ià(
£q
 !ğ
	`Ë32_to_ıu
(
mmp
->
mmp_£q
)) {

362 
	`dump_mmp_msg
(
sb
, 
mmp
,

364 
çed
;

367 
mmpd_d©a
 = 
	`km®loc
((*mmpd_d©a), 
GFP_KERNEL
);

368 ià(!
mmpd_d©a
) {

369 
	`ext4_w¬nšg
(
sb
, "notƒnough memory for mmpd_data");

370 
çed
;

372 
mmpd_d©a
->
sb
 = sb;

373 
mmpd_d©a
->
bh
 = bh;

378 
	`EXT4_SB
(
sb
)->
s_mmp_tsk
 = 
	`kth»ad_run
(
kmmpd
, 
mmpd_d©a
, "kmmpd-%s",

379 
	`bdevÇme
(
bh
->
b_bdev
,

380 
mmp
->
mmp_bdevÇme
));

381 ià(
	`IS_ERR
(
	`EXT4_SB
(
sb
)->
s_mmp_tsk
)) {

382 
	`EXT4_SB
(
sb
)->
s_mmp_tsk
 = 
NULL
;

383 
	`kä“
(
mmpd_d©a
);

384 
	`ext4_w¬nšg
(
sb
, "Unableo create kmmpdhread for %s.",

385 
sb
->
s_id
);

386 
çed
;

391 
çed
:

392 
	`b»l£
(
bh
);

394 
	}
}

	@pxt4/move_extent.c

8 
	~<lšux/fs.h
>

9 
	~<lšux/quÙaİs.h
>

10 
	~<lšux/¦ab.h
>

11 
	~"ext4_jbd2.h
"

12 
	~"ext4.h
"

13 
	~"ext4_ex‹Ás.h
"

24 
šlše
 

25 
	$g‘_ext_·th
(
šode
 *šode, 
ext4_lblk_t
 
lblock
,

26 
ext4_ext_·th
 **
µ©h
)

28 
ext4_ext_·th
 *
·th
;

30 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
lblock
, 
µ©h
, 
EXT4_EX_NOCACHE
);

31 ià(
	`IS_ERR
(
·th
))

32  
	`PTR_ERR
(
·th
);

33 ià(
·th
[
	`ext_d•th
(
šode
)].
p_ext
 =ğ
NULL
) {

34 
	`ext4_ext_drİ_»fs
(
·th
);

35 
	`kä“
(
·th
);

36 *
µ©h
 = 
NULL
;

37  -
ENODATA
;

39 *
µ©h
 = 
·th
;

41 
	}
}

51 
	$ext4_doubË_down_wr™e_d©a_£m
(
šode
 *
fœ¡
, šod*
£cÚd
)

53 ià(
fœ¡
 < 
£cÚd
) {

54 
	`down_wr™e
(&
	`EXT4_I
(
fœ¡
)->
i_d©a_£m
);

55 
	`down_wr™e_Ã¡ed
(&
	`EXT4_I
(
£cÚd
)->
i_d©a_£m
, 
I_DATA_SEM_OTHER
);

57 
	`down_wr™e
(&
	`EXT4_I
(
£cÚd
)->
i_d©a_£m
);

58 
	`down_wr™e_Ã¡ed
(&
	`EXT4_I
(
fœ¡
)->
i_d©a_£m
, 
I_DATA_SEM_OTHER
);

61 
	}
}

71 
	$ext4_doubË_up_wr™e_d©a_£m
(
šode
 *
Üig_šode
,

72 
šode
 *
dÚÜ_šode
)

74 
	`up_wr™e
(&
	`EXT4_I
(
Üig_šode
)->
i_d©a_£m
);

75 
	`up_wr™e
(&
	`EXT4_I
(
dÚÜ_šode
)->
i_d©a_£m
);

76 
	}
}

90 
	$mext_check_cov”age
(
šode
 *šode, 
ext4_lblk_t
 
äom
,ƒxt4_lblk_ˆ
couÁ
,

91 
unwr™‹n
, *
”r
)

93 
ext4_ext_·th
 *
·th
 = 
NULL
;

94 
ext4_ex‹Á
 *
ext
;

95 
»t
 = 0;

96 
ext4_lblk_t
 
Ï¡
 = 
äom
 + 
couÁ
;

97 
äom
 < 
Ï¡
) {

98 *
”r
 = 
	`g‘_ext_·th
(
šode
, 
äom
, &
·th
);

99 ià(*
”r
)

100 
out
;

101 
ext
 = 
·th
[
	`ext_d•th
(
šode
)].
p_ext
;

102 ià(
unwr™‹n
 !ğ
	`ext4_ext_is_unwr™‹n
(
ext
))

103 
out
;

104 
äom
 +ğ
	`ext4_ext_g‘_aùu®_Ën
(
ext
);

105 
	`ext4_ext_drİ_»fs
(
·th
);

107 
»t
 = 1;

108 
out
:

109 
	`ext4_ext_drİ_»fs
(
·th
);

110 
	`kä“
(
·th
);

111  
»t
;

112 
	}
}

126 
	$mext_·ge_doubË_lock
(
šode
 *
šode1
, šod*
šode2
,

127 
pgoff_t
 
šdex1
,…goff_ˆ
šdex2
, 
·ge
 *page[2])

129 
add»ss_¥aû
 *
m­pšg
[2];

130 
æ
 = 
AOP_FLAG_NOFS
;

132 
	`BUG_ON
(!
šode1
 || !
šode2
);

133 ià(
šode1
 < 
šode2
) {

134 
m­pšg
[0] = 
šode1
->
i_m­pšg
;

135 
m­pšg
[1] = 
šode2
->
i_m­pšg
;

137 
	`sw­
(
šdex1
, 
šdex2
);

138 
m­pšg
[0] = 
šode2
->
i_m­pšg
;

139 
m­pšg
[1] = 
šode1
->
i_m­pšg
;

142 
·ge
[0] = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
[0], 
šdex1
, 
æ
);

143 ià(!
·ge
[0])

144  -
ENOMEM
;

146 
·ge
[1] = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
[1], 
šdex2
, 
æ
);

147 ià(!
·ge
[1]) {

148 
	`uÆock_·ge
(
·ge
[0]);

149 
	`put_·ge
(
·ge
[0]);

150  -
ENOMEM
;

157 
	`wa™_Ú_·ge_wr™eback
(
·ge
[0]);

158 
	`wa™_Ú_·ge_wr™eback
(
·ge
[1]);

159 ià(
šode1
 > 
šode2
)

160 
	`sw­
(
·ge
[0],…age[1]);

163 
	}
}

167 
	$mext_·ge_mku±od©e
(
·ge
 *·ge, 
äom
, 
to
)

169 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

170 
£ùÜ_t
 
block
;

171 
bufãr_h—d
 *
bh
, *
h—d
, *
¬r
[
MAX_BUF_PER_PAGE
];

172 
blocksize
, 
block_¡¬t
, 
block_’d
;

173 
i
, 
”r
, 
Ä
 = 0, 
·¹Ÿl
 = 0;

174 
	`BUG_ON
(!
	`PageLocked
(
·ge
));

175 
	`BUG_ON
(
	`PageWr™eback
(
·ge
));

177 ià(
	`PageU±od©e
(
·ge
))

180 
blocksize
 = 
	`i_blocksize
(
šode
);

181 ià(!
	`·ge_has_bufãrs
(
·ge
))

182 
	`ü—‹_em±y_bufãrs
(
·ge
, 
blocksize
, 0);

184 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

185 
block
 = (
£ùÜ_t
)
·ge
->
šdex
 << (
PAGE_SHIFT
 - 
šode
->
i_blkb™s
);

186 
bh
 = 
h—d
, 
block_¡¬t
 = 0; bh != head || !block_start;

187 
block
++, 
block_¡¬t
 = 
block_’d
, 
bh
 = bh->
b_this_·ge
) {

188 
block_’d
 = 
block_¡¬t
 + 
blocksize
;

189 ià(
block_’d
 <ğ
äom
 || 
block_¡¬t
 >ğ
to
) {

190 ià(!
	`bufãr_u±od©e
(
bh
))

191 
·¹Ÿl
 = 1;

194 ià(
	`bufãr_u±od©e
(
bh
))

196 ià(!
	`bufãr_m­³d
(
bh
)) {

197 
”r
 = 
	`ext4_g‘_block
(
šode
, 
block
, 
bh
, 0);

198 ià(
”r
) {

199 
	`S‘PageE¼Ü
(
·ge
);

200  
”r
;

202 ià(!
	`bufãr_m­³d
(
bh
)) {

203 
	`z”o_u£r
(
·ge
, 
block_¡¬t
, 
blocksize
);

204 
	`£t_bufãr_u±od©e
(
bh
);

208 
	`BUG_ON
(
Ä
 >ğ
MAX_BUF_PER_PAGE
);

209 
¬r
[
Ä
++] = 
bh
;

212 ià(!
Ä
)

213 
out
;

215 
i
 = 0; i < 
Ä
; i++) {

216 
bh
 = 
¬r
[
i
];

217 ià(!
	`bh_u±od©e_Ü_lock
(
bh
)) {

218 
”r
 = 
	`bh_subm™_»ad
(
bh
);

219 ià(
”r
)

220  
”r
;

223 
out
:

224 ià(!
·¹Ÿl
)

225 
	`S‘PageU±od©e
(
·ge
);

227 
	}
}

247 
	$move_ex‹Á_³r_·ge
(
fe
 *
o_fp
, 
šode
 *
dÚÜ_šode
,

248 
pgoff_t
 
Üig_·ge_off£t
,…goff_ˆ
dÚÜ_·ge_off£t
,

249 
d©a_off£t_š_·ge
,

250 
block_Ën_š_·ge
, 
unwr™‹n
, *
”r
)

252 
šode
 *
Üig_šode
 = 
	`fe_šode
(
o_fp
);

253 
·ge
 *
·g•
[2] = {
NULL
, NULL};

254 
hªdË_t
 *
hªdË
;

255 
ext4_lblk_t
 
Üig_blk_off£t
, 
dÚÜ_blk_off£t
;

256 
blocksize
 = 
Üig_šode
->
i_sb
->
s_blocksize
;

257 
tmp_d©a_size
, 
d©a_size
, 
»¶aûd_size
;

258 
i
, 
”r2
, 
jblocks
, 
»Œ›s
 = 0;

259 
»¶aûd_couÁ
 = 0;

260 
äom
 = 
d©a_off£t_š_·ge
 << 
Üig_šode
->
i_blkb™s
;

261 
blocks_³r_·ge
 = 
PAGE_SIZE
 >> 
Üig_šode
->
i_blkb™s
;

262 
su³r_block
 *
sb
 = 
Üig_šode
->
i_sb
;

263 
bufãr_h—d
 *
bh
 = 
NULL
;

269 
agaš
:

270 *
”r
 = 0;

271 
jblocks
 = 
	`ext4_wr™•age_Œªs_blocks
(
Üig_šode
) * 2;

272 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
Üig_šode
, 
EXT4_HT_MOVE_EXTENTS
, 
jblocks
);

273 ià(
	`IS_ERR
(
hªdË
)) {

274 *
”r
 = 
	`PTR_ERR
(
hªdË
);

278 
Üig_blk_off£t
 = 
Üig_·ge_off£t
 * 
blocks_³r_·ge
 +

279 
d©a_off£t_š_·ge
;

281 
dÚÜ_blk_off£t
 = 
dÚÜ_·ge_off£t
 * 
blocks_³r_·ge
 +

282 
d©a_off£t_š_·ge
;

285 ià((
Üig_blk_off£t
 + 
block_Ën_š_·ge
 - 1) ==

286 ((
Üig_šode
->
i_size
 - 1è>> orig_šode->
i_blkb™s
)) {

288 
tmp_d©a_size
 = 
Üig_šode
->
i_size
 & (
blocksize
 - 1);

293 ià(
tmp_d©a_size
 == 0)

294 
tmp_d©a_size
 = 
blocksize
;

296 
d©a_size
 = 
tmp_d©a_size
 +

297 ((
block_Ën_š_·ge
 - 1è<< 
Üig_šode
->
i_blkb™s
);

299 
d©a_size
 = 
block_Ën_š_·ge
 << 
Üig_šode
->
i_blkb™s
;

301 
»¶aûd_size
 = 
d©a_size
;

303 *
”r
 = 
	`mext_·ge_doubË_lock
(
Üig_šode
, 
dÚÜ_šode
, 
Üig_·ge_off£t
,

304 
dÚÜ_·ge_off£t
, 
·g•
);

305 ià(
	`uÆik–y
(*
”r
 < 0))

306 
¡İ_jouº®
;

314 ià(
unwr™‹n
) {

315 
	`ext4_doubË_down_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

318 
unwr™‹n
 = 
	`mext_check_cov”age
(
Üig_šode
, 
Üig_blk_off£t
,

319 
block_Ën_š_·ge
, 1, 
”r
);

320 ià(*
”r
)

321 
drİ_d©a_£m
;

323 
unwr™‹n
 &ğ
	`mext_check_cov”age
(
dÚÜ_šode
, 
dÚÜ_blk_off£t
,

324 
block_Ën_š_·ge
, 1, 
”r
);

325 ià(*
”r
)

326 
drİ_d©a_£m
;

328 ià(!
unwr™‹n
) {

329 
	`ext4_doubË_up_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

330 
d©a_cİy
;

332 ià((
	`·ge_has_´iv©e
(
·g•
[0]) &&

333 !
	`Œy_to_»Ëa£_·ge
(
·g•
[0], 0)) ||

334 (
	`·ge_has_´iv©e
(
·g•
[1]) &&

335 !
	`Œy_to_»Ëa£_·ge
(
·g•
[1], 0))) {

336 *
”r
 = -
EBUSY
;

337 
drİ_d©a_£m
;

339 
»¶aûd_couÁ
 = 
	`ext4_sw­_ex‹Ás
(
hªdË
, 
Üig_šode
,

340 
dÚÜ_šode
, 
Üig_blk_off£t
,

341 
dÚÜ_blk_off£t
,

342 
block_Ën_š_·ge
, 1, 
”r
);

343 
drİ_d©a_£m
:

344 
	`ext4_doubË_up_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

345 
uÆock_·ges
;

347 
d©a_cİy
:

348 *
”r
 = 
	`mext_·ge_mku±od©e
(
·g•
[0], 
äom
, from + 
»¶aûd_size
);

349 ià(*
”r
)

350 
uÆock_·ges
;

354 ià((
	`·ge_has_´iv©e
(
·g•
[0]è&& !
	`Œy_to_»Ëa£_·ge
(pagep[0], 0)) ||

355 (
	`·ge_has_´iv©e
(
·g•
[1]è&& !
	`Œy_to_»Ëa£_·ge
(pagep[1], 0))) {

356 *
”r
 = -
EBUSY
;

357 
uÆock_·ges
;

359 
	`ext4_doubË_down_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

360 
»¶aûd_couÁ
 = 
	`ext4_sw­_ex‹Ás
(
hªdË
, 
Üig_šode
, 
dÚÜ_šode
,

361 
Üig_blk_off£t
, 
dÚÜ_blk_off£t
,

362 
block_Ën_š_·ge
, 1, 
”r
);

363 
	`ext4_doubË_up_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

364 ià(*
”r
) {

365 ià(
»¶aûd_couÁ
) {

366 
block_Ën_š_·ge
 = 
»¶aûd_couÁ
;

367 
»¶aûd_size
 =

368 
block_Ën_š_·ge
 << 
Üig_šode
->
i_blkb™s
;

370 
uÆock_·ges
;

374 ià(!
	`·ge_has_bufãrs
(
·g•
[0]))

375 
	`ü—‹_em±y_bufãrs
(
·g•
[0], 1 << 
Üig_šode
->
i_blkb™s
, 0);

376 
bh
 = 
	`·ge_bufãrs
(
·g•
[0]);

377 
i
 = 0; i < 
d©a_off£t_š_·ge
; i++)

378 
bh
 = bh->
b_this_·ge
;

379 
i
 = 0; i < 
block_Ën_š_·ge
; i++) {

380 *
”r
 = 
	`ext4_g‘_block
(
Üig_šode
, 
Üig_blk_off£t
 + 
i
, 
bh
, 0);

381 ià(*
”r
 < 0)

383 
bh
 = bh->
b_this_·ge
;

385 ià(!*
”r
)

386 *
”r
 = 
	`block_comm™_wr™e
(
·g•
[0], 
äom
, from + 
»¶aûd_size
);

388 ià(
	`uÆik–y
(*
”r
 < 0))

389 
»·œ_b¿nches
;

393 *
”r
 = 
	`ext4_jbd2_šode_add_wr™e
(
hªdË
, 
Üig_šode
,

394 (
loff_t
)
Üig_·ge_off£t
 << 
PAGE_SHIFT
, 
»¶aûd_size
);

396 
uÆock_·ges
:

397 
	`uÆock_·ge
(
·g•
[0]);

398 
	`put_·ge
(
·g•
[0]);

399 
	`uÆock_·ge
(
·g•
[1]);

400 
	`put_·ge
(
·g•
[1]);

401 
¡İ_jouº®
:

402 
	`ext4_jouº®_¡İ
(
hªdË
);

403 ià(*
”r
 =ğ-
ENOSPC
 &&

404 
	`ext4_should_»Œy_®loc
(
sb
, &
»Œ›s
))

405 
agaš
;

408 ià(*
”r
 =ğ-
EBUSY
 && 
»Œ›s
++ < 4 && 
	`EXT4_SB
(
sb
)->
s_jouº®
 &&

409 
	`jbd2_jouº®_fÜû_comm™_Ã¡ed
(
	`EXT4_SB
(
sb
)->
s_jouº®
))

410 
agaš
;

411  
»¶aûd_couÁ
;

413 
»·œ_b¿nches
:

419 
	`ext4_doubË_down_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

420 
»¶aûd_couÁ
 = 
	`ext4_sw­_ex‹Ás
(
hªdË
, 
dÚÜ_šode
, 
Üig_šode
,

421 
Üig_blk_off£t
, 
dÚÜ_blk_off£t
,

422 
block_Ën_š_·ge
, 0, &
”r2
);

423 
	`ext4_doubË_up_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

424 ià(
»¶aûd_couÁ
 !ğ
block_Ën_š_·ge
) {

425 
	`EXT4_ERROR_INODE_BLOCK
(
Üig_šode
, (
£ùÜ_t
)(
Üig_blk_off£t
),

428 *
”r
 = -
EIO
;

430 
»¶aûd_couÁ
 = 0;

431 
uÆock_·ges
;

432 
	}
}

448 
	$mext_check_¬gum’ts
(
šode
 *
Üig_šode
,

449 
šode
 *
dÚÜ_šode
, 
__u64
 
Üig_¡¬t
,

450 
__u64
 
dÚÜ_¡¬t
, __u64 *
Ën
)

452 
__u64
 
Üig_eof
, 
dÚÜ_eof
;

453 
blkb™s
 = 
Üig_šode
->
i_blkb™s
;

454 
blocksize
 = 1 << 
blkb™s
;

456 
Üig_eof
 = (
	`i_size_»ad
(
Üig_šode
è+ 
blocksize
 - 1è>> 
blkb™s
;

457 
dÚÜ_eof
 = (
	`i_size_»ad
(
dÚÜ_šode
è+ 
blocksize
 - 1è>> 
blkb™s
;

460 ià(
dÚÜ_šode
->
i_mode
 & (
S_ISUID
|
S_ISGID
)) {

461 
	`ext4_debug
("ext4 moveƒxtent: suid or sgid is set"

463 
Üig_šode
->
i_šo
, 
dÚÜ_šode
->i_ino);

464  -
EINVAL
;

467 ià(
	`IS_IMMUTABLE
(
dÚÜ_šode
è|| 
	`IS_APPEND
(donor_inode))

468  -
EPERM
;

471 ià(
	`IS_SWAPFILE
(
Üig_šode
è|| IS_SWAPFILE(
dÚÜ_šode
)) {

472 
	`ext4_debug
("ext4 moveƒxtent: The‡rgument files should "

474 
Üig_šode
->
i_šo
, 
dÚÜ_šode
->i_ino);

475  -
EBUSY
;

478 ià(
	`ext4_is_quÙa_fe
(
Üig_šode
è&&ƒxt4_is_quÙa_fe(
dÚÜ_šode
)) {

479 
	`ext4_debug
("ext4 moveƒxtent: The‡rgument files should "

481 
Üig_šode
->
i_šo
, 
dÚÜ_šode
->i_ino);

482  -
EBUSY
;

486 ià(!(
	`ext4_‹¡_šode_æag
(
Üig_šode
, 
EXT4_INODE_EXTENTS
))) {

487 
	`ext4_debug
("ext4 moveƒxtent: orig file is‚otƒxtents "

488 "ba£d f[šo:Üig %lu]\n", 
Üig_šode
->
i_šo
);

489  -
EOPNOTSUPP
;

490 } ià(!(
	`ext4_‹¡_šode_æag
(
dÚÜ_šode
, 
EXT4_INODE_EXTENTS
))) {

491 
	`ext4_debug
("ext4 moveƒxtent: donor file is‚otƒxtents "

492 "ba£d f[šo:dÚÜ %lu]\n", 
dÚÜ_šode
->
i_šo
);

493  -
EOPNOTSUPP
;

496 ià((!
Üig_šode
->
i_size
è|| (!
dÚÜ_šode
->i_size)) {

497 
	`ext4_debug
("ext4 moveƒxtent: File size is 0 byte\n");

498  -
EINVAL
;

502 ià((
Üig_¡¬t
 & ~(
PAGE_MASK
 >> 
Üig_šode
->
i_blkb™s
)) !=

503 (
dÚÜ_¡¬t
 & ~(
PAGE_MASK
 >> 
Üig_šode
->
i_blkb™s
))) {

504 
	`ext4_debug
("ext4 moveƒxtent: orig‡nd donor's start "

506 
Üig_šode
->
i_šo
, 
dÚÜ_šode
->i_ino);

507  -
EINVAL
;

510 ià((
Üig_¡¬t
 >ğ
EXT_MAX_BLOCKS
) ||

511 (
dÚÜ_¡¬t
 >ğ
EXT_MAX_BLOCKS
) ||

512 (*
Ën
 > 
EXT_MAX_BLOCKS
) ||

513 (
dÚÜ_¡¬t
 + *
Ën
 >ğ
EXT_MAX_BLOCKS
) ||

514 (
Üig_¡¬t
 + *
Ën
 >ğ
EXT_MAX_BLOCKS
)) {

515 
	`ext4_debug
("ext4 moveƒxtent: Can't handle over [%u] blocks "

516 "[šo:Üig %lu, dÚÜ %lu]\n", 
EXT_MAX_BLOCKS
,

517 
Üig_šode
->
i_šo
, 
dÚÜ_šode
->i_ino);

518  -
EINVAL
;

520 ià(
Üig_eof
 <ğ
Üig_¡¬t
)

521 *
Ën
 = 0;

522 ià(
Üig_eof
 < 
Üig_¡¬t
 + *
Ën
 - 1)

523 *
Ën
 = 
Üig_eof
 - 
Üig_¡¬t
;

524 ià(
dÚÜ_eof
 <ğ
dÚÜ_¡¬t
)

525 *
Ën
 = 0;

526 ià(
dÚÜ_eof
 < 
dÚÜ_¡¬t
 + *
Ën
 - 1)

527 *
Ën
 = 
dÚÜ_eof
 - 
dÚÜ_¡¬t
;

528 ià(!*
Ën
) {

529 
	`ext4_debug
("ext4 moveƒxtent:†en should‚ot be 0 "

530 "[šo:Üig %lu, dÚÜ %lu]\n", 
Üig_šode
->
i_šo
,

531 
dÚÜ_šode
->
i_šo
);

532  -
EINVAL
;

536 
	}
}

553 
	$ext4_move_ex‹Ás
(
fe
 *
o_fp
, f*
d_fp
, 
__u64
 
Üig_blk
,

554 
__u64
 
dÚÜ_blk
, __u64 
Ën
, __u64 *
moved_Ën
)

556 
šode
 *
Üig_šode
 = 
	`fe_šode
(
o_fp
);

557 
šode
 *
dÚÜ_šode
 = 
	`fe_šode
(
d_fp
);

558 
ext4_ext_·th
 *
·th
 = 
NULL
;

559 
blocks_³r_·ge
 = 
PAGE_SIZE
 >> 
Üig_šode
->
i_blkb™s
;

560 
ext4_lblk_t
 
o_’d
, 
o_¡¬t
 = 
Üig_blk
;

561 
ext4_lblk_t
 
d_¡¬t
 = 
dÚÜ_blk
;

562 
»t
;

564 ià(
Üig_šode
->
i_sb
 !ğ
dÚÜ_šode
->i_sb) {

565 
	`ext4_debug
("ext4 moveƒxtent: The‡rgument files "

567 
Üig_šode
->
i_šo
, 
dÚÜ_šode
->i_ino);

568  -
EINVAL
;

572 ià(
Üig_šode
 =ğ
dÚÜ_šode
) {

573 
	`ext4_debug
("ext4 moveƒxtent: The‡rgument files should‚ot "

575 
Üig_šode
->
i_šo
, 
dÚÜ_šode
->i_ino);

576  -
EINVAL
;

580 ià(!
	`S_ISREG
(
Üig_šode
->
i_mode
è|| !S_ISREG(
dÚÜ_šode
->i_mode)) {

581 
	`ext4_debug
("ext4 moveƒxtent: The‡rgument files should be "

583 
Üig_šode
->
i_šo
, 
dÚÜ_šode
->i_ino);

584  -
EINVAL
;

589 ià(
	`ext4_should_jouº®_d©a
(
Üig_šode
) ||

590 
	`ext4_should_jouº®_d©a
(
dÚÜ_šode
)) {

591 
	`ext4_msg
(
Üig_šode
->
i_sb
, 
KERN_ERR
,

593  -
EOPNOTSUPP
;

596 ià(
	`IS_ENCRYPTED
(
Üig_šode
è|| IS_ENCRYPTED(
dÚÜ_šode
)) {

597 
	`ext4_msg
(
Üig_šode
->
i_sb
, 
KERN_ERR
,

599  -
EOPNOTSUPP
;

603 
	`lock_two_nÚdœeùÜ›s
(
Üig_šode
, 
dÚÜ_šode
);

606 
	`šode_dio_wa™
(
Üig_šode
);

607 
	`šode_dio_wa™
(
dÚÜ_šode
);

610 
	`ext4_doubË_down_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

612 
»t
 = 
	`mext_check_¬gum’ts
(
Üig_šode
, 
dÚÜ_šode
, 
Üig_blk
,

613 
dÚÜ_blk
, &
Ën
);

614 ià(
»t
)

615 
out
;

616 
o_’d
 = 
o_¡¬t
 + 
Ën
;

618 
o_¡¬t
 < 
o_’d
) {

619 
ext4_ex‹Á
 *
ex
;

620 
ext4_lblk_t
 
cur_blk
, 
Ãxt_blk
;

621 
pgoff_t
 
Üig_·ge_šdex
, 
dÚÜ_·ge_šdex
;

622 
off£t_š_·ge
;

623 
unwr™‹n
, 
cur_Ën
;

625 
»t
 = 
	`g‘_ext_·th
(
Üig_šode
, 
o_¡¬t
, &
·th
);

626 ià(
»t
)

627 
out
;

628 
ex
 = 
·th
[·th->
p_d•th
].
p_ext
;

629 
Ãxt_blk
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th
);

630 
cur_blk
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

631 
cur_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

633 ià(
cur_blk
 + 
cur_Ën
 - 1 < 
o_¡¬t
) {

634 ià(
Ãxt_blk
 =ğ
EXT_MAX_BLOCKS
) {

635 
o_¡¬t
 = 
o_’d
;

636 
»t
 = -
ENODATA
;

637 
out
;

639 
d_¡¬t
 +ğ
Ãxt_blk
 - 
o_¡¬t
;

640 
o_¡¬t
 = 
Ãxt_blk
;

643 } ià(
cur_blk
 > 
o_¡¬t
) {

645 
d_¡¬t
 +ğ
cur_blk
 - 
o_¡¬t
;

646 
o_¡¬t
 = 
cur_blk
;

648 ià(
cur_blk
 >ğ
o_’d
)

649 
out
;

651 
cur_Ën
 +ğ
cur_blk
 - 
o_¡¬t
;

653 
unwr™‹n
 = 
	`ext4_ext_is_unwr™‹n
(
ex
);

654 ià(
o_’d
 - 
o_¡¬t
 < 
cur_Ën
)

655 
cur_Ën
 = 
o_’d
 - 
o_¡¬t
;

657 
Üig_·ge_šdex
 = 
o_¡¬t
 >> (
PAGE_SHIFT
 -

658 
Üig_šode
->
i_blkb™s
);

659 
dÚÜ_·ge_šdex
 = 
d_¡¬t
 >> (
PAGE_SHIFT
 -

660 
dÚÜ_šode
->
i_blkb™s
);

661 
off£t_š_·ge
 = 
o_¡¬t
 % 
blocks_³r_·ge
;

662 ià(
cur_Ën
 > 
blocks_³r_·ge
- 
off£t_š_·ge
)

663 
cur_Ën
 = 
blocks_³r_·ge
 - 
off£t_š_·ge
;

671 
	`ext4_doubË_up_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

673 
	`move_ex‹Á_³r_·ge
(
o_fp
, 
dÚÜ_šode
,

674 
Üig_·ge_šdex
, 
dÚÜ_·ge_šdex
,

675 
off£t_š_·ge
, 
cur_Ën
,

676 
unwr™‹n
, &
»t
);

677 
	`ext4_doubË_down_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

678 ià(
»t
 < 0)

680 
o_¡¬t
 +ğ
cur_Ën
;

681 
d_¡¬t
 +ğ
cur_Ën
;

683 *
moved_Ën
 = 
o_¡¬t
 - 
Üig_blk
;

684 ià(*
moved_Ën
 > 
Ën
)

685 *
moved_Ën
 = 
Ën
;

687 
out
:

688 ià(*
moved_Ën
) {

689 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
Üig_šode
);

690 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
dÚÜ_šode
);

693 
	`ext4_ext_drİ_»fs
(
·th
);

694 
	`kä“
(
·th
);

695 
	`ext4_doubË_up_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

696 
	`uÆock_two_nÚdœeùÜ›s
(
Üig_šode
, 
dÚÜ_šode
);

698  
»t
;

699 
	}
}

	@pxt4/namei.c

28 
	~<lšux/fs.h
>

29 
	~<lšux/·gem­.h
>

30 
	~<lšux/time.h
>

31 
	~<lšux/fú.h
>

32 
	~<lšux/¡©.h
>

33 
	~<lšux/¡ršg.h
>

34 
	~<lšux/quÙaİs.h
>

35 
	~<lšux/bufãr_h—d.h
>

36 
	~<lšux/bio.h
>

37 
	~<lšux/iv”siÚ.h
>

38 
	~<lšux/unicode.h
>

39 
	~"ext4.h
"

40 
	~"ext4_jbd2.h
"

42 
	~"x©Œ.h
"

43 
	~"aş.h
"

45 
	~<Œaû/ev’ts/ext4.h
>

49 
	#NAMEI_RA_CHUNKS
 2

	)

50 
	#NAMEI_RA_BLOCKS
 4

	)

51 
	#NAMEI_RA_SIZE
 (
NAMEI_RA_CHUNKS
 * 
NAMEI_RA_BLOCKS
)

	)

53 
bufãr_h—d
 *
	$ext4_­³nd
(
hªdË_t
 *
hªdË
,

54 
šode
 *inode,

55 
ext4_lblk_t
 *
block
)

57 
bufãr_h—d
 *
bh
;

58 
”r
;

60 ià(
	`uÆik–y
(
	`EXT4_SB
(
šode
->
i_sb
)->
s_max_dœ_size_kb
 &&

61 ((
šode
->
i_size
 >> 10) >=

62 
	`EXT4_SB
(
šode
->
i_sb
)->
s_max_dœ_size_kb
)))

63  
	`ERR_PTR
(-
ENOSPC
);

65 *
block
 = 
šode
->
i_size
 >> inode->
i_sb
->
s_blocksize_b™s
;

67 
bh
 = 
	`ext4_b»ad
(
hªdË
, 
šode
, *
block
, 
EXT4_GET_BLOCKS_CREATE
);

68 ià(
	`IS_ERR
(
bh
))

69  
bh
;

70 
šode
->
i_size
 +ğšode->
i_sb
->
s_blocksize
;

71 
	`EXT4_I
(
šode
)->
i_disksize
 = inode->
i_size
;

72 
	`BUFFER_TRACE
(
bh
, "get_write_access");

73 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

74 ià(
”r
) {

75 
	`b»l£
(
bh
);

76 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”r
);

77  
	`ERR_PTR
(
”r
);

79  
bh
;

80 
	}
}

82 
ext4_dx_csum_v”ify
(
šode
 *inode,

83 
ext4_dœ_’Œy
 *
dœ’t
);

96 
	mEITHER
, 
	mINDEX
, 
	mDIRENT
, 
	mDIRENT_HTREE


97 } 
	tdœblock_ty³_t
;

99 
	#ext4_»ad_dœblock
(
šode
, 
block
, 
ty³
) \

100 
	`__ext4_»ad_dœblock
((
šode
), (
block
), (
ty³
), 
__func__
, 
__LINE__
)

	)

102 
bufãr_h—d
 *
	$__ext4_»ad_dœblock
(
šode
 *inode,

103 
ext4_lblk_t
 
block
,

104 
dœblock_ty³_t
 
ty³
,

105 cÚ¡ *
func
,

106 
lše
)

108 
bufãr_h—d
 *
bh
;

109 
ext4_dœ_’Œy
 *
dœ’t
;

110 
is_dx_block
 = 0;

112 
bh
 = 
	`ext4_b»ad
(
NULL
, 
šode
, 
block
, 0);

113 ià(
	`IS_ERR
(
bh
)) {

114 
	`__ext4_w¬nšg
(
šode
->
i_sb
, 
func
, 
lše
,

117 
šode
->
i_šo
, ()
block
,

118 
cu¼’t
->
comm
, 
	`PTR_ERR
(
bh
));

120  
bh
;

122 ià(!
bh
 && (
ty³
 =ğ
INDEX
 ||y³ =ğ
DIRENT_HTREE
)) {

123 
	`ext4_”rÜ_šode
(
šode
, 
func
, 
lše
, 
block
,

125 (
ty³
 =ğ
INDEX
) ? "index" : "leaf");

126  
	`ERR_PTR
(-
EFSCORRUPTED
);

128 ià(!
bh
)

129  
NULL
;

130 
dœ’t
 = (
ext4_dœ_’Œy
 *è
bh
->
b_d©a
;

132 ià(
	`is_dx
(
šode
)) {

133 ià(
block
 == 0)

134 
is_dx_block
 = 1;

135 ià(
	`ext4_»c_Ën_äom_disk
(
dœ’t
->
»c_Ën
,

136 
šode
->
i_sb
->
s_blocksize
) ==

137 
šode
->
i_sb
->
s_blocksize
)

138 
is_dx_block
 = 1;

140 ià(!
is_dx_block
 && 
ty³
 =ğ
INDEX
) {

141 
	`ext4_”rÜ_šode
(
šode
, 
func
, 
lše
, 
block
,

143 
	`b»l£
(
bh
);

144  
	`ERR_PTR
(-
EFSCORRUPTED
);

146 ià(!
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
) ||

147 
	`bufãr_v”if›d
(
bh
))

148  
bh
;

155 ià(
is_dx_block
 && 
ty³
 =ğ
INDEX
) {

156 ià(
	`ext4_dx_csum_v”ify
(
šode
, 
dœ’t
))

157 
	`£t_bufãr_v”if›d
(
bh
);

159 
	`ext4_”rÜ_šode
(
šode
, 
func
, 
lše
, 
block
,

161 
	`b»l£
(
bh
);

162  
	`ERR_PTR
(-
EFSBADCRC
);

165 ià(!
is_dx_block
) {

166 ià(
	`ext4_dœblock_csum_v”ify
(
šode
, 
bh
))

167 
	`£t_bufãr_v”if›d
(
bh
);

169 
	`ext4_”rÜ_šode
(
šode
, 
func
, 
lše
, 
block
,

171 
	`b»l£
(
bh
);

172  
	`ERR_PTR
(-
EFSBADCRC
);

175  
bh
;

176 
	}
}

178 #iâdeà
as£¹


179 
	#as£¹
(
‹¡
è
	`J_ASSERT
Ñe¡)

	)

182 #ifdeà
DX_DEBUG


183 
	#dxŒaû
(
commªd
è
	)
command

185 
	#dxŒaû
(
commªd
)

	)

188 
	sçke_dœ’t


190 
__Ë32
 
	mšode
;

191 
__Ë16
 
	m»c_Ën
;

192 
u8
 
	mÇme_Ën
;

193 
u8
 
	mfe_ty³
;

196 
	sdx_couÁlim™


198 
__Ë16
 
	mlim™
;

199 
__Ë16
 
	mcouÁ
;

202 
	sdx_’Œy


204 
__Ë32
 
	mhash
;

205 
__Ë32
 
	mblock
;

214 
	sdx_roÙ


216 
çke_dœ’t
 
	mdÙ
;

217 
	mdÙ_Çme
[4];

218 
çke_dœ’t
 
	mdÙdÙ
;

219 
	mdÙdÙ_Çme
[4];

220 
	sdx_roÙ_šfo


222 
__Ë32
 
	m»£rved_z”o
;

223 
u8
 
	mhash_v”siÚ
;

224 
u8
 
	mšfo_Ëngth
;

225 
u8
 
	mšdœeù_Ëv–s
;

226 
u8
 
	munu£d_æags
;

228 
	mšfo
;

229 
dx_’Œy
 
	m’Œ›s
[0];

232 
	sdx_node


234 
çke_dœ’t
 
	mçke
;

235 
dx_’Œy
 
	m’Œ›s
[0];

239 
	sdx_äame


241 
bufãr_h—d
 *
	mbh
;

242 
dx_’Œy
 *
	m’Œ›s
;

243 
dx_’Œy
 *
	m©
;

246 
	sdx_m­_’Œy


248 
u32
 
	mhash
;

249 
u16
 
	moffs
;

250 
u16
 
	msize
;

256 
	sdx_
 {

257 
u32
 
	mdt_»£rved
;

258 
__Ë32
 
	mdt_checksum
;

261 
šlše
 
ext4_lblk_t
 
dx_g‘_block
(
dx_’Œy
 *
’Œy
);

262 
dx_£t_block
(
dx_’Œy
 *
’Œy
, 
ext4_lblk_t
 
v®ue
);

263 
šlše
 
dx_g‘_hash
(
dx_’Œy
 *
’Œy
);

264 
dx_£t_hash
(
dx_’Œy
 *
’Œy
, 
v®ue
);

265 
dx_g‘_couÁ
(
dx_’Œy
 *
’Œ›s
);

266 
dx_g‘_lim™
(
dx_’Œy
 *
’Œ›s
);

267 
dx_£t_couÁ
(
dx_’Œy
 *
’Œ›s
, 
v®ue
);

268 
dx_£t_lim™
(
dx_’Œy
 *
’Œ›s
, 
v®ue
);

269 
dx_roÙ_lim™
(
šode
 *
dœ
, 
šfosize
);

270 
dx_node_lim™
(
šode
 *
dœ
);

271 
dx_äame
 *
dx_´obe
(
ext4_f’ame
 *
âame
,

272 
šode
 *
dœ
,

273 
dx_hash_šfo
 *
hšfo
,

274 
dx_äame
 *
äame
);

275 
dx_»Ëa£
(
dx_äame
 *
äames
);

276 
dx_make_m­
(
šode
 *
dœ
, 
ext4_dœ_’Œy_2
 *
de
,

277 
blocksize
, 
dx_hash_šfo
 *
hšfo
,

278 
dx_m­_’Œy
 
m­
[]);

279 
dx_sÜt_m­
(
dx_m­_’Œy
 *
m­
, 
couÁ
);

280 
ext4_dœ_’Œy_2
 *
dx_move_dœ’ts
(*
äom
, *
to
,

281 
dx_m­_’Œy
 *
off£ts
, 
couÁ
, 
blocksize
);

282 
ext4_dœ_’Œy_2
* 
dx_·ck_dœ’ts
(*
ba£
, 
blocksize
);

283 
dx_š£¹_block
(
dx_äame
 *
äame
,

284 
u32
 
hash
, 
ext4_lblk_t
 
block
);

285 
ext4_hŒ“_Ãxt_block
(
šode
 *
dœ
, 
__u32
 
hash
,

286 
dx_äame
 *
äame
,

287 
dx_äame
 *
äames
,

288 
__u32
 *
¡¬t_hash
);

289 
bufãr_h—d
 * 
ext4_dx_fšd_’Œy
(
šode
 *
dœ
,

290 
ext4_f’ame
 *
âame
,

291 
ext4_dœ_’Œy_2
 **
»s_dœ
);

292 
ext4_dx_add_’Œy
(
hªdË_t
 *
hªdË
, 
ext4_f’ame
 *
âame
,

293 
šode
 *
dœ
, inode *inode);

296 
	$ext4_š™Ÿlize_dœ’t_
(
bufãr_h—d
 *
bh
,

297 
blocksize
)

299 
ext4_dœ_’Œy_
 *
t
 = 
	`EXT4_DIRENT_TAIL
(
bh
->
b_d©a
, 
blocksize
);

301 
	`mem£t
(
t
, 0, (
ext4_dœ_’Œy_
));

302 
t
->
d‘_»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(

303 (
ext4_dœ_’Œy_
), 
blocksize
);

304 
t
->
d‘_»£rved_á
 = 
EXT4_FT_DIR_CSUM
;

305 
	}
}

308 
ext4_dœ_’Œy_
 *
	$g‘_dœ’t_
(
šode
 *inode,

309 
bufãr_h—d
 *
bh
)

311 
ext4_dœ_’Œy_
 *
t
;

313 #ifdeà
PARANOID


314 
ext4_dœ_’Œy
 *
d
, *
tİ
;

316 
d
 = (
ext4_dœ_’Œy
 *)
bh
->
b_d©a
;

317 
tİ
 = (
ext4_dœ_’Œy
 *)(
bh
->
b_d©a
 +

318 (
	`EXT4_BLOCK_SIZE
(
šode
->
i_sb
) -

319 (
ext4_dœ_’Œy_
)));

320 
d
 < 
tİ
 && d->
»c_Ën
)

321 
d
 = (
ext4_dœ_’Œy
 *)(((*)d) +

322 
	`Ë16_to_ıu
(
d
->
»c_Ën
));

324 ià(
d
 !ğ
tİ
)

325  
NULL
;

327 
t
 = (
ext4_dœ_’Œy_
 *)
d
;

329 
t
 = 
	`EXT4_DIRENT_TAIL
(
bh
->
b_d©a
, 
	`EXT4_BLOCK_SIZE
(
šode
->
i_sb
));

332 ià(
t
->
d‘_»£rved_z”o1
 ||

333 
	`Ë16_to_ıu
(
t
->
d‘_»c_Ën
è!ğ(
ext4_dœ_’Œy_
) ||

334 
t
->
d‘_»£rved_z”o2
 ||

335 
t
->
d‘_»£rved_á
 !ğ
EXT4_FT_DIR_CSUM
)

336  
NULL
;

338  
t
;

339 
	}
}

341 
__Ë32
 
	$ext4_dœblock_csum
(
šode
 *šode, *
dœ’t
, 
size
)

343 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

344 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

345 
__u32
 
csum
;

347 
csum
 = 
	`ext4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
dœ’t
, 
size
);

348  
	`ıu_to_Ë32
(
csum
);

349 
	}
}

351 
	#w¬n_no_¥aû_fÜ_csum
(
šode
) \

352 
	`__w¬n_no_¥aû_fÜ_csum
((
šode
), 
__func__
, 
__LINE__
)

	)

354 
	$__w¬n_no_¥aû_fÜ_csum
(
šode
 *šode, cÚ¡ *
func
,

355 
lše
)

357 
	`__ext4_w¬nšg_šode
(
šode
, 
func
, 
lše
,

359 
	}
}

361 
	$ext4_dœblock_csum_v”ify
(
šode
 *šode, 
bufãr_h—d
 *
bh
)

363 
ext4_dœ_’Œy_
 *
t
;

365 ià(!
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

368 
t
 = 
	`g‘_dœ’t_
(
šode
, 
bh
);

369 ià(!
t
) {

370 
	`w¬n_no_¥aû_fÜ_csum
(
šode
);

374 ià(
t
->
d‘_checksum
 !ğ
	`ext4_dœblock_csum
(
šode
, 
bh
->
b_d©a
,

375 (*)
t
 - 
bh
->
b_d©a
))

379 
	}
}

381 
	$ext4_dœblock_csum_£t
(
šode
 *inode,

382 
bufãr_h—d
 *
bh
)

384 
ext4_dœ_’Œy_
 *
t
;

386 ià(!
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

389 
t
 = 
	`g‘_dœ’t_
(
šode
, 
bh
);

390 ià(!
t
) {

391 
	`w¬n_no_¥aû_fÜ_csum
(
šode
);

395 
t
->
d‘_checksum
 = 
	`ext4_dœblock_csum
(
šode
, 
bh
->
b_d©a
,

396 (*)
t
 - 
bh
->
b_d©a
);

397 
	}
}

399 
	$ext4_hªdË_dœty_dœblock
(
hªdË_t
 *
hªdË
,

400 
šode
 *inode,

401 
bufãr_h—d
 *
bh
)

403 
	`ext4_dœblock_csum_£t
(
šode
, 
bh
);

404  
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

405 
	}
}

407 
dx_couÁlim™
 *
	$g‘_dx_couÁlim™
(
šode
 *inode,

408 
ext4_dœ_’Œy
 *
dœ’t
,

409 *
off£t
)

411 
ext4_dœ_’Œy
 *
dp
;

412 
dx_roÙ_šfo
 *
roÙ
;

413 
couÁ_off£t
;

415 ià(
	`Ë16_to_ıu
(
dœ’t
->
»c_Ën
è=ğ
	`EXT4_BLOCK_SIZE
(
šode
->
i_sb
))

416 
couÁ_off£t
 = 8;

417 ià(
	`Ë16_to_ıu
(
dœ’t
->
»c_Ën
) == 12) {

418 
dp
 = (
ext4_dœ_’Œy
 *)(((*)
dœ’t
) + 12);

419 ià(
	`Ë16_to_ıu
(
dp
->
»c_Ën
) !=

420 
	`EXT4_BLOCK_SIZE
(
šode
->
i_sb
) - 12)

421  
NULL
;

422 
roÙ
 = (
dx_roÙ_šfo
 *)(((*)
dp
 + 12));

423 ià(
roÙ
->
»£rved_z”o
 ||

424 
roÙ
->
šfo_Ëngth
 !ğ(
dx_roÙ_šfo
))

425  
NULL
;

426 
couÁ_off£t
 = 32;

428  
NULL
;

430 ià(
off£t
)

431 *
off£t
 = 
couÁ_off£t
;

432  (
dx_couÁlim™
 *)(((*)
dœ’t
è+ 
couÁ_off£t
);

433 
	}
}

435 
__Ë32
 
	$ext4_dx_csum
(
šode
 *šode, 
ext4_dœ_’Œy
 *
dœ’t
,

436 
couÁ_off£t
, 
couÁ
, 
dx_
 *
t
)

438 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

439 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

440 
__u32
 
csum
;

441 
size
;

442 
__u32
 
dummy_csum
 = 0;

443 
off£t
 = 
	`off£tof
(
dx_
, 
dt_checksum
);

445 
size
 = 
couÁ_off£t
 + (
couÁ
 * (
dx_’Œy
));

446 
csum
 = 
	`ext4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
dœ’t
, 
size
);

447 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)
t
, 
off£t
);

448 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, (dummy_csum));

450  
	`ıu_to_Ë32
(
csum
);

451 
	}
}

453 
	$ext4_dx_csum_v”ify
(
šode
 *inode,

454 
ext4_dœ_’Œy
 *
dœ’t
)

456 
dx_couÁlim™
 *
c
;

457 
dx_
 *
t
;

458 
couÁ_off£t
, 
lim™
, 
couÁ
;

460 ià(!
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

463 
c
 = 
	`g‘_dx_couÁlim™
(
šode
, 
dœ’t
, &
couÁ_off£t
);

464 ià(!
c
) {

465 
	`EXT4_ERROR_INODE
(
šode
, "dir seems corrupt? Runƒ2fsck -D.");

468 
lim™
 = 
	`Ë16_to_ıu
(
c
->limit);

469 
couÁ
 = 
	`Ë16_to_ıu
(
c
->count);

470 ià(
couÁ_off£t
 + (
lim™
 * (
dx_’Œy
)) >

471 
	`EXT4_BLOCK_SIZE
(
šode
->
i_sb
è- (
dx_
)) {

472 
	`w¬n_no_¥aû_fÜ_csum
(
šode
);

475 
t
 = (
dx_
 *)(((
dx_’Œy
 *)
c
è+ 
lim™
);

477 ià(
t
->
dt_checksum
 !ğ
	`ext4_dx_csum
(
šode
, 
dœ’t
, 
couÁ_off£t
,

478 
couÁ
, 
t
))

481 
	}
}

483 
	$ext4_dx_csum_£t
(
šode
 *šode, 
ext4_dœ_’Œy
 *
dœ’t
)

485 
dx_couÁlim™
 *
c
;

486 
dx_
 *
t
;

487 
couÁ_off£t
, 
lim™
, 
couÁ
;

489 ià(!
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

492 
c
 = 
	`g‘_dx_couÁlim™
(
šode
, 
dœ’t
, &
couÁ_off£t
);

493 ià(!
c
) {

494 
	`EXT4_ERROR_INODE
(
šode
, "dir seems corrupt? Runƒ2fsck -D.");

497 
lim™
 = 
	`Ë16_to_ıu
(
c
->limit);

498 
couÁ
 = 
	`Ë16_to_ıu
(
c
->count);

499 ià(
couÁ_off£t
 + (
lim™
 * (
dx_’Œy
)) >

500 
	`EXT4_BLOCK_SIZE
(
šode
->
i_sb
è- (
dx_
)) {

501 
	`w¬n_no_¥aû_fÜ_csum
(
šode
);

504 
t
 = (
dx_
 *)(((
dx_’Œy
 *)
c
è+ 
lim™
);

506 
t
->
dt_checksum
 = 
	`ext4_dx_csum
(
šode
, 
dœ’t
, 
couÁ_off£t
, 
couÁ
,);

507 
	}
}

509 
šlše
 
	$ext4_hªdË_dœty_dx_node
(
hªdË_t
 *
hªdË
,

510 
šode
 *inode,

511 
bufãr_h—d
 *
bh
)

513 
	`ext4_dx_csum_£t
(
šode
, (
ext4_dœ_’Œy
 *)
bh
->
b_d©a
);

514  
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

515 
	}
}

520 
šlše
 
ext4_dœ_’Œy_2
 *

521 
	$ext4_Ãxt_’Œy
(
ext4_dœ_’Œy_2
 *
p
, 
blocksize
)

523  (
ext4_dœ_’Œy_2
 *)((*)
p
 +

524 
	`ext4_»c_Ën_äom_disk
(
p
->
»c_Ën
, 
blocksize
));

525 
	}
}

532 
šlše
 
ext4_lblk_t
 
	$dx_g‘_block
(
dx_’Œy
 *
’Œy
)

534  
	`Ë32_to_ıu
(
’Œy
->
block
) & 0x0fffffff;

535 
	}
}

537 
šlše
 
	$dx_£t_block
(
dx_’Œy
 *
’Œy
, 
ext4_lblk_t
 
v®ue
)

539 
’Œy
->
block
 = 
	`ıu_to_Ë32
(
v®ue
);

540 
	}
}

542 
šlše
 
	$dx_g‘_hash
(
dx_’Œy
 *
’Œy
)

544  
	`Ë32_to_ıu
(
’Œy
->
hash
);

545 
	}
}

547 
šlše
 
	$dx_£t_hash
(
dx_’Œy
 *
’Œy
, 
v®ue
)

549 
’Œy
->
hash
 = 
	`ıu_to_Ë32
(
v®ue
);

550 
	}
}

552 
šlše
 
	$dx_g‘_couÁ
(
dx_’Œy
 *
’Œ›s
)

554  
	`Ë16_to_ıu
(((
dx_couÁlim™
 *è
’Œ›s
)->
couÁ
);

555 
	}
}

557 
šlše
 
	$dx_g‘_lim™
(
dx_’Œy
 *
’Œ›s
)

559  
	`Ë16_to_ıu
(((
dx_couÁlim™
 *è
’Œ›s
)->
lim™
);

560 
	}
}

562 
šlše
 
	$dx_£t_couÁ
(
dx_’Œy
 *
’Œ›s
, 
v®ue
)

564 ((
dx_couÁlim™
 *è
’Œ›s
)->
couÁ
 = 
	`ıu_to_Ë16
(
v®ue
);

565 
	}
}

567 
šlše
 
	$dx_£t_lim™
(
dx_’Œy
 *
’Œ›s
, 
v®ue
)

569 ((
dx_couÁlim™
 *è
’Œ›s
)->
lim™
 = 
	`ıu_to_Ë16
(
v®ue
);

570 
	}
}

572 
šlše
 
	$dx_roÙ_lim™
(
šode
 *
dœ
, 
šfosize
)

574 
’Œy_¥aû
 = 
dœ
->
i_sb
->
s_blocksize
 - 
	`EXT4_DIR_REC_LEN
(1) -

575 
	`EXT4_DIR_REC_LEN
(2è- 
šfosize
;

577 ià(
	`ext4_has_m‘ad©a_csum
(
dœ
->
i_sb
))

578 
’Œy_¥aû
 -ğ(
dx_
);

579  
’Œy_¥aû
 / (
dx_’Œy
);

580 
	}
}

582 
šlše
 
	$dx_node_lim™
(
šode
 *
dœ
)

584 
’Œy_¥aû
 = 
dœ
->
i_sb
->
s_blocksize
 - 
	`EXT4_DIR_REC_LEN
(0);

586 ià(
	`ext4_has_m‘ad©a_csum
(
dœ
->
i_sb
))

587 
’Œy_¥aû
 -ğ(
dx_
);

588  
’Œy_¥aû
 / (
dx_’Œy
);

589 
	}
}

594 #ifdeà
DX_DEBUG


595 
	$dx_show_šdex
(* 
Ïb–
, 
dx_’Œy
 *
’Œ›s
)

597 
i
, 
n
 = 
	`dx_g‘_couÁ
 (
’Œ›s
);

598 
	`´štk
(
KERN_DEBUG
 "% šdex", 
Ïb–
);

599 
i
 = 0; i < 
n
; i++) {

600 
	`´štk
(
KERN_CONT
 " %x->%lu",

601 
i
 ? 
	`dx_g‘_hash
(
’Œ›s
 + i) : 0,

602 ()
	`dx_g‘_block
(
’Œ›s
 + 
i
));

604 
	`´štk
(
KERN_CONT
 "\n");

605 
	}
}

607 
	s¡©s


609 
	mÇmes
;

610 
	m¥aû
;

611 
	mbcouÁ
;

614 
¡©s
 
	$dx_show_Ëaf
(
šode
 *
dœ
,

615 
dx_hash_šfo
 *
hšfo
,

616 
ext4_dœ_’Œy_2
 *
de
,

617 
size
, 
show_Çmes
)

619 
Çmes
 = 0, 
¥aû
 = 0;

620 *
ba£
 = (*è
de
;

621 
dx_hash_šfo
 
h
 = *
hšfo
;

623 
	`´štk
("names: ");

624 (*è
de
 < 
ba£
 + 
size
)

626 ià(
de
->
šode
)

628 ià(
show_Çmes
)

630 #ifdeà
CONFIG_FS_ENCRYPTION


631 
Ën
;

632 *
Çme
;

633 
fsüy±_¡r
 
âame_üy±o_¡r
 =

634 
	`FSTR_INIT
(
NULL
, 0);

635 
»s
 = 0;

637 
Çme
 = 
de
->name;

638 
Ën
 = 
de
->
Çme_Ën
;

639 ià(
	`IS_ENCRYPTED
(
dœ
))

640 
»s
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
dœ
);

641 ià(
»s
) {

642 
	`´štk
(
KERN_WARNING
 "Error setting up"

643 " fÇmüy±o: %d\n", 
»s
);

645 ià(!
	`fsüy±_has_’üy±iÚ_key
(
dœ
)) {

647 
	`ext4fs_dœhash
(
dœ
, 
de
->
Çme
,

648 
de
->
Çme_Ën
, &
h
);

649 
	`´štk
("%*.s:(U)%x.%u ", 
Ën
,

650 
Çme
, 
h
.
hash
,

651 (è((*è
de


652 - 
ba£
));

654 
fsüy±_¡r
 
de_Çme
 =

655 
	`FSTR_INIT
(
Çme
, 
Ën
);

658 
»s
 = 
	`fsüy±_âame_®loc_bufãr
(

659 
dœ
, 
Ën
,

660 &
âame_üy±o_¡r
);

661 ià(
»s
)

662 
	`´štk
(
KERN_WARNING
 "Error "

666 
»s
 = 
	`fsüy±_âame_disk_to_u¤
(
dœ
,

667 0, 0, &
de_Çme
,

668 &
âame_üy±o_¡r
);

669 ià(
»s
) {

670 
	`´štk
(
KERN_WARNING
 "Error "

674 
Çme
 = "??";

675 
Ën
 = 2;

677 
Çme
 = 
âame_üy±o_¡r
.name;

678 
Ën
 = 
âame_üy±o_¡r
.len;

680 
	`ext4fs_dœhash
(
dœ
, 
de
->
Çme
,

681 
de
->
Çme_Ën
, &
h
);

682 
	`´štk
("%*.s:(E)%x.%u ", 
Ën
, 
Çme
,

683 
h
.
hash
, (è((*è
de


684 - 
ba£
));

685 
	`fsüy±_âame_ä“_bufãr
(

686 &
âame_üy±o_¡r
);

689 
Ën
 = 
de
->
Çme_Ën
;

690 *
Çme
 = 
de
->name;

691 
	`ext4fs_dœhash
(
dœ
, 
de
->
Çme
, de->
Çme_Ën
, &
h
);

692 
	`´štk
("%*.s:%x.%u ", 
Ën
, 
Çme
, 
h
.
hash
,

693 (è((*è
de
 - 
ba£
));

696 
¥aû
 +ğ
	`EXT4_DIR_REC_LEN
(
de
->
Çme_Ën
);

697 
Çmes
++;

699 
de
 = 
	`ext4_Ãxt_’Œy
(de, 
size
);

701 
	`´štk
(
KERN_CONT
 "(%i)\n", 
Çmes
);

702  (
¡©s
è{ 
Çmes
, 
¥aû
, 1 };

703 
	}
}

705 
¡©s
 
	$dx_show_’Œ›s
(
dx_hash_šfo
 *
hšfo
, 
šode
 *
dœ
,

706 
dx_’Œy
 *
’Œ›s
, 
Ëv–s
)

708 
blocksize
 = 
dœ
->
i_sb
->
s_blocksize
;

709 
couÁ
 = 
	`dx_g‘_couÁ
(
’Œ›s
), 
Çmes
 = 0, 
¥aû
 = 0, 
i
;

710 
bcouÁ
 = 0;

711 
bufãr_h—d
 *
bh
;

712 
	`´štk
("%˜šdexed blocks...\n", 
couÁ
);

713 
i
 = 0; i < 
couÁ
; i++, 
’Œ›s
++)

715 
ext4_lblk_t
 
block
 = 
	`dx_g‘_block
(
’Œ›s
);

716 
ext4_lblk_t
 
hash
 = 
i
 ? 
	`dx_g‘_hash
(
’Œ›s
): 0;

717 
u32
 
¿nge
 = 
i
 < 
couÁ
 - 1? (
	`dx_g‘_hash
(
’Œ›s
 + 1è- 
hash
): ~hash;

718 
¡©s
 stats;

719 
	`´štk
("%s%3u:%03u hash %8x/%8x ",
Ëv–s
?"":" ", 
i
, 
block
, 
hash
, 
¿nge
);

720 
bh
 = 
	`ext4_b»ad
(
NULL
,
dœ
, 
block
, 0);

721 ià(!
bh
 || 
	`IS_ERR
(bh))

723 
¡©s
 = 
Ëv–s
?

724 
	`dx_show_’Œ›s
(
hšfo
, 
dœ
, ((
dx_node
 *è
bh
->
b_d©a
)->
’Œ›s
, 
Ëv–s
 - 1):

725 
	`dx_show_Ëaf
(
dœ
, 
hšfo
, (
ext4_dœ_’Œy_2
 *)

726 
bh
->
b_d©a
, 
blocksize
, 0);

727 
Çmes
 +ğ
¡©s
.names;

728 
¥aû
 +ğ
¡©s
.space;

729 
bcouÁ
 +ğ
¡©s
.bcount;

730 
	`b»l£
(
bh
);

732 ià(
bcouÁ
)

733 
	`´štk
(
KERN_DEBUG
 "%snames %u, fullness %u (%u%%)\n",

734 
Ëv–s
 ? "" : " ", 
Çmes
, 
¥aû
/
bcouÁ
,

735 (
¥aû
/
bcouÁ
)*100/
blocksize
);

736  (
¡©s
è{ 
Çmes
, 
¥aû
, 
bcouÁ
};

737 
	}
}

749 
dx_äame
 *

750 
	$dx_´obe
(
ext4_f’ame
 *
âame
, 
šode
 *
dœ
,

751 
dx_hash_šfo
 *
hšfo
, 
dx_äame
 *
äame_š
)

753 
couÁ
, 
šdœeù
;

754 
dx_’Œy
 *
©
, *
’Œ›s
, *
p
, *
q
, *
m
;

755 
dx_roÙ
 *
roÙ
;

756 
dx_äame
 *
äame
 = 
äame_š
;

757 
dx_äame
 *
»t_”r
 = 
	`ERR_PTR
(
ERR_BAD_DX_DIR
);

758 
u32
 
hash
;

760 
	`mem£t
(
äame_š
, 0, 
EXT4_HTREE_LEVEL
 * (frame_in[0]));

761 
äame
->
bh
 = 
	`ext4_»ad_dœblock
(
dœ
, 0, 
INDEX
);

762 ià(
	`IS_ERR
(
äame
->
bh
))

763  (
dx_äame
 *è
äame
->
bh
;

765 
roÙ
 = (
dx_roÙ
 *è
äame
->
bh
->
b_d©a
;

766 ià(
roÙ
->
šfo
.
hash_v”siÚ
 !ğ
DX_HASH_TEA
 &&

767 
roÙ
->
šfo
.
hash_v”siÚ
 !ğ
DX_HASH_HALF_MD4
 &&

768 
roÙ
->
šfo
.
hash_v”siÚ
 !ğ
DX_HASH_LEGACY
) {

769 
	`ext4_w¬nšg_šode
(
dœ
, "Unrecognised inode hash code %u",

770 
roÙ
->
šfo
.
hash_v”siÚ
);

771 
ç
;

773 ià(
âame
)

774 
hšfo
 = &
âame
->hinfo;

775 
hšfo
->
hash_v”siÚ
 = 
roÙ
->
šfo
.hash_version;

776 ià(
hšfo
->
hash_v”siÚ
 <ğ
DX_HASH_TEA
)

777 
hšfo
->
hash_v”siÚ
 +ğ
	`EXT4_SB
(
dœ
->
i_sb
)->
s_hash_unsigÃd
;

778 
hšfo
->
£ed
 = 
	`EXT4_SB
(
dœ
->
i_sb
)->
s_hash_£ed
;

779 ià(
âame
 && 
	`âame_Çme
(fname))

780 
	`ext4fs_dœhash
(
dœ
, 
	`âame_Çme
(
âame
), 
	`âame_Ën
(âame), 
hšfo
);

781 
hash
 = 
hšfo
->hash;

783 ià(
roÙ
->
šfo
.
unu£d_æags
 & 1) {

784 
	`ext4_w¬nšg_šode
(
dœ
, "Unimplemented hash flags: %#06x",

785 
roÙ
->
šfo
.
unu£d_æags
);

786 
ç
;

789 
šdœeù
 = 
roÙ
->
šfo
.
šdœeù_Ëv–s
;

790 ià(
šdœeù
 >ğ
	`ext4_dœ_hŒ“_Ëv–
(
dœ
->
i_sb
)) {

791 
	`ext4_w¬nšg
(
dœ
->
i_sb
,

793 "suµÜ‹d v®ue", 
dœ
->
i_šo
,

794 
	`ext4_dœ_hŒ“_Ëv–
(
dœ
->
i_sb
));

795 ià(
	`ext4_dœ_hŒ“_Ëv–
(
dœ
->
i_sb
è< 
EXT4_HTREE_LEVEL
) {

796 
	`ext4_w¬nšg
(
dœ
->
i_sb
, "Enable†arge directory "

799 
ç
;

802 
’Œ›s
 = (
dx_’Œy
 *)(((*)&
roÙ
->
šfo
) +

803 
roÙ
->
šfo
.
šfo_Ëngth
);

805 ià(
	`dx_g‘_lim™
(
’Œ›s
è!ğ
	`dx_roÙ_lim™
(
dœ
,

806 
roÙ
->
šfo
.
šfo_Ëngth
)) {

807 
	`ext4_w¬nšg_šode
(
dœ
, "dxƒntry:†imit %u !=„oot†imit %u",

808 
	`dx_g‘_lim™
(
’Œ›s
),

809 
	`dx_roÙ_lim™
(
dœ
, 
roÙ
->
šfo
.
šfo_Ëngth
));

810 
ç
;

813 
	`dxŒaû
(
	`´štk
("Look u°%x", 
hash
));

815 
couÁ
 = 
	`dx_g‘_couÁ
(
’Œ›s
);

816 ià(!
couÁ
 || couÁ > 
	`dx_g‘_lim™
(
’Œ›s
)) {

817 
	`ext4_w¬nšg_šode
(
dœ
,

819 
couÁ
, 
	`dx_g‘_lim™
(
’Œ›s
));

820 
ç
;

823 
p
 = 
’Œ›s
 + 1;

824 
q
 = 
’Œ›s
 + 
couÁ
 - 1;

825 
p
 <ğ
q
) {

826 
m
 = 
p
 + (
q
 -…) / 2;

827 
	`dxŒaû
(
	`´štk
(
KERN_CONT
 "."));

828 ià(
	`dx_g‘_hash
(
m
è> 
hash
)

829 
q
 = 
m
 - 1;

831 
p
 = 
m
 + 1;

835 
n
 = 
couÁ
 - 1;

836 
©
 = 
’Œ›s
;

837 
n
--)

839 
	`dxŒaû
(
	`´štk
(
KERN_CONT
 ","));

840 ià(
	`dx_g‘_hash
(++
©
è> 
hash
)

842 
©
--;

846 
	`as£¹
 (
©
 =ğ
p
 - 1);

849 
©
 = 
p
 - 1;

850 
	`dxŒaû
(
	`´štk
(
KERN_CONT
 " %x->%u\n",

851 
©
 =ğ
’Œ›s
 ? 0 : 
	`dx_g‘_hash
(at),

852 
	`dx_g‘_block
(
©
)));

853 
äame
->
’Œ›s
 =ƒntries;

854 
äame
->
©
 =‡t;

855 ià(!
šdœeù
--)

856  
äame
;

857 
äame
++;

858 
äame
->
bh
 = 
	`ext4_»ad_dœblock
(
dœ
, 
	`dx_g‘_block
(
©
), 
INDEX
);

859 ià(
	`IS_ERR
(
äame
->
bh
)) {

860 
»t_”r
 = (
dx_äame
 *è
äame
->
bh
;

861 
äame
->
bh
 = 
NULL
;

862 
ç
;

864 
’Œ›s
 = ((
dx_node
 *è
äame
->
bh
->
b_d©a
)->entries;

866 ià(
	`dx_g‘_lim™
(
’Œ›s
è!ğ
	`dx_node_lim™
(
dœ
)) {

867 
	`ext4_w¬nšg_šode
(
dœ
,

869 
	`dx_g‘_lim™
(
’Œ›s
), 
	`dx_node_lim™
(
dœ
));

870 
ç
;

873 
ç
:

874 
äame
 >ğ
äame_š
) {

875 
	`b»l£
(
äame
->
bh
);

876 
äame
--;

879 ià(
»t_”r
 =ğ
	`ERR_PTR
(
ERR_BAD_DX_DIR
))

880 
	`ext4_w¬nšg_šode
(
dœ
,

882  
»t_”r
;

883 
	}
}

885 
	$dx_»Ëa£
(
dx_äame
 *
äames
)

887 
dx_roÙ_šfo
 *
šfo
;

888 
i
;

889 
šdœeù_Ëv–s
;

891 ià(
äames
[0].
bh
 =ğ
NULL
)

894 
šfo
 = &((
dx_roÙ
 *)
äames
[0].
bh
->
b_d©a
)->info;

896 
šdœeù_Ëv–s
 = 
šfo
->indirect_levels;

897 
i
 = 0; i <ğ
šdœeù_Ëv–s
; i++) {

898 ià(
äames
[
i
].
bh
 =ğ
NULL
)

900 
	`b»l£
(
äames
[
i
].
bh
);

901 
äames
[
i
].
bh
 = 
NULL
;

903 
	}
}

922 
	$ext4_hŒ“_Ãxt_block
(
šode
 *
dœ
, 
__u32
 
hash
,

923 
dx_äame
 *
äame
,

924 
dx_äame
 *
äames
,

925 
__u32
 *
¡¬t_hash
)

927 
dx_äame
 *
p
;

928 
bufãr_h—d
 *
bh
;

929 
num_äames
 = 0;

930 
__u32
 
bhash
;

932 
p
 = 
äame
;

941 ià(++(
p
->
©
è<…->
’Œ›s
 + 
	`dx_g‘_couÁ
(p->entries))

943 ià(
p
 =ğ
äames
)

945 
num_äames
++;

946 
p
--;

956 
bhash
 = 
	`dx_g‘_hash
(
p
->
©
);

957 ià(
¡¬t_hash
)

958 *
¡¬t_hash
 = 
bhash
;

959 ià((
hash
 & 1) == 0) {

960 ià((
bhash
 & ~1è!ğ
hash
)

967 
num_äames
--) {

968 
bh
 = 
	`ext4_»ad_dœblock
(
dœ
, 
	`dx_g‘_block
(
p
->
©
), 
INDEX
);

969 ià(
	`IS_ERR
(
bh
))

970  
	`PTR_ERR
(
bh
);

971 
p
++;

972 
	`b»l£
(
p
->
bh
);

973 
p
->
bh
 = bh;

974 
p
->
©
 =…->
’Œ›s
 = ((
dx_node
 *è
bh
->
b_d©a
)->entries;

977 
	}
}

985 
	$hŒ“_dœblock_to_Œ“
(
fe
 *
dœ_fe
,

986 
šode
 *
dœ
, 
ext4_lblk_t
 
block
,

987 
dx_hash_šfo
 *
hšfo
,

988 
__u32
 
¡¬t_hash
, __u32 
¡¬t_mšÜ_hash
)

990 
bufãr_h—d
 *
bh
;

991 
ext4_dœ_’Œy_2
 *
de
, *
tİ
;

992 
”r
 = 0, 
couÁ
 = 0;

993 
fsüy±_¡r
 
âame_üy±o_¡r
 = 
	`FSTR_INIT
(
NULL
, 0), 
tmp_¡r
;

995 
	`dxŒaû
(
	`´štk
(
KERN_INFO
 "In htree dirblock_to_tree: block %lu\n",

996 ()
block
));

997 
bh
 = 
	`ext4_»ad_dœblock
(
dœ
, 
block
, 
DIRENT_HTREE
);

998 ià(
	`IS_ERR
(
bh
))

999  
	`PTR_ERR
(
bh
);

1001 
de
 = (
ext4_dœ_’Œy_2
 *è
bh
->
b_d©a
;

1002 
tİ
 = (
ext4_dœ_’Œy_2
 *è((*è
de
 +

1003 
dœ
->
i_sb
->
s_blocksize
 -

1004 
	`EXT4_DIR_REC_LEN
(0));

1005 #ifdeà
CONFIG_FS_ENCRYPTION


1007 ià(
	`IS_ENCRYPTED
(
dœ
)) {

1008 
”r
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
dœ
);

1009 ià(
”r
 < 0) {

1010 
	`b»l£
(
bh
);

1011  
”r
;

1013 
”r
 = 
	`fsüy±_âame_®loc_bufãr
(
dœ
, 
EXT4_NAME_LEN
,

1014 &
âame_üy±o_¡r
);

1015 ià(
”r
 < 0) {

1016 
	`b»l£
(
bh
);

1017  
”r
;

1021 ; 
de
 < 
tİ
; dğ
	`ext4_Ãxt_’Œy
(de, 
dœ
->
i_sb
->
s_blocksize
)) {

1022 ià(
	`ext4_check_dœ_’Œy
(
dœ
, 
NULL
, 
de
, 
bh
,

1023 
bh
->
b_d©a
, bh->
b_size
,

1024 (
block
<<
	`EXT4_BLOCK_SIZE_BITS
(
dœ
->
i_sb
))

1025 + ((*)
de
 - 
bh
->
b_d©a
))) {

1029 
	`ext4fs_dœhash
(
dœ
, 
de
->
Çme
, de->
Çme_Ën
, 
hšfo
);

1030 ià((
hšfo
->
hash
 < 
¡¬t_hash
) ||

1031 ((
hšfo
->
hash
 =ğ
¡¬t_hash
) &&

1032 (
hšfo
->
mšÜ_hash
 < 
¡¬t_mšÜ_hash
)))

1034 ià(
de
->
šode
 == 0)

1036 ià(!
	`IS_ENCRYPTED
(
dœ
)) {

1037 
tmp_¡r
.
Çme
 = 
de
->name;

1038 
tmp_¡r
.
Ën
 = 
de
->
Çme_Ën
;

1039 
”r
 = 
	`ext4_hŒ“_¡Üe_dœ’t
(
dœ_fe
,

1040 
hšfo
->
hash
, hšfo->
mšÜ_hash
, 
de
,

1041 &
tmp_¡r
);

1043 
§ve_Ën
 = 
âame_üy±o_¡r
.
Ën
;

1044 
fsüy±_¡r
 
de_Çme
 = 
	`FSTR_INIT
(
de
->
Çme
,

1045 
de
->
Çme_Ën
);

1048 
”r
 = 
	`fsüy±_âame_disk_to_u¤
(
dœ
, 
hšfo
->
hash
,

1049 
hšfo
->
mšÜ_hash
, &
de_Çme
,

1050 &
âame_üy±o_¡r
);

1051 ià(
”r
) {

1052 
couÁ
 = 
”r
;

1053 
”rout
;

1055 
”r
 = 
	`ext4_hŒ“_¡Üe_dœ’t
(
dœ_fe
,

1056 
hšfo
->
hash
, hšfo->
mšÜ_hash
, 
de
,

1057 &
âame_üy±o_¡r
);

1058 
âame_üy±o_¡r
.
Ën
 = 
§ve_Ën
;

1060 ià(
”r
 != 0) {

1061 
couÁ
 = 
”r
;

1062 
”rout
;

1064 
couÁ
++;

1066 
”rout
:

1067 
	`b»l£
(
bh
);

1068 #ifdeà
CONFIG_FS_ENCRYPTION


1069 
	`fsüy±_âame_ä“_bufãr
(&
âame_üy±o_¡r
);

1071  
couÁ
;

1072 
	}
}

1083 
	$ext4_hŒ“_fl_Œ“
(
fe
 *
dœ_fe
, 
__u32
 
¡¬t_hash
,

1084 
__u32
 
¡¬t_mšÜ_hash
, __u32 *
Ãxt_hash
)

1086 
dx_hash_šfo
 
hšfo
;

1087 
ext4_dœ_’Œy_2
 *
de
;

1088 
dx_äame
 
äames
[
EXT4_HTREE_LEVEL
], *
äame
;

1089 
šode
 *
dœ
;

1090 
ext4_lblk_t
 
block
;

1091 
couÁ
 = 0;

1092 
»t
, 
”r
;

1093 
__u32
 
hashv®
;

1094 
fsüy±_¡r
 
tmp_¡r
;

1096 
	`dxŒaû
(
	`´štk
(
KERN_DEBUG
 "In htree_fill_tree, start hash: %x:%x\n",

1097 
¡¬t_hash
, 
¡¬t_mšÜ_hash
));

1098 
dœ
 = 
	`fe_šode
(
dœ_fe
);

1099 ià(!(
	`ext4_‹¡_šode_æag
(
dœ
, 
EXT4_INODE_INDEX
))) {

1100 
hšfo
.
hash_v”siÚ
 = 
	`EXT4_SB
(
dœ
->
i_sb
)->
s_def_hash_v”siÚ
;

1101 ià(
hšfo
.
hash_v”siÚ
 <ğ
DX_HASH_TEA
)

1102 
hšfo
.
hash_v”siÚ
 +=

1103 
	`EXT4_SB
(
dœ
->
i_sb
)->
s_hash_unsigÃd
;

1104 
hšfo
.
£ed
 = 
	`EXT4_SB
(
dœ
->
i_sb
)->
s_hash_£ed
;

1105 ià(
	`ext4_has_šlše_d©a
(
dœ
)) {

1106 
has_šlše_d©a
 = 1;

1107 
couÁ
 = 
	`ext4_šlšedœ_to_Œ“
(
dœ_fe
, 
dœ
, 0,

1108 &
hšfo
, 
¡¬t_hash
,

1109 
¡¬t_mšÜ_hash
,

1110 &
has_šlše_d©a
);

1111 ià(
has_šlše_d©a
) {

1112 *
Ãxt_hash
 = ~0;

1113  
couÁ
;

1116 
couÁ
 = 
	`hŒ“_dœblock_to_Œ“
(
dœ_fe
, 
dœ
, 0, &
hšfo
,

1117 
¡¬t_hash
, 
¡¬t_mšÜ_hash
);

1118 *
Ãxt_hash
 = ~0;

1119  
couÁ
;

1121 
hšfo
.
hash
 = 
¡¬t_hash
;

1122 
hšfo
.
mšÜ_hash
 = 0;

1123 
äame
 = 
	`dx_´obe
(
NULL
, 
dœ
, &
hšfo
, 
äames
);

1124 ià(
	`IS_ERR
(
äame
))

1125  
	`PTR_ERR
(
äame
);

1128 ià(!
¡¬t_hash
 && !
¡¬t_mšÜ_hash
) {

1129 
de
 = (
ext4_dœ_’Œy_2
 *è
äames
[0].
bh
->
b_d©a
;

1130 
tmp_¡r
.
Çme
 = 
de
->name;

1131 
tmp_¡r
.
Ën
 = 
de
->
Çme_Ën
;

1132 
”r
 = 
	`ext4_hŒ“_¡Üe_dœ’t
(
dœ_fe
, 0, 0,

1133 
de
, &
tmp_¡r
);

1134 ià(
”r
 != 0)

1135 
”rout
;

1136 
couÁ
++;

1138 ià(
¡¬t_hash
 < 2 || (¡¬t_hash ==2 && 
¡¬t_mšÜ_hash
==0)) {

1139 
de
 = (
ext4_dœ_’Œy_2
 *è
äames
[0].
bh
->
b_d©a
;

1140 
de
 = 
	`ext4_Ãxt_’Œy
(de, 
dœ
->
i_sb
->
s_blocksize
);

1141 
tmp_¡r
.
Çme
 = 
de
->name;

1142 
tmp_¡r
.
Ën
 = 
de
->
Çme_Ën
;

1143 
”r
 = 
	`ext4_hŒ“_¡Üe_dœ’t
(
dœ_fe
, 2, 0,

1144 
de
, &
tmp_¡r
);

1145 ià(
”r
 != 0)

1146 
”rout
;

1147 
couÁ
++;

1151 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

1152 
”r
 = -
ERESTARTSYS
;

1153 
”rout
;

1155 
	`cÚd_»sched
();

1156 
block
 = 
	`dx_g‘_block
(
äame
->
©
);

1157 
»t
 = 
	`hŒ“_dœblock_to_Œ“
(
dœ_fe
, 
dœ
, 
block
, &
hšfo
,

1158 
¡¬t_hash
, 
¡¬t_mšÜ_hash
);

1159 ià(
»t
 < 0) {

1160 
”r
 = 
»t
;

1161 
”rout
;

1163 
couÁ
 +ğ
»t
;

1164 
hashv®
 = ~0;

1165 
»t
 = 
	`ext4_hŒ“_Ãxt_block
(
dœ
, 
HASH_NB_ALWAYS
,

1166 
äame
, 
äames
, &
hashv®
);

1167 *
Ãxt_hash
 = 
hashv®
;

1168 ià(
»t
 < 0) {

1169 
”r
 = 
»t
;

1170 
”rout
;

1177 ià((
»t
 == 0) ||

1178 (
couÁ
 && ((
hashv®
 & 1) == 0)))

1181 
	`dx_»Ëa£
(
äames
);

1182 
	`dxŒaû
(
	`´štk
(
KERN_DEBUG
 "Fillree:„eturned %dƒntries, "

1183 "Ãxˆhash: %x\n", 
couÁ
, *
Ãxt_hash
));

1184  
couÁ
;

1185 
”rout
:

1186 
	`dx_»Ëa£
(
äames
);

1187  (
”r
);

1188 
	}
}

1190 
šlše
 
	$£¬ch_dœblock
(
bufãr_h—d
 *
bh
,

1191 
šode
 *
dœ
,

1192 
ext4_f’ame
 *
âame
,

1193 
off£t
,

1194 
ext4_dœ_’Œy_2
 **
»s_dœ
)

1196  
	`ext4_£¬ch_dœ
(
bh
, bh->
b_d©a
, 
dœ
->
i_sb
->
s_blocksize
, dir,

1197 
âame
, 
off£t
, 
»s_dœ
);

1198 
	}
}

1208 
	$dx_make_m­
(
šode
 *
dœ
, 
ext4_dœ_’Œy_2
 *
de
,

1209 
blocksize
, 
dx_hash_šfo
 *
hšfo
,

1210 
dx_m­_’Œy
 *
m­_
)

1212 
couÁ
 = 0;

1213 *
ba£
 = (*è
de
;

1214 
dx_hash_šfo
 
h
 = *
hšfo
;

1216 (*è
de
 < 
ba£
 + 
blocksize
) {

1217 ià(
de
->
Çme_Ën
 && de->
šode
) {

1218 
	`ext4fs_dœhash
(
dœ
, 
de
->
Çme
, de->
Çme_Ën
, &
h
);

1219 
m­_
--;

1220 
m­_
->
hash
 = 
h
.hash;

1221 
m­_
->
offs
 = ((*è
de
 - 
ba£
)>>2;

1222 
m­_
->
size
 = 
	`Ë16_to_ıu
(
de
->
»c_Ën
);

1223 
couÁ
++;

1224 
	`cÚd_»sched
();

1227 
de
 = 
	`ext4_Ãxt_’Œy
(de, 
blocksize
);

1229  
couÁ
;

1230 
	}
}

1233 
	$dx_sÜt_m­
 (
dx_m­_’Œy
 *
m­
, 
couÁ
)

1235 
dx_m­_’Œy
 *
p
, *
q
, *
tİ
 = 
m­
 + 
couÁ
 - 1;

1236 
mÜe
;

1238 
couÁ
 > 2) {

1239 
couÁ
 = count*10/13;

1240 ià(
couÁ
 - 9 < 2)

1241 
couÁ
 = 11;

1242 
p
 = 
tİ
, 
q
 =… - 
couÁ
; q >ğ
m­
;…--, q--)

1243 ià(
p
->
hash
 < 
q
->hash)

1244 
	`sw­
(*
p
, *
q
);

1248 
mÜe
 = 0;

1249 
q
 = 
tİ
;

1250 
q
-- > 
m­
) {

1251 ià(
q
[1].
hash
 >= q[0].hash)

1253 
	`sw­
(*(
q
+1), *q);

1254 
mÜe
 = 1;

1256 } 
mÜe
);

1257 
	}
}

1259 
	$dx_š£¹_block
(
dx_äame
 *
äame
, 
u32
 
hash
, 
ext4_lblk_t
 
block
)

1261 
dx_’Œy
 *
’Œ›s
 = 
äame
->entries;

1262 
dx_’Œy
 *
Şd
 = 
äame
->
©
, *
Ãw
 = old + 1;

1263 
couÁ
 = 
	`dx_g‘_couÁ
(
’Œ›s
);

1265 
	`as£¹
(
couÁ
 < 
	`dx_g‘_lim™
(
’Œ›s
));

1266 
	`as£¹
(
Şd
 < 
’Œ›s
 + 
couÁ
);

1267 
	`memmove
(
Ãw
 + 1,‚ew, (*)(
’Œ›s
 + 
couÁ
) - (*)(new));

1268 
	`dx_£t_hash
(
Ãw
, 
hash
);

1269 
	`dx_£t_block
(
Ãw
, 
block
);

1270 
	`dx_£t_couÁ
(
’Œ›s
, 
couÁ
 + 1);

1271 
	}
}

1273 #ifdeà
CONFIG_UNICODE


1282 
	$ext4_ci_com·»
(cÚ¡ 
šode
 *
·»Á
, cÚ¡ 
q¡r
 *
Çme
,

1283 cÚ¡ 
q¡r
 *
’Œy
, 
boŞ
 
quick
)

1285 cÚ¡ 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
·»Á
->
i_sb
);

1286 cÚ¡ 
unicode_m­
 *
um
 = 
sbi
->
s_’codšg
;

1287 
»t
;

1289 ià(
quick
)

1290 
»t
 = 
	`utf8_¡ºÿ£cmp_fŞded
(
um
, 
Çme
, 
’Œy
);

1292 
»t
 = 
	`utf8_¡ºÿ£cmp
(
um
, 
Çme
, 
’Œy
);

1294 ià(
»t
 < 0) {

1298 ià(
	`ext4_has_¡riù_mode
(
sbi
))

1299  -
EINVAL
;

1301 ià(
Çme
->
Ën
 !ğ
’Œy
->len)

1304  !!
	`memcmp
(
Çme
->Çme, 
’Œy
->Çme,‚ame->
Ën
);

1307  
»t
;

1308 
	}
}

1310 
	$ext4_âame_£tup_ci_f’ame
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *
šame
,

1311 
fsüy±_¡r
 *
cf_Çme
)

1313 
Ën
;

1315 ià(!
	`IS_CASEFOLDED
(
dœ
è|| !
	`EXT4_SB
(dœ->
i_sb
)->
s_’codšg
) {

1316 
cf_Çme
->
Çme
 = 
NULL
;

1320 
cf_Çme
->
Çme
 = 
	`km®loc
(
EXT4_NAME_LEN
, 
GFP_NOFS
);

1321 ià(!
cf_Çme
->
Çme
)

1324 
Ën
 = 
	`utf8_ÿ£fŞd
(
	`EXT4_SB
(
dœ
->
i_sb
)->
s_’codšg
,

1325 
šame
, 
cf_Çme
->
Çme
,

1326 
EXT4_NAME_LEN
);

1327 ià(
Ën
 <= 0) {

1328 
	`kä“
(
cf_Çme
->
Çme
);

1329 
cf_Çme
->
Çme
 = 
NULL
;

1332 
cf_Çme
->
Ën
 = ()†en;

1334 
	}
}

1342 
šlše
 
boŞ
 
	$ext4_m©ch
(cÚ¡ 
šode
 *
·»Á
,

1343 cÚ¡ 
ext4_f’ame
 *
âame
,

1344 cÚ¡ 
ext4_dœ_’Œy_2
 *
de
)

1346 
fsüy±_Çme
 
f
;

1347 #ifdeà
CONFIG_UNICODE


1348 cÚ¡ 
q¡r
 
’Œy
 = {.
Çme
 = 
de
->Çme, .
Ën
 = de->
Çme_Ën
};

1351 ià(!
de
->
šode
)

1352  
çl£
;

1354 
f
.
u¤_âame
 = 
âame
->usr_fname;

1355 
f
.
disk_Çme
 = 
âame
->disk_name;

1356 #ifdeà
CONFIG_FS_ENCRYPTION


1357 
f
.
üy±o_buf
 = 
âame
->crypto_buf;

1360 #ifdeà
CONFIG_UNICODE


1361 ià(
	`EXT4_SB
(
·»Á
->
i_sb
)->
s_’codšg
 && 
	`IS_CASEFOLDED
(parent)) {

1362 ià(
âame
->
cf_Çme
.
Çme
) {

1363 
q¡r
 
cf
 = {.
Çme
 = 
âame
->
cf_Çme
.name,

1364 .
Ën
 = 
âame
->
cf_Çme
.len};

1365  !
	`ext4_ci_com·»
(
·»Á
, &
cf
, &
’Œy
, 
Œue
);

1367  !
	`ext4_ci_com·»
(
·»Á
, 
âame
->
u¤_âame
, &
’Œy
,

1368 
çl£
);

1372  
	`fsüy±_m©ch_Çme
(&
f
, 
de
->
Çme
, de->
Çme_Ën
);

1373 
	}
}

1378 
	$ext4_£¬ch_dœ
(
bufãr_h—d
 *
bh
, *
£¬ch_buf
, 
buf_size
,

1379 
šode
 *
dœ
, 
ext4_f’ame
 *
âame
,

1380 
off£t
, 
ext4_dœ_’Œy_2
 **
»s_dœ
)

1382 
ext4_dœ_’Œy_2
 * 
de
;

1383 * 
dlim™
;

1384 
de_Ën
;

1386 
de
 = (
ext4_dœ_’Œy_2
 *)
£¬ch_buf
;

1387 
dlim™
 = 
£¬ch_buf
 + 
buf_size
;

1388 (*è
de
 < 
dlim™
) {

1391 ià((*è
de
 + de->
Çme_Ën
 <ğ
dlim™
 &&

1392 
	`ext4_m©ch
(
dœ
, 
âame
, 
de
)) {

1395 ià(
	`ext4_check_dœ_’Œy
(
dœ
, 
NULL
, 
de
, 
bh
, bh->
b_d©a
,

1396 
bh
->
b_size
, 
off£t
))

1398 *
»s_dœ
 = 
de
;

1402 
de_Ën
 = 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
,

1403 
dœ
->
i_sb
->
s_blocksize
);

1404 ià(
de_Ën
 <= 0)

1406 
off£t
 +ğ
de_Ën
;

1407 
de
 = (
ext4_dœ_’Œy_2
 *è((*èd+ 
de_Ën
);

1410 
	}
}

1412 
	$is_dx_š‹º®_node
(
šode
 *
dœ
, 
ext4_lblk_t
 
block
,

1413 
ext4_dœ_’Œy
 *
de
)

1415 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

1417 ià(!
	`is_dx
(
dœ
))

1419 ià(
block
 == 0)

1421 ià(
de
->
šode
 == 0 &&

1422 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
sb
->
s_blocksize
) ==

1423 
sb
->
s_blocksize
)

1426 
	}
}

1439 
bufãr_h—d
 *
	$__ext4_fšd_’Œy
(
šode
 *
dœ
,

1440 
ext4_f’ame
 *
âame
,

1441 
ext4_dœ_’Œy_2
 **
»s_dœ
,

1442 *
šlšed
)

1444 
su³r_block
 *
sb
;

1445 
bufãr_h—d
 *
bh_u£
[
NAMEI_RA_SIZE
];

1446 
bufãr_h—d
 *
bh
, *
»t
 = 
NULL
;

1447 
ext4_lblk_t
 
¡¬t
, 
block
;

1448 cÚ¡ 
u8
 *
Çme
 = 
âame
->
u¤_âame
->name;

1449 
size_t
 
¿_max
 = 0;

1451 
size_t
 
¿_±r
 = 0;

1453 
ext4_lblk_t
 
nblocks
;

1454 
i
, 
Çm–’
, 
»tv®
;

1456 *
»s_dœ
 = 
NULL
;

1457 
sb
 = 
dœ
->
i_sb
;

1458 
Çm–’
 = 
âame
->
u¤_âame
->
Ën
;

1459 ià(
Çm–’
 > 
EXT4_NAME_LEN
)

1460  
NULL
;

1462 ià(
	`ext4_has_šlše_d©a
(
dœ
)) {

1463 
has_šlše_d©a
 = 1;

1464 
»t
 = 
	`ext4_fšd_šlše_’Œy
(
dœ
, 
âame
, 
»s_dœ
,

1465 &
has_šlše_d©a
);

1466 ià(
has_šlše_d©a
) {

1467 ià(
šlšed
)

1468 *
šlšed
 = 1;

1469 
ş—nup_ªd_ex™
;

1473 ià((
Çm–’
 <ğ2è&& (
Çme
[0] == '.') &&

1474 (
Çme
[1] == '.' ||‚ame[1] == '\0')) {

1479 
block
 = 
¡¬t
 = 0;

1480 
nblocks
 = 1;

1481 
»¡¬t
;

1483 ià(
	`is_dx
(
dœ
)) {

1484 
»t
 = 
	`ext4_dx_fšd_’Œy
(
dœ
, 
âame
, 
»s_dœ
);

1490 ià(!
	`IS_ERR
(
»t
è|| 
	`PTR_ERR
Ô‘è!ğ
ERR_BAD_DX_DIR
)

1491 
ş—nup_ªd_ex™
;

1492 
	`dxŒaû
(
	`´štk
(
KERN_DEBUG
 "ext4_find_entry: dx failed, "

1494 
»t
 = 
NULL
;

1496 
nblocks
 = 
dœ
->
i_size
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

1497 ià(!
nblocks
) {

1498 
»t
 = 
NULL
;

1499 
ş—nup_ªd_ex™
;

1501 
¡¬t
 = 
	`EXT4_I
(
dœ
)->
i_dœ_¡¬t_lookup
;

1502 ià(
¡¬t
 >ğ
nblocks
)

1503 
¡¬t
 = 0;

1504 
block
 = 
¡¬t
;

1505 
»¡¬t
:

1510 ià(
¿_±r
 >ğ
¿_max
) {

1512 
¿_±r
 = 0;

1513 ià(
block
 < 
¡¬t
)

1514 
¿_max
 = 
¡¬t
 - 
block
;

1516 
¿_max
 = 
nblocks
 - 
block
;

1517 
¿_max
 = 
	`mš
Ôa_max, 
	`ARRAY_SIZE
(
bh_u£
));

1518 
»tv®
 = 
	`ext4_b»ad_b©ch
(
dœ
, 
block
, 
¿_max
,

1519 
çl£
 , 
bh_u£
);

1520 ià(
»tv®
) {

1521 
»t
 = 
	`ERR_PTR
(
»tv®
);

1522 
¿_max
 = 0;

1523 
ş—nup_ªd_ex™
;

1526 ià((
bh
 = 
bh_u£
[
¿_±r
++]è=ğ
NULL
)

1527 
Ãxt
;

1528 
	`wa™_Ú_bufãr
(
bh
);

1529 ià(!
	`bufãr_u±od©e
(
bh
)) {

1530 
	`EXT4_ERROR_INODE
(
dœ
, "reading directory†block %lu",

1531 (è
block
);

1532 
	`b»l£
(
bh
);

1533 
»t
 = 
	`ERR_PTR
(-
EIO
);

1534 
ş—nup_ªd_ex™
;

1536 ià(!
	`bufãr_v”if›d
(
bh
) &&

1537 !
	`is_dx_š‹º®_node
(
dœ
, 
block
,

1538 (
ext4_dœ_’Œy
 *)
bh
->
b_d©a
) &&

1539 !
	`ext4_dœblock_csum_v”ify
(
dœ
, 
bh
)) {

1540 
	`EXT4_ERROR_INODE
(
dœ
, "checksumming directory "

1541 "block %lu", ()
block
);

1542 
	`b»l£
(
bh
);

1543 
»t
 = 
	`ERR_PTR
(-
EFSBADCRC
);

1544 
ş—nup_ªd_ex™
;

1546 
	`£t_bufãr_v”if›d
(
bh
);

1547 
i
 = 
	`£¬ch_dœblock
(
bh
, 
dœ
, 
âame
,

1548 
block
 << 
	`EXT4_BLOCK_SIZE_BITS
(
sb
), 
»s_dœ
);

1549 ià(
i
 == 1) {

1550 
	`EXT4_I
(
dœ
)->
i_dœ_¡¬t_lookup
 = 
block
;

1551 
»t
 = 
bh
;

1552 
ş—nup_ªd_ex™
;

1554 
	`b»l£
(
bh
);

1555 ià(
i
 < 0)

1556 
ş—nup_ªd_ex™
;

1558 
Ãxt
:

1559 ià(++
block
 >ğ
nblocks
)

1560 
block
 = 0;

1561 } 
block
 !ğ
¡¬t
);

1567 
block
 = 
nblocks
;

1568 
nblocks
 = 
dœ
->
i_size
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

1569 ià(
block
 < 
nblocks
) {

1570 
¡¬t
 = 0;

1571 
»¡¬t
;

1574 
ş—nup_ªd_ex™
:

1576 ; 
¿_±r
 < 
¿_max
;„a_ptr++)

1577 
	`b»l£
(
bh_u£
[
¿_±r
]);

1578  
»t
;

1579 
	}
}

1581 
bufãr_h—d
 *
	$ext4_fšd_’Œy
(
šode
 *
dœ
,

1582 cÚ¡ 
q¡r
 *
d_Çme
,

1583 
ext4_dœ_’Œy_2
 **
»s_dœ
,

1584 *
šlšed
)

1586 
”r
;

1587 
ext4_f’ame
 
âame
;

1588 
bufãr_h—d
 *
bh
;

1590 
”r
 = 
	`ext4_âame_£tup_f’ame
(
dœ
, 
d_Çme
, 1, &
âame
);

1591 ià(
”r
 =ğ-
ENOENT
)

1592  
NULL
;

1593 ià(
”r
)

1594  
	`ERR_PTR
(
”r
);

1596 
bh
 = 
	`__ext4_fšd_’Œy
(
dœ
, &
âame
, 
»s_dœ
, 
šlšed
);

1598 
	`ext4_âame_ä“_f’ame
(&
âame
);

1599  
bh
;

1600 
	}
}

1602 
bufãr_h—d
 *
	$ext4_lookup_’Œy
(
šode
 *
dœ
,

1603 
d’Œy
 *dentry,

1604 
ext4_dœ_’Œy_2
 **
»s_dœ
)

1606 
”r
;

1607 
ext4_f’ame
 
âame
;

1608 
bufãr_h—d
 *
bh
;

1610 
”r
 = 
	`ext4_âame_´•¬e_lookup
(
dœ
, 
d’Œy
, &
âame
);

1611 ià(
”r
 =ğ-
ENOENT
)

1612  
NULL
;

1613 ià(
”r
)

1614  
	`ERR_PTR
(
”r
);

1616 
bh
 = 
	`__ext4_fšd_’Œy
(
dœ
, &
âame
, 
»s_dœ
, 
NULL
);

1618 
	`ext4_âame_ä“_f’ame
(&
âame
);

1619  
bh
;

1620 
	}
}

1622 
bufãr_h—d
 * 
	$ext4_dx_fšd_’Œy
(
šode
 *
dœ
,

1623 
ext4_f’ame
 *
âame
,

1624 
ext4_dœ_’Œy_2
 **
»s_dœ
)

1626 
su³r_block
 * 
sb
 = 
dœ
->
i_sb
;

1627 
dx_äame
 
äames
[
EXT4_HTREE_LEVEL
], *
äame
;

1628 
bufãr_h—d
 *
bh
;

1629 
ext4_lblk_t
 
block
;

1630 
»tv®
;

1632 #ifdeà
CONFIG_FS_ENCRYPTION


1633 *
»s_dœ
 = 
NULL
;

1635 
äame
 = 
	`dx_´obe
(
âame
, 
dœ
, 
NULL
, 
äames
);

1636 ià(
	`IS_ERR
(
äame
))

1637  (
bufãr_h—d
 *è
äame
;

1639 
block
 = 
	`dx_g‘_block
(
äame
->
©
);

1640 
bh
 = 
	`ext4_»ad_dœblock
(
dœ
, 
block
, 
DIRENT_HTREE
);

1641 ià(
	`IS_ERR
(
bh
))

1642 
”rout
;

1644 
»tv®
 = 
	`£¬ch_dœblock
(
bh
, 
dœ
, 
âame
,

1645 
block
 << 
	`EXT4_BLOCK_SIZE_BITS
(
sb
),

1646 
»s_dœ
);

1647 ià(
»tv®
 == 1)

1648 
sucûss
;

1649 
	`b»l£
(
bh
);

1650 ià(
»tv®
 == -1) {

1651 
bh
 = 
	`ERR_PTR
(
ERR_BAD_DX_DIR
);

1652 
”rout
;

1656 
»tv®
 = 
	`ext4_hŒ“_Ãxt_block
(
dœ
, 
âame
->
hšfo
.
hash
, 
äame
,

1657 
äames
, 
NULL
);

1658 ià(
»tv®
 < 0) {

1659 
	`ext4_w¬nšg_šode
(
dœ
,

1661 
»tv®
);

1662 
bh
 = 
	`ERR_PTR
(
»tv®
);

1663 
”rout
;

1665 } 
»tv®
 == 1);

1667 
bh
 = 
NULL
;

1668 
”rout
:

1669 
	`dxŒaû
(
	`´štk
(
KERN_DEBUG
 "% nÙ found\n", 
âame
->
u¤_âame
->
Çme
));

1670 
sucûss
:

1671 
	`dx_»Ëa£
(
äames
);

1672  
bh
;

1673 
	}
}

1675 
d’Œy
 *
	$ext4_lookup
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
æags
)

1677 
šode
 *inode;

1678 
ext4_dœ_’Œy_2
 *
de
;

1679 
bufãr_h—d
 *
bh
;

1681 ià(
d’Œy
->
d_Çme
.
Ën
 > 
EXT4_NAME_LEN
)

1682  
	`ERR_PTR
(-
ENAMETOOLONG
);

1684 
bh
 = 
	`ext4_lookup_’Œy
(
dœ
, 
d’Œy
, &
de
);

1685 ià(
	`IS_ERR
(
bh
))

1686  
	`ERR_CAST
(
bh
);

1687 
šode
 = 
NULL
;

1688 ià(
bh
) {

1689 
__u32
 
šo
 = 
	`Ë32_to_ıu
(
de
->
šode
);

1690 
	`b»l£
(
bh
);

1691 ià(!
	`ext4_v®id_šum
(
dœ
->
i_sb
, 
šo
)) {

1692 
	`EXT4_ERROR_INODE
(
dœ
, "bad inodnumb”: %u", 
šo
);

1693  
	`ERR_PTR
(-
EFSCORRUPTED
);

1695 ià(
	`uÆik–y
(
šo
 =ğ
dœ
->
i_šo
)) {

1696 
	`EXT4_ERROR_INODE
(
dœ
, "'%pd'†inkedo…arent dir",

1697 
d’Œy
);

1698  
	`ERR_PTR
(-
EFSCORRUPTED
);

1700 
šode
 = 
	`ext4_ig‘
(
dœ
->
i_sb
, 
šo
, 
EXT4_IGET_NORMAL
);

1701 ià(
šode
 =ğ
	`ERR_PTR
(-
ESTALE
)) {

1702 
	`EXT4_ERROR_INODE
(
dœ
,

1704 
šo
);

1705  
	`ERR_PTR
(-
EFSCORRUPTED
);

1707 ià(!
	`IS_ERR
(
šode
è&& 
	`IS_ENCRYPTED
(
dœ
) &&

1708 (
	`S_ISDIR
(
šode
->
i_mode
è|| 
	`S_ISLNK
(inode->i_mode)) &&

1709 !
	`fsüy±_has_³rm™‹d_cÚ‹xt
(
dœ
, 
šode
)) {

1710 
	`ext4_w¬nšg
(
šode
->
i_sb
,

1712 
dœ
->
i_šo
, 
šode
->i_ino);

1713 
	`ut
(
šode
);

1714  
	`ERR_PTR
(-
EPERM
);

1718 #ifdeà
CONFIG_UNICODE


1719 ià(!
šode
 && 
	`IS_CASEFOLDED
(
dœ
)) {

1725  
NULL
;

1728  
	`d_¥liû_®Ÿs
(
šode
, 
d’Œy
);

1729 
	}
}

1732 
d’Œy
 *
	$ext4_g‘_·»Á
(
d’Œy
 *
chd
)

1734 
__u32
 
šo
;

1735 cÚ¡ 
q¡r
 
dÙdÙ
 = 
	`QSTR_INIT
("..", 2);

1736 
ext4_dœ_’Œy_2
 * 
de
;

1737 
bufãr_h—d
 *
bh
;

1739 
bh
 = 
	`ext4_fšd_’Œy
(
	`d_šode
(
chd
), &
dÙdÙ
, &
de
, 
NULL
);

1740 ià(
	`IS_ERR
(
bh
))

1741  
	`ERR_CAST
(
bh
);

1742 ià(!
bh
)

1743  
	`ERR_PTR
(-
ENOENT
);

1744 
šo
 = 
	`Ë32_to_ıu
(
de
->
šode
);

1745 
	`b»l£
(
bh
);

1747 ià(!
	`ext4_v®id_šum
(
chd
->
d_sb
, 
šo
)) {

1748 
	`EXT4_ERROR_INODE
(
	`d_šode
(
chd
),

1749 "bad…¬’ˆšodnumb”: %u", 
šo
);

1750  
	`ERR_PTR
(-
EFSCORRUPTED
);

1753  
	`d_obš_®Ÿs
(
	`ext4_ig‘
(
chd
->
d_sb
, 
šo
, 
EXT4_IGET_NORMAL
));

1754 
	}
}

1760 
ext4_dœ_’Œy_2
 *

1761 
	$dx_move_dœ’ts
(*
äom
, *
to
, 
dx_m­_’Œy
 *
m­
, 
couÁ
,

1762 
blocksize
)

1764 
»c_Ën
 = 0;

1766 
couÁ
--) {

1767 
ext4_dœ_’Œy_2
 *
de
 = (ext4_dir_entry_2 *)

1768 (
äom
 + (
m­
->
offs
<<2));

1769 
»c_Ën
 = 
	`EXT4_DIR_REC_LEN
(
de
->
Çme_Ën
);

1770 
	`memıy
 (
to
, 
de
, 
»c_Ën
);

1771 ((
ext4_dœ_’Œy_2
 *è
to
)->
»c_Ën
 =

1772 
	`ext4_»c_Ën_to_disk
(
»c_Ën
, 
blocksize
);

1773 
de
->
šode
 = 0;

1774 
m­
++;

1775 
to
 +ğ
»c_Ën
;

1777  (
ext4_dœ_’Œy_2
 *è(
to
 - 
»c_Ën
);

1778 
	}
}

1784 
ext4_dœ_’Œy_2
* 
	$dx_·ck_dœ’ts
(*
ba£
, 
blocksize
)

1786 
ext4_dœ_’Œy_2
 *
Ãxt
, *
to
, *
´ev
, *
de
 = (ext4_dœ_’Œy_2 *è
ba£
;

1787 
»c_Ën
 = 0;

1789 
´ev
 = 
to
 = 
de
;

1790 (*)
de
 < 
ba£
 + 
blocksize
) {

1791 
Ãxt
 = 
	`ext4_Ãxt_’Œy
(
de
, 
blocksize
);

1792 ià(
de
->
šode
 && de->
Çme_Ën
) {

1793 
»c_Ën
 = 
	`EXT4_DIR_REC_LEN
(
de
->
Çme_Ën
);

1794 ià(
de
 > 
to
)

1795 
	`memmove
(
to
, 
de
, 
»c_Ën
);

1796 
to
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
Ôec_Ën, 
blocksize
);

1797 
´ev
 = 
to
;

1798 
to
 = (
ext4_dœ_’Œy_2
 *è(((*ètoè+ 
»c_Ën
);

1800 
de
 = 
Ãxt
;

1802  
´ev
;

1803 
	}
}

1810 
ext4_dœ_’Œy_2
 *
	$do_¥l™
(
hªdË_t
 *
hªdË
, 
šode
 *
dœ
,

1811 
bufãr_h—d
 **
bh
,
dx_äame
 *
äame
,

1812 
dx_hash_šfo
 *
hšfo
)

1814 
blocksize
 = 
dœ
->
i_sb
->
s_blocksize
;

1815 
couÁ
, 
cÚtšued
;

1816 
bufãr_h—d
 *
bh2
;

1817 
ext4_lblk_t
 
Ãwblock
;

1818 
u32
 
hash2
;

1819 
dx_m­_’Œy
 *
m­
;

1820 *
d©a1
 = (*
bh
)->
b_d©a
, *
d©a2
;

1821 
¥l™
, 
move
, 
size
;

1822 
ext4_dœ_’Œy_2
 *
de
 = 
NULL
, *
de2
;

1823 
csum_size
 = 0;

1824 
”r
 = 0, 
i
;

1826 ià(
	`ext4_has_m‘ad©a_csum
(
dœ
->
i_sb
))

1827 
csum_size
 = (
ext4_dœ_’Œy_
);

1829 
bh2
 = 
	`ext4_­³nd
(
hªdË
, 
dœ
, &
Ãwblock
);

1830 ià(
	`IS_ERR
(
bh2
)) {

1831 
	`b»l£
(*
bh
);

1832 *
bh
 = 
NULL
;

1833  (
ext4_dœ_’Œy_2
 *è
bh2
;

1836 
	`BUFFER_TRACE
(*
bh
, "get_write_access");

1837 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, *
bh
);

1838 ià(
”r
)

1839 
jouº®_”rÜ
;

1841 
	`BUFFER_TRACE
(
äame
->
bh
, "get_write_access");

1842 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
äame
->
bh
);

1843 ià(
”r
)

1844 
jouº®_”rÜ
;

1846 
d©a2
 = 
bh2
->
b_d©a
;

1849 
m­
 = (
dx_m­_’Œy
 *è(
d©a2
 + 
blocksize
);

1850 
couÁ
 = 
	`dx_make_m­
(
dœ
, (
ext4_dœ_’Œy_2
 *è
d©a1
,

1851 
blocksize
, 
hšfo
, 
m­
);

1852 
m­
 -ğ
couÁ
;

1853 
	`dx_sÜt_m­
(
m­
, 
couÁ
);

1855 
size
 = 0;

1856 
move
 = 0;

1857 
i
 = 
couÁ
-1; i >= 0; i--) {

1859 ià(
size
 + 
m­
[
i
].size/2 > 
blocksize
/2)

1861 
size
 +ğ
m­
[
i
].size;

1862 
move
++;

1865 
¥l™
 = 
couÁ
 - 
move
;

1866 
hash2
 = 
m­
[
¥l™
].
hash
;

1867 
cÚtšued
 = 
hash2
 =ğ
m­
[
¥l™
 - 1].
hash
;

1868 
	`dxŒaû
(
	`´štk
(
KERN_INFO
 "Split block %lu‡t %x, %i/%i\n",

1869 ()
	`dx_g‘_block
(
äame
->
©
),

1870 
hash2
, 
¥l™
, 
couÁ
-split));

1873 
de2
 = 
	`dx_move_dœ’ts
(
d©a1
, 
d©a2
, 
m­
 + 
¥l™
, 
couÁ
 - split,

1874 
blocksize
);

1875 
de
 = 
	`dx_·ck_dœ’ts
(
d©a1
, 
blocksize
);

1876 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
d©a1
 + (
blocksize
 - 
csum_size
) -

1877 (*è
de
,

1878 
blocksize
);

1879 
de2
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
d©a2
 + (
blocksize
 - 
csum_size
) -

1880 (*è
de2
,

1881 
blocksize
);

1882 ià(
csum_size
) {

1883 
	`ext4_š™Ÿlize_dœ’t_
(*
bh
, 
blocksize
);

1884 
	`ext4_š™Ÿlize_dœ’t_
(
bh2
, 
blocksize
);

1887 
	`dxŒaû
(
	`dx_show_Ëaf
(
dœ
, 
hšfo
, (
ext4_dœ_’Œy_2
 *è
d©a1
,

1888 
blocksize
, 1));

1889 
	`dxŒaû
(
	`dx_show_Ëaf
(
dœ
, 
hšfo
, (
ext4_dœ_’Œy_2
 *è
d©a2
,

1890 
blocksize
, 1));

1893 ià(
hšfo
->
hash
 >ğ
hash2
) {

1894 
	`sw­
(*
bh
, 
bh2
);

1895 
de
 = 
de2
;

1897 
	`dx_š£¹_block
(
äame
, 
hash2
 + 
cÚtšued
, 
Ãwblock
);

1898 
”r
 = 
	`ext4_hªdË_dœty_dœblock
(
hªdË
, 
dœ
, 
bh2
);

1899 ià(
”r
)

1900 
jouº®_”rÜ
;

1901 
”r
 = 
	`ext4_hªdË_dœty_dx_node
(
hªdË
, 
dœ
, 
äame
->
bh
);

1902 ià(
”r
)

1903 
jouº®_”rÜ
;

1904 
	`b»l£
(
bh2
);

1905 
	`dxŒaû
(
	`dx_show_šdex
("äame", 
äame
->
’Œ›s
));

1906  
de
;

1908 
jouº®_”rÜ
:

1909 
	`b»l£
(*
bh
);

1910 
	`b»l£
(
bh2
);

1911 *
bh
 = 
NULL
;

1912 
	`ext4_¡d_”rÜ
(
dœ
->
i_sb
, 
”r
);

1913  
	`ERR_PTR
(
”r
);

1914 
	}
}

1916 
	$ext4_fšd_de¡_de
(
šode
 *
dœ
, inode *inode,

1917 
bufãr_h—d
 *
bh
,

1918 *
buf
, 
buf_size
,

1919 
ext4_f’ame
 *
âame
,

1920 
ext4_dœ_’Œy_2
 **
de¡_de
)

1922 
ext4_dœ_’Œy_2
 *
de
;

1923 
»ş’
 = 
	`EXT4_DIR_REC_LEN
(
	`âame_Ën
(
âame
));

1924 
Æ’
, 
¾’
;

1925 
off£t
 = 0;

1926 *
tİ
;

1928 
de
 = (
ext4_dœ_’Œy_2
 *)
buf
;

1929 
tİ
 = 
buf
 + 
buf_size
 - 
»ş’
;

1930 (*è
de
 <ğ
tİ
) {

1931 ià(
	`ext4_check_dœ_’Œy
(
dœ
, 
NULL
, 
de
, 
bh
,

1932 
buf
, 
buf_size
, 
off£t
))

1933  -
EFSCORRUPTED
;

1934 ià(
	`ext4_m©ch
(
dœ
, 
âame
, 
de
))

1935  -
EEXIST
;

1936 
Æ’
 = 
	`EXT4_DIR_REC_LEN
(
de
->
Çme_Ën
);

1937 
¾’
 = 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
buf_size
);

1938 ià((
de
->
šode
 ? 
¾’
 - 
Æ’
 :„Ënè>ğ
»ş’
)

1940 
de
 = (
ext4_dœ_’Œy_2
 *)((*)d+ 
¾’
);

1941 
off£t
 +ğ
¾’
;

1943 ià((*è
de
 > 
tİ
)

1944  -
ENOSPC
;

1946 *
de¡_de
 = 
de
;

1948 
	}
}

1950 
	$ext4_š£¹_d’Œy
(
šode
 *inode,

1951 
ext4_dœ_’Œy_2
 *
de
,

1952 
buf_size
,

1953 
ext4_f’ame
 *
âame
)

1956 
Æ’
, 
¾’
;

1958 
Æ’
 = 
	`EXT4_DIR_REC_LEN
(
de
->
Çme_Ën
);

1959 
¾’
 = 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
buf_size
);

1960 ià(
de
->
šode
) {

1961 
ext4_dœ_’Œy_2
 *
de1
 =

1962 (
ext4_dœ_’Œy_2
 *)((*)
de
 + 
Æ’
);

1963 
de1
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
¾’
 - 
Æ’
, 
buf_size
);

1964 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
Æ’
, 
buf_size
);

1965 
de
 = 
de1
;

1967 
de
->
fe_ty³
 = 
EXT4_FT_UNKNOWN
;

1968 
de
->
šode
 = 
	`ıu_to_Ë32
(šode->
i_šo
);

1969 
	`ext4_£t_de_ty³
(
šode
->
i_sb
, 
de
, inode->
i_mode
);

1970 
de
->
Çme_Ën
 = 
	`âame_Ën
(
âame
);

1971 
	`memıy
(
de
->
Çme
, 
	`âame_Çme
(
âame
), 
	`âame_Ën
(fname));

1972 
	}
}

1982 
	$add_dœ’t_to_buf
(
hªdË_t
 *
hªdË
, 
ext4_f’ame
 *
âame
,

1983 
šode
 *
dœ
,

1984 
šode
 *šode, 
ext4_dœ_’Œy_2
 *
de
,

1985 
bufãr_h—d
 *
bh
)

1987 
blocksize
 = 
dœ
->
i_sb
->
s_blocksize
;

1988 
csum_size
 = 0;

1989 
”r
;

1991 ià(
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

1992 
csum_size
 = (
ext4_dœ_’Œy_
);

1994 ià(!
de
) {

1995 
”r
 = 
	`ext4_fšd_de¡_de
(
dœ
, 
šode
, 
bh
, bh->
b_d©a
,

1996 
blocksize
 - 
csum_size
, 
âame
, &
de
);

1997 ià(
”r
)

1998  
”r
;

2000 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2001 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

2002 ià(
”r
) {

2003 
	`ext4_¡d_”rÜ
(
dœ
->
i_sb
, 
”r
);

2004  
”r
;

2008 
	`ext4_š£¹_d’Œy
(
šode
, 
de
, 
blocksize
, 
âame
);

2021 
dœ
->
i_mtime
 = dœ->
i_ùime
 = 
	`cu¼’t_time
(dir);

2022 
	`ext4_upd©e_dx_æag
(
dœ
);

2023 
	`šode_šc_iv”siÚ
(
dœ
);

2024 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dœ
);

2025 
	`BUFFER_TRACE
(
bh
, "callƒxt4_handle_dirty_metadata");

2026 
”r
 = 
	`ext4_hªdË_dœty_dœblock
(
hªdË
, 
dœ
, 
bh
);

2027 ià(
”r
)

2028 
	`ext4_¡d_”rÜ
(
dœ
->
i_sb
, 
”r
);

2030 
	}
}

2036 
	$make_šdexed_dœ
(
hªdË_t
 *
hªdË
, 
ext4_f’ame
 *
âame
,

2037 
šode
 *
dœ
,

2038 
šode
 *šode, 
bufãr_h—d
 *
bh
)

2040 
bufãr_h—d
 *
bh2
;

2041 
dx_roÙ
 *
roÙ
;

2042 
dx_äame
 
äames
[
EXT4_HTREE_LEVEL
], *
äame
;

2043 
dx_’Œy
 *
’Œ›s
;

2044 
ext4_dœ_’Œy_2
 *
de
, *
de2
;

2045 *
d©a2
, *
tİ
;

2046 
Ën
;

2047 
»tv®
;

2048 
blocksize
;

2049 
ext4_lblk_t
 
block
;

2050 
çke_dœ’t
 *
fde
;

2051 
csum_size
 = 0;

2053 ià(
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

2054 
csum_size
 = (
ext4_dœ_’Œy_
);

2056 
blocksize
 = 
dœ
->
i_sb
->
s_blocksize
;

2057 
	`dxŒaû
(
	`´štk
(
KERN_DEBUG
 "C»©šg index: inod%lu\n", 
dœ
->
i_šo
));

2058 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2059 
»tv®
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

2060 ià(
»tv®
) {

2061 
	`ext4_¡d_”rÜ
(
dœ
->
i_sb
, 
»tv®
);

2062 
	`b»l£
(
bh
);

2063  
»tv®
;

2065 
roÙ
 = (
dx_roÙ
 *è
bh
->
b_d©a
;

2068 
fde
 = &
roÙ
->
dÙdÙ
;

2069 
de
 = (
ext4_dœ_’Œy_2
 *)((*)
fde
 +

2070 
	`ext4_»c_Ën_äom_disk
(
fde
->
»c_Ën
, 
blocksize
));

2071 ià((*è
de
 >ğ(((*è
roÙ
è+ 
blocksize
)) {

2072 
	`EXT4_ERROR_INODE
(
dœ
, "invalid„ec_len for '..'");

2073 
	`b»l£
(
bh
);

2074  -
EFSCORRUPTED
;

2076 
Ën
 = ((*è
roÙ
è+ (
blocksize
 - 
csum_size
è- (*è
de
;

2079 
bh2
 = 
	`ext4_­³nd
(
hªdË
, 
dœ
, &
block
);

2080 ià(
	`IS_ERR
(
bh2
)) {

2081 
	`b»l£
(
bh
);

2082  
	`PTR_ERR
(
bh2
);

2084 
	`ext4_£t_šode_æag
(
dœ
, 
EXT4_INODE_INDEX
);

2085 
d©a2
 = 
bh2
->
b_d©a
;

2087 
	`memıy
(
d©a2
, 
de
, 
Ën
);

2088 
de
 = (
ext4_dœ_’Œy_2
 *è
d©a2
;

2089 
tİ
 = 
d©a2
 + 
Ën
;

2090 (*)(
de2
 = 
	`ext4_Ãxt_’Œy
(
de
, 
blocksize
)è< 
tİ
)

2091 
de
 = 
de2
;

2092 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
d©a2
 + (
blocksize
 - 
csum_size
) -

2093 (*è
de
, 
blocksize
);

2095 ià(
csum_size
)

2096 
	`ext4_š™Ÿlize_dœ’t_
(
bh2
, 
blocksize
);

2099 
de
 = (
ext4_dœ_’Œy_2
 *è(&
roÙ
->
dÙdÙ
);

2100 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
blocksize
 - 
	`EXT4_DIR_REC_LEN
(2),

2101 
blocksize
);

2102 
	`mem£t
 (&
roÙ
->
šfo
, 0, (root->info));

2103 
roÙ
->
šfo
.
šfo_Ëngth
 = (root->info);

2104 
roÙ
->
šfo
.
hash_v”siÚ
 = 
	`EXT4_SB
(
dœ
->
i_sb
)->
s_def_hash_v”siÚ
;

2105 
’Œ›s
 = 
roÙ
->entries;

2106 
	`dx_£t_block
(
’Œ›s
, 1);

2107 
	`dx_£t_couÁ
(
’Œ›s
, 1);

2108 
	`dx_£t_lim™
(
’Œ›s
, 
	`dx_roÙ_lim™
(
dœ
, (
roÙ
->
šfo
)));

2111 
âame
->
hšfo
.
hash_v”siÚ
 = 
roÙ
->
šfo
.hash_version;

2112 ià(
âame
->
hšfo
.
hash_v”siÚ
 <ğ
DX_HASH_TEA
)

2113 
âame
->
hšfo
.
hash_v”siÚ
 +ğ
	`EXT4_SB
(
dœ
->
i_sb
)->
s_hash_unsigÃd
;

2114 
âame
->
hšfo
.
£ed
 = 
	`EXT4_SB
(
dœ
->
i_sb
)->
s_hash_£ed
;

2115 
	`ext4fs_dœhash
(
dœ
, 
	`âame_Çme
(
âame
), 
	`âame_Ën
(âame), &âame->
hšfo
);

2117 
	`mem£t
(
äames
, 0, (frames));

2118 
äame
 = 
äames
;

2119 
äame
->
’Œ›s
 =ƒntries;

2120 
äame
->
©
 = 
’Œ›s
;

2121 
äame
->
bh
 = bh;

2123 
»tv®
 = 
	`ext4_hªdË_dœty_dx_node
(
hªdË
, 
dœ
, 
äame
->
bh
);

2124 ià(
»tv®
)

2125 
out_äames
;

2126 
»tv®
 = 
	`ext4_hªdË_dœty_dœblock
(
hªdË
, 
dœ
, 
bh2
);

2127 ià(
»tv®
)

2128 
out_äames
;

2130 
de
 = 
	`do_¥l™
(
hªdË
,
dœ
, &
bh2
, 
äame
, &
âame
->
hšfo
);

2131 ià(
	`IS_ERR
(
de
)) {

2132 
»tv®
 = 
	`PTR_ERR
(
de
);

2133 
out_äames
;

2136 
»tv®
 = 
	`add_dœ’t_to_buf
(
hªdË
, 
âame
, 
dœ
, 
šode
, 
de
, 
bh2
);

2137 
out_äames
:

2143 ià(
»tv®
)

2144 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dœ
);

2145 
	`dx_»Ëa£
(
äames
);

2146 
	`b»l£
(
bh2
);

2147  
»tv®
;

2148 
	}
}

2160 
	$ext4_add_’Œy
(
hªdË_t
 *
hªdË
, 
d’Œy
 *dentry,

2161 
šode
 *inode)

2163 
šode
 *
dœ
 = 
	`d_šode
(
d’Œy
->
d_·»Á
);

2164 
bufãr_h—d
 *
bh
 = 
NULL
;

2165 
ext4_dœ_’Œy_2
 *
de
;

2166 
su³r_block
 *
sb
;

2167 
ext4_sb_šfo
 *
sbi
;

2168 
ext4_f’ame
 
âame
;

2169 
»tv®
;

2170 
dx_çÎback
=0;

2171 
blocksize
;

2172 
ext4_lblk_t
 
block
, 
blocks
;

2173 
csum_size
 = 0;

2175 ià(
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

2176 
csum_size
 = (
ext4_dœ_’Œy_
);

2178 
sb
 = 
dœ
->
i_sb
;

2179 
sbi
 = 
	`EXT4_SB
(
sb
);

2180 
blocksize
 = 
sb
->
s_blocksize
;

2181 ià(!
d’Œy
->
d_Çme
.
Ën
)

2182  -
EINVAL
;

2184 #ifdeà
CONFIG_UNICODE


2185 ià(
	`ext4_has_¡riù_mode
(
sbi
è&& 
	`IS_CASEFOLDED
(
dœ
) &&

2186 
sbi
->
s_’codšg
 && 
	`utf8_v®id©e
(sbi->s_’codšg, &
d’Œy
->
d_Çme
))

2187  -
EINVAL
;

2190 
»tv®
 = 
	`ext4_âame_£tup_f’ame
(
dœ
, &
d’Œy
->
d_Çme
, 0, &
âame
);

2191 ià(
»tv®
)

2192  
»tv®
;

2194 ià(
	`ext4_has_šlše_d©a
(
dœ
)) {

2195 
»tv®
 = 
	`ext4_Œy_add_šlše_’Œy
(
hªdË
, &
âame
, 
dœ
, 
šode
);

2196 ià(
»tv®
 < 0)

2197 
out
;

2198 ià(
»tv®
 == 1) {

2199 
»tv®
 = 0;

2200 
out
;

2204 ià(
	`is_dx
(
dœ
)) {

2205 
»tv®
 = 
	`ext4_dx_add_’Œy
(
hªdË
, &
âame
, 
dœ
, 
šode
);

2206 ià(!
»tv®
 || (»tv® !ğ
ERR_BAD_DX_DIR
))

2207 
out
;

2208 
	`ext4_ş—r_šode_æag
(
dœ
, 
EXT4_INODE_INDEX
);

2209 
dx_çÎback
++;

2210 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dœ
);

2212 
blocks
 = 
dœ
->
i_size
 >> 
sb
->
s_blocksize_b™s
;

2213 
block
 = 0; block < 
blocks
; block++) {

2214 
bh
 = 
	`ext4_»ad_dœblock
(
dœ
, 
block
, 
DIRENT
);

2215 ià(
bh
 =ğ
NULL
) {

2216 
bh
 = 
	`ext4_b»ad
(
hªdË
, 
dœ
, 
block
,

2217 
EXT4_GET_BLOCKS_CREATE
);

2218 
add_to_Ãw_block
;

2220 ià(
	`IS_ERR
(
bh
)) {

2221 
»tv®
 = 
	`PTR_ERR
(
bh
);

2222 
bh
 = 
NULL
;

2223 
out
;

2225 
»tv®
 = 
	`add_dœ’t_to_buf
(
hªdË
, &
âame
, 
dœ
, 
šode
,

2226 
NULL
, 
bh
);

2227 ià(
»tv®
 !ğ-
ENOSPC
)

2228 
out
;

2230 ià(
blocks
 =ğ1 && !
dx_çÎback
 &&

2231 
	`ext4_has_ã©u»_dœ_šdex
(
sb
)) {

2232 
»tv®
 = 
	`make_šdexed_dœ
(
hªdË
, &
âame
, 
dœ
,

2233 
šode
, 
bh
);

2234 
bh
 = 
NULL
;

2235 
out
;

2237 
	`b»l£
(
bh
);

2239 
bh
 = 
	`ext4_­³nd
(
hªdË
, 
dœ
, &
block
);

2240 
add_to_Ãw_block
:

2241 ià(
	`IS_ERR
(
bh
)) {

2242 
»tv®
 = 
	`PTR_ERR
(
bh
);

2243 
bh
 = 
NULL
;

2244 
out
;

2246 
de
 = (
ext4_dœ_’Œy_2
 *è
bh
->
b_d©a
;

2247 
de
->
šode
 = 0;

2248 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
blocksize
 - 
csum_size
, blocksize);

2250 ià(
csum_size
)

2251 
	`ext4_š™Ÿlize_dœ’t_
(
bh
, 
blocksize
);

2253 
»tv®
 = 
	`add_dœ’t_to_buf
(
hªdË
, &
âame
, 
dœ
, 
šode
, 
de
, 
bh
);

2254 
out
:

2255 
	`ext4_âame_ä“_f’ame
(&
âame
);

2256 
	`b»l£
(
bh
);

2257 ià(
»tv®
 == 0)

2258 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_NEWENTRY
);

2259  
»tv®
;

2260 
	}
}

2265 
	$ext4_dx_add_’Œy
(
hªdË_t
 *
hªdË
, 
ext4_f’ame
 *
âame
,

2266 
šode
 *
dœ
, inode *inode)

2268 
dx_äame
 
äames
[
EXT4_HTREE_LEVEL
], *
äame
;

2269 
dx_’Œy
 *
’Œ›s
, *
©
;

2270 
bufãr_h—d
 *
bh
;

2271 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

2272 
ext4_dœ_’Œy_2
 *
de
;

2273 
»¡¬t
;

2274 
”r
;

2276 
agaš
:

2277 
»¡¬t
 = 0;

2278 
äame
 = 
	`dx_´obe
(
âame
, 
dœ
, 
NULL
, 
äames
);

2279 ià(
	`IS_ERR
(
äame
))

2280  
	`PTR_ERR
(
äame
);

2281 
’Œ›s
 = 
äame
->entries;

2282 
©
 = 
äame
->at;

2283 
bh
 = 
	`ext4_»ad_dœblock
(
dœ
, 
	`dx_g‘_block
(
äame
->
©
), 
DIRENT_HTREE
);

2284 ià(
	`IS_ERR
(
bh
)) {

2285 
”r
 = 
	`PTR_ERR
(
bh
);

2286 
bh
 = 
NULL
;

2287 
ş—nup
;

2290 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2291 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

2292 ià(
”r
)

2293 
jouº®_”rÜ
;

2295 
”r
 = 
	`add_dœ’t_to_buf
(
hªdË
, 
âame
, 
dœ
, 
šode
, 
NULL
, 
bh
);

2296 ià(
”r
 !ğ-
ENOSPC
)

2297 
ş—nup
;

2299 
”r
 = 0;

2301 
	`dxŒaû
(
	`´štk
(
KERN_DEBUG
 "using %u of %u‚odeƒntries\n",

2302 
	`dx_g‘_couÁ
(
’Œ›s
), 
	`dx_g‘_lim™
(entries)));

2304 ià(
	`dx_g‘_couÁ
(
’Œ›s
è=ğ
	`dx_g‘_lim™
(entries)) {

2305 
ext4_lblk_t
 
Ãwblock
;

2306 
Ëv–s
 = 
äame
 - 
äames
 + 1;

2307 
icouÁ
;

2308 
add_Ëv–
 = 1;

2309 
dx_’Œy
 *
’Œ›s2
;

2310 
dx_node
 *
node2
;

2311 
bufãr_h—d
 *
bh2
;

2313 
äame
 > 
äames
) {

2314 ià(
	`dx_g‘_couÁ
((
äame
 - 1)->
’Œ›s
) <

2315 
	`dx_g‘_lim™
((
äame
 - 1)->
’Œ›s
)) {

2316 
add_Ëv–
 = 0;

2319 
äame
--;

2320 
©
 = 
äame
->at;

2321 
’Œ›s
 = 
äame
->entries;

2322 
»¡¬t
 = 1;

2324 ià(
add_Ëv–
 && 
Ëv–s
 =ğ
	`ext4_dœ_hŒ“_Ëv–
(
sb
)) {

2325 
	`ext4_w¬nšg
(
sb
, "Directory (ino: %lu) index full, "

2327 
dœ
->
i_šo
, 
Ëv–s
);

2328 ià(
	`ext4_dœ_hŒ“_Ëv–
(
sb
è< 
EXT4_HTREE_LEVEL
) {

2329 
	`ext4_w¬nšg
(
sb
, "Large directory feature is "

2333 
”r
 = -
ENOSPC
;

2334 
ş—nup
;

2336 
icouÁ
 = 
	`dx_g‘_couÁ
(
’Œ›s
);

2337 
bh2
 = 
	`ext4_­³nd
(
hªdË
, 
dœ
, &
Ãwblock
);

2338 ià(
	`IS_ERR
(
bh2
)) {

2339 
”r
 = 
	`PTR_ERR
(
bh2
);

2340 
ş—nup
;

2342 
node2
 = (
dx_node
 *)(
bh2
->
b_d©a
);

2343 
’Œ›s2
 = 
node2
->
’Œ›s
;

2344 
	`mem£t
(&
node2
->
çke
, 0, (
çke_dœ’t
));

2345 
node2
->
çke
.
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
sb
->
s_blocksize
,

2346 
sb
->
s_blocksize
);

2347 
	`BUFFER_TRACE
(
äame
->
bh
, "get_write_access");

2348 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
äame
->
bh
);

2349 ià(
”r
)

2350 
jouº®_”rÜ
;

2351 ià(!
add_Ëv–
) {

2352 
icouÁ1
 = 
icouÁ
/2, 
icouÁ2
 = icount - icount1;

2353 
hash2
 = 
	`dx_g‘_hash
(
’Œ›s
 + 
icouÁ1
);

2354 
	`dxŒaû
(
	`´štk
(
KERN_DEBUG
 "Split index %i/%i\n",

2355 
icouÁ1
, 
icouÁ2
));

2357 
	`BUFFER_TRACE
(
äame
->
bh
, "get_write_access");

2358 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
,

2359 (
äame
 - 1)->
bh
);

2360 ià(
”r
)

2361 
jouº®_”rÜ
;

2363 
	`memıy
((*è
’Œ›s2
, (*è(
’Œ›s
 + 
icouÁ1
),

2364 
icouÁ2
 * (
dx_’Œy
));

2365 
	`dx_£t_couÁ
(
’Œ›s
, 
icouÁ1
);

2366 
	`dx_£t_couÁ
(
’Œ›s2
, 
icouÁ2
);

2367 
	`dx_£t_lim™
(
’Œ›s2
, 
	`dx_node_lim™
(
dœ
));

2370 ià(
©
 - 
’Œ›s
 >ğ
icouÁ1
) {

2371 
äame
->
©
 =‡ˆğ© - 
’Œ›s
 - 
icouÁ1
 + 
’Œ›s2
;

2372 
äame
->
’Œ›s
 =ƒÁr› ğ
’Œ›s2
;

2373 
	`sw­
(
äame
->
bh
, 
bh2
);

2375 
	`dx_š£¹_block
((
äame
 - 1), 
hash2
, 
Ãwblock
);

2376 
	`dxŒaû
(
	`dx_show_šdex
("node", 
äame
->
’Œ›s
));

2377 
	`dxŒaû
(
	`dx_show_šdex
("node",

2378 ((
dx_node
 *è
bh2
->
b_d©a
)->
’Œ›s
));

2379 
”r
 = 
	`ext4_hªdË_dœty_dx_node
(
hªdË
, 
dœ
, 
bh2
);

2380 ià(
”r
)

2381 
jouº®_”rÜ
;

2382 
	`b»l£
 (
bh2
);

2383 
”r
 = 
	`ext4_hªdË_dœty_dx_node
(
hªdË
, 
dœ
,

2384 (
äame
 - 1)->
bh
);

2385 ià(
”r
)

2386 
jouº®_”rÜ
;

2387 ià(
»¡¬t
) {

2388 
”r
 = 
	`ext4_hªdË_dœty_dx_node
(
hªdË
, 
dœ
,

2389 
äame
->
bh
);

2390 
jouº®_”rÜ
;

2393 
dx_roÙ
 *
dxroÙ
;

2394 
	`memıy
((*è
’Œ›s2
, (*è
’Œ›s
,

2395 
icouÁ
 * (
dx_’Œy
));

2396 
	`dx_£t_lim™
(
’Œ›s2
, 
	`dx_node_lim™
(
dœ
));

2399 
	`dx_£t_couÁ
(
’Œ›s
, 1);

2400 
	`dx_£t_block
(
’Œ›s
 + 0, 
Ãwblock
);

2401 
dxroÙ
 = (
dx_roÙ
 *)
äames
[0].
bh
->
b_d©a
;

2402 
dxroÙ
->
šfo
.
šdœeù_Ëv–s
 += 1;

2403 
	`dxŒaû
(
	`´štk
(
KERN_DEBUG


2405 
dxroÙ
->
šfo
.
šdœeù_Ëv–s
));

2406 
”r
 = 
	`ext4_hªdË_dœty_dx_node
(
hªdË
, 
dœ
, 
äame
->
bh
);

2407 ià(
”r
)

2408 
jouº®_”rÜ
;

2409 
”r
 = 
	`ext4_hªdË_dœty_dx_node
(
hªdË
, 
dœ
, 
bh2
);

2410 
	`b»l£
(
bh2
);

2411 
»¡¬t
 = 1;

2412 
jouº®_”rÜ
;

2415 
de
 = 
	`do_¥l™
(
hªdË
, 
dœ
, &
bh
, 
äame
, &
âame
->
hšfo
);

2416 ià(
	`IS_ERR
(
de
)) {

2417 
”r
 = 
	`PTR_ERR
(
de
);

2418 
ş—nup
;

2420 
”r
 = 
	`add_dœ’t_to_buf
(
hªdË
, 
âame
, 
dœ
, 
šode
, 
de
, 
bh
);

2421 
ş—nup
;

2423 
jouº®_”rÜ
:

2424 
	`ext4_¡d_”rÜ
(
dœ
->
i_sb
, 
”r
);

2425 
ş—nup
:

2426 
	`b»l£
(
bh
);

2427 
	`dx_»Ëa£
(
äames
);

2431 ià(
»¡¬t
 && 
”r
 == 0)

2432 
agaš
;

2433  
”r
;

2434 
	}
}

2440 
	$ext4_g’”ic_d–‘e_’Œy
(
hªdË_t
 *
hªdË
,

2441 
šode
 *
dœ
,

2442 
ext4_dœ_’Œy_2
 *
de_d–
,

2443 
bufãr_h—d
 *
bh
,

2444 *
’Œy_buf
,

2445 
buf_size
,

2446 
csum_size
)

2448 
ext4_dœ_’Œy_2
 *
de
, *
pde
;

2449 
blocksize
 = 
dœ
->
i_sb
->
s_blocksize
;

2450 
i
;

2452 
i
 = 0;

2453 
pde
 = 
NULL
;

2454 
de
 = (
ext4_dœ_’Œy_2
 *)
’Œy_buf
;

2455 
i
 < 
buf_size
 - 
csum_size
) {

2456 ià(
	`ext4_check_dœ_’Œy
(
dœ
, 
NULL
, 
de
, 
bh
,

2457 
bh
->
b_d©a
, bh->
b_size
, 
i
))

2458  -
EFSCORRUPTED
;

2459 ià(
de
 =ğ
de_d–
) {

2460 ià(
pde
)

2461 
pde
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(

2462 
	`ext4_»c_Ën_äom_disk
(
pde
->
»c_Ën
,

2463 
blocksize
) +

2464 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
,

2465 
blocksize
),

2466 
blocksize
);

2468 
de
->
šode
 = 0;

2469 
	`šode_šc_iv”siÚ
(
dœ
);

2472 
i
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
blocksize
);

2473 
pde
 = 
de
;

2474 
de
 = 
	`ext4_Ãxt_’Œy
(de, 
blocksize
);

2476  -
ENOENT
;

2477 
	}
}

2479 
	$ext4_d–‘e_’Œy
(
hªdË_t
 *
hªdË
,

2480 
šode
 *
dœ
,

2481 
ext4_dœ_’Œy_2
 *
de_d–
,

2482 
bufãr_h—d
 *
bh
)

2484 
”r
, 
csum_size
 = 0;

2486 ià(
	`ext4_has_šlše_d©a
(
dœ
)) {

2487 
has_šlše_d©a
 = 1;

2488 
”r
 = 
	`ext4_d–‘e_šlše_’Œy
(
hªdË
, 
dœ
, 
de_d–
, 
bh
,

2489 &
has_šlše_d©a
);

2490 ià(
has_šlše_d©a
)

2491  
”r
;

2494 ià(
	`ext4_has_m‘ad©a_csum
(
dœ
->
i_sb
))

2495 
csum_size
 = (
ext4_dœ_’Œy_
);

2497 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2498 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

2499 ià(
	`uÆik–y
(
”r
))

2500 
out
;

2502 
”r
 = 
	`ext4_g’”ic_d–‘e_’Œy
(
hªdË
, 
dœ
, 
de_d–
,

2503 
bh
, bh->
b_d©a
,

2504 
dœ
->
i_sb
->
s_blocksize
, 
csum_size
);

2505 ià(
”r
)

2506 
out
;

2508 
	`BUFFER_TRACE
(
bh
, "callƒxt4_handle_dirty_metadata");

2509 
”r
 = 
	`ext4_hªdË_dœty_dœblock
(
hªdË
, 
dœ
, 
bh
);

2510 ià(
	`uÆik–y
(
”r
))

2511 
out
;

2514 
out
:

2515 ià(
”r
 !ğ-
ENOENT
)

2516 
	`ext4_¡d_”rÜ
(
dœ
->
i_sb
, 
”r
);

2517  
”r
;

2518 
	}
}

2531 
	$ext4_šc_couÁ
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

2533 
	`šc_Æšk
(
šode
);

2534 ià(
	`is_dx
(
šode
) &&

2535 (
šode
->
i_Æšk
 > 
EXT4_LINK_MAX
 || inode->i_nlink == 2))

2536 
	`£t_Æšk
(
šode
, 1);

2537 
	}
}

2543 
	$ext4_dec_couÁ
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

2545 ià(!
	`S_ISDIR
(
šode
->
i_mode
è|| inode->
i_Æšk
 > 2)

2546 
	`drİ_Æšk
(
šode
);

2547 
	}
}

2550 
	$ext4_add_nÚdœ
(
hªdË_t
 *
hªdË
,

2551 
d’Œy
 *d’Œy, 
šode
 *inode)

2553 
”r
 = 
	`ext4_add_’Œy
(
hªdË
, 
d’Œy
, 
šode
);

2554 ià(!
”r
) {

2555 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

2556 
	`d_š¡ªtŸ‹_Ãw
(
d’Œy
, 
šode
);

2559 
	`drİ_Æšk
(
šode
);

2560 
	`uÆock_Ãw_šode
(
šode
);

2561 
	`ut
(
šode
);

2562  
”r
;

2563 
	}
}

2573 
	$ext4_ü—‹
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
,

2574 
boŞ
 
exş
)

2576 
hªdË_t
 *
hªdË
;

2577 
šode
 *inode;

2578 
”r
, 
üed™s
, 
»Œ›s
 = 0;

2580 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

2581 ià(
”r
)

2582  
”r
;

2584 
üed™s
 = (
	`EXT4_DATA_TRANS_BLOCKS
(
dœ
->
i_sb
) +

2585 
EXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2586 
»Œy
:

2587 
šode
 = 
	`ext4_Ãw_šode_¡¬t_hªdË
(
dœ
, 
mode
, &
d’Œy
->
d_Çme
, 0,

2588 
NULL
, 
EXT4_HT_DIR
, 
üed™s
);

2589 
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

2590 
”r
 = 
	`PTR_ERR
(
šode
);

2591 ià(!
	`IS_ERR
(
šode
)) {

2592 
šode
->
i_İ
 = &
ext4_fe_šode_İ”©iÚs
;

2593 
šode
->
i_fİ
 = &
ext4_fe_İ”©iÚs
;

2594 
	`ext4_£t_aİs
(
šode
);

2595 
”r
 = 
	`ext4_add_nÚdœ
(
hªdË
, 
d’Œy
, 
šode
);

2596 ià(!
”r
 && 
	`IS_DIRSYNC
(
dœ
))

2597 
	`ext4_hªdË_sync
(
hªdË
);

2599 ià(
hªdË
)

2600 
	`ext4_jouº®_¡İ
(
hªdË
);

2601 ià(
”r
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
dœ
->
i_sb
, &
»Œ›s
))

2602 
»Œy
;

2603  
”r
;

2604 
	}
}

2606 
	$ext4_mknod
(
šode
 *
dœ
, 
d’Œy
 *dentry,

2607 
umode_t
 
mode
, 
dev_t
 
rdev
)

2609 
hªdË_t
 *
hªdË
;

2610 
šode
 *inode;

2611 
”r
, 
üed™s
, 
»Œ›s
 = 0;

2613 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

2614 ià(
”r
)

2615  
”r
;

2617 
üed™s
 = (
	`EXT4_DATA_TRANS_BLOCKS
(
dœ
->
i_sb
) +

2618 
EXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2619 
»Œy
:

2620 
šode
 = 
	`ext4_Ãw_šode_¡¬t_hªdË
(
dœ
, 
mode
, &
d’Œy
->
d_Çme
, 0,

2621 
NULL
, 
EXT4_HT_DIR
, 
üed™s
);

2622 
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

2623 
”r
 = 
	`PTR_ERR
(
šode
);

2624 ià(!
	`IS_ERR
(
šode
)) {

2625 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
, 
rdev
);

2626 
šode
->
i_İ
 = &
ext4_¥ecŸl_šode_İ”©iÚs
;

2627 
”r
 = 
	`ext4_add_nÚdœ
(
hªdË
, 
d’Œy
, 
šode
);

2628 ià(!
”r
 && 
	`IS_DIRSYNC
(
dœ
))

2629 
	`ext4_hªdË_sync
(
hªdË
);

2631 ià(
hªdË
)

2632 
	`ext4_jouº®_¡İ
(
hªdË
);

2633 ià(
”r
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
dœ
->
i_sb
, &
»Œ›s
))

2634 
»Œy
;

2635  
”r
;

2636 
	}
}

2638 
	$ext4_tmpfe
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
)

2640 
hªdË_t
 *
hªdË
;

2641 
šode
 *inode;

2642 
”r
, 
»Œ›s
 = 0;

2644 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

2645 ià(
”r
)

2646  
”r
;

2648 
»Œy
:

2649 
šode
 = 
	`ext4_Ãw_šode_¡¬t_hªdË
(
dœ
, 
mode
,

2650 
NULL
, 0, NULL,

2651 
EXT4_HT_DIR
,

2652 
	`EXT4_MAXQUOTAS_INIT_BLOCKS
(
dœ
->
i_sb
) +

2653 4 + 
EXT4_XATTR_TRANS_BLOCKS
);

2654 
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

2655 
”r
 = 
	`PTR_ERR
(
šode
);

2656 ià(!
	`IS_ERR
(
šode
)) {

2657 
šode
->
i_İ
 = &
ext4_fe_šode_İ”©iÚs
;

2658 
šode
->
i_fİ
 = &
ext4_fe_İ”©iÚs
;

2659 
	`ext4_£t_aİs
(
šode
);

2660 
	`d_tmpfe
(
d’Œy
, 
šode
);

2661 
”r
 = 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

2662 ià(
”r
)

2663 
”r_uÆock_šode
;

2664 
	`m¬k_šode_dœty
(
šode
);

2665 
	`uÆock_Ãw_šode
(
šode
);

2667 ià(
hªdË
)

2668 
	`ext4_jouº®_¡İ
(
hªdË
);

2669 ià(
”r
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
dœ
->
i_sb
, &
»Œ›s
))

2670 
»Œy
;

2671  
”r
;

2672 
”r_uÆock_šode
:

2673 
	`ext4_jouº®_¡İ
(
hªdË
);

2674 
	`uÆock_Ãw_šode
(
šode
);

2675  
”r
;

2676 
	}
}

2678 
ext4_dœ_’Œy_2
 *
	$ext4_š™_dÙ_dÙdÙ
(
šode
 *inode,

2679 
ext4_dœ_’Œy_2
 *
de
,

2680 
blocksize
, 
csum_size
,

2681 
·»Á_šo
, 
dÙdÙ_»®_Ën
)

2683 
de
->
šode
 = 
	`ıu_to_Ë32
(šode->
i_šo
);

2684 
de
->
Çme_Ën
 = 1;

2685 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
	`EXT4_DIR_REC_LEN
(de->
Çme_Ën
),

2686 
blocksize
);

2687 
	`¡rıy
(
de
->
Çme
, ".");

2688 
	`ext4_£t_de_ty³
(
šode
->
i_sb
, 
de
, 
S_IFDIR
);

2690 
de
 = 
	`ext4_Ãxt_’Œy
(de, 
blocksize
);

2691 
de
->
šode
 = 
	`ıu_to_Ë32
(
·»Á_šo
);

2692 
de
->
Çme_Ën
 = 2;

2693 ià(!
dÙdÙ_»®_Ën
)

2694 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
blocksize
 -

2695 (
csum_size
 + 
	`EXT4_DIR_REC_LEN
(1)),

2696 
blocksize
);

2698 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(

2699 
	`EXT4_DIR_REC_LEN
(
de
->
Çme_Ën
), 
blocksize
);

2700 
	`¡rıy
(
de
->
Çme
, "..");

2701 
	`ext4_£t_de_ty³
(
šode
->
i_sb
, 
de
, 
S_IFDIR
);

2703  
	`ext4_Ãxt_’Œy
(
de
, 
blocksize
);

2704 
	}
}

2706 
	$ext4_š™_Ãw_dœ
(
hªdË_t
 *
hªdË
, 
šode
 *
dœ
,

2707 
šode
 *inode)

2709 
bufãr_h—d
 *
dœ_block
 = 
NULL
;

2710 
ext4_dœ_’Œy_2
 *
de
;

2711 
ext4_lblk_t
 
block
 = 0;

2712 
blocksize
 = 
dœ
->
i_sb
->
s_blocksize
;

2713 
csum_size
 = 0;

2714 
”r
;

2716 ià(
	`ext4_has_m‘ad©a_csum
(
dœ
->
i_sb
))

2717 
csum_size
 = (
ext4_dœ_’Œy_
);

2719 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
)) {

2720 
”r
 = 
	`ext4_Œy_ü—‹_šlše_dœ
(
hªdË
, 
dœ
, 
šode
);

2721 ià(
”r
 < 0 &&ƒ¼ !ğ-
ENOSPC
)

2722 
out
;

2723 ià(!
”r
)

2724 
out
;

2727 
šode
->
i_size
 = 0;

2728 
dœ_block
 = 
	`ext4_­³nd
(
hªdË
, 
šode
, &
block
);

2729 ià(
	`IS_ERR
(
dœ_block
))

2730  
	`PTR_ERR
(
dœ_block
);

2731 
de
 = (
ext4_dœ_’Œy_2
 *)
dœ_block
->
b_d©a
;

2732 
	`ext4_š™_dÙ_dÙdÙ
(
šode
, 
de
, 
blocksize
, 
csum_size
, 
dœ
->
i_šo
, 0);

2733 
	`£t_Æšk
(
šode
, 2);

2734 ià(
csum_size
)

2735 
	`ext4_š™Ÿlize_dœ’t_
(
dœ_block
, 
blocksize
);

2737 
	`BUFFER_TRACE
(
dœ_block
, "callƒxt4_handle_dirty_metadata");

2738 
”r
 = 
	`ext4_hªdË_dœty_dœblock
(
hªdË
, 
šode
, 
dœ_block
);

2739 ià(
”r
)

2740 
out
;

2741 
	`£t_bufãr_v”if›d
(
dœ_block
);

2742 
out
:

2743 
	`b»l£
(
dœ_block
);

2744  
”r
;

2745 
	}
}

2747 
	$ext4_mkdœ
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
)

2749 
hªdË_t
 *
hªdË
;

2750 
šode
 *inode;

2751 
”r
, 
üed™s
, 
»Œ›s
 = 0;

2753 ià(
	`EXT4_DIR_LINK_MAX
(
dœ
))

2754  -
EMLINK
;

2756 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

2757 ià(
”r
)

2758  
”r
;

2760 
üed™s
 = (
	`EXT4_DATA_TRANS_BLOCKS
(
dœ
->
i_sb
) +

2761 
EXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2762 
»Œy
:

2763 
šode
 = 
	`ext4_Ãw_šode_¡¬t_hªdË
(
dœ
, 
S_IFDIR
 | 
mode
,

2764 &
d’Œy
->
d_Çme
,

2765 0, 
NULL
, 
EXT4_HT_DIR
, 
üed™s
);

2766 
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

2767 
”r
 = 
	`PTR_ERR
(
šode
);

2768 ià(
	`IS_ERR
(
šode
))

2769 
out_¡İ
;

2771 
šode
->
i_İ
 = &
ext4_dœ_šode_İ”©iÚs
;

2772 
šode
->
i_fİ
 = &
ext4_dœ_İ”©iÚs
;

2773 
”r
 = 
	`ext4_š™_Ãw_dœ
(
hªdË
, 
dœ
, 
šode
);

2774 ià(
”r
)

2775 
out_ş—r_šode
;

2776 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

2777 ià(!
”r
)

2778 
”r
 = 
	`ext4_add_’Œy
(
hªdË
, 
d’Œy
, 
šode
);

2779 ià(
”r
) {

2780 
out_ş—r_šode
:

2781 
	`ş—r_Æšk
(
šode
);

2782 
	`uÆock_Ãw_šode
(
šode
);

2783 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

2784 
	`ut
(
šode
);

2785 
out_¡İ
;

2787 
	`ext4_šc_couÁ
(
hªdË
, 
dœ
);

2788 
	`ext4_upd©e_dx_æag
(
dœ
);

2789 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dœ
);

2790 ià(
”r
)

2791 
out_ş—r_šode
;

2792 
	`d_š¡ªtŸ‹_Ãw
(
d’Œy
, 
šode
);

2793 ià(
	`IS_DIRSYNC
(
dœ
))

2794 
	`ext4_hªdË_sync
(
hªdË
);

2796 
out_¡İ
:

2797 ià(
hªdË
)

2798 
	`ext4_jouº®_¡İ
(
hªdË
);

2799 ià(
”r
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
dœ
->
i_sb
, &
»Œ›s
))

2800 
»Œy
;

2801  
”r
;

2802 
	}
}

2807 
boŞ
 
	$ext4_em±y_dœ
(
šode
 *inode)

2809 
off£t
;

2810 
bufãr_h—d
 *
bh
;

2811 
ext4_dœ_’Œy_2
 *
de
, *
de1
;

2812 
su³r_block
 *
sb
;

2814 ià(
	`ext4_has_šlše_d©a
(
šode
)) {

2815 
has_šlše_d©a
 = 1;

2816 
»t
;

2818 
»t
 = 
	`em±y_šlše_dœ
(
šode
, &
has_šlše_d©a
);

2819 ià(
has_šlše_d©a
)

2820  
»t
;

2823 
sb
 = 
šode
->
i_sb
;

2824 ià(
šode
->
i_size
 < 
	`EXT4_DIR_REC_LEN
(1) + EXT4_DIR_REC_LEN(2)) {

2825 
	`EXT4_ERROR_INODE
(
šode
, "invalid size");

2826  
Œue
;

2831 
bh
 = 
	`ext4_»ad_dœblock
(
šode
, 0, 
DIRENT_HTREE
);

2832 ià(
	`IS_ERR
(
bh
))

2833  
Œue
;

2835 
de
 = (
ext4_dœ_’Œy_2
 *è
bh
->
b_d©a
;

2836 
de1
 = 
	`ext4_Ãxt_’Œy
(
de
, 
sb
->
s_blocksize
);

2837 ià(
	`Ë32_to_ıu
(
de
->
šode
è!ğšode->
i_šo
 ||

2838 
	`Ë32_to_ıu
(
de1
->
šode
) == 0 ||

2839 
	`¡rcmp
(".", 
de
->
Çme
è|| sŒcmp("..", 
de1
->name)) {

2840 
	`ext4_w¬nšg_šode
(
šode
, "directory missing '.'‡nd/or '..'");

2841 
	`b»l£
(
bh
);

2842  
Œue
;

2844 
off£t
 = 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
sb
->
s_blocksize
) +

2845 
	`ext4_»c_Ën_äom_disk
(
de1
->
»c_Ën
, 
sb
->
s_blocksize
);

2846 
de
 = 
	`ext4_Ãxt_’Œy
(
de1
, 
sb
->
s_blocksize
);

2847 
off£t
 < 
šode
->
i_size
) {

2848 ià((*è
de
 >ğ(*è(
bh
->
b_d©a
+
sb
->
s_blocksize
)) {

2849 
lblock
;

2850 
	`b»l£
(
bh
);

2851 
lblock
 = 
off£t
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

2852 
bh
 = 
	`ext4_»ad_dœblock
(
šode
, 
lblock
, 
EITHER
);

2853 ià(
bh
 =ğ
NULL
) {

2854 
off£t
 +ğ
sb
->
s_blocksize
;

2857 ià(
	`IS_ERR
(
bh
))

2858  
Œue
;

2859 
de
 = (
ext4_dœ_’Œy_2
 *è
bh
->
b_d©a
;

2861 ià(
	`ext4_check_dœ_’Œy
(
šode
, 
NULL
, 
de
, 
bh
,

2862 
bh
->
b_d©a
, bh->
b_size
, 
off£t
)) {

2863 
de
 = (
ext4_dœ_’Œy_2
 *)(
bh
->
b_d©a
 +

2864 
sb
->
s_blocksize
);

2865 
off£t
 = (off£ˆ| (
sb
->
s_blocksize
 - 1)) + 1;

2868 ià(
	`Ë32_to_ıu
(
de
->
šode
)) {

2869 
	`b»l£
(
bh
);

2870  
çl£
;

2872 
off£t
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
sb
->
s_blocksize
);

2873 
de
 = 
	`ext4_Ãxt_’Œy
(de, 
sb
->
s_blocksize
);

2875 
	`b»l£
(
bh
);

2876  
Œue
;

2877 
	}
}

2891 
	$ext4_Üphª_add
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

2893 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

2894 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2895 
ext4_oc
 
oc
;

2896 
”r
 = 0, 
rc
;

2897 
boŞ
 
dœty
 = 
çl£
;

2899 ià(!
sbi
->
s_jouº®
 || 
	`is_bad_šode
(
šode
))

2902 
	`WARN_ON_ONCE
(!(
šode
->
i_¡©e
 & (
I_NEW
 | 
I_FREEING
)) &&

2903 !
	`šode_is_locked
(
šode
));

2908 ià(!
	`li¡_em±y
(&
	`EXT4_I
(
šode
)->
i_Üphª
))

2917 
	`J_ASSERT
((
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

2918 
	`S_ISLNK
(
šode
->
i_mode
)è|| inode->
i_Æšk
 == 0);

2920 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

2921 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
sbi
->
s_sbh
);

2922 ià(
”r
)

2923 
out
;

2925 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
);

2926 ià(
”r
)

2927 
out
;

2929 
	`mu‹x_lock
(&
sbi
->
s_Üphª_lock
);

2934 ià(!
	`NEXT_ORPHAN
(
šode
) || NEXT_ORPHAN(inode) >

2935 (
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_šodes_couÁ
))) {

2937 
	`NEXT_ORPHAN
(
šode
èğ
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_Ï¡_Üphª
);

2938 
sbi
->
s_es
->
s_Ï¡_Üphª
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

2939 
dœty
 = 
Œue
;

2941 
	`li¡_add
(&
	`EXT4_I
(
šode
)->
i_Üphª
, &
sbi
->
s_Üphª
);

2942 
	`mu‹x_uÆock
(&
sbi
->
s_Üphª_lock
);

2944 ià(
dœty
) {

2945 
”r
 = 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
);

2946 
rc
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

2947 ià(!
”r
)

2948 
”r
 = 
rc
;

2949 ià(
”r
) {

2955 
	`mu‹x_lock
(&
sbi
->
s_Üphª_lock
);

2956 
	`li¡_d–_š™
(&
	`EXT4_I
(
šode
)->
i_Üphª
);

2957 
	`mu‹x_uÆock
(&
sbi
->
s_Üphª_lock
);

2960 
	`b»l£
(
oc
.
bh
);

2962 
	`jbd_debug
(4, "su³rblock wÈpošˆtØ%lu\n", 
šode
->
i_šo
);

2963 
	`jbd_debug
(4, "orphan inode %lu will…ointo %d\n",

2964 
šode
->
i_šo
, 
	`NEXT_ORPHAN
(inode));

2965 
out
:

2966 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

2967  
”r
;

2968 
	}
}

2974 
	$ext4_Üphª_d–
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

2976 
li¡_h—d
 *
´ev
;

2977 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

2978 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

2979 
__u32
 
šo_Ãxt
;

2980 
ext4_oc
 
oc
;

2981 
”r
 = 0;

2983 ià(!
sbi
->
s_jouº®
 && !(sbi->
s_mouÁ_¡©e
 & 
EXT4_ORPHAN_FS
))

2986 
	`WARN_ON_ONCE
(!(
šode
->
i_¡©e
 & (
I_NEW
 | 
I_FREEING
)) &&

2987 !
	`šode_is_locked
(
šode
));

2989 ià(
	`li¡_em±y
(&
ei
->
i_Üphª
))

2992 ià(
hªdË
) {

2994 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
);

2997 
	`mu‹x_lock
(&
sbi
->
s_Üphª_lock
);

2998 
	`jbd_debug
(4, "»movšod%lu from o½hª†i¡\n", 
šode
->
i_šo
);

3000 
´ev
 = 
ei
->
i_Üphª
.prev;

3001 
	`li¡_d–_š™
(&
ei
->
i_Üphª
);

3007 ià(!
hªdË
 || 
”r
) {

3008 
	`mu‹x_uÆock
(&
sbi
->
s_Üphª_lock
);

3009 
out_”r
;

3012 
šo_Ãxt
 = 
	`NEXT_ORPHAN
(
šode
);

3013 ià(
´ev
 =ğ&
sbi
->
s_Üphª
) {

3014 
	`jbd_debug
(4, "su³rblock wÈpošˆtØ%u\n", 
šo_Ãxt
);

3015 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

3016 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
sbi
->
s_sbh
);

3017 ià(
”r
) {

3018 
	`mu‹x_uÆock
(&
sbi
->
s_Üphª_lock
);

3019 
out_b»l£
;

3021 
sbi
->
s_es
->
s_Ï¡_Üphª
 = 
	`ıu_to_Ë32
(
šo_Ãxt
);

3022 
	`mu‹x_uÆock
(&
sbi
->
s_Üphª_lock
);

3023 
”r
 = 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
šode
->
i_sb
);

3025 
ext4_oc
 
oc2
;

3026 
šode
 *
i_´ev
 =

3027 &
	`li¡_’Œy
(
´ev
, 
ext4_šode_šfo
, 
i_Üphª
)->
vfs_šode
;

3029 
	`jbd_debug
(4, "orphan inode %lu will…ointo %u\n",

3030 
i_´ev
->
i_šo
, 
šo_Ãxt
);

3031 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
i_´ev
, &
oc2
);

3032 ià(
”r
) {

3033 
	`mu‹x_uÆock
(&
sbi
->
s_Üphª_lock
);

3034 
out_b»l£
;

3036 
	`NEXT_ORPHAN
(
i_´ev
èğ
šo_Ãxt
;

3037 
”r
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
i_´ev
, &
oc2
);

3038 
	`mu‹x_uÆock
(&
sbi
->
s_Üphª_lock
);

3040 ià(
”r
)

3041 
out_b»l£
;

3042 
	`NEXT_ORPHAN
(
šode
) = 0;

3043 
”r
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

3044 
out_”r
:

3045 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”r
);

3046  
”r
;

3048 
out_b»l£
:

3049 
	`b»l£
(
oc
.
bh
);

3050 
out_”r
;

3051 
	}
}

3053 
	$ext4_rmdœ
(
šode
 *
dœ
, 
d’Œy
 *dentry)

3055 
»tv®
;

3056 
šode
 *inode;

3057 
bufãr_h—d
 *
bh
;

3058 
ext4_dœ_’Œy_2
 *
de
;

3059 
hªdË_t
 *
hªdË
 = 
NULL
;

3061 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
dœ
->
i_sb
))))

3062  -
EIO
;

3066 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

3067 ià(
»tv®
)

3068  
»tv®
;

3069 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
	`d_šode
(
d’Œy
));

3070 ià(
»tv®
)

3071  
»tv®
;

3073 
»tv®
 = -
ENOENT
;

3074 
bh
 = 
	`ext4_fšd_’Œy
(
dœ
, &
d’Œy
->
d_Çme
, &
de
, 
NULL
);

3075 ià(
	`IS_ERR
(
bh
))

3076  
	`PTR_ERR
(
bh
);

3077 ià(!
bh
)

3078 
’d_rmdœ
;

3080 
šode
 = 
	`d_šode
(
d’Œy
);

3082 
»tv®
 = -
EFSCORRUPTED
;

3083 ià(
	`Ë32_to_ıu
(
de
->
šode
è!ğšode->
i_šo
)

3084 
’d_rmdœ
;

3086 
»tv®
 = -
ENOTEMPTY
;

3087 ià(!
	`ext4_em±y_dœ
(
šode
))

3088 
’d_rmdœ
;

3090 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
dœ
, 
EXT4_HT_DIR
,

3091 
	`EXT4_DATA_TRANS_BLOCKS
(
dœ
->
i_sb
));

3092 ià(
	`IS_ERR
(
hªdË
)) {

3093 
»tv®
 = 
	`PTR_ERR
(
hªdË
);

3094 
hªdË
 = 
NULL
;

3095 
’d_rmdœ
;

3098 ià(
	`IS_DIRSYNC
(
dœ
))

3099 
	`ext4_hªdË_sync
(
hªdË
);

3101 
»tv®
 = 
	`ext4_d–‘e_’Œy
(
hªdË
, 
dœ
, 
de
, 
bh
);

3102 ià(
»tv®
)

3103 
’d_rmdœ
;

3104 ià(!
	`EXT4_DIR_LINK_EMPTY
(
šode
))

3105 
	`ext4_w¬nšg_šode
(
šode
,

3107 
d’Œy
->
d_Çme
.
Ën
, d’Œy->d_Çme.
Çme
,

3108 
šode
->
i_Æšk
);

3109 
	`šode_šc_iv”siÚ
(
šode
);

3110 
	`ş—r_Æšk
(
šode
);

3114 
šode
->
i_size
 = 0;

3115 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

3116 
šode
->
i_ùime
 = 
dœ
->i_ùimğdœ->
i_mtime
 = 
	`cu¼’t_time
(inode);

3117 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

3118 
	`ext4_dec_couÁ
(
hªdË
, 
dœ
);

3119 
	`ext4_upd©e_dx_æag
(
dœ
);

3120 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dœ
);

3122 #ifdeà
CONFIG_UNICODE


3129 ià(
	`IS_CASEFOLDED
(
dœ
))

3130 
	`d_šv®id©e
(
d’Œy
);

3133 
’d_rmdœ
:

3134 
	`b»l£
(
bh
);

3135 ià(
hªdË
)

3136 
	`ext4_jouº®_¡İ
(
hªdË
);

3137  
»tv®
;

3138 
	}
}

3140 
	$ext4_uÆšk
(
šode
 *
dœ
, 
d’Œy
 *dentry)

3142 
»tv®
;

3143 
šode
 *inode;

3144 
bufãr_h—d
 *
bh
;

3145 
ext4_dœ_’Œy_2
 *
de
;

3146 
hªdË_t
 *
hªdË
 = 
NULL
;

3148 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
dœ
->
i_sb
))))

3149  -
EIO
;

3151 
	`Œaû_ext4_uÆšk_’‹r
(
dœ
, 
d’Œy
);

3154 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

3155 ià(
»tv®
)

3156  
»tv®
;

3157 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
	`d_šode
(
d’Œy
));

3158 ià(
»tv®
)

3159  
»tv®
;

3161 
»tv®
 = -
ENOENT
;

3162 
bh
 = 
	`ext4_fšd_’Œy
(
dœ
, &
d’Œy
->
d_Çme
, &
de
, 
NULL
);

3163 ià(
	`IS_ERR
(
bh
))

3164  
	`PTR_ERR
(
bh
);

3165 ià(!
bh
)

3166 
’d_uÆšk
;

3168 
šode
 = 
	`d_šode
(
d’Œy
);

3170 
»tv®
 = -
EFSCORRUPTED
;

3171 ià(
	`Ë32_to_ıu
(
de
->
šode
è!ğšode->
i_šo
)

3172 
’d_uÆšk
;

3174 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
dœ
, 
EXT4_HT_DIR
,

3175 
	`EXT4_DATA_TRANS_BLOCKS
(
dœ
->
i_sb
));

3176 ià(
	`IS_ERR
(
hªdË
)) {

3177 
»tv®
 = 
	`PTR_ERR
(
hªdË
);

3178 
hªdË
 = 
NULL
;

3179 
’d_uÆšk
;

3182 ià(
	`IS_DIRSYNC
(
dœ
))

3183 
	`ext4_hªdË_sync
(
hªdË
);

3185 ià(
šode
->
i_Æšk
 == 0) {

3186 
	`ext4_w¬nšg_šode
(
šode
, "Deleting file '%.*s' with‚o†inks",

3187 
d’Œy
->
d_Çme
.
Ën
, d’Œy->d_Çme.
Çme
);

3188 
	`£t_Æšk
(
šode
, 1);

3190 
»tv®
 = 
	`ext4_d–‘e_’Œy
(
hªdË
, 
dœ
, 
de
, 
bh
);

3191 ià(
»tv®
)

3192 
’d_uÆšk
;

3193 
dœ
->
i_ùime
 = dœ->
i_mtime
 = 
	`cu¼’t_time
(dir);

3194 
	`ext4_upd©e_dx_æag
(
dœ
);

3195 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dœ
);

3196 
	`drİ_Æšk
(
šode
);

3197 ià(!
šode
->
i_Æšk
)

3198 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

3199 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

3200 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

3202 #ifdeà
CONFIG_UNICODE


3209 ià(
	`IS_CASEFOLDED
(
dœ
))

3210 
	`d_šv®id©e
(
d’Œy
);

3213 
’d_uÆšk
:

3214 
	`b»l£
(
bh
);

3215 ià(
hªdË
)

3216 
	`ext4_jouº®_¡İ
(
hªdË
);

3217 
	`Œaû_ext4_uÆšk_ex™
(
d’Œy
, 
»tv®
);

3218  
»tv®
;

3219 
	}
}

3221 
	$ext4_symlšk
(
šode
 *
dœ
,

3222 
d’Œy
 *d’Œy, cÚ¡ *
symÇme
)

3224 
hªdË_t
 *
hªdË
;

3225 
šode
 *inode;

3226 
”r
, 
Ën
 = 
	`¡¾’
(
symÇme
);

3227 
üed™s
;

3228 
fsüy±_¡r
 
disk_lšk
;

3230 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
dœ
->
i_sb
))))

3231  -
EIO
;

3233 
”r
 = 
	`fsüy±_´•¬e_symlšk
(
dœ
, 
symÇme
, 
Ën
, dœ->
i_sb
->
s_blocksize
,

3234 &
disk_lšk
);

3235 ià(
”r
)

3236  
”r
;

3238 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

3239 ià(
”r
)

3240  
”r
;

3242 ià((
disk_lšk
.
Ën
 > 
EXT4_N_BLOCKS
 * 4)) {

3249 
üed™s
 = 4 + 
	`EXT4_MAXQUOTAS_INIT_BLOCKS
(
dœ
->
i_sb
) +

3250 
EXT4_XATTR_TRANS_BLOCKS
;

3258 
üed™s
 = 
	`EXT4_DATA_TRANS_BLOCKS
(
dœ
->
i_sb
) +

3259 
EXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3;

3262 
šode
 = 
	`ext4_Ãw_šode_¡¬t_hªdË
(
dœ
, 
S_IFLNK
|
S_IRWXUGO
,

3263 &
d’Œy
->
d_Çme
, 0, 
NULL
,

3264 
EXT4_HT_DIR
, 
üed™s
);

3265 
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

3266 ià(
	`IS_ERR
(
šode
)) {

3267 ià(
hªdË
)

3268 
	`ext4_jouº®_¡İ
(
hªdË
);

3269  
	`PTR_ERR
(
šode
);

3272 ià(
	`IS_ENCRYPTED
(
šode
)) {

3273 
”r
 = 
	`fsüy±_’üy±_symlšk
(
šode
, 
symÇme
, 
Ën
, &
disk_lšk
);

3274 ià(
”r
)

3275 
”r_drİ_šode
;

3276 
šode
->
i_İ
 = &
ext4_’üy±ed_symlšk_šode_İ”©iÚs
;

3279 ià((
disk_lšk
.
Ën
 > 
EXT4_N_BLOCKS
 * 4)) {

3280 ià(!
	`IS_ENCRYPTED
(
šode
))

3281 
šode
->
i_İ
 = &
ext4_symlšk_šode_İ”©iÚs
;

3282 
	`šode_nohighmem
(
šode
);

3283 
	`ext4_£t_aİs
(
šode
);

3294 
	`drİ_Æšk
(
šode
);

3295 
”r
 = 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

3296 
	`ext4_jouº®_¡İ
(
hªdË
);

3297 
hªdË
 = 
NULL
;

3298 ià(
”r
)

3299 
”r_drİ_šode
;

3300 
”r
 = 
	`__·ge_symlšk
(
šode
, 
disk_lšk
.
Çme
, disk_lšk.
Ën
, 1);

3301 ià(
”r
)

3302 
”r_drİ_šode
;

3307 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
dœ
, 
EXT4_HT_DIR
,

3308 
	`EXT4_DATA_TRANS_BLOCKS
(
dœ
->
i_sb
) +

3309 
EXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 1);

3310 ià(
	`IS_ERR
(
hªdË
)) {

3311 
”r
 = 
	`PTR_ERR
(
hªdË
);

3312 
hªdË
 = 
NULL
;

3313 
”r_drİ_šode
;

3315 
	`£t_Æšk
(
šode
, 1);

3316 
”r
 = 
	`ext4_Üphª_d–
(
hªdË
, 
šode
);

3317 ià(
”r
)

3318 
”r_drİ_šode
;

3321 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
);

3322 ià(!
	`IS_ENCRYPTED
(
šode
)) {

3323 
šode
->
i_İ
 = &
ext4_ç¡_symlšk_šode_İ”©iÚs
;

3324 
šode
->
i_lšk
 = (*)&
	`EXT4_I
(šode)->
i_d©a
;

3326 
	`memıy
((*)&
	`EXT4_I
(
šode
)->
i_d©a
, 
disk_lšk
.
Çme
,

3327 
disk_lšk
.
Ën
);

3328 
šode
->
i_size
 = 
disk_lšk
.
Ën
 - 1;

3330 
	`EXT4_I
(
šode
)->
i_disksize
 = inode->
i_size
;

3331 
”r
 = 
	`ext4_add_nÚdœ
(
hªdË
, 
d’Œy
, 
šode
);

3332 ià(!
”r
 && 
	`IS_DIRSYNC
(
dœ
))

3333 
	`ext4_hªdË_sync
(
hªdË
);

3335 ià(
hªdË
)

3336 
	`ext4_jouº®_¡İ
(
hªdË
);

3337 
out_ä“_’üy±ed_lšk
;

3339 
”r_drİ_šode
:

3340 ià(
hªdË
)

3341 
	`ext4_jouº®_¡İ
(
hªdË
);

3342 
	`ş—r_Æšk
(
šode
);

3343 
	`uÆock_Ãw_šode
(
šode
);

3344 
	`ut
(
šode
);

3345 
out_ä“_’üy±ed_lšk
:

3346 ià(
disk_lšk
.
Çme
 !ğ(*)
symÇme
)

3347 
	`kä“
(
disk_lšk
.
Çme
);

3348  
”r
;

3349 
	}
}

3351 
	$ext4_lšk
(
d’Œy
 *
Şd_d’Œy
,

3352 
šode
 *
dœ
, 
d’Œy
 *dentry)

3354 
hªdË_t
 *
hªdË
;

3355 
šode
 *šodğ
	`d_šode
(
Şd_d’Œy
);

3356 
”r
, 
»Œ›s
 = 0;

3358 ià(
šode
->
i_Æšk
 >ğ
EXT4_LINK_MAX
)

3359  -
EMLINK
;

3361 
”r
 = 
	`fsüy±_´•¬e_lšk
(
Şd_d’Œy
, 
dœ
, 
d’Œy
);

3362 ià(
”r
)

3363  
”r
;

3365 ià((
	`ext4_‹¡_šode_æag
(
dœ
, 
EXT4_INODE_PROJINHERIT
)) &&

3366 (!
	`´ojid_eq
(
	`EXT4_I
(
dœ
)->
i_´ojid
,

3367 
	`EXT4_I
(
Şd_d’Œy
->
d_šode
)->
i_´ojid
)))

3368  -
EXDEV
;

3370 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

3371 ià(
”r
)

3372  
”r
;

3374 
»Œy
:

3375 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
dœ
, 
EXT4_HT_DIR
,

3376 (
	`EXT4_DATA_TRANS_BLOCKS
(
dœ
->
i_sb
) +

3377 
EXT4_INDEX_EXTRA_TRANS_BLOCKS
) + 1);

3378 ià(
	`IS_ERR
(
hªdË
))

3379  
	`PTR_ERR
(
hªdË
);

3381 ià(
	`IS_DIRSYNC
(
dœ
))

3382 
	`ext4_hªdË_sync
(
hªdË
);

3384 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

3385 
	`ext4_šc_couÁ
(
hªdË
, 
šode
);

3386 
	`ihŞd
(
šode
);

3388 
”r
 = 
	`ext4_add_’Œy
(
hªdË
, 
d’Œy
, 
šode
);

3389 ià(!
”r
) {

3390 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

3394 ià(
šode
->
i_Æšk
 == 1)

3395 
	`ext4_Üphª_d–
(
hªdË
, 
šode
);

3396 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

3398 
	`drİ_Æšk
(
šode
);

3399 
	`ut
(
šode
);

3401 
	`ext4_jouº®_¡İ
(
hªdË
);

3402 ià(
”r
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
dœ
->
i_sb
, &
»Œ›s
))

3403 
»Œy
;

3404  
”r
;

3405 
	}
}

3413 
bufãr_h—d
 *
	$ext4_g‘_fœ¡_dœ_block
(
hªdË_t
 *
hªdË
,

3414 
šode
 *inode,

3415 *
»tv®
,

3416 
ext4_dœ_’Œy_2
 **
·»Á_de
,

3417 *
šlšed
)

3419 
bufãr_h—d
 *
bh
;

3421 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

3425 
bh
 = 
	`ext4_»ad_dœblock
(
šode
, 0, 
DIRENT_HTREE
);

3426 ià(
	`IS_ERR
(
bh
)) {

3427 *
»tv®
 = 
	`PTR_ERR
(
bh
);

3428  
NULL
;

3430 *
·»Á_de
 = 
	`ext4_Ãxt_’Œy
(

3431 (
ext4_dœ_’Œy_2
 *)
bh
->
b_d©a
,

3432 
šode
->
i_sb
->
s_blocksize
);

3433  
bh
;

3436 *
šlšed
 = 1;

3437  
	`ext4_g‘_fœ¡_šlše_block
(
šode
, 
·»Á_de
, 
»tv®
);

3438 
	}
}

3440 
	sext4_»Çm’t
 {

3441 
šode
 *
	mdœ
;

3442 
d’Œy
 *
	md’Œy
;

3443 
šode
 *
	mšode
;

3444 
boŞ
 
	mis_dœ
;

3445 
	mdœ_Æšk_d–
;

3448 
bufãr_h—d
 *
	mbh
;

3449 
ext4_dœ_’Œy_2
 *
	mde
;

3450 
	mšlšed
;

3453 
bufãr_h—d
 *
	mdœ_bh
;

3454 
ext4_dœ_’Œy_2
 *
	m·»Á_de
;

3455 
	mdœ_šlšed
;

3458 
	$ext4_»Çme_dœ_´•¬e
(
hªdË_t
 *
hªdË
, 
ext4_»Çm’t
 *
’t
)

3460 
»tv®
;

3462 
’t
->
dœ_bh
 = 
	`ext4_g‘_fœ¡_dœ_block
(
hªdË
,ƒÁ->
šode
,

3463 &
»tv®
, &
’t
->
·»Á_de
,

3464 &
’t
->
dœ_šlšed
);

3465 ià(!
’t
->
dœ_bh
)

3466  
»tv®
;

3467 ià(
	`Ë32_to_ıu
(
’t
->
·»Á_de
->
šode
è!ğ’t->
dœ
->
i_šo
)

3468  -
EFSCORRUPTED
;

3469 
	`BUFFER_TRACE
(
’t
->
dœ_bh
, "get_write_access");

3470  
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
’t
->
dœ_bh
);

3471 
	}
}

3473 
	$ext4_»Çme_dœ_fšish
(
hªdË_t
 *
hªdË
, 
ext4_»Çm’t
 *
’t
,

3474 
dœ_šo
)

3476 
»tv®
;

3478 
’t
->
·»Á_de
->
šode
 = 
	`ıu_to_Ë32
(
dœ_šo
);

3479 
	`BUFFER_TRACE
(
’t
->
dœ_bh
, "callƒxt4_handle_dirty_metadata");

3480 ià(!
’t
->
dœ_šlšed
) {

3481 ià(
	`is_dx
(
’t
->
šode
)) {

3482 
»tv®
 = 
	`ext4_hªdË_dœty_dx_node
(
hªdË
,

3483 
’t
->
šode
,

3484 
’t
->
dœ_bh
);

3486 
»tv®
 = 
	`ext4_hªdË_dœty_dœblock
(
hªdË
, 
’t
->
šode
,

3487 
’t
->
dœ_bh
);

3490 
»tv®
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
’t
->
šode
);

3492 ià(
»tv®
) {

3493 
	`ext4_¡d_”rÜ
(
’t
->
dœ
->
i_sb
, 
»tv®
);

3494  
»tv®
;

3497 
	}
}

3499 
	$ext4_£‹Á
(
hªdË_t
 *
hªdË
, 
ext4_»Çm’t
 *
’t
,

3500 
šo
, 
fe_ty³
)

3502 
»tv®
;

3504 
	`BUFFER_TRACE
(
’t
->
bh
, "get write‡ccess");

3505 
»tv®
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
’t
->
bh
);

3506 ià(
»tv®
)

3507  
»tv®
;

3508 
’t
->
de
->
šode
 = 
	`ıu_to_Ë32
(
šo
);

3509 ià(
	`ext4_has_ã©u»_f‘y³
(
’t
->
dœ
->
i_sb
))

3510 
’t
->
de
->
fe_ty³
 = file_type;

3511 
	`šode_šc_iv”siÚ
(
’t
->
dœ
);

3512 
’t
->
dœ
->
i_ùime
 =ƒÁ->dœ->
i_mtime
 =

3513 
	`cu¼’t_time
(
’t
->
dœ
);

3514 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
’t
->
dœ
);

3515 
	`BUFFER_TRACE
(
’t
->
bh
, "callƒxt4_handle_dirty_metadata");

3516 ià(!
’t
->
šlšed
) {

3517 
»tv®
 = 
	`ext4_hªdË_dœty_dœblock
(
hªdË
, 
’t
->
dœ
,ƒÁ->
bh
);

3518 ià(
	`uÆik–y
(
»tv®
)) {

3519 
	`ext4_¡d_”rÜ
(
’t
->
dœ
->
i_sb
, 
»tv®
);

3520  
»tv®
;

3523 
	`b»l£
(
’t
->
bh
);

3524 
’t
->
bh
 = 
NULL
;

3527 
	}
}

3529 
	$ext4_fšd_d–‘e_’Œy
(
hªdË_t
 *
hªdË
, 
šode
 *
dœ
,

3530 cÚ¡ 
q¡r
 *
d_Çme
)

3532 
»tv®
 = -
ENOENT
;

3533 
bufãr_h—d
 *
bh
;

3534 
ext4_dœ_’Œy_2
 *
de
;

3536 
bh
 = 
	`ext4_fšd_’Œy
(
dœ
, 
d_Çme
, &
de
, 
NULL
);

3537 ià(
	`IS_ERR
(
bh
))

3538  
	`PTR_ERR
(
bh
);

3539 ià(
bh
) {

3540 
»tv®
 = 
	`ext4_d–‘e_’Œy
(
hªdË
, 
dœ
, 
de
, 
bh
);

3541 
	`b»l£
(
bh
);

3543  
»tv®
;

3544 
	}
}

3546 
	$ext4_»Çme_d–‘e
(
hªdË_t
 *
hªdË
, 
ext4_»Çm’t
 *
’t
,

3547 
fÜû_»»ad
)

3549 
»tv®
;

3556 ià(
	`Ë32_to_ıu
(
’t
->
de
->
šode
è!ğ’t->šode->
i_šo
 ||

3557 
’t
->
de
->
Çme_Ën
 !ğ’t->
d’Œy
->
d_Çme
.
Ën
 ||

3558 
	`¡ºcmp
(
’t
->
de
->
Çme
,ƒÁ->
d’Œy
->
d_Çme
.name,

3559 
’t
->
de
->
Çme_Ën
) ||

3560 
fÜû_»»ad
) {

3561 
»tv®
 = 
	`ext4_fšd_d–‘e_’Œy
(
hªdË
, 
’t
->
dœ
,

3562 &
’t
->
d’Œy
->
d_Çme
);

3564 
»tv®
 = 
	`ext4_d–‘e_’Œy
(
hªdË
, 
’t
->
dœ
,ƒÁ->
de
,ƒÁ->
bh
);

3565 ià(
»tv®
 =ğ-
ENOENT
) {

3566 
»tv®
 = 
	`ext4_fšd_d–‘e_’Œy
(
hªdË
, 
’t
->
dœ
,

3567 &
’t
->
d’Œy
->
d_Çme
);

3571 ià(
»tv®
) {

3572 
	`ext4_w¬nšg_šode
(
’t
->
dœ
,

3574 
’t
->
dœ
->
i_Æšk
, 
»tv®
);

3576 
	}
}

3578 
	$ext4_upd©e_dœ_couÁ
(
hªdË_t
 *
hªdË
, 
ext4_»Çm’t
 *
’t
)

3580 ià(
’t
->
dœ_Æšk_d–
) {

3581 ià(
’t
->
dœ_Æšk_d–
 == -1)

3582 
	`ext4_dec_couÁ
(
hªdË
, 
’t
->
dœ
);

3584 
	`ext4_šc_couÁ
(
hªdË
, 
’t
->
dœ
);

3585 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
’t
->
dœ
);

3587 
	}
}

3589 
šode
 *
	$ext4_wh™eout_fÜ_»Çme
(
ext4_»Çm’t
 *
’t
,

3590 
üed™s
, 
hªdË_t
 **
h
)

3592 
šode
 *
wh
;

3593 
hªdË_t
 *
hªdË
;

3594 
»Œ›s
 = 0;

3600 
üed™s
 +ğ(
	`EXT4_MAXQUOTAS_TRANS_BLOCKS
(
’t
->
dœ
->
i_sb
) +

3601 
EXT4_XATTR_TRANS_BLOCKS
 + 4);

3602 
»Œy
:

3603 
wh
 = 
	`ext4_Ãw_šode_¡¬t_hªdË
(
’t
->
dœ
, 
S_IFCHR
 | 
WHITEOUT_MODE
,

3604 &
’t
->
d’Œy
->
d_Çme
, 0, 
NULL
,

3605 
EXT4_HT_DIR
, 
üed™s
);

3607 
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

3608 ià(
	`IS_ERR
(
wh
)) {

3609 ià(
hªdË
)

3610 
	`ext4_jouº®_¡İ
(
hªdË
);

3611 ià(
	`PTR_ERR
(
wh
è=ğ-
ENOSPC
 &&

3612 
	`ext4_should_»Œy_®loc
(
’t
->
dœ
->
i_sb
, &
»Œ›s
))

3613 
»Œy
;

3615 *
h
 = 
hªdË
;

3616 
	`š™_¥ecŸl_šode
(
wh
, wh->
i_mode
, 
WHITEOUT_DEV
);

3617 
wh
->
i_İ
 = &
ext4_¥ecŸl_šode_İ”©iÚs
;

3619  
wh
;

3620 
	}
}

3630 
	$ext4_»Çme
(
šode
 *
Şd_dœ
, 
d’Œy
 *
Şd_d’Œy
,

3631 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
,

3632 
æags
)

3634 
hªdË_t
 *
hªdË
 = 
NULL
;

3635 
ext4_»Çm’t
 
Şd
 = {

3636 .
dœ
 = 
Şd_dœ
,

3637 .
d’Œy
 = 
Şd_d’Œy
,

3638 .
šode
 = 
	`d_šode
(
Şd_d’Œy
),

3640 
ext4_»Çm’t
 
Ãw
 = {

3641 .
dœ
 = 
Ãw_dœ
,

3642 .
d’Œy
 = 
Ãw_d’Œy
,

3643 .
šode
 = 
	`d_šode
(
Ãw_d’Œy
),

3645 
fÜû_»»ad
;

3646 
»tv®
;

3647 
šode
 *
wh™eout
 = 
NULL
;

3648 
üed™s
;

3649 
u8
 
Şd_fe_ty³
;

3651 ià(
Ãw
.
šode
 &&‚ew.šode->
i_Æšk
 == 0) {

3652 
	`EXT4_ERROR_INODE
(
Ãw
.
šode
,

3654  -
EFSCORRUPTED
;

3657 ià((
	`ext4_‹¡_šode_æag
(
Ãw_dœ
, 
EXT4_INODE_PROJINHERIT
)) &&

3658 (!
	`´ojid_eq
(
	`EXT4_I
(
Ãw_dœ
)->
i_´ojid
,

3659 
	`EXT4_I
(
Şd_d’Œy
->
d_šode
)->
i_´ojid
)))

3660  -
EXDEV
;

3662 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
Şd
.
dœ
);

3663 ià(
»tv®
)

3664  
»tv®
;

3665 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
Ãw
.
dœ
);

3666 ià(
»tv®
)

3667  
»tv®
;

3671 ià(
Ãw
.
šode
) {

3672 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
Ãw
.
šode
);

3673 ià(
»tv®
)

3674  
»tv®
;

3677 
Şd
.
bh
 = 
	`ext4_fšd_’Œy
(Şd.
dœ
, &Şd.
d’Œy
->
d_Çme
, &Şd.
de
, 
NULL
);

3678 ià(
	`IS_ERR
(
Şd
.
bh
))

3679  
	`PTR_ERR
(
Şd
.
bh
);

3686 
»tv®
 = -
ENOENT
;

3687 ià(!
Şd
.
bh
 || 
	`Ë32_to_ıu
(Şd.
de
->
šode
è!ğŞd.šode->
i_šo
)

3688 
’d_»Çme
;

3690 
Ãw
.
bh
 = 
	`ext4_fšd_’Œy
Òew.
dœ
, &Ãw.
d’Œy
->
d_Çme
,

3691 &
Ãw
.
de
, &Ãw.
šlšed
);

3692 ià(
	`IS_ERR
(
Ãw
.
bh
)) {

3693 
»tv®
 = 
	`PTR_ERR
(
Ãw
.
bh
);

3694 
Ãw
.
bh
 = 
NULL
;

3695 
’d_»Çme
;

3697 ià(
Ãw
.
bh
) {

3698 ià(!
Ãw
.
šode
) {

3699 
	`b»l£
(
Ãw
.
bh
);

3700 
Ãw
.
bh
 = 
NULL
;

3703 ià(
Ãw
.
šode
 && !
	`‹¡_İt
Òew.
dœ
->
i_sb
, 
NO_AUTO_DA_ALLOC
))

3704 
	`ext4_®loc_da_blocks
(
Şd
.
šode
);

3706 
üed™s
 = (2 * 
	`EXT4_DATA_TRANS_BLOCKS
(
Şd
.
dœ
->
i_sb
) +

3707 
EXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 2);

3708 ià(!(
æags
 & 
RENAME_WHITEOUT
)) {

3709 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
Şd
.
dœ
, 
EXT4_HT_DIR
, 
üed™s
);

3710 ià(
	`IS_ERR
(
hªdË
)) {

3711 
»tv®
 = 
	`PTR_ERR
(
hªdË
);

3712 
hªdË
 = 
NULL
;

3713 
’d_»Çme
;

3716 
wh™eout
 = 
	`ext4_wh™eout_fÜ_»Çme
(&
Şd
, 
üed™s
, &
hªdË
);

3717 ià(
	`IS_ERR
(
wh™eout
)) {

3718 
»tv®
 = 
	`PTR_ERR
(
wh™eout
);

3719 
wh™eout
 = 
NULL
;

3720 
’d_»Çme
;

3724 ià(
	`IS_DIRSYNC
(
Şd
.
dœ
è|| IS_DIRSYNC(
Ãw
.dir))

3725 
	`ext4_hªdË_sync
(
hªdË
);

3727 ià(
	`S_ISDIR
(
Şd
.
šode
->
i_mode
)) {

3728 ià(
Ãw
.
šode
) {

3729 
»tv®
 = -
ENOTEMPTY
;

3730 ià(!
	`ext4_em±y_dœ
(
Ãw
.
šode
))

3731 
’d_»Çme
;

3733 
»tv®
 = -
EMLINK
;

3734 ià(
Ãw
.
dœ
 !ğ
Şd
.dœ && 
	`EXT4_DIR_LINK_MAX
(new.dir))

3735 
’d_»Çme
;

3737 
»tv®
 = 
	`ext4_»Çme_dœ_´•¬e
(
hªdË
, &
Şd
);

3738 ià(
»tv®
)

3739 
’d_»Çme
;

3748 
fÜû_»»ad
 = (
Ãw
.
dœ
->
i_šo
 =ğ
Şd
.dir->i_ino &&

3749 
	`ext4_‹¡_šode_æag
(
Ãw
.
dœ
, 
EXT4_INODE_INLINE_DATA
));

3751 
Şd_fe_ty³
 = 
Şd
.
de
->
fe_ty³
;

3752 ià(
wh™eout
) {

3757 
»tv®
 = 
	`ext4_£‹Á
(
hªdË
, &
Şd
, 
wh™eout
->
i_šo
,

3758 
EXT4_FT_CHRDEV
);

3759 ià(
»tv®
)

3760 
’d_»Çme
;

3761 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
wh™eout
);

3763 ià(!
Ãw
.
bh
) {

3764 
»tv®
 = 
	`ext4_add_’Œy
(
hªdË
, 
Ãw
.
d’Œy
, 
Şd
.
šode
);

3765 ià(
»tv®
)

3766 
’d_»Çme
;

3768 
»tv®
 = 
	`ext4_£‹Á
(
hªdË
, &
Ãw
,

3769 
Şd
.
šode
->
i_šo
, 
Şd_fe_ty³
);

3770 ià(
»tv®
)

3771 
’d_»Çme
;

3773 ià(
fÜû_»»ad
)

3774 
fÜû_»»ad
 = !
	`ext4_‹¡_šode_æag
(
Ãw
.
dœ
,

3775 
EXT4_INODE_INLINE_DATA
);

3781 
Şd
.
šode
->
i_ùime
 = 
	`cu¼’t_time
(old.inode);

3782 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
Şd
.
šode
);

3784 ià(!
wh™eout
) {

3788 
	`ext4_»Çme_d–‘e
(
hªdË
, &
Şd
, 
fÜû_»»ad
);

3791 ià(
Ãw
.
šode
) {

3792 
	`ext4_dec_couÁ
(
hªdË
, 
Ãw
.
šode
);

3793 
Ãw
.
šode
->
i_ùime
 = 
	`cu¼’t_time
(new.inode);

3795 
Şd
.
dœ
->
i_ùime
 = old.dœ->
i_mtime
 = 
	`cu¼’t_time
(old.dir);

3796 
	`ext4_upd©e_dx_æag
(
Şd
.
dœ
);

3797 ià(
Şd
.
dœ_bh
) {

3798 
»tv®
 = 
	`ext4_»Çme_dœ_fšish
(
hªdË
, &
Şd
, 
Ãw
.
dœ
->
i_šo
);

3799 ià(
»tv®
)

3800 
’d_»Çme
;

3802 
	`ext4_dec_couÁ
(
hªdË
, 
Şd
.
dœ
);

3803 ià(
Ãw
.
šode
) {

3807 
	`ş—r_Æšk
(
Ãw
.
šode
);

3809 
	`ext4_šc_couÁ
(
hªdË
, 
Ãw
.
dœ
);

3810 
	`ext4_upd©e_dx_æag
(
Ãw
.
dœ
);

3811 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
Ãw
.
dœ
);

3814 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
Şd
.
dœ
);

3815 ià(
Ãw
.
šode
) {

3816 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
Ãw
.
šode
);

3817 ià(!
Ãw
.
šode
->
i_Æšk
)

3818 
	`ext4_Üphª_add
(
hªdË
, 
Ãw
.
šode
);

3820 
»tv®
 = 0;

3822 
’d_»Çme
:

3823 
	`b»l£
(
Şd
.
dœ_bh
);

3824 
	`b»l£
(
Şd
.
bh
);

3825 
	`b»l£
(
Ãw
.
bh
);

3826 ià(
wh™eout
) {

3827 ià(
»tv®
)

3828 
	`drİ_Æšk
(
wh™eout
);

3829 
	`uÆock_Ãw_šode
(
wh™eout
);

3830 
	`ut
(
wh™eout
);

3832 ià(
hªdË
)

3833 
	`ext4_jouº®_¡İ
(
hªdË
);

3834  
»tv®
;

3835 
	}
}

3837 
	$ext4_üoss_»Çme
(
šode
 *
Şd_dœ
, 
d’Œy
 *
Şd_d’Œy
,

3838 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
)

3840 
hªdË_t
 *
hªdË
 = 
NULL
;

3841 
ext4_»Çm’t
 
Şd
 = {

3842 .
dœ
 = 
Şd_dœ
,

3843 .
d’Œy
 = 
Şd_d’Œy
,

3844 .
šode
 = 
	`d_šode
(
Şd_d’Œy
),

3846 
ext4_»Çm’t
 
Ãw
 = {

3847 .
dœ
 = 
Ãw_dœ
,

3848 .
d’Œy
 = 
Ãw_d’Œy
,

3849 .
šode
 = 
	`d_šode
(
Ãw_d’Œy
),

3851 
u8
 
Ãw_fe_ty³
;

3852 
»tv®
;

3853 
time¥ec64
 
ùime
;

3855 ià((
	`ext4_‹¡_šode_æag
(
Ãw_dœ
, 
EXT4_INODE_PROJINHERIT
) &&

3856 !
	`´ojid_eq
(
	`EXT4_I
(
Ãw_dœ
)->
i_´ojid
,

3857 
	`EXT4_I
(
Şd_d’Œy
->
d_šode
)->
i_´ojid
)) ||

3858 (
	`ext4_‹¡_šode_æag
(
Şd_dœ
, 
EXT4_INODE_PROJINHERIT
) &&

3859 !
	`´ojid_eq
(
	`EXT4_I
(
Şd_dœ
)->
i_´ojid
,

3860 
	`EXT4_I
(
Ãw_d’Œy
->
d_šode
)->
i_´ojid
)))

3861  -
EXDEV
;

3863 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
Şd
.
dœ
);

3864 ià(
»tv®
)

3865  
»tv®
;

3866 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
Ãw
.
dœ
);

3867 ià(
»tv®
)

3868  
»tv®
;

3870 
Şd
.
bh
 = 
	`ext4_fšd_’Œy
(Şd.
dœ
, &Şd.
d’Œy
->
d_Çme
,

3871 &
Şd
.
de
, &Şd.
šlšed
);

3872 ià(
	`IS_ERR
(
Şd
.
bh
))

3873  
	`PTR_ERR
(
Şd
.
bh
);

3880 
»tv®
 = -
ENOENT
;

3881 ià(!
Şd
.
bh
 || 
	`Ë32_to_ıu
(Şd.
de
->
šode
è!ğŞd.šode->
i_šo
)

3882 
’d_»Çme
;

3884 
Ãw
.
bh
 = 
	`ext4_fšd_’Œy
Òew.
dœ
, &Ãw.
d’Œy
->
d_Çme
,

3885 &
Ãw
.
de
, &Ãw.
šlšed
);

3886 ià(
	`IS_ERR
(
Ãw
.
bh
)) {

3887 
»tv®
 = 
	`PTR_ERR
(
Ãw
.
bh
);

3888 
Ãw
.
bh
 = 
NULL
;

3889 
’d_»Çme
;

3893 ià(!
Ãw
.
bh
 || 
	`Ë32_to_ıu
Òew.
de
->
šode
è!ğÃw.šode->
i_šo
)

3894 
’d_»Çme
;

3896 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
Şd
.
dœ
, 
EXT4_HT_DIR
,

3897 (2 * 
	`EXT4_DATA_TRANS_BLOCKS
(
Şd
.
dœ
->
i_sb
) +

3898 2 * 
EXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 2));

3899 ià(
	`IS_ERR
(
hªdË
)) {

3900 
»tv®
 = 
	`PTR_ERR
(
hªdË
);

3901 
hªdË
 = 
NULL
;

3902 
’d_»Çme
;

3905 ià(
	`IS_DIRSYNC
(
Şd
.
dœ
è|| IS_DIRSYNC(
Ãw
.dir))

3906 
	`ext4_hªdË_sync
(
hªdË
);

3908 ià(
	`S_ISDIR
(
Şd
.
šode
->
i_mode
)) {

3909 
Şd
.
is_dœ
 = 
Œue
;

3910 
»tv®
 = 
	`ext4_»Çme_dœ_´•¬e
(
hªdË
, &
Şd
);

3911 ià(
»tv®
)

3912 
’d_»Çme
;

3914 ià(
	`S_ISDIR
(
Ãw
.
šode
->
i_mode
)) {

3915 
Ãw
.
is_dœ
 = 
Œue
;

3916 
»tv®
 = 
	`ext4_»Çme_dœ_´•¬e
(
hªdË
, &
Ãw
);

3917 ià(
»tv®
)

3918 
’d_»Çme
;

3925 ià(
Şd
.
dœ
 !ğ
Ãw
.dœ && old.
is_dœ
 !=‚ew.is_dir) {

3926 
Şd
.
dœ_Æšk_d–
 = old.
is_dœ
 ? -1 : 1;

3927 
Ãw
.
dœ_Æšk_d–
 = -
Şd
.dir_nlink_delta;

3928 
»tv®
 = -
EMLINK
;

3929 ià((
Şd
.
dœ_Æšk_d–
 > 0 && 
	`EXT4_DIR_LINK_MAX
(Şd.
dœ
)) ||

3930 (
Ãw
.
dœ_Æšk_d–
 > 0 && 
	`EXT4_DIR_LINK_MAX
Òew.
dœ
)))

3931 
’d_»Çme
;

3934 
Ãw_fe_ty³
 = 
Ãw
.
de
->
fe_ty³
;

3935 
»tv®
 = 
	`ext4_£‹Á
(
hªdË
, &
Ãw
, 
Şd
.
šode
->
i_šo
, old.
de
->
fe_ty³
);

3936 ià(
»tv®
)

3937 
’d_»Çme
;

3939 
»tv®
 = 
	`ext4_£‹Á
(
hªdË
, &
Şd
, 
Ãw
.
šode
->
i_šo
, 
Ãw_fe_ty³
);

3940 ià(
»tv®
)

3941 
’d_»Çme
;

3947 
ùime
 = 
	`cu¼’t_time
(
Şd
.
šode
);

3948 
Şd
.
šode
->
i_ùime
 = 
ùime
;

3949 
Ãw
.
šode
->
i_ùime
 = 
ùime
;

3950 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
Şd
.
šode
);

3951 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
Ãw
.
šode
);

3953 ià(
Şd
.
dœ_bh
) {

3954 
»tv®
 = 
	`ext4_»Çme_dœ_fšish
(
hªdË
, &
Şd
, 
Ãw
.
dœ
->
i_šo
);

3955 ià(
»tv®
)

3956 
’d_»Çme
;

3958 ià(
Ãw
.
dœ_bh
) {

3959 
»tv®
 = 
	`ext4_»Çme_dœ_fšish
(
hªdË
, &
Ãw
, 
Şd
.
dœ
->
i_šo
);

3960 ià(
»tv®
)

3961 
’d_»Çme
;

3963 
	`ext4_upd©e_dœ_couÁ
(
hªdË
, &
Şd
);

3964 
	`ext4_upd©e_dœ_couÁ
(
hªdË
, &
Ãw
);

3965 
»tv®
 = 0;

3967 
’d_»Çme
:

3968 
	`b»l£
(
Şd
.
dœ_bh
);

3969 
	`b»l£
(
Ãw
.
dœ_bh
);

3970 
	`b»l£
(
Şd
.
bh
);

3971 
	`b»l£
(
Ãw
.
bh
);

3972 ià(
hªdË
)

3973 
	`ext4_jouº®_¡İ
(
hªdË
);

3974  
»tv®
;

3975 
	}
}

3977 
	$ext4_»Çme2
(
šode
 *
Şd_dœ
, 
d’Œy
 *
Şd_d’Œy
,

3978 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
,

3979 
æags
)

3981 
”r
;

3983 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
Şd_dœ
->
i_sb
))))

3984  -
EIO
;

3986 ià(
æags
 & ~(
RENAME_NOREPLACE
 | 
RENAME_EXCHANGE
 | 
RENAME_WHITEOUT
))

3987  -
EINVAL
;

3989 
”r
 = 
	`fsüy±_´•¬e_»Çme
(
Şd_dœ
, 
Şd_d’Œy
, 
Ãw_dœ
, 
Ãw_d’Œy
,

3990 
æags
);

3991 ià(
”r
)

3992  
”r
;

3994 ià(
æags
 & 
RENAME_EXCHANGE
) {

3995  
	`ext4_üoss_»Çme
(
Şd_dœ
, 
Şd_d’Œy
,

3996 
Ãw_dœ
, 
Ãw_d’Œy
);

3999  
	`ext4_»Çme
(
Şd_dœ
, 
Şd_d’Œy
, 
Ãw_dœ
, 
Ãw_d’Œy
, 
æags
);

4000 
	}
}

4005 cÚ¡ 
šode_İ”©iÚs
 
	gext4_dœ_šode_İ”©iÚs
 = {

4006 .
ü—‹
 = 
ext4_ü—‹
,

4007 .
	glookup
 = 
ext4_lookup
,

4008 .
	glšk
 = 
ext4_lšk
,

4009 .
	guÆšk
 = 
ext4_uÆšk
,

4010 .
	gsymlšk
 = 
ext4_symlšk
,

4011 .
	gmkdœ
 = 
ext4_mkdœ
,

4012 .
	grmdœ
 = 
ext4_rmdœ
,

4013 .
	gmknod
 = 
ext4_mknod
,

4014 .
	gtmpfe
 = 
ext4_tmpfe
,

4015 .
	g»Çme
 = 
ext4_»Çme2
,

4016 .
	g£‰r
 = 
ext4_£‰r
,

4017 .
	gg‘©Œ
 = 
ext4_g‘©Œ
,

4018 .
	gli¡x©Œ
 = 
ext4_li¡x©Œ
,

4019 .
	gg‘_aş
 = 
ext4_g‘_aş
,

4020 .
	g£t_aş
 = 
ext4_£t_aş
,

4021 .
	gf›m­
 = 
ext4_f›m­
,

4024 cÚ¡ 
šode_İ”©iÚs
 
	gext4_¥ecŸl_šode_İ”©iÚs
 = {

4025 .
£‰r
 = 
ext4_£‰r
,

4026 .
	gg‘©Œ
 = 
ext4_g‘©Œ
,

4027 .
	gli¡x©Œ
 = 
ext4_li¡x©Œ
,

4028 .
	gg‘_aş
 = 
ext4_g‘_aş
,

4029 .
	g£t_aş
 = 
ext4_£t_aş
,

	@pxt4/page-io.c

10 
	~<lšux/fs.h
>

11 
	~<lšux/time.h
>

12 
	~<lšux/highuid.h
>

13 
	~<lšux/·gem­.h
>

14 
	~<lšux/quÙaİs.h
>

15 
	~<lšux/¡ršg.h
>

16 
	~<lšux/bufãr_h—d.h
>

17 
	~<lšux/wr™eback.h
>

18 
	~<lšux/·gevec.h
>

19 
	~<lšux/m·ge.h
>

20 
	~<lšux/Çmei.h
>

21 
	~<lšux/uio.h
>

22 
	~<lšux/bio.h
>

23 
	~<lšux/wÜkqueue.h
>

24 
	~<lšux/k”Ãl.h
>

25 
	~<lšux/¦ab.h
>

26 
	~<lšux/mm.h
>

27 
	~<lšux/backšg-dev.h
>

29 
	~"ext4_jbd2.h
"

30 
	~"x©Œ.h
"

31 
	~"aş.h
"

33 
kmem_ÿche
 *
	gio_’d_ÿch•
;

35 
__š™
 
	$ext4_š™_·geio
()

37 
io_’d_ÿch•
 = 
	`KMEM_CACHE
(
ext4_io_’d
, 
SLAB_RECLAIM_ACCOUNT
);

38 ià(
io_’d_ÿch•
 =ğ
NULL
)

39  -
ENOMEM
;

41 
	}
}

43 
	$ext4_ex™_·geio
()

45 
	`kmem_ÿche_de¡roy
(
io_’d_ÿch•
);

46 
	}
}

55 
	$bufãr_io_”rÜ
(
bufãr_h—d
 *
bh
)

57 
	`´štk_¿‹lim™ed
(
KERN_ERR
 "Buffer I/Oƒrror on device %pg,†ogical block %llu\n",

58 
bh
->
b_bdev
,

59 ()
bh
->
b_blockÄ
);

60 
	}
}

62 
	$ext4_fšish_bio
(
bio
 *bio)

64 
bio_vec
 *
bvec
;

65 
bvec_™”_®l
 
™”_®l
;

67 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
™”_®l
) {

68 
·ge
 *·gğ
bvec
->
bv_·ge
;

69 
·ge
 *
bounû_·ge
 = 
NULL
;

70 
bufãr_h—d
 *
bh
, *
h—d
;

71 
bio_¡¬t
 = 
bvec
->
bv_off£t
;

72 
bio_’d
 = 
bio_¡¬t
 + 
bvec
->
bv_Ën
;

73 
und”_io
 = 0;

74 
æags
;

76 ià(!
·ge
)

79 ià(
	`fsüy±_is_bounû_·ge
(
·ge
)) {

80 
bounû_·ge
 = 
·ge
;

81 
·ge
 = 
	`fsüy±_·geÿche_·ge
(
bounû_·ge
);

84 ià(
bio
->
bi_¡©us
) {

85 
	`S‘PageE¼Ü
(
·ge
);

86 
	`m­pšg_£t_”rÜ
(
·ge
->
m­pšg
, -
EIO
);

88 
bh
 = 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

93 
	`loÿl_œq_§ve
(
æags
);

94 
	`b™_¥š_lock
(
BH_U±od©e_Lock
, &
h—d
->
b_¡©e
);

96 ià(
	`bh_off£t
(
bh
è< 
bio_¡¬t
 ||

97 
	`bh_off£t
(
bh
è+ bh->
b_size
 > 
bio_’d
) {

98 ià(
	`bufãr_async_wr™e
(
bh
))

99 
und”_io
++;

102 
	`ş—r_bufãr_async_wr™e
(
bh
);

103 ià(
bio
->
bi_¡©us
)

104 
	`bufãr_io_”rÜ
(
bh
);

105 } (
bh
 = bh->
b_this_·ge
è!ğ
h—d
);

106 
	`b™_¥š_uÆock
(
BH_U±od©e_Lock
, &
h—d
->
b_¡©e
);

107 
	`loÿl_œq_»¡Üe
(
æags
);

108 ià(!
und”_io
) {

109 
	`fsüy±_ä“_bounû_·ge
(
bounû_·ge
);

110 
	`’d_·ge_wr™eback
(
·ge
);

113 
	}
}

115 
	$ext4_»Ëa£_io_’d
(
ext4_io_’d_t
 *
io_’d
)

117 
bio
 *bio, *
Ãxt_bio
;

119 
	`BUG_ON
(!
	`li¡_em±y
(&
io_’d
->
li¡
));

120 
	`BUG_ON
(
io_’d
->
æag
 & 
EXT4_IO_END_UNWRITTEN
);

121 
	`WARN_ON
(
io_’d
->
hªdË
);

123 
bio
 = 
io_’d
->bio; bio; biØğ
Ãxt_bio
) {

124 
Ãxt_bio
 = 
bio
->
bi_´iv©e
;

125 
	`ext4_fšish_bio
(
bio
);

126 
	`bio_put
(
bio
);

128 
	`kmem_ÿche_ä“
(
io_’d_ÿch•
, 
io_’d
);

129 
	}
}

139 
	$ext4_’d_io
(
ext4_io_’d_t
 *
io
)

141 
šode
 *šodğ
io
->inode;

142 
loff_t
 
off£t
 = 
io
->offset;

143 
ssize_t
 
size
 = 
io
->size;

144 
hªdË_t
 *
hªdË
 = 
io
->handle;

145 
»t
 = 0;

147 
	`ext4_debug
("ext4_end_io_nolock: io 0x%p from inode %lu,list->next 0x%p,"

149 
io
, 
šode
->
i_šo
, io->
li¡
.
Ãxt
, io->li¡.
´ev
);

151 
io
->
hªdË
 = 
NULL
;

152 
»t
 = 
	`ext4_cÚv”t_unwr™‹n_ex‹Ás
(
hªdË
, 
šode
, 
off£t
, 
size
);

153 ià(
»t
 < 0 && !
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))) {

154 
	`ext4_msg
(
šode
->
i_sb
, 
KERN_EMERG
,

158 
šode
->
i_šo
, 
off£t
, 
size
, 
»t
);

160 
	`ext4_ş—r_io_unwr™‹n_æag
(
io
);

161 
	`ext4_»Ëa£_io_’d
(
io
);

162  
»t
;

163 
	}
}

165 
	$dump_com¶‘ed_IO
(
šode
 *šode, 
li¡_h—d
 *
h—d
)

167 #ifdef 
EXT4FS_DEBUG


168 
li¡_h—d
 *
cur
, *
befÜe
, *
aá”
;

169 
ext4_io_’d_t
 *
io
, *
io0
, *
io1
;

171 ià(
	`li¡_em±y
(
h—d
))

174 
	`ext4_debug
("Dum°šod%lu com¶‘ed iØli¡\n", 
šode
->
i_šo
);

175 
	`li¡_fÜ_—ch_’Œy
(
io
, 
h—d
, 
li¡
) {

176 
cur
 = &
io
->
li¡
;

177 
befÜe
 = 
cur
->
´ev
;

178 
io0
 = 
	`cÚš”_of
(
befÜe
, 
ext4_io_’d_t
, 
li¡
);

179 
aá”
 = 
cur
->
Ãxt
;

180 
io1
 = 
	`cÚš”_of
(
aá”
, 
ext4_io_’d_t
, 
li¡
);

182 
	`ext4_debug
("io 0x%p from inode %lu,prev 0x%p,next 0x%p\n",

183 
io
, 
šode
->
i_šo
, 
io0
, 
io1
);

186 
	}
}

189 
	$ext4_add_com¶‘e_io
(
ext4_io_’d_t
 *
io_’d
)

191 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
io_’d
->
šode
);

192 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
io_’d
->
šode
->
i_sb
);

193 
wÜkqueue_¡ruù
 *
wq
;

194 
æags
;

197 
	`WARN_ON
(!(
io_’d
->
æag
 & 
EXT4_IO_END_UNWRITTEN
));

198 
	`WARN_ON
(!
io_’d
->
hªdË
 && 
sbi
->
s_jouº®
);

199 
	`¥š_lock_œq§ve
(&
ei
->
i_com¶‘ed_io_lock
, 
æags
);

200 
wq
 = 
sbi
->
rsv_cÚv”siÚ_wq
;

201 ià(
	`li¡_em±y
(&
ei
->
i_rsv_cÚv”siÚ_li¡
))

202 
	`queue_wÜk
(
wq
, &
ei
->
i_rsv_cÚv”siÚ_wÜk
);

203 
	`li¡_add_
(&
io_’d
->
li¡
, &
ei
->
i_rsv_cÚv”siÚ_li¡
);

204 
	`¥š_uÆock_œq»¡Üe
(&
ei
->
i_com¶‘ed_io_lock
, 
æags
);

205 
	}
}

207 
	$ext4_do_æush_com¶‘ed_IO
(
šode
 *inode,

208 
li¡_h—d
 *
h—d
)

210 
ext4_io_’d_t
 *
io
;

211 
li¡_h—d
 
unwr™‹n
;

212 
æags
;

213 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

214 
”r
, 
»t
 = 0;

216 
	`¥š_lock_œq§ve
(&
ei
->
i_com¶‘ed_io_lock
, 
æags
);

217 
	`dump_com¶‘ed_IO
(
šode
, 
h—d
);

218 
	`li¡_»¶aû_š™
(
h—d
, &
unwr™‹n
);

219 
	`¥š_uÆock_œq»¡Üe
(&
ei
->
i_com¶‘ed_io_lock
, 
æags
);

221 !
	`li¡_em±y
(&
unwr™‹n
)) {

222 
io
 = 
	`li¡_’Œy
(
unwr™‹n
.
Ãxt
, 
ext4_io_’d_t
, 
li¡
);

223 
	`BUG_ON
(!(
io
->
æag
 & 
EXT4_IO_END_UNWRITTEN
));

224 
	`li¡_d–_š™
(&
io
->
li¡
);

226 
”r
 = 
	`ext4_’d_io
(
io
);

227 ià(
	`uÆik–y
(!
»t
 && 
”r
))

228 
»t
 = 
”r
;

230  
»t
;

231 
	}
}

236 
	$ext4_’d_io_rsv_wÜk
(
wÜk_¡ruù
 *
wÜk
)

238 
ext4_šode_šfo
 *
ei
 = 
	`cÚš”_of
(
wÜk
, ext4_inode_info,

239 
i_rsv_cÚv”siÚ_wÜk
);

240 
	`ext4_do_æush_com¶‘ed_IO
(&
ei
->
vfs_šode
, &ei->
i_rsv_cÚv”siÚ_li¡
);

241 
	}
}

243 
ext4_io_’d_t
 *
	$ext4_š™_io_’d
(
šode
 *šode, 
gå_t
 
æags
)

245 
ext4_io_’d_t
 *
io
 = 
	`kmem_ÿche_z®loc
(
io_’d_ÿch•
, 
æags
);

246 ià(
io
) {

247 
io
->
šode
 = inode;

248 
	`INIT_LIST_HEAD
(&
io
->
li¡
);

249 
	`©omic_£t
(&
io
->
couÁ
, 1);

251  
io
;

252 
	}
}

254 
	$ext4_put_io_’d_deãr
(
ext4_io_’d_t
 *
io_’d
)

256 ià(
	`©omic_dec_ªd_‹¡
(&
io_’d
->
couÁ
)) {

257 ià(!(
io_’d
->
æag
 & 
EXT4_IO_END_UNWRITTEN
è|| !io_’d->
size
) {

258 
	`ext4_»Ëa£_io_’d
(
io_’d
);

261 
	`ext4_add_com¶‘e_io
(
io_’d
);

263 
	}
}

265 
	$ext4_put_io_’d
(
ext4_io_’d_t
 *
io_’d
)

267 
”r
 = 0;

269 ià(
	`©omic_dec_ªd_‹¡
(&
io_’d
->
couÁ
)) {

270 ià(
io_’d
->
æag
 & 
EXT4_IO_END_UNWRITTEN
) {

271 
”r
 = 
	`ext4_cÚv”t_unwr™‹n_ex‹Ás
(
io_’d
->
hªdË
,

272 
io_’d
->
šode
, io_’d->
off£t
,

273 
io_’d
->
size
);

274 
io_’d
->
hªdË
 = 
NULL
;

275 
	`ext4_ş—r_io_unwr™‹n_æag
(
io_’d
);

277 
	`ext4_»Ëa£_io_’d
(
io_’d
);

279  
”r
;

280 
	}
}

282 
ext4_io_’d_t
 *
	$ext4_g‘_io_’d
(
ext4_io_’d_t
 *
io_’d
)

284 
	`©omic_šc
(&
io_’d
->
couÁ
);

285  
io_’d
;

286 
	}
}

289 
	$ext4_’d_bio
(
bio
 *bio)

291 
ext4_io_’d_t
 *
io_’d
 = 
bio
->
bi_´iv©e
;

292 
£ùÜ_t
 
bi_£ùÜ
 = 
bio
->
bi_™”
.bi_sector;

293 
b
[
BDEVNAME_SIZE
];

295 ià(
	`WARN_ONCE
(!
io_’d
, "io_end is NULL: %s: sector %Lu†en %uƒrr %d\n",

296 
	`bio_devÇme
(
bio
, 
b
),

297 (è
bio
->
bi_™”
.
bi_£ùÜ
,

298 (è
	`bio_£ùÜs
(
bio
),

299 
bio
->
bi_¡©us
)) {

300 
	`ext4_fšish_bio
(
bio
);

301 
	`bio_put
(
bio
);

304 
bio
->
bi_’d_io
 = 
NULL
;

306 ià(
bio
->
bi_¡©us
) {

307 
šode
 *šodğ
io_’d
->inode;

309 
	`ext4_w¬nšg
(
šode
->
i_sb
, "I/Oƒrror %d writingo inode %lu "

311 
bio
->
bi_¡©us
, 
šode
->
i_šo
,

312 (è
io_’d
->
off£t
,

313 (è
io_’d
->
size
,

315 
bi_£ùÜ
 >> (
šode
->
i_blkb™s
 - 9));

316 
	`m­pšg_£t_”rÜ
(
šode
->
i_m­pšg
,

317 
	`blk_¡©us_to_”ºo
(
bio
->
bi_¡©us
));

320 ià(
io_’d
->
æag
 & 
EXT4_IO_END_UNWRITTEN
) {

326 
bio
->
bi_´iv©e
 = 
	`xchg
(&
io_’d
->bio, bio);

327 
	`ext4_put_io_’d_deãr
(
io_’d
);

333 
	`ext4_put_io_’d_deãr
(
io_’d
);

334 
	`ext4_fšish_bio
(
bio
);

335 
	`bio_put
(
bio
);

337 
	}
}

339 
	$ext4_io_subm™
(
ext4_io_subm™
 *
io
)

341 
bio
 *biØğ
io
->
io_bio
;

343 ià(
bio
) {

344 
io_İ_æags
 = 
io
->
io_wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
 ?

345 
REQ_SYNC
 : 0;

346 
io
->
io_bio
->
bi_wr™e_hšt
 = io->
io_’d
->
šode
->
i_wr™e_hšt
;

347 
	`bio_£t_İ_©Œs
(
io
->
io_bio
, 
REQ_OP_WRITE
, 
io_İ_æags
);

348 
	`subm™_bio
(
io
->
io_bio
);

350 
io
->
io_bio
 = 
NULL
;

351 
	}
}

353 
	$ext4_io_subm™_š™
(
ext4_io_subm™
 *
io
,

354 
wr™eback_cÚŒŞ
 *
wbc
)

356 
io
->
io_wbc
 = 
wbc
;

357 
io
->
io_bio
 = 
NULL
;

358 
io
->
io_’d
 = 
NULL
;

359 
	}
}

361 
	$io_subm™_š™_bio
(
ext4_io_subm™
 *
io
,

362 
bufãr_h—d
 *
bh
)

364 
bio
 *bio;

366 
bio
 = 
	`bio_®loc
(
GFP_NOIO
, 
BIO_MAX_PAGES
);

367 ià(!
bio
)

368  -
ENOMEM
;

369 
bio
->
bi_™”
.
bi_£ùÜ
 = 
bh
->
b_blockÄ
 * (bh->
b_size
 >> 9);

370 
	`bio_£t_dev
(
bio
, 
bh
->
b_bdev
);

371 
bio
->
bi_’d_io
 = 
ext4_’d_bio
;

372 
bio
->
bi_´iv©e
 = 
	`ext4_g‘_io_’d
(
io
->
io_’d
);

373 
io
->
io_bio
 = 
bio
;

374 
io
->
io_Ãxt_block
 = 
bh
->
b_blockÄ
;

375 
	`wbc_š™_bio
(
io
->
io_wbc
, 
bio
);

377 
	}
}

379 
	$io_subm™_add_bh
(
ext4_io_subm™
 *
io
,

380 
šode
 *inode,

381 
·ge
 *page,

382 
bufãr_h—d
 *
bh
)

384 
»t
;

386 ià(
io
->
io_bio
 && 
bh
->
b_blockÄ
 !ğio->
io_Ãxt_block
) {

387 
subm™_ªd_»Œy
:

388 
	`ext4_io_subm™
(
io
);

390 ià(
io
->
io_bio
 =ğ
NULL
) {

391 
»t
 = 
	`io_subm™_š™_bio
(
io
, 
bh
);

392 ià(
»t
)

393  
»t
;

394 
io
->
io_bio
->
bi_wr™e_hšt
 = 
šode
->
i_wr™e_hšt
;

396 
»t
 = 
	`bio_add_·ge
(
io
->
io_bio
, 
·ge
, 
bh
->
b_size
, 
	`bh_off£t
(bh));

397 ià(
»t
 !ğ
bh
->
b_size
)

398 
subm™_ªd_»Œy
;

399 
	`wbc_accouÁ_cgroup_owÃr
(
io
->
io_wbc
, 
·ge
, 
bh
->
b_size
);

400 
io
->
io_Ãxt_block
++;

402 
	}
}

404 
	$ext4_bio_wr™e_·ge
(
ext4_io_subm™
 *
io
,

405 
·ge
 *page,

406 
Ën
,

407 
wr™eback_cÚŒŞ
 *
wbc
,

408 
boŞ
 
k“p_towr™e
)

410 
·ge
 *
bounû_·ge
 = 
NULL
;

411 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

412 
block_¡¬t
;

413 
bufãr_h—d
 *
bh
, *
h—d
;

414 
»t
 = 0;

415 
Ä_subm™‹d
 = 0;

416 
Ä_to_subm™
 = 0;

418 
	`BUG_ON
(!
	`PageLocked
(
·ge
));

419 
	`BUG_ON
(
	`PageWr™eback
(
·ge
));

421 ià(
k“p_towr™e
)

422 
	`£t_·ge_wr™eback_k“pwr™e
(
·ge
);

424 
	`£t_·ge_wr™eback
(
·ge
);

425 
	`CË¬PageE¼Ü
(
·ge
);

436 ià(
Ën
 < 
PAGE_SIZE
)

437 
	`z”o_u£r_£gm’t
(
·ge
, 
Ën
, 
PAGE_SIZE
);

445 
bh
 = 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

447 
block_¡¬t
 = 
	`bh_off£t
(
bh
);

448 ià(
block_¡¬t
 >ğ
Ën
) {

449 
	`ş—r_bufãr_dœty
(
bh
);

450 
	`£t_bufãr_u±od©e
(
bh
);

453 ià(!
	`bufãr_dœty
(
bh
è|| 
	`bufãr_d–ay
(bh) ||

454 !
	`bufãr_m­³d
(
bh
è|| 
	`bufãr_unwr™‹n
(bh)) {

456 ià(!
	`bufãr_m­³d
(
bh
))

457 
	`ş—r_bufãr_dœty
(
bh
);

458 ià(
io
->
io_bio
)

459 
	`ext4_io_subm™
(
io
);

462 ià(
	`bufãr_Ãw
(
bh
))

463 
	`ş—r_bufãr_Ãw
(
bh
);

464 
	`£t_bufãr_async_wr™e
(
bh
);

465 
Ä_to_subm™
++;

466 } (
bh
 = bh->
b_this_·ge
è!ğ
h—d
);

468 
bh
 = 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

477 ià(
	`IS_ENCRYPTED
(
šode
è&& 
	`S_ISREG
(šode->
i_mode
è&& 
Ä_to_subm™
) {

478 
gå_t
 
gå_æags
 = 
GFP_NOFS
;

479 
’c_by‹s
 = 
	`round_up
(
Ën
, 
	`i_blocksize
(
šode
));

481 
»Œy_’üy±
:

482 
bounû_·ge
 = 
	`fsüy±_’üy±_·geÿche_blocks
(
·ge
, 
’c_by‹s
,

483 0, 
gå_æags
);

484 ià(
	`IS_ERR
(
bounû_·ge
)) {

485 
»t
 = 
	`PTR_ERR
(
bounû_·ge
);

486 ià(
»t
 =ğ-
ENOMEM
 && 
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
) {

487 ià(
io
->
io_bio
) {

488 
	`ext4_io_subm™
(
io
);

489 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

491 
gå_æags
 |ğ
__GFP_NOFAIL
;

492 
»Œy_’üy±
;

494 
bounû_·ge
 = 
NULL
;

495 
out
;

501 ià(!
	`bufãr_async_wr™e
(
bh
))

503 
»t
 = 
	`io_subm™_add_bh
(
io
, 
šode
, 
bounû_·ge
 ?: 
·ge
, 
bh
);

504 ià(
»t
) {

512 
Ä_subm™‹d
++;

513 
	`ş—r_bufãr_dœty
(
bh
);

514 } (
bh
 = bh->
b_this_·ge
è!ğ
h—d
);

517 ià(
»t
) {

518 
out
:

519 
	`fsüy±_ä“_bounû_·ge
(
bounû_·ge
);

520 
	`´štk_¿‹lim™ed
(
KERN_ERR
 "%s:„‘ = %d\n", 
__func__
, 
»t
);

521 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

523 
	`ş—r_bufãr_async_wr™e
(
bh
);

524 
bh
 = bh->
b_this_·ge
;

525 } 
bh
 !ğ
h—d
);

527 
	`uÆock_·ge
(
·ge
);

529 ià(!
Ä_subm™‹d
)

530 
	`’d_·ge_wr™eback
(
·ge
);

531  
»t
;

532 
	}
}

	@pxt4/readpage.c

31 
	~<lšux/k”Ãl.h
>

32 
	~<lšux/expÜt.h
>

33 
	~<lšux/mm.h
>

34 
	~<lšux/kdev_t.h
>

35 
	~<lšux/gå.h
>

36 
	~<lšux/bio.h
>

37 
	~<lšux/fs.h
>

38 
	~<lšux/bufãr_h—d.h
>

39 
	~<lšux/blkdev.h
>

40 
	~<lšux/highmem.h
>

41 
	~<lšux/´eãtch.h
>

42 
	~<lšux/m·ge.h
>

43 
	~<lšux/wr™eback.h
>

44 
	~<lšux/backšg-dev.h
>

45 
	~<lšux/·gevec.h
>

46 
	~<lšux/ş—nÿche.h
>

48 
	~"ext4.h
"

50 
	#NUM_PREALLOC_POST_READ_CTXS
 128

	)

52 
kmem_ÿche
 *
	gbio_po¡_»ad_ùx_ÿche
;

53 
mempoŞ_t
 *
	gbio_po¡_»ad_ùx_poŞ
;

56 
	ebio_po¡_»ad_¡•
 {

57 
	mSTEP_INITIAL
 = 0,

58 
	mSTEP_DECRYPT
,

59 
	mSTEP_VERITY
,

62 
	sbio_po¡_»ad_ùx
 {

63 
bio
 *
	mbio
;

64 
wÜk_¡ruù
 
	mwÜk
;

65 
	mcur_¡•
;

66 
	m’abËd_¡•s
;

69 
	$__»ad_’d_io
(
bio
 *bio)

71 
·ge
 *page;

72 
bio_vec
 *
bv
;

73 
bvec_™”_®l
 
™”_®l
;

75 
	`bio_fÜ_—ch_£gm’t_®l
(
bv
, 
bio
, 
™”_®l
) {

76 
·ge
 = 
bv
->
bv_·ge
;

79 ià(
bio
->
bi_¡©us
 || 
	`PageE¼Ü
(
·ge
)) {

80 
	`CË¬PageU±od©e
(
·ge
);

82 
	`CË¬PageE¼Ü
(
·ge
);

84 
	`S‘PageU±od©e
(
·ge
);

86 
	`uÆock_·ge
(
·ge
);

88 ià(
bio
->
bi_´iv©e
)

89 
	`mempoŞ_ä“
(
bio
->
bi_´iv©e
, 
bio_po¡_»ad_ùx_poŞ
);

90 
	`bio_put
(
bio
);

91 
	}
}

93 
bio_po¡_»ad_´oûssšg
(
bio_po¡_»ad_ùx
 *
ùx
);

95 
	$deüy±_wÜk
(
wÜk_¡ruù
 *
wÜk
)

97 
bio_po¡_»ad_ùx
 *
ùx
 =

98 
	`cÚš”_of
(
wÜk
, 
bio_po¡_»ad_ùx
, work);

100 
	`fsüy±_deüy±_bio
(
ùx
->
bio
);

102 
	`bio_po¡_»ad_´oûssšg
(
ùx
);

103 
	}
}

105 
	$v”™y_wÜk
(
wÜk_¡ruù
 *
wÜk
)

107 
bio_po¡_»ad_ùx
 *
ùx
 =

108 
	`cÚš”_of
(
wÜk
, 
bio_po¡_»ad_ùx
, work);

110 
	`fsv”™y_v”ify_bio
(
ùx
->
bio
);

112 
	`bio_po¡_»ad_´oûssšg
(
ùx
);

113 
	}
}

115 
	$bio_po¡_»ad_´oûssšg
(
bio_po¡_»ad_ùx
 *
ùx
)

122 ++
ùx
->
cur_¡•
) {

123 
STEP_DECRYPT
:

124 ià(
ùx
->
’abËd_¡•s
 & (1 << 
STEP_DECRYPT
)) {

125 
	`INIT_WORK
(&
ùx
->
wÜk
, 
deüy±_wÜk
);

126 
	`fsüy±_’queue_deüy±_wÜk
(&
ùx
->
wÜk
);

129 
ùx
->
cur_¡•
++;

131 
STEP_VERITY
:

132 ià(
ùx
->
’abËd_¡•s
 & (1 << 
STEP_VERITY
)) {

133 
	`INIT_WORK
(&
ùx
->
wÜk
, 
v”™y_wÜk
);

134 
	`fsv”™y_’queue_v”ify_wÜk
(&
ùx
->
wÜk
);

137 
ùx
->
cur_¡•
++;

140 
	`__»ad_’d_io
(
ùx
->
bio
);

142 
	}
}

144 
boŞ
 
	$bio_po¡_»ad_»quœed
(
bio
 *bio)

146  
bio
->
bi_´iv©e
 && !bio->
bi_¡©us
;

147 
	}
}

161 
	$m·ge_’d_io
(
bio
 *bio)

163 ià(
	`bio_po¡_»ad_»quœed
(
bio
)) {

164 
bio_po¡_»ad_ùx
 *
ùx
 = 
bio
->
bi_´iv©e
;

166 
ùx
->
cur_¡•
 = 
STEP_INITIAL
;

167 
	`bio_po¡_»ad_´oûssšg
(
ùx
);

170 
	`__»ad_’d_io
(
bio
);

171 
	}
}

173 
šlše
 
boŞ
 
	$ext4_Ãed_v”™y
(cÚ¡ 
šode
 *šode, 
pgoff_t
 
idx
)

175  
	`fsv”™y_aùive
(
šode
) &&

176 
idx
 < 
	`DIV_ROUND_UP
(
šode
->
i_size
, 
PAGE_SIZE
);

177 
	}
}

179 
bio_po¡_»ad_ùx
 *
	$g‘_bio_po¡_»ad_ùx
(
šode
 *inode,

180 
bio
 *bio,

181 
pgoff_t
 
fœ¡_idx
)

183 
po¡_»ad_¡•s
 = 0;

184 
bio_po¡_»ad_ùx
 *
ùx
 = 
NULL
;

186 ià(
	`IS_ENCRYPTED
(
šode
è&& 
	`S_ISREG
(šode->
i_mode
))

187 
po¡_»ad_¡•s
 |ğ1 << 
STEP_DECRYPT
;

189 ià(
	`ext4_Ãed_v”™y
(
šode
, 
fœ¡_idx
))

190 
po¡_»ad_¡•s
 |ğ1 << 
STEP_VERITY
;

192 ià(
po¡_»ad_¡•s
) {

193 
ùx
 = 
	`mempoŞ_®loc
(
bio_po¡_»ad_ùx_poŞ
, 
GFP_NOFS
);

194 ià(!
ùx
)

195  
	`ERR_PTR
(-
ENOMEM
);

196 
ùx
->
bio
 = bio;

197 
ùx
->
’abËd_¡•s
 = 
po¡_»ad_¡•s
;

198 
bio
->
bi_´iv©e
 = 
ùx
;

200  
ùx
;

201 
	}
}

203 
šlše
 
loff_t
 
	$ext4_»ad·ge_lim™
(
šode
 *inode)

205 ià(
	`IS_ENABLED
(
CONFIG_FS_VERITY
) &&

206 (
	`IS_VERITY
(
šode
è|| 
	`ext4_v”™y_š_´og»ss
(inode)))

207  
šode
->
i_sb
->
s_maxby‹s
;

209  
	`i_size_»ad
(
šode
);

210 
	}
}

212 
	$ext4_m·ge_»ad·ges
(
add»ss_¥aû
 *
m­pšg
,

213 
li¡_h—d
 *
·ges
, 
·ge
 *page,

214 
Ä_·ges
, 
boŞ
 
is_»adah—d
)

216 
bio
 *biØğ
NULL
;

217 
£ùÜ_t
 
Ï¡_block_š_bio
 = 0;

219 
šode
 *šodğ
m­pšg
->
ho¡
;

220 cÚ¡ 
blkb™s
 = 
šode
->
i_blkb™s
;

221 cÚ¡ 
blocks_³r_·ge
 = 
PAGE_SIZE
 >> 
blkb™s
;

222 cÚ¡ 
blocksize
 = 1 << 
blkb™s
;

223 
£ùÜ_t
 
block_š_fe
;

224 
£ùÜ_t
 
Ï¡_block
;

225 
£ùÜ_t
 
Ï¡_block_š_fe
;

226 
£ùÜ_t
 
blocks
[
MAX_BUF_PER_PAGE
];

227 
·ge_block
;

228 
block_deviû
 *
bdev
 = 
šode
->
i_sb
->
s_bdev
;

229 
Ëngth
;

230 
»Ïtive_block
 = 0;

231 
ext4_m­_blocks
 
m­
;

233 
m­
.
m_pblk
 = 0;

234 
m­
.
m_lblk
 = 0;

235 
m­
.
m_Ën
 = 0;

236 
m­
.
m_æags
 = 0;

238 ; 
Ä_·ges
;‚r_pages--) {

239 
fuÎy_m­³d
 = 1;

240 
fœ¡_hŞe
 = 
blocks_³r_·ge
;

242 ià(
·ges
) {

243 
·ge
 = 
	`Ìu_to_·ge
(
·ges
);

245 
	`´eãtchw
(&
·ge
->
æags
);

246 
	`li¡_d–
(&
·ge
->
Ìu
);

247 ià(
	`add_to_·ge_ÿche_Ìu
(
·ge
, 
m­pšg
,…age->
šdex
,

248 
	`»adah—d_gå_mask
(
m­pšg
)))

249 
Ãxt_·ge
;

252 ià(
	`·ge_has_bufãrs
(
·ge
))

253 
cÚfu£d
;

255 
block_š_fe
 = (
£ùÜ_t
)
·ge
->
šdex
 << (
PAGE_SHIFT
 - 
blkb™s
);

256 
Ï¡_block
 = 
block_š_fe
 + 
Ä_·ges
 * 
blocks_³r_·ge
;

257 
Ï¡_block_š_fe
 = (
	`ext4_»ad·ge_lim™
(
šode
) +

258 
blocksize
 - 1è>> 
blkb™s
;

259 ià(
Ï¡_block
 > 
Ï¡_block_š_fe
)

260 
Ï¡_block
 = 
Ï¡_block_š_fe
;

261 
·ge_block
 = 0;

266 ià((
m­
.
m_æags
 & 
EXT4_MAP_MAPPED
) &&

267 
block_š_fe
 > 
m­
.
m_lblk
 &&

268 
block_š_fe
 < (
m­
.
m_lblk
 + m­.
m_Ën
)) {

269 
m­_off£t
 = 
block_š_fe
 - 
m­
.
m_lblk
;

270 
Ï¡
 = 
m­
.
m_Ën
 - 
m­_off£t
;

272 
»Ïtive_block
 = 0; ;„elative_block++) {

273 ià(
»Ïtive_block
 =ğ
Ï¡
) {

275 
m­
.
m_æags
 &ğ~
EXT4_MAP_MAPPED
;

278 ià(
·ge_block
 =ğ
blocks_³r_·ge
)

280 
blocks
[
·ge_block
] = 
m­
.
m_pblk
 + 
m­_off£t
 +

281 
»Ïtive_block
;

282 
·ge_block
++;

283 
block_š_fe
++;

291 
·ge_block
 < 
blocks_³r_·ge
) {

292 ià(
block_š_fe
 < 
Ï¡_block
) {

293 
m­
.
m_lblk
 = 
block_š_fe
;

294 
m­
.
m_Ën
 = 
Ï¡_block
 - 
block_š_fe
;

296 ià(
	`ext4_m­_blocks
(
NULL
, 
šode
, &
m­
, 0) < 0) {

297 
£t_”rÜ_·ge
:

298 
	`S‘PageE¼Ü
(
·ge
);

299 
	`z”o_u£r_£gm’t
(
·ge
, 0,

300 
PAGE_SIZE
);

301 
	`uÆock_·ge
(
·ge
);

302 
Ãxt_·ge
;

305 ià((
m­
.
m_æags
 & 
EXT4_MAP_MAPPED
) == 0) {

306 
fuÎy_m­³d
 = 0;

307 ià(
fœ¡_hŞe
 =ğ
blocks_³r_·ge
)

308 
fœ¡_hŞe
 = 
·ge_block
;

309 
·ge_block
++;

310 
block_š_fe
++;

313 ià(
fœ¡_hŞe
 !ğ
blocks_³r_·ge
)

314 
cÚfu£d
;

317 ià(
·ge_block
 && 
blocks
[·ge_block-1] !ğ
m­
.
m_pblk
-1)

318 
cÚfu£d
;

319 
»Ïtive_block
 = 0; ;„elative_block++) {

320 ià(
»Ïtive_block
 =ğ
m­
.
m_Ën
) {

322 
m­
.
m_æags
 &ğ~
EXT4_MAP_MAPPED
;

324 } ià(
·ge_block
 =ğ
blocks_³r_·ge
)

326 
blocks
[
·ge_block
] = 
m­
.
m_pblk
+
»Ïtive_block
;

327 
·ge_block
++;

328 
block_š_fe
++;

331 ià(
fœ¡_hŞe
 !ğ
blocks_³r_·ge
) {

332 
	`z”o_u£r_£gm’t
(
·ge
, 
fœ¡_hŞe
 << 
blkb™s
,

333 
PAGE_SIZE
);

334 ià(
fœ¡_hŞe
 == 0) {

335 ià(
	`ext4_Ãed_v”™y
(
šode
, 
·ge
->
šdex
) &&

336 !
	`fsv”™y_v”ify_·ge
(
·ge
))

337 
£t_”rÜ_·ge
;

338 
	`S‘PageU±od©e
(
·ge
);

339 
	`uÆock_·ge
(
·ge
);

340 
Ãxt_·ge
;

342 } ià(
fuÎy_m­³d
) {

343 
	`S‘PageM­³dToDisk
(
·ge
);

345 ià(
fuÎy_m­³d
 && 
blocks_³r_·ge
 == 1 &&

346 !
	`PageU±od©e
(
·ge
è&& 
	`ş—nÿche_g‘_·ge
(page) == 0) {

347 
	`S‘PageU±od©e
(
·ge
);

348 
cÚfu£d
;

355 ià(
bio
 && (
Ï¡_block_š_bio
 !ğ
blocks
[0] - 1)) {

356 
subm™_ªd_»®loc
:

357 
	`subm™_bio
(
bio
);

358 
bio
 = 
NULL
;

360 ià(
bio
 =ğ
NULL
) {

361 
bio_po¡_»ad_ùx
 *
ùx
;

363 
bio
 = 
	`bio_®loc
(
GFP_KERNEL
,

364 
	`mš_t
(, 
Ä_·ges
, 
BIO_MAX_PAGES
));

365 ià(!
bio
)

366 
£t_”rÜ_·ge
;

367 
ùx
 = 
	`g‘_bio_po¡_»ad_ùx
(
šode
, 
bio
, 
·ge
->
šdex
);

368 ià(
	`IS_ERR
(
ùx
)) {

369 
	`bio_put
(
bio
);

370 
bio
 = 
NULL
;

371 
£t_”rÜ_·ge
;

373 
	`bio_£t_dev
(
bio
, 
bdev
);

374 
bio
->
bi_™”
.
bi_£ùÜ
 = 
blocks
[0] << (
blkb™s
 - 9);

375 
bio
->
bi_’d_io
 = 
m·ge_’d_io
;

376 
bio
->
bi_´iv©e
 = 
ùx
;

377 
	`bio_£t_İ_©Œs
(
bio
, 
REQ_OP_READ
,

378 
is_»adah—d
 ? 
REQ_RAHEAD
 : 0);

381 
Ëngth
 = 
fœ¡_hŞe
 << 
blkb™s
;

382 ià(
	`bio_add_·ge
(
bio
, 
·ge
, 
Ëngth
, 0) <†ength)

383 
subm™_ªd_»®loc
;

385 ià(((
m­
.
m_æags
 & 
EXT4_MAP_BOUNDARY
) &&

386 (
»Ïtive_block
 =ğ
m­
.
m_Ën
)) ||

387 (
fœ¡_hŞe
 !ğ
blocks_³r_·ge
)) {

388 
	`subm™_bio
(
bio
);

389 
bio
 = 
NULL
;

391 
Ï¡_block_š_bio
 = 
blocks
[
blocks_³r_·ge
 - 1];

392 
Ãxt_·ge
;

393 
cÚfu£d
:

394 ià(
bio
) {

395 
	`subm™_bio
(
bio
);

396 
bio
 = 
NULL
;

398 ià(!
	`PageU±od©e
(
·ge
))

399 
	`block_»ad_fuÎ_·ge
(
·ge
, 
ext4_g‘_block
);

401 
	`uÆock_·ge
(
·ge
);

402 
Ãxt_·ge
:

403 ià(
·ges
)

404 
	`put_·ge
(
·ge
);

406 
	`BUG_ON
(
·ges
 && !
	`li¡_em±y
(pages));

407 ià(
bio
)

408 
	`subm™_bio
(
bio
);

410 
	}
}

412 
__š™
 
	$ext4_š™_po¡_»ad_´oûssšg
()

414 
bio_po¡_»ad_ùx_ÿche
 =

415 
	`kmem_ÿche_ü—‹
("ext4_bio_post_read_ctx",

416 (
bio_po¡_»ad_ùx
), 0, 0, 
NULL
);

417 ià(!
bio_po¡_»ad_ùx_ÿche
)

418 
ç
;

419 
bio_po¡_»ad_ùx_poŞ
 =

420 
	`mempoŞ_ü—‹_¦ab_poŞ
(
NUM_PREALLOC_POST_READ_CTXS
,

421 
bio_po¡_»ad_ùx_ÿche
);

422 ià(!
bio_po¡_»ad_ùx_poŞ
)

423 
ç_ä“_ÿche
;

426 
ç_ä“_ÿche
:

427 
	`kmem_ÿche_de¡roy
(
bio_po¡_»ad_ùx_ÿche
);

428 
ç
:

429  -
ENOMEM
;

430 
	}
}

432 
	$ext4_ex™_po¡_»ad_´oûssšg
()

434 
	`mempoŞ_de¡roy
(
bio_po¡_»ad_ùx_poŞ
);

435 
	`kmem_ÿche_de¡roy
(
bio_po¡_»ad_ùx_ÿche
);

436 
	}
}

	@pxt4/resize.c

13 
	#EXT4FS_DEBUG


	)

15 
	~<lšux/”ºo.h
>

16 
	~<lšux/¦ab.h
>

18 
	~"ext4_jbd2.h
"

20 
	$ext4_»size_begš
(
su³r_block
 *
sb
)

22 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

23 
»t
 = 0;

25 ià(!
	`ÿ·bË
(
CAP_SYS_RESOURCE
))

26  -
EPERM
;

33 ià(
	`EXT4_B2C
(
sbi
, sbi->
s_sbh
->
b_blockÄ
) !=

34 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_fœ¡_d©a_block
)) {

35 
	`ext4_w¬nšg
(
sb
, "won't„esize using backup superblock‡t %llu",

36 ()
	`EXT4_SB
(
sb
)->
s_sbh
->
b_blockÄ
);

37  -
EPERM
;

44 ià(
	`EXT4_SB
(
sb
)->
s_mouÁ_¡©e
 & 
EXT4_ERROR_FS
) {

45 
	`ext4_w¬nšg
(
sb
, "There‡reƒrrors inhe filesystem, "

47  -
EPERM
;

50 ià(
	`‹¡_ªd_£t_b™_lock
(
EXT4_FLAGS_RESIZING
,

51 &
	`EXT4_SB
(
sb
)->
s_ext4_æags
))

52 
»t
 = -
EBUSY
;

54  
»t
;

55 
	}
}

57 
	$ext4_»size_’d
(
su³r_block
 *
sb
)

59 
	`ş—r_b™_uÆock
(
EXT4_FLAGS_RESIZING
, &
	`EXT4_SB
(
sb
)->
s_ext4_æags
);

60 
	`smp_mb__aá”_©omic
();

61 
	}
}

63 
ext4_group_t
 
	$ext4_m‘a_bg_fœ¡_group
(
su³r_block
 *
sb
,

64 
ext4_group_t
 
group
) {

65  (
group
 >> 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
)) <<

66 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
);

67 
	}
}

69 
ext4_fsblk_t
 
	$ext4_m‘a_bg_fœ¡_block_no
(
su³r_block
 *
sb
,

70 
ext4_group_t
 
group
) {

71 
group
 = 
	`ext4_m‘a_bg_fœ¡_group
(
sb
, group);

72  
	`ext4_group_fœ¡_block_no
(
sb
, 
group
);

73 
	}
}

75 
ext4_g½blk_t
 
	$ext4_group_ov”h—d_blocks
(
su³r_block
 *
sb
,

76 
ext4_group_t
 
group
) {

77 
ext4_g½blk_t
 
ov”h—d
;

78 
ov”h—d
 = 
	`ext4_bg_num_gdb
(
sb
, 
group
);

79 ià(
	`ext4_bg_has_su³r
(
sb
, 
group
))

80 
ov”h—d
 += 1 +

81 
	`Ë16_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_»£rved_gdt_blocks
);

82  
ov”h—d
;

83 
	}
}

85 
	#outside
(
b
, 
fœ¡
, 
Ï¡
è((bè< (fœ¡è|| (bè>ğÖa¡))

	)

86 
	#šside
(
b
, 
fœ¡
, 
Ï¡
è((bè>ğ(fœ¡è&& (bè< (Ï¡))

	)

88 
	$v”ify_group_šput
(
su³r_block
 *
sb
,

89 
ext4_Ãw_group_d©a
 *
šput
)

91 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

92 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

93 
ext4_fsblk_t
 
¡¬t
 = 
	`ext4_blocks_couÁ
(
es
);

94 
ext4_fsblk_t
 
’d
 = 
¡¬t
 + 
šput
->
blocks_couÁ
;

95 
ext4_group_t
 
group
 = 
šput
->group;

96 
ext4_fsblk_t
 
™’d
 = 
šput
->
šode_bË
 + 
sbi
->
s_™b_³r_group
;

97 
ov”h—d
;

98 
ext4_fsblk_t
 
m‘«nd
;

99 
bufãr_h—d
 *
bh
 = 
NULL
;

100 
ext4_g½blk_t
 
ä“_blocks_couÁ
, 
off£t
;

101 
”r
 = -
EINVAL
;

103 ià(
group
 !ğ
sbi
->
s_groups_couÁ
) {

104 
	`ext4_w¬nšg
(
sb
, "Cannot‡dd‡t group %u (only %u groups)",

105 
šput
->
group
, 
sbi
->
s_groups_couÁ
);

106  -
EINVAL
;

109 
ov”h—d
 = 
	`ext4_group_ov”h—d_blocks
(
sb
, 
group
);

110 
m‘«nd
 = 
¡¬t
 + 
ov”h—d
;

111 
šput
->
ä“_şu¡”s_couÁ
 = 
ä“_blocks_couÁ
 =

112 
šput
->
blocks_couÁ
 - 2 - 
ov”h—d
 - 
sbi
->
s_™b_³r_group
;

114 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

115 
	`´štk
(
KERN_DEBUG
 "EXT4-fs:‡dding %s group %u: %u blocks "

117 
	`ext4_bg_has_su³r
(
sb
, 
šput
->
group
) ? "normal" :

118 "no-su³r", 
šput
->
group
, iÅut->
blocks_couÁ
,

119 
ä“_blocks_couÁ
, 
šput
->
»£rved_blocks
);

121 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
¡¬t
, 
NULL
, &
off£t
);

122 ià(
off£t
 != 0)

123 
	`ext4_w¬nšg
(
sb
, "Last group‚ot full");

124 ià(
šput
->
»£rved_blocks
 > iÅut->
blocks_couÁ
 / 5)

125 
	`ext4_w¬nšg
(
sb
, "Reserved blocksoo high (%u)",

126 
šput
->
»£rved_blocks
);

127 ià(
ä“_blocks_couÁ
 < 0)

128 
	`ext4_w¬nšg
(
sb
, "Bad blocks count %u",

129 
šput
->
blocks_couÁ
);

130 ià(
	`IS_ERR
(
bh
 = 
	`ext4_sb_b»ad
(
sb
, 
’d
 - 1, 0))) {

131 
”r
 = 
	`PTR_ERR
(
bh
);

132 
bh
 = 
NULL
;

133 
	`ext4_w¬nšg
(
sb
, "Cannot„ead†ast block (%llu)",

134 
’d
 - 1);

135 } ià(
	`outside
(
šput
->
block_b™m­
, 
¡¬t
, 
’d
))

136 
	`ext4_w¬nšg
(
sb
, "Block bitmap‚ot in group (block %llu)",

137 ()
šput
->
block_b™m­
);

138 ià(
	`outside
(
šput
->
šode_b™m­
, 
¡¬t
, 
’d
))

139 
	`ext4_w¬nšg
(
sb
, "Inode bitmap‚ot in group (block %llu)",

140 ()
šput
->
šode_b™m­
);

141 ià(
	`outside
(
šput
->
šode_bË
, 
¡¬t
, 
’d
) ||

142 
	`outside
(
™’d
 - 1, 
¡¬t
, 
’d
))

143 
	`ext4_w¬nšg
(
sb
, "Inodeable‚ot in group (blocks %llu-%llu)",

144 ()
šput
->
šode_bË
, 
™’d
 - 1);

145 ià(
šput
->
šode_b™m­
 =ğšput->
block_b™m­
)

146 
	`ext4_w¬nšg
(
sb
, "Block bitmap same‡s inode bitmap (%llu)",

147 ()
šput
->
block_b™m­
);

148 ià(
	`šside
(
šput
->
block_b™m­
, iÅut->
šode_bË
, 
™’d
))

149 
	`ext4_w¬nšg
(
sb
, "Block bitmap (%llu) in inodeable "

151 ()
šput
->
block_b™m­
,

152 ()
šput
->
šode_bË
, 
™’d
 - 1);

153 ià(
	`šside
(
šput
->
šode_b™m­
, iÅut->
šode_bË
, 
™’d
))

154 
	`ext4_w¬nšg
(
sb
, "Inode bitmap (%llu) in inodeable "

156 ()
šput
->
šode_b™m­
,

157 ()
šput
->
šode_bË
, 
™’d
 - 1);

158 ià(
	`šside
(
šput
->
block_b™m­
, 
¡¬t
, 
m‘«nd
))

159 
	`ext4_w¬nšg
(
sb
, "Block bitmap (%llu) in GDTable (%llu-%llu)",

160 ()
šput
->
block_b™m­
,

161 
¡¬t
, 
m‘«nd
 - 1);

162 ià(
	`šside
(
šput
->
šode_b™m­
, 
¡¬t
, 
m‘«nd
))

163 
	`ext4_w¬nšg
(
sb
, "Inode bitmap (%llu) in GDTable (%llu-%llu)",

164 ()
šput
->
šode_b™m­
,

165 
¡¬t
, 
m‘«nd
 - 1);

166 ià(
	`šside
(
šput
->
šode_bË
, 
¡¬t
, 
m‘«nd
) ||

167 
	`šside
(
™’d
 - 1, 
¡¬t
, 
m‘«nd
))

168 
	`ext4_w¬nšg
(
sb
, "Inodeable (%llu-%llu) overlaps GDTable "

170 ()
šput
->
šode_bË
,

171 
™’d
 - 1, 
¡¬t
, 
m‘«nd
 - 1);

173 
”r
 = 0;

174 
	`b»l£
(
bh
);

176  
”r
;

177 
	}
}

183 
	sext4_Ãw_æex_group_d©a
 {

184 
ext4_Ãw_group_d©a
 *
	mgroups
;

186 
__u16
 *
	mbg_æags
;

188 
ext4_group_t
 
	mcouÁ
;

198 
ext4_Ãw_æex_group_d©a
 *
	$®loc_æex_gd
(
æexbg_size
)

200 
ext4_Ãw_æex_group_d©a
 *
æex_gd
;

202 
æex_gd
 = 
	`km®loc
((*æex_gd), 
GFP_NOFS
);

203 ià(
æex_gd
 =ğ
NULL
)

204 
out3
;

206 ià(
æexbg_size
 >ğ
UINT_MAX
 / (
ext4_Ãw_group_d©a
))

207 
out2
;

208 
æex_gd
->
couÁ
 = 
æexbg_size
;

210 
æex_gd
->
groups
 = 
	`km®loc_¬¿y
(
æexbg_size
,

211 (
ext4_Ãw_group_d©a
),

212 
GFP_NOFS
);

213 ià(
æex_gd
->
groups
 =ğ
NULL
)

214 
out2
;

216 
æex_gd
->
bg_æags
 = 
	`km®loc_¬¿y
(
æexbg_size
, (
__u16
),

217 
GFP_NOFS
);

218 ià(
æex_gd
->
bg_æags
 =ğ
NULL
)

219 
out1
;

221  
æex_gd
;

223 
out1
:

224 
	`kä“
(
æex_gd
->
groups
);

225 
out2
:

226 
	`kä“
(
æex_gd
);

227 
out3
:

228  
NULL
;

229 
	}
}

231 
	$ä“_æex_gd
(
ext4_Ãw_æex_group_d©a
 *
æex_gd
)

233 
	`kä“
(
æex_gd
->
bg_æags
);

234 
	`kä“
(
æex_gd
->
groups
);

235 
	`kä“
(
æex_gd
);

236 
	}
}

251 
	$ext4_®loc_group_bËs
(
su³r_block
 *
sb
,

252 
ext4_Ãw_æex_group_d©a
 *
æex_gd
,

253 
æexbg_size
)

255 
ext4_Ãw_group_d©a
 *
group_d©a
 = 
æex_gd
->
groups
;

256 
ext4_fsblk_t
 
¡¬t_blk
;

257 
ext4_fsblk_t
 
Ï¡_blk
;

258 
ext4_group_t
 
¤c_group
;

259 
ext4_group_t
 
bb_šdex
 = 0;

260 
ext4_group_t
 
ib_šdex
 = 0;

261 
ext4_group_t
 
™_šdex
 = 0;

262 
ext4_group_t
 
group
;

263 
ext4_group_t
 
Ï¡_group
;

264 
ov”h—d
;

265 
__u16
 
unš™_mask
 = (
æexbg_size
 > 1è? ~
EXT4_BG_BLOCK_UNINIT
 : ~0;

266 
i
;

268 
	`BUG_ON
(
æex_gd
->
couÁ
 =ğ0 || 
group_d©a
 =ğ
NULL
);

270 
¤c_group
 = 
group_d©a
[0].
group
;

271 
Ï¡_group
 = 
¤c_group
 + 
æex_gd
->
couÁ
 - 1;

273 
	`BUG_ON
((
æexbg_size
 > 1è&& ((
¤c_group
 & ~(flexbg_size - 1)) !=

274 (
Ï¡_group
 & ~(
æexbg_size
 - 1))));

275 
Ãxt_group
:

276 
group
 = 
group_d©a
[0].group;

277 ià(
¤c_group
 >ğ
group_d©a
[0].
group
 + 
æex_gd
->
couÁ
)

278  -
ENOSPC
;

279 
¡¬t_blk
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
¤c_group
);

280 
Ï¡_blk
 = 
¡¬t_blk
 + 
group_d©a
[
¤c_group
 - 
group
].
blocks_couÁ
;

282 
ov”h—d
 = 
	`ext4_group_ov”h—d_blocks
(
sb
, 
¤c_group
);

284 
¡¬t_blk
 +ğ
ov”h—d
;

287 
¤c_group
++;

288 ; 
¤c_group
 <ğ
Ï¡_group
; src_group++) {

289 
ov”h—d
 = 
	`ext4_group_ov”h—d_blocks
(
sb
, 
¤c_group
);

290 ià(
ov”h—d
 == 0)

291 
Ï¡_blk
 +ğ
group_d©a
[
¤c_group
 - 
group
].
blocks_couÁ
;

297 ; 
bb_šdex
 < 
æex_gd
->
couÁ
; bb_index++) {

298 ià(
¡¬t_blk
 >ğ
Ï¡_blk
)

299 
Ãxt_group
;

300 
group_d©a
[
bb_šdex
].
block_b™m­
 = 
¡¬t_blk
++;

301 
group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
¡¬t_blk
 - 1);

302 
group
 -ğ
group_d©a
[0].group;

303 
group_d©a
[
group
].
md©a_blocks
++;

304 
æex_gd
->
bg_æags
[
group
] &ğ
unš™_mask
;

308 ; 
ib_šdex
 < 
æex_gd
->
couÁ
; ib_index++) {

309 ià(
¡¬t_blk
 >ğ
Ï¡_blk
)

310 
Ãxt_group
;

311 
group_d©a
[
ib_šdex
].
šode_b™m­
 = 
¡¬t_blk
++;

312 
group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
¡¬t_blk
 - 1);

313 
group
 -ğ
group_d©a
[0].group;

314 
group_d©a
[
group
].
md©a_blocks
++;

315 
æex_gd
->
bg_æags
[
group
] &ğ
unš™_mask
;

319 ; 
™_šdex
 < 
æex_gd
->
couÁ
; it_index++) {

320 
™b
 = 
	`EXT4_SB
(
sb
)->
s_™b_³r_group
;

321 
ext4_fsblk_t
 
Ãxt_group_¡¬t
;

323 ià(
¡¬t_blk
 + 
™b
 > 
Ï¡_blk
)

324 
Ãxt_group
;

325 
group_d©a
[
™_šdex
].
šode_bË
 = 
¡¬t_blk
;

326 
group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
¡¬t_blk
);

327 
Ãxt_group_¡¬t
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
group
 + 1);

328 
group
 -ğ
group_d©a
[0].group;

330 ià(
¡¬t_blk
 + 
™b
 > 
Ãxt_group_¡¬t
) {

331 
æex_gd
->
bg_æags
[
group
 + 1] &ğ
unš™_mask
;

332 
ov”h—d
 = 
¡¬t_blk
 + 
™b
 - 
Ãxt_group_¡¬t
;

333 
group_d©a
[
group
 + 1].
md©a_blocks
 +ğ
ov”h—d
;

334 
™b
 -ğ
ov”h—d
;

337 
group_d©a
[
group
].
md©a_blocks
 +ğ
™b
;

338 
æex_gd
->
bg_æags
[
group
] &ğ
unš™_mask
;

339 
¡¬t_blk
 +ğ
	`EXT4_SB
(
sb
)->
s_™b_³r_group
;

343 
i
 = 0; i < 
æex_gd
->
couÁ
; i++) {

344 
group_d©a
[
i
].
ä“_şu¡”s_couÁ
 -=

345 
	`EXT4_NUM_B2C
(
	`EXT4_SB
(
sb
),

346 
group_d©a
[
i
].
md©a_blocks
);

349 ià(
	`‹¡_İt
(
sb
, 
DEBUG
)) {

350 
i
;

351 
group
 = 
group_d©a
[0].group;

353 
	`´štk
(
KERN_DEBUG
 "EXT4-fs:‡dding‡ flex group with "

354 "%d groups, fËxbg sizi %d:\n", 
æex_gd
->
couÁ
,

355 
æexbg_size
);

357 
i
 = 0; i < 
æex_gd
->
couÁ
; i++) {

358 
	`ext4_debug
(

360 
	`ext4_bg_has_su³r
(
sb
, 
group
 + 
i
) ? "normal" :

361 "no-su³r", 
group
 + 
i
,

362 
group_d©a
[
i
].
blocks_couÁ
,

363 
group_d©a
[
i
].
ä“_şu¡”s_couÁ
,

364 
group_d©a
[
i
].
md©a_blocks
);

368 
	}
}

370 
bufãr_h—d
 *
	$bş—n
(
hªdË_t
 *
hªdË
, 
su³r_block
 *
sb
,

371 
ext4_fsblk_t
 
blk
)

373 
bufãr_h—d
 *
bh
;

374 
”r
;

376 
bh
 = 
	`sb_g‘blk
(
sb
, 
blk
);

377 ià(
	`uÆik–y
(!
bh
))

378  
	`ERR_PTR
(-
ENOMEM
);

379 
	`BUFFER_TRACE
(
bh
, "get_write_access");

380 ià((
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
))) {

381 
	`b»l£
(
bh
);

382 
bh
 = 
	`ERR_PTR
(
”r
);

384 
	`mem£t
(
bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

385 
	`£t_bufãr_u±od©e
(
bh
);

388  
bh
;

389 
	}
}

396 
	$ex‹nd_Ü_»¡¬t_Œª§ùiÚ
(
hªdË_t
 *
hªdË
, 
th»sh
)

398 
”r
;

400 ià(
	`ext4_hªdË_has_’ough_üed™s
(
hªdË
, 
th»sh
))

403 
”r
 = 
	`ext4_jouº®_ex‹nd
(
hªdË
, 
EXT4_MAX_TRANS_DATA
);

404 ià(
”r
 < 0)

405  
”r
;

406 ià(
”r
) {

407 
”r
 = 
	`ext4_jouº®_»¡¬t
(
hªdË
, 
EXT4_MAX_TRANS_DATA
);

408 ià(
”r
)

409  
”r
;

413 
	}
}

424 
	$£t_æexbg_block_b™m­
(
su³r_block
 *
sb
, 
hªdË_t
 *
hªdË
,

425 
ext4_Ãw_æex_group_d©a
 *
æex_gd
,

426 
ext4_fsblk_t
 
fœ¡_şu¡”
,ƒxt4_fsblk_ˆ
Ï¡_şu¡”
)

428 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

429 
ext4_group_t
 
couÁ
 = 
Ï¡_şu¡”
 - 
fœ¡_şu¡”
 + 1;

430 
ext4_group_t
 
couÁ2
;

432 
	`ext4_debug
("m¬k clu¡” [%Îu-%Îu] u£d\n", 
fœ¡_şu¡”
,

433 
Ï¡_şu¡”
);

434 
couÁ2
 = 
couÁ
; count > 0;

435 
couÁ
 -ğ
couÁ2
, 
fœ¡_şu¡”
 += count2) {

436 
ext4_fsblk_t
 
¡¬t
;

437 
bufãr_h—d
 *
bh
;

438 
ext4_group_t
 
group
;

439 
”r
;

441 
group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
	`EXT4_C2B
(
sbi
, 
fœ¡_şu¡”
));

442 
¡¬t
 = 
	`EXT4_B2C
(
sbi
, 
	`ext4_group_fœ¡_block_no
(
sb
, 
group
));

443 
group
 -ğ
æex_gd
->
groups
[0].group;

445 
couÁ2
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
è- (
fœ¡_şu¡”
 - 
¡¬t
);

446 ià(
couÁ2
 > 
couÁ
)

447 
couÁ2
 = 
couÁ
;

449 ià(
æex_gd
->
bg_æags
[
group
] & 
EXT4_BG_BLOCK_UNINIT
) {

450 
	`BUG_ON
(
æex_gd
->
couÁ
 > 1);

454 
”r
 = 
	`ex‹nd_Ü_»¡¬t_Œª§ùiÚ
(
hªdË
, 1);

455 ià(
”r
)

456  
”r
;

458 
bh
 = 
	`sb_g‘blk
(
sb
, 
æex_gd
->
groups
[
group
].
block_b™m­
);

459 ià(
	`uÆik–y
(!
bh
))

460  -
ENOMEM
;

462 
	`BUFFER_TRACE
(
bh
, "get_write_access");

463 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

464 ià(
”r
) {

465 
	`b»l£
(
bh
);

466  
”r
;

468 
	`ext4_debug
("mark block bitmap %#04llx (+%llu/%u)\n",

469 
fœ¡_şu¡”
, fœ¡_şu¡” - 
¡¬t
, 
couÁ2
);

470 
	`ext4_£t_b™s
(
bh
->
b_d©a
, 
fœ¡_şu¡”
 - 
¡¬t
, 
couÁ2
);

472 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

473 
	`b»l£
(
bh
);

474 ià(
	`uÆik–y
(
”r
))

475  
”r
;

479 
	}
}

495 
	$£tup_Ãw_æex_group_blocks
(
su³r_block
 *
sb
,

496 
ext4_Ãw_æex_group_d©a
 *
æex_gd
)

498 
group_bË_couÁ
[] = {1, 1, 
	`EXT4_SB
(
sb
)->
s_™b_³r_group
};

499 
ext4_fsblk_t
 
¡¬t
;

500 
ext4_fsblk_t
 
block
;

501 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

502 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

503 
ext4_Ãw_group_d©a
 *
group_d©a
 = 
æex_gd
->
groups
;

504 
__u16
 *
bg_æags
 = 
æex_gd
->bg_flags;

505 
hªdË_t
 *
hªdË
;

506 
ext4_group_t
 
group
, 
couÁ
;

507 
bufãr_h—d
 *
bh
 = 
NULL
;

508 
»£rved_gdb
, 
i
, 
j
, 
”r
 = 0, 
”r2
;

509 
m‘a_bg
;

511 
	`BUG_ON
(!
æex_gd
->
couÁ
 || !
group_d©a
 ||

512 
group_d©a
[0].
group
 !ğ
sbi
->
s_groups_couÁ
);

514 
»£rved_gdb
 = 
	`Ë16_to_ıu
(
es
->
s_»£rved_gdt_blocks
);

515 
m‘a_bg
 = 
	`ext4_has_ã©u»_m‘a_bg
(
sb
);

518 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_RESIZE
, 
EXT4_MAX_TRANS_DATA
);

519 ià(
	`IS_ERR
(
hªdË
))

520  
	`PTR_ERR
(
hªdË
);

522 
group
 = 
group_d©a
[0].group;

523 
i
 = 0; i < 
æex_gd
->
couÁ
; i++, 
group
++) {

524 
gdblocks
;

525 
ext4_g½blk_t
 
ov”h—d
;

527 
gdblocks
 = 
	`ext4_bg_num_gdb
(
sb
, 
group
);

528 
¡¬t
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
group
);

530 ià(
m‘a_bg
 =ğ0 && !
	`ext4_bg_has_su³r
(
sb
, 
group
))

531 
hªdË_™b
;

533 ià(
m‘a_bg
 == 1) {

534 
ext4_group_t
 
fœ¡_group
;

535 
fœ¡_group
 = 
	`ext4_m‘a_bg_fœ¡_group
(
sb
, 
group
);

536 ià(
fœ¡_group
 !ğ
group
 + 1 &&

537 
fœ¡_group
 !ğ
group
 + 
	`EXT4_DESC_PER_BLOCK
(
sb
) - 1)

538 
hªdË_™b
;

541 
block
 = 
¡¬t
 + 
	`ext4_bg_has_su³r
(
sb
, 
group
);

543 
j
 = 0; j < 
gdblocks
; j++, 
block
++) {

544 
bufãr_h—d
 *
gdb
;

546 
	`ext4_debug
("upd©backu°grou°%#04Îx\n", 
block
);

547 
”r
 = 
	`ex‹nd_Ü_»¡¬t_Œª§ùiÚ
(
hªdË
, 1);

548 ià(
”r
)

549 
out
;

551 
gdb
 = 
	`sb_g‘blk
(
sb
, 
block
);

552 ià(
	`uÆik–y
(!
gdb
)) {

553 
”r
 = -
ENOMEM
;

554 
out
;

557 
	`BUFFER_TRACE
(
gdb
, "get_write_access");

558 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
gdb
);

559 ià(
”r
) {

560 
	`b»l£
(
gdb
);

561 
out
;

563 
	`memıy
(
gdb
->
b_d©a
, 
sbi
->
s_group_desc
[
j
]->b_data,

564 
gdb
->
b_size
);

565 
	`£t_bufãr_u±od©e
(
gdb
);

567 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
gdb
);

568 ià(
	`uÆik–y
(
”r
)) {

569 
	`b»l£
(
gdb
);

570 
out
;

572 
	`b»l£
(
gdb
);

578 ià(
	`ext4_bg_has_su³r
(
sb
, 
group
)) {

579 
”r
 = 
	`sb_issue_z”oout
(
sb
, 
gdblocks
 + 
¡¬t
 + 1,

580 
»£rved_gdb
, 
GFP_NOFS
);

581 ià(
”r
)

582 
out
;

585 
hªdË_™b
:

587 ià(!(
bg_æags
[
i
] & 
EXT4_BG_INODE_ZEROED
))

588 
hªdË_bb
;

591 
block
 = 
group_d©a
[
i
].
šode_bË
;

592 
	`ext4_debug
("clear inodeable blocks %#04llx -> %#04lx\n",

593 
block
, 
sbi
->
s_™b_³r_group
);

594 
”r
 = 
	`sb_issue_z”oout
(
sb
, 
block
, 
sbi
->
s_™b_³r_group
,

595 
GFP_NOFS
);

596 ià(
”r
)

597 
out
;

599 
hªdË_bb
:

600 ià(
bg_æags
[
i
] & 
EXT4_BG_BLOCK_UNINIT
)

601 
hªdË_ib
;

604 
block
 = 
group_d©a
[
i
].
block_b™m­
;

605 
”r
 = 
	`ex‹nd_Ü_»¡¬t_Œª§ùiÚ
(
hªdË
, 1);

606 ià(
”r
)

607 
out
;

609 
bh
 = 
	`bş—n
(
hªdË
, 
sb
, 
block
);

610 ià(
	`IS_ERR
(
bh
)) {

611 
”r
 = 
	`PTR_ERR
(
bh
);

612 
out
;

614 
ov”h—d
 = 
	`ext4_group_ov”h—d_blocks
(
sb
, 
group
);

615 ià(
ov”h—d
 != 0) {

616 
	`ext4_debug
("mark backup superblock %#04llx (+0)\n",

617 
¡¬t
);

618 
	`ext4_£t_b™s
(
bh
->
b_d©a
, 0,

619 
	`EXT4_NUM_B2C
(
sbi
, 
ov”h—d
));

621 
	`ext4_m¬k_b™m­_’d
(
	`EXT4_B2C
(
sbi
, 
group_d©a
[
i
].
blocks_couÁ
),

622 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

623 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

624 
	`b»l£
(
bh
);

625 ià(
”r
)

626 
out
;

628 
hªdË_ib
:

629 ià(
bg_æags
[
i
] & 
EXT4_BG_INODE_UNINIT
)

633 
block
 = 
group_d©a
[
i
].
šode_b™m­
;

634 
”r
 = 
	`ex‹nd_Ü_»¡¬t_Œª§ùiÚ
(
hªdË
, 1);

635 ià(
”r
)

636 
out
;

638 
bh
 = 
	`bş—n
(
hªdË
, 
sb
, 
block
);

639 ià(
	`IS_ERR
(
bh
)) {

640 
”r
 = 
	`PTR_ERR
(
bh
);

641 
out
;

644 
	`ext4_m¬k_b™m­_’d
(
	`EXT4_INODES_PER_GROUP
(
sb
),

645 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

646 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

647 
	`b»l£
(
bh
);

648 ià(
”r
)

649 
out
;

653 
j
 = 0; j < 
GROUP_TABLE_COUNT
; j++) {

654 
couÁ
 = 
group_bË_couÁ
[
j
];

655 
¡¬t
 = (&
group_d©a
[0].
block_b™m­
)[
j
];

656 
block
 = 
¡¬t
;

657 
i
 = 1; i < 
æex_gd
->
couÁ
; i++) {

658 
block
 +ğ
group_bË_couÁ
[
j
];

659 ià(
block
 =ğ(&
group_d©a
[
i
].
block_b™m­
)[
j
]) {

660 
couÁ
 +ğ
group_bË_couÁ
[
j
];

663 
”r
 = 
	`£t_æexbg_block_b™m­
(
sb
, 
hªdË
,

664 
æex_gd
,

665 
	`EXT4_B2C
(
sbi
, 
¡¬t
),

666 
	`EXT4_B2C
(
sbi
,

667 
¡¬t
 + 
couÁ


669 ià(
”r
)

670 
out
;

671 
couÁ
 = 
group_bË_couÁ
[
j
];

672 
¡¬t
 = (&
group_d©a
[
i
].
block_b™m­
)[
j
];

673 
block
 = 
¡¬t
;

676 ià(
couÁ
) {

677 
”r
 = 
	`£t_æexbg_block_b™m­
(
sb
, 
hªdË
,

678 
æex_gd
,

679 
	`EXT4_B2C
(
sbi
, 
¡¬t
),

680 
	`EXT4_B2C
(
sbi
,

681 
¡¬t
 + 
couÁ


683 ià(
”r
)

684 
out
;

688 
out
:

689 
”r2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

690 ià(
”r2
 && !
”r
)

691 
”r
 = 
”r2
;

693  
”r
;

694 
	}
}

703 
	$ext4_li¡_backups
(
su³r_block
 *
sb
, *
th»e
,

704 *
five
, *
£v’
)

706 *
mš
 = 
th»e
;

707 
muÉ
 = 3;

708 
»t
;

710 ià(!
	`ext4_has_ã©u»_¥¬£_su³r
(
sb
)) {

711 
»t
 = *
mš
;

712 *
mš
 += 1;

713  
»t
;

716 ià(*
five
 < *
mš
) {

717 
mš
 = 
five
;

718 
muÉ
 = 5;

720 ià(*
£v’
 < *
mš
) {

721 
mš
 = 
£v’
;

722 
muÉ
 = 7;

725 
»t
 = *
mš
;

726 *
mš
 *ğ
muÉ
;

728  
»t
;

729 
	}
}

736 
	$v”ify_»£rved_gdb
(
su³r_block
 *
sb
,

737 
ext4_group_t
 
’d
,

738 
bufãr_h—d
 *
´im¬y
)

740 cÚ¡ 
ext4_fsblk_t
 
blk
 = 
´im¬y
->
b_blockÄ
;

741 
th»e
 = 1;

742 
five
 = 5;

743 
£v’
 = 7;

744 
g½
;

745 
__Ë32
 *
p
 = (__Ë32 *)
´im¬y
->
b_d©a
;

746 
gdbackups
 = 0;

748 (
g½
 = 
	`ext4_li¡_backups
(
sb
, &
th»e
, &
five
, &
£v’
)è< 
’d
) {

749 ià(
	`Ë32_to_ıu
(*
p
++) !=

750 
g½
 * 
	`EXT4_BLOCKS_PER_GROUP
(
sb
è+ 
blk
){

751 
	`ext4_w¬nšg
(
sb
, "reserved GDT %llu"

753 
blk
, 
g½
,

754 
g½
 *

755 (
ext4_fsblk_t
)
	`EXT4_BLOCKS_PER_GROUP
(
sb
) +

756 
blk
);

757  -
EINVAL
;

759 ià(++
gdbackups
 > 
	`EXT4_ADDR_PER_BLOCK
(
sb
))

760  -
EFBIG
;

763  
gdbackups
;

764 
	}
}

779 
	$add_Ãw_gdb
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

780 
ext4_group_t
 
group
)

782 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

783 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

784 
gdb_num
 = 
group
 / 
	`EXT4_DESC_PER_BLOCK
(
sb
);

785 
ext4_fsblk_t
 
gdblock
 = 
	`EXT4_SB
(
sb
)->
s_sbh
->
b_blockÄ
 + 1 + 
gdb_num
;

786 
bufãr_h—d
 **
o_group_desc
, **
n_group_desc
 = 
NULL
;

787 
bufãr_h—d
 *
dšd
 = 
NULL
;

788 
bufãr_h—d
 *
gdb_bh
 = 
NULL
;

789 
gdbackups
;

790 
ext4_oc
 
oc
 = { .
bh
 = 
NULL
 };

791 
__Ë32
 *
d©a
;

792 
”r
;

794 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

795 
	`´štk
(
KERN_DEBUG


797 
gdb_num
);

799 
gdb_bh
 = 
	`ext4_sb_b»ad
(
sb
, 
gdblock
, 0);

800 ià(
	`IS_ERR
(
gdb_bh
))

801  
	`PTR_ERR
(
gdb_bh
);

803 
gdbackups
 = 
	`v”ify_»£rved_gdb
(
sb
, 
group
, 
gdb_bh
);

804 ià(
gdbackups
 < 0) {

805 
”r
 = 
gdbackups
;

806 
”rout
;

809 
d©a
 = 
	`EXT4_I
(
šode
)->
i_d©a
 + 
EXT4_DIND_BLOCK
;

810 
dšd
 = 
	`ext4_sb_b»ad
(
sb
, 
	`Ë32_to_ıu
(*
d©a
), 0);

811 ià(
	`IS_ERR
(
dšd
)) {

812 
”r
 = 
	`PTR_ERR
(
dšd
);

813 
dšd
 = 
NULL
;

814 
”rout
;

817 
d©a
 = (
__Ë32
 *)
dšd
->
b_d©a
;

818 ià(
	`Ë32_to_ıu
(
d©a
[
gdb_num
 % 
	`EXT4_ADDR_PER_BLOCK
(
sb
)]è!ğ
gdblock
) {

819 
	`ext4_w¬nšg
(
sb
, "new group %u GDT block %llu‚ot„eserved",

820 
group
, 
gdblock
);

821 
”r
 = -
EINVAL
;

822 
”rout
;

825 
	`BUFFER_TRACE
(
	`EXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

826 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
	`EXT4_SB
(
sb
)->
s_sbh
);

827 ià(
	`uÆik–y
(
”r
))

828 
”rout
;

830 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

831 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
gdb_bh
);

832 ià(
	`uÆik–y
(
”r
))

833 
”rout
;

835 
	`BUFFER_TRACE
(
dšd
, "get_write_access");

836 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
dšd
);

837 ià(
	`uÆik–y
(
”r
))

838 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

841 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
);

842 ià(
	`uÆik–y
(
”r
))

843 
”rout
;

845 
n_group_desc
 = 
	`ext4_kvm®loc
((
gdb_num
 + 1) *

846 (
bufãr_h—d
 *),

847 
GFP_NOFS
);

848 ià(!
n_group_desc
) {

849 
”r
 = -
ENOMEM
;

850 
	`ext4_w¬nšg
(
sb
, "notƒnough memory for %lu groups",

851 
gdb_num
 + 1);

852 
”rout
;

864 
d©a
[
gdb_num
 % 
	`EXT4_ADDR_PER_BLOCK
(
sb
)] = 0;

865 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
dšd
);

866 ià(
	`uÆik–y
(
”r
)) {

867 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

868 
”rout
;

870 
šode
->
i_blocks
 -ğ(
gdbackups
 + 1è* 
sb
->
s_blocksize
 >>

871 (9 - 
	`EXT4_SB
(
sb
)->
s_şu¡”_b™s
);

872 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

873 
	`mem£t
(
gdb_bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

874 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
gdb_bh
);

875 ià(
	`uÆik–y
(
”r
)) {

876 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

877 
oc
.
bh
 = 
NULL
;

878 
”rout
;

880 
	`b»l£
(
dšd
);

882 
o_group_desc
 = 
	`EXT4_SB
(
sb
)->
s_group_desc
;

883 
	`memıy
(
n_group_desc
, 
o_group_desc
,

884 
	`EXT4_SB
(
sb
)->
s_gdb_couÁ
 * (
bufãr_h—d
 *));

885 
n_group_desc
[
gdb_num
] = 
gdb_bh
;

886 
	`EXT4_SB
(
sb
)->
s_group_desc
 = 
n_group_desc
;

887 
	`EXT4_SB
(
sb
)->
s_gdb_couÁ
++;

888 
	`kvä“
(
o_group_desc
);

890 
	`Ë16_add_ıu
(&
es
->
s_»£rved_gdt_blocks
, -1);

891 
”r
 = 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
);

892 ià(
”r
)

893 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

894  
”r
;

895 
”rout
:

896 
	`kvä“
(
n_group_desc
);

897 
	`b»l£
(
oc
.
bh
);

898 
	`b»l£
(
dšd
);

899 
	`b»l£
(
gdb_bh
);

901 
	`ext4_debug
("Ëavšg w™hƒ¼Ü %d\n", 
”r
);

902  
”r
;

903 
	}
}

908 
	$add_Ãw_gdb_m‘a_bg
(
su³r_block
 *
sb
,

909 
hªdË_t
 *
hªdË
, 
ext4_group_t
 
group
) {

910 
ext4_fsblk_t
 
gdblock
;

911 
bufãr_h—d
 *
gdb_bh
;

912 
bufãr_h—d
 **
o_group_desc
, **
n_group_desc
;

913 
gdb_num
 = 
group
 / 
	`EXT4_DESC_PER_BLOCK
(
sb
);

914 
”r
;

916 
gdblock
 = 
	`ext4_m‘a_bg_fœ¡_block_no
(
sb
, 
group
) +

917 
	`ext4_bg_has_su³r
(
sb
, 
group
);

918 
gdb_bh
 = 
	`ext4_sb_b»ad
(
sb
, 
gdblock
, 0);

919 ià(
	`IS_ERR
(
gdb_bh
))

920  
	`PTR_ERR
(
gdb_bh
);

921 
n_group_desc
 = 
	`ext4_kvm®loc
((
gdb_num
 + 1) *

922 (
bufãr_h—d
 *),

923 
GFP_NOFS
);

924 ià(!
n_group_desc
) {

925 
	`b»l£
(
gdb_bh
);

926 
”r
 = -
ENOMEM
;

927 
	`ext4_w¬nšg
(
sb
, "notƒnough memory for %lu groups",

928 
gdb_num
 + 1);

929  
”r
;

932 
o_group_desc
 = 
	`EXT4_SB
(
sb
)->
s_group_desc
;

933 
	`memıy
(
n_group_desc
, 
o_group_desc
,

934 
	`EXT4_SB
(
sb
)->
s_gdb_couÁ
 * (
bufãr_h—d
 *));

935 
n_group_desc
[
gdb_num
] = 
gdb_bh
;

937 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

938 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
gdb_bh
);

939 ià(
”r
) {

940 
	`kvä“
(
n_group_desc
);

941 
	`b»l£
(
gdb_bh
);

942  
”r
;

945 
	`EXT4_SB
(
sb
)->
s_group_desc
 = 
n_group_desc
;

946 
	`EXT4_SB
(
sb
)->
s_gdb_couÁ
++;

947 
	`kvä“
(
o_group_desc
);

948  
”r
;

949 
	}
}

964 
	$»£rve_backup_gdb
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

965 
ext4_group_t
 
group
)

967 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

968 
»£rved_gdb
 =
	`Ë16_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_»£rved_gdt_blocks
);

969 
şu¡”_b™s
 = 
	`EXT4_SB
(
sb
)->
s_şu¡”_b™s
;

970 
bufãr_h—d
 **
´im¬y
;

971 
bufãr_h—d
 *
dšd
;

972 
ext4_oc
 
oc
;

973 
ext4_fsblk_t
 
blk
;

974 
__Ë32
 *
d©a
, *
’d
;

975 
gdbackups
 = 0;

976 
»s
, 
i
;

977 
”r
;

979 
´im¬y
 = 
	`km®loc_¬¿y
(
»£rved_gdb
, (*´im¬y), 
GFP_NOFS
);

980 ià(!
´im¬y
)

981  -
ENOMEM
;

983 
d©a
 = 
	`EXT4_I
(
šode
)->
i_d©a
 + 
EXT4_DIND_BLOCK
;

984 
dšd
 = 
	`ext4_sb_b»ad
(
sb
, 
	`Ë32_to_ıu
(*
d©a
), 0);

985 ià(
	`IS_ERR
(
dšd
)) {

986 
”r
 = 
	`PTR_ERR
(
dšd
);

987 
dšd
 = 
NULL
;

988 
ex™_ä“
;

991 
blk
 = 
	`EXT4_SB
(
sb
)->
s_sbh
->
b_blockÄ
 + 1 + EXT4_SB(sb)->
s_gdb_couÁ
;

992 
d©a
 = (
__Ë32
 *)
dšd
->
b_d©a
 + (
	`EXT4_SB
(
sb
)->
s_gdb_couÁ
 %

993 
	`EXT4_ADDR_PER_BLOCK
(
sb
));

994 
’d
 = (
__Ë32
 *)
dšd
->
b_d©a
 + 
	`EXT4_ADDR_PER_BLOCK
(
sb
);

997 
»s
 = 0;„e < 
»£rved_gdb
;„es++, 
blk
++) {

998 ià(
	`Ë32_to_ıu
(*
d©a
è!ğ
blk
) {

999 
	`ext4_w¬nšg
(
sb
, "reserved block %llu"

1001 
blk
,

1002 ()(
d©a
 - (
__Ë32
 *)
dšd
->
b_d©a
));

1003 
”r
 = -
EINVAL
;

1004 
ex™_bh
;

1006 
´im¬y
[
»s
] = 
	`ext4_sb_b»ad
(
sb
, 
blk
, 0);

1007 ià(
	`IS_ERR
(
´im¬y
[
»s
])) {

1008 
”r
 = 
	`PTR_ERR
(
´im¬y
[
»s
]);

1009 
´im¬y
[
»s
] = 
NULL
;

1010 
ex™_bh
;

1012 
gdbackups
 = 
	`v”ify_»£rved_gdb
(
sb
, 
group
, 
´im¬y
[
»s
]);

1013 ià(
gdbackups
 < 0) {

1014 
	`b»l£
(
´im¬y
[
»s
]);

1015 
”r
 = 
gdbackups
;

1016 
ex™_bh
;

1018 ià(++
d©a
 >ğ
’d
)

1019 
d©a
 = (
__Ë32
 *)
dšd
->
b_d©a
;

1022 
i
 = 0; i < 
»£rved_gdb
; i++) {

1023 
	`BUFFER_TRACE
(
´im¬y
[
i
], "get_write_access");

1024 ià((
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
´im¬y
[
i
])))

1025 
ex™_bh
;

1028 ià((
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
)))

1029 
ex™_bh
;

1035 
blk
 = 
group
 * 
	`EXT4_BLOCKS_PER_GROUP
(
sb
);

1036 
i
 = 0; i < 
»£rved_gdb
; i++) {

1037 
”r2
;

1038 
d©a
 = (
__Ë32
 *)
´im¬y
[
i
]->
b_d©a
;

1042 
d©a
[
gdbackups
] = 
	`ıu_to_Ë32
(
blk
 + 
´im¬y
[
i
]->
b_blockÄ
);

1043 
”r2
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
´im¬y
[
i
]);

1044 ià(!
”r
)

1045 
”r
 = 
”r2
;

1048 
šode
->
i_blocks
 +ğ
»£rved_gdb
 * 
sb
->
s_blocksize
 >> (9 - 
şu¡”_b™s
);

1049 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

1051 
ex™_bh
:

1052 --
»s
 >= 0)

1053 
	`b»l£
(
´im¬y
[
»s
]);

1054 
	`b»l£
(
dšd
);

1056 
ex™_ä“
:

1057 
	`kä“
(
´im¬y
);

1059  
”r
;

1060 
	}
}

1078 
	$upd©e_backups
(
su³r_block
 *
sb
, 
£ùÜ_t
 
blk_off
, *
d©a
,

1079 
size
, 
m‘a_bg
)

1081 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1082 
ext4_group_t
 
Ï¡
;

1083 cÚ¡ 
bpg
 = 
	`EXT4_BLOCKS_PER_GROUP
(
sb
);

1084 
th»e
 = 1;

1085 
five
 = 5;

1086 
£v’
 = 7;

1087 
ext4_group_t
 
group
 = 0;

1088 
»¡
 = 
sb
->
s_blocksize
 - 
size
;

1089 
hªdË_t
 *
hªdË
;

1090 
”r
 = 0, 
”r2
;

1092 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_RESIZE
, 
EXT4_MAX_TRANS_DATA
);

1093 ià(
	`IS_ERR
(
hªdË
)) {

1094 
group
 = 1;

1095 
”r
 = 
	`PTR_ERR
(
hªdË
);

1096 
ex™_”r
;

1099 ià(
m‘a_bg
 == 0) {

1100 
group
 = 
	`ext4_li¡_backups
(
sb
, &
th»e
, &
five
, &
£v’
);

1101 
Ï¡
 = 
sbi
->
s_groups_couÁ
;

1103 
group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
blk_off
) + 1;

1104 
Ï¡
 = (
ext4_group_t
)(
group
 + 
	`EXT4_DESC_PER_BLOCK
(
sb
) - 2);

1107 
group
 < 
sbi
->
s_groups_couÁ
) {

1108 
bufãr_h—d
 *
bh
;

1109 
ext4_fsblk_t
 
backup_block
;

1112 ià(
	`ext4_hªdË_v®id
(
hªdË
) &&

1113 
hªdË
->
h_bufãr_üed™s
 == 0 &&

1114 
	`ext4_jouº®_ex‹nd
(
hªdË
, 
EXT4_MAX_TRANS_DATA
) &&

1115 (
”r
 = 
	`ext4_jouº®_»¡¬t
(
hªdË
, 
EXT4_MAX_TRANS_DATA
)))

1118 ià(
m‘a_bg
 == 0)

1119 
backup_block
 = ((
ext4_fsblk_t
)
group
è* 
bpg
 + 
blk_off
;

1121 
backup_block
 = (
	`ext4_group_fœ¡_block_no
(
sb
, 
group
) +

1122 
	`ext4_bg_has_su³r
(
sb
, 
group
));

1124 
bh
 = 
	`sb_g‘blk
(
sb
, 
backup_block
);

1125 ià(
	`uÆik–y
(!
bh
)) {

1126 
”r
 = -
ENOMEM
;

1129 
	`ext4_debug
("update metadata backup %llu(+%llu)\n",

1130 
backup_block
, backup_block -

1131 
	`ext4_group_fœ¡_block_no
(
sb
, 
group
));

1132 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1133 ià((
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
))) {

1134 
	`b»l£
(
bh
);

1137 
	`lock_bufãr
(
bh
);

1138 
	`memıy
(
bh
->
b_d©a
, 
d©a
, 
size
);

1139 ià(
»¡
)

1140 
	`mem£t
(
bh
->
b_d©a
 + 
size
, 0, 
»¡
);

1141 
	`£t_bufãr_u±od©e
(
bh
);

1142 
	`uÆock_bufãr
(
bh
);

1143 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

1144 ià(
	`uÆik–y
(
”r
))

1145 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1146 
	`b»l£
(
bh
);

1148 ià(
m‘a_bg
 == 0)

1149 
group
 = 
	`ext4_li¡_backups
(
sb
, &
th»e
, &
five
, &
£v’
);

1150 ià(
group
 =ğ
Ï¡
)

1153 
group
 = 
Ï¡
;

1155 ià((
”r2
 = 
	`ext4_jouº®_¡İ
(
hªdË
)è&& !
”r
)

1156 
”r
 = 
”r2
;

1168 
ex™_”r
:

1169 ià(
”r
) {

1170 
	`ext4_w¬nšg
(
sb
, "can't update backup for group %u (err %d), "

1171 "fÜcšg fsck oÀÃxˆ»boÙ", 
group
, 
”r
);

1172 
sbi
->
s_mouÁ_¡©e
 &ğ~
EXT4_VALID_FS
;

1173 
sbi
->
s_es
->
s_¡©e
 &ğ
	`ıu_to_Ë16
(~
EXT4_VALID_FS
);

1174 
	`m¬k_bufãr_dœty
(
sbi
->
s_sbh
);

1176 
	}
}

1188 
	$ext4_add_Ãw_descs
(
hªdË_t
 *
hªdË
, 
su³r_block
 *
sb
,

1189 
ext4_group_t
 
group
, 
šode
 *
»size_šode
,

1190 
ext4_group_t
 
couÁ
)

1192 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1193 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

1194 
bufãr_h—d
 *
gdb_bh
;

1195 
i
, 
gdb_off
, 
gdb_num
, 
”r
 = 0;

1196 
m‘a_bg
;

1198 
m‘a_bg
 = 
	`ext4_has_ã©u»_m‘a_bg
(
sb
);

1199 
i
 = 0; i < 
couÁ
; i++, 
group
++) {

1200 
»£rved_gdb
 = 
	`ext4_bg_has_su³r
(
sb
, 
group
) ?

1201 
	`Ë16_to_ıu
(
es
->
s_»£rved_gdt_blocks
) : 0;

1203 
gdb_off
 = 
group
 % 
	`EXT4_DESC_PER_BLOCK
(
sb
);

1204 
gdb_num
 = 
group
 / 
	`EXT4_DESC_PER_BLOCK
(
sb
);

1212 ià(
gdb_off
) {

1213 
gdb_bh
 = 
sbi
->
s_group_desc
[
gdb_num
];

1214 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

1215 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
gdb_bh
);

1217 ià(!
”r
 && 
»£rved_gdb
 && 
	`ext4_bg_num_gdb
(
sb
, 
group
))

1218 
”r
 = 
	`»£rve_backup_gdb
(
hªdË
, 
»size_šode
, 
group
);

1219 } ià(
m‘a_bg
 != 0) {

1220 
”r
 = 
	`add_Ãw_gdb_m‘a_bg
(
sb
, 
hªdË
, 
group
);

1222 
”r
 = 
	`add_Ãw_gdb
(
hªdË
, 
»size_šode
, 
group
);

1224 ià(
”r
)

1227  
”r
;

1228 
	}
}

1230 
bufãr_h—d
 *
	$ext4_g‘_b™m­
(
su³r_block
 *
sb
, 
__u64
 
block
)

1232 
bufãr_h—d
 *
bh
 = 
	`sb_g‘blk
(
sb
, 
block
);

1233 ià(
	`uÆik–y
(!
bh
))

1234  
NULL
;

1235 ià(!
	`bh_u±od©e_Ü_lock
(
bh
)) {

1236 ià(
	`bh_subm™_»ad
(
bh
) < 0) {

1237 
	`b»l£
(
bh
);

1238  
NULL
;

1242  
bh
;

1243 
	}
}

1245 
	$ext4_£t_b™m­_checksums
(
su³r_block
 *
sb
,

1246 
ext4_group_t
 
group
,

1247 
ext4_group_desc
 *
gdp
,

1248 
ext4_Ãw_group_d©a
 *
group_d©a
)

1250 
bufãr_h—d
 *
bh
;

1252 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

1255 
bh
 = 
	`ext4_g‘_b™m­
(
sb
, 
group_d©a
->
šode_b™m­
);

1256 ià(!
bh
)

1257  -
EIO
;

1258 
	`ext4_šode_b™m­_csum_£t
(
sb
, 
group
, 
gdp
, 
bh
,

1259 
	`EXT4_INODES_PER_GROUP
(
sb
) / 8);

1260 
	`b»l£
(
bh
);

1262 
bh
 = 
	`ext4_g‘_b™m­
(
sb
, 
group_d©a
->
block_b™m­
);

1263 ià(!
bh
)

1264  -
EIO
;

1265 
	`ext4_block_b™m­_csum_£t
(
sb
, 
group
, 
gdp
, 
bh
);

1266 
	`b»l£
(
bh
);

1269 
	}
}

1274 
	$ext4_£tup_Ãw_descs
(
hªdË_t
 *
hªdË
, 
su³r_block
 *
sb
,

1275 
ext4_Ãw_æex_group_d©a
 *
æex_gd
)

1277 
ext4_Ãw_group_d©a
 *
group_d©a
 = 
æex_gd
->
groups
;

1278 
ext4_group_desc
 *
gdp
;

1279 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1280 
bufãr_h—d
 *
gdb_bh
;

1281 
ext4_group_t
 
group
;

1282 
__u16
 *
bg_æags
 = 
æex_gd
->bg_flags;

1283 
i
, 
gdb_off
, 
gdb_num
, 
”r
 = 0;

1286 
i
 = 0; i < 
æex_gd
->
couÁ
; i++, 
group_d©a
++, 
bg_æags
++) {

1287 
group
 = 
group_d©a
->group;

1289 
gdb_off
 = 
group
 % 
	`EXT4_DESC_PER_BLOCK
(
sb
);

1290 
gdb_num
 = 
group
 / 
	`EXT4_DESC_PER_BLOCK
(
sb
);

1295 
gdb_bh
 = 
sbi
->
s_group_desc
[
gdb_num
];

1297 
gdp
 = (
ext4_group_desc
 *)(
gdb_bh
->
b_d©a
 +

1298 
gdb_off
 * 
	`EXT4_DESC_SIZE
(
sb
));

1300 
	`mem£t
(
gdp
, 0, 
	`EXT4_DESC_SIZE
(
sb
));

1301 
	`ext4_block_b™m­_£t
(
sb
, 
gdp
, 
group_d©a
->
block_b™m­
);

1302 
	`ext4_šode_b™m­_£t
(
sb
, 
gdp
, 
group_d©a
->
šode_b™m­
);

1303 
”r
 = 
	`ext4_£t_b™m­_checksums
(
sb
, 
group
, 
gdp
, 
group_d©a
);

1304 ià(
”r
) {

1305 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1309 
	`ext4_šode_bË_£t
(
sb
, 
gdp
, 
group_d©a
->
šode_bË
);

1310 
	`ext4_ä“_group_şu¡”s_£t
(
sb
, 
gdp
,

1311 
group_d©a
->
ä“_şu¡”s_couÁ
);

1312 
	`ext4_ä“_šodes_£t
(
sb
, 
gdp
, 
	`EXT4_INODES_PER_GROUP
(sb));

1313 ià(
	`ext4_has_group_desc_csum
(
sb
))

1314 
	`ext4_™abË_unu£d_£t
(
sb
, 
gdp
,

1315 
	`EXT4_INODES_PER_GROUP
(
sb
));

1316 
gdp
->
bg_æags
 = 
	`ıu_to_Ë16
(*bg_flags);

1317 
	`ext4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1319 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
gdb_bh
);

1320 ià(
	`uÆik–y
(
”r
)) {

1321 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1329 
”r
 = 
	`ext4_mb_add_groupšfo
(
sb
, 
group
, 
gdp
);

1330 ià(
”r
)

1333  
”r
;

1334 
	}
}

1343 
	$ext4_upd©e_su³r
(
su³r_block
 *
sb
,

1344 
ext4_Ãw_æex_group_d©a
 *
æex_gd
)

1346 
ext4_fsblk_t
 
blocks_couÁ
 = 0;

1347 
ext4_fsblk_t
 
ä“_blocks
 = 0;

1348 
ext4_fsblk_t
 
»£rved_blocks
 = 0;

1349 
ext4_Ãw_group_d©a
 *
group_d©a
 = 
æex_gd
->
groups
;

1350 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1351 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

1352 
i
;

1354 
	`BUG_ON
(
æex_gd
->
couÁ
 =ğ0 || 
group_d©a
 =ğ
NULL
);

1365 
i
 = 0; i < 
æex_gd
->
couÁ
; i++) {

1366 
blocks_couÁ
 +ğ
group_d©a
[
i
].blocks_count;

1367 
ä“_blocks
 +ğ
	`EXT4_C2B
(
sbi
, 
group_d©a
[
i
].
ä“_şu¡”s_couÁ
);

1370 
»£rved_blocks
 = 
	`ext4_r_blocks_couÁ
(
es
) * 100;

1371 
»£rved_blocks
 = 
	`div64_u64
Ôe£rved_blocks, 
	`ext4_blocks_couÁ
(
es
));

1372 
»£rved_blocks
 *ğ
blocks_couÁ
;

1373 
	`do_div
(
»£rved_blocks
, 100);

1375 
	`ext4_blocks_couÁ_£t
(
es
, 
	`ext4_blocks_couÁ
Ósè+ 
blocks_couÁ
);

1376 
	`ext4_ä“_blocks_couÁ_£t
(
es
, 
	`ext4_ä“_blocks_couÁ
Ósè+ 
ä“_blocks
);

1377 
	`Ë32_add_ıu
(&
es
->
s_šodes_couÁ
, 
	`EXT4_INODES_PER_GROUP
(
sb
) *

1378 
æex_gd
->
couÁ
);

1379 
	`Ë32_add_ıu
(&
es
->
s_ä“_šodes_couÁ
, 
	`EXT4_INODES_PER_GROUP
(
sb
) *

1380 
æex_gd
->
couÁ
);

1382 
	`ext4_debug
("ä“ block couÁ %Îu", 
	`ext4_ä“_blocks_couÁ
(
es
));

1401 
	`smp_wmb
();

1404 
sbi
->
s_groups_couÁ
 +ğ
æex_gd
->
couÁ
;

1405 
sbi
->
s_blockfe_groups
 = 
	`mš_t
(
ext4_group_t
, sbi->
s_groups_couÁ
,

1406 (
EXT4_MAX_BLOCK_FILE_PHYS
 / 
	`EXT4_BLOCKS_PER_GROUP
(
sb
)));

1410 
	`ext4_r_blocks_couÁ_£t
(
es
, 
	`ext4_r_blocks_couÁ
(es) +

1411 
»£rved_blocks
);

1414 
	`³rıu_couÁ”_add
(&
sbi
->
s_ä“şu¡”s_couÁ”
,

1415 
	`EXT4_NUM_B2C
(
sbi
, 
ä“_blocks
));

1416 
	`³rıu_couÁ”_add
(&
sbi
->
s_ä“šodes_couÁ”
,

1417 
	`EXT4_INODES_PER_GROUP
(
sb
è* 
æex_gd
->
couÁ
);

1419 
	`ext4_debug
("free blocks count %llu",

1420 
	`³rıu_couÁ”_»ad
(&
sbi
->
s_ä“şu¡”s_couÁ”
));

1421 ià(
	`ext4_has_ã©u»_æex_bg
(
sb
è&& 
sbi
->
s_log_groups_³r_æex
) {

1422 
ext4_group_t
 
æex_group
;

1423 
æex_group
 = 
	`ext4_æex_group
(
sbi
, 
group_d©a
[0].
group
);

1424 
	`©omic64_add
(
	`EXT4_NUM_B2C
(
sbi
, 
ä“_blocks
),

1425 &
sbi
->
s_æex_groups
[
æex_group
].
ä“_şu¡”s
);

1426 
	`©omic_add
(
	`EXT4_INODES_PER_GROUP
(
sb
è* 
æex_gd
->
couÁ
,

1427 &
sbi
->
s_æex_groups
[
æex_group
].
ä“_šodes
);

1433 
	`ext4_ÿlcuÏ‹_ov”h—d
(
sb
);

1435 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

1436 
	`´štk
(
KERN_DEBUG
 "EXT4-fs:‡dded group %u:"

1437 "%Îu blocks(%Îu f»%Îu„e£rved)\n", 
æex_gd
->
couÁ
,

1438 
blocks_couÁ
, 
ä“_blocks
, 
»£rved_blocks
);

1439 
	}
}

1445 
	$ext4_æex_group_add
(
su³r_block
 *
sb
,

1446 
šode
 *
»size_šode
,

1447 
ext4_Ãw_æex_group_d©a
 *
æex_gd
)

1449 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1450 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

1451 
ext4_fsblk_t
 
o_blocks_couÁ
;

1452 
ext4_g½blk_t
 
Ï¡
;

1453 
ext4_group_t
 
group
;

1454 
hªdË_t
 *
hªdË
;

1455 
»£rved_gdb
;

1456 
”r
 = 0, 
”r2
 = 0, 
üed™
;

1458 
	`BUG_ON
(!
æex_gd
->
couÁ
 || !æex_gd->
groups
 || !æex_gd->
bg_æags
);

1460 
»£rved_gdb
 = 
	`Ë16_to_ıu
(
es
->
s_»£rved_gdt_blocks
);

1461 
o_blocks_couÁ
 = 
	`ext4_blocks_couÁ
(
es
);

1462 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
o_blocks_couÁ
, &
group
, &
Ï¡
);

1463 
	`BUG_ON
(
Ï¡
);

1465 
”r
 = 
	`£tup_Ãw_æex_group_blocks
(
sb
, 
æex_gd
);

1466 ià(
”r
)

1467 
ex™
;

1475 
üed™
 = 3;

1477 
üed™
 +ğ1 + 
	`DIV_ROUND_UP
(
æex_gd
->
couÁ
, 
	`EXT4_DESC_PER_BLOCK
(
sb
));

1478 
üed™
 +ğ
»£rved_gdb
;

1479 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_RESIZE
, 
üed™
);

1480 ià(
	`IS_ERR
(
hªdË
)) {

1481 
”r
 = 
	`PTR_ERR
(
hªdË
);

1482 
ex™
;

1485 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

1486 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
sbi
->
s_sbh
);

1487 ià(
”r
)

1488 
ex™_jouº®
;

1490 
group
 = 
æex_gd
->
groups
[0].group;

1491 
	`BUG_ON
(
group
 !ğ
sbi
->
s_groups_couÁ
);

1492 
”r
 = 
	`ext4_add_Ãw_descs
(
hªdË
, 
sb
, 
group
,

1493 
»size_šode
, 
æex_gd
->
couÁ
);

1494 ià(
”r
)

1495 
ex™_jouº®
;

1497 
”r
 = 
	`ext4_£tup_Ãw_descs
(
hªdË
, 
sb
, 
æex_gd
);

1498 ià(
”r
)

1499 
ex™_jouº®
;

1501 
	`ext4_upd©e_su³r
(
sb
, 
æex_gd
);

1503 
”r
 = 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
);

1505 
ex™_jouº®
:

1506 
”r2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

1507 ià(!
”r
)

1508 
”r
 = 
”r2
;

1510 ià(!
”r
) {

1511 
gdb_num
 = 
group
 / 
	`EXT4_DESC_PER_BLOCK
(
sb
);

1512 
gdb_num_’d
 = ((
group
 + 
æex_gd
->
couÁ
 - 1) /

1513 
	`EXT4_DESC_PER_BLOCK
(
sb
));

1514 
m‘a_bg
 = 
	`ext4_has_ã©u»_m‘a_bg
(
sb
);

1515 
£ùÜ_t
 
Şd_gdb
 = 0;

1517 
	`upd©e_backups
(
sb
, 
sbi
->
s_sbh
->
b_blockÄ
, (*)
es
,

1518 (
ext4_su³r_block
), 0);

1519 ; 
gdb_num
 <ğ
gdb_num_’d
; gdb_num++) {

1520 
bufãr_h—d
 *
gdb_bh
;

1522 
gdb_bh
 = 
sbi
->
s_group_desc
[
gdb_num
];

1523 ià(
Şd_gdb
 =ğ
gdb_bh
->
b_blockÄ
)

1525 
	`upd©e_backups
(
sb
, 
gdb_bh
->
b_blockÄ
, gdb_bh->
b_d©a
,

1526 
gdb_bh
->
b_size
, 
m‘a_bg
);

1527 
Şd_gdb
 = 
gdb_bh
->
b_blockÄ
;

1530 
ex™
:

1531  
”r
;

1532 
	}
}

1534 
	$ext4_£tup_Ãxt_æex_gd
(
su³r_block
 *
sb
,

1535 
ext4_Ãw_æex_group_d©a
 *
æex_gd
,

1536 
ext4_fsblk_t
 
n_blocks_couÁ
,

1537 
æexbg_size
)

1539 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1540 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

1541 
ext4_Ãw_group_d©a
 *
group_d©a
 = 
æex_gd
->
groups
;

1542 
ext4_fsblk_t
 
o_blocks_couÁ
;

1543 
ext4_group_t
 
n_group
;

1544 
ext4_group_t
 
group
;

1545 
ext4_group_t
 
Ï¡_group
;

1546 
ext4_g½blk_t
 
Ï¡
;

1547 
ext4_g½blk_t
 
şu¡”s_³r_group
;

1548 
i
;

1550 
şu¡”s_³r_group
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
);

1552 
o_blocks_couÁ
 = 
	`ext4_blocks_couÁ
(
es
);

1554 ià(
o_blocks_couÁ
 =ğ
n_blocks_couÁ
)

1557 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
o_blocks_couÁ
, &
group
, &
Ï¡
);

1558 
	`BUG_ON
(
Ï¡
);

1559 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
n_blocks_couÁ
 - 1, &
n_group
, &
Ï¡
);

1561 
Ï¡_group
 = 
group
 | (
æexbg_size
 - 1);

1562 ià(
Ï¡_group
 > 
n_group
)

1563 
Ï¡_group
 = 
n_group
;

1565 
æex_gd
->
couÁ
 = 
Ï¡_group
 - 
group
 + 1;

1567 
i
 = 0; i < 
æex_gd
->
couÁ
; i++) {

1568 
ov”h—d
;

1570 
group_d©a
[
i
].
group
 = group + i;

1571 
group_d©a
[
i
].
blocks_couÁ
 = 
	`EXT4_BLOCKS_PER_GROUP
(
sb
);

1572 
ov”h—d
 = 
	`ext4_group_ov”h—d_blocks
(
sb
, 
group
 + 
i
);

1573 
group_d©a
[
i
].
md©a_blocks
 = 
ov”h—d
;

1574 
group_d©a
[
i
].
ä“_şu¡”s_couÁ
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
);

1575 ià(
	`ext4_has_group_desc_csum
(
sb
)) {

1576 
æex_gd
->
bg_æags
[
i
] = 
EXT4_BG_BLOCK_UNINIT
 |

1577 
EXT4_BG_INODE_UNINIT
;

1578 ià(!
	`‹¡_İt
(
sb
, 
INIT_INODE_TABLE
))

1579 
æex_gd
->
bg_æags
[
i
] |ğ
EXT4_BG_INODE_ZEROED
;

1581 
æex_gd
->
bg_æags
[
i
] = 
EXT4_BG_INODE_ZEROED
;

1584 ià(
Ï¡_group
 =ğ
n_group
 && 
	`ext4_has_group_desc_csum
(
sb
))

1586 
æex_gd
->
bg_æags
[
i
 - 1] &ğ~
EXT4_BG_BLOCK_UNINIT
;

1588 ià((
Ï¡_group
 =ğ
n_group
è&& (
Ï¡
 !ğ
şu¡”s_³r_group
 - 1)) {

1589 
group_d©a
[
i
 - 1].
blocks_couÁ
 = 
	`EXT4_C2B
(
sbi
, 
Ï¡
 + 1);

1590 
group_d©a
[
i
 - 1].
ä“_şu¡”s_couÁ
 -ğ
şu¡”s_³r_group
 -

1591 
Ï¡
 - 1;

1595 
	}
}

1610 
	$ext4_group_add
(
su³r_block
 *
sb
, 
ext4_Ãw_group_d©a
 *
šput
)

1612 
ext4_Ãw_æex_group_d©a
 
æex_gd
;

1613 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1614 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

1615 
»£rved_gdb
 = 
	`ext4_bg_has_su³r
(
sb
, 
šput
->
group
) ?

1616 
	`Ë16_to_ıu
(
es
->
s_»£rved_gdt_blocks
) : 0;

1617 
šode
 *šodğ
NULL
;

1618 
gdb_off
;

1619 
”r
;

1620 
__u16
 
bg_æags
 = 0;

1622 
gdb_off
 = 
šput
->
group
 % 
	`EXT4_DESC_PER_BLOCK
(
sb
);

1624 ià(
gdb_off
 =ğ0 && !
	`ext4_has_ã©u»_¥¬£_su³r
(
sb
)) {

1625 
	`ext4_w¬nšg
(
sb
, "Can't„esize‚on-sparse filesystem further");

1626  -
EPERM
;

1629 ià(
	`ext4_blocks_couÁ
(
es
è+ 
šput
->
blocks_couÁ
 <

1630 
	`ext4_blocks_couÁ
(
es
)) {

1631 
	`ext4_w¬nšg
(
sb
, "blocks_count overflow");

1632  -
EINVAL
;

1635 ià(
	`Ë32_to_ıu
(
es
->
s_šodes_couÁ
è+ 
	`EXT4_INODES_PER_GROUP
(
sb
) <

1636 
	`Ë32_to_ıu
(
es
->
s_šodes_couÁ
)) {

1637 
	`ext4_w¬nšg
(
sb
, "inodes_count overflow");

1638  -
EINVAL
;

1641 ià(
»£rved_gdb
 || 
gdb_off
 == 0) {

1642 ià(!
	`ext4_has_ã©u»_»size_šode
(
sb
) ||

1643 !
	`Ë16_to_ıu
(
es
->
s_»£rved_gdt_blocks
)) {

1644 
	`ext4_w¬nšg
(
sb
,

1646  -
EPERM
;

1648 
šode
 = 
	`ext4_ig‘
(
sb
, 
EXT4_RESIZE_INO
, 
EXT4_IGET_SPECIAL
);

1649 ià(
	`IS_ERR
(
šode
)) {

1650 
	`ext4_w¬nšg
(
sb
, "Error opening„esize inode");

1651  
	`PTR_ERR
(
šode
);

1656 
”r
 = 
	`v”ify_group_šput
(
sb
, 
šput
);

1657 ià(
”r
)

1658 
out
;

1660 
”r
 = 
	`ext4_®loc_æex_bg_¬¿y
(
sb
, 
šput
->
group
 + 1);

1661 ià(
”r
)

1662 
out
;

1664 
”r
 = 
	`ext4_mb_®loc_groupšfo
(
sb
, 
šput
->
group
 + 1);

1665 ià(
”r
)

1666 
out
;

1668 
æex_gd
.
couÁ
 = 1;

1669 
æex_gd
.
groups
 = 
šput
;

1670 
æex_gd
.
bg_æags
 = &bg_flags;

1671 
”r
 = 
	`ext4_æex_group_add
(
sb
, 
šode
, &
æex_gd
);

1672 
out
:

1673 
	`ut
(
šode
);

1674  
”r
;

1675 
	}
}

1680 
	$ext4_group_ex‹nd_no_check
(
su³r_block
 *
sb
,

1681 
ext4_fsblk_t
 
o_blocks_couÁ
, 
ext4_g½blk_t
 
add
)

1683 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

1684 
hªdË_t
 *
hªdË
;

1685 
”r
 = 0, 
”r2
;

1690 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_RESIZE
, 3);

1691 ià(
	`IS_ERR
(
hªdË
)) {

1692 
”r
 = 
	`PTR_ERR
(
hªdË
);

1693 
	`ext4_w¬nšg
(
sb
, "”rÜ %d oÀjouº® s¹", 
”r
);

1694  
”r
;

1697 
	`BUFFER_TRACE
(
	`EXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

1698 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
	`EXT4_SB
(
sb
)->
s_sbh
);

1699 ià(
”r
) {

1700 
	`ext4_w¬nšg
(
sb
, "”rÜ %d oÀjouº® wr™acûss", 
”r
);

1701 
”rout
;

1704 
	`ext4_blocks_couÁ_£t
(
es
, 
o_blocks_couÁ
 + 
add
);

1705 
	`ext4_ä“_blocks_couÁ_£t
(
es
, 
	`ext4_ä“_blocks_couÁ
Ósè+ 
add
);

1706 
	`ext4_debug
("ä“šg block %Îuhrough %Îu\n", 
o_blocks_couÁ
,

1707 
o_blocks_couÁ
 + 
add
);

1709 
”r
 = 
	`ext4_group_add_blocks
(
hªdË
, 
sb
, 
o_blocks_couÁ
, 
add
);

1710 ià(
”r
)

1711 
”rout
;

1712 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
);

1713 
	`ext4_debug
("ä“d block %Îuhrough %Îu\n", 
o_blocks_couÁ
,

1714 
o_blocks_couÁ
 + 
add
);

1715 
”rout
:

1716 
”r2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

1717 ià(
”r2
 && !
”r
)

1718 
”r
 = 
”r2
;

1720 ià(!
”r
) {

1721 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

1722 
	`´štk
(
KERN_DEBUG
 "EXT4-fs:ƒxtended groupo %llu "

1723 "blocks\n", 
	`ext4_blocks_couÁ
(
es
));

1724 
	`upd©e_backups
(
sb
, 
	`EXT4_SB
(sb)->
s_sbh
->
b_blockÄ
,

1725 (*)
es
, (
ext4_su³r_block
), 0);

1727  
”r
;

1728 
	}
}

1740 
	$ext4_group_ex‹nd
(
su³r_block
 *
sb
, 
ext4_su³r_block
 *
es
,

1741 
ext4_fsblk_t
 
n_blocks_couÁ
)

1743 
ext4_fsblk_t
 
o_blocks_couÁ
;

1744 
ext4_g½blk_t
 
Ï¡
;

1745 
ext4_g½blk_t
 
add
;

1746 
bufãr_h—d
 *
bh
;

1747 
”r
;

1748 
ext4_group_t
 
group
;

1750 
o_blocks_couÁ
 = 
	`ext4_blocks_couÁ
(
es
);

1752 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

1753 
	`ext4_msg
(
sb
, 
KERN_DEBUG
,

1755 
o_blocks_couÁ
, 
n_blocks_couÁ
);

1757 ià(
n_blocks_couÁ
 =ğ0 ||‚_blocks_couÁ =ğ
o_blocks_couÁ
)

1760 ià(
n_blocks_couÁ
 > (
£ùÜ_t
)(~0ULLè>> (
sb
->
s_blocksize_b™s
 - 9)) {

1761 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1763 
n_blocks_couÁ
);

1764  -
EINVAL
;

1767 ià(
n_blocks_couÁ
 < 
o_blocks_couÁ
) {

1768 
	`ext4_w¬nšg
(
sb
, "can't shrink FS -„esize‡borted");

1769  -
EINVAL
;

1773 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
o_blocks_couÁ
, &
group
, &
Ï¡
);

1775 ià(
Ï¡
 == 0) {

1776 
	`ext4_w¬nšg
(
sb
, "needo useƒxt2onlineo„esize further");

1777  -
EPERM
;

1780 
add
 = 
	`EXT4_BLOCKS_PER_GROUP
(
sb
è- 
Ï¡
;

1782 ià(
o_blocks_couÁ
 + 
add
 < o_blocks_count) {

1783 
	`ext4_w¬nšg
(
sb
, "blocks_count overflow");

1784  -
EINVAL
;

1787 ià(
o_blocks_couÁ
 + 
add
 > 
n_blocks_couÁ
)

1788 
add
 = 
n_blocks_couÁ
 - 
o_blocks_couÁ
;

1790 ià(
o_blocks_couÁ
 + 
add
 < 
n_blocks_couÁ
)

1791 
	`ext4_w¬nšg
(
sb
, "will only finish group (%llu blocks, %u‚ew)",

1792 
o_blocks_couÁ
 + 
add
,‡dd);

1795 
bh
 = 
	`sb_b»ad
(
sb
, 
o_blocks_couÁ
 + 
add
 - 1);

1796 ià(!
bh
) {

1797 
	`ext4_w¬nšg
(
sb
, "can't„ead†ast block,„esize‡borted");

1798  -
ENOSPC
;

1800 
	`b»l£
(
bh
);

1802 
”r
 = 
	`ext4_group_ex‹nd_no_check
(
sb
, 
o_blocks_couÁ
, 
add
);

1803  
”r
;

1804 
	}
}

1807 
	$num_desc_blocks
(
su³r_block
 *
sb
, 
ext4_group_t
 
groups
)

1809  (
groups
 + 
	`EXT4_DESC_PER_BLOCK
(
sb
) - 1) / EXT4_DESC_PER_BLOCK(sb);

1810 
	}
}

1817 
	$ext4_cÚv”t_m‘a_bg
(
su³r_block
 *
sb
, 
šode
 *inode)

1819 
hªdË_t
 *
hªdË
;

1820 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1821 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

1822 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

1823 
ext4_fsblk_t
 
Ä
;

1824 
i
, 
»t
, 
”r
 = 0;

1825 
üed™s
 = 1;

1827 
	`ext4_msg
(
sb
, 
KERN_INFO
, "Converting file systemo meta_bg");

1828 ià(
šode
) {

1829 ià(
es
->
s_»£rved_gdt_blocks
) {

1830 
	`ext4_”rÜ
(
sb
, "Unexpected‚on-zero "

1832  -
EPERM
;

1836 ià(
šode
->
i_blocks
 !ğ1 << (šode->
i_blkb™s
 -

1837 (9 - 
sbi
->
s_şu¡”_b™s
)))

1838 
šv®id_»size_šode
;

1839 
i
 = 0; i < 
EXT4_N_BLOCKS
; i++) {

1840 ià(
i
 =ğ
EXT4_DIND_BLOCK
) {

1841 ià(
ei
->
i_d©a
[
i
])

1844 
šv®id_»size_šode
;

1846 ià(
ei
->
i_d©a
[
i
])

1847 
šv®id_»size_šode
;

1849 
üed™s
 += 3;

1852 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_RESIZE
, 
üed™s
);

1853 ià(
	`IS_ERR
(
hªdË
))

1854  
	`PTR_ERR
(
hªdË
);

1856 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

1857 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
sbi
->
s_sbh
);

1858 ià(
”r
)

1859 
”rout
;

1861 
	`ext4_ş—r_ã©u»_»size_šode
(
sb
);

1862 
	`ext4_£t_ã©u»_m‘a_bg
(
sb
);

1863 
sbi
->
s_es
->
s_fœ¡_m‘a_bg
 =

1864 
	`ıu_to_Ë32
(
	`num_desc_blocks
(
sb
, 
sbi
->
s_groups_couÁ
));

1866 
”r
 = 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
);

1867 ià(
”r
) {

1868 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1869 
”rout
;

1872 ià(
šode
) {

1873 
Ä
 = 
	`Ë32_to_ıu
(
ei
->
i_d©a
[
EXT4_DIND_BLOCK
]);

1874 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
Ä
, 1,

1875 
EXT4_FREE_BLOCKS_METADATA
 |

1876 
EXT4_FREE_BLOCKS_FORGET
);

1877 
ei
->
i_d©a
[
EXT4_DIND_BLOCK
] = 0;

1878 
šode
->
i_blocks
 = 0;

1880 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1881 ià(
”r
)

1882 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1885 
”rout
:

1886 
»t
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

1887 ià(!
”r
)

1888 
”r
 = 
»t
;

1889  
»t
;

1891 
šv®id_»size_šode
:

1892 
	`ext4_”rÜ
(
sb
, "corrupted/inconsistent„esize inode");

1893  -
EINVAL
;

1894 
	}
}

1902 
	$ext4_»size_fs
(
su³r_block
 *
sb
, 
ext4_fsblk_t
 
n_blocks_couÁ
)

1904 
ext4_Ãw_æex_group_d©a
 *
æex_gd
 = 
NULL
;

1905 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1906 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

1907 
bufãr_h—d
 *
bh
;

1908 
šode
 *
»size_šode
 = 
NULL
;

1909 
ext4_g½blk_t
 
add
, 
off£t
;

1910 
n_desc_blocks
;

1911 
o_desc_blocks
;

1912 
ext4_group_t
 
o_group
;

1913 
ext4_group_t
 
n_group
;

1914 
ext4_fsblk_t
 
o_blocks_couÁ
;

1915 
ext4_fsblk_t
 
n_blocks_couÁ_»Œy
 = 0;

1916 
Ï¡_upd©e_time
 = 0;

1917 
”r
 = 0, 
æexbg_size
 = 1 << 
sbi
->
s_log_groups_³r_æex
;

1918 
m‘a_bg
;

1921 
bh
 = 
	`sb_b»ad
(
sb
, 
n_blocks_couÁ
 - 1);

1922 ià(!
bh
) {

1923 
	`ext4_w¬nšg
(
sb
, "can't„ead†ast block,„esize‡borted");

1924  -
ENOSPC
;

1926 
	`b»l£
(
bh
);

1928 
»Œy
:

1929 
o_blocks_couÁ
 = 
	`ext4_blocks_couÁ
(
es
);

1931 
	`ext4_msg
(
sb
, 
KERN_INFO
, "resizing filesystem from %llu "

1932 "tØ%Îu blocks", 
o_blocks_couÁ
, 
n_blocks_couÁ
);

1934 ià(
n_blocks_couÁ
 < 
o_blocks_couÁ
) {

1936 
	`ext4_w¬nšg
(
sb
, "can't shrink FS -„esize‡borted");

1937  -
EINVAL
;

1940 ià(
n_blocks_couÁ
 =ğ
o_blocks_couÁ
)

1944 
n_group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
n_blocks_couÁ
 - 1);

1945 ià(
n_group
 >ğ(0xFFFFFFFFUL / 
	`EXT4_INODES_PER_GROUP
(
sb
))) {

1946 
	`ext4_w¬nšg
(
sb
, "resize would cause inodes_count overflow");

1947  -
EINVAL
;

1949 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
o_blocks_couÁ
 - 1, &
o_group
, &
off£t
);

1951 
n_desc_blocks
 = 
	`num_desc_blocks
(
sb
, 
n_group
 + 1);

1952 
o_desc_blocks
 = 
	`num_desc_blocks
(
sb
, 
sbi
->
s_groups_couÁ
);

1954 
m‘a_bg
 = 
	`ext4_has_ã©u»_m‘a_bg
(
sb
);

1956 ià(
	`ext4_has_ã©u»_»size_šode
(
sb
)) {

1957 ià(
m‘a_bg
) {

1958 
	`ext4_”rÜ
(
sb
, "resize_inode‡nd meta_bgƒnabled "

1960  -
EINVAL
;

1962 ià(
n_desc_blocks
 > 
o_desc_blocks
 +

1963 
	`Ë16_to_ıu
(
es
->
s_»£rved_gdt_blocks
)) {

1964 
n_blocks_couÁ_»Œy
 = 
n_blocks_couÁ
;

1965 
n_desc_blocks
 = 
o_desc_blocks
 +

1966 
	`Ë16_to_ıu
(
es
->
s_»£rved_gdt_blocks
);

1967 
n_group
 = 
n_desc_blocks
 * 
	`EXT4_DESC_PER_BLOCK
(
sb
);

1968 
n_blocks_couÁ
 = (
ext4_fsblk_t
)
n_group
 *

1969 
	`EXT4_BLOCKS_PER_GROUP
(
sb
) +

1970 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
);

1971 
n_group
--;

1974 ià(!
»size_šode
)

1975 
»size_šode
 = 
	`ext4_ig‘
(
sb
, 
EXT4_RESIZE_INO
,

1976 
EXT4_IGET_SPECIAL
);

1977 ià(
	`IS_ERR
(
»size_šode
)) {

1978 
	`ext4_w¬nšg
(
sb
, "Error opening„esize inode");

1979  
	`PTR_ERR
(
»size_šode
);

1983 ià((!
»size_šode
 && !
m‘a_bg
è|| 
n_blocks_couÁ
 =ğ
o_blocks_couÁ
) {

1984 
”r
 = 
	`ext4_cÚv”t_m‘a_bg
(
sb
, 
»size_šode
);

1985 ià(
”r
)

1986 
out
;

1987 ià(
»size_šode
) {

1988 
	`ut
(
»size_šode
);

1989 
»size_šode
 = 
NULL
;

1991 ià(
n_blocks_couÁ_»Œy
) {

1992 
n_blocks_couÁ
 = 
n_blocks_couÁ_»Œy
;

1993 
n_blocks_couÁ_»Œy
 = 0;

1994 
»Œy
;

2005 ià((
	`ext4_group_fœ¡_block_no
(
sb
, 
n_group
) +

2006 
	`ext4_group_ov”h—d_blocks
(
sb
, 
n_group
) + 2 +

2007 
sbi
->
s_™b_³r_group
 + sbi->
s_şu¡”_¿tio
è>ğ
n_blocks_couÁ
) {

2008 
n_blocks_couÁ
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
n_group
);

2009 
n_group
--;

2010 
n_blocks_couÁ_»Œy
 = 0;

2011 ià(
»size_šode
) {

2012 
	`ut
(
»size_šode
);

2013 
»size_šode
 = 
NULL
;

2015 
»Œy
;

2019 ià(
n_group
 =ğ
o_group
)

2020 
add
 = 
n_blocks_couÁ
 - 
o_blocks_couÁ
;

2022 
add
 = 
	`EXT4_C2B
(
sbi
, 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
è- (
off£t
 + 1));

2023 ià(
add
 > 0) {

2024 
”r
 = 
	`ext4_group_ex‹nd_no_check
(
sb
, 
o_blocks_couÁ
, 
add
);

2025 ià(
”r
)

2026 
out
;

2029 ià(
	`ext4_blocks_couÁ
(
es
è=ğ
n_blocks_couÁ
)

2030 
out
;

2032 
”r
 = 
	`ext4_®loc_æex_bg_¬¿y
(
sb
, 
n_group
 + 1);

2033 ià(
”r
)

2034 
out
;

2036 
”r
 = 
	`ext4_mb_®loc_groupšfo
(
sb
, 
n_group
 + 1);

2037 ià(
”r
)

2038 
out
;

2040 
æex_gd
 = 
	`®loc_æex_gd
(
æexbg_size
);

2041 ià(
æex_gd
 =ğ
NULL
) {

2042 
”r
 = -
ENOMEM
;

2043 
out
;

2049 
	`ext4_£tup_Ãxt_æex_gd
(
sb
, 
æex_gd
, 
n_blocks_couÁ
,

2050 
æexbg_size
)) {

2051 ià(
jiff›s
 - 
Ï¡_upd©e_time
 > 
HZ
 * 10) {

2052 ià(
Ï¡_upd©e_time
)

2053 
	`ext4_msg
(
sb
, 
KERN_INFO
,

2055 
	`ext4_blocks_couÁ
(
es
));

2056 
Ï¡_upd©e_time
 = 
jiff›s
;

2058 ià(
	`ext4_®loc_group_bËs
(
sb
, 
æex_gd
, 
æexbg_size
) != 0)

2060 
”r
 = 
	`ext4_æex_group_add
(
sb
, 
»size_šode
, 
æex_gd
);

2061 ià(
	`uÆik–y
(
”r
))

2065 ià(!
”r
 && 
n_blocks_couÁ_»Œy
) {

2066 
n_blocks_couÁ
 = 
n_blocks_couÁ_»Œy
;

2067 
n_blocks_couÁ_»Œy
 = 0;

2068 
	`ä“_æex_gd
(
æex_gd
);

2069 
æex_gd
 = 
NULL
;

2070 ià(
»size_šode
) {

2071 
	`ut
(
»size_šode
);

2072 
»size_šode
 = 
NULL
;

2074 
»Œy
;

2077 
out
:

2078 ià(
æex_gd
)

2079 
	`ä“_æex_gd
(
æex_gd
);

2080 ià(
»size_šode
 !ğ
NULL
)

2081 
	`ut
(
»size_šode
);

2082 ià(
”r
)

2083 
	`ext4_w¬nšg
(
sb
, "error (%d) occurred during "

2084 "fsy¡em„esize", 
”r
);

2085 
	`ext4_msg
(
sb
, 
KERN_INFO
, "resized filesystemo %llu",

2086 
	`ext4_blocks_couÁ
(
es
));

2087  
”r
;

2088 
	}
}

	@pxt4/super.c

20 
	~<lšux/moduË.h
>

21 
	~<lšux/¡ršg.h
>

22 
	~<lšux/fs.h
>

23 
	~<lšux/time.h
>

24 
	~<lšux/vm®loc.h
>

25 
	~<lšux/¦ab.h
>

26 
	~<lšux/š™.h
>

27 
	~<lšux/blkdev.h
>

28 
	~<lšux/backšg-dev.h
>

29 
	~<lšux/·r£r.h
>

30 
	~<lšux/bufãr_h—d.h
>

31 
	~<lšux/expÜtfs.h
>

32 
	~<lšux/vfs.h
>

33 
	~<lšux/¿ndom.h
>

34 
	~<lšux/mouÁ.h
>

35 
	~<lšux/Çmei.h
>

36 
	~<lšux/quÙaİs.h
>

37 
	~<lšux/£q_fe.h
>

38 
	~<lšux/ùy³.h
>

39 
	~<lšux/log2.h
>

40 
	~<lšux/üc16.h
>

41 
	~<lšux/dax.h
>

42 
	~<lšux/ş—nÿche.h
>

43 
	~<lšux/uacûss.h
>

44 
	~<lšux/iv”siÚ.h
>

45 
	~<lšux/unicode.h
>

47 
	~<lšux/kth»ad.h
>

48 
	~<lšux/ä“z”.h
>

50 
	~"ext4.h
"

51 
	~"ext4_ex‹Ás.h
"

52 
	~"ext4_jbd2.h
"

53 
	~"x©Œ.h
"

54 
	~"aş.h
"

55 
	~"mb®loc.h
"

56 
	~"fsm­.h
"

58 
	#CREATE_TRACE_POINTS


	)

59 
	~<Œaû/ev’ts/ext4.h
>

61 
ext4_Ïzy_š™
 *
	gext4_li_šfo
;

62 
mu‹x
 
	gext4_li_mtx
;

63 
¿‹lim™_¡©e
 
	gext4_mouÁ_msg_¿‹lim™
;

65 
ext4_lßd_jouº®
(
su³r_block
 *, 
ext4_su³r_block
 *,

66 
jouº®_devnum
);

67 
ext4_show_İtiÚs
(
£q_fe
 *
£q
, 
d’Œy
 *
roÙ
);

68 
ext4_comm™_su³r
(
su³r_block
 *
sb
, 
sync
);

69 
ext4_m¬k_»cov”y_com¶‘e
(
su³r_block
 *
sb
,

70 
ext4_su³r_block
 *
es
);

71 
ext4_ş—r_jouº®_”r
(
su³r_block
 *
sb
,

72 
ext4_su³r_block
 *
es
);

73 
ext4_sync_fs
(
su³r_block
 *
sb
, 
wa™
);

74 
ext4_»mouÁ
(
su³r_block
 *
sb
, *
æags
, *
d©a
);

75 
ext4_¡©fs
(
d’Œy
 *d’Œy, 
k¡©fs
 *
buf
);

76 
ext4_unä“ze
(
su³r_block
 *
sb
);

77 
ext4_ä“ze
(
su³r_block
 *
sb
);

78 
d’Œy
 *
ext4_mouÁ
(
fe_sy¡em_ty³
 *
fs_ty³
, 
æags
,

79 cÚ¡ *
dev_Çme
, *
d©a
);

80 
šlše
 
ext2_ã©u»_£t_ok
(
su³r_block
 *
sb
);

81 
šlše
 
ext3_ã©u»_£t_ok
(
su³r_block
 *
sb
);

82 
ext4_ã©u»_£t_ok
(
su³r_block
 *
sb
, 
»adÚly
);

83 
ext4_de¡roy_Ïzyš™_th»ad
();

84 
ext4_uÄegi¡”_li_»que¡
(
su³r_block
 *
sb
);

85 
ext4_ş—r_»que¡_li¡
();

86 
šode
 *
ext4_g‘_jouº®_šode
(
su³r_block
 *
sb
,

87 
jouº®_šum
);

117 #ià!
defšed
(
CONFIG_EXT2_FS
è&& !defšed(
CONFIG_EXT2_FS_MODULE
è&& defšed(
CONFIG_EXT4_USE_FOR_EXT2
)

118 
fe_sy¡em_ty³
 
	gext2_fs_ty³
 = {

119 .
owÃr
 = 
THIS_MODULE
,

120 .
	gÇme
 = "ext2",

121 .
	gmouÁ
 = 
ext4_mouÁ
,

122 .
	gkl_sb
 = 
kl_block_su³r
,

123 .
	gfs_æags
 = 
FS_REQUIRES_DEV
,

125 
MODULE_ALIAS_FS
("ext2");

126 
MODULE_ALIAS
("ext2");

127 
	#IS_EXT2_SB
(
sb
è((sb)->
s_bdev
->
bd_hŞd”
 =ğ&
ext2_fs_ty³
)

	)

129 
	#IS_EXT2_SB
(
sb
è(0)

	)

133 
fe_sy¡em_ty³
 
	gext3_fs_ty³
 = {

134 .
owÃr
 = 
THIS_MODULE
,

135 .
	gÇme
 = "ext3",

136 .
	gmouÁ
 = 
ext4_mouÁ
,

137 .
	gkl_sb
 = 
kl_block_su³r
,

138 .
	gfs_æags
 = 
FS_REQUIRES_DEV
,

140 
MODULE_ALIAS_FS
("ext3");

141 
MODULE_ALIAS
("ext3");

142 
	#IS_EXT3_SB
(
sb
è((sb)->
s_bdev
->
bd_hŞd”
 =ğ&
ext3_fs_ty³
)

	)

150 
bufãr_h—d
 *

151 
	$ext4_sb_b»ad
(
su³r_block
 *
sb
, 
£ùÜ_t
 
block
, 
İ_æags
)

153 
bufãr_h—d
 *
bh
 = 
	`sb_g‘blk
(
sb
, 
block
);

155 ià(
bh
 =ğ
NULL
)

156  
	`ERR_PTR
(-
ENOMEM
);

157 ià(
	`bufãr_u±od©e
(
bh
))

158  
bh
;

159 
	`Î_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
İ_æags
, 1, &
bh
);

160 
	`wa™_Ú_bufãr
(
bh
);

161 ià(
	`bufãr_u±od©e
(
bh
))

162  
bh
;

163 
	`put_bh
(
bh
);

164  
	`ERR_PTR
(-
EIO
);

165 
	}
}

167 
	$ext4_v”ify_csum_ty³
(
su³r_block
 *
sb
,

168 
ext4_su³r_block
 *
es
)

170 ià(!
	`ext4_has_ã©u»_m‘ad©a_csum
(
sb
))

173  
es
->
s_checksum_ty³
 =ğ
EXT4_CRC32C_CHKSUM
;

174 
	}
}

176 
__Ë32
 
	$ext4_su³rblock_csum
(
su³r_block
 *
sb
,

177 
ext4_su³r_block
 *
es
)

179 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

180 
off£t
 = 
	`off£tof
(
ext4_su³r_block
, 
s_checksum
);

181 
__u32
 
csum
;

183 
csum
 = 
	`ext4_chksum
(
sbi
, ~0, (*)
es
, 
off£t
);

185  
	`ıu_to_Ë32
(
csum
);

186 
	}
}

188 
	$ext4_su³rblock_csum_v”ify
(
su³r_block
 *
sb
,

189 
ext4_su³r_block
 *
es
)

191 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

194  
es
->
s_checksum
 =ğ
	`ext4_su³rblock_csum
(
sb
,ƒs);

195 
	}
}

197 
	$ext4_su³rblock_csum_£t
(
su³r_block
 *
sb
)

199 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

201 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

204 
es
->
s_checksum
 = 
	`ext4_su³rblock_csum
(
sb
,ƒs);

205 
	}
}

207 *
	$ext4_kvm®loc
(
size_t
 
size
, 
gå_t
 
æags
)

209 *
»t
;

211 
»t
 = 
	`km®loc
(
size
, 
æags
 | 
__GFP_NOWARN
);

212 ià(!
»t
)

213 
»t
 = 
	`__vm®loc
(
size
, 
æags
, 
PAGE_KERNEL
);

214  
»t
;

215 
	}
}

217 *
	$ext4_kvz®loc
(
size_t
 
size
, 
gå_t
 
æags
)

219 *
»t
;

221 
»t
 = 
	`kz®loc
(
size
, 
æags
 | 
__GFP_NOWARN
);

222 ià(!
»t
)

223 
»t
 = 
	`__vm®loc
(
size
, 
æags
 | 
__GFP_ZERO
, 
PAGE_KERNEL
);

224  
»t
;

225 
	}
}

227 
ext4_fsblk_t
 
	$ext4_block_b™m­
(
su³r_block
 *
sb
,

228 
ext4_group_desc
 *
bg
)

230  
	`Ë32_to_ıu
(
bg
->
bg_block_b™m­_lo
) |

231 (
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
 ?

232 (
ext4_fsblk_t
)
	`Ë32_to_ıu
(
bg
->
bg_block_b™m­_hi
) << 32 : 0);

233 
	}
}

235 
ext4_fsblk_t
 
	$ext4_šode_b™m­
(
su³r_block
 *
sb
,

236 
ext4_group_desc
 *
bg
)

238  
	`Ë32_to_ıu
(
bg
->
bg_šode_b™m­_lo
) |

239 (
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
 ?

240 (
ext4_fsblk_t
)
	`Ë32_to_ıu
(
bg
->
bg_šode_b™m­_hi
) << 32 : 0);

241 
	}
}

243 
ext4_fsblk_t
 
	$ext4_šode_bË
(
su³r_block
 *
sb
,

244 
ext4_group_desc
 *
bg
)

246  
	`Ë32_to_ıu
(
bg
->
bg_šode_bË_lo
) |

247 (
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
 ?

248 (
ext4_fsblk_t
)
	`Ë32_to_ıu
(
bg
->
bg_šode_bË_hi
) << 32 : 0);

249 
	}
}

251 
__u32
 
	$ext4_ä“_group_şu¡”s
(
su³r_block
 *
sb
,

252 
ext4_group_desc
 *
bg
)

254  
	`Ë16_to_ıu
(
bg
->
bg_ä“_blocks_couÁ_lo
) |

255 (
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
 ?

256 (
__u32
)
	`Ë16_to_ıu
(
bg
->
bg_ä“_blocks_couÁ_hi
) << 16 : 0);

257 
	}
}

259 
__u32
 
	$ext4_ä“_šodes_couÁ
(
su³r_block
 *
sb
,

260 
ext4_group_desc
 *
bg
)

262  
	`Ë16_to_ıu
(
bg
->
bg_ä“_šodes_couÁ_lo
) |

263 (
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
 ?

264 (
__u32
)
	`Ë16_to_ıu
(
bg
->
bg_ä“_šodes_couÁ_hi
) << 16 : 0);

265 
	}
}

267 
__u32
 
	$ext4_u£d_dœs_couÁ
(
su³r_block
 *
sb
,

268 
ext4_group_desc
 *
bg
)

270  
	`Ë16_to_ıu
(
bg
->
bg_u£d_dœs_couÁ_lo
) |

271 (
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
 ?

272 (
__u32
)
	`Ë16_to_ıu
(
bg
->
bg_u£d_dœs_couÁ_hi
) << 16 : 0);

273 
	}
}

275 
__u32
 
	$ext4_™abË_unu£d_couÁ
(
su³r_block
 *
sb
,

276 
ext4_group_desc
 *
bg
)

278  
	`Ë16_to_ıu
(
bg
->
bg_™abË_unu£d_lo
) |

279 (
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
 ?

280 (
__u32
)
	`Ë16_to_ıu
(
bg
->
bg_™abË_unu£d_hi
) << 16 : 0);

281 
	}
}

283 
	$ext4_block_b™m­_£t
(
su³r_block
 *
sb
,

284 
ext4_group_desc
 *
bg
, 
ext4_fsblk_t
 
blk
)

286 
bg
->
bg_block_b™m­_lo
 = 
	`ıu_to_Ë32
((
u32
)
blk
);

287 ià(
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
)

288 
bg
->
bg_block_b™m­_hi
 = 
	`ıu_to_Ë32
(
blk
 >> 32);

289 
	}
}

291 
	$ext4_šode_b™m­_£t
(
su³r_block
 *
sb
,

292 
ext4_group_desc
 *
bg
, 
ext4_fsblk_t
 
blk
)

294 
bg
->
bg_šode_b™m­_lo
 = 
	`ıu_to_Ë32
((
u32
)
blk
);

295 ià(
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
)

296 
bg
->
bg_šode_b™m­_hi
 = 
	`ıu_to_Ë32
(
blk
 >> 32);

297 
	}
}

299 
	$ext4_šode_bË_£t
(
su³r_block
 *
sb
,

300 
ext4_group_desc
 *
bg
, 
ext4_fsblk_t
 
blk
)

302 
bg
->
bg_šode_bË_lo
 = 
	`ıu_to_Ë32
((
u32
)
blk
);

303 ià(
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
)

304 
bg
->
bg_šode_bË_hi
 = 
	`ıu_to_Ë32
(
blk
 >> 32);

305 
	}
}

307 
	$ext4_ä“_group_şu¡”s_£t
(
su³r_block
 *
sb
,

308 
ext4_group_desc
 *
bg
, 
__u32
 
couÁ
)

310 
bg
->
bg_ä“_blocks_couÁ_lo
 = 
	`ıu_to_Ë16
((
__u16
)
couÁ
);

311 ià(
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
)

312 
bg
->
bg_ä“_blocks_couÁ_hi
 = 
	`ıu_to_Ë16
(
couÁ
 >> 16);

313 
	}
}

315 
	$ext4_ä“_šodes_£t
(
su³r_block
 *
sb
,

316 
ext4_group_desc
 *
bg
, 
__u32
 
couÁ
)

318 
bg
->
bg_ä“_šodes_couÁ_lo
 = 
	`ıu_to_Ë16
((
__u16
)
couÁ
);

319 ià(
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
)

320 
bg
->
bg_ä“_šodes_couÁ_hi
 = 
	`ıu_to_Ë16
(
couÁ
 >> 16);

321 
	}
}

323 
	$ext4_u£d_dœs_£t
(
su³r_block
 *
sb
,

324 
ext4_group_desc
 *
bg
, 
__u32
 
couÁ
)

326 
bg
->
bg_u£d_dœs_couÁ_lo
 = 
	`ıu_to_Ë16
((
__u16
)
couÁ
);

327 ià(
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
)

328 
bg
->
bg_u£d_dœs_couÁ_hi
 = 
	`ıu_to_Ë16
(
couÁ
 >> 16);

329 
	}
}

331 
	$ext4_™abË_unu£d_£t
(
su³r_block
 *
sb
,

332 
ext4_group_desc
 *
bg
, 
__u32
 
couÁ
)

334 
bg
->
bg_™abË_unu£d_lo
 = 
	`ıu_to_Ë16
((
__u16
)
couÁ
);

335 ià(
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
)

336 
bg
->
bg_™abË_unu£d_hi
 = 
	`ıu_to_Ë16
(
couÁ
 >> 16);

337 
	}
}

339 
	$__ext4_upd©e_t¡amp
(
__Ë32
 *
lo
, 
__u8
 *
hi
)

341 
time64_t
 
now
 = 
	`ktime_g‘_»®_£cÚds
();

343 
now
 = 
	`şamp_v®
(now, 0, (1ull << 40) - 1);

345 *
lo
 = 
	`ıu_to_Ë32
(
	`low”_32_b™s
(
now
));

346 *
hi
 = 
	`uµ”_32_b™s
(
now
);

347 
	}
}

349 
time64_t
 
	$__ext4_g‘_t¡amp
(
__Ë32
 *
lo
, 
__u8
 *
hi
)

351  ((
time64_t
)(*
hi
è<< 32è+ 
	`Ë32_to_ıu
(*
lo
);

352 
	}
}

353 
	#ext4_upd©e_t¡amp
(
es
, 
t¡amp
) \

354 
	`__ext4_upd©e_t¡amp
(&(
es
)->
t¡amp
, &Ós)->t¡am°## 
_hi
)

	)

355 
	#ext4_g‘_t¡amp
(
es
, 
t¡amp
) \

356 
	`__ext4_g‘_t¡amp
(&(
es
)->
t¡amp
, &Ós)->t¡am°## 
_hi
)

	)

358 
	$__§ve_”rÜ_šfo
(
su³r_block
 *
sb
, cÚ¡ *
func
,

359 
lše
)

361 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

363 
	`EXT4_SB
(
sb
)->
s_mouÁ_¡©e
 |ğ
EXT4_ERROR_FS
;

364 ià(
	`bdev_»ad_Úly
(
sb
->
s_bdev
))

366 
es
->
s_¡©e
 |ğ
	`ıu_to_Ë16
(
EXT4_ERROR_FS
);

367 
	`ext4_upd©e_t¡amp
(
es
, 
s_Ï¡_”rÜ_time
);

368 
	`¡ºıy
(
es
->
s_Ï¡_”rÜ_func
, 
func
, (es->s_last_error_func));

369 
es
->
s_Ï¡_”rÜ_lše
 = 
	`ıu_to_Ë32
(
lše
);

370 ià(!
es
->
s_fœ¡_”rÜ_time
) {

371 
es
->
s_fœ¡_”rÜ_time
 =ƒs->
s_Ï¡_”rÜ_time
;

372 
es
->
s_fœ¡_”rÜ_time_hi
 =ƒs->
s_Ï¡_”rÜ_time_hi
;

373 
	`¡ºıy
(
es
->
s_fœ¡_”rÜ_func
, 
func
,

374 (
es
->
s_fœ¡_”rÜ_func
));

375 
es
->
s_fœ¡_”rÜ_lše
 = 
	`ıu_to_Ë32
(
lše
);

376 
es
->
s_fœ¡_”rÜ_šo
 =ƒs->
s_Ï¡_”rÜ_šo
;

377 
es
->
s_fœ¡_”rÜ_block
 =ƒs->
s_Ï¡_”rÜ_block
;

383 ià(!
es
->
s_”rÜ_couÁ
)

384 
	`mod_tim”
(&
	`EXT4_SB
(
sb
)->
s_”r_»pÜt
, 
jiff›s
 + 24*60*60*
HZ
);

385 
	`Ë32_add_ıu
(&
es
->
s_”rÜ_couÁ
, 1);

386 
	}
}

388 
	$§ve_”rÜ_šfo
(
su³r_block
 *
sb
, cÚ¡ *
func
,

389 
lše
)

391 
	`__§ve_”rÜ_šfo
(
sb
, 
func
, 
lše
);

392 
	`ext4_comm™_su³r
(
sb
, 1);

393 
	}
}

403 
	$block_deviû_ejeùed
(
su³r_block
 *
sb
)

405 
šode
 *
bd_šode
 = 
sb
->
s_bdev
->bd_inode;

406 
backšg_dev_šfo
 *
bdi
 = 
	`šode_to_bdi
(
bd_šode
);

408  
bdi
->
dev
 =ğ
NULL
;

409 
	}
}

411 
	$ext4_jouº®_comm™_ÿÎback
(
jouº®_t
 *
jouº®
, 
Œª§ùiÚ_t
 *
txn
)

413 
su³r_block
 *
sb
 = 
jouº®
->
j_´iv©e
;

414 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

415 
”rÜ
 = 
	`is_jouº®_abÜ‹d
(
jouº®
);

416 
ext4_jouº®_cb_’Œy
 *
jû
;

418 
	`BUG_ON
(
txn
->
t_¡©e
 =ğ
T_FINISHED
);

420 
	`ext4_´oûss_ä“d_d©a
(
sb
, 
txn
->
t_tid
);

422 
	`¥š_lock
(&
sbi
->
s_md_lock
);

423 !
	`li¡_em±y
(&
txn
->
t_´iv©e_li¡
)) {

424 
jû
 = 
	`li¡_’Œy
(
txn
->
t_´iv©e_li¡
.
Ãxt
,

425 
ext4_jouº®_cb_’Œy
, 
jû_li¡
);

426 
	`li¡_d–_š™
(&
jû
->
jû_li¡
);

427 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

428 
jû
->
	`jû_func
(
sb
, jû, 
”rÜ
);

429 
	`¥š_lock
(&
sbi
->
s_md_lock
);

431 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

432 
	}
}

434 
boŞ
 
	$sy¡em_gošg_down
()

436  
sy¡em_¡©e
 =ğ
SYSTEM_HALT
 || sy¡em_¡©=ğ
SYSTEM_POWER_OFF


437 || 
sy¡em_¡©e
 =ğ
SYSTEM_RESTART
;

438 
	}
}

455 
	$ext4_hªdË_”rÜ
(
su³r_block
 *
sb
)

457 ià(
	`‹¡_İt
(
sb
, 
WARN_ON_ERROR
))

458 
	`WARN_ON_ONCE
(1);

460 ià(
	`sb_rdÚly
(
sb
))

463 ià(!
	`‹¡_İt
(
sb
, 
ERRORS_CONT
)) {

464 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

466 
	`EXT4_SB
(
sb
)->
s_mouÁ_æags
 |ğ
EXT4_MF_FS_ABORTED
;

467 ià(
jouº®
)

468 
	`jbd2_jouº®_abÜt
(
jouº®
, -
EIO
);

475 ià(
	`‹¡_İt
(
sb
, 
ERRORS_RO
è|| 
	`sy¡em_gošg_down
()) {

476 
	`ext4_msg
(
sb
, 
KERN_CRIT
, "Remounting filesystem„ead-only");

481 
	`smp_wmb
();

482 
sb
->
s_æags
 |ğ
SB_RDONLY
;

483 } ià(
	`‹¡_İt
(
sb
, 
ERRORS_PANIC
)) {

484 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
 &&

485 !(
	`EXT4_SB
(
sb
)->
s_jouº®
->
j_æags
 & 
JBD2_REC_ERR
))

487 
	`·nic
("EXT4-fs (device %s):…anic forced‡fterƒrror\n",

488 
sb
->
s_id
);

490 
	}
}

492 
	#ext4_”rÜ_¿‹lim™
(
sb
) \

493 
	`___¿‹lim™
(&(
	`EXT4_SB
(
sb
)->
s_”r_¿‹lim™_¡©e
), \

494 "EXT4-f ”rÜ")

	)

496 
	$__ext4_”rÜ
(
su³r_block
 *
sb
, cÚ¡ *
funùiÚ
,

497 
lše
, cÚ¡ *
fmt
, ...)

499 
va_fÜm©
 
vaf
;

500 
va_li¡
 
¬gs
;

502 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
sb
))))

505 
	`Œaû_ext4_”rÜ
(
sb
, 
funùiÚ
, 
lše
);

506 ià(
	`ext4_”rÜ_¿‹lim™
(
sb
)) {

507 
	`va_¡¬t
(
¬gs
, 
fmt
);

508 
vaf
.
fmt
 = fmt;

509 
vaf
.
va
 = &
¬gs
;

510 
	`´štk
(
KERN_CRIT


512 
sb
->
s_id
, 
funùiÚ
, 
lše
, 
cu¼’t
->
comm
, &
vaf
);

513 
	`va_’d
(
¬gs
);

515 
	`§ve_”rÜ_šfo
(
sb
, 
funùiÚ
, 
lše
);

516 
	`ext4_hªdË_”rÜ
(
sb
);

517 
	}
}

519 
	$__ext4_”rÜ_šode
(
šode
 *šode, cÚ¡ *
funùiÚ
,

520 
lše
, 
ext4_fsblk_t
 
block
,

521 cÚ¡ *
fmt
, ...)

523 
va_li¡
 
¬gs
;

524 
va_fÜm©
 
vaf
;

525 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
;

527 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

530 
	`Œaû_ext4_”rÜ
(
šode
->
i_sb
, 
funùiÚ
, 
lše
);

531 
es
->
s_Ï¡_”rÜ_šo
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

532 
es
->
s_Ï¡_”rÜ_block
 = 
	`ıu_to_Ë64
(
block
);

533 ià(
	`ext4_”rÜ_¿‹lim™
(
šode
->
i_sb
)) {

534 
	`va_¡¬t
(
¬gs
, 
fmt
);

535 
vaf
.
fmt
 = fmt;

536 
vaf
.
va
 = &
¬gs
;

537 ià(
block
)

538 
	`´štk
(
KERN_CRIT
 "EXT4-fsƒrror (device %s): %s:%d: "

540 
šode
->
i_sb
->
s_id
, 
funùiÚ
, 
lše
, inode->
i_šo
,

541 
block
, 
cu¼’t
->
comm
, &
vaf
);

543 
	`´štk
(
KERN_CRIT
 "EXT4-fsƒrror (device %s): %s:%d: "

545 
šode
->
i_sb
->
s_id
, 
funùiÚ
, 
lše
, inode->
i_šo
,

546 
cu¼’t
->
comm
, &
vaf
);

547 
	`va_’d
(
¬gs
);

549 
	`§ve_”rÜ_šfo
(
šode
->
i_sb
, 
funùiÚ
, 
lše
);

550 
	`ext4_hªdË_”rÜ
(
šode
->
i_sb
);

551 
	}
}

553 
	$__ext4_”rÜ_fe
(
fe
 *fe, cÚ¡ *
funùiÚ
,

554 
lše
, 
ext4_fsblk_t
 
block
,

555 cÚ¡ *
fmt
, ...)

557 
va_li¡
 
¬gs
;

558 
va_fÜm©
 
vaf
;

559 
ext4_su³r_block
 *
es
;

560 
šode
 *šodğ
	`fe_šode
(
fe
);

561 
·thÇme
[80], *
·th
;

563 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

566 
	`Œaû_ext4_”rÜ
(
šode
->
i_sb
, 
funùiÚ
, 
lše
);

567 
es
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
;

568 
es
->
s_Ï¡_”rÜ_šo
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

569 ià(
	`ext4_”rÜ_¿‹lim™
(
šode
->
i_sb
)) {

570 
·th
 = 
	`fe_·th
(
fe
, 
·thÇme
, (pathname));

571 ià(
	`IS_ERR
(
·th
))

572 
·th
 = "(unknown)";

573 
	`va_¡¬t
(
¬gs
, 
fmt
);

574 
vaf
.
fmt
 = fmt;

575 
vaf
.
va
 = &
¬gs
;

576 ià(
block
)

577 
	`´štk
(
KERN_CRIT


580 
šode
->
i_sb
->
s_id
, 
funùiÚ
, 
lše
, inode->
i_šo
,

581 
block
, 
cu¼’t
->
comm
, 
·th
, &
vaf
);

583 
	`´štk
(
KERN_CRIT


586 
šode
->
i_sb
->
s_id
, 
funùiÚ
, 
lše
, inode->
i_šo
,

587 
cu¼’t
->
comm
, 
·th
, &
vaf
);

588 
	`va_’d
(
¬gs
);

590 
	`§ve_”rÜ_šfo
(
šode
->
i_sb
, 
funùiÚ
, 
lše
);

591 
	`ext4_hªdË_”rÜ
(
šode
->
i_sb
);

592 
	}
}

594 cÚ¡ *
	$ext4_decode_”rÜ
(
su³r_block
 *
sb
, 
”ºo
,

595 
nbuf
[16])

597 *
”r¡r
 = 
NULL
;

599 
”ºo
) {

600 -
EFSCORRUPTED
:

601 
”r¡r
 = "Corrupt filesystem";

603 -
EFSBADCRC
:

604 
”r¡r
 = "Filesystem failed CRC";

606 -
EIO
:

607 
”r¡r
 = "IO failure";

609 -
ENOMEM
:

610 
”r¡r
 = "Out of memory";

612 -
EROFS
:

613 ià(!
sb
 || (
	`EXT4_SB
(sb)->
s_jouº®
 &&

614 
	`EXT4_SB
(
sb
)->
s_jouº®
->
j_æags
 & 
JBD2_ABORT
))

615 
”r¡r
 = "Journal has‡borted";

617 
”r¡r
 = "Readonly filesystem";

623 ià(
nbuf
) {

625 ià(
	`¢´štf
(
nbuf
, 16, "”rÜ %d", -
”ºo
) >= 0)

626 
”r¡r
 = 
nbuf
;

631  
”r¡r
;

632 
	}
}

637 
	$__ext4_¡d_”rÜ
(
su³r_block
 *
sb
, cÚ¡ *
funùiÚ
,

638 
lše
, 
”ºo
)

640 
nbuf
[16];

641 cÚ¡ *
”r¡r
;

643 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
sb
))))

649 ià(
”ºo
 =ğ-
EROFS
 && 
	`jouº®_cu¼’t_hªdË
(è=ğ
NULL
 && 
	`sb_rdÚly
(
sb
))

652 ià(
	`ext4_”rÜ_¿‹lim™
(
sb
)) {

653 
”r¡r
 = 
	`ext4_decode_”rÜ
(
sb
, 
”ºo
, 
nbuf
);

654 
	`´štk
(
KERN_CRIT
 "EXT4-fsƒrror (device %s) in %s:%d: %s\n",

655 
sb
->
s_id
, 
funùiÚ
, 
lše
, 
”r¡r
);

658 
	`§ve_”rÜ_šfo
(
sb
, 
funùiÚ
, 
lše
);

659 
	`ext4_hªdË_”rÜ
(
sb
);

660 
	}
}

672 
	$__ext4_abÜt
(
su³r_block
 *
sb
, cÚ¡ *
funùiÚ
,

673 
lše
, cÚ¡ *
fmt
, ...)

675 
va_fÜm©
 
vaf
;

676 
va_li¡
 
¬gs
;

678 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
sb
))))

681 
	`§ve_”rÜ_šfo
(
sb
, 
funùiÚ
, 
lše
);

682 
	`va_¡¬t
(
¬gs
, 
fmt
);

683 
vaf
.
fmt
 = fmt;

684 
vaf
.
va
 = &
¬gs
;

685 
	`´štk
(
KERN_CRIT
 "EXT4-fsƒrror (device %s): %s:%d: %pV\n",

686 
sb
->
s_id
, 
funùiÚ
, 
lše
, &
vaf
);

687 
	`va_’d
(
¬gs
);

689 ià(
	`sb_rdÚly
(
sb
) == 0) {

690 
	`ext4_msg
(
sb
, 
KERN_CRIT
, "Remounting filesystem„ead-only");

691 
	`EXT4_SB
(
sb
)->
s_mouÁ_æags
 |ğ
EXT4_MF_FS_ABORTED
;

696 
	`smp_wmb
();

697 
sb
->
s_æags
 |ğ
SB_RDONLY
;

698 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
)

699 
	`jbd2_jouº®_abÜt
(
	`EXT4_SB
(
sb
)->
s_jouº®
, -
EIO
);

700 
	`§ve_”rÜ_šfo
(
sb
, 
funùiÚ
, 
lše
);

702 ià(
	`‹¡_İt
(
sb
, 
ERRORS_PANIC
è&& !
	`sy¡em_gošg_down
()) {

703 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
 &&

704 !(
	`EXT4_SB
(
sb
)->
s_jouº®
->
j_æags
 & 
JBD2_REC_ERR
))

706 
	`·nic
("EXT4-fs…anic from…reviousƒrror\n");

708 
	}
}

710 
	$__ext4_msg
(
su³r_block
 *
sb
,

711 cÚ¡ *
´efix
, cÚ¡ *
fmt
, ...)

713 
va_fÜm©
 
vaf
;

714 
va_li¡
 
¬gs
;

716 ià(!
	`___¿‹lim™
(&(
	`EXT4_SB
(
sb
)->
s_msg_¿‹lim™_¡©e
), "EXT4-fs"))

719 
	`va_¡¬t
(
¬gs
, 
fmt
);

720 
vaf
.
fmt
 = fmt;

721 
vaf
.
va
 = &
¬gs
;

722 
	`´štk
("%sEXT4-f (%s): %pV\n", 
´efix
, 
sb
->
s_id
, &
vaf
);

723 
	`va_’d
(
¬gs
);

724 
	}
}

726 
	#ext4_w¬nšg_¿‹lim™
(
sb
) \

727 
	`___¿‹lim™
(&(
	`EXT4_SB
(
sb
)->
s_w¬nšg_¿‹lim™_¡©e
), \

728 "EXT4-f w¬nšg")

	)

730 
	$__ext4_w¬nšg
(
su³r_block
 *
sb
, cÚ¡ *
funùiÚ
,

731 
lše
, cÚ¡ *
fmt
, ...)

733 
va_fÜm©
 
vaf
;

734 
va_li¡
 
¬gs
;

736 ià(!
	`ext4_w¬nšg_¿‹lim™
(
sb
))

739 
	`va_¡¬t
(
¬gs
, 
fmt
);

740 
vaf
.
fmt
 = fmt;

741 
vaf
.
va
 = &
¬gs
;

742 
	`´štk
(
KERN_WARNING
 "EXT4-fs warning (device %s): %s:%d: %pV\n",

743 
sb
->
s_id
, 
funùiÚ
, 
lše
, &
vaf
);

744 
	`va_’d
(
¬gs
);

745 
	}
}

747 
	$__ext4_w¬nšg_šode
(cÚ¡ 
šode
 *šode, cÚ¡ *
funùiÚ
,

748 
lše
, cÚ¡ *
fmt
, ...)

750 
va_fÜm©
 
vaf
;

751 
va_li¡
 
¬gs
;

753 ià(!
	`ext4_w¬nšg_¿‹lim™
(
šode
->
i_sb
))

756 
	`va_¡¬t
(
¬gs
, 
fmt
);

757 
vaf
.
fmt
 = fmt;

758 
vaf
.
va
 = &
¬gs
;

759 
	`´štk
(
KERN_WARNING
 "EXT4-fs warning (device %s): %s:%d: "

760 "šod#%lu: comm %s: %pV\n", 
šode
->
i_sb
->
s_id
,

761 
funùiÚ
, 
lše
, 
šode
->
i_šo
, 
cu¼’t
->
comm
, &
vaf
);

762 
	`va_’d
(
¬gs
);

763 
	}
}

765 
	$__ext4_g½_locked_”rÜ
(cÚ¡ *
funùiÚ
, 
lše
,

766 
su³r_block
 *
sb
, 
ext4_group_t
 
g½
,

767 
šo
, 
ext4_fsblk_t
 
block
,

768 cÚ¡ *
fmt
, ...)

769 
	$__»Ëa£s
(
b™lock
)

770 
	$__acquœes
(
b™lock
)

772 
va_fÜm©
 
vaf
;

773 
va_li¡
 
¬gs
;

774 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

776 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
sb
))))

779 
	`Œaû_ext4_”rÜ
(
sb
, 
funùiÚ
, 
lše
);

780 
es
->
s_Ï¡_”rÜ_šo
 = 
	`ıu_to_Ë32
(
šo
);

781 
es
->
s_Ï¡_”rÜ_block
 = 
	`ıu_to_Ë64
(
block
);

782 
	`__§ve_”rÜ_šfo
(
sb
, 
funùiÚ
, 
lše
);

784 ià(
	`ext4_”rÜ_¿‹lim™
(
sb
)) {

785 
	`va_¡¬t
(
¬gs
, 
fmt
);

786 
vaf
.
fmt
 = fmt;

787 
vaf
.
va
 = &
¬gs
;

788 
	`´štk
(
KERN_CRIT
 "EXT4-fsƒrror (device %s): %s:%d: group %u, ",

789 
sb
->
s_id
, 
funùiÚ
, 
lše
, 
g½
);

790 ià(
šo
)

791 
	`´štk
(
KERN_CONT
 "šod%lu: ", 
šo
);

792 ià(
block
)

793 
	`´štk
(
KERN_CONT
 "block %llu:",

794 (è
block
);

795 
	`´štk
(
KERN_CONT
 "%pV\n", &
vaf
);

796 
	`va_’d
(
¬gs
);

799 ià(
	`‹¡_İt
(
sb
, 
WARN_ON_ERROR
))

800 
	`WARN_ON_ONCE
(1);

802 ià(
	`‹¡_İt
(
sb
, 
ERRORS_CONT
)) {

803 
	`ext4_comm™_su³r
(
sb
, 0);

807 
	`ext4_uÆock_group
(
sb
, 
g½
);

808 
	`ext4_comm™_su³r
(
sb
, 1);

809 
	`ext4_hªdË_”rÜ
(
sb
);

821 
	`ext4_lock_group
(
sb
, 
g½
);

823 
	}
}

825 
	$ext4_m¬k_group_b™m­_cÜru±ed
(
su³r_block
 *
sb
,

826 
ext4_group_t
 
group
,

827 
æags
)

829 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

830 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

831 
ext4_group_desc
 *
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
group
, 
NULL
);

832 
»t
;

834 ià(
æags
 & 
EXT4_GROUP_INFO_BBITMAP_CORRUPT
) {

835 
»t
 = 
	`ext4_‹¡_ªd_£t_b™
(
EXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
,

836 &
g½
->
bb_¡©e
);

837 ià(!
»t
)

838 
	`³rıu_couÁ”_sub
(&
sbi
->
s_ä“şu¡”s_couÁ”
,

839 
g½
->
bb_ä“
);

842 ià(
æags
 & 
EXT4_GROUP_INFO_IBITMAP_CORRUPT
) {

843 
»t
 = 
	`ext4_‹¡_ªd_£t_b™
(
EXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
,

844 &
g½
->
bb_¡©e
);

845 ià(!
»t
 && 
gdp
) {

846 
couÁ
;

848 
couÁ
 = 
	`ext4_ä“_šodes_couÁ
(
sb
, 
gdp
);

849 
	`³rıu_couÁ”_sub
(&
sbi
->
s_ä“šodes_couÁ”
,

850 
couÁ
);

853 
	}
}

855 
	$ext4_upd©e_dyÇmic_»v
(
su³r_block
 *
sb
)

857 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

859 ià(
	`Ë32_to_ıu
(
es
->
s_»v_Ëv–
è> 
EXT4_GOOD_OLD_REV
)

862 
	`ext4_w¬nšg
(
sb
,

865 
EXT4_DYNAMIC_REV
);

867 
es
->
s_fœ¡_šo
 = 
	`ıu_to_Ë32
(
EXT4_GOOD_OLD_FIRST_INO
);

868 
es
->
s_šode_size
 = 
	`ıu_to_Ë16
(
EXT4_GOOD_OLD_INODE_SIZE
);

869 
es
->
s_»v_Ëv–
 = 
	`ıu_to_Ë32
(
EXT4_DYNAMIC_REV
);

878 
	}
}

883 
block_deviû
 *
	$ext4_blkdev_g‘
(
dev_t
 
dev
, 
su³r_block
 *
sb
)

885 
block_deviû
 *
bdev
;

886 
b
[
BDEVNAME_SIZE
];

888 
bdev
 = 
	`blkdev_g‘_by_dev
(
dev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
, 
sb
);

889 ià(
	`IS_ERR
(
bdev
))

890 
ç
;

891  
bdev
;

893 
ç
:

894 
	`ext4_msg
(
sb
, 
KERN_ERR
, "failedo open journal device %s: %ld",

895 
	`__bdevÇme
(
dev
, 
b
), 
	`PTR_ERR
(
bdev
));

896  
NULL
;

897 
	}
}

902 
	$ext4_blkdev_put
(
block_deviû
 *
bdev
)

904 
	`blkdev_put
(
bdev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
);

905 
	}
}

907 
	$ext4_blkdev_»move
(
ext4_sb_šfo
 *
sbi
)

909 
block_deviû
 *
bdev
;

910 
bdev
 = 
sbi
->
jouº®_bdev
;

911 ià(
bdev
) {

912 
	`ext4_blkdev_put
(
bdev
);

913 
sbi
->
jouº®_bdev
 = 
NULL
;

915 
	}
}

917 
šlše
 
šode
 *
	$Üphª_li¡_’Œy
(
li¡_h—d
 *
l
)

919  &
	`li¡_’Œy
(
l
, 
ext4_šode_šfo
, 
i_Üphª
)->
vfs_šode
;

920 
	}
}

922 
	$dump_Üphª_li¡
(
su³r_block
 *
sb
, 
ext4_sb_šfo
 *
sbi
)

924 
li¡_h—d
 *
l
;

926 
	`ext4_msg
(
sb
, 
KERN_ERR
, "sb orphan head is %d",

927 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_Ï¡_Üphª
));

929 
	`´štk
(
KERN_ERR
 "sb_info orphan†ist:\n");

930 
	`li¡_fÜ_—ch
(
l
, &
sbi
->
s_Üphª
) {

931 
šode
 *šodğ
	`Üphª_li¡_’Œy
(
l
);

932 
	`´štk
(
KERN_ERR
 " "

934 
šode
->
i_sb
->
s_id
, inode->
i_šo
, inode,

935 
šode
->
i_mode
, inode->
i_Æšk
,

936 
	`NEXT_ORPHAN
(
šode
));

938 
	}
}

940 #ifdeà
CONFIG_QUOTA


941 
ext4_quÙa_off
(
su³r_block
 *
sb
, 
ty³
);

943 
šlše
 
	$ext4_quÙa_off_umouÁ
(
su³r_block
 *
sb
)

945 
ty³
;

948 
ty³
 = 0;y³ < 
EXT4_MAXQUOTAS
;ype++)

949 
	`ext4_quÙa_off
(
sb
, 
ty³
);

950 
	}
}

956 
šlše
 *
	$g‘_qf_Çme
(
su³r_block
 *
sb
,

957 
ext4_sb_šfo
 *
sbi
,

958 
ty³
)

960  
	`rcu_d”eã»nû_´Ùeùed
(
sbi
->
s_qf_Çmes
[
ty³
],

961 
	`lockd•_is_h–d
(&
sb
->
s_umouÁ
));

962 
	}
}

964 
šlše
 
	$ext4_quÙa_off_umouÁ
(
su³r_block
 *
sb
)

966 
	}
}

969 
	$ext4_put_su³r
(
su³r_block
 *
sb
)

971 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

972 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

973 
abÜ‹d
 = 0;

974 
i
, 
”r
;

976 
	`ext4_uÄegi¡”_li_»que¡
(
sb
);

977 
	`ext4_quÙa_off_umouÁ
(
sb
);

979 
	`de¡roy_wÜkqueue
(
sbi
->
rsv_cÚv”siÚ_wq
);

981 ià(
sbi
->
s_jouº®
) {

982 
abÜ‹d
 = 
	`is_jouº®_abÜ‹d
(
sbi
->
s_jouº®
);

983 
”r
 = 
	`jbd2_jouº®_de¡roy
(
sbi
->
s_jouº®
);

984 
sbi
->
s_jouº®
 = 
NULL
;

985 ià((
”r
 < 0è&& !
abÜ‹d
)

986 
	`ext4_abÜt
(
sb
, "Couldn't clean uphe journal");

989 
	`ext4_uÄegi¡”_sysfs
(
sb
);

990 
	`ext4_es_uÄegi¡”_shršk”
(
sbi
);

991 
	`d–_tim”_sync
(&
sbi
->
s_”r_»pÜt
);

992 
	`ext4_»Ëa£_sy¡em_zÚe
(
sb
);

993 
	`ext4_mb_»Ëa£
(
sb
);

994 
	`ext4_ext_»Ëa£
(
sb
);

996 ià(!
	`sb_rdÚly
(
sb
è&& !
abÜ‹d
) {

997 
	`ext4_ş—r_ã©u»_jouº®_Ãeds_»cov”y
(
sb
);

998 
es
->
s_¡©e
 = 
	`ıu_to_Ë16
(
sbi
->
s_mouÁ_¡©e
);

1000 ià(!
	`sb_rdÚly
(
sb
))

1001 
	`ext4_comm™_su³r
(
sb
, 1);

1003 
i
 = 0; i < 
sbi
->
s_gdb_couÁ
; i++)

1004 
	`b»l£
(
sbi
->
s_group_desc
[
i
]);

1005 
	`kvä“
(
sbi
->
s_group_desc
);

1006 
	`kvä“
(
sbi
->
s_æex_groups
);

1007 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_ä“şu¡”s_couÁ”
);

1008 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_ä“šodes_couÁ”
);

1009 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_dœs_couÁ”
);

1010 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_dœtyşu¡”s_couÁ”
);

1011 
	`³rıu_ä“_rw£m
(&
sbi
->
s_jouº®_æag_rw£m
);

1012 #ifdeà
CONFIG_QUOTA


1013 
i
 = 0; i < 
EXT4_MAXQUOTAS
; i++)

1014 
	`kä“
(
	`g‘_qf_Çme
(
sb
, 
sbi
, 
i
));

1021 ià(!
	`li¡_em±y
(&
sbi
->
s_Üphª
))

1022 
	`dump_Üphª_li¡
(
sb
, 
sbi
);

1023 
	`J_ASSERT
(
	`li¡_em±y
(&
sbi
->
s_Üphª
));

1025 
	`sync_blockdev
(
sb
->
s_bdev
);

1026 
	`šv®id©e_bdev
(
sb
->
s_bdev
);

1027 ià(
sbi
->
jouº®_bdev
 && sbi->jouº®_bdev !ğ
sb
->
s_bdev
) {

1033 
	`sync_blockdev
(
sbi
->
jouº®_bdev
);

1034 
	`šv®id©e_bdev
(
sbi
->
jouº®_bdev
);

1035 
	`ext4_blkdev_»move
(
sbi
);

1038 
	`ext4_x©Œ_de¡roy_ÿche
(
sbi
->
s_—_šode_ÿche
);

1039 
sbi
->
s_—_šode_ÿche
 = 
NULL
;

1041 
	`ext4_x©Œ_de¡roy_ÿche
(
sbi
->
s_—_block_ÿche
);

1042 
sbi
->
s_—_block_ÿche
 = 
NULL
;

1044 ià(
sbi
->
s_mmp_tsk
)

1045 
	`kth»ad_¡İ
(
sbi
->
s_mmp_tsk
);

1046 
	`b»l£
(
sbi
->
s_sbh
);

1047 
sb
->
s_fs_šfo
 = 
NULL
;

1052 
	`kobjeù_put
(&
sbi
->
s_kobj
);

1053 
	`wa™_fÜ_com¶‘iÚ
(&
sbi
->
s_kobj_uÄegi¡”
);

1054 ià(
sbi
->
s_chksum_driv”
)

1055 
	`üy±o_ä“_shash
(
sbi
->
s_chksum_driv”
);

1056 
	`kä“
(
sbi
->
s_blockgroup_lock
);

1057 
	`fs_put_dax
(
sbi
->
s_daxdev
);

1058 #ifdeà
CONFIG_UNICODE


1059 
	`utf8_uÆßd
(
sbi
->
s_’codšg
);

1061 
	`kä“
(
sbi
);

1062 
	}
}

1064 
kmem_ÿche
 *
	gext4_šode_ÿch•
;

1069 
šode
 *
	$ext4_®loc_šode
(
su³r_block
 *
sb
)

1071 
ext4_šode_šfo
 *
ei
;

1073 
ei
 = 
	`kmem_ÿche_®loc
(
ext4_šode_ÿch•
, 
GFP_NOFS
);

1074 ià(!
ei
)

1075  
NULL
;

1077 
	`šode_£t_iv”siÚ
(&
ei
->
vfs_šode
, 1);

1078 
	`¥š_lock_š™
(&
ei
->
i_¿w_lock
);

1079 
	`INIT_LIST_HEAD
(&
ei
->
i_´—Îoc_li¡
);

1080 
	`¥š_lock_š™
(&
ei
->
i_´—Îoc_lock
);

1081 
	`ext4_es_š™_Œ“
(&
ei
->
i_es_Œ“
);

1082 
	`rwlock_š™
(&
ei
->
i_es_lock
);

1083 
	`INIT_LIST_HEAD
(&
ei
->
i_es_li¡
);

1084 
ei
->
i_es_®l_Ä
 = 0;

1085 
ei
->
i_es_shk_Ä
 = 0;

1086 
ei
->
i_es_shršk_lblk
 = 0;

1087 
ei
->
i_»£rved_d©a_blocks
 = 0;

1088 
ei
->
i_da_m‘ad©a_ÿlc_Ën
 = 0;

1089 
ei
->
i_da_m‘ad©a_ÿlc_Ï¡_lblock
 = 0;

1090 
	`¥š_lock_š™
(&(
ei
->
i_block_»£rv©iÚ_lock
));

1091 
	`ext4_š™_³ndšg_Œ“
(&
ei
->
i_³ndšg_Œ“
);

1092 #ifdeà
CONFIG_QUOTA


1093 
ei
->
i_»£rved_quÙa
 = 0;

1094 
	`mem£t
(&
ei
->
i_dquÙ
, 0, (ei->i_dquot));

1096 
ei
->
jšode
 = 
NULL
;

1097 
	`INIT_LIST_HEAD
(&
ei
->
i_rsv_cÚv”siÚ_li¡
);

1098 
	`¥š_lock_š™
(&
ei
->
i_com¶‘ed_io_lock
);

1099 
ei
->
i_sync_tid
 = 0;

1100 
ei
->
i_d©async_tid
 = 0;

1101 
	`©omic_£t
(&
ei
->
i_unwr™‹n
, 0);

1102 
	`INIT_WORK
(&
ei
->
i_rsv_cÚv”siÚ_wÜk
, 
ext4_’d_io_rsv_wÜk
);

1103  &
ei
->
vfs_šode
;

1104 
	}
}

1106 
	$ext4_drİ_šode
(
šode
 *inode)

1108 
drİ
 = 
	`g’”ic_drİ_šode
(
šode
);

1110 ià(!
drİ
)

1111 
drİ
 = 
	`fsüy±_drİ_šode
(
šode
);

1113 
	`Œaû_ext4_drİ_šode
(
šode
, 
drİ
);

1114  
drİ
;

1115 
	}
}

1117 
	$ext4_ä“_š_cÜe_šode
(
šode
 *inode)

1119 
	`fsüy±_ä“_šode
(
šode
);

1120 
	`kmem_ÿche_ä“
(
ext4_šode_ÿch•
, 
	`EXT4_I
(
šode
));

1121 
	}
}

1123 
	$ext4_de¡roy_šode
(
šode
 *inode)

1125 ià(!
	`li¡_em±y
(&(
	`EXT4_I
(
šode
)->
i_Üphª
))) {

1126 
	`ext4_msg
(
šode
->
i_sb
, 
KERN_ERR
,

1128 
šode
->
i_šo
, 
	`EXT4_I
(inode));

1129 
	`´št_hex_dump
(
KERN_INFO
, "", 
DUMP_PREFIX_ADDRESS
, 16, 4,

1130 
	`EXT4_I
(
šode
), (
ext4_šode_šfo
),

1131 
Œue
);

1132 
	`dump_¡ack
();

1134 
	}
}

1136 
	$š™_Úû
(*
foo
)

1138 
ext4_šode_šfo
 *
ei
 = (ext4_šode_šfØ*è
foo
;

1140 
	`INIT_LIST_HEAD
(&
ei
->
i_Üphª
);

1141 
	`š™_rw£m
(&
ei
->
x©Œ_£m
);

1142 
	`š™_rw£m
(&
ei
->
i_d©a_£m
);

1143 
	`š™_rw£m
(&
ei
->
i_mm­_£m
);

1144 
	`šode_š™_Úû
(&
ei
->
vfs_šode
);

1145 
	}
}

1147 
__š™
 
	$š™_šodeÿche
()

1149 
ext4_šode_ÿch•
 = 
	`kmem_ÿche_ü—‹_u£rcİy
("ext4_inode_cache",

1150 (
ext4_šode_šfo
), 0,

1151 (
SLAB_RECLAIM_ACCOUNT
|
SLAB_MEM_SPREAD
|

1152 
SLAB_ACCOUNT
),

1153 
	`off£tof
(
ext4_šode_šfo
, 
i_d©a
),

1154 
	`sizeof_f›ld
(
ext4_šode_šfo
, 
i_d©a
),

1155 
š™_Úû
);

1156 ià(
ext4_šode_ÿch•
 =ğ
NULL
)

1157  -
ENOMEM
;

1159 
	}
}

1161 
	$de¡roy_šodeÿche
()

1167 
	`rcu_b¬r›r
();

1168 
	`kmem_ÿche_de¡roy
(
ext4_šode_ÿch•
);

1169 
	}
}

1171 
	$ext4_ş—r_šode
(
šode
 *inode)

1173 
	`šv®id©e_šode_bufãrs
(
šode
);

1174 
	`ş—r_šode
(
šode
);

1175 
	`dquÙ_drİ
(
šode
);

1176 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

1177 
	`ext4_es_»move_ex‹Á
(
šode
, 0, 
EXT_MAX_BLOCKS
);

1178 ià(
	`EXT4_I
(
šode
)->
jšode
) {

1179 
	`jbd2_jouº®_»Ëa£_jbd_šode
(
	`EXT4_JOURNAL
(
šode
),

1180 
	`EXT4_I
(
šode
)->
jšode
);

1181 
	`jbd2_ä“_šode
(
	`EXT4_I
(
šode
)->
jšode
);

1182 
	`EXT4_I
(
šode
)->
jšode
 = 
NULL
;

1184 
	`fsüy±_put_’üy±iÚ_šfo
(
šode
);

1185 
	`fsv”™y_ş—nup_šode
(
šode
);

1186 
	}
}

1188 
šode
 *
	$ext4_nfs_g‘_šode
(
su³r_block
 *
sb
,

1189 
u64
 
šo
, 
u32
 
g’”©iÚ
)

1191 
šode
 *inode;

1197 
šode
 = 
	`ext4_ig‘
(
sb
, 
šo
, 
EXT4_IGET_HANDLE
);

1198 ià(
	`IS_ERR
(
šode
))

1199  
	`ERR_CAST
(
šode
);

1200 ià(
g’”©iÚ
 && 
šode
->
i_g’”©iÚ
 != generation) {

1201 
	`ut
(
šode
);

1202  
	`ERR_PTR
(-
ESTALE
);

1205  
šode
;

1206 
	}
}

1208 
d’Œy
 *
	$ext4_fh_to_d’Œy
(
su³r_block
 *
sb
, 
fid
 *fid,

1209 
fh_Ën
, 
fh_ty³
)

1211  
	`g’”ic_fh_to_d’Œy
(
sb
, 
fid
, 
fh_Ën
, 
fh_ty³
,

1212 
ext4_nfs_g‘_šode
);

1213 
	}
}

1215 
d’Œy
 *
	$ext4_fh_to_·»Á
(
su³r_block
 *
sb
, 
fid
 *fid,

1216 
fh_Ën
, 
fh_ty³
)

1218  
	`g’”ic_fh_to_·»Á
(
sb
, 
fid
, 
fh_Ën
, 
fh_ty³
,

1219 
ext4_nfs_g‘_šode
);

1220 
	}
}

1222 
	$ext4_nfs_comm™_m‘ad©a
(
šode
 *inode)

1224 
wr™eback_cÚŒŞ
 
wbc
 = {

1225 .
sync_mode
 = 
WB_SYNC_ALL


1228 
	`Œaû_ext4_nfs_comm™_m‘ad©a
(
šode
);

1229  
	`ext4_wr™e_šode
(
šode
, &
wbc
);

1230 
	}
}

1238 
	$bdev_Œy_to_ä“_·ge
(
su³r_block
 *
sb
, 
·ge
 *page,

1239 
gå_t
 
wa™
)

1241 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

1243 
	`WARN_ON
(
	`PageChecked
(
·ge
));

1244 ià(!
	`·ge_has_bufãrs
(
·ge
))

1246 ià(
jouº®
)

1247  
	`jbd2_jouº®_Œy_to_ä“_bufãrs
(
jouº®
, 
·ge
,

1248 
wa™
 & ~
__GFP_DIRECT_RECLAIM
);

1249  
	`Œy_to_ä“_bufãrs
(
·ge
);

1250 
	}
}

1252 #ifdeà
CONFIG_FS_ENCRYPTION


1253 
	$ext4_g‘_cÚ‹xt
(
šode
 *šode, *
ùx
, 
size_t
 
Ën
)

1255  
	`ext4_x©Œ_g‘
(
šode
, 
EXT4_XATTR_INDEX_ENCRYPTION
,

1256 
EXT4_XATTR_NAME_ENCRYPTION_CONTEXT
, 
ùx
, 
Ën
);

1257 
	}
}

1259 
	$ext4_£t_cÚ‹xt
(
šode
 *šode, cÚ¡ *
ùx
, 
size_t
 
Ën
,

1260 *
fs_d©a
)

1262 
hªdË_t
 *
hªdË
 = 
fs_d©a
;

1263 
»s
, 
»s2
, 
üed™s
, 
»Œ›s
 = 0;

1271 ià(
šode
->
i_šo
 =ğ
EXT4_ROOT_INO
)

1272  -
EPERM
;

1274 ià(
	`WARN_ON_ONCE
(
	`IS_DAX
(
šode
è&& 
	`i_size_»ad
(inode)))

1275  -
EINVAL
;

1277 
»s
 = 
	`ext4_cÚv”t_šlše_d©a
(
šode
);

1278 ià(
»s
)

1279  
»s
;

1289 ià(
hªdË
) {

1290 
»s
 = 
	`ext4_x©Œ_£t_hªdË
(
hªdË
, 
šode
,

1291 
EXT4_XATTR_INDEX_ENCRYPTION
,

1292 
EXT4_XATTR_NAME_ENCRYPTION_CONTEXT
,

1293 
ùx
, 
Ën
, 0);

1294 ià(!
»s
) {

1295 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_ENCRYPT
);

1296 
	`ext4_ş—r_šode_¡©e
(
šode
,

1297 
EXT4_STATE_MAY_INLINE_DATA
);

1302 
	`ext4_£t_šode_æags
(
šode
);

1304  
»s
;

1307 
»s
 = 
	`dquÙ_š™Ÿlize
(
šode
);

1308 ià(
»s
)

1309  
»s
;

1310 
»Œy
:

1311 
»s
 = 
	`ext4_x©Œ_£t_üed™s
(
šode
, 
Ën
, 
çl£
 ,

1312 &
üed™s
);

1313 ià(
»s
)

1314  
»s
;

1316 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MISC
, 
üed™s
);

1317 ià(
	`IS_ERR
(
hªdË
))

1318  
	`PTR_ERR
(
hªdË
);

1320 
»s
 = 
	`ext4_x©Œ_£t_hªdË
(
hªdË
, 
šode
, 
EXT4_XATTR_INDEX_ENCRYPTION
,

1321 
EXT4_XATTR_NAME_ENCRYPTION_CONTEXT
,

1322 
ùx
, 
Ën
, 0);

1323 ià(!
»s
) {

1324 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_ENCRYPT
);

1329 
	`ext4_£t_šode_æags
(
šode
);

1330 
»s
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1331 ià(
»s
)

1332 
	`EXT4_ERROR_INODE
(
šode
, "Failedo mark inode dirty");

1334 
»s2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

1336 ià(
»s
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

1337 
»Œy
;

1338 ià(!
»s
)

1339 
»s
 = 
»s2
;

1340  
»s
;

1341 
	}
}

1343 
boŞ
 
	$ext4_dummy_cÚ‹xt
(
šode
 *inode)

1345  
	`DUMMY_ENCRYPTION_ENABLED
(
	`EXT4_SB
(
šode
->
i_sb
));

1346 
	}
}

1348 cÚ¡ 
fsüy±_İ”©iÚs
 
	gext4_üy±İs
 = {

1349 .
key_´efix
 = "ext4:",

1350 .
	gg‘_cÚ‹xt
 = 
ext4_g‘_cÚ‹xt
,

1351 .
	g£t_cÚ‹xt
 = 
ext4_£t_cÚ‹xt
,

1352 .
	gdummy_cÚ‹xt
 = 
ext4_dummy_cÚ‹xt
,

1353 .
	gem±y_dœ
 = 
ext4_em±y_dœ
,

1354 .
	gmax_Çm–’
 = 
EXT4_NAME_LEN
,

1358 #ifdeà
CONFIG_QUOTA


1359 cÚ¡ * cÚ¡ 
	gquÙ©y³s
[] = 
INITQFNAMES
;

1360 
	#QTYPE2NAME
(
t
è(
quÙ©y³s
[t])

	)

1362 
ext4_wr™e_dquÙ
(
dquÙ
 *dquot);

1363 
ext4_acquœe_dquÙ
(
dquÙ
 *dquot);

1364 
ext4_»Ëa£_dquÙ
(
dquÙ
 *dquot);

1365 
ext4_m¬k_dquÙ_dœty
(
dquÙ
 *dquot);

1366 
ext4_wr™e_šfo
(
su³r_block
 *
sb
, 
ty³
);

1367 
ext4_quÙa_Ú
(
su³r_block
 *
sb
, 
ty³
, 
fÜm©_id
,

1368 cÚ¡ 
·th
 *path);

1369 
ext4_quÙa_Ú_mouÁ
(
su³r_block
 *
sb
, 
ty³
);

1370 
ssize_t
 
ext4_quÙa_»ad
(
su³r_block
 *
sb
, 
ty³
, *
d©a
,

1371 
size_t
 
Ën
, 
loff_t
 
off
);

1372 
ssize_t
 
ext4_quÙa_wr™e
(
su³r_block
 *
sb
, 
ty³
,

1373 cÚ¡ *
d©a
, 
size_t
 
Ën
, 
loff_t
 
off
);

1374 
ext4_quÙa_’abË
(
su³r_block
 *
sb
, 
ty³
, 
fÜm©_id
,

1375 
æags
);

1376 
ext4_’abË_quÙas
(
su³r_block
 *
sb
);

1377 
ext4_g‘_Ãxt_id
(
su³r_block
 *
sb
, 
kqid
 *
qid
);

1379 
dquÙ
 **
	$ext4_g‘_dquÙs
(
šode
 *inode)

1381  
	`EXT4_I
(
šode
)->
i_dquÙ
;

1382 
	}
}

1384 cÚ¡ 
dquÙ_İ”©iÚs
 
	gext4_quÙa_İ”©iÚs
 = {

1385 .
g‘_»£rved_¥aû
 = 
ext4_g‘_»£rved_¥aû
,

1386 .
	gwr™e_dquÙ
 = 
ext4_wr™e_dquÙ
,

1387 .
	gacquœe_dquÙ
 = 
ext4_acquœe_dquÙ
,

1388 .
	g»Ëa£_dquÙ
 = 
ext4_»Ëa£_dquÙ
,

1389 .
	gm¬k_dœty
 = 
ext4_m¬k_dquÙ_dœty
,

1390 .
	gwr™e_šfo
 = 
ext4_wr™e_šfo
,

1391 .
	g®loc_dquÙ
 = 
dquÙ_®loc
,

1392 .
	gde¡roy_dquÙ
 = 
dquÙ_de¡roy
,

1393 .
	gg‘_´ojid
 = 
ext4_g‘_´ojid
,

1394 .
	gg‘_šode_u§ge
 = 
ext4_g‘_šode_u§ge
,

1395 .
	gg‘_Ãxt_id
 = 
ext4_g‘_Ãxt_id
,

1398 cÚ¡ 
quÙaùl_İs
 
	gext4_qùl_İ”©iÚs
 = {

1399 .
quÙa_Ú
 = 
ext4_quÙa_Ú
,

1400 .
	gquÙa_off
 = 
ext4_quÙa_off
,

1401 .
	gquÙa_sync
 = 
dquÙ_quÙa_sync
,

1402 .
	gg‘_¡©e
 = 
dquÙ_g‘_¡©e
,

1403 .
	g£t_šfo
 = 
dquÙ_£t_dqšfo
,

1404 .
	gg‘_dqblk
 = 
dquÙ_g‘_dqblk
,

1405 .
	g£t_dqblk
 = 
dquÙ_£t_dqblk
,

1406 .
	gg‘_Ãxtdqblk
 = 
dquÙ_g‘_Ãxt_dqblk
,

1410 cÚ¡ 
su³r_İ”©iÚs
 
	gext4_sİs
 = {

1411 .
®loc_šode
 = 
ext4_®loc_šode
,

1412 .
	gä“_šode
 = 
ext4_ä“_š_cÜe_šode
,

1413 .
	gde¡roy_šode
 = 
ext4_de¡roy_šode
,

1414 .
	gwr™e_šode
 = 
ext4_wr™e_šode
,

1415 .
	gdœty_šode
 = 
ext4_dœty_šode
,

1416 .
	gdrİ_šode
 = 
ext4_drİ_šode
,

1417 .
	geviù_šode
 = 
ext4_eviù_šode
,

1418 .
	gput_su³r
 = 
ext4_put_su³r
,

1419 .
	gsync_fs
 = 
ext4_sync_fs
,

1420 .
	gä“ze_fs
 = 
ext4_ä“ze
,

1421 .
	gunä“ze_fs
 = 
ext4_unä“ze
,

1422 .
	g¡©fs
 = 
ext4_¡©fs
,

1423 .
	g»mouÁ_fs
 = 
ext4_»mouÁ
,

1424 .
	gshow_İtiÚs
 = 
ext4_show_İtiÚs
,

1425 #ifdeà
CONFIG_QUOTA


1426 .
	gquÙa_»ad
 = 
ext4_quÙa_»ad
,

1427 .
	gquÙa_wr™e
 = 
ext4_quÙa_wr™e
,

1428 .
	gg‘_dquÙs
 = 
ext4_g‘_dquÙs
,

1430 .
	gbdev_Œy_to_ä“_·ge
 = 
bdev_Œy_to_ä“_·ge
,

1433 cÚ¡ 
expÜt_İ”©iÚs
 
	gext4_expÜt_İs
 = {

1434 .
fh_to_d’Œy
 = 
ext4_fh_to_d’Œy
,

1435 .
	gfh_to_·»Á
 = 
ext4_fh_to_·»Á
,

1436 .
	gg‘_·»Á
 = 
ext4_g‘_·»Á
,

1437 .
	gcomm™_m‘ad©a
 = 
ext4_nfs_comm™_m‘ad©a
,

1441 
	mO±_bsd_df
, 
	mO±_mšix_df
, 
	mO±_g½id
, 
	mO±_nog½id
,

1442 
	mO±_»sgid
, 
	mO±_»suid
, 
	mO±_sb
, 
	mO±_”r_cÚt
, 
	mO±_”r_·nic
, 
	mO±_”r_ro
,

1443 
	mO±_nouid32
, 
	mO±_debug
, 
	mO±_»moved
,

1444 
	mO±_u£r_x©Œ
, 
	mO±_nou£r_x©Œ
, 
	mO±_aş
, 
	mO±_nßş
,

1445 
	mO±_auto_da_®loc
, 
	mO±_nßuto_da_®loc
, 
	mO±_nŞßd
,

1446 
	mO±_comm™
, 
	mO±_mš_b©ch_time
, 
	mO±_max_b©ch_time
, 
	mO±_jouº®_dev
,

1447 
	mO±_jouº®_·th
, 
	mO±_jouº®_checksum
, 
	mO±_jouº®_async_comm™
,

1448 
	mO±_abÜt
, 
	mO±_d©a_jouº®
, 
	mO±_d©a_Üd”ed
, 
	mO±_d©a_wr™eback
,

1449 
	mO±_d©a_”r_abÜt
, 
	mO±_d©a_”r_ignÜe
, 
	mO±_‹¡_dummy_’üy±iÚ
,

1450 
	mO±_u¤jquÙa
, 
	mO±_g½jquÙa
, 
	mO±_offu¤jquÙa
, 
	mO±_offg½jquÙa
,

1451 
	mO±_jqfmt_vfsŞd
, 
	mO±_jqfmt_vfsv0
, 
	mO±_jqfmt_vfsv1
, 
	mO±_quÙa
,

1452 
	mO±_noquÙa
, 
	mO±_b¬r›r
, 
	mO±_nob¬r›r
, 
	mO±_”r
,

1453 
	mO±_u¤quÙa
, 
	mO±_g½quÙa
, 
	mO±_´jquÙa
, 
	mO±_i_v”siÚ
, 
	mO±_dax
,

1454 
	mO±_¡re
, 
	mO±_d–®loc
, 
	mO±_nod–®loc
, 
	mO±_w¬n_Ú_”rÜ
,

1455 
	mO±_now¬n_Ú_”rÜ
, 
	mO±_mblk_io_subm™
,

1456 
	mO±_Ïzytime
, 
	mO±_nŞazytime
, 
	mO±_debug_wªt_exŒa_isize
,

1457 
	mO±_nomblk_io_subm™
, 
	mO±_block_v®id™y
, 
	mO±_noblock_v®id™y
,

1458 
	mO±_šode_»adah—d_blks
, 
	mO±_jouº®_iİrio
,

1459 
	mO±_diÜ—d_nŞock
, 
	mO±_diÜ—d_lock
,

1460 
	mO±_disÿrd
, 
	mO±_nodisÿrd
, 
	mO±_š™_™abË
, 
	mO±_noš™_™abË
,

1461 
	mO±_max_dœ_size_kb
, 
	mO±_nojouº®_checksum
, 
	mO±_nombÿche
,

1464 cÚ¡ 
m©ch_bË_t
 
	gtok’s
 = {

1465 {
O±_bsd_df
, "bsddf"},

1466 {
O±_mšix_df
, "minixdf"},

1467 {
O±_g½id
, "grpid"},

1468 {
O±_g½id
, "bsdgroups"},

1469 {
O±_nog½id
, "nogrpid"},

1470 {
O±_nog½id
, "sysvgroups"},

1471 {
O±_»sgid
, "resgid=%u"},

1472 {
O±_»suid
, "resuid=%u"},

1473 {
O±_sb
, "sb=%u"},

1474 {
O±_”r_cÚt
, "errors=continue"},

1475 {
O±_”r_·nic
, "errors=panic"},

1476 {
O±_”r_ro
, "errors=remount-ro"},

1477 {
O±_nouid32
, "nouid32"},

1478 {
O±_debug
, "debug"},

1479 {
O±_»moved
, "oldalloc"},

1480 {
O±_»moved
, "orlov"},

1481 {
O±_u£r_x©Œ
, "user_xattr"},

1482 {
O±_nou£r_x©Œ
, "nouser_xattr"},

1483 {
O±_aş
, "acl"},

1484 {
O±_nßş
, "noacl"},

1485 {
O±_nŞßd
, "norecovery"},

1486 {
O±_nŞßd
, "noload"},

1487 {
O±_»moved
, "nobh"},

1488 {
O±_»moved
, "bh"},

1489 {
O±_comm™
, "commit=%u"},

1490 {
O±_mš_b©ch_time
, "min_batch_time=%u"},

1491 {
O±_max_b©ch_time
, "max_batch_time=%u"},

1492 {
O±_jouº®_dev
, "journal_dev=%u"},

1493 {
O±_jouº®_·th
, "journal_path=%s"},

1494 {
O±_jouº®_checksum
, "journal_checksum"},

1495 {
O±_nojouº®_checksum
, "nojournal_checksum"},

1496 {
O±_jouº®_async_comm™
, "journal_async_commit"},

1497 {
O±_abÜt
, "abort"},

1498 {
O±_d©a_jouº®
, "data=journal"},

1499 {
O±_d©a_Üd”ed
, "data=ordered"},

1500 {
O±_d©a_wr™eback
, "data=writeback"},

1501 {
O±_d©a_”r_abÜt
, "data_err=abort"},

1502 {
O±_d©a_”r_ignÜe
, "data_err=ignore"},

1503 {
O±_offu¤jquÙa
, "usrjquota="},

1504 {
O±_u¤jquÙa
, "usrjquota=%s"},

1505 {
O±_offg½jquÙa
, "grpjquota="},

1506 {
O±_g½jquÙa
, "grpjquota=%s"},

1507 {
O±_jqfmt_vfsŞd
, "jqfmt=vfsold"},

1508 {
O±_jqfmt_vfsv0
, "jqfmt=vfsv0"},

1509 {
O±_jqfmt_vfsv1
, "jqfmt=vfsv1"},

1510 {
O±_g½quÙa
, "grpquota"},

1511 {
O±_noquÙa
, "noquota"},

1512 {
O±_quÙa
, "quota"},

1513 {
O±_u¤quÙa
, "usrquota"},

1514 {
O±_´jquÙa
, "prjquota"},

1515 {
O±_b¬r›r
, "barrier=%u"},

1516 {
O±_b¬r›r
, "barrier"},

1517 {
O±_nob¬r›r
, "nobarrier"},

1518 {
O±_i_v”siÚ
, "i_version"},

1519 {
O±_dax
, "dax"},

1520 {
O±_¡re
, "stripe=%u"},

1521 {
O±_d–®loc
, "delalloc"},

1522 {
O±_w¬n_Ú_”rÜ
, "warn_on_error"},

1523 {
O±_now¬n_Ú_”rÜ
, "nowarn_on_error"},

1524 {
O±_Ïzytime
, "lazytime"},

1525 {
O±_nŞazytime
, "nolazytime"},

1526 {
O±_debug_wªt_exŒa_isize
, "debug_want_extra_isize=%u"},

1527 {
O±_nod–®loc
, "nodelalloc"},

1528 {
O±_»moved
, "mblk_io_submit"},

1529 {
O±_»moved
, "nomblk_io_submit"},

1530 {
O±_block_v®id™y
, "block_validity"},

1531 {
O±_noblock_v®id™y
, "noblock_validity"},

1532 {
O±_šode_»adah—d_blks
, "inode_readahead_blks=%u"},

1533 {
O±_jouº®_iİrio
, "journal_ioprio=%u"},

1534 {
O±_auto_da_®loc
, "auto_da_alloc=%u"},

1535 {
O±_auto_da_®loc
, "auto_da_alloc"},

1536 {
O±_nßuto_da_®loc
, "noauto_da_alloc"},

1537 {
O±_diÜ—d_nŞock
, "dioread_nolock"},

1538 {
O±_diÜ—d_lock
, "dioread_lock"},

1539 {
O±_disÿrd
, "discard"},

1540 {
O±_nodisÿrd
, "nodiscard"},

1541 {
O±_š™_™abË
, "init_itable=%u"},

1542 {
O±_š™_™abË
, "init_itable"},

1543 {
O±_noš™_™abË
, "noinit_itable"},

1544 {
O±_max_dœ_size_kb
, "max_dir_size_kb=%u"},

1545 {
O±_‹¡_dummy_’üy±iÚ
, "test_dummy_encryption"},

1546 {
O±_nombÿche
, "nombcache"},

1547 {
O±_nombÿche
, "no_mbcache"},

1548 {
O±_»moved
, "check=none"},

1549 {
O±_»moved
, "nocheck"},

1550 {
O±_»moved
, "reservation"},

1551 {
O±_»moved
, "noreservation"},

1552 {
O±_»moved
, "journal=%u"},

1553 {
O±_”r
, 
NULL
},

1556 
ext4_fsblk_t
 
	$g‘_sb_block
(**
d©a
)

1558 
ext4_fsblk_t
 
sb_block
;

1559 *
İtiÚs
 = (*è*
d©a
;

1561 ià(!
İtiÚs
 || 
	`¡ºcmp
(options, "sb=", 3) != 0)

1564 
İtiÚs
 += 3;

1566 
sb_block
 = 
	`sim¶e_¡¹oul
(
İtiÚs
, &options, 0);

1567 ià(*
İtiÚs
 && *options != ',') {

1568 
	`´štk
(
KERN_ERR
 "EXT4-fs: Invalid sb specification: %s\n",

1569 (*è*
d©a
);

1572 ià(*
İtiÚs
 == ',')

1573 
İtiÚs
++;

1574 *
d©a
 = (*è
İtiÚs
;

1576  
sb_block
;

1577 
	}
}

1579 
	#DEFAULT_JOURNAL_IOPRIO
 (
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 3))

	)

1580 cÚ¡ 
	gd•»ÿ‹d_msg
[] =

1584 #ifdeà
CONFIG_QUOTA


1585 
	$£t_qf_Çme
(
su³r_block
 *
sb
, 
qty³
, 
sub¡ršg_t
 *
¬gs
)

1587 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1588 *
qÇme
, *
Şd_qÇme
 = 
	`g‘_qf_Çme
(
sb
, 
sbi
, 
qty³
);

1589 
»t
 = -1;

1591 ià(
	`sb_ªy_quÙa_lßded
(
sb
è&& !
Şd_qÇme
) {

1592 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1597 ià(
	`ext4_has_ã©u»_quÙa
(
sb
)) {

1598 
	`ext4_msg
(
sb
, 
KERN_INFO
, "Journaled quota options "

1602 
qÇme
 = 
	`m©ch_¡rdup
(
¬gs
);

1603 ià(!
qÇme
) {

1604 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1608 ià(
Şd_qÇme
) {

1609 ià(
	`¡rcmp
(
Şd_qÇme
, 
qÇme
) == 0)

1610 
»t
 = 1;

1612 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1614 
	`QTYPE2NAME
(
qty³
));

1615 
”rout
;

1617 ià(
	`¡rchr
(
qÇme
, '/')) {

1618 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1620 
”rout
;

1622 
	`rcu_assign_poš‹r
(
sbi
->
s_qf_Çmes
[
qty³
], 
qÇme
);

1623 
	`£t_İt
(
sb
, 
QUOTA
);

1625 
”rout
:

1626 
	`kä“
(
qÇme
);

1627  
»t
;

1628 
	}
}

1630 
	$ş—r_qf_Çme
(
su³r_block
 *
sb
, 
qty³
)

1633 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1634 *
Şd_qÇme
 = 
	`g‘_qf_Çme
(
sb
, 
sbi
, 
qty³
);

1636 ià(
	`sb_ªy_quÙa_lßded
(
sb
è&& 
Şd_qÇme
) {

1637 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Cannot change journaled quota options"

1641 
	`rcu_assign_poš‹r
(
sbi
->
s_qf_Çmes
[
qty³
], 
NULL
);

1642 
	`synchrÚize_rcu
();

1643 
	`kä“
(
Şd_qÇme
);

1645 
	}
}

1648 
	#MOPT_SET
 0x0001

	)

1649 
	#MOPT_CLEAR
 0x0002

	)

1650 
	#MOPT_NOSUPPORT
 0x0004

	)

1651 
	#MOPT_EXPLICIT
 0x0008

	)

1652 
	#MOPT_CLEAR_ERR
 0x0010

	)

1653 
	#MOPT_GTE0
 0x0020

	)

1654 #ifdeà
CONFIG_QUOTA


1655 
	#MOPT_Q
 0

	)

1656 
	#MOPT_QFMT
 0x0040

	)

1658 
	#MOPT_Q
 
MOPT_NOSUPPORT


	)

1659 
	#MOPT_QFMT
 
MOPT_NOSUPPORT


	)

1661 
	#MOPT_DATAJ
 0x0080

	)

1662 
	#MOPT_NO_EXT2
 0x0100

	)

1663 
	#MOPT_NO_EXT3
 0x0200

	)

1664 
	#MOPT_EXT4_ONLY
 (
MOPT_NO_EXT2
 | 
MOPT_NO_EXT3
)

	)

1665 
	#MOPT_STRING
 0x0400

	)

1667 cÚ¡ 
	smouÁ_İts
 {

1668 
	mtok’
;

1669 
	mmouÁ_İt
;

1670 
	mæags
;

1671 } 
	gext4_mouÁ_İts
[] = {

1672 {
O±_mšix_df
, 
EXT4_MOUNT_MINIX_DF
, 
MOPT_SET
},

1673 {
O±_bsd_df
, 
EXT4_MOUNT_MINIX_DF
, 
MOPT_CLEAR
},

1674 {
O±_g½id
, 
EXT4_MOUNT_GRPID
, 
MOPT_SET
},

1675 {
O±_nog½id
, 
EXT4_MOUNT_GRPID
, 
MOPT_CLEAR
},

1676 {
O±_block_v®id™y
, 
EXT4_MOUNT_BLOCK_VALIDITY
, 
MOPT_SET
},

1677 {
O±_noblock_v®id™y
, 
EXT4_MOUNT_BLOCK_VALIDITY
, 
MOPT_CLEAR
},

1678 {
O±_diÜ—d_nŞock
, 
EXT4_MOUNT_DIOREAD_NOLOCK
,

1679 
MOPT_EXT4_ONLY
 | 
MOPT_SET
},

1680 {
O±_diÜ—d_lock
, 
EXT4_MOUNT_DIOREAD_NOLOCK
,

1681 
MOPT_EXT4_ONLY
 | 
MOPT_CLEAR
},

1682 {
O±_disÿrd
, 
EXT4_MOUNT_DISCARD
, 
MOPT_SET
},

1683 {
O±_nodisÿrd
, 
EXT4_MOUNT_DISCARD
, 
MOPT_CLEAR
},

1684 {
O±_d–®loc
, 
EXT4_MOUNT_DELALLOC
,

1685 
MOPT_EXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1686 {
O±_nod–®loc
, 
EXT4_MOUNT_DELALLOC
,

1687 
MOPT_EXT4_ONLY
 | 
MOPT_CLEAR
},

1688 {
O±_w¬n_Ú_”rÜ
, 
EXT4_MOUNT_WARN_ON_ERROR
, 
MOPT_SET
},

1689 {
O±_now¬n_Ú_”rÜ
, 
EXT4_MOUNT_WARN_ON_ERROR
, 
MOPT_CLEAR
},

1690 {
O±_nojouº®_checksum
, 
EXT4_MOUNT_JOURNAL_CHECKSUM
,

1691 
MOPT_EXT4_ONLY
 | 
MOPT_CLEAR
},

1692 {
O±_jouº®_checksum
, 
EXT4_MOUNT_JOURNAL_CHECKSUM
,

1693 
MOPT_EXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1694 {
O±_jouº®_async_comm™
, (
EXT4_MOUNT_JOURNAL_ASYNC_COMMIT
 |

1695 
EXT4_MOUNT_JOURNAL_CHECKSUM
),

1696 
MOPT_EXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1697 {
O±_nŞßd
, 
EXT4_MOUNT_NOLOAD
, 
MOPT_NO_EXT2
 | 
MOPT_SET
},

1698 {
O±_”r_·nic
, 
EXT4_MOUNT_ERRORS_PANIC
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1699 {
O±_”r_ro
, 
EXT4_MOUNT_ERRORS_RO
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1700 {
O±_”r_cÚt
, 
EXT4_MOUNT_ERRORS_CONT
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1701 {
O±_d©a_”r_abÜt
, 
EXT4_MOUNT_DATA_ERR_ABORT
,

1702 
MOPT_NO_EXT2
},

1703 {
O±_d©a_”r_ignÜe
, 
EXT4_MOUNT_DATA_ERR_ABORT
,

1704 
MOPT_NO_EXT2
},

1705 {
O±_b¬r›r
, 
EXT4_MOUNT_BARRIER
, 
MOPT_SET
},

1706 {
O±_nob¬r›r
, 
EXT4_MOUNT_BARRIER
, 
MOPT_CLEAR
},

1707 {
O±_nßuto_da_®loc
, 
EXT4_MOUNT_NO_AUTO_DA_ALLOC
, 
MOPT_SET
},

1708 {
O±_auto_da_®loc
, 
EXT4_MOUNT_NO_AUTO_DA_ALLOC
, 
MOPT_CLEAR
},

1709 {
O±_noš™_™abË
, 
EXT4_MOUNT_INIT_INODE_TABLE
, 
MOPT_CLEAR
},

1710 {
O±_comm™
, 0, 
MOPT_GTE0
},

1711 {
O±_max_b©ch_time
, 0, 
MOPT_GTE0
},

1712 {
O±_mš_b©ch_time
, 0, 
MOPT_GTE0
},

1713 {
O±_šode_»adah—d_blks
, 0, 
MOPT_GTE0
},

1714 {
O±_š™_™abË
, 0, 
MOPT_GTE0
},

1715 {
O±_dax
, 
EXT4_MOUNT_DAX
, 
MOPT_SET
},

1716 {
O±_¡re
, 0, 
MOPT_GTE0
},

1717 {
O±_»suid
, 0, 
MOPT_GTE0
},

1718 {
O±_»sgid
, 0, 
MOPT_GTE0
},

1719 {
O±_jouº®_dev
, 0, 
MOPT_NO_EXT2
 | 
MOPT_GTE0
},

1720 {
O±_jouº®_·th
, 0, 
MOPT_NO_EXT2
 | 
MOPT_STRING
},

1721 {
O±_jouº®_iİrio
, 0, 
MOPT_NO_EXT2
 | 
MOPT_GTE0
},

1722 {
O±_d©a_jouº®
, 
EXT4_MOUNT_JOURNAL_DATA
, 
MOPT_NO_EXT2
 | 
MOPT_DATAJ
},

1723 {
O±_d©a_Üd”ed
, 
EXT4_MOUNT_ORDERED_DATA
, 
MOPT_NO_EXT2
 | 
MOPT_DATAJ
},

1724 {
O±_d©a_wr™eback
, 
EXT4_MOUNT_WRITEBACK_DATA
,

1725 
MOPT_NO_EXT2
 | 
MOPT_DATAJ
},

1726 {
O±_u£r_x©Œ
, 
EXT4_MOUNT_XATTR_USER
, 
MOPT_SET
},

1727 {
O±_nou£r_x©Œ
, 
EXT4_MOUNT_XATTR_USER
, 
MOPT_CLEAR
},

1728 #ifdeà
CONFIG_EXT4_FS_POSIX_ACL


1729 {
O±_aş
, 
EXT4_MOUNT_POSIX_ACL
, 
MOPT_SET
},

1730 {
O±_nßş
, 
EXT4_MOUNT_POSIX_ACL
, 
MOPT_CLEAR
},

1732 {
O±_aş
, 0, 
MOPT_NOSUPPORT
},

1733 {
O±_nßş
, 0, 
MOPT_NOSUPPORT
},

1735 {
O±_nouid32
, 
EXT4_MOUNT_NO_UID32
, 
MOPT_SET
},

1736 {
O±_debug
, 
EXT4_MOUNT_DEBUG
, 
MOPT_SET
},

1737 {
O±_debug_wªt_exŒa_isize
, 0, 
MOPT_GTE0
},

1738 {
O±_quÙa
, 
EXT4_MOUNT_QUOTA
 | 
EXT4_MOUNT_USRQUOTA
, 
MOPT_SET
 | 
MOPT_Q
},

1739 {
O±_u¤quÙa
, 
EXT4_MOUNT_QUOTA
 | 
EXT4_MOUNT_USRQUOTA
,

1740 
MOPT_SET
 | 
MOPT_Q
},

1741 {
O±_g½quÙa
, 
EXT4_MOUNT_QUOTA
 | 
EXT4_MOUNT_GRPQUOTA
,

1742 
MOPT_SET
 | 
MOPT_Q
},

1743 {
O±_´jquÙa
, 
EXT4_MOUNT_QUOTA
 | 
EXT4_MOUNT_PRJQUOTA
,

1744 
MOPT_SET
 | 
MOPT_Q
},

1745 {
O±_noquÙa
, (
EXT4_MOUNT_QUOTA
 | 
EXT4_MOUNT_USRQUOTA
 |

1746 
EXT4_MOUNT_GRPQUOTA
 | 
EXT4_MOUNT_PRJQUOTA
),

1747 
MOPT_CLEAR
 | 
MOPT_Q
},

1748 {
O±_u¤jquÙa
, 0, 
MOPT_Q
},

1749 {
O±_g½jquÙa
, 0, 
MOPT_Q
},

1750 {
O±_offu¤jquÙa
, 0, 
MOPT_Q
},

1751 {
O±_offg½jquÙa
, 0, 
MOPT_Q
},

1752 {
O±_jqfmt_vfsŞd
, 
QFMT_VFS_OLD
, 
MOPT_QFMT
},

1753 {
O±_jqfmt_vfsv0
, 
QFMT_VFS_V0
, 
MOPT_QFMT
},

1754 {
O±_jqfmt_vfsv1
, 
QFMT_VFS_V1
, 
MOPT_QFMT
},

1755 {
O±_max_dœ_size_kb
, 0, 
MOPT_GTE0
},

1756 {
O±_‹¡_dummy_’üy±iÚ
, 0, 
MOPT_GTE0
},

1757 {
O±_nombÿche
, 
EXT4_MOUNT_NO_MBCACHE
, 
MOPT_SET
},

1758 {
O±_”r
, 0, 0}

1761 #ifdeà
CONFIG_UNICODE


1762 cÚ¡ 
	sext4_sb_’codšgs
 {

1763 
__u16
 
	mmagic
;

1764 *
	mÇme
;

1765 *
	mv”siÚ
;

1766 } 
	gext4_sb_’codšg_m­
[] = {

1767 {
EXT4_ENC_UTF8_12_1
, "utf8", "12.1.0"},

1770 
	$ext4_sb_»ad_’codšg
(cÚ¡ 
ext4_su³r_block
 *
es
,

1771 cÚ¡ 
ext4_sb_’codšgs
 **
’codšg
,

1772 
__u16
 *
æags
)

1774 
__u16
 
magic
 = 
	`Ë16_to_ıu
(
es
->
s_’codšg
);

1775 
i
;

1777 
i
 = 0; i < 
	`ARRAY_SIZE
(
ext4_sb_’codšg_m­
); i++)

1778 ià(
magic
 =ğ
ext4_sb_’codšg_m­
[
i
].magic)

1781 ià(
i
 >ğ
	`ARRAY_SIZE
(
ext4_sb_’codšg_m­
))

1782  -
EINVAL
;

1784 *
’codšg
 = &
ext4_sb_’codšg_m­
[
i
];

1785 *
æags
 = 
	`Ë16_to_ıu
(
es
->
s_’codšg_æags
);

1788 
	}
}

1791 
	$hªdË_mouÁ_İt
(
su³r_block
 *
sb
, *
İt
, 
tok’
,

1792 
sub¡ršg_t
 *
¬gs
, *
jouº®_devnum
,

1793 *
jouº®_iİrio
, 
is_»mouÁ
)

1795 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1796 cÚ¡ 
mouÁ_İts
 *
m
;

1797 
kuid_t
 
uid
;

1798 
kgid_t
 
gid
;

1799 
¬g
 = 0;

1801 #ifdeà
CONFIG_QUOTA


1802 ià(
tok’
 =ğ
O±_u¤jquÙa
)

1803  
	`£t_qf_Çme
(
sb
, 
USRQUOTA
, &
¬gs
[0]);

1804 ià(
tok’
 =ğ
O±_g½jquÙa
)

1805  
	`£t_qf_Çme
(
sb
, 
GRPQUOTA
, &
¬gs
[0]);

1806 ià(
tok’
 =ğ
O±_offu¤jquÙa
)

1807  
	`ş—r_qf_Çme
(
sb
, 
USRQUOTA
);

1808 ià(
tok’
 =ğ
O±_offg½jquÙa
)

1809  
	`ş—r_qf_Çme
(
sb
, 
GRPQUOTA
);

1811 
tok’
) {

1812 
O±_nßş
:

1813 
O±_nou£r_x©Œ
:

1814 
	`ext4_msg
(
sb
, 
KERN_WARNING
, 
d•»ÿ‹d_msg
, 
İt
, "3.5");

1816 
O±_sb
:

1818 
O±_»moved
:

1819 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "IgnÜšg„emoved % İtiÚ", 
İt
);

1821 
O±_abÜt
:

1822 
sbi
->
s_mouÁ_æags
 |ğ
EXT4_MF_FS_ABORTED
;

1824 
O±_i_v”siÚ
:

1825 
sb
->
s_æags
 |ğ
SB_I_VERSION
;

1827 
O±_Ïzytime
:

1828 
sb
->
s_æags
 |ğ
SB_LAZYTIME
;

1830 
O±_nŞazytime
:

1831 
sb
->
s_æags
 &ğ~
SB_LAZYTIME
;

1835 
m
 = 
ext4_mouÁ_İts
; m->
tok’
 !ğ
O±_”r
; m++)

1836 ià(
tok’
 =ğ
m
->token)

1839 ià(
m
->
tok’
 =ğ
O±_”r
) {

1840 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Unrecognized mount option \"%s\" "

1841 "Ü missšg v®ue", 
İt
);

1845 ià((
m
->
æags
 & 
MOPT_NO_EXT2
è&& 
	`IS_EXT2_SB
(
sb
)) {

1846 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1847 "MouÁ o±iÚ \"%s\" incom·tibË w™hƒxt2", 
İt
);

1850 ià((
m
->
æags
 & 
MOPT_NO_EXT3
è&& 
	`IS_EXT3_SB
(
sb
)) {

1851 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1852 "MouÁ o±iÚ \"%s\" incom·tibË w™hƒxt3", 
İt
);

1856 ià(
¬gs
->
äom
 && !(
m
->
æags
 & 
MOPT_STRING
è&& 
	`m©ch_št
×rgs, &
¬g
))

1858 ià(
¬gs
->
äom
 && (
m
->
æags
 & 
MOPT_GTE0
è&& (
¬g
 < 0))

1860 ià(
m
->
æags
 & 
MOPT_EXPLICIT
) {

1861 ià(
m
->
mouÁ_İt
 & 
EXT4_MOUNT_DELALLOC
) {

1862 
	`£t_İt2
(
sb
, 
EXPLICIT_DELALLOC
);

1863 } ià(
m
->
mouÁ_İt
 & 
EXT4_MOUNT_JOURNAL_CHECKSUM
) {

1864 
	`£t_İt2
(
sb
, 
EXPLICIT_JOURNAL_CHECKSUM
);

1868 ià(
m
->
æags
 & 
MOPT_CLEAR_ERR
)

1869 
	`ş—r_İt
(
sb
, 
ERRORS_MASK
);

1870 ià(
tok’
 =ğ
O±_noquÙa
 && 
	`sb_ªy_quÙa_lßded
(
sb
)) {

1871 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Cannot change quota "

1876 ià(
m
->
æags
 & 
MOPT_NOSUPPORT
) {

1877 
	`ext4_msg
(
sb
, 
KERN_ERR
, "% İtiÚ‚Ù suµÜ‹d", 
İt
);

1878 } ià(
tok’
 =ğ
O±_comm™
) {

1879 ià(
¬g
 == 0)

1880 
¬g
 = 
JBD2_DEFAULT_MAX_COMMIT_AGE
;

1881 ià(
¬g
 > 
INT_MAX
 / 
HZ
) {

1882 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1885 
¬g
, 
INT_MAX
 / 
HZ
);

1888 
sbi
->
s_comm™_š‹rv®
 = 
HZ
 * 
¬g
;

1889 } ià(
tok’
 =ğ
O±_debug_wªt_exŒa_isize
) {

1890 
sbi
->
s_wªt_exŒa_isize
 = 
¬g
;

1891 } ià(
tok’
 =ğ
O±_max_b©ch_time
) {

1892 
sbi
->
s_max_b©ch_time
 = 
¬g
;

1893 } ià(
tok’
 =ğ
O±_mš_b©ch_time
) {

1894 
sbi
->
s_mš_b©ch_time
 = 
¬g
;

1895 } ià(
tok’
 =ğ
O±_šode_»adah—d_blks
) {

1896 ià(
¬g
 && (¬g > (1 << 30è|| !
	`is_pow”_of_2
(arg))) {

1897 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1902 
sbi
->
s_šode_»adah—d_blks
 = 
¬g
;

1903 } ià(
tok’
 =ğ
O±_š™_™abË
) {

1904 
	`£t_İt
(
sb
, 
INIT_INODE_TABLE
);

1905 ià(!
¬gs
->
äom
)

1906 
¬g
 = 
EXT4_DEF_LI_WAIT_MULT
;

1907 
sbi
->
s_li_wa™_muÉ
 = 
¬g
;

1908 } ià(
tok’
 =ğ
O±_max_dœ_size_kb
) {

1909 
sbi
->
s_max_dœ_size_kb
 = 
¬g
;

1910 } ià(
tok’
 =ğ
O±_¡re
) {

1911 
sbi
->
s_¡re
 = 
¬g
;

1912 } ià(
tok’
 =ğ
O±_»suid
) {

1913 
uid
 = 
	`make_kuid
(
	`cu¼’t_u£r_ns
(), 
¬g
);

1914 ià(!
	`uid_v®id
(
uid
)) {

1915 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Inv®id uid v®u%d", 
¬g
);

1918 
sbi
->
s_»suid
 = 
uid
;

1919 } ià(
tok’
 =ğ
O±_»sgid
) {

1920 
gid
 = 
	`make_kgid
(
	`cu¼’t_u£r_ns
(), 
¬g
);

1921 ià(!
	`gid_v®id
(
gid
)) {

1922 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Inv®id gid v®u%d", 
¬g
);

1925 
sbi
->
s_»sgid
 = 
gid
;

1926 } ià(
tok’
 =ğ
O±_jouº®_dev
) {

1927 ià(
is_»mouÁ
) {

1928 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1932 *
jouº®_devnum
 = 
¬g
;

1933 } ià(
tok’
 =ğ
O±_jouº®_·th
) {

1934 *
jouº®_·th
;

1935 
šode
 *
jouº®_šode
;

1936 
·th
…ath;

1937 
”rÜ
;

1939 ià(
is_»mouÁ
) {

1940 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1944 
jouº®_·th
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

1945 ià(!
jouº®_·th
) {

1946 
	`ext4_msg
(
sb
, 
KERN_ERR
, "error: could‚ot dup "

1951 
”rÜ
 = 
	`k”n_·th
(
jouº®_·th
, 
LOOKUP_FOLLOW
, &
·th
);

1952 ià(
”rÜ
) {

1953 
	`ext4_msg
(
sb
, 
KERN_ERR
, "error: could‚ot find "

1954 "jouº® deviû…©h:ƒ¼Ü %d", 
”rÜ
);

1955 
	`kä“
(
jouº®_·th
);

1959 
jouº®_šode
 = 
	`d_šode
(
·th
.
d’Œy
);

1960 ià(!
	`S_ISBLK
(
jouº®_šode
->
i_mode
)) {

1961 
	`ext4_msg
(
sb
, 
KERN_ERR
, "error: journal…ath %s "

1962 "i nÙ‡ block deviû", 
jouº®_·th
);

1963 
	`·th_put
(&
·th
);

1964 
	`kä“
(
jouº®_·th
);

1968 *
jouº®_devnum
 = 
	`Ãw_’code_dev
(
jouº®_šode
->
i_rdev
);

1969 
	`·th_put
(&
·th
);

1970 
	`kä“
(
jouº®_·th
);

1971 } ià(
tok’
 =ğ
O±_jouº®_iİrio
) {

1972 ià(
¬g
 > 7) {

1973 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Invalid journal IO…riority"

1977 *
jouº®_iİrio
 =

1978 
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 
¬g
);

1979 } ià(
tok’
 =ğ
O±_‹¡_dummy_’üy±iÚ
) {

1980 #ifdeà
CONFIG_FS_ENCRYPTION


1981 
sbi
->
s_mouÁ_æags
 |ğ
EXT4_MF_TEST_DUMMY_ENCRYPTION
;

1982 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

1985 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

1988 } ià(
m
->
æags
 & 
MOPT_DATAJ
) {

1989 ià(
is_»mouÁ
) {

1990 ià(!
sbi
->
s_jouº®
)

1991 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "Remounting file system with‚o journal so ignoring journalled data option");

1992 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è!ğ
m
->
mouÁ_İt
) {

1993 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1998 
	`ş—r_İt
(
sb
, 
DATA_FLAGS
);

1999 
sbi
->
s_mouÁ_İt
 |ğ
m
->
mouÁ_İt
;

2001 #ifdeà
CONFIG_QUOTA


2002 } ià(
m
->
æags
 & 
MOPT_QFMT
) {

2003 ià(
	`sb_ªy_quÙa_lßded
(
sb
) &&

2004 
sbi
->
s_jquÙa_fmt
 !ğ
m
->
mouÁ_İt
) {

2005 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Cannot change journaled "

2009 ià(
	`ext4_has_ã©u»_quÙa
(
sb
)) {

2010 
	`ext4_msg
(
sb
, 
KERN_INFO
,

2015 
sbi
->
s_jquÙa_fmt
 = 
m
->
mouÁ_İt
;

2017 } ià(
tok’
 =ğ
O±_dax
) {

2018 #ifdeà
CONFIG_FS_DAX


2019 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

2021 
sbi
->
s_mouÁ_İt
 |ğ
m
->
mouÁ_İt
;

2023 
	`ext4_msg
(
sb
, 
KERN_INFO
, "dax option‚ot supported");

2026 } ià(
tok’
 =ğ
O±_d©a_”r_abÜt
) {

2027 
sbi
->
s_mouÁ_İt
 |ğ
m
->
mouÁ_İt
;

2028 } ià(
tok’
 =ğ
O±_d©a_”r_ignÜe
) {

2029 
sbi
->
s_mouÁ_İt
 &ğ~
m
->
mouÁ_İt
;

2031 ià(!
¬gs
->
äom
)

2032 
¬g
 = 1;

2033 ià(
m
->
æags
 & 
MOPT_CLEAR
)

2034 
¬g
 = !arg;

2035 ià(
	`uÆik–y
(!(
m
->
æags
 & 
MOPT_SET
))) {

2036 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

2037 "buggy hªdlšg oàİtiÚ %s", 
İt
);

2038 
	`WARN_ON
(1);

2041 ià(
¬g
 != 0)

2042 
sbi
->
s_mouÁ_İt
 |ğ
m
->
mouÁ_İt
;

2044 
sbi
->
s_mouÁ_İt
 &ğ~
m
->
mouÁ_İt
;

2047 
	}
}

2049 
	$·r£_İtiÚs
(*
İtiÚs
, 
su³r_block
 *
sb
,

2050 *
jouº®_devnum
,

2051 *
jouº®_iİrio
,

2052 
is_»mouÁ
)

2054 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2055 *
p
, 
__maybe_unu£d
 *
u¤_qf_Çme
, __maybe_unu£d *
g½_qf_Çme
;

2056 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

2057 
tok’
;

2059 ià(!
İtiÚs
)

2062 (
p
 = 
	`¡r£p
(&
İtiÚs
, ",")è!ğ
NULL
) {

2063 ià(!*
p
)

2069 
¬gs
[0].
to
 =‡rgs[0].
äom
 = 
NULL
;

2070 
tok’
 = 
	`m©ch_tok’
(
p
, 
tok’s
, 
¬gs
);

2071 ià(
	`hªdË_mouÁ_İt
(
sb
, 
p
, 
tok’
, 
¬gs
, 
jouº®_devnum
,

2072 
jouº®_iİrio
, 
is_»mouÁ
) < 0)

2075 #ifdeà
CONFIG_QUOTA


2081 ià(
	`‹¡_İt
(
sb
, 
PRJQUOTA
è&& !
	`ext4_has_ã©u»_´ojeù
(sb)) {

2082 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Project quota feature‚otƒnabled. "

2086 
u¤_qf_Çme
 = 
	`g‘_qf_Çme
(
sb
, 
sbi
, 
USRQUOTA
);

2087 
g½_qf_Çme
 = 
	`g‘_qf_Çme
(
sb
, 
sbi
, 
GRPQUOTA
);

2088 ià(
u¤_qf_Çme
 || 
g½_qf_Çme
) {

2089 ià(
	`‹¡_İt
(
sb
, 
USRQUOTA
è&& 
u¤_qf_Çme
)

2090 
	`ş—r_İt
(
sb
, 
USRQUOTA
);

2092 ià(
	`‹¡_İt
(
sb
, 
GRPQUOTA
è&& 
g½_qf_Çme
)

2093 
	`ş—r_İt
(
sb
, 
GRPQUOTA
);

2095 ià(
	`‹¡_İt
(
sb
, 
GRPQUOTA
è||e¡_İt(sb, 
USRQUOTA
)) {

2096 
	`ext4_msg
(
sb
, 
KERN_ERR
, "old‡nd‚ew quota "

2101 ià(!
sbi
->
s_jquÙa_fmt
) {

2102 
	`ext4_msg
(
sb
, 
KERN_ERR
, "journaled quota format "

2108 ià(
	`‹¡_İt
(
sb
, 
DIOREAD_NOLOCK
)) {

2109 
blocksize
 =

2110 
BLOCK_SIZE
 << 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_log_block_size
);

2112 ià(
blocksize
 < 
PAGE_SIZE
) {

2113 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

2119 
	}
}

2121 
šlše
 
	$ext4_show_quÙa_İtiÚs
(
£q_fe
 *
£q
,

2122 
su³r_block
 *
sb
)

2124 #ià
	`defšed
(
CONFIG_QUOTA
)

2125 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2126 *
u¤_qf_Çme
, *
g½_qf_Çme
;

2128 ià(
sbi
->
s_jquÙa_fmt
) {

2129 *
fmŠame
 = "";

2131 
sbi
->
s_jquÙa_fmt
) {

2132 
QFMT_VFS_OLD
:

2133 
fmŠame
 = "vfsold";

2135 
QFMT_VFS_V0
:

2136 
fmŠame
 = "vfsv0";

2138 
QFMT_VFS_V1
:

2139 
fmŠame
 = "vfsv1";

2142 
	`£q_´štf
(
£q
, ",jqfmt=%s", 
fmŠame
);

2145 
	`rcu_»ad_lock
();

2146 
u¤_qf_Çme
 = 
	`rcu_d”eã»nû
(
sbi
->
s_qf_Çmes
[
USRQUOTA
]);

2147 
g½_qf_Çme
 = 
	`rcu_d”eã»nû
(
sbi
->
s_qf_Çmes
[
GRPQUOTA
]);

2148 ià(
u¤_qf_Çme
)

2149 
	`£q_show_İtiÚ
(
£q
, "u¤jquÙa", 
u¤_qf_Çme
);

2150 ià(
g½_qf_Çme
)

2151 
	`£q_show_İtiÚ
(
£q
, "g½jquÙa", 
g½_qf_Çme
);

2152 
	`rcu_»ad_uÆock
();

2154 
	}
}

2156 cÚ¡ *
	$tok’2¡r
(
tok’
)

2158 cÚ¡ 
m©ch_tok’
 *
t
;

2160 
t
 = 
tok’s
;->
tok’
 !ğ
O±_”r
;++)

2161 ià(
t
->
tok’
 =ğtok’ && !
	`¡rchr
Ñ->
·‰”n
, '='))

2163  
t
->
·‰”n
;

2164 
	}
}

2171 
	$_ext4_show_İtiÚs
(
£q_fe
 *
£q
, 
su³r_block
 *
sb
,

2172 
nodefs
)

2174 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2175 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

2176 
def_”rÜs
, 
def_mouÁ_İt
 = 
sbi
->
s_def_mouÁ_İt
;

2177 cÚ¡ 
mouÁ_İts
 *
m
;

2178 
£p
 = 
nodefs
 ? '\n' : ',';

2180 
	#SEQ_OPTS_PUTS
(
¡r
è
	`£q_´štf
(
£q
, "%c" sŒ, 
£p
)

	)

2181 
	#SEQ_OPTS_PRINT
(
¡r
, 
¬g
è
	`£q_´štf
(
£q
, "%c" sŒ, 
£p
,‡rg)

	)

2183 ià(
sbi
->
s_sb_block
 != 1)

2184 
	`SEQ_OPTS_PRINT
("sb=%Îu", 
sbi
->
s_sb_block
);

2186 
m
 = 
ext4_mouÁ_İts
; m->
tok’
 !ğ
O±_”r
; m++) {

2187 
wªt_£t
 = 
m
->
æags
 & 
MOPT_SET
;

2188 ià(((
m
->
æags
 & (
MOPT_SET
|
MOPT_CLEAR
)) == 0) ||

2189 (
m
->
æags
 & 
MOPT_CLEAR_ERR
))

2191 ià(!
nodefs
 && !(
m
->
mouÁ_İt
 & (
sbi
->
s_mouÁ_İt
 ^ 
def_mouÁ_İt
)))

2193 ià((
wªt_£t
 &&

2194 (
sbi
->
s_mouÁ_İt
 & 
m
->
mouÁ_İt
) != m->mount_opt) ||

2195 (!
wªt_£t
 && (
sbi
->
s_mouÁ_İt
 & 
m
->
mouÁ_İt
)))

2197 
	`SEQ_OPTS_PRINT
("%s", 
	`tok’2¡r
(
m
->
tok’
));

2200 ià(
nodefs
 || !
	`uid_eq
(
sbi
->
s_»suid
, 
	`make_kuid
(&
š™_u£r_ns
, 
EXT4_DEF_RESUID
)) ||

2201 
	`Ë16_to_ıu
(
es
->
s_def_»suid
è!ğ
EXT4_DEF_RESUID
)

2202 
	`SEQ_OPTS_PRINT
("resuid=%u",

2203 
	`äom_kuid_munged
(&
š™_u£r_ns
, 
sbi
->
s_»suid
));

2204 ià(
nodefs
 || !
	`gid_eq
(
sbi
->
s_»sgid
, 
	`make_kgid
(&
š™_u£r_ns
, 
EXT4_DEF_RESGID
)) ||

2205 
	`Ë16_to_ıu
(
es
->
s_def_»sgid
è!ğ
EXT4_DEF_RESGID
)

2206 
	`SEQ_OPTS_PRINT
("resgid=%u",

2207 
	`äom_kgid_munged
(&
š™_u£r_ns
, 
sbi
->
s_»sgid
));

2208 
def_”rÜs
 = 
nodefs
 ? -1 : 
	`Ë16_to_ıu
(
es
->
s_”rÜs
);

2209 ià(
	`‹¡_İt
(
sb
, 
ERRORS_RO
è&& 
def_”rÜs
 !ğ
EXT4_ERRORS_RO
)

2210 
	`SEQ_OPTS_PUTS
("errors=remount-ro");

2211 ià(
	`‹¡_İt
(
sb
, 
ERRORS_CONT
è&& 
def_”rÜs
 !ğ
EXT4_ERRORS_CONTINUE
)

2212 
	`SEQ_OPTS_PUTS
("errors=continue");

2213 ià(
	`‹¡_İt
(
sb
, 
ERRORS_PANIC
è&& 
def_”rÜs
 !ğ
EXT4_ERRORS_PANIC
)

2214 
	`SEQ_OPTS_PUTS
("errors=panic");

2215 ià(
nodefs
 || 
sbi
->
s_comm™_š‹rv®
 !ğ
JBD2_DEFAULT_MAX_COMMIT_AGE
*
HZ
)

2216 
	`SEQ_OPTS_PRINT
("comm™=%lu", 
sbi
->
s_comm™_š‹rv®
 / 
HZ
);

2217 ià(
nodefs
 || 
sbi
->
s_mš_b©ch_time
 !ğ
EXT4_DEF_MIN_BATCH_TIME
)

2218 
	`SEQ_OPTS_PRINT
("mš_b©ch_time=%u", 
sbi
->
s_mš_b©ch_time
);

2219 ià(
nodefs
 || 
sbi
->
s_max_b©ch_time
 !ğ
EXT4_DEF_MAX_BATCH_TIME
)

2220 
	`SEQ_OPTS_PRINT
("max_b©ch_time=%u", 
sbi
->
s_max_b©ch_time
);

2221 ià(
sb
->
s_æags
 & 
SB_I_VERSION
)

2222 
	`SEQ_OPTS_PUTS
("i_version");

2223 ià(
nodefs
 || 
sbi
->
s_¡re
)

2224 
	`SEQ_OPTS_PRINT
("¡re=%lu", 
sbi
->
s_¡re
);

2225 ià(
nodefs
 || 
EXT4_MOUNT_DATA_FLAGS
 &

2226 (
sbi
->
s_mouÁ_İt
 ^ 
def_mouÁ_İt
)) {

2227 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_JOURNAL_DATA
)

2228 
	`SEQ_OPTS_PUTS
("data=journal");

2229 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_ORDERED_DATA
)

2230 
	`SEQ_OPTS_PUTS
("data=ordered");

2231 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_WRITEBACK_DATA
)

2232 
	`SEQ_OPTS_PUTS
("data=writeback");

2234 ià(
nodefs
 ||

2235 
sbi
->
s_šode_»adah—d_blks
 !ğ
EXT4_DEF_INODE_READAHEAD_BLKS
)

2236 
	`SEQ_OPTS_PRINT
("inode_readahead_blks=%u",

2237 
sbi
->
s_šode_»adah—d_blks
);

2239 ià(
	`‹¡_İt
(
sb
, 
INIT_INODE_TABLE
è&& (
nodefs
 ||

2240 (
sbi
->
s_li_wa™_muÉ
 !ğ
EXT4_DEF_LI_WAIT_MULT
)))

2241 
	`SEQ_OPTS_PRINT
("š™_™abË=%u", 
sbi
->
s_li_wa™_muÉ
);

2242 ià(
nodefs
 || 
sbi
->
s_max_dœ_size_kb
)

2243 
	`SEQ_OPTS_PRINT
("max_dœ_size_kb=%u", 
sbi
->
s_max_dœ_size_kb
);

2244 ià(
	`‹¡_İt
(
sb
, 
DATA_ERR_ABORT
))

2245 
	`SEQ_OPTS_PUTS
("data_err=abort");

2246 ià(
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
))

2247 
	`SEQ_OPTS_PUTS
("test_dummy_encryption");

2249 
	`ext4_show_quÙa_İtiÚs
(
£q
, 
sb
);

2251 
	}
}

2253 
	$ext4_show_İtiÚs
(
£q_fe
 *
£q
, 
d’Œy
 *
roÙ
)

2255  
	`_ext4_show_İtiÚs
(
£q
, 
roÙ
->
d_sb
, 0);

2256 
	}
}

2258 
	$ext4_£q_İtiÚs_show
(
£q_fe
 *
£q
, *
off£t
)

2260 
su³r_block
 *
sb
 = 
£q
->
´iv©e
;

2261 
rc
;

2263 
	`£q_puts
(
£q
, 
	`sb_rdÚly
(
sb
) ? "ro" : "rw");

2264 
rc
 = 
	`_ext4_show_İtiÚs
(
£q
, 
sb
, 1);

2265 
	`£q_puts
(
£q
, "\n");

2266  
rc
;

2267 
	}
}

2269 
	$ext4_£tup_su³r
(
su³r_block
 *
sb
, 
ext4_su³r_block
 *
es
,

2270 
»ad_Úly
)

2272 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2273 
”r
 = 0;

2275 ià(
	`Ë32_to_ıu
(
es
->
s_»v_Ëv–
è> 
EXT4_MAX_SUPP_REV
) {

2276 
	`ext4_msg
(
sb
, 
KERN_ERR
, "revision†eveloo high, "

2278 
”r
 = -
EROFS
;

2280 ià(
»ad_Úly
)

2281 
dÚe
;

2282 ià(!(
sbi
->
s_mouÁ_¡©e
 & 
EXT4_VALID_FS
))

2283 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "warning: mounting unchecked fs, "

2285 ià(
sbi
->
s_mouÁ_¡©e
 & 
EXT4_ERROR_FS
)

2286 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

2289 ià((
__s16
è
	`Ë16_to_ıu
(
es
->
s_max_mÁ_couÁ
) > 0 &&

2290 
	`Ë16_to_ıu
(
es
->
s_mÁ_couÁ
) >=

2291 (è(
__s16
è
	`Ë16_to_ıu
(
es
->
s_max_mÁ_couÁ
))

2292 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

2295 ià(
	`Ë32_to_ıu
(
es
->
s_checkš‹rv®
) &&

2296 (
	`ext4_g‘_t¡amp
(
es
, 
s_Ï¡check
) +

2297 
	`Ë32_to_ıu
(
es
->
s_checkš‹rv®
è<ğ
	`ktime_g‘_»®_£cÚds
()))

2298 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

2301 ià(!
sbi
->
s_jouº®
)

2302 
es
->
s_¡©e
 &ğ
	`ıu_to_Ë16
(~
EXT4_VALID_FS
);

2303 ià(!(
__s16
è
	`Ë16_to_ıu
(
es
->
s_max_mÁ_couÁ
))

2304 
es
->
s_max_mÁ_couÁ
 = 
	`ıu_to_Ë16
(
EXT4_DFL_MAX_MNT_COUNT
);

2305 
	`Ë16_add_ıu
(&
es
->
s_mÁ_couÁ
, 1);

2306 
	`ext4_upd©e_t¡amp
(
es
, 
s_mtime
);

2307 ià(
sbi
->
s_jouº®
)

2308 
	`ext4_£t_ã©u»_jouº®_Ãeds_»cov”y
(
sb
);

2310 
”r
 = 
	`ext4_comm™_su³r
(
sb
, 1);

2311 
dÚe
:

2312 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

2313 
	`´štk
(
KERN_INFO
 "[EXT4 FS bs=%lu, gc=%u, "

2315 
sb
->
s_blocksize
,

2316 
sbi
->
s_groups_couÁ
,

2317 
	`EXT4_BLOCKS_PER_GROUP
(
sb
),

2318 
	`EXT4_INODES_PER_GROUP
(
sb
),

2319 
sbi
->
s_mouÁ_İt
, sbi->
s_mouÁ_İt2
);

2321 
	`ş—nÿche_š™_fs
(
sb
);

2322  
”r
;

2323 
	}
}

2325 
	$ext4_®loc_æex_bg_¬¿y
(
su³r_block
 *
sb
, 
ext4_group_t
 
ngroup
)

2327 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2328 
æex_groups
 *
Ãw_groups
;

2329 
size
;

2331 ià(!
sbi
->
s_log_groups_³r_æex
)

2334 
size
 = 
	`ext4_æex_group
(
sbi
, 
ngroup
 - 1) + 1;

2335 ià(
size
 <ğ
sbi
->
s_æex_groups_®loÿ‹d
)

2338 
size
 = 
	`roundup_pow_of_two
(siz* (
æex_groups
));

2339 
Ãw_groups
 = 
	`kvz®loc
(
size
, 
GFP_KERNEL
);

2340 ià(!
Ãw_groups
) {

2341 
	`ext4_msg
(
sb
, 
KERN_ERR
, "notƒnough memory for %d flex groups",

2342 
size
 / (è(
æex_groups
));

2343  -
ENOMEM
;

2346 ià(
sbi
->
s_æex_groups
) {

2347 
	`memıy
(
Ãw_groups
, 
sbi
->
s_æex_groups
,

2348 (
sbi
->
s_æex_groups_®loÿ‹d
 *

2349 (
æex_groups
)));

2350 
	`kvä“
(
sbi
->
s_æex_groups
);

2352 
sbi
->
s_æex_groups
 = 
Ãw_groups
;

2353 
sbi
->
s_æex_groups_®loÿ‹d
 = 
size
 / (
æex_groups
);

2355 
	}
}

2357 
	$ext4_fl_æex_šfo
(
su³r_block
 *
sb
)

2359 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2360 
ext4_group_desc
 *
gdp
 = 
NULL
;

2361 
ext4_group_t
 
æex_group
;

2362 
i
, 
”r
;

2364 
sbi
->
s_log_groups_³r_æex
 = sbi->
s_es
->s_log_groups_per_flex;

2365 ià(
sbi
->
s_log_groups_³r_æex
 < 1 || sbi->s_log_groups_per_flex > 31) {

2366 
sbi
->
s_log_groups_³r_æex
 = 0;

2370 
”r
 = 
	`ext4_®loc_æex_bg_¬¿y
(
sb
, 
sbi
->
s_groups_couÁ
);

2371 ià(
”r
)

2372 
çed
;

2374 
i
 = 0; i < 
sbi
->
s_groups_couÁ
; i++) {

2375 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

2377 
æex_group
 = 
	`ext4_æex_group
(
sbi
, 
i
);

2378 
	`©omic_add
(
	`ext4_ä“_šodes_couÁ
(
sb
, 
gdp
),

2379 &
sbi
->
s_æex_groups
[
æex_group
].
ä“_šodes
);

2380 
	`©omic64_add
(
	`ext4_ä“_group_şu¡”s
(
sb
, 
gdp
),

2381 &
sbi
->
s_æex_groups
[
æex_group
].
ä“_şu¡”s
);

2382 
	`©omic_add
(
	`ext4_u£d_dœs_couÁ
(
sb
, 
gdp
),

2383 &
sbi
->
s_æex_groups
[
æex_group
].
u£d_dœs
);

2387 
çed
:

2389 
	}
}

2391 
__Ë16
 
	$ext4_group_desc_csum
(
su³r_block
 *
sb
, 
__u32
 
block_group
,

2392 
ext4_group_desc
 *
gdp
)

2394 
off£t
 = 
	`off£tof
(
ext4_group_desc
, 
bg_checksum
);

2395 
__u16
 
üc
 = 0;

2396 
__Ë32
 
Ë_group
 = 
	`ıu_to_Ë32
(
block_group
);

2397 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2399 ià(
	`ext4_has_m‘ad©a_csum
(
sbi
->
s_sb
)) {

2401 
__u32
 
csum32
;

2402 
__u16
 
dummy_csum
 = 0;

2404 
csum32
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
Ë_group
,

2405 (
Ë_group
));

2406 
csum32
 = 
	`ext4_chksum
(
sbi
, csum32, (
__u8
 *)
gdp
, 
off£t
);

2407 
csum32
 = 
	`ext4_chksum
(
sbi
, csum32, (
__u8
 *)&
dummy_csum
,

2408 (
dummy_csum
));

2409 
off£t
 +ğ(
dummy_csum
);

2410 ià(
off£t
 < 
sbi
->
s_desc_size
)

2411 
csum32
 = 
	`ext4_chksum
(
sbi
, csum32, (
__u8
 *)
gdp
 + 
off£t
,

2412 
sbi
->
s_desc_size
 - 
off£t
);

2414 
üc
 = 
csum32
 & 0xFFFF;

2415 
out
;

2419 ià(!
	`ext4_has_ã©u»_gdt_csum
(
sb
))

2422 
üc
 = 
	`üc16
(~0, 
sbi
->
s_es
->
s_uuid
, (sbi->s_es->s_uuid));

2423 
üc
 = 
	`üc16
(üc, (
__u8
 *)&
Ë_group
, (le_group));

2424 
üc
 = 
	`üc16
(üc, (
__u8
 *)
gdp
, 
off£t
);

2425 
off£t
 +ğ(
gdp
->
bg_checksum
);

2427 ià(
	`ext4_has_ã©u»_64b™
(
sb
) &&

2428 
off£t
 < 
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_desc_size
))

2429 
üc
 = 
	`üc16
(üc, (
__u8
 *)
gdp
 + 
off£t
,

2430 
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_desc_size
) -

2431 
off£t
);

2433 
out
:

2434  
	`ıu_to_Ë16
(
üc
);

2435 
	}
}

2437 
	$ext4_group_desc_csum_v”ify
(
su³r_block
 *
sb
, 
__u32
 
block_group
,

2438 
ext4_group_desc
 *
gdp
)

2440 ià(
	`ext4_has_group_desc_csum
(
sb
) &&

2441 (
gdp
->
bg_checksum
 !ğ
	`ext4_group_desc_csum
(
sb
, 
block_group
, gdp)))

2445 
	}
}

2447 
	$ext4_group_desc_csum_£t
(
su³r_block
 *
sb
, 
__u32
 
block_group
,

2448 
ext4_group_desc
 *
gdp
)

2450 ià(!
	`ext4_has_group_desc_csum
(
sb
))

2452 
gdp
->
bg_checksum
 = 
	`ext4_group_desc_csum
(
sb
, 
block_group
, gdp);

2453 
	}
}

2456 
	$ext4_check_desütÜs
(
su³r_block
 *
sb
,

2457 
ext4_fsblk_t
 
sb_block
,

2458 
ext4_group_t
 *
fœ¡_nÙ_z”Ûd
)

2460 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2461 
ext4_fsblk_t
 
fœ¡_block
 = 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_d©a_block
);

2462 
ext4_fsblk_t
 
Ï¡_block
;

2463 
ext4_fsblk_t
 
Ï¡_bg_block
 = 
sb_block
 + 
	`ext4_bg_num_gdb
(
sb
, 0);

2464 
ext4_fsblk_t
 
block_b™m­
;

2465 
ext4_fsblk_t
 
šode_b™m­
;

2466 
ext4_fsblk_t
 
šode_bË
;

2467 
æexbg_æag
 = 0;

2468 
ext4_group_t
 
i
, 
g½
 = 
sbi
->
s_groups_couÁ
;

2470 ià(
	`ext4_has_ã©u»_æex_bg
(
sb
))

2471 
æexbg_æag
 = 1;

2473 
	`ext4_debug
("Checking group descriptors");

2475 
i
 = 0; i < 
sbi
->
s_groups_couÁ
; i++) {

2476 
ext4_group_desc
 *
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

2478 ià(
i
 =ğ
sbi
->
s_groups_couÁ
 - 1 || 
æexbg_æag
)

2479 
Ï¡_block
 = 
	`ext4_blocks_couÁ
(
sbi
->
s_es
) - 1;

2481 
Ï¡_block
 = 
fœ¡_block
 +

2482 (
	`EXT4_BLOCKS_PER_GROUP
(
sb
) - 1);

2484 ià((
g½
 =ğ
sbi
->
s_groups_couÁ
) &&

2485 !(
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_INODE_ZEROED
)))

2486 
g½
 = 
i
;

2488 
block_b™m­
 = 
	`ext4_block_b™m­
(
sb
, 
gdp
);

2489 ià(
block_b™m­
 =ğ
sb_block
) {

2490 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2492 "su³rblock", 
i
);

2493 ià(!
	`sb_rdÚly
(
sb
))

2496 ià(
block_b™m­
 >ğ
sb_block
 + 1 &&

2497 
block_b™m­
 <ğ
Ï¡_bg_block
) {

2498 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2500 "block grou°desütÜs", 
i
);

2501 ià(!
	`sb_rdÚly
(
sb
))

2504 ià(
block_b™m­
 < 
fœ¡_block
 || block_b™m­ > 
Ï¡_block
) {

2505 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2507 "(block %Îu)!", 
i
, 
block_b™m­
);

2510 
šode_b™m­
 = 
	`ext4_šode_b™m­
(
sb
, 
gdp
);

2511 ià(
šode_b™m­
 =ğ
sb_block
) {

2512 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2514 "su³rblock", 
i
);

2515 ià(!
	`sb_rdÚly
(
sb
))

2518 ià(
šode_b™m­
 >ğ
sb_block
 + 1 &&

2519 
šode_b™m­
 <ğ
Ï¡_bg_block
) {

2520 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2522 "block grou°desütÜs", 
i
);

2523 ià(!
	`sb_rdÚly
(
sb
))

2526 ià(
šode_b™m­
 < 
fœ¡_block
 || inode_b™m­ > 
Ï¡_block
) {

2527 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2529 "(block %Îu)!", 
i
, 
šode_b™m­
);

2532 
šode_bË
 = 
	`ext4_šode_bË
(
sb
, 
gdp
);

2533 ià(
šode_bË
 =ğ
sb_block
) {

2534 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2536 "su³rblock", 
i
);

2537 ià(!
	`sb_rdÚly
(
sb
))

2540 ià(
šode_bË
 >ğ
sb_block
 + 1 &&

2541 
šode_bË
 <ğ
Ï¡_bg_block
) {

2542 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2544 "block grou°desütÜs", 
i
);

2545 ià(!
	`sb_rdÚly
(
sb
))

2548 ià(
šode_bË
 < 
fœ¡_block
 ||

2549 
šode_bË
 + 
sbi
->
s_™b_³r_group
 - 1 > 
Ï¡_block
) {

2550 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2552 "(block %Îu)!", 
i
, 
šode_bË
);

2555 
	`ext4_lock_group
(
sb
, 
i
);

2556 ià(!
	`ext4_group_desc_csum_v”ify
(
sb
, 
i
, 
gdp
)) {

2557 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2559 
i
, 
	`Ë16_to_ıu
(
	`ext4_group_desc_csum
(
sb
, i,

2560 
gdp
)), 
	`Ë16_to_ıu
(gdp->
bg_checksum
));

2561 ià(!
	`sb_rdÚly
(
sb
)) {

2562 
	`ext4_uÆock_group
(
sb
, 
i
);

2566 
	`ext4_uÆock_group
(
sb
, 
i
);

2567 ià(!
æexbg_æag
)

2568 
fœ¡_block
 +ğ
	`EXT4_BLOCKS_PER_GROUP
(
sb
);

2570 ià(
NULL
 !ğ
fœ¡_nÙ_z”Ûd
)

2571 *
fœ¡_nÙ_z”Ûd
 = 
g½
;

2573 
	}
}

2592 
	$ext4_Üphª_ş—nup
(
su³r_block
 *
sb
,

2593 
ext4_su³r_block
 *
es
)

2595 
s_æags
 = 
sb
->s_flags;

2596 
»t
, 
Ä_Üphªs
 = 0, 
Ä_Œunÿ‹s
 = 0;

2597 #ifdeà
CONFIG_QUOTA


2598 
quÙa_upd©e
 = 0;

2599 
i
;

2601 ià(!
es
->
s_Ï¡_Üphª
) {

2602 
	`jbd_debug
(4, "no orphan inodeso clean up\n");

2606 ià(
	`bdev_»ad_Úly
(
sb
->
s_bdev
)) {

2607 
	`ext4_msg
(
sb
, 
KERN_ERR
, "write‡ccess "

2613 ià(!
	`ext4_ã©u»_£t_ok
(
sb
, 0)) {

2614 
	`ext4_msg
(
sb
, 
KERN_INFO
, "Skipping orphan cleanup dueo "

2619 ià(
	`EXT4_SB
(
sb
)->
s_mouÁ_¡©e
 & 
EXT4_ERROR_FS
) {

2621 ià(
es
->
s_Ï¡_Üphª
 && !(
s_æags
 & 
SB_RDONLY
)) {

2622 
	`ext4_msg
(
sb
, 
KERN_INFO
, "Errors on filesystem, "

2624 
es
->
s_Ï¡_Üphª
 = 0;

2626 
	`jbd_debug
(1, "Skipping orphan„ecovery on fs withƒrrors.\n");

2630 ià(
s_æags
 & 
SB_RDONLY
) {

2631 
	`ext4_msg
(
sb
, 
KERN_INFO
, "orphan cleanup on„eadonly fs");

2632 
sb
->
s_æags
 &ğ~
SB_RDONLY
;

2634 #ifdeà
CONFIG_QUOTA


2636 
sb
->
s_æags
 |ğ
SB_ACTIVE
;

2642 ià(
	`ext4_has_ã©u»_quÙa
(
sb
è&& (
s_æags
 & 
SB_RDONLY
)) {

2643 
»t
 = 
	`ext4_’abË_quÙas
(
sb
);

2645 ià(!
»t
)

2646 
quÙa_upd©e
 = 1;

2648 
	`ext4_msg
(
sb
, 
KERN_ERR
,

2649 "CªnÙuº oÀquÙas:ƒ¼Ü %d", 
»t
);

2653 
i
 = 0; i < 
EXT4_MAXQUOTAS
; i++) {

2654 ià(
	`EXT4_SB
(
sb
)->
s_qf_Çmes
[
i
]) {

2655 
»t
 = 
	`ext4_quÙa_Ú_mouÁ
(
sb
, 
i
);

2657 ià(!
»t
)

2658 
quÙa_upd©e
 = 1;

2660 
	`ext4_msg
(
sb
, 
KERN_ERR
,

2662 "quÙa:y³ %d:ƒ¼Ü %d", 
i
, 
»t
);

2667 
es
->
s_Ï¡_Üphª
) {

2668 
šode
 *inode;

2674 ià(
	`EXT4_SB
(
sb
)->
s_mouÁ_¡©e
 & 
EXT4_ERROR_FS
) {

2675 
	`jbd_debug
(1, "Skipping orphan„ecovery on fs withƒrrors.\n");

2676 
es
->
s_Ï¡_Üphª
 = 0;

2680 
šode
 = 
	`ext4_Üphª_g‘
(
sb
, 
	`Ë32_to_ıu
(
es
->
s_Ï¡_Üphª
));

2681 ià(
	`IS_ERR
(
šode
)) {

2682 
es
->
s_Ï¡_Üphª
 = 0;

2686 
	`li¡_add
(&
	`EXT4_I
(
šode
)->
i_Üphª
, &
	`EXT4_SB
(
sb
)->
s_Üphª
);

2687 
	`dquÙ_š™Ÿlize
(
šode
);

2688 ià(
šode
->
i_Æšk
) {

2689 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

2690 
	`ext4_msg
(
sb
, 
KERN_DEBUG
,

2692 
__func__
, 
šode
->
i_šo
, inode->
i_size
);

2693 
	`jbd_debug
(2, "truncating inode %luo %lld bytes\n",

2694 
šode
->
i_šo
, inode->
i_size
);

2695 
	`šode_lock
(
šode
);

2696 
	`Œunÿ‹_šode_·ges
(
šode
->
i_m­pšg
, inode->
i_size
);

2697 
»t
 = 
	`ext4_Œunÿ‹
(
šode
);

2698 ià(
»t
)

2699 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
»t
);

2700 
	`šode_uÆock
(
šode
);

2701 
Ä_Œunÿ‹s
++;

2703 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

2704 
	`ext4_msg
(
sb
, 
KERN_DEBUG
,

2706 
__func__
, 
šode
->
i_šo
);

2707 
	`jbd_debug
(2, "deleting unreferenced inode %lu\n",

2708 
šode
->
i_šo
);

2709 
Ä_Üphªs
++;

2711 
	`ut
(
šode
);

2714 
	#PLURAL
(
x
è(x), ((xè=ğ1è? "" : "s"

	)

2716 ià(
Ä_Üphªs
)

2717 
	`ext4_msg
(
sb
, 
KERN_INFO
, "%d orphan inode%s deleted",

2718 
	`PLURAL
(
Ä_Üphªs
));

2719 ià(
Ä_Œunÿ‹s
)

2720 
	`ext4_msg
(
sb
, 
KERN_INFO
, "%druncate%s cleaned up",

2721 
	`PLURAL
(
Ä_Œunÿ‹s
));

2722 #ifdeà
CONFIG_QUOTA


2724 ià(
quÙa_upd©e
) {

2725 
i
 = 0; i < 
EXT4_MAXQUOTAS
; i++) {

2726 ià(
	`sb_dqİt
(
sb
)->
fes
[
i
])

2727 
	`dquÙ_quÙa_off
(
sb
, 
i
);

2731 
sb
->
s_æags
 = s_flags;

2732 
	}
}

2749 
loff_t
 
	$ext4_max_size
(
blkb™s
, 
has_huge_fes
)

2751 
loff_t
 
»s
;

2752 
loff_t
 
uµ”_lim™
 = 
MAX_LFS_FILESIZE
;

2754 
	`BUILD_BUG_ON
((
blkút_t
è< (
u64
));

2756 ià(!
has_huge_fes
) {

2757 
uµ”_lim™
 = (1LL << 32) - 1;

2760 
uµ”_lim™
 >>ğ(
blkb™s
 - 9);

2761 
uµ”_lim™
 <<ğ
blkb™s
;

2769 
»s
 = (1LL << 32) - 1;

2770 
»s
 <<ğ
blkb™s
;

2773 ià(
»s
 > 
uµ”_lim™
)

2774 
»s
 = 
uµ”_lim™
;

2776  
»s
;

2777 
	}
}

2784 
loff_t
 
	$ext4_max_b™m­_size
(
b™s
, 
has_huge_fes
)

2786 
loff_t
 
»s
 = 
EXT4_NDIR_BLOCKS
;

2787 
m‘a_blocks
;

2788 
loff_t
 
uµ”_lim™
;

2797 ià(!
has_huge_fes
) {

2803 
uµ”_lim™
 = (1LL << 32) - 1;

2806 
uµ”_lim™
 >>ğ(
b™s
 - 9);

2815 
uµ”_lim™
 = (1LL << 48) - 1;

2820 
m‘a_blocks
 = 1;

2822 
m‘a_blocks
 +ğ1 + (1LL << (
b™s
-2));

2824 
m‘a_blocks
 +ğ1 + (1LL << (
b™s
-2)) + (1LL << (2*(bits-2)));

2826 
uµ”_lim™
 -ğ
m‘a_blocks
;

2827 
uµ”_lim™
 <<ğ
b™s
;

2829 
»s
 +ğ1LL << (
b™s
-2);

2830 
»s
 +ğ1LL << (2*(
b™s
-2));

2831 
»s
 +ğ1LL << (3*(
b™s
-2));

2832 
»s
 <<ğ
b™s
;

2833 ià(
»s
 > 
uµ”_lim™
)

2834 
»s
 = 
uµ”_lim™
;

2836 ià(
»s
 > 
MAX_LFS_FILESIZE
)

2837 
»s
 = 
MAX_LFS_FILESIZE
;

2839  
»s
;

2840 
	}
}

2842 
ext4_fsblk_t
 
	$desütÜ_loc
(
su³r_block
 *
sb
,

2843 
ext4_fsblk_t
 
logiÿl_sb_block
, 
Ä
)

2845 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2846 
ext4_group_t
 
bg
, 
fœ¡_m‘a_bg
;

2847 
has_su³r
 = 0;

2849 
fœ¡_m‘a_bg
 = 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_m‘a_bg
);

2851 ià(!
	`ext4_has_ã©u»_m‘a_bg
(
sb
è|| 
Ä
 < 
fœ¡_m‘a_bg
)

2852  
logiÿl_sb_block
 + 
Ä
 + 1;

2853 
bg
 = 
sbi
->
s_desc_³r_block
 * 
Ä
;

2854 ià(
	`ext4_bg_has_su³r
(
sb
, 
bg
))

2855 
has_su³r
 = 1;

2863 ià(
sb
->
s_blocksize
 =ğ1024 && 
Ä
 == 0 &&

2864 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_d©a_block
) == 0)

2865 
has_su³r
++;

2867  (
has_su³r
 + 
	`ext4_group_fœ¡_block_no
(
sb
, 
bg
));

2868 
	}
}

2881 
	$ext4_g‘_¡re_size
(
ext4_sb_šfo
 *
sbi
)

2883 
¡ride
 = 
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_¿id_¡ride
);

2884 
¡re_width
 =

2885 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_¿id_¡re_width
);

2886 
»t
;

2888 ià(
sbi
->
s_¡re
 && sbi->s_¡r<ğsbi->
s_blocks_³r_group
)

2889 
»t
 = 
sbi
->
s_¡re
;

2890 ià(
¡re_width
 && sŒe_width <ğ
sbi
->
s_blocks_³r_group
)

2891 
»t
 = 
¡re_width
;

2892 ià(
¡ride
 && sŒid<ğ
sbi
->
s_blocks_³r_group
)

2893 
»t
 = 
¡ride
;

2895 
»t
 = 0;

2901 ià(
»t
 <= 1)

2902 
»t
 = 0;

2904  
»t
;

2905 
	}
}

2913 
	$ext4_ã©u»_£t_ok
(
su³r_block
 *
sb
, 
»adÚly
)

2915 ià(
	`ext4_has_unknown_ext4_šcom·t_ã©u»s
(
sb
)) {

2916 
	`ext4_msg
(
sb
, 
KERN_ERR
,

2919 (
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_šcom·t
) &

2920 ~
EXT4_FEATURE_INCOMPAT_SUPP
));

2924 #iâdeà
CONFIG_UNICODE


2925 ià(
	`ext4_has_ã©u»_ÿ£fŞd
(
sb
)) {

2926 
	`ext4_msg
(
sb
, 
KERN_ERR
,

2933 ià(
»adÚly
)

2936 ià(
	`ext4_has_ã©u»_»adÚly
(
sb
)) {

2937 
	`ext4_msg
(
sb
, 
KERN_INFO
, "filesystem is„ead-only");

2938 
sb
->
s_æags
 |ğ
SB_RDONLY
;

2943 ià(
	`ext4_has_unknown_ext4_ro_com·t_ã©u»s
(
sb
)) {

2944 
	`ext4_msg
(
sb
, 
KERN_ERR
, "couldn't mount RDWR because of "

2946 (
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_ro_com·t
) &

2947 ~
EXT4_FEATURE_RO_COMPAT_SUPP
));

2950 ià(
	`ext4_has_ã©u»_big®loc
(
sb
è&& !
	`ext4_has_ã©u»_ex‹Ás
(sb)) {

2951 
	`ext4_msg
(
sb
, 
KERN_ERR
,

2957 #iâdeà
CONFIG_QUOTA


2958 ià(
	`ext4_has_ã©u»_quÙa
(
sb
è&& !
»adÚly
) {

2959 
	`ext4_msg
(
sb
, 
KERN_ERR
,

2964 ià(
	`ext4_has_ã©u»_´ojeù
(
sb
è&& !
»adÚly
) {

2965 
	`ext4_msg
(
sb
, 
KERN_ERR
,

2972 
	}
}

2978 
	$´št_day_”rÜ_šfo
(
tim”_li¡
 *
t
)

2980 
ext4_sb_šfo
 *
sbi
 = 
	`äom_tim”
(sbi, 
t
, 
s_”r_»pÜt
);

2981 
su³r_block
 *
sb
 = 
sbi
->
s_sb
;

2982 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

2984 ià(
es
->
s_”rÜ_couÁ
)

2986 
	`ext4_msg
(
sb
, 
KERN_NOTICE
, "error count since†ast fsck: %u",

2987 
	`Ë32_to_ıu
(
es
->
s_”rÜ_couÁ
));

2988 ià(
es
->
s_fœ¡_”rÜ_time
) {

2989 
	`´štk
(
KERN_NOTICE
 "EXT4-fs (%s): initialƒrror‡time %llu: %.*s:%d",

2990 
sb
->
s_id
,

2991 
	`ext4_g‘_t¡amp
(
es
, 
s_fœ¡_”rÜ_time
),

2992 (è(
es
->
s_fœ¡_”rÜ_func
),

2993 
es
->
s_fœ¡_”rÜ_func
,

2994 
	`Ë32_to_ıu
(
es
->
s_fœ¡_”rÜ_lše
));

2995 ià(
es
->
s_fœ¡_”rÜ_šo
)

2996 
	`´štk
(
KERN_CONT
 ": inode %u",

2997 
	`Ë32_to_ıu
(
es
->
s_fœ¡_”rÜ_šo
));

2998 ià(
es
->
s_fœ¡_”rÜ_block
)

2999 
	`´štk
(
KERN_CONT
 ": block %llu", ()

3000 
	`Ë64_to_ıu
(
es
->
s_fœ¡_”rÜ_block
));

3001 
	`´štk
(
KERN_CONT
 "\n");

3003 ià(
es
->
s_Ï¡_”rÜ_time
) {

3004 
	`´štk
(
KERN_NOTICE
 "EXT4-fs (%s):†astƒrror‡time %llu: %.*s:%d",

3005 
sb
->
s_id
,

3006 
	`ext4_g‘_t¡amp
(
es
, 
s_Ï¡_”rÜ_time
),

3007 (è(
es
->
s_Ï¡_”rÜ_func
),

3008 
es
->
s_Ï¡_”rÜ_func
,

3009 
	`Ë32_to_ıu
(
es
->
s_Ï¡_”rÜ_lše
));

3010 ià(
es
->
s_Ï¡_”rÜ_šo
)

3011 
	`´štk
(
KERN_CONT
 ": inode %u",

3012 
	`Ë32_to_ıu
(
es
->
s_Ï¡_”rÜ_šo
));

3013 ià(
es
->
s_Ï¡_”rÜ_block
)

3014 
	`´štk
(
KERN_CONT
 ": block %llu", ()

3015 
	`Ë64_to_ıu
(
es
->
s_Ï¡_”rÜ_block
));

3016 
	`´štk
(
KERN_CONT
 "\n");

3018 
	`mod_tim”
(&
sbi
->
s_”r_»pÜt
, 
jiff›s
 + 24*60*60*
HZ
);

3019 
	}
}

3022 
	$ext4_run_li_»que¡
(
ext4_li_»que¡
 *
–r
)

3024 
ext4_group_desc
 *
gdp
 = 
NULL
;

3025 
ext4_group_t
 
group
, 
ngroups
;

3026 
su³r_block
 *
sb
;

3027 
timeout
 = 0;

3028 
»t
 = 0;

3030 
sb
 = 
–r
->
Ì_su³r
;

3031 
ngroups
 = 
	`EXT4_SB
(
sb
)->
s_groups_couÁ
;

3033 
group
 = 
–r
->
Ì_Ãxt_group
; grou°< 
ngroups
; group++) {

3034 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
group
, 
NULL
);

3035 ià(!
gdp
) {

3036 
»t
 = 1;

3040 ià(!(
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_INODE_ZEROED
)))

3044 ià(
group
 >ğ
ngroups
)

3045 
»t
 = 1;

3047 ià(!
»t
) {

3048 
timeout
 = 
jiff›s
;

3049 
»t
 = 
	`ext4_š™_šode_bË
(
sb
, 
group
,

3050 
–r
->
Ì_timeout
 ? 0 : 1);

3051 ià(
–r
->
Ì_timeout
 == 0) {

3052 
timeout
 = (
jiff›s
 -imeout) *

3053 
–r
->
Ì_sbi
->
s_li_wa™_muÉ
;

3054 
–r
->
Ì_timeout
 = 
timeout
;

3056 
–r
->
Ì_Ãxt_sched
 = 
jiff›s
 +ƒÌ->
Ì_timeout
;

3057 
–r
->
Ì_Ãxt_group
 = 
group
 + 1;

3059  
»t
;

3060 
	}
}

3066 
	$ext4_»move_li_»que¡
(
ext4_li_»que¡
 *
–r
)

3068 
ext4_sb_šfo
 *
sbi
;

3070 ià(!
–r
)

3073 
sbi
 = 
–r
->
Ì_sbi
;

3075 
	`li¡_d–
(&
–r
->
Ì_»que¡
);

3076 
sbi
->
s_li_»que¡
 = 
NULL
;

3077 
	`kä“
(
–r
);

3078 
	}
}

3080 
	$ext4_uÄegi¡”_li_»que¡
(
su³r_block
 *
sb
)

3082 
	`mu‹x_lock
(&
ext4_li_mtx
);

3083 ià(!
ext4_li_šfo
) {

3084 
	`mu‹x_uÆock
(&
ext4_li_mtx
);

3088 
	`mu‹x_lock
(&
ext4_li_šfo
->
li_li¡_mtx
);

3089 
	`ext4_»move_li_»que¡
(
	`EXT4_SB
(
sb
)->
s_li_»que¡
);

3090 
	`mu‹x_uÆock
(&
ext4_li_šfo
->
li_li¡_mtx
);

3091 
	`mu‹x_uÆock
(&
ext4_li_mtx
);

3092 
	}
}

3094 
sk_¡ruù
 *
	gext4_Ïzyš™_sk
;

3105 
	$ext4_Ïzyš™_th»ad
(*
¬g
)

3107 
ext4_Ïzy_š™
 *
–i
 = (ext4_Ïzy_š™ *)
¬g
;

3108 
li¡_h—d
 *
pos
, *
n
;

3109 
ext4_li_»que¡
 *
–r
;

3110 
Ãxt_wakeup
, 
cur
;

3112 
	`BUG_ON
(
NULL
 =ğ
–i
);

3114 
cÚt_th»ad
:

3115 
Œue
) {

3116 
Ãxt_wakeup
 = 
MAX_JIFFY_OFFSET
;

3118 
	`mu‹x_lock
(&
–i
->
li_li¡_mtx
);

3119 ià(
	`li¡_em±y
(&
–i
->
li_»que¡_li¡
)) {

3120 
	`mu‹x_uÆock
(&
–i
->
li_li¡_mtx
);

3121 
ex™_th»ad
;

3123 
	`li¡_fÜ_—ch_§ã
(
pos
, 
n
, &
–i
->
li_»que¡_li¡
) {

3124 
”r
 = 0;

3125 
´og»ss
 = 0;

3126 
–r
 = 
	`li¡_’Œy
(
pos
, 
ext4_li_»que¡
,

3127 
Ì_»que¡
);

3129 ià(
	`time_befÜe
(
jiff›s
, 
–r
->
Ì_Ãxt_sched
)) {

3130 ià(
	`time_befÜe
(
–r
->
Ì_Ãxt_sched
, 
Ãxt_wakeup
))

3131 
Ãxt_wakeup
 = 
–r
->
Ì_Ãxt_sched
;

3134 ià(
	`down_»ad_Œylock
(&
–r
->
Ì_su³r
->
s_umouÁ
)) {

3135 ià(
	`sb_¡¬t_wr™e_Œylock
(
–r
->
Ì_su³r
)) {

3136 
´og»ss
 = 1;

3142 
	`mu‹x_uÆock
(&
–i
->
li_li¡_mtx
);

3143 
”r
 = 
	`ext4_run_li_»que¡
(
–r
);

3144 
	`sb_’d_wr™e
(
–r
->
Ì_su³r
);

3145 
	`mu‹x_lock
(&
–i
->
li_li¡_mtx
);

3146 
n
 = 
pos
->
Ãxt
;

3148 
	`up_»ad
((&
–r
->
Ì_su³r
->
s_umouÁ
));

3151 ià(
”r
) {

3152 
	`ext4_»move_li_»que¡
(
–r
);

3155 ià(!
´og»ss
) {

3156 
–r
->
Ì_Ãxt_sched
 = 
jiff›s
 +

3157 (
	`´ªdom_u32
()

3158 % (
EXT4_DEF_LI_MAX_START_DELAY
 * 
HZ
));

3160 ià(
	`time_befÜe
(
–r
->
Ì_Ãxt_sched
, 
Ãxt_wakeup
))

3161 
Ãxt_wakeup
 = 
–r
->
Ì_Ãxt_sched
;

3163 
	`mu‹x_uÆock
(&
–i
->
li_li¡_mtx
);

3165 
	`Œy_to_ä“ze
();

3167 
cur
 = 
jiff›s
;

3168 ià((
	`time_aá”_eq
(
cur
, 
Ãxt_wakeup
)) ||

3169 (
MAX_JIFFY_OFFSET
 =ğ
Ãxt_wakeup
)) {

3170 
	`cÚd_»sched
();

3174 
	`scheduË_timeout_š‹¼u±ibË
(
Ãxt_wakeup
 - 
cur
);

3176 ià(
	`kth»ad_should_¡İ
()) {

3177 
	`ext4_ş—r_»que¡_li¡
();

3178 
ex™_th»ad
;

3182 
ex™_th»ad
:

3191 
	`mu‹x_lock
(&
ext4_li_mtx
);

3192 
	`mu‹x_lock
(&
–i
->
li_li¡_mtx
);

3193 ià(!
	`li¡_em±y
(&
–i
->
li_»que¡_li¡
)) {

3194 
	`mu‹x_uÆock
(&
–i
->
li_li¡_mtx
);

3195 
	`mu‹x_uÆock
(&
ext4_li_mtx
);

3196 
cÚt_th»ad
;

3198 
	`mu‹x_uÆock
(&
–i
->
li_li¡_mtx
);

3199 
	`kä“
(
ext4_li_šfo
);

3200 
ext4_li_šfo
 = 
NULL
;

3201 
	`mu‹x_uÆock
(&
ext4_li_mtx
);

3204 
	}
}

3206 
	$ext4_ş—r_»que¡_li¡
()

3208 
li¡_h—d
 *
pos
, *
n
;

3209 
ext4_li_»que¡
 *
–r
;

3211 
	`mu‹x_lock
(&
ext4_li_šfo
->
li_li¡_mtx
);

3212 
	`li¡_fÜ_—ch_§ã
(
pos
, 
n
, &
ext4_li_šfo
->
li_»que¡_li¡
) {

3213 
–r
 = 
	`li¡_’Œy
(
pos
, 
ext4_li_»que¡
,

3214 
Ì_»que¡
);

3215 
	`ext4_»move_li_»que¡
(
–r
);

3217 
	`mu‹x_uÆock
(&
ext4_li_šfo
->
li_li¡_mtx
);

3218 
	}
}

3220 
	$ext4_run_Ïzyš™_th»ad
()

3222 
ext4_Ïzyš™_sk
 = 
	`kth»ad_run
(
ext4_Ïzyš™_th»ad
,

3223 
ext4_li_šfo
, "ext4lazyinit");

3224 ià(
	`IS_ERR
(
ext4_Ïzyš™_sk
)) {

3225 
”r
 = 
	`PTR_ERR
(
ext4_Ïzyš™_sk
);

3226 
	`ext4_ş—r_»que¡_li¡
();

3227 
	`kä“
(
ext4_li_šfo
);

3228 
ext4_li_šfo
 = 
NULL
;

3229 
	`´štk
(
KERN_CRIT
 "EXT4-fs:ƒrror %d creating inodeable "

3231 
”r
);

3232  
”r
;

3234 
ext4_li_šfo
->
li_¡©e
 |ğ
EXT4_LAZYINIT_RUNNING
;

3236 
	}
}

3244 
ext4_group_t
 
	$ext4_has_unš™_™abË
(
su³r_block
 *
sb
)

3246 
ext4_group_t
 
group
, 
ngroups
 = 
	`EXT4_SB
(
sb
)->
s_groups_couÁ
;

3247 
ext4_group_desc
 *
gdp
 = 
NULL
;

3249 ià(!
	`ext4_has_group_desc_csum
(
sb
))

3250  
ngroups
;

3252 
group
 = 0; grou°< 
ngroups
; group++) {

3253 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
group
, 
NULL
);

3254 ià(!
gdp
)

3257 ià(!(
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_INODE_ZEROED
)))

3261  
group
;

3262 
	}
}

3264 
	$ext4_li_šfo_Ãw
()

3266 
ext4_Ïzy_š™
 *
–i
 = 
NULL
;

3268 
–i
 = 
	`kz®loc
((*–i), 
GFP_KERNEL
);

3269 ià(!
–i
)

3270  -
ENOMEM
;

3272 
	`INIT_LIST_HEAD
(&
–i
->
li_»que¡_li¡
);

3273 
	`mu‹x_š™
(&
–i
->
li_li¡_mtx
);

3275 
–i
->
li_¡©e
 |ğ
EXT4_LAZYINIT_QUIT
;

3277 
ext4_li_šfo
 = 
–i
;

3280 
	}
}

3282 
ext4_li_»que¡
 *
	$ext4_li_»que¡_Ãw
(
su³r_block
 *
sb
,

3283 
ext4_group_t
 
¡¬t
)

3285 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3286 
ext4_li_»que¡
 *
–r
;

3288 
–r
 = 
	`kz®loc
((*–r), 
GFP_KERNEL
);

3289 ià(!
–r
)

3290  
NULL
;

3292 
–r
->
Ì_su³r
 = 
sb
;

3293 
–r
->
Ì_sbi
 = 
sbi
;

3294 
–r
->
Ì_Ãxt_group
 = 
¡¬t
;

3301 
–r
->
Ì_Ãxt_sched
 = 
jiff›s
 + (
	`´ªdom_u32
() %

3302 (
EXT4_DEF_LI_MAX_START_DELAY
 * 
HZ
));

3303  
–r
;

3304 
	}
}

3306 
	$ext4_»gi¡”_li_»que¡
(
su³r_block
 *
sb
,

3307 
ext4_group_t
 
fœ¡_nÙ_z”Ûd
)

3309 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3310 
ext4_li_»que¡
 *
–r
 = 
NULL
;

3311 
ext4_group_t
 
ngroups
 = 
sbi
->
s_groups_couÁ
;

3312 
»t
 = 0;

3314 
	`mu‹x_lock
(&
ext4_li_mtx
);

3315 ià(
sbi
->
s_li_»que¡
 !ğ
NULL
) {

3320 
sbi
->
s_li_»que¡
->
Ì_timeout
 = 0;

3321 
out
;

3324 ià(
fœ¡_nÙ_z”Ûd
 =ğ
ngroups
 || 
	`sb_rdÚly
(
sb
) ||

3325 !
	`‹¡_İt
(
sb
, 
INIT_INODE_TABLE
))

3326 
out
;

3328 
–r
 = 
	`ext4_li_»que¡_Ãw
(
sb
, 
fœ¡_nÙ_z”Ûd
);

3329 ià(!
–r
) {

3330 
»t
 = -
ENOMEM
;

3331 
out
;

3334 ià(
NULL
 =ğ
ext4_li_šfo
) {

3335 
»t
 = 
	`ext4_li_šfo_Ãw
();

3336 ià(
»t
)

3337 
out
;

3340 
	`mu‹x_lock
(&
ext4_li_šfo
->
li_li¡_mtx
);

3341 
	`li¡_add
(&
–r
->
Ì_»que¡
, &
ext4_li_šfo
->
li_»que¡_li¡
);

3342 
	`mu‹x_uÆock
(&
ext4_li_šfo
->
li_li¡_mtx
);

3344 
sbi
->
s_li_»que¡
 = 
–r
;

3350 
–r
 = 
NULL
;

3352 ià(!(
ext4_li_šfo
->
li_¡©e
 & 
EXT4_LAZYINIT_RUNNING
)) {

3353 
»t
 = 
	`ext4_run_Ïzyš™_th»ad
();

3354 ià(
»t
)

3355 
out
;

3357 
out
:

3358 
	`mu‹x_uÆock
(&
ext4_li_mtx
);

3359 ià(
»t
)

3360 
	`kä“
(
–r
);

3361  
»t
;

3362 
	}
}

3368 
	$ext4_de¡roy_Ïzyš™_th»ad
()

3374 ià(!
ext4_li_šfo
 || !
ext4_Ïzyš™_sk
)

3377 
	`kth»ad_¡İ
(
ext4_Ïzyš™_sk
);

3378 
	}
}

3380 
	$£t_jouº®_csum_ã©u»_£t
(
su³r_block
 *
sb
)

3382 
»t
 = 1;

3383 
com·t
, 
šcom·t
;

3384 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3386 ià(
	`ext4_has_m‘ad©a_csum
(
sb
)) {

3388 
com·t
 = 0;

3389 
šcom·t
 = 
JBD2_FEATURE_INCOMPAT_CSUM_V3
;

3392 
com·t
 = 
JBD2_FEATURE_COMPAT_CHECKSUM
;

3393 
šcom·t
 = 0;

3396 
	`jbd2_jouº®_ş—r_ã©u»s
(
sbi
->
s_jouº®
,

3397 
JBD2_FEATURE_COMPAT_CHECKSUM
, 0,

3398 
JBD2_FEATURE_INCOMPAT_CSUM_V3
 |

3399 
JBD2_FEATURE_INCOMPAT_CSUM_V2
);

3400 ià(
	`‹¡_İt
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

3401 
»t
 = 
	`jbd2_jouº®_£t_ã©u»s
(
sbi
->
s_jouº®
,

3402 
com·t
, 0,

3403 
JBD2_FEATURE_INCOMPAT_ASYNC_COMMIT
 |

3404 
šcom·t
);

3405 } ià(
	`‹¡_İt
(
sb
, 
JOURNAL_CHECKSUM
)) {

3406 
»t
 = 
	`jbd2_jouº®_£t_ã©u»s
(
sbi
->
s_jouº®
,

3407 
com·t
, 0,

3408 
šcom·t
);

3409 
	`jbd2_jouº®_ş—r_ã©u»s
(
sbi
->
s_jouº®
, 0, 0,

3410 
JBD2_FEATURE_INCOMPAT_ASYNC_COMMIT
);

3412 
	`jbd2_jouº®_ş—r_ã©u»s
(
sbi
->
s_jouº®
, 0, 0,

3413 
JBD2_FEATURE_INCOMPAT_ASYNC_COMMIT
);

3416  
»t
;

3417 
	}
}

3434 
	$couÁ_ov”h—d
(
su³r_block
 *
sb
, 
ext4_group_t
 
g½
,

3435 *
buf
)

3437 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3438 
ext4_group_desc
 *
gdp
;

3439 
ext4_fsblk_t
 
fœ¡_block
, 
Ï¡_block
, 
b
;

3440 
ext4_group_t
 
i
, 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

3441 
s
, 
j
, 
couÁ
 = 0;

3443 ià(!
	`ext4_has_ã©u»_big®loc
(
sb
))

3444  (
	`ext4_bg_has_su³r
(
sb
, 
g½
è+ 
	`ext4_bg_num_gdb
(sb, grp) +

3445 
sbi
->
s_™b_³r_group
 + 2);

3447 
fœ¡_block
 = 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_d©a_block
) +

3448 (
g½
 * 
	`EXT4_BLOCKS_PER_GROUP
(
sb
));

3449 
Ï¡_block
 = 
fœ¡_block
 + 
	`EXT4_BLOCKS_PER_GROUP
(
sb
) - 1;

3450 
i
 = 0; i < 
ngroups
; i++) {

3451 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

3452 
b
 = 
	`ext4_block_b™m­
(
sb
, 
gdp
);

3453 ià(
b
 >ğ
fœ¡_block
 && b <ğ
Ï¡_block
) {

3454 
	`ext4_£t_b™
(
	`EXT4_B2C
(
sbi
, 
b
 - 
fœ¡_block
), 
buf
);

3455 
couÁ
++;

3457 
b
 = 
	`ext4_šode_b™m­
(
sb
, 
gdp
);

3458 ià(
b
 >ğ
fœ¡_block
 && b <ğ
Ï¡_block
) {

3459 
	`ext4_£t_b™
(
	`EXT4_B2C
(
sbi
, 
b
 - 
fœ¡_block
), 
buf
);

3460 
couÁ
++;

3462 
b
 = 
	`ext4_šode_bË
(
sb
, 
gdp
);

3463 ià(
b
 >ğ
fœ¡_block
 && b + 
sbi
->
s_™b_³r_group
 <ğ
Ï¡_block
)

3464 
j
 = 0; j < 
sbi
->
s_™b_³r_group
; j++, 
b
++) {

3465 
c
 = 
	`EXT4_B2C
(
sbi
, 
b
 - 
fœ¡_block
);

3466 
	`ext4_£t_b™
(
c
, 
buf
);

3467 
couÁ
++;

3469 ià(
i
 !ğ
g½
)

3471 
s
 = 0;

3472 ià(
	`ext4_bg_has_su³r
(
sb
, 
g½
)) {

3473 
	`ext4_£t_b™
(
s
++, 
buf
);

3474 
couÁ
++;

3476 
j
 = 
	`ext4_bg_num_gdb
(
sb
, 
g½
);

3477 ià(
s
 + 
j
 > 
	`EXT4_BLOCKS_PER_GROUP
(
sb
)) {

3478 
	`ext4_”rÜ
(
sb
, "Invalid‚umber of block group "

3479 "desütÜ blocks: %d", 
j
);

3480 
j
 = 
	`EXT4_BLOCKS_PER_GROUP
(
sb
è- 
s
;

3482 
couÁ
 +ğ
j
;

3483 ; 
j
 > 0; j--)

3484 
	`ext4_£t_b™
(
	`EXT4_B2C
(
sbi
, 
s
++), 
buf
);

3486 ià(!
couÁ
)

3488  
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) -

3489 
	`ext4_couÁ_ä“
(
buf
, 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) / 8);

3490 
	}
}

3495 
	$ext4_ÿlcuÏ‹_ov”h—d
(
su³r_block
 *
sb
)

3497 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3498 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

3499 
šode
 *
j_šode
;

3500 
j_blocks
, 
j_šum
 = 
	`Ë32_to_ıu
(
es
->
s_jouº®_šum
);

3501 
ext4_group_t
 
i
, 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

3502 
ext4_fsblk_t
 
ov”h—d
 = 0;

3503 *
buf
 = (*è
	`g‘_z”Ûd_·ge
(
GFP_NOFS
);

3505 ià(!
buf
)

3506  -
ENOMEM
;

3517 
ov”h—d
 = 
	`EXT4_B2C
(
sbi
, 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
));

3522 
i
 = 0; i < 
ngroups
; i++) {

3523 
blks
;

3525 
blks
 = 
	`couÁ_ov”h—d
(
sb
, 
i
, 
buf
);

3526 
ov”h—d
 +ğ
blks
;

3527 ià(
blks
)

3528 
	`mem£t
(
buf
, 0, 
PAGE_SIZE
);

3529 
	`cÚd_»sched
();

3536 ià(
sbi
->
s_jouº®
 && !sbi->
jouº®_bdev
)

3537 
ov”h—d
 +ğ
	`EXT4_NUM_B2C
(
sbi
, sbi->
s_jouº®
->
j_maxËn
);

3538 ià(
	`ext4_has_ã©u»_jouº®
(
sb
è&& !
sbi
->
s_jouº®
) {

3539 
j_šode
 = 
	`ext4_g‘_jouº®_šode
(
sb
, 
j_šum
);

3540 ià(
j_šode
) {

3541 
j_blocks
 = 
j_šode
->
i_size
 >> 
sb
->
s_blocksize_b™s
;

3542 
ov”h—d
 +ğ
	`EXT4_NUM_B2C
(
sbi
, 
j_blocks
);

3543 
	`ut
(
j_šode
);

3545 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't get journal size");

3548 
sbi
->
s_ov”h—d
 = 
ov”h—d
;

3549 
	`smp_wmb
();

3550 
	`ä“_·ge
((è
buf
);

3552 
	}
}

3554 
	$ext4_şamp_wªt_exŒa_isize
(
su³r_block
 *
sb
)

3556 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3557 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

3560 ià(
sbi
->
s_šode_size
 > 
EXT4_GOOD_OLD_INODE_SIZE
 &&

3561 
sbi
->
s_wªt_exŒa_isize
 == 0) {

3562 
sbi
->
s_wªt_exŒa_isize
 = (
ext4_šode
) -

3563 
EXT4_GOOD_OLD_INODE_SIZE
;

3564 ià(
	`ext4_has_ã©u»_exŒa_isize
(
sb
)) {

3565 ià(
sbi
->
s_wªt_exŒa_isize
 <

3566 
	`Ë16_to_ıu
(
es
->
s_wªt_exŒa_isize
))

3567 
sbi
->
s_wªt_exŒa_isize
 =

3568 
	`Ë16_to_ıu
(
es
->
s_wªt_exŒa_isize
);

3569 ià(
sbi
->
s_wªt_exŒa_isize
 <

3570 
	`Ë16_to_ıu
(
es
->
s_mš_exŒa_isize
))

3571 
sbi
->
s_wªt_exŒa_isize
 =

3572 
	`Ë16_to_ıu
(
es
->
s_mš_exŒa_isize
);

3576 ià(
EXT4_GOOD_OLD_INODE_SIZE
 + 
sbi
->
s_wªt_exŒa_isize
 >

3577 
sbi
->
s_šode_size
) {

3578 
sbi
->
s_wªt_exŒa_isize
 = (
ext4_šode
) -

3579 
EXT4_GOOD_OLD_INODE_SIZE
;

3580 
	`ext4_msg
(
sb
, 
KERN_INFO
,

3583 
	}
}

3585 
	$ext4_£t_»sv_şu¡”s
(
su³r_block
 *
sb
)

3587 
ext4_fsblk_t
 
»sv_şu¡”s
;

3588 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3596 ià(!
	`ext4_has_ã©u»_ex‹Ás
(
sb
))

3606 
»sv_şu¡”s
 = (
	`ext4_blocks_couÁ
(
sbi
->
s_es
) >>

3607 
sbi
->
s_şu¡”_b™s
);

3609 
	`do_div
(
»sv_şu¡”s
, 50);

3610 
»sv_şu¡”s
 = 
	`mš_t
(
ext4_fsblk_t
,„esv_clusters, 4096);

3612 
	`©omic64_£t
(&
sbi
->
s_»sv_şu¡”s
, 
»sv_şu¡”s
);

3613 
	}
}

3615 
	$ext4_fl_su³r
(
su³r_block
 *
sb
, *
d©a
, 
s’t
)

3617 
dax_deviû
 *
dax_dev
 = 
	`fs_dax_g‘_by_bdev
(
sb
->
s_bdev
);

3618 *
Üig_d©a
 = 
	`k¡rdup
(
d©a
, 
GFP_KERNEL
);

3619 
bufãr_h—d
 *
bh
;

3620 
ext4_su³r_block
 *
es
 = 
NULL
;

3621 
ext4_sb_šfo
 *
sbi
 = 
	`kz®loc
((*sbi), 
GFP_KERNEL
);

3622 
ext4_fsblk_t
 
block
;

3623 
ext4_fsblk_t
 
sb_block
 = 
	`g‘_sb_block
(&
d©a
);

3624 
ext4_fsblk_t
 
logiÿl_sb_block
;

3625 
off£t
 = 0;

3626 
jouº®_devnum
 = 0;

3627 
def_mouÁ_İts
;

3628 
šode
 *
roÙ
;

3629 cÚ¡ *
desü
;

3630 
»t
 = -
ENOMEM
;

3631 
blocksize
, 
şu¡”size
;

3632 
db_couÁ
;

3633 
i
;

3634 
Ãeds_»cov”y
, 
has_huge_fes
, 
has_big®loc
;

3635 
__u64
 
blocks_couÁ
;

3636 
”r
 = 0;

3637 
jouº®_iİrio
 = 
DEFAULT_JOURNAL_IOPRIO
;

3638 
ext4_group_t
 
fœ¡_nÙ_z”Ûd
;

3640 ià((
d©a
 && !
Üig_d©a
è|| !
sbi
)

3641 
out_ä“_ba£
;

3643 
sbi
->
s_daxdev
 = 
dax_dev
;

3644 
sbi
->
s_blockgroup_lock
 =

3645 
	`kz®loc
((
blockgroup_lock
), 
GFP_KERNEL
);

3646 ià(!
sbi
->
s_blockgroup_lock
)

3647 
out_ä“_ba£
;

3649 
sb
->
s_fs_šfo
 = 
sbi
;

3650 
sbi
->
s_sb
 = 
sb
;

3651 
sbi
->
s_šode_»adah—d_blks
 = 
EXT4_DEF_INODE_READAHEAD_BLKS
;

3652 
sbi
->
s_sb_block
 = 
sb_block
;

3653 ià(
sb
->
s_bdev
->
bd_·¹
)

3654 
sbi
->
s_£ùÜs_wr™‹n_¡¬t
 =

3655 
	`·¹_¡©_»ad
(
sb
->
s_bdev
->
bd_·¹
, 
£ùÜs
[
STAT_WRITE
]);

3658 
	`¡¼•Ïû
(
sb
->
s_id
, '/', '!');

3661 
»t
 = -
EINVAL
;

3662 
blocksize
 = 
	`sb_mš_blocksize
(
sb
, 
EXT4_MIN_BLOCK_SIZE
);

3663 ià(!
blocksize
) {

3664 
	`ext4_msg
(
sb
, 
KERN_ERR
, "unableo set blocksize");

3665 
out_ç
;

3672 ià(
blocksize
 !ğ
EXT4_MIN_BLOCK_SIZE
) {

3673 
logiÿl_sb_block
 = 
sb_block
 * 
EXT4_MIN_BLOCK_SIZE
;

3674 
off£t
 = 
	`do_div
(
logiÿl_sb_block
, 
blocksize
);

3676 
logiÿl_sb_block
 = 
sb_block
;

3679 ià(!(
bh
 = 
	`sb_b»ad_unmovabË
(
sb
, 
logiÿl_sb_block
))) {

3680 
	`ext4_msg
(
sb
, 
KERN_ERR
, "unableo„ead superblock");

3681 
out_ç
;

3687 
es
 = (
ext4_su³r_block
 *è(
bh
->
b_d©a
 + 
off£t
);

3688 
sbi
->
s_es
 = 
es
;

3689 
sb
->
s_magic
 = 
	`Ë16_to_ıu
(
es
->s_magic);

3690 ià(
sb
->
s_magic
 !ğ
EXT4_SUPER_MAGIC
)

3691 
ÿÁfšd_ext4
;

3692 
sbi
->
s_kby‹s_wr™‹n
 = 
	`Ë64_to_ıu
(
es
->s_kbytes_written);

3695 ià(
	`ext4_has_ã©u»_m‘ad©a_csum
(
sb
) &&

3696 
	`ext4_has_ã©u»_gdt_csum
(
sb
))

3697 
	`ext4_w¬nšg
(
sb
, "metadata_csum‡nd uninit_bg‡re "

3701 ià(!
	`ext4_v”ify_csum_ty³
(
sb
, 
es
)) {

3702 
	`ext4_msg
(
sb
, 
KERN_ERR
, "VFS: Foundƒxt4 filesystem with "

3704 
s’t
 = 1;

3705 
ÿÁfšd_ext4
;

3709 
sbi
->
s_chksum_driv”
 = 
	`üy±o_®loc_shash
("crc32c", 0, 0);

3710 ià(
	`IS_ERR
(
sbi
->
s_chksum_driv”
)) {

3711 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Cannot†oad crc32c driver.");

3712 
»t
 = 
	`PTR_ERR
(
sbi
->
s_chksum_driv”
);

3713 
sbi
->
s_chksum_driv”
 = 
NULL
;

3714 
çed_mouÁ
;

3718 ià(!
	`ext4_su³rblock_csum_v”ify
(
sb
, 
es
)) {

3719 
	`ext4_msg
(
sb
, 
KERN_ERR
, "VFS: Foundƒxt4 filesystem with "

3721 
s’t
 = 1;

3722 
»t
 = -
EFSBADCRC
;

3723 
ÿÁfšd_ext4
;

3727 ià(
	`ext4_has_ã©u»_csum_£ed
(
sb
))

3728 
sbi
->
s_csum_£ed
 = 
	`Ë32_to_ıu
(
es
->
s_checksum_£ed
);

3729 ià(
	`ext4_has_m‘ad©a_csum
(
sb
è|| 
	`ext4_has_ã©u»_—_šode
(sb))

3730 
sbi
->
s_csum_£ed
 = 
	`ext4_chksum
(sbi, ~0, 
es
->
s_uuid
,

3731 (
es
->
s_uuid
));

3734 
def_mouÁ_İts
 = 
	`Ë32_to_ıu
(
es
->
s_deçuÉ_mouÁ_İts
);

3735 
	`£t_İt
(
sb
, 
INIT_INODE_TABLE
);

3736 ià(
def_mouÁ_İts
 & 
EXT4_DEFM_DEBUG
)

3737 
	`£t_İt
(
sb
, 
DEBUG
);

3738 ià(
def_mouÁ_İts
 & 
EXT4_DEFM_BSDGROUPS
)

3739 
	`£t_İt
(
sb
, 
GRPID
);

3740 ià(
def_mouÁ_İts
 & 
EXT4_DEFM_UID16
)

3741 
	`£t_İt
(
sb
, 
NO_UID32
);

3743 
	`£t_İt
(
sb
, 
XATTR_USER
);

3744 #ifdeà
CONFIG_EXT4_FS_POSIX_ACL


3745 
	`£t_İt
(
sb
, 
POSIX_ACL
);

3748 ià(
	`ext4_has_m‘ad©a_csum
(
sb
))

3749 
	`£t_İt
(
sb
, 
JOURNAL_CHECKSUM
);

3751 ià((
def_mouÁ_İts
 & 
EXT4_DEFM_JMODE
è=ğ
EXT4_DEFM_JMODE_DATA
)

3752 
	`£t_İt
(
sb
, 
JOURNAL_DATA
);

3753 ià((
def_mouÁ_İts
 & 
EXT4_DEFM_JMODE
è=ğ
EXT4_DEFM_JMODE_ORDERED
)

3754 
	`£t_İt
(
sb
, 
ORDERED_DATA
);

3755 ià((
def_mouÁ_İts
 & 
EXT4_DEFM_JMODE
è=ğ
EXT4_DEFM_JMODE_WBACK
)

3756 
	`£t_İt
(
sb
, 
WRITEBACK_DATA
);

3758 ià(
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_”rÜs
è=ğ
EXT4_ERRORS_PANIC
)

3759 
	`£t_İt
(
sb
, 
ERRORS_PANIC
);

3760 ià(
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_”rÜs
è=ğ
EXT4_ERRORS_CONTINUE
)

3761 
	`£t_İt
(
sb
, 
ERRORS_CONT
);

3763 
	`£t_İt
(
sb
, 
ERRORS_RO
);

3765 
	`£t_İt
(
sb
, 
BLOCK_VALIDITY
);

3766 ià(
def_mouÁ_İts
 & 
EXT4_DEFM_DISCARD
)

3767 
	`£t_İt
(
sb
, 
DISCARD
);

3769 
sbi
->
s_»suid
 = 
	`make_kuid
(&
š™_u£r_ns
, 
	`Ë16_to_ıu
(
es
->
s_def_»suid
));

3770 
sbi
->
s_»sgid
 = 
	`make_kgid
(&
š™_u£r_ns
, 
	`Ë16_to_ıu
(
es
->
s_def_»sgid
));

3771 
sbi
->
s_comm™_š‹rv®
 = 
JBD2_DEFAULT_MAX_COMMIT_AGE
 * 
HZ
;

3772 
sbi
->
s_mš_b©ch_time
 = 
EXT4_DEF_MIN_BATCH_TIME
;

3773 
sbi
->
s_max_b©ch_time
 = 
EXT4_DEF_MAX_BATCH_TIME
;

3775 ià((
def_mouÁ_İts
 & 
EXT4_DEFM_NOBARRIER
) == 0)

3776 
	`£t_İt
(
sb
, 
BARRIER
);

3782 ià(!
	`IS_EXT3_SB
(
sb
è&& !
	`IS_EXT2_SB
(sb) &&

3783 ((
def_mouÁ_İts
 & 
EXT4_DEFM_NODELALLOC
) == 0))

3784 
	`£t_İt
(
sb
, 
DELALLOC
);

3790 
sbi
->
s_li_wa™_muÉ
 = 
EXT4_DEF_LI_WAIT_MULT
;

3792 ià(
sbi
->
s_es
->
s_mouÁ_İts
[0]) {

3793 *
s_mouÁ_İts
 = 
	`k¡ºdup
(
sbi
->
s_es
->s_mount_opts,

3794 (
sbi
->
s_es
->
s_mouÁ_İts
),

3795 
GFP_KERNEL
);

3796 ià(!
s_mouÁ_İts
)

3797 
çed_mouÁ
;

3798 ià(!
	`·r£_İtiÚs
(
s_mouÁ_İts
, 
sb
, &
jouº®_devnum
,

3799 &
jouº®_iİrio
, 0)) {

3800 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

3802 
s_mouÁ_İts
);

3804 
	`kä“
(
s_mouÁ_İts
);

3806 
sbi
->
s_def_mouÁ_İt
 = sbi->
s_mouÁ_İt
;

3807 ià(!
	`·r£_İtiÚs
((*è
d©a
, 
sb
, &
jouº®_devnum
,

3808 &
jouº®_iİrio
, 0))

3809 
çed_mouÁ
;

3811 #ifdeà
CONFIG_UNICODE


3812 ià(
	`ext4_has_ã©u»_ÿ£fŞd
(
sb
è&& !
sbi
->
s_’codšg
) {

3813 cÚ¡ 
ext4_sb_’codšgs
 *
’codšg_šfo
;

3814 
unicode_m­
 *
’codšg
;

3815 
__u16
 
’codšg_æags
;

3817 ià(
	`ext4_has_ã©u»_’üy±
(
sb
)) {

3818 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3820 
çed_mouÁ
;

3823 ià(
	`ext4_sb_»ad_’codšg
(
es
, &
’codšg_šfo
,

3824 &
’codšg_æags
)) {

3825 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3827 
çed_mouÁ
;

3830 
’codšg
 = 
	`utf8_lßd
(
’codšg_šfo
->
v”siÚ
);

3831 ià(
	`IS_ERR
(
’codšg
)) {

3832 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3835 
’codšg_šfo
->
Çme
,ƒncodšg_šfo->
v”siÚ
,

3836 
’codšg_æags
);

3837 
çed_mouÁ
;

3839 
	`ext4_msg
(
sb
, 
KERN_INFO
,"Usingƒncoding defined by superblock: "

3840 "%s-% w™h fÏg 0x%hx", 
’codšg_šfo
->
Çme
,

3841 
’codšg_šfo
->
v”siÚ
?:"\b", 
’codšg_æags
);

3843 
sbi
->
s_’codšg
 = 
’codšg
;

3844 
sbi
->
s_’codšg_æags
 = 
’codšg_æags
;

3848 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_JOURNAL_DATA
) {

3849 
	`´štk_Úû
(
KERN_WARNING
 "EXT4-fs: Warning: mounting "

3852 ià(
	`‹¡_İt2
(
sb
, 
EXPLICIT_DELALLOC
)) {

3853 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3855 
çed_mouÁ
;

3857 ià(
	`‹¡_İt
(
sb
, 
DIOREAD_NOLOCK
)) {

3858 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3860 
çed_mouÁ
;

3862 ià(
	`‹¡_İt
(
sb
, 
DAX
)) {

3863 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3865 
çed_mouÁ
;

3867 ià(
	`ext4_has_ã©u»_’üy±
(
sb
)) {

3868 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

3872 ià(
	`‹¡_İt
(
sb
, 
DELALLOC
))

3873 
	`ş—r_İt
(
sb
, 
DELALLOC
);

3875 
sb
->
s_iæags
 |ğ
SB_I_CGROUPWB
;

3878 
sb
->
s_æags
 = (sb->s_æag & ~
SB_POSIXACL
) |

3879 (
	`‹¡_İt
(
sb
, 
POSIX_ACL
è? 
SB_POSIXACL
 : 0);

3881 ià(
	`Ë32_to_ıu
(
es
->
s_»v_Ëv–
è=ğ
EXT4_GOOD_OLD_REV
 &&

3882 (
	`ext4_has_com·t_ã©u»s
(
sb
) ||

3883 
	`ext4_has_ro_com·t_ã©u»s
(
sb
) ||

3884 
	`ext4_has_šcom·t_ã©u»s
(
sb
)))

3885 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

3889 ià(
es
->
s_ü—tÜ_os
 =ğ
	`ıu_to_Ë32
(
EXT4_OS_HURD
)) {

3890 
	`£t_İt2
(
sb
, 
HURD_COMPAT
);

3891 ià(
	`ext4_has_ã©u»_64b™
(
sb
)) {

3892 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3894 
çed_mouÁ
;

3901 ià(
	`ext4_has_ã©u»_—_šode
(
sb
)) {

3902 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3904 
çed_mouÁ
;

3908 ià(
	`IS_EXT2_SB
(
sb
)) {

3909 ià(
	`ext2_ã©u»_£t_ok
(
sb
))

3910 
	`ext4_msg
(
sb
, 
KERN_INFO
, "mountingƒxt2 file system "

3917 ià(
s’t
 && 
	`ext4_ã©u»_£t_ok
(
sb
, 
	`sb_rdÚly
(sb)))

3918 
çed_mouÁ
;

3919 
	`ext4_msg
(
sb
, 
KERN_ERR
, "couldn't mount‡sƒxt2 due "

3921 
çed_mouÁ
;

3925 ià(
	`IS_EXT3_SB
(
sb
)) {

3926 ià(
	`ext3_ã©u»_£t_ok
(
sb
))

3927 
	`ext4_msg
(
sb
, 
KERN_INFO
, "mountingƒxt3 file system "

3934 ià(
s’t
 && 
	`ext4_ã©u»_£t_ok
(
sb
, 
	`sb_rdÚly
(sb)))

3935 
çed_mouÁ
;

3936 
	`ext4_msg
(
sb
, 
KERN_ERR
, "couldn't mount‡sƒxt3 due "

3938 
çed_mouÁ
;

3947 ià(!
	`ext4_ã©u»_£t_ok
(
sb
, (
	`sb_rdÚly
(sb))))

3948 
çed_mouÁ
;

3950 
blocksize
 = 
BLOCK_SIZE
 << 
	`Ë32_to_ıu
(
es
->
s_log_block_size
);

3951 ià(
blocksize
 < 
EXT4_MIN_BLOCK_SIZE
 ||

3952 
blocksize
 > 
EXT4_MAX_BLOCK_SIZE
) {

3953 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3955 
blocksize
, 
	`Ë32_to_ıu
(
es
->
s_log_block_size
));

3956 
çed_mouÁ
;

3958 ià(
	`Ë32_to_ıu
(
es
->
s_log_block_size
) >

3959 (
EXT4_MAX_BLOCK_LOG_SIZE
 - 
EXT4_MIN_BLOCK_LOG_SIZE
)) {

3960 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3962 
	`Ë32_to_ıu
(
es
->
s_log_block_size
));

3963 
çed_mouÁ
;

3965 ià(
	`Ë32_to_ıu
(
es
->
s_log_şu¡”_size
) >

3966 (
EXT4_MAX_CLUSTER_LOG_SIZE
 - 
EXT4_MIN_BLOCK_LOG_SIZE
)) {

3967 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3969 
	`Ë32_to_ıu
(
es
->
s_log_şu¡”_size
));

3970 
çed_mouÁ
;

3973 ià(
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_»£rved_gdt_blocks
è> (
blocksize
 / 4)) {

3974 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3976 
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_»£rved_gdt_blocks
));

3977 
çed_mouÁ
;

3980 ià(
sbi
->
s_mouÁ_İt
 & 
EXT4_MOUNT_DAX
) {

3981 ià(
	`ext4_has_ã©u»_šlše_d©a
(
sb
)) {

3982 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Cannot use DAX on‡ filesystem"

3984 
çed_mouÁ
;

3986 ià(!
	`bdev_dax_suµÜ‹d
(
sb
->
s_bdev
, 
blocksize
)) {

3987 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3989 
çed_mouÁ
;

3993 ià(
	`ext4_has_ã©u»_’üy±
(
sb
è&& 
es
->
s_’üy±iÚ_Ëv–
) {

3994 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Unsupportedƒncryption†evel %d",

3995 
es
->
s_’üy±iÚ_Ëv–
);

3996 
çed_mouÁ
;

3999 ià(
sb
->
s_blocksize
 !ğ
blocksize
) {

4001 ià(!
	`sb_£t_blocksize
(
sb
, 
blocksize
)) {

4002 
	`ext4_msg
(
sb
, 
KERN_ERR
, "bad block size %d",

4003 
blocksize
);

4004 
çed_mouÁ
;

4007 
	`b»l£
(
bh
);

4008 
logiÿl_sb_block
 = 
sb_block
 * 
EXT4_MIN_BLOCK_SIZE
;

4009 
off£t
 = 
	`do_div
(
logiÿl_sb_block
, 
blocksize
);

4010 
bh
 = 
	`sb_b»ad_unmovabË
(
sb
, 
logiÿl_sb_block
);

4011 ià(!
bh
) {

4012 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4014 
çed_mouÁ
;

4016 
es
 = (
ext4_su³r_block
 *)(
bh
->
b_d©a
 + 
off£t
);

4017 
sbi
->
s_es
 = 
es
;

4018 ià(
es
->
s_magic
 !ğ
	`ıu_to_Ë16
(
EXT4_SUPER_MAGIC
)) {

4019 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4021 
çed_mouÁ
;

4025 
has_huge_fes
 = 
	`ext4_has_ã©u»_huge_fe
(
sb
);

4026 
sbi
->
s_b™m­_maxby‹s
 = 
	`ext4_max_b™m­_size
(
sb
->
s_blocksize_b™s
,

4027 
has_huge_fes
);

4028 
sb
->
s_maxby‹s
 = 
	`ext4_max_size
(sb->
s_blocksize_b™s
, 
has_huge_fes
);

4030 ià(
	`Ë32_to_ıu
(
es
->
s_»v_Ëv–
è=ğ
EXT4_GOOD_OLD_REV
) {

4031 
sbi
->
s_šode_size
 = 
EXT4_GOOD_OLD_INODE_SIZE
;

4032 
sbi
->
s_fœ¡_šo
 = 
EXT4_GOOD_OLD_FIRST_INO
;

4034 
sbi
->
s_šode_size
 = 
	`Ë16_to_ıu
(
es
->s_inode_size);

4035 
sbi
->
s_fœ¡_šo
 = 
	`Ë32_to_ıu
(
es
->s_first_ino);

4036 ià(
sbi
->
s_fœ¡_šo
 < 
EXT4_GOOD_OLD_FIRST_INO
) {

4037 
	`ext4_msg
(
sb
, 
KERN_ERR
, "invalid first ino: %u",

4038 
sbi
->
s_fœ¡_šo
);

4039 
çed_mouÁ
;

4041 ià((
sbi
->
s_šode_size
 < 
EXT4_GOOD_OLD_INODE_SIZE
) ||

4042 (!
	`is_pow”_of_2
(
sbi
->
s_šode_size
)) ||

4043 (
sbi
->
s_šode_size
 > 
blocksize
)) {

4044 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4046 
sbi
->
s_šode_size
);

4047 
çed_mouÁ
;

4054 ià(
sbi
->
s_šode_size
 >ğ
	`off£tof
(
ext4_šode
, 
i_©ime_exŒa
) +

4055 (((
ext4_šode
 *)0)->
i_©ime_exŒa
)) {

4056 
sb
->
s_time_g¿n
 = 1;

4057 
sb
->
s_time_max
 = 
EXT4_EXTRA_TIMESTAMP_MAX
;

4059 
sb
->
s_time_g¿n
 = 
NSEC_PER_SEC
;

4060 
sb
->
s_time_max
 = 
EXT4_NON_EXTRA_TIMESTAMP_MAX
;

4063 
sb
->
s_time_mš
 = 
EXT4_TIMESTAMP_MIN
;

4066 
sbi
->
s_desc_size
 = 
	`Ë16_to_ıu
(
es
->s_desc_size);

4067 ià(
	`ext4_has_ã©u»_64b™
(
sb
)) {

4068 ià(
sbi
->
s_desc_size
 < 
EXT4_MIN_DESC_SIZE_64BIT
 ||

4069 
sbi
->
s_desc_size
 > 
EXT4_MAX_DESC_SIZE
 ||

4070 !
	`is_pow”_of_2
(
sbi
->
s_desc_size
)) {

4071 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4073 
sbi
->
s_desc_size
);

4074 
çed_mouÁ
;

4077 
sbi
->
s_desc_size
 = 
EXT4_MIN_DESC_SIZE
;

4079 
sbi
->
s_blocks_³r_group
 = 
	`Ë32_to_ıu
(
es
->s_blocks_per_group);

4080 
sbi
->
s_šodes_³r_group
 = 
	`Ë32_to_ıu
(
es
->s_inodes_per_group);

4082 
sbi
->
s_šodes_³r_block
 = 
blocksize
 / 
	`EXT4_INODE_SIZE
(
sb
);

4083 ià(
sbi
->
s_šodes_³r_block
 == 0)

4084 
ÿÁfšd_ext4
;

4085 ià(
sbi
->
s_šodes_³r_group
 < sbi->
s_šodes_³r_block
 ||

4086 
sbi
->
s_šodes_³r_group
 > 
blocksize
 * 8) {

4087 
	`ext4_msg
(
sb
, 
KERN_ERR
, "invalid inodes…er group: %lu\n",

4088 
sbi
->
s_blocks_³r_group
);

4089 
çed_mouÁ
;

4091 
sbi
->
s_™b_³r_group
 = sbi->
s_šodes_³r_group
 /

4092 
sbi
->
s_šodes_³r_block
;

4093 
sbi
->
s_desc_³r_block
 = 
blocksize
 / 
	`EXT4_DESC_SIZE
(
sb
);

4094 
sbi
->
s_sbh
 = 
bh
;

4095 
sbi
->
s_mouÁ_¡©e
 = 
	`Ë16_to_ıu
(
es
->
s_¡©e
);

4096 
sbi
->
s_addr_³r_block_b™s
 = 
	`og2
(
	`EXT4_ADDR_PER_BLOCK
(
sb
));

4097 
sbi
->
s_desc_³r_block_b™s
 = 
	`og2
(
	`EXT4_DESC_PER_BLOCK
(
sb
));

4099 
i
 = 0; i < 4; i++)

4100 
sbi
->
s_hash_£ed
[
i
] = 
	`Ë32_to_ıu
(
es
->s_hash_seed[i]);

4101 
sbi
->
s_def_hash_v”siÚ
 = 
es
->s_def_hash_version;

4102 ià(
	`ext4_has_ã©u»_dœ_šdex
(
sb
)) {

4103 
i
 = 
	`Ë32_to_ıu
(
es
->
s_æags
);

4104 ià(
i
 & 
EXT2_FLAGS_UNSIGNED_HASH
)

4105 
sbi
->
s_hash_unsigÃd
 = 3;

4106 ià((
i
 & 
EXT2_FLAGS_SIGNED_HASH
) == 0) {

4107 #ifdeà
__CHAR_UNSIGNED__


4108 ià(!
	`sb_rdÚly
(
sb
))

4109 
es
->
s_æags
 |=

4110 
	`ıu_to_Ë32
(
EXT2_FLAGS_UNSIGNED_HASH
);

4111 
sbi
->
s_hash_unsigÃd
 = 3;

4113 ià(!
	`sb_rdÚly
(
sb
))

4114 
es
->
s_æags
 |=

4115 
	`ıu_to_Ë32
(
EXT2_FLAGS_SIGNED_HASH
);

4121 
şu¡”size
 = 
BLOCK_SIZE
 << 
	`Ë32_to_ıu
(
es
->
s_log_şu¡”_size
);

4122 
has_big®loc
 = 
	`ext4_has_ã©u»_big®loc
(
sb
);

4123 ià(
has_big®loc
) {

4124 ià(
şu¡”size
 < 
blocksize
) {

4125 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4127 "block siz(%d)", 
şu¡”size
, 
blocksize
);

4128 
çed_mouÁ
;

4130 
sbi
->
s_şu¡”_b™s
 = 
	`Ë32_to_ıu
(
es
->
s_log_şu¡”_size
) -

4131 
	`Ë32_to_ıu
(
es
->
s_log_block_size
);

4132 
sbi
->
s_şu¡”s_³r_group
 =

4133 
	`Ë32_to_ıu
(
es
->
s_şu¡”s_³r_group
);

4134 ià(
sbi
->
s_şu¡”s_³r_group
 > 
blocksize
 * 8) {

4135 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4137 
sbi
->
s_şu¡”s_³r_group
);

4138 
çed_mouÁ
;

4140 ià(
sbi
->
s_blocks_³r_group
 !=

4141 (
sbi
->
s_şu¡”s_³r_group
 * (
şu¡”size
 / 
blocksize
))) {

4142 
	`ext4_msg
(
sb
, 
KERN_ERR
, "blocks…er group (%lu)‡nd "

4144 
sbi
->
s_blocks_³r_group
,

4145 
sbi
->
s_şu¡”s_³r_group
);

4146 
çed_mouÁ
;

4149 ià(
şu¡”size
 !ğ
blocksize
) {

4150 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4152 "block siz(%d)", 
şu¡”size
, 
blocksize
);

4153 
çed_mouÁ
;

4155 ià(
sbi
->
s_blocks_³r_group
 > 
blocksize
 * 8) {

4156 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4158 
sbi
->
s_blocks_³r_group
);

4159 
çed_mouÁ
;

4161 
sbi
->
s_şu¡”s_³r_group
 = sbi->
s_blocks_³r_group
;

4162 
sbi
->
s_şu¡”_b™s
 = 0;

4164 
sbi
->
s_şu¡”_¿tio
 = 
şu¡”size
 / 
blocksize
;

4167 ià(
sbi
->
s_blocks_³r_group
 =ğ
şu¡”size
 << 3)

4168 
	`£t_İt2
(
sb
, 
STD_GROUP_SIZE
);

4174 
”r
 = 
	`g’”ic_check_add»s§bË
(
sb
->
s_blocksize_b™s
,

4175 
	`ext4_blocks_couÁ
(
es
));

4176 ià(
”r
) {

4177 
	`ext4_msg
(
sb
, 
KERN_ERR
, "filesystem"

4179 
çed_mouÁ
;

4182 ià(
	`EXT4_BLOCKS_PER_GROUP
(
sb
) == 0)

4183 
ÿÁfšd_ext4
;

4186 
blocks_couÁ
 = 
sb
->
s_bdev
->
bd_šode
->
i_size
 >> sb->
s_blocksize_b™s
;

4187 ià(
blocks_couÁ
 && 
	`ext4_blocks_couÁ
(
es
) > blocks_count) {

4188 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: block count %llu "

4190 
	`ext4_blocks_couÁ
(
es
), 
blocks_couÁ
);

4191 
çed_mouÁ
;

4198 ià(
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
è>ğ
	`ext4_blocks_couÁ
(es)) {

4199 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: first data "

4201 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
),

4202 
	`ext4_blocks_couÁ
(
es
));

4203 
çed_mouÁ
;

4205 ià((
es
->
s_fœ¡_d©a_block
 =ğ0è&& (es->
s_log_block_size
 == 0) &&

4206 (
sbi
->
s_şu¡”_¿tio
 == 1)) {

4207 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: first data "

4209 
çed_mouÁ
;

4212 
blocks_couÁ
 = (
	`ext4_blocks_couÁ
(
es
) -

4213 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
) +

4214 
	`EXT4_BLOCKS_PER_GROUP
(
sb
) - 1);

4215 
	`do_div
(
blocks_couÁ
, 
	`EXT4_BLOCKS_PER_GROUP
(
sb
));

4216 ià(
blocks_couÁ
 > ((
ušt64_t
)1<<32è- 
	`EXT4_DESC_PER_BLOCK
(
sb
)) {

4217 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "groups countoo†arge: %u "

4219 "block ³¸grou°%lu)", 
sbi
->
s_groups_couÁ
,

4220 
	`ext4_blocks_couÁ
(
es
),

4221 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
),

4222 
	`EXT4_BLOCKS_PER_GROUP
(
sb
));

4223 
çed_mouÁ
;

4225 
sbi
->
s_groups_couÁ
 = 
blocks_couÁ
;

4226 
sbi
->
s_blockfe_groups
 = 
	`mš_t
(
ext4_group_t
, sbi->
s_groups_couÁ
,

4227 (
EXT4_MAX_BLOCK_FILE_PHYS
 / 
	`EXT4_BLOCKS_PER_GROUP
(
sb
)));

4228 ià(((
u64
)
sbi
->
s_groups_couÁ
 * sbi->
s_šodes_³r_group
) !=

4229 
	`Ë32_to_ıu
(
es
->
s_šodes_couÁ
)) {

4230 
	`ext4_msg
(
sb
, 
KERN_ERR
, "inodes count‚ot valid: %u vs %llu",

4231 
	`Ë32_to_ıu
(
es
->
s_šodes_couÁ
),

4232 ((
u64
)
sbi
->
s_groups_couÁ
 * sbi->
s_šodes_³r_group
));

4233 
»t
 = -
EINVAL
;

4234 
çed_mouÁ
;

4236 
db_couÁ
 = (
sbi
->
s_groups_couÁ
 + 
	`EXT4_DESC_PER_BLOCK
(
sb
) - 1) /

4237 
	`EXT4_DESC_PER_BLOCK
(
sb
);

4238 ià(
	`ext4_has_ã©u»_m‘a_bg
(
sb
)) {

4239 ià(
	`Ë32_to_ıu
(
es
->
s_fœ¡_m‘a_bg
è> 
db_couÁ
) {

4240 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

4243 
	`Ë32_to_ıu
(
es
->
s_fœ¡_m‘a_bg
), 
db_couÁ
);

4244 
çed_mouÁ
;

4247 
sbi
->
s_group_desc
 = 
	`kvm®loc_¬¿y
(
db_couÁ
,

4248 (
bufãr_h—d
 *),

4249 
GFP_KERNEL
);

4250 ià(
sbi
->
s_group_desc
 =ğ
NULL
) {

4251 
	`ext4_msg
(
sb
, 
KERN_ERR
, "notƒnough memory");

4252 
»t
 = -
ENOMEM
;

4253 
çed_mouÁ
;

4256 
	`bgl_lock_š™
(
sbi
->
s_blockgroup_lock
);

4259 
i
 = 0; i < 
db_couÁ
; i++) {

4260 
block
 = 
	`desütÜ_loc
(
sb
, 
logiÿl_sb_block
, 
i
);

4261 
	`sb_b»adah—d
(
sb
, 
block
);

4264 
i
 = 0; i < 
db_couÁ
; i++) {

4265 
block
 = 
	`desütÜ_loc
(
sb
, 
logiÿl_sb_block
, 
i
);

4266 
sbi
->
s_group_desc
[
i
] = 
	`sb_b»ad_unmovabË
(
sb
, 
block
);

4267 ià(!
sbi
->
s_group_desc
[
i
]) {

4268 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4269 "ÿn'ˆ»ad grou°desütÜ %d", 
i
);

4270 
db_couÁ
 = 
i
;

4271 
çed_mouÁ2
;

4274 
sbi
->
s_gdb_couÁ
 = 
db_couÁ
;

4275 ià(!
	`ext4_check_desütÜs
(
sb
, 
logiÿl_sb_block
, &
fœ¡_nÙ_z”Ûd
)) {

4276 
	`ext4_msg
(
sb
, 
KERN_ERR
, "group descriptors corrupted!");

4277 
»t
 = -
EFSCORRUPTED
;

4278 
çed_mouÁ2
;

4281 
	`tim”_£tup
(&
sbi
->
s_”r_»pÜt
, 
´št_day_”rÜ_šfo
, 0);

4284 ià(
	`ext4_es_»gi¡”_shršk”
(
sbi
))

4285 
çed_mouÁ3
;

4287 
sbi
->
s_¡re
 = 
	`ext4_g‘_¡re_size
(sbi);

4288 
sbi
->
s_ex‹Á_max_z”oout_kb
 = 32;

4293 
sb
->
s_İ
 = &
ext4_sİs
;

4294 
sb
->
s_expÜt_İ
 = &
ext4_expÜt_İs
;

4295 
sb
->
s_x©Œ
 = 
ext4_x©Œ_hªdËrs
;

4296 #ifdeà
CONFIG_FS_ENCRYPTION


4297 
sb
->
s_cİ
 = &
ext4_üy±İs
;

4299 #ifdeà
CONFIG_FS_VERITY


4300 
sb
->
s_vİ
 = &
ext4_v”™yİs
;

4302 #ifdeà
CONFIG_QUOTA


4303 
sb
->
dq_İ
 = &
ext4_quÙa_İ”©iÚs
;

4304 ià(
	`ext4_has_ã©u»_quÙa
(
sb
))

4305 
sb
->
s_qcİ
 = &
dquÙ_quÙaùl_sysfe_İs
;

4307 
sb
->
s_qcİ
 = &
ext4_qùl_İ”©iÚs
;

4308 
sb
->
s_quÙa_ty³s
 = 
QTYPE_MASK_USR
 | 
QTYPE_MASK_GRP
 | 
QTYPE_MASK_PRJ
;

4310 
	`memıy
(&
sb
->
s_uuid
, 
es
->s_uuid, (es->s_uuid));

4312 
	`INIT_LIST_HEAD
(&
sbi
->
s_Üphª
);

4313 
	`mu‹x_š™
(&
sbi
->
s_Üphª_lock
);

4315 
sb
->
s_roÙ
 = 
NULL
;

4317 
Ãeds_»cov”y
 = (
es
->
s_Ï¡_Üphª
 != 0 ||

4318 
	`ext4_has_ã©u»_jouº®_Ãeds_»cov”y
(
sb
));

4320 ià(
	`ext4_has_ã©u»_mmp
(
sb
è&& !
	`sb_rdÚly
(sb))

4321 ià(
	`ext4_muÉi_mouÁ_´Ùeù
(
sb
, 
	`Ë64_to_ıu
(
es
->
s_mmp_block
)))

4322 
çed_mouÁ3a
;

4328 ià(!
	`‹¡_İt
(
sb
, 
NOLOAD
è&& 
	`ext4_has_ã©u»_jouº®
(sb)) {

4329 
”r
 = 
	`ext4_lßd_jouº®
(
sb
, 
es
, 
jouº®_devnum
);

4330 ià(
”r
)

4331 
çed_mouÁ3a
;

4332 } ià(
	`‹¡_İt
(
sb
, 
NOLOAD
è&& !
	`sb_rdÚly
(sb) &&

4333 
	`ext4_has_ã©u»_jouº®_Ãeds_»cov”y
(
sb
)) {

4334 
	`ext4_msg
(
sb
, 
KERN_ERR
, "required journal„ecovery "

4336 
çed_mouÁ_wq
;

4339 ià(
	`‹¡_İt2
(
sb
, 
EXPLICIT_JOURNAL_CHECKSUM
)) {

4340 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4342 
çed_mouÁ_wq
;

4344 ià(
	`‹¡_İt
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

4345 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4347 
çed_mouÁ_wq
;

4349 ià(
sbi
->
s_comm™_š‹rv®
 !ğ
JBD2_DEFAULT_MAX_COMMIT_AGE
*
HZ
) {

4350 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4352 
sbi
->
s_comm™_š‹rv®
 / 
HZ
);

4353 
çed_mouÁ_wq
;

4355 ià(
EXT4_MOUNT_DATA_FLAGS
 &

4356 (
sbi
->
s_mouÁ_İt
 ^ sbi->
s_def_mouÁ_İt
)) {

4357 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4359 
çed_mouÁ_wq
;

4361 
sbi
->
s_def_mouÁ_İt
 &ğ~
EXT4_MOUNT_JOURNAL_CHECKSUM
;

4362 
	`ş—r_İt
(
sb
, 
JOURNAL_CHECKSUM
);

4363 
	`ş—r_İt
(
sb
, 
DATA_FLAGS
);

4364 
sbi
->
s_jouº®
 = 
NULL
;

4365 
Ãeds_»cov”y
 = 0;

4366 
no_jouº®
;

4369 ià(
	`ext4_has_ã©u»_64b™
(
sb
) &&

4370 !
	`jbd2_jouº®_£t_ã©u»s
(
	`EXT4_SB
(
sb
)->
s_jouº®
, 0, 0,

4371 
JBD2_FEATURE_INCOMPAT_64BIT
)) {

4372 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Failedo set 64-bit journal feature");

4373 
çed_mouÁ_wq
;

4376 ià(!
	`£t_jouº®_csum_ã©u»_£t
(
sb
)) {

4377 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Failedo set journal checksum "

4379 
çed_mouÁ_wq
;

4384 
	`‹¡_İt
(
sb
, 
DATA_FLAGS
)) {

4390 ià(
jbd2_jouº®_check_avaabË_ã©u»s


4391 (
sbi
->
s_jouº®
, 0, 0, 
JBD2_FEATURE_INCOMPAT_REVOKE
)) {

4392 
	`£t_İt
(
sb
, 
ORDERED_DATA
);

4393 
sbi
->
s_def_mouÁ_İt
 |ğ
EXT4_MOUNT_ORDERED_DATA
;

4395 
	`£t_İt
(
sb
, 
JOURNAL_DATA
);

4396 
sbi
->
s_def_mouÁ_İt
 |ğ
EXT4_MOUNT_JOURNAL_DATA
;

4400 
EXT4_MOUNT_ORDERED_DATA
:

4401 
EXT4_MOUNT_WRITEBACK_DATA
:

4402 ià(!
jbd2_jouº®_check_avaabË_ã©u»s


4403 (
sbi
->
s_jouº®
, 0, 0, 
JBD2_FEATURE_INCOMPAT_REVOKE
)) {

4404 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Journal does‚ot support "

4406 
çed_mouÁ_wq
;

4412 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_ORDERED_DATA
 &&

4413 
	`‹¡_İt
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

4414 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4416 
çed_mouÁ_wq
;

4419 
	`£t_sk_iİrio
(
sbi
->
s_jouº®
->
j_sk
, 
jouº®_iİrio
);

4421 
sbi
->
s_jouº®
->
j_comm™_ÿÎback
 = 
ext4_jouº®_comm™_ÿÎback
;

4423 
no_jouº®
:

4424 ià(!
	`‹¡_İt
(
sb
, 
NO_MBCACHE
)) {

4425 
sbi
->
s_—_block_ÿche
 = 
	`ext4_x©Œ_ü—‹_ÿche
();

4426 ià(!
sbi
->
s_—_block_ÿche
) {

4427 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4429 
çed_mouÁ_wq
;

4432 ià(
	`ext4_has_ã©u»_—_šode
(
sb
)) {

4433 
sbi
->
s_—_šode_ÿche
 = 
	`ext4_x©Œ_ü—‹_ÿche
();

4434 ià(!
sbi
->
s_—_šode_ÿche
) {

4435 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4437 
çed_mouÁ_wq
;

4442 ià((
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
è|| 
	`ext4_has_ã©u»_’üy±
(
sb
)) &&

4443 (
blocksize
 !ğ
PAGE_SIZE
)) {

4444 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4446 
çed_mouÁ_wq
;

4449 ià(
	`ext4_has_ã©u»_v”™y
(
sb
è&& 
blocksize
 !ğ
PAGE_SIZE
) {

4450 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Unsupported blocksize for fs-verity");

4451 
çed_mouÁ_wq
;

4454 ià(
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
è&& !
	`sb_rdÚly
(
sb
) &&

4455 !
	`ext4_has_ã©u»_’üy±
(
sb
)) {

4456 
	`ext4_£t_ã©u»_’üy±
(
sb
);

4457 
	`ext4_comm™_su³r
(
sb
, 1);

4464 ià(
es
->
s_ov”h—d_şu¡”s
)

4465 
sbi
->
s_ov”h—d
 = 
	`Ë32_to_ıu
(
es
->
s_ov”h—d_şu¡”s
);

4467 
”r
 = 
	`ext4_ÿlcuÏ‹_ov”h—d
(
sb
);

4468 ià(
”r
)

4469 
çed_mouÁ_wq
;

4476 
	`EXT4_SB
(
sb
)->
rsv_cÚv”siÚ_wq
 =

4477 
	`®loc_wÜkqueue
("ext4-rsv-cÚv”siÚ", 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 1);

4478 ià(!
	`EXT4_SB
(
sb
)->
rsv_cÚv”siÚ_wq
) {

4479 
	`´štk
(
KERN_ERR
 "EXT4-fs: failedo create workqueue\n");

4480 
»t
 = -
ENOMEM
;

4481 
çed_mouÁ4
;

4489 
roÙ
 = 
	`ext4_ig‘
(
sb
, 
EXT4_ROOT_INO
, 
EXT4_IGET_SPECIAL
);

4490 ià(
	`IS_ERR
(
roÙ
)) {

4491 
	`ext4_msg
(
sb
, 
KERN_ERR
, "get„oot inode failed");

4492 
»t
 = 
	`PTR_ERR
(
roÙ
);

4493 
roÙ
 = 
NULL
;

4494 
çed_mouÁ4
;

4496 ià(!
	`S_ISDIR
(
roÙ
->
i_mode
è|| !roÙ->
i_blocks
 || !roÙ->
i_size
) {

4497 
	`ext4_msg
(
sb
, 
KERN_ERR
, "corrupt„oot inode,„unƒ2fsck");

4498 
	`ut
(
roÙ
);

4499 
çed_mouÁ4
;

4502 #ifdeà
CONFIG_UNICODE


4503 ià(
sbi
->
s_’codšg
)

4504 
sb
->
s_d_İ
 = &
ext4_d’Œy_İs
;

4507 
sb
->
s_roÙ
 = 
	`d_make_roÙ
(
roÙ
);

4508 ià(!
sb
->
s_roÙ
) {

4509 
	`ext4_msg
(
sb
, 
KERN_ERR
, "get„oot dentry failed");

4510 
»t
 = -
ENOMEM
;

4511 
çed_mouÁ4
;

4514 
»t
 = 
	`ext4_£tup_su³r
(
sb
, 
es
, 
	`sb_rdÚly
(sb));

4515 ià(
»t
 =ğ-
EROFS
) {

4516 
sb
->
s_æags
 |ğ
SB_RDONLY
;

4517 
»t
 = 0;

4518 } ià(
»t
)

4519 
çed_mouÁ4a
;

4521 
	`ext4_şamp_wªt_exŒa_isize
(
sb
);

4523 
	`ext4_£t_»sv_şu¡”s
(
sb
);

4525 
”r
 = 
	`ext4_£tup_sy¡em_zÚe
(
sb
);

4526 ià(
”r
) {

4527 
	`ext4_msg
(
sb
, 
KERN_ERR
, "failedo initialize system "

4528 "zÚ(%d)", 
”r
);

4529 
çed_mouÁ4a
;

4532 
	`ext4_ext_š™
(
sb
);

4533 
”r
 = 
	`ext4_mb_š™
(
sb
);

4534 ià(
”r
) {

4535 
	`ext4_msg
(
sb
, 
KERN_ERR
, "failedo initialize mballoc (%d)",

4536 
”r
);

4537 
çed_mouÁ5
;

4540 
block
 = 
	`ext4_couÁ_ä“_şu¡”s
(
sb
);

4541 
	`ext4_ä“_blocks_couÁ_£t
(
sbi
->
s_es
,

4542 
	`EXT4_C2B
(
sbi
, 
block
));

4543 
	`ext4_su³rblock_csum_£t
(
sb
);

4544 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
s_ä“şu¡”s_couÁ”
, 
block
,

4545 
GFP_KERNEL
);

4546 ià(!
”r
) {

4547 
ä“i
 = 
	`ext4_couÁ_ä“_šodes
(
sb
);

4548 
sbi
->
s_es
->
s_ä“_šodes_couÁ
 = 
	`ıu_to_Ë32
(
ä“i
);

4549 
	`ext4_su³rblock_csum_£t
(
sb
);

4550 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
s_ä“šodes_couÁ”
, 
ä“i
,

4551 
GFP_KERNEL
);

4553 ià(!
”r
)

4554 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
s_dœs_couÁ”
,

4555 
	`ext4_couÁ_dœs
(
sb
), 
GFP_KERNEL
);

4556 ià(!
”r
)

4557 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
s_dœtyşu¡”s_couÁ”
, 0,

4558 
GFP_KERNEL
);

4559 ià(!
”r
)

4560 
”r
 = 
	`³rıu_š™_rw£m
(&
sbi
->
s_jouº®_æag_rw£m
);

4562 ià(
”r
) {

4563 
	`ext4_msg
(
sb
, 
KERN_ERR
, "insufficient memory");

4564 
çed_mouÁ6
;

4567 ià(
	`ext4_has_ã©u»_æex_bg
(
sb
))

4568 ià(!
	`ext4_fl_æex_šfo
(
sb
)) {

4569 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4572 
çed_mouÁ6
;

4575 
”r
 = 
	`ext4_»gi¡”_li_»que¡
(
sb
, 
fœ¡_nÙ_z”Ûd
);

4576 ià(
”r
)

4577 
çed_mouÁ6
;

4579 
”r
 = 
	`ext4_»gi¡”_sysfs
(
sb
);

4580 ià(
”r
)

4581 
çed_mouÁ7
;

4583 #ifdeà
CONFIG_QUOTA


4585 ià(
	`ext4_has_ã©u»_quÙa
(
sb
è&& !
	`sb_rdÚly
(sb)) {

4586 
”r
 = 
	`ext4_’abË_quÙas
(
sb
);

4587 ià(
”r
)

4588 
çed_mouÁ8
;

4592 
	`EXT4_SB
(
sb
)->
s_mouÁ_¡©e
 |ğ
EXT4_ORPHAN_FS
;

4593 
	`ext4_Üphª_ş—nup
(
sb
, 
es
);

4594 
	`EXT4_SB
(
sb
)->
s_mouÁ_¡©e
 &ğ~
EXT4_ORPHAN_FS
;

4595 ià(
Ãeds_»cov”y
) {

4596 
	`ext4_msg
(
sb
, 
KERN_INFO
, "recovery complete");

4597 
	`ext4_m¬k_»cov”y_com¶‘e
(
sb
, 
es
);

4599 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
) {

4600 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_JOURNAL_DATA
)

4601 
desü
 = " journalled data mode";

4602 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_ORDERED_DATA
)

4603 
desü
 = " ordered data mode";

4605 
desü
 = " writeback data mode";

4607 
desü
 = "out journal";

4609 ià(
	`‹¡_İt
(
sb
, 
DISCARD
)) {

4610 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
sb
->
s_bdev
);

4611 ià(!
	`blk_queue_disÿrd
(
q
))

4612 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

4617 ià(
	`___¿‹lim™
(&
ext4_mouÁ_msg_¿‹lim™
, "EXT4-fs mount"))

4618 
	`ext4_msg
(
sb
, 
KERN_INFO
, "mounted filesystem with%s. "

4619 "O±s: %.*s%s%s", 
desü
,

4620 (è(
sbi
->
s_es
->
s_mouÁ_İts
),

4621 
sbi
->
s_es
->
s_mouÁ_İts
,

4622 *
sbi
->
s_es
->
s_mouÁ_İts
 ? "; " : "", 
Üig_d©a
);

4624 ià(
es
->
s_”rÜ_couÁ
)

4625 
	`mod_tim”
(&
sbi
->
s_”r_»pÜt
, 
jiff›s
 + 300*
HZ
);

4628 
	`¿‹lim™_¡©e_š™
(&
sbi
->
s_”r_¿‹lim™_¡©e
, 5 * 
HZ
, 10);

4629 
	`¿‹lim™_¡©e_š™
(&
sbi
->
s_w¬nšg_¿‹lim™_¡©e
, 5 * 
HZ
, 10);

4630 
	`¿‹lim™_¡©e_š™
(&
sbi
->
s_msg_¿‹lim™_¡©e
, 5 * 
HZ
, 10);

4632 
	`kä“
(
Üig_d©a
);

4635 
ÿÁfšd_ext4
:

4636 ià(!
s’t
)

4637 
	`ext4_msg
(
sb
, 
KERN_ERR
, "VFS: Can't findƒxt4 filesystem");

4638 
çed_mouÁ
;

4640 #ifdeà
CONFIG_QUOTA


4641 
çed_mouÁ8
:

4642 
	`ext4_uÄegi¡”_sysfs
(
sb
);

4644 
çed_mouÁ7
:

4645 
	`ext4_uÄegi¡”_li_»que¡
(
sb
);

4646 
çed_mouÁ6
:

4647 
	`ext4_mb_»Ëa£
(
sb
);

4648 ià(
sbi
->
s_æex_groups
)

4649 
	`kvä“
(
sbi
->
s_æex_groups
);

4650 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_ä“şu¡”s_couÁ”
);

4651 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_ä“šodes_couÁ”
);

4652 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_dœs_couÁ”
);

4653 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_dœtyşu¡”s_couÁ”
);

4654 
	`³rıu_ä“_rw£m
(&
sbi
->
s_jouº®_æag_rw£m
);

4655 
çed_mouÁ5
:

4656 
	`ext4_ext_»Ëa£
(
sb
);

4657 
	`ext4_»Ëa£_sy¡em_zÚe
(
sb
);

4658 
çed_mouÁ4a
:

4659 
	`dput
(
sb
->
s_roÙ
);

4660 
sb
->
s_roÙ
 = 
NULL
;

4661 
çed_mouÁ4
:

4662 
	`ext4_msg
(
sb
, 
KERN_ERR
, "mount failed");

4663 ià(
	`EXT4_SB
(
sb
)->
rsv_cÚv”siÚ_wq
)

4664 
	`de¡roy_wÜkqueue
(
	`EXT4_SB
(
sb
)->
rsv_cÚv”siÚ_wq
);

4665 
çed_mouÁ_wq
:

4666 
	`ext4_x©Œ_de¡roy_ÿche
(
sbi
->
s_—_šode_ÿche
);

4667 
sbi
->
s_—_šode_ÿche
 = 
NULL
;

4669 
	`ext4_x©Œ_de¡roy_ÿche
(
sbi
->
s_—_block_ÿche
);

4670 
sbi
->
s_—_block_ÿche
 = 
NULL
;

4672 ià(
sbi
->
s_jouº®
) {

4673 
	`jbd2_jouº®_de¡roy
(
sbi
->
s_jouº®
);

4674 
sbi
->
s_jouº®
 = 
NULL
;

4676 
çed_mouÁ3a
:

4677 
	`ext4_es_uÄegi¡”_shršk”
(
sbi
);

4678 
çed_mouÁ3
:

4679 
	`d–_tim”_sync
(&
sbi
->
s_”r_»pÜt
);

4680 ià(
sbi
->
s_mmp_tsk
)

4681 
	`kth»ad_¡İ
(
sbi
->
s_mmp_tsk
);

4682 
çed_mouÁ2
:

4683 
i
 = 0; i < 
db_couÁ
; i++)

4684 
	`b»l£
(
sbi
->
s_group_desc
[
i
]);

4685 
	`kvä“
(
sbi
->
s_group_desc
);

4686 
çed_mouÁ
:

4687 ià(
sbi
->
s_chksum_driv”
)

4688 
	`üy±o_ä“_shash
(
sbi
->
s_chksum_driv”
);

4690 #ifdeà
CONFIG_UNICODE


4691 
	`utf8_uÆßd
(
sbi
->
s_’codšg
);

4694 #ifdeà
CONFIG_QUOTA


4695 
i
 = 0; i < 
EXT4_MAXQUOTAS
; i++)

4696 
	`kä“
(
	`g‘_qf_Çme
(
sb
, 
sbi
, 
i
));

4698 
	`ext4_blkdev_»move
(
sbi
);

4699 
	`b»l£
(
bh
);

4700 
out_ç
:

4701 
sb
->
s_fs_šfo
 = 
NULL
;

4702 
	`kä“
(
sbi
->
s_blockgroup_lock
);

4703 
out_ä“_ba£
:

4704 
	`kä“
(
sbi
);

4705 
	`kä“
(
Üig_d©a
);

4706 
	`fs_put_dax
(
dax_dev
);

4707  
”r
 ?ƒ¼ : 
»t
;

4708 
	}
}

4715 
	$ext4_š™_jouº®_·¿ms
(
su³r_block
 *
sb
, 
jouº®_t
 *
jouº®
)

4717 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

4719 
jouº®
->
j_comm™_š‹rv®
 = 
sbi
->
s_comm™_š‹rv®
;

4720 
jouº®
->
j_mš_b©ch_time
 = 
sbi
->
s_mš_b©ch_time
;

4721 
jouº®
->
j_max_b©ch_time
 = 
sbi
->
s_max_b©ch_time
;

4723 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

4724 ià(
	`‹¡_İt
(
sb
, 
BARRIER
))

4725 
jouº®
->
j_æags
 |ğ
JBD2_BARRIER
;

4727 
jouº®
->
j_æags
 &ğ~
JBD2_BARRIER
;

4728 ià(
	`‹¡_İt
(
sb
, 
DATA_ERR_ABORT
))

4729 
jouº®
->
j_æags
 |ğ
JBD2_ABORT_ON_SYNCDATA_ERR
;

4731 
jouº®
->
j_æags
 &ğ~
JBD2_ABORT_ON_SYNCDATA_ERR
;

4732 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

4733 
	}
}

4735 
šode
 *
	$ext4_g‘_jouº®_šode
(
su³r_block
 *
sb
,

4736 
jouº®_šum
)

4738 
šode
 *
jouº®_šode
;

4745 
jouº®_šode
 = 
	`ext4_ig‘
(
sb
, 
jouº®_šum
, 
EXT4_IGET_SPECIAL
);

4746 ià(
	`IS_ERR
(
jouº®_šode
)) {

4747 
	`ext4_msg
(
sb
, 
KERN_ERR
, "no journal found");

4748  
NULL
;

4750 ià(!
jouº®_šode
->
i_Æšk
) {

4751 
	`make_bad_šode
(
jouº®_šode
);

4752 
	`ut
(
jouº®_šode
);

4753 
	`ext4_msg
(
sb
, 
KERN_ERR
, "journal inode is deleted");

4754  
NULL
;

4757 
	`jbd_debug
(2, "Journal inode found‡t %p: %lld bytes\n",

4758 
jouº®_šode
, jouº®_šode->
i_size
);

4759 ià(!
	`S_ISREG
(
jouº®_šode
->
i_mode
)) {

4760 
	`ext4_msg
(
sb
, 
KERN_ERR
, "invalid journal inode");

4761 
	`ut
(
jouº®_šode
);

4762  
NULL
;

4764  
jouº®_šode
;

4765 
	}
}

4767 
jouº®_t
 *
	$ext4_g‘_jouº®
(
su³r_block
 *
sb
,

4768 
jouº®_šum
)

4770 
šode
 *
jouº®_šode
;

4771 
jouº®_t
 *
jouº®
;

4773 
	`BUG_ON
(!
	`ext4_has_ã©u»_jouº®
(
sb
));

4775 
jouº®_šode
 = 
	`ext4_g‘_jouº®_šode
(
sb
, 
jouº®_šum
);

4776 ià(!
jouº®_šode
)

4777  
NULL
;

4779 
jouº®
 = 
	`jbd2_jouº®_š™_šode
(
jouº®_šode
);

4780 ià(!
jouº®
) {

4781 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Could‚ot†oad journal inode");

4782 
	`ut
(
jouº®_šode
);

4783  
NULL
;

4785 
jouº®
->
j_´iv©e
 = 
sb
;

4786 
	`ext4_š™_jouº®_·¿ms
(
sb
, 
jouº®
);

4787  
jouº®
;

4788 
	}
}

4790 
jouº®_t
 *
	$ext4_g‘_dev_jouº®
(
su³r_block
 *
sb
,

4791 
dev_t
 
j_dev
)

4793 
bufãr_h—d
 *
bh
;

4794 
jouº®_t
 *
jouº®
;

4795 
ext4_fsblk_t
 
¡¬t
;

4796 
ext4_fsblk_t
 
Ën
;

4797 
hblock
, 
blocksize
;

4798 
ext4_fsblk_t
 
sb_block
;

4799 
off£t
;

4800 
ext4_su³r_block
 *
es
;

4801 
block_deviû
 *
bdev
;

4803 
	`BUG_ON
(!
	`ext4_has_ã©u»_jouº®
(
sb
));

4805 
bdev
 = 
	`ext4_blkdev_g‘
(
j_dev
, 
sb
);

4806 ià(
bdev
 =ğ
NULL
)

4807  
NULL
;

4809 
blocksize
 = 
sb
->
s_blocksize
;

4810 
hblock
 = 
	`bdev_logiÿl_block_size
(
bdev
);

4811 ià(
blocksize
 < 
hblock
) {

4812 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4814 
out_bdev
;

4817 
sb_block
 = 
EXT4_MIN_BLOCK_SIZE
 / 
blocksize
;

4818 
off£t
 = 
EXT4_MIN_BLOCK_SIZE
 % 
blocksize
;

4819 
	`£t_blocksize
(
bdev
, 
blocksize
);

4820 ià(!(
bh
 = 
	`__b»ad
(
bdev
, 
sb_block
, 
blocksize
))) {

4821 
	`ext4_msg
(
sb
, 
KERN_ERR
, "couldn't„ead superblock of "

4823 
out_bdev
;

4826 
es
 = (
ext4_su³r_block
 *è(
bh
->
b_d©a
 + 
off£t
);

4827 ià((
	`Ë16_to_ıu
(
es
->
s_magic
è!ğ
EXT4_SUPER_MAGIC
) ||

4828 !(
	`Ë32_to_ıu
(
es
->
s_ã©u»_šcom·t
) &

4829 
EXT4_FEATURE_INCOMPAT_JOURNAL_DEV
)) {

4830 
	`ext4_msg
(
sb
, 
KERN_ERR
, "external journal has "

4832 
	`b»l£
(
bh
);

4833 
out_bdev
;

4836 ià((
	`Ë32_to_ıu
(
es
->
s_ã©u»_ro_com·t
) &

4837 
EXT4_FEATURE_RO_COMPAT_METADATA_CSUM
) &&

4838 
es
->
s_checksum
 !ğ
	`ext4_su³rblock_csum
(
sb
,ƒs)) {

4839 
	`ext4_msg
(
sb
, 
KERN_ERR
, "external journal has "

4841 
	`b»l£
(
bh
);

4842 
out_bdev
;

4845 ià(
	`memcmp
(
	`EXT4_SB
(
sb
)->
s_es
->
s_jouº®_uuid
, 
es
->
s_uuid
, 16)) {

4846 
	`ext4_msg
(
sb
, 
KERN_ERR
, "journal UUID does‚ot match");

4847 
	`b»l£
(
bh
);

4848 
out_bdev
;

4851 
Ën
 = 
	`ext4_blocks_couÁ
(
es
);

4852 
¡¬t
 = 
sb_block
 + 1;

4853 
	`b»l£
(
bh
);

4855 
jouº®
 = 
	`jbd2_jouº®_š™_dev
(
bdev
, 
sb
->
s_bdev
,

4856 
¡¬t
, 
Ën
, 
blocksize
);

4857 ià(!
jouº®
) {

4858 
	`ext4_msg
(
sb
, 
KERN_ERR
, "failedo create device journal");

4859 
out_bdev
;

4861 
jouº®
->
j_´iv©e
 = 
sb
;

4862 
	`Î_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1, &
jouº®
->
j_sb_bufãr
);

4863 
	`wa™_Ú_bufãr
(
jouº®
->
j_sb_bufãr
);

4864 ià(!
	`bufãr_u±od©e
(
jouº®
->
j_sb_bufãr
)) {

4865 
	`ext4_msg
(
sb
, 
KERN_ERR
, "I/Oƒrror on journal device");

4866 
out_jouº®
;

4868 ià(
	`be32_to_ıu
(
jouº®
->
j_su³rblock
->
s_Ä_u£rs
) != 1) {

4869 
	`ext4_msg
(
sb
, 
KERN_ERR
, "External journal has morehan one "

4871 
	`be32_to_ıu
(
jouº®
->
j_su³rblock
->
s_Ä_u£rs
));

4872 
out_jouº®
;

4874 
	`EXT4_SB
(
sb
)->
jouº®_bdev
 = 
bdev
;

4875 
	`ext4_š™_jouº®_·¿ms
(
sb
, 
jouº®
);

4876  
jouº®
;

4878 
out_jouº®
:

4879 
	`jbd2_jouº®_de¡roy
(
jouº®
);

4880 
out_bdev
:

4881 
	`ext4_blkdev_put
(
bdev
);

4882  
NULL
;

4883 
	}
}

4885 
	$ext4_lßd_jouº®
(
su³r_block
 *
sb
,

4886 
ext4_su³r_block
 *
es
,

4887 
jouº®_devnum
)

4889 
jouº®_t
 *
jouº®
;

4890 
jouº®_šum
 = 
	`Ë32_to_ıu
(
es
->
s_jouº®_šum
);

4891 
dev_t
 
jouº®_dev
;

4892 
”r
 = 0;

4893 
»®ly_»ad_Úly
;

4895 
	`BUG_ON
(!
	`ext4_has_ã©u»_jouº®
(
sb
));

4897 ià(
jouº®_devnum
 &&

4898 
jouº®_devnum
 !ğ
	`Ë32_to_ıu
(
es
->
s_jouº®_dev
)) {

4899 
	`ext4_msg
(
sb
, 
KERN_INFO
, "external journal device major/minor "

4901 
jouº®_dev
 = 
	`Ãw_decode_dev
(
jouº®_devnum
);

4903 
jouº®_dev
 = 
	`Ãw_decode_dev
(
	`Ë32_to_ıu
(
es
->
s_jouº®_dev
));

4905 
»®ly_»ad_Úly
 = 
	`bdev_»ad_Úly
(
sb
->
s_bdev
);

4912 ià(
	`ext4_has_ã©u»_jouº®_Ãeds_»cov”y
(
sb
)) {

4913 ià(
	`sb_rdÚly
(
sb
)) {

4914 
	`ext4_msg
(
sb
, 
KERN_INFO
, "INFO:„ecovery "

4916 ià(
»®ly_»ad_Úly
) {

4917 
	`ext4_msg
(
sb
, 
KERN_ERR
, "write‡ccess "

4920  -
EROFS
;

4922 
	`ext4_msg
(
sb
, 
KERN_INFO
, "write‡ccess will "

4927 ià(
jouº®_šum
 && 
jouº®_dev
) {

4928 
	`ext4_msg
(
sb
, 
KERN_ERR
, "filesystem has both journal "

4930  -
EINVAL
;

4933 ià(
jouº®_šum
) {

4934 ià(!(
jouº®
 = 
	`ext4_g‘_jouº®
(
sb
, 
jouº®_šum
)))

4935  -
EINVAL
;

4937 ià(!(
jouº®
 = 
	`ext4_g‘_dev_jouº®
(
sb
, 
jouº®_dev
)))

4938  -
EINVAL
;

4941 ià(!(
jouº®
->
j_æags
 & 
JBD2_BARRIER
))

4942 
	`ext4_msg
(
sb
, 
KERN_INFO
, "barriers disabled");

4944 ià(!
	`ext4_has_ã©u»_jouº®_Ãeds_»cov”y
(
sb
))

4945 
”r
 = 
	`jbd2_jouº®_we
(
jouº®
, !
»®ly_»ad_Úly
);

4946 ià(!
”r
) {

4947 *
§ve
 = 
	`km®loc
(
EXT4_S_ERR_LEN
, 
GFP_KERNEL
);

4948 ià(
§ve
)

4949 
	`memıy
(
§ve
, ((*è
es
) +

4950 
EXT4_S_ERR_START
, 
EXT4_S_ERR_LEN
);

4951 
”r
 = 
	`jbd2_jouº®_lßd
(
jouº®
);

4952 ià(
§ve
)

4953 
	`memıy
(((*è
es
è+ 
EXT4_S_ERR_START
,

4954 
§ve
, 
EXT4_S_ERR_LEN
);

4955 
	`kä“
(
§ve
);

4958 ià(
”r
) {

4959 
	`ext4_msg
(
sb
, 
KERN_ERR
, "error†oading journal");

4960 
	`jbd2_jouº®_de¡roy
(
jouº®
);

4961  
”r
;

4964 
	`EXT4_SB
(
sb
)->
s_jouº®
 = 
jouº®
;

4965 
	`ext4_ş—r_jouº®_”r
(
sb
, 
es
);

4967 ià(!
»®ly_»ad_Úly
 && 
jouº®_devnum
 &&

4968 
jouº®_devnum
 !ğ
	`Ë32_to_ıu
(
es
->
s_jouº®_dev
)) {

4969 
es
->
s_jouº®_dev
 = 
	`ıu_to_Ë32
(
jouº®_devnum
);

4972 
	`ext4_comm™_su³r
(
sb
, 1);

4976 
	}
}

4978 
	$ext4_comm™_su³r
(
su³r_block
 *
sb
, 
sync
)

4980 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

4981 
bufãr_h—d
 *
sbh
 = 
	`EXT4_SB
(
sb
)->
s_sbh
;

4982 
”rÜ
 = 0;

4984 ià(!
sbh
 || 
	`block_deviû_ejeùed
(
sb
))

4985  
”rÜ
;

4991 ià(!
	`bufãr_m­³d
(
sbh
))

4992  
”rÜ
;

5004 ià(!(
sb
->
s_æags
 & 
SB_RDONLY
))

5005 
	`ext4_upd©e_t¡amp
(
es
, 
s_wtime
);

5006 ià(
sb
->
s_bdev
->
bd_·¹
)

5007 
es
->
s_kby‹s_wr™‹n
 =

5008 
	`ıu_to_Ë64
(
	`EXT4_SB
(
sb
)->
s_kby‹s_wr™‹n
 +

5009 ((
	`·¹_¡©_»ad
(
sb
->
s_bdev
->
bd_·¹
,

5010 
£ùÜs
[
STAT_WRITE
]) -

5011 
	`EXT4_SB
(
sb
)->
s_£ùÜs_wr™‹n_¡¬t
) >> 1));

5013 
es
->
s_kby‹s_wr™‹n
 =

5014 
	`ıu_to_Ë64
(
	`EXT4_SB
(
sb
)->
s_kby‹s_wr™‹n
);

5015 ià(
	`³rıu_couÁ”_š™Ÿlized
(&
	`EXT4_SB
(
sb
)->
s_ä“şu¡”s_couÁ”
))

5016 
	`ext4_ä“_blocks_couÁ_£t
(
es
,

5017 
	`EXT4_C2B
(
	`EXT4_SB
(
sb
), 
	`³rıu_couÁ”_sum_pos™ive
(

5018 &
	`EXT4_SB
(
sb
)->
s_ä“şu¡”s_couÁ”
)));

5019 ià(
	`³rıu_couÁ”_š™Ÿlized
(&
	`EXT4_SB
(
sb
)->
s_ä“šodes_couÁ”
))

5020 
es
->
s_ä“_šodes_couÁ
 =

5021 
	`ıu_to_Ë32
(
	`³rıu_couÁ”_sum_pos™ive
(

5022 &
	`EXT4_SB
(
sb
)->
s_ä“šodes_couÁ”
));

5023 
	`BUFFER_TRACE
(
sbh
, "marking dirty");

5024 
	`ext4_su³rblock_csum_£t
(
sb
);

5025 ià(
sync
)

5026 
	`lock_bufãr
(
sbh
);

5027 ià(
	`bufãr_wr™e_io_”rÜ
(
sbh
è|| !
	`bufãr_u±od©e
(sbh)) {

5036 
	`ext4_msg
(
sb
, 
KERN_ERR
, "previous I/Oƒrroro "

5038 
	`ş—r_bufãr_wr™e_io_”rÜ
(
sbh
);

5039 
	`£t_bufãr_u±od©e
(
sbh
);

5041 
	`m¬k_bufãr_dœty
(
sbh
);

5042 ià(
sync
) {

5043 
	`uÆock_bufãr
(
sbh
);

5044 
”rÜ
 = 
	`__sync_dœty_bufãr
(
sbh
,

5045 
REQ_SYNC
 | (
	`‹¡_İt
(
sb
, 
BARRIER
è? 
REQ_FUA
 : 0));

5046 ià(
	`bufãr_wr™e_io_”rÜ
(
sbh
)) {

5047 
	`ext4_msg
(
sb
, 
KERN_ERR
, "I/Oƒrror while writing "

5049 
	`ş—r_bufãr_wr™e_io_”rÜ
(
sbh
);

5050 
	`£t_bufãr_u±od©e
(
sbh
);

5053  
”rÜ
;

5054 
	}
}

5061 
	$ext4_m¬k_»cov”y_com¶‘e
(
su³r_block
 *
sb
,

5062 
ext4_su³r_block
 *
es
)

5064 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

5066 ià(!
	`ext4_has_ã©u»_jouº®
(
sb
)) {

5067 
	`BUG_ON
(
jouº®
 !ğ
NULL
);

5070 
	`jbd2_jouº®_lock_upd©es
(
jouº®
);

5071 ià(
	`jbd2_jouº®_æush
(
jouº®
) < 0)

5072 
out
;

5074 ià(
	`ext4_has_ã©u»_jouº®_Ãeds_»cov”y
(
sb
è&& 
	`sb_rdÚly
(sb)) {

5075 
	`ext4_ş—r_ã©u»_jouº®_Ãeds_»cov”y
(
sb
);

5076 
	`ext4_comm™_su³r
(
sb
, 1);

5079 
out
:

5080 
	`jbd2_jouº®_uÆock_upd©es
(
jouº®
);

5081 
	}
}

5088 
	$ext4_ş—r_jouº®_”r
(
su³r_block
 *
sb
,

5089 
ext4_su³r_block
 *
es
)

5091 
jouº®_t
 *
jouº®
;

5092 
j_”ºo
;

5093 cÚ¡ *
”r¡r
;

5095 
	`BUG_ON
(!
	`ext4_has_ã©u»_jouº®
(
sb
));

5097 
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

5104 
j_”ºo
 = 
	`jbd2_jouº®_”ºo
(
jouº®
);

5105 ià(
j_”ºo
) {

5106 
nbuf
[16];

5108 
”r¡r
 = 
	`ext4_decode_”rÜ
(
sb
, 
j_”ºo
, 
nbuf
);

5109 
	`ext4_w¬nšg
(
sb
, "Filesystemƒrror„ecorded "

5110 "äom…»viou mouÁ: %s", 
”r¡r
);

5111 
	`ext4_w¬nšg
(
sb
, "Marking fs in‚eed of filesystem check.");

5113 
	`EXT4_SB
(
sb
)->
s_mouÁ_¡©e
 |ğ
EXT4_ERROR_FS
;

5114 
es
->
s_¡©e
 |ğ
	`ıu_to_Ë16
(
EXT4_ERROR_FS
);

5115 
	`ext4_comm™_su³r
(
sb
, 1);

5117 
	`jbd2_jouº®_ş—r_”r
(
jouº®
);

5118 
	`jbd2_jouº®_upd©e_sb_”ºo
(
jouº®
);

5120 
	}
}

5126 
	$ext4_fÜû_comm™
(
su³r_block
 *
sb
)

5128 
jouº®_t
 *
jouº®
;

5130 ià(
	`sb_rdÚly
(
sb
))

5133 
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

5134  
	`ext4_jouº®_fÜû_comm™
(
jouº®
);

5135 
	}
}

5137 
	$ext4_sync_fs
(
su³r_block
 *
sb
, 
wa™
)

5139 
»t
 = 0;

5140 
tid_t
 
rg‘
;

5141 
boŞ
 
Ãeds_b¬r›r
 = 
çl£
;

5142 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

5144 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
sbi
)))

5147 
	`Œaû_ext4_sync_fs
(
sb
, 
wa™
);

5148 
	`æush_wÜkqueue
(
sbi
->
rsv_cÚv”siÚ_wq
);

5153 
	`dquÙ_wr™eback_dquÙs
(
sb
, -1);

5159 ià(
sbi
->
s_jouº®
) {

5160 
rg‘
 = 
	`jbd2_g‘_Ï‹¡_Œª§ùiÚ
(
sbi
->
s_jouº®
);

5161 ià(
wa™
 && 
sbi
->
s_jouº®
->
j_æags
 & 
JBD2_BARRIER
 &&

5162 !
	`jbd2_Œªs_wl_£nd_d©a_b¬r›r
(
sbi
->
s_jouº®
, 
rg‘
))

5163 
Ãeds_b¬r›r
 = 
Œue
;

5165 ià(
	`jbd2_jouº®_¡¬t_comm™
(
sbi
->
s_jouº®
, &
rg‘
)) {

5166 ià(
wa™
)

5167 
»t
 = 
	`jbd2_log_wa™_comm™
(
sbi
->
s_jouº®
,

5168 
rg‘
);

5170 } ià(
wa™
 && 
	`‹¡_İt
(
sb
, 
BARRIER
))

5171 
Ãeds_b¬r›r
 = 
Œue
;

5172 ià(
Ãeds_b¬r›r
) {

5173 
”r
;

5174 
”r
 = 
	`blkdev_issue_æush
(
sb
->
s_bdev
, 
GFP_KERNEL
, 
NULL
);

5175 ià(!
»t
)

5176 
»t
 = 
”r
;

5179  
»t
;

5180 
	}
}

5190 
	$ext4_ä“ze
(
su³r_block
 *
sb
)

5192 
”rÜ
 = 0;

5193 
jouº®_t
 *
jouº®
;

5195 ià(
	`sb_rdÚly
(
sb
))

5198 
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

5200 ià(
jouº®
) {

5202 
	`jbd2_jouº®_lock_upd©es
(
jouº®
);

5208 
”rÜ
 = 
	`jbd2_jouº®_æush
(
jouº®
);

5209 ià(
”rÜ
 < 0)

5210 
out
;

5213 
	`ext4_ş—r_ã©u»_jouº®_Ãeds_»cov”y
(
sb
);

5216 
”rÜ
 = 
	`ext4_comm™_su³r
(
sb
, 1);

5217 
out
:

5218 ià(
jouº®
)

5220 
	`jbd2_jouº®_uÆock_upd©es
(
jouº®
);

5221  
”rÜ
;

5222 
	}
}

5228 
	$ext4_unä“ze
(
su³r_block
 *
sb
)

5230 ià(
	`sb_rdÚly
(
sb
è|| 
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(sb)))

5233 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
) {

5235 
	`ext4_£t_ã©u»_jouº®_Ãeds_»cov”y
(
sb
);

5238 
	`ext4_comm™_su³r
(
sb
, 1);

5240 
	}
}

5245 
	sext4_mouÁ_İtiÚs
 {

5246 
	ms_mouÁ_İt
;

5247 
	ms_mouÁ_İt2
;

5248 
kuid_t
 
	ms_»suid
;

5249 
kgid_t
 
	ms_»sgid
;

5250 
	ms_comm™_š‹rv®
;

5251 
u32
 
	ms_mš_b©ch_time
, 
	ms_max_b©ch_time
;

5252 #ifdeà
CONFIG_QUOTA


5253 
	ms_jquÙa_fmt
;

5254 *
	ms_qf_Çmes
[
EXT4_MAXQUOTAS
];

5258 
	$ext4_»mouÁ
(
su³r_block
 *
sb
, *
æags
, *
d©a
)

5260 
ext4_su³r_block
 *
es
;

5261 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

5262 
Şd_sb_æags
;

5263 
ext4_mouÁ_İtiÚs
 
Şd_İts
;

5264 
’abË_quÙa
 = 0;

5265 
ext4_group_t
 
g
;

5266 
jouº®_iİrio
 = 
DEFAULT_JOURNAL_IOPRIO
;

5267 
”r
 = 0;

5268 #ifdeà
CONFIG_QUOTA


5269 
i
, 
j
;

5270 *
to_ä“
[
EXT4_MAXQUOTAS
];

5272 *
Üig_d©a
 = 
	`k¡rdup
(
d©a
, 
GFP_KERNEL
);

5274 ià(
d©a
 && !
Üig_d©a
)

5275  -
ENOMEM
;

5278 
Şd_sb_æags
 = 
sb
->
s_æags
;

5279 
Şd_İts
.
s_mouÁ_İt
 = 
sbi
->s_mount_opt;

5280 
Şd_İts
.
s_mouÁ_İt2
 = 
sbi
->s_mount_opt2;

5281 
Şd_İts
.
s_»suid
 = 
sbi
->s_resuid;

5282 
Şd_İts
.
s_»sgid
 = 
sbi
->s_resgid;

5283 
Şd_İts
.
s_comm™_š‹rv®
 = 
sbi
->s_commit_interval;

5284 
Şd_İts
.
s_mš_b©ch_time
 = 
sbi
->s_min_batch_time;

5285 
Şd_İts
.
s_max_b©ch_time
 = 
sbi
->s_max_batch_time;

5286 #ifdeà
CONFIG_QUOTA


5287 
Şd_İts
.
s_jquÙa_fmt
 = 
sbi
->s_jquota_fmt;

5288 
i
 = 0; i < 
EXT4_MAXQUOTAS
; i++)

5289 ià(
sbi
->
s_qf_Çmes
[
i
]) {

5290 *
qf_Çme
 = 
	`g‘_qf_Çme
(
sb
, 
sbi
, 
i
);

5292 
Şd_İts
.
s_qf_Çmes
[
i
] = 
	`k¡rdup
(
qf_Çme
, 
GFP_KERNEL
);

5293 ià(!
Şd_İts
.
s_qf_Çmes
[
i
]) {

5294 
j
 = 0; j < 
i
; j++)

5295 
	`kä“
(
Şd_İts
.
s_qf_Çmes
[
j
]);

5296 
	`kä“
(
Üig_d©a
);

5297  -
ENOMEM
;

5300 
Şd_İts
.
s_qf_Çmes
[
i
] = 
NULL
;

5302 ià(
sbi
->
s_jouº®
 && sbi->s_jouº®->
j_sk
->
io_cÚ‹xt
)

5303 
jouº®_iİrio
 = 
sbi
->
s_jouº®
->
j_sk
->
io_cÚ‹xt
->
iİrio
;

5305 ià(!
	`·r£_İtiÚs
(
d©a
, 
sb
, 
NULL
, &
jouº®_iİrio
, 1)) {

5306 
”r
 = -
EINVAL
;

5307 
»¡Üe_İts
;

5310 
	`ext4_şamp_wªt_exŒa_isize
(
sb
);

5312 ià((
Şd_İts
.
s_mouÁ_İt
 & 
EXT4_MOUNT_JOURNAL_CHECKSUM
) ^

5313 
	`‹¡_İt
(
sb
, 
JOURNAL_CHECKSUM
)) {

5314 
	`ext4_msg
(
sb
, 
KERN_ERR
, "changing journal_checksum "

5316 
sbi
->
s_mouÁ_İt
 ^ğ
EXT4_MOUNT_JOURNAL_CHECKSUM
;

5319 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_JOURNAL_DATA
) {

5320 ià(
	`‹¡_İt2
(
sb
, 
EXPLICIT_DELALLOC
)) {

5321 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5323 
”r
 = -
EINVAL
;

5324 
»¡Üe_İts
;

5326 ià(
	`‹¡_İt
(
sb
, 
DIOREAD_NOLOCK
)) {

5327 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5329 
”r
 = -
EINVAL
;

5330 
»¡Üe_İts
;

5332 ià(
	`‹¡_İt
(
sb
, 
DAX
)) {

5333 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5335 
”r
 = -
EINVAL
;

5336 
»¡Üe_İts
;

5338 } ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_ORDERED_DATA
) {

5339 ià(
	`‹¡_İt
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

5340 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5342 
”r
 = -
EINVAL
;

5343 
»¡Üe_İts
;

5347 ià((
sbi
->
s_mouÁ_İt
 ^ 
Şd_İts
.s_mouÁ_İtè& 
EXT4_MOUNT_NO_MBCACHE
) {

5348 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can'tƒnable‚ombcache during„emount");

5349 
”r
 = -
EINVAL
;

5350 
»¡Üe_İts
;

5353 ià((
sbi
->
s_mouÁ_İt
 ^ 
Şd_İts
.s_mouÁ_İtè& 
EXT4_MOUNT_DAX
) {

5354 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "warning:„efusing change of "

5356 
sbi
->
s_mouÁ_İt
 ^ğ
EXT4_MOUNT_DAX
;

5359 ià(
sbi
->
s_mouÁ_æags
 & 
EXT4_MF_FS_ABORTED
)

5360 
	`ext4_abÜt
(
sb
, "Abort forced by user");

5362 
sb
->
s_æags
 = (sb->s_æag & ~
SB_POSIXACL
) |

5363 (
	`‹¡_İt
(
sb
, 
POSIX_ACL
è? 
SB_POSIXACL
 : 0);

5365 
es
 = 
sbi
->
s_es
;

5367 ià(
sbi
->
s_jouº®
) {

5368 
	`ext4_š™_jouº®_·¿ms
(
sb
, 
sbi
->
s_jouº®
);

5369 
	`£t_sk_iİrio
(
sbi
->
s_jouº®
->
j_sk
, 
jouº®_iİrio
);

5372 ià(*
æags
 & 
SB_LAZYTIME
)

5373 
sb
->
s_æags
 |ğ
SB_LAZYTIME
;

5375 ià((
boŞ
)(*
æags
 & 
SB_RDONLY
è!ğ
	`sb_rdÚly
(
sb
)) {

5376 ià(
sbi
->
s_mouÁ_æags
 & 
EXT4_MF_FS_ABORTED
) {

5377 
”r
 = -
EROFS
;

5378 
»¡Üe_İts
;

5381 ià(*
æags
 & 
SB_RDONLY
) {

5382 
”r
 = 
	`sync_fesy¡em
(
sb
);

5383 ià(
”r
 < 0)

5384 
»¡Üe_İts
;

5385 
”r
 = 
	`dquÙ_su¥’d
(
sb
, -1);

5386 ià(
”r
 < 0)

5387 
»¡Üe_İts
;

5393 
sb
->
s_æags
 |ğ
SB_RDONLY
;

5400 ià(!(
es
->
s_¡©e
 & 
	`ıu_to_Ë16
(
EXT4_VALID_FS
)) &&

5401 (
sbi
->
s_mouÁ_¡©e
 & 
EXT4_VALID_FS
))

5402 
es
->
s_¡©e
 = 
	`ıu_to_Ë16
(
sbi
->
s_mouÁ_¡©e
);

5404 ià(
sbi
->
s_jouº®
)

5405 
	`ext4_m¬k_»cov”y_com¶‘e
(
sb
, 
es
);

5406 ià(
sbi
->
s_mmp_tsk
)

5407 
	`kth»ad_¡İ
(
sbi
->
s_mmp_tsk
);

5410 ià(
	`ext4_has_ã©u»_»adÚly
(
sb
) ||

5411 !
	`ext4_ã©u»_£t_ok
(
sb
, 0)) {

5412 
”r
 = -
EROFS
;

5413 
»¡Üe_İts
;

5419 
g
 = 0; g < 
sbi
->
s_groups_couÁ
; g++) {

5420 
ext4_group_desc
 *
gdp
 =

5421 
	`ext4_g‘_group_desc
(
sb
, 
g
, 
NULL
);

5423 ià(!
	`ext4_group_desc_csum_v”ify
(
sb
, 
g
, 
gdp
)) {

5424 
	`ext4_msg
(
sb
, 
KERN_ERR
,

5426 
g
, 
	`Ë16_to_ıu
(
	`ext4_group_desc_csum
(
sb
, g, 
gdp
)),

5427 
	`Ë16_to_ıu
(
gdp
->
bg_checksum
));

5428 
”r
 = -
EFSBADCRC
;

5429 
»¡Üe_İts
;

5438 ià(
es
->
s_Ï¡_Üphª
) {

5439 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "Couldn't "

5443 
”r
 = -
EINVAL
;

5444 
»¡Üe_İts
;

5453 ià(
sbi
->
s_jouº®
)

5454 
	`ext4_ş—r_jouº®_”r
(
sb
, 
es
);

5455 
sbi
->
s_mouÁ_¡©e
 = 
	`Ë16_to_ıu
(
es
->
s_¡©e
);

5457 
”r
 = 
	`ext4_£tup_su³r
(
sb
, 
es
, 0);

5458 ià(
”r
)

5459 
»¡Üe_İts
;

5461 
sb
->
s_æags
 &ğ~
SB_RDONLY
;

5462 ià(
	`ext4_has_ã©u»_mmp
(
sb
))

5463 ià(
	`ext4_muÉi_mouÁ_´Ùeù
(
sb
,

5464 
	`Ë64_to_ıu
(
es
->
s_mmp_block
))) {

5465 
”r
 = -
EROFS
;

5466 
»¡Üe_İts
;

5468 
’abË_quÙa
 = 1;

5476 ià(
	`sb_rdÚly
(
sb
è|| !
	`‹¡_İt
(sb, 
INIT_INODE_TABLE
))

5477 
	`ext4_uÄegi¡”_li_»que¡
(
sb
);

5479 
ext4_group_t
 
fœ¡_nÙ_z”Ûd
;

5480 
fœ¡_nÙ_z”Ûd
 = 
	`ext4_has_unš™_™abË
(
sb
);

5481 
	`ext4_»gi¡”_li_»que¡
(
sb
, 
fœ¡_nÙ_z”Ûd
);

5484 
	`ext4_£tup_sy¡em_zÚe
(
sb
);

5485 ià(
sbi
->
s_jouº®
 =ğ
NULL
 && !(
Şd_sb_æags
 & 
SB_RDONLY
)) {

5486 
”r
 = 
	`ext4_comm™_su³r
(
sb
, 1);

5487 ià(
”r
)

5488 
»¡Üe_İts
;

5491 #ifdeà
CONFIG_QUOTA


5493 
i
 = 0; i < 
EXT4_MAXQUOTAS
; i++)

5494 
	`kä“
(
Şd_İts
.
s_qf_Çmes
[
i
]);

5495 ià(
’abË_quÙa
) {

5496 ià(
	`sb_ªy_quÙa_su¥’ded
(
sb
))

5497 
	`dquÙ_»sume
(
sb
, -1);

5498 ià(
	`ext4_has_ã©u»_quÙa
(
sb
)) {

5499 
”r
 = 
	`ext4_’abË_quÙas
(
sb
);

5500 ià(
”r
)

5501 
»¡Üe_İts
;

5506 *
æags
 = (*æag & ~
SB_LAZYTIME
è| (
sb
->
s_æags
 & SB_LAZYTIME);

5507 
	`ext4_msg
(
sb
, 
KERN_INFO
, "»-mouÁed. O±s: %s", 
Üig_d©a
);

5508 
	`kä“
(
Üig_d©a
);

5511 
»¡Üe_İts
:

5512 
sb
->
s_æags
 = 
Şd_sb_æags
;

5513 
sbi
->
s_mouÁ_İt
 = 
Şd_İts
.s_mount_opt;

5514 
sbi
->
s_mouÁ_İt2
 = 
Şd_İts
.s_mount_opt2;

5515 
sbi
->
s_»suid
 = 
Şd_İts
.s_resuid;

5516 
sbi
->
s_»sgid
 = 
Şd_İts
.s_resgid;

5517 
sbi
->
s_comm™_š‹rv®
 = 
Şd_İts
.s_commit_interval;

5518 
sbi
->
s_mš_b©ch_time
 = 
Şd_İts
.s_min_batch_time;

5519 
sbi
->
s_max_b©ch_time
 = 
Şd_İts
.s_max_batch_time;

5520 #ifdeà
CONFIG_QUOTA


5521 
sbi
->
s_jquÙa_fmt
 = 
Şd_İts
.s_jquota_fmt;

5522 
i
 = 0; i < 
EXT4_MAXQUOTAS
; i++) {

5523 
to_ä“
[
i
] = 
	`g‘_qf_Çme
(
sb
, 
sbi
, i);

5524 
	`rcu_assign_poš‹r
(
sbi
->
s_qf_Çmes
[
i
], 
Şd_İts
.s_qf_names[i]);

5526 
	`synchrÚize_rcu
();

5527 
i
 = 0; i < 
EXT4_MAXQUOTAS
; i++)

5528 
	`kä“
(
to_ä“
[
i
]);

5530 
	`kä“
(
Üig_d©a
);

5531  
”r
;

5532 
	}
}

5534 #ifdeà
CONFIG_QUOTA


5535 
	$ext4_¡©fs_´ojeù
(
su³r_block
 *
sb
,

5536 
k´ojid_t
 
´ojid
, 
k¡©fs
 *
buf
)

5538 
kqid
 
qid
;

5539 
dquÙ
 *dquot;

5540 
u64
 
lim™
;

5541 
u64
 
curblock
;

5543 
qid
 = 
	`make_kqid_´ojid
(
´ojid
);

5544 
dquÙ
 = 
	`dqg‘
(
sb
, 
qid
);

5545 ià(
	`IS_ERR
(
dquÙ
))

5546  
	`PTR_ERR
(
dquÙ
);

5547 
	`¥š_lock
(&
dquÙ
->
dq_dqb_lock
);

5549 
lim™
 = (
dquÙ
->
dq_dqb
.
dqb_bsoálim™
 ?

5550 
dquÙ
->
dq_dqb
.
dqb_bsoálim™
 :

5551 
dquÙ
->
dq_dqb
.
dqb_bh¬dlim™
è>> 
sb
->
s_blocksize_b™s
;

5552 ià(
lim™
 && 
buf
->
f_blocks
 >†imit) {

5553 
curblock
 = (
dquÙ
->
dq_dqb
.
dqb_cur¥aû
 +

5554 
dquÙ
->
dq_dqb
.
dqb_rsv¥aû
è>> 
sb
->
s_blocksize_b™s
;

5555 
buf
->
f_blocks
 = 
lim™
;

5556 
buf
->
f_bä“
 = buf->
f_bava
 =

5557 (
buf
->
f_blocks
 > 
curblock
) ?

5558 (
buf
->
f_blocks
 - 
curblock
) : 0;

5561 
lim™
 = 
dquÙ
->
dq_dqb
.
dqb_isoálim™
 ?

5562 
dquÙ
->
dq_dqb
.
dqb_isoálim™
 :

5563 
dquÙ
->
dq_dqb
.
dqb_ih¬dlim™
;

5564 ià(
lim™
 && 
buf
->
f_fes
 >†imit) {

5565 
buf
->
f_fes
 = 
lim™
;

5566 
buf
->
f_fä“
 =

5567 (
buf
->
f_fes
 > 
dquÙ
->
dq_dqb
.
dqb_curšodes
) ?

5568 (
buf
->
f_fes
 - 
dquÙ
->
dq_dqb
.
dqb_curšodes
) : 0;

5571 
	`¥š_uÆock
(&
dquÙ
->
dq_dqb_lock
);

5572 
	`dqput
(
dquÙ
);

5574 
	}
}

5577 
	$ext4_¡©fs
(
d’Œy
 *d’Œy, 
k¡©fs
 *
buf
)

5579 
su³r_block
 *
sb
 = 
d’Œy
->
d_sb
;

5580 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

5581 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

5582 
ext4_fsblk_t
 
ov”h—d
 = 0, 
»sv_blocks
;

5583 
u64
 
fsid
;

5584 
s64
 
bä“
;

5585 
»sv_blocks
 = 
	`EXT4_C2B
(
sbi
, 
	`©omic64_»ad
(&sbi->
s_»sv_şu¡”s
));

5587 ià(!
	`‹¡_İt
(
sb
, 
MINIX_DF
))

5588 
ov”h—d
 = 
sbi
->
s_ov”h—d
;

5590 
buf
->
f_ty³
 = 
EXT4_SUPER_MAGIC
;

5591 
buf
->
f_bsize
 = 
sb
->
s_blocksize
;

5592 
buf
->
f_blocks
 = 
	`ext4_blocks_couÁ
(
es
è- 
	`EXT4_C2B
(
sbi
, 
ov”h—d
);

5593 
bä“
 = 
	`³rıu_couÁ”_sum_pos™ive
(&
sbi
->
s_ä“şu¡”s_couÁ”
) -

5594 
	`³rıu_couÁ”_sum_pos™ive
(&
sbi
->
s_dœtyşu¡”s_couÁ”
);

5596 
buf
->
f_bä“
 = 
	`EXT4_C2B
(
sbi
, 
	`max_t
(
s64
, 
bä“
, 0));

5597 
buf
->
f_bava
 = buf->
f_bä“
 -

5598 (
	`ext4_r_blocks_couÁ
(
es
è+ 
»sv_blocks
);

5599 ià(
buf
->
f_bä“
 < (
	`ext4_r_blocks_couÁ
(
es
è+ 
»sv_blocks
))

5600 
buf
->
f_bava
 = 0;

5601 
buf
->
f_fes
 = 
	`Ë32_to_ıu
(
es
->
s_šodes_couÁ
);

5602 
buf
->
f_fä“
 = 
	`³rıu_couÁ”_sum_pos™ive
(&
sbi
->
s_ä“šodes_couÁ”
);

5603 
buf
->
f_Çm–’
 = 
EXT4_NAME_LEN
;

5604 
fsid
 = 
	`Ë64_to_ıup
((*)
es
->
s_uuid
) ^

5605 
	`Ë64_to_ıup
((*)
es
->
s_uuid
 + (
u64
));

5606 
buf
->
f_fsid
.
v®
[0] = 
fsid
 & 0xFFFFFFFFUL;

5607 
buf
->
f_fsid
.
v®
[1] = (
fsid
 >> 32) & 0xFFFFFFFFUL;

5609 #ifdeà
CONFIG_QUOTA


5610 ià(
	`ext4_‹¡_šode_æag
(
d’Œy
->
d_šode
, 
EXT4_INODE_PROJINHERIT
) &&

5611 
	`sb_has_quÙa_lim™s_’abËd
(
sb
, 
PRJQUOTA
))

5612 
	`ext4_¡©fs_´ojeù
(
sb
, 
	`EXT4_I
(
d’Œy
->
d_šode
)->
i_´ojid
, 
buf
);

5615 
	}
}

5618 #ifdeà
CONFIG_QUOTA


5624 
šlše
 
šode
 *
	$dquÙ_to_šode
(
dquÙ
 *dquot)

5626  
	`sb_dqİt
(
dquÙ
->
dq_sb
)->
fes
[dquÙ->
dq_id
.
ty³
];

5627 
	}
}

5629 
	$ext4_wr™e_dquÙ
(
dquÙ
 *dquot)

5631 
»t
, 
”r
;

5632 
hªdË_t
 *
hªdË
;

5633 
šode
 *inode;

5635 
šode
 = 
	`dquÙ_to_šode
(
dquÙ
);

5636 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_QUOTA
,

5637 
	`EXT4_QUOTA_TRANS_BLOCKS
(
dquÙ
->
dq_sb
));

5638 ià(
	`IS_ERR
(
hªdË
))

5639  
	`PTR_ERR
(
hªdË
);

5640 
»t
 = 
	`dquÙ_comm™
(
dquÙ
);

5641 
”r
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

5642 ià(!
»t
)

5643 
»t
 = 
”r
;

5644  
»t
;

5645 
	}
}

5647 
	$ext4_acquœe_dquÙ
(
dquÙ
 *dquot)

5649 
»t
, 
”r
;

5650 
hªdË_t
 *
hªdË
;

5652 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
	`dquÙ_to_šode
(
dquÙ
), 
EXT4_HT_QUOTA
,

5653 
	`EXT4_QUOTA_INIT_BLOCKS
(
dquÙ
->
dq_sb
));

5654 ià(
	`IS_ERR
(
hªdË
))

5655  
	`PTR_ERR
(
hªdË
);

5656 
»t
 = 
	`dquÙ_acquœe
(
dquÙ
);

5657 
”r
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

5658 ià(!
»t
)

5659 
»t
 = 
”r
;

5660  
»t
;

5661 
	}
}

5663 
	$ext4_»Ëa£_dquÙ
(
dquÙ
 *dquot)

5665 
»t
, 
”r
;

5666 
hªdË_t
 *
hªdË
;

5668 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
	`dquÙ_to_šode
(
dquÙ
), 
EXT4_HT_QUOTA
,

5669 
	`EXT4_QUOTA_DEL_BLOCKS
(
dquÙ
->
dq_sb
));

5670 ià(
	`IS_ERR
(
hªdË
)) {

5672 
	`dquÙ_»Ëa£
(
dquÙ
);

5673  
	`PTR_ERR
(
hªdË
);

5675 
»t
 = 
	`dquÙ_»Ëa£
(
dquÙ
);

5676 
”r
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

5677 ià(!
»t
)

5678 
»t
 = 
”r
;

5679  
»t
;

5680 
	}
}

5682 
	$ext4_m¬k_dquÙ_dœty
(
dquÙ
 *dquot)

5684 
su³r_block
 *
sb
 = 
dquÙ
->
dq_sb
;

5685 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

5688 ià(
	`ext4_has_ã©u»_quÙa
(
sb
) ||

5689 
sbi
->
s_qf_Çmes
[
USRQUOTA
] || sbi->s_qf_Çmes[
GRPQUOTA
]) {

5690 
	`dquÙ_m¬k_dquÙ_dœty
(
dquÙ
);

5691  
	`ext4_wr™e_dquÙ
(
dquÙ
);

5693  
	`dquÙ_m¬k_dquÙ_dœty
(
dquÙ
);

5695 
	}
}

5697 
	$ext4_wr™e_šfo
(
su³r_block
 *
sb
, 
ty³
)

5699 
»t
, 
”r
;

5700 
hªdË_t
 *
hªdË
;

5703 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
	`d_šode
(
sb
->
s_roÙ
), 
EXT4_HT_QUOTA
, 2);

5704 ià(
	`IS_ERR
(
hªdË
))

5705  
	`PTR_ERR
(
hªdË
);

5706 
»t
 = 
	`dquÙ_comm™_šfo
(
sb
, 
ty³
);

5707 
”r
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

5708 ià(!
»t
)

5709 
»t
 = 
”r
;

5710  
»t
;

5711 
	}
}

5717 
	$ext4_quÙa_Ú_mouÁ
(
su³r_block
 *
sb
, 
ty³
)

5719  
	`dquÙ_quÙa_Ú_mouÁ
(
sb
, 
	`g‘_qf_Çme
(sb, 
	`EXT4_SB
(sb), 
ty³
),

5720 
	`EXT4_SB
(
sb
)->
s_jquÙa_fmt
, 
ty³
);

5721 
	}
}

5723 
	$lockd•_£t_quÙa_šode
(
šode
 *šode, 
subşass
)

5725 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

5733 (è
ei
;

5734 
	`lockd•_£t_subşass
(&
ei
->
i_d©a_£m
, 
subşass
);

5735 
	}
}

5740 
	$ext4_quÙa_Ú
(
su³r_block
 *
sb
, 
ty³
, 
fÜm©_id
,

5741 cÚ¡ 
·th
 *path)

5743 
”r
;

5745 ià(!
	`‹¡_İt
(
sb
, 
QUOTA
))

5746  -
EINVAL
;

5749 ià(
·th
->
d’Œy
->
d_sb
 !ğ
sb
)

5750  -
EXDEV
;

5752 ià(
	`EXT4_SB
(
sb
)->
s_qf_Çmes
[
ty³
]) {

5754 ià(
·th
->
d’Œy
->
d_·»Á
 !ğ
sb
->
s_roÙ
)

5755 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

5758 
	`sb_dqİt
(
sb
)->
æags
 |ğ
DQUOT_NOLIST_DIRTY
;

5764 
	`sb_dqİt
(
sb
)->
æags
 &ğ~
DQUOT_NOLIST_DIRTY
;

5771 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
 &&

5772 
	`ext4_should_jouº®_d©a
(
	`d_šode
(
·th
->
d’Œy
))) {

5777 
	`jbd2_jouº®_lock_upd©es
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

5778 
”r
 = 
	`jbd2_jouº®_æush
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

5779 
	`jbd2_jouº®_uÆock_upd©es
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

5780 ià(
”r
)

5781  
”r
;

5784 
	`lockd•_£t_quÙa_šode
(
·th
->
d’Œy
->
d_šode
, 
I_DATA_SEM_QUOTA
);

5785 
”r
 = 
	`dquÙ_quÙa_Ú
(
sb
, 
ty³
, 
fÜm©_id
, 
·th
);

5786 ià(
”r
) {

5787 
	`lockd•_£t_quÙa_šode
(
·th
->
d’Œy
->
d_šode
,

5788 
I_DATA_SEM_NORMAL
);

5790 
šode
 *šodğ
	`d_šode
(
·th
->
d’Œy
);

5791 
hªdË_t
 *
hªdË
;

5798 
	`šode_lock
(
šode
);

5799 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_QUOTA
, 1);

5800 ià(
	`IS_ERR
(
hªdË
))

5801 
uÆock_šode
;

5802 
	`EXT4_I
(
šode
)->
i_æags
 |ğ
EXT4_NOATIME_FL
 | 
EXT4_IMMUTABLE_FL
;

5803 
	`šode_£t_æags
(
šode
, 
S_NOATIME
 | 
S_IMMUTABLE
,

5804 
S_NOATIME
 | 
S_IMMUTABLE
);

5805 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

5806 
	`ext4_jouº®_¡İ
(
hªdË
);

5807 
uÆock_šode
:

5808 
	`šode_uÆock
(
šode
);

5810  
”r
;

5811 
	}
}

5813 
	$ext4_quÙa_’abË
(
su³r_block
 *
sb
, 
ty³
, 
fÜm©_id
,

5814 
æags
)

5816 
”r
;

5817 
šode
 *
qf_šode
;

5818 
qf_šums
[
EXT4_MAXQUOTAS
] = {

5819 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_u¤_quÙa_šum
),

5820 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_g½_quÙa_šum
),

5821 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_´j_quÙa_šum
)

5824 
	`BUG_ON
(!
	`ext4_has_ã©u»_quÙa
(
sb
));

5826 ià(!
qf_šums
[
ty³
])

5827  -
EPERM
;

5829 
qf_šode
 = 
	`ext4_ig‘
(
sb
, 
qf_šums
[
ty³
], 
EXT4_IGET_SPECIAL
);

5830 ià(
	`IS_ERR
(
qf_šode
)) {

5831 
	`ext4_”rÜ
(
sb
, "Bad quÙ¨šod# %lu", 
qf_šums
[
ty³
]);

5832  
	`PTR_ERR
(
qf_šode
);

5836 
qf_šode
->
i_æags
 |ğ
S_NOQUOTA
;

5837 
	`lockd•_£t_quÙa_šode
(
qf_šode
, 
I_DATA_SEM_QUOTA
);

5838 
”r
 = 
	`dquÙ_’abË
(
qf_šode
, 
ty³
, 
fÜm©_id
, 
æags
);

5839 ià(
”r
)

5840 
	`lockd•_£t_quÙa_šode
(
qf_šode
, 
I_DATA_SEM_NORMAL
);

5841 
	`ut
(
qf_šode
);

5843  
”r
;

5844 
	}
}

5847 
	$ext4_’abË_quÙas
(
su³r_block
 *
sb
)

5849 
ty³
, 
”r
 = 0;

5850 
qf_šums
[
EXT4_MAXQUOTAS
] = {

5851 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_u¤_quÙa_šum
),

5852 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_g½_quÙa_šum
),

5853 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_´j_quÙa_šum
)

5855 
boŞ
 
quÙa_mİt
[
EXT4_MAXQUOTAS
] = {

5856 
	`‹¡_İt
(
sb
, 
USRQUOTA
),

5857 
	`‹¡_İt
(
sb
, 
GRPQUOTA
),

5858 
	`‹¡_İt
(
sb
, 
PRJQUOTA
),

5861 
	`sb_dqİt
(
sb
)->
æags
 |ğ
DQUOT_QUOTA_SYS_FILE
 | 
DQUOT_NOLIST_DIRTY
;

5862 
ty³
 = 0;y³ < 
EXT4_MAXQUOTAS
;ype++) {

5863 ià(
qf_šums
[
ty³
]) {

5864 
”r
 = 
	`ext4_quÙa_’abË
(
sb
, 
ty³
, 
QFMT_VFS_V1
,

5865 
DQUOT_USAGE_ENABLED
 |

5866 (
quÙa_mİt
[
ty³
] ? 
DQUOT_LIMITS_ENABLED
 : 0));

5867 ià(
”r
) {

5868 
	`ext4_w¬nšg
(
sb
,

5871 "e2fsckØfix.", 
ty³
, 
”r
);

5872 
ty³
--;ype >= 0;ype--)

5873 
	`dquÙ_quÙa_off
(
sb
, 
ty³
);

5875  
”r
;

5880 
	}
}

5882 
	$ext4_quÙa_off
(
su³r_block
 *
sb
, 
ty³
)

5884 
šode
 *šodğ
	`sb_dqİt
(
sb
)->
fes
[
ty³
];

5885 
hªdË_t
 *
hªdË
;

5886 
”r
;

5890 ià(
	`‹¡_İt
(
sb
, 
DELALLOC
))

5891 
	`sync_fesy¡em
(
sb
);

5893 ià(!
šode
 || !
	`ig¿b
(inode))

5894 
out
;

5896 
”r
 = 
	`dquÙ_quÙa_off
(
sb
, 
ty³
);

5897 ià(
”r
 || 
	`ext4_has_ã©u»_quÙa
(
sb
))

5898 
out_put
;

5900 
	`šode_lock
(
šode
);

5906 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_QUOTA
, 1);

5907 ià(
	`IS_ERR
(
hªdË
))

5908 
out_uÆock
;

5909 
	`EXT4_I
(
šode
)->
i_æags
 &ğ~(
EXT4_NOATIME_FL
 | 
EXT4_IMMUTABLE_FL
);

5910 
	`šode_£t_æags
(
šode
, 0, 
S_NOATIME
 | 
S_IMMUTABLE
);

5911 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

5912 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

5913 
	`ext4_jouº®_¡İ
(
hªdË
);

5914 
out_uÆock
:

5915 
	`šode_uÆock
(
šode
);

5916 
out_put
:

5917 
	`lockd•_£t_quÙa_šode
(
šode
, 
I_DATA_SEM_NORMAL
);

5918 
	`ut
(
šode
);

5919  
”r
;

5920 
out
:

5921  
	`dquÙ_quÙa_off
(
sb
, 
ty³
);

5922 
	}
}

5928 
ssize_t
 
	$ext4_quÙa_»ad
(
su³r_block
 *
sb
, 
ty³
, *
d©a
,

5929 
size_t
 
Ën
, 
loff_t
 
off
)

5931 
šode
 *šodğ
	`sb_dqİt
(
sb
)->
fes
[
ty³
];

5932 
ext4_lblk_t
 
blk
 = 
off
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

5933 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

5934 
tocİy
;

5935 
size_t
 
tÜ—d
;

5936 
bufãr_h—d
 *
bh
;

5937 
loff_t
 
i_size
 = 
	`i_size_»ad
(
šode
);

5939 ià(
off
 > 
i_size
)

5941 ià(
off
+
Ën
 > 
i_size
)

5942 
Ën
 = 
i_size
-
off
;

5943 
tÜ—d
 = 
Ën
;

5944 
tÜ—d
 > 0) {

5945 
tocİy
 = 
sb
->
s_blocksize
 - 
off£t
 < 
tÜ—d
 ?

5946 
sb
->
s_blocksize
 - 
off£t
 : 
tÜ—d
;

5947 
bh
 = 
	`ext4_b»ad
(
NULL
, 
šode
, 
blk
, 0);

5948 ià(
	`IS_ERR
(
bh
))

5949  
	`PTR_ERR
(
bh
);

5950 ià(!
bh
)

5951 
	`mem£t
(
d©a
, 0, 
tocİy
);

5953 
	`memıy
(
d©a
, 
bh
->
b_d©a
+
off£t
, 
tocİy
);

5954 
	`b»l£
(
bh
);

5955 
off£t
 = 0;

5956 
tÜ—d
 -ğ
tocİy
;

5957 
d©a
 +ğ
tocİy
;

5958 
blk
++;

5960  
Ën
;

5961 
	}
}

5965 
ssize_t
 
	$ext4_quÙa_wr™e
(
su³r_block
 *
sb
, 
ty³
,

5966 cÚ¡ *
d©a
, 
size_t
 
Ën
, 
loff_t
 
off
)

5968 
šode
 *šodğ
	`sb_dqİt
(
sb
)->
fes
[
ty³
];

5969 
ext4_lblk_t
 
blk
 = 
off
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

5970 
”r
, 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

5971 
»Œ›s
 = 0;

5972 
bufãr_h—d
 *
bh
;

5973 
hªdË_t
 *
hªdË
 = 
	`jouº®_cu¼’t_hªdË
();

5975 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
 && !
hªdË
) {

5976 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "Quota write (off=%llu,†en=%llu)"

5978 ()
off
, ()
Ën
);

5979  -
EIO
;

5985 ià(
sb
->
s_blocksize
 - 
off£t
 < 
Ën
) {

5986 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "Quota write (off=%llu,†en=%llu)"

5988 ()
off
, ()
Ën
);

5989  -
EIO
;

5993 
bh
 = 
	`ext4_b»ad
(
hªdË
, 
šode
, 
blk
,

5994 
EXT4_GET_BLOCKS_CREATE
 |

5995 
EXT4_GET_BLOCKS_METADATA_NOFAIL
);

5996 } 
	`IS_ERR
(
bh
è&& (
	`PTR_ERR
(bhè=ğ-
ENOSPC
) &&

5997 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
));

5998 ià(
	`IS_ERR
(
bh
))

5999  
	`PTR_ERR
(
bh
);

6000 ià(!
bh
)

6001 
out
;

6002 
	`BUFFER_TRACE
(
bh
, "get write‡ccess");

6003 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

6004 ià(
”r
) {

6005 
	`b»l£
(
bh
);

6006  
”r
;

6008 
	`lock_bufãr
(
bh
);

6009 
	`memıy
(
bh
->
b_d©a
+
off£t
, 
d©a
, 
Ën
);

6010 
	`æush_dÿche_·ge
(
bh
->
b_·ge
);

6011 
	`uÆock_bufãr
(
bh
);

6012 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

6013 
	`b»l£
(
bh
);

6014 
out
:

6015 ià(
šode
->
i_size
 < 
off
 + 
Ën
) {

6016 
	`i_size_wr™e
(
šode
, 
off
 + 
Ën
);

6017 
	`EXT4_I
(
šode
)->
i_disksize
 = inode->
i_size
;

6018 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

6020  
Ën
;

6021 
	}
}

6023 
	$ext4_g‘_Ãxt_id
(
su³r_block
 *
sb
, 
kqid
 *
qid
)

6025 cÚ¡ 
quÙa_fÜm©_İs
 *
İs
;

6027 ià(!
	`sb_has_quÙa_lßded
(
sb
, 
qid
->
ty³
))

6028  -
ESRCH
;

6029 
İs
 = 
	`sb_dqİt
(
sb
)->İs[
qid
->
ty³
];

6030 ià(!
İs
 || !İs->
g‘_Ãxt_id
)

6031  -
ENOSYS
;

6032  
	`dquÙ_g‘_Ãxt_id
(
sb
, 
qid
);

6033 
	}
}

6036 
d’Œy
 *
	$ext4_mouÁ
(
fe_sy¡em_ty³
 *
fs_ty³
, 
æags
,

6037 cÚ¡ *
dev_Çme
, *
d©a
)

6039  
	`mouÁ_bdev
(
fs_ty³
, 
æags
, 
dev_Çme
, 
d©a
, 
ext4_fl_su³r
);

6040 
	}
}

6042 #ià!
defšed
(
CONFIG_EXT2_FS
è&& !defšed(
CONFIG_EXT2_FS_MODULE
è&& defšed(
CONFIG_EXT4_USE_FOR_EXT2
)

6043 
šlše
 
	$»gi¡”_as_ext2
()

6045 
”r
 = 
	`»gi¡”_fesy¡em
(&
ext2_fs_ty³
);

6046 ià(
”r
)

6047 
	`´štk
(
KERN_WARNING


6048 "EXT4-fs: UÇbËØ»gi¡”‡ ext2 (%d)\n", 
”r
);

6049 
	}
}

6051 
šlše
 
	$uÄegi¡”_as_ext2
()

6053 
	`uÄegi¡”_fesy¡em
(&
ext2_fs_ty³
);

6054 
	}
}

6056 
šlše
 
	$ext2_ã©u»_£t_ok
(
su³r_block
 *
sb
)

6058 ià(
	`ext4_has_unknown_ext2_šcom·t_ã©u»s
(
sb
))

6060 ià(
	`sb_rdÚly
(
sb
))

6062 ià(
	`ext4_has_unknown_ext2_ro_com·t_ã©u»s
(
sb
))

6065 
	}
}

6067 
šlše
 
	$»gi¡”_as_ext2
(è{ 
	}
}

6068 
šlše
 
	$uÄegi¡”_as_ext2
(è{ 
	}
}

6069 
šlše
 
	$ext2_ã©u»_£t_ok
(
su³r_block
 *
sb
è{  0; 
	}
}

6072 
šlše
 
	$»gi¡”_as_ext3
()

6074 
”r
 = 
	`»gi¡”_fesy¡em
(&
ext3_fs_ty³
);

6075 ià(
”r
)

6076 
	`´štk
(
KERN_WARNING


6077 "EXT4-fs: UÇbËØ»gi¡”‡ ext3 (%d)\n", 
”r
);

6078 
	}
}

6080 
šlše
 
	$uÄegi¡”_as_ext3
()

6082 
	`uÄegi¡”_fesy¡em
(&
ext3_fs_ty³
);

6083 
	}
}

6085 
šlše
 
	$ext3_ã©u»_£t_ok
(
su³r_block
 *
sb
)

6087 ià(
	`ext4_has_unknown_ext3_šcom·t_ã©u»s
(
sb
))

6089 ià(!
	`ext4_has_ã©u»_jouº®
(
sb
))

6091 ià(
	`sb_rdÚly
(
sb
))

6093 ià(
	`ext4_has_unknown_ext3_ro_com·t_ã©u»s
(
sb
))

6096 
	}
}

6098 
fe_sy¡em_ty³
 
	gext4_fs_ty³
 = {

6099 .
owÃr
 = 
THIS_MODULE
,

6100 .
	gÇme
 = "ext4",

6101 .
	gmouÁ
 = 
ext4_mouÁ
,

6102 .
	gkl_sb
 = 
kl_block_su³r
,

6103 .
	gfs_æags
 = 
FS_REQUIRES_DEV
,

6105 
MODULE_ALIAS_FS
("ext4");

6108 
wa™_queue_h—d_t
 
	gext4__iÛnd_wq
[
EXT4_WQ_HASH_SZ
];

6110 
__š™
 
	$ext4_š™_fs
()

6112 
i
, 
”r
;

6114 
	`¿‹lim™_¡©e_š™
(&
ext4_mouÁ_msg_¿‹lim™
, 30 * 
HZ
, 64);

6115 
ext4_li_šfo
 = 
NULL
;

6116 
	`mu‹x_š™
(&
ext4_li_mtx
);

6119 
	`ext4_check_æag_v®ues
();

6121 
i
 = 0; i < 
EXT4_WQ_HASH_SZ
; i++)

6122 
	`š™_wa™queue_h—d
(&
ext4__iÛnd_wq
[
i
]);

6124 
”r
 = 
	`ext4_š™_es
();

6125 ià(
”r
)

6126  
”r
;

6128 
”r
 = 
	`ext4_š™_³ndšg
();

6129 ià(
”r
)

6130 
out7
;

6132 
”r
 = 
	`ext4_š™_po¡_»ad_´oûssšg
();

6133 ià(
”r
)

6134 
out6
;

6136 
”r
 = 
	`ext4_š™_·geio
();

6137 ià(
”r
)

6138 
out5
;

6140 
”r
 = 
	`ext4_š™_sy¡em_zÚe
();

6141 ià(
”r
)

6142 
out4
;

6144 
”r
 = 
	`ext4_š™_sysfs
();

6145 ià(
”r
)

6146 
out3
;

6148 
”r
 = 
	`ext4_š™_mb®loc
();

6149 ià(
”r
)

6150 
out2
;

6151 
”r
 = 
	`š™_šodeÿche
();

6152 ià(
”r
)

6153 
out1
;

6154 
	`»gi¡”_as_ext3
();

6155 
	`»gi¡”_as_ext2
();

6156 
”r
 = 
	`»gi¡”_fesy¡em
(&
ext4_fs_ty³
);

6157 ià(
”r
)

6158 
out
;

6161 
out
:

6162 
	`uÄegi¡”_as_ext2
();

6163 
	`uÄegi¡”_as_ext3
();

6164 
	`de¡roy_šodeÿche
();

6165 
out1
:

6166 
	`ext4_ex™_mb®loc
();

6167 
out2
:

6168 
	`ext4_ex™_sysfs
();

6169 
out3
:

6170 
	`ext4_ex™_sy¡em_zÚe
();

6171 
out4
:

6172 
	`ext4_ex™_·geio
();

6173 
out5
:

6174 
	`ext4_ex™_po¡_»ad_´oûssšg
();

6175 
out6
:

6176 
	`ext4_ex™_³ndšg
();

6177 
out7
:

6178 
	`ext4_ex™_es
();

6180  
”r
;

6181 
	}
}

6183 
__ex™
 
	$ext4_ex™_fs
()

6185 
	`ext4_de¡roy_Ïzyš™_th»ad
();

6186 
	`uÄegi¡”_as_ext2
();

6187 
	`uÄegi¡”_as_ext3
();

6188 
	`uÄegi¡”_fesy¡em
(&
ext4_fs_ty³
);

6189 
	`de¡roy_šodeÿche
();

6190 
	`ext4_ex™_mb®loc
();

6191 
	`ext4_ex™_sysfs
();

6192 
	`ext4_ex™_sy¡em_zÚe
();

6193 
	`ext4_ex™_·geio
();

6194 
	`ext4_ex™_po¡_»ad_´oûssšg
();

6195 
	`ext4_ex™_es
();

6196 
	`ext4_ex™_³ndšg
();

6197 
	}
}

6199 
MODULE_AUTHOR
("Remy Card, Stephen Tweedie, Andrew Morton, Andreas Dilger, Theodore Ts'o‡nd others");

6200 
MODULE_DESCRIPTION
("Fourth Extended Filesystem");

6201 
MODULE_LICENSE
("GPL");

6202 
MODULE_SOFTDEP
("pre: crc32c");

6203 
	$moduË_š™
(
ext4_š™_fs
)

6204 
	`moduË_ex™
(
ext4_ex™_fs
)

	@pxt4/symlink.c

21 
	~<lšux/fs.h
>

22 
	~<lšux/Çmei.h
>

23 
	~"ext4.h
"

24 
	~"x©Œ.h
"

26 cÚ¡ *
	$ext4_’üy±ed_g‘_lšk
(
d’Œy
 *dentry,

27 
šode
 *inode,

28 
d–ayed_ÿÎ
 *
dÚe
)

30 
·ge
 *
ıage
 = 
NULL
;

31 cÚ¡ *
ÿddr
;

32 
max_size
;

33 cÚ¡ *
·ddr
;

35 ià(!
d’Œy
)

36  
	`ERR_PTR
(-
ECHILD
);

38 ià(
	`ext4_šode_is_ç¡_symlšk
(
šode
)) {

39 
ÿddr
 = 
	`EXT4_I
(
šode
)->
i_d©a
;

40 
max_size
 = (
	`EXT4_I
(
šode
)->
i_d©a
);

42 
ıage
 = 
	`»ad_m­pšg_·ge
(
šode
->
i_m­pšg
, 0, 
NULL
);

43 ià(
	`IS_ERR
(
ıage
))

44  
	`ERR_CAST
(
ıage
);

45 
ÿddr
 = 
	`·ge_add»ss
(
ıage
);

46 
max_size
 = 
šode
->
i_sb
->
s_blocksize
;

49 
·ddr
 = 
	`fsüy±_g‘_symlšk
(
šode
, 
ÿddr
, 
max_size
, 
dÚe
);

50 ià(
ıage
)

51 
	`put_·ge
(
ıage
);

52  
·ddr
;

53 
	}
}

55 cÚ¡ 
šode_İ”©iÚs
 
	gext4_’üy±ed_symlšk_šode_İ”©iÚs
 = {

56 .
g‘_lšk
 = 
ext4_’üy±ed_g‘_lšk
,

57 .
	g£‰r
 = 
ext4_£‰r
,

58 .
	gg‘©Œ
 = 
ext4_g‘©Œ
,

59 .
	gli¡x©Œ
 = 
ext4_li¡x©Œ
,

62 cÚ¡ 
šode_İ”©iÚs
 
	gext4_symlšk_šode_İ”©iÚs
 = {

63 .
g‘_lšk
 = 
·ge_g‘_lšk
,

64 .
	g£‰r
 = 
ext4_£‰r
,

65 .
	gg‘©Œ
 = 
ext4_g‘©Œ
,

66 .
	gli¡x©Œ
 = 
ext4_li¡x©Œ
,

69 cÚ¡ 
šode_İ”©iÚs
 
	gext4_ç¡_symlšk_šode_İ”©iÚs
 = {

70 .
g‘_lšk
 = 
sim¶e_g‘_lšk
,

71 .
	g£‰r
 = 
ext4_£‰r
,

72 .
	gg‘©Œ
 = 
ext4_g‘©Œ
,

73 .
	gli¡x©Œ
 = 
ext4_li¡x©Œ
,

	@pxt4/sysfs.c

11 
	~<lšux/time.h
>

12 
	~<lšux/fs.h
>

13 
	~<lšux/£q_fe.h
>

14 
	~<lšux/¦ab.h
>

15 
	~<lšux/´oc_fs.h
>

17 
	~"ext4.h
"

18 
	~"ext4_jbd2.h
"

21 
	m©Œ_noİ
,

22 
	m©Œ_d–ayed_®loÿtiÚ_blocks
,

23 
	m©Œ_£ssiÚ_wr™e_kby‹s
,

24 
	m©Œ_liãtime_wr™e_kby‹s
,

25 
	m©Œ_»£rved_şu¡”s
,

26 
	m©Œ_šode_»adah—d
,

27 
	m©Œ_Œigg”_‹¡_”rÜ
,

28 
	m©Œ_fœ¡_”rÜ_time
,

29 
	m©Œ_Ï¡_”rÜ_time
,

30 
	m©Œ_ã©u»
,

31 
	m©Œ_poš‹r_ui
,

32 
	m©Œ_poš‹r_©omic
,

33 
	m©Œ_jouº®_sk
,

34 } 
	t©Œ_id_t
;

37 
	m±r_ex¶ic™
,

38 
	m±r_ext4_sb_šfo_off£t
,

39 
	m±r_ext4_su³r_block_off£t
,

40 } 
	t©Œ_±r_t
;

42 cÚ¡ 
	g´oc_dœÇme
[] = "fs/ext4";

43 
´oc_dœ_’Œy
 *
	gext4_´oc_roÙ
;

45 
	sext4_©Œ
 {

46 
©Œibu‹
 
	m©Œ
;

47 
	m©Œ_id
;

48 
	m©Œ_±r
;

50 
	moff£t
;

51 *
	mex¶ic™_±r
;

52 } 
	mu
;

55 
ssize_t
 
	$£ssiÚ_wr™e_kby‹s_show
(
ext4_sb_šfo
 *
sbi
, *
buf
)

57 
su³r_block
 *
sb
 = 
sbi
->
s_buddy_ÿche
->
i_sb
;

59 ià(!
sb
->
s_bdev
->
bd_·¹
)

60  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "0\n");

61  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%lu\n",

62 (
	`·¹_¡©_»ad
(
sb
->
s_bdev
->
bd_·¹
,

63 
£ùÜs
[
STAT_WRITE
]) -

64 
sbi
->
s_£ùÜs_wr™‹n_¡¬t
) >> 1);

65 
	}
}

67 
ssize_t
 
	$liãtime_wr™e_kby‹s_show
(
ext4_sb_šfo
 *
sbi
, *
buf
)

69 
su³r_block
 *
sb
 = 
sbi
->
s_buddy_ÿche
->
i_sb
;

71 ià(!
sb
->
s_bdev
->
bd_·¹
)

72  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "0\n");

73  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%llu\n",

74 ()(
sbi
->
s_kby‹s_wr™‹n
 +

75 ((
	`·¹_¡©_»ad
(
sb
->
s_bdev
->
bd_·¹
,

76 
£ùÜs
[
STAT_WRITE
]) -

77 
	`EXT4_SB
(
sb
)->
s_£ùÜs_wr™‹n_¡¬t
) >> 1)));

78 
	}
}

80 
ssize_t
 
	$šode_»adah—d_blks_¡Üe
(
ext4_sb_šfo
 *
sbi
,

81 cÚ¡ *
buf
, 
size_t
 
couÁ
)

83 
t
;

84 
»t
;

86 
»t
 = 
	`k¡¹oul
(
	`sk_¥aûs
(
buf
), 0, &
t
);

87 ià(
»t
)

88  
»t
;

90 ià(
t
 && (!
	`is_pow”_of_2
(t) || > 0x40000000))

91  -
EINVAL
;

93 
sbi
->
s_šode_»adah—d_blks
 = 
t
;

94  
couÁ
;

95 
	}
}

97 
ssize_t
 
	$»£rved_şu¡”s_¡Üe
(
ext4_sb_šfo
 *
sbi
,

98 cÚ¡ *
buf
, 
size_t
 
couÁ
)

100 
v®
;

101 
ext4_fsblk_t
 
şu¡”s
 = (
	`ext4_blocks_couÁ
(
sbi
->
s_es
) >>

102 
sbi
->
s_şu¡”_b™s
);

103 
»t
;

105 
»t
 = 
	`k¡¹ouÎ
(
	`sk_¥aûs
(
buf
), 0, &
v®
);

106 ià(
»t
 || 
v®
 >ğ
şu¡”s
)

107  -
EINVAL
;

109 
	`©omic64_£t
(&
sbi
->
s_»sv_şu¡”s
, 
v®
);

110  
couÁ
;

111 
	}
}

113 
ssize_t
 
	$Œigg”_‹¡_”rÜ
(
ext4_sb_šfo
 *
sbi
,

114 cÚ¡ *
buf
, 
size_t
 
couÁ
)

116 
Ën
 = 
couÁ
;

118 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

119  -
EPERM
;

121 ià(
Ën
 && 
buf
[len-1] == '\n')

122 
Ën
--;

124 ià(
Ën
)

125 
	`ext4_”rÜ
(
sbi
->
s_sb
, "%.*s", 
Ën
, 
buf
);

126  
couÁ
;

127 
	}
}

129 
ssize_t
 
	$jouº®_sk_show
(
ext4_sb_šfo
 *
sbi
, *
buf
)

131 ià(!
sbi
->
s_jouº®
)

132  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "<none>\n");

133  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%d\n",

134 
	`sk_pid_vÄ
(
sbi
->
s_jouº®
->
j_sk
));

135 
	}
}

137 
	#EXT4_ATTR
(
_Çme
,
_mode
,
_id
) \

138 
ext4_©Œ
 
ext4_©Œ_
##
_Çme
 = { \

139 .
©Œ
 = {.
Çme
 = 
	`__¡ršgify
(
_Çme
), .
mode
 = 
_mode
 }, \

140 .
©Œ_id
 = 
©Œ_
##
_id
, \

141 }

	)

143 
	#EXT4_ATTR_FUNC
(
_Çme
,
_mode
è
	`EXT4_ATTR
(_Çme,_mode,_Çme)

	)

145 
	#EXT4_ATTR_FEATURE
(
_Çme
è
	`EXT4_ATTR
(_Çme, 0444, 
ã©u»
)

	)

147 
	#EXT4_ATTR_OFFSET
(
_Çme
,
_mode
,
_id
,
_¡ruù
,
_–Çme
) \

148 
ext4_©Œ
 
ext4_©Œ_
##
_Çme
 = { \

149 .
©Œ
 = {.
Çme
 = 
	`__¡ršgify
(
_Çme
), .
mode
 = 
_mode
 }, \

150 .
©Œ_id
 = 
©Œ_
##
_id
, \

151 .
©Œ_±r
 = 
±r_
##
_¡ruù
##
_off£t
, \

152 .
u
 = { \

153 .
off£t
 = 
	`off£tof
(
_¡ruù
, 
_–Çme
),\

155 }

	)

157 
	#EXT4_RO_ATTR_ES_UI
(
_Çme
,
_–Çme
) \

158 
	`EXT4_ATTR_OFFSET
(
_Çme
, 0444, 
poš‹r_ui
, 
ext4_su³r_block
, 
_–Çme
)

	)

160 
	#EXT4_RW_ATTR_SBI_UI
(
_Çme
,
_–Çme
) \

161 
	`EXT4_ATTR_OFFSET
(
_Çme
, 0644, 
poš‹r_ui
, 
ext4_sb_šfo
, 
_–Çme
)

	)

163 
	#EXT4_ATTR_PTR
(
_Çme
,
_mode
,
_id
,
_±r
) \

164 
ext4_©Œ
 
ext4_©Œ_
##
_Çme
 = { \

165 .
©Œ
 = {.
Çme
 = 
	`__¡ršgify
(
_Çme
), .
mode
 = 
_mode
 }, \

166 .
©Œ_id
 = 
©Œ_
##
_id
, \

167 .
©Œ_±r
 = 
±r_ex¶ic™
, \

168 .
u
 = { \

169 .
ex¶ic™_±r
 = 
_±r
, \

171 }

	)

173 
	#ATTR_LIST
(
Çme
è&
ext4_©Œ_
##Çme.
©Œ


	)

175 
EXT4_ATTR_FUNC
(
d–ayed_®loÿtiÚ_blocks
, 0444);

176 
EXT4_ATTR_FUNC
(
£ssiÚ_wr™e_kby‹s
, 0444);

177 
EXT4_ATTR_FUNC
(
liãtime_wr™e_kby‹s
, 0444);

178 
EXT4_ATTR_FUNC
(
»£rved_şu¡”s
, 0644);

180 
EXT4_ATTR_OFFSET
(
šode_»adah—d_blks
, 0644, 
šode_»adah—d
,

181 
ext4_sb_šfo
, 
s_šode_»adah—d_blks
);

182 
EXT4_RW_ATTR_SBI_UI
(
šode_gßl
, 
s_šode_gßl
);

183 
EXT4_RW_ATTR_SBI_UI
(
mb_¡©s
, 
s_mb_¡©s
);

184 
EXT4_RW_ATTR_SBI_UI
(
mb_max_to_sÿn
, 
s_mb_max_to_sÿn
);

185 
EXT4_RW_ATTR_SBI_UI
(
mb_mš_to_sÿn
, 
s_mb_mš_to_sÿn
);

186 
EXT4_RW_ATTR_SBI_UI
(
mb_Üd”2_»q
, 
s_mb_Üd”2_»qs
);

187 
EXT4_RW_ATTR_SBI_UI
(
mb_¡»am_»q
, 
s_mb_¡»am_»que¡
);

188 
EXT4_RW_ATTR_SBI_UI
(
mb_group_´—Îoc
, 
s_mb_group_´—Îoc
);

189 
EXT4_RW_ATTR_SBI_UI
(
ex‹Á_max_z”oout_kb
, 
s_ex‹Á_max_z”oout_kb
);

190 
EXT4_ATTR
(
Œigg”_fs_”rÜ
, 0200, 
Œigg”_‹¡_”rÜ
);

191 
EXT4_RW_ATTR_SBI_UI
(
”r_¿‹lim™_š‹rv®_ms
, 
s_”r_¿‹lim™_¡©e
.
š‹rv®
);

192 
EXT4_RW_ATTR_SBI_UI
(
”r_¿‹lim™_bur¡
, 
s_”r_¿‹lim™_¡©e
.
bur¡
);

193 
EXT4_RW_ATTR_SBI_UI
(
w¬nšg_¿‹lim™_š‹rv®_ms
, 
s_w¬nšg_¿‹lim™_¡©e
.
š‹rv®
);

194 
EXT4_RW_ATTR_SBI_UI
(
w¬nšg_¿‹lim™_bur¡
, 
s_w¬nšg_¿‹lim™_¡©e
.
bur¡
);

195 
EXT4_RW_ATTR_SBI_UI
(
msg_¿‹lim™_š‹rv®_ms
, 
s_msg_¿‹lim™_¡©e
.
š‹rv®
);

196 
EXT4_RW_ATTR_SBI_UI
(
msg_¿‹lim™_bur¡
, 
s_msg_¿‹lim™_¡©e
.
bur¡
);

197 
EXT4_RO_ATTR_ES_UI
(
”rÜs_couÁ
, 
s_”rÜ_couÁ
);

198 
EXT4_ATTR
(
fœ¡_”rÜ_time
, 0444, first_error_time);

199 
EXT4_ATTR
(
Ï¡_”rÜ_time
, 0444,†ast_error_time);

200 
EXT4_ATTR
(
jouº®_sk
, 0444, journal_task);

202 
	gŞd_bump_v®
 = 128;

203 
EXT4_ATTR_PTR
(
max_wr™eback_mb_bump
, 0444, 
poš‹r_ui
, &
Şd_bump_v®
);

205 
©Œibu‹
 *
	gext4_©Œs
[] = {

206 
ATTR_LIST
(
d–ayed_®loÿtiÚ_blocks
),

207 
ATTR_LIST
(
£ssiÚ_wr™e_kby‹s
),

208 
ATTR_LIST
(
liãtime_wr™e_kby‹s
),

209 
ATTR_LIST
(
»£rved_şu¡”s
),

210 
ATTR_LIST
(
šode_»adah—d_blks
),

211 
ATTR_LIST
(
šode_gßl
),

212 
ATTR_LIST
(
mb_¡©s
),

213 
ATTR_LIST
(
mb_max_to_sÿn
),

214 
ATTR_LIST
(
mb_mš_to_sÿn
),

215 
ATTR_LIST
(
mb_Üd”2_»q
),

216 
ATTR_LIST
(
mb_¡»am_»q
),

217 
ATTR_LIST
(
mb_group_´—Îoc
),

218 
ATTR_LIST
(
max_wr™eback_mb_bump
),

219 
ATTR_LIST
(
ex‹Á_max_z”oout_kb
),

220 
ATTR_LIST
(
Œigg”_fs_”rÜ
),

221 
ATTR_LIST
(
”r_¿‹lim™_š‹rv®_ms
),

222 
ATTR_LIST
(
”r_¿‹lim™_bur¡
),

223 
ATTR_LIST
(
w¬nšg_¿‹lim™_š‹rv®_ms
),

224 
ATTR_LIST
(
w¬nšg_¿‹lim™_bur¡
),

225 
ATTR_LIST
(
msg_¿‹lim™_š‹rv®_ms
),

226 
ATTR_LIST
(
msg_¿‹lim™_bur¡
),

227 
ATTR_LIST
(
”rÜs_couÁ
),

228 
ATTR_LIST
(
fœ¡_”rÜ_time
),

229 
ATTR_LIST
(
Ï¡_”rÜ_time
),

230 
ATTR_LIST
(
jouº®_sk
),

231 
NULL
,

233 
ATTRIBUTE_GROUPS
(
ext4
);

236 
EXT4_ATTR_FEATURE
(
Ïzy_™abË_š™
);

237 
EXT4_ATTR_FEATURE
(
b©ched_disÿrd
);

238 
EXT4_ATTR_FEATURE
(
m‘a_bg_»size
);

239 #ifdeà
CONFIG_FS_ENCRYPTION


240 
EXT4_ATTR_FEATURE
(
’üy±iÚ
);

242 #ifdeà
CONFIG_UNICODE


243 
EXT4_ATTR_FEATURE
(
ÿ£fŞd
);

245 #ifdeà
CONFIG_FS_VERITY


246 
EXT4_ATTR_FEATURE
(
v”™y
);

248 
EXT4_ATTR_FEATURE
(
m‘ad©a_csum_£ed
);

250 
©Œibu‹
 *
	gext4_ã©_©Œs
[] = {

251 
ATTR_LIST
(
Ïzy_™abË_š™
),

252 
ATTR_LIST
(
b©ched_disÿrd
),

253 
ATTR_LIST
(
m‘a_bg_»size
),

254 #ifdeà
CONFIG_FS_ENCRYPTION


255 
ATTR_LIST
(
’üy±iÚ
),

257 #ifdeà
CONFIG_UNICODE


258 
ATTR_LIST
(
ÿ£fŞd
),

260 #ifdeà
CONFIG_FS_VERITY


261 
ATTR_LIST
(
v”™y
),

263 
ATTR_LIST
(
m‘ad©a_csum_£ed
),

264 
NULL
,

266 
ATTRIBUTE_GROUPS
(
ext4_ã©
);

268 *
	$ÿlc_±r
(
ext4_©Œ
 *
a
, 
ext4_sb_šfo
 *
sbi
)

270 
a
->
©Œ_±r
) {

271 
±r_ex¶ic™
:

272  
a
->
u
.
ex¶ic™_±r
;

273 
±r_ext4_sb_šfo_off£t
:

274  (*è(((*è
sbi
è+ 
a
->
u
.
off£t
);

275 
±r_ext4_su³r_block_off£t
:

276  (*è(((*è
sbi
->
s_es
è+ 
a
->
u
.
off£t
);

278  
NULL
;

279 
	}
}

281 
ssize_t
 
	$__´št_t¡amp
(*
buf
, 
__Ë32
 
lo
, 
__u8
 
hi
)

283  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%lld",

284 ((
time64_t
)
hi
 << 32è+ 
	`Ë32_to_ıu
(
lo
));

285 
	}
}

287 
	#´št_t¡amp
(
buf
, 
es
, 
t¡amp
) \

288 
	`__´št_t¡amp
(
buf
, (
es
)->
t¡amp
, (es)->t¡am°## 
_hi
)

	)

290 
ssize_t
 
	$ext4_©Œ_show
(
kobjeù
 *
kobj
,

291 
©Œibu‹
 *
©Œ
, *
buf
)

293 
ext4_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
kobj
, ext4_sb_info,

294 
s_kobj
);

295 
ext4_©Œ
 *
a
 = 
	`cÚš”_of
(
©Œ
, ext4_attr,‡ttr);

296 *
±r
 = 
	`ÿlc_±r
(
a
, 
sbi
);

298 
a
->
©Œ_id
) {

299 
©Œ_d–ayed_®loÿtiÚ_blocks
:

300  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%llu\n",

301 (
s64
è
	`EXT4_C2B
(
sbi
,

302 
	`³rıu_couÁ”_sum
(&
sbi
->
s_dœtyşu¡”s_couÁ”
)));

303 
©Œ_£ssiÚ_wr™e_kby‹s
:

304  
	`£ssiÚ_wr™e_kby‹s_show
(
sbi
, 
buf
);

305 
©Œ_liãtime_wr™e_kby‹s
:

306  
	`liãtime_wr™e_kby‹s_show
(
sbi
, 
buf
);

307 
©Œ_»£rved_şu¡”s
:

308  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%llu\n",

310 
	`©omic64_»ad
(&
sbi
->
s_»sv_şu¡”s
));

311 
©Œ_šode_»adah—d
:

312 
©Œ_poš‹r_ui
:

313 ià(!
±r
)

315 ià(
a
->
©Œ_±r
 =ğ
±r_ext4_su³r_block_off£t
)

316  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%u\n",

317 
	`Ë32_to_ıup
(
±r
));

319  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%u\n",

320 *((*è
±r
));

321 
©Œ_poš‹r_©omic
:

322 ià(!
±r
)

324  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%d\n",

325 
	`©omic_»ad
((
©omic_t
 *è
±r
));

326 
©Œ_ã©u»
:

327  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "supported\n");

328 
©Œ_fœ¡_”rÜ_time
:

329  
	`´št_t¡amp
(
buf
, 
sbi
->
s_es
, 
s_fœ¡_”rÜ_time
);

330 
©Œ_Ï¡_”rÜ_time
:

331  
	`´št_t¡amp
(
buf
, 
sbi
->
s_es
, 
s_Ï¡_”rÜ_time
);

332 
©Œ_jouº®_sk
:

333  
	`jouº®_sk_show
(
sbi
, 
buf
);

337 
	}
}

339 
ssize_t
 
	$ext4_©Œ_¡Üe
(
kobjeù
 *
kobj
,

340 
©Œibu‹
 *
©Œ
,

341 cÚ¡ *
buf
, 
size_t
 
Ën
)

343 
ext4_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
kobj
, ext4_sb_info,

344 
s_kobj
);

345 
ext4_©Œ
 *
a
 = 
	`cÚš”_of
(
©Œ
, ext4_attr,‡ttr);

346 *
±r
 = 
	`ÿlc_±r
(
a
, 
sbi
);

347 
t
;

348 
»t
;

350 
a
->
©Œ_id
) {

351 
©Œ_»£rved_şu¡”s
:

352  
	`»£rved_şu¡”s_¡Üe
(
sbi
, 
buf
, 
Ën
);

353 
©Œ_poš‹r_ui
:

354 ià(!
±r
)

356 
»t
 = 
	`k¡¹oul
(
	`sk_¥aûs
(
buf
), 0, &
t
);

357 ià(
»t
)

358  
»t
;

359 ià(
a
->
©Œ_±r
 =ğ
±r_ext4_su³r_block_off£t
)

360 *((
__Ë32
 *è
±r
èğ
	`ıu_to_Ë32
(
t
);

362 *((*è
±r
èğ
t
;

363  
Ën
;

364 
©Œ_šode_»adah—d
:

365  
	`šode_»adah—d_blks_¡Üe
(
sbi
, 
buf
, 
Ën
);

366 
©Œ_Œigg”_‹¡_”rÜ
:

367  
	`Œigg”_‹¡_”rÜ
(
sbi
, 
buf
, 
Ën
);

370 
	}
}

372 
	$ext4_sb_»Ëa£
(
kobjeù
 *
kobj
)

374 
ext4_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
kobj
, ext4_sb_info,

375 
s_kobj
);

376 
	`com¶‘e
(&
sbi
->
s_kobj_uÄegi¡”
);

377 
	}
}

379 cÚ¡ 
sysfs_İs
 
	gext4_©Œ_İs
 = {

380 .
show
 = 
ext4_©Œ_show
,

381 .
	g¡Üe
 = 
ext4_©Œ_¡Üe
,

384 
kobj_ty³
 
	gext4_sb_kty³
 = {

385 .
deçuÉ_groups
 = 
ext4_groups
,

386 .
	gsysfs_İs
 = &
ext4_©Œ_İs
,

387 .
	g»Ëa£
 = 
ext4_sb_»Ëa£
,

390 
kobj_ty³
 
	gext4_ã©_kty³
 = {

391 .
deçuÉ_groups
 = 
ext4_ã©_groups
,

392 .
	gsysfs_İs
 = &
ext4_©Œ_İs
,

393 .
	g»Ëa£
 = ((*)(
kobjeù
 *))
kä“
,

396 
kobjeù
 *
	gext4_roÙ
;

398 
kobjeù
 *
	gext4_ã©
;

400 
	$ext4_»gi¡”_sysfs
(
su³r_block
 *
sb
)

402 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

403 
”r
;

405 
	`š™_com¶‘iÚ
(&
sbi
->
s_kobj_uÄegi¡”
);

406 
”r
 = 
	`kobjeù_š™_ªd_add
(&
sbi
->
s_kobj
, &
ext4_sb_kty³
, 
ext4_roÙ
,

407 "%s", 
sb
->
s_id
);

408 ià(
”r
) {

409 
	`kobjeù_put
(&
sbi
->
s_kobj
);

410 
	`wa™_fÜ_com¶‘iÚ
(&
sbi
->
s_kobj_uÄegi¡”
);

411  
”r
;

414 ià(
ext4_´oc_roÙ
)

415 
sbi
->
s_´oc
 = 
	`´oc_mkdœ
(
sb
->
s_id
, 
ext4_´oc_roÙ
);

416 ià(
sbi
->
s_´oc
) {

417 
	`´oc_ü—‹_sšgË_d©a
("İtiÚs", 
S_IRUGO
, 
sbi
->
s_´oc
,

418 
ext4_£q_İtiÚs_show
, 
sb
);

419 
	`´oc_ü—‹_sšgË_d©a
("es_shršk”_šfo", 
S_IRUGO
,

420 
sbi
->
s_´oc
, 
ext4_£q_es_shršk”_šfo_show
,

421 
sb
);

422 
	`´oc_ü—‹_£q_d©a
("mb_groups", 
S_IRUGO
, 
sbi
->
s_´oc
,

423 &
ext4_mb_£q_groups_İs
, 
sb
);

426 
	}
}

428 
	$ext4_uÄegi¡”_sysfs
(
su³r_block
 *
sb
)

430 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

432 ià(
sbi
->
s_´oc
)

433 
	`»move_´oc_subŒ“
(
sb
->
s_id
, 
ext4_´oc_roÙ
);

434 
	`kobjeù_d–
(&
sbi
->
s_kobj
);

435 
	}
}

437 
__š™
 
	$ext4_š™_sysfs
()

439 
»t
;

441 
ext4_roÙ
 = 
	`kobjeù_ü—‹_ªd_add
("ext4", 
fs_kobj
);

442 ià(!
ext4_roÙ
)

443  -
ENOMEM
;

445 
ext4_ã©
 = 
	`kz®loc
((*ext4_ã©), 
GFP_KERNEL
);

446 ià(!
ext4_ã©
) {

447 
»t
 = -
ENOMEM
;

448 
roÙ_”r
;

451 
»t
 = 
	`kobjeù_š™_ªd_add
(
ext4_ã©
, &
ext4_ã©_kty³
,

452 
ext4_roÙ
, "features");

453 ià(
»t
)

454 
ã©_”r
;

456 
ext4_´oc_roÙ
 = 
	`´oc_mkdœ
(
´oc_dœÇme
, 
NULL
);

457  
»t
;

459 
ã©_”r
:

460 
	`kobjeù_put
(
ext4_ã©
);

461 
ext4_ã©
 = 
NULL
;

462 
roÙ_”r
:

463 
	`kobjeù_put
(
ext4_roÙ
);

464 
ext4_roÙ
 = 
NULL
;

465  
»t
;

466 
	}
}

468 
	$ext4_ex™_sysfs
()

470 
	`kobjeù_put
(
ext4_ã©
);

471 
ext4_ã©
 = 
NULL
;

472 
	`kobjeù_put
(
ext4_roÙ
);

473 
ext4_roÙ
 = 
NULL
;

474 
	`»move_´oc_’Œy
(
´oc_dœÇme
, 
NULL
);

475 
ext4_´oc_roÙ
 = 
NULL
;

476 
	}
}

	@pxt4/truncate.h

12 
šlše
 
	$ext4_Œunÿ‹_çed_wr™e
(
šode
 *inode)

18 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

19 
	`Œunÿ‹_šode_·ges
(
šode
->
i_m­pšg
, inode->
i_size
);

20 
	`ext4_Œunÿ‹
(
šode
);

21 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

22 
	}
}

28 
šlše
 
	$ext4_blocks_fÜ_Œunÿ‹
(
šode
 *inode)

30 
ext4_lblk_t
 
Ãeded
;

32 
Ãeded
 = 
šode
->
i_blocks
 >> (šode->
i_sb
->
s_blocksize_b™s
 - 9);

40 ià(
Ãeded
 < 2)

41 
Ãeded
 = 2;

45 ià(
Ãeded
 > 
EXT4_MAX_TRANS_DATA
)

46 
Ãeded
 = 
EXT4_MAX_TRANS_DATA
;

48  
	`EXT4_DATA_TRANS_BLOCKS
(
šode
->
i_sb
è+ 
Ãeded
;

49 
	}
}

	@pxt4/verity.c

26 
	~<lšux/quÙaİs.h
>

28 
	~"ext4.h
"

29 
	~"ext4_ex‹Ás.h
"

30 
	~"ext4_jbd2.h
"

32 
šlše
 
loff_t
 
	$ext4_v”™y_m‘ad©a_pos
(cÚ¡ 
šode
 *inode)

34  
	`round_up
(
šode
->
i_size
, 65536);

35 
	}
}

41 
	$·geÿche_»ad
(
šode
 *šode, *
buf
, 
size_t
 
couÁ
,

42 
loff_t
 
pos
)

44 
couÁ
) {

45 
size_t
 
n
 = 
	`mš_t
(size_t, 
couÁ
,

46 
PAGE_SIZE
 - 
	`off£t_š_·ge
(
pos
));

47 
·ge
 *page;

48 *
addr
;

50 
·ge
 = 
	`»ad_m­pšg_·ge
(
šode
->
i_m­pšg
, 
pos
 >> 
PAGE_SHIFT
,

51 
NULL
);

52 ià(
	`IS_ERR
(
·ge
))

53  
	`PTR_ERR
(
·ge
);

55 
addr
 = 
	`km­_©omic
(
·ge
);

56 
	`memıy
(
buf
, 
addr
 + 
	`off£t_š_·ge
(
pos
), 
n
);

57 
	`kunm­_©omic
(
addr
);

59 
	`put_·ge
(
·ge
);

61 
buf
 +ğ
n
;

62 
pos
 +ğ
n
;

63 
couÁ
 -ğ
n
;

66 
	}
}

72 
	$·geÿche_wr™e
(
šode
 *šode, cÚ¡ *
buf
, 
size_t
 
couÁ
,

73 
loff_t
 
pos
)

75 ià(
pos
 + 
couÁ
 > 
šode
->
i_sb
->
s_maxby‹s
)

76  -
EFBIG
;

78 
couÁ
) {

79 
size_t
 
n
 = 
	`mš_t
(size_t, 
couÁ
,

80 
PAGE_SIZE
 - 
	`off£t_š_·ge
(
pos
));

81 
·ge
 *page;

82 *
fsd©a
;

83 *
addr
;

84 
»s
;

86 
»s
 = 
	`·geÿche_wr™e_begš
(
NULL
, 
šode
->
i_m­pšg
, 
pos
, 
n
, 0,

87 &
·ge
, &
fsd©a
);

88 ià(
»s
)

89  
»s
;

91 
addr
 = 
	`km­_©omic
(
·ge
);

92 
	`memıy
(
addr
 + 
	`off£t_š_·ge
(
pos
), 
buf
, 
n
);

93 
	`kunm­_©omic
(
addr
);

95 
»s
 = 
	`·geÿche_wr™e_’d
(
NULL
, 
šode
->
i_m­pšg
, 
pos
, 
n
,‚,

96 
·ge
, 
fsd©a
);

97 ià(
»s
 < 0)

98  
»s
;

99 ià(
»s
 !ğ
n
)

100  -
EIO
;

102 
buf
 +ğ
n
;

103 
pos
 +ğ
n
;

104 
couÁ
 -ğ
n
;

107 
	}
}

109 
	$ext4_begš_’abË_v”™y
(
fe
 *
fp
)

111 
šode
 *šodğ
	`fe_šode
(
fp
);

112 cÚ¡ 
üed™s
 = 2;

113 
hªdË_t
 *
hªdË
;

114 
”r
;

116 ià(
	`ext4_v”™y_š_´og»ss
(
šode
))

117  -
EBUSY
;

125 
”r
 = 
	`ext4_šode_©ch_jšode
(
šode
);

126 ià(
”r
)

127  
”r
;

129 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

130 ià(
”r
)

131  
”r
;

133 
”r
 = 
	`ext4_cÚv”t_šlše_d©a
(
šode
);

134 ià(
”r
)

135  
”r
;

137 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)) {

138 
	`ext4_w¬nšg_šode
(
šode
,

140  -
EOPNOTSUPP
;

147 
”r
 = 
	`ext4_Œunÿ‹
(
šode
);

148 ià(
”r
)

149  
”r
;

151 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 
üed™s
);

152 ià(
	`IS_ERR
(
hªdË
))

153  
	`PTR_ERR
(
hªdË
);

155 
”r
 = 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

156 ià(
”r
 == 0)

157 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_VERITY_IN_PROGRESS
);

159 
	`ext4_jouº®_¡İ
(
hªdË
);

160  
”r
;

161 
	}
}

175 
	$ext4_wr™e_v”™y_desütÜ
(
šode
 *šode, cÚ¡ *
desc
,

176 
size_t
 
desc_size
, 
u64
 
m”kË_Œ“_size
)

178 cÚ¡ 
u64
 
desc_pos
 = 
	`round_up
(
	`ext4_v”™y_m‘ad©a_pos
(
šode
) +

179 
m”kË_Œ“_size
, 
	`i_blocksize
(
šode
));

180 cÚ¡ 
u64
 
desc_’d
 = 
desc_pos
 + 
desc_size
;

181 cÚ¡ 
__Ë32
 
desc_size_disk
 = 
	`ıu_to_Ë32
(
desc_size
);

182 cÚ¡ 
u64
 
desc_size_pos
 = 
	`round_up
(
desc_’d
 + (
desc_size_disk
),

183 
	`i_blocksize
(
šode
)) -

184 (
desc_size_disk
);

185 
”r
;

187 
”r
 = 
	`·geÿche_wr™e
(
šode
, 
desc
, 
desc_size
, 
desc_pos
);

188 ià(
”r
)

189  
”r
;

191  
	`·geÿche_wr™e
(
šode
, &
desc_size_disk
, (desc_size_disk),

192 
desc_size_pos
);

193 
	}
}

195 
	$ext4_’d_’abË_v”™y
(
fe
 *
fp
, cÚ¡ *
desc
,

196 
size_t
 
desc_size
, 
u64
 
m”kË_Œ“_size
)

198 
šode
 *šodğ
	`fe_šode
(
fp
);

199 cÚ¡ 
üed™s
 = 2;

200 
hªdË_t
 *
hªdË
;

201 
”r
 = 0;

202 
”r2
;

204 ià(
desc
 !ğ
NULL
) {

206 
”r
 = 
	`ext4_wr™e_v”™y_desütÜ
(
šode
, 
desc
, 
desc_size
,

207 
m”kË_Œ“_size
);

210 ià(!
”r
)

211 
”r
 = 
	`fem­_wr™e_ªd_wa™
(
šode
->
i_m­pšg
);

215 ià(
desc
 =ğ
NULL
 || 
”r
)

216 
	`ext4_Œunÿ‹
(
šode
);

225 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_VERITY_IN_PROGRESS
);

227 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 
üed™s
);

228 ià(
	`IS_ERR
(
hªdË
)) {

229 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

230  
	`PTR_ERR
(
hªdË
);

233 
”r2
 = 
	`ext4_Üphª_d–
(
hªdË
, 
šode
);

234 ià(
”r2
)

235 
out_¡İ
;

237 ià(
desc
 !ğ
NULL
 && !
”r
) {

238 
ext4_oc
 
oc
;

240 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
);

241 ià(
”r
)

242 
out_¡İ
;

243 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_VERITY
);

244 
	`ext4_£t_šode_æags
(
šode
);

245 
”r
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

247 
out_¡İ
:

248 
	`ext4_jouº®_¡İ
(
hªdË
);

249  
”r
 ?: 
”r2
;

250 
	}
}

252 
	$ext4_g‘_v”™y_desütÜ_loÿtiÚ
(
šode
 *inode,

253 
size_t
 *
desc_size_»t
,

254 
u64
 *
desc_pos_»t
)

256 
ext4_ext_·th
 *
·th
;

257 
ext4_ex‹Á
 *
Ï¡_ex‹Á
;

258 
u32
 
’d_lblk
;

259 
u64
 
desc_size_pos
;

260 
__Ë32
 
desc_size_disk
;

261 
u32
 
desc_size
;

262 
u64
 
desc_pos
;

263 
”r
;

270 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)) {

271 
	`EXT4_ERROR_INODE
(
šode
, "verity file doesn't useƒxtents");

272  -
EFSCORRUPTED
;

275 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
EXT_MAX_BLOCKS
 - 1, 
NULL
, 0);

276 ià(
	`IS_ERR
(
·th
))

277  
	`PTR_ERR
(
·th
);

279 
Ï¡_ex‹Á
 = 
·th
[·th->
p_d•th
].
p_ext
;

280 ià(!
Ï¡_ex‹Á
) {

281 
	`EXT4_ERROR_INODE
(
šode
, "verity file has‚oƒxtents");

282 
	`ext4_ext_drİ_»fs
(
·th
);

283 
	`kä“
(
·th
);

284  -
EFSCORRUPTED
;

287 
’d_lblk
 = 
	`Ë32_to_ıu
(
Ï¡_ex‹Á
->
“_block
) +

288 
	`ext4_ext_g‘_aùu®_Ën
(
Ï¡_ex‹Á
);

289 
desc_size_pos
 = (
u64
)
’d_lblk
 << 
šode
->
i_blkb™s
;

290 
	`ext4_ext_drİ_»fs
(
·th
);

291 
	`kä“
(
·th
);

293 ià(
desc_size_pos
 < (
desc_size_disk
))

294 
bad
;

295 
desc_size_pos
 -ğ(
desc_size_disk
);

297 
”r
 = 
	`·geÿche_»ad
(
šode
, &
desc_size_disk
, (desc_size_disk),

298 
desc_size_pos
);

299 ià(
”r
)

300  
”r
;

301 
desc_size
 = 
	`Ë32_to_ıu
(
desc_size_disk
);

308 ià(
desc_size
 > 
INT_MAX
 || desc_siz> 
desc_size_pos
)

309 
bad
;

311 
desc_pos
 = 
	`round_down
(
desc_size_pos
 - 
desc_size
, 
	`i_blocksize
(
šode
));

312 ià(
desc_pos
 < 
	`ext4_v”™y_m‘ad©a_pos
(
šode
))

313 
bad
;

315 *
desc_size_»t
 = 
desc_size
;

316 *
desc_pos_»t
 = 
desc_pos
;

319 
bad
:

320 
	`EXT4_ERROR_INODE
(
šode
, "verity file corrupted; can't find descriptor");

321  -
EFSCORRUPTED
;

322 
	}
}

324 
	$ext4_g‘_v”™y_desütÜ
(
šode
 *šode, *
buf
,

325 
size_t
 
buf_size
)

327 
size_t
 
desc_size
 = 0;

328 
u64
 
desc_pos
 = 0;

329 
”r
;

331 
”r
 = 
	`ext4_g‘_v”™y_desütÜ_loÿtiÚ
(
šode
, &
desc_size
, &
desc_pos
);

332 ià(
”r
)

333  
”r
;

335 ià(
buf_size
) {

336 ià(
desc_size
 > 
buf_size
)

337  -
ERANGE
;

338 
”r
 = 
	`·geÿche_»ad
(
šode
, 
buf
, 
desc_size
, 
desc_pos
);

339 ià(
”r
)

340  
”r
;

342  
desc_size
;

343 
	}
}

345 
·ge
 *
	$ext4_»ad_m”kË_Œ“_·ge
(
šode
 *inode,

346 
pgoff_t
 
šdex
)

348 
šdex
 +ğ
	`ext4_v”™y_m‘ad©a_pos
(
šode
è>> 
PAGE_SHIFT
;

350  
	`»ad_m­pšg_·ge
(
šode
->
i_m­pšg
, 
šdex
, 
NULL
);

351 
	}
}

353 
	$ext4_wr™e_m”kË_Œ“_block
(
šode
 *šode, cÚ¡ *
buf
,

354 
u64
 
šdex
, 
log_blocksize
)

356 
loff_t
 
pos
 = 
	`ext4_v”™y_m‘ad©a_pos
(
šode
è+ (
šdex
 << 
log_blocksize
);

358  
	`·geÿche_wr™e
(
šode
, 
buf
, 1 << 
log_blocksize
, 
pos
);

359 
	}
}

361 cÚ¡ 
fsv”™y_İ”©iÚs
 
	gext4_v”™yİs
 = {

362 .
begš_’abË_v”™y
 = 
ext4_begš_’abË_v”™y
,

363 .
	g’d_’abË_v”™y
 = 
ext4_’d_’abË_v”™y
,

364 .
	gg‘_v”™y_desütÜ
 = 
ext4_g‘_v”™y_desütÜ
,

365 .
	g»ad_m”kË_Œ“_·ge
 = 
ext4_»ad_m”kË_Œ“_·ge
,

366 .
	gwr™e_m”kË_Œ“_block
 = 
ext4_wr™e_m”kË_Œ“_block
,

	@pxt4/xattr.c

54 
	~<lšux/š™.h
>

55 
	~<lšux/fs.h
>

56 
	~<lšux/¦ab.h
>

57 
	~<lšux/mbÿche.h
>

58 
	~<lšux/quÙaİs.h
>

59 
	~<lšux/iv”siÚ.h
>

60 
	~"ext4_jbd2.h
"

61 
	~"ext4.h
"

62 
	~"x©Œ.h
"

63 
	~"aş.h
"

65 #ifdeà
EXT4_XATTR_DEBUG


66 
	#—_idebug
(
šode
, 
fmt
, ...) \

67 
	`´štk
(
KERN_DEBUG
 "šod%s:%lu: " 
fmt
 "\n", \

68 
šode
->
i_sb
->
s_id
, inode->
i_šo
, ##
__VA_ARGS__
)

	)

69 
	#—_bdebug
(
bh
, 
fmt
, ...) \

70 
	`´štk
(
KERN_DEBUG
 "block %pg:%lu: " 
fmt
 "\n", \

71 
bh
->
b_bdev
, ()bh->
b_blockÄ
, ##
__VA_ARGS__
)

	)

73 
	#—_idebug
(
šode
, 
fmt
, ...è
	`no_´štk
(fmt, ##
__VA_ARGS__
)

	)

74 
	#—_bdebug
(
bh
, 
fmt
, ...è
	`no_´štk
(fmt, ##
__VA_ARGS__
)

	)

77 
ext4_x©Œ_block_ÿche_š£¹
(
mb_ÿche
 *,

78 
bufãr_h—d
 *);

79 
bufãr_h—d
 *

80 
ext4_x©Œ_block_ÿche_fšd
(
šode
 *, 
ext4_x©Œ_h—d”
 *,

81 
mb_ÿche_’Œy
 **);

82 
__Ë32
 
ext4_x©Œ_hash_’Œy
(*
Çme
, 
size_t
 
Çme_Ën
, __Ë32 *
v®ue
,

83 
size_t
 
v®ue_couÁ
);

84 
ext4_x©Œ_»hash
(
ext4_x©Œ_h—d”
 *);

86 cÚ¡ 
x©Œ_hªdËr
 * cÚ¡ 
	gext4_x©Œ_hªdËr_m­
[] = {

87 [
EXT4_XATTR_INDEX_USER
] = &
ext4_x©Œ_u£r_hªdËr
,

88 #ifdeà
CONFIG_EXT4_FS_POSIX_ACL


89 [
EXT4_XATTR_INDEX_POSIX_ACL_ACCESS
] = &
posix_aş_acûss_x©Œ_hªdËr
,

90 [
EXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
] = &
posix_aş_deçuÉ_x©Œ_hªdËr
,

92 [
EXT4_XATTR_INDEX_TRUSTED
] = &
ext4_x©Œ_Œu¡ed_hªdËr
,

93 #ifdeà
CONFIG_EXT4_FS_SECURITY


94 [
EXT4_XATTR_INDEX_SECURITY
] = &
ext4_x©Œ_£cur™y_hªdËr
,

98 cÚ¡ 
x©Œ_hªdËr
 *
	gext4_x©Œ_hªdËrs
[] = {

99 &
ext4_x©Œ_u£r_hªdËr
,

100 &
ext4_x©Œ_Œu¡ed_hªdËr
,

101 #ifdeà
CONFIG_EXT4_FS_POSIX_ACL


102 &
posix_aş_acûss_x©Œ_hªdËr
,

103 &
posix_aş_deçuÉ_x©Œ_hªdËr
,

105 #ifdeà
CONFIG_EXT4_FS_SECURITY


106 &
ext4_x©Œ_£cur™y_hªdËr
,

108 
NULL


111 
	#EA_BLOCK_CACHE
(
šode
è(((
ext4_sb_šfo
 *) \

112 
šode
->
i_sb
->
s_fs_šfo
)->
s_—_block_ÿche
)

	)

114 
	#EA_INODE_CACHE
(
šode
è(((
ext4_sb_šfo
 *) \

115 
šode
->
i_sb
->
s_fs_šfo
)->
s_—_šode_ÿche
)

	)

118 
ext4_ex·nd_šode_¬¿y
(
ext4_x©Œ_šode_¬¿y
 **
—_šode_¬¿y
,

119 
šode
 *inode);

121 #ifdeà
CONFIG_LOCKDEP


122 
	$ext4_x©Œ_šode_£t_şass
(
šode
 *
—_šode
)

124 
	`lockd•_£t_subşass
(&
—_šode
->
i_rw£m
, 1);

125 
	}
}

128 
__Ë32
 
	$ext4_x©Œ_block_csum
(
šode
 *inode,

129 
£ùÜ_t
 
block_Ä
,

130 
ext4_x©Œ_h—d”
 *
hdr
)

132 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

133 
__u32
 
csum
;

134 
__Ë64
 
dsk_block_Ä
 = 
	`ıu_to_Ë64
(
block_Ä
);

135 
__u32
 
dummy_csum
 = 0;

136 
off£t
 = 
	`off£tof
(
ext4_x©Œ_h—d”
, 
h_checksum
);

138 
csum
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
dsk_block_Ä
,

139 (
dsk_block_Ä
));

140 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)
hdr
, 
off£t
);

141 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, (dummy_csum));

142 
off£t
 +ğ(
dummy_csum
);

143 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)
hdr
 + 
off£t
,

144 
	`EXT4_BLOCK_SIZE
(
šode
->
i_sb
è- 
off£t
);

146  
	`ıu_to_Ë32
(
csum
);

147 
	}
}

149 
	$ext4_x©Œ_block_csum_v”ify
(
šode
 *inode,

150 
bufãr_h—d
 *
bh
)

152 
ext4_x©Œ_h—d”
 *
hdr
 = 
	`BHDR
(
bh
);

153 
»t
 = 1;

155 ià(
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
)) {

156 
	`lock_bufãr
(
bh
);

157 
»t
 = (
hdr
->
h_checksum
 =ğ
	`ext4_x©Œ_block_csum
(
šode
,

158 
bh
->
b_blockÄ
, 
hdr
));

159 
	`uÆock_bufãr
(
bh
);

161  
»t
;

162 
	}
}

164 
	$ext4_x©Œ_block_csum_£t
(
šode
 *inode,

165 
bufãr_h—d
 *
bh
)

167 ià(
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

168 
	`BHDR
(
bh
)->
h_checksum
 = 
	`ext4_x©Œ_block_csum
(
šode
,

169 
bh
->
b_blockÄ
, 
	`BHDR
(bh));

170 
	}
}

172 
šlše
 cÚ¡ 
x©Œ_hªdËr
 *

173 
	$ext4_x©Œ_hªdËr
(
Çme_šdex
)

175 cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
 = 
NULL
;

177 ià(
Çme_šdex
 > 0 &&‚ame_šdex < 
	`ARRAY_SIZE
(
ext4_x©Œ_hªdËr_m­
))

178 
hªdËr
 = 
ext4_x©Œ_hªdËr_m­
[
Çme_šdex
];

179  
hªdËr
;

180 
	}
}

183 
	$ext4_x©Œ_check_’Œ›s
(
ext4_x©Œ_’Œy
 *
’Œy
, *
’d
,

184 *
v®ue_¡¬t
)

186 
ext4_x©Œ_’Œy
 *
e
 = 
’Œy
;

189 !
	`IS_LAST_ENTRY
(
e
)) {

190 
ext4_x©Œ_’Œy
 *
Ãxt
 = 
	`EXT4_XATTR_NEXT
(
e
);

191 ià((*)
Ãxt
 >ğ
’d
)

192  -
EFSCORRUPTED
;

193 ià(
	`¡ºËn
(
e
->
e_Çme
,ƒ->
e_Çme_Ën
) !=ƒ->e_name_len)

194  -
EFSCORRUPTED
;

195 
e
 = 
Ãxt
;

199 !
	`IS_LAST_ENTRY
(
’Œy
)) {

200 
u32
 
size
 = 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
);

202 ià(
size
 > 
EXT4_XATTR_SIZE_MAX
)

203  -
EFSCORRUPTED
;

205 ià(
size
 !ğ0 && 
’Œy
->
e_v®ue_šum
 == 0) {

206 
u16
 
offs
 = 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_offs
);

207 *
v®ue
;

215 ià(
offs
 > 
’d
 - 
v®ue_¡¬t
)

216  -
EFSCORRUPTED
;

217 
v®ue
 = 
v®ue_¡¬t
 + 
offs
;

218 ià(
v®ue
 < (*)
e
 + (
u32
) ||

219 
size
 > 
’d
 - 
v®ue
 ||

220 
	`EXT4_XATTR_SIZE
(
size
è> 
’d
 - 
v®ue
)

221  -
EFSCORRUPTED
;

223 
’Œy
 = 
	`EXT4_XATTR_NEXT
(entry);

227 
	}
}

229 
šlše
 

230 
	$__ext4_x©Œ_check_block
(
šode
 *šode, 
bufãr_h—d
 *
bh
,

231 cÚ¡ *
funùiÚ
, 
lše
)

233 
”rÜ
 = -
EFSCORRUPTED
;

235 ià(
	`BHDR
(
bh
)->
h_magic
 !ğ
	`ıu_to_Ë32
(
EXT4_XATTR_MAGIC
) ||

236 
	`BHDR
(
bh
)->
h_blocks
 !ğ
	`ıu_to_Ë32
(1))

237 
”rout
;

238 ià(
	`bufãr_v”if›d
(
bh
))

241 
”rÜ
 = -
EFSBADCRC
;

242 ià(!
	`ext4_x©Œ_block_csum_v”ify
(
šode
, 
bh
))

243 
”rout
;

244 
”rÜ
 = 
	`ext4_x©Œ_check_’Œ›s
(
	`BFIRST
(
bh
), bh->
b_d©a
 + bh->
b_size
,

245 
bh
->
b_d©a
);

246 
”rout
:

247 ià(
”rÜ
)

248 
	`__ext4_”rÜ_šode
(
šode
, 
funùiÚ
, 
lše
, 0,

250 (è
bh
->
b_blockÄ
);

252 
	`£t_bufãr_v”if›d
(
bh
);

253  
”rÜ
;

254 
	}
}

256 
	#ext4_x©Œ_check_block
(
šode
, 
bh
) \

257 
	`__ext4_x©Œ_check_block
((
šode
), (
bh
), 
__func__
, 
__LINE__
)

	)

261 
	$__x©Œ_check_šode
(
šode
 *šode, 
ext4_x©Œ_ibody_h—d”
 *
h—d”
,

262 *
’d
, cÚ¡ *
funùiÚ
, 
lše
)

264 
”rÜ
 = -
EFSCORRUPTED
;

266 ià(
’d
 - (*)
h—d”
 < (*h—d”è+ (
u32
) ||

267 (
h—d”
->
h_magic
 !ğ
	`ıu_to_Ë32
(
EXT4_XATTR_MAGIC
)))

268 
”rout
;

269 
”rÜ
 = 
	`ext4_x©Œ_check_’Œ›s
(
	`IFIRST
(
h—d”
), 
’d
, IFIRST(header));

270 
”rout
:

271 ià(
”rÜ
)

272 
	`__ext4_”rÜ_šode
(
šode
, 
funùiÚ
, 
lše
, 0,

274  
”rÜ
;

275 
	}
}

277 
	#x©Œ_check_šode
(
šode
, 
h—d”
, 
’d
) \

278 
	`__x©Œ_check_šode
((
šode
), (
h—d”
), (
’d
), 
__func__
, 
__LINE__
)

	)

281 
	$x©Œ_fšd_’Œy
(
šode
 *šode, 
ext4_x©Œ_’Œy
 **
³Áry
,

282 *
’d
, 
Çme_šdex
, cÚ¡ *
Çme
, 
sÜ‹d
)

284 
ext4_x©Œ_’Œy
 *
’Œy
, *
Ãxt
;

285 
size_t
 
Çme_Ën
;

286 
cmp
 = 1;

288 ià(
Çme
 =ğ
NULL
)

289  -
EINVAL
;

290 
Çme_Ën
 = 
	`¡¾’
(
Çme
);

291 
’Œy
 = *
³Áry
; !
	`IS_LAST_ENTRY
ÓÁry);ƒÁry = 
Ãxt
) {

292 
Ãxt
 = 
	`EXT4_XATTR_NEXT
(
’Œy
);

293 ià((*è
Ãxt
 >ğ
’d
) {

294 
	`EXT4_ERROR_INODE
(
šode
, "corrupted xattrƒntries");

295  -
EFSCORRUPTED
;

297 
cmp
 = 
Çme_šdex
 - 
’Œy
->
e_Çme_šdex
;

298 ià(!
cmp
)

299 
cmp
 = 
Çme_Ën
 - 
’Œy
->
e_Çme_Ën
;

300 ià(!
cmp
)

301 
cmp
 = 
	`memcmp
(
Çme
, 
’Œy
->
e_Çme
, 
Çme_Ën
);

302 ià(
cmp
 <ğ0 && (
sÜ‹d
 || cmp == 0))

305 *
³Áry
 = 
’Œy
;

306  
cmp
 ? -
ENODATA
 : 0;

307 
	}
}

309 
u32


310 
	$ext4_x©Œ_šode_hash
(
ext4_sb_šfo
 *
sbi
, cÚ¡ *
bufãr
, 
size_t
 
size
)

312  
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, 
bufãr
, 
size
);

313 
	}
}

315 
u64
 
	$ext4_x©Œ_šode_g‘_»f
(
šode
 *
—_šode
)

317  ((
u64
)
—_šode
->
i_ùime
.
tv_£c
 << 32) |

318 (
u32
è
	`šode_³ek_iv”siÚ_¿w
(
—_šode
);

319 
	}
}

321 
	$ext4_x©Œ_šode_£t_»f
(
šode
 *
—_šode
, 
u64
 
»f_couÁ
)

323 
—_šode
->
i_ùime
.
tv_£c
 = (
u32
)(
»f_couÁ
 >> 32);

324 
	`šode_£t_iv”siÚ_¿w
(
—_šode
, 
»f_couÁ
 & 0xffffffff);

325 
	}
}

327 
u32
 
	$ext4_x©Œ_šode_g‘_hash
(
šode
 *
—_šode
)

329  (
u32
)
—_šode
->
i_©ime
.
tv_£c
;

330 
	}
}

332 
	$ext4_x©Œ_šode_£t_hash
(
šode
 *
—_šode
, 
u32
 
hash
)

334 
—_šode
->
i_©ime
.
tv_£c
 = 
hash
;

335 
	}
}

340 
	$ext4_x©Œ_šode_»ad
(
šode
 *
—_šode
, *
buf
, 
size_t
 
size
)

342 
blocksize
 = 1 << 
—_šode
->
i_blkb™s
;

343 
bh_couÁ
 = (
size
 + 
blocksize
 - 1è>> 
—_šode
->
i_blkb™s
;

344 
_size
 = (
size
 % 
blocksize
) ?: blocksize;

345 
bufãr_h—d
 *
bhs_šlše
[8];

346 
bufãr_h—d
 **
bhs
 = 
bhs_šlše
;

347 
i
, 
»t
;

349 ià(
bh_couÁ
 > 
	`ARRAY_SIZE
(
bhs_šlše
)) {

350 
bhs
 = 
	`km®loc_¬¿y
(
bh_couÁ
, (*bhs), 
GFP_NOFS
);

351 ià(!
bhs
)

352  -
ENOMEM
;

355 
»t
 = 
	`ext4_b»ad_b©ch
(
—_šode
, 0 , 
bh_couÁ
,

356 
Œue
 , 
bhs
);

357 ià(
»t
)

358 
ä“_bhs
;

360 
i
 = 0; i < 
bh_couÁ
; i++) {

362 ià(!
bhs
[
i
]) {

363 
»t
 = -
EFSCORRUPTED
;

364 
put_bhs
;

366 
	`memıy
((*)
buf
 + 
blocksize
 * 
i
, 
bhs
[i]->
b_d©a
,

367 
i
 < 
bh_couÁ
 - 1 ? 
blocksize
 : 
_size
);

369 
»t
 = 0;

370 
put_bhs
:

371 
i
 = 0; i < 
bh_couÁ
; i++)

372 
	`b»l£
(
bhs
[
i
]);

373 
ä“_bhs
:

374 ià(
bhs
 !ğ
bhs_šlše
)

375 
	`kä“
(
bhs
);

376  
»t
;

377 
	}
}

379 
	#EXT4_XATTR_INODE_GET_PARENT
(
šode
è((
__u32
)(šode)->
i_mtime
.
tv_£c
)

	)

381 
	$ext4_x©Œ_šode_ig‘
(
šode
 *
·»Á
, 
—_šo
,

382 
u32
 
—_šode_hash
, 
šode
 **
—_šode
)

384 
šode
 *inode;

385 
”r
;

387 
šode
 = 
	`ext4_ig‘
(
·»Á
->
i_sb
, 
—_šo
, 
EXT4_IGET_NORMAL
);

388 ià(
	`IS_ERR
(
šode
)) {

389 
”r
 = 
	`PTR_ERR
(
šode
);

390 
	`ext4_”rÜ
(
·»Á
->
i_sb
,

391 "”rÜ wh»adšg EA inod%luƒ¼=%d", 
—_šo
,

392 
”r
);

393  
”r
;

396 ià(
	`is_bad_šode
(
šode
)) {

397 
	`ext4_”rÜ
(
·»Á
->
i_sb
,

399 
—_šo
);

400 
”r
 = -
EIO
;

401 
”rÜ
;

404 ià(!(
	`EXT4_I
(
šode
)->
i_æags
 & 
EXT4_EA_INODE_FL
)) {

405 
	`ext4_”rÜ
(
·»Á
->
i_sb
,

407 
—_šo
);

408 
”r
 = -
EINVAL
;

409 
”rÜ
;

412 
	`ext4_x©Œ_šode_£t_şass
(
šode
);

419 ià(
—_šode_hash
 !ğ
	`ext4_x©Œ_šode_g‘_hash
(
šode
) &&

420 
	`EXT4_XATTR_INODE_GET_PARENT
(
šode
è=ğ
·»Á
->
i_šo
 &&

421 
šode
->
i_g’”©iÚ
 =ğ
·»Á
->i_generation) {

422 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_LUSTRE_EA_INODE
);

423 
	`ext4_x©Œ_šode_£t_»f
(
šode
, 1);

425 
	`šode_lock
(
šode
);

426 
šode
->
i_æags
 |ğ
S_NOQUOTA
;

427 
	`šode_uÆock
(
šode
);

430 *
—_šode
 = 
šode
;

432 
”rÜ
:

433 
	`ut
(
šode
);

434  
”r
;

435 
	}
}

438 
	$ext4_x©Œ_šode_v”ify_hashes
(
šode
 *
—_šode
,

439 
ext4_x©Œ_’Œy
 *
’Œy
, *
bufãr
,

440 
size_t
 
size
)

442 
u32
 
hash
;

445 
hash
 = 
	`ext4_x©Œ_šode_hash
(
	`EXT4_SB
(
—_šode
->
i_sb
), 
bufãr
, 
size
);

446 ià(
hash
 !ğ
	`ext4_x©Œ_šode_g‘_hash
(
—_šode
))

447  -
EFSCORRUPTED
;

449 ià(
’Œy
) {

450 
__Ë32
 
e_hash
, 
tmp_d©a
;

453 
tmp_d©a
 = 
	`ıu_to_Ë32
(
hash
);

454 
e_hash
 = 
	`ext4_x©Œ_hash_’Œy
(
’Œy
->
e_Çme
,ƒÁry->
e_Çme_Ën
,

455 &
tmp_d©a
, 1);

456 ià(
e_hash
 !ğ
’Œy
->e_hash)

457  -
EFSCORRUPTED
;

460 
	}
}

466 
	$ext4_x©Œ_šode_g‘
(
šode
 *šode, 
ext4_x©Œ_’Œy
 *
’Œy
,

467 *
bufãr
, 
size_t
 
size
)

469 
mb_ÿche
 *
—_šode_ÿche
 = 
	`EA_INODE_CACHE
(
šode
);

470 
šode
 *
—_šode
;

471 
”r
;

473 
”r
 = 
	`ext4_x©Œ_šode_ig‘
(
šode
, 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_šum
),

474 
	`Ë32_to_ıu
(
’Œy
->
e_hash
), &
—_šode
);

475 ià(
”r
) {

476 
—_šode
 = 
NULL
;

477 
out
;

480 ià(
	`i_size_»ad
(
—_šode
è!ğ
size
) {

481 
	`ext4_w¬nšg_šode
(
—_šode
,

483 
	`i_size_»ad
(
—_šode
), 
size
);

484 
”r
 = -
EFSCORRUPTED
;

485 
out
;

488 
”r
 = 
	`ext4_x©Œ_šode_»ad
(
—_šode
, 
bufãr
, 
size
);

489 ià(
”r
)

490 
out
;

492 ià(!
	`ext4_‹¡_šode_¡©e
(
—_šode
, 
EXT4_STATE_LUSTRE_EA_INODE
)) {

493 
”r
 = 
	`ext4_x©Œ_šode_v”ify_hashes
(
—_šode
, 
’Œy
, 
bufãr
,

494 
size
);

495 ià(
”r
) {

496 
	`ext4_w¬nšg_šode
(
—_šode
,

498 
out
;

501 ià(
—_šode_ÿche
)

502 
	`mb_ÿche_’Œy_ü—‹
(
—_šode_ÿche
, 
GFP_NOFS
,

503 
	`ext4_x©Œ_šode_g‘_hash
(
—_šode
),

504 
—_šode
->
i_šo
, 
Œue
 );

506 
out
:

507 
	`ut
(
—_šode
);

508  
”r
;

509 
	}
}

512 
	$ext4_x©Œ_block_g‘
(
šode
 *šode, 
Çme_šdex
, cÚ¡ *
Çme
,

513 *
bufãr
, 
size_t
 
bufãr_size
)

515 
bufãr_h—d
 *
bh
 = 
NULL
;

516 
ext4_x©Œ_’Œy
 *
’Œy
;

517 
size_t
 
size
;

518 *
’d
;

519 
”rÜ
;

520 
mb_ÿche
 *
—_block_ÿche
 = 
	`EA_BLOCK_CACHE
(
šode
);

522 
	`—_idebug
(
šode
, "name=%d.%s, buffer=%p, buffer_size=%ld",

523 
Çme_šdex
, 
Çme
, 
bufãr
, ()
bufãr_size
);

525 ià(!
	`EXT4_I
(
šode
)->
i_fe_aş
)

526  -
ENODATA
;

527 
	`—_idebug
(
šode
, "reading block %llu",

528 ()
	`EXT4_I
(
šode
)->
i_fe_aş
);

529 
bh
 = 
	`ext4_sb_b»ad
(
šode
->
i_sb
, 
	`EXT4_I
(šode)->
i_fe_aş
, 
REQ_PRIO
);

530 ià(
	`IS_ERR
(
bh
))

531  
	`PTR_ERR
(
bh
);

532 
	`—_bdebug
(
bh
, "b_count=%d,„efcount=%d",

533 
	`©omic_»ad
(&(
bh
->
b_couÁ
)), 
	`Ë32_to_ıu
(
	`BHDR
(bh)->
h_»fcouÁ
));

534 
”rÜ
 = 
	`ext4_x©Œ_check_block
(
šode
, 
bh
);

535 ià(
”rÜ
)

536 
ş—nup
;

537 
	`ext4_x©Œ_block_ÿche_š£¹
(
—_block_ÿche
, 
bh
);

538 
’Œy
 = 
	`BFIRST
(
bh
);

539 
’d
 = 
bh
->
b_d©a
 + bh->
b_size
;

540 
”rÜ
 = 
	`x©Œ_fšd_’Œy
(
šode
, &
’Œy
, 
’d
, 
Çme_šdex
, 
Çme
, 1);

541 ià(
”rÜ
)

542 
ş—nup
;

543 
size
 = 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
);

544 
”rÜ
 = -
ERANGE
;

545 ià(
	`uÆik–y
(
size
 > 
EXT4_XATTR_SIZE_MAX
))

546 
ş—nup
;

547 ià(
bufãr
) {

548 ià(
size
 > 
bufãr_size
)

549 
ş—nup
;

550 ià(
’Œy
->
e_v®ue_šum
) {

551 
”rÜ
 = 
	`ext4_x©Œ_šode_g‘
(
šode
, 
’Œy
, 
bufãr
,

552 
size
);

553 ià(
”rÜ
)

554 
ş—nup
;

556 
u16
 
off£t
 = 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_offs
);

557 *
p
 = 
bh
->
b_d©a
 + 
off£t
;

559 ià(
	`uÆik–y
(
p
 + 
size
 > 
’d
))

560 
ş—nup
;

561 
	`memıy
(
bufãr
, 
p
, 
size
);

564 
”rÜ
 = 
size
;

566 
ş—nup
:

567 
	`b»l£
(
bh
);

568  
”rÜ
;

569 
	}
}

572 
	$ext4_x©Œ_ibody_g‘
(
šode
 *šode, 
Çme_šdex
, cÚ¡ *
Çme
,

573 *
bufãr
, 
size_t
 
bufãr_size
)

575 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

576 
ext4_x©Œ_’Œy
 *
’Œy
;

577 
ext4_šode
 *
¿w_šode
;

578 
ext4_oc
 
oc
;

579 
size_t
 
size
;

580 *
’d
;

581 
”rÜ
;

583 ià(!
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
))

584  -
ENODATA
;

585 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

586 ià(
”rÜ
)

587  
”rÜ
;

588 
¿w_šode
 = 
	`ext4_¿w_šode
(&
oc
);

589 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

590 
’d
 = (*)
¿w_šode
 + 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
;

591 
”rÜ
 = 
	`x©Œ_check_šode
(
šode
, 
h—d”
, 
’d
);

592 ià(
”rÜ
)

593 
ş—nup
;

594 
’Œy
 = 
	`IFIRST
(
h—d”
);

595 
”rÜ
 = 
	`x©Œ_fšd_’Œy
(
šode
, &
’Œy
, 
’d
, 
Çme_šdex
, 
Çme
, 0);

596 ià(
”rÜ
)

597 
ş—nup
;

598 
size
 = 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
);

599 
”rÜ
 = -
ERANGE
;

600 ià(
	`uÆik–y
(
size
 > 
EXT4_XATTR_SIZE_MAX
))

601 
ş—nup
;

602 ià(
bufãr
) {

603 ià(
size
 > 
bufãr_size
)

604 
ş—nup
;

605 ià(
’Œy
->
e_v®ue_šum
) {

606 
”rÜ
 = 
	`ext4_x©Œ_šode_g‘
(
šode
, 
’Œy
, 
bufãr
,

607 
size
);

608 ià(
”rÜ
)

609 
ş—nup
;

611 
u16
 
off£t
 = 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_offs
);

612 *
p
 = (*)
	`IFIRST
(
h—d”
è+ 
off£t
;

614 ià(
	`uÆik–y
(
p
 + 
size
 > 
’d
))

615 
ş—nup
;

616 
	`memıy
(
bufãr
, 
p
, 
size
);

619 
”rÜ
 = 
size
;

621 
ş—nup
:

622 
	`b»l£
(
oc
.
bh
);

623  
”rÜ
;

624 
	}
}

637 
	$ext4_x©Œ_g‘
(
šode
 *šode, 
Çme_šdex
, cÚ¡ *
Çme
,

638 *
bufãr
, 
size_t
 
bufãr_size
)

640 
”rÜ
;

642 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

643  -
EIO
;

645 ià(
	`¡¾’
(
Çme
) > 255)

646  -
ERANGE
;

648 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

649 
”rÜ
 = 
	`ext4_x©Œ_ibody_g‘
(
šode
, 
Çme_šdex
, 
Çme
, 
bufãr
,

650 
bufãr_size
);

651 ià(
”rÜ
 =ğ-
ENODATA
)

652 
”rÜ
 = 
	`ext4_x©Œ_block_g‘
(
šode
, 
Çme_šdex
, 
Çme
, 
bufãr
,

653 
bufãr_size
);

654 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

655  
”rÜ
;

656 
	}
}

659 
	$ext4_x©Œ_li¡_’Œ›s
(
d’Œy
 *d’Œy, 
ext4_x©Œ_’Œy
 *
’Œy
,

660 *
bufãr
, 
size_t
 
bufãr_size
)

662 
size_t
 
»¡
 = 
bufãr_size
;

664 ; !
	`IS_LAST_ENTRY
(
’Œy
);ƒÁry = 
	`EXT4_XATTR_NEXT
(entry)) {

665 cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
 =

666 
	`ext4_x©Œ_hªdËr
(
’Œy
->
e_Çme_šdex
);

668 ià(
hªdËr
 && (!hªdËr->
li¡
 || hªdËr->
	`li¡
(
d’Œy
))) {

669 cÚ¡ *
´efix
 = 
hªdËr
->´efix ?: hªdËr->
Çme
;

670 
size_t
 
´efix_Ën
 = 
	`¡¾’
(
´efix
);

671 
size_t
 
size
 = 
´efix_Ën
 + 
’Œy
->
e_Çme_Ën
 + 1;

673 ià(
bufãr
) {

674 ià(
size
 > 
»¡
)

675  -
ERANGE
;

676 
	`memıy
(
bufãr
, 
´efix
, 
´efix_Ën
);

677 
bufãr
 +ğ
´efix_Ën
;

678 
	`memıy
(
bufãr
, 
’Œy
->
e_Çme
,ƒÁry->
e_Çme_Ën
);

679 
bufãr
 +ğ
’Œy
->
e_Çme_Ën
;

680 *
bufãr
++ = 0;

682 
»¡
 -ğ
size
;

685  
bufãr_size
 - 
»¡
;

686 
	}
}

689 
	$ext4_x©Œ_block_li¡
(
d’Œy
 *d’Œy, *
bufãr
, 
size_t
 
bufãr_size
)

691 
šode
 *šodğ
	`d_šode
(
d’Œy
);

692 
bufãr_h—d
 *
bh
 = 
NULL
;

693 
”rÜ
;

695 
	`—_idebug
(
šode
, "buffer=%p, buffer_size=%ld",

696 
bufãr
, ()
bufãr_size
);

698 ià(!
	`EXT4_I
(
šode
)->
i_fe_aş
)

700 
	`—_idebug
(
šode
, "reading block %llu",

701 ()
	`EXT4_I
(
šode
)->
i_fe_aş
);

702 
bh
 = 
	`ext4_sb_b»ad
(
šode
->
i_sb
, 
	`EXT4_I
(šode)->
i_fe_aş
, 
REQ_PRIO
);

703 ià(
	`IS_ERR
(
bh
))

704  
	`PTR_ERR
(
bh
);

705 
	`—_bdebug
(
bh
, "b_count=%d,„efcount=%d",

706 
	`©omic_»ad
(&(
bh
->
b_couÁ
)), 
	`Ë32_to_ıu
(
	`BHDR
(bh)->
h_»fcouÁ
));

707 
”rÜ
 = 
	`ext4_x©Œ_check_block
(
šode
, 
bh
);

708 ià(
”rÜ
)

709 
ş—nup
;

710 
	`ext4_x©Œ_block_ÿche_š£¹
(
	`EA_BLOCK_CACHE
(
šode
), 
bh
);

711 
”rÜ
 = 
	`ext4_x©Œ_li¡_’Œ›s
(
d’Œy
, 
	`BFIRST
(
bh
), 
bufãr
,

712 
bufãr_size
);

713 
ş—nup
:

714 
	`b»l£
(
bh
);

715  
”rÜ
;

716 
	}
}

719 
	$ext4_x©Œ_ibody_li¡
(
d’Œy
 *d’Œy, *
bufãr
, 
size_t
 
bufãr_size
)

721 
šode
 *šodğ
	`d_šode
(
d’Œy
);

722 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

723 
ext4_šode
 *
¿w_šode
;

724 
ext4_oc
 
oc
;

725 *
’d
;

726 
”rÜ
;

728 ià(!
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
))

730 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

731 ià(
”rÜ
)

732  
”rÜ
;

733 
¿w_šode
 = 
	`ext4_¿w_šode
(&
oc
);

734 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

735 
’d
 = (*)
¿w_šode
 + 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
;

736 
”rÜ
 = 
	`x©Œ_check_šode
(
šode
, 
h—d”
, 
’d
);

737 ià(
”rÜ
)

738 
ş—nup
;

739 
”rÜ
 = 
	`ext4_x©Œ_li¡_’Œ›s
(
d’Œy
, 
	`IFIRST
(
h—d”
),

740 
bufãr
, 
bufãr_size
);

742 
ş—nup
:

743 
	`b»l£
(
oc
.
bh
);

744  
”rÜ
;

745 
	}
}

759 
ssize_t


760 
	$ext4_li¡x©Œ
(
d’Œy
 *d’Œy, *
bufãr
, 
size_t
 
bufãr_size
)

762 
»t
, 
»t2
;

764 
	`down_»ad
(&
	`EXT4_I
(
	`d_šode
(
d’Œy
))->
x©Œ_£m
);

765 
»t
 = 
»t2
 = 
	`ext4_x©Œ_ibody_li¡
(
d’Œy
, 
bufãr
, 
bufãr_size
);

766 ià(
»t
 < 0)

767 
”rout
;

768 ià(
bufãr
) {

769 
bufãr
 +ğ
»t
;

770 
bufãr_size
 -ğ
»t
;

772 
»t
 = 
	`ext4_x©Œ_block_li¡
(
d’Œy
, 
bufãr
, 
bufãr_size
);

773 ià(
»t
 < 0)

774 
”rout
;

775 
»t
 +ğ
»t2
;

776 
”rout
:

777 
	`up_»ad
(&
	`EXT4_I
(
	`d_šode
(
d’Œy
))->
x©Œ_£m
);

778  
»t
;

779 
	}
}

785 
	$ext4_x©Œ_upd©e_su³r_block
(
hªdË_t
 *
hªdË
,

786 
su³r_block
 *
sb
)

788 ià(
	`ext4_has_ã©u»_x©Œ
(
sb
))

791 
	`BUFFER_TRACE
(
	`EXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

792 ià(
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
	`EXT4_SB
(
sb
)->
s_sbh
) == 0) {

793 
	`ext4_£t_ã©u»_x©Œ
(
sb
);

794 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
);

796 
	}
}

798 
	$ext4_g‘_šode_u§ge
(
šode
 *šode, 
qsize_t
 *
u§ge
)

800 
ext4_oc
 
oc
 = { .
bh
 = 
NULL
 };

801 
bufãr_h—d
 *
bh
 = 
NULL
;

802 
ext4_šode
 *
¿w_šode
;

803 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

804 
ext4_x©Œ_’Œy
 *
’Œy
;

805 
qsize_t
 
—_šode_»fs
 = 0;

806 *
’d
;

807 
»t
;

809 
	`lockd•_as£¹_h–d_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

811 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
)) {

812 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

813 ià(
»t
)

814 
out
;

815 
¿w_šode
 = 
	`ext4_¿w_šode
(&
oc
);

816 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

817 
’d
 = (*)
¿w_šode
 + 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
;

818 
»t
 = 
	`x©Œ_check_šode
(
šode
, 
h—d”
, 
’d
);

819 ià(
»t
)

820 
out
;

822 
’Œy
 = 
	`IFIRST
(
h—d”
); !
	`IS_LAST_ENTRY
(entry);

823 
’Œy
 = 
	`EXT4_XATTR_NEXT
(entry))

824 ià(
’Œy
->
e_v®ue_šum
)

825 
—_šode_»fs
++;

828 ià(
	`EXT4_I
(
šode
)->
i_fe_aş
) {

829 
bh
 = 
	`ext4_sb_b»ad
(
šode
->
i_sb
, 
	`EXT4_I
(šode)->
i_fe_aş
, 
REQ_PRIO
);

830 ià(
	`IS_ERR
(
bh
)) {

831 
»t
 = 
	`PTR_ERR
(
bh
);

832 
bh
 = 
NULL
;

833 
out
;

836 
»t
 = 
	`ext4_x©Œ_check_block
(
šode
, 
bh
);

837 ià(
»t
)

838 
out
;

840 
’Œy
 = 
	`BFIRST
(
bh
); !
	`IS_LAST_ENTRY
(entry);

841 
’Œy
 = 
	`EXT4_XATTR_NEXT
(entry))

842 ià(
’Œy
->
e_v®ue_šum
)

843 
—_šode_»fs
++;

845 *
u§ge
 = 
—_šode_»fs
 + 1;

846 
»t
 = 0;

847 
out
:

848 
	`b»l£
(
oc
.
bh
);

849 
	`b»l£
(
bh
);

850  
»t
;

851 
	}
}

853 
šlše
 
size_t
 
	$round_up_şu¡”
(
šode
 *šode, 
size_t
 
Ëngth
)

855 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

856 
size_t
 
şu¡”_size
 = 1 << (
	`EXT4_SB
(
sb
)->
s_şu¡”_b™s
 +

857 
šode
->
i_blkb™s
);

858 
size_t
 
mask
 = ~(
şu¡”_size
 - 1);

860  (
Ëngth
 + 
şu¡”_size
 - 1è& 
mask
;

861 
	}
}

863 
	$ext4_x©Œ_šode_®loc_quÙa
(
šode
 *šode, 
size_t
 
Ën
)

865 
”r
;

867 
”r
 = 
	`dquÙ_®loc_šode
(
šode
);

868 ià(
”r
)

869  
”r
;

870 
”r
 = 
	`dquÙ_®loc_¥aû_nodœty
(
šode
, 
	`round_up_şu¡”
(šode, 
Ën
));

871 ià(
”r
)

872 
	`dquÙ_ä“_šode
(
šode
);

873  
”r
;

874 
	}
}

876 
	$ext4_x©Œ_šode_ä“_quÙa
(
šode
 *
·»Á
,

877 
šode
 *
—_šode
,

878 
size_t
 
Ën
)

880 ià(
—_šode
 &&

881 
	`ext4_‹¡_šode_¡©e
(
—_šode
, 
EXT4_STATE_LUSTRE_EA_INODE
))

883 
	`dquÙ_ä“_¥aû_nodœty
(
·»Á
, 
	`round_up_şu¡”
Õ¬’t, 
Ën
));

884 
	`dquÙ_ä“_šode
(
·»Á
);

885 
	}
}

887 
	$__ext4_x©Œ_£t_üed™s
(
su³r_block
 *
sb
, 
šode
 *inode,

888 
bufãr_h—d
 *
block_bh
, 
size_t
 
v®ue_Ën
,

889 
boŞ
 
is_ü—‹
)

891 
üed™s
;

892 
blocks
;

907 
üed™s
 = 7;

910 
üed™s
 +ğ
	`EXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
);

916 ià(
šode
 && 
	`ext4_has_šlše_d©a
(inode))

917 
üed™s
 +ğ
	`ext4_wr™•age_Œªs_blocks
(
šode
) + 1;

920 ià(!
	`ext4_has_ã©u»_—_šode
(
sb
))

921  
üed™s
;

924 
üed™s
 += 4;

927 
blocks
 = (
v®ue_Ën
 + 
sb
->
s_blocksize
 - 1è>> sb->
s_blocksize_b™s
;

930 
blocks
 += 1;

933 
üed™s
 +ğ
blocks
 * 2;

936 
üed™s
 +ğ
blocks
;

938 ià(!
is_ü—‹
) {

942 
üed™s
 += 4;

945 
blocks
 = 
XATTR_SIZE_MAX
 >> 
sb
->
s_blocksize_b™s
;

950 
blocks
 += 1;

953 
üed™s
 +ğ
blocks
 * 2;

959 ià(
block_bh
) {

960 
ext4_x©Œ_’Œy
 *
’Œy
 = 
	`BFIRST
(
block_bh
);

962 ; !
	`IS_LAST_ENTRY
(
’Œy
);ƒÁry = 
	`EXT4_XATTR_NEXT
(entry))

963 ià(
’Œy
->
e_v®ue_šum
)

965 
üed™s
 += 1;

967  
üed™s
;

968 
	}
}

970 
	$ext4_x©Œ_’su»_üed™s
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

971 
üed™s
, 
bufãr_h—d
 *
bh
,

972 
boŞ
 
dœty
, boŞ 
block_csum
)

974 
”rÜ
;

976 ià(!
	`ext4_hªdË_v®id
(
hªdË
))

979 ià(
hªdË
->
h_bufãr_üed™s
 >ğ
üed™s
)

982 
”rÜ
 = 
	`ext4_jouº®_ex‹nd
(
hªdË
, 
üed™s
 - hªdË->
h_bufãr_üed™s
);

983 ià(!
”rÜ
)

985 ià(
”rÜ
 < 0) {

986 
	`ext4_w¬nšg
(
šode
->
i_sb
, "Ex‹nd jouº® (”rÜ %d)", 
”rÜ
);

987  
”rÜ
;

990 ià(
bh
 && 
dœty
) {

991 ià(
block_csum
)

992 
	`ext4_x©Œ_block_csum_£t
(
šode
, 
bh
);

993 
”rÜ
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

994 ià(
”rÜ
) {

995 
	`ext4_w¬nšg
(
šode
->
i_sb
, "Handle metadata (error %d)",

996 
”rÜ
);

997  
”rÜ
;

1001 
”rÜ
 = 
	`ext4_jouº®_»¡¬t
(
hªdË
, 
üed™s
);

1002 ià(
”rÜ
) {

1003 
	`ext4_w¬nšg
(
šode
->
i_sb
, "Re¡¬ˆjouº® (”rÜ %d)", 
”rÜ
);

1004  
”rÜ
;

1007 ià(
bh
) {

1008 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

1009 ià(
”rÜ
) {

1010 
	`ext4_w¬nšg
(
šode
->
i_sb
,

1012 
”rÜ
);

1013  
”rÜ
;

1017 
	}
}

1019 
	$ext4_x©Œ_šode_upd©e_»f
(
hªdË_t
 *
hªdË
, 
šode
 *
—_šode
,

1020 
»f_chªge
)

1022 
mb_ÿche
 *
—_šode_ÿche
 = 
	`EA_INODE_CACHE
(
—_šode
);

1023 
ext4_oc
 
oc
;

1024 
s64
 
»f_couÁ
;

1025 
u32
 
hash
;

1026 
»t
;

1028 
	`šode_lock
(
—_šode
);

1030 
»t
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
—_šode
, &
oc
);

1031 ià(
»t
)

1032 
out
;

1034 
»f_couÁ
 = 
	`ext4_x©Œ_šode_g‘_»f
(
—_šode
);

1035 
»f_couÁ
 +ğ
»f_chªge
;

1036 
	`ext4_x©Œ_šode_£t_»f
(
—_šode
, 
»f_couÁ
);

1038 ià(
»f_chªge
 > 0) {

1039 
	`WARN_ONCE
(
»f_couÁ
 <= 0, "EA inode %lu„ef_count=%lld",

1040 
—_šode
->
i_šo
, 
»f_couÁ
);

1042 ià(
»f_couÁ
 == 1) {

1043 
	`WARN_ONCE
(
—_šode
->
i_Æšk
, "EA inode %lu i_nlink=%u",

1044 
—_šode
->
i_šo
,ƒa_šode->
i_Æšk
);

1046 
	`£t_Æšk
(
—_šode
, 1);

1047 
	`ext4_Üphª_d–
(
hªdË
, 
—_šode
);

1049 ià(
—_šode_ÿche
) {

1050 
hash
 = 
	`ext4_x©Œ_šode_g‘_hash
(
—_šode
);

1051 
	`mb_ÿche_’Œy_ü—‹
(
—_šode_ÿche
,

1052 
GFP_NOFS
, 
hash
,

1053 
—_šode
->
i_šo
,

1054 
Œue
 );

1058 
	`WARN_ONCE
(
»f_couÁ
 < 0, "EA inode %lu„ef_count=%lld",

1059 
—_šode
->
i_šo
, 
»f_couÁ
);

1061 ià(
»f_couÁ
 == 0) {

1062 
	`WARN_ONCE
(
—_šode
->
i_Æšk
 != 1,

1064 
—_šode
->
i_šo
,ƒa_šode->
i_Æšk
);

1066 
	`ş—r_Æšk
(
—_šode
);

1067 
	`ext4_Üphª_add
(
hªdË
, 
—_šode
);

1069 ià(
—_šode_ÿche
) {

1070 
hash
 = 
	`ext4_x©Œ_šode_g‘_hash
(
—_šode
);

1071 
	`mb_ÿche_’Œy_d–‘e
(
—_šode_ÿche
, 
hash
,

1072 
—_šode
->
i_šo
);

1077 
»t
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
—_šode
, &
oc
);

1078 ià(
»t
)

1079 
	`ext4_w¬nšg_šode
(
—_šode
,

1080 "ext4_m¬k_oc_dœty(èçed„‘=%d", 
»t
);

1081 
out
:

1082 
	`šode_uÆock
(
—_šode
);

1083  
»t
;

1084 
	}
}

1086 
	$ext4_x©Œ_šode_šc_»f
(
hªdË_t
 *
hªdË
, 
šode
 *
—_šode
)

1088  
	`ext4_x©Œ_šode_upd©e_»f
(
hªdË
, 
—_šode
, 1);

1089 
	}
}

1091 
	$ext4_x©Œ_šode_dec_»f
(
hªdË_t
 *
hªdË
, 
šode
 *
—_šode
)

1093  
	`ext4_x©Œ_šode_upd©e_»f
(
hªdË
, 
—_šode
, -1);

1094 
	}
}

1096 
	$ext4_x©Œ_šode_šc_»f_®l
(
hªdË_t
 *
hªdË
, 
šode
 *
·»Á
,

1097 
ext4_x©Œ_’Œy
 *
fœ¡
)

1099 
šode
 *
—_šode
;

1100 
ext4_x©Œ_’Œy
 *
’Œy
;

1101 
ext4_x©Œ_’Œy
 *
çed_’Œy
;

1102 
—_šo
;

1103 
”r
, 
§ved_”r
;

1105 
’Œy
 = 
fœ¡
; !
	`IS_LAST_ENTRY
(entry);

1106 
’Œy
 = 
	`EXT4_XATTR_NEXT
(entry)) {

1107 ià(!
’Œy
->
e_v®ue_šum
)

1109 
—_šo
 = 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_šum
);

1110 
”r
 = 
	`ext4_x©Œ_šode_ig‘
(
·»Á
, 
—_šo
,

1111 
	`Ë32_to_ıu
(
’Œy
->
e_hash
),

1112 &
—_šode
);

1113 ià(
”r
)

1114 
ş—nup
;

1115 
”r
 = 
	`ext4_x©Œ_šode_šc_»f
(
hªdË
, 
—_šode
);

1116 ià(
”r
) {

1117 
	`ext4_w¬nšg_šode
(
—_šode
, "šø»à”rÜ %d", 
”r
);

1118 
	`ut
(
—_šode
);

1119 
ş—nup
;

1121 
	`ut
(
—_šode
);

1125 
ş—nup
:

1126 
§ved_”r
 = 
”r
;

1127 
çed_’Œy
 = 
’Œy
;

1129 
’Œy
 = 
fœ¡
;ƒÁry !ğ
çed_’Œy
;

1130 
’Œy
 = 
	`EXT4_XATTR_NEXT
(entry)) {

1131 ià(!
’Œy
->
e_v®ue_šum
)

1133 
—_šo
 = 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_šum
);

1134 
”r
 = 
	`ext4_x©Œ_šode_ig‘
(
·»Á
, 
—_šo
,

1135 
	`Ë32_to_ıu
(
’Œy
->
e_hash
),

1136 &
—_šode
);

1137 ià(
”r
) {

1138 
	`ext4_w¬nšg
(
·»Á
->
i_sb
,

1139 "ş—nu°—_šØ%u ig‘ƒ¼Ü %d", 
—_šo
,

1140 
”r
);

1143 
”r
 = 
	`ext4_x©Œ_šode_dec_»f
(
hªdË
, 
—_šode
);

1144 ià(
”r
)

1145 
	`ext4_w¬nšg_šode
(
—_šode
, "cleanup dec„efƒrror %d",

1146 
”r
);

1147 
	`ut
(
—_šode
);

1149  
§ved_”r
;

1150 
	}
}

1153 
	$ext4_x©Œ_šode_dec_»f_®l
(
hªdË_t
 *
hªdË
, 
šode
 *
·»Á
,

1154 
bufãr_h—d
 *
bh
,

1155 
ext4_x©Œ_’Œy
 *
fœ¡
, 
boŞ
 
block_csum
,

1156 
ext4_x©Œ_šode_¬¿y
 **
—_šode_¬¿y
,

1157 
exŒa_üed™s
, 
boŞ
 
sk_quÙa
)

1159 
šode
 *
—_šode
;

1160 
ext4_x©Œ_’Œy
 *
’Œy
;

1161 
boŞ
 
dœty
 = 
çl£
;

1162 
—_šo
;

1163 
”r
;

1164 
üed™s
;

1167 
üed™s
 = 2 + 
exŒa_üed™s
;

1169 
’Œy
 = 
fœ¡
; !
	`IS_LAST_ENTRY
(entry);

1170 
’Œy
 = 
	`EXT4_XATTR_NEXT
(entry)) {

1171 ià(!
’Œy
->
e_v®ue_šum
)

1173 
—_šo
 = 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_šum
);

1174 
”r
 = 
	`ext4_x©Œ_šode_ig‘
(
·»Á
, 
—_šo
,

1175 
	`Ë32_to_ıu
(
’Œy
->
e_hash
),

1176 &
—_šode
);

1177 ià(
”r
)

1180 
”r
 = 
	`ext4_ex·nd_šode_¬¿y
(
—_šode_¬¿y
, 
—_šode
);

1181 ià(
”r
) {

1182 
	`ext4_w¬nšg_šode
(
—_šode
,

1183 "Ex·nd inod¬¿yƒ¼=%d", 
”r
);

1184 
	`ut
(
—_šode
);

1188 
”r
 = 
	`ext4_x©Œ_’su»_üed™s
(
hªdË
, 
·»Á
, 
üed™s
, 
bh
,

1189 
dœty
, 
block_csum
);

1190 ià(
”r
) {

1191 
	`ext4_w¬nšg_šode
(
—_šode
, "Ensure creditsƒrr=%d",

1192 
”r
);

1196 
”r
 = 
	`ext4_x©Œ_šode_dec_»f
(
hªdË
, 
—_šode
);

1197 ià(
”r
) {

1198 
	`ext4_w¬nšg_šode
(
—_šode
, "ea_inode dec„efƒrr=%d",

1199 
”r
);

1203 ià(!
sk_quÙa
)

1204 
	`ext4_x©Œ_šode_ä“_quÙa
(
·»Á
, 
—_šode
,

1205 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
));

1213 
’Œy
->
e_v®ue_šum
 = 0;

1214 
’Œy
->
e_v®ue_size
 = 0;

1216 
dœty
 = 
Œue
;

1219 ià(
dœty
) {

1226 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

1227 ià(
”r
)

1228 
	`ext4_w¬nšg_šode
(
·»Á
,

1229 "hªdË dœty m‘ad©¨”r=%d", 
”r
);

1231 
	}
}

1238 
	$ext4_x©Œ_»Ëa£_block
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1239 
bufãr_h—d
 *
bh
,

1240 
ext4_x©Œ_šode_¬¿y
 **
—_šode_¬¿y
,

1241 
exŒa_üed™s
)

1243 
mb_ÿche
 *
—_block_ÿche
 = 
	`EA_BLOCK_CACHE
(
šode
);

1244 
u32
 
hash
, 
»f
;

1245 
”rÜ
 = 0;

1247 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1248 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

1249 ià(
”rÜ
)

1250 
out
;

1252 
	`lock_bufãr
(
bh
);

1253 
hash
 = 
	`Ë32_to_ıu
(
	`BHDR
(
bh
)->
h_hash
);

1254 
»f
 = 
	`Ë32_to_ıu
(
	`BHDR
(
bh
)->
h_»fcouÁ
);

1255 ià(
»f
 == 1) {

1256 
	`—_bdebug
(
bh
, "refcount‚ow=0; freeing");

1261 ià(
—_block_ÿche
)

1262 
	`mb_ÿche_’Œy_d–‘e
(
—_block_ÿche
, 
hash
,

1263 
bh
->
b_blockÄ
);

1264 
	`g‘_bh
(
bh
);

1265 
	`uÆock_bufãr
(
bh
);

1267 ià(
	`ext4_has_ã©u»_—_šode
(
šode
->
i_sb
))

1268 
	`ext4_x©Œ_šode_dec_»f_®l
(
hªdË
, 
šode
, 
bh
,

1269 
	`BFIRST
(
bh
),

1270 
Œue
 ,

1271 
—_šode_¬¿y
,

1272 
exŒa_üed™s
,

1273 
Œue
 );

1274 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
bh
, 0, 1,

1275 
EXT4_FREE_BLOCKS_METADATA
 |

1276 
EXT4_FREE_BLOCKS_FORGET
);

1278 
»f
--;

1279 
	`BHDR
(
bh
)->
h_»fcouÁ
 = 
	`ıu_to_Ë32
(
»f
);

1280 ià(
»f
 =ğ
EXT4_XATTR_REFCOUNT_MAX
 - 1) {

1281 
mb_ÿche_’Œy
 *
û
;

1283 ià(
—_block_ÿche
) {

1284 
û
 = 
	`mb_ÿche_’Œy_g‘
(
—_block_ÿche
, 
hash
,

1285 
bh
->
b_blockÄ
);

1286 ià(
û
) {

1287 
û
->
e_»u§bË
 = 1;

1288 
	`mb_ÿche_’Œy_put
(
—_block_ÿche
, 
û
);

1293 
	`ext4_x©Œ_block_csum_£t
(
šode
, 
bh
);

1304 ià(
	`ext4_hªdË_v®id
(
hªdË
))

1305 
”rÜ
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

1306 
	`uÆock_bufãr
(
bh
);

1307 ià(!
	`ext4_hªdË_v®id
(
hªdË
))

1308 
”rÜ
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

1309 ià(
	`IS_SYNC
(
šode
))

1310 
	`ext4_hªdË_sync
(
hªdË
);

1311 
	`dquÙ_ä“_block
(
šode
, 
	`EXT4_C2B
(
	`EXT4_SB
(šode->
i_sb
), 1));

1312 
	`—_bdebug
(
bh
, "refcount‚ow=%d;„eleasing",

1313 
	`Ë32_to_ıu
(
	`BHDR
(
bh
)->
h_»fcouÁ
));

1315 
out
:

1316 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”rÜ
);

1318 
	}
}

1324 
size_t
 
	$ext4_x©Œ_ä“_¥aû
(
ext4_x©Œ_’Œy
 *
Ï¡
,

1325 
size_t
 *
mš_offs
, *
ba£
, *
tÙ®
)

1327 ; !
	`IS_LAST_ENTRY
(
Ï¡
);†a¡ = 
	`EXT4_XATTR_NEXT
(last)) {

1328 ià(!
Ï¡
->
e_v®ue_šum
 &&†a¡->
e_v®ue_size
) {

1329 
size_t
 
offs
 = 
	`Ë16_to_ıu
(
Ï¡
->
e_v®ue_offs
);

1330 ià(
offs
 < *
mš_offs
)

1331 *
mš_offs
 = 
offs
;

1333 ià(
tÙ®
)

1334 *
tÙ®
 +ğ
	`EXT4_XATTR_LEN
(
Ï¡
->
e_Çme_Ën
);

1336  (*
mš_offs
 - ((*)
Ï¡
 - 
ba£
è- (
__u32
));

1337 
	}
}

1342 
	$ext4_x©Œ_šode_wr™e
(
hªdË_t
 *
hªdË
, 
šode
 *
—_šode
,

1343 cÚ¡ *
buf
, 
bufsize
)

1345 
bufãr_h—d
 *
bh
 = 
NULL
;

1346 
block
 = 0;

1347 
blocksize
 = 
—_šode
->
i_sb
->
s_blocksize
;

1348 
max_blocks
 = (
bufsize
 + 
blocksize
 - 1è>> 
—_šode
->
i_blkb™s
;

1349 
csize
, 
wsize
 = 0;

1350 
»t
 = 0;

1351 
»Œ›s
 = 0;

1353 
»Œy
:

1354 
»t
 >ğ0 &&„‘ < 
max_blocks
) {

1355 
ext4_m­_blocks
 
m­
;

1356 
m­
.
m_lblk
 = 
block
 +ğ
»t
;

1357 
m­
.
m_Ën
 = 
max_blocks
 -ğ
»t
;

1359 
»t
 = 
	`ext4_m­_blocks
(
hªdË
, 
—_šode
, &
m­
,

1360 
EXT4_GET_BLOCKS_CREATE
);

1361 ià(
»t
 <= 0) {

1362 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
—_šode
);

1363 ià(
»t
 =ğ-
ENOSPC
 &&

1364 
	`ext4_should_»Œy_®loc
(
—_šode
->
i_sb
, &
»Œ›s
)) {

1365 
»t
 = 0;

1366 
»Œy
;

1372 ià(
»t
 < 0)

1373  
»t
;

1375 
block
 = 0;

1376 
wsize
 < 
bufsize
) {

1377 ià(
bh
 !ğ
NULL
)

1378 
	`b»l£
(
bh
);

1379 
csize
 = (
bufsize
 - 
wsize
è> 
blocksize
 ? blocksize :

1380 
bufsize
 - 
wsize
;

1381 
bh
 = 
	`ext4_g‘blk
(
hªdË
, 
—_šode
, 
block
, 0);

1382 ià(
	`IS_ERR
(
bh
))

1383  
	`PTR_ERR
(
bh
);

1384 ià(!
bh
) {

1385 
	`WARN_ON_ONCE
(1);

1386 
	`EXT4_ERROR_INODE
(
—_šode
,

1388  -
EFSCORRUPTED
;

1390 
»t
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

1391 ià(
»t
)

1392 
out
;

1394 
	`memıy
(
bh
->
b_d©a
, 
buf
, 
csize
);

1395 
	`£t_bufãr_u±od©e
(
bh
);

1396 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
—_šode
, 
bh
);

1398 
buf
 +ğ
csize
;

1399 
wsize
 +ğ
csize
;

1400 
block
 += 1;

1403 
	`šode_lock
(
—_šode
);

1404 
	`i_size_wr™e
(
—_šode
, 
wsize
);

1405 
	`ext4_upd©e_i_disksize
(
—_šode
, 
wsize
);

1406 
	`šode_uÆock
(
—_šode
);

1408 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
—_šode
);

1410 
out
:

1411 
	`b»l£
(
bh
);

1413  
»t
;

1414 
	}
}

1419 
šode
 *
	$ext4_x©Œ_šode_ü—‹
(
hªdË_t
 *
hªdË
,

1420 
šode
 *šode, 
u32
 
hash
)

1422 
šode
 *
—_šode
 = 
NULL
;

1423 
uid_t
 
owÃr
[2] = { 
	`i_uid_»ad
(
šode
), 
	`i_gid_»ad
(inode) };

1424 
”r
;

1430 
—_šode
 = 
	`ext4_Ãw_šode
(
hªdË
, 
šode
->
i_sb
->
s_roÙ
->
d_šode
,

1431 
S_IFREG
 | 0600, 
NULL
, 
šode
->
i_šo
 + 1, 
owÃr
,

1432 
EXT4_EA_INODE_FL
);

1433 ià(!
	`IS_ERR
(
—_šode
)) {

1434 
—_šode
->
i_İ
 = &
ext4_fe_šode_İ”©iÚs
;

1435 
—_šode
->
i_fİ
 = &
ext4_fe_İ”©iÚs
;

1436 
	`ext4_£t_aİs
(
—_šode
);

1437 
	`ext4_x©Œ_šode_£t_şass
(
—_šode
);

1438 
	`uÆock_Ãw_šode
(
—_šode
);

1439 
	`ext4_x©Œ_šode_£t_»f
(
—_šode
, 1);

1440 
	`ext4_x©Œ_šode_£t_hash
(
—_šode
, 
hash
);

1441 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
—_šode
);

1442 ià(!
”r
)

1443 
”r
 = 
	`ext4_šode_©ch_jšode
(
—_šode
);

1444 ià(
”r
) {

1445 
	`ut
(
—_šode
);

1446  
	`ERR_PTR
(
”r
);

1453 
	`dquÙ_ä“_šode
(
—_šode
);

1454 
	`dquÙ_drİ
(
—_šode
);

1455 
	`šode_lock
(
—_šode
);

1456 
—_šode
->
i_æags
 |ğ
S_NOQUOTA
;

1457 
	`šode_uÆock
(
—_šode
);

1460  
—_šode
;

1461 
	}
}

1463 
šode
 *

1464 
	$ext4_x©Œ_šode_ÿche_fšd
(
šode
 *šode, cÚ¡ *
v®ue
,

1465 
size_t
 
v®ue_Ën
, 
u32
 
hash
)

1467 
šode
 *
—_šode
;

1468 
mb_ÿche_’Œy
 *
û
;

1469 
mb_ÿche
 *
—_šode_ÿche
 = 
	`EA_INODE_CACHE
(
šode
);

1470 *
—_d©a
;

1472 ià(!
—_šode_ÿche
)

1473  
NULL
;

1475 
û
 = 
	`mb_ÿche_’Œy_fšd_fœ¡
(
—_šode_ÿche
, 
hash
);

1476 ià(!
û
)

1477  
NULL
;

1479 
—_d©a
 = 
	`ext4_kvm®loc
(
v®ue_Ën
, 
GFP_NOFS
);

1480 ià(!
—_d©a
) {

1481 
	`mb_ÿche_’Œy_put
(
—_šode_ÿche
, 
û
);

1482  
NULL
;

1485 
û
) {

1486 
—_šode
 = 
	`ext4_ig‘
(
šode
->
i_sb
, 
û
->
e_v®ue
,

1487 
EXT4_IGET_NORMAL
);

1488 ià(!
	`IS_ERR
(
—_šode
) &&

1489 !
	`is_bad_šode
(
—_šode
) &&

1490 (
	`EXT4_I
(
—_šode
)->
i_æags
 & 
EXT4_EA_INODE_FL
) &&

1491 
	`i_size_»ad
(
—_šode
è=ğ
v®ue_Ën
 &&

1492 !
	`ext4_x©Œ_šode_»ad
(
—_šode
, 
—_d©a
, 
v®ue_Ën
) &&

1493 !
	`ext4_x©Œ_šode_v”ify_hashes
(
—_šode
, 
NULL
, 
—_d©a
,

1494 
v®ue_Ën
) &&

1495 !
	`memcmp
(
v®ue
, 
—_d©a
, 
v®ue_Ën
)) {

1496 
	`mb_ÿche_’Œy_touch
(
—_šode_ÿche
, 
û
);

1497 
	`mb_ÿche_’Œy_put
(
—_šode_ÿche
, 
û
);

1498 
	`kvä“
(
—_d©a
);

1499  
—_šode
;

1502 ià(!
	`IS_ERR
(
—_šode
))

1503 
	`ut
(
—_šode
);

1504 
û
 = 
	`mb_ÿche_’Œy_fšd_Ãxt
(
—_šode_ÿche
, ce);

1506 
	`kvä“
(
—_d©a
);

1507  
NULL
;

1508 
	}
}

1513 
	$ext4_x©Œ_šode_lookup_ü—‹
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1514 cÚ¡ *
v®ue
, 
size_t
 
v®ue_Ën
,

1515 
šode
 **
»t_šode
)

1517 
šode
 *
—_šode
;

1518 
u32
 
hash
;

1519 
”r
;

1521 
hash
 = 
	`ext4_x©Œ_šode_hash
(
	`EXT4_SB
(
šode
->
i_sb
), 
v®ue
, 
v®ue_Ën
);

1522 
—_šode
 = 
	`ext4_x©Œ_šode_ÿche_fšd
(
šode
, 
v®ue
, 
v®ue_Ën
, 
hash
);

1523 ià(
—_šode
) {

1524 
”r
 = 
	`ext4_x©Œ_šode_šc_»f
(
hªdË
, 
—_šode
);

1525 ià(
”r
) {

1526 
	`ut
(
—_šode
);

1527  
”r
;

1530 *
»t_šode
 = 
—_šode
;

1535 
—_šode
 = 
	`ext4_x©Œ_šode_ü—‹
(
hªdË
, 
šode
, 
hash
);

1536 ià(
	`IS_ERR
(
—_šode
))

1537  
	`PTR_ERR
(
—_šode
);

1539 
”r
 = 
	`ext4_x©Œ_šode_wr™e
(
hªdË
, 
—_šode
, 
v®ue
, 
v®ue_Ën
);

1540 ià(
”r
) {

1541 
	`ext4_x©Œ_šode_dec_»f
(
hªdË
, 
—_šode
);

1542 
	`ut
(
—_šode
);

1543  
”r
;

1546 ià(
	`EA_INODE_CACHE
(
šode
))

1547 
	`mb_ÿche_’Œy_ü—‹
(
	`EA_INODE_CACHE
(
šode
), 
GFP_NOFS
, 
hash
,

1548 
—_šode
->
i_šo
, 
Œue
 );

1550 *
»t_šode
 = 
—_šode
;

1552 
	}
}

1558 
	#EXT4_XATTR_BLOCK_RESERVE
(
šode
è
	`mš
(
	`i_blocksize
(šode)/8, 1024U)

	)

1560 
	$ext4_x©Œ_£t_’Œy
(
ext4_x©Œ_šfo
 *
i
,

1561 
ext4_x©Œ_£¬ch
 *
s
,

1562 
hªdË_t
 *
hªdË
, 
šode
 *inode,

1563 
boŞ
 
is_block
)

1565 
ext4_x©Œ_’Œy
 *
Ï¡
, *
Ãxt
;

1566 
ext4_x©Œ_’Œy
 *
h”e
 = 
s
->here;

1567 
size_t
 
mš_offs
 = 
s
->
’d
 - s->
ba£
, 
Çme_Ën
 = 
	`¡¾’
(
i
->
Çme
);

1568 
š_šode
 = 
i
->in_inode;

1569 
šode
 *
Şd_—_šode
 = 
NULL
;

1570 
šode
 *
Ãw_—_šode
 = 
NULL
;

1571 
size_t
 
Şd_size
, 
Ãw_size
;

1572 
»t
;

1575 
Şd_size
 = (!
s
->
nÙ_found
 && !
h”e
->
e_v®ue_šum
) ?

1576 
	`EXT4_XATTR_SIZE
(
	`Ë32_to_ıu
(
h”e
->
e_v®ue_size
)) : 0;

1577 
Ãw_size
 = (
i
->
v®ue
 && !
š_šode
è? 
	`EXT4_XATTR_SIZE
(i->
v®ue_Ën
) : 0;

1583 ià(
Ãw_size
 &&‚ew_siz=ğ
Şd_size
) {

1584 
size_t
 
offs
 = 
	`Ë16_to_ıu
(
h”e
->
e_v®ue_offs
);

1585 *
v®
 = 
s
->
ba£
 + 
offs
;

1587 
h”e
->
e_v®ue_size
 = 
	`ıu_to_Ë32
(
i
->
v®ue_Ën
);

1588 ià(
i
->
v®ue
 =ğ
EXT4_ZERO_XATTR_VALUE
) {

1589 
	`mem£t
(
v®
, 0, 
Ãw_size
);

1591 
	`memıy
(
v®
, 
i
->
v®ue
, i->
v®ue_Ën
);

1593 
	`mem£t
(
v®
 + 
i
->
v®ue_Ën
, 0, 
Ãw_size
 - i->value_len);

1595 
upd©e_hash
;

1599 
Ï¡
 = 
s
->
fœ¡
;

1600 ; !
	`IS_LAST_ENTRY
(
Ï¡
);†a¡ = 
Ãxt
) {

1601 
Ãxt
 = 
	`EXT4_XATTR_NEXT
(
Ï¡
);

1602 ià((*)
Ãxt
 >ğ
s
->
’d
) {

1603 
	`EXT4_ERROR_INODE
(
šode
, "corrupted xattrƒntries");

1604 
»t
 = -
EFSCORRUPTED
;

1605 
out
;

1607 ià(!
Ï¡
->
e_v®ue_šum
 &&†a¡->
e_v®ue_size
) {

1608 
size_t
 
offs
 = 
	`Ë16_to_ıu
(
Ï¡
->
e_v®ue_offs
);

1609 ià(
offs
 < 
mš_offs
)

1610 
mš_offs
 = 
offs
;

1615 ià(
i
->
v®ue
) {

1616 
size_t
 
ä“
;

1618 
ä“
 = 
mš_offs
 - ((*)
Ï¡
 - 
s
->
ba£
è- (
__u32
);

1619 ià(!
s
->
nÙ_found
)

1620 
ä“
 +ğ
	`EXT4_XATTR_LEN
(
Çme_Ën
è+ 
Şd_size
;

1622 ià(
ä“
 < 
	`EXT4_XATTR_LEN
(
Çme_Ën
è+ 
Ãw_size
) {

1623 
»t
 = -
ENOSPC
;

1624 
out
;

1633 ià(
	`ext4_has_ã©u»_—_šode
(
šode
->
i_sb
) &&

1634 
Ãw_size
 && 
is_block
 &&

1635 (
mš_offs
 + 
Şd_size
 - 
Ãw_size
) <

1636 
	`EXT4_XATTR_BLOCK_RESERVE
(
šode
)) {

1637 
»t
 = -
ENOSPC
;

1638 
out
;

1646 ià(!
s
->
nÙ_found
 && 
h”e
->
e_v®ue_šum
) {

1647 
»t
 = 
	`ext4_x©Œ_šode_ig‘
(
šode
,

1648 
	`Ë32_to_ıu
(
h”e
->
e_v®ue_šum
),

1649 
	`Ë32_to_ıu
(
h”e
->
e_hash
),

1650 &
Şd_—_šode
);

1651 ià(
»t
) {

1652 
Şd_—_šode
 = 
NULL
;

1653 
out
;

1656 ià(
i
->
v®ue
 && 
š_šode
) {

1657 
	`WARN_ON_ONCE
(!
i
->
v®ue_Ën
);

1659 
»t
 = 
	`ext4_x©Œ_šode_®loc_quÙa
(
šode
, 
i
->
v®ue_Ën
);

1660 ià(
»t
)

1661 
out
;

1663 
»t
 = 
	`ext4_x©Œ_šode_lookup_ü—‹
(
hªdË
, 
šode
, 
i
->
v®ue
,

1664 
i
->
v®ue_Ën
,

1665 &
Ãw_—_šode
);

1666 ià(
»t
) {

1667 
Ãw_—_šode
 = 
NULL
;

1668 
	`ext4_x©Œ_šode_ä“_quÙa
(
šode
, 
NULL
, 
i
->
v®ue_Ën
);

1669 
out
;

1673 ià(
Şd_—_šode
) {

1675 
»t
 = 
	`ext4_x©Œ_šode_dec_»f
(
hªdË
, 
Şd_—_šode
);

1676 ià(
»t
) {

1678 ià(
Ãw_—_šode
) {

1679 
”r
;

1681 
”r
 = 
	`ext4_x©Œ_šode_dec_»f
(
hªdË
,

1682 
Ãw_—_šode
);

1683 ià(
”r
)

1684 
	`ext4_w¬nšg_šode
(
Ãw_—_šode
,

1686 
”r
);

1687 
	`ext4_x©Œ_šode_ä“_quÙa
(
šode
, 
Ãw_—_šode
,

1688 
i
->
v®ue_Ën
);

1690 
out
;

1693 
	`ext4_x©Œ_šode_ä“_quÙa
(
šode
, 
Şd_—_šode
,

1694 
	`Ë32_to_ıu
(
h”e
->
e_v®ue_size
));

1699 ià(!
s
->
nÙ_found
 && 
h”e
->
e_v®ue_size
 && !h”e->
e_v®ue_šum
) {

1701 *
fœ¡_v®
 = 
s
->
ba£
 + 
mš_offs
;

1702 
size_t
 
offs
 = 
	`Ë16_to_ıu
(
h”e
->
e_v®ue_offs
);

1703 *
v®
 = 
s
->
ba£
 + 
offs
;

1705 
	`memmove
(
fœ¡_v®
 + 
Şd_size
, fœ¡_v®, 
v®
 - first_val);

1706 
	`mem£t
(
fœ¡_v®
, 0, 
Şd_size
);

1707 
mš_offs
 +ğ
Şd_size
;

1710 
Ï¡
 = 
s
->
fœ¡
;

1711 !
	`IS_LAST_ENTRY
(
Ï¡
)) {

1712 
size_t
 
o
 = 
	`Ë16_to_ıu
(
Ï¡
->
e_v®ue_offs
);

1714 ià(!
Ï¡
->
e_v®ue_šum
 &&

1715 
Ï¡
->
e_v®ue_size
 && 
o
 < 
offs
)

1716 
Ï¡
->
e_v®ue_offs
 = 
	`ıu_to_Ë16
(
o
 + 
Şd_size
);

1717 
Ï¡
 = 
	`EXT4_XATTR_NEXT
(last);

1721 ià(!
i
->
v®ue
) {

1723 
size_t
 
size
 = 
	`EXT4_XATTR_LEN
(
Çme_Ën
);

1725 
Ï¡
 = 
	`ENTRY
((*îa¡ - 
size
);

1726 
	`memmove
(
h”e
, (*)h”+ 
size
,

1727 (*)
Ï¡
 - (*)
h”e
 + (
__u32
));

1728 
	`mem£t
(
Ï¡
, 0, 
size
);

1729 } ià(
s
->
nÙ_found
) {

1731 
size_t
 
size
 = 
	`EXT4_XATTR_LEN
(
Çme_Ën
);

1732 
size_t
 
»¡
 = (*)
Ï¡
 - (*)
h”e
 + (
__u32
);

1734 
	`memmove
((*)
h”e
 + 
size
, h”e, 
»¡
);

1735 
	`mem£t
(
h”e
, 0, 
size
);

1736 
h”e
->
e_Çme_šdex
 = 
i
->
Çme_šdex
;

1737 
h”e
->
e_Çme_Ën
 = 
Çme_Ën
;

1738 
	`memıy
(
h”e
->
e_Çme
, 
i
->
Çme
, 
Çme_Ën
);

1741 
h”e
->
e_v®ue_šum
 = 0;

1742 
h”e
->
e_v®ue_offs
 = 0;

1743 
h”e
->
e_v®ue_size
 = 0;

1746 ià(
i
->
v®ue
) {

1748 ià(
š_šode
) {

1749 
h”e
->
e_v®ue_šum
 = 
	`ıu_to_Ë32
(
Ãw_—_šode
->
i_šo
);

1750 } ià(
i
->
v®ue_Ën
) {

1751 *
v®
 = 
s
->
ba£
 + 
mš_offs
 - 
Ãw_size
;

1753 
h”e
->
e_v®ue_offs
 = 
	`ıu_to_Ë16
(
mš_offs
 - 
Ãw_size
);

1754 ià(
i
->
v®ue
 =ğ
EXT4_ZERO_XATTR_VALUE
) {

1755 
	`mem£t
(
v®
, 0, 
Ãw_size
);

1757 
	`memıy
(
v®
, 
i
->
v®ue
, i->
v®ue_Ën
);

1759 
	`mem£t
(
v®
 + 
i
->
v®ue_Ën
, 0,

1760 
Ãw_size
 - 
i
->
v®ue_Ën
);

1763 
h”e
->
e_v®ue_size
 = 
	`ıu_to_Ë32
(
i
->
v®ue_Ën
);

1766 
upd©e_hash
:

1767 ià(
i
->
v®ue
) {

1768 
__Ë32
 
hash
 = 0;

1771 ià(
š_šode
) {

1772 
__Ë32
 
üc32c_hash
;

1779 
üc32c_hash
 = 
	`ıu_to_Ë32
(

1780 
	`ext4_x©Œ_šode_g‘_hash
(
Ãw_—_šode
));

1781 
hash
 = 
	`ext4_x©Œ_hash_’Œy
(
h”e
->
e_Çme
,

1782 
h”e
->
e_Çme_Ën
,

1783 &
üc32c_hash
, 1);

1784 } ià(
is_block
) {

1785 
__Ë32
 *
v®ue
 = 
s
->
ba£
 + 
	`Ë16_to_ıu
(

1786 
h”e
->
e_v®ue_offs
);

1788 
hash
 = 
	`ext4_x©Œ_hash_’Œy
(
h”e
->
e_Çme
,

1789 
h”e
->
e_Çme_Ën
, 
v®ue
,

1790 
Ãw_size
 >> 2);

1792 
h”e
->
e_hash
 = 
hash
;

1795 ià(
is_block
)

1796 
	`ext4_x©Œ_»hash
((
ext4_x©Œ_h—d”
 *)
s
->
ba£
);

1798 
»t
 = 0;

1799 
out
:

1800 
	`ut
(
Şd_—_šode
);

1801 
	`ut
(
Ãw_—_šode
);

1802  
»t
;

1803 
	}
}

1805 
	sext4_x©Œ_block_fšd
 {

1806 
ext4_x©Œ_£¬ch
 
	ms
;

1807 
bufãr_h—d
 *
	mbh
;

1811 
	$ext4_x©Œ_block_fšd
(
šode
 *šode, 
ext4_x©Œ_šfo
 *
i
,

1812 
ext4_x©Œ_block_fšd
 *
bs
)

1814 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

1815 
”rÜ
;

1817 
	`—_idebug
(
šode
, "name=%d.%s, value=%p, value_len=%ld",

1818 
i
->
Çme_šdex
, i->
Çme
, i->
v®ue
, ()i->
v®ue_Ën
);

1820 ià(
	`EXT4_I
(
šode
)->
i_fe_aş
) {

1822 
bs
->
bh
 = 
	`ext4_sb_b»ad
(
sb
, 
	`EXT4_I
(
šode
)->
i_fe_aş
, 
REQ_PRIO
);

1823 ià(
	`IS_ERR
(
bs
->
bh
))

1824  
	`PTR_ERR
(
bs
->
bh
);

1825 
	`—_bdebug
(
bs
->
bh
, "b_count=%d,„efcount=%d",

1826 
	`©omic_»ad
(&(
bs
->
bh
->
b_couÁ
)),

1827 
	`Ë32_to_ıu
(
	`BHDR
(
bs
->
bh
)->
h_»fcouÁ
));

1828 
”rÜ
 = 
	`ext4_x©Œ_check_block
(
šode
, 
bs
->
bh
);

1829 ià(
”rÜ
)

1830  
”rÜ
;

1832 
bs
->
s
.
ba£
 = 
	`BHDR
(bs->
bh
);

1833 
bs
->
s
.
fœ¡
 = 
	`BFIRST
(bs->
bh
);

1834 
bs
->
s
.
’d
 = bs->
bh
->
b_d©a
 + bs->bh->
b_size
;

1835 
bs
->
s
.
h”e
 = bs->s.
fœ¡
;

1836 
”rÜ
 = 
	`x©Œ_fšd_’Œy
(
šode
, &
bs
->
s
.
h”e
, bs->s.
’d
,

1837 
i
->
Çme_šdex
, i->
Çme
, 1);

1838 ià(
”rÜ
 &&ƒ¼Ü !ğ-
ENODATA
)

1839  
”rÜ
;

1840 
bs
->
s
.
nÙ_found
 = 
”rÜ
;

1843 
	}
}

1846 
	$ext4_x©Œ_block_£t
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1847 
ext4_x©Œ_šfo
 *
i
,

1848 
ext4_x©Œ_block_fšd
 *
bs
)

1850 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

1851 
bufãr_h—d
 *
Ãw_bh
 = 
NULL
;

1852 
ext4_x©Œ_£¬ch
 
s_cİy
 = 
bs
->
s
;

1853 
ext4_x©Œ_£¬ch
 *
s
 = &
s_cİy
;

1854 
mb_ÿche_’Œy
 *
û
 = 
NULL
;

1855 
”rÜ
 = 0;

1856 
mb_ÿche
 *
—_block_ÿche
 = 
	`EA_BLOCK_CACHE
(
šode
);

1857 
šode
 *
—_šode
 = 
NULL
, *
tmp_šode
;

1858 
size_t
 
Şd_—_šode_quÙa
 = 0;

1859 
—_šo
;

1862 
	#h—d”
(
x
è((
ext4_x©Œ_h—d”
 *)(x))

	)

1864 ià(
s
->
ba£
) {

1865 
	`BUFFER_TRACE
(
bs
->
bh
, "get_write_access");

1866 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bs
->
bh
);

1867 ià(
”rÜ
)

1868 
ş—nup
;

1869 
	`lock_bufãr
(
bs
->
bh
);

1871 ià(
	`h—d”
(
s
->
ba£
)->
h_»fcouÁ
 =ğ
	`ıu_to_Ë32
(1)) {

1872 
__u32
 
hash
 = 
	`Ë32_to_ıu
(
	`BHDR
(
bs
->
bh
)->
h_hash
);

1879 ià(
—_block_ÿche
)

1880 
	`mb_ÿche_’Œy_d–‘e
(
—_block_ÿche
, 
hash
,

1881 
bs
->
bh
->
b_blockÄ
);

1882 
	`—_bdebug
(
bs
->
bh
, "modifying in-place");

1883 
”rÜ
 = 
	`ext4_x©Œ_£t_’Œy
(
i
, 
s
, 
hªdË
, 
šode
,

1884 
Œue
 );

1885 
	`ext4_x©Œ_block_csum_£t
(
šode
, 
bs
->
bh
);

1886 
	`uÆock_bufãr
(
bs
->
bh
);

1887 ià(
”rÜ
 =ğ-
EFSCORRUPTED
)

1888 
bad_block
;

1889 ià(!
”rÜ
)

1890 
”rÜ
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
,

1891 
šode
,

1892 
bs
->
bh
);

1893 ià(
”rÜ
)

1894 
ş—nup
;

1895 
š£¹ed
;

1897 
off£t
 = (*)
s
->
h”e
 - 
bs
->
bh
->
b_d©a
;

1899 
	`uÆock_bufãr
(
bs
->
bh
);

1900 
	`—_bdebug
(
bs
->
bh
, "cloning");

1901 
s
->
ba£
 = 
	`km®loc
(
bs
->
bh
->
b_size
, 
GFP_NOFS
);

1902 
”rÜ
 = -
ENOMEM
;

1903 ià(
s
->
ba£
 =ğ
NULL
)

1904 
ş—nup
;

1905 
	`memıy
(
s
->
ba£
, 
	`BHDR
(
bs
->
bh
), bs->bh->
b_size
);

1906 
s
->
fœ¡
 = 
	`ENTRY
(
	`h—d”
(s->
ba£
)+1);

1907 
	`h—d”
(
s
->
ba£
)->
h_»fcouÁ
 = 
	`ıu_to_Ë32
(1);

1908 
s
->
h”e
 = 
	`ENTRY
(s->
ba£
 + 
off£t
);

1909 
s
->
’d
 = s->
ba£
 + 
bs
->
bh
->
b_size
;

1918 ià(!
s
->
nÙ_found
 && s->
h”e
->
e_v®ue_šum
) {

1919 
—_šo
 = 
	`Ë32_to_ıu
(
s
->
h”e
->
e_v®ue_šum
);

1920 
”rÜ
 = 
	`ext4_x©Œ_šode_ig‘
(
šode
, 
—_šo
,

1921 
	`Ë32_to_ıu
(
s
->
h”e
->
e_hash
),

1922 &
tmp_šode
);

1923 ià(
”rÜ
)

1924 
ş—nup
;

1926 ià(!
	`ext4_‹¡_šode_¡©e
(
tmp_šode
,

1927 
EXT4_STATE_LUSTRE_EA_INODE
)) {

1932 
Şd_—_šode_quÙa
 = 
	`Ë32_to_ıu
(

1933 
s
->
h”e
->
e_v®ue_size
);

1935 
	`ut
(
tmp_šode
);

1937 
s
->
h”e
->
e_v®ue_šum
 = 0;

1938 
s
->
h”e
->
e_v®ue_size
 = 0;

1943 
s
->
ba£
 = 
	`kz®loc
(
sb
->
s_blocksize
, 
GFP_NOFS
);

1945 
”rÜ
 = -
ENOMEM
;

1946 ià(
s
->
ba£
 =ğ
NULL
)

1947 
ş—nup
;

1948 
	`h—d”
(
s
->
ba£
)->
h_magic
 = 
	`ıu_to_Ë32
(
EXT4_XATTR_MAGIC
);

1949 
	`h—d”
(
s
->
ba£
)->
h_blocks
 = 
	`ıu_to_Ë32
(1);

1950 
	`h—d”
(
s
->
ba£
)->
h_»fcouÁ
 = 
	`ıu_to_Ë32
(1);

1951 
s
->
fœ¡
 = 
	`ENTRY
(
	`h—d”
(s->
ba£
)+1);

1952 
s
->
h”e
 = 
	`ENTRY
(
	`h—d”
(s->
ba£
)+1);

1953 
s
->
’d
 = s->
ba£
 + 
sb
->
s_blocksize
;

1956 
”rÜ
 = 
	`ext4_x©Œ_£t_’Œy
(
i
, 
s
, 
hªdË
, 
šode
, 
Œue
 );

1957 ià(
”rÜ
 =ğ-
EFSCORRUPTED
)

1958 
bad_block
;

1959 ià(
”rÜ
)

1960 
ş—nup
;

1962 ià(
i
->
v®ue
 && 
s
->
h”e
->
e_v®ue_šum
) {

1969 
—_šo
 = 
	`Ë32_to_ıu
(
s
->
h”e
->
e_v®ue_šum
);

1970 
”rÜ
 = 
	`ext4_x©Œ_šode_ig‘
(
šode
, 
—_šo
,

1971 
	`Ë32_to_ıu
(
s
->
h”e
->
e_hash
),

1972 &
—_šode
);

1973 ià(
”rÜ
) {

1974 
—_šode
 = 
NULL
;

1975 
ş—nup
;

1979 
š£¹ed
:

1980 ià(!
	`IS_LAST_ENTRY
(
s
->
fœ¡
)) {

1981 
Ãw_bh
 = 
	`ext4_x©Œ_block_ÿche_fšd
(
šode
, 
	`h—d”
(
s
->
ba£
),

1982 &
û
);

1983 ià(
Ãw_bh
) {

1985 ià(
Ãw_bh
 =ğ
bs
->
bh
)

1986 
	`—_bdebug
(
Ãw_bh
, "keeping");

1988 
u32
 
»f
;

1990 
	`WARN_ON_ONCE
(
	`dquÙ_š™Ÿlize_Ãeded
(
šode
));

1994 
”rÜ
 = 
	`dquÙ_®loc_block
(
šode
,

1995 
	`EXT4_C2B
(
	`EXT4_SB
(
sb
), 1));

1996 ià(
”rÜ
)

1997 
ş—nup
;

1998 
	`BUFFER_TRACE
(
Ãw_bh
, "get_write_access");

1999 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
,

2000 
Ãw_bh
);

2001 ià(
”rÜ
)

2002 
ş—nup_dquÙ
;

2003 
	`lock_bufãr
(
Ãw_bh
);

2016 ià(
	`hli¡_bl_unhashed
(&
û
->
e_hash_li¡
) ||

2017 !
û
->
e_»u§bË
) {

2022 
	`uÆock_bufãr
(
Ãw_bh
);

2023 
	`dquÙ_ä“_block
(
šode
,

2024 
	`EXT4_C2B
(
	`EXT4_SB
(
sb
),

2026 
	`b»l£
(
Ãw_bh
);

2027 
	`mb_ÿche_’Œy_put
(
—_block_ÿche
, 
û
);

2028 
û
 = 
NULL
;

2029 
Ãw_bh
 = 
NULL
;

2030 
š£¹ed
;

2032 
»f
 = 
	`Ë32_to_ıu
(
	`BHDR
(
Ãw_bh
)->
h_»fcouÁ
) + 1;

2033 
	`BHDR
(
Ãw_bh
)->
h_»fcouÁ
 = 
	`ıu_to_Ë32
(
»f
);

2034 ià(
»f
 >ğ
EXT4_XATTR_REFCOUNT_MAX
)

2035 
û
->
e_»u§bË
 = 0;

2036 
	`—_bdebug
(
Ãw_bh
, "reusing;„efcount‚ow=%d",

2037 
»f
);

2038 
	`ext4_x©Œ_block_csum_£t
(
šode
, 
Ãw_bh
);

2039 
	`uÆock_bufãr
(
Ãw_bh
);

2040 
”rÜ
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
,

2041 
šode
,

2042 
Ãw_bh
);

2043 ià(
”rÜ
)

2044 
ş—nup_dquÙ
;

2046 
	`mb_ÿche_’Œy_touch
(
—_block_ÿche
, 
û
);

2047 
	`mb_ÿche_’Œy_put
(
—_block_ÿche
, 
û
);

2048 
û
 = 
NULL
;

2049 } ià(
bs
->
bh
 && 
s
->
ba£
 =ğbs->bh->
b_d©a
) {

2051 
	`—_bdebug
(
bs
->
bh
, "keepinghis block");

2052 
	`ext4_x©Œ_block_ÿche_š£¹
(
—_block_ÿche
, 
bs
->
bh
);

2053 
Ãw_bh
 = 
bs
->
bh
;

2054 
	`g‘_bh
(
Ãw_bh
);

2057 
ext4_fsblk_t
 
gßl
, 
block
;

2059 
	`WARN_ON_ONCE
(
	`dquÙ_š™Ÿlize_Ãeded
(
šode
));

2061 
gßl
 = 
	`ext4_group_fœ¡_block_no
(
sb
,

2062 
	`EXT4_I
(
šode
)->
i_block_group
);

2065 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)))

2066 
gßl
 = gßÈ& 
EXT4_MAX_BLOCK_FILE_PHYS
;

2068 
block
 = 
	`ext4_Ãw_m‘a_blocks
(
hªdË
, 
šode
, 
gßl
, 0,

2069 
NULL
, &
”rÜ
);

2070 ià(
”rÜ
)

2071 
ş—nup
;

2073 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)))

2074 
	`BUG_ON
(
block
 > 
EXT4_MAX_BLOCK_FILE_PHYS
);

2076 
	`—_idebug
(
šode
, "creating block %llu",

2077 ()
block
);

2079 
Ãw_bh
 = 
	`sb_g‘blk
(
sb
, 
block
);

2080 ià(
	`uÆik–y
(!
Ãw_bh
)) {

2081 
”rÜ
 = -
ENOMEM
;

2082 
g‘blk_çed
:

2083 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
block
, 1,

2084 
EXT4_FREE_BLOCKS_METADATA
);

2085 
ş—nup
;

2087 
”rÜ
 = 
	`ext4_x©Œ_šode_šc_»f_®l
(
hªdË
, 
šode
,

2088 
	`ENTRY
(
	`h—d”
(
s
->
ba£
)+1));

2089 ià(
”rÜ
)

2090 
g‘blk_çed
;

2091 ià(
—_šode
) {

2093 
”rÜ
 = 
	`ext4_x©Œ_šode_dec_»f
(
hªdË
,

2094 
—_šode
);

2095 ià(
”rÜ
)

2096 
	`ext4_w¬nšg_šode
(
—_šode
,

2098 
”rÜ
);

2099 
	`ut
(
—_šode
);

2100 
—_šode
 = 
NULL
;

2103 
	`lock_bufãr
(
Ãw_bh
);

2104 
”rÜ
 = 
	`ext4_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
Ãw_bh
);

2105 ià(
”rÜ
) {

2106 
	`uÆock_bufãr
(
Ãw_bh
);

2107 
”rÜ
 = -
EIO
;

2108 
g‘blk_çed
;

2110 
	`memıy
(
Ãw_bh
->
b_d©a
, 
s
->
ba£
,‚ew_bh->
b_size
);

2111 
	`ext4_x©Œ_block_csum_£t
(
šode
, 
Ãw_bh
);

2112 
	`£t_bufãr_u±od©e
(
Ãw_bh
);

2113 
	`uÆock_bufãr
(
Ãw_bh
);

2114 
	`ext4_x©Œ_block_ÿche_š£¹
(
—_block_ÿche
, 
Ãw_bh
);

2115 
”rÜ
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
,

2116 
Ãw_bh
);

2117 ià(
”rÜ
)

2118 
ş—nup
;

2122 ià(
Şd_—_šode_quÙa
)

2123 
	`ext4_x©Œ_šode_ä“_quÙa
(
šode
, 
NULL
, 
Şd_—_šode_quÙa
);

2126 
	`EXT4_I
(
šode
)->
i_fe_aş
 = 
Ãw_bh
 ?‚ew_bh->
b_blockÄ
 : 0;

2129 ià(
bs
->
bh
 && bs->bh !ğ
Ãw_bh
) {

2130 
ext4_x©Œ_šode_¬¿y
 *
—_šode_¬¿y
 = 
NULL
;

2132 
	`ext4_x©Œ_»Ëa£_block
(
hªdË
, 
šode
, 
bs
->
bh
,

2133 &
—_šode_¬¿y
,

2135 
	`ext4_x©Œ_šode_¬¿y_ä“
(
—_šode_¬¿y
);

2137 
”rÜ
 = 0;

2139 
ş—nup
:

2140 ià(
—_šode
) {

2141 
”rÜ2
;

2143 
”rÜ2
 = 
	`ext4_x©Œ_šode_dec_»f
(
hªdË
, 
—_šode
);

2144 ià(
”rÜ2
)

2145 
	`ext4_w¬nšg_šode
(
—_šode
, "dec„efƒrror=%d",

2146 
”rÜ2
);

2149 ià(
”rÜ
)

2150 
	`ext4_x©Œ_šode_ä“_quÙa
(
šode
, 
—_šode
,

2151 
	`i_size_»ad
(
—_šode
));

2152 
	`ut
(
—_šode
);

2154 ià(
û
)

2155 
	`mb_ÿche_’Œy_put
(
—_block_ÿche
, 
û
);

2156 
	`b»l£
(
Ãw_bh
);

2157 ià(!(
bs
->
bh
 && 
s
->
ba£
 =ğbs->bh->
b_d©a
))

2158 
	`kä“
(
s
->
ba£
);

2160  
”rÜ
;

2162 
ş—nup_dquÙ
:

2163 
	`dquÙ_ä“_block
(
šode
, 
	`EXT4_C2B
(
	`EXT4_SB
(
sb
), 1));

2164 
ş—nup
;

2166 
bad_block
:

2167 
	`EXT4_ERROR_INODE
(
šode
, "bad block %llu",

2168 
	`EXT4_I
(
šode
)->
i_fe_aş
);

2169 
ş—nup
;

2171 #undeà
h—d”


2172 
	}
}

2174 
	$ext4_x©Œ_ibody_fšd
(
šode
 *šode, 
ext4_x©Œ_šfo
 *
i
,

2175 
ext4_x©Œ_ibody_fšd
 *
is
)

2177 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

2178 
ext4_šode
 *
¿w_šode
;

2179 
”rÜ
;

2181 ià(
	`EXT4_I
(
šode
)->
i_exŒa_isize
 == 0)

2183 
¿w_šode
 = 
	`ext4_¿w_šode
(&
is
->
oc
);

2184 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

2185 
is
->
s
.
ba£
 = is->s.
fœ¡
 = 
	`IFIRST
(
h—d”
);

2186 
is
->
s
.
h”e
 = is->s.
fœ¡
;

2187 
is
->
s
.
’d
 = (*)
¿w_šode
 + 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
;

2188 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
)) {

2189 
”rÜ
 = 
	`x©Œ_check_šode
(
šode
, 
h—d”
, 
is
->
s
.
’d
);

2190 ià(
”rÜ
)

2191  
”rÜ
;

2193 
”rÜ
 = 
	`x©Œ_fšd_’Œy
(
šode
, &
is
->
s
.
h”e
, is->s.
’d
,

2194 
i
->
Çme_šdex
, i->
Çme
, 0);

2195 ià(
”rÜ
 &&ƒ¼Ü !ğ-
ENODATA
)

2196  
”rÜ
;

2197 
is
->
s
.
nÙ_found
 = 
”rÜ
;

2200 
	}
}

2202 
	$ext4_x©Œ_ibody_šlše_£t
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2203 
ext4_x©Œ_šfo
 *
i
,

2204 
ext4_x©Œ_ibody_fšd
 *
is
)

2206 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

2207 
ext4_x©Œ_£¬ch
 *
s
 = &
is
->s;

2208 
”rÜ
;

2210 ià(
	`EXT4_I
(
šode
)->
i_exŒa_isize
 == 0)

2211  -
ENOSPC
;

2212 
”rÜ
 = 
	`ext4_x©Œ_£t_’Œy
(
i
, 
s
, 
hªdË
, 
šode
, 
çl£
 );

2213 ià(
”rÜ
)

2214  
”rÜ
;

2215 
h—d”
 = 
	`IHDR
(
šode
, 
	`ext4_¿w_šode
(&
is
->
oc
));

2216 ià(!
	`IS_LAST_ENTRY
(
s
->
fœ¡
)) {

2217 
h—d”
->
h_magic
 = 
	`ıu_to_Ë32
(
EXT4_XATTR_MAGIC
);

2218 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
);

2220 
h—d”
->
h_magic
 = 
	`ıu_to_Ë32
(0);

2221 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
);

2224 
	}
}

2226 
	$ext4_x©Œ_ibody_£t
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2227 
ext4_x©Œ_šfo
 *
i
,

2228 
ext4_x©Œ_ibody_fšd
 *
is
)

2230 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

2231 
ext4_x©Œ_£¬ch
 *
s
 = &
is
->s;

2232 
”rÜ
;

2234 ià(
	`EXT4_I
(
šode
)->
i_exŒa_isize
 == 0)

2235  -
ENOSPC
;

2236 
”rÜ
 = 
	`ext4_x©Œ_£t_’Œy
(
i
, 
s
, 
hªdË
, 
šode
, 
çl£
 );

2237 ià(
”rÜ
)

2238  
”rÜ
;

2239 
h—d”
 = 
	`IHDR
(
šode
, 
	`ext4_¿w_šode
(&
is
->
oc
));

2240 ià(!
	`IS_LAST_ENTRY
(
s
->
fœ¡
)) {

2241 
h—d”
->
h_magic
 = 
	`ıu_to_Ë32
(
EXT4_XATTR_MAGIC
);

2242 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
);

2244 
h—d”
->
h_magic
 = 
	`ıu_to_Ë32
(0);

2245 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
);

2248 
	}
}

2250 
	$ext4_x©Œ_v®ue_§me
(
ext4_x©Œ_£¬ch
 *
s
,

2251 
ext4_x©Œ_šfo
 *
i
)

2253 *
v®ue
;

2256 ià(
s
->
h”e
->
e_v®ue_šum
)

2258 ià(
	`Ë32_to_ıu
(
s
->
h”e
->
e_v®ue_size
è!ğ
i
->
v®ue_Ën
)

2260 
v®ue
 = ((*)
s
->
ba£
è+ 
	`Ë16_to_ıu
(s->
h”e
->
e_v®ue_offs
);

2261  !
	`memcmp
(
v®ue
, 
i
->v®ue, i->
v®ue_Ën
);

2262 
	}
}

2264 
bufãr_h—d
 *
	$ext4_x©Œ_g‘_block
(
šode
 *inode)

2266 
bufãr_h—d
 *
bh
;

2267 
”rÜ
;

2269 ià(!
	`EXT4_I
(
šode
)->
i_fe_aş
)

2270  
NULL
;

2271 
bh
 = 
	`ext4_sb_b»ad
(
šode
->
i_sb
, 
	`EXT4_I
(šode)->
i_fe_aş
, 
REQ_PRIO
);

2272 ià(
	`IS_ERR
(
bh
))

2273  
bh
;

2274 
”rÜ
 = 
	`ext4_x©Œ_check_block
(
šode
, 
bh
);

2275 ià(
”rÜ
) {

2276 
	`b»l£
(
bh
);

2277  
	`ERR_PTR
(
”rÜ
);

2279  
bh
;

2280 
	}
}

2295 
	$ext4_x©Œ_£t_hªdË
(
hªdË_t
 *
hªdË
, 
šode
 *šode, 
Çme_šdex
,

2296 cÚ¡ *
Çme
, cÚ¡ *
v®ue
, 
size_t
 
v®ue_Ën
,

2297 
æags
)

2299 
ext4_x©Œ_šfo
 
i
 = {

2300 .
Çme_šdex
 =‚ame_index,

2301 .
Çme
 =‚ame,

2302 .
v®ue
 = value,

2303 .
v®ue_Ën
 = value_len,

2304 .
š_šode
 = 0,

2306 
ext4_x©Œ_ibody_fšd
 
is
 = {

2307 .
s
 = { .
nÙ_found
 = -
ENODATA
, },

2309 
ext4_x©Œ_block_fšd
 
bs
 = {

2310 .
s
 = { .
nÙ_found
 = -
ENODATA
, },

2312 
no_ex·nd
;

2313 
”rÜ
;

2315 ià(!
Çme
)

2316  -
EINVAL
;

2317 ià(
	`¡¾’
(
Çme
) > 255)

2318  -
ERANGE
;

2320 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

2323 ià(
	`ext4_hªdË_v®id
(
hªdË
)) {

2324 
bufãr_h—d
 *
bh
;

2325 
üed™s
;

2327 
bh
 = 
	`ext4_x©Œ_g‘_block
(
šode
);

2328 ià(
	`IS_ERR
(
bh
)) {

2329 
”rÜ
 = 
	`PTR_ERR
(
bh
);

2330 
ş—nup
;

2333 
üed™s
 = 
	`__ext4_x©Œ_£t_üed™s
(
šode
->
i_sb
, inode, 
bh
,

2334 
v®ue_Ën
,

2335 
æags
 & 
XATTR_CREATE
);

2336 
	`b»l£
(
bh
);

2338 ià(!
	`ext4_hªdË_has_’ough_üed™s
(
hªdË
, 
üed™s
)) {

2339 
”rÜ
 = -
ENOSPC
;

2340 
ş—nup
;

2344 
”rÜ
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
is
.
oc
);

2345 ià(
”rÜ
)

2346 
ş—nup
;

2348 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NEW
)) {

2349 
ext4_šode
 *
¿w_šode
 = 
	`ext4_¿w_šode
(&
is
.
oc
);

2350 
	`mem£t
(
¿w_šode
, 0, 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
);

2351 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_NEW
);

2354 
”rÜ
 = 
	`ext4_x©Œ_ibody_fšd
(
šode
, &
i
, &
is
);

2355 ià(
”rÜ
)

2356 
ş—nup
;

2357 ià(
is
.
s
.
nÙ_found
)

2358 
”rÜ
 = 
	`ext4_x©Œ_block_fšd
(
šode
, &
i
, &
bs
);

2359 ià(
”rÜ
)

2360 
ş—nup
;

2361 ià(
is
.
s
.
nÙ_found
 && 
bs
.s.not_found) {

2362 
”rÜ
 = -
ENODATA
;

2363 ià(
æags
 & 
XATTR_REPLACE
)

2364 
ş—nup
;

2365 
”rÜ
 = 0;

2366 ià(!
v®ue
)

2367 
ş—nup
;

2369 
”rÜ
 = -
EEXIST
;

2370 ià(
æags
 & 
XATTR_CREATE
)

2371 
ş—nup
;

2374 ià(!
v®ue
) {

2375 ià(!
is
.
s
.
nÙ_found
)

2376 
”rÜ
 = 
	`ext4_x©Œ_ibody_£t
(
hªdË
, 
šode
, &
i
, &
is
);

2377 ià(!
bs
.
s
.
nÙ_found
)

2378 
”rÜ
 = 
	`ext4_x©Œ_block_£t
(
hªdË
, 
šode
, &
i
, &
bs
);

2380 
”rÜ
 = 0;

2382 ià(!
is
.
s
.
nÙ_found
 && 
	`ext4_x©Œ_v®ue_§me
(&is.s, &
i
))

2383 
ş—nup
;

2384 ià(!
bs
.
s
.
nÙ_found
 && 
	`ext4_x©Œ_v®ue_§me
(&bs.s, &
i
))

2385 
ş—nup
;

2387 ià(
	`ext4_has_ã©u»_—_šode
(
šode
->
i_sb
) &&

2388 (
	`EXT4_XATTR_SIZE
(
i
.
v®ue_Ën
) >

2389 
	`EXT4_XATTR_MIN_LARGE_EA_SIZE
(
šode
->
i_sb
->
s_blocksize
)))

2390 
i
.
š_šode
 = 1;

2391 
»Œy_šode
:

2392 
”rÜ
 = 
	`ext4_x©Œ_ibody_£t
(
hªdË
, 
šode
, &
i
, &
is
);

2393 ià(!
”rÜ
 && !
bs
.
s
.
nÙ_found
) {

2394 
i
.
v®ue
 = 
NULL
;

2395 
”rÜ
 = 
	`ext4_x©Œ_block_£t
(
hªdË
, 
šode
, &
i
, &
bs
);

2396 } ià(
”rÜ
 =ğ-
ENOSPC
) {

2397 ià(
	`EXT4_I
(
šode
)->
i_fe_aş
 && !
bs
.
s
.
ba£
) {

2398 
	`b»l£
(
bs
.
bh
);

2399 
bs
.
bh
 = 
NULL
;

2400 
”rÜ
 = 
	`ext4_x©Œ_block_fšd
(
šode
, &
i
, &
bs
);

2401 ià(
”rÜ
)

2402 
ş—nup
;

2404 
”rÜ
 = 
	`ext4_x©Œ_block_£t
(
hªdË
, 
šode
, &
i
, &
bs
);

2405 ià(!
”rÜ
 && !
is
.
s
.
nÙ_found
) {

2406 
i
.
v®ue
 = 
NULL
;

2407 
”rÜ
 = 
	`ext4_x©Œ_ibody_£t
(
hªdË
, 
šode
, &
i
,

2408 &
is
);

2409 } ià(
”rÜ
 =ğ-
ENOSPC
) {

2414 ià(
	`ext4_has_ã©u»_—_šode
(
šode
->
i_sb
) &&

2415 !
i
.
š_šode
) {

2416 
i
.
š_šode
 = 1;

2417 
»Œy_šode
;

2422 ià(!
”rÜ
) {

2423 
	`ext4_x©Œ_upd©e_su³r_block
(
hªdË
, 
šode
->
i_sb
);

2424 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

2425 ià(!
v®ue
)

2426 
no_ex·nd
 = 0;

2427 
”rÜ
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
is
.
oc
);

2432 
is
.
oc
.
bh
 = 
NULL
;

2433 ià(
	`IS_SYNC
(
šode
))

2434 
	`ext4_hªdË_sync
(
hªdË
);

2437 
ş—nup
:

2438 
	`b»l£
(
is
.
oc
.
bh
);

2439 
	`b»l£
(
bs
.
bh
);

2440 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

2441  
”rÜ
;

2442 
	}
}

2444 
	$ext4_x©Œ_£t_üed™s
(
šode
 *šode, 
size_t
 
v®ue_Ën
,

2445 
boŞ
 
is_ü—‹
, *
üed™s
)

2447 
bufãr_h—d
 *
bh
;

2448 
”r
;

2450 *
üed™s
 = 0;

2452 ià(!
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
)

2455 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

2457 
bh
 = 
	`ext4_x©Œ_g‘_block
(
šode
);

2458 ià(
	`IS_ERR
(
bh
)) {

2459 
”r
 = 
	`PTR_ERR
(
bh
);

2461 *
üed™s
 = 
	`__ext4_x©Œ_£t_üed™s
(
šode
->
i_sb
, inode, 
bh
,

2462 
v®ue_Ën
, 
is_ü—‹
);

2463 
	`b»l£
(
bh
);

2464 
”r
 = 0;

2467 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

2468  
”r
;

2469 
	}
}

2480 
	$ext4_x©Œ_£t
(
šode
 *šode, 
Çme_šdex
, cÚ¡ *
Çme
,

2481 cÚ¡ *
v®ue
, 
size_t
 
v®ue_Ën
, 
æags
)

2483 
hªdË_t
 *
hªdË
;

2484 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

2485 
”rÜ
, 
»Œ›s
 = 0;

2486 
üed™s
;

2488 
”rÜ
 = 
	`dquÙ_š™Ÿlize
(
šode
);

2489 ià(
”rÜ
)

2490  
”rÜ
;

2492 
»Œy
:

2493 
”rÜ
 = 
	`ext4_x©Œ_£t_üed™s
(
šode
, 
v®ue_Ën
, 
æags
 & 
XATTR_CREATE
,

2494 &
üed™s
);

2495 ià(
”rÜ
)

2496  
”rÜ
;

2498 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_XATTR
, 
üed™s
);

2499 ià(
	`IS_ERR
(
hªdË
)) {

2500 
”rÜ
 = 
	`PTR_ERR
(
hªdË
);

2502 
”rÜ2
;

2504 
”rÜ
 = 
	`ext4_x©Œ_£t_hªdË
(
hªdË
, 
šode
, 
Çme_šdex
, 
Çme
,

2505 
v®ue
, 
v®ue_Ën
, 
æags
);

2506 
”rÜ2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

2507 ià(
”rÜ
 =ğ-
ENOSPC
 &&

2508 
	`ext4_should_»Œy_®loc
(
sb
, &
»Œ›s
))

2509 
»Œy
;

2510 ià(
”rÜ
 == 0)

2511 
”rÜ
 = 
”rÜ2
;

2514  
”rÜ
;

2515 
	}
}

2521 
	$ext4_x©Œ_shiá_’Œ›s
(
ext4_x©Œ_’Œy
 *
’Œy
,

2522 
v®ue_offs_shiá
, *
to
,

2523 *
äom
, 
size_t
 
n
)

2525 
ext4_x©Œ_’Œy
 *
Ï¡
 = 
’Œy
;

2526 
Ãw_offs
;

2529 
	`BUG_ON
(
v®ue_offs_shiá
 > 0);

2532 ; !
	`IS_LAST_ENTRY
(
Ï¡
);†a¡ = 
	`EXT4_XATTR_NEXT
(last)) {

2533 ià(!
Ï¡
->
e_v®ue_šum
 &&†a¡->
e_v®ue_size
) {

2534 
Ãw_offs
 = 
	`Ë16_to_ıu
(
Ï¡
->
e_v®ue_offs
) +

2535 
v®ue_offs_shiá
;

2536 
Ï¡
->
e_v®ue_offs
 = 
	`ıu_to_Ë16
(
Ãw_offs
);

2540 
	`memmove
(
to
, 
äom
, 
n
);

2541 
	}
}

2546 
	$ext4_x©Œ_move_to_block
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2547 
ext4_šode
 *
¿w_šode
,

2548 
ext4_x©Œ_’Œy
 *
’Œy
)

2550 
ext4_x©Œ_ibody_fšd
 *
is
 = 
NULL
;

2551 
ext4_x©Œ_block_fšd
 *
bs
 = 
NULL
;

2552 *
bufãr
 = 
NULL
, *
b_’Œy_Çme
 = NULL;

2553 
size_t
 
v®ue_size
 = 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
);

2554 
ext4_x©Œ_šfo
 
i
 = {

2555 .
v®ue
 = 
NULL
,

2556 .
v®ue_Ën
 = 0,

2557 .
Çme_šdex
 = 
’Œy
->
e_Çme_šdex
,

2558 .
š_šode
 = !!
’Œy
->
e_v®ue_šum
,

2560 
ext4_x©Œ_ibody_h—d”
 *
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

2561 
”rÜ
;

2563 
is
 = 
	`kz®loc
((
ext4_x©Œ_ibody_fšd
), 
GFP_NOFS
);

2564 
bs
 = 
	`kz®loc
((
ext4_x©Œ_block_fšd
), 
GFP_NOFS
);

2565 
bufãr
 = 
	`km®loc
(
v®ue_size
, 
GFP_NOFS
);

2566 
b_’Œy_Çme
 = 
	`km®loc
(
’Œy
->
e_Çme_Ën
 + 1, 
GFP_NOFS
);

2567 ià(!
is
 || !
bs
 || !
bufãr
 || !
b_’Œy_Çme
) {

2568 
”rÜ
 = -
ENOMEM
;

2569 
out
;

2572 
is
->
s
.
nÙ_found
 = -
ENODATA
;

2573 
bs
->
s
.
nÙ_found
 = -
ENODATA
;

2574 
is
->
oc
.
bh
 = 
NULL
;

2575 
bs
->
bh
 = 
NULL
;

2578 ià(
’Œy
->
e_v®ue_šum
) {

2579 
”rÜ
 = 
	`ext4_x©Œ_šode_g‘
(
šode
, 
’Œy
, 
bufãr
, 
v®ue_size
);

2580 ià(
”rÜ
)

2581 
out
;

2583 
size_t
 
v®ue_offs
 = 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_offs
);

2584 
	`memıy
(
bufãr
, (*)
	`IFIRST
(
h—d”
è+ 
v®ue_offs
, 
v®ue_size
);

2587 
	`memıy
(
b_’Œy_Çme
, 
’Œy
->
e_Çme
,ƒÁry->
e_Çme_Ën
);

2588 
b_’Œy_Çme
[
’Œy
->
e_Çme_Ën
] = '\0';

2589 
i
.
Çme
 = 
b_’Œy_Çme
;

2591 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
is
->
oc
);

2592 ià(
”rÜ
)

2593 
out
;

2595 
”rÜ
 = 
	`ext4_x©Œ_ibody_fšd
(
šode
, &
i
, 
is
);

2596 ià(
”rÜ
)

2597 
out
;

2600 
”rÜ
 = 
	`ext4_x©Œ_ibody_£t
(
hªdË
, 
šode
, &
i
, 
is
);

2601 ià(
”rÜ
)

2602 
out
;

2604 
i
.
v®ue
 = 
bufãr
;

2605 
i
.
v®ue_Ën
 = 
v®ue_size
;

2606 
”rÜ
 = 
	`ext4_x©Œ_block_fšd
(
šode
, &
i
, 
bs
);

2607 ià(
”rÜ
)

2608 
out
;

2611 
”rÜ
 = 
	`ext4_x©Œ_block_£t
(
hªdË
, 
šode
, &
i
, 
bs
);

2612 ià(
”rÜ
)

2613 
out
;

2614 
”rÜ
 = 0;

2615 
out
:

2616 
	`kä“
(
b_’Œy_Çme
);

2617 
	`kä“
(
bufãr
);

2618 ià(
is
)

2619 
	`b»l£
(
is
->
oc
.
bh
);

2620 ià(
bs
)

2621 
	`b»l£
(
bs
->
bh
);

2622 
	`kä“
(
is
);

2623 
	`kä“
(
bs
);

2625  
”rÜ
;

2626 
	}
}

2628 
	$ext4_x©Œ_make_šode_¥aû
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2629 
ext4_šode
 *
¿w_šode
,

2630 
isize_diff
, 
size_t
 
iä“
,

2631 
size_t
 
bä“
, *
tÙ®_šo
)

2633 
ext4_x©Œ_ibody_h—d”
 *
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

2634 
ext4_x©Œ_’Œy
 *
sm®l_’Œy
;

2635 
ext4_x©Œ_’Œy
 *
’Œy
;

2636 
ext4_x©Œ_’Œy
 *
Ï¡
;

2637 
’Œy_size
;

2638 
tÙ®_size
;

2639 
mš_tÙ®_size
;

2640 
”rÜ
;

2642 
isize_diff
 > 
iä“
) {

2643 
’Œy
 = 
NULL
;

2644 
sm®l_’Œy
 = 
NULL
;

2645 
mš_tÙ®_size
 = ~0U;

2646 
Ï¡
 = 
	`IFIRST
(
h—d”
);

2648 ; !
	`IS_LAST_ENTRY
(
Ï¡
);†a¡ = 
	`EXT4_XATTR_NEXT
(last)) {

2650 ià((
Ï¡
->
e_Çme_Ën
 == 4) &&

2651 (
Ï¡
->
e_Çme_šdex
 =ğ
EXT4_XATTR_INDEX_SYSTEM
) &&

2652 !
	`memcmp
(
Ï¡
->
e_Çme
, "data", 4))

2654 
tÙ®_size
 = 
	`EXT4_XATTR_LEN
(
Ï¡
->
e_Çme_Ën
);

2655 ià(!
Ï¡
->
e_v®ue_šum
)

2656 
tÙ®_size
 +ğ
	`EXT4_XATTR_SIZE
(

2657 
	`Ë32_to_ıu
(
Ï¡
->
e_v®ue_size
));

2658 ià(
tÙ®_size
 <ğ
bä“
 &&

2659 
tÙ®_size
 < 
mš_tÙ®_size
) {

2660 ià(
tÙ®_size
 + 
iä“
 < 
isize_diff
) {

2661 
sm®l_’Œy
 = 
Ï¡
;

2663 
’Œy
 = 
Ï¡
;

2664 
mš_tÙ®_size
 = 
tÙ®_size
;

2669 ià(
’Œy
 =ğ
NULL
) {

2670 ià(
sm®l_’Œy
 =ğ
NULL
)

2671  -
ENOSPC
;

2672 
’Œy
 = 
sm®l_’Œy
;

2675 
’Œy_size
 = 
	`EXT4_XATTR_LEN
(
’Œy
->
e_Çme_Ën
);

2676 
tÙ®_size
 = 
’Œy_size
;

2677 ià(!
’Œy
->
e_v®ue_šum
)

2678 
tÙ®_size
 +ğ
	`EXT4_XATTR_SIZE
(

2679 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
));

2680 
”rÜ
 = 
	`ext4_x©Œ_move_to_block
(
hªdË
, 
šode
, 
¿w_šode
,

2681 
’Œy
);

2682 ià(
”rÜ
)

2683  
”rÜ
;

2685 *
tÙ®_šo
 -ğ
’Œy_size
;

2686 
iä“
 +ğ
tÙ®_size
;

2687 
bä“
 -ğ
tÙ®_size
;

2691 
	}
}

2697 
	$ext4_ex·nd_exŒa_isize_—
(
šode
 *šode, 
Ãw_exŒa_isize
,

2698 
ext4_šode
 *
¿w_šode
, 
hªdË_t
 *
hªdË
)

2700 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

2701 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

2702 
mÁ_couÁ
;

2703 
size_t
 
mš_offs
;

2704 
size_t
 
iä“
, 
bä“
;

2705 
tÙ®_šo
;

2706 *
ba£
, *
’d
;

2707 
”rÜ
 = 0, 
Œ›d_mš_exŒa_isize
 = 0;

2708 
s_mš_exŒa_isize
 = 
	`Ë16_to_ıu
(
sbi
->
s_es
->s_min_extra_isize);

2709 
isize_diff
;

2711 
»Œy
:

2712 
isize_diff
 = 
Ãw_exŒa_isize
 - 
	`EXT4_I
(
šode
)->
i_exŒa_isize
;

2713 ià(
	`EXT4_I
(
šode
)->
i_exŒa_isize
 >ğ
Ãw_exŒa_isize
)

2716 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

2723 
ba£
 = 
	`IFIRST
(
h—d”
);

2724 
’d
 = (*)
¿w_šode
 + 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
;

2725 
mš_offs
 = 
’d
 - 
ba£
;

2726 
tÙ®_šo
 = (
ext4_x©Œ_ibody_h—d”
è+ (
u32
);

2728 
”rÜ
 = 
	`x©Œ_check_šode
(
šode
, 
h—d”
, 
’d
);

2729 ià(
”rÜ
)

2730 
ş—nup
;

2732 
iä“
 = 
	`ext4_x©Œ_ä“_¥aû
(
ba£
, &
mš_offs
, ba£, &
tÙ®_šo
);

2733 ià(
iä“
 >ğ
isize_diff
)

2734 
shiá
;

2740 ià(
	`EXT4_I
(
šode
)->
i_fe_aş
) {

2741 
bufãr_h—d
 *
bh
;

2743 
bh
 = 
	`ext4_sb_b»ad
(
šode
->
i_sb
, 
	`EXT4_I
(šode)->
i_fe_aş
, 
REQ_PRIO
);

2744 ià(
	`IS_ERR
(
bh
)) {

2745 
”rÜ
 = 
	`PTR_ERR
(
bh
);

2746 
ş—nup
;

2748 
”rÜ
 = 
	`ext4_x©Œ_check_block
(
šode
, 
bh
);

2749 ià(
”rÜ
) {

2750 
	`b»l£
(
bh
);

2751 
ş—nup
;

2753 
ba£
 = 
	`BHDR
(
bh
);

2754 
’d
 = 
bh
->
b_d©a
 + bh->
b_size
;

2755 
mš_offs
 = 
’d
 - 
ba£
;

2756 
bä“
 = 
	`ext4_x©Œ_ä“_¥aû
(
	`BFIRST
(
bh
), &
mš_offs
, 
ba£
,

2757 
NULL
);

2758 
	`b»l£
(
bh
);

2759 ià(
bä“
 + 
iä“
 < 
isize_diff
) {

2760 ià(!
Œ›d_mš_exŒa_isize
 && 
s_mš_exŒa_isize
) {

2761 
Œ›d_mš_exŒa_isize
++;

2762 
Ãw_exŒa_isize
 = 
s_mš_exŒa_isize
;

2763 
»Œy
;

2765 
”rÜ
 = -
ENOSPC
;

2766 
ş—nup
;

2769 
bä“
 = 
šode
->
i_sb
->
s_blocksize
;

2772 
”rÜ
 = 
	`ext4_x©Œ_make_šode_¥aû
(
hªdË
, 
šode
, 
¿w_šode
,

2773 
isize_diff
, 
iä“
, 
bä“
,

2774 &
tÙ®_šo
);

2775 ià(
”rÜ
) {

2776 ià(
”rÜ
 =ğ-
ENOSPC
 && !
Œ›d_mš_exŒa_isize
 &&

2777 
s_mš_exŒa_isize
) {

2778 
Œ›d_mš_exŒa_isize
++;

2779 
Ãw_exŒa_isize
 = 
s_mš_exŒa_isize
;

2780 
»Œy
;

2782 
ş—nup
;

2784 
shiá
:

2786 
	`ext4_x©Œ_shiá_’Œ›s
(
	`IFIRST
(
h—d”
), 
	`EXT4_I
(
šode
)->
i_exŒa_isize


2787 - 
Ãw_exŒa_isize
, (*)
¿w_šode
 +

2788 
EXT4_GOOD_OLD_INODE_SIZE
 + 
Ãw_exŒa_isize
,

2789 (*)
h—d”
, 
tÙ®_šo
);

2790 
	`EXT4_I
(
šode
)->
i_exŒa_isize
 = 
Ãw_exŒa_isize
;

2792 
ş—nup
:

2793 ià(
”rÜ
 && (
mÁ_couÁ
 !ğ
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_mÁ_couÁ
))) {

2794 
	`ext4_w¬nšg
(
šode
->
i_sb
, "Unableoƒxpand inode %lu. Delete some EAs or„unƒ2fsck.",

2795 
šode
->
i_šo
);

2796 
mÁ_couÁ
 = 
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_mÁ_couÁ
);

2798  
”rÜ
;

2799 
	}
}

2801 
	#EIA_INCR
 16

	)

2802 
	#EIA_MASK
 (
EIA_INCR
 - 1)

	)

2809 
	$ext4_ex·nd_šode_¬¿y
(
ext4_x©Œ_šode_¬¿y
 **
—_šode_¬¿y
,

2810 
šode
 *inode)

2812 ià(*
—_šode_¬¿y
 =ğ
NULL
) {

2817 (*
—_šode_¬¿y
) =

2818 
	`km®loc
(
	`off£tof
(
ext4_x©Œ_šode_¬¿y
,

2819 
šodes
[
EIA_MASK
]),

2820 
GFP_NOFS
);

2821 ià(*
—_šode_¬¿y
 =ğ
NULL
)

2822  -
ENOMEM
;

2823 (*
—_šode_¬¿y
)->
couÁ
 = 0;

2824 } ià(((*
—_šode_¬¿y
)->
couÁ
 & 
EIA_MASK
) == EIA_MASK) {

2826 
ext4_x©Œ_šode_¬¿y
 *
Ãw_¬¿y
 = 
NULL
;

2827 
couÁ
 = (*
—_šode_¬¿y
)->count;

2830 
Ãw_¬¿y
 = 
	`km®loc
(

2831 
	`off£tof
(
ext4_x©Œ_šode_¬¿y
,

2832 
šodes
[
couÁ
 + 
EIA_INCR
]),

2833 
GFP_NOFS
);

2834 ià(
Ãw_¬¿y
 =ğ
NULL
)

2835  -
ENOMEM
;

2836 
	`memıy
(
Ãw_¬¿y
, *
—_šode_¬¿y
,

2837 
	`off£tof
(
ext4_x©Œ_šode_¬¿y
, 
šodes
[
couÁ
]));

2838 
	`kä“
(*
—_šode_¬¿y
);

2839 *
—_šode_¬¿y
 = 
Ãw_¬¿y
;

2841 (*
—_šode_¬¿y
)->
šodes
[(*—_šode_¬¿y)->
couÁ
++] = 
šode
;

2843 
	}
}

2854 
	$ext4_x©Œ_d–‘e_šode
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2855 
ext4_x©Œ_šode_¬¿y
 **
—_šode_¬¿y
,

2856 
exŒa_üed™s
)

2858 
bufãr_h—d
 *
bh
 = 
NULL
;

2859 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

2860 
ext4_oc
 
oc
 = { .
bh
 = 
NULL
 };

2861 
ext4_x©Œ_’Œy
 *
’Œy
;

2862 
šode
 *
—_šode
;

2863 
”rÜ
;

2865 
”rÜ
 = 
	`ext4_x©Œ_’su»_üed™s
(
hªdË
, 
šode
, 
exŒa_üed™s
,

2866 
NULL
 ,

2867 
çl£
 ,

2868 
çl£
 );

2869 ià(
”rÜ
) {

2870 
	`EXT4_ERROR_INODE
(
šode
, "’su» c»d™ Ó¼Ü %d)", 
”rÜ
);

2871 
ş—nup
;

2874 ià(
	`ext4_has_ã©u»_—_šode
(
šode
->
i_sb
) &&

2875 
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
)) {

2877 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

2878 ià(
”rÜ
) {

2879 
	`EXT4_ERROR_INODE
(
šode
, "šodloøÓ¼Ü %d)", 
”rÜ
);

2880 
ş—nup
;

2883 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
oc
.
bh
);

2884 ià(
”rÜ
) {

2885 
	`EXT4_ERROR_INODE
(
šode
, "write‡ccess (error %d)",

2886 
”rÜ
);

2887 
ş—nup
;

2890 
h—d”
 = 
	`IHDR
(
šode
, 
	`ext4_¿w_šode
(&
oc
));

2891 ià(
h—d”
->
h_magic
 =ğ
	`ıu_to_Ë32
(
EXT4_XATTR_MAGIC
))

2892 
	`ext4_x©Œ_šode_dec_»f_®l
(
hªdË
, 
šode
, 
oc
.
bh
,

2893 
	`IFIRST
(
h—d”
),

2894 
çl£
 ,

2895 
—_šode_¬¿y
,

2896 
exŒa_üed™s
,

2897 
çl£
 );

2900 ià(
	`EXT4_I
(
šode
)->
i_fe_aş
) {

2901 
bh
 = 
	`ext4_sb_b»ad
(
šode
->
i_sb
, 
	`EXT4_I
(šode)->
i_fe_aş
, 
REQ_PRIO
);

2902 ià(
	`IS_ERR
(
bh
)) {

2903 
”rÜ
 = 
	`PTR_ERR
(
bh
);

2904 ià(
”rÜ
 =ğ-
EIO
)

2905 
	`EXT4_ERROR_INODE
(
šode
, "block %llu„eadƒrror",

2906 
	`EXT4_I
(
šode
)->
i_fe_aş
);

2907 
bh
 = 
NULL
;

2908 
ş—nup
;

2910 
”rÜ
 = 
	`ext4_x©Œ_check_block
(
šode
, 
bh
);

2911 ià(
”rÜ
)

2912 
ş—nup
;

2914 ià(
	`ext4_has_ã©u»_—_šode
(
šode
->
i_sb
)) {

2915 
’Œy
 = 
	`BFIRST
(
bh
); !
	`IS_LAST_ENTRY
(entry);

2916 
’Œy
 = 
	`EXT4_XATTR_NEXT
(entry)) {

2917 ià(!
’Œy
->
e_v®ue_šum
)

2919 
”rÜ
 = 
	`ext4_x©Œ_šode_ig‘
(
šode
,

2920 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_šum
),

2921 
	`Ë32_to_ıu
(
’Œy
->
e_hash
),

2922 &
—_šode
);

2923 ià(
”rÜ
)

2925 
	`ext4_x©Œ_šode_ä“_quÙa
(
šode
, 
—_šode
,

2926 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
));

2927 
	`ut
(
—_šode
);

2932 
	`ext4_x©Œ_»Ëa£_block
(
hªdË
, 
šode
, 
bh
, 
—_šode_¬¿y
,

2933 
exŒa_üed™s
);

2938 
	`EXT4_I
(
šode
)->
i_fe_aş
 = 0;

2939 
”rÜ
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

2940 ià(
”rÜ
) {

2941 
	`EXT4_ERROR_INODE
(
šode
, "mark inode dirty (error %d)",

2942 
”rÜ
);

2943 
ş—nup
;

2946 
”rÜ
 = 0;

2947 
ş—nup
:

2948 
	`b»l£
(
oc
.
bh
);

2949 
	`b»l£
(
bh
);

2950  
”rÜ
;

2951 
	}
}

2953 
	$ext4_x©Œ_šode_¬¿y_ä“
(
ext4_x©Œ_šode_¬¿y
 *
—_šode_¬¿y
)

2955 
idx
;

2957 ià(
—_šode_¬¿y
 =ğ
NULL
)

2960 
idx
 = 0; idx < 
—_šode_¬¿y
->
couÁ
; ++idx)

2961 
	`ut
(
—_šode_¬¿y
->
šodes
[
idx
]);

2962 
	`kä“
(
—_šode_¬¿y
);

2963 
	}
}

2974 
	$ext4_x©Œ_block_ÿche_š£¹
(
mb_ÿche
 *
—_block_ÿche
,

2975 
bufãr_h—d
 *
bh
)

2977 
ext4_x©Œ_h—d”
 *
h—d”
 = 
	`BHDR
(
bh
);

2978 
__u32
 
hash
 = 
	`Ë32_to_ıu
(
h—d”
->
h_hash
);

2979 
»u§bË
 = 
	`Ë32_to_ıu
(
h—d”
->
h_»fcouÁ
) <

2980 
EXT4_XATTR_REFCOUNT_MAX
;

2981 
”rÜ
;

2983 ià(!
—_block_ÿche
)

2985 
”rÜ
 = 
	`mb_ÿche_’Œy_ü—‹
(
—_block_ÿche
, 
GFP_NOFS
, 
hash
,

2986 
bh
->
b_blockÄ
, 
»u§bË
);

2987 ià(
”rÜ
) {

2988 ià(
”rÜ
 =ğ-
EBUSY
)

2989 
	`—_bdebug
(
bh
, "already in cache");

2991 
	`—_bdebug
(
bh
, "š£¹šg [%x]", ()
hash
);

2992 
	}
}

3003 
	$ext4_x©Œ_cmp
(
ext4_x©Œ_h—d”
 *
h—d”1
,

3004 
ext4_x©Œ_h—d”
 *
h—d”2
)

3006 
ext4_x©Œ_’Œy
 *
’Œy1
, *
’Œy2
;

3008 
’Œy1
 = 
	`ENTRY
(
h—d”1
+1);

3009 
’Œy2
 = 
	`ENTRY
(
h—d”2
+1);

3010 !
	`IS_LAST_ENTRY
(
’Œy1
)) {

3011 ià(
	`IS_LAST_ENTRY
(
’Œy2
))

3013 ià(
’Œy1
->
e_hash
 !ğ
’Œy2
->e_hash ||

3014 
’Œy1
->
e_Çme_šdex
 !ğ
’Œy2
->e_name_index ||

3015 
’Œy1
->
e_Çme_Ën
 !ğ
’Œy2
->e_name_len ||

3016 
’Œy1
->
e_v®ue_size
 !ğ
’Œy2
->e_value_size ||

3017 
’Œy1
->
e_v®ue_šum
 !ğ
’Œy2
->e_value_inum ||

3018 
	`memcmp
(
’Œy1
->
e_Çme
, 
’Œy2
->e_Çme,ƒÁry1->
e_Çme_Ën
))

3020 ià(!
’Œy1
->
e_v®ue_šum
 &&

3021 
	`memcmp
((*)
h—d”1
 + 
	`Ë16_to_ıu
(
’Œy1
->
e_v®ue_offs
),

3022 (*)
h—d”2
 + 
	`Ë16_to_ıu
(
’Œy2
->
e_v®ue_offs
),

3023 
	`Ë32_to_ıu
(
’Œy1
->
e_v®ue_size
)))

3026 
’Œy1
 = 
	`EXT4_XATTR_NEXT
(entry1);

3027 
’Œy2
 = 
	`EXT4_XATTR_NEXT
(entry2);

3029 ià(!
	`IS_LAST_ENTRY
(
’Œy2
))

3032 
	}
}

3042 
bufãr_h—d
 *

3043 
	$ext4_x©Œ_block_ÿche_fšd
(
šode
 *inode,

3044 
ext4_x©Œ_h—d”
 *
h—d”
,

3045 
mb_ÿche_’Œy
 **
pû
)

3047 
__u32
 
hash
 = 
	`Ë32_to_ıu
(
h—d”
->
h_hash
);

3048 
mb_ÿche_’Œy
 *
û
;

3049 
mb_ÿche
 *
—_block_ÿche
 = 
	`EA_BLOCK_CACHE
(
šode
);

3051 ià(!
—_block_ÿche
)

3052  
NULL
;

3053 ià(!
h—d”
->
h_hash
)

3054  
NULL
;

3055 
	`—_idebug
(
šode
, "lookšg fÜ cached block [%x]", ()
hash
);

3056 
û
 = 
	`mb_ÿche_’Œy_fšd_fœ¡
(
—_block_ÿche
, 
hash
);

3057 
û
) {

3058 
bufãr_h—d
 *
bh
;

3060 
bh
 = 
	`ext4_sb_b»ad
(
šode
->
i_sb
, 
û
->
e_v®ue
, 
REQ_PRIO
);

3061 ià(
	`IS_ERR
(
bh
)) {

3062 ià(
	`PTR_ERR
(
bh
è=ğ-
ENOMEM
)

3063  
NULL
;

3064 
bh
 = 
NULL
;

3065 
	`EXT4_ERROR_INODE
(
šode
, "block %lu„eadƒrror",

3066 ()
û
->
e_v®ue
);

3067 } ià(
	`ext4_x©Œ_cmp
(
h—d”
, 
	`BHDR
(
bh
)) == 0) {

3068 *
pû
 = 
û
;

3069  
bh
;

3071 
	`b»l£
(
bh
);

3072 
û
 = 
	`mb_ÿche_’Œy_fšd_Ãxt
(
—_block_ÿche
, ce);

3074  
NULL
;

3075 
	}
}

3077 
	#NAME_HASH_SHIFT
 5

	)

3078 
	#VALUE_HASH_SHIFT
 16

	)

3085 
__Ë32
 
	$ext4_x©Œ_hash_’Œy
(*
Çme
, 
size_t
 
Çme_Ën
, 
__Ë32
 *
v®ue
,

3086 
size_t
 
v®ue_couÁ
)

3088 
__u32
 
hash
 = 0;

3090 
Çme_Ën
--) {

3091 
hash
 = (hash << 
NAME_HASH_SHIFT
) ^

3092 (
hash
 >> (8*(hashè- 
NAME_HASH_SHIFT
)) ^

3093 *
Çme
++;

3095 
v®ue_couÁ
--) {

3096 
hash
 = (hash << 
VALUE_HASH_SHIFT
) ^

3097 (
hash
 >> (8*(hashè- 
VALUE_HASH_SHIFT
)) ^

3098 
	`Ë32_to_ıu
(*
v®ue
++);

3100  
	`ıu_to_Ë32
(
hash
);

3101 
	}
}

3103 #undeà
NAME_HASH_SHIFT


3104 #undeà
VALUE_HASH_SHIFT


3106 
	#BLOCK_HASH_SHIFT
 16

	)

3113 
	$ext4_x©Œ_»hash
(
ext4_x©Œ_h—d”
 *
h—d”
)

3115 
ext4_x©Œ_’Œy
 *
h”e
;

3116 
__u32
 
hash
 = 0;

3118 
h”e
 = 
	`ENTRY
(
h—d”
+1);

3119 !
	`IS_LAST_ENTRY
(
h”e
)) {

3120 ià(!
h”e
->
e_hash
) {

3122 
hash
 = 0;

3125 
hash
 = (hash << 
BLOCK_HASH_SHIFT
) ^

3126 (
hash
 >> (8*(hashè- 
BLOCK_HASH_SHIFT
)) ^

3127 
	`Ë32_to_ıu
(
h”e
->
e_hash
);

3128 
h”e
 = 
	`EXT4_XATTR_NEXT
(here);

3130 
h—d”
->
h_hash
 = 
	`ıu_to_Ë32
(
hash
);

3131 
	}
}

3133 #undeà
BLOCK_HASH_SHIFT


3135 
	#HASH_BUCKET_BITS
 10

	)

3137 
mb_ÿche
 *

3138 
	$ext4_x©Œ_ü—‹_ÿche
()

3140  
	`mb_ÿche_ü—‹
(
HASH_BUCKET_BITS
);

3141 
	}
}

3143 
	$ext4_x©Œ_de¡roy_ÿche
(
mb_ÿche
 *
ÿche
)

3145 ià(
ÿche
)

3146 
	`mb_ÿche_de¡roy
(
ÿche
);

3147 
	}
}

	@pxt4/xattr.h

10 
	~<lšux/x©Œ.h
>

13 
	#EXT4_XATTR_MAGIC
 0xEA020000

	)

16 
	#EXT4_XATTR_REFCOUNT_MAX
 1024

	)

19 
	#EXT4_XATTR_INDEX_USER
 1

	)

20 
	#EXT4_XATTR_INDEX_POSIX_ACL_ACCESS
 2

	)

21 
	#EXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
 3

	)

22 
	#EXT4_XATTR_INDEX_TRUSTED
 4

	)

23 
	#EXT4_XATTR_INDEX_LUSTRE
 5

	)

24 
	#EXT4_XATTR_INDEX_SECURITY
 6

	)

25 
	#EXT4_XATTR_INDEX_SYSTEM
 7

	)

26 
	#EXT4_XATTR_INDEX_RICHACL
 8

	)

27 
	#EXT4_XATTR_INDEX_ENCRYPTION
 9

	)

28 
	#EXT4_XATTR_INDEX_HURD
 10

	)

30 
	sext4_x©Œ_h—d”
 {

31 
__Ë32
 
	mh_magic
;

32 
__Ë32
 
	mh_»fcouÁ
;

33 
__Ë32
 
	mh_blocks
;

34 
__Ë32
 
	mh_hash
;

35 
__Ë32
 
	mh_checksum
;

37 
__u32
 
	mh_»£rved
[3];

40 
	sext4_x©Œ_ibody_h—d”
 {

41 
__Ë32
 
	mh_magic
;

44 
	sext4_x©Œ_’Œy
 {

45 
__u8
 
	me_Çme_Ën
;

46 
__u8
 
	me_Çme_šdex
;

47 
__Ë16
 
	me_v®ue_offs
;

48 
__Ë32
 
	me_v®ue_šum
;

49 
__Ë32
 
	me_v®ue_size
;

50 
__Ë32
 
	me_hash
;

51 
	me_Çme
[0];

54 
	#EXT4_XATTR_PAD_BITS
 2

	)

55 
	#EXT4_XATTR_PAD
 (1<<
EXT4_XATTR_PAD_BITS
)

	)

56 
	#EXT4_XATTR_ROUND
 (
EXT4_XATTR_PAD
-1)

	)

57 
	#EXT4_XATTR_LEN
(
Çme_Ën
) \

58 (((
Çme_Ën
è+ 
EXT4_XATTR_ROUND
 + \

59 (
ext4_x©Œ_’Œy
)è& ~
EXT4_XATTR_ROUND
)

	)

60 
	#EXT4_XATTR_NEXT
(
’Œy
) \

61 ((
ext4_x©Œ_’Œy
 *)( \

62 (*)(
’Œy
è+ 
	`EXT4_XATTR_LEN
(ÓÁry)->
e_Çme_Ën
)))

	)

63 
	#EXT4_XATTR_SIZE
(
size
) \

64 (((
size
è+ 
EXT4_XATTR_ROUND
è& ~EXT4_XATTR_ROUND)

	)

66 
	#IHDR
(
šode
, 
¿w_šode
) \

67 ((
ext4_x©Œ_ibody_h—d”
 *) \

68 ((*)
¿w_šode
 + \

69 
EXT4_GOOD_OLD_INODE_SIZE
 + \

70 
	`EXT4_I
(
šode
)->
i_exŒa_isize
))

	)

71 
	#IFIRST
(
hdr
è((
ext4_x©Œ_’Œy
 *)((hdr)+1))

	)

82 
	#EXT4_XATTR_SIZE_MAX
 (1 << 24)

	)

88 
	#EXT4_XATTR_MIN_LARGE_EA_SIZE
(
b
) \

89 ((
b
è- 
	`EXT4_XATTR_LEN
(3è- (
ext4_x©Œ_h—d”
è- 4)

	)

91 
	#BHDR
(
bh
è((
ext4_x©Œ_h—d”
 *)((bh)->
b_d©a
))

	)

92 
	#ENTRY
(
±r
è((
ext4_x©Œ_’Œy
 *)ÕŒ))

	)

93 
	#BFIRST
(
bh
è
	`ENTRY
(
	`BHDR
(bh)+1)

	)

94 
	#IS_LAST_ENTRY
(
’Œy
è(*(
__u32
 *)ÓÁryè=ğ0)

	)

96 
	#EXT4_ZERO_XATTR_VALUE
 ((*)-1)

	)

98 
	sext4_x©Œ_šfo
 {

99 cÚ¡ *
	mÇme
;

100 cÚ¡ *
	mv®ue
;

101 
size_t
 
	mv®ue_Ën
;

102 
	mÇme_šdex
;

103 
	mš_šode
;

106 
	sext4_x©Œ_£¬ch
 {

107 
ext4_x©Œ_’Œy
 *
	mfœ¡
;

108 *
	mba£
;

109 *
	m’d
;

110 
ext4_x©Œ_’Œy
 *
	mh”e
;

111 
	mnÙ_found
;

114 
	sext4_x©Œ_ibody_fšd
 {

115 
ext4_x©Œ_£¬ch
 
	ms
;

116 
ext4_oc
 
	moc
;

119 
	sext4_x©Œ_šode_¬¿y
 {

120 
	mcouÁ
;

121 
šode
 *
	mšodes
[0];

124 cÚ¡ 
x©Œ_hªdËr
 
ext4_x©Œ_u£r_hªdËr
;

125 cÚ¡ 
x©Œ_hªdËr
 
ext4_x©Œ_Œu¡ed_hªdËr
;

126 cÚ¡ 
x©Œ_hªdËr
 
ext4_x©Œ_£cur™y_hªdËr
;

128 
	#EXT4_XATTR_NAME_ENCRYPTION_CONTEXT
 "c"

	)

139 
šlše
 
	$ext4_wr™e_lock_x©Œ
(
šode
 *šode, *
§ve
)

141 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

142 *
§ve
 = 
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NO_EXPAND
);

143 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_NO_EXPAND
);

144 
	}
}

146 
šlše
 
	$ext4_wr™e_Œylock_x©Œ
(
šode
 *šode, *
§ve
)

148 ià(
	`down_wr™e_Œylock
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
) == 0)

150 *
§ve
 = 
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NO_EXPAND
);

151 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_NO_EXPAND
);

153 
	}
}

155 
šlše
 
	$ext4_wr™e_uÆock_x©Œ
(
šode
 *šode, *
§ve
)

157 ià(*
§ve
 == 0)

158 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_NO_EXPAND
);

159 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

160 
	}
}

162 
ssize_t
 
ext4_li¡x©Œ
(
d’Œy
 *, *, 
size_t
);

164 
ext4_x©Œ_g‘
(
šode
 *, , cÚ¡ *, *, 
size_t
);

165 
ext4_x©Œ_£t
(
šode
 *, , cÚ¡ *, cÚ¡ *, 
size_t
, );

166 
ext4_x©Œ_£t_hªdË
(
hªdË_t
 *, 
šode
 *, , cÚ¡ *, cÚ¡ *, 
size_t
, );

167 
ext4_x©Œ_£t_üed™s
(
šode
 *šode, 
size_t
 
v®ue_Ën
,

168 
boŞ
 
is_ü—‹
, *
üed™s
);

169 
__ext4_x©Œ_£t_üed™s
(
su³r_block
 *
sb
, 
šode
 *inode,

170 
bufãr_h—d
 *
block_bh
, 
size_t
 
v®ue_Ën
,

171 
boŞ
 
is_ü—‹
);

173 
ext4_x©Œ_d–‘e_šode
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

174 
ext4_x©Œ_šode_¬¿y
 **
¬¿y
,

175 
exŒa_üed™s
);

176 
ext4_x©Œ_šode_¬¿y_ä“
(
ext4_x©Œ_šode_¬¿y
 *
¬¿y
);

178 
ext4_ex·nd_exŒa_isize_—
(
šode
 *šode, 
Ãw_exŒa_isize
,

179 
ext4_šode
 *
¿w_šode
, 
hªdË_t
 *
hªdË
);

181 cÚ¡ 
x©Œ_hªdËr
 *
ext4_x©Œ_hªdËrs
[];

183 
ext4_x©Œ_ibody_fšd
(
šode
 *šode, 
ext4_x©Œ_šfo
 *
i
,

184 
ext4_x©Œ_ibody_fšd
 *
is
);

185 
ext4_x©Œ_ibody_g‘
(
šode
 *šode, 
Çme_šdex
,

186 cÚ¡ *
Çme
,

187 *
bufãr
, 
size_t
 
bufãr_size
);

188 
ext4_x©Œ_ibody_šlše_£t
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

189 
ext4_x©Œ_šfo
 *
i
,

190 
ext4_x©Œ_ibody_fšd
 *
is
);

192 
mb_ÿche
 *
ext4_x©Œ_ü—‹_ÿche
();

193 
ext4_x©Œ_de¡roy_ÿche
(
mb_ÿche
 *);

195 #ifdeà
CONFIG_EXT4_FS_SECURITY


196 
ext4_š™_£cur™y
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

197 
šode
 *
dœ
, cÚ¡ 
q¡r
 *qstr);

199 
šlše
 
	$ext4_š™_£cur™y
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

200 
šode
 *
dœ
, cÚ¡ 
q¡r
 *qstr)

203 
	}
}

206 #ifdeà
CONFIG_LOCKDEP


207 
ext4_x©Œ_šode_£t_şass
(
šode
 *
—_šode
);

209 
šlše
 
	$ext4_x©Œ_šode_£t_şass
(
šode
 *
—_šode
è{ 
	}
}

212 
ext4_g‘_šode_u§ge
(
šode
 *šode, 
qsize_t
 *
u§ge
);

	@pxt4/xattr_security.c

7 
	~<lšux/¡ršg.h
>

8 
	~<lšux/fs.h
>

9 
	~<lšux/£cur™y.h
>

10 
	~<lšux/¦ab.h
>

11 
	~"ext4_jbd2.h
"

12 
	~"ext4.h
"

13 
	~"x©Œ.h
"

16 
	$ext4_x©Œ_£cur™y_g‘
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

17 
d’Œy
 *
unu£d
, 
šode
 *inode,

18 cÚ¡ *
Çme
, *
bufãr
, 
size_t
 
size
)

20  
	`ext4_x©Œ_g‘
(
šode
, 
EXT4_XATTR_INDEX_SECURITY
,

21 
Çme
, 
bufãr
, 
size
);

22 
	}
}

25 
	$ext4_x©Œ_£cur™y_£t
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

26 
d’Œy
 *
unu£d
, 
šode
 *inode,

27 cÚ¡ *
Çme
, cÚ¡ *
v®ue
,

28 
size_t
 
size
, 
æags
)

30  
	`ext4_x©Œ_£t
(
šode
, 
EXT4_XATTR_INDEX_SECURITY
,

31 
Çme
, 
v®ue
, 
size
, 
æags
);

32 
	}
}

35 
	$ext4_š™x©Œs
(
šode
 *šode, cÚ¡ 
x©Œ
 *
x©Œ_¬¿y
,

36 *
fs_šfo
)

38 cÚ¡ 
x©Œ
 *xattr;

39 
hªdË_t
 *
hªdË
 = 
fs_šfo
;

40 
”r
 = 0;

42 
x©Œ
 = 
x©Œ_¬¿y
; x©Œ->
Çme
 !ğ
NULL
; xattr++) {

43 
”r
 = 
	`ext4_x©Œ_£t_hªdË
(
hªdË
, 
šode
,

44 
EXT4_XATTR_INDEX_SECURITY
,

45 
x©Œ
->
Çme
, x©Œ->
v®ue
,

46 
x©Œ
->
v®ue_Ën
, 
XATTR_CREATE
);

47 ià(
”r
 < 0)

50  
”r
;

51 
	}
}

54 
	$ext4_š™_£cur™y
(
hªdË_t
 *
hªdË
, 
šode
 *šode, šod*
dœ
,

55 cÚ¡ 
q¡r
 *qstr)

57  
	`£cur™y_šode_š™_£cur™y
(
šode
, 
dœ
, 
q¡r
,

58 &
ext4_š™x©Œs
, 
hªdË
);

59 
	}
}

61 cÚ¡ 
x©Œ_hªdËr
 
	gext4_x©Œ_£cur™y_hªdËr
 = {

62 .
´efix
 = 
XATTR_SECURITY_PREFIX
,

63 .
	gg‘
 = 
ext4_x©Œ_£cur™y_g‘
,

64 .
	g£t
 = 
ext4_x©Œ_£cur™y_£t
,

	@pxt4/xattr_trusted.c

9 
	~<lšux/¡ršg.h
>

10 
	~<lšux/ÿ·b™y.h
>

11 
	~<lšux/fs.h
>

12 
	~"ext4_jbd2.h
"

13 
	~"ext4.h
"

14 
	~"x©Œ.h
"

16 
boŞ


17 
	$ext4_x©Œ_Œu¡ed_li¡
(
d’Œy
 *dentry)

19  
	`ÿ·bË
(
CAP_SYS_ADMIN
);

20 
	}
}

23 
	$ext4_x©Œ_Œu¡ed_g‘
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

24 
d’Œy
 *
unu£d
, 
šode
 *inode,

25 cÚ¡ *
Çme
, *
bufãr
, 
size_t
 
size
)

27  
	`ext4_x©Œ_g‘
(
šode
, 
EXT4_XATTR_INDEX_TRUSTED
,

28 
Çme
, 
bufãr
, 
size
);

29 
	}
}

32 
	$ext4_x©Œ_Œu¡ed_£t
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

33 
d’Œy
 *
unu£d
, 
šode
 *inode,

34 cÚ¡ *
Çme
, cÚ¡ *
v®ue
,

35 
size_t
 
size
, 
æags
)

37  
	`ext4_x©Œ_£t
(
šode
, 
EXT4_XATTR_INDEX_TRUSTED
,

38 
Çme
, 
v®ue
, 
size
, 
æags
);

39 
	}
}

41 cÚ¡ 
x©Œ_hªdËr
 
	gext4_x©Œ_Œu¡ed_hªdËr
 = {

42 .
´efix
 = 
XATTR_TRUSTED_PREFIX
,

43 .
	gli¡
 = 
ext4_x©Œ_Œu¡ed_li¡
,

44 .
	gg‘
 = 
ext4_x©Œ_Œu¡ed_g‘
,

45 .
	g£t
 = 
ext4_x©Œ_Œu¡ed_£t
,

	@pxt4/xattr_user.c

9 
	~<lšux/¡ršg.h
>

10 
	~<lšux/fs.h
>

11 
	~"ext4_jbd2.h
"

12 
	~"ext4.h
"

13 
	~"x©Œ.h
"

15 
boŞ


16 
	$ext4_x©Œ_u£r_li¡
(
d’Œy
 *dentry)

18  
	`‹¡_İt
(
d’Œy
->
d_sb
, 
XATTR_USER
);

19 
	}
}

22 
	$ext4_x©Œ_u£r_g‘
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

23 
d’Œy
 *
unu£d
, 
šode
 *inode,

24 cÚ¡ *
Çme
, *
bufãr
, 
size_t
 
size
)

26 ià(!
	`‹¡_İt
(
šode
->
i_sb
, 
XATTR_USER
))

27  -
EOPNOTSUPP
;

28  
	`ext4_x©Œ_g‘
(
šode
, 
EXT4_XATTR_INDEX_USER
,

29 
Çme
, 
bufãr
, 
size
);

30 
	}
}

33 
	$ext4_x©Œ_u£r_£t
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

34 
d’Œy
 *
unu£d
, 
šode
 *inode,

35 cÚ¡ *
Çme
, cÚ¡ *
v®ue
,

36 
size_t
 
size
, 
æags
)

38 ià(!
	`‹¡_İt
(
šode
->
i_sb
, 
XATTR_USER
))

39  -
EOPNOTSUPP
;

40  
	`ext4_x©Œ_£t
(
šode
, 
EXT4_XATTR_INDEX_USER
,

41 
Çme
, 
v®ue
, 
size
, 
æags
);

42 
	}
}

44 cÚ¡ 
x©Œ_hªdËr
 
	gext4_x©Œ_u£r_hªdËr
 = {

45 .
´efix
 = 
XATTR_USER_PREFIX
,

46 .
	gli¡
 = 
ext4_x©Œ_u£r_li¡
,

47 .
	gg‘
 = 
ext4_x©Œ_u£r_g‘
,

48 .
	g£t
 = 
ext4_x©Œ_u£r_£t
,

	@/usr/include/linux/capability.h

14 #iâdeà
_LINUX_CAPABILITY_H


15 
	#_LINUX_CAPABILITY_H


	)

17 
	~<lšux/ty³s.h
>

30 
	#_LINUX_CAPABILITY_VERSION_1
 0x19980330

	)

31 
	#_LINUX_CAPABILITY_U32S_1
 1

	)

33 
	#_LINUX_CAPABILITY_VERSION_2
 0x20071026

	)

34 
	#_LINUX_CAPABILITY_U32S_2
 2

	)

36 
	#_LINUX_CAPABILITY_VERSION_3
 0x20080522

	)

37 
	#_LINUX_CAPABILITY_U32S_3
 2

	)

39 
	s__u£r_ÿp_h—d”_¡ruù
 {

40 
__u32
 
	mv”siÚ
;

41 
	mpid
;

42 } *
	tÿp_u£r_h—d”_t
;

44 
	s__u£r_ÿp_d©a_¡ruù
 {

45 
__u32
 
	mefãùive
;

46 
__u32
 
	m³rm™‹d
;

47 
__u32
 
	mšh”™abË
;

48 } *
	tÿp_u£r_d©a_t
;

51 
	#VFS_CAP_REVISION_MASK
 0xFF000000

	)

52 
	#VFS_CAP_REVISION_SHIFT
 24

	)

53 
	#VFS_CAP_FLAGS_MASK
 ~
VFS_CAP_REVISION_MASK


	)

54 
	#VFS_CAP_FLAGS_EFFECTIVE
 0x000001

	)

56 
	#VFS_CAP_REVISION_1
 0x01000000

	)

57 
	#VFS_CAP_U32_1
 1

	)

58 
	#XATTR_CAPS_SZ_1
 ((
__Ë32
)*(1 + 2*
VFS_CAP_U32_1
))

	)

60 
	#VFS_CAP_REVISION_2
 0x02000000

	)

61 
	#VFS_CAP_U32_2
 2

	)

62 
	#XATTR_CAPS_SZ_2
 ((
__Ë32
)*(1 + 2*
VFS_CAP_U32_2
))

	)

64 
	#VFS_CAP_REVISION_3
 0x03000000

	)

65 
	#VFS_CAP_U32_3
 2

	)

66 
	#XATTR_CAPS_SZ_3
 ((
__Ë32
)*(2 + 2*
VFS_CAP_U32_3
))

	)

68 
	#XATTR_CAPS_SZ
 
XATTR_CAPS_SZ_3


	)

69 
	#VFS_CAP_U32
 
VFS_CAP_U32_3


	)

70 
	#VFS_CAP_REVISION
 
VFS_CAP_REVISION_3


	)

72 
	svfs_ÿp_d©a
 {

73 
__Ë32
 
	mmagic_‘c
;

75 
__Ë32
 
	m³rm™‹d
;

76 
__Ë32
 
	mšh”™abË
;

77 } 
	md©a
[
VFS_CAP_U32
];

83 
	svfs_ns_ÿp_d©a
 {

84 
__Ë32
 
	mmagic_‘c
;

86 
__Ë32
 
	m³rm™‹d
;

87 
__Ë32
 
	mšh”™abË
;

88 } 
	md©a
[
VFS_CAP_U32
];

89 
__Ë32
 
	mroÙid
;

98 
	#_LINUX_CAPABILITY_VERSION
 
_LINUX_CAPABILITY_VERSION_1


	)

99 
	#_LINUX_CAPABILITY_U32S
 
_LINUX_CAPABILITY_U32S_1


	)

111 
	#CAP_CHOWN
 0

	)

117 
	#CAP_DAC_OVERRIDE
 1

	)

123 
	#CAP_DAC_READ_SEARCH
 2

	)

129 
	#CAP_FOWNER
 3

	)

138 
	#CAP_FSETID
 4

	)

144 
	#CAP_KILL
 5

	)

150 
	#CAP_SETGID
 6

	)

155 
	#CAP_SETUID
 7

	)

172 
	#CAP_SETPCAP
 8

	)

176 
	#CAP_LINUX_IMMUTABLE
 9

	)

181 
	#CAP_NET_BIND_SERVICE
 10

	)

185 
	#CAP_NET_BROADCAST
 11

	)

201 
	#CAP_NET_ADMIN
 12

	)

207 
	#CAP_NET_RAW
 13

	)

213 
	#CAP_IPC_LOCK
 14

	)

217 
	#CAP_IPC_OWNER
 15

	)

220 
	#CAP_SYS_MODULE
 16

	)

225 
	#CAP_SYS_RAWIO
 17

	)

229 
	#CAP_SYS_CHROOT
 18

	)

233 
	#CAP_SYS_PTRACE
 19

	)

237 
	#CAP_SYS_PACCT
 20

	)

276 
	#CAP_SYS_ADMIN
 21

	)

280 
	#CAP_SYS_BOOT
 22

	)

289 
	#CAP_SYS_NICE
 23

	)

303 
	#CAP_SYS_RESOURCE
 24

	)

309 
	#CAP_SYS_TIME
 25

	)

314 
	#CAP_SYS_TTY_CONFIG
 26

	)

318 
	#CAP_MKNOD
 27

	)

322 
	#CAP_LEASE
 28

	)

326 
	#CAP_AUDIT_WRITE
 29

	)

330 
	#CAP_AUDIT_CONTROL
 30

	)

332 
	#CAP_SETFCAP
 31

	)

340 
	#CAP_MAC_OVERRIDE
 32

	)

349 
	#CAP_MAC_ADMIN
 33

	)

353 
	#CAP_SYSLOG
 34

	)

357 
	#CAP_WAKE_ALARM
 35

	)

361 
	#CAP_BLOCK_SUSPEND
 36

	)

365 
	#CAP_AUDIT_READ
 37

	)

368 
	#CAP_LAST_CAP
 
CAP_AUDIT_READ


	)

370 
	#ÿp_v®id
(
x
è((xè>ğ0 && (xè<ğ
CAP_LAST_CAP
)

	)

376 
	#CAP_TO_INDEX
(
x
è((xè>> 5è

	)

377 
	#CAP_TO_MASK
(
x
è(1 << ((xè& 31)è

	)

	@/usr/include/linux/errno.h

1 
	~<asm/”ºo.h
>

	@/usr/include/linux/falloc.h

2 #iâdeà
_FALLOC_H_


3 
	#_FALLOC_H_


	)

5 
	#FALLOC_FL_KEEP_SIZE
 0x01

	)

6 
	#FALLOC_FL_PUNCH_HOLE
 0x02

	)

7 
	#FALLOC_FL_NO_HIDE_STALE
 0x04

	)

29 
	#FALLOC_FL_COLLAPSE_RANGE
 0x08

	)

43 
	#FALLOC_FL_ZERO_RANGE
 0x10

	)

60 
	#FALLOC_FL_INSERT_RANGE
 0x20

	)

78 
	#FALLOC_FL_UNSHARE_RANGE
 0x40

	)

	@/usr/include/linux/fcntl.h

2 #iâdeà
_LINUX_FCNTL_H


3 
	#_LINUX_FCNTL_H


	)

5 
	~<asm/fú.h
>

7 
	#F_SETLEASE
 (
F_LINUX_SPECIFIC_BASE
 + 0)

	)

8 
	#F_GETLEASE
 (
F_LINUX_SPECIFIC_BASE
 + 1)

	)

14 
	#F_CANCELLK
 (
F_LINUX_SPECIFIC_BASE
 + 5)

	)

17 
	#F_DUPFD_CLOEXEC
 (
F_LINUX_SPECIFIC_BASE
 + 6)

	)

23 
	#F_NOTIFY
 (
F_LINUX_SPECIFIC_BASE
+2)

	)

28 
	#F_SETPIPE_SZ
 (
F_LINUX_SPECIFIC_BASE
 + 7)

	)

29 
	#F_GETPIPE_SZ
 (
F_LINUX_SPECIFIC_BASE
 + 8)

	)

34 
	#F_ADD_SEALS
 (
F_LINUX_SPECIFIC_BASE
 + 9)

	)

35 
	#F_GET_SEALS
 (
F_LINUX_SPECIFIC_BASE
 + 10)

	)

40 
	#F_SEAL_SEAL
 0x0001

	)

41 
	#F_SEAL_SHRINK
 0x0002

	)

42 
	#F_SEAL_GROW
 0x0004

	)

43 
	#F_SEAL_WRITE
 0x0008

	)

44 
	#F_SEAL_FUTURE_WRITE
 0x0010

	)

52 
	#F_GET_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 11)

	)

53 
	#F_SET_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 12)

	)

54 
	#F_GET_FILE_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 13)

	)

55 
	#F_SET_FILE_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 14)

	)

61 
	#RWF_WRITE_LIFE_NOT_SET
 0

	)

62 
	#RWH_WRITE_LIFE_NONE
 1

	)

63 
	#RWH_WRITE_LIFE_SHORT
 2

	)

64 
	#RWH_WRITE_LIFE_MEDIUM
 3

	)

65 
	#RWH_WRITE_LIFE_LONG
 4

	)

66 
	#RWH_WRITE_LIFE_EXTREME
 5

	)

71 
	#DN_ACCESS
 0x00000001

	)

72 
	#DN_MODIFY
 0x00000002

	)

73 
	#DN_CREATE
 0x00000004

	)

74 
	#DN_DELETE
 0x00000008

	)

75 
	#DN_RENAME
 0x00000010

	)

76 
	#DN_ATTRIB
 0x00000020

	)

77 
	#DN_MULTISHOT
 0x80000000

	)

79 
	#AT_FDCWD
 -100

	)

82 
	#AT_SYMLINK_NOFOLLOW
 0x100

	)

83 
	#AT_REMOVEDIR
 0x200

	)

85 
	#AT_SYMLINK_FOLLOW
 0x400

	)

86 
	#AT_NO_AUTOMOUNT
 0x800

	)

87 
	#AT_EMPTY_PATH
 0x1000

	)

89 
	#AT_STATX_SYNC_TYPE
 0x6000

	)

90 
	#AT_STATX_SYNC_AS_STAT
 0x0000

	)

91 
	#AT_STATX_FORCE_SYNC
 0x2000

	)

92 
	#AT_STATX_DONT_SYNC
 0x4000

	)

94 
	#AT_RECURSIVE
 0x8000

	)

	@/usr/include/linux/fiemap.h

12 #iâdeà
_LINUX_FIEMAP_H


13 
	#_LINUX_FIEMAP_H


	)

15 
	~<lšux/ty³s.h
>

17 
	sf›m­_ex‹Á
 {

18 
__u64
 
	mã_logiÿl
;

20 
__u64
 
	mã_physiÿl
;

22 
__u64
 
	mã_Ëngth
;

23 
__u64
 
	mã_»£rved64
[2];

24 
__u32
 
	mã_æags
;

25 
__u32
 
	mã_»£rved
[3];

28 
	sf›m­
 {

29 
__u64
 
	mfm_¡¬t
;

31 
__u64
 
	mfm_Ëngth
;

33 
__u32
 
	mfm_æags
;

34 
__u32
 
	mfm_m­³d_ex‹Ás
;

35 
__u32
 
	mfm_ex‹Á_couÁ
;

36 
__u32
 
	mfm_»£rved
;

37 
f›m­_ex‹Á
 
	mfm_ex‹Ás
[0];

40 
	#FIEMAP_MAX_OFFSET
 (~0ULL)

	)

42 
	#FIEMAP_FLAG_SYNC
 0x00000001

	)

43 
	#FIEMAP_FLAG_XATTR
 0x00000002

	)

44 
	#FIEMAP_FLAG_CACHE
 0x00000004

	)

46 
	#FIEMAP_FLAGS_COMPAT
 (
FIEMAP_FLAG_SYNC
 | 
FIEMAP_FLAG_XATTR
)

	)

48 
	#FIEMAP_EXTENT_LAST
 0x00000001

	)

49 
	#FIEMAP_EXTENT_UNKNOWN
 0x00000002

	)

50 
	#FIEMAP_EXTENT_DELALLOC
 0x00000004

	)

52 
	#FIEMAP_EXTENT_ENCODED
 0x00000008

	)

54 
	#FIEMAP_EXTENT_DATA_ENCRYPTED
 0x00000080

	)

56 
	#FIEMAP_EXTENT_NOT_ALIGNED
 0x00000100

	)

58 
	#FIEMAP_EXTENT_DATA_INLINE
 0x00000200

	)

60 
	#FIEMAP_EXTENT_DATA_TAIL
 0x00000400

	)

62 
	#FIEMAP_EXTENT_UNWRITTEN
 0x00000800

	)

64 
	#FIEMAP_EXTENT_MERGED
 0x00001000

	)

67 
	#FIEMAP_EXTENT_SHARED
 0x00002000

	)

	@/usr/include/linux/fs.h

2 #iâdeà
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<lšux/lim™s.h
>

14 
	~<lšux/ioùl.h
>

15 
	~<lšux/ty³s.h
>

16 
	~<lšux/fsüy±.h
>

19 
	~<lšux/mouÁ.h
>

32 #undeà
NR_OPEN


33 
	#INR_OPEN_CUR
 1024

	)

34 
	#INR_OPEN_MAX
 4096

	)

36 
	#BLOCK_SIZE_BITS
 10

	)

37 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

39 
	#SEEK_SET
 0

	)

40 
	#SEEK_CUR
 1

	)

41 
	#SEEK_END
 2

	)

42 
	#SEEK_DATA
 3

	)

43 
	#SEEK_HOLE
 4

	)

44 
	#SEEK_MAX
 
SEEK_HOLE


	)

46 
	#RENAME_NOREPLACE
 (1 << 0è

	)

47 
	#RENAME_EXCHANGE
 (1 << 1è

	)

48 
	#RENAME_WHITEOUT
 (1 << 2è

	)

50 
	sfe_şÚe_¿nge
 {

51 
__s64
 
	m¤c_fd
;

52 
__u64
 
	m¤c_off£t
;

53 
__u64
 
	m¤c_Ëngth
;

54 
__u64
 
	mde¡_off£t
;

57 
	sf¡rim_¿nge
 {

58 
__u64
 
	m¡¬t
;

59 
__u64
 
	mËn
;

60 
__u64
 
	mmšËn
;

64 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

65 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

68 
	sfe_dedu³_¿nge_šfo
 {

69 
__s64
 
	mde¡_fd
;

70 
__u64
 
	mde¡_off£t
;

71 
__u64
 
	mby‹s_dedu³d
;

78 
__s32
 
	m¡©us
;

79 
__u32
 
	m»£rved
;

83 
	sfe_dedu³_¿nge
 {

84 
__u64
 
	m¤c_off£t
;

85 
__u64
 
	m¤c_Ëngth
;

86 
__u16
 
	mde¡_couÁ
;

87 
__u16
 
	m»£rved1
;

88 
__u32
 
	m»£rved2
;

89 
fe_dedu³_¿nge_šfo
 
	mšfo
[0];

93 
	sfes_¡©_¡ruù
 {

94 
	mÄ_fes
;

95 
	mÄ_ä“_fes
;

96 
	mmax_fes
;

99 
	sšodes_¡©_t
 {

100 
	mÄ_šodes
;

101 
	mÄ_unu£d
;

102 
	mdummy
[5];

106 
	#NR_FILE
 8192

	)

111 
	sfsx©Œ
 {

112 
__u32
 
	mfsx_xæags
;

113 
__u32
 
	mfsx_extsize
;

114 
__u32
 
	mfsx_Ãx‹Ás
;

115 
__u32
 
	mfsx_´ojid
;

116 
__u32
 
	mfsx_cowextsize
;

117 
	mfsx_·d
[8];

123 
	#FS_XFLAG_REALTIME
 0x00000001

	)

124 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

125 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

126 
	#FS_XFLAG_APPEND
 0x00000010

	)

127 
	#FS_XFLAG_SYNC
 0x00000020

	)

128 
	#FS_XFLAG_NOATIME
 0x00000040

	)

129 
	#FS_XFLAG_NODUMP
 0x00000080

	)

130 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

131 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

132 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

133 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

134 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

135 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

136 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

137 
	#FS_XFLAG_DAX
 0x00008000

	)

138 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

139 
	#FS_XFLAG_HASATTR
 0x80000000

	)

144 
	#BLKROSET
 
	`_IO
(0x12,93è

	)

145 
	#BLKROGET
 
	`_IO
(0x12,94è

	)

146 
	#BLKRRPART
 
	`_IO
(0x12,95è

	)

147 
	#BLKGETSIZE
 
	`_IO
(0x12,96è

	)

148 
	#BLKFLSBUF
 
	`_IO
(0x12,97è

	)

149 
	#BLKRASET
 
	`_IO
(0x12,98è

	)

150 
	#BLKRAGET
 
	`_IO
(0x12,99è

	)

151 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

152 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

153 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

154 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

155 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

157 
	#BLKPG
 
	`_IO
(0x12,105)

	)

161 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

162 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

167 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

168 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

169 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
è

	)

170 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_Œaû_£tup
)

	)

171 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

172 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

173 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

174 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

175 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

176 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

177 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

178 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

179 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

180 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

181 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

182 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

188 
	#BMAP_IOCTL
 1

	)

189 
	#FIBMAP
 
	`_IO
(0x00,1è

	)

190 
	#FIGETBSZ
 
	`_IO
(0x00,2è

	)

191 
	#FIFREEZE
 
	`_IOWR
('X', 119, è

	)

192 
	#FITHAW
 
	`_IOWR
('X', 120, è

	)

193 
	#FITRIM
 
	`_IOWR
('X', 121, 
f¡rim_¿nge
è

	)

194 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

195 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fe_şÚe_¿nge
)

	)

196 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fe_dedu³_¿nge
)

	)

198 
	#FSLABEL_MAX
 256

	)

200 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

201 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

202 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

203 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

204 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
f›m­
)

	)

205 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

206 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

207 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

208 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

209 
	#FS_IOC_FSGETXATTR
 
	`_IOR
('X', 31, 
fsx©Œ
)

	)

210 
	#FS_IOC_FSSETXATTR
 
	`_IOW
('X', 32, 
fsx©Œ
)

	)

211 
	#FS_IOC_GETFSLABEL
 
	`_IOR
(0x94, 49, [
FSLABEL_MAX
])

	)

212 
	#FS_IOC_SETFSLABEL
 
	`_IOW
(0x94, 50, [
FSLABEL_MAX
])

	)

234 
	#FS_SECRM_FL
 0x00000001

	)

235 
	#FS_UNRM_FL
 0x00000002

	)

236 
	#FS_COMPR_FL
 0x00000004

	)

237 
	#FS_SYNC_FL
 0x00000008

	)

238 
	#FS_IMMUTABLE_FL
 0x00000010

	)

239 
	#FS_APPEND_FL
 0x00000020

	)

240 
	#FS_NODUMP_FL
 0x00000040

	)

241 
	#FS_NOATIME_FL
 0x00000080

	)

243 
	#FS_DIRTY_FL
 0x00000100

	)

244 
	#FS_COMPRBLK_FL
 0x00000200

	)

245 
	#FS_NOCOMP_FL
 0x00000400

	)

247 
	#FS_ENCRYPT_FL
 0x00000800

	)

248 
	#FS_BTREE_FL
 0x00001000

	)

249 
	#FS_INDEX_FL
 0x00001000

	)

250 
	#FS_IMAGIC_FL
 0x00002000

	)

251 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

252 
	#FS_NOTAIL_FL
 0x00008000

	)

253 
	#FS_DIRSYNC_FL
 0x00010000

	)

254 
	#FS_TOPDIR_FL
 0x00020000

	)

255 
	#FS_HUGE_FILE_FL
 0x00040000

	)

256 
	#FS_EXTENT_FL
 0x00080000

	)

257 
	#FS_VERITY_FL
 0x00100000

	)

258 
	#FS_EA_INODE_FL
 0x00200000

	)

259 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

260 
	#FS_NOCOW_FL
 0x00800000

	)

261 
	#FS_INLINE_DATA_FL
 0x10000000

	)

262 
	#FS_PROJINHERIT_FL
 0x20000000

	)

263 
	#FS_CASEFOLD_FL
 0x40000000

	)

264 
	#FS_RESERVED_FL
 0x80000000

	)

266 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

267 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

270 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

271 
	#SYNC_FILE_RANGE_WRITE
 2

	)

272 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

273 
	#SYNC_FILE_RANGE_WRITE_AND_WAIT
 (
SYNC_FILE_RANGE_WRITE
 | \

274 
SYNC_FILE_RANGE_WAIT_BEFORE
 | \

275 
SYNC_FILE_RANGE_WAIT_AFTER
)

	)

281 
	t__b™wi£
 
	t__k”Ãl_rwf_t
;

284 
	#RWF_HIPRI
 ((
__k”Ãl_rwf_t
)0x00000001)

	)

287 
	#RWF_DSYNC
 ((
__k”Ãl_rwf_t
)0x00000002)

	)

290 
	#RWF_SYNC
 ((
__k”Ãl_rwf_t
)0x00000004)

	)

293 
	#RWF_NOWAIT
 ((
__k”Ãl_rwf_t
)0x00000008)

	)

296 
	#RWF_APPEND
 ((
__k”Ãl_rwf_t
)0x00000010)

	)

299 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
 |\

300 
RWF_APPEND
)

	)

	@/usr/include/linux/fscrypt.h

8 #iâdeà
_LINUX_FSCRYPT_H


9 
	#_LINUX_FSCRYPT_H


	)

11 
	~<lšux/ty³s.h
>

14 
	#FSCRYPT_POLICY_FLAGS_PAD_4
 0x00

	)

15 
	#FSCRYPT_POLICY_FLAGS_PAD_8
 0x01

	)

16 
	#FSCRYPT_POLICY_FLAGS_PAD_16
 0x02

	)

17 
	#FSCRYPT_POLICY_FLAGS_PAD_32
 0x03

	)

18 
	#FSCRYPT_POLICY_FLAGS_PAD_MASK
 0x03

	)

19 
	#FSCRYPT_POLICY_FLAG_DIRECT_KEY
 0x04

	)

20 
	#FSCRYPT_POLICY_FLAGS_VALID
 0x07

	)

23 
	#FSCRYPT_MODE_AES_256_XTS
 1

	)

24 
	#FSCRYPT_MODE_AES_256_CTS
 4

	)

25 
	#FSCRYPT_MODE_AES_128_CBC
 5

	)

26 
	#FSCRYPT_MODE_AES_128_CTS
 6

	)

27 
	#FSCRYPT_MODE_ADIANTUM
 9

	)

28 
	#__FSCRYPT_MODE_MAX
 9

	)

36 
	#FSCRYPT_POLICY_V1
 0

	)

37 
	#FSCRYPT_KEY_DESCRIPTOR_SIZE
 8

	)

38 
	sfsüy±_pŞicy_v1
 {

39 
__u8
 
	mv”siÚ
;

40 
__u8
 
	mcÚ‹Ás_’üy±iÚ_mode
;

41 
__u8
 
	mf’ames_’üy±iÚ_mode
;

42 
__u8
 
	mæags
;

43 
__u8
 
	mma¡”_key_desütÜ
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

45 
	#fsüy±_pŞicy
 
fsüy±_pŞicy_v1


	)

51 
	#FSCRYPT_KEY_DESC_PREFIX
 "fsüy±:"

	)

52 
	#FSCRYPT_KEY_DESC_PREFIX_SIZE
 8

	)

53 
	#FSCRYPT_MAX_KEY_SIZE
 64

	)

54 
	sfsüy±_key
 {

55 
__u32
 
	mmode
;

56 
__u8
 
	m¿w
[
FSCRYPT_MAX_KEY_SIZE
];

57 
__u32
 
	msize
;

63 
	#FSCRYPT_POLICY_V2
 2

	)

64 
	#FSCRYPT_KEY_IDENTIFIER_SIZE
 16

	)

65 
	sfsüy±_pŞicy_v2
 {

66 
__u8
 
	mv”siÚ
;

67 
__u8
 
	mcÚ‹Ás_’üy±iÚ_mode
;

68 
__u8
 
	mf’ames_’üy±iÚ_mode
;

69 
__u8
 
	mæags
;

70 
__u8
 
	m__»£rved
[4];

71 
__u8
 
	mma¡”_key_id’tif›r
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

75 
	sfsüy±_g‘_pŞicy_ex_¬g
 {

76 
__u64
 
	mpŞicy_size
;

78 
__u8
 
	mv”siÚ
;

79 
fsüy±_pŞicy_v1
 
	mv1
;

80 
fsüy±_pŞicy_v2
 
	mv2
;

81 } 
	mpŞicy
;

88 
	#FSCRYPT_KEY_SPEC_TYPE_DESCRIPTOR
 1

	)

95 
	#FSCRYPT_KEY_SPEC_TYPE_IDENTIFIER
 2

	)

101 
	sfsüy±_key_¥ecif›r
 {

102 
__u32
 
	mty³
;

103 
__u32
 
	m__»£rved
;

105 
__u8
 
	m__»£rved
[32];

106 
__u8
 
	mdesütÜ
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

107 
__u8
 
	mid’tif›r
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

108 } 
	mu
;

112 
	sfsüy±_add_key_¬g
 {

113 
fsüy±_key_¥ecif›r
 
	mkey_¥ec
;

114 
__u32
 
	m¿w_size
;

115 
__u32
 
	m__»£rved
[9];

116 
__u8
 
	m¿w
[];

120 
	sfsüy±_»move_key_¬g
 {

121 
fsüy±_key_¥ecif›r
 
	mkey_¥ec
;

122 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_FILES_BUSY
 0x00000001

	)

123 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_OTHER_USERS
 0x00000002

	)

124 
__u32
 
	m»mov®_¡©us_æags
;

125 
__u32
 
	m__»£rved
[5];

129 
	sfsüy±_g‘_key_¡©us_¬g
 {

131 
fsüy±_key_¥ecif›r
 
	mkey_¥ec
;

132 
__u32
 
	m__»£rved
[6];

135 
	#FSCRYPT_KEY_STATUS_ABSENT
 1

	)

136 
	#FSCRYPT_KEY_STATUS_PRESENT
 2

	)

137 
	#FSCRYPT_KEY_STATUS_INCOMPLETELY_REMOVED
 3

	)

138 
__u32
 
	m¡©us
;

139 
	#FSCRYPT_KEY_STATUS_FLAG_ADDED_BY_SELF
 0x00000001

	)

140 
__u32
 
	m¡©us_æags
;

141 
__u32
 
	mu£r_couÁ
;

142 
__u32
 
	m__out_»£rved
[13];

145 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fsüy±_pŞicy
)

	)

146 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

147 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fsüy±_pŞicy
)

	)

148 
	#FS_IOC_GET_ENCRYPTION_POLICY_EX
 
	`_IOWR
('f', 22, 
__u8
[9]è

	)

149 
	#FS_IOC_ADD_ENCRYPTION_KEY
 
	`_IOWR
('f', 23, 
fsüy±_add_key_¬g
)

	)

150 
	#FS_IOC_REMOVE_ENCRYPTION_KEY
 
	`_IOWR
('f', 24, 
fsüy±_»move_key_¬g
)

	)

151 
	#FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
 
	`_IOWR
('f', 25, 
fsüy±_»move_key_¬g
)

	)

152 
	#FS_IOC_GET_ENCRYPTION_KEY_STATUS
 
	`_IOWR
('f', 26, 
fsüy±_g‘_key_¡©us_¬g
)

	)

157 
	#FS_KEY_DESCRIPTOR_SIZE
 
FSCRYPT_KEY_DESCRIPTOR_SIZE


	)

158 
	#FS_POLICY_FLAGS_PAD_4
 
FSCRYPT_POLICY_FLAGS_PAD_4


	)

159 
	#FS_POLICY_FLAGS_PAD_8
 
FSCRYPT_POLICY_FLAGS_PAD_8


	)

160 
	#FS_POLICY_FLAGS_PAD_16
 
FSCRYPT_POLICY_FLAGS_PAD_16


	)

161 
	#FS_POLICY_FLAGS_PAD_32
 
FSCRYPT_POLICY_FLAGS_PAD_32


	)

162 
	#FS_POLICY_FLAGS_PAD_MASK
 
FSCRYPT_POLICY_FLAGS_PAD_MASK


	)

163 
	#FS_POLICY_FLAG_DIRECT_KEY
 
FSCRYPT_POLICY_FLAG_DIRECT_KEY


	)

164 
	#FS_POLICY_FLAGS_VALID
 
FSCRYPT_POLICY_FLAGS_VALID


	)

165 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

166 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 
FSCRYPT_MODE_AES_256_XTS


	)

167 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

168 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

169 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 
FSCRYPT_MODE_AES_256_CTS


	)

170 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 
FSCRYPT_MODE_AES_128_CBC


	)

171 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 
FSCRYPT_MODE_AES_128_CTS


	)

172 
	#FS_ENCRYPTION_MODE_SPECK128_256_XTS
 7

	)

173 
	#FS_ENCRYPTION_MODE_SPECK128_256_CTS
 8

	)

174 
	#FS_ENCRYPTION_MODE_ADIANTUM
 
FSCRYPT_MODE_ADIANTUM


	)

175 
	#FS_KEY_DESC_PREFIX
 
FSCRYPT_KEY_DESC_PREFIX


	)

176 
	#FS_KEY_DESC_PREFIX_SIZE
 
FSCRYPT_KEY_DESC_PREFIX_SIZE


	)

177 
	#FS_MAX_KEY_SIZE
 
FSCRYPT_MAX_KEY_SIZE


	)

	@/usr/include/linux/fsmap.h

9 #iâdeà
_LINUX_FSMAP_H


10 
	#_LINUX_FSMAP_H


	)

12 
	~<lšux/ty³s.h
>

50 
	sfsm­
 {

51 
__u32
 
	mfmr_deviû
;

52 
__u32
 
	mfmr_æags
;

53 
__u64
 
	mfmr_physiÿl
;

54 
__u64
 
	mfmr_owÃr
;

55 
__u64
 
	mfmr_off£t
;

56 
__u64
 
	mfmr_Ëngth
;

57 
__u64
 
	mfmr_»£rved
[3];

60 
	sfsm­_h—d
 {

61 
__u32
 
	mfmh_iæags
;

62 
__u32
 
	mfmh_oæags
;

63 
__u32
 
	mfmh_couÁ
;

64 
__u32
 
	mfmh_’Œ›s
;

65 
__u64
 
	mfmh_»£rved
[6];

67 
fsm­
 
	mfmh_keys
[2];

68 
fsm­
 
	mfmh_»cs
[];

72 
__šlše__
 
size_t


73 
	$fsm­_sizeof
(

74 
Ä
)

76  (
fsm­_h—d
è+ 
Ä
 * (
fsm­
);

77 
	}
}

80 
__šlše__
 

81 
	$fsm­_advªû
(

82 
fsm­_h—d
 *
h—d
)

84 
h—d
->
fmh_keys
[0] = h—d->
fmh_»cs
[h—d->
fmh_’Œ›s
 - 1];

85 
	}
}

89 
	#FMH_IF_VALID
 0

	)

92 
	#FMH_OF_DEV_T
 0x1

	)

95 
	#FMR_OF_PREALLOC
 0x1

	)

96 
	#FMR_OF_ATTR_FORK
 0x2

	)

97 
	#FMR_OF_EXTENT_MAP
 0x4

	)

98 
	#FMR_OF_SHARED
 0x8

	)

99 
	#FMR_OF_SPECIAL_OWNER
 0x10

	)

100 
	#FMR_OF_LAST
 0x20

	)

103 
	#FMR_OWNER
(
ty³
, 
code
è(((
__u64
)type << 32) | \

104 ((
__u64
)
code
 & 0xFFFFFFFFULL))

	)

105 
	#FMR_OWNER_TYPE
(
owÃr
è((
__u32
)((
__u64
)owÃ¸>> 32))

	)

106 
	#FMR_OWNER_CODE
(
owÃr
è((
__u32
)(((
__u64
)owÃ¸& 0xFFFFFFFFULL)))

	)

107 
	#FMR_OWN_FREE
 
	`FMR_OWNER
(0, 1è

	)

108 
	#FMR_OWN_UNKNOWN
 
	`FMR_OWNER
(0, 2è

	)

109 
	#FMR_OWN_METADATA
 
	`FMR_OWNER
(0, 3è

	)

111 
	#FS_IOC_GETFSMAP
 
	`_IOWR
('X', 59, 
fsm­_h—d
)

	)

	@/usr/include/linux/fsverity.h

10 #iâdeà
_LINUX_FSVERITY_H


11 
	#_LINUX_FSVERITY_H


	)

13 
	~<lšux/ioùl.h
>

14 
	~<lšux/ty³s.h
>

16 
	#FS_VERITY_HASH_ALG_SHA256
 1

	)

17 
	#FS_VERITY_HASH_ALG_SHA512
 2

	)

19 
	sfsv”™y_’abË_¬g
 {

20 
__u32
 
	mv”siÚ
;

21 
__u32
 
	mhash_®gÜ™hm
;

22 
__u32
 
	mblock_size
;

23 
__u32
 
	m§É_size
;

24 
__u64
 
	m§É_±r
;

25 
__u32
 
	msig_size
;

26 
__u32
 
	m__»£rved1
;

27 
__u64
 
	msig_±r
;

28 
__u64
 
	m__»£rved2
[11];

31 
	sfsv”™y_dige¡
 {

32 
__u16
 
	mdige¡_®gÜ™hm
;

33 
__u16
 
	mdige¡_size
;

34 
__u8
 
	mdige¡
[];

37 
	#FS_IOC_ENABLE_VERITY
 
	`_IOW
('f', 133, 
fsv”™y_’abË_¬g
)

	)

38 
	#FS_IOC_MEASURE_VERITY
 
	`_IOWR
('f', 134, 
fsv”™y_dige¡
)

	)

	@/usr/include/linux/kdev_t.h

2 #iâdeà
_LINUX_KDEV_T_H


3 
	#_LINUX_KDEV_T_H


	)

9 
	#MAJOR
(
dev
è((dev)>>8)

	)

10 
	#MINOR
(
dev
è((devè& 0xff)

	)

11 
	#MKDEV
(
ma
,
mi
è((ma)<<8 | (mi))

	)

	@/usr/include/linux/kernel.h

2 #iâdeà
_LINUX_KERNEL_H


3 
	#_LINUX_KERNEL_H


	)

5 
	~<lšux/sysšfo.h
>

10 
	#__ALIGN_KERNEL
(
x
, 
a
è
	`__ALIGN_KERNEL_MASK
(x, (
	`ty³of
(x))×è- 1)

	)

11 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
è(((xè+ (mask)è& ~(mask))

	)

13 
	#__KERNEL_DIV_ROUND_UP
(
n
, 
d
è((Òè+ (dè- 1è/ (d))

	)

	@/usr/include/linux/magic.h

2 #iâdeà
__LINUX_MAGIC_H__


3 
	#__LINUX_MAGIC_H__


	)

5 
	#ADFS_SUPER_MAGIC
 0xadf5

	)

6 
	#AFFS_SUPER_MAGIC
 0xadff

	)

7 
	#AFS_SUPER_MAGIC
 0x5346414F

	)

8 
	#AUTOFS_SUPER_MAGIC
 0x0187

	)

9 
	#CODA_SUPER_MAGIC
 0x73757245

	)

10 
	#CRAMFS_MAGIC
 0x28cd3d45

	)

11 
	#CRAMFS_MAGIC_WEND
 0x453dcd28

	)

12 
	#DEBUGFS_MAGIC
 0x64626720

	)

13 
	#SECURITYFS_MAGIC
 0x73636673

	)

14 
	#SELINUX_MAGIC
 0xf97cff8c

	)

15 
	#SMACK_MAGIC
 0x43415d53

	)

16 
	#RAMFS_MAGIC
 0x858458f6

	)

17 
	#TMPFS_MAGIC
 0x01021994

	)

18 
	#HUGETLBFS_MAGIC
 0x958458f6

	)

19 
	#SQUASHFS_MAGIC
 0x73717368

	)

20 
	#ECRYPTFS_SUPER_MAGIC
 0xf15f

	)

21 
	#EFS_SUPER_MAGIC
 0x414A53

	)

22 
	#EROFS_SUPER_MAGIC_V1
 0xE0F5E1E2

	)

23 
	#EXT2_SUPER_MAGIC
 0xEF53

	)

24 
	#EXT3_SUPER_MAGIC
 0xEF53

	)

25 
	#XENFS_SUPER_MAGIC
 0xabba1974

	)

26 
	#EXT4_SUPER_MAGIC
 0xEF53

	)

27 
	#BTRFS_SUPER_MAGIC
 0x9123683E

	)

28 
	#NILFS_SUPER_MAGIC
 0x3434

	)

29 
	#F2FS_SUPER_MAGIC
 0xF2F52010

	)

30 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

31 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

32 
	#JFFS2_SUPER_MAGIC
 0x72b6

	)

33 
	#XFS_SUPER_MAGIC
 0x58465342

	)

34 
	#PSTOREFS_MAGIC
 0x6165676C

	)

35 
	#EFIVARFS_MAGIC
 0xde5e81e4

	)

36 
	#HOSTFS_SUPER_MAGIC
 0x00c0fãe

	)

37 
	#OVERLAYFS_SUPER_MAGIC
 0x794c7630

	)

39 
	#MINIX_SUPER_MAGIC
 0x137F

	)

40 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

41 
	#MINIX2_SUPER_MAGIC
 0x2468

	)

42 
	#MINIX2_SUPER_MAGIC2
 0x2478

	)

43 
	#MINIX3_SUPER_MAGIC
 0x4d5¨

	)

45 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

46 
	#NCP_SUPER_MAGIC
 0x564ø

	)

47 
	#NFS_SUPER_MAGIC
 0x6969

	)

48 
	#OCFS2_SUPER_MAGIC
 0x7461636f

	)

49 
	#OPENPROM_SUPER_MAGIC
 0x9ç1

	)

50 
	#QNX4_SUPER_MAGIC
 0x002à

	)

51 
	#QNX6_SUPER_MAGIC
 0x68191122

	)

52 
	#AFS_FS_MAGIC
 0x6B414653

	)

54 
	#REISERFS_SUPER_MAGIC
 0x52654973

	)

57 
	#REISERFS_SUPER_MAGIC_STRING
 "ReIsErFs"

	)

58 
	#REISER2FS_SUPER_MAGIC_STRING
 "ReIsEr2Fs"

	)

59 
	#REISER2FS_JR_SUPER_MAGIC_STRING
 "ReIsEr3Fs"

	)

61 
	#SMB_SUPER_MAGIC
 0x517B

	)

62 
	#CGROUP_SUPER_MAGIC
 0x27e0eb

	)

63 
	#CGROUP2_SUPER_MAGIC
 0x63677270

	)

65 
	#RDTGROUP_SUPER_MAGIC
 0x7655821

	)

67 
	#STACK_END_MAGIC
 0x57AC6E9D

	)

69 
	#TRACEFS_MAGIC
 0x74726163

	)

71 
	#V9FS_MAGIC
 0x01021997

	)

73 
	#BDEVFS_MAGIC
 0x62646576

	)

74 
	#DAXFS_MAGIC
 0x64646178

	)

75 
	#BINFMTFS_MAGIC
 0x42494e4d

	)

76 
	#DEVPTS_SUPER_MAGIC
 0x1cd1

	)

77 
	#BINDERFS_SUPER_MAGIC
 0x6c6f6f70

	)

78 
	#FUTEXFS_SUPER_MAGIC
 0xBAD1DEA

	)

79 
	#PIPEFS_MAGIC
 0x50495045

	)

80 
	#PROC_SUPER_MAGIC
 0x9ç0

	)

81 
	#SOCKFS_MAGIC
 0x534F434B

	)

82 
	#SYSFS_MAGIC
 0x62656572

	)

83 
	#USBDEVICE_SUPER_MAGIC
 0x9ç2

	)

84 
	#MTD_INODE_FS_MAGIC
 0x11307854

	)

85 
	#ANON_INODE_FS_MAGIC
 0x09041934

	)

86 
	#BTRFS_TEST_MAGIC
 0x73727279

	)

87 
	#NSFS_MAGIC
 0x6e736673

	)

88 
	#BPF_FS_MAGIC
 0xÿã4a11

	)

89 
	#AAFS_MAGIC
 0x5a3c69f0

	)

92 
	#UDF_SUPER_MAGIC
 0x15013346

	)

93 
	#BALLOON_KVM_MAGIC
 0x13661366

	)

94 
	#ZSMALLOC_MAGIC
 0x58295829

	)

95 
	#DMA_BUF_MAGIC
 0x444d4142

	)

96 
	#DEVMEM_MAGIC
 0x454d444d

	)

97 
	#Z3FOLD_MAGIC
 0x33

	)

99 
	#SHIFTFS_MAGIC
 0x6a656a62

	)

	@/usr/include/linux/mman.h

2 #iâdeà
_LINUX_MMAN_H


3 
	#_LINUX_MMAN_H


	)

5 
	~<asm/mmª.h
>

6 
	~<asm-g’”ic/hug‘lb_’code.h
>

8 
	#MREMAP_MAYMOVE
 1

	)

9 
	#MREMAP_FIXED
 2

	)

11 
	#OVERCOMMIT_GUESS
 0

	)

12 
	#OVERCOMMIT_ALWAYS
 1

	)

13 
	#OVERCOMMIT_NEVER
 2

	)

15 
	#MAP_SHARED
 0x01

	)

16 
	#MAP_PRIVATE
 0x02

	)

17 
	#MAP_SHARED_VALIDATE
 0x03

	)

26 
	#MAP_HUGE_SHIFT
 
HUGETLB_FLAG_ENCODE_SHIFT


	)

27 
	#MAP_HUGE_MASK
 
HUGETLB_FLAG_ENCODE_MASK


	)

29 
	#MAP_HUGE_64KB
 
HUGETLB_FLAG_ENCODE_64KB


	)

30 
	#MAP_HUGE_512KB
 
HUGETLB_FLAG_ENCODE_512KB


	)

31 
	#MAP_HUGE_1MB
 
HUGETLB_FLAG_ENCODE_1MB


	)

32 
	#MAP_HUGE_2MB
 
HUGETLB_FLAG_ENCODE_2MB


	)

33 
	#MAP_HUGE_8MB
 
HUGETLB_FLAG_ENCODE_8MB


	)

34 
	#MAP_HUGE_16MB
 
HUGETLB_FLAG_ENCODE_16MB


	)

35 
	#MAP_HUGE_32MB
 
HUGETLB_FLAG_ENCODE_32MB


	)

36 
	#MAP_HUGE_256MB
 
HUGETLB_FLAG_ENCODE_256MB


	)

37 
	#MAP_HUGE_512MB
 
HUGETLB_FLAG_ENCODE_512MB


	)

38 
	#MAP_HUGE_1GB
 
HUGETLB_FLAG_ENCODE_1GB


	)

39 
	#MAP_HUGE_2GB
 
HUGETLB_FLAG_ENCODE_2GB


	)

40 
	#MAP_HUGE_16GB
 
HUGETLB_FLAG_ENCODE_16GB


	)

	@/usr/include/linux/module.h

2 #iâdeà
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/mount.h

1 #iâdeà
_LINUX_MOUNT_H


2 
	#_LINUX_MOUNT_H


	)

11 
	#MS_RDONLY
 1

	)

12 
	#MS_NOSUID
 2

	)

13 
	#MS_NODEV
 4

	)

14 
	#MS_NOEXEC
 8

	)

15 
	#MS_SYNCHRONOUS
 16

	)

16 
	#MS_REMOUNT
 32

	)

17 
	#MS_MANDLOCK
 64

	)

18 
	#MS_DIRSYNC
 128

	)

19 
	#MS_NOATIME
 1024

	)

20 
	#MS_NODIRATIME
 2048

	)

21 
	#MS_BIND
 4096

	)

22 
	#MS_MOVE
 8192

	)

23 
	#MS_REC
 16384

	)

24 
	#MS_VERBOSE
 32768

	)

26 
	#MS_SILENT
 32768

	)

27 
	#MS_POSIXACL
 (1<<16è

	)

28 
	#MS_UNBINDABLE
 (1<<17è

	)

29 
	#MS_PRIVATE
 (1<<18è

	)

30 
	#MS_SLAVE
 (1<<19è

	)

31 
	#MS_SHARED
 (1<<20è

	)

32 
	#MS_RELATIME
 (1<<21è

	)

33 
	#MS_KERNMOUNT
 (1<<22è

	)

34 
	#MS_I_VERSION
 (1<<23è

	)

35 
	#MS_STRICTATIME
 (1<<24è

	)

36 
	#MS_LAZYTIME
 (1<<25è

	)

39 
	#MS_SUBMOUNT
 (1<<26)

	)

40 
	#MS_NOREMOTELOCK
 (1<<27)

	)

41 
	#MS_NOSEC
 (1<<28)

	)

42 
	#MS_BORN
 (1<<29)

	)

43 
	#MS_ACTIVE
 (1<<30)

	)

44 
	#MS_NOUSER
 (1<<31)

	)

49 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

50 
MS_LAZYTIME
)

	)

55 
	#MS_MGC_VAL
 0xC0ED0000

	)

56 
	#MS_MGC_MSK
 0xffff0000

	)

61 
	#OPEN_TREE_CLONE
 1

	)

62 
	#OPEN_TREE_CLOEXEC
 
O_CLOEXEC


	)

67 
	#MOVE_MOUNT_F_SYMLINKS
 0x00000001

	)

68 
	#MOVE_MOUNT_F_AUTOMOUNTS
 0x00000002

	)

69 
	#MOVE_MOUNT_F_EMPTY_PATH
 0x00000004

	)

70 
	#MOVE_MOUNT_T_SYMLINKS
 0x00000010

	)

71 
	#MOVE_MOUNT_T_AUTOMOUNTS
 0x00000020

	)

72 
	#MOVE_MOUNT_T_EMPTY_PATH
 0x00000040

	)

73 
	#MOVE_MOUNT__MASK
 0x00000077

	)

78 
	#FSOPEN_CLOEXEC
 0x00000001

	)

83 
	#FSPICK_CLOEXEC
 0x00000001

	)

84 
	#FSPICK_SYMLINK_NOFOLLOW
 0x00000002

	)

85 
	#FSPICK_NO_AUTOMOUNT
 0x00000004

	)

86 
	#FSPICK_EMPTY_PATH
 0x00000008

	)

91 
	efscÚfig_commªd
 {

92 
	mFSCONFIG_SET_FLAG
 = 0,

93 
	mFSCONFIG_SET_STRING
 = 1,

94 
	mFSCONFIG_SET_BINARY
 = 2,

95 
	mFSCONFIG_SET_PATH
 = 3,

96 
	mFSCONFIG_SET_PATH_EMPTY
 = 4,

97 
	mFSCONFIG_SET_FD
 = 5,

98 
	mFSCONFIG_CMD_CREATE
 = 6,

99 
	mFSCONFIG_CMD_RECONFIGURE
 = 7,

105 
	#FSMOUNT_CLOEXEC
 0x00000001

	)

110 
	#MOUNT_ATTR_RDONLY
 0x00000001

	)

111 
	#MOUNT_ATTR_NOSUID
 0x00000002

	)

112 
	#MOUNT_ATTR_NODEV
 0x00000004

	)

113 
	#MOUNT_ATTR_NOEXEC
 0x00000008

	)

114 
	#MOUNT_ATTR__ATIME
 0x00000070

	)

115 
	#MOUNT_ATTR_RELATIME
 0x00000000

	)

116 
	#MOUNT_ATTR_NOATIME
 0x00000010

	)

117 
	#MOUNT_ATTR_STRICTATIME
 0x00000020

	)

118 
	#MOUNT_ATTR_NODIRATIME
 0x00000080

	)

	@/usr/include/linux/posix_acl_xattr.h

18 #iâdeà
__UAPI_POSIX_ACL_XATTR_H


19 
	#__UAPI_POSIX_ACL_XATTR_H


	)

21 
	~<lšux/ty³s.h
>

24 
	#POSIX_ACL_XATTR_VERSION
 0x0002

	)

27 
	#ACL_UNDEFINED_ID
 (-1)

	)

29 
	sposix_aş_x©Œ_’Œy
 {

30 
__Ë16
 
	me_g
;

31 
__Ë16
 
	me_³rm
;

32 
__Ë32
 
	me_id
;

35 
	sposix_aş_x©Œ_h—d”
 {

36 
__Ë32
 
	ma_v”siÚ
;

	@/usr/include/linux/quota.h

33 #iâdeà
_LINUX_QUOTA_


34 
	#_LINUX_QUOTA_


	)

36 
	~<lšux/ty³s.h
>

38 
	#__DQUOT_VERSION__
 "dquÙ_6.6.0"

	)

40 
	#MAXQUOTAS
 3

	)

41 
	#USRQUOTA
 0

	)

42 
	#GRPQUOTA
 1

	)

43 
	#PRJQUOTA
 2

	)

48 
	#INITQFNAMES
 { \

53 };

	)

61 
	#SUBCMDMASK
 0x00ff

	)

62 
	#SUBCMDSHIFT
 8

	)

63 
	#QCMD
(
cmd
, 
ty³
è(((cmdè<< 
SUBCMDSHIFT
è| (Ñy³è& 
SUBCMDMASK
))

	)

65 
	#Q_SYNC
 0x800001

	)

66 
	#Q_QUOTAON
 0x800002

	)

67 
	#Q_QUOTAOFF
 0x800003

	)

68 
	#Q_GETFMT
 0x800004

	)

69 
	#Q_GETINFO
 0x800005

	)

70 
	#Q_SETINFO
 0x800006

	)

71 
	#Q_GETQUOTA
 0x800007

	)

72 
	#Q_SETQUOTA
 0x800008

	)

73 
	#Q_GETNEXTQUOTA
 0x800009

	)

76 
	#QFMT_VFS_OLD
 1

	)

77 
	#QFMT_VFS_V0
 2

	)

78 
	#QFMT_OCFS2
 3

	)

79 
	#QFMT_VFS_V1
 4

	)

83 
	#QIF_DQBLKSIZE_BITS
 10

	)

84 
	#QIF_DQBLKSIZE
 (1 << 
QIF_DQBLKSIZE_BITS
)

	)

91 
	mQIF_BLIMITS_B
 = 0,

92 
	mQIF_SPACE_B
,

93 
	mQIF_ILIMITS_B
,

94 
	mQIF_INODES_B
,

95 
	mQIF_BTIME_B
,

96 
	mQIF_ITIME_B
,

99 
	#QIF_BLIMITS
 (1 << 
QIF_BLIMITS_B
)

	)

100 
	#QIF_SPACE
 (1 << 
QIF_SPACE_B
)

	)

101 
	#QIF_ILIMITS
 (1 << 
QIF_ILIMITS_B
)

	)

102 
	#QIF_INODES
 (1 << 
QIF_INODES_B
)

	)

103 
	#QIF_BTIME
 (1 << 
QIF_BTIME_B
)

	)

104 
	#QIF_ITIME
 (1 << 
QIF_ITIME_B
)

	)

105 
	#QIF_LIMITS
 (
QIF_BLIMITS
 | 
QIF_ILIMITS
)

	)

106 
	#QIF_USAGE
 (
QIF_SPACE
 | 
QIF_INODES
)

	)

107 
	#QIF_TIMES
 (
QIF_BTIME
 | 
QIF_ITIME
)

	)

108 
	#QIF_ALL
 (
QIF_LIMITS
 | 
QIF_USAGE
 | 
QIF_TIMES
)

	)

110 
	sif_dqblk
 {

111 
__u64
 
	mdqb_bh¬dlim™
;

112 
__u64
 
	mdqb_bsoálim™
;

113 
__u64
 
	mdqb_cur¥aû
;

114 
__u64
 
	mdqb_ih¬dlim™
;

115 
__u64
 
	mdqb_isoálim™
;

116 
__u64
 
	mdqb_curšodes
;

117 
__u64
 
	mdqb_btime
;

118 
__u64
 
	mdqb_™ime
;

119 
__u32
 
	mdqb_v®id
;

122 
	sif_Ãxtdqblk
 {

123 
__u64
 
	mdqb_bh¬dlim™
;

124 
__u64
 
	mdqb_bsoálim™
;

125 
__u64
 
	mdqb_cur¥aû
;

126 
__u64
 
	mdqb_ih¬dlim™
;

127 
__u64
 
	mdqb_isoálim™
;

128 
__u64
 
	mdqb_curšodes
;

129 
__u64
 
	mdqb_btime
;

130 
__u64
 
	mdqb_™ime
;

131 
__u32
 
	mdqb_v®id
;

132 
__u32
 
	mdqb_id
;

139 
	#IIF_BGRACE
 1

	)

140 
	#IIF_IGRACE
 2

	)

141 
	#IIF_FLAGS
 4

	)

142 
	#IIF_ALL
 (
IIF_BGRACE
 | 
IIF_IGRACE
 | 
IIF_FLAGS
)

	)

145 
	mDQF_ROOT_SQUASH_B
 = 0,

146 
	mDQF_SYS_FILE_B
 = 16,

148 
	mDQF_PRIVATE


152 
	#DQF_ROOT_SQUASH
 (1 << 
DQF_ROOT_SQUASH_B
)

	)

154 
	#DQF_SYS_FILE
 (1 << 
DQF_SYS_FILE_B
)

	)

156 
	sif_dqšfo
 {

157 
__u64
 
	mdqi_bg¿û
;

158 
__u64
 
	mdqi_ig¿û
;

159 
__u32
 
	mdqi_æags
;

160 
__u32
 
	mdqi_v®id
;

166 
	#QUOTA_NL_NOWARN
 0

	)

167 
	#QUOTA_NL_IHARDWARN
 1

	)

168 
	#QUOTA_NL_ISOFTLONGWARN
 2

	)

169 
	#QUOTA_NL_ISOFTWARN
 3

	)

170 
	#QUOTA_NL_BHARDWARN
 4

	)

171 
	#QUOTA_NL_BSOFTLONGWARN
 5

	)

172 
	#QUOTA_NL_BSOFTWARN
 6

	)

173 
	#QUOTA_NL_IHARDBELOW
 7

	)

174 
	#QUOTA_NL_ISOFTBELOW
 8

	)

175 
	#QUOTA_NL_BHARDBELOW
 9

	)

176 
	#QUOTA_NL_BSOFTBELOW
 10

	)

179 
	mQUOTA_NL_C_UNSPEC
,

180 
	mQUOTA_NL_C_WARNING
,

181 
	m__QUOTA_NL_C_MAX
,

183 
	#QUOTA_NL_C_MAX
 (
__QUOTA_NL_C_MAX
 - 1)

	)

186 
	mQUOTA_NL_A_UNSPEC
,

187 
	mQUOTA_NL_A_QTYPE
,

188 
	mQUOTA_NL_A_EXCESS_ID
,

189 
	mQUOTA_NL_A_WARNING
,

190 
	mQUOTA_NL_A_DEV_MAJOR
,

191 
	mQUOTA_NL_A_DEV_MINOR
,

192 
	mQUOTA_NL_A_CAUSED_ID
,

193 
	mQUOTA_NL_A_PAD
,

194 
	m__QUOTA_NL_A_MAX
,

196 
	#QUOTA_NL_A_MAX
 (
__QUOTA_NL_A_MAX
 - 1)

	)

	@/usr/include/linux/random.h

8 #iâdeà
_LINUX_RANDOM_H


9 
	#_LINUX_RANDOM_H


	)

11 
	~<lšux/ty³s.h
>

12 
	~<lšux/ioùl.h
>

13 
	~<lšux/œqÄ.h
>

18 
	#RNDGETENTCNT
 
	`_IOR
Ğ'R', 0x00, )

	)

21 
	#RNDADDTOENTCNT
 
	`_IOW
Ğ'R', 0x01, )

	)

24 
	#RNDGETPOOL
 
	`_IOR
Ğ'R', 0x02, [2] )

	)

30 
	#RNDADDENTROPY
 
	`_IOW
Ğ'R', 0x03, [2] )

	)

33 
	#RNDZAPENTCNT
 
	`_IO
Ğ'R', 0x04 )

	)

36 
	#RNDCLEARPOOL
 
	`_IO
Ğ'R', 0x06 )

	)

39 
	#RNDRESEEDCRNG
 
	`_IO
Ğ'R', 0x07 )

	)

41 
	s¿nd_poŞ_šfo
 {

42 
	m’Œİy_couÁ
;

43 
	mbuf_size
;

44 
__u32
 
	mbuf
[0];

53 
	#GRND_NONBLOCK
 0x0001

	)

54 
	#GRND_RANDOM
 0x0002

	)

	@/usr/include/linux/sched.h

2 #iâdeà
_LINUX_SCHED_H


3 
	#_LINUX_SCHED_H


	)

5 
	~<lšux/ty³s.h
>

10 
	#CSIGNAL
 0x000000fà

	)

11 
	#CLONE_VM
 0x00000100

	)

12 
	#CLONE_FS
 0x00000200

	)

13 
	#CLONE_FILES
 0x00000400

	)

14 
	#CLONE_SIGHAND
 0x00000800

	)

15 
	#CLONE_PIDFD
 0x00001000

	)

16 
	#CLONE_PTRACE
 0x00002000

	)

17 
	#CLONE_VFORK
 0x00004000

	)

18 
	#CLONE_PARENT
 0x00008000

	)

19 
	#CLONE_THREAD
 0x00010000

	)

20 
	#CLONE_NEWNS
 0x00020000

	)

21 
	#CLONE_SYSVSEM
 0x00040000

	)

22 
	#CLONE_SETTLS
 0x00080000

	)

23 
	#CLONE_PARENT_SETTID
 0x00100000

	)

24 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

25 
	#CLONE_DETACHED
 0x00400000

	)

26 
	#CLONE_UNTRACED
 0x00800000

	)

27 
	#CLONE_CHILD_SETTID
 0x01000000

	)

28 
	#CLONE_NEWCGROUP
 0x02000000

	)

29 
	#CLONE_NEWUTS
 0x04000000

	)

30 
	#CLONE_NEWIPC
 0x08000000

	)

31 
	#CLONE_NEWUSER
 0x10000000

	)

32 
	#CLONE_NEWPID
 0x20000000

	)

33 
	#CLONE_NEWNET
 0x40000000

	)

34 
	#CLONE_IO
 0x80000000

	)

36 #iâdeà
__ASSEMBLY__


66 
	sşÚe_¬gs
 {

67 
__®igÃd_u64
 
	mæags
;

68 
__®igÃd_u64
 
	mpidfd
;

69 
__®igÃd_u64
 
	mchd_tid
;

70 
__®igÃd_u64
 
	m·»Á_tid
;

71 
__®igÃd_u64
 
	mex™_sigÇl
;

72 
__®igÃd_u64
 
	m¡ack
;

73 
__®igÃd_u64
 
	m¡ack_size
;

74 
__®igÃd_u64
 
	ms
;

78 
	#CLONE_ARGS_SIZE_VER0
 64

	)

83 
	#SCHED_NORMAL
 0

	)

84 
	#SCHED_FIFO
 1

	)

85 
	#SCHED_RR
 2

	)

86 
	#SCHED_BATCH
 3

	)

88 
	#SCHED_IDLE
 5

	)

89 
	#SCHED_DEADLINE
 6

	)

92 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

97 
	#SCHED_FLAG_RESET_ON_FORK
 0x01

	)

98 
	#SCHED_FLAG_RECLAIM
 0x02

	)

99 
	#SCHED_FLAG_DL_OVERRUN
 0x04

	)

100 
	#SCHED_FLAG_KEEP_POLICY
 0x08

	)

101 
	#SCHED_FLAG_KEEP_PARAMS
 0x10

	)

102 
	#SCHED_FLAG_UTIL_CLAMP_MIN
 0x20

	)

103 
	#SCHED_FLAG_UTIL_CLAMP_MAX
 0x40

	)

105 
	#SCHED_FLAG_KEEP_ALL
 (
SCHED_FLAG_KEEP_POLICY
 | \

106 
SCHED_FLAG_KEEP_PARAMS
)

	)

108 
	#SCHED_FLAG_UTIL_CLAMP
 (
SCHED_FLAG_UTIL_CLAMP_MIN
 | \

109 
SCHED_FLAG_UTIL_CLAMP_MAX
)

	)

111 
	#SCHED_FLAG_ALL
 (
SCHED_FLAG_RESET_ON_FORK
 | \

112 
SCHED_FLAG_RECLAIM
 | \

113 
SCHED_FLAG_DL_OVERRUN
 | \

114 
SCHED_FLAG_KEEP_ALL
 | \

115 
SCHED_FLAG_UTIL_CLAMP
)

	)

	@/usr/include/linux/stat.h

2 #iâdeà
_LINUX_STAT_H


3 
	#_LINUX_STAT_H


	)

5 
	~<lšux/ty³s.h
>

7 #ià
defšed
(
__KERNEL__
è|| !defšed(
__GLIBC__
) || (__GLIBC__ < 2)

9 
	#S_IFMT
 00170000

	)

10 
	#S_IFSOCK
 0140000

	)

11 
	#S_IFLNK
 0120000

	)

12 
	#S_IFREG
 0100000

	)

13 
	#S_IFBLK
 0060000

	)

14 
	#S_IFDIR
 0040000

	)

15 
	#S_IFCHR
 0020000

	)

16 
	#S_IFIFO
 0010000

	)

17 
	#S_ISUID
 0004000

	)

18 
	#S_ISGID
 0002000

	)

19 
	#S_ISVTX
 0001000

	)

21 
	#S_ISLNK
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFLNK
)

	)

22 
	#S_ISREG
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFREG
)

	)

23 
	#S_ISDIR
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFDIR
)

	)

24 
	#S_ISCHR
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFCHR
)

	)

25 
	#S_ISBLK
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFBLK
)

	)

26 
	#S_ISFIFO
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFIFO
)

	)

27 
	#S_ISSOCK
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFSOCK
)

	)

29 
	#S_IRWXU
 00700

	)

30 
	#S_IRUSR
 00400

	)

31 
	#S_IWUSR
 00200

	)

32 
	#S_IXUSR
 00100

	)

34 
	#S_IRWXG
 00070

	)

35 
	#S_IRGRP
 00040

	)

36 
	#S_IWGRP
 00020

	)

37 
	#S_IXGRP
 00010

	)

39 
	#S_IRWXO
 00007

	)

40 
	#S_IROTH
 00004

	)

41 
	#S_IWOTH
 00002

	)

42 
	#S_IXOTH
 00001

	)

56 
	s¡©x_time¡amp
 {

57 
__s64
 
	mtv_£c
;

58 
__u32
 
	mtv_n£c
;

59 
__s32
 
	m__»£rved
;

99 
	s¡©x
 {

101 
__u32
 
	m¡x_mask
;

102 
__u32
 
	m¡x_blksize
;

103 
__u64
 
	m¡x_©Œibu‹s
;

105 
__u32
 
	m¡x_Æšk
;

106 
__u32
 
	m¡x_uid
;

107 
__u32
 
	m¡x_gid
;

108 
__u16
 
	m¡x_mode
;

109 
__u16
 
	m__¥¬e0
[1];

111 
__u64
 
	m¡x_šo
;

112 
__u64
 
	m¡x_size
;

113 
__u64
 
	m¡x_blocks
;

114 
__u64
 
	m¡x_©Œibu‹s_mask
;

116 
¡©x_time¡amp
 
	m¡x_©ime
;

117 
¡©x_time¡amp
 
	m¡x_btime
;

118 
¡©x_time¡amp
 
	m¡x_ùime
;

119 
¡©x_time¡amp
 
	m¡x_mtime
;

121 
__u32
 
	m¡x_rdev_majÜ
;

122 
__u32
 
	m¡x_rdev_mšÜ
;

123 
__u32
 
	m¡x_dev_majÜ
;

124 
__u32
 
	m¡x_dev_mšÜ
;

126 
__u64
 
	m__¥¬e2
[14];

138 
	#STATX_TYPE
 0x00000001U

	)

139 
	#STATX_MODE
 0x00000002U

	)

140 
	#STATX_NLINK
 0x00000004U

	)

141 
	#STATX_UID
 0x00000008U

	)

142 
	#STATX_GID
 0x00000010U

	)

143 
	#STATX_ATIME
 0x00000020U

	)

144 
	#STATX_MTIME
 0x00000040U

	)

145 
	#STATX_CTIME
 0x00000080U

	)

146 
	#STATX_INO
 0x00000100U

	)

147 
	#STATX_SIZE
 0x00000200U

	)

148 
	#STATX_BLOCKS
 0x00000400U

	)

149 
	#STATX_BASIC_STATS
 0x000007ffU

	)

150 
	#STATX_BTIME
 0x00000800U

	)

151 
	#STATX_ALL
 0x00000fffU

	)

152 
	#STATX__RESERVED
 0x80000000U

	)

165 
	#STATX_ATTR_COMPRESSED
 0x00000004

	)

166 
	#STATX_ATTR_IMMUTABLE
 0x00000010

	)

167 
	#STATX_ATTR_APPEND
 0x00000020

	)

168 
	#STATX_ATTR_NODUMP
 0x00000040

	)

169 
	#STATX_ATTR_ENCRYPTED
 0x00000800

	)

171 
	#STATX_ATTR_AUTOMOUNT
 0x00001000

	)

	@/usr/include/linux/string.h

2 #iâdeà
_LINUX_STRING_H_


3 
	#_LINUX_STRING_H_


	)

7 
	~<¡ršg.h
>

	@/usr/include/linux/time.h

2 #iâdeà
_LINUX_TIME_H


3 
	#_LINUX_TIME_H


	)

5 
	~<lšux/ty³s.h
>

6 
	~<lšux/time_ty³s.h
>

8 #iâdeà
_STRUCT_TIMESPEC


9 
	#_STRUCT_TIMESPEC


	)

10 
	stime¥ec
 {

11 
__k”Ãl_time_t
 
	mtv_£c
;

12 
	mtv_n£c
;

16 
	stimev®
 {

17 
__k”Ãl_time_t
 
	mtv_£c
;

18 
__k”Ãl_su£cÚds_t
 
	mtv_u£c
;

21 
	stimezÚe
 {

22 
	mtz_mšu‹swe¡
;

23 
	mtz_d¡time
;

30 
	#ITIMER_REAL
 0

	)

31 
	#ITIMER_VIRTUAL
 1

	)

32 
	#ITIMER_PROF
 2

	)

34 
	s™im”¥ec
 {

35 
time¥ec
 
	m™_š‹rv®
;

36 
time¥ec
 
	m™_v®ue
;

39 
	s™im”v®
 {

40 
timev®
 
	m™_š‹rv®
;

41 
timev®
 
	m™_v®ue
;

47 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

49 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

50 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

51 
	#CLOCK_MONOTONIC_RAW
 4

	)

52 
	#CLOCK_REALTIME_COARSE
 5

	)

53 
	#CLOCK_MONOTONIC_COARSE
 6

	)

54 
	#CLOCK_BOOTTIME
 7

	)

55 
	#CLOCK_REALTIME_ALARM
 8

	)

56 
	#CLOCK_BOOTTIME_ALARM
 9

	)

61 
	#CLOCK_SGI_CYCLE
 10

	)

62 
	#CLOCK_TAI
 11

	)

64 
	#MAX_CLOCKS
 16

	)

65 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

66 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

71 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/types.h

2 #iâdeà
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty³s.h
>

7 #iâdeà
__ASSEMBLY__


9 
	~<lšux/posix_ty³s.h
>

17 #ifdeà
__CHECKER__


18 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

20 
	#__b™wi£__


	)

22 
	#__b™wi£
 
__b™wi£__


	)

24 
__u16
 
	t__b™wi£
 
	t__Ë16
;

25 
__u16
 
	t__b™wi£
 
	t__be16
;

26 
__u32
 
	t__b™wi£
 
	t__Ë32
;

27 
__u32
 
	t__b™wi£
 
	t__be32
;

28 
__u64
 
	t__b™wi£
 
	t__Ë64
;

29 
__u64
 
	t__b™wi£
 
	t__be64
;

31 
__u16
 
	t__b™wi£
 
	t__sum16
;

32 
__u32
 
	t__b™wi£
 
	t__wsum
;

43 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

44 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

45 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

47 
	t__b™wi£
 
	t__pŞl_t
;

	@/usr/include/linux/uio.h

10 #iâdeà
__LINUX_UIO_H


11 
	#__LINUX_UIO_H


	)

14 
	~<lšux/ty³s.h
>

17 
	siovec


19 *
	miov_ba£
;

20 
__k”Ãl_size_t
 
	miov_Ën
;

27 
	#UIO_FASTIOV
 8

	)

28 
	#UIO_MAXIOV
 1024

	)

	@/usr/include/linux/utsname.h

2 #iâdeà
_LINUX_UTSNAME_H


3 
	#_LINUX_UTSNAME_H


	)

5 
	#__OLD_UTS_LEN
 8

	)

7 
	sŞdŞd_ut¢ame
 {

8 
	msy¢ame
[9];

9 
	mnod’ame
[9];

10 
	m»Ëa£
[9];

11 
	mv”siÚ
[9];

12 
	mmachše
[9];

15 
	#__NEW_UTS_LEN
 64

	)

17 
	sŞd_ut¢ame
 {

18 
	msy¢ame
[65];

19 
	mnod’ame
[65];

20 
	m»Ëa£
[65];

21 
	mv”siÚ
[65];

22 
	mmachše
[65];

25 
	sÃw_ut¢ame
 {

26 
	msy¢ame
[
__NEW_UTS_LEN
 + 1];

27 
	mnod’ame
[
__NEW_UTS_LEN
 + 1];

28 
	m»Ëa£
[
__NEW_UTS_LEN
 + 1];

29 
	mv”siÚ
[
__NEW_UTS_LEN
 + 1];

30 
	mmachše
[
__NEW_UTS_LEN
 + 1];

31 
	mdomašÇme
[
__NEW_UTS_LEN
 + 1];

	@/usr/include/linux/uuid.h

18 #iâdeà
_LINUX_UUID_H_


19 
	#_LINUX_UUID_H_


	)

21 
	~<lšux/ty³s.h
>

24 
__u8
 
	mb
[16];

25 } 
	tguid_t
;

27 
	#GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

28 ((
guid_t
) \

29 {{ (
a
) & 0xff, ((a) >> 8) & 0xff, ((a) >> 16) & 0xff, ((a) >> 24) & 0xff, \

30 (
b
) & 0xff, ((b) >> 8) & 0xff, \

31 (
c
) & 0xff, ((c) >> 8) & 0xff, \

32 (
d0
), (
d1
), (
d2
), (
d3
), (
d4
), (
d5
), (
d6
), (
d7
è}})

	)

35 
guid_t
 
	tuuid_Ë
;

36 
	#UUID_LE
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

37 
	`GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
)

	)

38 
	#NULL_UUID_LE
 \

39 
	`UUID_LE
(0x00000000, 0x0000, 0x0000, 0x00, 0x00, 0x00, 0x00, \

40 0x00, 0x00, 0x00, 0x00)

	)

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 328769

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
è((×è<< 16è+ ((bè<< 8è+ (c))

	)

	@/usr/include/linux/wait.h

2 #iâdeà
_LINUX_WAIT_H


3 
	#_LINUX_WAIT_H


	)

5 
	#WNOHANG
 0x00000001

	)

6 
	#WUNTRACED
 0x00000002

	)

7 
	#WSTOPPED
 
WUNTRACED


	)

8 
	#WEXITED
 0x00000004

	)

9 
	#WCONTINUED
 0x00000008

	)

10 
	#WNOWAIT
 0x01000000

	)

12 
	#__WNOTHREAD
 0x20000000

	)

13 
	#__WALL
 0x40000000

	)

14 
	#__WCLONE
 0x80000000

	)

17 
	#P_ALL
 0

	)

18 
	#P_PID
 1

	)

19 
	#P_PGID
 2

	)

20 
	#P_PIDFD
 3

	)

	@/usr/include/linux/xattr.h

12 
	~<lšux/libc-com·t.h
>

14 #iâdeà
_LINUX_XATTR_H


15 
	#_LINUX_XATTR_H


	)

17 #ià
__UAPI_DEF_XATTR


18 
	#__USE_KERNEL_XATTR_DEFS


	)

20 
	#XATTR_CREATE
 0x1

	)

21 
	#XATTR_REPLACE
 0x2

	)

25 
	#XATTR_OS2_PREFIX
 "os2."

	)

26 
	#XATTR_OS2_PREFIX_LEN
 ((
XATTR_OS2_PREFIX
è- 1)

	)

28 
	#XATTR_MAC_OSX_PREFIX
 "osx."

	)

29 
	#XATTR_MAC_OSX_PREFIX_LEN
 ((
XATTR_MAC_OSX_PREFIX
è- 1)

	)

31 
	#XATTR_BTRFS_PREFIX
 "bŒfs."

	)

32 
	#XATTR_BTRFS_PREFIX_LEN
 ((
XATTR_BTRFS_PREFIX
è- 1)

	)

34 
	#XATTR_SECURITY_PREFIX
 "£cur™y."

	)

35 
	#XATTR_SECURITY_PREFIX_LEN
 ((
XATTR_SECURITY_PREFIX
è- 1)

	)

37 
	#XATTR_SYSTEM_PREFIX
 "sy¡em."

	)

38 
	#XATTR_SYSTEM_PREFIX_LEN
 ((
XATTR_SYSTEM_PREFIX
è- 1)

	)

40 
	#XATTR_TRUSTED_PREFIX
 "Œu¡ed."

	)

41 
	#XATTR_TRUSTED_PREFIX_LEN
 ((
XATTR_TRUSTED_PREFIX
è- 1)

	)

43 
	#XATTR_USER_PREFIX
 "u£r."

	)

44 
	#XATTR_USER_PREFIX_LEN
 ((
XATTR_USER_PREFIX
è- 1)

	)

47 
	#XATTR_EVM_SUFFIX
 "evm"

	)

48 
	#XATTR_NAME_EVM
 
XATTR_SECURITY_PREFIX
 
XATTR_EVM_SUFFIX


	)

50 
	#XATTR_IMA_SUFFIX
 "ima"

	)

51 
	#XATTR_NAME_IMA
 
XATTR_SECURITY_PREFIX
 
XATTR_IMA_SUFFIX


	)

53 
	#XATTR_SELINUX_SUFFIX
 "£lšux"

	)

54 
	#XATTR_NAME_SELINUX
 
XATTR_SECURITY_PREFIX
 
XATTR_SELINUX_SUFFIX


	)

56 
	#XATTR_SMACK_SUFFIX
 "SMACK64"

	)

57 
	#XATTR_SMACK_IPIN
 "SMACK64IPIN"

	)

58 
	#XATTR_SMACK_IPOUT
 "SMACK64IPOUT"

	)

59 
	#XATTR_SMACK_EXEC
 "SMACK64EXEC"

	)

60 
	#XATTR_SMACK_TRANSMUTE
 "SMACK64TRANSMUTE"

	)

61 
	#XATTR_SMACK_MMAP
 "SMACK64MMAP"

	)

62 
	#XATTR_NAME_SMACK
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_SUFFIX


	)

63 
	#XATTR_NAME_SMACKIPIN
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPIN


	)

64 
	#XATTR_NAME_SMACKIPOUT
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPOUT


	)

65 
	#XATTR_NAME_SMACKEXEC
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_EXEC


	)

66 
	#XATTR_NAME_SMACKTRANSMUTE
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_TRANSMUTE


	)

67 
	#XATTR_NAME_SMACKMMAP
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_MMAP


	)

69 
	#XATTR_APPARMOR_SUFFIX
 "­·rmÜ"

	)

70 
	#XATTR_NAME_APPARMOR
 
XATTR_SECURITY_PREFIX
 
XATTR_APPARMOR_SUFFIX


	)

72 
	#XATTR_CAPS_SUFFIX
 "ÿ·b™y"

	)

73 
	#XATTR_NAME_CAPS
 
XATTR_SECURITY_PREFIX
 
XATTR_CAPS_SUFFIX


	)

75 
	#XATTR_POSIX_ACL_ACCESS
 "posix_aş_acûss"

	)

76 
	#XATTR_NAME_POSIX_ACL_ACCESS
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_ACCESS


	)

77 
	#XATTR_POSIX_ACL_DEFAULT
 "posix_aş_deçuÉ"

	)

78 
	#XATTR_NAME_POSIX_ACL_DEFAULT
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_DEFAULT


	)

	@/usr/include/asm-generic/hugetlb_encode.h

1 #iâdeà
_ASM_GENERIC_HUGETLB_ENCODE_H_


2 
	#_ASM_GENERIC_HUGETLB_ENCODE_H_


	)

20 
	#HUGETLB_FLAG_ENCODE_SHIFT
 26

	)

21 
	#HUGETLB_FLAG_ENCODE_MASK
 0x3f

	)

23 
	#HUGETLB_FLAG_ENCODE_64KB
 (16 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

24 
	#HUGETLB_FLAG_ENCODE_512KB
 (19 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

25 
	#HUGETLB_FLAG_ENCODE_1MB
 (20 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

26 
	#HUGETLB_FLAG_ENCODE_2MB
 (21 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

27 
	#HUGETLB_FLAG_ENCODE_8MB
 (23 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

28 
	#HUGETLB_FLAG_ENCODE_16MB
 (24 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

29 
	#HUGETLB_FLAG_ENCODE_32MB
 (25 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

30 
	#HUGETLB_FLAG_ENCODE_256MB
 (28 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

31 
	#HUGETLB_FLAG_ENCODE_512MB
 (29 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

32 
	#HUGETLB_FLAG_ENCODE_1GB
 (30 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

33 
	#HUGETLB_FLAG_ENCODE_2GB
 (31 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

34 
	#HUGETLB_FLAG_ENCODE_16GB
 (34 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

	@/usr/include/linux/ioctl.h

2 #iâdeà
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/ioùl.h
>

	@/usr/include/linux/irqnr.h

	@/usr/include/linux/libc-compat.h

49 #iâdeà
_LIBC_COMPAT_H


50 
	#_LIBC_COMPAT_H


	)

53 #ià
defšed
(
__GLIBC__
)

56 #ià
defšed
(
_NET_IF_H
è&& defšed(
__USE_MISC
)

61 
	#__UAPI_DEF_IF_IFCONF
 0

	)

62 
	#__UAPI_DEF_IF_IFMAP
 0

	)

63 
	#__UAPI_DEF_IF_IFNAMSIZ
 0

	)

64 
	#__UAPI_DEF_IF_IFREQ
 0

	)

66 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 0

	)

68 #iâdeà
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


69 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

78 
	#__UAPI_DEF_IF_IFCONF
 1

	)

79 
	#__UAPI_DEF_IF_IFMAP
 1

	)

80 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

81 
	#__UAPI_DEF_IF_IFREQ
 1

	)

83 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

85 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

90 #ià
defšed
(
_NETINET_IN_H
)

94 
	#__UAPI_DEF_IN_ADDR
 0

	)

95 
	#__UAPI_DEF_IN_IPPROTO
 0

	)

96 
	#__UAPI_DEF_IN_PKTINFO
 0

	)

97 
	#__UAPI_DEF_IP_MREQ
 0

	)

98 
	#__UAPI_DEF_SOCKADDR_IN
 0

	)

99 
	#__UAPI_DEF_IN_CLASS
 0

	)

101 
	#__UAPI_DEF_IN6_ADDR
 0

	)

106 #ià
defšed
(
__USE_MISC
è|| defšed (
__USE_GNU
)

107 
	#__UAPI_DEF_IN6_ADDR_ALT
 0

	)

109 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

111 
	#__UAPI_DEF_SOCKADDR_IN6
 0

	)

112 
	#__UAPI_DEF_IPV6_MREQ
 0

	)

113 
	#__UAPI_DEF_IPPROTO_V6
 0

	)

114 
	#__UAPI_DEF_IPV6_OPTIONS
 0

	)

115 
	#__UAPI_DEF_IN6_PKTINFO
 0

	)

116 
	#__UAPI_DEF_IP6_MTUINFO
 0

	)

123 
	#__UAPI_DEF_IN_ADDR
 1

	)

124 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

125 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

126 
	#__UAPI_DEF_IP_MREQ
 1

	)

127 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

128 
	#__UAPI_DEF_IN_CLASS
 1

	)

130 
	#__UAPI_DEF_IN6_ADDR
 1

	)

133 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

134 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

135 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

136 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

137 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

138 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

139 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

144 #ià
defšed
(
__NETIPX_IPX_H
)

146 
	#__UAPI_DEF_SOCKADDR_IPX
 0

	)

147 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 0

	)

148 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 0

	)

149 
	#__UAPI_DEF_IPX_CONFIG_DATA
 0

	)

150 
	#__UAPI_DEF_IPX_ROUTE_DEF
 0

	)

154 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

155 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

156 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

157 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

158 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

163 #ià
defšed
(
_SYS_XATTR_H
)

164 
	#__UAPI_DEF_XATTR
 0

	)

166 
	#__UAPI_DEF_XATTR
 1

	)

176 #iâdeà
__UAPI_DEF_IF_IFCONF


177 
	#__UAPI_DEF_IF_IFCONF
 1

	)

179 #iâdeà
__UAPI_DEF_IF_IFMAP


180 
	#__UAPI_DEF_IF_IFMAP
 1

	)

182 #iâdeà
__UAPI_DEF_IF_IFNAMSIZ


183 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

185 #iâdeà
__UAPI_DEF_IF_IFREQ


186 
	#__UAPI_DEF_IF_IFREQ
 1

	)

189 #iâdeà
__UAPI_DEF_IF_NET_DEVICE_FLAGS


190 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

193 #iâdeà
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


194 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

198 #iâdeà
__UAPI_DEF_IN_ADDR


199 
	#__UAPI_DEF_IN_ADDR
 1

	)

201 #iâdeà
__UAPI_DEF_IN_IPPROTO


202 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

204 #iâdeà
__UAPI_DEF_IN_PKTINFO


205 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

207 #iâdeà
__UAPI_DEF_IP_MREQ


208 
	#__UAPI_DEF_IP_MREQ
 1

	)

210 #iâdeà
__UAPI_DEF_SOCKADDR_IN


211 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

213 #iâdeà
__UAPI_DEF_IN_CLASS


214 
	#__UAPI_DEF_IN_CLASS
 1

	)

218 #iâdeà
__UAPI_DEF_IN6_ADDR


219 
	#__UAPI_DEF_IN6_ADDR
 1

	)

221 #iâdeà
__UAPI_DEF_IN6_ADDR_ALT


222 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

224 #iâdeà
__UAPI_DEF_SOCKADDR_IN6


225 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

227 #iâdeà
__UAPI_DEF_IPV6_MREQ


228 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

230 #iâdeà
__UAPI_DEF_IPPROTO_V6


231 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

233 #iâdeà
__UAPI_DEF_IPV6_OPTIONS


234 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

236 #iâdeà
__UAPI_DEF_IN6_PKTINFO


237 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

239 #iâdeà
__UAPI_DEF_IP6_MTUINFO


240 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

244 #iâdeà
__UAPI_DEF_SOCKADDR_IPX


245 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

247 #iâdeà
__UAPI_DEF_IPX_ROUTE_DEFINITION


248 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

250 #iâdeà
__UAPI_DEF_IPX_INTERFACE_DEFINITION


251 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

253 #iâdeà
__UAPI_DEF_IPX_CONFIG_DATA


254 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

256 #iâdeà
__UAPI_DEF_IPX_ROUTE_DEF


257 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

261 #iâdeà
__UAPI_DEF_XATTR


262 
	#__UAPI_DEF_XATTR
 1

	)

	@/usr/include/linux/limits.h

2 #iâdeà
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/posix_types.h

2 #iâdeà
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<lšux/¡ddef.h
>

22 #undeà
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_b™s
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__k”Ãl_fd_£t
;

30 (*
	t__k”Ãl_sighªdËr_t
)();

33 
	t__k”Ãl_key_t
;

34 
	t__k”Ãl_mqd_t
;

36 
	~<asm/posix_ty³s.h
>

	@/usr/include/linux/sysinfo.h

2 #iâdeà
_LINUX_SYSINFO_H


3 
	#_LINUX_SYSINFO_H


	)

5 
	~<lšux/ty³s.h
>

7 
	#SI_LOAD_SHIFT
 16

	)

8 
	ssysšfo
 {

9 
__k”Ãl_lÚg_t
 
	mu±ime
;

10 
__k”Ãl_ulÚg_t
 
	mlßds
[3];

11 
__k”Ãl_ulÚg_t
 
	mtÙ®¿m
;

12 
__k”Ãl_ulÚg_t
 
	mä“¿m
;

13 
__k”Ãl_ulÚg_t
 
	msh¬ed¿m
;

14 
__k”Ãl_ulÚg_t
 
	mbufã¼am
;

15 
__k”Ãl_ulÚg_t
 
	mtÙ®sw­
;

16 
__k”Ãl_ulÚg_t
 
	mä“sw­
;

17 
__u16
 
	m´ocs
;

18 
__u16
 
	m·d
;

19 
__k”Ãl_ulÚg_t
 
	mtÙ®high
;

20 
__k”Ãl_ulÚg_t
 
	mä“high
;

21 
__u32
 
	mmem_un™
;

22 
	m_f
[20-2*(
__k”Ãl_ulÚg_t
)-(
__u32
)];

	@/usr/include/linux/time_types.h

2 #iâdeà
_LINUX_TIME_TYPES_H


3 
	#_LINUX_TIME_TYPES_H


	)

5 
	~<lšux/ty³s.h
>

7 
	s__k”Ãl_time¥ec
 {

8 
__k”Ãl_time64_t
 
	mtv_£c
;

9 
	mtv_n£c
;

12 
	s__k”Ãl_™im”¥ec
 {

13 
__k”Ãl_time¥ec
 
	m™_š‹rv®
;

14 
__k”Ãl_time¥ec
 
	m™_v®ue
;

24 #iâdeà
__k”Ãl_Şd_timev®


25 
	s__k”Ãl_Şd_timev®
 {

26 
__k”Ãl_lÚg_t
 
	mtv_£c
;

27 
__k”Ãl_lÚg_t
 
	mtv_u£c
;

31 
	s__k”Ãl_sock_timev®
 {

32 
__s64
 
	mtv_£c
;

33 
__s64
 
	mtv_u£c
;

	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<b™s/libc-h—d”-¡¬t.h
>

28 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

36 #ià
defšed
 
__ılu¥lus
 && (
__GNUC_PREREQ
 (4, 4) \

37 || 
	$__glibc_şªg_´”eq
 (3, 5))

38 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

43 *
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

44 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

47 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

48 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

53 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN
 || 
	`__GLIBC_USE
 (
ISOC2X
)

54 *
	$memcıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

61 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

64 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

65 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

68 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


71 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

72 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

73 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

74 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

76 #ifdeà
__OPTIMIZE__


77 
__ex‹º_®ways_šlše
 *

78 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


80  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

83 
__ex‹º_®ways_šlše
 const *

84 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


86  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

89 
	}
}

91 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

92 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

95 #ifdeà
__USE_GNU


98 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


99 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

100 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

101 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

102 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

104 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

105 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

109 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


110 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

111 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

112 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

113 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

115 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

116 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

122 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

123 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

125 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

126 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

127 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

130 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

131 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

133 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

134 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

137 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

138 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

140 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

141 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

144 
	$¡rcŞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

145 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

147 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

148 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

149 
__THROW
 
	`__nÚnuÎ
 ((2));

151 #ifdeà
__USE_XOPEN2K8


153 
	~<b™s/ty³s/loÿË_t.h
>

156 
	$¡rcŞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
loÿË_t
 
__l
)

157 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

160 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

161 
loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

164 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8
 \

165 || 
	`__GLIBC_USE
 (
LIB_EXT2
è|| 
	$__GLIBC_USE
 (
ISOC2X
))

167 *
	$¡rdup
 (cÚ¡ *
__s
)

168 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

174 #ià
defšed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
è|| __GLIBC_USE (
ISOC2X
)

175 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

176 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

179 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


181 
	#¡rdu·
(
s
) \

182 (
__ex‹nsiÚ__
 \

184 cÚ¡ *
__Şd
 = (
s
); \

185 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

186 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

187 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

188 
	}
}))

	)

191 
	#¡ºdu·
(
s
, 
n
) \

192 (
__ex‹nsiÚ__
 \

194 cÚ¡ *
__Şd
 = (
s
); \

195 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

196 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

197 
__Ãw
[
__Ën
] = '\0'; \

198 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

199 }))

	)

203 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


206 *
¡rchr
 (*
__s
, 
__c
)

207 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

208 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

209 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

211 #ifdeà
__OPTIMIZE__


212 
__ex‹º_®ways_šlše
 *

213 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


215  
__butš_¡rchr
 (
__s
, 
__c
);

218 
__ex‹º_®ways_šlše
 const *

219 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


221  
__butš_¡rchr
 (
__s
, 
__c
);

226 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

227 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

230 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


233 *
	`¡¼chr
 (*
__s
, 
__c
)

234 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

235 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

236 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

238 #ifdeà
__OPTIMIZE__


239 
__ex‹º_®ways_šlše
 *

240 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


242  
	`__butš_¡¼chr
 (
__s
, 
__c
);

245 
__ex‹º_®ways_šlše
 const *

246 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


248  
	`__butš_¡¼chr
 (
__s
, 
__c
);

251 
	}
}

253 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

254 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

257 #ifdeà
__USE_GNU


260 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


261 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

262 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

263 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

264 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

266 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

267 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

273 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

274 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

277 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

278 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

280 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


283 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

284 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

285 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

286 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

288 #ifdeà
__OPTIMIZE__


289 
__ex‹º_®ways_šlše
 *

290 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


292  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

295 
__ex‹º_®ways_šlše
 const *

296 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


298  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

301 
	}
}

303 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

304 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

307 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


310 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

311 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

312 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

313 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

315 #ifdeà
__OPTIMIZE__


316 
__ex‹º_®ways_šlše
 *

317 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


319  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

322 
__ex‹º_®ways_šlše
 const *

323 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


325  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

328 
	}
}

330 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

331 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

336 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

337 
__THROW
 
	`__nÚnuÎ
 ((2));

341 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

342 cÚ¡ *
__»¡riù
 
__d–im
,

343 **
__»¡riù
 
__§ve_±r
)

344 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

345 #ifdeà
__USE_POSIX


346 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

347 **
__»¡riù
 
__§ve_±r
)

348 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

351 #ifdeà
__USE_GNU


353 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


354 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

355 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

356 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

357 cÚ¡ *
__ÃedË
)

358 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

360 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

361 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

365 #ifdeà
__USE_GNU


369 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

370 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

371 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

375 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

376 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

377 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

378 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

379 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

380 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

385 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

386 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

388 #ifdef 
__USE_XOPEN2K8


391 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

392 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

397 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

398 #ifdeà
__USE_XOPEN2K


406 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


409 #ifdeà
__REDIRECT_NTH


410 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

411 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

412 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

414 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

415 
__THROW
 
	`__nÚnuÎ
 ((2));

416 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

421 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

422 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

426 #ifdeà
__USE_XOPEN2K8


428 *
	$¡»¼Ü_l
 (
__”ºum
, 
loÿË_t
 
__l
è
__THROW
;

431 #ifdeà
__USE_MISC


432 
	~<¡ršgs.h
>

436 
	$ex¶ic™_bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

440 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

441 cÚ¡ *
__»¡riù
 
__d–im
)

442 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

445 #ifdef 
__USE_XOPEN2K8


447 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

450 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

451 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

452 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

453 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

457 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

458 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

459 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

460 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

461 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

462 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

465 #ifdef 
__USE_GNU


467 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

468 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

471 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

474 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

476 #iâdeà
ba£Çme


481 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


482 "C++" *
	$ba£Çme
 (*
__f’ame
)

483 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

484 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__f’ame
)

485 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

487 *
	$ba£Çme
 (cÚ¡ *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

492 #ià
	`__GNUC_PREREQ
 (3,4)

493 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


495 
	~<b™s/¡ršg_fÜtif›d.h
>

499 
__END_DECLS


	@/usr/include/linux/stddef.h

4 #iâdeà
__®ways_šlše


5 
	#__®ways_šlše
 
__šlše__


	)

	@/usr/include/strings.h

18 #iâdef 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	#__Ãed_size_t


	)

23 
	~<¡ddef.h
>

26 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

27 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

30 
	g__BEGIN_DECLS


32 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


34 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

35 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

38 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

39 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

42 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

45 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


48 *
	`šdex
 (*
__s
, 
__c
)

49 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

50 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

51 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

53 #ià
defšed
 
__OPTIMIZE__


54 
__ex‹º_®ways_šlše
 *

55 
	`šdex
 (*
__s
, 
__c
è
__THROW


57  
	`__butš_šdex
 (
__s
, 
__c
);

60 
__ex‹º_®ways_šlše
 const *

61 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


63  
	`__butš_šdex
 (
__s
, 
__c
);

66 
	}
}

68 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

69 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

73 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


76 *
	`ršdex
 (*
__s
, 
__c
)

77 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

78 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

79 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

81 #ià
defšed
 
__OPTIMIZE__


82 
__ex‹º_®ways_šlše
 *

83 
	`ršdex
 (*
__s
, 
__c
è
__THROW


85  
	`__butš_ršdex
 (
__s
, 
__c
);

88 
__ex‹º_®ways_šlše
 const *

89 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


91  
	`__butš_ršdex
 (
__s
, 
__c
);

94 
	}
}

96 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

97 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

101 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8
 || defšed 
__USE_XOPEN2K8XSI


104 
	$ffs
 (
__i
è
__THROW
 
__©Œibu‹_cÚ¡__
;

109 #ifdef 
__USE_MISC


110 
	$ff¦
 (
__l
è
__THROW
 
__©Œibu‹_cÚ¡__
;

111 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

112 
__THROW
 
__©Œibu‹_cÚ¡__
;

116 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

117 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

120 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

121 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

123 #ifdef 
__USE_XOPEN2K8


125 
	~<b™s/ty³s/loÿË_t.h
>

128 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
loÿË_t
 
__loc
)

129 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

133 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

134 
size_t
 
__n
, 
loÿË_t
 
__loc
)

135 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

138 
__END_DECLS


140 #ià
	`__GNUC_PREREQ
 (3,4è&& 
__USE_FORTIFY_LEVEL
 > 0 \

141 && 
defšed
 
__fÜtify_funùiÚ


143 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


144 
	~<b™s/¡ršgs_fÜtif›d.h
>

	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

120 #undeà
__USE_ISOC11


121 #undeà
__USE_ISOC99


122 #undeà
__USE_ISOC95


123 #undeà
__USE_ISOCXX11


124 #undeà
__USE_POSIX


125 #undeà
__USE_POSIX2


126 #undeà
__USE_POSIX199309


127 #undeà
__USE_POSIX199506


128 #undeà
__USE_XOPEN


129 #undeà
__USE_XOPEN_EXTENDED


130 #undeà
__USE_UNIX98


131 #undeà
__USE_XOPEN2K


132 #undeà
__USE_XOPEN2KXSI


133 #undeà
__USE_XOPEN2K8


134 #undeà
__USE_XOPEN2K8XSI


135 #undeà
__USE_LARGEFILE


136 #undeà
__USE_LARGEFILE64


137 #undeà
__USE_FILE_OFFSET64


138 #undeà
__USE_MISC


139 #undeà
__USE_ATFILE


140 #undeà
__USE_GNU


141 #undeà
__USE_FORTIFY_LEVEL


142 #undeà
__KERNEL_STRICT_NAMES


143 #undeà
__GLIBC_USE_ISOC2X


144 #undeà
__GLIBC_USE_DEPRECATED_GETS


145 #undeà
__GLIBC_USE_DEPRECATED_SCANF


149 #iâdeà
_LOOSE_KERNEL_NAMES


150 
	#__KERNEL_STRICT_NAMES


	)

160 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


161 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

162 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

164 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

171 #ià
defšed
 
__şªg_majÜ__
 && defšed 
__şªg_mšÜ__


172 
	#__glibc_şªg_´”eq
(
maj
, 
mš
) \

173 ((
__şªg_majÜ__
 << 16è+ 
__şªg_mšÜ__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

175 
	#__glibc_şªg_´”eq
(
maj
, 
mš
è0

	)

179 
	#__GLIBC_USE
(
F
è
__GLIBC_USE_
 ## 
	)
F

185 #ià(
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE
) \

186 && !
defšed
 
	g_DEFAULT_SOURCE


188 #undeà
_DEFAULT_SOURCE


189 
	#_DEFAULT_SOURCE
 1

	)

193 #ifdeà
_GNU_SOURCE


194 #undeà
_ISOC95_SOURCE


195 
	#_ISOC95_SOURCE
 1

	)

196 #undeà
_ISOC99_SOURCE


197 
	#_ISOC99_SOURCE
 1

	)

198 #undeà
_ISOC11_SOURCE


199 
	#_ISOC11_SOURCE
 1

	)

200 #undeà
_ISOC2X_SOURCE


201 
	#_ISOC2X_SOURCE
 1

	)

202 #undeà
_POSIX_SOURCE


203 
	#_POSIX_SOURCE
 1

	)

204 #undeà
_POSIX_C_SOURCE


205 
	#_POSIX_C_SOURCE
 200809L

	)

206 #undeà
_XOPEN_SOURCE


207 
	#_XOPEN_SOURCE
 700

	)

208 #undeà
_XOPEN_SOURCE_EXTENDED


209 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

210 #undeà
_LARGEFILE64_SOURCE


211 
	#_LARGEFILE64_SOURCE
 1

	)

212 #undeà
_DEFAULT_SOURCE


213 
	#_DEFAULT_SOURCE
 1

	)

214 #undeà
_ATFILE_SOURCE


215 
	#_ATFILE_SOURCE
 1

	)

220 #ià(
defšed
 
_DEFAULT_SOURCE
 \

221 || (!
defšed
 
	g__STRICT_ANSI__
 \

222 && !
defšed
 
	g_ISOC99_SOURCE
 && !defšed 
	g_ISOC11_SOURCE
 \

223 && !
defšed
 
	g_ISOC2X_SOURCE
 \

224 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

225 && !
defšed
 
	g_XOPEN_SOURCE
))

226 #undeà
_DEFAULT_SOURCE


227 
	#_DEFAULT_SOURCE
 1

	)

231 #ià(
defšed
 
_ISOC2X_SOURCE
 \

232 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ > 201710L))

233 
	#__GLIBC_USE_ISOC2X
 1

	)

235 
	#__GLIBC_USE_ISOC2X
 0

	)

239 #ià(
defšed
 
_ISOC11_SOURCE
 || defšed 
_ISOC2X_SOURCE
 \

240 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

241 
	#__USE_ISOC11
 1

	)

245 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

246 || 
defšed
 
_ISOC2X_SOURCE
 \

247 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

248 
	#__USE_ISOC99
 1

	)

252 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

253 || 
defšed
 
_ISOC2X_SOURCE
 \

254 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

255 
	#__USE_ISOC95
 1

	)

258 #ifdeà
__ılu¥lus


260 #ià
__ılu¥lus
 >= 201703L

261 
	#__USE_ISOC11
 1

	)

265 #ià
__ılu¥lus
 >ğ201103L || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__


266 
	#__USE_ISOCXX11
 1

	)

267 
	#__USE_ISOC99
 1

	)

274 #ifdeà
_DEFAULT_SOURCE


275 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


276 
	#__USE_POSIX_IMPLICITLY
 1

	)

278 #undeà
_POSIX_SOURCE


279 
	#_POSIX_SOURCE
 1

	)

280 #undeà
_POSIX_C_SOURCE


281 
	#_POSIX_C_SOURCE
 200809L

	)

284 #ià((!
defšed
 
__STRICT_ANSI__
 \

285 || (
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

286 && !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

287 
	#_POSIX_SOURCE
 1

	)

288 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

289 
	#_POSIX_C_SOURCE
 2

	)

290 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

291 
	#_POSIX_C_SOURCE
 199506L

	)

292 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

293 
	#_POSIX_C_SOURCE
 200112L

	)

295 
	#_POSIX_C_SOURCE
 200809L

	)

297 
	#__USE_POSIX_IMPLICITLY
 1

	)

306 #ià((!
defšed
 
_POSIX_C_SOURCE
 || (_POSIX_C_SOURCE - 0) < 199506L) \

307 && (
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE
))

308 
	#_POSIX_SOURCE
 1

	)

309 #undeà
_POSIX_C_SOURCE


310 
	#_POSIX_C_SOURCE
 199506L

	)

313 #ià(
defšed
 
_POSIX_SOURCE
 \

314 || (
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

315 || 
defšed
 
_XOPEN_SOURCE
)

316 
	#__USE_POSIX
 1

	)

319 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


320 
	#__USE_POSIX2
 1

	)

323 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

324 
	#__USE_POSIX199309
 1

	)

327 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

328 
	#__USE_POSIX199506
 1

	)

331 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

332 
	#__USE_XOPEN2K
 1

	)

333 #undeà
__USE_ISOC95


334 
	#__USE_ISOC95
 1

	)

335 #undeà
__USE_ISOC99


336 
	#__USE_ISOC99
 1

	)

339 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

340 
	#__USE_XOPEN2K8
 1

	)

341 #undeà
_ATFILE_SOURCE


342 
	#_ATFILE_SOURCE
 1

	)

345 #ifdef 
_XOPEN_SOURCE


346 
	#__USE_XOPEN
 1

	)

347 #ià(
_XOPEN_SOURCE
 - 0) >= 500

348 
	#__USE_XOPEN_EXTENDED
 1

	)

349 
	#__USE_UNIX98
 1

	)

350 #undeà
_LARGEFILE_SOURCE


351 
	#_LARGEFILE_SOURCE
 1

	)

352 #ià(
_XOPEN_SOURCE
 - 0) >= 600

353 #ià(
_XOPEN_SOURCE
 - 0) >= 700

354 
	#__USE_XOPEN2K8
 1

	)

355 
	#__USE_XOPEN2K8XSI
 1

	)

357 
	#__USE_XOPEN2K
 1

	)

358 
	#__USE_XOPEN2KXSI
 1

	)

359 #undeà
__USE_ISOC95


360 
	#__USE_ISOC95
 1

	)

361 #undeà
__USE_ISOC99


362 
	#__USE_ISOC99
 1

	)

365 #ifdeà
_XOPEN_SOURCE_EXTENDED


366 
	#__USE_XOPEN_EXTENDED
 1

	)

371 #ifdeà
_LARGEFILE_SOURCE


372 
	#__USE_LARGEFILE
 1

	)

375 #ifdeà
_LARGEFILE64_SOURCE


376 
	#__USE_LARGEFILE64
 1

	)

379 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

380 
	#__USE_FILE_OFFSET64
 1

	)

383 #ià
defšed
 
_DEFAULT_SOURCE


384 
	#__USE_MISC
 1

	)

387 #ifdef 
_ATFILE_SOURCE


388 
	#__USE_ATFILE
 1

	)

391 #ifdef 
_GNU_SOURCE


392 
	#__USE_GNU
 1

	)

395 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

396 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

397 #ià
_FORTIFY_SOURCE
 > 1

398 
	#__USE_FORTIFY_LEVEL
 2

	)

400 
	#__USE_FORTIFY_LEVEL
 1

	)

403 
	#__USE_FORTIFY_LEVEL
 0

	)

410 #ià
defšed
 
__ılu¥lus
 ? __ılu¥lu >ğ201402L : defšed 
__USE_ISOC11


411 
	#__GLIBC_USE_DEPRECATED_GETS
 0

	)

413 
	#__GLIBC_USE_DEPRECATED_GETS
 1

	)

428 #ià(
defšed
 
__USE_GNU
 \

429 && (
defšed
 
	g__ılu¥lus
 \

430 ? (
	g__ılu¥lus
 < 201103L && !
defšed
 
	g__GXX_EXPERIMENTAL_CXX0X__
) \

431 : (!
defšed
 
__STDC_VERSION__
 || __STDC_VERSION__ < 199901L)))

432 
	#__GLIBC_USE_DEPRECATED_SCANF
 1

	)

434 
	#__GLIBC_USE_DEPRECATED_SCANF
 0

	)

439 
	~<¡dc-´edef.h
>

447 #undeà
__GNU_LIBRARY__


448 
	#__GNU_LIBRARY__
 6

	)

452 
	#__GLIBC__
 2

	)

453 
	#__GLIBC_MINOR__
 31

	)

455 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

456 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

459 #iâdeà
__ASSEMBLER__


460 #iâdeà
_SYS_CDEFS_H


461 
	~<sys/cdefs.h
>

466 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


467 
	#__USE_LARGEFILE
 1

	)

468 
	#__USE_LARGEFILE64
 1

	)

474 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

475 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

476 && 
defšed
 
	g__ex‹º_šlše


477 
	#__USE_EXTERN_INLINES
 1

	)

485 
	~<gnu/¡ubs.h
>

	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

58 
	#__STDC_ISO_10646__
 201706L

	)

	@
1
.
1
/usr/include
90
1907
jbd3/checkpoint.c
jbd3/commit.c
jbd3/journal.c
jbd3/recovery.c
jbd3/revoke.c
jbd3/transaction.c
pxt4/acl.c
pxt4/acl.h
pxt4/balloc.c
pxt4/bitmap.c
pxt4/block_validity.c
pxt4/dir.c
pxt4/ext4.h
pxt4/ext4_extents.h
pxt4/ext4_jbd2.c
pxt4/ext4_jbd2.h
pxt4/extents.c
pxt4/extents_status.c
pxt4/extents_status.h
pxt4/file.c
pxt4/fsmap.c
pxt4/fsmap.h
pxt4/fsync.c
pxt4/hash.c
pxt4/ialloc.c
pxt4/indirect.c
pxt4/inline.c
pxt4/inode.c
pxt4/ioctl.c
pxt4/mballoc.c
pxt4/mballoc.h
pxt4/migrate.c
pxt4/mmp.c
pxt4/move_extent.c
pxt4/namei.c
pxt4/page-io.c
pxt4/readpage.c
pxt4/resize.c
pxt4/super.c
pxt4/symlink.c
pxt4/sysfs.c
pxt4/truncate.h
pxt4/verity.c
pxt4/xattr.c
pxt4/xattr.h
pxt4/xattr_security.c
pxt4/xattr_trusted.c
pxt4/xattr_user.c
/usr/include/linux/capability.h
/usr/include/linux/errno.h
/usr/include/linux/falloc.h
/usr/include/linux/fcntl.h
/usr/include/linux/fiemap.h
/usr/include/linux/fs.h
/usr/include/linux/fscrypt.h
/usr/include/linux/fsmap.h
/usr/include/linux/fsverity.h
/usr/include/linux/kdev_t.h
/usr/include/linux/kernel.h
/usr/include/linux/magic.h
/usr/include/linux/mman.h
/usr/include/linux/module.h
/usr/include/linux/mount.h
/usr/include/linux/posix_acl_xattr.h
/usr/include/linux/quota.h
/usr/include/linux/random.h
/usr/include/linux/sched.h
/usr/include/linux/stat.h
/usr/include/linux/string.h
/usr/include/linux/time.h
/usr/include/linux/types.h
/usr/include/linux/uio.h
/usr/include/linux/utsname.h
/usr/include/linux/uuid.h
/usr/include/linux/version.h
/usr/include/linux/wait.h
/usr/include/linux/xattr.h
/usr/include/asm-generic/hugetlb_encode.h
/usr/include/linux/ioctl.h
/usr/include/linux/irqnr.h
/usr/include/linux/libc-compat.h
/usr/include/linux/limits.h
/usr/include/linux/posix_types.h
/usr/include/linux/sysinfo.h
/usr/include/linux/time_types.h
/usr/include/string.h
/usr/include/linux/stddef.h
/usr/include/strings.h
/usr/include/features.h
/usr/include/stdc-predef.h
