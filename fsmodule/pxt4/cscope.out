cscope 15 /home/ungung97/fsmodule/pxt4               0001329269
	@acl.c

8 
	~<löux/quŸa›s.h
>

9 
	~"pxt4_jbd3.h
"

10 
	~"pxt4.h
"

11 
	~"x©å.h
"

12 
	~"a˛.h
"

17 
posix_a˛
 *

18 
	$pxt4_a˛_‰om_disk
(c⁄° *
vÆue
, 
size_t
 
size
)

20 c⁄° *
íd
 = (*)
vÆue
 + 
size
;

21 
n
, 
cou¡
;

22 
posix_a˛
 *
a˛
;

24 i‡(!
vÆue
)

25  
NULL
;

26 i‡(
size
 < (
pxt4_a˛_hódî
))

27  
	`ERR_PTR
(-
EINVAL
);

28 i‡(((
pxt4_a˛_hódî
 *)
vÆue
)->
a_vîsi⁄
 !=

29 
	`˝u_to_À32
(
PXT4_ACL_VERSION
))

30  
	`ERR_PTR
(-
EINVAL
);

31 
vÆue
 = (*)vÆuê+ (
pxt4_a˛_hódî
);

32 
cou¡
 = 
	`pxt4_a˛_cou¡
(
size
);

33 i‡(
cou¡
 < 0)

34  
	`ERR_PTR
(-
EINVAL
);

35 i‡(
cou¡
 == 0)

36  
NULL
;

37 
a˛
 = 
	`posix_a˛_Æloc
(
cou¡
, 
GFP_NOFS
);

38 i‡(!
a˛
)

39  
	`ERR_PTR
(-
ENOMEM
);

40 
n
 = 0;Ç < 
cou¡
;Ç++) {

41 
pxt4_a˛_íåy
 *
íåy
 =

42 (
pxt4_a˛_íåy
 *)
vÆue
;

43 i‡((*)
vÆue
 + (
pxt4_a˛_íåy_sh‹t
Ë> 
íd
)

44 
Áû
;

45 
a˛
->
a_íåõs
[
n
].
e_èg
 = 
	`À16_to_˝u
(
íåy
->e_tag);

46 
a˛
->
a_íåõs
[
n
].
e_≥rm
 = 
	`À16_to_˝u
(
íåy
->e_perm);

48 
a˛
->
a_íåõs
[
n
].
e_èg
) {

49 
ACL_USER_OBJ
:

50 
ACL_GROUP_OBJ
:

51 
ACL_MASK
:

52 
ACL_OTHER
:

53 
vÆue
 = (*)value +

54 (
pxt4_a˛_íåy_sh‹t
);

57 
ACL_USER
:

58 
vÆue
 = (*)vÆuê+ (
pxt4_a˛_íåy
);

59 i‡((*)
vÆue
 > 
íd
)

60 
Áû
;

61 
a˛
->
a_íåõs
[
n
].
e_uid
 =

62 
	`make_kuid
(&
öô_u£r_ns
,

63 
	`À32_to_˝u
(
íåy
->
e_id
));

65 
ACL_GROUP
:

66 
vÆue
 = (*)vÆuê+ (
pxt4_a˛_íåy
);

67 i‡((*)
vÆue
 > 
íd
)

68 
Áû
;

69 
a˛
->
a_íåõs
[
n
].
e_gid
 =

70 
	`make_kgid
(&
öô_u£r_ns
,

71 
	`À32_to_˝u
(
íåy
->
e_id
));

75 
Áû
;

78 i‡(
vÆue
 !
íd
)

79 
Áû
;

80  
a˛
;

82 
Áû
:

83 
	`posix_a˛_ªÀa£
(
a˛
);

84  
	`ERR_PTR
(-
EINVAL
);

85 
	}
}

91 
	$pxt4_a˛_to_disk
(c⁄° 
posix_a˛
 *
a˛
, 
size_t
 *
size
)

93 
pxt4_a˛_hódî
 *
ext_a˛
;

94 *
e
;

95 
size_t
 
n
;

97 *
size
 = 
	`pxt4_a˛_size
(
a˛
->
a_cou¡
);

98 
ext_a˛
 = 
	`kmÆloc
((
pxt4_a˛_hódî
Ë+ 
a˛
->
a_cou¡
 *

99 (
pxt4_a˛_íåy
), 
GFP_NOFS
);

100 i‡(!
ext_a˛
)

101  
	`ERR_PTR
(-
ENOMEM
);

102 
ext_a˛
->
a_vîsi⁄
 = 
	`˝u_to_À32
(
PXT4_ACL_VERSION
);

103 
e
 = (*)
ext_a˛
 + (
pxt4_a˛_hódî
);

104 
n
 = 0;Ç < 
a˛
->
a_cou¡
;Ç++) {

105 c⁄° 
posix_a˛_íåy
 *
a˛_e
 = &
a˛
->
a_íåõs
[
n
];

106 
pxt4_a˛_íåy
 *
íåy
 = (pxt4_a˛_íåy *)
e
;

107 
íåy
->
e_èg
 = 
	`˝u_to_À16
(
a˛_e
->e_tag);

108 
íåy
->
e_≥rm
 = 
	`˝u_to_À16
(
a˛_e
->e_perm);

109 
a˛_e
->
e_èg
) {

110 
ACL_USER
:

111 
íåy
->
e_id
 = 
	`˝u_to_À32
(

112 
	`‰om_kuid
(&
öô_u£r_ns
, 
a˛_e
->
e_uid
));

113 
e
 +(
pxt4_a˛_íåy
);

115 
ACL_GROUP
:

116 
íåy
->
e_id
 = 
	`˝u_to_À32
(

117 
	`‰om_kgid
(&
öô_u£r_ns
, 
a˛_e
->
e_gid
));

118 
e
 +(
pxt4_a˛_íåy
);

121 
ACL_USER_OBJ
:

122 
ACL_GROUP_OBJ
:

123 
ACL_MASK
:

124 
ACL_OTHER
:

125 
e
 +(
pxt4_a˛_íåy_sh‹t
);

129 
Áû
;

132  (*)
ext_a˛
;

134 
Áû
:

135 
	`k‰ì
(
ext_a˛
);

136  
	`ERR_PTR
(-
EINVAL
);

137 
	}
}

144 
posix_a˛
 *

145 
	$pxt4_gë_a˛
(
öode
 *öode, 
ty≥
)

147 
«me_ödex
;

148 *
vÆue
 = 
NULL
;

149 
posix_a˛
 *
a˛
;

150 
ªtvÆ
;

152 
ty≥
) {

153 
ACL_TYPE_ACCESS
:

154 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
;

156 
ACL_TYPE_DEFAULT
:

157 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
;

160 
	`BUG
();

162 
ªtvÆ
 = 
	`pxt4_x©å_gë
(
öode
, 
«me_ödex
, "", 
NULL
, 0);

163 i‡(
ªtvÆ
 > 0) {

164 
vÆue
 = 
	`kmÆloc
(
ªtvÆ
, 
GFP_NOFS
);

165 i‡(!
vÆue
)

166  
	`ERR_PTR
(-
ENOMEM
);

167 
ªtvÆ
 = 
	`pxt4_x©å_gë
(
öode
, 
«me_ödex
, "", 
vÆue
,Ñetval);

169 i‡(
ªtvÆ
 > 0)

170 
a˛
 = 
	`pxt4_a˛_‰om_disk
(
vÆue
, 
ªtvÆ
);

171 i‡(
ªtvÆ
 =-
ENODATA
 ||ÑëvÆ =-
ENOSYS
)

172 
a˛
 = 
NULL
;

174 
a˛
 = 
	`ERR_PTR
(
ªtvÆ
);

175 
	`k‰ì
(
vÆue
);

177  
a˛
;

178 
	}
}

186 
	$__pxt4_£t_a˛
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, 
ty≥
,

187 
posix_a˛
 *
a˛
, 
x©å_Êags
)

189 
«me_ödex
;

190 *
vÆue
 = 
NULL
;

191 
size_t
 
size
 = 0;

192 
îr‹
;

194 
ty≥
) {

195 
ACL_TYPE_ACCESS
:

196 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
;

199 
ACL_TYPE_DEFAULT
:

200 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
;

201 i‡(!
	`S_ISDIR
(
öode
->
i_mode
))

202  
a˛
 ? -
EACCES
 : 0;

206  -
EINVAL
;

208 i‡(
a˛
) {

209 
vÆue
 = 
	`pxt4_a˛_to_disk
(
a˛
, &
size
);

210 i‡(
	`IS_ERR
(
vÆue
))

211  ()
	`PTR_ERR
(
vÆue
);

214 
îr‹
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
, 
«me_ödex
, "",

215 
vÆue
, 
size
, 
x©å_Êags
);

217 
	`k‰ì
(
vÆue
);

218 i‡(!
îr‹
) {

219 
	`£t_ˇched_a˛
(
öode
, 
ty≥
, 
a˛
);

222  
îr‹
;

223 
	}
}

226 
	$pxt4_£t_a˛
(
öode
 *öode, 
posix_a˛
 *
a˛
, 
ty≥
)

228 
h™dÀ_t
 *
h™dÀ
;

229 
îr‹
, 
¸edôs
, 
ªåõs
 = 0;

230 
size_t
 
a˛_size
 = 
a˛
 ? 
	`pxt4_a˛_size
◊˛->
a_cou¡
) : 0;

231 
umode_t
 
mode
 = 
öode
->
i_mode
;

232 
upd©e_mode
 = 0;

234 
îr‹
 = 
	`dquŸ_öôülize
(
öode
);

235 i‡(
îr‹
)

236  
îr‹
;

237 
ªåy
:

238 
îr‹
 = 
	`pxt4_x©å_£t_¸edôs
(
öode
, 
a˛_size
, 
Ál£
 ,

239 &
¸edôs
);

240 i‡(
îr‹
)

241  
îr‹
;

243 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_XATTR
, 
¸edôs
);

244 i‡(
	`IS_ERR
(
h™dÀ
))

245  
	`PTR_ERR
(
h™dÀ
);

247 i‡((
ty≥
 =
ACL_TYPE_ACCESS
Ë&& 
a˛
) {

248 
îr‹
 = 
	`posix_a˛_upd©e_mode
(
öode
, &
mode
, &
a˛
);

249 i‡(
îr‹
)

250 
out_°›
;

251 i‡(
mode
 !
öode
->
i_mode
)

252 
upd©e_mode
 = 1;

255 
îr‹
 = 
	`__pxt4_£t_a˛
(
h™dÀ
, 
öode
, 
ty≥
, 
a˛
, 0 );

256 i‡(!
îr‹
 && 
upd©e_mode
) {

257 
öode
->
i_mode
 = 
mode
;

258 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

259 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

261 
out_°›
:

262 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

263 i‡(
îr‹
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

264 
ªåy
;

265  
îr‹
;

266 
	}
}

275 
	$pxt4_öô_a˛
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, öodê*
dú
)

277 
posix_a˛
 *
deÁu…_a˛
, *
a˛
;

278 
îr‹
;

280 
îr‹
 = 
	`posix_a˛_¸óã
(
dú
, &
öode
->
i_mode
, &
deÁu…_a˛
, &
a˛
);

281 i‡(
îr‹
)

282  
îr‹
;

284 i‡(
deÁu…_a˛
) {

285 
îr‹
 = 
	`__pxt4_£t_a˛
(
h™dÀ
, 
öode
, 
ACL_TYPE_DEFAULT
,

286 
deÁu…_a˛
, 
XATTR_CREATE
);

287 
	`posix_a˛_ªÀa£
(
deÁu…_a˛
);

289 
öode
->
i_deÁu…_a˛
 = 
NULL
;

291 i‡(
a˛
) {

292 i‡(!
îr‹
)

293 
îr‹
 = 
	`__pxt4_£t_a˛
(
h™dÀ
, 
öode
, 
ACL_TYPE_ACCESS
,

294 
a˛
, 
XATTR_CREATE
);

295 
	`posix_a˛_ªÀa£
(
a˛
);

297 
öode
->
i_a˛
 = 
NULL
;

299  
îr‹
;

300 
	}
}

	@acl.h

8 
	~<löux/posix_a˛_x©å.h
>

10 
	#PXT4_ACL_VERSION
 0x0001

	)

13 
__À16
 
	me_èg
;

14 
__À16
 
	me_≥rm
;

15 
__À32
 
	me_id
;

16 } 
	tpxt4_a˛_íåy
;

19 
__À16
 
	me_èg
;

20 
__À16
 
	me_≥rm
;

21 } 
	tpxt4_a˛_íåy_sh‹t
;

24 
__À32
 
	ma_vîsi⁄
;

25 } 
	tpxt4_a˛_hódî
;

27 
ölöe
 
size_t
 
	$pxt4_a˛_size
(
cou¡
)

29 i‡(
cou¡
 <= 4) {

30  (
pxt4_a˛_hódî
) +

31 
cou¡
 * (
pxt4_a˛_íåy_sh‹t
);

33  (
pxt4_a˛_hódî
) +

34 4 * (
pxt4_a˛_íåy_sh‹t
) +

35 (
cou¡
 - 4Ë* (
pxt4_a˛_íåy
);

37 
	}
}

39 
ölöe
 
	$pxt4_a˛_cou¡
(
size_t
 
size
)

41 
ssize_t
 
s
;

42 
size
 -(
pxt4_a˛_hódî
);

43 
s
 = 
size
 - 4 * (
pxt4_a˛_íåy_sh‹t
);

44 i‡(
s
 < 0) {

45 i‡(
size
 % (
pxt4_a˛_íåy_sh‹t
))

47  
size
 / (
pxt4_a˛_íåy_sh‹t
);

49 i‡(
s
 % (
pxt4_a˛_íåy
))

51  
s
 / (
pxt4_a˛_íåy
) + 4;

53 
	}
}

55 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


58 
posix_a˛
 *
pxt4_gë_a˛
(
öode
 *öode, 
ty≥
);

59 
pxt4_£t_a˛
(
öode
 *öode, 
posix_a˛
 *
a˛
, 
ty≥
);

60 
pxt4_öô_a˛
(
h™dÀ_t
 *, 
öode
 *, inode *);

63 
	~<löux/sched.h
>

64 
	#pxt4_gë_a˛
 
NULL


	)

65 
	#pxt4_£t_a˛
 
NULL


	)

67 
ölöe
 

68 
	$pxt4_öô_a˛
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, öodê*
dú
)

71 
	}
}

	@balloc.c

15 
	~<löux/time.h
>

16 
	~<löux/ˇ∑bûôy.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/quŸa›s.h
>

19 
	~<löux/buf„r_hód.h
>

20 
	~"pxt4.h
"

21 
	~"pxt4_jbd3.h
"

22 
	~"mbÆloc.h
"

24 
	~<åa˚/evíts/pxt4.h
>

26 
pxt4_num_ba£_mëa_˛u°îs
(
su≥r_block
 *
sb
,

27 
pxt4_group_t
 
block_group
);

35 
pxt4_group_t
 
	$pxt4_gë_group_numbî
(
su≥r_block
 *
sb
,

36 
pxt4_fsblk_t
 
block
)

38 
pxt4_group_t
 
group
;

40 i‡(
	`ã°_›t2
(
sb
, 
STD_GROUP_SIZE
))

41 
group
 = (
block
 -

42 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
)) >>

43 (
	`PXT4_BLOCK_SIZE_BITS
(
sb
Ë+ 
	`PXT4_CLUSTER_BITS
(sb) + 3);

45 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
block
, &
group
, 
NULL
);

46  
group
;

47 
	}
}

53 
	$pxt4_gë_group_no_™d_off£t
(
su≥r_block
 *
sb
, 
pxt4_fsblk_t
 
blockƒ
,

54 
pxt4_group_t
 *
blockgΩp
, 
pxt4_gΩblk_t
 *
off£ç
)

56 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

57 
pxt4_gΩblk_t
 
off£t
;

59 
blockƒ
 = blockƒ - 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
);

60 
off£t
 = 
	`do_div
(
blockƒ
, 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)) >>

61 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
;

62 i‡(
off£ç
)

63 *
off£ç
 = 
off£t
;

64 i‡(
blockgΩp
)

65 *
blockgΩp
 = 
blockƒ
;

67 
	}
}

73 
ölöe
 
	$pxt4_block_ö_group
(
su≥r_block
 *
sb
,

74 
pxt4_fsblk_t
 
block
,

75 
pxt4_group_t
 
block_group
)

77 
pxt4_group_t
 
a˘uÆ_group
;

79 
a˘uÆ_group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
block
);

80  (
a˘uÆ_group
 =
block_group
) ? 1 : 0;

81 
	}
}

86 
	$pxt4_num_ovîhód_˛u°îs
(
su≥r_block
 *
sb
,

87 
pxt4_group_t
 
block_group
,

88 
pxt4_group_desc
 *
gdp
)

90 
num_˛u°îs
;

91 
block_˛u°î
 = -1, 
öode_˛u°î
 = -1, 
ôbl_˛u°î
 = -1, 
i
, 
c
;

92 
pxt4_fsblk_t
 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

93 
pxt4_fsblk_t
 
ôbl_blk
;

94 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

99 
num_˛u°îs
 = 
	`pxt4_num_ba£_mëa_˛u°îs
(
sb
, 
block_group
);

113 i‡(
	`pxt4_block_ö_group
(
sb
, 
	`pxt4_block_bôm≠
(sb, 
gdp
), 
block_group
)) {

114 
block_˛u°î
 = 
	`PXT4_B2C
(
sbi
,

115 
	`pxt4_block_bôm≠
(
sb
, 
gdp
Ë- 
°¨t
);

116 i‡(
block_˛u°î
 < 
num_˛u°îs
)

117 
block_˛u°î
 = -1;

118 i‡(
block_˛u°î
 =
num_˛u°îs
) {

119 
num_˛u°îs
++;

120 
block_˛u°î
 = -1;

124 i‡(
	`pxt4_block_ö_group
(
sb
, 
	`pxt4_öode_bôm≠
(sb, 
gdp
), 
block_group
)) {

125 
öode_˛u°î
 = 
	`PXT4_B2C
(
sbi
,

126 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
Ë- 
°¨t
);

127 i‡(
öode_˛u°î
 < 
num_˛u°îs
)

128 
öode_˛u°î
 = -1;

129 i‡(
öode_˛u°î
 =
num_˛u°îs
) {

130 
num_˛u°îs
++;

131 
öode_˛u°î
 = -1;

135 
ôbl_blk
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

136 
i
 = 0; i < 
sbi
->
s_ôb_≥r_group
; i++) {

137 i‡(
	`pxt4_block_ö_group
(
sb
, 
ôbl_blk
 + 
i
, 
block_group
)) {

138 
c
 = 
	`PXT4_B2C
(
sbi
, 
ôbl_blk
 + 
i
 - 
°¨t
);

139 i‡((
c
 < 
num_˛u°îs
Ë|| (¯=
öode_˛u°î
) ||

140 (
c
 =
block_˛u°î
Ë|| (¯=
ôbl_˛u°î
))

142 i‡(
c
 =
num_˛u°îs
) {

143 
num_˛u°îs
++;

146 
num_˛u°îs
++;

147 
ôbl_˛u°î
 = 
c
;

151 i‡(
block_˛u°î
 != -1)

152 
num_˛u°îs
++;

153 i‡(
öode_˛u°î
 != -1)

154 
num_˛u°îs
++;

156  
num_˛u°îs
;

157 
	}
}

159 
	$num_˛u°îs_ö_group
(
su≥r_block
 *
sb
,

160 
pxt4_group_t
 
block_group
)

162 
blocks
;

164 i‡(
block_group
 =
	`pxt4_gë_groups_cou¡
(
sb
) - 1) {

171 
blocks
 = 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
sb
)->
s_es
) -

172 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

174 
blocks
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

175  
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
), 
blocks
);

176 
	}
}

179 
	$pxt4_öô_block_bôm≠
(
su≥r_block
 *
sb
,

180 
buf„r_hód
 *
bh
,

181 
pxt4_group_t
 
block_group
,

182 
pxt4_group_desc
 *
gdp
)

184 
bô
, 
bô_max
;

185 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

186 
pxt4_fsblk_t
 
°¨t
, 
tmp
;

188 
	`J_ASSERT_BH
(
bh
, 
	`buf„r_locked
(bh));

192 i‡(!
	`pxt4_group_desc_csum_vîify
(
sb
, 
block_group
, 
gdp
)) {

193 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

194 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
 |

195 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

196  -
EFSBADCRC
;

198 
	`mem£t
(
bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

200 
bô_max
 = 
	`pxt4_num_ba£_mëa_˛u°îs
(
sb
, 
block_group
);

201 i‡((
bô_max
 >> 3Ë>
bh
->
b_size
)

202  -
EFSCORRUPTED
;

204 
bô
 = 0; bô < 
bô_max
; bit++)

205 
	`pxt4_£t_bô
(
bô
, 
bh
->
b_d©a
);

207 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

210 
tmp
 = 
	`pxt4_block_bôm≠
(
sb
, 
gdp
);

211 i‡(
	`pxt4_block_ö_group
(
sb
, 
tmp
, 
block_group
))

212 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
tmp
 - 
°¨t
), 
bh
->
b_d©a
);

214 
tmp
 = 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
);

215 i‡(
	`pxt4_block_ö_group
(
sb
, 
tmp
, 
block_group
))

216 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
tmp
 - 
°¨t
), 
bh
->
b_d©a
);

218 
tmp
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

219 ; 
tmp
 < 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
) +

220 
sbi
->
s_ôb_≥r_group
; 
tmp
++) {

221 i‡(
	`pxt4_block_ö_group
(
sb
, 
tmp
, 
block_group
))

222 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
tmp
 - 
°¨t
), 
bh
->
b_d©a
);

230 
	`pxt4_m¨k_bôm≠_íd
(
	`num_˛u°îs_ö_group
(
sb
, 
block_group
),

231 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

233 
	}
}

238 
	$pxt4_‰ì_˛u°îs_a·î_öô
(
su≥r_block
 *
sb
,

239 
pxt4_group_t
 
block_group
,

240 
pxt4_group_desc
 *
gdp
)

242  
	`num_˛u°îs_ö_group
(
sb
, 
block_group
) -

243 
	`pxt4_num_ovîhód_˛u°îs
(
sb
, 
block_group
, 
gdp
);

244 
	}
}

264 
pxt4_group_desc
 * 
	$pxt4_gë_group_desc
(
su≥r_block
 *
sb
,

265 
pxt4_group_t
 
block_group
,

266 
buf„r_hód
 **
bh
)

268 
group_desc
;

269 
off£t
;

270 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

271 
pxt4_group_desc
 *
desc
;

272 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

274 i‡(
block_group
 >
ngroups
) {

275 
	`pxt4_îr‹
(
sb
, "block_group >= groups_count - block_group = %u,"

276 " groups_cou¡ = %u", 
block_group
, 
ngroups
);

278  
NULL
;

281 
group_desc
 = 
block_group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

282 
off£t
 = 
block_group
 & (
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1);

283 i‡(!
sbi
->
s_group_desc
[
group_desc
]) {

284 
	`pxt4_îr‹
(
sb
, "Group descriptorÇotÜoaded - "

286 
block_group
, 
group_desc
, 
off£t
);

287  
NULL
;

290 
desc
 = (
pxt4_group_desc
 *)(

291 (
__u8
 *)
sbi
->
s_group_desc
[
group_desc
]->
b_d©a
 +

292 
off£t
 * 
	`PXT4_DESC_SIZE
(
sb
));

293 i‡(
bh
)

294 *
bh
 = 
sbi
->
s_group_desc
[
group_desc
];

295  
desc
;

296 
	}
}

302 
pxt4_fsblk_t
 
	$pxt4_vÆid_block_bôm≠
(
su≥r_block
 *
sb
,

303 
pxt4_group_desc
 *
desc
,

304 
pxt4_group_t
 
block_group
,

305 
buf„r_hód
 *
bh
)

307 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

308 
pxt4_gΩblk_t
 
off£t
;

309 
pxt4_gΩblk_t
 
√xt_zîo_bô
;

310 
pxt4_gΩblk_t
 
max_bô
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

311 
pxt4_fsblk_t
 
blk
;

312 
pxt4_fsblk_t
 
group_fú°_block
;

314 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
)) {

323 
group_fú°_block
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

326 
blk
 = 
	`pxt4_block_bôm≠
(
sb
, 
desc
);

327 
off£t
 = 
blk
 - 
group_fú°_block
;

328 i‡(
off£t
 < 0 || 
	`PXT4_B2C
(
sbi
, off£tË>
max_bô
 ||

329 !
	`pxt4_ã°_bô
(
	`PXT4_B2C
(
sbi
, 
off£t
), 
bh
->
b_d©a
))

331  
blk
;

334 
blk
 = 
	`pxt4_öode_bôm≠
(
sb
, 
desc
);

335 
off£t
 = 
blk
 - 
group_fú°_block
;

336 i‡(
off£t
 < 0 || 
	`PXT4_B2C
(
sbi
, off£tË>
max_bô
 ||

337 !
	`pxt4_ã°_bô
(
	`PXT4_B2C
(
sbi
, 
off£t
), 
bh
->
b_d©a
))

339  
blk
;

342 
blk
 = 
	`pxt4_öode_èbÀ
(
sb
, 
desc
);

343 
off£t
 = 
blk
 - 
group_fú°_block
;

344 i‡(
off£t
 < 0 || 
	`PXT4_B2C
(
sbi
, off£tË>
max_bô
 ||

345 
	`PXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_ôb_≥r_group
Ë>
max_bô
)

346  
blk
;

347 
√xt_zîo_bô
 = 
	`pxt4_föd_√xt_zîo_bô
(
bh
->
b_d©a
,

348 
	`PXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_ôb_≥r_group
),

349 
	`PXT4_B2C
(
sbi
, 
off£t
));

350 i‡(
√xt_zîo_bô
 <

351 
	`PXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_ôb_≥r_group
))

353  
blk
;

355 
	}
}

357 
	$pxt4_vÆid©e_block_bôm≠
(
su≥r_block
 *
sb
,

358 
pxt4_group_desc
 *
desc
,

359 
pxt4_group_t
 
block_group
,

360 
buf„r_hód
 *
bh
)

362 
pxt4_fsblk_t
 
blk
;

363 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
);

365 i‡(
	`buf„r_vîifõd
(
bh
))

367 i‡(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
gΩ
))

368  -
EFSCORRUPTED
;

370 
	`pxt4_lock_group
(
sb
, 
block_group
);

371 i‡(
	`buf„r_vîifõd
(
bh
))

372 
vîifõd
;

373 i‡(
	`u∆ikñy
(!
	`pxt4_block_bôm≠_csum_vîify
(
sb
, 
block_group
,

374 
desc
, 
bh
))) {

375 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

376 
	`pxt4_îr‹
(
sb
, "bg %u: bad block bôm≠ checksum", 
block_group
);

377 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

378 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

379  -
EFSBADCRC
;

381 
blk
 = 
	`pxt4_vÆid_block_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

382 i‡(
	`u∆ikñy
(
blk
 != 0)) {

383 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

384 
	`pxt4_îr‹
(
sb
, "bg %u: block %llu: invalid block bitmap",

385 
block_group
, 
blk
);

386 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

387 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

388  -
EFSCORRUPTED
;

390 
	`£t_buf„r_vîifõd
(
bh
);

391 
vîifõd
:

392 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

394 
	}
}

406 
buf„r_hód
 *

407 
	$pxt4_ªad_block_bôm≠_nowaô
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
)

409 
pxt4_group_desc
 *
desc
;

410 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

411 
buf„r_hód
 *
bh
;

412 
pxt4_fsblk_t
 
bôm≠_blk
;

413 
îr
;

415 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, 
NULL
);

416 i‡(!
desc
)

417  
	`ERR_PTR
(-
EFSCORRUPTED
);

418 
bôm≠_blk
 = 
	`pxt4_block_bôm≠
(
sb
, 
desc
);

419 i‡((
bôm≠_blk
 <
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
)) ||

420 (
bôm≠_blk
 >
	`pxt4_blocks_cou¡
(
sbi
->
s_es
))) {

421 
	`pxt4_îr‹
(
sb
, "Invalid block bitmap block %llu in "

422 "block_grou∞%u", 
bôm≠_blk
, 
block_group
);

423 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

424 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

425  
	`ERR_PTR
(-
EFSCORRUPTED
);

427 
bh
 = 
	`sb_gëblk
(
sb
, 
bôm≠_blk
);

428 i‡(
	`u∆ikñy
(!
bh
)) {

429 
	`pxt4_w¨nög
(
sb
, "Cannot get buffer for block bitmap - "

431 
block_group
, 
bôm≠_blk
);

432  
	`ERR_PTR
(-
ENOMEM
);

435 i‡(
	`bôm≠_u±od©e
(
bh
))

436 
vîify
;

438 
	`lock_buf„r
(
bh
);

439 i‡(
	`bôm≠_u±od©e
(
bh
)) {

440 
	`u∆ock_buf„r
(
bh
);

441 
vîify
;

443 
	`pxt4_lock_group
(
sb
, 
block_group
);

444 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

445 (
desc
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

446 i‡(
block_group
 == 0) {

447 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

448 
	`u∆ock_buf„r
(
bh
);

449 
	`pxt4_îr‹
(
sb
, "Block bitmap for bg 0 marked "

451 
îr
 = -
EFSCORRUPTED
;

452 
out
;

454 
îr
 = 
	`pxt4_öô_block_bôm≠
(
sb
, 
bh
, 
block_group
, 
desc
);

455 
	`£t_bôm≠_u±od©e
(
bh
);

456 
	`£t_buf„r_u±od©e
(
bh
);

457 
	`£t_buf„r_vîifõd
(
bh
);

458 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

459 
	`u∆ock_buf„r
(
bh
);

460 i‡(
îr
) {

461 
	`pxt4_îr‹
(
sb
, "FailedÅo init block bitmap for group "

462 "%u: %d", 
block_group
, 
îr
);

463 
out
;

465 
vîify
;

467 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

468 i‡(
	`buf„r_u±od©e
(
bh
)) {

473 
	`£t_bôm≠_u±od©e
(
bh
);

474 
	`u∆ock_buf„r
(
bh
);

475 
vîify
;

480 
	`£t_buf„r_√w
(
bh
);

481 
	`åa˚_pxt4_ªad_block_bôm≠_lﬂd
(
sb
, 
block_group
);

482 
bh
->
b_íd_io
 = 
pxt4_íd_bôm≠_ªad
;

483 
	`gë_bh
(
bh
);

484 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

485  
bh
;

486 
vîify
:

487 
îr
 = 
	`pxt4_vÆid©e_block_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

488 i‡(
îr
)

489 
out
;

490  
bh
;

491 
out
:

492 
	`put_bh
(
bh
);

493  
	`ERR_PTR
(
îr
);

494 
	}
}

497 
	$pxt4_waô_block_bôm≠
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
,

498 
buf„r_hód
 *
bh
)

500 
pxt4_group_desc
 *
desc
;

502 i‡(!
	`buf„r_√w
(
bh
))

504 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, 
NULL
);

505 i‡(!
desc
)

506  -
EFSCORRUPTED
;

507 
	`waô_⁄_buf„r
(
bh
);

508 i‡(!
	`buf„r_u±od©e
(
bh
)) {

509 
	`pxt4_îr‹
(
sb
, "CannotÑead block bitmap - "

511 
block_group
, (Ë
bh
->
b_blockƒ
);

512 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

513 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

514  -
EIO
;

516 
	`˛ór_buf„r_√w
(
bh
);

518  
	`pxt4_vÆid©e_block_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

519 
	}
}

521 
buf„r_hód
 *

522 
	$pxt4_ªad_block_bôm≠
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
)

524 
buf„r_hód
 *
bh
;

525 
îr
;

527 
bh
 = 
	`pxt4_ªad_block_bôm≠_nowaô
(
sb
, 
block_group
);

528 i‡(
	`IS_ERR
(
bh
))

529  
bh
;

530 
îr
 = 
	`pxt4_waô_block_bôm≠
(
sb
, 
block_group
, 
bh
);

531 i‡(
îr
) {

532 
	`put_bh
(
bh
);

533  
	`ERR_PTR
(
îr
);

535  
bh
;

536 
	}
}

547 
	$pxt4_has_‰ì_˛u°îs
(
pxt4_sb_öfo
 *
sbi
,

548 
s64
 
n˛u°îs
, 
Êags
)

550 
s64
 
‰ì_˛u°îs
, 
dúty_˛u°îs
, 
rsv
, 
ªsv_˛u°îs
;

551 
≥r˝u_cou¡î
 *
fcc
 = &
sbi
->
s_‰ì˛u°îs_cou¡î
;

552 
≥r˝u_cou¡î
 *
dcc
 = &
sbi
->
s_dúty˛u°îs_cou¡î
;

554 
‰ì_˛u°îs
 = 
	`≥r˝u_cou¡î_ªad_posôive
(
fcc
);

555 
dúty_˛u°îs
 = 
	`≥r˝u_cou¡î_ªad_posôive
(
dcc
);

556 
ªsv_˛u°îs
 = 
	`©omic64_ªad
(&
sbi
->
s_ªsv_˛u°îs
);

562 
rsv
 = (
	`pxt4_r_blocks_cou¡
(
sbi
->
s_es
Ë>> sbi->
s_˛u°î_bôs
) +

563 
ªsv_˛u°îs
;

565 i‡(
‰ì_˛u°îs
 - (
n˛u°îs
 + 
rsv
 + 
dúty_˛u°îs
) <

566 
PXT4_FREECLUSTERS_WATERMARK
) {

567 
‰ì_˛u°îs
 = 
	`≥r˝u_cou¡î_sum_posôive
(
fcc
);

568 
dúty_˛u°îs
 = 
	`≥r˝u_cou¡î_sum_posôive
(
dcc
);

573 i‡(
‰ì_˛u°îs
 >(
rsv
 + 
n˛u°îs
 + 
dúty_˛u°îs
))

577 i‡(
	`uid_eq
(
sbi
->
s_ªsuid
, 
	`cuºít_fsuid
()) ||

578 (!
	`gid_eq
(
sbi
->
s_ªsgid
, 
GLOBAL_ROOT_GID
Ë&& 
	`ö_group_p
(sbi->s_resgid)) ||

579 
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
) ||

580 (
Êags
 & 
PXT4_MB_USE_ROOT_BLOCKS
)) {

582 i‡(
‰ì_˛u°îs
 >(
n˛u°îs
 + 
dúty_˛u°îs
 +

583 
ªsv_˛u°îs
))

587 i‡(
Êags
 & 
PXT4_MB_USE_RESERVED
) {

588 i‡(
‰ì_˛u°îs
 >(
n˛u°îs
 + 
dúty_˛u°îs
))

593 
	}
}

595 
	$pxt4_˛aim_‰ì_˛u°îs
(
pxt4_sb_öfo
 *
sbi
,

596 
s64
 
n˛u°îs
, 
Êags
)

598 i‡(
	`pxt4_has_‰ì_˛u°îs
(
sbi
, 
n˛u°îs
, 
Êags
)) {

599 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 
n˛u°îs
);

602  -
ENOSPC
;

603 
	}
}

615 
	$pxt4_should_ªåy_Æloc
(
su≥r_block
 *
sb
, *
ªåõs
)

617 i‡(!
	`pxt4_has_‰ì_˛u°îs
(
	`PXT4_SB
(
sb
), 1, 0) ||

618 (*
ªåõs
)++ > 1 ||

619 !
	`PXT4_SB
(
sb
)->
s_jou∫Æ
)

622 
	`smp_mb
();

623 i‡(
	`PXT4_SB
(
sb
)->
s_mb_‰ì_≥ndög
 == 0)

626 
	`jbd_debug
(1, "%s:Ñëryög o≥øti⁄á·î ENOSPC\n", 
sb
->
s_id
);

627 
	`jbd3_jou∫Æ_f‹˚_commô_√°ed
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

629 
	}
}

643 
pxt4_fsblk_t
 
	$pxt4_√w_mëa_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

644 
pxt4_fsblk_t
 
gﬂl
, 
Êags
,

645 *
cou¡
, *
îΩ
)

647 
pxt4_Æloˇti⁄_ªque°
 
¨
;

648 
pxt4_fsblk_t
 
ªt
;

650 
	`mem£t
(&
¨
, 0, (ar));

652 
¨
.
öode
 = inode;

653 
¨
.
gﬂl
 = goal;

654 
¨
.
Àn
 = 
cou¡
 ? *count : 1;

655 
¨
.
Êags
 = flags;

657 
ªt
 = 
	`pxt4_mb_√w_blocks
(
h™dÀ
, &
¨
, 
îΩ
);

658 i‡(
cou¡
)

659 *
cou¡
 = 
¨
.
Àn
;

664 i‡(!(*
îΩ
Ë&& (
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
)) {

665 
	`dquŸ_Æloc_block_noÁû
(
öode
,

666 
	`PXT4_C2B
(
	`PXT4_SB
(
öode
->
i_sb
), 
¨
.
Àn
));

668  
ªt
;

669 
	}
}

677 
pxt4_fsblk_t
 
	$pxt4_cou¡_‰ì_˛u°îs
(
su≥r_block
 *
sb
)

679 
pxt4_fsblk_t
 
desc_cou¡
;

680 
pxt4_group_desc
 *
gdp
;

681 
pxt4_group_t
 
i
;

682 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

683 
pxt4_group_öfo
 *
gΩ
;

684 #ifde‡
PXT4FS_DEBUG


685 
pxt4_su≥r_block
 *
es
;

686 
pxt4_fsblk_t
 
bôm≠_cou¡
;

687 
x
;

688 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

690 
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

691 
desc_cou¡
 = 0;

692 
bôm≠_cou¡
 = 0;

693 
gdp
 = 
NULL
;

695 
i
 = 0; i < 
ngroups
; i++) {

696 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

697 i‡(!
gdp
)

699 
gΩ
 = 
NULL
;

700 i‡(
	`PXT4_SB
(
sb
)->
s_group_öfo
)

701 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

702 i‡(!
gΩ
 || !
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(grp))

703 
desc_cou¡
 +
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
);

704 
	`bªl£
(
bôm≠_bh
);

705 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
i
);

706 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

707 
bôm≠_bh
 = 
NULL
;

711 
x
 = 
	`pxt4_cou¡_‰ì
(
bôm≠_bh
->
b_d©a
,

712 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8);

713 
	`¥ötk
(
KERN_DEBUG
 "group %u: stored = %d, counted = %u\n",

714 
i
, 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
), 
x
);

715 
bôm≠_cou¡
 +
x
;

717 
	`bªl£
(
bôm≠_bh
);

718 
	`¥ötk
(
KERN_DEBUG
 "pxt4_count_free_clusters: stored = %llu"

720 
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
), 
	`pxt4_‰ì_blocks_cou¡
(
es
)),

721 
desc_cou¡
, 
bôm≠_cou¡
);

722  
bôm≠_cou¡
;

724 
desc_cou¡
 = 0;

725 
i
 = 0; i < 
ngroups
; i++) {

726 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

727 i‡(!
gdp
)

729 
gΩ
 = 
NULL
;

730 i‡(
	`PXT4_SB
(
sb
)->
s_group_öfo
)

731 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

732 i‡(!
gΩ
 || !
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(grp))

733 
desc_cou¡
 +
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
);

736  
desc_cou¡
;

738 
	}
}

740 
ölöe
 
	$ã°_roŸ
(
pxt4_group_t
 
a
, 
b
)

743 i‡(
a
 < 
b
)

745 i‡(
a
 =
b
)

747 i‡((
a
 % 
b
) != 0)

749 
a
 =á / 
b
;

751 
	}
}

761 
	$pxt4_bg_has_su≥r
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
)

763 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

765 i‡(
group
 == 0)

767 i‡(
	`pxt4_has_„©uª_•¨£_su≥r2
(
sb
)) {

768 i‡(
group
 =
	`À32_to_˝u
(
es
->
s_backup_bgs
[0]) ||

769 
group
 =
	`À32_to_˝u
(
es
->
s_backup_bgs
[1]))

773 i‡((
group
 <1Ë|| !
	`pxt4_has_„©uª_•¨£_su≥r
(
sb
))

775 i‡(!(
group
 & 1))

777 i‡(
	`ã°_roŸ
(
group
, 3) || (test_root(group, 5)) ||

778 
	`ã°_roŸ
(
group
, 7))

782 
	}
}

784 
	$pxt4_bg_num_gdb_mëa
(
su≥r_block
 *
sb
,

785 
pxt4_group_t
 
group
)

787 
mëagroup
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

788 
pxt4_group_t
 
fú°
 = 
mëagroup
 * 
	`PXT4_DESC_PER_BLOCK
(
sb
);

789 
pxt4_group_t
 
œ°
 = 
fú°
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1;

791 i‡(
group
 =
fú°
 || grou∞=fú° + 1 || grou∞=
œ°
)

794 
	}
}

796 
	$pxt4_bg_num_gdb_nomëa
(
su≥r_block
 *
sb
,

797 
pxt4_group_t
 
group
)

799 i‡(!
	`pxt4_bg_has_su≥r
(
sb
, 
group
))

802 i‡(
	`pxt4_has_„©uª_mëa_bg
(
sb
))

803  
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_mëa_bg
);

805  
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
;

806 
	}
}

817 
	$pxt4_bg_num_gdb
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
)

819 
fú°_mëa_bg
 =

820 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_mëa_bg
);

821 
mëagroup
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

823 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
Ë|| 
mëagroup
 < 
fú°_mëa_bg
)

824  
	`pxt4_bg_num_gdb_nomëa
(
sb
, 
group
);

826  
	`pxt4_bg_num_gdb_mëa
(
sb
,
group
);

828 
	}
}

834 
	$pxt4_num_ba£_mëa_˛u°îs
(
su≥r_block
 *
sb
,

835 
pxt4_group_t
 
block_group
)

837 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

838 
num
;

841 
num
 = 
	`pxt4_bg_has_su≥r
(
sb
, 
block_group
);

843 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
) ||

844 
block_group
 < 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_mëa_bg
) *

845 
sbi
->
s_desc_≥r_block
) {

846 i‡(
num
) {

847 
num
 +
	`pxt4_bg_num_gdb
(
sb
, 
block_group
);

848 
num
 +
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
);

851 
num
 +
	`pxt4_bg_num_gdb
(
sb
, 
block_group
);

853  
	`PXT4_NUM_B2C
(
sbi
, 
num
);

854 
	}
}

862 
pxt4_fsblk_t
 
	$pxt4_öode_to_gﬂl_block
(
öode
 *inode)

864 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

865 
pxt4_group_t
 
block_group
;

866 
pxt4_gΩblk_t
 
cﬁour
;

867 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
	`PXT4_SB
(
öode
->
i_sb
));

868 
pxt4_fsblk_t
 
bg_°¨t
;

869 
pxt4_fsblk_t
 
œ°_block
;

871 
block_group
 = 
ei
->
i_block_group
;

872 i‡(
Êex_size
 >
PXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
) {

881 
block_group
 &~(
Êex_size
-1);

882 i‡(
	`S_ISREG
(
öode
->
i_mode
))

883 
block_group
++;

885 
bg_°¨t
 = 
	`pxt4_group_fú°_block_no
(
öode
->
i_sb
, 
block_group
);

886 
œ°_block
 = 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
) - 1;

892 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

893  
bg_°¨t
;

895 i‡(
bg_°¨t
 + 
	`PXT4_BLOCKS_PER_GROUP
(
öode
->
i_sb
Ë<
œ°_block
)

896 
cﬁour
 = (
cuºít
->
pid
 % 16) *

897 (
	`PXT4_BLOCKS_PER_GROUP
(
öode
->
i_sb
) / 16);

899 
cﬁour
 = (
cuºít
->
pid
 % 16Ë* ((
œ°_block
 - 
bg_°¨t
) / 16);

900  
bg_°¨t
 + 
cﬁour
;

901 
	}
}

	@bitmap.c

11 
	~<löux/buf„r_hód.h
>

12 
	~"pxt4.h
"

14 
	$pxt4_cou¡_‰ì
(*
bôm≠
, 
numch¨s
)

16  
numch¨s
 * 
BITS_PER_BYTE
 - 
	`memweight
(
bôm≠
,Çumchars);

17 
	}
}

19 
	$pxt4_öode_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

20 
pxt4_group_desc
 *
gdp
,

21 
buf„r_hód
 *
bh
, 
sz
)

23 
__u32
 
hi
;

24 
__u32
 
¥ovided
, 
ˇlcuœãd
;

25 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

27 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

30 
¥ovided
 = 
	`À16_to_˝u
(
gdp
->
bg_öode_bôm≠_csum_lo
);

31 
ˇlcuœãd
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

32 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_INODE_BITMAP_CSUM_HI_END
) {

33 
hi
 = 
	`À16_to_˝u
(
gdp
->
bg_öode_bôm≠_csum_hi
);

34 
¥ovided
 |(
hi
 << 16);

36 
ˇlcuœãd
 &= 0xFFFF;

38  
¥ovided
 =
ˇlcuœãd
;

39 
	}
}

41 
	$pxt4_öode_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

42 
pxt4_group_desc
 *
gdp
,

43 
buf„r_hód
 *
bh
, 
sz
)

45 
__u32
 
csum
;

46 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

48 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

51 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

52 
gdp
->
bg_öode_bôm≠_csum_lo
 = 
	`˝u_to_À16
(
csum
 & 0xFFFF);

53 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_INODE_BITMAP_CSUM_HI_END
)

54 
gdp
->
bg_öode_bôm≠_csum_hi
 = 
	`˝u_to_À16
(
csum
 >> 16);

55 
	}
}

57 
	$pxt4_block_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

58 
pxt4_group_desc
 *
gdp
,

59 
buf„r_hód
 *
bh
)

61 
__u32
 
hi
;

62 
__u32
 
¥ovided
, 
ˇlcuœãd
;

63 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

64 
sz
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8;

66 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

69 
¥ovided
 = 
	`À16_to_˝u
(
gdp
->
bg_block_bôm≠_csum_lo
);

70 
ˇlcuœãd
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

71 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_BLOCK_BITMAP_CSUM_HI_END
) {

72 
hi
 = 
	`À16_to_˝u
(
gdp
->
bg_block_bôm≠_csum_hi
);

73 
¥ovided
 |(
hi
 << 16);

75 
ˇlcuœãd
 &= 0xFFFF;

77 i‡(
¥ovided
 =
ˇlcuœãd
)

81 
	}
}

83 
	$pxt4_block_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

84 
pxt4_group_desc
 *
gdp
,

85 
buf„r_hód
 *
bh
)

87 
sz
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8;

88 
__u32
 
csum
;

89 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

91 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

94 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

95 
gdp
->
bg_block_bôm≠_csum_lo
 = 
	`˝u_to_À16
(
csum
 & 0xFFFF);

96 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_BLOCK_BITMAP_CSUM_HI_END
)

97 
gdp
->
bg_block_bôm≠_csum_hi
 = 
	`˝u_to_À16
(
csum
 >> 16);

98 
	}
}

	@block_validity.c

12 
	~<löux/time.h
>

13 
	~<löux/fs.h
>

14 
	~<löux/«mei.h
>

15 
	~<löux/quŸa›s.h
>

16 
	~<löux/buf„r_hód.h
>

17 
	~<löux/sw≠.h
>

18 
	~<löux/∑gem≠.h
>

19 
	~<löux/blkdev.h
>

20 
	~<löux/¶ab.h
>

21 
	~"pxt4.h
"

23 
	spxt4_sy°em_z⁄e
 {

24 
rb_node
 
	mnode
;

25 
pxt4_fsblk_t
 
	m°¨t_blk
;

26 
	mcou¡
;

29 
kmem_ˇche
 *
	gpxt4_sy°em_z⁄e_ˇchï
;

31 
__öô
 
	$pxt4_öô_sy°em_z⁄e
()

33 
pxt4_sy°em_z⁄e_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_sy°em_z⁄e
, 0);

34 i‡(
pxt4_sy°em_z⁄e_ˇchï
 =
NULL
)

35  -
ENOMEM
;

37 
	}
}

39 
	$pxt4_exô_sy°em_z⁄e
()

41 
	`rcu_b¨rõr
();

42 
	`kmem_ˇche_de°roy
(
pxt4_sy°em_z⁄e_ˇchï
);

43 
	}
}

45 
ölöe
 
	$ˇn_mîge
(
pxt4_sy°em_z⁄e
 *
íåy1
,

46 
pxt4_sy°em_z⁄e
 *
íåy2
)

48 i‡((
íåy1
->
°¨t_blk
 +É¡ry1->
cou¡
Ë=
íåy2
->start_blk)

51 
	}
}

53 
	$ªÀa£_sy°em_z⁄e
(
pxt4_sy°em_blocks
 *
sy°em_blks
)

55 
pxt4_sy°em_z⁄e
 *
íåy
, *
n
;

57 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
íåy
, 
n
,

58 &
sy°em_blks
->
roŸ
, 
node
)

59 
	`kmem_ˇche_‰ì
(
pxt4_sy°em_z⁄e_ˇchï
, 
íåy
);

60 
	}
}

67 
	$add_sy°em_z⁄e
(
pxt4_sy°em_blocks
 *
sy°em_blks
,

68 
pxt4_fsblk_t
 
°¨t_blk
,

69 
cou¡
)

71 
pxt4_sy°em_z⁄e
 *
√w_íåy
 = 
NULL
, *
íåy
;

72 
rb_node
 **
n
 = &
sy°em_blks
->
roŸ
.rb_node, *
node
;

73 
rb_node
 *
∑ª¡
 = 
NULL
, *
√w_node
 = NULL;

75 *
n
) {

76 
∑ª¡
 = *
n
;

77 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
pxt4_sy°em_z⁄e
, 
node
);

78 i‡(
°¨t_blk
 < 
íåy
->start_blk)

79 
n
 = &(*n)->
rb_À·
;

80 i‡(
°¨t_blk
 >(
íåy
->°¨t_blk +É¡ry->
cou¡
))

81 
n
 = &(*n)->
rb_right
;

83 i‡(
°¨t_blk
 + 
cou¡
 > (
íåy
->start_blk +

84 
íåy
->
cou¡
))

85 
íåy
->
cou¡
 = (
°¨t_blk
 + count -

86 
íåy
->
°¨t_blk
);

87 
√w_node
 = *
n
;

88 
√w_íåy
 = 
	`rb_íåy
(
√w_node
, 
pxt4_sy°em_z⁄e
,

89 
node
);

94 i‡(!
√w_íåy
) {

95 
√w_íåy
 = 
	`kmem_ˇche_Æloc
(
pxt4_sy°em_z⁄e_ˇchï
,

96 
GFP_KERNEL
);

97 i‡(!
√w_íåy
)

98  -
ENOMEM
;

99 
√w_íåy
->
°¨t_blk
 = start_blk;

100 
√w_íåy
->
cou¡
 = count;

101 
√w_node
 = &
√w_íåy
->
node
;

103 
	`rb_lök_node
(
√w_node
, 
∑ª¡
, 
n
);

104 
	`rb_ö£π_cﬁ‹
(
√w_node
, &
sy°em_blks
->
roŸ
);

108 
node
 = 
	`rb_¥ev
(
√w_node
);

109 i‡(
node
) {

110 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_sy°em_z⁄e
,Çode);

111 i‡(
	`ˇn_mîge
(
íåy
, 
√w_íåy
)) {

112 
√w_íåy
->
°¨t_blk
 = 
íåy
->start_blk;

113 
√w_íåy
->
cou¡
 +
íåy
->count;

114 
	`rb_îa£
(
node
, &
sy°em_blks
->
roŸ
);

115 
	`kmem_ˇche_‰ì
(
pxt4_sy°em_z⁄e_ˇchï
, 
íåy
);

120 
node
 = 
	`rb_√xt
(
√w_node
);

121 i‡(
node
) {

122 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_sy°em_z⁄e
,Çode);

123 i‡(
	`ˇn_mîge
(
√w_íåy
, 
íåy
)) {

124 
√w_íåy
->
cou¡
 +
íåy
->count;

125 
	`rb_îa£
(
node
, &
sy°em_blks
->
roŸ
);

126 
	`kmem_ˇche_‰ì
(
pxt4_sy°em_z⁄e_ˇchï
, 
íåy
);

130 
	}
}

132 
	$debug_¥öt_åì
(
pxt4_sb_öfo
 *
sbi
)

134 
rb_node
 *
node
;

135 
pxt4_sy°em_z⁄e
 *
íåy
;

136 
fú°
 = 1;

138 
	`¥ötk
(
KERN_INFO
 "System zones: ");

139 
node
 = 
	`rb_fú°
(&
sbi
->
sy°em_blks
->
roŸ
);

140 
node
) {

141 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_sy°em_z⁄e
,Çode);

142 
	`¥ötk
(
KERN_CONT
 "%s%Œu-%Œu", 
fú°
 ? "" : ", ",

143 
íåy
->
°¨t_blk
,É¡ry->°¨t_blk +É¡ry->
cou¡
 - 1);

144 
fú°
 = 0;

145 
node
 = 
	`rb_√xt
(node);

147 
	`¥ötk
(
KERN_CONT
 "\n");

148 
	}
}

155 
	$pxt4_d©a_block_vÆid_rcu
(
pxt4_sb_öfo
 *
sbi
,

156 
pxt4_sy°em_blocks
 *
sy°em_blks
,

157 
pxt4_fsblk_t
 
°¨t_blk
,

158 
cou¡
)

160 
pxt4_sy°em_z⁄e
 *
íåy
;

161 
rb_node
 *
n
;

163 i‡((
°¨t_blk
 <
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
)) ||

164 (
°¨t_blk
 + 
cou¡
 < start_blk) ||

165 (
°¨t_blk
 + 
cou¡
 > 
	`pxt4_blocks_cou¡
(
sbi
->
s_es
))) {

166 
sbi
->
s_es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
°¨t_blk
);

170 i‡(
sy°em_blks
 =
NULL
)

173 
n
 = 
sy°em_blks
->
roŸ
.
rb_node
;

174 
n
) {

175 
íåy
 = 
	`rb_íåy
(
n
, 
pxt4_sy°em_z⁄e
, 
node
);

176 i‡(
°¨t_blk
 + 
cou¡
 - 1 < 
íåy
->start_blk)

177 
n
 =Ç->
rb_À·
;

178 i‡(
°¨t_blk
 >(
íåy
->°¨t_blk +É¡ry->
cou¡
))

179 
n
 =Ç->
rb_right
;

181 
sbi
->
s_es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
°¨t_blk
);

186 
	}
}

188 
	$pxt4_¥Ÿe˘_ª£rved_öode
(
su≥r_block
 *
sb
,

189 
pxt4_sy°em_blocks
 *
sy°em_blks
,

190 
u32
 
öo
)

192 
öode
 *inode;

193 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

194 
pxt4_m≠_blocks
 
m≠
;

195 
u32
 
i
 = 0, 
num
;

196 
îr
 = 0, 
n
;

198 i‡((
öo
 < 
PXT4_ROOT_INO
) ||

199 (
öo
 > 
	`À32_to_˝u
(
sbi
->
s_es
->
s_öodes_cou¡
)))

200  -
EINVAL
;

201 
öode
 = 
	`pxt4_igë
(
sb
, 
öo
, 
PXT4_IGET_SPECIAL
);

202 i‡(
	`IS_ERR
(
öode
))

203  
	`PTR_ERR
(
öode
);

204 
num
 = (
öode
->
i_size
 + 
sb
->
s_blocksize
 - 1Ë>> sb->
s_blocksize_bôs
;

205 
i
 < 
num
) {

206 
m≠
.
m_lblk
 = 
i
;

207 
m≠
.
m_Àn
 = 
num
 - 
i
;

208 
n
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

209 i‡(
n
 < 0) {

210 
îr
 = 
n
;

213 i‡(
n
 == 0) {

214 
i
++;

216 i‡(!
	`pxt4_d©a_block_vÆid_rcu
(
sbi
, 
sy°em_blks
,

217 
m≠
.
m_pblk
, 
n
)) {

218 
	`pxt4_îr‹
(
sb
, "blocks %llu-%llu from inode %u "

219 "ovîœ∞sy°em z⁄e", 
m≠
.
m_pblk
,

220 
m≠
.
m_pblk
 + m≠.
m_Àn
 - 1, 
öo
);

221 
îr
 = -
EFSCORRUPTED
;

224 
îr
 = 
	`add_sy°em_z⁄e
(
sy°em_blks
, 
m≠
.
m_pblk
, 
n
);

225 i‡(
îr
 < 0)

227 
i
 +
n
;

230 
	`ùut
(
öode
);

231  
îr
;

232 
	}
}

234 
	$pxt4_de°roy_sy°em_z⁄e
(
rcu_hód
 *
rcu
)

236 
pxt4_sy°em_blocks
 *
sy°em_blks
;

238 
sy°em_blks
 = 
	`c⁄èöî_of
(
rcu
, 
pxt4_sy°em_blocks
,Ñcu);

239 
	`ªÀa£_sy°em_z⁄e
(
sy°em_blks
);

240 
	`k‰ì
(
sy°em_blks
);

241 
	}
}

252 
	$pxt4_£tup_sy°em_z⁄e
(
su≥r_block
 *
sb
)

254 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

255 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

256 
pxt4_sy°em_blocks
 *
sy°em_blks
;

257 
pxt4_group_desc
 *
gdp
;

258 
pxt4_group_t
 
i
;

259 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
sbi
);

260 
ªt
;

262 i‡(!
	`ã°_›t
(
sb
, 
BLOCK_VALIDITY
)) {

263 i‡(
sbi
->
sy°em_blks
)

264 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

267 i‡(
sbi
->
sy°em_blks
)

270 
sy°em_blks
 = 
	`kzÆloc
((*sy°em_blks), 
GFP_KERNEL
);

271 i‡(!
sy°em_blks
)

272  -
ENOMEM
;

274 
i
=0; i < 
ngroups
; i++) {

275 
	`c⁄d_ªsched
();

276 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
i
) &&

277 ((
i
 < 5Ë|| ((ò% 
Êex_size
) == 0)))

278 
	`add_sy°em_z⁄e
(
sy°em_blks
,

279 
	`pxt4_group_fú°_block_no
(
sb
, 
i
),

280 
	`pxt4_bg_num_gdb
(
sb
, 
i
) + 1);

281 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

282 
ªt
 = 
	`add_sy°em_z⁄e
(
sy°em_blks
,

283 
	`pxt4_block_bôm≠
(
sb
, 
gdp
), 1);

284 i‡(
ªt
)

285 
îr
;

286 
ªt
 = 
	`add_sy°em_z⁄e
(
sy°em_blks
,

287 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
), 1);

288 i‡(
ªt
)

289 
îr
;

290 
ªt
 = 
	`add_sy°em_z⁄e
(
sy°em_blks
,

291 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

292 
sbi
->
s_ôb_≥r_group
);

293 i‡(
ªt
)

294 
îr
;

296 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
sb
Ë&& 
sbi
->
s_es
->
s_jou∫Æ_öum
) {

297 
ªt
 = 
	`pxt4_¥Ÿe˘_ª£rved_öode
(
sb
, 
sy°em_blks
,

298 
	`À32_to_˝u
(
sbi
->
s_es
->
s_jou∫Æ_öum
));

299 i‡(
ªt
)

300 
îr
;

308 
	`rcu_assign_poöãr
(
sbi
->
sy°em_blks
, system_blks);

310 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

311 
	`debug_¥öt_åì
(
sbi
);

313 
îr
:

314 
	`ªÀa£_sy°em_z⁄e
(
sy°em_blks
);

315 
	`k‰ì
(
sy°em_blks
);

316  
ªt
;

317 
	}
}

329 
	$pxt4_ªÀa£_sy°em_z⁄e
(
su≥r_block
 *
sb
)

331 
pxt4_sy°em_blocks
 *
sy°em_blks
;

333 
sy°em_blks
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
	`PXT4_SB
(
sb
)->system_blks,

334 
	`lockdï_is_hñd
(&
sb
->
s_umou¡
));

335 
	`rcu_assign_poöãr
(
	`PXT4_SB
(
sb
)->
sy°em_blks
, 
NULL
);

337 i‡(
sy°em_blks
)

338 
	`ˇŒ_rcu
(&
sy°em_blks
->
rcu
, 
pxt4_de°roy_sy°em_z⁄e
);

339 
	}
}

341 
	$pxt4_d©a_block_vÆid
(
pxt4_sb_öfo
 *
sbi
, 
pxt4_fsblk_t
 
°¨t_blk
,

342 
cou¡
)

344 
pxt4_sy°em_blocks
 *
sy°em_blks
;

345 
ªt
;

352 
	`rcu_ªad_lock
();

353 
sy°em_blks
 = 
	`rcu_dîe„ªn˚
(
sbi
->system_blks);

354 
ªt
 = 
	`pxt4_d©a_block_vÆid_rcu
(
sbi
, 
sy°em_blks
, 
°¨t_blk
,

355 
cou¡
);

356 
	`rcu_ªad_u∆ock
();

357  
ªt
;

358 
	}
}

360 
	$pxt4_check_blockªf
(c⁄° *
fun˘i⁄
, 
löe
,

361 
öode
 *öode, 
__À32
 *
p
, 
max
)

363 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

364 
__À32
 *
bªf
 = 
p
;

365 
blk
;

367 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
öode
->
i_sb
) &&

368 (
öode
->
i_öo
 ==

369 
	`À32_to_˝u
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_jou∫Æ_öum
)))

372 
bªf
 < 
p
+
max
) {

373 
blk
 = 
	`À32_to_˝u
(*
bªf
++);

374 i‡(
blk
 &&

375 
	`u∆ikñy
(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
),

376 
blk
, 1))) {

377 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
blk
);

378 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 
blk
,

380  -
EFSCORRUPTED
;

384 
	}
}

	@dir.c

25 
	~<löux/fs.h
>

26 
	~<löux/buf„r_hód.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/ivîsi⁄.h
>

29 
	~<löux/unicode.h
>

30 
	~"pxt4.h
"

31 
	~"x©å.h
"

33 
pxt4_dx_ªaddú
(
fûe
 *, 
dú_c⁄ãxt
 *);

45 
	$is_dx_dú
(
öode
 *inode)

47 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

49 i‡(
	`pxt4_has_„©uª_dú_ödex
(
öode
->
i_sb
) &&

50 ((
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
)) ||

51 ((
öode
->
i_size
 >> 
sb
->
s_blocksize_bôs
) == 1) ||

52 
	`pxt4_has_ölöe_d©a
(
öode
)))

56 
	}
}

66 
	$__pxt4_check_dú_íåy
(c⁄° *
fun˘i⁄
, 
löe
,

67 
öode
 *
dú
, 
fûe
 *
fûp
,

68 
pxt4_dú_íåy_2
 *
de
,

69 
buf„r_hód
 *
bh
, *
buf
, 
size
,

70 
off£t
)

72 c⁄° *
îr‹_msg
 = 
NULL
;

73 c⁄° 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

74 
dú
->
i_sb
->
s_blocksize
);

76 i‡(
	`u∆ikñy
(
æí
 < 
	`PXT4_DIR_REC_LEN
(1)))

77 
îr‹_msg
 = "rec_len is smallerÅhan minimal";

78 i‡(
	`u∆ikñy
(
æí
 % 4 != 0))

79 
îr‹_msg
 = "rec_len % 4 != 0";

80 i‡(
	`u∆ikñy
(
æí
 < 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
)))

81 
îr‹_msg
 = "rec_len isÅoo small forÇame_len";

82 i‡(
	`u∆ikñy
(((*Ë
de
 - 
buf
Ë+ 
æí
 > 
size
))

83 
îr‹_msg
 = "directoryÉntry overrun";

84 i‡(
	`u∆ikñy
(
	`À32_to_˝u
(
de
->
öode
) >

85 
	`À32_to_˝u
(
	`PXT4_SB
(
dú
->
i_sb
)->
s_es
->
s_öodes_cou¡
)))

86 
îr‹_msg
 = "inode out of bounds";

90 i‡(
fûp
)

91 
	`pxt4_îr‹_fûe
(
fûp
, 
fun˘i⁄
, 
löe
, 
bh
->
b_blockƒ
,

94 
îr‹_msg
, 
off£t
, 
	`À32_to_˝u
(
de
->
öode
),

95 
æí
, 
de
->
«me_Àn
, 
size
);

97 
	`pxt4_îr‹_öode
(
dú
, 
fun˘i⁄
, 
löe
, 
bh
->
b_blockƒ
,

100 
îr‹_msg
, 
off£t
, 
	`À32_to_˝u
(
de
->
öode
),

101 
æí
, 
de
->
«me_Àn
, 
size
);

104 
	}
}

106 
	$pxt4_ªaddú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
)

108 
off£t
;

109 
i
;

110 
pxt4_dú_íåy_2
 *
de
;

111 
îr
;

112 
öode
 *öodê
	`fûe_öode
(
fûe
);

113 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

114 
buf„r_hód
 *
bh
 = 
NULL
;

115 
fs¸y±_°r
 
f°r
 = 
	`FSTR_INIT
(
NULL
, 0);

117 i‡(
	`IS_ENCRYPTED
(
öode
)) {

118 
îr
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
öode
);

119 i‡(
îr
 &&Éº !-
ENOKEY
)

120  
îr
;

123 i‡(
	`is_dx_dú
(
öode
)) {

124 
îr
 = 
	`pxt4_dx_ªaddú
(
fûe
, 
˘x
);

125 i‡(
îr
 !
ERR_BAD_DX_DIR
) {

126  
îr
;

132 
	`pxt4_˛ór_öode_Êag
(
	`fûe_öode
(
fûe
),

133 
PXT4_INODE_INDEX
);

136 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

137 
has_ölöe_d©a
 = 1;

138 
îr
 = 
	`pxt4_ªad_ölöe_dú
(
fûe
, 
˘x
,

139 &
has_ölöe_d©a
);

140 i‡(
has_ölöe_d©a
)

141  
îr
;

144 i‡(
	`IS_ENCRYPTED
(
öode
)) {

145 
îr
 = 
	`fs¸y±_‚ame_Æloc_buf„r
(
öode
, 
PXT4_NAME_LEN
, &
f°r
);

146 i‡(
îr
 < 0)

147  
îr
;

150 
˘x
->
pos
 < 
öode
->
i_size
) {

151 
pxt4_m≠_blocks
 
m≠
;

153 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

154 
îr
 = -
ERESTARTSYS
;

155 
îrout
;

157 
	`c⁄d_ªsched
();

158 
off£t
 = 
˘x
->
pos
 & (
sb
->
s_blocksize
 - 1);

159 
m≠
.
m_lblk
 = 
˘x
->
pos
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

160 
m≠
.
m_Àn
 = 1;

161 
îr
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

162 i‡(
îr
 == 0) {

165 i‡(
m≠
.
m_Àn
 == 0)

166 
m≠
.
m_Àn
 = 1;

167 
˘x
->
pos
 +
m≠
.
m_Àn
 * 
sb
->
s_blocksize
;

170 i‡(
îr
 > 0) {

171 
pgoff_t
 
ödex
 = 
m≠
.
m_pblk
 >>

172 (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

173 i‡(!
	`ø_has_ödex
(&
fûe
->
f_ø
, 
ödex
))

174 
	`∑ge_ˇche_sync_ªadahód
(

175 
sb
->
s_bdev
->
bd_öode
->
i_m≠pög
,

176 &
fûe
->
f_ø
, file,

177 
ödex
, 1);

178 
fûe
->
f_ø
.
¥ev_pos
 = (
loff_t
)
ödex
 << 
PAGE_SHIFT
;

179 
bh
 = 
	`pxt4_bªad
(
NULL
, 
öode
, 
m≠
.
m_lblk
, 0);

180 i‡(
	`IS_ERR
(
bh
)) {

181 
îr
 = 
	`PTR_ERR
(
bh
);

182 
bh
 = 
NULL
;

183 
îrout
;

187 i‡(!
bh
) {

189 i‡(
˘x
->
pos
 > 
öode
->
i_blocks
 << 9)

191 
˘x
->
pos
 +
sb
->
s_blocksize
 - 
off£t
;

196 i‡(!
	`buf„r_vîifõd
(
bh
) &&

197 !
	`pxt4_dúblock_csum_vîify
(
öode
, 
bh
)) {

198 
	`PXT4_ERROR_FILE
(
fûe
, 0, "directory fails checksum "

200 ()
˘x
->
pos
);

201 
˘x
->
pos
 +
sb
->
s_blocksize
 - 
off£t
;

202 
	`bªl£
(
bh
);

203 
bh
 = 
NULL
;

206 
	`£t_buf„r_vîifõd
(
bh
);

212 i‡(!
	`öode_eq_ivîsi⁄
(
öode
, 
fûe
->
f_vîsi⁄
)) {

213 
i
 = 0; i < 
sb
->
s_blocksize
 && i < 
off£t
; ) {

214 
de
 = (
pxt4_dú_íåy_2
 *)

215 (
bh
->
b_d©a
 + 
i
);

222 i‡(
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

223 
sb
->
s_blocksize
Ë< 
	`PXT4_DIR_REC_LEN
(1))

225 
i
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

226 
sb
->
s_blocksize
);

228 
off£t
 = 
i
;

229 
˘x
->
pos
 = (˘x->po†& ~(
sb
->
s_blocksize
 - 1))

230 | 
off£t
;

231 
fûe
->
f_vîsi⁄
 = 
	`öode_quîy_ivîsi⁄
(
öode
);

234 
˘x
->
pos
 < 
öode
->
i_size


235 && 
off£t
 < 
sb
->
s_blocksize
) {

236 
de
 = (
pxt4_dú_íåy_2
 *Ë(
bh
->
b_d©a
 + 
off£t
);

237 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
fûe
, 
de
, 
bh
,

238 
bh
->
b_d©a
, bh->
b_size
,

239 
off£t
)) {

243 
˘x
->
pos
 = (ctx->pos |

244 (
sb
->
s_blocksize
 - 1)) + 1;

247 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

248 
sb
->
s_blocksize
);

249 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

250 i‡(!
	`IS_ENCRYPTED
(
öode
)) {

251 i‡(!
	`dú_emô
(
˘x
, 
de
->
«me
,

252 
de
->
«me_Àn
,

253 
	`À32_to_˝u
(
de
->
öode
),

254 
	`gë_dty≥
(
sb
, 
de
->
fûe_ty≥
)))

255 
d⁄e
;

257 
ßve_Àn
 = 
f°r
.
Àn
;

258 
fs¸y±_°r
 
de_«me
 =

259 
	`FSTR_INIT
(
de
->
«me
,

260 
de
->
«me_Àn
);

263 
îr
 = 
	`fs¸y±_‚ame_disk_to_u§
(
öode
,

264 0, 0, &
de_«me
, &
f°r
);

265 
de_«me
 = 
f°r
;

266 
f°r
.
Àn
 = 
ßve_Àn
;

267 i‡(
îr
)

268 
îrout
;

269 i‡(!
	`dú_emô
(
˘x
,

270 
de_«me
.
«me
, de_«me.
Àn
,

271 
	`À32_to_˝u
(
de
->
öode
),

272 
	`gë_dty≥
(
sb
, 
de
->
fûe_ty≥
)))

273 
d⁄e
;

276 
˘x
->
pos
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

277 
sb
->
s_blocksize
);

279 i‡((
˘x
->
pos
 < 
öode
->
i_size
Ë&& !
	`dú_ªœx_sh¨ed
(inode))

280 
d⁄e
;

281 
	`bªl£
(
bh
);

282 
bh
 = 
NULL
;

283 
off£t
 = 0;

285 
d⁄e
:

286 
îr
 = 0;

287 
îrout
:

288 
	`fs¸y±_‚ame_‰ì_buf„r
(&
f°r
);

289 
	`bªl£
(
bh
);

290  
îr
;

291 
	}
}

293 
ölöe
 
	$is_32bô_≠i
()

295 #ifde‡
CONFIG_COMPAT


296  
	`ö_com∑t_sysˇŒ
();

298  (
BITS_PER_LONG
 == 32);

300 
	}
}

311 
ölöe
 
loff_t
 
	$hash2pos
(
fûe
 *
fûp
, 
__u32
 
maj‹
, __u32 
mö‹
)

313 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

314 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

315  
maj‹
 >> 1;

317  ((
__u64
)(
maj‹
 >> 1Ë<< 32Ë| (__u64)
mö‹
;

318 
	}
}

320 
ölöe
 
__u32
 
	$pos2maj_hash
(
fûe
 *
fûp
, 
loff_t
 
pos
)

322 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

323 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

324  (
pos
 << 1) & 0xffffffff;

326  ((
pos
 >> 32) << 1) & 0xffffffff;

327 
	}
}

329 
ölöe
 
__u32
 
	$pos2mö_hash
(
fûe
 *
fûp
, 
loff_t
 
pos
)

331 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

332 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

335  
pos
 & 0xffffffff;

336 
	}
}

341 
ölöe
 
loff_t
 
	$pxt4_gë_håì_eof
(
fûe
 *
fûp
)

343 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

344 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

345  
PXT4_HTREE_EOF_32BIT
;

347  
PXT4_HTREE_EOF_64BIT
;

348 
	}
}

362 
loff_t
 
	$pxt4_dú_Œ£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
whí˚
)

364 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

365 
dx_dú
 = 
	`is_dx_dú
(
öode
);

366 
loff_t
 
ªt
, 
håì_max
 = 
	`pxt4_gë_håì_eof
(
fûe
);

368 i‡(
	`likñy
(
dx_dú
))

369 
ªt
 = 
	`gíîic_fûe_Œ£ek_size
(
fûe
, 
off£t
, 
whí˚
,

370 
håì_max
, htree_max);

372 
ªt
 = 
	`pxt4_Œ£ek
(
fûe
, 
off£t
, 
whí˚
);

373 
fûe
->
f_vîsi⁄
 = 
	`öode_≥ek_ivîsi⁄
(
öode
) - 1;

374  
ªt
;

375 
	}
}

381 
	s‚ame
 {

382 
__u32
 
	mhash
;

383 
__u32
 
	mmö‹_hash
;

384 
rb_node
 
	mrb_hash
;

385 
‚ame
 *
	m√xt
;

386 
__u32
 
	möode
;

387 
__u8
 
	m«me_Àn
;

388 
__u8
 
	mfûe_ty≥
;

389 
	m«me
[0];

396 
	$‰ì_rb_åì_‚ame
(
rb_roŸ
 *
roŸ
)

398 
‚ame
 *‚ame, *
√xt
;

400 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
‚ame
, 
√xt
, 
roŸ
, 
rb_hash
)

401 
‚ame
) {

402 
‚ame
 *
ﬁd
 = fname;

403 
‚ame
 = f«me->
√xt
;

404 
	`k‰ì
(
ﬁd
);

407 *
roŸ
 = 
RB_ROOT
;

408 
	}
}

411 
dú_¥iv©e_öfo
 *
	$pxt4_håì_¸óã_dú_öfo
(
fûe
 *
fûp
,

412 
loff_t
 
pos
)

414 
dú_¥iv©e_öfo
 *
p
;

416 
p
 = 
	`kzÆloc
((*p), 
GFP_KERNEL
);

417 i‡(!
p
)

418  
NULL
;

419 
p
->
cuº_hash
 = 
	`pos2maj_hash
(
fûp
, 
pos
);

420 
p
->
cuº_mö‹_hash
 = 
	`pos2mö_hash
(
fûp
, 
pos
);

421  
p
;

422 
	}
}

424 
	$pxt4_håì_‰ì_dú_öfo
(
dú_¥iv©e_öfo
 *
p
)

426 
	`‰ì_rb_åì_‚ame
(&
p
->
roŸ
);

427 
	`k‰ì
(
p
);

428 
	}
}

437 
	$pxt4_håì_°‹e_dúít
(
fûe
 *
dú_fûe
, 
__u32
 
hash
,

438 
__u32
 
mö‹_hash
,

439 
pxt4_dú_íåy_2
 *
dúít
,

440 
fs¸y±_°r
 *
ít_«me
)

442 
rb_node
 **
p
, *
∑ª¡
 = 
NULL
;

443 
‚ame
 *‚ame, *
√w_‚
;

444 
dú_¥iv©e_öfo
 *
öfo
;

445 
Àn
;

447 
öfo
 = 
dú_fûe
->
¥iv©e_d©a
;

448 
p
 = &
öfo
->
roŸ
.
rb_node
;

451 
Àn
 = (
‚ame
Ë+ 
ít_«me
->len + 1;

452 
√w_‚
 = 
	`kzÆloc
(
Àn
, 
GFP_KERNEL
);

453 i‡(!
√w_‚
)

454  -
ENOMEM
;

455 
√w_‚
->
hash
 = hash;

456 
√w_‚
->
mö‹_hash
 = minor_hash;

457 
√w_‚
->
öode
 = 
	`À32_to_˝u
(
dúít
->inode);

458 
√w_‚
->
«me_Àn
 = 
ít_«me
->
Àn
;

459 
√w_‚
->
fûe_ty≥
 = 
dúít
->file_type;

460 
	`mem˝y
(
√w_‚
->
«me
, 
ít_«me
->«me,É¡_«me->
Àn
);

461 
√w_‚
->
«me
[
ít_«me
->
Àn
] = 0;

463 *
p
) {

464 
∑ª¡
 = *
p
;

465 
‚ame
 = 
	`rb_íåy
(
∑ª¡
, ‚ame, 
rb_hash
);

471 i‡((
√w_‚
->
hash
 =
‚ame
->hash) &&

472 (
√w_‚
->
mö‹_hash
 =
‚ame
->minor_hash)) {

473 
√w_‚
->
√xt
 = 
‚ame
->next;

474 
‚ame
->
√xt
 = 
√w_‚
;

478 i‡(
√w_‚
->
hash
 < 
‚ame
->hash)

479 
p
 = &(*p)->
rb_À·
;

480 i‡(
√w_‚
->
hash
 > 
‚ame
->hash)

481 
p
 = &(*p)->
rb_right
;

482 i‡(
√w_‚
->
mö‹_hash
 < 
‚ame
->minor_hash)

483 
p
 = &(*p)->
rb_À·
;

485 
p
 = &(*p)->
rb_right
;

488 
	`rb_lök_node
(&
√w_‚
->
rb_hash
, 
∑ª¡
, 
p
);

489 
	`rb_ö£π_cﬁ‹
(&
√w_‚
->
rb_hash
, &
öfo
->
roŸ
);

491 
	}
}

500 
	$ˇŒ_fûldú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
,

501 
‚ame
 *fname)

503 
dú_¥iv©e_öfo
 *
öfo
 = 
fûe
->
¥iv©e_d©a
;

504 
öode
 *öodê
	`fûe_öode
(
fûe
);

505 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

507 i‡(!
‚ame
) {

508 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu: comm %s: "

509 "ˇŒed wôhÇuŒ f«me?!?", 
__func__
, 
__LINE__
,

510 
öode
->
i_öo
, 
cuºít
->
comm
);

513 
˘x
->
pos
 = 
	`hash2pos
(
fûe
, 
‚ame
->
hash
, f«me->
mö‹_hash
);

514 
‚ame
) {

515 i‡(!
	`dú_emô
(
˘x
, 
‚ame
->
«me
,

516 
‚ame
->
«me_Àn
,

517 
‚ame
->
öode
,

518 
	`gë_dty≥
(
sb
, 
‚ame
->
fûe_ty≥
))) {

519 
öfo
->
exåa_‚ame
 = 
‚ame
;

522 
‚ame
 = f«me->
√xt
;

525 
	}
}

527 
	$pxt4_dx_ªaddú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
)

529 
dú_¥iv©e_öfo
 *
öfo
 = 
fûe
->
¥iv©e_d©a
;

530 
öode
 *öodê
	`fûe_öode
(
fûe
);

531 
‚ame
 *fname;

532 
ªt
;

534 i‡(!
öfo
) {

535 
öfo
 = 
	`pxt4_håì_¸óã_dú_öfo
(
fûe
, 
˘x
->
pos
);

536 i‡(!
öfo
)

537  -
ENOMEM
;

538 
fûe
->
¥iv©e_d©a
 = 
öfo
;

541 i‡(
˘x
->
pos
 =
	`pxt4_gë_håì_eof
(
fûe
))

545 i‡(
öfo
->
œ°_pos
 !
˘x
->
pos
) {

546 
	`‰ì_rb_åì_‚ame
(&
öfo
->
roŸ
);

547 
öfo
->
cuº_node
 = 
NULL
;

548 
öfo
->
exåa_‚ame
 = 
NULL
;

549 
öfo
->
cuº_hash
 = 
	`pos2maj_hash
(
fûe
, 
˘x
->
pos
);

550 
öfo
->
cuº_mö‹_hash
 = 
	`pos2mö_hash
(
fûe
, 
˘x
->
pos
);

557 i‡(
öfo
->
exåa_‚ame
) {

558 i‡(
	`ˇŒ_fûldú
(
fûe
, 
˘x
, 
öfo
->
exåa_‚ame
))

559 
föished
;

560 
öfo
->
exåa_‚ame
 = 
NULL
;

561 
√xt_node
;

562 } i‡(!
öfo
->
cuº_node
)

563 
öfo
->
cuº_node
 = 
	`rb_fú°
(&öfo->
roŸ
);

571 i‡((!
öfo
->
cuº_node
) ||

572 !
	`öode_eq_ivîsi⁄
(
öode
, 
fûe
->
f_vîsi⁄
)) {

573 
öfo
->
cuº_node
 = 
NULL
;

574 
	`‰ì_rb_åì_‚ame
(&
öfo
->
roŸ
);

575 
fûe
->
f_vîsi⁄
 = 
	`öode_quîy_ivîsi⁄
(
öode
);

576 
ªt
 = 
	`pxt4_håì_fûl_åì
(
fûe
, 
öfo
->
cuº_hash
,

577 
öfo
->
cuº_mö‹_hash
,

578 &
öfo
->
√xt_hash
);

579 i‡(
ªt
 < 0)

580  
ªt
;

581 i‡(
ªt
 == 0) {

582 
˘x
->
pos
 = 
	`pxt4_gë_håì_eof
(
fûe
);

585 
öfo
->
cuº_node
 = 
	`rb_fú°
(&öfo->
roŸ
);

588 
‚ame
 = 
	`rb_íåy
(
öfo
->
cuº_node
, ‚ame, 
rb_hash
);

589 
öfo
->
cuº_hash
 = 
‚ame
->
hash
;

590 
öfo
->
cuº_mö‹_hash
 = 
‚ame
->
mö‹_hash
;

591 i‡(
	`ˇŒ_fûldú
(
fûe
, 
˘x
, 
‚ame
))

593 
√xt_node
:

594 
öfo
->
cuº_node
 = 
	`rb_√xt
(info->curr_node);

595 i‡(
öfo
->
cuº_node
) {

596 
‚ame
 = 
	`rb_íåy
(
öfo
->
cuº_node
, fname,

597 
rb_hash
);

598 
öfo
->
cuº_hash
 = 
‚ame
->
hash
;

599 
öfo
->
cuº_mö‹_hash
 = 
‚ame
->
mö‹_hash
;

601 i‡(
öfo
->
√xt_hash
 == ~0) {

602 
˘x
->
pos
 = 
	`pxt4_gë_håì_eof
(
fûe
);

605 
öfo
->
cuº_hash
 = info->
√xt_hash
;

606 
öfo
->
cuº_mö‹_hash
 = 0;

609 
föished
:

610 
öfo
->
œ°_pos
 = 
˘x
->
pos
;

612 
	}
}

614 
	$pxt4_dú_›í
(
öode
 * inode, 
fûe
 * 
fûp
)

616 i‡(
	`IS_ENCRYPTED
(
öode
))

617  
	`fs¸y±_gë_í¸y±i⁄_öfo
(
öode
Ë? -
EACCES
 : 0;

619 
	}
}

621 
	$pxt4_ªÀa£_dú
(
öode
 *öode, 
fûe
 *
fûp
)

623 i‡(
fûp
->
¥iv©e_d©a
)

624 
	`pxt4_håì_‰ì_dú_öfo
(
fûp
->
¥iv©e_d©a
);

627 
	}
}

629 
	$pxt4_check_Æl_de
(
öode
 *
dú
, 
buf„r_hód
 *
bh
, *
buf
,

630 
buf_size
)

632 
pxt4_dú_íåy_2
 *
de
;

633 
æí
;

634 
off£t
 = 0;

635 *
t›
;

637 
de
 = (
pxt4_dú_íåy_2
 *)
buf
;

638 
t›
 = 
buf
 + 
buf_size
;

639 (*Ë
de
 < 
t›
) {

640 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

641 
buf
, 
buf_size
, 
off£t
))

642  -
EFSCORRUPTED
;

643 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
buf_size
);

644 
de
 = (
pxt4_dú_íåy_2
 *)((*)dê+ 
æí
);

645 
off£t
 +
æí
;

647 i‡((*Ë
de
 > 
t›
)

648  -
EFSCORRUPTED
;

651 
	}
}

653 c⁄° 
fûe_›î©i⁄s
 
	gpxt4_dú_›î©i⁄s
 = {

654 .
Œ£ek
 = 
pxt4_dú_Œ£ek
,

655 .
	gªad
 = 
gíîic_ªad_dú
,

656 .
	gôî©e_sh¨ed
 = 
pxt4_ªaddú
,

657 .
	gu∆ocked_io˘l
 = 
pxt4_io˘l
,

658 #ifde‡
CONFIG_COMPAT


659 .
	gcom∑t_io˘l
 = 
pxt4_com∑t_io˘l
,

661 .
	gfsync
 = 
pxt4_sync_fûe
,

662 .
	g›í
 = 
pxt4_dú_›í
,

663 .
	gªÀa£
 = 
pxt4_ªÀa£_dú
,

666 #ifde‡
CONFIG_UNICODE


667 
	$pxt4_d_com∑ª
(c⁄° 
díåy
 *díåy, 
Àn
,

668 c⁄° *
°r
, c⁄° 
q°r
 *
«me
)

670 
q°r
 q°∏{.
«me
 = 
°r
, .
Àn
 =Üen };

671 
öode
 *öodê
díåy
->
d_∑ª¡
->
d_öode
;

673 i‡(!
	`IS_CASEFOLDED
(
öode
Ë|| !
	`PXT4_SB
(öode->
i_sb
)->
s_ícodög
) {

674 i‡(
Àn
 !
«me
->len)

676  
	`memcmp
(
°r
, 
«me
->«me, 
Àn
);

679  
	`pxt4_ci_com∑ª
(
öode
, 
«me
, &
q°r
, 
Ál£
);

680 
	}
}

682 
	$pxt4_d_hash
(c⁄° 
díåy
 *díåy, 
q°r
 *
°r
)

684 c⁄° 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
díåy
->
d_sb
);

685 c⁄° 
unicode_m≠
 *
um
 = 
sbi
->
s_ícodög
;

686 *
n‹m
;

687 
Àn
, 
ªt
 = 0;

689 i‡(!
	`IS_CASEFOLDED
(
díåy
->
d_öode
Ë|| !
um
)

692 
n‹m
 = 
	`kmÆloc
(
PATH_MAX
, 
GFP_ATOMIC
);

693 i‡(!
n‹m
)

694  -
ENOMEM
;

696 
Àn
 = 
	`utf8_ˇ£fﬁd
(
um
, 
°r
, 
n‹m
, 
PATH_MAX
);

697 i‡(
Àn
 < 0) {

698 i‡(
	`pxt4_has_°ri˘_mode
(
sbi
))

699 
ªt
 = -
EINVAL
;

700 
out
;

702 
°r
->
hash
 = 
	`fuŒ_«me_hash
(
díåy
, 
n‹m
, 
Àn
);

703 
out
:

704 
	`k‰ì
(
n‹m
);

705  
ªt
;

706 
	}
}

708 c⁄° 
díåy_›î©i⁄s
 
	gpxt4_díåy_›s
 = {

709 .
d_hash
 = 
pxt4_d_hash
,

710 .
	gd_com∑ª
 = 
pxt4_d_com∑ª
,

	@ext4.h

17 #i‚de‡
_PXT4_H


18 
	#_PXT4_H


	)

20 
	~<löux/ty≥s.h
>

21 
	~<löux/blkdev.h
>

22 
	~<löux/magic.h
>

23 
	~<löux/jbd3.h
>

24 
	~<löux/quŸa.h
>

25 
	~<löux/rw£m.h
>

26 
	~<löux/rbåì.h
>

27 
	~<löux/£qlock.h
>

28 
	~<löux/muãx.h
>

29 
	~<löux/timî.h
>

30 
	~<löux/vîsi⁄.h
>

31 
	~<löux/waô.h
>

32 
	~<löux/sched/sig«l.h
>

33 
	~<löux/blockgroup_lock.h
>

34 
	~<löux/≥r˝u_cou¡î.h
>

35 
	~<löux/øãlimô.h
>

36 
	~<¸y±o/hash.h
>

37 
	~<löux/ÁŒoc.h
>

38 
	~<löux/≥r˝u-rw£m.h
>

39 #ifde‡
__KERNEL__


40 
	~<löux/com∑t.h
>

43 
	~<löux/fs¸y±.h
>

44 
	~<löux/fsvîôy.h
>

46 
	~<löux/compûî.h
>

56 
	#AGGRESSIVE_CHECK__


	)

62 
	#DOUBLE_CHECK__


	)

67 #unde‡
PXT4FS_DEBUG


72 #ifde‡
PXT4FS_DEBUG


73 
	#pxt4_debug
(
f
, 
a
...) \

75 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs DEBUG (%s, %d): %s:", \

76 
__FILE__
, 
__LINE__
, 
__func__
); \

77 
	`¥ötk
(
KERN_DEBUG
 
f
, ## 
a
); \

78 } 0)

	)

80 
	#pxt4_debug
(
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

86 
	#EXT_DEBUG__


	)

87 #ifde‡
EXT_DEBUG


88 
	#ext_debug
(
fmt
, ...Ë
	`¥ötk
(fmt, ##
__VA_ARGS__
)

	)

90 
	#ext_debug
(
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

94 
	tpxt4_gΩblk_t
;

97 
	tpxt4_fsblk_t
;

100 
__u32
 
	tpxt4_lblk_t
;

103 
	tpxt4_group_t
;

105 
	eSHIFT_DIRECTION
 {

106 
	mSHIFT_LEFT
 = 0,

107 
	mSHIFT_RIGHT
,

118 
	#PXT4_MB_HINT_MERGE
 0x0001

	)

120 
	#PXT4_MB_HINT_RESERVED
 0x0002

	)

122 
	#PXT4_MB_HINT_METADATA
 0x0004

	)

124 
	#PXT4_MB_HINT_FIRST
 0x0008

	)

126 
	#PXT4_MB_HINT_BEST
 0x0010

	)

128 
	#PXT4_MB_HINT_DATA
 0x0020

	)

130 
	#PXT4_MB_HINT_NOPREALLOC
 0x0040

	)

132 
	#PXT4_MB_HINT_GROUP_ALLOC
 0x0080

	)

134 
	#PXT4_MB_HINT_GOAL_ONLY
 0x0100

	)

136 
	#PXT4_MB_HINT_TRY_GOAL
 0x0200

	)

138 
	#PXT4_MB_DELALLOC_RESERVED
 0x0400

	)

140 
	#PXT4_MB_STREAM_ALLOC
 0x0800

	)

142 
	#PXT4_MB_USE_ROOT_BLOCKS
 0x1000

	)

144 
	#PXT4_MB_USE_RESERVED
 0x2000

	)

146 
	spxt4_Æloˇti⁄_ªque°
 {

148 
öode
 *
	möode
;

150 
	mÀn
;

152 
pxt4_lblk_t
 
	mlogiˇl
;

154 
pxt4_lblk_t
 
	mŒe·
;

156 
pxt4_lblk_t
 
	mÃight
;

158 
pxt4_fsblk_t
 
	mgﬂl
;

160 
pxt4_fsblk_t
 
	m∂e·
;

162 
pxt4_fsblk_t
 
	m¥ight
;

164 
	mÊags
;

174 
	#PXT4_MAP_NEW
 (1 << 
BH_New
)

	)

175 
	#PXT4_MAP_MAPPED
 (1 << 
BH_M≠≥d
)

	)

176 
	#PXT4_MAP_UNWRITTEN
 (1 << 
BH_Unwrôãn
)

	)

177 
	#PXT4_MAP_BOUNDARY
 (1 << 
BH_Bound¨y
)

	)

178 
	#PXT4_MAP_FLAGS
 (
PXT4_MAP_NEW
 | 
PXT4_MAP_MAPPED
 |\

179 
PXT4_MAP_UNWRITTEN
 | 
PXT4_MAP_BOUNDARY
)

	)

181 
	spxt4_m≠_blocks
 {

182 
pxt4_fsblk_t
 
	mm_pblk
;

183 
pxt4_lblk_t
 
	mm_lblk
;

184 
	mm_Àn
;

185 
	mm_Êags
;

191 
	spxt4_sy°em_blocks
 {

192 
rb_roŸ
 
	mroŸ
;

193 
rcu_hód
 
	mrcu
;

199 
	#PXT4_IO_END_UNWRITTEN
 0x0001

	)

205 
	spxt4_io_íd
 {

206 
li°_hód
 
	mli°
;

207 
h™dÀ_t
 *
	mh™dÀ
;

209 
öode
 *
	möode
;

210 
bio
 *
	mbio
;

212 
	mÊag
;

213 
©omic_t
 
	mcou¡
;

214 
loff_t
 
	moff£t
;

215 
ssize_t
 
	msize
;

216 } 
	tpxt4_io_íd_t
;

218 
	spxt4_io_submô
 {

219 
wrôeback_c⁄åﬁ
 *
	mio_wbc
;

220 
bio
 *
	mio_bio
;

221 
pxt4_io_íd_t
 *
	mio_íd
;

222 
£˘‹_t
 
	mio_√xt_block
;

228 
	#PXT4_BAD_INO
 1

	)

229 
	#PXT4_ROOT_INO
 2

	)

230 
	#PXT4_USR_QUOTA_INO
 3

	)

231 
	#PXT4_GRP_QUOTA_INO
 4

	)

232 
	#PXT4_BOOT_LOADER_INO
 5

	)

233 
	#PXT4_UNDEL_DIR_INO
 6

	)

234 
	#PXT4_RESIZE_INO
 7

	)

235 
	#PXT4_JOURNAL_INO
 8

	)

238 
	#PXT4_GOOD_OLD_FIRST_INO
 11

	)

243 
	#PXT4_LINK_MAX
 65000

	)

248 
	#PXT4_MIN_BLOCK_SIZE
 1024

	)

249 
	#PXT4_MAX_BLOCK_SIZE
 65536

	)

250 
	#PXT4_MIN_BLOCK_LOG_SIZE
 10

	)

251 
	#PXT4_MAX_BLOCK_LOG_SIZE
 16

	)

252 
	#PXT4_MAX_CLUSTER_LOG_SIZE
 30

	)

253 #ifde‡
__KERNEL__


254 
	#PXT4_BLOCK_SIZE
(
s
Ë((s)->
s_blocksize
)

	)

256 
	#PXT4_BLOCK_SIZE
(
s
Ë(
PXT4_MIN_BLOCK_SIZE
 << (s)->
s_log_block_size
)

	)

258 
	#PXT4_ADDR_PER_BLOCK
(
s
Ë(
	`PXT4_BLOCK_SIZE
(sË/ (
__u32
))

	)

259 
	#PXT4_CLUSTER_SIZE
(
s
Ë(
	`PXT4_BLOCK_SIZE
(s) << \

260 
	`PXT4_SB
(
s
)->
s_˛u°î_bôs
)

	)

261 #ifde‡
__KERNEL__


262 
	#PXT4_BLOCK_SIZE_BITS
(
s
Ë((s)->
s_blocksize_bôs
)

	)

263 
	#PXT4_CLUSTER_BITS
(
s
Ë(
	`PXT4_SB
(s)->
s_˛u°î_bôs
)

	)

265 
	#PXT4_BLOCK_SIZE_BITS
(
s
Ë((s)->
s_log_block_size
 + 10)

	)

267 #ifde‡
__KERNEL__


268 
	#PXT4_ADDR_PER_BLOCK_BITS
(
s
Ë(
	`PXT4_SB
(s)->
s_addr_≥r_block_bôs
)

	)

269 
	#PXT4_INODE_SIZE
(
s
Ë(
	`PXT4_SB
(s)->
s_öode_size
)

	)

270 
	#PXT4_FIRST_INO
(
s
Ë(
	`PXT4_SB
(s)->
s_fú°_öo
)

	)

272 
	#PXT4_INODE_SIZE
(
s
Ë(((s)->
s_ªv_Àvñ
 =
PXT4_GOOD_OLD_REV
) ? \

273 
PXT4_GOOD_OLD_INODE_SIZE
 : \

274 (
s
)->
s_öode_size
)

	)

275 
	#PXT4_FIRST_INO
(
s
Ë(((s)->
s_ªv_Àvñ
 =
PXT4_GOOD_OLD_REV
) ? \

276 
PXT4_GOOD_OLD_FIRST_INO
 : \

277 (
s
)->
s_fú°_öo
)

	)

279 
	#PXT4_BLOCK_ALIGN
(
size
, 
blkbôs
Ë
	`ALIGN
((size), (1 << (blkbôs)))

	)

280 
	#PXT4_MAX_BLOCKS
(
size
, 
off£t
, 
blkbôs
) \

281 ((
	`PXT4_BLOCK_ALIGN
(
size
 + 
off£t
, 
blkbôs
) >> blkbits) - (offset >> \

282 
blkbôs
))

	)

285 
	#PXT4_B2C
(
sbi
, 
blk
Ë((blkË>> (sbi)->
s_˛u°î_bôs
)

	)

287 
	#PXT4_C2B
(
sbi
, 
˛u°î
Ë((˛u°îË<< (sbi)->
s_˛u°î_bôs
)

	)

289 
	#PXT4_NUM_B2C
(
sbi
, 
blks
Ë(((blksË+ (sbi)->
s_˛u°î_øtio
 - 1) >> \

290 (
sbi
)->
s_˛u°î_bôs
)

	)

292 
	#PXT4_PBLK_CMASK
(
s
, 
pblk
) ((pblk) & \

293 ~((
pxt4_fsblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

294 
	#PXT4_LBLK_CMASK
(
s
, 
lblk
) ((lblk) & \

295 ~((
pxt4_lblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

297 
	#PXT4_LBLK_CFILL
(
sbi
, 
lblk
) ((lblk) | \

298 ((
pxt4_lblk_t
Ë(
sbi
)->
s_˛u°î_øtio
 - 1))

	)

300 
	#PXT4_PBLK_COFF
(
s
, 
pblk
) ((pblk) & \

301 ((
pxt4_fsblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

302 
	#PXT4_LBLK_COFF
(
s
, 
lblk
) ((lblk) & \

303 ((
pxt4_lblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

308 
	spxt4_group_desc


310 
__À32
 
	mbg_block_bôm≠_lo
;

311 
__À32
 
	mbg_öode_bôm≠_lo
;

312 
__À32
 
	mbg_öode_èbÀ_lo
;

313 
__À16
 
	mbg_‰ì_blocks_cou¡_lo
;

314 
__À16
 
	mbg_‰ì_öodes_cou¡_lo
;

315 
__À16
 
	mbg_u£d_dús_cou¡_lo
;

316 
__À16
 
	mbg_Êags
;

317 
__À32
 
	mbg_ex˛ude_bôm≠_lo
;

318 
__À16
 
	mbg_block_bôm≠_csum_lo
;

319 
__À16
 
	mbg_öode_bôm≠_csum_lo
;

320 
__À16
 
	mbg_ôabÀ_unu£d_lo
;

321 
__À16
 
	mbg_checksum
;

322 
__À32
 
	mbg_block_bôm≠_hi
;

323 
__À32
 
	mbg_öode_bôm≠_hi
;

324 
__À32
 
	mbg_öode_èbÀ_hi
;

325 
__À16
 
	mbg_‰ì_blocks_cou¡_hi
;

326 
__À16
 
	mbg_‰ì_öodes_cou¡_hi
;

327 
__À16
 
	mbg_u£d_dús_cou¡_hi
;

328 
__À16
 
	mbg_ôabÀ_unu£d_hi
;

329 
__À32
 
	mbg_ex˛ude_bôm≠_hi
;

330 
__À16
 
	mbg_block_bôm≠_csum_hi
;

331 
__À16
 
	mbg_öode_bôm≠_csum_hi
;

332 
__u32
 
	mbg_ª£rved
;

335 
	#PXT4_BG_INODE_BITMAP_CSUM_HI_END
 \

336 (
	`off£tof
(
pxt4_group_desc
, 
bg_öode_bôm≠_csum_hi
) + \

337 (
__À16
))

	)

338 
	#PXT4_BG_BLOCK_BITMAP_CSUM_HI_END
 \

339 (
	`off£tof
(
pxt4_group_desc
, 
bg_block_bôm≠_csum_hi
) + \

340 (
__À16
))

	)

346 
	sÊex_groups
 {

347 
©omic64_t
 
	m‰ì_˛u°îs
;

348 
©omic_t
 
	m‰ì_öodes
;

349 
©omic_t
 
	mu£d_dús
;

352 
	#PXT4_BG_INODE_UNINIT
 0x0001

	)

353 
	#PXT4_BG_BLOCK_UNINIT
 0x0002

	)

354 
	#PXT4_BG_INODE_ZEROED
 0x0004

	)

359 
	#PXT4_MIN_DESC_SIZE
 32

	)

360 
	#PXT4_MIN_DESC_SIZE_64BIT
 64

	)

361 
	#PXT4_MAX_DESC_SIZE
 
PXT4_MIN_BLOCK_SIZE


	)

362 
	#PXT4_DESC_SIZE
(
s
Ë(
	`PXT4_SB
(s)->
s_desc_size
)

	)

363 #ifde‡
__KERNEL__


364 
	#PXT4_BLOCKS_PER_GROUP
(
s
Ë(
	`PXT4_SB
(s)->
s_blocks_≥r_group
)

	)

365 
	#PXT4_CLUSTERS_PER_GROUP
(
s
Ë(
	`PXT4_SB
(s)->
s_˛u°îs_≥r_group
)

	)

366 
	#PXT4_DESC_PER_BLOCK
(
s
Ë(
	`PXT4_SB
(s)->
s_desc_≥r_block
)

	)

367 
	#PXT4_INODES_PER_GROUP
(
s
Ë(
	`PXT4_SB
(s)->
s_öodes_≥r_group
)

	)

368 
	#PXT4_DESC_PER_BLOCK_BITS
(
s
Ë(
	`PXT4_SB
(s)->
s_desc_≥r_block_bôs
)

	)

370 
	#PXT4_BLOCKS_PER_GROUP
(
s
Ë((s)->
s_blocks_≥r_group
)

	)

371 
	#PXT4_DESC_PER_BLOCK
(
s
Ë(
	`PXT4_BLOCK_SIZE
(sË/ 
	`PXT4_DESC_SIZE
(s))

	)

372 
	#PXT4_INODES_PER_GROUP
(
s
Ë((s)->
s_öodes_≥r_group
)

	)

378 
	#PXT4_NDIR_BLOCKS
 12

	)

379 
	#PXT4_IND_BLOCK
 
PXT4_NDIR_BLOCKS


	)

380 
	#PXT4_DIND_BLOCK
 (
PXT4_IND_BLOCK
 + 1)

	)

381 
	#PXT4_TIND_BLOCK
 (
PXT4_DIND_BLOCK
 + 1)

	)

382 
	#PXT4_N_BLOCKS
 (
PXT4_TIND_BLOCK
 + 1)

	)

387 
	#PXT4_SECRM_FL
 0x00000001

	)

388 
	#PXT4_UNRM_FL
 0x00000002

	)

389 
	#PXT4_COMPR_FL
 0x00000004

	)

390 
	#PXT4_SYNC_FL
 0x00000008

	)

391 
	#PXT4_IMMUTABLE_FL
 0x00000010

	)

392 
	#PXT4_APPEND_FL
 0x00000020

	)

393 
	#PXT4_NODUMP_FL
 0x00000040

	)

394 
	#PXT4_NOATIME_FL
 0x00000080

	)

396 
	#PXT4_DIRTY_FL
 0x00000100

	)

397 
	#PXT4_COMPRBLK_FL
 0x00000200

	)

398 
	#PXT4_NOCOMPR_FL
 0x00000400

	)

400 
	#PXT4_ENCRYPT_FL
 0x00000800

	)

402 
	#PXT4_INDEX_FL
 0x00001000

	)

403 
	#PXT4_IMAGIC_FL
 0x00002000

	)

404 
	#PXT4_JOURNAL_DATA_FL
 0x00004000

	)

405 
	#PXT4_NOTAIL_FL
 0x00008000

	)

406 
	#PXT4_DIRSYNC_FL
 0x00010000

	)

407 
	#PXT4_TOPDIR_FL
 0x00020000

	)

408 
	#PXT4_HUGE_FILE_FL
 0x00040000

	)

409 
	#PXT4_EXTENTS_FL
 0x00080000

	)

410 
	#PXT4_VERITY_FL
 0x00100000

	)

411 
	#PXT4_EA_INODE_FL
 0x00200000

	)

412 
	#PXT4_EOFBLOCKS_FL
 0x00400000

	)

413 
	#PXT4_INLINE_DATA_FL
 0x10000000

	)

414 
	#PXT4_PROJINHERIT_FL
 0x20000000

	)

415 
	#PXT4_CASEFOLD_FL
 0x40000000

	)

416 
	#PXT4_RESERVED_FL
 0x80000000

	)

418 
	#PXT4_FL_USER_VISIBLE
 0x705BDFFF

	)

419 
	#PXT4_FL_USER_MODIFIABLE
 0x604BC0FF

	)

422 
	#PXT4_FL_XFLAG_VISIBLE
 (
PXT4_SYNC_FL
 | \

423 
PXT4_IMMUTABLE_FL
 | \

424 
PXT4_APPEND_FL
 | \

425 
PXT4_NODUMP_FL
 | \

426 
PXT4_NOATIME_FL
 | \

427 
PXT4_PROJINHERIT_FL
)

	)

430 
	#PXT4_FL_INHERITED
 (
PXT4_SECRM_FL
 | 
PXT4_UNRM_FL
 | 
PXT4_COMPR_FL
 |\

431 
PXT4_SYNC_FL
 | 
PXT4_NODUMP_FL
 | 
PXT4_NOATIME_FL
 |\

432 
PXT4_NOCOMPR_FL
 | 
PXT4_JOURNAL_DATA_FL
 |\

433 
PXT4_NOTAIL_FL
 | 
PXT4_DIRSYNC_FL
 |\

434 
PXT4_PROJINHERIT_FL
 | 
PXT4_CASEFOLD_FL
)

	)

437 
	#PXT4_REG_FLMASK
 (~(
PXT4_DIRSYNC_FL
 | 
PXT4_TOPDIR_FL
 | 
PXT4_CASEFOLD_FL
 |\

438 
PXT4_PROJINHERIT_FL
))

	)

441 
	#PXT4_OTHER_FLMASK
 (
PXT4_NODUMP_FL
 | 
PXT4_NOATIME_FL
)

	)

444 
	#PXT4_FL_SHOULD_SWAP
 (
PXT4_HUGE_FILE_FL
 | 
PXT4_EXTENTS_FL
)

	)

447 
ölöe
 
__u32
 
	$pxt4_mask_Êags
(
umode_t
 
mode
, 
__u32
 
Êags
)

449 i‡(
	`S_ISDIR
(
mode
))

450  
Êags
;

451 i‡(
	`S_ISREG
(
mode
))

452  
Êags
 & 
PXT4_REG_FLMASK
;

454  
Êags
 & 
PXT4_OTHER_FLMASK
;

455 
	}
}

461 
	mPXT4_INODE_SECRM
 = 0,

462 
	mPXT4_INODE_UNRM
 = 1,

463 
	mPXT4_INODE_COMPR
 = 2,

464 
	mPXT4_INODE_SYNC
 = 3,

465 
	mPXT4_INODE_IMMUTABLE
 = 4,

466 
	mPXT4_INODE_APPEND
 = 5,

467 
	mPXT4_INODE_NODUMP
 = 6,

468 
	mPXT4_INODE_NOATIME
 = 7,

470 
	mPXT4_INODE_DIRTY
 = 8,

471 
	mPXT4_INODE_COMPRBLK
 = 9,

472 
	mPXT4_INODE_NOCOMPR
 = 10,

473 
	mPXT4_INODE_ENCRYPT
 = 11,

475 
	mPXT4_INODE_INDEX
 = 12,

476 
	mPXT4_INODE_IMAGIC
 = 13,

477 
	mPXT4_INODE_JOURNAL_DATA
 = 14,

478 
	mPXT4_INODE_NOTAIL
 = 15,

479 
	mPXT4_INODE_DIRSYNC
 = 16,

480 
	mPXT4_INODE_TOPDIR
 = 17,

481 
	mPXT4_INODE_HUGE_FILE
 = 18,

482 
	mPXT4_INODE_EXTENTS
 = 19,

483 
	mPXT4_INODE_VERITY
 = 20,

484 
	mPXT4_INODE_EA_INODE
 = 21,

485 
	mPXT4_INODE_EOFBLOCKS
 = 22,

486 
	mPXT4_INODE_INLINE_DATA
 = 28,

487 
	mPXT4_INODE_PROJINHERIT
 = 29,

488 
	mPXT4_INODE_RESERVED
 = 31,

504 
	#TEST_FLAG_VALUE
(
FLAG
Ë(
PXT4_
##FLAG##
_FL
 =(1 << 
PXT4_INODE_
##FLAG))

	)

505 
	#CHECK_FLAG_VALUE
(
FLAG
Ë
	`BUILD_BUG_ON
(!
	`TEST_FLAG_VALUE
(FLAG))

	)

507 
ölöe
 
	$pxt4_check_Êag_vÆues
()

509 
	`CHECK_FLAG_VALUE
(
SECRM
);

510 
	`CHECK_FLAG_VALUE
(
UNRM
);

511 
	`CHECK_FLAG_VALUE
(
COMPR
);

512 
	`CHECK_FLAG_VALUE
(
SYNC
);

513 
	`CHECK_FLAG_VALUE
(
IMMUTABLE
);

514 
	`CHECK_FLAG_VALUE
(
APPEND
);

515 
	`CHECK_FLAG_VALUE
(
NODUMP
);

516 
	`CHECK_FLAG_VALUE
(
NOATIME
);

517 
	`CHECK_FLAG_VALUE
(
DIRTY
);

518 
	`CHECK_FLAG_VALUE
(
COMPRBLK
);

519 
	`CHECK_FLAG_VALUE
(
NOCOMPR
);

520 
	`CHECK_FLAG_VALUE
(
ENCRYPT
);

521 
	`CHECK_FLAG_VALUE
(
INDEX
);

522 
	`CHECK_FLAG_VALUE
(
IMAGIC
);

523 
	`CHECK_FLAG_VALUE
(
JOURNAL_DATA
);

524 
	`CHECK_FLAG_VALUE
(
NOTAIL
);

525 
	`CHECK_FLAG_VALUE
(
DIRSYNC
);

526 
	`CHECK_FLAG_VALUE
(
TOPDIR
);

527 
	`CHECK_FLAG_VALUE
(
HUGE_FILE
);

528 
	`CHECK_FLAG_VALUE
(
EXTENTS
);

529 
	`CHECK_FLAG_VALUE
(
VERITY
);

530 
	`CHECK_FLAG_VALUE
(
EA_INODE
);

531 
	`CHECK_FLAG_VALUE
(
EOFBLOCKS
);

532 
	`CHECK_FLAG_VALUE
(
INLINE_DATA
);

533 
	`CHECK_FLAG_VALUE
(
PROJINHERIT
);

534 
	`CHECK_FLAG_VALUE
(
RESERVED
);

535 
	}
}

538 
	spxt4_√w_group_öput
 {

539 
__u32
 
	mgroup
;

540 
__u64
 
	mblock_bôm≠
;

541 
__u64
 
	möode_bôm≠
;

542 
__u64
 
	möode_èbÀ
;

543 
__u32
 
	mblocks_cou¡
;

544 
__u16
 
	mª£rved_blocks
;

545 
__u16
 
	munu£d
;

548 #i‡
deföed
(
__KERNEL__
Ë&& deföed(
CONFIG_COMPAT
)

549 
	scom∑t_pxt4_√w_group_öput
 {

550 
u32
 
	mgroup
;

551 
com∑t_u64
 
	mblock_bôm≠
;

552 
com∑t_u64
 
	möode_bôm≠
;

553 
com∑t_u64
 
	möode_èbÀ
;

554 
u32
 
	mblocks_cou¡
;

555 
u16
 
	mª£rved_blocks
;

556 
u16
 
	munu£d
;

561 
	spxt4_√w_group_d©a
 {

562 
__u32
 
	mgroup
;

563 
__u64
 
	mblock_bôm≠
;

564 
__u64
 
	möode_bôm≠
;

565 
__u64
 
	möode_èbÀ
;

566 
__u32
 
	mblocks_cou¡
;

567 
__u16
 
	mª£rved_blocks
;

568 
__u16
 
	mmd©a_blocks
;

569 
__u32
 
	m‰ì_˛u°îs_cou¡
;

574 
	mBLOCK_BITMAP
 = 0,

575 
	mINODE_BITMAP
,

576 
	mINODE_TABLE
,

577 
	mGROUP_TABLE_COUNT
,

585 
	#PXT4_GET_BLOCKS_CREATE
 0x0001

	)

587 
	#PXT4_GET_BLOCKS_UNWRIT_EXT
 0x0002

	)

588 
	#PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
 (
PXT4_GET_BLOCKS_UNWRIT_EXT
|\

589 
PXT4_GET_BLOCKS_CREATE
)

	)

592 
	#PXT4_GET_BLOCKS_DELALLOC_RESERVE
 0x0004

	)

596 
	#PXT4_GET_BLOCKS_PRE_IO
 0x0008

	)

597 
	#PXT4_GET_BLOCKS_CONVERT
 0x0010

	)

598 
	#PXT4_GET_BLOCKS_IO_CREATE_EXT
 (
PXT4_GET_BLOCKS_PRE_IO
|\

599 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
)

	)

601 
	#PXT4_GET_BLOCKS_IO_CONVERT_EXT
 (
PXT4_GET_BLOCKS_CONVERT
|\

602 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
)

	)

605 
	#PXT4_GET_BLOCKS_METADATA_NOFAIL
 0x0020

	)

607 
	#PXT4_GET_BLOCKS_NO_NORMALIZE
 0x0040

	)

609 
	#PXT4_GET_BLOCKS_KEEP_SIZE
 0x0080

	)

611 
	#PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
 0x0100

	)

613 
	#PXT4_GET_BLOCKS_ZERO
 0x0200

	)

614 
	#PXT4_GET_BLOCKS_CREATE_ZERO
 (
PXT4_GET_BLOCKS_CREATE
 |\

615 
PXT4_GET_BLOCKS_ZERO
)

	)

618 
	#PXT4_GET_BLOCKS_IO_SUBMIT
 0x0400

	)

629 
	#PXT4_EX_NOCACHE
 0x40000000

	)

630 
	#PXT4_EX_FORCE_CACHE
 0x20000000

	)

635 
	#PXT4_FREE_BLOCKS_METADATA
 0x0001

	)

636 
	#PXT4_FREE_BLOCKS_FORGET
 0x0002

	)

637 
	#PXT4_FREE_BLOCKS_VALIDATED
 0x0004

	)

638 
	#PXT4_FREE_BLOCKS_NO_QUOT_UPDATE
 0x0008

	)

639 
	#PXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
 0x0010

	)

640 
	#PXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
 0x0020

	)

641 
	#PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
 0x0040

	)

646 
	#PXT4_IOC_GETFLAGS
 
FS_IOC_GETFLAGS


	)

647 
	#PXT4_IOC_SETFLAGS
 
FS_IOC_SETFLAGS


	)

648 
	#PXT4_IOC_GETVERSION
 
	`_IOR
('f', 3, )

	)

649 
	#PXT4_IOC_SETVERSION
 
	`_IOW
('f', 4, )

	)

650 
	#PXT4_IOC_GETVERSION_OLD
 
FS_IOC_GETVERSION


	)

651 
	#PXT4_IOC_SETVERSION_OLD
 
FS_IOC_SETVERSION


	)

652 
	#PXT4_IOC_GETRSVSZ
 
	`_IOR
('f', 5, )

	)

653 
	#PXT4_IOC_SETRSVSZ
 
	`_IOW
('f', 6, )

	)

654 
	#PXT4_IOC_GROUP_EXTEND
 
	`_IOW
('f', 7, )

	)

655 
	#PXT4_IOC_GROUP_ADD
 
	`_IOW
('f', 8, 
pxt4_√w_group_öput
)

	)

656 
	#PXT4_IOC_MIGRATE
 
	`_IO
('f', 9)

	)

659 
	#PXT4_IOC_ALLOC_DA_BLKS
 
	`_IO
('f', 12)

	)

660 
	#PXT4_IOC_MOVE_EXT
 
	`_IOWR
('f', 15, 
move_exã¡
)

	)

661 
	#PXT4_IOC_RESIZE_FS
 
	`_IOW
('f', 16, 
__u64
)

	)

662 
	#PXT4_IOC_SWAP_BOOT
 
	`_IO
('f', 17)

	)

663 
	#PXT4_IOC_PRECACHE_EXTENTS
 
	`_IO
('f', 18)

	)

664 
	#PXT4_IOC_SET_ENCRYPTION_POLICY
 
FS_IOC_SET_ENCRYPTION_POLICY


	)

665 
	#PXT4_IOC_GET_ENCRYPTION_PWSALT
 
FS_IOC_GET_ENCRYPTION_PWSALT


	)

666 
	#PXT4_IOC_GET_ENCRYPTION_POLICY
 
FS_IOC_GET_ENCRYPTION_POLICY


	)

668 
	#PXT4_IOC_CLEAR_ES_CACHE
 
	`_IO
('f', 40)

	)

669 
	#PXT4_IOC_GETSTATE
 
	`_IOW
('f', 41, 
__u32
)

	)

670 
	#PXT4_IOC_GET_ES_CACHE
 
	`_IOWR
('f', 42, 
fõm≠
)

	)

672 
	#PXT4_IOC_FSGETXATTR
 
FS_IOC_FSGETXATTR


	)

673 
	#PXT4_IOC_FSSETXATTR
 
FS_IOC_FSSETXATTR


	)

675 
	#PXT4_IOC_SHUTDOWN
 
	`_IOR
 ('X', 125, 
__u32
)

	)

680 
	#PXT4_GOING_FLAGS_DEFAULT
 0x0

	)

681 
	#PXT4_GOING_FLAGS_LOGFLUSH
 0x1

	)

682 
	#PXT4_GOING_FLAGS_NOLOGFLUSH
 0x2

	)

690 
	#PXT4_STATE_FLAG_EXT_PRECACHED
 0x00000001

	)

691 
	#PXT4_STATE_FLAG_NEW
 0x00000002

	)

692 
	#PXT4_STATE_FLAG_NEWENTRY
 0x00000004

	)

693 
	#PXT4_STATE_FLAG_DA_ALLOC_CLOSE
 0x00000008

	)

695 #i‡
deföed
(
__KERNEL__
Ë&& deföed(
CONFIG_COMPAT
)

699 
	#PXT4_IOC32_GETFLAGS
 
FS_IOC32_GETFLAGS


	)

700 
	#PXT4_IOC32_SETFLAGS
 
FS_IOC32_SETFLAGS


	)

701 
	#PXT4_IOC32_GETVERSION
 
	`_IOR
('f', 3, )

	)

702 
	#PXT4_IOC32_SETVERSION
 
	`_IOW
('f', 4, )

	)

703 
	#PXT4_IOC32_GETRSVSZ
 
	`_IOR
('f', 5, )

	)

704 
	#PXT4_IOC32_SETRSVSZ
 
	`_IOW
('f', 6, )

	)

705 
	#PXT4_IOC32_GROUP_EXTEND
 
	`_IOW
('f', 7, )

	)

706 
	#PXT4_IOC32_GROUP_ADD
 
	`_IOW
('f', 8, 
com∑t_pxt4_√w_group_öput
)

	)

707 
	#PXT4_IOC32_GETVERSION_OLD
 
FS_IOC32_GETVERSION


	)

708 
	#PXT4_IOC32_SETVERSION_OLD
 
FS_IOC32_SETVERSION


	)

715 
	#PXT4_FIEMAP_EXTENT_HOLE
 0x08000000

	)

718 
	#PXT4_MAX_BLOCK_FILE_PHYS
 0xFFFFFFFF

	)

721 
	#PXT4_MAX_LOGICAL_BLOCK
 0xFFFFFFFF

	)

726 
	spxt4_öode
 {

727 
__À16
 
	mi_mode
;

728 
__À16
 
	mi_uid
;

729 
__À32
 
	mi_size_lo
;

730 
__À32
 
	mi_©ime
;

731 
__À32
 
	mi_˘ime
;

732 
__À32
 
	mi_mtime
;

733 
__À32
 
	mi_dtime
;

734 
__À16
 
	mi_gid
;

735 
__À16
 
	mi_löks_cou¡
;

736 
__À32
 
	mi_blocks_lo
;

737 
__À32
 
	mi_Êags
;

740 
__À32
 
	ml_i_vîsi⁄
;

741 } 
	mlöux1
;

743 
__u32
 
	mh_i_å™¶©‹
;

744 } 
	mhurd1
;

746 
__u32
 
	mm_i_ª£rved1
;

747 } 
	mmasix1
;

748 } 
	mosd1
;

749 
__À32
 
	mi_block
[
PXT4_N_BLOCKS
];

750 
__À32
 
	mi_gíî©i⁄
;

751 
__À32
 
	mi_fûe_a˛_lo
;

752 
__À32
 
	mi_size_high
;

753 
__À32
 
	mi_obso_Áddr
;

756 
__À16
 
	ml_i_blocks_high
;

757 
__À16
 
	ml_i_fûe_a˛_high
;

758 
__À16
 
	ml_i_uid_high
;

759 
__À16
 
	ml_i_gid_high
;

760 
__À16
 
	ml_i_checksum_lo
;

761 
__À16
 
	ml_i_ª£rved
;

762 } 
	mlöux2
;

764 
__À16
 
	mh_i_ª£rved1
;

765 
__u16
 
	mh_i_mode_high
;

766 
__u16
 
	mh_i_uid_high
;

767 
__u16
 
	mh_i_gid_high
;

768 
__u32
 
	mh_i_auth‹
;

769 } 
	mhurd2
;

771 
__À16
 
	mh_i_ª£rved1
;

772 
__À16
 
	mm_i_fûe_a˛_high
;

773 
__u32
 
	mm_i_ª£rved2
[2];

774 } 
	mmasix2
;

775 } 
	mosd2
;

776 
__À16
 
	mi_exåa_isize
;

777 
__À16
 
	mi_checksum_hi
;

778 
__À32
 
	mi_˘ime_exåa
;

779 
__À32
 
	mi_mtime_exåa
;

780 
__À32
 
	mi_©ime_exåa
;

781 
__À32
 
	mi_¸time
;

782 
__À32
 
	mi_¸time_exåa
;

783 
__À32
 
	mi_vîsi⁄_hi
;

784 
__À32
 
	mi_¥ojid
;

787 
	smove_exã¡
 {

788 
__u32
 
	mª£rved
;

789 
__u32
 
	md⁄‹_fd
;

790 
__u64
 
	m‹ig_°¨t
;

791 
__u64
 
	md⁄‹_°¨t
;

792 
__u64
 
	mÀn
;

793 
__u64
 
	mmoved_Àn
;

796 
	#PXT4_EPOCH_BITS
 2

	)

797 
	#PXT4_EPOCH_MASK
 ((1 << 
PXT4_EPOCH_BITS
Ë- 1)

	)

798 
	#PXT4_NSEC_MASK
 (~0UL << 
PXT4_EPOCH_BITS
)

	)

810 
	#PXT4_FITS_IN_INODE
(
pxt4_öode
, 
eöode
, 
fõld
) \

811 ((
	`off£tof
(
	`ty≥of
(*
pxt4_öode
), 
fõld
) + \

812 ((
pxt4_öode
)->
fõld
)) \

813 <(
PXT4_GOOD_OLD_INODE_SIZE
 + \

814 (
eöode
)->
i_exåa_isize
)) \

815 

	)

837 
ölöe
 
__À32
 
	$pxt4_ícode_exåa_time
(
time•ec64
 *
time
)

839 
u32
 
exåa
 =((
time
->
tv_£c
 - (
s32
Èime->tv_£cË>> 32Ë& 
PXT4_EPOCH_MASK
;

840  
	`˝u_to_À32
(
exåa
 | (
time
->
tv_n£c
 << 
PXT4_EPOCH_BITS
));

841 
	}
}

843 
ölöe
 
	$pxt4_decode_exåa_time
(
time•ec64
 *
time
,

844 
__À32
 
exåa
)

846 i‡(
	`u∆ikñy
(
exåa
 & 
	`˝u_to_À32
(
PXT4_EPOCH_MASK
)))

847 
time
->
tv_£c
 +(
u64
)(
	`À32_to_˝u
(
exåa
Ë& 
PXT4_EPOCH_MASK
) << 32;

848 
time
->
tv_n£c
 = (
	`À32_to_˝u
(
exåa
Ë& 
PXT4_NSEC_MASK
Ë>> 
PXT4_EPOCH_BITS
;

849 
	}
}

851 
	#PXT4_INODE_SET_XTIME
(
xtime
, 
öode
, 
øw_öode
) \

853 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
	`PXT4_I
(
öode
), 
xtime
 ## 
_exåa
)) {\

854 (
øw_öode
)->
xtime
 = 
	`˝u_to_À32
((
öode
)->xtime.
tv_£c
); \

855 (
øw_öode
)->
xtime
 ## 
_exåa
 = \

856 
	`pxt4_ícode_exåa_time
(&(
öode
)->
xtime
); \

859 (
øw_öode
)->
xtime
 = 
	`˝u_to_À32
(
	`˛amp_t
(
öt32_t
, (
öode
)->xtime.
tv_£c
, 
S32_MIN
, 
S32_MAX
)); \

860 } 0)

	)

862 
	#PXT4_EINODE_SET_XTIME
(
xtime
, 
eöode
, 
øw_öode
) \

864 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
)) \

865 (
øw_öode
)->
xtime
 = 
	`˝u_to_À32
((
eöode
)->xtime.
tv_£c
); \

866 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
 ## 
_exåa
)) \

867 (
øw_öode
)->
xtime
 ## 
_exåa
 = \

868 
	`pxt4_ícode_exåa_time
(&(
eöode
)->
xtime
); \

869 } 0)

	)

871 
	#PXT4_INODE_GET_XTIME
(
xtime
, 
öode
, 
øw_öode
) \

873 (
öode
)->
xtime
.
tv_£c
 = (sig√d)
	`À32_to_˝u
((
øw_öode
)->xtime); \

874 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
	`PXT4_I
(
öode
), 
xtime
 ## 
_exåa
)) { \

875 
	`pxt4_decode_exåa_time
(&(
öode
)->
xtime
, \

876 
øw_öode
->
xtime
 ## 
_exåa
); \

879 (
öode
)->
xtime
.
tv_n£c
 = 0; \

880 } 0)

	)

883 
	#PXT4_EINODE_GET_XTIME
(
xtime
, 
eöode
, 
øw_öode
) \

885 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
)) \

886 (
eöode
)->
xtime
.
tv_£c
 = \

887 (sig√d)
	`À32_to_˝u
((
øw_öode
)->
xtime
); \

889 (
eöode
)->
xtime
.
tv_£c
 = 0; \

890 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
 ## 
_exåa
)) \

891 
	`pxt4_decode_exåa_time
(&(
eöode
)->
xtime
, \

892 
øw_öode
->
xtime
 ## 
_exåa
); \

894 (
eöode
)->
xtime
.
tv_n£c
 = 0; \

895 } 0)

	)

897 
	#i_disk_vîsi⁄
 
osd1
.
löux1
.
l_i_vîsi⁄


	)

899 #i‡
deföed
(
__KERNEL__
Ë|| deföed(
__löux__
)

900 
	#i_ª£rved1
 
osd1
.
löux1
.
l_i_ª£rved1


	)

901 
	#i_fûe_a˛_high
 
osd2
.
löux2
.
l_i_fûe_a˛_high


	)

902 
	#i_blocks_high
 
osd2
.
löux2
.
l_i_blocks_high


	)

903 
	#i_uid_low
 
i_uid


	)

904 
	#i_gid_low
 
i_gid


	)

905 
	#i_uid_high
 
osd2
.
löux2
.
l_i_uid_high


	)

906 
	#i_gid_high
 
osd2
.
löux2
.
l_i_gid_high


	)

907 
	#i_checksum_lo
 
osd2
.
löux2
.
l_i_checksum_lo


	)

909 #ñi‡
deföed
(
__GNU__
)

911 
	#i_å™¶©‹
 
osd1
.
hurd1
.
h_i_å™¶©‹


	)

912 
	#i_uid_high
 
osd2
.
hurd2
.
h_i_uid_high


	)

913 
	#i_gid_high
 
osd2
.
hurd2
.
h_i_gid_high


	)

914 
	#i_auth‹
 
osd2
.
hurd2
.
h_i_auth‹


	)

916 #ñi‡
deföed
(
__masix__
)

918 
	#i_ª£rved1
 
osd1
.
masix1
.
m_i_ª£rved1


	)

919 
	#i_fûe_a˛_high
 
osd2
.
masix2
.
m_i_fûe_a˛_high


	)

920 
	#i_ª£rved2
 
osd2
.
masix2
.
m_i_ª£rved2


	)

924 
	~"exã¡s_°©us.h
"

943 
	mI_DATA_SEM_NORMAL
 = 0,

944 
	mI_DATA_SEM_OTHER
,

945 
	mI_DATA_SEM_QUOTA
,

952 
	spxt4_öode_öfo
 {

953 
__À32
 
	mi_d©a
[15];

954 
__u32
 
	mi_dtime
;

955 
pxt4_fsblk_t
 
	mi_fûe_a˛
;

964 
pxt4_group_t
 
	mi_block_group
;

965 
pxt4_lblk_t
 
	mi_dú_°¨t_lookup
;

966 #i‡(
BITS_PER_LONG
 < 64)

967 
	mi_°©e_Êags
;

969 
	mi_Êags
;

978 
rw_£m≠h‹e
 
	mx©å_£m
;

980 
li°_hód
 
	mi_‹ph™
;

997 
loff_t
 
	mi_disksize
;

1009 
rw_£m≠h‹e
 
	mi_d©a_£m
;

1018 
rw_£m≠h‹e
 
	mi_mm≠_£m
;

1019 
öode
 
	mvfs_öode
;

1020 
jbd3_öode
 *
	mjöode
;

1022 
•ölock_t
 
	mi_øw_lock
;

1028 
time•ec64
 
	mi_¸time
;

1031 
li°_hód
 
	mi_¥óŒoc_li°
;

1032 
•ölock_t
 
	mi_¥óŒoc_lock
;

1035 
pxt4_es_åì
 
	mi_es_åì
;

1036 
rwlock_t
 
	mi_es_lock
;

1037 
li°_hód
 
	mi_es_li°
;

1038 
	mi_es_Æl_ƒ
;

1039 
	mi_es_shk_ƒ
;

1040 
pxt4_lblk_t
 
	mi_es_shrök_lblk
;

1045 
pxt4_group_t
 
	mi_œ°_Æloc_group
;

1049 
	mi_ª£rved_d©a_blocks
;

1050 
pxt4_lblk_t
 
	mi_da_mëad©a_ˇlc_œ°_lblock
;

1051 
	mi_da_mëad©a_ˇlc_Àn
;

1054 
pxt4_≥ndög_åì
 
	mi_≥ndög_åì
;

1057 
__u16
 
	mi_exåa_isize
;

1060 
u16
 
	mi_ölöe_off
;

1061 
u16
 
	mi_ölöe_size
;

1063 #ifde‡
CONFIG_QUOTA


1065 
qsize_t
 
	mi_ª£rved_quŸa
;

1069 
•ölock_t
 
	mi_com∂ëed_io_lock
;

1074 
li°_hód
 
	mi_rsv_c⁄vîsi⁄_li°
;

1075 
w‹k_°ru˘
 
	mi_rsv_c⁄vîsi⁄_w‹k
;

1076 
©omic_t
 
	mi_unwrôãn
;

1078 
•ölock_t
 
	mi_block_ª£rv©i⁄_lock
;

1084 
tid_t
 
	mi_sync_tid
;

1085 
tid_t
 
	mi_d©async_tid
;

1087 #ifde‡
CONFIG_QUOTA


1088 
dquŸ
 *
	mi_dquŸ
[
MAXQUOTAS
];

1092 
__u32
 
	mi_csum_£ed
;

1094 
k¥ojid_t
 
	mi_¥ojid
;

1100 
	#PXT4_VALID_FS
 0x0001

	)

1101 
	#PXT4_ERROR_FS
 0x0002

	)

1102 
	#PXT4_ORPHAN_FS
 0x0004

	)

1107 
	#PXT2_FLAGS_SIGNED_HASH
 0x0001

	)

1108 
	#PXT2_FLAGS_UNSIGNED_HASH
 0x0002

	)

1109 
	#PXT2_FLAGS_TEST_FILESYS
 0x0004

	)

1114 
	#PXT4_MOUNT_NO_MBCACHE
 0x00001

	)

1115 
	#PXT4_MOUNT_GRPID
 0x00004

	)

1116 
	#PXT4_MOUNT_DEBUG
 0x00008

	)

1117 
	#PXT4_MOUNT_ERRORS_CONT
 0x00010

	)

1118 
	#PXT4_MOUNT_ERRORS_RO
 0x00020

	)

1119 
	#PXT4_MOUNT_ERRORS_PANIC
 0x00040

	)

1120 
	#PXT4_MOUNT_ERRORS_MASK
 0x00070

	)

1121 
	#PXT4_MOUNT_MINIX_DF
 0x00080

	)

1122 
	#PXT4_MOUNT_NOLOAD
 0x00100

	)

1123 #ifde‡
CONFIG_FS_DAX


1124 
	#PXT4_MOUNT_DAX
 0x00200

	)

1126 
	#PXT4_MOUNT_DAX
 0

	)

1128 
	#PXT4_MOUNT_DATA_FLAGS
 0x00C00

	)

1129 
	#PXT4_MOUNT_JOURNAL_DATA
 0x00400

	)

1130 
	#PXT4_MOUNT_ORDERED_DATA
 0x00800

	)

1131 
	#PXT4_MOUNT_WRITEBACK_DATA
 0x00C00

	)

1132 
	#PXT4_MOUNT_UPDATE_JOURNAL
 0x01000

	)

1133 
	#PXT4_MOUNT_NO_UID32
 0x02000

	)

1134 
	#PXT4_MOUNT_XATTR_USER
 0x04000

	)

1135 
	#PXT4_MOUNT_POSIX_ACL
 0x08000

	)

1136 
	#PXT4_MOUNT_NO_AUTO_DA_ALLOC
 0x10000

	)

1137 
	#PXT4_MOUNT_BARRIER
 0x20000

	)

1138 
	#PXT4_MOUNT_QUOTA
 0x40000

	)

1139 
	#PXT4_MOUNT_USRQUOTA
 0x80000

	)

1142 
	#PXT4_MOUNT_GRPQUOTA
 0x100000

	)

1145 
	#PXT4_MOUNT_PRJQUOTA
 0x200000

	)

1147 
	#PXT4_MOUNT_DIOREAD_NOLOCK
 0x400000

	)

1148 
	#PXT4_MOUNT_JOURNAL_CHECKSUM
 0x800000

	)

1149 
	#PXT4_MOUNT_JOURNAL_ASYNC_COMMIT
 0x1000000

	)

1150 
	#PXT4_MOUNT_WARN_ON_ERROR
 0x2000000

	)

1151 
	#PXT4_MOUNT_DELALLOC
 0x8000000

	)

1152 
	#PXT4_MOUNT_DATA_ERR_ABORT
 0x10000000

	)

1153 
	#PXT4_MOUNT_BLOCK_VALIDITY
 0x20000000

	)

1154 
	#PXT4_MOUNT_DISCARD
 0x40000000

	)

1155 
	#PXT4_MOUNT_INIT_INODE_TABLE
 0x80000000

	)

1162 
	#PXT4_MOUNT2_EXPLICIT_DELALLOC
 0x00000001

	)

1164 
	#PXT4_MOUNT2_STD_GROUP_SIZE
 0x00000002

	)

1167 
	#PXT4_MOUNT2_HURD_COMPAT
 0x00000004

	)

1170 
	#PXT4_MOUNT2_EXPLICIT_JOURNAL_CHECKSUM
 0x00000008

	)

1173 
	#˛ór_›t
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t
 &= \

1174 ~
PXT4_MOUNT_
##
›t


	)

1175 
	#£t_›t
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t
 |= \

1176 
PXT4_MOUNT_
##
›t


	)

1177 
	#ã°_›t
(
sb
, 
›t
Ë(
	`PXT4_SB
(sb)->
s_mou¡_›t
 & \

1178 
PXT4_MOUNT_
##
›t
)

	)

1180 
	#˛ór_›t2
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t2
 &= \

1181 ~
PXT4_MOUNT2_
##
›t


	)

1182 
	#£t_›t2
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t2
 |= \

1183 
PXT4_MOUNT2_
##
›t


	)

1184 
	#ã°_›t2
(
sb
, 
›t
Ë(
	`PXT4_SB
(sb)->
s_mou¡_›t2
 & \

1185 
PXT4_MOUNT2_
##
›t
)

	)

1187 
	#pxt4_ã°_™d_£t_bô
 
__ã°_™d_£t_bô_À


	)

1188 
	#pxt4_£t_bô
 
__£t_bô_À


	)

1189 
	#pxt4_£t_bô_©omic
 
pxt2_£t_bô_©omic


	)

1190 
	#pxt4_ã°_™d_˛ór_bô
 
__ã°_™d_˛ór_bô_À


	)

1191 
	#pxt4_˛ór_bô
 
__˛ór_bô_À


	)

1192 
	#pxt4_˛ór_bô_©omic
 
pxt2_˛ór_bô_©omic


	)

1193 
	#pxt4_ã°_bô
 
ã°_bô_À


	)

1194 
	#pxt4_föd_√xt_zîo_bô
 
föd_√xt_zîo_bô_À


	)

1195 
	#pxt4_föd_√xt_bô
 
föd_√xt_bô_À


	)

1197 
pxt4_£t_bôs
(*
bm
, 
cur
, 
Àn
);

1202 
	#PXT4_DFL_MAX_MNT_COUNT
 20

	)

1203 
	#PXT4_DFL_CHECKINTERVAL
 0

	)

1208 
	#PXT4_ERRORS_CONTINUE
 1

	)

1209 
	#PXT4_ERRORS_RO
 2

	)

1210 
	#PXT4_ERRORS_PANIC
 3

	)

1211 
	#PXT4_ERRORS_DEFAULT
 
PXT4_ERRORS_CONTINUE


	)

1214 
	#PXT4_CRC32C_CHKSUM
 1

	)

1219 
	spxt4_su≥r_block
 {

1220  
__À32
 
	ms_öodes_cou¡
;

1221 
__À32
 
	ms_blocks_cou¡_lo
;

1222 
__À32
 
	ms_r_blocks_cou¡_lo
;

1223 
__À32
 
	ms_‰ì_blocks_cou¡_lo
;

1224  
__À32
 
	ms_‰ì_öodes_cou¡
;

1225 
__À32
 
	ms_fú°_d©a_block
;

1226 
__À32
 
	ms_log_block_size
;

1227 
__À32
 
	ms_log_˛u°î_size
;

1228  
__À32
 
	ms_blocks_≥r_group
;

1229 
__À32
 
	ms_˛u°îs_≥r_group
;

1230 
__À32
 
	ms_öodes_≥r_group
;

1231 
__À32
 
	ms_mtime
;

1232  
__À32
 
	ms_wtime
;

1233 
__À16
 
	ms_m¡_cou¡
;

1234 
__À16
 
	ms_max_m¡_cou¡
;

1235 
__À16
 
	ms_magic
;

1236 
__À16
 
	ms_°©e
;

1237 
__À16
 
	ms_îr‹s
;

1238 
__À16
 
	ms_mö‹_ªv_Àvñ
;

1239  
__À32
 
	ms_œ°check
;

1240 
__À32
 
	ms_checköãrvÆ
;

1241 
__À32
 
	ms_¸ót‹_os
;

1242 
__À32
 
	ms_ªv_Àvñ
;

1243  
__À16
 
	ms_def_ªsuid
;

1244 
__À16
 
	ms_def_ªsgid
;

1258 
__À32
 
	ms_fú°_öo
;

1259 
__À16
 
	ms_öode_size
;

1260 
__À16
 
	ms_block_group_ƒ
;

1261 
__À32
 
	ms_„©uª_com∑t
;

1262  
__À32
 
	ms_„©uª_öcom∑t
;

1263 
__À32
 
	ms_„©uª_ro_com∑t
;

1264  
__u8
 
	ms_uuid
[16];

1265  
	ms_vﬁume_«me
[16];

1266  
	ms_œ°_mou¡ed
[64] 
	m__n⁄°rög
;

1267  
__À32
 
	ms_Æg‹ôhm_ußge_bôm≠
;

1272 
__u8
 
	ms_¥óŒoc_blocks
;

1273 
__u8
 
	ms_¥óŒoc_dú_blocks
;

1274 
__À16
 
	ms_ª£rved_gdt_blocks
;

1278  
__u8
 
	ms_jou∫Æ_uuid
[16];

1279  
__À32
 
	ms_jou∫Æ_öum
;

1280 
__À32
 
	ms_jou∫Æ_dev
;

1281 
__À32
 
	ms_œ°_‹ph™
;

1282 
__À32
 
	ms_hash_£ed
[4];

1283 
__u8
 
	ms_def_hash_vîsi⁄
;

1284 
__u8
 
	ms_j∆_backup_ty≥
;

1285 
__À16
 
	ms_desc_size
;

1286  
__À32
 
	ms_deÁu…_mou¡_›ts
;

1287 
__À32
 
	ms_fú°_mëa_bg
;

1288 
__À32
 
	ms_mkfs_time
;

1289 
__À32
 
	ms_j∆_blocks
[17];

1291  
__À32
 
	ms_blocks_cou¡_hi
;

1292 
__À32
 
	ms_r_blocks_cou¡_hi
;

1293 
__À32
 
	ms_‰ì_blocks_cou¡_hi
;

1294 
__À16
 
	ms_mö_exåa_isize
;

1295 
__À16
 
	ms_w™t_exåa_isize
;

1296 
__À32
 
	ms_Êags
;

1297 
__À16
 
	ms_øid_°ride
;

1298 
__À16
 
	ms_mmp_upd©e_öãrvÆ
;

1299 
__À64
 
	ms_mmp_block
;

1300 
__À32
 
	ms_øid_°rùe_width
;

1301 
__u8
 
	ms_log_groups_≥r_Êex
;

1302 
__u8
 
	ms_checksum_ty≥
;

1303 
__u8
 
	ms_í¸y±i⁄_Àvñ
;

1304 
__u8
 
	ms_ª£rved_∑d
;

1305 
__À64
 
	ms_kbyãs_wrôãn
;

1306 
__À32
 
	ms_¢≠shŸ_öum
;

1307 
__À32
 
	ms_¢≠shŸ_id
;

1308 
__À64
 
	ms_¢≠shŸ_r_blocks_cou¡
;

1310 
__À32
 
	ms_¢≠shŸ_li°
;

1312 
	#PXT4_S_ERR_START
 
	`off£tof
(
pxt4_su≥r_block
, 
s_îr‹_cou¡
)

	)

1313 
__À32
 
	ms_îr‹_cou¡
;

1314 
__À32
 
	ms_fú°_îr‹_time
;

1315 
__À32
 
	ms_fú°_îr‹_öo
;

1316 
__À64
 
	ms_fú°_îr‹_block
;

1317 
__u8
 
	ms_fú°_îr‹_func
[32] 
	m__n⁄°rög
;

1318 
__À32
 
	ms_fú°_îr‹_löe
;

1319 
__À32
 
	ms_œ°_îr‹_time
;

1320 
__À32
 
	ms_œ°_îr‹_öo
;

1321 
__À32
 
	ms_œ°_îr‹_löe
;

1322 
__À64
 
	ms_œ°_îr‹_block
;

1323 
__u8
 
	ms_œ°_îr‹_func
[32] 
	m__n⁄°rög
;

1324 
	#PXT4_S_ERR_END
 
	`off£tof
(
pxt4_su≥r_block
, 
s_mou¡_›ts
)

	)

1325 
__u8
 
	ms_mou¡_›ts
[64];

1326 
__À32
 
	ms_u§_quŸa_öum
;

1327 
__À32
 
	ms_gΩ_quŸa_öum
;

1328 
__À32
 
	ms_ovîhód_˛u°îs
;

1329 
__À32
 
	ms_backup_bgs
[2];

1330 
__u8
 
	ms_í¸y±_Ægos
[4];

1331 
__u8
 
	ms_í¸y±_pw_ß…
[16];

1332 
__À32
 
	ms_Õf_öo
;

1333 
__À32
 
	ms_¥j_quŸa_öum
;

1334 
__À32
 
	ms_checksum_£ed
;

1335 
__u8
 
	ms_wtime_hi
;

1336 
__u8
 
	ms_mtime_hi
;

1337 
__u8
 
	ms_mkfs_time_hi
;

1338 
__u8
 
	ms_œ°check_hi
;

1339 
__u8
 
	ms_fú°_îr‹_time_hi
;

1340 
__u8
 
	ms_œ°_îr‹_time_hi
;

1341 
__u8
 
	ms_∑d
[2];

1342 
__À16
 
	ms_ícodög
;

1343 
__À16
 
	ms_ícodög_Êags
;

1344 
__À32
 
	ms_ª£rved
[95];

1345 
__À32
 
	ms_checksum
;

1348 
	#PXT4_S_ERR_LEN
 (
PXT4_S_ERR_END
 - 
PXT4_S_ERR_START
)

	)

1350 #ifde‡
__KERNEL__


1355 
	#PXT4_MF_MNTDIR_SAMPLED
 0x0001

	)

1356 
	#PXT4_MF_FS_ABORTED
 0x0002

	)

1357 
	#PXT4_MF_TEST_DUMMY_ENCRYPTION
 0x0004

	)

1359 #ifde‡
CONFIG_FS_ENCRYPTION


1360 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë(
	`u∆ikñy
((sbi)->
s_mou¡_Êags
 & \

1361 
PXT4_MF_TEST_DUMMY_ENCRYPTION
))

	)

1363 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë(0)

	)

1367 
	#PXT4_MAXQUOTAS
 3

	)

1369 
	#PXT4_ENC_UTF8_12_1
 1

	)

1374 
	#PXT4_ENC_STRICT_MODE_FL
 (1 << 0)

	)

1376 
	#pxt4_has_°ri˘_mode
(
sbi
) \

1377 (
sbi
->
s_ícodög_Êags
 & 
PXT4_ENC_STRICT_MODE_FL
)

	)

1382 
	spxt4_sb_öfo
 {

1383 
	ms_desc_size
;

1384 
	ms_öodes_≥r_block
;

1385 
	ms_blocks_≥r_group
;

1386 
	ms_˛u°îs_≥r_group
;

1387 
	ms_öodes_≥r_group
;

1388 
	ms_ôb_≥r_group
;

1389 
	ms_gdb_cou¡
;

1390 
	ms_desc_≥r_block
;

1391 
pxt4_group_t
 
	ms_groups_cou¡
;

1392 
pxt4_group_t
 
	ms_blockfûe_groups
;

1393 
	ms_ovîhód
;

1394 
	ms_˛u°î_øtio
;

1395 
	ms_˛u°î_bôs
;

1396 
loff_t
 
	ms_bôm≠_maxbyãs
;

1397 
buf„r_hód
 * 
	ms_sbh
;

1398 
pxt4_su≥r_block
 *
	ms_es
;

1399 
buf„r_hód
 **
	ms_group_desc
;

1400 
	ms_mou¡_›t
;

1401 
	ms_mou¡_›t2
;

1402 
	ms_mou¡_Êags
;

1403 
	ms_def_mou¡_›t
;

1404 
pxt4_fsblk_t
 
	ms_sb_block
;

1405 
©omic64_t
 
	ms_ªsv_˛u°îs
;

1406 
kuid_t
 
	ms_ªsuid
;

1407 
kgid_t
 
	ms_ªsgid
;

1408 
	ms_mou¡_°©e
;

1409 
	ms_∑d
;

1410 
	ms_addr_≥r_block_bôs
;

1411 
	ms_desc_≥r_block_bôs
;

1412 
	ms_öode_size
;

1413 
	ms_fú°_öo
;

1414 
	ms_öode_ªadahód_blks
;

1415 
	ms_öode_gﬂl
;

1416 
u32
 
	ms_hash_£ed
[4];

1417 
	ms_def_hash_vîsi⁄
;

1418 
	ms_hash_unsig√d
;

1419 
≥r˝u_cou¡î
 
	ms_‰ì˛u°îs_cou¡î
;

1420 
≥r˝u_cou¡î
 
	ms_‰ìöodes_cou¡î
;

1421 
≥r˝u_cou¡î
 
	ms_dús_cou¡î
;

1422 
≥r˝u_cou¡î
 
	ms_dúty˛u°îs_cou¡î
;

1423 
blockgroup_lock
 *
	ms_blockgroup_lock
;

1424 
¥oc_dú_íåy
 *
	ms_¥oc
;

1425 
kobje˘
 
	ms_kobj
;

1426 
com∂ëi⁄
 
	ms_kobj_uƒegi°î
;

1427 
su≥r_block
 *
	ms_sb
;

1428 #ifde‡
CONFIG_UNICODE


1429 
unicode_m≠
 *
	ms_ícodög
;

1430 
__u16
 
	ms_ícodög_Êags
;

1434 
jou∫Æ_s
 *
	ms_jou∫Æ
;

1435 
li°_hód
 
	ms_‹ph™
;

1436 
muãx
 
	ms_‹ph™_lock
;

1437 
	ms_pxt4_Êags
;

1438 
	ms_commô_öãrvÆ
;

1439 
u32
 
	ms_max_b©ch_time
;

1440 
u32
 
	ms_mö_b©ch_time
;

1441 
block_devi˚
 *
	mjou∫Æ_bdev
;

1442 #ifde‡
CONFIG_QUOTA


1444 
__rcu
 *
	ms_qf_«mes
[
PXT4_MAXQUOTAS
];

1445 
	ms_jquŸa_fmt
;

1447 
	ms_w™t_exåa_isize
;

1448 
pxt4_sy°em_blocks
 
__rcu
 *
	msy°em_blks
;

1450 #ifde‡
EXTENTS_STATS


1452 
	ms_ext_mö
;

1453 
	ms_ext_max
;

1454 
	ms_dïth_max
;

1455 
•ölock_t
 
	ms_ext_°©s_lock
;

1456 
	ms_ext_blocks
;

1457 
	ms_ext_exã¡s
;

1461 
pxt4_group_öfo
 ***
	ms_group_öfo
;

1462 
öode
 *
	ms_buddy_ˇche
;

1463 
•ölock_t
 
	ms_md_lock
;

1464 *
	ms_mb_off£ts
;

1465 *
	ms_mb_maxs
;

1466 
	ms_group_öfo_size
;

1467 
	ms_mb_‰ì_≥ndög
;

1468 
li°_hód
 
	ms_‰ìd_d©a_li°
;

1472 
	ms_°rùe
;

1473 
	ms_mb_°ªam_ªque°
;

1474 
	ms_mb_max_to_sˇn
;

1475 
	ms_mb_mö_to_sˇn
;

1476 
	ms_mb_°©s
;

1477 
	ms_mb_‹dî2_ªqs
;

1478 
	ms_mb_group_¥óŒoc
;

1479 
	ms_max_dú_size_kb
;

1481 
	ms_mb_œ°_group
;

1482 
	ms_mb_œ°_°¨t
;

1485 
©omic_t
 
	ms_bÆ_ªqs
;

1486 
©omic_t
 
	ms_bÆ_suc˚ss
;

1487 
©omic_t
 
	ms_bÆ_Æloˇãd
;

1488 
©omic_t
 
	ms_bÆ_ex_sˇ¬ed
;

1489 
©omic_t
 
	ms_bÆ_gﬂls
;

1490 
©omic_t
 
	ms_bÆ_bªaks
;

1491 
©omic_t
 
	ms_bÆ_2‹dîs
;

1492 
•ölock_t
 
	ms_bÆ_lock
;

1493 
	ms_mb_buddõs_gíî©ed
;

1494 
	ms_mb_gíî©i⁄_time
;

1495 
©omic_t
 
	ms_mb_lo°_chunks
;

1496 
©omic_t
 
	ms_mb_¥óŒoˇãd
;

1497 
©omic_t
 
	ms_mb_disˇrded
;

1498 
©omic_t
 
	ms_lock_busy
;

1501 
pxt4_loˇlôy_group
 
__≥r˝u
 *
	ms_loˇlôy_groups
;

1504 
	ms_£˘‹s_wrôãn_°¨t
;

1505 
u64
 
	ms_kbyãs_wrôãn
;

1508 
	ms_exã¡_max_zîoout_kb
;

1510 
	ms_log_groups_≥r_Êex
;

1511 
Êex_groups
 *
	ms_Êex_groups
;

1512 
pxt4_group_t
 
	ms_Êex_groups_Æloˇãd
;

1515 
w‹kqueue_°ru˘
 *
	mrsv_c⁄vîsi⁄_wq
;

1518 
timî_li°
 
	ms_îr_ªp‹t
;

1521 
pxt4_li_ªque°
 *
	ms_li_ªque°
;

1523 
	ms_li_waô_mu…
;

1526 
èsk_°ru˘
 *
	ms_mmp_tsk
;

1529 
©omic_t
 
	ms_œ°_åim_möblks
;

1532 
¸y±o_shash
 *
	ms_chksum_drivî
;

1535 
__u32
 
	ms_csum_£ed
;

1538 
shrökî
 
	ms_es_shrökî
;

1539 
li°_hód
 
	ms_es_li°
;

1540 
	ms_es_ƒ_öode
;

1541 
pxt4_es_°©s
 
	ms_es_°©s
;

1542 
mb_ˇche
 *
	ms_ó_block_ˇche
;

1543 
mb_ˇche
 *
	ms_ó_öode_ˇche
;

1544 
•ölock_t
 
s_es_lock
 
	m____ˇchñöe_Æig√d_ö_smp
;

1547 
øãlimô_°©e
 
	ms_îr_øãlimô_°©e
;

1548 
øãlimô_°©e
 
	ms_w¨nög_øãlimô_°©e
;

1549 
øãlimô_°©e
 
	ms_msg_øãlimô_°©e
;

1552 
≥r˝u_rw_£m≠h‹e
 
	ms_jou∫Æ_Êag_rw£m
;

1553 
dax_devi˚
 *
	ms_daxdev
;

1556 
ölöe
 
pxt4_sb_öfo
 *
	$PXT4_SB
(
su≥r_block
 *
sb
)

1558  
sb
->
s_fs_öfo
;

1559 
	}
}

1560 
ölöe
 
pxt4_öode_öfo
 *
	$PXT4_I
(
öode
 *inode)

1562  
	`c⁄èöî_of
(
öode
, 
pxt4_öode_öfo
, 
vfs_öode
);

1563 
	}
}

1565 
ölöe
 
	$pxt4_vÆid_öum
(
su≥r_block
 *
sb
, 
öo
)

1567  
öo
 =
PXT4_ROOT_INO
 ||

1568 (
öo
 >
	`PXT4_FIRST_INO
(
sb
) &&

1569 
öo
 <
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
));

1570 
	}
}

1576 
	mPXT4_STATE_JDATA
,

1577 
	mPXT4_STATE_NEW
,

1578 
	mPXT4_STATE_XATTR
,

1579 
	mPXT4_STATE_NO_EXPAND
,

1580 
	mPXT4_STATE_DA_ALLOC_CLOSE
,

1581 
	mPXT4_STATE_EXT_MIGRATE
,

1582 
	mPXT4_STATE_DIO_UNWRITTEN
,

1583 
	mPXT4_STATE_NEWENTRY
,

1584 
	mPXT4_STATE_MAY_INLINE_DATA
,

1585 
	mPXT4_STATE_EXT_PRECACHED
,

1586 
	mPXT4_STATE_LUSTRE_EA_INODE
,

1587 
	mPXT4_STATE_VERITY_IN_PROGRESS
,

1590 
	#PXT4_INODE_BIT_FNS
(
«me
, 
fõld
, 
off£t
) \

1591 
ölöe
 
pxt4_ã°_öode_
##
	`«me
(
öode
 *öode, 
bô
) \

1593  
	`ã°_bô
(
bô
 + (
off£t
), &
	`PXT4_I
(
öode
)->
i_
##
fõld
); \

1595 
ölöe
 
pxt4_£t_öode_
##
	`«me
(
öode
 *öode, 
bô
) \

1597 
	`£t_bô
(
bô
 + (
off£t
), &
	`PXT4_I
(
öode
)->
i_
##
fõld
); \

1599 
ölöe
 
pxt4_˛ór_öode_
##
	`«me
(
öode
 *öode, 
bô
) \

1601 
	`˛ór_bô
(
bô
 + (
off£t
), &
	`PXT4_I
(
öode
)->
i_
##
fõld
); \

1602 }

	)

1606 
ölöe
 
pxt4_ã°_öode_Êag
(
öode
 *öode, 
bô
);

1607 
ölöe
 
pxt4_£t_öode_Êag
(
öode
 *öode, 
bô
);

1608 
ölöe
 
pxt4_˛ór_öode_Êag
(
öode
 *öode, 
bô
);

1609 
	$PXT4_INODE_BIT_FNS
(
Êag
, 
Êags
, 0)

1613 
ölöe
 
	`pxt4_ã°_öode_°©e
(
öode
 *öode, 
bô
);

1614 
ölöe
 
	`pxt4_£t_öode_°©e
(
öode
 *öode, 
bô
);

1615 
ölöe
 
	`pxt4_˛ór_öode_°©e
(
öode
 *öode, 
bô
);

1616 #i‡(
BITS_PER_LONG
 < 64)

1617 
	$PXT4_INODE_BIT_FNS
(
°©e
, 
°©e_Êags
, 0)

1619 
ölöe
 
	$pxt4_˛ór_°©e_Êags
(
pxt4_öode_öfo
 *
ei
)

1621 (
ei
)->
i_°©e_Êags
 = 0;

1622 
	}
}

1624 
	$PXT4_INODE_BIT_FNS
(
°©e
, 
Êags
, 32)

1626 
ölöe
 
	$pxt4_˛ór_°©e_Êags
(
pxt4_öode_öfo
 *
ei
)

1629 
	}
}

1635 
	#PXT4_SB
(
sb
Ë(sb)

	)

1638 
ölöe
 
boﬁ
 
	$pxt4_vîôy_ö_¥ogªss
(
öode
 *inode)

1640  
	`IS_ENABLED
(
CONFIG_FS_VERITY
) &&

1641 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_VERITY_IN_PROGRESS
);

1642 
	}
}

1644 
	#NEXT_ORPHAN
(
öode
Ë
	`PXT4_I
(öode)->
i_dtime


	)

1649 
	#PXT4_OS_LINUX
 0

	)

1650 
	#PXT4_OS_HURD
 1

	)

1651 
	#PXT4_OS_MASIX
 2

	)

1652 
	#PXT4_OS_FREEBSD
 3

	)

1653 
	#PXT4_OS_LITES
 4

	)

1658 
	#PXT4_GOOD_OLD_REV
 0

	)

1659 
	#PXT4_DYNAMIC_REV
 1

	)

1661 
	#PXT4_CURRENT_REV
 
PXT4_GOOD_OLD_REV


	)

1662 
	#PXT4_MAX_SUPP_REV
 
PXT4_DYNAMIC_REV


	)

1664 
	#PXT4_GOOD_OLD_INODE_SIZE
 128

	)

1666 
	#PXT4_EXTRA_TIMESTAMP_MAX
 (((
s64
)1 << 34Ë- 1 + 
S32_MIN
)

	)

1667 
	#PXT4_NON_EXTRA_TIMESTAMP_MAX
 
S32_MAX


	)

1668 
	#PXT4_TIMESTAMP_MIN
 
S32_MIN


	)

1674 
	#PXT4_FEATURE_COMPAT_DIR_PREALLOC
 0x0001

	)

1675 
	#PXT4_FEATURE_COMPAT_IMAGIC_INODES
 0x0002

	)

1676 
	#PXT4_FEATURE_COMPAT_HAS_JOURNAL
 0x0004

	)

1677 
	#PXT4_FEATURE_COMPAT_EXT_ATTR
 0x0008

	)

1678 
	#PXT4_FEATURE_COMPAT_RESIZE_INODE
 0x0010

	)

1679 
	#PXT4_FEATURE_COMPAT_DIR_INDEX
 0x0020

	)

1680 
	#PXT4_FEATURE_COMPAT_SPARSE_SUPER2
 0x0200

	)

1682 
	#PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
 0x0001

	)

1683 
	#PXT4_FEATURE_RO_COMPAT_LARGE_FILE
 0x0002

	)

1684 
	#PXT4_FEATURE_RO_COMPAT_BTREE_DIR
 0x0004

	)

1685 
	#PXT4_FEATURE_RO_COMPAT_HUGE_FILE
 0x0008

	)

1686 
	#PXT4_FEATURE_RO_COMPAT_GDT_CSUM
 0x0010

	)

1687 
	#PXT4_FEATURE_RO_COMPAT_DIR_NLINK
 0x0020

	)

1688 
	#PXT4_FEATURE_RO_COMPAT_EXTRA_ISIZE
 0x0040

	)

1689 
	#PXT4_FEATURE_RO_COMPAT_QUOTA
 0x0100

	)

1690 
	#PXT4_FEATURE_RO_COMPAT_BIGALLOC
 0x0200

	)

1697 
	#PXT4_FEATURE_RO_COMPAT_METADATA_CSUM
 0x0400

	)

1698 
	#PXT4_FEATURE_RO_COMPAT_READONLY
 0x1000

	)

1699 
	#PXT4_FEATURE_RO_COMPAT_PROJECT
 0x2000

	)

1700 
	#PXT4_FEATURE_RO_COMPAT_VERITY
 0x8000

	)

1702 
	#PXT4_FEATURE_INCOMPAT_COMPRESSION
 0x0001

	)

1703 
	#PXT4_FEATURE_INCOMPAT_FILETYPE
 0x0002

	)

1704 
	#PXT4_FEATURE_INCOMPAT_RECOVER
 0x0004

	)

1705 
	#PXT4_FEATURE_INCOMPAT_JOURNAL_DEV
 0x0008

	)

1706 
	#PXT4_FEATURE_INCOMPAT_META_BG
 0x0010

	)

1707 
	#PXT4_FEATURE_INCOMPAT_EXTENTS
 0x0040

	)

1708 
	#PXT4_FEATURE_INCOMPAT_64BIT
 0x0080

	)

1709 
	#PXT4_FEATURE_INCOMPAT_MMP
 0x0100

	)

1710 
	#PXT4_FEATURE_INCOMPAT_FLEX_BG
 0x0200

	)

1711 
	#PXT4_FEATURE_INCOMPAT_EA_INODE
 0x0400

	)

1712 
	#PXT4_FEATURE_INCOMPAT_DIRDATA
 0x1000

	)

1713 
	#PXT4_FEATURE_INCOMPAT_CSUM_SEED
 0x2000

	)

1714 
	#PXT4_FEATURE_INCOMPAT_LARGEDIR
 0x4000

	)

1715 
	#PXT4_FEATURE_INCOMPAT_INLINE_DATA
 0x8000

	)

1716 
	#PXT4_FEATURE_INCOMPAT_ENCRYPT
 0x10000

	)

1717 
	#PXT4_FEATURE_INCOMPAT_CASEFOLD
 0x20000

	)

1719 
pxt4_upd©e_dy«mic_ªv
(
su≥r_block
 *
sb
);

1721 
	#PXT4_FEATURE_COMPAT_FUNCS
(
«me
, 
Êag«me
) \

1722 
ölöe
 
boﬁ
 
pxt4_has_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1724  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 & \

1725 
	`˝u_to_À32
(
PXT4_FEATURE_COMPAT_
##
Êag«me
)) != 0); \

1727 
ölöe
 
pxt4_£t_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1729 
	`pxt4_upd©e_dy«mic_ªv
(
sb
); \

1730 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 |= \

1731 
	`˝u_to_À32
(
PXT4_FEATURE_COMPAT_
##
Êag«me
); \

1733 
ölöe
 
pxt4_˛ór_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1735 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 &= \

1736 ~
	`˝u_to_À32
(
PXT4_FEATURE_COMPAT_
##
Êag«me
); \

1737 }

	)

1739 
	#PXT4_FEATURE_RO_COMPAT_FUNCS
(
«me
, 
Êag«me
) \

1740 
ölöe
 
boﬁ
 
pxt4_has_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1742  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 & \

1743 
	`˝u_to_À32
(
PXT4_FEATURE_RO_COMPAT_
##
Êag«me
)) != 0); \

1745 
ölöe
 
pxt4_£t_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1747 
	`pxt4_upd©e_dy«mic_ªv
(
sb
); \

1748 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 |= \

1749 
	`˝u_to_À32
(
PXT4_FEATURE_RO_COMPAT_
##
Êag«me
); \

1751 
ölöe
 
pxt4_˛ór_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1753 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 &= \

1754 ~
	`˝u_to_À32
(
PXT4_FEATURE_RO_COMPAT_
##
Êag«me
); \

1755 }

	)

1757 
	#PXT4_FEATURE_INCOMPAT_FUNCS
(
«me
, 
Êag«me
) \

1758 
ölöe
 
boﬁ
 
pxt4_has_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1760  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 & \

1761 
	`˝u_to_À32
(
PXT4_FEATURE_INCOMPAT_
##
Êag«me
)) != 0); \

1763 
ölöe
 
pxt4_£t_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1765 
	`pxt4_upd©e_dy«mic_ªv
(
sb
); \

1766 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 |= \

1767 
	`˝u_to_À32
(
PXT4_FEATURE_INCOMPAT_
##
Êag«me
); \

1769 
ölöe
 
pxt4_˛ór_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1771 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 &= \

1772 ~
	`˝u_to_À32
(
PXT4_FEATURE_INCOMPAT_
##
Êag«me
); \

1773 }

	)

1775 
	$PXT4_FEATURE_COMPAT_FUNCS
(
dú_¥óŒoc
, 
DIR_PREALLOC
)

1776 
	$PXT4_FEATURE_COMPAT_FUNCS
(
imagic_öodes
, 
IMAGIC_INODES
)

1777 
	$PXT4_FEATURE_COMPAT_FUNCS
(
jou∫Æ
, 
HAS_JOURNAL
)

1778 
	$PXT4_FEATURE_COMPAT_FUNCS
(
x©å
, 
EXT_ATTR
)

1779 
	$PXT4_FEATURE_COMPAT_FUNCS
(
ªsize_öode
, 
RESIZE_INODE
)

1780 
	$PXT4_FEATURE_COMPAT_FUNCS
(
dú_ödex
, 
DIR_INDEX
)

1781 
	$PXT4_FEATURE_COMPAT_FUNCS
(
•¨£_su≥r2
, 
SPARSE_SUPER2
)

1783 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
•¨£_su≥r
, 
SPARSE_SUPER
)

1784 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
œrge_fûe
, 
LARGE_FILE
)

1785 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
båì_dú
, 
BTREE_DIR
)

1786 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
huge_fûe
, 
HUGE_FILE
)

1787 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
gdt_csum
, 
GDT_CSUM
)

1788 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
dú_∆ök
, 
DIR_NLINK
)

1789 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
exåa_isize
, 
EXTRA_ISIZE
)

1790 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
quŸa
, 
QUOTA
)

1791 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
bigÆloc
, 
BIGALLOC
)

1792 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
mëad©a_csum
, 
METADATA_CSUM
)

1793 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
ªad⁄ly
, 
READONLY
)

1794 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
¥oje˘
, 
PROJECT
)

1795 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
vîôy
, 
VERITY
)

1797 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
com¥essi⁄
, 
COMPRESSION
)

1798 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
fûëy≥
, 
FILETYPE
)

1799 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
jou∫Æ_√eds_ªcovîy
, 
RECOVER
)

1800 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
jou∫Æ_dev
, 
JOURNAL_DEV
)

1801 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
mëa_bg
, 
META_BG
)

1802 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
exã¡s
, 
EXTENTS
)

1803 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(64b
ô
, 64B
IT
)

1804 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
mmp
, 
MMP
)

1805 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
Êex_bg
, 
FLEX_BG
)

1806 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
ó_öode
, 
EA_INODE
)

1807 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
dúd©a
, 
DIRDATA
)

1808 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
csum_£ed
, 
CSUM_SEED
)

1809 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
œrgedú
, 
LARGEDIR
)

1810 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
ölöe_d©a
, 
INLINE_DATA
)

1811 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
í¸y±
, 
ENCRYPT
)

1812 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
ˇ£fﬁd
, 
CASEFOLD
)

1814 
	#PXT2_FEATURE_COMPAT_SUPP
 
PXT4_FEATURE_COMPAT_EXT_ATTR


	)

1815 
	#PXT2_FEATURE_INCOMPAT_SUPP
 (
PXT4_FEATURE_INCOMPAT_FILETYPE
| \

1816 
PXT4_FEATURE_INCOMPAT_META_BG
)

	)

1817 
	#PXT2_FEATURE_RO_COMPAT_SUPP
 (
PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1818 
PXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1819 
PXT4_FEATURE_RO_COMPAT_BTREE_DIR
)

	)

1821 
	#EXT3_FEATURE_COMPAT_SUPP
 
PXT4_FEATURE_COMPAT_EXT_ATTR


	)

1822 
	#EXT3_FEATURE_INCOMPAT_SUPP
 (
PXT4_FEATURE_INCOMPAT_FILETYPE
| \

1823 
PXT4_FEATURE_INCOMPAT_RECOVER
| \

1824 
PXT4_FEATURE_INCOMPAT_META_BG
)

	)

1825 
	#EXT3_FEATURE_RO_COMPAT_SUPP
 (
PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1826 
PXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1827 
PXT4_FEATURE_RO_COMPAT_BTREE_DIR
)

	)

1829 
	#PXT4_FEATURE_COMPAT_SUPP
 
PXT4_FEATURE_COMPAT_EXT_ATTR


	)

1830 
	#PXT4_FEATURE_INCOMPAT_SUPP
 (
PXT4_FEATURE_INCOMPAT_FILETYPE
| \

1831 
PXT4_FEATURE_INCOMPAT_RECOVER
| \

1832 
PXT4_FEATURE_INCOMPAT_META_BG
| \

1833 
PXT4_FEATURE_INCOMPAT_EXTENTS
| \

1834 
PXT4_FEATURE_INCOMPAT_64BIT
| \

1835 
PXT4_FEATURE_INCOMPAT_FLEX_BG
| \

1836 
PXT4_FEATURE_INCOMPAT_EA_INODE
| \

1837 
PXT4_FEATURE_INCOMPAT_MMP
 | \

1838 
PXT4_FEATURE_INCOMPAT_INLINE_DATA
 | \

1839 
PXT4_FEATURE_INCOMPAT_ENCRYPT
 | \

1840 
PXT4_FEATURE_INCOMPAT_CASEFOLD
 | \

1841 
PXT4_FEATURE_INCOMPAT_CSUM_SEED
 | \

1842 
PXT4_FEATURE_INCOMPAT_LARGEDIR
)

	)

1843 
	#PXT4_FEATURE_RO_COMPAT_SUPP
 (
PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1844 
PXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1845 
PXT4_FEATURE_RO_COMPAT_GDT_CSUM
| \

1846 
PXT4_FEATURE_RO_COMPAT_DIR_NLINK
 | \

1847 
PXT4_FEATURE_RO_COMPAT_EXTRA_ISIZE
 | \

1848 
PXT4_FEATURE_RO_COMPAT_BTREE_DIR
 |\

1849 
PXT4_FEATURE_RO_COMPAT_HUGE_FILE
 |\

1850 
PXT4_FEATURE_RO_COMPAT_BIGALLOC
 |\

1851 
PXT4_FEATURE_RO_COMPAT_METADATA_CSUM
|\

1852 
PXT4_FEATURE_RO_COMPAT_QUOTA
 |\

1853 
PXT4_FEATURE_RO_COMPAT_PROJECT
 |\

1854 
PXT4_FEATURE_RO_COMPAT_VERITY
)

	)

1856 
	#EXTN_FEATURE_FUNCS
(
vî
) \

1857 
ölöe
 
boﬁ
 
pxt4_has_unknown_ext
##
vî
##
	`_com∑t_„©uªs
(
su≥r_block
 *
sb
) \

1859  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 & \

1860 
	`˝u_to_À32
(~
EXT
##
vî
##
_FEATURE_COMPAT_SUPP
)) != 0); \

1861 
	}
} \

1862 
ölöe
 
boﬁ
 
pxt4_has_unknown_ext
##
vî
##
	`_ro_com∑t_„©uªs
(
su≥r_block
 *
sb
) \

1864  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 & \

1865 
	`˝u_to_À32
(~
EXT
##
vî
##
_FEATURE_RO_COMPAT_SUPP
)) != 0); \

1867 
ölöe
 
boﬁ
 
pxt4_has_unknown_ext
##
vî
##
	`_öcom∑t_„©uªs
(
su≥r_block
 *
sb
) \

1869  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 & \

1870 
	`˝u_to_À32
(~
EXT
##
vî
##
_FEATURE_INCOMPAT_SUPP
)) != 0); \

1871 }

	)

1873 
	$EXTN_FEATURE_FUNCS
(2)

1874 
	$EXTN_FEATURE_FUNCS
(3)

1875 
	$EXTN_FEATURE_FUNCS
(4)

1877 
ölöe
 
boﬁ
 
	$pxt4_has_com∑t_„©uªs
(
su≥r_block
 *
sb
)

1879  (
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 != 0);

1880 
	}
}

1881 
ölöe
 
boﬁ
 
	$pxt4_has_ro_com∑t_„©uªs
(
su≥r_block
 *
sb
)

1883  (
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 != 0);

1884 
	}
}

1885 
ölöe
 
boﬁ
 
	$pxt4_has_öcom∑t_„©uªs
(
su≥r_block
 *
sb
)

1887  (
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 != 0);

1888 
	}
}

1893 
	#PXT4_FLAGS_RESIZING
 0

	)

1894 
	#PXT4_FLAGS_SHUTDOWN
 1

	)

1896 
ölöe
 
	$pxt4_f‹˚d_shutdown
(
pxt4_sb_öfo
 *
sbi
)

1898  
	`ã°_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

1899 
	}
}

1905 
	#PXT4_DEF_RESUID
 0

	)

1906 
	#PXT4_DEF_RESGID
 0

	)

1911 
	#PXT4_DEF_PROJID
 0

	)

1913 
	#PXT4_DEF_INODE_READAHEAD_BLKS
 32

	)

1918 
	#PXT4_DEFM_DEBUG
 0x0001

	)

1919 
	#PXT4_DEFM_BSDGROUPS
 0x0002

	)

1920 
	#PXT4_DEFM_XATTR_USER
 0x0004

	)

1921 
	#PXT4_DEFM_ACL
 0x0008

	)

1922 
	#PXT4_DEFM_UID16
 0x0010

	)

1923 
	#PXT4_DEFM_JMODE
 0x0060

	)

1924 
	#PXT4_DEFM_JMODE_DATA
 0x0020

	)

1925 
	#PXT4_DEFM_JMODE_ORDERED
 0x0040

	)

1926 
	#PXT4_DEFM_JMODE_WBACK
 0x0060

	)

1927 
	#PXT4_DEFM_NOBARRIER
 0x0100

	)

1928 
	#PXT4_DEFM_BLOCK_VALIDITY
 0x0200

	)

1929 
	#PXT4_DEFM_DISCARD
 0x0400

	)

1930 
	#PXT4_DEFM_NODELALLOC
 0x0800

	)

1935 
	#PXT4_DEF_MIN_BATCH_TIME
 0

	)

1936 
	#PXT4_DEF_MAX_BATCH_TIME
 15000

	)

1942 
	#PXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
 4

	)

1947 
	#PXT4_NAME_LEN
 255

	)

1949 
	spxt4_dú_íåy
 {

1950 
__À32
 
	möode
;

1951 
__À16
 
	mªc_Àn
;

1952 
__À16
 
	m«me_Àn
;

1953 
	m«me
[
PXT4_NAME_LEN
];

1962 
	spxt4_dú_íåy_2
 {

1963 
__À32
 
	möode
;

1964 
__À16
 
	mªc_Àn
;

1965 
__u8
 
	m«me_Àn
;

1966 
__u8
 
	mfûe_ty≥
;

1967 
	m«me
[
PXT4_NAME_LEN
];

1974 
	spxt4_dú_íåy_èû
 {

1975 
__À32
 
	mdë_ª£rved_zîo1
;

1976 
__À16
 
	mdë_ªc_Àn
;

1977 
__u8
 
	mdë_ª£rved_zîo2
;

1978 
__u8
 
	mdë_ª£rved_·
;

1979 
__À32
 
	mdë_checksum
;

1982 
	#PXT4_DIRENT_TAIL
(
block
, 
blocksize
) \

1983 ((
pxt4_dú_íåy_èû
 *)(((*)(
block
)) + \

1984 ((
blocksize
) - \

1985 (
pxt4_dú_íåy_èû
))))

	)

1991 
	#PXT4_FT_UNKNOWN
 0

	)

1992 
	#PXT4_FT_REG_FILE
 1

	)

1993 
	#PXT4_FT_DIR
 2

	)

1994 
	#PXT4_FT_CHRDEV
 3

	)

1995 
	#PXT4_FT_BLKDEV
 4

	)

1996 
	#PXT4_FT_FIFO
 5

	)

1997 
	#PXT4_FT_SOCK
 6

	)

1998 
	#PXT4_FT_SYMLINK
 7

	)

2000 
	#PXT4_FT_MAX
 8

	)

2002 
	#PXT4_FT_DIR_CSUM
 0xDE

	)

2009 
	#PXT4_DIR_PAD
 4

	)

2010 
	#PXT4_DIR_ROUND
 (
PXT4_DIR_PAD
 - 1)

	)

2011 
	#PXT4_DIR_REC_LEN
(
«me_Àn
Ë((“ame_ÀnË+ 8 + 
PXT4_DIR_ROUND
) & \

2012 ~
PXT4_DIR_ROUND
)

	)

2013 
	#PXT4_MAX_REC_LEN
 ((1<<16)-1)

	)

2019 
ölöe
 

2020 
	$pxt4_ªc_Àn_‰om_disk
(
__À16
 
dÀn
, 
blocksize
)

2022 
Àn
 = 
	`À16_to_˝u
(
dÀn
);

2024 #i‡(
PAGE_SIZE
 >= 65536)

2025 i‡(
Àn
 =
PXT4_MAX_REC_LEN
 ||Üen == 0)

2026  
blocksize
;

2027  (
Àn
 & 65532) | ((len & 3) << 16);

2029  
Àn
;

2031 
	}
}

2033 
ölöe
 
__À16
 
	$pxt4_ªc_Àn_to_disk
(
Àn
, 
blocksize
)

2035 i‡((
Àn
 > 
blocksize
) || (blocksize > (1 << 18)) || (len & 3))

2036 
	`BUG
();

2037 #i‡(
PAGE_SIZE
 >= 65536)

2038 i‡(
Àn
 < 65536)

2039  
	`˝u_to_À16
(
Àn
);

2040 i‡(
Àn
 =
blocksize
) {

2041 i‡(
blocksize
 == 65536)

2042  
	`˝u_to_À16
(
PXT4_MAX_REC_LEN
);

2044  
	`˝u_to_À16
(0);

2046  
	`˝u_to_À16
((
Àn
 & 65532) | ((len >> 16) & 3));

2048  
	`˝u_to_À16
(
Àn
);

2050 
	}
}

2057 
	#is_dx
(
dú
Ë(
	`pxt4_has_„©uª_dú_ödex
((dú)->
i_sb
) && \

2058 
	`pxt4_ã°_öode_Êag
((
dú
), 
PXT4_INODE_INDEX
))

	)

2059 
	#PXT4_DIR_LINK_MAX
(
dú
Ë
	`u∆ikñy
((dú)->
i_∆ök
 >
PXT4_LINK_MAX
 && \

2060 !(
	`pxt4_has_„©uª_dú_∆ök
((
dú
)->
i_sb
Ë&& 
	`is_dx
(dú)))

	)

2061 
	#PXT4_DIR_LINK_EMPTY
(
dú
Ë((dú)->
i_∆ök
 =2 || (dú)->i_∆ök =1)

	)

2065 
	#DX_HASH_LEGACY
 0

	)

2066 
	#DX_HASH_HALF_MD4
 1

	)

2067 
	#DX_HASH_TEA
 2

	)

2068 
	#DX_HASH_LEGACY_UNSIGNED
 3

	)

2069 
	#DX_HASH_HALF_MD4_UNSIGNED
 4

	)

2070 
	#DX_HASH_TEA_UNSIGNED
 5

	)

2072 
ölöe
 
u32
 
	$pxt4_chksum
(
pxt4_sb_öfo
 *
sbi
, 
u32
 
¸c
,

2073 c⁄° *
addªss
, 
Àngth
)

2076 
shash_desc
 
shash
;

2077 
˘x
[4];

2078 } 
desc
;

2080 
	`BUG_ON
(
	`¸y±o_shash_descsize
(
sbi
->
s_chksum_drivî
)!=(
desc
.
˘x
));

2082 
desc
.
shash
.
tfm
 = 
sbi
->
s_chksum_drivî
;

2083 *(
u32
 *)
desc
.
˘x
 = 
¸c
;

2085 
	`BUG_ON
(
	`¸y±o_shash_upd©e
(&
desc
.
shash
, 
addªss
, 
Àngth
));

2087  *(
u32
 *)
desc
.
˘x
;

2088 
	}
}

2090 #ifde‡
__KERNEL__


2093 
	sdx_hash_öfo


2095 
u32
 
	mhash
;

2096 
u32
 
	mmö‹_hash
;

2097 
	mhash_vîsi⁄
;

2098 
u32
 *
	m£ed
;

2103 
	#PXT4_HTREE_EOF_32BIT
 ((1UL << (32 - 1)Ë- 1)

	)

2104 
	#PXT4_HTREE_EOF_64BIT
 ((1ULL << (64 - 1)Ë- 1)

	)

2110 
	#HASH_NB_ALWAYS
 1

	)

2112 
	spxt4_fûíame
 {

2113 c⁄° 
q°r
 *
	mu§_‚ame
;

2114 
fs¸y±_°r
 
	mdisk_«me
;

2115 
dx_hash_öfo
 
	mhöfo
;

2116 #ifde‡
CONFIG_FS_ENCRYPTION


2117 
fs¸y±_°r
 
	m¸y±o_buf
;

2119 #ifde‡
CONFIG_UNICODE


2120 
fs¸y±_°r
 
	mcf_«me
;

2124 
	#‚ame_«me
(
p
Ë(’)->
disk_«me
.
«me
)

	)

2125 
	#‚ame_Àn
(
p
Ë(’)->
disk_«me
.
Àn
)

	)

2130 
	spxt4_ûoc


2132 
buf„r_hód
 *
	mbh
;

2133 
	moff£t
;

2134 
pxt4_group_t
 
	mblock_group
;

2137 
ölöe
 
pxt4_öode
 *
	$pxt4_øw_öode
(
pxt4_ûoc
 *
ûoc
)

2139  (
pxt4_öode
 *Ë(
ûoc
->
bh
->
b_d©a
 + iloc->
off£t
);

2140 
	}
}

2142 
ölöe
 
boﬁ
 
	$pxt4_is_quŸa_fûe
(
öode
 *inode)

2144  
	`IS_NOQUOTA
(
öode
) &&

2145 !(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
);

2146 
	}
}

2153 
	sdú_¥iv©e_öfo
 {

2154 
rb_roŸ
 
	mroŸ
;

2155 
rb_node
 *
	mcuº_node
;

2156 
‚ame
 *
	mexåa_‚ame
;

2157 
loff_t
 
	mœ°_pos
;

2158 
__u32
 
	mcuº_hash
;

2159 
__u32
 
	mcuº_mö‹_hash
;

2160 
__u32
 
	m√xt_hash
;

2164 
ölöe
 
pxt4_fsblk_t


2165 
	$pxt4_group_fú°_block_no
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group_no
)

2167  
group_no
 * (
pxt4_fsblk_t
)
	`PXT4_BLOCKS_PER_GROUP
(
sb
) +

2168 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
);

2169 
	}
}

2174 
	#ERR_BAD_DX_DIR
 (-(
MAX_ERRNO
 - 1))

	)

2177 
	#PXT4_HTREE_LEVEL_COMPAT
 2

	)

2178 
	#PXT4_HTREE_LEVEL
 3

	)

2180 
ölöe
 
	$pxt4_dú_håì_Àvñ
(
su≥r_block
 *
sb
)

2182  
	`pxt4_has_„©uª_œrgedú
(
sb
) ?

2183 
PXT4_HTREE_LEVEL
 : 
PXT4_HTREE_LEVEL_COMPAT
;

2184 
	}
}

2189 
	#PXT4_DEF_LI_WAIT_MULT
 10

	)

2190 
	#PXT4_DEF_LI_MAX_START_DELAY
 5

	)

2191 
	#PXT4_LAZYINIT_QUIT
 0x0001

	)

2192 
	#PXT4_LAZYINIT_RUNNING
 0x0002

	)

2197 
	spxt4_œzy_öô
 {

2198 
	mli_°©e
;

2199 
li°_hód
 
	mli_ªque°_li°
;

2200 
muãx
 
	mli_li°_mtx
;

2203 
	spxt4_li_ªque°
 {

2204 
su≥r_block
 *
	mÃ_su≥r
;

2205 
pxt4_sb_öfo
 *
	mÃ_sbi
;

2206 
pxt4_group_t
 
	mÃ_√xt_group
;

2207 
li°_hód
 
	mÃ_ªque°
;

2208 
	mÃ_√xt_sched
;

2209 
	mÃ_timeout
;

2212 
	spxt4_„©uªs
 {

2213 
kobje˘
 
	mf_kobj
;

2214 
com∂ëi⁄
 
	mf_kobj_uƒegi°î
;

2224 
	#PXT4_MMP_MAGIC
 0x004D4D50U

	)

2225 
	#PXT4_MMP_SEQ_CLEAN
 0xFF4D4D50U

	)

2226 
	#PXT4_MMP_SEQ_FSCK
 0xE24D4D50U

	)

2227 
	#PXT4_MMP_SEQ_MAX
 0xE24D4D4FU

	)

2229 
	smmp_°ru˘
 {

2230 
__À32
 
	mmmp_magic
;

2231 
__À32
 
	mmmp_£q
;

2237 
__À64
 
	mmmp_time
;

2238 
	mmmp_nodíame
[64];

2239 
	mmmp_bdev«me
[32];

2246 
__À16
 
	mmmp_check_öãrvÆ
;

2248 
__À16
 
	mmmp_∑d1
;

2249 
__À32
 
	mmmp_∑d2
[226];

2250 
__À32
 
	mmmp_checksum
;

2254 
	smmpd_d©a
 {

2255 
buf„r_hód
 *
	mbh
;

2256 
su≥r_block
 *
	msb
;

2267 
	#PXT4_MMP_CHECK_MULT
 2UL

	)

2272 
	#PXT4_MMP_MIN_CHECK_INTERVAL
 5UL

	)

2277 
	#PXT4_MMP_MAX_CHECK_INTERVAL
 300UL

	)

2287 
	#NORET_TYPE


	)

2288 
	#ATTRIB_NORET
 
	`__©åibuã__
((
n‹ëu∫
))

	)

2289 
	#NORET_AND
 
n‹ëu∫
,

	)

2292 
pxt4_cou¡_‰ì
(*
bôm≠
, 
numch¨s
);

2293 
pxt4_öode_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2294 
pxt4_group_desc
 *
gdp
,

2295 
buf„r_hód
 *
bh
, 
sz
);

2296 
pxt4_öode_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2297 
pxt4_group_desc
 *
gdp
,

2298 
buf„r_hód
 *
bh
, 
sz
);

2299 
pxt4_block_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2300 
pxt4_group_desc
 *
gdp
,

2301 
buf„r_hód
 *
bh
);

2302 
pxt4_block_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2303 
pxt4_group_desc
 *
gdp
,

2304 
buf„r_hód
 *
bh
);

2307 
pxt4_gë_group_no_™d_off£t
(
su≥r_block
 *
sb
,

2308 
pxt4_fsblk_t
 
blockƒ
,

2309 
pxt4_group_t
 *
blockgΩp
,

2310 
pxt4_gΩblk_t
 *
off£ç
);

2311 
pxt4_group_t
 
pxt4_gë_group_numbî
(
su≥r_block
 *
sb
,

2312 
pxt4_fsblk_t
 
block
);

2314 
pxt4_block_group
(
su≥r_block
 *
sb
,

2315 
pxt4_fsblk_t
 
blockƒ
);

2316 
pxt4_gΩblk_t
 
pxt4_block_group_off£t
(
su≥r_block
 *
sb
,

2317 
pxt4_fsblk_t
 
blockƒ
);

2318 
pxt4_bg_has_su≥r
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
);

2319 
pxt4_bg_num_gdb
(
su≥r_block
 *
sb
,

2320 
pxt4_group_t
 
group
);

2321 
pxt4_fsblk_t
 
pxt4_√w_mëa_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2322 
pxt4_fsblk_t
 
gﬂl
,

2323 
Êags
,

2324 *
cou¡
,

2325 *
îΩ
);

2326 
pxt4_˛aim_‰ì_˛u°îs
(
pxt4_sb_öfo
 *
sbi
,

2327 
s64
 
n˛u°îs
, 
Êags
);

2328 
pxt4_fsblk_t
 
pxt4_cou¡_‰ì_˛u°îs
(
su≥r_block
 *);

2329 
pxt4_check_blocks_bôm≠
(
su≥r_block
 *);

2330 
pxt4_group_desc
 * 
pxt4_gë_group_desc
(
su≥r_block
 * 
sb
,

2331 
pxt4_group_t
 
block_group
,

2332 
buf„r_hód
 ** 
bh
);

2333 
pxt4_should_ªåy_Æloc
(
su≥r_block
 *
sb
, *
ªåõs
);

2335 
buf„r_hód
 *
pxt4_ªad_block_bôm≠_nowaô
(
su≥r_block
 *
sb
,

2336 
pxt4_group_t
 
block_group
);

2337 
pxt4_waô_block_bôm≠
(
su≥r_block
 *
sb
,

2338 
pxt4_group_t
 
block_group
,

2339 
buf„r_hód
 *
bh
);

2340 
buf„r_hód
 *
pxt4_ªad_block_bôm≠
(
su≥r_block
 *
sb
,

2341 
pxt4_group_t
 
block_group
);

2342 
pxt4_‰ì_˛u°îs_a·î_öô
(
su≥r_block
 *
sb
,

2343 
pxt4_group_t
 
block_group
,

2344 
pxt4_group_desc
 *
gdp
);

2345 
pxt4_fsblk_t
 
pxt4_öode_to_gﬂl_block
(
öode
 *);

2347 #ifde‡
CONFIG_UNICODE


2348 
pxt4_‚ame_£tup_ci_fûíame
(
öode
 *
dú
,

2349 c⁄° 
q°r
 *
öame
,

2350 
fs¸y±_°r
 *
‚ame
);

2353 #ifde‡
CONFIG_FS_ENCRYPTION


2354 
ölöe
 
	$pxt4_‚ame_‰om_fs¸y±_«me
(
pxt4_fûíame
 *
d°
,

2355 c⁄° 
fs¸y±_«me
 *
§c
)

2357 
	`mem£t
(
d°
, 0, (*dst));

2359 
d°
->
u§_‚ame
 = 
§c
->usr_fname;

2360 
d°
->
disk_«me
 = 
§c
->disk_name;

2361 
d°
->
höfo
.
hash
 = 
§c
->hash;

2362 
d°
->
höfo
.
mö‹_hash
 = 
§c
->minor_hash;

2363 
d°
->
¸y±o_buf
 = 
§c
->crypto_buf;

2364 
	}
}

2366 
ölöe
 
	$pxt4_‚ame_£tup_fûíame
(
öode
 *
dú
,

2367 c⁄° 
q°r
 *
öame
,

2368 
lookup
,

2369 
pxt4_fûíame
 *
‚ame
)

2371 
fs¸y±_«me
 
«me
;

2372 
îr
;

2374 
îr
 = 
	`fs¸y±_£tup_fûíame
(
dú
, 
öame
, 
lookup
, &
«me
);

2375 i‡(
îr
)

2376  
îr
;

2378 
	`pxt4_‚ame_‰om_fs¸y±_«me
(
‚ame
, &
«me
);

2380 #ifde‡
CONFIG_UNICODE


2381 
	`pxt4_‚ame_£tup_ci_fûíame
(
dú
, 
öame
, &
‚ame
->
cf_«me
);

2384 
	}
}

2386 
ölöe
 
	$pxt4_‚ame_¥ï¨e_lookup
(
öode
 *
dú
,

2387 
díåy
 *dentry,

2388 
pxt4_fûíame
 *
‚ame
)

2390 
fs¸y±_«me
 
«me
;

2391 
îr
;

2393 
îr
 = 
	`fs¸y±_¥ï¨e_lookup
(
dú
, 
díåy
, &
«me
);

2394 i‡(
îr
)

2395  
îr
;

2397 
	`pxt4_‚ame_‰om_fs¸y±_«me
(
‚ame
, &
«me
);

2399 #ifde‡
CONFIG_UNICODE


2400 
	`pxt4_‚ame_£tup_ci_fûíame
(
dú
, &
díåy
->
d_«me
, &
‚ame
->
cf_«me
);

2403 
	}
}

2405 
ölöe
 
	$pxt4_‚ame_‰ì_fûíame
(
pxt4_fûíame
 *
‚ame
)

2407 
fs¸y±_«me
 
«me
;

2409 
«me
.
¸y±o_buf
 = 
‚ame
->crypto_buf;

2410 
	`fs¸y±_‰ì_fûíame
(&
«me
);

2412 
‚ame
->
¸y±o_buf
.
«me
 = 
NULL
;

2413 
‚ame
->
u§_‚ame
 = 
NULL
;

2414 
‚ame
->
disk_«me
.
«me
 = 
NULL
;

2416 #ifde‡
CONFIG_UNICODE


2417 
	`k‰ì
(
‚ame
->
cf_«me
.
«me
);

2418 
‚ame
->
cf_«me
.
«me
 = 
NULL
;

2420 
	}
}

2422 
ölöe
 
	$pxt4_‚ame_£tup_fûíame
(
öode
 *
dú
,

2423 c⁄° 
q°r
 *
öame
,

2424 
lookup
,

2425 
pxt4_fûíame
 *
‚ame
)

2427 
‚ame
->
u§_‚ame
 = 
öame
;

2428 
‚ame
->
disk_«me
.
«me
 = (*Ë
öame
->name;

2429 
‚ame
->
disk_«me
.
Àn
 = 
öame
->len;

2431 #ifde‡
CONFIG_UNICODE


2432 
	`pxt4_‚ame_£tup_ci_fûíame
(
dú
, 
öame
, &
‚ame
->
cf_«me
);

2436 
	}
}

2438 
ölöe
 
	$pxt4_‚ame_¥ï¨e_lookup
(
öode
 *
dú
,

2439 
díåy
 *dentry,

2440 
pxt4_fûíame
 *
‚ame
)

2442  
	`pxt4_‚ame_£tup_fûíame
(
dú
, &
díåy
->
d_«me
, 1, 
‚ame
);

2443 
	}
}

2445 
ölöe
 
	$pxt4_‚ame_‰ì_fûíame
(
pxt4_fûíame
 *
‚ame
)

2447 #ifde‡
CONFIG_UNICODE


2448 
	`k‰ì
(
‚ame
->
cf_«me
.
«me
);

2449 
‚ame
->
cf_«me
.
«me
 = 
NULL
;

2451 
	}
}

2455 
__pxt4_check_dú_íåy
(c⁄° *, , 
öode
 *,

2456 
fûe
 *,

2457 
pxt4_dú_íåy_2
 *,

2458 
buf„r_hód
 *, *, ,

2460 
	#pxt4_check_dú_íåy
(
dú
, 
fûp
, 
de
, 
bh
, 
buf
, 
size
, 
off£t
) \

2461 
	`u∆ikñy
(
	`__pxt4_check_dú_íåy
(
__func__
, 
__LINE__
, (
dú
), (
fûp
), \

2462 (
de
), (
bh
), (
buf
), (
size
), (
off£t
)))

	)

2463 
pxt4_håì_°‹e_dúít
(
fûe
 *
dú_fûe
, 
__u32
 
hash
,

2464 
__u32
 
mö‹_hash
,

2465 
pxt4_dú_íåy_2
 *
dúít
,

2466 
fs¸y±_°r
 *
ít_«me
);

2467 
pxt4_håì_‰ì_dú_öfo
(
dú_¥iv©e_öfo
 *
p
);

2468 
pxt4_föd_de°_de
(
öode
 *
dú
, inode *inode,

2469 
buf„r_hód
 *
bh
,

2470 *
buf
, 
buf_size
,

2471 
pxt4_fûíame
 *
‚ame
,

2472 
pxt4_dú_íåy_2
 **
de°_de
);

2473 
pxt4_ö£π_díåy
(
öode
 *inode,

2474 
pxt4_dú_íåy_2
 *
de
,

2475 
buf_size
,

2476 
pxt4_fûíame
 *
‚ame
);

2477 
ölöe
 
	$pxt4_upd©e_dx_Êag
(
öode
 *inode)

2479 i‡(!
	`pxt4_has_„©uª_dú_ödex
(
öode
->
i_sb
))

2480 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
);

2481 
	}
}

2482 c⁄° 
	gpxt4_fûëy≥_èbÀ
[] = {

2483 
DT_UNKNOWN
, 
DT_REG
, 
DT_DIR
, 
DT_CHR
, 
DT_BLK
, 
DT_FIFO
, 
DT_SOCK
, 
DT_LNK


2486 
ölöe
 
	$gë_dty≥
(
su≥r_block
 *
sb
, 
fûëy≥
)

2488 i‡(!
	`pxt4_has_„©uª_fûëy≥
(
sb
Ë|| 
fûëy≥
 >
PXT4_FT_MAX
)

2489  
DT_UNKNOWN
;

2491  
pxt4_fûëy≥_èbÀ
[
fûëy≥
];

2492 
	}
}

2493 
pxt4_check_Æl_de
(
öode
 *
dú
, 
buf„r_hód
 *
bh
,

2494 *
buf
, 
buf_size
);

2497 
pxt4_sync_fûe
(
fûe
 *, 
loff_t
,Üoff_t, );

2500 
pxt4fs_dúhash
(c⁄° 
öode
 *
dú
, c⁄° *
«me
, 
Àn
,

2501 
dx_hash_öfo
 *
höfo
);

2504 
öode
 *
__pxt4_√w_öode
(
h™dÀ_t
 *, öodê*, 
umode_t
,

2505 c⁄° 
q°r
 *q°r, 
__u32
 
gﬂl
,

2506 
uid_t
 *
ow√r
, 
__u32
 
i_Êags
,

2507 
h™dÀ_ty≥
, 
löe_no
,

2508 
nblocks
);

2510 
	#pxt4_√w_öode
(
h™dÀ
, 
dú
, 
mode
, 
q°r
, 
gﬂl
, 
ow√r
, 
i_Êags
) \

2511 
	`__pxt4_√w_öode
((
h™dÀ
), (
dú
), (
mode
), (
q°r
), (
gﬂl
), (
ow√r
), \

2512 
i_Êags
, 0, 0, 0)

	)

2513 
	#pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
, 
q°r
, 
gﬂl
, 
ow√r
, \

2514 
ty≥
, 
nblocks
) \

2515 
	`__pxt4_√w_öode
(
NULL
, (
dú
), (
mode
), (
q°r
), (
gﬂl
), (
ow√r
), \

2516 0, (
ty≥
), 
__LINE__
, (
nblocks
))

	)

2519 
pxt4_‰ì_öode
(
h™dÀ_t
 *, 
öode
 *);

2520 
öode
 * 
pxt4_‹ph™_gë
(
su≥r_block
 *, );

2521 
pxt4_cou¡_‰ì_öodes
(
su≥r_block
 *);

2522 
pxt4_cou¡_dús
(
su≥r_block
 *);

2523 
pxt4_check_öodes_bôm≠
(
su≥r_block
 *);

2524 
pxt4_m¨k_bôm≠_íd
(
°¨t_bô
, 
íd_bô
, *
bôm≠
);

2525 
pxt4_öô_öode_èbÀ
(
su≥r_block
 *
sb
,

2526 
pxt4_group_t
 
group
, 
b¨rõr
);

2527 
pxt4_íd_bôm≠_ªad
(
buf„r_hód
 *
bh
, 
u±od©e
);

2530 c⁄° 
£q_›î©i⁄s
 
pxt4_mb_£q_groups_›s
;

2531 
pxt4_mb_°©s
;

2532 
pxt4_mb_max_to_sˇn
;

2533 
pxt4_mb_öô
(
su≥r_block
 *);

2534 
pxt4_mb_ªÀa£
(
su≥r_block
 *);

2535 
pxt4_fsblk_t
 
pxt4_mb_√w_blocks
(
h™dÀ_t
 *,

2536 
pxt4_Æloˇti⁄_ªque°
 *, *);

2537 
pxt4_mb_ª£rve_blocks
(
su≥r_block
 *, );

2538 
pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
 *);

2539 
__öô
 
pxt4_öô_mbÆloc
();

2540 
pxt4_exô_mbÆloc
();

2541 
pxt4_‰ì_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2542 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
block
,

2543 
cou¡
, 
Êags
);

2544 
pxt4_mb_Æloc_groupöfo
(
su≥r_block
 *
sb
,

2545 
pxt4_group_t
 
ngroups
);

2546 
pxt4_mb_add_groupöfo
(
su≥r_block
 *
sb
,

2547 
pxt4_group_t
 
i
, 
pxt4_group_desc
 *
desc
);

2548 
pxt4_group_add_blocks
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

2549 
pxt4_fsblk_t
 
block
, 
cou¡
);

2550 
pxt4_åim_fs
(
su≥r_block
 *, 
f°rim_ønge
 *);

2551 
pxt4_¥o˚ss_‰ìd_d©a
(
su≥r_block
 *
sb
, 
tid_t
 
commô_tid
);

2554 
pxt4_öode_is_Á°_symlök
(
öode
 *inode);

2555 
buf„r_hód
 *
pxt4_gëblk
(
h™dÀ_t
 *, 
öode
 *, 
pxt4_lblk_t
, );

2556 
buf„r_hód
 *
pxt4_bªad
(
h™dÀ_t
 *, 
öode
 *, 
pxt4_lblk_t
, );

2557 
pxt4_bªad_b©ch
(
öode
 *öode, 
pxt4_lblk_t
 
block
, 
bh_cou¡
,

2558 
boﬁ
 
waô
, 
buf„r_hód
 **
bhs
);

2559 
pxt4_gë_block_unwrôãn
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2560 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
);

2561 
pxt4_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2562 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
);

2563 
pxt4_dio_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2564 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
);

2565 
pxt4_da_gë_block_¥ï
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2566 
buf„r_hód
 *
bh
, 
¸óã
);

2567 
pxt4_wÆk_∑ge_buf„rs
(
h™dÀ_t
 *
h™dÀ
,

2568 
buf„r_hód
 *
hód
,

2569 
‰om
,

2570 
to
,

2571 *
∑πül
,

2572 (*
‚
)(
h™dÀ_t
 *
h™dÀ
,

2573 
buf„r_hód
 *
bh
));

2574 
	`do_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ_t
 *
h™dÀ
,

2575 
buf„r_hód
 *
bh
);

2576 
	#FALL_BACK_TO_NONDELALLOC
 1

	)

2577 
	#CONVERT_INLINE_DATA
 2

	)

2580 
PXT4_IGET_NORMAL
 = 0,

2581 
PXT4_IGET_SPECIAL
 = 0x0001,

2582 
PXT4_IGET_HANDLE
 = 0x0002

2583 } 
	tpxt4_igë_Êags
;

2585 
öode
 *
	`__pxt4_igë
(
su≥r_block
 *
sb
, 
öo
,

2586 
pxt4_igë_Êags
 
Êags
, c⁄° *
fun˘i⁄
,

2587 
löe
);

2589 
	#pxt4_igë
(
sb
, 
öo
, 
Êags
) \

2590 
	`__pxt4_igë
((
sb
), (
öo
), (
Êags
), 
__func__
, 
__LINE__
)

	)

2592 
	`pxt4_wrôe_öode
(
öode
 *, 
wrôeback_c⁄åﬁ
 *);

2593 
	`pxt4_£èâr
(
díåy
 *, 
üâr
 *);

2594 
	`pxt4_gë©å
(c⁄° 
∑th
 *, 
k°©
 *, 
u32
, );

2595 
	`pxt4_evi˘_öode
(
öode
 *);

2596 
	`pxt4_˛ór_öode
(
öode
 *);

2597 
	`pxt4_fûe_gë©å
(c⁄° 
∑th
 *, 
k°©
 *, 
u32
, );

2598 
	`pxt4_sync_öode
(
h™dÀ_t
 *, 
öode
 *);

2599 
	`pxt4_dúty_öode
(
öode
 *, );

2600 
	`pxt4_ch™ge_öode_jou∫Æ_Êag
(
öode
 *, );

2601 
	`pxt4_gë_öode_loc
(
öode
 *, 
pxt4_ûoc
 *);

2602 
	`pxt4_öode_©èch_jöode
(
öode
 *inode);

2603 
	`pxt4_ˇn_åunˇã
(
öode
 *inode);

2604 
	`pxt4_åunˇã
(
öode
 *);

2605 
	`pxt4_bªak_œyouts
(
öode
 *);

2606 
	`pxt4_punch_hﬁe
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
);

2607 
	`pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ_t
 *, 
öode
 *, 
nblocks
);

2608 
	`pxt4_£t_öode_Êags
(
öode
 *);

2609 
	`pxt4_Æloc_da_blocks
(
öode
 *inode);

2610 
	`pxt4_£t_a›s
(
öode
 *inode);

2611 
	`pxt4_wrôïage_å™s_blocks
(
öode
 *);

2612 
	`pxt4_chunk_å™s_blocks
(
öode
 *, 
ƒblocks
);

2613 
	`pxt4_zîo_∑πül_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2614 
loff_t
 
l°¨t
,Üoff_à
Ànd
);

2615 
vm_Áu…_t
 
	`pxt4_∑ge_mkwrôe
(
vm_Áu…
 *
vmf
);

2616 
vm_Áu…_t
 
	`pxt4_fûem≠_Áu…
(
vm_Áu…
 *
vmf
);

2617 
qsize_t
 *
	`pxt4_gë_ª£rved_•a˚
(
öode
 *inode);

2618 
	`pxt4_gë_¥ojid
(
öode
 *öode, 
k¥ojid_t
 *
¥ojid
);

2619 
	`pxt4_da_ªÀa£_•a˚
(
öode
 *öode, 
to_‰ì
);

2620 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
 *inode,

2621 
u£d
, 
quŸa_˛aim
);

2622 
	`pxt4_issue_zîoout
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

2623 
pxt4_fsblk_t
 
pblk
, 
pxt4_lblk_t
 
Àn
);

2626 
	`pxt4_öd_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2627 
pxt4_m≠_blocks
 *
m≠
, 
Êags
);

2628 
	`pxt4_öd_ˇlc_mëad©a_amou¡
(
öode
 *öode, 
£˘‹_t
 
lblock
);

2629 
	`pxt4_öd_å™s_blocks
(
öode
 *öode, 
ƒblocks
);

2630 
	`pxt4_öd_åunˇã
(
h™dÀ_t
 *, 
öode
 *inode);

2631 
	`pxt4_öd_ªmove_•a˚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2632 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
);

2635 
	`pxt4_io˘l
(
fûe
 *, , );

2636 
	`pxt4_com∑t_io˘l
(
fûe
 *, , );

2639 
	`pxt4_ext_migøã
(
öode
 *);

2640 
	`pxt4_öd_migøã
(
öode
 *inode);

2643 
	`pxt4_dúblock_csum_vîify
(
öode
 *inode,

2644 
buf„r_hód
 *
bh
);

2645 
	`pxt4_‹ph™_add
(
h™dÀ_t
 *, 
öode
 *);

2646 
	`pxt4_‹ph™_dñ
(
h™dÀ_t
 *, 
öode
 *);

2647 
	`pxt4_håì_fûl_åì
(
fûe
 *
dú_fûe
, 
__u32
 
°¨t_hash
,

2648 
__u32
 
°¨t_mö‹_hash
, __u32 *
√xt_hash
);

2649 
	`pxt4_£¨ch_dú
(
buf„r_hód
 *
bh
,

2650 *
£¨ch_buf
,

2651 
buf_size
,

2652 
öode
 *
dú
,

2653 
pxt4_fûíame
 *
‚ame
,

2654 
off£t
,

2655 
pxt4_dú_íåy_2
 **
ªs_dú
);

2656 
	`pxt4_gíîic_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
,

2657 
öode
 *
dú
,

2658 
pxt4_dú_íåy_2
 *
de_dñ
,

2659 
buf„r_hód
 *
bh
,

2660 *
íåy_buf
,

2661 
buf_size
,

2662 
csum_size
);

2663 
boﬁ
 
	`pxt4_em±y_dú
(
öode
 *inode);

2666 
	`pxt4_group_add
(
su≥r_block
 *
sb
,

2667 
pxt4_√w_group_d©a
 *
öput
);

2668 
	`pxt4_group_exãnd
(
su≥r_block
 *
sb
,

2669 
pxt4_su≥r_block
 *
es
,

2670 
pxt4_fsblk_t
 
n_blocks_cou¡
);

2671 
	`pxt4_ªsize_fs
(
su≥r_block
 *
sb
, 
pxt4_fsblk_t
 
n_blocks_cou¡
);

2674 
buf„r_hód
 *
	`pxt4_sb_bªad
(
su≥r_block
 *
sb
,

2675 
£˘‹_t
 
block
, 
›_Êags
);

2676 
	`pxt4_£q_›ti⁄s_show
(
£q_fûe
 *
£q
, *
off£t
);

2677 
	`pxt4_ˇlcuœã_ovîhód
(
su≥r_block
 *
sb
);

2678 
	`pxt4_su≥rblock_csum_£t
(
su≥r_block
 *
sb
);

2679 *
	`pxt4_kvmÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
);

2680 *
	`pxt4_kvzÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
);

2681 
	`pxt4_Æloc_Êex_bg_¨øy
(
su≥r_block
 *
sb
,

2682 
pxt4_group_t
 
ngroup
);

2683 c⁄° *
	`pxt4_decode_îr‹
(
su≥r_block
 *
sb
, 
î∫o
,

2684 
nbuf
[16]);

2685 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
su≥r_block
 *
sb
,

2686 
pxt4_group_t
 
block_group
,

2687 
Êags
);

2689 
	$__¥ötf
(4, 5)

2690 
	`__pxt4_îr‹
(
su≥r_block
 *, const *, ,

2692 
	$__¥ötf
(5, 6)

2693 
	`__pxt4_îr‹_öode
(
öode
 *, c⁄° *, , 
pxt4_fsblk_t
,

2695 
	$__¥ötf
(5, 6)

2696 
	`__pxt4_îr‹_fûe
(
fûe
 *, c⁄° *, , 
pxt4_fsblk_t
,

2698 
	`__pxt4_°d_îr‹
(
su≥r_block
 *, const *,

2700 
	$__¥ötf
(4, 5)

2701 
	`__pxt4_ab‹t
(
su≥r_block
 *, const *, ,

2703 
	$__¥ötf
(4, 5)

2704 
	`__pxt4_w¨nög
(
su≥r_block
 *, const *, ,

2706 
	$__¥ötf
(4, 5)

2707 
	`__pxt4_w¨nög_öode
(c⁄° 
öode
 *öode, c⁄° *
fun˘i⁄
,

2708 
löe
, c⁄° *
fmt
, ...);

2709 
	$__¥ötf
(3, 4)

2710 
	`__pxt4_msg
(
su≥r_block
 *, const *, const *, ...);

2711 
	`__dump_mmp_msg
(
su≥r_block
 *, 
mmp_°ru˘
 *
mmp
,

2713 
	$__¥ötf
(7, 8)

2714 
	`__pxt4_gΩ_locked_îr‹
(const *, ,

2715 
su≥r_block
 *, 
pxt4_group_t
,

2716 , 
pxt4_fsblk_t
,

2719 
	#PXT4_ERROR_INODE
(
öode
, 
fmt
, 
a
...) \

2720 
	`pxt4_îr‹_öode
((
öode
), 
__func__
, 
__LINE__
, 0, (
fmt
), ## 
a
)

	)

2722 
	#PXT4_ERROR_INODE_BLOCK
(
öode
, 
block
, 
fmt
, 
a
...) \

2723 
	`pxt4_îr‹_öode
((
öode
), 
__func__
, 
__LINE__
, (
block
), (
fmt
), ## 
a
)

	)

2725 
	#PXT4_ERROR_FILE
(
fûe
, 
block
, 
fmt
, 
a
...) \

2726 
	`pxt4_îr‹_fûe
((
fûe
), 
__func__
, 
__LINE__
, (
block
), (
fmt
), ## 
a
)

	)

2728 #ifde‡
CONFIG_PRINTK


2730 
	#pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2731 
	`__pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
, 
fmt
, ##
__VA_ARGS__
)

	)

2732 
	#pxt4_îr‹_fûe
(
fûe
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2733 
	`__pxt4_îr‹_fûe
(
fûe
, 
func
, 
löe
, 
block
, 
fmt
, ##
__VA_ARGS__
)

	)

2734 
	#pxt4_îr‹
(
sb
, 
fmt
, ...) \

2735 
	`__pxt4_îr‹
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2736 
	#pxt4_ab‹t
(
sb
, 
fmt
, ...) \

2737 
	`__pxt4_ab‹t
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2738 
	#pxt4_w¨nög
(
sb
, 
fmt
, ...) \

2739 
	`__pxt4_w¨nög
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2740 
	#pxt4_w¨nög_öode
(
öode
, 
fmt
, ...) \

2741 
	`__pxt4_w¨nög_öode
(
öode
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2742 
	#pxt4_msg
(
sb
, 
Àvñ
, 
fmt
, ...) \

2743 
	`__pxt4_msg
(
sb
, 
Àvñ
, 
fmt
, ##
__VA_ARGS__
)

	)

2744 
	#dump_mmp_msg
(
sb
, 
mmp
, 
msg
) \

2745 
	`__dump_mmp_msg
(
sb
, 
mmp
, 
__func__
, 
__LINE__
, 
msg
)

	)

2746 
	#pxt4_gΩ_locked_îr‹
(
sb
, 
gΩ
, 
öo
, 
block
, 
fmt
, ...) \

2747 
	`__pxt4_gΩ_locked_îr‹
(
__func__
, 
__LINE__
, 
sb
, 
gΩ
, 
öo
, 
block
, \

2748 
fmt
, ##
__VA_ARGS__
)

	)

2752 
	#pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2754 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2755 
	`__pxt4_îr‹_öode
(
öode
, "", 0, 
block
, " "); \

2756 
	}
} 0)

	)

2757 
	#pxt4_îr‹_fûe
(
fûe
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2759 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2760 
	`__pxt4_îr‹_fûe
(
fûe
, "", 0, 
block
, " "); \

2761 } 0)

	)

2762 
	#pxt4_îr‹
(
sb
, 
fmt
, ...) \

2764 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2765 
	`__pxt4_îr‹
(
sb
, "", 0, " "); \

2766 } 0)

	)

2767 
	#pxt4_ab‹t
(
sb
, 
fmt
, ...) \

2769 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2770 
	`__pxt4_ab‹t
(
sb
, "", 0, " "); \

2771 } 0)

	)

2772 
	#pxt4_w¨nög
(
sb
, 
fmt
, ...) \

2774 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2775 
	`__pxt4_w¨nög
(
sb
, "", 0, " "); \

2776 } 0)

	)

2777 
	#pxt4_w¨nög_öode
(
öode
, 
fmt
, ...) \

2779 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2780 
	`__pxt4_w¨nög_öode
(
öode
, "", 0, " "); \

2781 } 0)

	)

2782 
	#pxt4_msg
(
sb
, 
Àvñ
, 
fmt
, ...) \

2784 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2785 
	`__pxt4_msg
(
sb
, "", " "); \

2786 } 0)

	)

2787 
	#dump_mmp_msg
(
sb
, 
mmp
, 
msg
) \

2788 
	`__dump_mmp_msg
(
sb
, 
mmp
, "", 0, "")

	)

2789 
	#pxt4_gΩ_locked_îr‹
(
sb
, 
gΩ
, 
öo
, 
block
, 
fmt
, ...) \

2791 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2792 
	`__pxt4_gΩ_locked_îr‹
("", 0, 
sb
, 
gΩ
, 
öo
, 
block
, " "); \

2793 } 0)

	)

2797 
pxt4_upd©e_com∑t_„©uª
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

2798 
__u32
 
com∑t
);

2799 
pxt4_upd©e_rocom∑t_„©uª
(
h™dÀ_t
 *
h™dÀ
,

2800 
su≥r_block
 *
sb
, 
__u32
 
rocom∑t
);

2801 
pxt4_upd©e_öcom∑t_„©uª
(
h™dÀ_t
 *
h™dÀ
,

2802 
su≥r_block
 *
sb
, 
__u32
 
öcom∑t
);

2803 
pxt4_fsblk_t
 
pxt4_block_bôm≠
(
su≥r_block
 *
sb
,

2804 
pxt4_group_desc
 *
bg
);

2805 
pxt4_fsblk_t
 
pxt4_öode_bôm≠
(
su≥r_block
 *
sb
,

2806 
pxt4_group_desc
 *
bg
);

2807 
pxt4_fsblk_t
 
pxt4_öode_èbÀ
(
su≥r_block
 *
sb
,

2808 
pxt4_group_desc
 *
bg
);

2809 
__u32
 
pxt4_‰ì_group_˛u°îs
(
su≥r_block
 *
sb
,

2810 
pxt4_group_desc
 *
bg
);

2811 
__u32
 
pxt4_‰ì_öodes_cou¡
(
su≥r_block
 *
sb
,

2812 
pxt4_group_desc
 *
bg
);

2813 
__u32
 
pxt4_u£d_dús_cou¡
(
su≥r_block
 *
sb
,

2814 
pxt4_group_desc
 *
bg
);

2815 
__u32
 
pxt4_ôabÀ_unu£d_cou¡
(
su≥r_block
 *
sb
,

2816 
pxt4_group_desc
 *
bg
);

2817 
pxt4_block_bôm≠_£t
(
su≥r_block
 *
sb
,

2818 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
);

2819 
pxt4_öode_bôm≠_£t
(
su≥r_block
 *
sb
,

2820 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
);

2821 
pxt4_öode_èbÀ_£t
(
su≥r_block
 *
sb
,

2822 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
);

2823 
pxt4_‰ì_group_˛u°îs_£t
(
su≥r_block
 *
sb
,

2824 
pxt4_group_desc
 *
bg
,

2825 
__u32
 
cou¡
);

2826 
pxt4_‰ì_öodes_£t
(
su≥r_block
 *
sb
,

2827 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
);

2828 
pxt4_u£d_dús_£t
(
su≥r_block
 *
sb
,

2829 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
);

2830 
pxt4_ôabÀ_unu£d_£t
(
su≥r_block
 *
sb
,

2831 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
);

2832 
pxt4_group_desc_csum_vîify
(
su≥r_block
 *
sb
, 
__u32
 
group
,

2833 
pxt4_group_desc
 *
gdp
);

2834 
pxt4_group_desc_csum_£t
(
su≥r_block
 *
sb
, 
__u32
 
group
,

2835 
pxt4_group_desc
 *
gdp
);

2836 
pxt4_ªgi°î_li_ªque°
(
su≥r_block
 *
sb
,

2837 
pxt4_group_t
 
fú°_nŸ_zî€d
);

2839 
ölöe
 
	$pxt4_has_mëad©a_csum
(
su≥r_block
 *
sb
)

2841 
	`WARN_ON_ONCE
(
	`pxt4_has_„©uª_mëad©a_csum
(
sb
) &&

2842 !
	`PXT4_SB
(
sb
)->
s_chksum_drivî
);

2844  
	`pxt4_has_„©uª_mëad©a_csum
(
sb
) &&

2845 (
	`PXT4_SB
(
sb
)->
s_chksum_drivî
 !
NULL
);

2846 
	}
}

2848 
ölöe
 
	$pxt4_has_group_desc_csum
(
su≥r_block
 *
sb
)

2850  
	`pxt4_has_„©uª_gdt_csum
(
sb
Ë|| 
	`pxt4_has_mëad©a_csum
(sb);

2851 
	}
}

2853 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_blocks_cou¡
(
pxt4_su≥r_block
 *
es
)

2855  ((
pxt4_fsblk_t
)
	`À32_to_˝u
(
es
->
s_blocks_cou¡_hi
) << 32) |

2856 
	`À32_to_˝u
(
es
->
s_blocks_cou¡_lo
);

2857 
	}
}

2859 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_r_blocks_cou¡
(
pxt4_su≥r_block
 *
es
)

2861  ((
pxt4_fsblk_t
)
	`À32_to_˝u
(
es
->
s_r_blocks_cou¡_hi
) << 32) |

2862 
	`À32_to_˝u
(
es
->
s_r_blocks_cou¡_lo
);

2863 
	}
}

2865 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_‰ì_blocks_cou¡
(
pxt4_su≥r_block
 *
es
)

2867  ((
pxt4_fsblk_t
)
	`À32_to_˝u
(
es
->
s_‰ì_blocks_cou¡_hi
) << 32) |

2868 
	`À32_to_˝u
(
es
->
s_‰ì_blocks_cou¡_lo
);

2869 
	}
}

2871 
ölöe
 
	$pxt4_blocks_cou¡_£t
(
pxt4_su≥r_block
 *
es
,

2872 
pxt4_fsblk_t
 
blk
)

2874 
es
->
s_blocks_cou¡_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

2875 
es
->
s_blocks_cou¡_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

2876 
	}
}

2878 
ölöe
 
	$pxt4_‰ì_blocks_cou¡_£t
(
pxt4_su≥r_block
 *
es
,

2879 
pxt4_fsblk_t
 
blk
)

2881 
es
->
s_‰ì_blocks_cou¡_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

2882 
es
->
s_‰ì_blocks_cou¡_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

2883 
	}
}

2885 
ölöe
 
	$pxt4_r_blocks_cou¡_£t
(
pxt4_su≥r_block
 *
es
,

2886 
pxt4_fsblk_t
 
blk
)

2888 
es
->
s_r_blocks_cou¡_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

2889 
es
->
s_r_blocks_cou¡_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

2890 
	}
}

2892 
ölöe
 
loff_t
 
	$pxt4_isize
(
su≥r_block
 *
sb
,

2893 
pxt4_öode
 *
øw_öode
)

2895 i‡(
	`pxt4_has_„©uª_œrgedú
(
sb
) ||

2896 
	`S_ISREG
(
	`À16_to_˝u
(
øw_öode
->
i_mode
)))

2897  ((
loff_t
)
	`À32_to_˝u
(
øw_öode
->
i_size_high
) << 32) |

2898 
	`À32_to_˝u
(
øw_öode
->
i_size_lo
);

2900  (
loff_t
Ë
	`À32_to_˝u
(
øw_öode
->
i_size_lo
);

2901 
	}
}

2903 
ölöe
 
	$pxt4_isize_£t
(
pxt4_öode
 *
øw_öode
, 
loff_t
 
i_size
)

2905 
øw_öode
->
i_size_lo
 = 
	`˝u_to_À32
(
i_size
);

2906 
øw_öode
->
i_size_high
 = 
	`˝u_to_À32
(
i_size
 >> 32);

2907 
	}
}

2909 
ölöe


2910 
pxt4_group_öfo
 *
	$pxt4_gë_group_öfo
(
su≥r_block
 *
sb
,

2911 
pxt4_group_t
 
group
)

2913 
pxt4_group_öfo
 ***
gΩ_öfo
;

2914 
ödexv
, 
ödexh
;

2915 
	`BUG_ON
(
group
 >
	`PXT4_SB
(
sb
)->
s_groups_cou¡
);

2916 
gΩ_öfo
 = 
	`PXT4_SB
(
sb
)->
s_group_öfo
;

2917 
ödexv
 = 
group
 >> (
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
));

2918 
ödexh
 = 
group
 & ((
	`PXT4_DESC_PER_BLOCK
(
sb
)) - 1);

2919  
gΩ_öfo
[
ödexv
][
ödexh
];

2920 
	}
}

2927 
ölöe
 
pxt4_group_t
 
	$pxt4_gë_groups_cou¡
(
su≥r_block
 *
sb
)

2929 
pxt4_group_t
 
ngroups
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

2931 
	`smp_rmb
();

2932  
ngroups
;

2933 
	}
}

2935 
ölöe
 
pxt4_group_t
 
	$pxt4_Êex_group
(
pxt4_sb_öfo
 *
sbi
,

2936 
pxt4_group_t
 
block_group
)

2938  
block_group
 >> 
sbi
->
s_log_groups_≥r_Êex
;

2939 
	}
}

2941 
ölöe
 
	$pxt4_Êex_bg_size
(
pxt4_sb_öfo
 *
sbi
)

2943  1 << 
sbi
->
s_log_groups_≥r_Êex
;

2944 
	}
}

2946 
	#pxt4_°d_îr‹
(
sb
, 
î∫o
) \

2948 i‡((
î∫o
)) \

2949 
	`__pxt4_°d_îr‹
((
sb
), 
__func__
, 
__LINE__
, (
î∫o
)); \

2950 } 0)

	)

2952 #ifde‡
CONFIG_SMP


2957 
	#PXT4_FREECLUSTERS_WATERMARK
 (4 * (
≥r˝u_cou¡î_b©ch
 * 
ƒ_˝u_ids
))

	)

2959 
	#PXT4_FREECLUSTERS_WATERMARK
 0

	)

2963 
ölöe
 
	$pxt4_upd©e_i_disksize
(
öode
 *öode, 
loff_t
 
√wsize
)

2965 
	`WARN_ON_ONCE
(
	`S_ISREG
(
öode
->
i_mode
) &&

2966 !
	`öode_is_locked
(
öode
));

2967 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2968 i‡(
√wsize
 > 
	`PXT4_I
(
öode
)->
i_disksize
)

2969 
	`PXT4_I
(
öode
)->
i_disksize
 = 
√wsize
;

2970 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2971 
	}
}

2974 
ölöe
 
	$pxt4_upd©e_öode_size
(
öode
 *öode, 
loff_t
 
√wsize
)

2976 
ch™ged
 = 0;

2978 i‡(
√wsize
 > 
öode
->
i_size
) {

2979 
	`i_size_wrôe
(
öode
, 
√wsize
);

2980 
ch™ged
 = 1;

2982 i‡(
√wsize
 > 
	`PXT4_I
(
öode
)->
i_disksize
) {

2983 
	`pxt4_upd©e_i_disksize
(
öode
, 
√wsize
);

2984 
ch™ged
 |= 2;

2986  
ch™ged
;

2987 
	}
}

2989 
pxt4_upd©e_disksize_bef‹e_punch
(
öode
 *öode, 
loff_t
 
off£t
,

2990 
loff_t
 
Àn
);

2992 
	spxt4_group_öfo
 {

2993 
	mbb_°©e
;

2994 
rb_roŸ
 
	mbb_‰ì_roŸ
;

2995 
pxt4_gΩblk_t
 
	mbb_fú°_‰ì
;

2996 
pxt4_gΩblk_t
 
	mbb_‰ì
;

2997 
pxt4_gΩblk_t
 
	mbb_‰agmíts
;

2998 
pxt4_gΩblk_t
 
	mbb_œrge°_‰ì_‹dî
;

2999 
li°_hód
 
	mbb_¥óŒoc_li°
;

3000 #ifde‡
DOUBLE_CHECK


3001 *
	mbb_bôm≠
;

3003 
rw_£m≠h‹e
 
	mÆloc_£m
;

3004 
pxt4_gΩblk_t
 
	mbb_cou¡îs
[];

3010 
	#PXT4_GROUP_INFO_NEED_INIT_BIT
 0

	)

3011 
	#PXT4_GROUP_INFO_WAS_TRIMMED_BIT
 1

	)

3012 
	#PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
 2

	)

3013 
	#PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
 3

	)

3014 
	#PXT4_GROUP_INFO_BBITMAP_CORRUPT
 \

3015 (1 << 
PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
)

	)

3016 
	#PXT4_GROUP_INFO_IBITMAP_CORRUPT
 \

3017 (1 << 
PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
)

	)

3019 
	#PXT4_MB_GRP_NEED_INIT
(
gΩ
) \

3020 (
	`ã°_bô
(
PXT4_GROUP_INFO_NEED_INIT_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3021 
	#PXT4_MB_GRP_BBITMAP_CORRUPT
(
gΩ
) \

3022 (
	`ã°_bô
(
PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3023 
	#PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
) \

3024 (
	`ã°_bô
(
PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3026 
	#PXT4_MB_GRP_WAS_TRIMMED
(
gΩ
) \

3027 (
	`ã°_bô
(
PXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3028 
	#PXT4_MB_GRP_SET_TRIMMED
(
gΩ
) \

3029 (
	`£t_bô
(
PXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3030 
	#PXT4_MB_GRP_CLEAR_TRIMMED
(
gΩ
) \

3031 (
	`˛ór_bô
(
PXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3033 
	#PXT4_MAX_CONTENTION
 8

	)

3034 
	#PXT4_CONTENTION_THRESHOLD
 2

	)

3036 
ölöe
 
•ölock_t
 *
	$pxt4_group_lock_±r
(
su≥r_block
 *
sb
,

3037 
pxt4_group_t
 
group
)

3039  
	`bgl_lock_±r
(
	`PXT4_SB
(
sb
)->
s_blockgroup_lock
, 
group
);

3040 
	}
}

3046 
ölöe
 
	$pxt4_fs_is_busy
(
pxt4_sb_öfo
 *
sbi
)

3048  (
	`©omic_ªad
(&
sbi
->
s_lock_busy
Ë> 
PXT4_CONTENTION_THRESHOLD
);

3049 
	}
}

3051 
ölöe
 
	$pxt4_lock_group
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
)

3053 
•ölock_t
 *
lock
 = 
	`pxt4_group_lock_±r
(
sb
, 
group
);

3054 i‡(
	`•ö_åylock
(
lock
))

3059 
	`©omic_add_u∆ess
(&
	`PXT4_SB
(
sb
)->
s_lock_busy
, -1, 0);

3065 
	`©omic_add_u∆ess
(&
	`PXT4_SB
(
sb
)->
s_lock_busy
, 1,

3066 
PXT4_MAX_CONTENTION
);

3067 
	`•ö_lock
(
lock
);

3069 
	}
}

3071 
ölöe
 
	$pxt4_u∆ock_group
(
su≥r_block
 *
sb
,

3072 
pxt4_group_t
 
group
)

3074 
	`•ö_u∆ock
(
	`pxt4_group_lock_±r
(
sb
, 
group
));

3075 
	}
}

3080 
	#pxt4_check_ödúe˘_blockªf
(
öode
, 
bh
) \

3081 
	`pxt4_check_blockªf
(
__func__
, 
__LINE__
, 
öode
, \

3082 (
__À32
 *)(
bh
)->
b_d©a
, \

3083 
	`PXT4_ADDR_PER_BLOCK
((
öode
)->
i_sb
))

	)

3085 
	#pxt4_öd_check_öode
(
öode
) \

3086 
	`pxt4_check_blockªf
(
__func__
, 
__LINE__
, 
öode
, \

3087 
	`PXT4_I
(
öode
)->
i_d©a
, \

3088 
PXT4_NDIR_BLOCKS
)

	)

3095 c⁄° 
fûe_›î©i⁄s
 
pxt4_dú_›î©i⁄s
;

3097 #ifde‡
CONFIG_UNICODE


3098 c⁄° 
díåy_›î©i⁄s
 
pxt4_díåy_›s
;

3102 c⁄° 
öode_›î©i⁄s
 
pxt4_fûe_öode_›î©i⁄s
;

3103 c⁄° 
fûe_›î©i⁄s
 
pxt4_fûe_›î©i⁄s
;

3104 
loff_t
 
pxt4_Œ£ek
(
fûe
 *fûe,Üoff_à
off£t
, 
‹igö
);

3107 
pxt4_gë_max_ölöe_size
(
öode
 *inode);

3108 
pxt4_föd_ölöe_d©a_nﬁock
(
öode
 *inode);

3109 
pxt4_öô_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3110 
Àn
);

3111 
pxt4_de°roy_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode);

3113 
pxt4_ªad∑ge_ölöe
(
öode
 *öode, 
∑ge
 *page);

3114 
pxt4_åy_to_wrôe_ölöe_d©a
(
addªss_•a˚
 *
m≠pög
,

3115 
öode
 *inode,

3116 
loff_t
 
pos
, 
Àn
,

3117 
Êags
,

3118 
∑ge
 **
∑gï
);

3119 
pxt4_wrôe_ölöe_d©a_íd
(
öode
 *inode,

3120 
loff_t
 
pos
, 
Àn
,

3121 
c›õd
,

3122 
∑ge
 *page);

3123 
buf„r_hód
 *

3124 
pxt4_jou∫ÆÀd_wrôe_ölöe_d©a
(
öode
 *inode,

3125 
Àn
,

3126 
∑ge
 *page);

3127 
pxt4_da_wrôe_ölöe_d©a_begö
(
addªss_•a˚
 *
m≠pög
,

3128 
öode
 *inode,

3129 
loff_t
 
pos
, 
Àn
,

3130 
Êags
,

3131 
∑ge
 **
∑gï
,

3132 **
fsd©a
);

3133 
pxt4_da_wrôe_ölöe_d©a_íd
(
öode
 *öode, 
loff_t
 
pos
,

3134 
Àn
, 
c›õd
,

3135 
∑ge
 *page);

3136 
pxt4_åy_add_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
,

3137 
pxt4_fûíame
 *
‚ame
,

3138 
öode
 *
dú
, inode *inode);

3139 
pxt4_åy_¸óã_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
,

3140 
öode
 *
∑ª¡
,

3141 
öode
 *inode);

3142 
pxt4_ªad_ölöe_dú
(
fûe
 *
fûp
,

3143 
dú_c⁄ãxt
 *
˘x
,

3144 *
has_ölöe_d©a
);

3145 
pxt4_ölöedú_to_åì
(
fûe
 *
dú_fûe
,

3146 
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

3147 
dx_hash_öfo
 *
höfo
,

3148 
__u32
 
°¨t_hash
, __u32 
°¨t_mö‹_hash
,

3149 *
has_ölöe_d©a
);

3150 
buf„r_hód
 *
pxt4_föd_ölöe_íåy
(
öode
 *
dú
,

3151 
pxt4_fûíame
 *
‚ame
,

3152 
pxt4_dú_íåy_2
 **
ªs_dú
,

3153 *
has_ölöe_d©a
);

3154 
pxt4_dñëe_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
,

3155 
öode
 *
dú
,

3156 
pxt4_dú_íåy_2
 *
de_dñ
,

3157 
buf„r_hód
 *
bh
,

3158 *
has_ölöe_d©a
);

3159 
boﬁ
 
em±y_ölöe_dú
(
öode
 *
dú
, *
has_ölöe_d©a
);

3160 
buf„r_hód
 *
pxt4_gë_fú°_ölöe_block
(
öode
 *inode,

3161 
pxt4_dú_íåy_2
 **
∑ª¡_de
,

3162 *
ªtvÆ
);

3163 
pxt4_ölöe_d©a_fõm≠
(
öode
 *inode,

3164 
fõm≠_exã¡_öfo
 *
fõöfo
,

3165 *
has_ölöe
, 
__u64
 
°¨t
, __u64 
Àn
);

3167 
	giom≠
;

3168 
pxt4_ölöe_d©a_iom≠
(
öode
 *öode, 
iom≠
 *iomap);

3170 
pxt4_ölöe_d©a_åunˇã
(
öode
 *öode, *
has_ölöe
);

3172 
pxt4_c⁄vît_ölöe_d©a
(
öode
 *inode);

3174 
ölöe
 
	$pxt4_has_ölöe_d©a
(
öode
 *inode)

3176  
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_INLINE_DATA
) &&

3177 
	`PXT4_I
(
öode
)->
i_ölöe_off
;

3178 
	}
}

3181 c⁄° 
öode_›î©i⁄s
 
pxt4_dú_öode_›î©i⁄s
;

3182 c⁄° 
öode_›î©i⁄s
 
pxt4_•ecül_öode_›î©i⁄s
;

3183 
díåy
 *
pxt4_gë_∑ª¡
(díåy *
chûd
);

3184 
pxt4_dú_íåy_2
 *
pxt4_öô_dŸ_dŸdŸ
(
öode
 *inode,

3185 
pxt4_dú_íåy_2
 *
de
,

3186 
blocksize
, 
csum_size
,

3187 
∑ª¡_öo
, 
dŸdŸ_ªÆ_Àn
);

3188 
pxt4_öôülize_dúít_èû
(
buf„r_hód
 *
bh
,

3189 
blocksize
);

3190 
pxt4_h™dÀ_dúty_dúblock
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3191 
buf„r_hód
 *
bh
);

3192 
pxt4_ci_com∑ª
(c⁄° 
öode
 *
∑ª¡
,

3193 c⁄° 
q°r
 *
‚ame
,

3194 c⁄° 
q°r
 *
íåy
, 
boﬁ
 
quick
);

3196 
	#S_SHIFT
 12

	)

3197 c⁄° 
	gpxt4_ty≥_by_mode
[(
S_IFMT
 >> 
S_SHIFT
) + 1] = {

3198 [
S_IFREG
 >> 
S_SHIFT
] = 
PXT4_FT_REG_FILE
,

3199 [
S_IFDIR
 >> 
S_SHIFT
] = 
PXT4_FT_DIR
,

3200 [
S_IFCHR
 >> 
S_SHIFT
] = 
PXT4_FT_CHRDEV
,

3201 [
S_IFBLK
 >> 
S_SHIFT
] = 
PXT4_FT_BLKDEV
,

3202 [
S_IFIFO
 >> 
S_SHIFT
] = 
PXT4_FT_FIFO
,

3203 [
S_IFSOCK
 >> 
S_SHIFT
] = 
PXT4_FT_SOCK
,

3204 [
S_IFLNK
 >> 
S_SHIFT
] = 
PXT4_FT_SYMLINK
,

3207 
ölöe
 
	$pxt4_£t_de_ty≥
(
su≥r_block
 *
sb
,

3208 
pxt4_dú_íåy_2
 *
de
,

3209 
umode_t
 
mode
) {

3210 i‡(
	`pxt4_has_„©uª_fûëy≥
(
sb
))

3211 
de
->
fûe_ty≥
 = 
pxt4_ty≥_by_mode
[(
mode
 & 
S_IFMT
)>>
S_SHIFT
];

3212 
	}
}

3215 
pxt4_m∑ge_ªad∑ges
(
addªss_•a˚
 *
m≠pög
,

3216 
li°_hód
 *
∑ges
, 
∑ge
 *page,

3217 
ƒ_∑ges
, 
boﬁ
 
is_ªadahód
);

3218 
__öô
 
pxt4_öô_po°_ªad_¥o˚ssög
();

3219 
pxt4_exô_po°_ªad_¥o˚ssög
();

3222 c⁄° 
öode_›î©i⁄s
 
pxt4_í¸y±ed_symlök_öode_›î©i⁄s
;

3223 c⁄° 
öode_›î©i⁄s
 
pxt4_symlök_öode_›î©i⁄s
;

3224 c⁄° 
öode_›î©i⁄s
 
pxt4_Á°_symlök_öode_›î©i⁄s
;

3227 
pxt4_ªgi°î_sysfs
(
su≥r_block
 *
sb
);

3228 
pxt4_uƒegi°î_sysfs
(
su≥r_block
 *
sb
);

3229 
__öô
 
pxt4_öô_sysfs
();

3230 
pxt4_exô_sysfs
();

3233 
pxt4_ªÀa£_sy°em_z⁄e
(
su≥r_block
 *
sb
);

3234 
pxt4_£tup_sy°em_z⁄e
(
su≥r_block
 *
sb
);

3235 
__öô
 
pxt4_öô_sy°em_z⁄e
();

3236 
pxt4_exô_sy°em_z⁄e
();

3237 
pxt4_d©a_block_vÆid
(
pxt4_sb_öfo
 *
sbi
,

3238 
pxt4_fsblk_t
 
°¨t_blk
,

3239 
cou¡
);

3240 
pxt4_check_blockªf
(const *, ,

3241 
öode
 *, 
__À32
 *, );

3244 
	gpxt4_ext_∑th
;

3245 
	gpxt4_exã¡
;

3251 
	#EXT_MAX_BLOCKS
 0xffffffff

	)

3253 
pxt4_ext_åì_öô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *);

3254 
pxt4_ext_wrôïage_å™s_blocks
(
öode
 *, );

3255 
pxt4_ext_ödex_å™s_blocks
(
öode
 *öode, 
exã¡s
);

3256 
pxt4_ext_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3257 
pxt4_m≠_blocks
 *
m≠
, 
Êags
);

3258 
pxt4_ext_åunˇã
(
h™dÀ_t
 *, 
öode
 *);

3259 
pxt4_ext_ªmove_•a˚
(
öode
 *öode, 
pxt4_lblk_t
 
°¨t
,

3260 
pxt4_lblk_t
 
íd
);

3261 
pxt4_ext_öô
(
su≥r_block
 *);

3262 
pxt4_ext_ªÀa£
(
su≥r_block
 *);

3263 
pxt4_ÁŒoˇã
(
fûe
 *fûe, 
mode
, 
loff_t
 
off£t
,

3264 
loff_t
 
Àn
);

3265 
pxt4_c⁄vît_unwrôãn_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3266 
loff_t
 
off£t
, 
ssize_t
 
Àn
);

3267 
pxt4_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3268 
pxt4_m≠_blocks
 *
m≠
, 
Êags
);

3269 
pxt4_ext_ˇlc_mëad©a_amou¡
(
öode
 *inode,

3270 
pxt4_lblk_t
 
lblocks
);

3271 
pxt4_ext_ˇlc_¸edôs_f‹_sögÀ_exã¡
(
öode
 *inode,

3272 
num
,

3273 
pxt4_ext_∑th
 *
∑th
);

3274 
pxt4_ˇn_exã¡s_be_mîged
(
öode
 *inode,

3275 
pxt4_exã¡
 *
ex1
,

3276 
pxt4_exã¡
 *
ex2
);

3277 
pxt4_ext_ö£π_exã¡
(
h™dÀ_t
 *, 
öode
 *,

3278 
pxt4_ext_∑th
 **,

3279 
pxt4_exã¡
 *, );

3280 
pxt4_ext_∑th
 *
pxt4_föd_exã¡
(
öode
 *, 
pxt4_lblk_t
,

3281 
pxt4_ext_∑th
 **,

3282 
Êags
);

3283 
pxt4_ext_dr›_ªfs
(
pxt4_ext_∑th
 *);

3284 
pxt4_ext_check_öode
(
öode
 *inode);

3285 
pxt4_lblk_t
 
pxt4_ext_√xt_Æloˇãd_block
(
pxt4_ext_∑th
 *
∑th
);

3286 
pxt4_fõm≠
(
öode
 *öode, 
fõm≠_exã¡_öfo
 *
fõöfo
,

3287 
__u64
 
°¨t
, __u64 
Àn
);

3288 
pxt4_gë_es_ˇche
(
öode
 *inode,

3289 
fõm≠_exã¡_öfo
 *
fõöfo
,

3290 
__u64
 
°¨t
, __u64 
Àn
);

3291 
pxt4_ext_¥eˇche
(
öode
 *inode);

3292 
pxt4_cﬁœp£_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
);

3293 
pxt4_ö£π_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
);

3294 
pxt4_sw≠_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
öode1
,

3295 
öode
 *
öode2
, 
pxt4_lblk_t
 
lblk1
,

3296 
pxt4_lblk_t
 
lblk2
,Öxt4_lblk_à
cou¡
,

3297 
m¨k_unwrôãn
,*
îr
);

3298 
pxt4_˛u_m≠≥d
(
öode
 *öode, 
pxt4_lblk_t
 
l˛u
);

3301 
pxt4_doubÀ_down_wrôe_d©a_£m
(
öode
 *
fú°
,

3302 
öode
 *
£c⁄d
);

3303 
pxt4_doubÀ_up_wrôe_d©a_£m
(
öode
 *
‹ig_öode
,

3304 
öode
 *
d⁄‹_öode
);

3305 
pxt4_move_exã¡s
(
fûe
 *
o_fûp
, fûê*
d_fûp
,

3306 
__u64
 
°¨t_‹ig
, __u64 
°¨t_d⁄‹
,

3307 
__u64
 
Àn
, __u64 *
moved_Àn
);

3310 
__öô
 
pxt4_öô_∑geio
();

3311 
pxt4_exô_∑geio
();

3312 
pxt4_io_íd_t
 *
pxt4_öô_io_íd
(
öode
 *öode, 
gÂ_t
 
Êags
);

3313 
pxt4_io_íd_t
 *
pxt4_gë_io_íd
’xt4_io_íd_à*
io_íd
);

3314 
pxt4_put_io_íd
(
pxt4_io_íd_t
 *
io_íd
);

3315 
pxt4_put_io_íd_de„r
(
pxt4_io_íd_t
 *
io_íd
);

3316 
pxt4_io_submô_öô
(
pxt4_io_submô
 *
io
,

3317 
wrôeback_c⁄åﬁ
 *
wbc
);

3318 
pxt4_íd_io_rsv_w‹k
(
w‹k_°ru˘
 *
w‹k
);

3319 
pxt4_io_submô
(pxt4_io_submô *
io
);

3320 
pxt4_bio_wrôe_∑ge
(
pxt4_io_submô
 *
io
,

3321 
∑ge
 *page,

3322 
Àn
,

3323 
wrôeback_c⁄åﬁ
 *
wbc
,

3324 
boﬁ
 
kìp_towrôe
);

3327 
pxt4_mu…i_mou¡_¥Ÿe˘
(
su≥r_block
 *, 
pxt4_fsblk_t
);

3330 c⁄° 
fsvîôy_›î©i⁄s
 
pxt4_vîôy›s
;

3337 
	#BH_BITMAP_UPTODATE
 
BH_JBDPriv©eSèπ


	)

3339 
ölöe
 
	$bôm≠_u±od©e
(
buf„r_hód
 *
bh
)

3341  (
	`buf„r_u±od©e
(
bh
) &&

3342 
	`ã°_bô
(
BH_BITMAP_UPTODATE
, &(
bh
)->
b_°©e
));

3343 
	}
}

3344 
ölöe
 
	$£t_bôm≠_u±od©e
(
buf„r_hód
 *
bh
)

3346 
	`£t_bô
(
BH_BITMAP_UPTODATE
, &(
bh
)->
b_°©e
);

3347 
	}
}

3349 
	#ö_ønge
(
b
, 
fú°
, 
Àn
Ë((bË>(fú°Ë&& (bË<(fú°Ë+ (ÀnË- 1)

	)

3352 
	#PXT4_WQ_HASH_SZ
 37

	)

3353 
	#pxt4_i€nd_wq
(
v
Ë(&
pxt4__i€nd_wq
[(()(v)) %\

3354 
PXT4_WQ_HASH_SZ
])

	)

3355 
waô_queue_hód_t
 
pxt4__i€nd_wq
[
PXT4_WQ_HASH_SZ
];

3357 
pxt4_ªsize_begö
(
su≥r_block
 *
sb
);

3358 
pxt4_ªsize_íd
(
su≥r_block
 *
sb
);

3360 
ölöe
 
	$pxt4_£t_io_unwrôãn_Êag
(
öode
 *inode,

3361 
pxt4_io_íd
 *
io_íd
)

3363 i‡(!(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
)) {

3364 
io_íd
->
Êag
 |
PXT4_IO_END_UNWRITTEN
;

3365 
	`©omic_öc
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
);

3367 
	}
}

3369 
ölöe
 
	$pxt4_˛ór_io_unwrôãn_Êag
(
pxt4_io_íd_t
 *
io_íd
)

3371 
öode
 *öodê
io_íd
->inode;

3373 i‡(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
) {

3374 
io_íd
->
Êag
 &~
PXT4_IO_END_UNWRITTEN
;

3376 i‡(
	`©omic_dec_™d_ã°
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
))

3377 
	`wake_up_Æl
(
	`pxt4_i€nd_wq
(
öode
));

3379 
	}
}

3381 c⁄° 
iom≠_›s
 
pxt4_iom≠_›s
;

3383 
ölöe
 
	$pxt4_buf„r_u±od©e
(
buf„r_hód
 *
bh
)

3391 i‡(!
	`buf„r_u±od©e
(
bh
Ë&& 
	`buf„r_wrôe_io_îr‹
(bh))

3392 
	`£t_buf„r_u±od©e
(
bh
);

3393  
	`buf„r_u±od©e
(
bh
);

3394 
	}
}

3398 
	#EFSBADCRC
 
EBADMSG


	)

3399 
	#EFSCORRUPTED
 
EUCLEAN


	)

	@ext4_extents.h

7 #i‚de‡
_PXT4_EXTENTS


8 
	#_PXT4_EXTENTS


	)

10 
	~"pxt4.h
"

18 
	#AGGRESSIVE_TEST_


	)

25 
	#EXTENTS_STATS__


	)

31 
	#CHECK_BINSEARCH__


	)

37 
	#EXT_STATS_


	)

55 
	spxt4_exã¡_èû
 {

56 
__À32
 
	më_checksum
;

63 
	spxt4_exã¡
 {

64 
__À32
 
	mì_block
;

65 
__À16
 
	mì_Àn
;

66 
__À16
 
	mì_°¨t_hi
;

67 
__À32
 
	mì_°¨t_lo
;

74 
	spxt4_exã¡_idx
 {

75 
__À32
 
	mei_block
;

76 
__À32
 
	mei_Àaf_lo
;

78 
__À16
 
	mei_Àaf_hi
;

79 
__u16
 
	mei_unu£d
;

85 
	spxt4_exã¡_hódî
 {

86 
__À16
 
	meh_magic
;

87 
__À16
 
	meh_íåõs
;

88 
__À16
 
	meh_max
;

89 
__À16
 
	meh_dïth
;

90 
__À32
 
	meh_gíî©i⁄
;

93 
	#PXT4_EXT_MAGIC
 
	`˝u_to_À16
(0xf30a)

	)

94 
	#PXT4_MAX_EXTENT_DEPTH
 5

	)

96 
	#PXT4_EXTENT_TAIL_OFFSET
(
hdr
) \

97 ((
pxt4_exã¡_hódî
) + \

98 ((
pxt4_exã¡
Ë* 
	`À16_to_˝u
((
hdr
)->
eh_max
)))

	)

100 
ölöe
 
pxt4_exã¡_èû
 *

101 
	$föd_pxt4_exã¡_èû
(
pxt4_exã¡_hódî
 *
eh
)

103  (
pxt4_exã¡_èû
 *)(((*)
eh
) +

104 
	`PXT4_EXTENT_TAIL_OFFSET
(
eh
));

105 
	}
}

112 
	spxt4_ext_∑th
 {

113 
pxt4_fsblk_t
 
	mp_block
;

114 
__u16
 
	mp_dïth
;

115 
__u16
 
	mp_maxdïth
;

116 
pxt4_exã¡
 *
	mp_ext
;

117 
pxt4_exã¡_idx
 *
	mp_idx
;

118 
pxt4_exã¡_hódî
 *
	mp_hdr
;

119 
buf„r_hód
 *
	mp_bh
;

129 
	s∑πül_˛u°î
 {

130 
pxt4_fsblk_t
 
	mp˛u
;

131 
pxt4_lblk_t
 
	mlblk
;

132 íum {
	möôül
, 
	mto‰ì
, 
	mno‰ì
} 
	m°©e
;

156 
	#EXT_INIT_MAX_LEN
 (1UL << 15)

	)

157 
	#EXT_UNWRITTEN_MAX_LEN
 (
EXT_INIT_MAX_LEN
 - 1)

	)

160 
	#EXT_FIRST_EXTENT
(
__hdr__
) \

161 ((
pxt4_exã¡
 *Ë(((*Ë(
__hdr__
)) + \

162 (
pxt4_exã¡_hódî
)))

	)

163 
	#EXT_FIRST_INDEX
(
__hdr__
) \

164 ((
pxt4_exã¡_idx
 *Ë(((*Ë(
__hdr__
)) + \

165 (
pxt4_exã¡_hódî
)))

	)

166 
	#EXT_HAS_FREE_INDEX
(
__∑th__
) \

167 (
	`À16_to_˝u
((
__∑th__
)->
p_hdr
->
eh_íåõs
) \

168 < 
	`À16_to_˝u
((
__∑th__
)->
p_hdr
->
eh_max
))

	)

169 
	#EXT_LAST_EXTENT
(
__hdr__
) \

170 (
	`EXT_FIRST_EXTENT
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_íåõs
Ë- 1)

	)

171 
	#EXT_LAST_INDEX
(
__hdr__
) \

172 (
	`EXT_FIRST_INDEX
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_íåõs
Ë- 1)

	)

173 
	#EXT_MAX_EXTENT
(
__hdr__
) \

174 (
	`EXT_FIRST_EXTENT
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_max
Ë- 1)

	)

175 
	#EXT_MAX_INDEX
(
__hdr__
) \

176 (
	`EXT_FIRST_INDEX
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_max
Ë- 1)

	)

178 
ölöe
 
pxt4_exã¡_hódî
 *
	$ext_öode_hdr
(
öode
 *inode)

180  (
pxt4_exã¡_hódî
 *Ë
	`PXT4_I
(
öode
)->
i_d©a
;

181 
	}
}

183 
ölöe
 
pxt4_exã¡_hódî
 *
	$ext_block_hdr
(
buf„r_hód
 *
bh
)

185  (
pxt4_exã¡_hódî
 *Ë
bh
->
b_d©a
;

186 
	}
}

188 
ölöe
 
	$ext_dïth
(
öode
 *inode)

190  
	`À16_to_˝u
(
	`ext_öode_hdr
(
öode
)->
eh_dïth
);

191 
	}
}

193 
ölöe
 
	$pxt4_ext_m¨k_unwrôãn
(
pxt4_exã¡
 *
ext
)

196 
	`BUG_ON
((
	`À16_to_˝u
(
ext
->
ì_Àn
Ë& ~
EXT_INIT_MAX_LEN
) == 0);

197 
ext
->
ì_Àn
 |
	`˝u_to_À16
(
EXT_INIT_MAX_LEN
);

198 
	}
}

200 
ölöe
 
	$pxt4_ext_is_unwrôãn
(
pxt4_exã¡
 *
ext
)

203  (
	`À16_to_˝u
(
ext
->
ì_Àn
Ë> 
EXT_INIT_MAX_LEN
);

204 
	}
}

206 
ölöe
 
	$pxt4_ext_gë_a˘uÆ_Àn
(
pxt4_exã¡
 *
ext
)

208  (
	`À16_to_˝u
(
ext
->
ì_Àn
Ë<
EXT_INIT_MAX_LEN
 ?

209 
	`À16_to_˝u
(
ext
->
ì_Àn
) :

210 (
	`À16_to_˝u
(
ext
->
ì_Àn
Ë- 
EXT_INIT_MAX_LEN
));

211 
	}
}

213 
ölöe
 
	$pxt4_ext_m¨k_öôülized
(
pxt4_exã¡
 *
ext
)

215 
ext
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ext));

216 
	}
}

222 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_ext_pblock
(
pxt4_exã¡
 *
ex
)

224 
pxt4_fsblk_t
 
block
;

226 
block
 = 
	`À32_to_˝u
(
ex
->
ì_°¨t_lo
);

227 
block
 |((
pxt4_fsblk_t
Ë
	`À16_to_˝u
(
ex
->
ì_°¨t_hi
) << 31) << 1;

228  
block
;

229 
	}
}

235 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_idx_pblock
(
pxt4_exã¡_idx
 *
ix
)

237 
pxt4_fsblk_t
 
block
;

239 
block
 = 
	`À32_to_˝u
(
ix
->
ei_Àaf_lo
);

240 
block
 |((
pxt4_fsblk_t
Ë
	`À16_to_˝u
(
ix
->
ei_Àaf_hi
) << 31) << 1;

241  
block
;

242 
	}
}

249 
ölöe
 
	$pxt4_ext_°‹e_pblock
(
pxt4_exã¡
 *
ex
,

250 
pxt4_fsblk_t
 
pb
)

252 
ex
->
ì_°¨t_lo
 = 
	`˝u_to_À32
((Ë(
pb
 & 0xffffffff));

253 
ex
->
ì_°¨t_hi
 = 
	`˝u_to_À16
((Ë((
pb
 >> 31) >> 1) &

255 
	}
}

262 
ölöe
 
	$pxt4_idx_°‹e_pblock
(
pxt4_exã¡_idx
 *
ix
,

263 
pxt4_fsblk_t
 
pb
)

265 
ix
->
ei_Àaf_lo
 = 
	`˝u_to_À32
((Ë(
pb
 & 0xffffffff));

266 
ix
->
ei_Àaf_hi
 = 
	`˝u_to_À16
((Ë((
pb
 >> 31) >> 1) &

268 
	}
}

270 
	#pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
) \

271 
	`__pxt4_ext_dúty
(
__func__
, 
__LINE__
, (
h™dÀ
), (
öode
), (
∑th
))

	)

272 
__pxt4_ext_dúty
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

273 
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
);

	@ext4_jbd2.c

6 
	~"pxt4_jbd3.h
"

8 
	~<åa˚/evíts/pxt4.h
>

11 
h™dÀ_t
 *
	$pxt4_gë_nojou∫Æ
()

13 
h™dÀ_t
 *
h™dÀ
 = 
cuºít
->
jou∫Æ_öfo
;

14 
ªf_˙t
 = ()
h™dÀ
;

16 
	`BUG_ON
(
ªf_˙t
 >
PXT4_NOJOURNAL_MAX_REF_COUNT
);

18 
ªf_˙t
++;

19 
h™dÀ
 = (
h™dÀ_t
 *)
ªf_˙t
;

21 
cuºít
->
jou∫Æ_öfo
 = 
h™dÀ
;

22  
h™dÀ
;

23 
	}
}

27 
	$pxt4_put_nojou∫Æ
(
h™dÀ_t
 *
h™dÀ
)

29 
ªf_˙t
 = ()
h™dÀ
;

31 
	`BUG_ON
(
ªf_˙t
 == 0);

33 
ªf_˙t
--;

34 
h™dÀ
 = (
h™dÀ_t
 *)
ªf_˙t
;

36 
cuºít
->
jou∫Æ_öfo
 = 
h™dÀ
;

37 
	}
}

42 
	$pxt4_jou∫Æ_check_°¨t
(
su≥r_block
 *
sb
)

44 
jou∫Æ_t
 *
jou∫Æ
;

46 
	`might_¶ìp
();

48 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

49  -
EIO
;

51 i‡(
	`sb_rd⁄ly
(
sb
))

52  -
EROFS
;

53 
	`WARN_ON
(
sb
->
s_wrôîs
.
‰ozí
 =
SB_FREEZE_COMPLETE
);

54 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

60 i‡(
jou∫Æ
 && 
	`is_jou∫Æ_ab‹ãd
(journal)) {

61 
	`pxt4_ab‹t
(
sb
, "Detectedáborted journal");

62  -
EROFS
;

65 
	}
}

67 
h™dÀ_t
 *
	$__pxt4_jou∫Æ_°¨t_sb
(
su≥r_block
 *
sb
, 
löe
,

68 
ty≥
, 
blocks
, 
rsv_blocks
)

70 
jou∫Æ_t
 *
jou∫Æ
;

71 
îr
;

73 
	`åa˚_pxt4_jou∫Æ_°¨t
(
sb
, 
blocks
, 
rsv_blocks
, 
_RET_IP_
);

74 
îr
 = 
	`pxt4_jou∫Æ_check_°¨t
(
sb
);

75 i‡(
îr
 < 0)

76  
	`ERR_PTR
(
îr
);

78 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

79 i‡(!
jou∫Æ
)

80  
	`pxt4_gë_nojou∫Æ
();

81  
	`jbd3__jou∫Æ_°¨t
(
jou∫Æ
, 
blocks
, 
rsv_blocks
, 
GFP_NOFS
,

82 
ty≥
, 
löe
);

83 
	}
}

85 
	$__pxt4_jou∫Æ_°›
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
)

87 
su≥r_block
 *
sb
;

88 
îr
;

89 
rc
;

91 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

92 
	`pxt4_put_nojou∫Æ
(
h™dÀ
);

96 
îr
 = 
h™dÀ
->
h_îr
;

97 i‡(!
h™dÀ
->
h_å™ß˘i⁄
) {

98 
rc
 = 
	`jbd3_jou∫Æ_°›
(
h™dÀ
);

99  
îr
 ?Éº : 
rc
;

102 
sb
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
->
j_¥iv©e
;

103 
rc
 = 
	`jbd3_jou∫Æ_°›
(
h™dÀ
);

105 i‡(!
îr
)

106 
îr
 = 
rc
;

107 i‡(
îr
)

108 
	`__pxt4_°d_îr‹
(
sb
, 
whîe
, 
löe
, 
îr
);

109  
îr
;

110 
	}
}

112 
h™dÀ_t
 *
	$__pxt4_jou∫Æ_°¨t_ª£rved
(
h™dÀ_t
 *
h™dÀ
, 
löe
,

113 
ty≥
)

115 
su≥r_block
 *
sb
;

116 
îr
;

118 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

119  
	`pxt4_gë_nojou∫Æ
();

121 
sb
 = 
h™dÀ
->
h_jou∫Æ
->
j_¥iv©e
;

122 
	`åa˚_pxt4_jou∫Æ_°¨t_ª£rved
(
sb
, 
h™dÀ
->
h_buf„r_¸edôs
,

123 
_RET_IP_
);

124 
îr
 = 
	`pxt4_jou∫Æ_check_°¨t
(
sb
);

125 i‡(
îr
 < 0) {

126 
	`jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ
);

127  
	`ERR_PTR
(
îr
);

130 
îr
 = 
	`jbd3_jou∫Æ_°¨t_ª£rved
(
h™dÀ
, 
ty≥
, 
löe
);

131 i‡(
îr
 < 0)

132  
	`ERR_PTR
(
îr
);

133  
h™dÀ
;

134 
	}
}

136 
	$pxt4_jou∫Æ_ab‹t_h™dÀ
(c⁄° *
ˇŒî
, 
löe
,

137 c⁄° *
îr_‚
,

138 
buf„r_hód
 *
bh
,

139 
h™dÀ_t
 *
h™dÀ
, 
îr
)

141 
nbuf
[16];

142 c⁄° *
îr°r
 = 
	`pxt4_decode_îr‹
(
NULL
, 
îr
, 
nbuf
);

144 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

146 i‡(
bh
)

147 
	`BUFFER_TRACE
(
bh
, "abort");

149 i‡(!
h™dÀ
->
h_îr
)

150 
h™dÀ
->
h_îr
 = 
îr
;

152 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

155 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: %s:%d:ábortingÅransaction: %s in %s\n",

156 
ˇŒî
, 
löe
, 
îr°r
, 
îr_‚
);

158 
	`jbd3_jou∫Æ_ab‹t_h™dÀ
(
h™dÀ
);

159 
	}
}

161 
	$__pxt4_jou∫Æ_gë_wrôe_ac˚ss
(c⁄° *
whîe
, 
löe
,

162 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

164 
îr
 = 0;

166 
	`might_¶ìp
();

168 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

169 
îr
 = 
	`jbd3_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

170 i‡(
îr
)

171 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
, 
bh
,

172 
h™dÀ
, 
îr
);

174  
îr
;

175 
	}
}

189 
	$__pxt4_f‹gë
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

190 
is_mëad©a
, 
öode
 *inode,

191 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
blockƒ
)

193 
îr
;

195 
	`might_¶ìp
();

197 
	`åa˚_pxt4_f‹gë
(
öode
, 
is_mëad©a
, 
blockƒ
);

198 
	`BUFFER_TRACE
(
bh
, "enter");

200 
	`jbd_debug
(4, "forgetting bh %p: is_metadata = %d, mode %o, "

202 
bh
, 
is_mëad©a
, 
öode
->
i_mode
,

203 
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
));

206 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

207 
	`bf‹gë
(
bh
);

216 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
 ||

217 (!
is_mëad©a
 && !
	`pxt4_should_jou∫Æ_d©a
(
öode
))) {

218 i‡(
bh
) {

219 
	`BUFFER_TRACE
(
bh
, "call jbd3_journal_forget");

220 
îr
 = 
	`jbd3_jou∫Æ_f‹gë
(
h™dÀ
, 
bh
);

221 i‡(
îr
)

222 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

223 
bh
, 
h™dÀ
, 
îr
);

224  
îr
;

232 
	`BUFFER_TRACE
(
bh
, "call jbd3_journal_revoke");

233 
îr
 = 
	`jbd3_jou∫Æ_ªvoke
(
h™dÀ
, 
blockƒ
, 
bh
);

234 i‡(
îr
) {

235 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

236 
bh
, 
h™dÀ
, 
îr
);

237 
	`__pxt4_ab‹t
(
öode
->
i_sb
, 
whîe
, 
löe
,

238 "îr‹ %d whíáâem±ögÑevoke", 
îr
);

240 
	`BUFFER_TRACE
(
bh
, "exit");

241  
îr
;

242 
	}
}

244 
	$__pxt4_jou∫Æ_gë_¸óã_ac˚ss
(c⁄° *
whîe
, 
löe
,

245 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

247 
îr
 = 0;

249 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

250 
îr
 = 
	`jbd3_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

251 i‡(
îr
)

252 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

253 
bh
, 
h™dÀ
, 
îr
);

255  
îr
;

256 
	}
}

258 
	$__pxt4_h™dÀ_dúty_mëad©a
(c⁄° *
whîe
, 
löe
,

259 
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

260 
buf„r_hód
 *
bh
)

262 
îr
 = 0;

264 
	`might_¶ìp
();

266 
	`£t_buf„r_mëa
(
bh
);

267 
	`£t_buf„r_¥io
(
bh
);

268 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

269 
îr
 = 
	`jbd3_jou∫Æ_dúty_mëad©a
(
h™dÀ
, 
bh
);

271 i‡(!
	`is_h™dÀ_ab‹ãd
(
h™dÀ
Ë&& 
	`WARN_ON_ONCE
(
îr
)) {

272 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
, 
bh
,

273 
h™dÀ
, 
îr
);

274 i‡(
öode
 =
NULL
) {

275 
	`¥_îr
("PXT4: jbd3_journal_dirty_metadata "

278 
h™dÀ
->
h_ty≥
,

279 
h™dÀ
->
h_löe_no
,

280 
h™dÀ
->
h_ªque°ed_¸edôs
,

281 
h™dÀ
->
h_buf„r_¸edôs
, 
îr
);

282  
îr
;

284 
	`pxt4_îr‹_öode
(
öode
, 
whîe
, 
löe
,

285 
bh
->
b_blockƒ
,

289 
h™dÀ
->
h_ty≥
,

290 
h™dÀ
->
h_löe_no
,

291 
h™dÀ
->
h_ªque°ed_¸edôs
,

292 
h™dÀ
->
h_buf„r_¸edôs
, 
îr
);

295 i‡(
öode
)

296 
	`m¨k_buf„r_dúty_öode
(
bh
, 
öode
);

298 
	`m¨k_buf„r_dúty
(
bh
);

299 i‡(
öode
 && 
	`öode_√eds_sync
(inode)) {

300 
	`sync_dúty_buf„r
(
bh
);

301 i‡(
	`buf„r_ªq
(
bh
Ë&& !
	`buf„r_u±od©e
(bh)) {

302 
pxt4_su≥r_block
 *
es
;

304 
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

305 
es
->
s_œ°_îr‹_block
 =

306 
	`˝u_to_À64
(
bh
->
b_blockƒ
);

307 
	`pxt4_îr‹_öode
(
öode
, 
whîe
, 
löe
,

308 
bh
->
b_blockƒ
,

310 
îr
 = -
EIO
;

314  
îr
;

315 
	}
}

317 
	$__pxt4_h™dÀ_dúty_su≥r
(c⁄° *
whîe
, 
löe
,

318 
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
)

320 
buf„r_hód
 *
bh
 = 
	`PXT4_SB
(
sb
)->
s_sbh
;

321 
îr
 = 0;

323 
	`pxt4_su≥rblock_csum_£t
(
sb
);

324 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

325 
îr
 = 
	`jbd3_jou∫Æ_dúty_mëad©a
(
h™dÀ
, 
bh
);

326 i‡(
îr
)

327 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

328 
bh
, 
h™dÀ
, 
îr
);

330 
	`m¨k_buf„r_dúty
(
bh
);

331  
îr
;

332 
	}
}

	@ext4_jbd2.h

12 #i‚de‡
_PXT4_JBD3_H


13 
	#_PXT4_JBD3_H


	)

15 
	~<löux/fs.h
>

16 
	~<löux/jbd3.h
>

17 
	~"pxt4.h
"

19 
	#PXT4_JOURNAL
(
öode
Ë(
	`PXT4_SB
((öode)->
i_sb
)->
s_jou∫Æ
)

	)

33 
	#PXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
) \

34 (
	`pxt4_has_„©uª_exã¡s
(
sb
Ë? 20U : 8U)

	)

40 
	#PXT4_XATTR_TRANS_BLOCKS
 6U

	)

48 
	#PXT4_DATA_TRANS_BLOCKS
(
sb
Ë(
	`PXT4_SINGLEDATA_TRANS_BLOCKS
(sb) + \

49 
PXT4_XATTR_TRANS_BLOCKS
 - 2 + \

50 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
))

	)

57 
	#PXT4_META_TRANS_BLOCKS
(
sb
Ë(
PXT4_XATTR_TRANS_BLOCKS
 + \

58 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
))

	)

66 
	#PXT4_MAX_TRANS_DATA
 64U

	)

75 
	#PXT4_RESERVE_TRANS_BLOCKS
 12U

	)

84 
	#PXT4_INDEX_EXTRA_TRANS_BLOCKS
 12U

	)

86 #ifde‡
CONFIG_QUOTA


89 
	#PXT4_QUOTA_TRANS_BLOCKS
(
sb
Ë((
	`ã°_›t
(sb, 
QUOTA
) ||\

90 
	`pxt4_has_„©uª_quŸa
(
sb
)Ë? 1 : 0)

	)

93 
	#PXT4_QUOTA_INIT_BLOCKS
(
sb
Ë((
	`ã°_›t
(sb, 
QUOTA
) ||\

94 
	`pxt4_has_„©uª_quŸa
(
sb
)) ?\

95 (
DQUOT_INIT_ALLOC
*(
	`PXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
)-3)\

96 +3+
DQUOT_INIT_REWRITE
Ë: 0)

	)

98 
	#PXT4_QUOTA_DEL_BLOCKS
(
sb
Ë((
	`ã°_›t
(sb, 
QUOTA
) ||\

99 
	`pxt4_has_„©uª_quŸa
(
sb
)) ?\

100 (
DQUOT_DEL_ALLOC
*(
	`PXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
)-3)\

101 +3+
DQUOT_DEL_REWRITE
Ë: 0)

	)

103 
	#PXT4_QUOTA_TRANS_BLOCKS
(
sb
Ë0

	)

104 
	#PXT4_QUOTA_INIT_BLOCKS
(
sb
Ë0

	)

105 
	#PXT4_QUOTA_DEL_BLOCKS
(
sb
Ë0

	)

107 
	#PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
Ë(
PXT4_MAXQUOTAS
*
	`PXT4_QUOTA_TRANS_BLOCKS
(sb))

	)

108 
	#PXT4_MAXQUOTAS_INIT_BLOCKS
(
sb
Ë(
PXT4_MAXQUOTAS
*
	`PXT4_QUOTA_INIT_BLOCKS
(sb))

	)

109 
	#PXT4_MAXQUOTAS_DEL_BLOCKS
(
sb
Ë(
PXT4_MAXQUOTAS
*
	`PXT4_QUOTA_DEL_BLOCKS
(sb))

	)

114 
	#PXT4_HT_MISC
 0

	)

115 
	#PXT4_HT_INODE
 1

	)

116 
	#PXT4_HT_WRITE_PAGE
 2

	)

117 
	#PXT4_HT_MAP_BLOCKS
 3

	)

118 
	#PXT4_HT_DIR
 4

	)

119 
	#PXT4_HT_TRUNCATE
 5

	)

120 
	#PXT4_HT_QUOTA
 6

	)

121 
	#PXT4_HT_RESIZE
 7

	)

122 
	#PXT4_HT_MIGRATE
 8

	)

123 
	#PXT4_HT_MOVE_EXTENTS
 9

	)

124 
	#PXT4_HT_XATTR
 10

	)

125 
	#PXT4_HT_EXT_CONVERT
 11

	)

126 
	#PXT4_HT_MAX
 12

	)

136 
	spxt4_jou∫Æ_cb_íåy
 {

138 
li°_hód
 
	mj˚_li°
;

141 (*
	mj˚_func
)(
su≥r_block
 *
	msb
,

142 
pxt4_jou∫Æ_cb_íåy
 *
	mj˚
, 
	mîr‹
);

168 
ölöe
 
	$_pxt4_jou∫Æ_ˇŒback_add
(
h™dÀ_t
 *
h™dÀ
,

169 
pxt4_jou∫Æ_cb_íåy
 *
j˚
)

172 
	`li°_add_èû
(&
j˚
->
j˚_li°
, &
h™dÀ
->
h_å™ß˘i⁄
->
t_¥iv©e_li°
);

173 
	}
}

175 
ölöe
 
	$pxt4_jou∫Æ_ˇŒback_add
(
h™dÀ_t
 *
h™dÀ
,

176 (*
func
)(
su≥r_block
 *
sb
,

177 
pxt4_jou∫Æ_cb_íåy
 *
j˚
,

178 
rc
),

179 
pxt4_jou∫Æ_cb_íåy
 *
j˚
)

181 
pxt4_sb_öfo
 *
sbi
 =

182 
	`PXT4_SB
(
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
->
j_¥iv©e
);

185 
j˚
->
j˚_func
 = 
func
;

186 
	`•ö_lock
(&
sbi
->
s_md_lock
);

187 
	`_pxt4_jou∫Æ_ˇŒback_add
(
h™dÀ
, 
j˚
);

188 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

189 
	}
}

198 
ölöe
 
boﬁ
 
	$pxt4_jou∫Æ_ˇŒback_åy_dñ
(
h™dÀ_t
 *
h™dÀ
,

199 
pxt4_jou∫Æ_cb_íåy
 *
j˚
)

201 
boﬁ
 
dñëed
;

202 
pxt4_sb_öfo
 *
sbi
 =

203 
	`PXT4_SB
(
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
->
j_¥iv©e
);

205 
	`•ö_lock
(&
sbi
->
s_md_lock
);

206 
dñëed
 = !
	`li°_em±y
(&
j˚
->
j˚_li°
);

207 
	`li°_dñ_öô
(&
j˚
->
j˚_li°
);

208 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

209  
dñëed
;

210 
	}
}

213 
pxt4_m¨k_ûoc_dúty
(
h™dÀ_t
 *
h™dÀ
,

214 
öode
 *inode,

215 
pxt4_ûoc
 *
ûoc
);

222 
pxt4_ª£rve_öode_wrôe
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

223 
pxt4_ûoc
 *
ûoc
);

225 
pxt4_m¨k_öode_dúty
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode);

227 
pxt4_ex∑nd_exåa_isize
(
öode
 *inode,

228 
√w_exåa_isize
,

229 
pxt4_ûoc
 *
ûoc
);

233 
__pxt4_jou∫Æ_gë_wrôe_ac˚ss
(c⁄° *
whîe
, 
löe
,

234 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
);

236 
__pxt4_f‹gë
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

237 
is_mëad©a
, 
öode
 *inode,

238 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
blockƒ
);

240 
__pxt4_jou∫Æ_gë_¸óã_ac˚ss
(c⁄° *
whîe
, 
löe
,

241 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
);

243 
__pxt4_h™dÀ_dúty_mëad©a
(c⁄° *
whîe
, 
löe
,

244 
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

245 
buf„r_hód
 *
bh
);

247 
__pxt4_h™dÀ_dúty_su≥r
(c⁄° *
whîe
, 
löe
,

248 
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
);

250 
	#pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
) \

251 
	`__pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
__func__
, 
__LINE__
, (
h™dÀ
), (
bh
))

	)

252 
	#pxt4_f‹gë
(
h™dÀ
, 
is_mëad©a
, 
öode
, 
bh
, 
block_ƒ
) \

253 
	`__pxt4_f‹gë
(
__func__
, 
__LINE__
, (
h™dÀ
), (
is_mëad©a
), (
öode
), \

254 (
bh
), (
block_ƒ
))

	)

255 
	#pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
) \

256 
	`__pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
__func__
, 
__LINE__
, (
h™dÀ
), (
bh
))

	)

257 
	#pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
) \

258 
	`__pxt4_h™dÀ_dúty_mëad©a
(
__func__
, 
__LINE__
, (
h™dÀ
), (
öode
), \

259 (
bh
))

	)

260 
	#pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
) \

261 
	`__pxt4_h™dÀ_dúty_su≥r
(
__func__
, 
__LINE__
, (
h™dÀ
), (
sb
))

	)

263 
h™dÀ_t
 *
__pxt4_jou∫Æ_°¨t_sb
(
su≥r_block
 *
sb
, 
löe
,

264 
ty≥
, 
blocks
, 
rsv_blocks
);

265 
__pxt4_jou∫Æ_°›
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
);

267 
	#PXT4_NOJOURNAL_MAX_REF_COUNT
 ((Ë4096)

	)

271 
ölöe
 
	$pxt4_h™dÀ_vÆid
(
h™dÀ_t
 *
h™dÀ
)

273 i‡(()
h™dÀ
 < 
PXT4_NOJOURNAL_MAX_REF_COUNT
)

276 
	}
}

278 
ölöe
 
	$pxt4_h™dÀ_sync
(
h™dÀ_t
 *
h™dÀ
)

280 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

281 
h™dÀ
->
h_sync
 = 1;

282 
	}
}

284 
ölöe
 
	$pxt4_h™dÀ_is_ab‹ãd
(
h™dÀ_t
 *
h™dÀ
)

286 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

287  
	`is_h™dÀ_ab‹ãd
(
h™dÀ
);

289 
	}
}

291 
ölöe
 
	$pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ_t
 *
h™dÀ
, 
√eded
)

293 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë&& h™dÀ->
h_buf„r_¸edôs
 < 
√eded
)

296 
	}
}

298 
	#pxt4_jou∫Æ_°¨t_sb
(
sb
, 
ty≥
, 
nblocks
) \

299 
	`__pxt4_jou∫Æ_°¨t_sb
((
sb
), 
__LINE__
, (
ty≥
), (
nblocks
), 0)

	)

301 
	#pxt4_jou∫Æ_°¨t
(
öode
, 
ty≥
, 
nblocks
) \

302 
	`__pxt4_jou∫Æ_°¨t
((
öode
), 
__LINE__
, (
ty≥
), (
nblocks
), 0)

	)

304 
	#pxt4_jou∫Æ_°¨t_wôh_ª£rve
(
öode
, 
ty≥
, 
blocks
, 
rsv_blocks
) \

305 
	`__pxt4_jou∫Æ_°¨t
((
öode
), 
__LINE__
, (
ty≥
), (
blocks
), (
rsv_blocks
))

	)

307 
ölöe
 
h™dÀ_t
 *
	$__pxt4_jou∫Æ_°¨t
(
öode
 *inode,

308 
löe
, 
ty≥
,

309 
blocks
, 
rsv_blocks
)

311  
	`__pxt4_jou∫Æ_°¨t_sb
(
öode
->
i_sb
, 
löe
, 
ty≥
, 
blocks
,

312 
rsv_blocks
);

313 
	}
}

315 
	#pxt4_jou∫Æ_°›
(
h™dÀ
) \

316 
	`__pxt4_jou∫Æ_°›
(
__func__
, 
__LINE__
, (
h™dÀ
))

	)

318 
	#pxt4_jou∫Æ_°¨t_ª£rved
(
h™dÀ
, 
ty≥
) \

319 
	`__pxt4_jou∫Æ_°¨t_ª£rved
((
h™dÀ
), 
__LINE__
, (
ty≥
))

	)

321 
h™dÀ_t
 *
__pxt4_jou∫Æ_°¨t_ª£rved
(h™dÀ_à*
h™dÀ
, 
löe
,

322 
ty≥
);

324 
ölöe
 
	$pxt4_jou∫Æ_‰ì_ª£rved
(
h™dÀ_t
 *
h™dÀ
)

326 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

327 
	`jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ
);

328 
	}
}

330 
ölöe
 
h™dÀ_t
 *
	$pxt4_jou∫Æ_cuºít_h™dÀ
()

332  
	`jou∫Æ_cuºít_h™dÀ
();

333 
	}
}

335 
ölöe
 
	$pxt4_jou∫Æ_exãnd
(
h™dÀ_t
 *
h™dÀ
, 
nblocks
)

337 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

338  
	`jbd3_jou∫Æ_exãnd
(
h™dÀ
, 
nblocks
);

340 
	}
}

342 
ölöe
 
	$pxt4_jou∫Æ_ª°¨t
(
h™dÀ_t
 *
h™dÀ
, 
nblocks
)

344 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

345  
	`jbd3_jou∫Æ_ª°¨t
(
h™dÀ
, 
nblocks
);

347 
	}
}

349 
ölöe
 
	$pxt4_jou∫Æ_blocks_≥r_∑ge
(
öode
 *inode)

351 i‡(
	`PXT4_JOURNAL
(
öode
Ë!
NULL
)

352  
	`jbd3_jou∫Æ_blocks_≥r_∑ge
(
öode
);

354 
	}
}

356 
ölöe
 
	$pxt4_jou∫Æ_f‹˚_commô
(
jou∫Æ_t
 *
jou∫Æ
)

358 i‡(
jou∫Æ
)

359  
	`jbd3_jou∫Æ_f‹˚_commô
(
jou∫Æ
);

361 
	}
}

363 
ölöe
 
	$pxt4_jbd3_öode_add_wrôe
(
h™dÀ_t
 *
h™dÀ
,

364 
öode
 *öode, 
loff_t
 
°¨t_byã
,Üoff_à
Àngth
)

366 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

367  
	`jbd3_jou∫Æ_öode_ønged_wrôe
(
h™dÀ
,

368 
	`PXT4_I
(
öode
)->
jöode
, 
°¨t_byã
, 
Àngth
);

370 
	}
}

372 
ölöe
 
	$pxt4_jbd3_öode_add_waô
(
h™dÀ_t
 *
h™dÀ
,

373 
öode
 *öode, 
loff_t
 
°¨t_byã
,Üoff_à
Àngth
)

375 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

376  
	`jbd3_jou∫Æ_öode_ønged_waô
(
h™dÀ
,

377 
	`PXT4_I
(
öode
)->
jöode
, 
°¨t_byã
, 
Àngth
);

379 
	}
}

381 
ölöe
 
	$pxt4_upd©e_öode_fsync_å™s
(
h™dÀ_t
 *
h™dÀ
,

382 
öode
 *inode,

383 
d©async
)

385 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

387 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë&& !
	`is_h™dÀ_ab‹ãd
(handle)) {

388 
ei
->
i_sync_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

389 i‡(
d©async
)

390 
ei
->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

392 
	}
}

395 
pxt4_f‹˚_commô
(
su≥r_block
 *
sb
);

400 
	#PXT4_INODE_JOURNAL_DATA_MODE
 0x01

	)

401 
	#PXT4_INODE_ORDERED_DATA_MODE
 0x02

	)

402 
	#PXT4_INODE_WRITEBACK_DATA_MODE
 0x04

	)

404 
ölöe
 
	$pxt4_öode_jou∫Æ_mode
(
öode
 *inode)

406 i‡(
	`PXT4_JOURNAL
(
öode
Ë=
NULL
)

407  
PXT4_INODE_WRITEBACK_DATA_MODE
;

409 i‡(!
	`S_ISREG
(
öode
->
i_mode
) ||

410 
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
 ||

411 (
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_JOURNAL_DATA
) &&

412 !
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))) {

414 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë&& 
	`IS_ENCRYPTED
(inode))

415  
PXT4_INODE_ORDERED_DATA_MODE
;

416  
PXT4_INODE_JOURNAL_DATA_MODE
;

418 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
)

419  
PXT4_INODE_ORDERED_DATA_MODE
;

420 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_WRITEBACK_DATA
)

421  
PXT4_INODE_WRITEBACK_DATA_MODE
;

422 
	`BUG
();

423 
	}
}

425 
ölöe
 
	$pxt4_should_jou∫Æ_d©a
(
öode
 *inode)

427  
	`pxt4_öode_jou∫Æ_mode
(
öode
Ë& 
PXT4_INODE_JOURNAL_DATA_MODE
;

428 
	}
}

430 
ölöe
 
	$pxt4_should_‹dî_d©a
(
öode
 *inode)

432  
	`pxt4_öode_jou∫Æ_mode
(
öode
Ë& 
PXT4_INODE_ORDERED_DATA_MODE
;

433 
	}
}

435 
ölöe
 
	$pxt4_should_wrôeback_d©a
(
öode
 *inode)

437  
	`pxt4_öode_jou∫Æ_mode
(
öode
Ë& 
PXT4_INODE_WRITEBACK_DATA_MODE
;

438 
	}
}

449 
ölöe
 
	$pxt4_should_di‹ód_nﬁock
(
öode
 *inode)

451 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
DIOREAD_NOLOCK
))

453 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

455 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

457 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

460 
	}
}

	@extents.c

20 
	~<löux/fs.h
>

21 
	~<löux/time.h
>

22 
	~<löux/jbd3.h
>

23 
	~<löux/highuid.h
>

24 
	~<löux/∑gem≠.h
>

25 
	~<löux/quŸa›s.h
>

26 
	~<löux/°rög.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/uac˚ss.h
>

29 
	~<löux/fõm≠.h
>

30 
	~<löux/backög-dev.h
>

31 
	~"pxt4_jbd3.h
"

32 
	~"pxt4_exã¡s.h
"

33 
	~"x©å.h
"

35 
	~<åa˚/evíts/pxt4.h
>

40 
	#PXT4_EXT_MAY_ZEROOUT
 0x1

	)

42 
	#PXT4_EXT_MARK_UNWRIT1
 0x2

	)

43 
	#PXT4_EXT_MARK_UNWRIT2
 0x4

	)

45 
	#PXT4_EXT_DATA_VALID1
 0x8

	)

46 
	#PXT4_EXT_DATA_VALID2
 0x10

	)

48 
__À32
 
	$pxt4_exã¡_block_csum
(
öode
 *inode,

49 
pxt4_exã¡_hódî
 *
eh
)

51 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

52 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

53 
__u32
 
csum
;

55 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
eh
,

56 
	`PXT4_EXTENT_TAIL_OFFSET
(
eh
));

57  
	`˝u_to_À32
(
csum
);

58 
	}
}

60 
	$pxt4_exã¡_block_csum_vîify
(
öode
 *inode,

61 
pxt4_exã¡_hódî
 *
eh
)

63 
pxt4_exã¡_èû
 *
ë
;

65 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

68 
ë
 = 
	`föd_pxt4_exã¡_èû
(
eh
);

69 i‡(
ë
->
ë_checksum
 !
	`pxt4_exã¡_block_csum
(
öode
, 
eh
))

72 
	}
}

74 
	$pxt4_exã¡_block_csum_£t
(
öode
 *inode,

75 
pxt4_exã¡_hódî
 *
eh
)

77 
pxt4_exã¡_èû
 *
ë
;

79 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

82 
ë
 = 
	`föd_pxt4_exã¡_èû
(
eh
);

83 
ë
->
ë_checksum
 = 
	`pxt4_exã¡_block_csum
(
öode
, 
eh
);

84 
	}
}

86 
pxt4_•lô_exã¡
(
h™dÀ_t
 *
h™dÀ
,

87 
öode
 *inode,

88 
pxt4_ext_∑th
 **
µ©h
,

89 
pxt4_m≠_blocks
 *
m≠
,

90 
•lô_Êag
,

91 
Êags
);

93 
pxt4_•lô_exã¡_©
(
h™dÀ_t
 *
h™dÀ
,

94 
öode
 *inode,

95 
pxt4_ext_∑th
 **
µ©h
,

96 
pxt4_lblk_t
 
•lô
,

97 
•lô_Êag
,

98 
Êags
);

100 
pxt4_föd_dñayed_exã¡
(
öode
 *inode,

101 
exã¡_°©us
 *
√wes
);

103 
	$pxt4_ext_åunˇã_exãnd_ª°¨t
(
h™dÀ_t
 *
h™dÀ
,

104 
öode
 *inode,

105 
√eded
)

107 
îr
;

109 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

111 i‡(
h™dÀ
->
h_buf„r_¸edôs
 >
√eded
)

117 
√eded
 += 3;

118 
îr
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
√eded
 - h™dÀ->
h_buf„r_¸edôs
);

119 i‡(
îr
 <= 0)

120  
îr
;

121 
îr
 = 
	`pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ
, 
öode
, 
√eded
);

122 i‡(
îr
 == 0)

123 
îr
 = -
EAGAIN
;

125  
îr
;

126 
	}
}

133 
	$pxt4_ext_gë_ac˚ss
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

134 
pxt4_ext_∑th
 *
∑th
)

136 i‡(
∑th
->
p_bh
) {

138 
	`BUFFER_TRACE
(
∑th
->
p_bh
, "get_write_access");

139  
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
∑th
->
p_bh
);

144 
	}
}

152 
	$__pxt4_ext_dúty
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

153 
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
)

155 
îr
;

157 
	`WARN_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

158 i‡(
∑th
->
p_bh
) {

159 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
	`ext_block_hdr
(
∑th
->
p_bh
));

161 
îr
 = 
	`__pxt4_h™dÀ_dúty_mëad©a
(
whîe
, 
löe
, 
h™dÀ
,

162 
öode
, 
∑th
->
p_bh
);

165 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

167  
îr
;

168 
	}
}

170 
pxt4_fsblk_t
 
	$pxt4_ext_föd_gﬂl
(
öode
 *inode,

171 
pxt4_ext_∑th
 *
∑th
,

172 
pxt4_lblk_t
 
block
)

174 i‡(
∑th
) {

175 
dïth
 = 
∑th
->
p_dïth
;

176 
pxt4_exã¡
 *
ex
;

195 
ex
 = 
∑th
[
dïth
].
p_ext
;

196 i‡(
ex
) {

197 
pxt4_fsblk_t
 
ext_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

198 
pxt4_lblk_t
 
ext_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

200 i‡(
block
 > 
ext_block
)

201  
ext_pblk
 + (
block
 - 
ext_block
);

203  
ext_pblk
 - (
ext_block
 - 
block
);

208 i‡(
∑th
[
dïth
].
p_bh
)

209  
∑th
[
dïth
].
p_bh
->
b_blockƒ
;

213  
	`pxt4_öode_to_gﬂl_block
(
öode
);

214 
	}
}

219 
pxt4_fsblk_t


220 
	$pxt4_ext_√w_mëa_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

221 
pxt4_ext_∑th
 *
∑th
,

222 
pxt4_exã¡
 *
ex
, *
îr
, 
Êags
)

224 
pxt4_fsblk_t
 
gﬂl
, 
√wblock
;

226 
gﬂl
 = 
	`pxt4_ext_föd_gﬂl
(
öode
, 
∑th
, 
	`À32_to_˝u
(
ex
->
ì_block
));

227 
√wblock
 = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
, 
öode
, 
gﬂl
, 
Êags
,

228 
NULL
, 
îr
);

229  
√wblock
;

230 
	}
}

232 
ölöe
 
	$pxt4_ext_•a˚_block
(
öode
 *öode, 
check
)

234 
size
;

236 
size
 = (
öode
->
i_sb
->
s_blocksize
 - (
pxt4_exã¡_hódî
))

237 / (
pxt4_exã¡
);

238 #ifde‡
AGGRESSIVE_TEST


239 i‡(!
check
 && 
size
 > 6)

240 
size
 = 6;

242  
size
;

243 
	}
}

245 
ölöe
 
	$pxt4_ext_•a˚_block_idx
(
öode
 *öode, 
check
)

247 
size
;

249 
size
 = (
öode
->
i_sb
->
s_blocksize
 - (
pxt4_exã¡_hódî
))

250 / (
pxt4_exã¡_idx
);

251 #ifde‡
AGGRESSIVE_TEST


252 i‡(!
check
 && 
size
 > 5)

253 
size
 = 5;

255  
size
;

256 
	}
}

258 
ölöe
 
	$pxt4_ext_•a˚_roŸ
(
öode
 *öode, 
check
)

260 
size
;

262 
size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

263 
size
 -(
pxt4_exã¡_hódî
);

264 
size
 /(
pxt4_exã¡
);

265 #ifde‡
AGGRESSIVE_TEST


266 i‡(!
check
 && 
size
 > 3)

267 
size
 = 3;

269  
size
;

270 
	}
}

272 
ölöe
 
	$pxt4_ext_•a˚_roŸ_idx
(
öode
 *öode, 
check
)

274 
size
;

276 
size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

277 
size
 -(
pxt4_exã¡_hódî
);

278 
size
 /(
pxt4_exã¡_idx
);

279 #ifde‡
AGGRESSIVE_TEST


280 i‡(!
check
 && 
size
 > 4)

281 
size
 = 4;

283  
size
;

284 
	}
}

286 
ölöe
 

287 
	$pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

288 
pxt4_ext_∑th
 **
µ©h
, 
pxt4_lblk_t
 
lblk
,

289 
noÁû
)

291 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

292 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
∑th
[∑th->
p_dïth
].
p_ext
);

294  
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, 
µ©h
, 
lblk
, 
unwrôãn
 ?

295 
PXT4_EXT_MARK_UNWRIT1
|
PXT4_EXT_MARK_UNWRIT2
 : 0,

296 
PXT4_EX_NOCACHE
 | 
PXT4_GET_BLOCKS_PRE_IO
 |

297 (
noÁû
 ? 
PXT4_GET_BLOCKS_METADATA_NOFAIL
:0));

298 
	}
}

305 
	$pxt4_ext_ˇlc_mëad©a_amou¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblock
)

307 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

308 
idxs
;

310 
idxs
 = ((
öode
->
i_sb
->
s_blocksize
 - (
pxt4_exã¡_hódî
))

311 / (
pxt4_exã¡_idx
));

321 i‡(
ei
->
i_da_mëad©a_ˇlc_Àn
 &&

322 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
+1 =
lblock
) {

323 
num
 = 0;

325 i‡((
ei
->
i_da_mëad©a_ˇlc_Àn
 % 
idxs
) == 0)

326 
num
++;

327 i‡((
ei
->
i_da_mëad©a_ˇlc_Àn
 % (
idxs
*idxs)) == 0)

328 
num
++;

329 i‡((
ei
->
i_da_mëad©a_ˇlc_Àn
 % (
idxs
*idxs*idxs)) == 0) {

330 
num
++;

331 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 0;

333 
ei
->
i_da_mëad©a_ˇlc_Àn
++;

334 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
++;

335  
num
;

342 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 1;

343 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
 = 
lblock
;

344  
	`ext_dïth
(
öode
) + 1;

345 
	}
}

348 
	$pxt4_ext_max_íåõs
(
öode
 *öode, 
dïth
)

350 
max
;

352 i‡(
dïth
 =
	`ext_dïth
(
öode
)) {

353 i‡(
dïth
 == 0)

354 
max
 = 
	`pxt4_ext_•a˚_roŸ
(
öode
, 1);

356 
max
 = 
	`pxt4_ext_•a˚_roŸ_idx
(
öode
, 1);

358 i‡(
dïth
 == 0)

359 
max
 = 
	`pxt4_ext_•a˚_block
(
öode
, 1);

361 
max
 = 
	`pxt4_ext_•a˚_block_idx
(
öode
, 1);

364  
max
;

365 
	}
}

367 
	$pxt4_vÆid_exã¡
(
öode
 *öode, 
pxt4_exã¡
 *
ext
)

369 
pxt4_fsblk_t
 
block
 = 
	`pxt4_ext_pblock
(
ext
);

370 
Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ext
);

371 
pxt4_lblk_t
 
lblock
 = 
	`À32_to_˝u
(
ext
->
ì_block
);

378 i‡(
lblock
 + 
Àn
 <=Üblock)

380  
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
block
, 
Àn
);

381 
	}
}

383 
	$pxt4_vÆid_exã¡_idx
(
öode
 *inode,

384 
pxt4_exã¡_idx
 *
ext_idx
)

386 
pxt4_fsblk_t
 
block
 = 
	`pxt4_idx_pblock
(
ext_idx
);

388  
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
block
, 1);

389 
	}
}

391 
	$pxt4_vÆid_exã¡_íåõs
(
öode
 *inode,

392 
pxt4_exã¡_hódî
 *
eh
,

393 
dïth
)

395 
íåõs
;

396 i‡(
eh
->
eh_íåõs
 == 0)

399 
íåõs
 = 
	`À16_to_˝u
(
eh
->
eh_íåõs
);

401 i‡(
dïth
 == 0) {

403 
pxt4_exã¡
 *
ext
 = 
	`EXT_FIRST_EXTENT
(
eh
);

404 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

405 
pxt4_fsblk_t
 
pblock
 = 0;

406 
pxt4_lblk_t
 
lblock
 = 0;

407 
pxt4_lblk_t
 
¥ev
 = 0;

408 
Àn
 = 0;

409 
íåõs
) {

410 i‡(!
	`pxt4_vÆid_exã¡
(
öode
, 
ext
))

414 
lblock
 = 
	`À32_to_˝u
(
ext
->
ì_block
);

415 
Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ext
);

416 i‡((
lblock
 <
¥ev
) &&Örev) {

417 
pblock
 = 
	`pxt4_ext_pblock
(
ext
);

418 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
pblock
);

421 
ext
++;

422 
íåõs
--;

423 
¥ev
 = 
lblock
 + 
Àn
 - 1;

426 
pxt4_exã¡_idx
 *
ext_idx
 = 
	`EXT_FIRST_INDEX
(
eh
);

427 
íåõs
) {

428 i‡(!
	`pxt4_vÆid_exã¡_idx
(
öode
, 
ext_idx
))

430 
ext_idx
++;

431 
íåõs
--;

435 
	}
}

437 
	$__pxt4_ext_check
(c⁄° *
fun˘i⁄
, 
löe
,

438 
öode
 *öode, 
pxt4_exã¡_hódî
 *
eh
,

439 
dïth
, 
pxt4_fsblk_t
 
pblk
)

441 c⁄° *
îr‹_msg
;

442 
max
 = 0, 
îr
 = -
EFSCORRUPTED
;

444 i‡(
	`u∆ikñy
(
eh
->
eh_magic
 !
PXT4_EXT_MAGIC
)) {

445 
îr‹_msg
 = "invalid magic";

446 
c‹ru±ed
;

448 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
eh
->
eh_dïth
Ë!
dïth
)) {

449 
îr‹_msg
 = "unexpectedÉh_depth";

450 
c‹ru±ed
;

452 i‡(
	`u∆ikñy
(
eh
->
eh_max
 == 0)) {

453 
îr‹_msg
 = "invalidÉh_max";

454 
c‹ru±ed
;

456 
max
 = 
	`pxt4_ext_max_íåõs
(
öode
, 
dïth
);

457 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
eh
->
eh_max
Ë> 
max
)) {

458 
îr‹_msg
 = "tooÜargeÉh_max";

459 
c‹ru±ed
;

461 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
eh
->
eh_íåõs
Ë>Üe16_to_˝u”h->
eh_max
))) {

462 
îr‹_msg
 = "invalidÉh_entries";

463 
c‹ru±ed
;

465 i‡(!
	`pxt4_vÆid_exã¡_íåõs
(
öode
, 
eh
, 
dïth
)) {

466 
îr‹_msg
 = "invalidÉxtentÉntries";

467 
c‹ru±ed
;

469 i‡(
	`u∆ikñy
(
dïth
 > 32)) {

470 
îr‹_msg
 = "tooÜargeÉh_depth";

471 
c‹ru±ed
;

474 i‡(
	`ext_dïth
(
öode
Ë!
dïth
 &&

475 !
	`pxt4_exã¡_block_csum_vîify
(
öode
, 
eh
)) {

476 
îr‹_msg
 = "extentÅree corrupted";

477 
îr
 = -
EFSBADCRC
;

478 
c‹ru±ed
;

482 
c‹ru±ed
:

483 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

486 (Ë
pblk
, 
îr‹_msg
,

487 
	`À16_to_˝u
(
eh
->
eh_magic
),

488 
	`À16_to_˝u
(
eh
->
eh_íåõs
),Üe16_to_˝u”h->
eh_max
),

489 
max
, 
	`À16_to_˝u
(
eh
->
eh_dïth
), 
dïth
);

490  
îr
;

491 
	}
}

493 
	#pxt4_ext_check
(
öode
, 
eh
, 
dïth
, 
pblk
) \

494 
	`__pxt4_ext_check
(
__func__
, 
__LINE__
, (
öode
), (
eh
), (
dïth
), (
pblk
))

	)

496 
	$pxt4_ext_check_öode
(
öode
 *inode)

498  
	`pxt4_ext_check
(
öode
, 
	`ext_öode_hdr
(öode), 
	`ext_dïth
(inode), 0);

499 
	}
}

501 
buf„r_hód
 *

502 
	$__ªad_exã¡_åì_block
(c⁄° *
fun˘i⁄
, 
löe
,

503 
öode
 *öode, 
pxt4_fsblk_t
 
pblk
, 
dïth
,

504 
Êags
)

506 
buf„r_hód
 *
bh
;

507 
îr
;

509 
bh
 = 
	`sb_gëblk_gÂ
(
öode
->
i_sb
, 
pblk
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

510 i‡(
	`u∆ikñy
(!
bh
))

511  
	`ERR_PTR
(-
ENOMEM
);

513 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

514 
	`åa˚_pxt4_ext_lﬂd_exã¡
(
öode
, 
pblk
, 
_RET_IP_
);

515 
îr
 = 
	`bh_submô_ªad
(
bh
);

516 i‡(
îr
 < 0)

517 
îrout
;

519 i‡(
	`buf„r_vîifõd
(
bh
Ë&& !(
Êags
 & 
PXT4_EX_FORCE_CACHE
))

520  
bh
;

521 i‡(!
	`pxt4_has_„©uª_jou∫Æ
(
öode
->
i_sb
) ||

522 (
öode
->
i_öo
 !=

523 
	`À32_to_˝u
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_jou∫Æ_öum
))) {

524 
îr
 = 
	`__pxt4_ext_check
(
fun˘i⁄
, 
löe
, 
öode
,

525 
	`ext_block_hdr
(
bh
), 
dïth
, 
pblk
);

526 i‡(
îr
)

527 
îrout
;

529 
	`£t_buf„r_vîifõd
(
bh
);

533 i‡(!(
Êags
 & 
PXT4_EX_NOCACHE
Ë&& 
dïth
 == 0) {

534 
pxt4_exã¡_hódî
 *
eh
 = 
	`ext_block_hdr
(
bh
);

535 
pxt4_exã¡
 *
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

536 
pxt4_lblk_t
 
¥ev
 = 0;

537 
i
;

539 
i
 = 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i > 0; i--, 
ex
++) {

540 
°©us
 = 
EXTENT_STATUS_WRITTEN
;

541 
pxt4_lblk_t
 
lblk
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

542 
Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

544 i‡(
¥ev
 && (¥ev !
lblk
))

545 
	`pxt4_es_ˇche_exã¡
(
öode
, 
¥ev
,

546 
lblk
 - 
¥ev
, ~0,

547 
EXTENT_STATUS_HOLE
);

549 i‡(
	`pxt4_ext_is_unwrôãn
(
ex
))

550 
°©us
 = 
EXTENT_STATUS_UNWRITTEN
;

551 
	`pxt4_es_ˇche_exã¡
(
öode
, 
lblk
, 
Àn
,

552 
	`pxt4_ext_pblock
(
ex
), 
°©us
);

553 
¥ev
 = 
lblk
 + 
Àn
;

556  
bh
;

557 
îrout
:

558 
	`put_bh
(
bh
);

559  
	`ERR_PTR
(
îr
);

561 
	}
}

563 
	#ªad_exã¡_åì_block
(
öode
, 
pblk
, 
dïth
, 
Êags
) \

564 
	`__ªad_exã¡_åì_block
(
__func__
, 
__LINE__
, (
öode
), (
pblk
), \

565 (
dïth
), (
Êags
))

	)

571 
	$pxt4_ext_¥eˇche
(
öode
 *inode)

573 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

574 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

575 
buf„r_hód
 *
bh
;

576 
i
 = 0, 
dïth
, 
ªt
 = 0;

578 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

581 
	`down_ªad
(&
ei
->
i_d©a_£m
);

582 
dïth
 = 
	`ext_dïth
(
öode
);

584 
∑th
 = 
	`kˇŒoc
(
dïth
 + 1, (
pxt4_ext_∑th
),

585 
GFP_NOFS
);

586 i‡(
∑th
 =
NULL
) {

587 
	`up_ªad
(&
ei
->
i_d©a_£m
);

588  -
ENOMEM
;

592 i‡(
dïth
 == 0)

593 
out
;

594 
∑th
[0].
p_hdr
 = 
	`ext_öode_hdr
(
öode
);

595 
ªt
 = 
	`pxt4_ext_check
(
öode
, 
∑th
[0].
p_hdr
, 
dïth
, 0);

596 i‡(
ªt
)

597 
out
;

598 
∑th
[0].
p_idx
 = 
	`EXT_FIRST_INDEX
’©h[0].
p_hdr
);

599 
i
 >= 0) {

604 i‡((
i
 =
dïth
) ||

605 
∑th
[
i
].
p_idx
 > 
	`EXT_LAST_INDEX
’©h[i].
p_hdr
)) {

606 
	`bªl£
(
∑th
[
i
].
p_bh
);

607 
∑th
[
i
].
p_bh
 = 
NULL
;

608 
i
--;

611 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
,

612 
	`pxt4_idx_pblock
(
∑th
[
i
].
p_idx
++),

613 
dïth
 - 
i
 - 1,

614 
PXT4_EX_FORCE_CACHE
);

615 i‡(
	`IS_ERR
(
bh
)) {

616 
ªt
 = 
	`PTR_ERR
(
bh
);

619 
i
++;

620 
∑th
[
i
].
p_bh
 = 
bh
;

621 
∑th
[
i
].
p_hdr
 = 
	`ext_block_hdr
(
bh
);

622 
∑th
[
i
].
p_idx
 = 
	`EXT_FIRST_INDEX
’©h[i].
p_hdr
);

624 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
);

625 
out
:

626 
	`up_ªad
(&
ei
->
i_d©a_£m
);

627 
	`pxt4_ext_dr›_ªfs
(
∑th
);

628 
	`k‰ì
(
∑th
);

629  
ªt
;

630 
	}
}

632 #ifde‡
EXT_DEBUG


633 
	$pxt4_ext_show_∑th
(
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
)

635 
k
, 
l
 = 
∑th
->
p_dïth
;

637 
	`ext_debug
("path:");

638 
k
 = 0; k <
l
; k++, 
∑th
++) {

639 i‡(
∑th
->
p_idx
) {

640 
	`ext_debug
(" %d->%Œu", 
	`À32_to_˝u
(
∑th
->
p_idx
->
ei_block
),

641 
	`pxt4_idx_pblock
(
∑th
->
p_idx
));

642 } i‡(
∑th
->
p_ext
) {

643 
	`ext_debug
(" %d:[%d]%d:%llu ",

644 
	`À32_to_˝u
(
∑th
->
p_ext
->
ì_block
),

645 
	`pxt4_ext_is_unwrôãn
(
∑th
->
p_ext
),

646 
	`pxt4_ext_gë_a˘uÆ_Àn
(
∑th
->
p_ext
),

647 
	`pxt4_ext_pblock
(
∑th
->
p_ext
));

649 
	`ext_debug
(" []");

651 
	`ext_debug
("\n");

652 
	}
}

654 
	$pxt4_ext_show_Àaf
(
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
)

656 
dïth
 = 
	`ext_dïth
(
öode
);

657 
pxt4_exã¡_hódî
 *
eh
;

658 
pxt4_exã¡
 *
ex
;

659 
i
;

661 i‡(!
∑th
)

664 
eh
 = 
∑th
[
dïth
].
p_hdr
;

665 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

667 
	`ext_debug
("Di•œyögÜó‡exã¡†f‹ inodê%lu\n", 
öode
->
i_öo
);

669 
i
 = 0; i < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i++, 
ex
++) {

670 
	`ext_debug
("%d:[%d]%d:%Œu ", 
	`À32_to_˝u
(
ex
->
ì_block
),

671 
	`pxt4_ext_is_unwrôãn
(
ex
),

672 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
), 
	`pxt4_ext_pblock
(ex));

674 
	`ext_debug
("\n");

675 
	}
}

677 
	$pxt4_ext_show_move
(
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
,

678 
pxt4_fsblk_t
 
√wblock
, 
Àvñ
)

680 
dïth
 = 
	`ext_dïth
(
öode
);

681 
pxt4_exã¡
 *
ex
;

683 i‡(
dïth
 !
Àvñ
) {

684 
pxt4_exã¡_idx
 *
idx
;

685 
idx
 = 
∑th
[
Àvñ
].
p_idx
;

686 
idx
 <
	`EXT_MAX_INDEX
(
∑th
[
Àvñ
].
p_hdr
)) {

687 
	`ext_debug
("%d: movê%d:%Œu i¿√w index %Œu\n", 
Àvñ
,

688 
	`À32_to_˝u
(
idx
->
ei_block
),

689 
	`pxt4_idx_pblock
(
idx
),

690 
√wblock
);

691 
idx
++;

697 
ex
 = 
∑th
[
dïth
].
p_ext
;

698 
ex
 <
	`EXT_MAX_EXTENT
(
∑th
[
dïth
].
p_hdr
)) {

699 
	`ext_debug
("move %d:%llu:[%d]%d inÇewÜeaf %llu\n",

700 
	`À32_to_˝u
(
ex
->
ì_block
),

701 
	`pxt4_ext_pblock
(
ex
),

702 
	`pxt4_ext_is_unwrôãn
(
ex
),

703 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
),

704 
√wblock
);

705 
ex
++;

707 
	}
}

710 
	#pxt4_ext_show_∑th
(
öode
, 
∑th
)

	)

711 
	#pxt4_ext_show_Àaf
(
öode
, 
∑th
)

	)

712 
	#pxt4_ext_show_move
(
öode
, 
∑th
, 
√wblock
, 
Àvñ
)

	)

715 
	$pxt4_ext_dr›_ªfs
(
pxt4_ext_∑th
 *
∑th
)

717 
dïth
, 
i
;

719 i‡(!
∑th
)

721 
dïth
 = 
∑th
->
p_dïth
;

722 
i
 = 0; i <
dïth
; i++, 
∑th
++)

723 i‡(
∑th
->
p_bh
) {

724 
	`bªl£
(
∑th
->
p_bh
);

725 
∑th
->
p_bh
 = 
NULL
;

727 
	}
}

735 
	$pxt4_ext_bö£¨ch_idx
(
öode
 *inode,

736 
pxt4_ext_∑th
 *
∑th
, 
pxt4_lblk_t
 
block
)

738 
pxt4_exã¡_hódî
 *
eh
 = 
∑th
->
p_hdr
;

739 
pxt4_exã¡_idx
 *
r
, *
l
, *
m
;

742 
	`ext_debug
("bö£¨ch f‹ %u(idx): ", 
block
);

744 
l
 = 
	`EXT_FIRST_INDEX
(
eh
) + 1;

745 
r
 = 
	`EXT_LAST_INDEX
(
eh
);

746 
l
 <
r
) {

747 
m
 = 
l
 + (
r
 -Ü) / 2;

748 i‡(
block
 < 
	`À32_to_˝u
(
m
->
ei_block
))

749 
r
 = 
m
 - 1;

751 
l
 = 
m
 + 1;

752 
	`ext_debug
("%p(%u):%p(%u):%p(%uË", 
l
, 
	`À32_to_˝u
÷->
ei_block
),

753 
m
, 
	`À32_to_˝u
(m->
ei_block
),

754 
r
, 
	`À32_to_˝u
‘->
ei_block
));

757 
∑th
->
p_idx
 = 
l
 - 1;

758 
	`ext_debug
(" -> %u->%Œd ", 
	`À32_to_˝u
(
∑th
->
p_idx
->
ei_block
),

759 
	`pxt4_idx_pblock
(
∑th
->
p_idx
));

761 #ifde‡
CHECK_BINSEARCH


763 
pxt4_exã¡_idx
 *
chix
, *
ix
;

764 
k
;

766 
chix
 = 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

767 
k
 = 0; k < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); k++, 
ix
++) {

768 i‡(
k
 != 0 &&

769 
	`À32_to_˝u
(
ix
->
ei_block
) <=Üe32_to_cpu(ix[-1].ei_block)) {

770 
	`¥ötk
(
KERN_DEBUG
 "k=%d, ix=0x%p, "

771 "fú°=0x%p\n", 
k
,

772 
ix
, 
	`EXT_FIRST_INDEX
(
eh
));

773 
	`¥ötk
(
KERN_DEBUG
 "%u <= %u\n",

774 
	`À32_to_˝u
(
ix
->
ei_block
),

775 
	`À32_to_˝u
(
ix
[-1].
ei_block
));

777 
	`BUG_ON
(
k
 && 
	`À32_to_˝u
(
ix
->
ei_block
)

778 <
	`À32_to_˝u
(
ix
[-1].
ei_block
));

779 i‡(
block
 < 
	`À32_to_˝u
(
ix
->
ei_block
))

781 
chix
 = 
ix
;

783 
	`BUG_ON
(
chix
 !
∑th
->
p_idx
);

787 
	}
}

795 
	$pxt4_ext_bö£¨ch
(
öode
 *inode,

796 
pxt4_ext_∑th
 *
∑th
, 
pxt4_lblk_t
 
block
)

798 
pxt4_exã¡_hódî
 *
eh
 = 
∑th
->
p_hdr
;

799 
pxt4_exã¡
 *
r
, *
l
, *
m
;

801 i‡(
eh
->
eh_íåõs
 == 0) {

809 
	`ext_debug
("bö£¨ch f‹ %u: ", 
block
);

811 
l
 = 
	`EXT_FIRST_EXTENT
(
eh
) + 1;

812 
r
 = 
	`EXT_LAST_EXTENT
(
eh
);

814 
l
 <
r
) {

815 
m
 = 
l
 + (
r
 -Ü) / 2;

816 i‡(
block
 < 
	`À32_to_˝u
(
m
->
ì_block
))

817 
r
 = 
m
 - 1;

819 
l
 = 
m
 + 1;

820 
	`ext_debug
("%p(%u):%p(%u):%p(%uË", 
l
, 
	`À32_to_˝u
÷->
ì_block
),

821 
m
, 
	`À32_to_˝u
(m->
ì_block
),

822 
r
, 
	`À32_to_˝u
‘->
ì_block
));

825 
∑th
->
p_ext
 = 
l
 - 1;

826 
	`ext_debug
(" -> %d:%llu:[%d]%d ",

827 
	`À32_to_˝u
(
∑th
->
p_ext
->
ì_block
),

828 
	`pxt4_ext_pblock
(
∑th
->
p_ext
),

829 
	`pxt4_ext_is_unwrôãn
(
∑th
->
p_ext
),

830 
	`pxt4_ext_gë_a˘uÆ_Àn
(
∑th
->
p_ext
));

832 #ifde‡
CHECK_BINSEARCH


834 
pxt4_exã¡
 *
chex
, *
ex
;

835 
k
;

837 
chex
 = 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

838 
k
 = 0; k < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); k++, 
ex
++) {

839 
	`BUG_ON
(
k
 && 
	`À32_to_˝u
(
ex
->
ì_block
)

840 <
	`À32_to_˝u
(
ex
[-1].
ì_block
));

841 i‡(
block
 < 
	`À32_to_˝u
(
ex
->
ì_block
))

843 
chex
 = 
ex
;

845 
	`BUG_ON
(
chex
 !
∑th
->
p_ext
);

849 
	}
}

851 
	$pxt4_ext_åì_öô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

853 
pxt4_exã¡_hódî
 *
eh
;

855 
eh
 = 
	`ext_öode_hdr
(
öode
);

856 
eh
->
eh_dïth
 = 0;

857 
eh
->
eh_íåõs
 = 0;

858 
eh
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

859 
eh
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_roŸ
(
öode
, 0));

860 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

862 
	}
}

864 
pxt4_ext_∑th
 *

865 
	$pxt4_föd_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
block
,

866 
pxt4_ext_∑th
 **
‹ig_∑th
, 
Êags
)

868 
pxt4_exã¡_hódî
 *
eh
;

869 
buf„r_hód
 *
bh
;

870 
pxt4_ext_∑th
 *
∑th
 = 
‹ig_∑th
 ? *‹ig_∑th : 
NULL
;

871 
dïth
, 
i
, 
µos
 = 0;

872 
ªt
;

874 
eh
 = 
	`ext_öode_hdr
(
öode
);

875 
dïth
 = 
	`ext_dïth
(
öode
);

876 i‡(
dïth
 < 0 || dïth > 
PXT4_MAX_EXTENT_DEPTH
) {

877 
	`PXT4_ERROR_INODE
(
öode
, "inode has invalidÉxtent depth: %d",

878 
dïth
);

879 
ªt
 = -
EFSCORRUPTED
;

880 
îr
;

883 i‡(
∑th
) {

884 
	`pxt4_ext_dr›_ªfs
(
∑th
);

885 i‡(
dïth
 > 
∑th
[0].
p_maxdïth
) {

886 
	`k‰ì
(
∑th
);

887 *
‹ig_∑th
 = 
∑th
 = 
NULL
;

890 i‡(!
∑th
) {

892 
∑th
 = 
	`kˇŒoc
(
dïth
 + 2, (
pxt4_ext_∑th
),

893 
GFP_NOFS
);

894 i‡(
	`u∆ikñy
(!
∑th
))

895  
	`ERR_PTR
(-
ENOMEM
);

896 
∑th
[0].
p_maxdïth
 = 
dïth
 + 1;

898 
∑th
[0].
p_hdr
 = 
eh
;

899 
∑th
[0].
p_bh
 = 
NULL
;

901 
i
 = 
dïth
;

903 
i
) {

904 
	`ext_debug
("depth %d:Çum %d, max %d\n",

905 
µos
, 
	`À16_to_˝u
(
eh
->
eh_íåõs
),Üe16_to_˝u”h->
eh_max
));

907 
	`pxt4_ext_bö£¨ch_idx
(
öode
, 
∑th
 + 
µos
, 
block
);

908 
∑th
[
µos
].
p_block
 = 
	`pxt4_idx_pblock
’©h[µos].
p_idx
);

909 
∑th
[
µos
].
p_dïth
 = 
i
;

910 
∑th
[
µos
].
p_ext
 = 
NULL
;

912 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
, 
∑th
[
µos
].
p_block
, --
i
,

913 
Êags
);

914 i‡(
	`IS_ERR
(
bh
)) {

915 
ªt
 = 
	`PTR_ERR
(
bh
);

916 
îr
;

919 
eh
 = 
	`ext_block_hdr
(
bh
);

920 
µos
++;

921 
∑th
[
µos
].
p_bh
 = 
bh
;

922 
∑th
[
µos
].
p_hdr
 = 
eh
;

925 
∑th
[
µos
].
p_dïth
 = 
i
;

926 
∑th
[
µos
].
p_ext
 = 
NULL
;

927 
∑th
[
µos
].
p_idx
 = 
NULL
;

930 
	`pxt4_ext_bö£¨ch
(
öode
, 
∑th
 + 
µos
, 
block
);

932 i‡(
∑th
[
µos
].
p_ext
)

933 
∑th
[
µos
].
p_block
 = 
	`pxt4_ext_pblock
’©h[µos].
p_ext
);

935 
	`pxt4_ext_show_∑th
(
öode
, 
∑th
);

937  
∑th
;

939 
îr
:

940 
	`pxt4_ext_dr›_ªfs
(
∑th
);

941 
	`k‰ì
(
∑th
);

942 i‡(
‹ig_∑th
)

943 *
‹ig_∑th
 = 
NULL
;

944  
	`ERR_PTR
(
ªt
);

945 
	}
}

952 
	$pxt4_ext_ö£π_ödex
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

953 
pxt4_ext_∑th
 *
cuΩ
,

954 
logiˇl
, 
pxt4_fsblk_t
 
±r
)

956 
pxt4_exã¡_idx
 *
ix
;

957 
Àn
, 
îr
;

959 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
cuΩ
);

960 i‡(
îr
)

961  
îr
;

963 i‡(
	`u∆ikñy
(
logiˇl
 =
	`À32_to_˝u
(
cuΩ
->
p_idx
->
ei_block
))) {

964 
	`PXT4_ERROR_INODE
(
öode
,

966 
logiˇl
, 
	`À32_to_˝u
(
cuΩ
->
p_idx
->
ei_block
));

967  -
EFSCORRUPTED
;

970 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_íåõs
)

971 >
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_max
))) {

972 
	`PXT4_ERROR_INODE
(
öode
,

974 
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_íåõs
),

975 
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_max
));

976  -
EFSCORRUPTED
;

979 i‡(
logiˇl
 > 
	`À32_to_˝u
(
cuΩ
->
p_idx
->
ei_block
)) {

981 
	`ext_debug
("ö£πÇew index %dá·î: %Œu\n", 
logiˇl
, 
±r
);

982 
ix
 = 
cuΩ
->
p_idx
 + 1;

985 
	`ext_debug
("ö£πÇew index %d bef‹e: %Œu\n", 
logiˇl
, 
±r
);

986 
ix
 = 
cuΩ
->
p_idx
;

989 
Àn
 = 
	`EXT_LAST_INDEX
(
cuΩ
->
p_hdr
Ë- 
ix
 + 1;

990 
	`BUG_ON
(
Àn
 < 0);

991 i‡(
Àn
 > 0) {

992 
	`ext_debug
("insertÇew index %d: "

994 
logiˇl
, 
Àn
, 
ix
, ix + 1);

995 
	`memmove
(
ix
 + 1, ix, 
Àn
 * (
pxt4_exã¡_idx
));

998 i‡(
	`u∆ikñy
(
ix
 > 
	`EXT_MAX_INDEX
(
cuΩ
->
p_hdr
))) {

999 
	`PXT4_ERROR_INODE
(
öode
, "ix > EXT_MAX_INDEX!");

1000  -
EFSCORRUPTED
;

1003 
ix
->
ei_block
 = 
	`˝u_to_À32
(
logiˇl
);

1004 
	`pxt4_idx_°‹e_pblock
(
ix
, 
±r
);

1005 
	`À16_add_˝u
(&
cuΩ
->
p_hdr
->
eh_íåõs
, 1);

1007 i‡(
	`u∆ikñy
(
ix
 > 
	`EXT_LAST_INDEX
(
cuΩ
->
p_hdr
))) {

1008 
	`PXT4_ERROR_INODE
(
öode
, "ix > EXT_LAST_INDEX!");

1009  -
EFSCORRUPTED
;

1012 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
cuΩ
);

1013 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

1015  
îr
;

1016 
	}
}

1028 
	$pxt4_ext_•lô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1029 
Êags
,

1030 
pxt4_ext_∑th
 *
∑th
,

1031 
pxt4_exã¡
 *
√wext
, 
©
)

1033 
buf„r_hód
 *
bh
 = 
NULL
;

1034 
dïth
 = 
	`ext_dïth
(
öode
);

1035 
pxt4_exã¡_hódî
 *
√h
;

1036 
pxt4_exã¡_idx
 *
fidx
;

1037 
i
 = 
©
, 
k
, 
m
, 
a
;

1038 
pxt4_fsblk_t
 
√wblock
, 
ﬁdblock
;

1039 
__À32
 
b‹dî
;

1040 
pxt4_fsblk_t
 *
ablocks
 = 
NULL
;

1041 
îr
 = 0;

1042 
size_t
 
ext_size
 = 0;

1049 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_ext
 > 
	`EXT_MAX_EXTENT
’©h[dïth].
p_hdr
))) {

1050 
	`PXT4_ERROR_INODE
(
öode
, "p_ext > EXT_MAX_EXTENT!");

1051  -
EFSCORRUPTED
;

1053 i‡(
∑th
[
dïth
].
p_ext
 !
	`EXT_MAX_EXTENT
’©h[dïth].
p_hdr
)) {

1054 
b‹dî
 = 
∑th
[
dïth
].
p_ext
[1].
ì_block
;

1055 
	`ext_debug
("leaf will be split."

1057 
	`À32_to_˝u
(
b‹dî
));

1059 
b‹dî
 = 
√wext
->
ì_block
;

1060 
	`ext_debug
("leaf will beádded."

1062 
	`À32_to_˝u
(
b‹dî
));

1077 
ablocks
 = 
	`kˇŒoc
(
dïth
, (
pxt4_fsblk_t
), 
GFP_NOFS
);

1078 i‡(!
ablocks
)

1079  -
ENOMEM
;

1082 
	`ext_debug
("Æloˇã %d block†f‹ indexes/Àaf\n", 
dïth
 - 
©
);

1083 
a
 = 0;á < 
dïth
 - 
©
;á++) {

1084 
√wblock
 = 
	`pxt4_ext_√w_mëa_block
(
h™dÀ
, 
öode
, 
∑th
,

1085 
√wext
, &
îr
, 
Êags
);

1086 i‡(
√wblock
 == 0)

1087 
˛ónup
;

1088 
ablocks
[
a
] = 
√wblock
;

1092 
√wblock
 = 
ablocks
[--
a
];

1093 i‡(
	`u∆ikñy
(
√wblock
 == 0)) {

1094 
	`PXT4_ERROR_INODE
(
öode
, "newblock == 0!");

1095 
îr
 = -
EFSCORRUPTED
;

1096 
˛ónup
;

1098 
bh
 = 
	`sb_gëblk_gÂ
(
öode
->
i_sb
, 
√wblock
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

1099 i‡(
	`u∆ikñy
(!
bh
)) {

1100 
îr
 = -
ENOMEM
;

1101 
˛ónup
;

1103 
	`lock_buf„r
(
bh
);

1105 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1106 i‡(
îr
)

1107 
˛ónup
;

1109 
√h
 = 
	`ext_block_hdr
(
bh
);

1110 
√h
->
eh_íåõs
 = 0;

1111 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block
(
öode
, 0));

1112 
√h
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

1113 
√h
->
eh_dïth
 = 0;

1116 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
->
eh_íåõs
 !=

1117 
∑th
[
dïth
].
p_hdr
->
eh_max
)) {

1118 
	`PXT4_ERROR_INODE
(
öode
, "eh_entries %d !=Éh_max %d!",

1119 
∑th
[
dïth
].
p_hdr
->
eh_íåõs
,

1120 
∑th
[
dïth
].
p_hdr
->
eh_max
);

1121 
îr
 = -
EFSCORRUPTED
;

1122 
˛ónup
;

1125 
m
 = 
	`EXT_MAX_EXTENT
(
∑th
[
dïth
].
p_hdr
Ë-Ö©h[dïth].
p_ext
++;

1126 
	`pxt4_ext_show_move
(
öode
, 
∑th
, 
√wblock
, 
dïth
);

1127 i‡(
m
) {

1128 
pxt4_exã¡
 *
ex
;

1129 
ex
 = 
	`EXT_FIRST_EXTENT
(
√h
);

1130 
	`memmove
(
ex
, 
∑th
[
dïth
].
p_ext
, (
pxt4_exã¡
Ë* 
m
);

1131 
	`À16_add_˝u
(&
√h
->
eh_íåõs
, 
m
);

1135 
ext_size
 = (
pxt4_exã¡_hódî
) +

1136 (
pxt4_exã¡
Ë* 
	`À16_to_˝u
(
√h
->
eh_íåõs
);

1137 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0, 
öode
->
i_sb
->
s_blocksize
 -Éxt_size);

1138 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
√h
);

1139 
	`£t_buf„r_u±od©e
(
bh
);

1140 
	`u∆ock_buf„r
(
bh
);

1142 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1143 i‡(
îr
)

1144 
˛ónup
;

1145 
	`bªl£
(
bh
);

1146 
bh
 = 
NULL
;

1149 i‡(
m
) {

1150 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

1151 i‡(
îr
)

1152 
˛ónup
;

1153 
	`À16_add_˝u
(&
∑th
[
dïth
].
p_hdr
->
eh_íåõs
, -
m
);

1154 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

1155 i‡(
îr
)

1156 
˛ónup
;

1161 
k
 = 
dïth
 - 
©
 - 1;

1162 i‡(
	`u∆ikñy
(
k
 < 0)) {

1163 
	`PXT4_ERROR_INODE
(
öode
, "k %d < 0!", 
k
);

1164 
îr
 = -
EFSCORRUPTED
;

1165 
˛ónup
;

1167 i‡(
k
)

1168 
	`ext_debug
("¸óã %d i¡îmedüã indi˚s\n", 
k
);

1171 
i
 = 
dïth
 - 1;

1172 
k
--) {

1173 
ﬁdblock
 = 
√wblock
;

1174 
√wblock
 = 
ablocks
[--
a
];

1175 
bh
 = 
	`sb_gëblk
(
öode
->
i_sb
, 
√wblock
);

1176 i‡(
	`u∆ikñy
(!
bh
)) {

1177 
îr
 = -
ENOMEM
;

1178 
˛ónup
;

1180 
	`lock_buf„r
(
bh
);

1182 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1183 i‡(
îr
)

1184 
˛ónup
;

1186 
√h
 = 
	`ext_block_hdr
(
bh
);

1187 
√h
->
eh_íåõs
 = 
	`˝u_to_À16
(1);

1188 
√h
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

1189 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block_idx
(
öode
, 0));

1190 
√h
->
eh_dïth
 = 
	`˝u_to_À16
(
dïth
 - 
i
);

1191 
fidx
 = 
	`EXT_FIRST_INDEX
(
√h
);

1192 
fidx
->
ei_block
 = 
b‹dî
;

1193 
	`pxt4_idx_°‹e_pblock
(
fidx
, 
ﬁdblock
);

1195 
	`ext_debug
("int.indexát %d (block %llu): %u -> %llu\n",

1196 
i
, 
√wblock
, 
	`À32_to_˝u
(
b‹dî
), 
ﬁdblock
);

1199 i‡(
	`u∆ikñy
(
	`EXT_MAX_INDEX
(
∑th
[
i
].
p_hdr
) !=

1200 
	`EXT_LAST_INDEX
(
∑th
[
i
].
p_hdr
))) {

1201 
	`PXT4_ERROR_INODE
(
öode
,

1203 
	`À32_to_˝u
(
∑th
[
i
].
p_ext
->
ì_block
));

1204 
îr
 = -
EFSCORRUPTED
;

1205 
˛ónup
;

1208 
m
 = 
	`EXT_MAX_INDEX
(
∑th
[
i
].
p_hdr
Ë-Ö©h[i].
p_idx
++;

1209 
	`ext_debug
("cu∏0x%p,Üa° 0x%p\n", 
∑th
[
i
].
p_idx
,

1210 
	`EXT_MAX_INDEX
(
∑th
[
i
].
p_hdr
));

1211 
	`pxt4_ext_show_move
(
öode
, 
∑th
, 
√wblock
, 
i
);

1212 i‡(
m
) {

1213 
	`memmove
(++
fidx
, 
∑th
[
i
].
p_idx
,

1214 (
pxt4_exã¡_idx
Ë* 
m
);

1215 
	`À16_add_˝u
(&
√h
->
eh_íåõs
, 
m
);

1218 
ext_size
 = (
pxt4_exã¡_hódî
) +

1219 ((
pxt4_exã¡
Ë* 
	`À16_to_˝u
(
√h
->
eh_íåõs
));

1220 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0,

1221 
öode
->
i_sb
->
s_blocksize
 - 
ext_size
);

1222 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
√h
);

1223 
	`£t_buf„r_u±od©e
(
bh
);

1224 
	`u∆ock_buf„r
(
bh
);

1226 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1227 i‡(
îr
)

1228 
˛ónup
;

1229 
	`bªl£
(
bh
);

1230 
bh
 = 
NULL
;

1233 i‡(
m
) {

1234 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
i
);

1235 i‡(
îr
)

1236 
˛ónup
;

1237 
	`À16_add_˝u
(&
∑th
[
i
].
p_hdr
->
eh_íåõs
, -
m
);

1238 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
i
);

1239 i‡(
îr
)

1240 
˛ónup
;

1243 
i
--;

1247 
îr
 = 
	`pxt4_ext_ö£π_ödex
(
h™dÀ
, 
öode
, 
∑th
 + 
©
,

1248 
	`À32_to_˝u
(
b‹dî
), 
√wblock
);

1250 
˛ónup
:

1251 i‡(
bh
) {

1252 i‡(
	`buf„r_locked
(
bh
))

1253 
	`u∆ock_buf„r
(
bh
);

1254 
	`bªl£
(
bh
);

1257 i‡(
îr
) {

1259 
i
 = 0; i < 
dïth
; i++) {

1260 i‡(!
ablocks
[
i
])

1262 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
ablocks
[
i
], 1,

1263 
PXT4_FREE_BLOCKS_METADATA
);

1266 
	`k‰ì
(
ablocks
);

1268  
îr
;

1269 
	}
}

1279 
	$pxt4_ext_grow_ödïth
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1280 
Êags
)

1282 
pxt4_exã¡_hódî
 *
√h
;

1283 
buf„r_hód
 *
bh
;

1284 
pxt4_fsblk_t
 
√wblock
, 
gﬂl
 = 0;

1285 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

1286 
îr
 = 0;

1287 
size_t
 
ext_size
 = 0;

1290 i‡(
	`ext_dïth
(
öode
))

1291 
gﬂl
 = 
	`pxt4_idx_pblock
(
	`EXT_FIRST_INDEX
(
	`ext_öode_hdr
(
öode
)));

1292 i‡(
gﬂl
 > 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
)) {

1293 
Êags
 |
PXT4_MB_HINT_TRY_GOAL
;

1294 
gﬂl
--;

1296 
gﬂl
 = 
	`pxt4_öode_to_gﬂl_block
(
öode
);

1297 
√wblock
 = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
, 
öode
, 
gﬂl
, 
Êags
,

1298 
NULL
, &
îr
);

1299 i‡(
√wblock
 == 0)

1300  
îr
;

1302 
bh
 = 
	`sb_gëblk_gÂ
(
öode
->
i_sb
, 
√wblock
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

1303 i‡(
	`u∆ikñy
(!
bh
))

1304  -
ENOMEM
;

1305 
	`lock_buf„r
(
bh
);

1307 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1308 i‡(
îr
) {

1309 
	`u∆ock_buf„r
(
bh
);

1310 
out
;

1313 
ext_size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

1315 
	`memmove
(
bh
->
b_d©a
, 
	`PXT4_I
(
öode
)->
i_d©a
, 
ext_size
);

1317 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0, 
öode
->
i_sb
->
s_blocksize
 -Éxt_size);

1320 
√h
 = 
	`ext_block_hdr
(
bh
);

1323 i‡(
	`ext_dïth
(
öode
))

1324 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block_idx
(
öode
, 0));

1326 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block
(
öode
, 0));

1327 
√h
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

1328 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
√h
);

1329 
	`£t_buf„r_u±od©e
(
bh
);

1330 
	`u∆ock_buf„r
(
bh
);

1332 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1333 i‡(
îr
)

1334 
out
;

1337 
√h
 = 
	`ext_öode_hdr
(
öode
);

1338 
√h
->
eh_íåõs
 = 
	`˝u_to_À16
(1);

1339 
	`pxt4_idx_°‹e_pblock
(
	`EXT_FIRST_INDEX
(
√h
), 
√wblock
);

1340 i‡(
√h
->
eh_dïth
 == 0) {

1342 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_roŸ_idx
(
öode
, 0));

1343 
	`EXT_FIRST_INDEX
(
√h
)->
ei_block
 =

1344 
	`EXT_FIRST_EXTENT
(
√h
)->
ì_block
;

1346 
	`ext_debug
("newÑoot:Çum %d(%d),Üblock %d,Ötr %llu\n",

1347 
	`À16_to_˝u
(
√h
->
eh_íåõs
),Üe16_to_˝u“eh->
eh_max
),

1348 
	`À32_to_˝u
(
	`EXT_FIRST_INDEX
(
√h
)->
ei_block
),

1349 
	`pxt4_idx_pblock
(
	`EXT_FIRST_INDEX
(
√h
)));

1351 
	`À16_add_˝u
(&
√h
->
eh_dïth
, 1);

1352 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1353 
out
:

1354 
	`bªl£
(
bh
);

1356  
îr
;

1357 
	}
}

1364 
	$pxt4_ext_¸óã_√w_Àaf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1365 
mb_Êags
,

1366 
gb_Êags
,

1367 
pxt4_ext_∑th
 **
µ©h
,

1368 
pxt4_exã¡
 *
√wext
)

1370 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

1371 
pxt4_ext_∑th
 *
cuΩ
;

1372 
dïth
, 
i
, 
îr
 = 0;

1374 
ª≥©
:

1375 
i
 = 
dïth
 = 
	`ext_dïth
(
öode
);

1378 
cuΩ
 = 
∑th
 + 
dïth
;

1379 
i
 > 0 && !
	`EXT_HAS_FREE_INDEX
(
cuΩ
)) {

1380 
i
--;

1381 
cuΩ
--;

1386 i‡(
	`EXT_HAS_FREE_INDEX
(
cuΩ
)) {

1389 
îr
 = 
	`pxt4_ext_•lô
(
h™dÀ
, 
öode
, 
mb_Êags
, 
∑th
, 
√wext
, 
i
);

1390 i‡(
îr
)

1391 
out
;

1394 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
,

1395 (
pxt4_lblk_t
)
	`À32_to_˝u
(
√wext
->
ì_block
),

1396 
µ©h
, 
gb_Êags
);

1397 i‡(
	`IS_ERR
(
∑th
))

1398 
îr
 = 
	`PTR_ERR
(
∑th
);

1401 
îr
 = 
	`pxt4_ext_grow_ödïth
(
h™dÀ
, 
öode
, 
mb_Êags
);

1402 i‡(
îr
)

1403 
out
;

1406 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
,

1407 (
pxt4_lblk_t
)
	`À32_to_˝u
(
√wext
->
ì_block
),

1408 
µ©h
, 
gb_Êags
);

1409 i‡(
	`IS_ERR
(
∑th
)) {

1410 
îr
 = 
	`PTR_ERR
(
∑th
);

1411 
out
;

1418 
dïth
 = 
	`ext_dïth
(
öode
);

1419 i‡(
∑th
[
dïth
].
p_hdr
->
eh_íåõs
 =∑th[dïth].p_hdr->
eh_max
) {

1421 
ª≥©
;

1425 
out
:

1426  
îr
;

1427 
	}
}

1436 
	$pxt4_ext_£¨ch_À·
(
öode
 *inode,

1437 
pxt4_ext_∑th
 *
∑th
,

1438 
pxt4_lblk_t
 *
logiˇl
, 
pxt4_fsblk_t
 *
phys
)

1440 
pxt4_exã¡_idx
 *
ix
;

1441 
pxt4_exã¡
 *
ex
;

1442 
dïth
, 
ì_Àn
;

1444 i‡(
	`u∆ikñy
(
∑th
 =
NULL
)) {

1445 
	`PXT4_ERROR_INODE
(
öode
, "∑th =NULL *logiˇ»%d!", *
logiˇl
);

1446  -
EFSCORRUPTED
;

1448 
dïth
 = 
∑th
->
p_dïth
;

1449 *
phys
 = 0;

1451 i‡(
dïth
 =0 && 
∑th
->
p_ext
 =
NULL
)

1458 
ex
 = 
∑th
[
dïth
].
p_ext
;

1459 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

1460 i‡(*
logiˇl
 < 
	`À32_to_˝u
(
ex
->
ì_block
)) {

1461 i‡(
	`u∆ikñy
(
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
Ë!
ex
)) {

1462 
	`PXT4_ERROR_INODE
(
öode
,

1464 *
logiˇl
, 
	`À32_to_˝u
(
ex
->
ì_block
));

1465  -
EFSCORRUPTED
;

1467 --
dïth
 >= 0) {

1468 
ix
 = 
∑th
[
dïth
].
p_idx
;

1469 i‡(
	`u∆ikñy
(
ix
 !
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
))) {

1470 
	`PXT4_ERROR_INODE
(
öode
,

1472 
ix
 !
NULL
 ? 
	`À32_to_˝u
(ix->
ei_block
) : 0,

1473 
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
Ë!
NULL
 ?

1474 
	`À32_to_˝u
(
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
)->
ei_block
) : 0,

1475 
dïth
);

1476  -
EFSCORRUPTED
;

1482 i‡(
	`u∆ikñy
(*
logiˇl
 < (
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
))) {

1483 
	`PXT4_ERROR_INODE
(
öode
,

1485 *
logiˇl
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_Àn
);

1486  -
EFSCORRUPTED
;

1489 *
logiˇl
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
 - 1;

1490 *
phys
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ì_Àn
 - 1;

1492 
	}
}

1501 
	$pxt4_ext_£¨ch_right
(
öode
 *inode,

1502 
pxt4_ext_∑th
 *
∑th
,

1503 
pxt4_lblk_t
 *
logiˇl
, 
pxt4_fsblk_t
 *
phys
,

1504 
pxt4_exã¡
 **
ªt_ex
)

1506 
buf„r_hód
 *
bh
 = 
NULL
;

1507 
pxt4_exã¡_hódî
 *
eh
;

1508 
pxt4_exã¡_idx
 *
ix
;

1509 
pxt4_exã¡
 *
ex
;

1510 
pxt4_fsblk_t
 
block
;

1511 
dïth
;

1512 
ì_Àn
;

1514 i‡(
	`u∆ikñy
(
∑th
 =
NULL
)) {

1515 
	`PXT4_ERROR_INODE
(
öode
, "∑th =NULL *logiˇ»%d!", *
logiˇl
);

1516  -
EFSCORRUPTED
;

1518 
dïth
 = 
∑th
->
p_dïth
;

1519 *
phys
 = 0;

1521 i‡(
dïth
 =0 && 
∑th
->
p_ext
 =
NULL
)

1528 
ex
 = 
∑th
[
dïth
].
p_ext
;

1529 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

1530 i‡(*
logiˇl
 < 
	`À32_to_˝u
(
ex
->
ì_block
)) {

1531 i‡(
	`u∆ikñy
(
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
Ë!
ex
)) {

1532 
	`PXT4_ERROR_INODE
(
öode
,

1534 
dïth
);

1535  -
EFSCORRUPTED
;

1537 --
dïth
 >= 0) {

1538 
ix
 = 
∑th
[
dïth
].
p_idx
;

1539 i‡(
	`u∆ikñy
(
ix
 !
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
))) {

1540 
	`PXT4_ERROR_INODE
(
öode
,

1542 *
logiˇl
);

1543  -
EFSCORRUPTED
;

1546 
found_exã¡
;

1549 i‡(
	`u∆ikñy
(*
logiˇl
 < (
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
))) {

1550 
	`PXT4_ERROR_INODE
(
öode
,

1552 *
logiˇl
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_Àn
);

1553  -
EFSCORRUPTED
;

1556 i‡(
ex
 !
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
)) {

1558 
ex
++;

1559 
found_exã¡
;

1563 --
dïth
 >= 0) {

1564 
ix
 = 
∑th
[
dïth
].
p_idx
;

1565 i‡(
ix
 !
	`EXT_LAST_INDEX
(
∑th
[
dïth
].
p_hdr
))

1566 
gŸ_ödex
;

1572 
gŸ_ödex
:

1576 
ix
++;

1577 
block
 = 
	`pxt4_idx_pblock
(
ix
);

1578 ++
dïth
 < 
∑th
->
p_dïth
) {

1580 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
, 
block
,

1581 
∑th
->
p_dïth
 - 
dïth
, 0);

1582 i‡(
	`IS_ERR
(
bh
))

1583  
	`PTR_ERR
(
bh
);

1584 
eh
 = 
	`ext_block_hdr
(
bh
);

1585 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

1586 
block
 = 
	`pxt4_idx_pblock
(
ix
);

1587 
	`put_bh
(
bh
);

1590 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
, 
block
, 
∑th
->
p_dïth
 - 
dïth
, 0);

1591 i‡(
	`IS_ERR
(
bh
))

1592  
	`PTR_ERR
(
bh
);

1593 
eh
 = 
	`ext_block_hdr
(
bh
);

1594 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

1595 
found_exã¡
:

1596 *
logiˇl
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

1597 *
phys
 = 
	`pxt4_ext_pblock
(
ex
);

1598 *
ªt_ex
 = 
ex
;

1599 i‡(
bh
)

1600 
	`put_bh
(
bh
);

1602 
	}
}

1611 
pxt4_lblk_t


1612 
	$pxt4_ext_√xt_Æloˇãd_block
(
pxt4_ext_∑th
 *
∑th
)

1614 
dïth
;

1616 
	`BUG_ON
(
∑th
 =
NULL
);

1617 
dïth
 = 
∑th
->
p_dïth
;

1619 i‡(
dïth
 =0 && 
∑th
->
p_ext
 =
NULL
)

1620  
EXT_MAX_BLOCKS
;

1622 
dïth
 >= 0) {

1623 i‡(
dïth
 =
∑th
->
p_dïth
) {

1625 i‡(
∑th
[
dïth
].
p_ext
 &&

1626 
∑th
[
dïth
].
p_ext
 !=

1627 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
))

1628  
	`À32_to_˝u
(
∑th
[
dïth
].
p_ext
[1].
ì_block
);

1631 i‡(
∑th
[
dïth
].
p_idx
 !=

1632 
	`EXT_LAST_INDEX
(
∑th
[
dïth
].
p_hdr
))

1633  
	`À32_to_˝u
(
∑th
[
dïth
].
p_idx
[1].
ei_block
);

1635 
dïth
--;

1638  
EXT_MAX_BLOCKS
;

1639 
	}
}

1645 
pxt4_lblk_t
 
	$pxt4_ext_√xt_Àaf_block
(
pxt4_ext_∑th
 *
∑th
)

1647 
dïth
;

1649 
	`BUG_ON
(
∑th
 =
NULL
);

1650 
dïth
 = 
∑th
->
p_dïth
;

1653 i‡(
dïth
 == 0)

1654  
EXT_MAX_BLOCKS
;

1657 
dïth
--;

1659 
dïth
 >= 0) {

1660 i‡(
∑th
[
dïth
].
p_idx
 !=

1661 
	`EXT_LAST_INDEX
(
∑th
[
dïth
].
p_hdr
))

1662  (
pxt4_lblk_t
)

1663 
	`À32_to_˝u
(
∑th
[
dïth
].
p_idx
[1].
ei_block
);

1664 
dïth
--;

1667  
EXT_MAX_BLOCKS
;

1668 
	}
}

1676 
	$pxt4_ext_c‹ª˘_ödexes
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1677 
pxt4_ext_∑th
 *
∑th
)

1679 
pxt4_exã¡_hódî
 *
eh
;

1680 
dïth
 = 
	`ext_dïth
(
öode
);

1681 
pxt4_exã¡
 *
ex
;

1682 
__À32
 
b‹dî
;

1683 
k
, 
îr
 = 0;

1685 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1686 
ex
 = 
∑th
[
dïth
].
p_ext
;

1688 i‡(
	`u∆ikñy
(
ex
 =
NULL
 || 
eh
 == NULL)) {

1689 
	`PXT4_ERROR_INODE
(
öode
,

1690 "ex %∞=NULL o∏eh %∞=NULL", 
ex
, 
eh
);

1691  -
EFSCORRUPTED
;

1694 i‡(
dïth
 == 0) {

1699 i‡(
ex
 !
	`EXT_FIRST_EXTENT
(
eh
)) {

1707 
k
 = 
dïth
 - 1;

1708 
b‹dî
 = 
∑th
[
dïth
].
p_ext
->
ì_block
;

1709 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1710 i‡(
îr
)

1711  
îr
;

1712 
∑th
[
k
].
p_idx
->
ei_block
 = 
b‹dî
;

1713 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1714 i‡(
îr
)

1715  
îr
;

1717 
k
--) {

1719 i‡(
∑th
[
k
+1].
p_idx
 !
	`EXT_FIRST_INDEX
’©h[k+1].
p_hdr
))

1721 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1722 i‡(
îr
)

1724 
∑th
[
k
].
p_idx
->
ei_block
 = 
b‹dî
;

1725 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1726 i‡(
îr
)

1730  
îr
;

1731 
	}
}

1734 
	$pxt4_ˇn_exã¡s_be_mîged
(
öode
 *öode, 
pxt4_exã¡
 *
ex1
,

1735 
pxt4_exã¡
 *
ex2
)

1737 
ext1_ì_Àn
, 
pxt2_ì_Àn
;

1739 i‡(
	`pxt4_ext_is_unwrôãn
(
ex1
Ë!pxt4_ext_is_unwrôãn(
ex2
))

1742 
ext1_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex1
);

1743 
pxt2_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex2
);

1745 i‡(
	`À32_to_˝u
(
ex1
->
ì_block
Ë+ 
ext1_ì_Àn
 !=

1746 
	`À32_to_˝u
(
ex2
->
ì_block
))

1754 i‡(
ext1_ì_Àn
 + 
pxt2_ì_Àn
 > 
EXT_INIT_MAX_LEN
)

1762 i‡(
	`pxt4_ext_is_unwrôãn
(
ex1
) &&

1763 (
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_DIO_UNWRITTEN
) ||

1764 
	`©omic_ªad
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
) ||

1765 (
ext1_ì_Àn
 + 
pxt2_ì_Àn
 > 
EXT_UNWRITTEN_MAX_LEN
)))

1767 #ifde‡
AGGRESSIVE_TEST


1768 i‡(
ext1_ì_Àn
 >= 4)

1772 i‡(
	`pxt4_ext_pblock
(
ex1
Ë+ 
ext1_ì_Àn
 =pxt4_ext_pblock(
ex2
))

1775 
	}
}

1784 
	$pxt4_ext_åy_to_mîge_right
(
öode
 *inode,

1785 
pxt4_ext_∑th
 *
∑th
,

1786 
pxt4_exã¡
 *
ex
)

1788 
pxt4_exã¡_hódî
 *
eh
;

1789 
dïth
, 
Àn
;

1790 
mîge_d⁄e
 = 0, 
unwrôãn
;

1792 
dïth
 = 
	`ext_dïth
(
öode
);

1793 
	`BUG_ON
(
∑th
[
dïth
].
p_hdr
 =
NULL
);

1794 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1796 
ex
 < 
	`EXT_LAST_EXTENT
(
eh
)) {

1797 i‡(!
	`pxt4_ˇn_exã¡s_be_mîged
(
öode
, 
ex
,Éx + 1))

1800 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

1801 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ex)

1802 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
 + 1));

1803 i‡(
unwrôãn
)

1804 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

1806 i‡(
ex
 + 1 < 
	`EXT_LAST_EXTENT
(
eh
)) {

1807 
Àn
 = (
	`EXT_LAST_EXTENT
(
eh
Ë- 
ex
 - 1)

1808 * (
pxt4_exã¡
);

1809 
	`memmove
(
ex
 + 1,Éx + 2, 
Àn
);

1811 
	`À16_add_˝u
(&
eh
->
eh_íåõs
, -1);

1812 
mîge_d⁄e
 = 1;

1813 
	`WARN_ON
(
eh
->
eh_íåõs
 == 0);

1814 i‡(!
eh
->
eh_íåõs
)

1815 
	`PXT4_ERROR_INODE
(
öode
, "eh->eh_entries = 0!");

1818  
mîge_d⁄e
;

1819 
	}
}

1825 
	$pxt4_ext_åy_to_mîge_up
(
h™dÀ_t
 *
h™dÀ
,

1826 
öode
 *inode,

1827 
pxt4_ext_∑th
 *
∑th
)

1829 
size_t
 
s
;

1830 
max_roŸ
 = 
	`pxt4_ext_•a˚_roŸ
(
öode
, 0);

1831 
pxt4_fsblk_t
 
blk
;

1833 i‡((
∑th
[0].
p_dïth
 != 1) ||

1834 (
	`À16_to_˝u
(
∑th
[0].
p_hdr
->
eh_íåõs
) != 1) ||

1835 (
	`À16_to_˝u
(
∑th
[1].
p_hdr
->
eh_íåõs
Ë> 
max_roŸ
))

1843 i‡(
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 2))

1849 
blk
 = 
	`pxt4_idx_pblock
(
∑th
[0].
p_idx
);

1850 
s
 = 
	`À16_to_˝u
(
∑th
[1].
p_hdr
->
eh_íåõs
) *

1851 (
pxt4_exã¡_idx
);

1852 
s
 +(
pxt4_exã¡_hódî
);

1854 
∑th
[1].
p_maxdïth
 =Öath[0].p_maxdepth;

1855 
	`mem˝y
(
∑th
[0].
p_hdr
,Ö©h[1].p_hdr, 
s
);

1856 
∑th
[0].
p_dïth
 = 0;

1857 
∑th
[0].
p_ext
 = 
	`EXT_FIRST_EXTENT
’©h[0].
p_hdr
) +

1858 (
∑th
[1].
p_ext
 - 
	`EXT_FIRST_EXTENT
’©h[1].
p_hdr
));

1859 
∑th
[0].
p_hdr
->
eh_max
 = 
	`˝u_to_À16
(
max_roŸ
);

1861 
	`bªl£
(
∑th
[1].
p_bh
);

1862 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
blk
, 1,

1863 
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
);

1864 
	}
}

1870 
	$pxt4_ext_åy_to_mîge
(
h™dÀ_t
 *
h™dÀ
,

1871 
öode
 *inode,

1872 
pxt4_ext_∑th
 *
∑th
,

1873 
pxt4_exã¡
 *
ex
) {

1874 
pxt4_exã¡_hódî
 *
eh
;

1875 
dïth
;

1876 
mîge_d⁄e
 = 0;

1878 
dïth
 = 
	`ext_dïth
(
öode
);

1879 
	`BUG_ON
(
∑th
[
dïth
].
p_hdr
 =
NULL
);

1880 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1882 i‡(
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
))

1883 
mîge_d⁄e
 = 
	`pxt4_ext_åy_to_mîge_right
(
öode
, 
∑th
, 
ex
 - 1);

1885 i‡(!
mîge_d⁄e
)

1886 (Ë
	`pxt4_ext_åy_to_mîge_right
(
öode
, 
∑th
, 
ex
);

1888 
	`pxt4_ext_åy_to_mîge_up
(
h™dÀ
, 
öode
, 
∑th
);

1889 
	}
}

1899 
	$pxt4_ext_check_ovîœp
(
pxt4_sb_öfo
 *
sbi
,

1900 
öode
 *inode,

1901 
pxt4_exã¡
 *
√wext
,

1902 
pxt4_ext_∑th
 *
∑th
)

1904 
pxt4_lblk_t
 
b1
, 
b2
;

1905 
dïth
, 
Àn1
;

1906 
ªt
 = 0;

1908 
b1
 = 
	`À32_to_˝u
(
√wext
->
ì_block
);

1909 
Àn1
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
);

1910 
dïth
 = 
	`ext_dïth
(
öode
);

1911 i‡(!
∑th
[
dïth
].
p_ext
)

1912 
out
;

1913 
b2
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
	`À32_to_˝u
(
∑th
[
dïth
].
p_ext
->
ì_block
));

1919 i‡(
b2
 < 
b1
) {

1920 
b2
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

1921 i‡(
b2
 =
EXT_MAX_BLOCKS
)

1922 
out
;

1923 
b2
 = 
	`PXT4_LBLK_CMASK
(
sbi
, b2);

1927 i‡(
b1
 + 
Àn1
 < b1) {

1928 
Àn1
 = 
EXT_MAX_BLOCKS
 - 
b1
;

1929 
√wext
->
ì_Àn
 = 
	`˝u_to_À16
(
Àn1
);

1930 
ªt
 = 1;

1934 i‡(
b1
 + 
Àn1
 > 
b2
) {

1935 
√wext
->
ì_Àn
 = 
	`˝u_to_À16
(
b2
 - 
b1
);

1936 
ªt
 = 1;

1938 
out
:

1939  
ªt
;

1940 
	}
}

1948 
	$pxt4_ext_ö£π_exã¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1949 
pxt4_ext_∑th
 **
µ©h
,

1950 
pxt4_exã¡
 *
√wext
, 
gb_Êags
)

1952 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

1953 
pxt4_exã¡_hódî
 *
eh
;

1954 
pxt4_exã¡
 *
ex
, *
„x
;

1955 
pxt4_exã¡
 *
√¨ex
;

1956 
pxt4_ext_∑th
 *
≈©h
 = 
NULL
;

1957 
dïth
, 
Àn
, 
îr
;

1958 
pxt4_lblk_t
 
√xt
;

1959 
mb_Êags
 = 0, 
unwrôãn
;

1961 i‡(
gb_Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
)

1962 
mb_Êags
 |
PXT4_MB_DELALLOC_RESERVED
;

1963 i‡(
	`u∆ikñy
(
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
) == 0)) {

1964 
	`PXT4_ERROR_INODE
(
öode
, "pxt4_ext_get_actual_len(newext) == 0");

1965  -
EFSCORRUPTED
;

1967 
dïth
 = 
	`ext_dïth
(
öode
);

1968 
ex
 = 
∑th
[
dïth
].
p_ext
;

1969 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1970 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
 =
NULL
)) {

1971 
	`PXT4_ERROR_INODE
(
öode
, "∑th[%d].p_hd∏=NULL", 
dïth
);

1972  -
EFSCORRUPTED
;

1976 i‡(
ex
 && !(
gb_Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
)) {

1985 i‡(
ex
 < 
	`EXT_LAST_EXTENT
(
eh
) &&

1986 (
	`À32_to_˝u
(
ex
->
ì_block
) +

1987 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
) <

1988 
	`À32_to_˝u
(
√wext
->
ì_block
))) {

1989 
ex
 += 1;

1990 
¥ïíd
;

1991 } i‡((
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
)) &&

1992 (
	`À32_to_˝u
(
√wext
->
ì_block
) +

1993 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
) <

1994 
	`À32_to_˝u
(
ex
->
ì_block
)))

1995 
ex
 -= 1;

1998 i‡(
	`pxt4_ˇn_exã¡s_be_mîged
(
öode
, 
ex
, 
√wext
)) {

1999 
	`ext_debug
("append [%d]%d blockÅo %u:[%d]%d"

2001 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2002 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2003 
	`À32_to_˝u
(
ex
->
ì_block
),

2004 
	`pxt4_ext_is_unwrôãn
(
ex
),

2005 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
),

2006 
	`pxt4_ext_pblock
(
ex
));

2007 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
,

2008 
∑th
 + 
dïth
);

2009 i‡(
îr
)

2010  
îr
;

2011 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

2012 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ex)

2013 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
));

2014 i‡(
unwrôãn
)

2015 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

2016 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2017 
√¨ex
 = 
ex
;

2018 
mîge
;

2021 
¥ïíd
:

2023 i‡(
	`pxt4_ˇn_exã¡s_be_mîged
(
öode
, 
√wext
, 
ex
)) {

2024 
	`ext_debug
("prepend %u[%d]%d blockÅo %u:[%d]%d"

2026 
	`À32_to_˝u
(
√wext
->
ì_block
),

2027 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2028 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2029 
	`À32_to_˝u
(
ex
->
ì_block
),

2030 
	`pxt4_ext_is_unwrôãn
(
ex
),

2031 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
),

2032 
	`pxt4_ext_pblock
(
ex
));

2033 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
,

2034 
∑th
 + 
dïth
);

2035 i‡(
îr
)

2036  
îr
;

2038 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

2039 
ex
->
ì_block
 = 
√wext
->ee_block;

2040 
	`pxt4_ext_°‹e_pblock
(
ex
, 
	`pxt4_ext_pblock
(
√wext
));

2041 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ex)

2042 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
));

2043 i‡(
unwrôãn
)

2044 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

2045 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2046 
√¨ex
 = 
ex
;

2047 
mîge
;

2051 
dïth
 = 
	`ext_dïth
(
öode
);

2052 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2053 i‡(
	`À16_to_˝u
(
eh
->
eh_íåõs
Ë<Üe16_to_˝u”h->
eh_max
))

2054 
has_•a˚
;

2057 
„x
 = 
	`EXT_LAST_EXTENT
(
eh
);

2058 
√xt
 = 
EXT_MAX_BLOCKS
;

2059 i‡(
	`À32_to_˝u
(
√wext
->
ì_block
Ë>Üe32_to_˝u(
„x
->ee_block))

2060 
√xt
 = 
	`pxt4_ext_√xt_Àaf_block
(
∑th
);

2061 i‡(
√xt
 !
EXT_MAX_BLOCKS
) {

2062 
	`ext_debug
("√xàÀa‡block - %u\n", 
√xt
);

2063 
	`BUG_ON
(
≈©h
 !
NULL
);

2064 
≈©h
 = 
	`pxt4_föd_exã¡
(
öode
, 
√xt
, 
NULL
, 0);

2065 i‡(
	`IS_ERR
(
≈©h
))

2066  
	`PTR_ERR
(
≈©h
);

2067 
	`BUG_ON
(
≈©h
->
p_dïth
 !
∑th
->p_depth);

2068 
eh
 = 
≈©h
[
dïth
].
p_hdr
;

2069 i‡(
	`À16_to_˝u
(
eh
->
eh_íåõs
Ë<Üe16_to_˝u”h->
eh_max
)) {

2070 
	`ext_debug
("nextÜeaf isn't full(%d)\n",

2071 
	`À16_to_˝u
(
eh
->
eh_íåõs
));

2072 
∑th
 = 
≈©h
;

2073 
has_•a˚
;

2075 
	`ext_debug
("nextÜeaf hasÇo free space(%d,%d)\n",

2076 
	`À16_to_˝u
(
eh
->
eh_íåõs
),Üe16_to_˝u”h->
eh_max
));

2083 i‡(
gb_Êags
 & 
PXT4_GET_BLOCKS_METADATA_NOFAIL
)

2084 
mb_Êags
 |
PXT4_MB_USE_RESERVED
;

2085 
îr
 = 
	`pxt4_ext_¸óã_√w_Àaf
(
h™dÀ
, 
öode
, 
mb_Êags
, 
gb_Êags
,

2086 
µ©h
, 
√wext
);

2087 i‡(
îr
)

2088 
˛ónup
;

2089 
dïth
 = 
	`ext_dïth
(
öode
);

2090 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2092 
has_•a˚
:

2093 
√¨ex
 = 
∑th
[
dïth
].
p_ext
;

2095 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

2096 i‡(
îr
)

2097 
˛ónup
;

2099 i‡(!
√¨ex
) {

2101 
	`ext_debug
("firstÉxtent inÅheÜeaf: %u:%llu:[%d]%d\n",

2102 
	`À32_to_˝u
(
√wext
->
ì_block
),

2103 
	`pxt4_ext_pblock
(
√wext
),

2104 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2105 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
));

2106 
√¨ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

2108 i‡(
	`À32_to_˝u
(
√wext
->
ì_block
)

2109 > 
	`À32_to_˝u
(
√¨ex
->
ì_block
)) {

2111 
	`ext_debug
("insert %u:%llu:[%d]%d before: "

2113 
	`À32_to_˝u
(
√wext
->
ì_block
),

2114 
	`pxt4_ext_pblock
(
√wext
),

2115 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2116 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2117 
√¨ex
);

2118 
√¨ex
++;

2121 
	`BUG_ON
(
√wext
->
ì_block
 =
√¨ex
->ee_block);

2122 
	`ext_debug
("insert %u:%llu:[%d]%dáfter: "

2124 
	`À32_to_˝u
(
√wext
->
ì_block
),

2125 
	`pxt4_ext_pblock
(
√wext
),

2126 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2127 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2128 
√¨ex
);

2130 
Àn
 = 
	`EXT_LAST_EXTENT
(
eh
Ë- 
√¨ex
 + 1;

2131 i‡(
Àn
 > 0) {

2132 
	`ext_debug
("insert %u:%llu:[%d]%d: "

2134 
	`À32_to_˝u
(
√wext
->
ì_block
),

2135 
	`pxt4_ext_pblock
(
√wext
),

2136 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2137 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2138 
Àn
, 
√¨ex
,Çearex + 1);

2139 
	`memmove
(
√¨ex
 + 1,Çearex,

2140 
Àn
 * (
pxt4_exã¡
));

2144 
	`À16_add_˝u
(&
eh
->
eh_íåõs
, 1);

2145 
∑th
[
dïth
].
p_ext
 = 
√¨ex
;

2146 
√¨ex
->
ì_block
 = 
√wext
->ee_block;

2147 
	`pxt4_ext_°‹e_pblock
(
√¨ex
, 
	`pxt4_ext_pblock
(
√wext
));

2148 
√¨ex
->
ì_Àn
 = 
√wext
->ee_len;

2150 
mîge
:

2152 i‡(!(
gb_Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
))

2153 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
√¨ex
);

2157 
îr
 = 
	`pxt4_ext_c‹ª˘_ödexes
(
h™dÀ
, 
öode
, 
∑th
);

2158 i‡(
îr
)

2159 
˛ónup
;

2161 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

2163 
˛ónup
:

2164 
	`pxt4_ext_dr›_ªfs
(
≈©h
);

2165 
	`k‰ì
(
≈©h
);

2166  
îr
;

2167 
	}
}

2169 
	$pxt4_fûl_fõm≠_exã¡s
(
öode
 *inode,

2170 
pxt4_lblk_t
 
block
,Öxt4_lblk_à
num
,

2171 
fõm≠_exã¡_öfo
 *
fõöfo
)

2173 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

2174 
pxt4_exã¡
 *
ex
;

2175 
exã¡_°©us
 
es
;

2176 
pxt4_lblk_t
 
√xt
, 
√xt_dñ
, 
°¨t
 = 0, 
íd
 = 0;

2177 
pxt4_lblk_t
 
œ°
 = 
block
 + 
num
;

2178 
exi°s
, 
dïth
 = 0, 
îr
 = 0;

2179 
Êags
 = 0;

2180 
blksize_bôs
 = 
öode
->
i_sb
->
s_blocksize_bôs
;

2182 
block
 < 
œ°
 && block !
EXT_MAX_BLOCKS
) {

2183 
num
 = 
œ°
 - 
block
;

2185 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2187 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
block
, &path, 0);

2188 i‡(
	`IS_ERR
(
∑th
)) {

2189 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2190 
îr
 = 
	`PTR_ERR
(
∑th
);

2191 
∑th
 = 
NULL
;

2195 
dïth
 = 
	`ext_dïth
(
öode
);

2196 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
 =
NULL
)) {

2197 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2198 
	`PXT4_ERROR_INODE
(
öode
, "∑th[%d].p_hd∏=NULL", 
dïth
);

2199 
îr
 = -
EFSCORRUPTED
;

2202 
ex
 = 
∑th
[
dïth
].
p_ext
;

2203 
√xt
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

2205 
Êags
 = 0;

2206 
exi°s
 = 0;

2207 i‡(!
ex
) {

2210 
°¨t
 = 
block
;

2211 
íd
 = 
block
 + 
num
;

2212 } i‡(
	`À32_to_˝u
(
ex
->
ì_block
Ë> 
block
) {

2214 
°¨t
 = 
block
;

2215 
íd
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2216 i‡(
block
 + 
num
 < 
íd
)

2217 
íd
 = 
block
 + 
num
;

2218 } i‡(
block
 >
	`À32_to_˝u
(
ex
->
ì_block
)

2219 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
)) {

2221 
°¨t
 = 
block
;

2222 
íd
 = 
block
 + 
num
;

2223 i‡(
íd
 >
√xt
)

2224 
íd
 = 
√xt
;

2225 } i‡(
block
 >
	`À32_to_˝u
(
ex
->
ì_block
)) {

2230 
°¨t
 = 
block
;

2231 
íd
 = 
	`À32_to_˝u
(
ex
->
ì_block
)

2232 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2233 i‡(
block
 + 
num
 < 
íd
)

2234 
íd
 = 
block
 + 
num
;

2235 
exi°s
 = 1;

2237 
	`BUG
();

2239 
	`BUG_ON
(
íd
 <
°¨t
);

2241 i‡(!
exi°s
) {

2242 
es
.
es_lblk
 = 
°¨t
;

2243 
es
.
es_Àn
 = 
íd
 - 
°¨t
;

2244 
es
.
es_pblk
 = 0;

2246 
es
.
es_lblk
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2247 
es
.
es_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2248 
es
.
es_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

2249 i‡(
	`pxt4_ext_is_unwrôãn
(
ex
))

2250 
Êags
 |
FIEMAP_EXTENT_UNWRITTEN
;

2258 
√xt_dñ
 = 
	`pxt4_föd_dñayed_exã¡
(
öode
, &
es
);

2259 i‡(!
exi°s
 && 
√xt_dñ
) {

2260 
exi°s
 = 1;

2261 
Êags
 |(
FIEMAP_EXTENT_DELALLOC
 |

2262 
FIEMAP_EXTENT_UNKNOWN
);

2264 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2266 i‡(
	`u∆ikñy
(
es
.
es_Àn
 == 0)) {

2267 
	`PXT4_ERROR_INODE
(
öode
, "es.es_len == 0");

2268 
îr
 = -
EFSCORRUPTED
;

2283 i‡(
√xt
 =
√xt_dñ
 &&Çexà=
EXT_MAX_BLOCKS
) {

2284 
Êags
 |
FIEMAP_EXTENT_LAST
;

2285 i‡(
	`u∆ikñy
(
√xt_dñ
 !
EXT_MAX_BLOCKS
 ||

2286 
√xt
 !
EXT_MAX_BLOCKS
)) {

2287 
	`PXT4_ERROR_INODE
(
öode
,

2290 
√xt
, 
√xt_dñ
);

2291 
îr
 = -
EFSCORRUPTED
;

2296 i‡(
exi°s
) {

2297 
îr
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
,

2298 (
__u64
)
es
.
es_lblk
 << 
blksize_bôs
,

2299 (
__u64
)
es
.
es_pblk
 << 
blksize_bôs
,

2300 (
__u64
)
es
.
es_Àn
 << 
blksize_bôs
,

2301 
Êags
);

2302 i‡(
îr
 < 0)

2304 i‡(
îr
 == 1) {

2305 
îr
 = 0;

2310 
block
 = 
es
.
es_lblk
 +És.
es_Àn
;

2313 
	`pxt4_ext_dr›_ªfs
(
∑th
);

2314 
	`k‰ì
(
∑th
);

2315  
îr
;

2316 
	}
}

2318 
	$pxt4_fûl_es_ˇche_öfo
(
öode
 *inode,

2319 
pxt4_lblk_t
 
block
,Öxt4_lblk_à
num
,

2320 
fõm≠_exã¡_öfo
 *
fõöfo
)

2322 
pxt4_lblk_t
 
√xt
, 
íd
 = 
block
 + 
num
 - 1;

2323 
exã¡_°©us
 
es
;

2324 
blksize_bôs
 = 
öode
->
i_sb
->
s_blocksize_bôs
;

2325 
Êags
;

2326 
îr
;

2328 
block
 <
íd
) {

2329 
√xt
 = 0;

2330 
Êags
 = 0;

2331 i‡(!
	`pxt4_es_lookup_exã¡
(
öode
, 
block
, &
√xt
, &
es
))

2333 i‡(
	`pxt4_es_is_unwrôãn
(&
es
))

2334 
Êags
 |
FIEMAP_EXTENT_UNWRITTEN
;

2335 i‡(
	`pxt4_es_is_dñayed
(&
es
))

2336 
Êags
 |(
FIEMAP_EXTENT_DELALLOC
 |

2337 
FIEMAP_EXTENT_UNKNOWN
);

2338 i‡(
	`pxt4_es_is_hﬁe
(&
es
))

2339 
Êags
 |
PXT4_FIEMAP_EXTENT_HOLE
;

2340 i‡(
√xt
 == 0)

2341 
Êags
 |
FIEMAP_EXTENT_LAST
;

2342 i‡(
Êags
 & (
FIEMAP_EXTENT_DELALLOC
|

2343 
PXT4_FIEMAP_EXTENT_HOLE
))

2344 
es
.
es_pblk
 = 0;

2346 
es
.
es_pblk
 = 
	`pxt4_es_pblock
(&es);

2347 
îr
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
,

2348 (
__u64
)
es
.
es_lblk
 << 
blksize_bôs
,

2349 (
__u64
)
es
.
es_pblk
 << 
blksize_bôs
,

2350 (
__u64
)
es
.
es_Àn
 << 
blksize_bôs
,

2351 
Êags
);

2352 i‡(
√xt
 == 0)

2354 
block
 = 
√xt
;

2355 i‡(
îr
 < 0)

2356  
îr
;

2357 i‡(
îr
 == 1)

2361 
	}
}

2377 
pxt4_lblk_t
 
	$pxt4_ext_dëîmöe_hﬁe
(
öode
 *inode,

2378 
pxt4_ext_∑th
 *
∑th
,

2379 
pxt4_lblk_t
 *
lblk
)

2381 
dïth
 = 
	`ext_dïth
(
öode
);

2382 
pxt4_exã¡
 *
ex
;

2383 
pxt4_lblk_t
 
Àn
;

2385 
ex
 = 
∑th
[
dïth
].
p_ext
;

2386 i‡(
ex
 =
NULL
) {

2388 *
lblk
 = 0;

2389 
Àn
 = 
EXT_MAX_BLOCKS
;

2390 } i‡(*
lblk
 < 
	`À32_to_˝u
(
ex
->
ì_block
)) {

2391 
Àn
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë- *
lblk
;

2392 } i‡(*
lblk
 >
	`À32_to_˝u
(
ex
->
ì_block
)

2393 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
)) {

2394 
pxt4_lblk_t
 
√xt
;

2396 *
lblk
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
	`pxt4_ext_gë_a˘uÆ_Àn
(ex);

2397 
√xt
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

2398 
	`BUG_ON
(
√xt
 =*
lblk
);

2399 
Àn
 = 
√xt
 - *
lblk
;

2401 
	`BUG
();

2403  
Àn
;

2404 
	}
}

2412 
	$pxt4_ext_put_g≠_ö_ˇche
(
öode
 *öode, 
pxt4_lblk_t
 
hﬁe_°¨t
,

2413 
pxt4_lblk_t
 
hﬁe_Àn
)

2415 
exã¡_°©us
 
es
;

2417 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
hﬁe_°¨t
,

2418 
hﬁe_°¨t
 + 
hﬁe_Àn
 - 1, &
es
);

2419 i‡(
es
.
es_Àn
) {

2421 i‡(
es
.
es_lblk
 <
hﬁe_°¨t
)

2423 
hﬁe_Àn
 = 
	`mö
(
es
.
es_lblk
 - 
hﬁe_°¨t
, hole_len);

2425 
	`ext_debug
(" -> %u:%u\n", 
hﬁe_°¨t
, 
hﬁe_Àn
);

2426 
	`pxt4_es_ö£π_exã¡
(
öode
, 
hﬁe_°¨t
, 
hﬁe_Àn
, ~0,

2427 
EXTENT_STATUS_HOLE
);

2428 
	}
}

2434 
	$pxt4_ext_rm_idx
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2435 
pxt4_ext_∑th
 *
∑th
, 
dïth
)

2437 
îr
;

2438 
pxt4_fsblk_t
 
Àaf
;

2441 
dïth
--;

2442 
∑th
 =Ö©h + 
dïth
;

2443 
Àaf
 = 
	`pxt4_idx_pblock
(
∑th
->
p_idx
);

2444 i‡(
	`u∆ikñy
(
∑th
->
p_hdr
->
eh_íåõs
 == 0)) {

2445 
	`PXT4_ERROR_INODE
(
öode
, "path->p_hdr->eh_entries == 0");

2446  -
EFSCORRUPTED
;

2448 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

2449 i‡(
îr
)

2450  
îr
;

2452 i‡(
∑th
->
p_idx
 !
	`EXT_LAST_INDEX
’©h->
p_hdr
)) {

2453 
Àn
 = 
	`EXT_LAST_INDEX
(
∑th
->
p_hdr
Ë-Ö©h->
p_idx
;

2454 
Àn
 *(
pxt4_exã¡_idx
);

2455 
	`memmove
(
∑th
->
p_idx
,Ö©h->p_idx + 1, 
Àn
);

2458 
	`À16_add_˝u
(&
∑th
->
p_hdr
->
eh_íåõs
, -1);

2459 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
);

2460 i‡(
îr
)

2461  
îr
;

2462 
	`ext_debug
("ödex i†em±y,Ñemovêô, fªêblock %Œu\n", 
Àaf
);

2463 
	`åa˚_pxt4_ext_rm_idx
(
öode
, 
Àaf
);

2465 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
Àaf
, 1,

2466 
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
);

2468 --
dïth
 >= 0) {

2469 i‡(
∑th
->
p_idx
 !
	`EXT_FIRST_INDEX
’©h->
p_hdr
))

2471 
∑th
--;

2472 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

2473 i‡(
îr
)

2475 
∑th
->
p_idx
->
ei_block
 = (path+1)->p_idx->ei_block;

2476 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
);

2477 i‡(
îr
)

2480  
îr
;

2481 
	}
}

2490 
	$pxt4_ext_ˇlc_¸edôs_f‹_sögÀ_exã¡
(
öode
 *öode, 
ƒblocks
,

2491 
pxt4_ext_∑th
 *
∑th
)

2493 i‡(
∑th
) {

2494 
dïth
 = 
	`ext_dïth
(
öode
);

2495 
ªt
 = 0;

2498 i‡(
	`À16_to_˝u
(
∑th
[
dïth
].
p_hdr
->
eh_íåõs
)

2499 < 
	`À16_to_˝u
(
∑th
[
dïth
].
p_hdr
->
eh_max
)) {

2510 
ªt
 = 2 + 
	`PXT4_META_TRANS_BLOCKS
(
öode
->
i_sb
);

2511  
ªt
;

2515  
	`pxt4_chunk_å™s_blocks
(
öode
, 
ƒblocks
);

2516 
	}
}

2527 
	$pxt4_ext_ödex_å™s_blocks
(
öode
 *öode, 
exã¡s
)

2529 
ödex
;

2530 
dïth
;

2533 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

2536 
dïth
 = 
	`ext_dïth
(
öode
);

2538 i‡(
exã¡s
 <= 1)

2539 
ödex
 = 
dïth
 * 2;

2541 
ödex
 = 
dïth
 * 3;

2543  
ödex
;

2544 
	}
}

2546 
ölöe
 
	$gë_deÁu…_‰ì_blocks_Êags
(
öode
 *inode)

2548 i‡(
	`S_ISDIR
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode) ||

2549 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EA_INODE
))

2550  
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
;

2551 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

2552  
PXT4_FREE_BLOCKS_FORGET
;

2554 
	}
}

2571 
	$pxt4_ªª£rve_˛u°î
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

2573 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2574 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

2576 
	`dquŸ_ª˛aim_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 1));

2578 
	`•ö_lock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

2579 
ei
->
i_ª£rved_d©a_blocks
++;

2580 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 1);

2581 
	`•ö_u∆ock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

2583 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
, 1);

2584 
	`pxt4_ªmove_≥ndög
(
öode
, 
lblk
);

2585 
	}
}

2587 
	$pxt4_ªmove_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2588 
pxt4_exã¡
 *
ex
,

2589 
∑πül_˛u°î
 *
∑πül
,

2590 
pxt4_lblk_t
 
‰om
,Öxt4_lblk_à
to
)

2592 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2593 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2594 
pxt4_fsblk_t
 
œ°_pblk
, 
pblk
;

2595 
pxt4_lblk_t
 
num
;

2596 
Êags
;

2599 i‡(
‰om
 < 
	`À32_to_˝u
(
ex
->
ì_block
) ||

2600 
to
 !
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
 - 1) {

2601 
	`pxt4_îr‹
(
sbi
->
s_sb
,

2603 
‰om
, 
to
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_Àn
);

2607 #ifde‡
EXTENTS_STATS


2608 
	`•ö_lock
(&
sbi
->
s_ext_°©s_lock
);

2609 
sbi
->
s_ext_blocks
 +
ì_Àn
;

2610 
sbi
->
s_ext_exã¡s
++;

2611 i‡(
ì_Àn
 < 
sbi
->
s_ext_mö
)

2612 
sbi
->
s_ext_mö
 = 
ì_Àn
;

2613 i‡(
ì_Àn
 > 
sbi
->
s_ext_max
)

2614 
sbi
->
s_ext_max
 = 
ì_Àn
;

2615 i‡(
	`ext_dïth
(
öode
Ë> 
sbi
->
s_dïth_max
)

2616 
sbi
->
s_dïth_max
 = 
	`ext_dïth
(
öode
);

2617 
	`•ö_u∆ock
(&
sbi
->
s_ext_°©s_lock
);

2620 
	`åa˚_pxt4_ªmove_blocks
(
öode
, 
ex
, 
‰om
, 
to
, 
∑πül
);

2626 
œ°_pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ì_Àn
 - 1;

2628 i‡(
∑πül
->
°©e
 !
öôül
 &&

2629 
∑πül
->
p˛u
 !
	`PXT4_B2C
(
sbi
, 
œ°_pblk
)) {

2630 i‡(
∑πül
->
°©e
 =
to‰ì
) {

2631 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2632 i‡(
	`pxt4_is_≥ndög
(
öode
, 
∑πül
->
lblk
))

2633 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2634 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

2635 
	`PXT4_C2B
(
sbi
, 
∑πül
->
p˛u
),

2636 
sbi
->
s_˛u°î_øtio
, 
Êags
);

2637 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2638 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
∑πül
->
lblk
);

2640 
∑πül
->
°©e
 = 
öôül
;

2643 
num
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
 - 
‰om
;

2644 
pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ì_Àn
 - 
num
;

2652 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2655 i‡((
	`PXT4_LBLK_COFF
(
sbi
, 
to
Ë!sbi->
s_˛u°î_øtio
 - 1) &&

2656 (
	`PXT4_LBLK_CMASK
(
sbi
, 
to
Ë>
‰om
) &&

2657 (
∑πül
->
°©e
 !
no‰ì
)) {

2658 i‡(
	`pxt4_is_≥ndög
(
öode
, 
to
))

2659 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2660 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

2661 
	`PXT4_PBLK_CMASK
(
sbi
, 
œ°_pblk
),

2662 
sbi
->
s_˛u°î_øtio
, 
Êags
);

2663 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2664 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
to
);

2665 
∑πül
->
°©e
 = 
öôül
;

2666 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2669 
Êags
 |
PXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
;

2677 
Êags
 |
PXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
;

2678 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
pblk
, 
num
, 
Êags
);

2681 i‡(
∑πül
->
°©e
 !
öôül
 &&Ö¨tül->
p˛u
 !
	`PXT4_B2C
(
sbi
, 
pblk
))

2682 
∑πül
->
°©e
 = 
öôül
;

2694 i‡(
	`PXT4_LBLK_COFF
(
sbi
, 
‰om
Ë&& 
num
 =
ì_Àn
) {

2695 i‡(
∑πül
->
°©e
 =
öôül
) {

2696 
∑πül
->
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

2697 
∑πül
->
lblk
 = 
‰om
;

2698 
∑πül
->
°©e
 = 
to‰ì
;

2701 
∑πül
->
°©e
 = 
öôül
;

2705 
	}
}

2723 
	$pxt4_ext_rm_Àaf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2724 
pxt4_ext_∑th
 *
∑th
,

2725 
∑πül_˛u°î
 *
∑πül
,

2726 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
)

2728 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2729 
îr
 = 0, 
c‹ª˘_ödex
 = 0;

2730 
dïth
 = 
	`ext_dïth
(
öode
), 
¸edôs
;

2731 
pxt4_exã¡_hódî
 *
eh
;

2732 
pxt4_lblk_t
 
a
, 
b
;

2733 
num
;

2734 
pxt4_lblk_t
 
ex_ì_block
;

2735 
ex_ì_Àn
;

2736 
unwrôãn
 = 0;

2737 
pxt4_exã¡
 *
ex
;

2738 
pxt4_fsblk_t
 
pblk
;

2741 
	`ext_debug
("åunˇã sö˚ %u i¿Àa‡tÿ%u\n", 
°¨t
, 
íd
);

2742 i‡(!
∑th
[
dïth
].
p_hdr
)

2743 
∑th
[
dïth
].
p_hdr
 = 
	`ext_block_hdr
’©h[dïth].
p_bh
);

2744 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2745 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
 =
NULL
)) {

2746 
	`PXT4_ERROR_INODE
(
öode
, "∑th[%d].p_hd∏=NULL", 
dïth
);

2747  -
EFSCORRUPTED
;

2750 
ex
 = 
∑th
[
dïth
].
p_ext
;

2751 i‡(!
ex
)

2752 
ex
 = 
	`EXT_LAST_EXTENT
(
eh
);

2754 
ex_ì_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2755 
ex_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2757 
	`åa˚_pxt4_ext_rm_Àaf
(
öode
, 
°¨t
, 
ex
, 
∑πül
);

2759 
ex
 >
	`EXT_FIRST_EXTENT
(
eh
) &&

2760 
ex_ì_block
 + 
ex_ì_Àn
 > 
°¨t
) {

2762 i‡(
	`pxt4_ext_is_unwrôãn
(
ex
))

2763 
unwrôãn
 = 1;

2765 
unwrôãn
 = 0;

2767 
	`ext_debug
("ªmovêexà%u:[%d]%d\n", 
ex_ì_block
,

2768 
unwrôãn
, 
ex_ì_Àn
);

2769 
∑th
[
dïth
].
p_ext
 = 
ex
;

2771 
a
 = 
ex_ì_block
 > 
°¨t
 ?Éx_ee_block : start;

2772 
b
 = 
ex_ì_block
+
ex_ì_Àn
 - 1 < 
íd
 ?

2773 
ex_ì_block
+
ex_ì_Àn
 - 1 : 
íd
;

2775 
	`ext_debug
(" b‹dî %u:%u\n", 
a
, 
b
);

2778 i‡(
íd
 < 
ex_ì_block
) {

2786 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

2787 
pblk
 = 
	`pxt4_ext_pblock
(
ex
);

2788 
∑πül
->
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

2789 
∑πül
->
°©e
 = 
no‰ì
;

2791 
ex
--;

2792 
ex_ì_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2793 
ex_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2795 } i‡(
b
 !
ex_ì_block
 + 
ex_ì_Àn
 - 1) {

2796 
	`PXT4_ERROR_INODE
(
öode
,

2799 
°¨t
, 
íd
, 
ex_ì_block
,

2800 
ex_ì_block
 + 
ex_ì_Àn
 - 1);

2801 
îr
 = -
EFSCORRUPTED
;

2802 
out
;

2803 } i‡(
a
 !
ex_ì_block
) {

2805 
num
 = 
a
 - 
ex_ì_block
;

2808 
num
 = 0;

2816 
¸edôs
 = 7 + 2*(
ex_ì_Àn
/
	`PXT4_BLOCKS_PER_GROUP
(
öode
->
i_sb
));

2817 i‡(
ex
 =
	`EXT_FIRST_EXTENT
(
eh
)) {

2818 
c‹ª˘_ödex
 = 1;

2819 
¸edôs
 +(
	`ext_dïth
(
öode
)) + 1;

2821 
¸edôs
 +
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
öode
->
i_sb
);

2823 
îr
 = 
	`pxt4_ext_åunˇã_exãnd_ª°¨t
(
h™dÀ
, 
öode
, 
¸edôs
);

2824 i‡(
îr
)

2825 
out
;

2827 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

2828 i‡(
îr
)

2829 
out
;

2831 
îr
 = 
	`pxt4_ªmove_blocks
(
h™dÀ
, 
öode
, 
ex
, 
∑πül
, 
a
, 
b
);

2832 i‡(
îr
)

2833 
out
;

2835 i‡(
num
 == 0)

2837 
	`pxt4_ext_°‹e_pblock
(
ex
, 0);

2839 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
num
);

2844 i‡(
unwrôãn
 && 
num
)

2845 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

2850 i‡(
num
 == 0) {

2851 i‡(
íd
 !
EXT_MAX_BLOCKS
 - 1) {

2857 
	`memmove
(
ex
,Éx+1, (
	`EXT_LAST_EXTENT
(
eh
) -Éx) *

2858 (
pxt4_exã¡
));

2861 
	`mem£t
(
	`EXT_LAST_EXTENT
(
eh
), 0,

2862 (
pxt4_exã¡
));

2864 
	`À16_add_˝u
(&
eh
->
eh_íåõs
, -1);

2867 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

2868 i‡(
îr
)

2869 
out
;

2871 
	`ext_debug
("√wÉxã¡: %u:%u:%Œu\n", 
ex_ì_block
, 
num
,

2872 
	`pxt4_ext_pblock
(
ex
));

2873 
ex
--;

2874 
ex_ì_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2875 
ex_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2878 i‡(
c‹ª˘_ödex
 && 
eh
->
eh_íåõs
)

2879 
îr
 = 
	`pxt4_ext_c‹ª˘_ödexes
(
h™dÀ
, 
öode
, 
∑th
);

2888 i‡(
∑πül
->
°©e
 =
to‰ì
 && 
ex
 >
	`EXT_FIRST_EXTENT
(
eh
)) {

2889 
pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ex_ì_Àn
 - 1;

2890 i‡(
∑πül
->
p˛u
 !
	`PXT4_B2C
(
sbi
, 
pblk
)) {

2891 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2893 i‡(
	`pxt4_is_≥ndög
(
öode
, 
∑πül
->
lblk
))

2894 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2895 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

2896 
	`PXT4_C2B
(
sbi
, 
∑πül
->
p˛u
),

2897 
sbi
->
s_˛u°î_øtio
, 
Êags
);

2898 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2899 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
∑πül
->
lblk
);

2901 
∑πül
->
°©e
 = 
öôül
;

2906 i‡(
îr
 =0 && 
eh
->
eh_íåõs
 =0 && 
∑th
[
dïth
].
p_bh
 !
NULL
)

2907 
îr
 = 
	`pxt4_ext_rm_idx
(
h™dÀ
, 
öode
, 
∑th
, 
dïth
);

2909 
out
:

2910  
îr
;

2911 
	}
}

2918 
	$pxt4_ext_m‹e_to_rm
(
pxt4_ext_∑th
 *
∑th
)

2920 
	`BUG_ON
(
∑th
->
p_idx
 =
NULL
);

2922 i‡(
∑th
->
p_idx
 < 
	`EXT_FIRST_INDEX
’©h->
p_hdr
))

2929 i‡(
	`À16_to_˝u
(
∑th
->
p_hdr
->
eh_íåõs
Ë=∑th->
p_block
)

2932 
	}
}

2934 
	$pxt4_ext_ªmove_•a˚
(
öode
 *öode, 
pxt4_lblk_t
 
°¨t
,

2935 
pxt4_lblk_t
 
íd
)

2937 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2938 
dïth
 = 
	`ext_dïth
(
öode
);

2939 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

2940 
∑πül_˛u°î
 
∑πül
;

2941 
h™dÀ_t
 *
h™dÀ
;

2942 
i
 = 0, 
îr
 = 0;

2944 
∑πül
.
p˛u
 = 0;

2945 
∑πül
.
lblk
 = 0;

2946 
∑πül
.
°©e
 = 
öôül
;

2948 
	`ext_debug
("åunˇã sö˚ %uÅÿ%u\n", 
°¨t
, 
íd
);

2951 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
dïth
 + 1);

2952 i‡(
	`IS_ERR
(
h™dÀ
))

2953  
	`PTR_ERR
(
h™dÀ
);

2955 
agaö
:

2956 
	`åa˚_pxt4_ext_ªmove_•a˚
(
öode
, 
°¨t
, 
íd
, 
dïth
);

2965 i‡(
íd
 < 
EXT_MAX_BLOCKS
 - 1) {

2966 
pxt4_exã¡
 *
ex
;

2967 
pxt4_lblk_t
 
ì_block
, 
ex_íd
, 
lblk
;

2968 
pxt4_fsblk_t
 
pblk
;

2971 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
íd
, 
NULL
, 
PXT4_EX_NOCACHE
);

2972 i‡(
	`IS_ERR
(
∑th
)) {

2973 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2974  
	`PTR_ERR
(
∑th
);

2976 
dïth
 = 
	`ext_dïth
(
öode
);

2978 
ex
 = 
∑th
[
dïth
].
p_ext
;

2979 i‡(!
ex
) {

2980 i‡(
dïth
) {

2981 
	`PXT4_ERROR_INODE
(
öode
,

2983 
dïth
);

2984 
îr
 = -
EFSCORRUPTED
;

2986 
out
;

2989 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

2990 
ex_íd
 = 
ì_block
 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
) - 1;

2998 i‡(
íd
 >
ì_block
 &&Énd < 
ex_íd
) {

3005 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

3006 
pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
íd
 - 
ì_block
 + 2;

3007 
∑πül
.
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

3008 
∑πül
.
°©e
 = 
no‰ì
;

3017 
îr
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode
, &
∑th
,

3018 
íd
 + 1, 1);

3019 i‡(
îr
 < 0)

3020 
out
;

3022 } i‡(
sbi
->
s_˛u°î_øtio
 > 1 && 
íd
 >
ex_íd
 &&

3023 
∑πül
.
°©e
 =
öôül
) {

3034 
lblk
 = 
ex_íd
 + 1;

3035 
îr
 = 
	`pxt4_ext_£¨ch_right
(
öode
, 
∑th
, &
lblk
, &
pblk
,

3036 &
ex
);

3037 i‡(
îr
)

3038 
out
;

3039 i‡(
pblk
) {

3040 
∑πül
.
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

3041 
∑πül
.
°©e
 = 
no‰ì
;

3049 
dïth
 = 
	`ext_dïth
(
öode
);

3050 i‡(
∑th
) {

3051 
k
 = 
i
 = 
dïth
;

3052 --
k
 > 0)

3053 
∑th
[
k
].
p_block
 =

3054 
	`À16_to_˝u
(
∑th
[
k
].
p_hdr
->
eh_íåõs
)+1;

3056 
∑th
 = 
	`kˇŒoc
(
dïth
 + 1, (
pxt4_ext_∑th
),

3057 
GFP_NOFS
);

3058 i‡(
∑th
 =
NULL
) {

3059 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3060  -
ENOMEM
;

3062 
∑th
[0].
p_maxdïth
 =Ö©h[0].
p_dïth
 = 
dïth
;

3063 
∑th
[0].
p_hdr
 = 
	`ext_öode_hdr
(
öode
);

3064 
i
 = 0;

3066 i‡(
	`pxt4_ext_check
(
öode
, 
∑th
[0].
p_hdr
, 
dïth
, 0)) {

3067 
îr
 = -
EFSCORRUPTED
;

3068 
out
;

3071 
îr
 = 0;

3073 
i
 >0 && 
îr
 == 0) {

3074 i‡(
i
 =
dïth
) {

3076 
îr
 = 
	`pxt4_ext_rm_Àaf
(
h™dÀ
, 
öode
, 
∑th
,

3077 &
∑πül
, 
°¨t
, 
íd
);

3079 
	`bªl£
(
∑th
[
i
].
p_bh
);

3080 
∑th
[
i
].
p_bh
 = 
NULL
;

3081 
i
--;

3086 i‡(!
∑th
[
i
].
p_hdr
) {

3087 
	`ext_debug
("initialize header\n");

3088 
∑th
[
i
].
p_hdr
 = 
	`ext_block_hdr
’©h[i].
p_bh
);

3091 i‡(!
∑th
[
i
].
p_idx
) {

3093 
∑th
[
i
].
p_idx
 = 
	`EXT_LAST_INDEX
’©h[i].
p_hdr
);

3094 
∑th
[
i
].
p_block
 = 
	`À16_to_˝u
’©h[i].
p_hdr
->
eh_íåõs
)+1;

3095 
	`ext_debug
("init indexÖtr: hdr 0x%p,Çum %d\n",

3096 
∑th
[
i
].
p_hdr
,

3097 
	`À16_to_˝u
(
∑th
[
i
].
p_hdr
->
eh_íåõs
));

3100 
∑th
[
i
].
p_idx
--;

3103 
	`ext_debug
("level %d - index, first 0x%p, cur 0x%p\n",

3104 
i
, 
	`EXT_FIRST_INDEX
(
∑th
[i].
p_hdr
),

3105 
∑th
[
i
].
p_idx
);

3106 i‡(
	`pxt4_ext_m‹e_to_rm
(
∑th
 + 
i
)) {

3107 
buf„r_hód
 *
bh
;

3109 
	`ext_debug
("moveÅoÜevel %d (block %llu)\n",

3110 
i
 + 1, 
	`pxt4_idx_pblock
(
∑th
[i].
p_idx
));

3111 
	`mem£t
(
∑th
 + 
i
 + 1, 0, (*path));

3112 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
,

3113 
	`pxt4_idx_pblock
(
∑th
[
i
].
p_idx
), 
dïth
 - i - 1,

3114 
PXT4_EX_NOCACHE
);

3115 i‡(
	`IS_ERR
(
bh
)) {

3117 
îr
 = 
	`PTR_ERR
(
bh
);

3122 
	`c⁄d_ªsched
();

3123 i‡(
	`WARN_ON
(
i
 + 1 > 
dïth
)) {

3124 
îr
 = -
EFSCORRUPTED
;

3127 
∑th
[
i
 + 1].
p_bh
 = 
bh
;

3131 
∑th
[
i
].
p_block
 = 
	`À16_to_˝u
’©h[i].
p_hdr
->
eh_íåõs
);

3132 
i
++;

3135 i‡(
∑th
[
i
].
p_hdr
->
eh_íåõs
 == 0 && i > 0) {

3139 
îr
 = 
	`pxt4_ext_rm_idx
(
h™dÀ
, 
öode
, 
∑th
, 
i
);

3142 
	`bªl£
(
∑th
[
i
].
p_bh
);

3143 
∑th
[
i
].
p_bh
 = 
NULL
;

3144 
i
--;

3145 
	`ext_debug
("ªtu∫ÅÿÀvñ %d\n", 
i
);

3149 
	`åa˚_pxt4_ext_ªmove_•a˚_d⁄e
(
öode
, 
°¨t
, 
íd
, 
dïth
, &
∑πül
,

3150 
∑th
->
p_hdr
->
eh_íåõs
);

3156 i‡(
∑πül
.
°©e
 =
to‰ì
 && 
îr
 == 0) {

3157 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

3159 i‡(
	`pxt4_is_≥ndög
(
öode
, 
∑πül
.
lblk
))

3160 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

3161 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

3162 
	`PXT4_C2B
(
sbi
, 
∑πül
.
p˛u
),

3163 
sbi
->
s_˛u°î_øtio
, 
Êags
);

3164 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

3165 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
∑πül
.
lblk
);

3166 
∑πül
.
°©e
 = 
öôül
;

3170 i‡(
∑th
->
p_hdr
->
eh_íåõs
 == 0) {

3175 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

3176 i‡(
îr
 == 0) {

3177 
	`ext_öode_hdr
(
öode
)->
eh_dïth
 = 0;

3178 
	`ext_öode_hdr
(
öode
)->
eh_max
 =

3179 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_roŸ
(
öode
, 0));

3180 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
);

3183 
out
:

3184 
	`pxt4_ext_dr›_ªfs
(
∑th
);

3185 
	`k‰ì
(
∑th
);

3186 
∑th
 = 
NULL
;

3187 i‡(
îr
 =-
EAGAIN
)

3188 
agaö
;

3189 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3191  
îr
;

3192 
	}
}

3197 
	$pxt4_ext_öô
(
su≥r_block
 *
sb
)

3203 i‡(
	`pxt4_has_„©uª_exã¡s
(
sb
)) {

3204 #i‡
	`deföed
(
AGGRESSIVE_TEST
Ë|| deföed(
CHECK_BINSEARCH
Ë|| deföed(
EXTENTS_STATS
)

3205 
	`¥ötk
(
KERN_INFO
 "PXT4-fs: fileÉxtentsÉnabled"

3206 #ifde‡
AGGRESSIVE_TEST


3209 #ifde‡
CHECK_BINSEARCH


3212 #ifde‡
EXTENTS_STATS


3217 #ifde‡
EXTENTS_STATS


3218 
	`•ö_lock_öô
(&
	`PXT4_SB
(
sb
)->
s_ext_°©s_lock
);

3219 
	`PXT4_SB
(
sb
)->
s_ext_mö
 = 1 << 30;

3220 
	`PXT4_SB
(
sb
)->
s_ext_max
 = 0;

3223 
	}
}

3228 
	$pxt4_ext_ªÀa£
(
su≥r_block
 *
sb
)

3230 i‡(!
	`pxt4_has_„©uª_exã¡s
(
sb
))

3233 #ifde‡
EXTENTS_STATS


3234 i‡(
	`PXT4_SB
(
sb
)->
s_ext_blocks
 && PXT4_SB(sb)->
s_ext_exã¡s
) {

3235 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3236 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: %lu blocks in %luÉxtents (%luáve)\n",

3237 
sbi
->
s_ext_blocks
, sbi->
s_ext_exã¡s
,

3238 
sbi
->
s_ext_blocks
 / sbi->
s_ext_exã¡s
);

3239 
	`¥ötk
(
KERN_ERR
 "PXT4-fs:Éxtents: %lu min, %lu max, max depth %lu\n",

3240 
sbi
->
s_ext_mö
, sbi->
s_ext_max
, sbi->
s_dïth_max
);

3243 
	}
}

3245 
	$pxt4_zîoout_es
(
öode
 *öode, 
pxt4_exã¡
 *
ex
)

3247 
pxt4_lblk_t
 
ì_block
;

3248 
pxt4_fsblk_t
 
ì_pblock
;

3249 
ì_Àn
;

3251 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3252 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3253 
ì_pblock
 = 
	`pxt4_ext_pblock
(
ex
);

3255 i‡(
ì_Àn
 == 0)

3258  
	`pxt4_es_ö£π_exã¡
(
öode
, 
ì_block
, 
ì_Àn
, 
ì_pblock
,

3259 
EXTENT_STATUS_WRITTEN
);

3260 
	}
}

3263 
	$pxt4_ext_zîoout
(
öode
 *öode, 
pxt4_exã¡
 *
ex
)

3265 
pxt4_fsblk_t
 
ì_pblock
;

3266 
ì_Àn
;

3268 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3269 
ì_pblock
 = 
	`pxt4_ext_pblock
(
ex
);

3270  
	`pxt4_issue_zîoout
(
öode
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_pblock
,

3271 
ì_Àn
);

3272 
	}
}

3295 
	$pxt4_•lô_exã¡_©
(
h™dÀ_t
 *
h™dÀ
,

3296 
öode
 *inode,

3297 
pxt4_ext_∑th
 **
µ©h
,

3298 
pxt4_lblk_t
 
•lô
,

3299 
•lô_Êag
,

3300 
Êags
)

3302 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3303 
pxt4_fsblk_t
 
√wblock
;

3304 
pxt4_lblk_t
 
ì_block
;

3305 
pxt4_exã¡
 *
ex
, 
√wex
, 
‹ig_ex
, 
zîo_ex
;

3306 
pxt4_exã¡
 *
ex2
 = 
NULL
;

3307 
ì_Àn
, 
dïth
;

3308 
îr
 = 0;

3310 
	`BUG_ON
((
•lô_Êag
 & (
PXT4_EXT_DATA_VALID1
 | 
PXT4_EXT_DATA_VALID2
)) ==

3311 (
PXT4_EXT_DATA_VALID1
 | 
PXT4_EXT_DATA_VALID2
));

3313 
	`ext_debug
("pxt4_split_extents_at: inode %lu,Üogical"

3314 "block %Œu\n", 
öode
->
i_öo
, ()
•lô
);

3316 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3318 
dïth
 = 
	`ext_dïth
(
öode
);

3319 
ex
 = 
∑th
[
dïth
].
p_ext
;

3320 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3321 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3322 
√wblock
 = 
•lô
 - 
ì_block
 + 
	`pxt4_ext_pblock
(
ex
);

3324 
	`BUG_ON
(
•lô
 < 
ì_block
 || s∂ô >”e_block + 
ì_Àn
));

3325 
	`BUG_ON
(!
	`pxt4_ext_is_unwrôãn
(
ex
) &&

3326 
•lô_Êag
 & (
PXT4_EXT_MAY_ZEROOUT
 |

3327 
PXT4_EXT_MARK_UNWRIT1
 |

3328 
PXT4_EXT_MARK_UNWRIT2
));

3330 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3331 i‡(
îr
)

3332 
out
;

3334 i‡(
•lô
 =
ì_block
) {

3340 i‡(
•lô_Êag
 & 
PXT4_EXT_MARK_UNWRIT2
)

3341 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3343 
	`pxt4_ext_m¨k_öôülized
(
ex
);

3345 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
))

3346 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

3348 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3349 
out
;

3353 
	`mem˝y
(&
‹ig_ex
, 
ex
, (orig_ex));

3354 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
•lô
 - 
ì_block
);

3355 i‡(
•lô_Êag
 & 
PXT4_EXT_MARK_UNWRIT1
)

3356 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3362 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3363 i‡(
îr
)

3364 
fix_exã¡_Àn
;

3366 
ex2
 = &
√wex
;

3367 
ex2
->
ì_block
 = 
	`˝u_to_À32
(
•lô
);

3368 
ex2
->
ì_Àn
 = 
	`˝u_to_À16
”e_À¿- (
•lô
 - 
ì_block
));

3369 
	`pxt4_ext_°‹e_pblock
(
ex2
, 
√wblock
);

3370 i‡(
•lô_Êag
 & 
PXT4_EXT_MARK_UNWRIT2
)

3371 
	`pxt4_ext_m¨k_unwrôãn
(
ex2
);

3373 
îr
 = 
	`pxt4_ext_ö£π_exã¡
(
h™dÀ
, 
öode
, 
µ©h
, &
√wex
, 
Êags
);

3374 i‡(
îr
 =-
ENOSPC
 && (
PXT4_EXT_MAY_ZEROOUT
 & 
•lô_Êag
)) {

3375 i‡(
•lô_Êag
 & (
PXT4_EXT_DATA_VALID1
|
PXT4_EXT_DATA_VALID2
)) {

3376 i‡(
•lô_Êag
 & 
PXT4_EXT_DATA_VALID1
) {

3377 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, 
ex2
);

3378 
zîo_ex
.
ì_block
 = 
ex2
->ee_block;

3379 
zîo_ex
.
ì_Àn
 = 
	`˝u_to_À16
(

3380 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex2
));

3381 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex
,

3382 
	`pxt4_ext_pblock
(
ex2
));

3384 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, 
ex
);

3385 
zîo_ex
.
ì_block
 = 
ex
->ee_block;

3386 
zîo_ex
.
ì_Àn
 = 
	`˝u_to_À16
(

3387 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
));

3388 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex
,

3389 
	`pxt4_ext_pblock
(
ex
));

3392 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, &
‹ig_ex
);

3393 
zîo_ex
.
ì_block
 = 
‹ig_ex
.ee_block;

3394 
zîo_ex
.
ì_Àn
 = 
	`˝u_to_À16
(

3395 
	`pxt4_ext_gë_a˘uÆ_Àn
(&
‹ig_ex
));

3396 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex
,

3397 
	`pxt4_ext_pblock
(&
‹ig_ex
));

3400 i‡(
îr
)

3401 
fix_exã¡_Àn
;

3403 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(ee_len);

3404 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

3405 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3406 i‡(
îr
)

3407 
fix_exã¡_Àn
;

3410 
îr
 = 
	`pxt4_zîoout_es
(
öode
, &
zîo_ex
);

3412 
out
;

3413 } i‡(
îr
)

3414 
fix_exã¡_Àn
;

3416 
out
:

3417 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3418  
îr
;

3420 
fix_exã¡_Àn
:

3421 
ex
->
ì_Àn
 = 
‹ig_ex
.ee_len;

3422 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3423  
îr
;

3424 
	}
}

3437 
	$pxt4_•lô_exã¡
(
h™dÀ_t
 *
h™dÀ
,

3438 
öode
 *inode,

3439 
pxt4_ext_∑th
 **
µ©h
,

3440 
pxt4_m≠_blocks
 *
m≠
,

3441 
•lô_Êag
,

3442 
Êags
)

3444 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3445 
pxt4_lblk_t
 
ì_block
;

3446 
pxt4_exã¡
 *
ex
;

3447 
ì_Àn
, 
dïth
;

3448 
îr
 = 0;

3449 
unwrôãn
;

3450 
•lô_Êag1
, 
Êags1
;

3451 
Æloˇãd
 = 
m≠
->
m_Àn
;

3453 
dïth
 = 
	`ext_dïth
(
öode
);

3454 
ex
 = 
∑th
[
dïth
].
p_ext
;

3455 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3456 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3457 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

3459 i‡(
m≠
->
m_lblk
 + m≠->
m_Àn
 < 
ì_block
 + 
ì_Àn
) {

3460 
•lô_Êag1
 = 
•lô_Êag
 & 
PXT4_EXT_MAY_ZEROOUT
;

3461 
Êags1
 = 
Êags
 | 
PXT4_GET_BLOCKS_PRE_IO
;

3462 i‡(
unwrôãn
)

3463 
•lô_Êag1
 |
PXT4_EXT_MARK_UNWRIT1
 |

3464 
PXT4_EXT_MARK_UNWRIT2
;

3465 i‡(
•lô_Êag
 & 
PXT4_EXT_DATA_VALID2
)

3466 
•lô_Êag1
 |
PXT4_EXT_DATA_VALID1
;

3467 
îr
 = 
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, 
µ©h
,

3468 
m≠
->
m_lblk
 + m≠->
m_Àn
, 
•lô_Êag1
, 
Êags1
);

3469 i‡(
îr
)

3470 
out
;

3472 
Æloˇãd
 = 
ì_Àn
 - (
m≠
->
m_lblk
 - 
ì_block
);

3478 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
µ©h
, 0);

3479 i‡(
	`IS_ERR
(
∑th
))

3480  
	`PTR_ERR
(
∑th
);

3481 
dïth
 = 
	`ext_dïth
(
öode
);

3482 
ex
 = 
∑th
[
dïth
].
p_ext
;

3483 i‡(!
ex
) {

3484 
	`PXT4_ERROR_INODE
(
öode
, "unexpected holeát %lu",

3485 (Ë
m≠
->
m_lblk
);

3486  -
EFSCORRUPTED
;

3488 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

3489 
•lô_Êag1
 = 0;

3491 i‡(
m≠
->
m_lblk
 >
ì_block
) {

3492 
•lô_Êag1
 = 
•lô_Êag
 & 
PXT4_EXT_DATA_VALID2
;

3493 i‡(
unwrôãn
) {

3494 
•lô_Êag1
 |
PXT4_EXT_MARK_UNWRIT1
;

3495 
•lô_Êag1
 |
•lô_Êag
 & (
PXT4_EXT_MAY_ZEROOUT
 |

3496 
PXT4_EXT_MARK_UNWRIT2
);

3498 
îr
 = 
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, 
µ©h
,

3499 
m≠
->
m_lblk
, 
•lô_Êag1
, 
Êags
);

3500 i‡(
îr
)

3501 
out
;

3504 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3505 
out
:

3506  
îr
 ?Éº : 
Æloˇãd
;

3507 
	}
}

3529 
	$pxt4_ext_c⁄vît_to_öôülized
(
h™dÀ_t
 *
h™dÀ
,

3530 
öode
 *inode,

3531 
pxt4_m≠_blocks
 *
m≠
,

3532 
pxt4_ext_∑th
 **
µ©h
,

3533 
Êags
)

3535 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3536 
pxt4_sb_öfo
 *
sbi
;

3537 
pxt4_exã¡_hódî
 *
eh
;

3538 
pxt4_m≠_blocks
 
•lô_m≠
;

3539 
pxt4_exã¡
 
zîo_ex1
, 
zîo_ex2
;

3540 
pxt4_exã¡
 *
ex
, *
abut_ex
;

3541 
pxt4_lblk_t
 
ì_block
, 
eof_block
;

3542 
ì_Àn
, 
dïth
, 
m≠_Àn
 = 
m≠
->
m_Àn
;

3543 
Æloˇãd
 = 0, 
max_zîoout
 = 0;

3544 
îr
 = 0;

3545 
•lô_Êag
 = 
PXT4_EXT_DATA_VALID2
;

3547 
	`ext_debug
("pxt4_ext_convert_to_initialized: inode %lu,Üogical"

3548 "block %Œu, max_block†%u\n", 
öode
->
i_öo
,

3549 ()
m≠
->
m_lblk
, 
m≠_Àn
);

3551 
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

3552 
eof_block
 = (
öode
->
i_size
 + inode->
i_sb
->
s_blocksize
 - 1) >>

3553 
öode
->
i_sb
->
s_blocksize_bôs
;

3554 i‡(
eof_block
 < 
m≠
->
m_lblk
 + 
m≠_Àn
)

3555 
eof_block
 = 
m≠
->
m_lblk
 + 
m≠_Àn
;

3557 
dïth
 = 
	`ext_dïth
(
öode
);

3558 
eh
 = 
∑th
[
dïth
].
p_hdr
;

3559 
ex
 = 
∑th
[
dïth
].
p_ext
;

3560 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3561 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3562 
zîo_ex1
.
ì_Àn
 = 0;

3563 
zîo_ex2
.
ì_Àn
 = 0;

3565 
	`åa˚_pxt4_ext_c⁄vît_to_öôülized_íãr
(
öode
, 
m≠
, 
ex
);

3568 
	`BUG_ON
(!
	`pxt4_ext_is_unwrôãn
(
ex
));

3569 
	`BUG_ON
(!
	`ö_ønge
(
m≠
->
m_lblk
, 
ì_block
, 
ì_Àn
));

3586 i‡((
m≠
->
m_lblk
 =
ì_block
) &&

3588 (
m≠_Àn
 < 
ì_Àn
) &&

3589 (
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
))) {

3590 
pxt4_lblk_t
 
¥ev_lblk
;

3591 
pxt4_fsblk_t
 
¥ev_pblk
, 
ì_pblk
;

3592 
¥ev_Àn
;

3594 
abut_ex
 = 
ex
 - 1;

3595 
¥ev_lblk
 = 
	`À32_to_˝u
(
abut_ex
->
ì_block
);

3596 
¥ev_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
abut_ex
);

3597 
¥ev_pblk
 = 
	`pxt4_ext_pblock
(
abut_ex
);

3598 
ì_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

3609 i‡((!
	`pxt4_ext_is_unwrôãn
(
abut_ex
)) &&

3610 ((
¥ev_lblk
 + 
¥ev_Àn
Ë=
ì_block
) &&

3611 ((
¥ev_pblk
 + 
¥ev_Àn
Ë=
ì_pblk
) &&

3612 (
¥ev_Àn
 < (
EXT_INIT_MAX_LEN
 - 
m≠_Àn
))) {

3613 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3614 i‡(
îr
)

3615 
out
;

3617 
	`åa˚_pxt4_ext_c⁄vît_to_öôülized_Á°∑th
(
öode
,

3618 
m≠
, 
ex
, 
abut_ex
);

3621 
ex
->
ì_block
 = 
	`˝u_to_À32
”e_block + 
m≠_Àn
);

3622 
	`pxt4_ext_°‹e_pblock
(
ex
, 
ì_pblk
 + 
m≠_Àn
);

3623 
ex
->
ì_Àn
 = 
	`˝u_to_À16
”e_À¿- 
m≠_Àn
);

3624 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3627 
abut_ex
->
ì_Àn
 = 
	`˝u_to_À16
(
¥ev_Àn
 + 
m≠_Àn
);

3630 
Æloˇãd
 = 
m≠_Àn
;

3632 } i‡(((
m≠
->
m_lblk
 + 
m≠_Àn
Ë=(
ì_block
 + 
ì_Àn
)) &&

3633 (
m≠_Àn
 < 
ì_Àn
) &&

3634 
ex
 < 
	`EXT_LAST_EXTENT
(
eh
)) {

3636 
pxt4_lblk_t
 
√xt_lblk
;

3637 
pxt4_fsblk_t
 
√xt_pblk
, 
ì_pblk
;

3638 
√xt_Àn
;

3640 
abut_ex
 = 
ex
 + 1;

3641 
√xt_lblk
 = 
	`À32_to_˝u
(
abut_ex
->
ì_block
);

3642 
√xt_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
abut_ex
);

3643 
√xt_pblk
 = 
	`pxt4_ext_pblock
(
abut_ex
);

3644 
ì_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

3655 i‡((!
	`pxt4_ext_is_unwrôãn
(
abut_ex
)) &&

3656 ((
m≠
->
m_lblk
 + 
m≠_Àn
Ë=
√xt_lblk
) &&

3657 ((
ì_pblk
 + 
ì_Àn
Ë=
√xt_pblk
) &&

3658 (
√xt_Àn
 < (
EXT_INIT_MAX_LEN
 - 
m≠_Àn
))) {

3659 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3660 i‡(
îr
)

3661 
out
;

3663 
	`åa˚_pxt4_ext_c⁄vît_to_öôülized_Á°∑th
(
öode
,

3664 
m≠
, 
ex
, 
abut_ex
);

3667 
abut_ex
->
ì_block
 = 
	`˝u_to_À32
(
√xt_lblk
 - 
m≠_Àn
);

3668 
	`pxt4_ext_°‹e_pblock
(
abut_ex
, 
√xt_pblk
 - 
m≠_Àn
);

3669 
ex
->
ì_Àn
 = 
	`˝u_to_À16
”e_À¿- 
m≠_Àn
);

3670 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3673 
abut_ex
->
ì_Àn
 = 
	`˝u_to_À16
(
√xt_Àn
 + 
m≠_Àn
);

3676 
Æloˇãd
 = 
m≠_Àn
;

3679 i‡(
Æloˇãd
) {

3681 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3684 
∑th
[
dïth
].
p_ext
 = 
abut_ex
;

3685 
out
;

3687 
Æloˇãd
 = 
ì_Àn
 - (
m≠
->
m_lblk
 - 
ì_block
);

3689 
	`WARN_ON
(
m≠
->
m_lblk
 < 
ì_block
);

3694 
•lô_Êag
 |
ì_block
 + 
ì_Àn
 <
eof_block
 ? 
PXT4_EXT_MAY_ZEROOUT
 : 0;

3696 i‡(
PXT4_EXT_MAY_ZEROOUT
 & 
•lô_Êag
)

3697 
max_zîoout
 = 
sbi
->
s_exã¡_max_zîoout_kb
 >>

3698 (
öode
->
i_sb
->
s_blocksize_bôs
 - 10);

3700 i‡(
	`IS_ENCRYPTED
(
öode
))

3701 
max_zîoout
 = 0;

3714 
•lô_m≠
.
m_lblk
 = 
m≠
->m_lblk;

3715 
•lô_m≠
.
m_Àn
 = 
m≠
->m_len;

3717 i‡(
max_zîoout
 && (
Æloˇãd
 > 
•lô_m≠
.
m_Àn
)) {

3718 i‡(
Æloˇãd
 <
max_zîoout
) {

3720 
zîo_ex1
.
ì_block
 =

3721 
	`˝u_to_À32
(
•lô_m≠
.
m_lblk
 +

3722 
•lô_m≠
.
m_Àn
);

3723 
zîo_ex1
.
ì_Àn
 =

3724 
	`˝u_to_À16
(
Æloˇãd
 - 
•lô_m≠
.
m_Àn
);

3725 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex1
,

3726 
	`pxt4_ext_pblock
(
ex
Ë+ 
•lô_m≠
.
m_lblk
 +

3727 
•lô_m≠
.
m_Àn
 - 
ì_block
);

3728 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, &
zîo_ex1
);

3729 i‡(
îr
)

3730 
out
;

3731 
•lô_m≠
.
m_Àn
 = 
Æloˇãd
;

3733 i‡(
•lô_m≠
.
m_lblk
 - 
ì_block
 + s∂ô_m≠.
m_Àn
 <

3734 
max_zîoout
) {

3736 i‡(
•lô_m≠
.
m_lblk
 !
ì_block
) {

3737 
zîo_ex2
.
ì_block
 = 
ex
->ee_block;

3738 
zîo_ex2
.
ì_Àn
 = 
	`˝u_to_À16
(
•lô_m≠
.
m_lblk
 -

3739 
ì_block
);

3740 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex2
,

3741 
	`pxt4_ext_pblock
(
ex
));

3742 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, &
zîo_ex2
);

3743 i‡(
îr
)

3744 
out
;

3747 
•lô_m≠
.
m_Àn
 +•lô_m≠.
m_lblk
 - 
ì_block
;

3748 
•lô_m≠
.
m_lblk
 = 
ì_block
;

3749 
Æloˇãd
 = 
m≠
->
m_Àn
;

3753 
îr
 = 
	`pxt4_•lô_exã¡
(
h™dÀ
, 
öode
, 
µ©h
, &
•lô_m≠
, 
•lô_Êag
,

3754 
Êags
);

3755 i‡(
îr
 > 0)

3756 
îr
 = 0;

3757 
out
:

3759 i‡(!
îr
) {

3760 
îr
 = 
	`pxt4_zîoout_es
(
öode
, &
zîo_ex1
);

3761 i‡(!
îr
)

3762 
îr
 = 
	`pxt4_zîoout_es
(
öode
, &
zîo_ex2
);

3764  
îr
 ?Éº : 
Æloˇãd
;

3765 
	}
}

3791 
	$pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ_t
 *
h™dÀ
,

3792 
öode
 *inode,

3793 
pxt4_m≠_blocks
 *
m≠
,

3794 
pxt4_ext_∑th
 **
µ©h
,

3795 
Êags
)

3797 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3798 
pxt4_lblk_t
 
eof_block
;

3799 
pxt4_lblk_t
 
ì_block
;

3800 
pxt4_exã¡
 *
ex
;

3801 
ì_Àn
;

3802 
•lô_Êag
 = 0, 
dïth
;

3804 
	`ext_debug
("%s: inode %lu,Üogical block %llu, max_blocks %u\n",

3805 
__func__
, 
öode
->
i_öo
,

3806 ()
m≠
->
m_lblk
, m≠->
m_Àn
);

3808 
eof_block
 = (
öode
->
i_size
 + inode->
i_sb
->
s_blocksize
 - 1) >>

3809 
öode
->
i_sb
->
s_blocksize_bôs
;

3810 i‡(
eof_block
 < 
m≠
->
m_lblk
 + m≠->
m_Àn
)

3811 
eof_block
 = 
m≠
->
m_lblk
 + m≠->
m_Àn
;

3816 
dïth
 = 
	`ext_dïth
(
öode
);

3817 
ex
 = 
∑th
[
dïth
].
p_ext
;

3818 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3819 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3822 i‡(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
) {

3823 
•lô_Êag
 |
PXT4_EXT_DATA_VALID1
;

3825 } i‡(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT
) {

3826 
•lô_Êag
 |
ì_block
 + 
ì_Àn
 <
eof_block
 ?

3827 
PXT4_EXT_MAY_ZEROOUT
 : 0;

3828 
•lô_Êag
 |(
PXT4_EXT_MARK_UNWRIT2
 | 
PXT4_EXT_DATA_VALID2
);

3830 
Êags
 |
PXT4_GET_BLOCKS_PRE_IO
;

3831  
	`pxt4_•lô_exã¡
(
h™dÀ
, 
öode
, 
µ©h
, 
m≠
, 
•lô_Êag
, 
Êags
);

3832 
	}
}

3834 
	$pxt4_c⁄vît_unwrôãn_exã¡s_ídio
(
h™dÀ_t
 *
h™dÀ
,

3835 
öode
 *inode,

3836 
pxt4_m≠_blocks
 *
m≠
,

3837 
pxt4_ext_∑th
 **
µ©h
)

3839 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3840 
pxt4_exã¡
 *
ex
;

3841 
pxt4_lblk_t
 
ì_block
;

3842 
ì_Àn
;

3843 
dïth
;

3844 
îr
 = 0;

3846 
dïth
 = 
	`ext_dïth
(
öode
);

3847 
ex
 = 
∑th
[
dïth
].
p_ext
;

3848 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3849 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3851 
	`ext_debug
("pxt4_convert_unwritten_extents_endio: inode %lu,Üogical"

3852 "block %Œu, max_block†%u\n", 
öode
->
i_öo
,

3853 ()
ì_block
, 
ì_Àn
);

3861 i‡(
ì_block
 !
m≠
->
m_lblk
 || 
ì_Àn
 > m≠->
m_Àn
) {

3862 #ifde‡
CONFIG_PXT4_DEBUG


3863 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Inode (%ld) finished:ÉxtentÜogical block %llu,"

3865 
öode
->
i_öo
, ()
ì_block
, 
ì_Àn
,

3866 ()
m≠
->
m_lblk
, m≠->
m_Àn
);

3868 
îr
 = 
	`pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
,

3869 
PXT4_GET_BLOCKS_CONVERT
);

3870 i‡(
îr
 < 0)

3871  
îr
;

3872 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
µ©h
, 0);

3873 i‡(
	`IS_ERR
(
∑th
))

3874  
	`PTR_ERR
(
∑th
);

3875 
dïth
 = 
	`ext_dïth
(
öode
);

3876 
ex
 = 
∑th
[
dïth
].
p_ext
;

3879 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3880 i‡(
îr
)

3881 
out
;

3883 
	`pxt4_ext_m¨k_öôülized
(
ex
);

3888 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

3891 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3892 
out
:

3893 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3894  
îr
;

3895 
	}
}

3900 
	$check_eofblocks_Ê
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3901 
pxt4_lblk_t
 
lblk
,

3902 
pxt4_ext_∑th
 *
∑th
,

3903 
Àn
)

3905 
i
, 
dïth
;

3906 
pxt4_exã¡_hódî
 *
eh
;

3907 
pxt4_exã¡
 *
œ°_ex
;

3909 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
))

3912 
dïth
 = 
	`ext_dïth
(
öode
);

3913 
eh
 = 
∑th
[
dïth
].
p_hdr
;

3920 i‡(
	`u∆ikñy
(!
eh
->
eh_íåõs
))

3921 
out
;

3922 
œ°_ex
 = 
	`EXT_LAST_EXTENT
(
eh
);

3932 i‡(
lblk
 + 
Àn
 < 
	`À32_to_˝u
(
œ°_ex
->
ì_block
) +

3933 
	`pxt4_ext_gë_a˘uÆ_Àn
(
œ°_ex
))

3942 
i
 = 
dïth
-1; i >= 0; i--)

3943 i‡(
∑th
[
i
].
p_idx
 !
	`EXT_LAST_INDEX
’©h[i].
p_hdr
))

3945 
out
:

3946 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
);

3947  
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3948 
	}
}

3951 
	$c⁄vît_öôülized_exã¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3952 
pxt4_m≠_blocks
 *
m≠
,

3953 
pxt4_ext_∑th
 **
µ©h
,

3954 
Æloˇãd
)

3956 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3957 
pxt4_exã¡
 *
ex
;

3958 
pxt4_lblk_t
 
ì_block
;

3959 
ì_Àn
;

3960 
dïth
;

3961 
îr
 = 0;

3967 i‡(
m≠
->
m_Àn
 > 
EXT_UNWRITTEN_MAX_LEN
)

3968 
m≠
->
m_Àn
 = 
EXT_UNWRITTEN_MAX_LEN
 / 2;

3970 
dïth
 = 
	`ext_dïth
(
öode
);

3971 
ex
 = 
∑th
[
dïth
].
p_ext
;

3972 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3973 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3975 
	`ext_debug
("%s: inode %lu,Üogical"

3976 "block %Œu, max_block†%u\n", 
__func__
, 
öode
->
i_öo
,

3977 ()
ì_block
, 
ì_Àn
);

3979 i‡(
ì_block
 !
m≠
->
m_lblk
 || 
ì_Àn
 > m≠->
m_Àn
) {

3980 
îr
 = 
	`pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
,

3981 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
);

3982 i‡(
îr
 < 0)

3983  
îr
;

3984 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
µ©h
, 0);

3985 i‡(
	`IS_ERR
(
∑th
))

3986  
	`PTR_ERR
(
∑th
);

3987 
dïth
 = 
	`ext_dïth
(
öode
);

3988 
ex
 = 
∑th
[
dïth
].
p_ext
;

3989 i‡(!
ex
) {

3990 
	`PXT4_ERROR_INODE
(
öode
, "unexpected holeát %lu",

3991 (Ë
m≠
->
m_lblk
);

3992  -
EFSCORRUPTED
;

3996 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3997 i‡(
îr
)

3998  
îr
;

4000 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

4005 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

4008 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

4009 i‡(
îr
)

4010  
îr
;

4011 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4013 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4014 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
, 
∑th
, m≠->
m_Àn
);

4015 i‡(
îr
)

4016  
îr
;

4017 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4018 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4019 
Æloˇãd
 = 
m≠
->
m_Àn
;

4020 
m≠
->
m_Àn
 = 
Æloˇãd
;

4021  
Æloˇãd
;

4022 
	}
}

4025 
	$pxt4_ext_h™dÀ_unwrôãn_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4026 
pxt4_m≠_blocks
 *
m≠
,

4027 
pxt4_ext_∑th
 **
µ©h
, 
Êags
,

4028 
Æloˇãd
, 
pxt4_fsblk_t
 
√wblock
)

4030 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

4031 
ªt
 = 0;

4032 
îr
 = 0;

4034 
	`ext_debug
("pxt4_ext_handle_unwritten_extents: inode %lu,Üogical "

4036 
öode
->
i_öo
, ()
m≠
->
m_lblk
, m≠->
m_Àn
,

4037 
Êags
, 
Æloˇãd
);

4038 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4044 
Êags
 |
PXT4_GET_BLOCKS_METADATA_NOFAIL
;

4046 
	`åa˚_pxt4_ext_h™dÀ_unwrôãn_exã¡s
(
öode
, 
m≠
, 
Êags
,

4047 
Æloˇãd
, 
√wblock
);

4050 i‡(
Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
) {

4051 
ªt
 = 
	`pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
,

4052 
Êags
 | 
PXT4_GET_BLOCKS_CONVERT
);

4053 i‡(
ªt
 <= 0)

4054 
out
;

4055 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4056 
out
;

4059 i‡(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT
) {

4060 i‡(
Êags
 & 
PXT4_GET_BLOCKS_ZERO
) {

4061 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4062 
Æloˇãd
 = 
m≠
->
m_Àn
;

4063 
îr
 = 
	`pxt4_issue_zîoout
(
öode
, 
m≠
->
m_lblk
, 
√wblock
,

4064 
Æloˇãd
);

4065 i‡(
îr
 < 0)

4066 
out2
;

4068 
ªt
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s_ídio
(
h™dÀ
, 
öode
, 
m≠
,

4069 
µ©h
);

4070 i‡(
ªt
 >= 0) {

4071 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4072 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
,

4073 
∑th
, 
m≠
->
m_Àn
);

4075 
îr
 = 
ªt
;

4076 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

4077 
m≠
->
m_pblk
 = 
√wblock
;

4078 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4079 
Æloˇãd
 = 
m≠
->
m_Àn
;

4080 
m≠
->
m_Àn
 = 
Æloˇãd
;

4081 
out2
;

4088 i‡(
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
) {

4089 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4090 
m≠_out
;

4094 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0) {

4102 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4103 
out1
;

4107 
ªt
 = 
	`pxt4_ext_c⁄vît_to_öôülized
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
, 
Êags
);

4108 i‡(
ªt
 >= 0)

4109 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4110 
out
:

4111 i‡(
ªt
 <= 0) {

4112 
îr
 = 
ªt
;

4113 
out2
;

4115 
Æloˇãd
 = 
ªt
;

4116 
m≠
->
m_Êags
 |
PXT4_MAP_NEW
;

4117 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4118 
Æloˇãd
 = 
m≠
->
m_Àn
;

4119 
m≠
->
m_Àn
 = 
Æloˇãd
;

4121 
m≠_out
:

4122 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

4123 i‡((
Êags
 & 
PXT4_GET_BLOCKS_KEEP_SIZE
) == 0) {

4124 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
, 
∑th
,

4125 
m≠
->
m_Àn
);

4126 i‡(
îr
 < 0)

4127 
out2
;

4129 
out1
:

4130 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4131 
Æloˇãd
 = 
m≠
->
m_Àn
;

4132 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4133 
m≠
->
m_pblk
 = 
√wblock
;

4134 
m≠
->
m_Àn
 = 
Æloˇãd
;

4135 
out2
:

4136  
îr
 ?Éº : 
Æloˇãd
;

4137 
	}
}

4180 
	$gë_im∂õd_˛u°î_Æloc
(
su≥r_block
 *
sb
,

4181 
pxt4_m≠_blocks
 *
m≠
,

4182 
pxt4_exã¡
 *
ex
,

4183 
pxt4_ext_∑th
 *
∑th
)

4185 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4186 
pxt4_lblk_t
 
c_off£t
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
m≠
->
m_lblk
);

4187 
pxt4_lblk_t
 
ex_˛u°î_°¨t
, 
ex_˛u°î_íd
;

4188 
pxt4_lblk_t
 
º_˛u°î_°¨t
;

4189 
pxt4_lblk_t
 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

4190 
pxt4_fsblk_t
 
ì_°¨t
 = 
	`pxt4_ext_pblock
(
ex
);

4191 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

4194 
ex_˛u°î_°¨t
 = 
	`PXT4_B2C
(
sbi
, 
ì_block
);

4195 
ex_˛u°î_íd
 = 
	`PXT4_B2C
(
sbi
, 
ì_block
 + 
ì_Àn
 - 1);

4198 
º_˛u°î_°¨t
 = 
	`PXT4_B2C
(
sbi
, 
m≠
->
m_lblk
);

4200 i‡((
º_˛u°î_°¨t
 =
ex_˛u°î_íd
) ||

4201 (
º_˛u°î_°¨t
 =
ex_˛u°î_°¨t
)) {

4202 i‡(
º_˛u°î_°¨t
 =
ex_˛u°î_íd
)

4203 
ì_°¨t
 +
ì_Àn
 - 1;

4204 
m≠
->
m_pblk
 = 
	`PXT4_PBLK_CMASK
(
sbi
, 
ì_°¨t
Ë+ 
c_off£t
;

4205 
m≠
->
m_Àn
 = 
	`mö
(map->m_len,

4206 (Ë
sbi
->
s_˛u°î_øtio
 - 
c_off£t
);

4216 i‡(
m≠
->
m_lblk
 < 
ì_block
)

4217 
m≠
->
m_Àn
 = 
	`mö
(m≠->m_Àn, 
ì_block
 - m≠->
m_lblk
);

4228 i‡(
m≠
->
m_lblk
 > 
ì_block
) {

4229 
pxt4_lblk_t
 
√xt
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

4230 
m≠
->
m_Àn
 = 
	`mö
(m≠->m_Àn, 
√xt
 - m≠->
m_lblk
);

4233 
	`åa˚_pxt4_gë_im∂õd_˛u°î_Æloc_exô
(
sb
, 
m≠
, 1);

4237 
	`åa˚_pxt4_gë_im∂õd_˛u°î_Æloc_exô
(
sb
, 
m≠
, 0);

4239 
	}
}

4260 
	$pxt4_ext_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4261 
pxt4_m≠_blocks
 *
m≠
, 
Êags
)

4263 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

4264 
pxt4_exã¡
 
√wex
, *
ex
, *
ex2
;

4265 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

4266 
pxt4_fsblk_t
 
√wblock
 = 0;

4267 
‰ì_⁄_îr
 = 0, 
îr
 = 0, 
dïth
, 
ªt
;

4268 
Æloˇãd
 = 0, 
off£t
 = 0;

4269 
Æloˇãd_˛u°îs
 = 0;

4270 
pxt4_Æloˇti⁄_ªque°
 
¨
;

4271 
pxt4_lblk_t
 
˛u°î_off£t
;

4272 
boﬁ
 
m≠_‰om_˛u°î
 = 
Ál£
;

4274 
	`ext_debug
("blocks %u/%uÑequested for inode %lu\n",

4275 
m≠
->
m_lblk
, m≠->
m_Àn
, 
öode
->
i_öo
);

4276 
	`åa˚_pxt4_ext_m≠_blocks_íãr
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
, 
Êags
);

4279 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
NULL
, 0);

4280 i‡(
	`IS_ERR
(
∑th
)) {

4281 
îr
 = 
	`PTR_ERR
(
∑th
);

4282 
∑th
 = 
NULL
;

4283 
out2
;

4286 
dïth
 = 
	`ext_dïth
(
öode
);

4293 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_ext
 =
NULL
 && depth != 0)) {

4294 
	`PXT4_ERROR_INODE
(
öode
, "badÉxtentáddress "

4296 (Ë
m≠
->
m_lblk
, 
dïth
,

4297 
∑th
[
dïth
].
p_block
);

4298 
îr
 = -
EFSCORRUPTED
;

4299 
out2
;

4302 
ex
 = 
∑th
[
dïth
].
p_ext
;

4303 i‡(
ex
) {

4304 
pxt4_lblk_t
 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

4305 
pxt4_fsblk_t
 
ì_°¨t
 = 
	`pxt4_ext_pblock
(
ex
);

4306 
ì_Àn
;

4313 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

4315 
	`åa˚_pxt4_ext_show_exã¡
(
öode
, 
ì_block
, 
ì_°¨t
, 
ì_Àn
);

4318 i‡(
	`ö_ønge
(
m≠
->
m_lblk
, 
ì_block
, 
ì_Àn
)) {

4319 
√wblock
 = 
m≠
->
m_lblk
 - 
ì_block
 + 
ì_°¨t
;

4321 
Æloˇãd
 = 
ì_Àn
 - (
m≠
->
m_lblk
 - 
ì_block
);

4322 
	`ext_debug
("%u fô i¡ÿ%u:%d -> %Œu\n", 
m≠
->
m_lblk
,

4323 
ì_block
, 
ì_Àn
, 
√wblock
);

4329 i‡((!
	`pxt4_ext_is_unwrôãn
(
ex
)) &&

4330 (
Êags
 & 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
)) {

4331 
Æloˇãd
 = 
	`c⁄vît_öôülized_exã¡
(

4332 
h™dÀ
, 
öode
, 
m≠
, &
∑th
,

4333 
Æloˇãd
);

4334 
out2
;

4335 } i‡(!
	`pxt4_ext_is_unwrôãn
(
ex
))

4336 
out
;

4338 
ªt
 = 
	`pxt4_ext_h™dÀ_unwrôãn_exã¡s
(

4339 
h™dÀ
, 
öode
, 
m≠
, &
∑th
, 
Êags
,

4340 
Æloˇãd
, 
√wblock
);

4341 i‡(
ªt
 < 0)

4342 
îr
 = 
ªt
;

4344 
Æloˇãd
 = 
ªt
;

4345 
out2
;

4353 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0) {

4354 
pxt4_lblk_t
 
hﬁe_°¨t
, 
hﬁe_Àn
;

4356 
hﬁe_°¨t
 = 
m≠
->
m_lblk
;

4357 
hﬁe_Àn
 = 
	`pxt4_ext_dëîmöe_hﬁe
(
öode
, 
∑th
, &
hﬁe_°¨t
);

4362 
	`pxt4_ext_put_g≠_ö_ˇche
(
öode
, 
hﬁe_°¨t
, 
hﬁe_Àn
);

4365 i‡(
hﬁe_°¨t
 !
m≠
->
m_lblk
)

4366 
hﬁe_Àn
 -
m≠
->
m_lblk
 - 
hﬁe_°¨t
;

4367 
m≠
->
m_pblk
 = 0;

4368 
m≠
->
m_Àn
 = 
	`mö_t
(, m≠->m_Àn, 
hﬁe_Àn
);

4370 
out2
;

4376 
√wex
.
ì_block
 = 
	`˝u_to_À32
(
m≠
->
m_lblk
);

4377 
˛u°î_off£t
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
m≠
->
m_lblk
);

4383 i‡(
˛u°î_off£t
 && 
ex
 &&

4384 
	`gë_im∂õd_˛u°î_Æloc
(
öode
->
i_sb
, 
m≠
, 
ex
, 
∑th
)) {

4385 
¨
.
Àn
 = 
Æloˇãd
 = 
m≠
->
m_Àn
;

4386 
√wblock
 = 
m≠
->
m_pblk
;

4387 
m≠_‰om_˛u°î
 = 
åue
;

4388 
gŸ_Æloˇãd_blocks
;

4392 
¨
.
Œe·
 = 
m≠
->
m_lblk
;

4393 
îr
 = 
	`pxt4_ext_£¨ch_À·
(
öode
, 
∑th
, &
¨
.
Œe·
, &¨.
∂e·
);

4394 i‡(
îr
)

4395 
out2
;

4396 
¨
.
Ãight
 = 
m≠
->
m_lblk
;

4397 
ex2
 = 
NULL
;

4398 
îr
 = 
	`pxt4_ext_£¨ch_right
(
öode
, 
∑th
, &
¨
.
Ãight
, &¨.
¥ight
, &
ex2
);

4399 i‡(
îr
)

4400 
out2
;

4404 i‡((
sbi
->
s_˛u°î_øtio
 > 1Ë&& 
ex2
 &&

4405 
	`gë_im∂õd_˛u°î_Æloc
(
öode
->
i_sb
, 
m≠
, 
ex2
, 
∑th
)) {

4406 
¨
.
Àn
 = 
Æloˇãd
 = 
m≠
->
m_Àn
;

4407 
√wblock
 = 
m≠
->
m_pblk
;

4408 
m≠_‰om_˛u°î
 = 
åue
;

4409 
gŸ_Æloˇãd_blocks
;

4418 i‡(
m≠
->
m_Àn
 > 
EXT_INIT_MAX_LEN
 &&

4419 !(
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
))

4420 
m≠
->
m_Àn
 = 
EXT_INIT_MAX_LEN
;

4421 i‡(
m≠
->
m_Àn
 > 
EXT_UNWRITTEN_MAX_LEN
 &&

4422 (
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
))

4423 
m≠
->
m_Àn
 = 
EXT_UNWRITTEN_MAX_LEN
;

4426 
√wex
.
ì_Àn
 = 
	`˝u_to_À16
(
m≠
->
m_Àn
);

4427 
îr
 = 
	`pxt4_ext_check_ovîœp
(
sbi
, 
öode
, &
√wex
, 
∑th
);

4428 i‡(
îr
)

4429 
Æloˇãd
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(&
√wex
);

4431 
Æloˇãd
 = 
m≠
->
m_Àn
;

4434 
¨
.
öode
 = inode;

4435 
¨
.
gﬂl
 = 
	`pxt4_ext_föd_gﬂl
(
öode
, 
∑th
, 
m≠
->
m_lblk
);

4436 
¨
.
logiˇl
 = 
m≠
->
m_lblk
;

4445 
off£t
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
m≠
->
m_lblk
);

4446 
¨
.
Àn
 = 
	`PXT4_NUM_B2C
(
sbi
, 
off£t
+
Æloˇãd
);

4447 
¨
.
gﬂl
 -
off£t
;

4448 
¨
.
logiˇl
 -
off£t
;

4449 i‡(
	`S_ISREG
(
öode
->
i_mode
))

4450 
¨
.
Êags
 = 
PXT4_MB_HINT_DATA
;

4453 
¨
.
Êags
 = 0;

4454 i‡(
Êags
 & 
PXT4_GET_BLOCKS_NO_NORMALIZE
)

4455 
¨
.
Êags
 |
PXT4_MB_HINT_NOPREALLOC
;

4456 i‡(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
)

4457 
¨
.
Êags
 |
PXT4_MB_DELALLOC_RESERVED
;

4458 i‡(
Êags
 & 
PXT4_GET_BLOCKS_METADATA_NOFAIL
)

4459 
¨
.
Êags
 |
PXT4_MB_USE_RESERVED
;

4460 
√wblock
 = 
	`pxt4_mb_√w_blocks
(
h™dÀ
, &
¨
, &
îr
);

4461 i‡(!
√wblock
)

4462 
out2
;

4463 
	`ext_debug
("allocateÇew block: goal %llu, found %llu/%u\n",

4464 
¨
.
gﬂl
, 
√wblock
, 
Æloˇãd
);

4465 
‰ì_⁄_îr
 = 1;

4466 
Æloˇãd_˛u°îs
 = 
¨
.
Àn
;

4467 
¨
.
Àn
 = 
	`PXT4_C2B
(
sbi
,ár.ÀnË- 
off£t
;

4468 i‡(
¨
.
Àn
 > 
Æloˇãd
)

4469 
¨
.
Àn
 = 
Æloˇãd
;

4471 
gŸ_Æloˇãd_blocks
:

4473 
	`pxt4_ext_°‹e_pblock
(&
√wex
, 
√wblock
 + 
off£t
);

4474 
√wex
.
ì_Àn
 = 
	`˝u_to_À16
(
¨
.
Àn
);

4476 i‡(
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
){

4477 
	`pxt4_ext_m¨k_unwrôãn
(&
√wex
);

4478 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4481 
îr
 = 0;

4482 i‡((
Êags
 & 
PXT4_GET_BLOCKS_KEEP_SIZE
) == 0)

4483 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
,

4484 
∑th
, 
¨
.
Àn
);

4485 i‡(!
îr
)

4486 
îr
 = 
	`pxt4_ext_ö£π_exã¡
(
h™dÀ
, 
öode
, &
∑th
,

4487 &
√wex
, 
Êags
);

4489 i‡(
îr
 && 
‰ì_⁄_îr
) {

4490 
fb_Êags
 = 
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
 ?

4491 
PXT4_FREE_BLOCKS_NO_QUOT_UPDATE
 : 0;

4495 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4496 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
√wblock
,

4497 
	`PXT4_C2B
(
sbi
, 
Æloˇãd_˛u°îs
), 
fb_Êags
);

4498 
out2
;

4502 
√wblock
 = 
	`pxt4_ext_pblock
(&
√wex
);

4503 
Æloˇãd
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(&
√wex
);

4504 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4505 
Æloˇãd
 = 
m≠
->
m_Àn
;

4506 
m≠
->
m_Êags
 |
PXT4_MAP_NEW
;

4514 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
Ë&& !
m≠_‰om_˛u°î
) {

4515 i‡(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
) {

4520 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
, 
Æloˇãd_˛u°îs
,

4523 
pxt4_lblk_t
 
lblk
, 
Àn
;

4524 
n
;

4537 
lblk
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
m≠
->
m_lblk
);

4538 
Àn
 = 
Æloˇãd_˛u°îs
 << 
sbi
->
s_˛u°î_bôs
;

4539 
n
 = 
	`pxt4_es_dñayed_˛u
(
öode
, 
lblk
, 
Àn
);

4540 i‡(
n
 > 0)

4541 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
, (Ë
n
, 0);

4549 i‡((
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
) == 0)

4550 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4552 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 0);

4553 
out
:

4554 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4555 
Æloˇãd
 = 
m≠
->
m_Àn
;

4556 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4557 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

4558 
m≠
->
m_pblk
 = 
√wblock
;

4559 
m≠
->
m_Àn
 = 
Æloˇãd
;

4560 
out2
:

4561 
	`pxt4_ext_dr›_ªfs
(
∑th
);

4562 
	`k‰ì
(
∑th
);

4564 
	`åa˚_pxt4_ext_m≠_blocks_exô
(
öode
, 
Êags
, 
m≠
,

4565 
îr
 ?Éº : 
Æloˇãd
);

4566  
îr
 ?Éº : 
Æloˇãd
;

4567 
	}
}

4569 
	$pxt4_ext_åunˇã
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

4571 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4572 
pxt4_lblk_t
 
œ°_block
;

4573 
îr
 = 0;

4582 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

4583 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4584 i‡(
îr
)

4585  
îr
;

4587 
œ°_block
 = (
öode
->
i_size
 + 
sb
->
s_blocksize
 - 1)

4588 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

4589 
ªåy
:

4590 
îr
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
œ°_block
,

4591 
EXT_MAX_BLOCKS
 - 
œ°_block
);

4592 i‡(
îr
 =-
ENOMEM
) {

4593 
	`c⁄d_ªsched
();

4594 
	`c⁄ge°i⁄_waô
(
BLK_RW_ASYNC
, 
HZ
/50);

4595 
ªåy
;

4597 i‡(
îr
)

4598  
îr
;

4599  
	`pxt4_ext_ªmove_•a˚
(
öode
, 
œ°_block
, 
EXT_MAX_BLOCKS
 - 1);

4600 
	}
}

4602 
	$pxt4_Æloc_fûe_blocks
(
fûe
 *fûe, 
pxt4_lblk_t
 
off£t
,

4603 
pxt4_lblk_t
 
Àn
, 
loff_t
 
√w_size
,

4604 
Êags
)

4606 
öode
 *öodê
	`fûe_öode
(
fûe
);

4607 
h™dÀ_t
 *
h™dÀ
;

4608 
ªt
 = 0;

4609 
ªt2
 = 0;

4610 
ªåõs
 = 0;

4611 
dïth
 = 0;

4612 
pxt4_m≠_blocks
 
m≠
;

4613 
¸edôs
;

4614 
loff_t
 
ïos
;

4616 
	`BUG_ON
(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
));

4617 
m≠
.
m_lblk
 = 
off£t
;

4618 
m≠
.
m_Àn
 = 
Àn
;

4624 i‡(
Àn
 <
EXT_UNWRITTEN_MAX_LEN
)

4625 
Êags
 |
PXT4_GET_BLOCKS_NO_NORMALIZE
;

4630 
¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
Àn
);

4631 
dïth
 = 
	`ext_dïth
(
öode
);

4633 
ªåy
:

4634 
ªt
 >0 && 
Àn
) {

4638 i‡(
dïth
 !
	`ext_dïth
(
öode
)) {

4639 
¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
Àn
);

4640 
dïth
 = 
	`ext_dïth
(
öode
);

4643 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
,

4644 
¸edôs
);

4645 i‡(
	`IS_ERR
(
h™dÀ
)) {

4646 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4649 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
, 
Êags
);

4650 i‡(
ªt
 <= 0) {

4651 
	`pxt4_debug
("inode #%lu: block %u:Üen %u: "

4653 
öode
->
i_öo
, 
m≠
.
m_lblk
,

4654 
m≠
.
m_Àn
, 
ªt
);

4655 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4656 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4659 
m≠
.
m_lblk
 +
ªt
;

4660 
m≠
.
m_Àn
 = 
Àn
 =Üí - 
ªt
;

4661 
ïos
 = (
loff_t
)
m≠
.
m_lblk
 << 
öode
->
i_blkbôs
;

4662 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

4663 i‡(
√w_size
) {

4664 i‡(
ïos
 > 
√w_size
)

4665 
ïos
 = 
√w_size
;

4666 i‡(
	`pxt4_upd©e_öode_size
(
öode
, 
ïos
) & 0x1)

4667 
öode
->
i_mtime
 = inode->
i_˘ime
;

4669 i‡(
ïos
 > 
öode
->
i_size
)

4670 
	`pxt4_£t_öode_Êag
(
öode
,

4671 
PXT4_INODE_EOFBLOCKS
);

4673 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4674 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4675 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4676 i‡(
ªt2
)

4679 i‡(
ªt
 =-
ENOSPC
 &&

4680 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
)) {

4681 
ªt
 = 0;

4682 
ªåy
;

4685  
ªt
 > 0 ? 
ªt2
 :Ñet;

4686 
	}
}

4688 
	$pxt4_zîo_ønge
(
fûe
 *fûe, 
loff_t
 
off£t
,

4689 
loff_t
 
Àn
, 
mode
)

4691 
öode
 *öodê
	`fûe_öode
(
fûe
);

4692 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

4693 
max_blocks
;

4694 
loff_t
 
√w_size
 = 0;

4695 
ªt
 = 0;

4696 
Êags
;

4697 
¸edôs
;

4698 
∑πül_begö
, 
∑πül_íd
;

4699 
loff_t
 
°¨t
, 
íd
;

4700 
pxt4_lblk_t
 
lblk
;

4701 
blkbôs
 = 
öode
->
i_blkbôs
;

4703 
	`åa˚_pxt4_zîo_ønge
(
öode
, 
off£t
, 
Àn
, 
mode
);

4705 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

4706  -
EINVAL
;

4709 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

4710 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

4711 i‡(
ªt
)

4712  
ªt
;

4721 
°¨t
 = 
	`round_up
(
off£t
, 1 << 
blkbôs
);

4722 
íd
 = 
	`round_down
((
off£t
 + 
Àn
), 1 << 
blkbôs
);

4724 i‡(
°¨t
 < 
off£t
 || 
íd
 > off£à+ 
Àn
)

4725  -
EINVAL
;

4726 
∑πül_begö
 = 
off£t
 & ((1 << 
blkbôs
) - 1);

4727 
∑πül_íd
 = (
off£t
 + 
Àn
Ë& ((1 << 
blkbôs
) - 1);

4729 
lblk
 = 
°¨t
 >> 
blkbôs
;

4730 
max_blocks
 = (
íd
 >> 
blkbôs
);

4731 i‡(
max_blocks
 < 
lblk
)

4732 
max_blocks
 = 0;

4734 
max_blocks
 -
lblk
;

4736 
	`öode_lock
(
öode
);

4741 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

4742 
ªt
 = -
EOPNOTSUPP
;

4743 
out_muãx
;

4746 i‡(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

4747 (
off£t
 + 
Àn
 > 
	`i_size_ªad
(
öode
) ||

4748 
off£t
 + 
Àn
 > 
	`PXT4_I
(
öode
)->
i_disksize
)) {

4749 
√w_size
 = 
off£t
 + 
Àn
;

4750 
ªt
 = 
	`öode_√wsize_ok
(
öode
, 
√w_size
);

4751 i‡(
ªt
)

4752 
out_muãx
;

4755 
Êags
 = 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
;

4756 i‡(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

4757 
Êags
 |
PXT4_GET_BLOCKS_KEEP_SIZE
;

4760 
	`öode_dio_waô
(
öode
);

4763 i‡(
∑πül_begö
 || 
∑πül_íd
) {

4764 
ªt
 = 
	`pxt4_Æloc_fûe_blocks
(
fûe
,

4765 
	`round_down
(
off£t
, 1 << 
blkbôs
) >> blkbits,

4766 (
	`round_up
((
off£t
 + 
Àn
), 1 << 
blkbôs
) -

4767 
	`round_down
(
off£t
, 1 << 
blkbôs
)) >> blkbits,

4768 
√w_size
, 
Êags
);

4769 i‡(
ªt
)

4770 
out_muãx
;

4775 i‡(
max_blocks
 > 0) {

4776 
Êags
 |(
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
 |

4777 
PXT4_EX_NOCACHE
);

4783 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4785 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

4786 i‡(
ªt
) {

4787 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4788 
out_muãx
;

4791 
ªt
 = 
	`pxt4_upd©e_disksize_bef‹e_punch
(
öode
, 
off£t
, 
Àn
);

4792 i‡(
ªt
) {

4793 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4794 
out_muãx
;

4797 
	`åunˇã_∑geˇche_ønge
(
öode
, 
°¨t
, 
íd
 - 1);

4798 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4800 
ªt
 = 
	`pxt4_Æloc_fûe_blocks
(
fûe
, 
lblk
, 
max_blocks
, 
√w_size
,

4801 
Êags
);

4802 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4803 i‡(
ªt
)

4804 
out_muãx
;

4806 i‡(!
∑πül_begö
 && !
∑πül_íd
)

4807 
out_muãx
;

4813 
¸edôs
 = (2 * 
	`pxt4_ext_ödex_å™s_blocks
(
öode
, 2)) + 1;

4814 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

4815 
¸edôs
 += 2;

4816 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MISC
, 
¸edôs
);

4817 i‡(
	`IS_ERR
(
h™dÀ
)) {

4818 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4819 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

4820 
out_muãx
;

4823 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4824 i‡(
√w_size
) {

4825 
	`pxt4_upd©e_öode_size
(
öode
, 
√w_size
);

4831 i‡((
off£t
 + 
Àn
Ë> 
	`i_size_ªad
(
öode
))

4832 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
);

4834 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4837 
ªt
 = 
	`pxt4_zîo_∑πül_blocks
(
h™dÀ
, 
öode
, 
off£t
, 
Àn
);

4838 i‡(
ªt
 >= 0)

4839 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4841 i‡(
fûe
->
f_Êags
 & 
O_SYNC
)

4842 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

4844 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4845 
out_muãx
:

4846 
	`öode_u∆ock
(
öode
);

4847  
ªt
;

4848 
	}
}

4857 
	$pxt4_ÁŒoˇã
(
fûe
 *fûe, 
mode
, 
loff_t
 
off£t
,Üoff_à
Àn
)

4859 
öode
 *öodê
	`fûe_öode
(
fûe
);

4860 
loff_t
 
√w_size
 = 0;

4861 
max_blocks
;

4862 
ªt
 = 0;

4863 
Êags
;

4864 
pxt4_lblk_t
 
lblk
;

4865 
blkbôs
 = 
öode
->
i_blkbôs
;

4877 i‡(
	`IS_ENCRYPTED
(
öode
) &&

4878 (
mode
 & (
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_INSERT_RANGE
 |

4879 
FALLOC_FL_ZERO_RANGE
)))

4880  -
EOPNOTSUPP
;

4883 i‡(
mode
 & ~(
FALLOC_FL_KEEP_SIZE
 | 
FALLOC_FL_PUNCH_HOLE
 |

4884 
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_ZERO_RANGE
 |

4885 
FALLOC_FL_INSERT_RANGE
))

4886  -
EOPNOTSUPP
;

4888 i‡(
mode
 & 
FALLOC_FL_PUNCH_HOLE
)

4889  
	`pxt4_punch_hﬁe
(
öode
, 
off£t
, 
Àn
);

4891 
ªt
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

4892 i‡(
ªt
)

4893  
ªt
;

4895 i‡(
mode
 & 
FALLOC_FL_COLLAPSE_RANGE
)

4896  
	`pxt4_cﬁœp£_ønge
(
öode
, 
off£t
, 
Àn
);

4898 i‡(
mode
 & 
FALLOC_FL_INSERT_RANGE
)

4899  
	`pxt4_ö£π_ønge
(
öode
, 
off£t
, 
Àn
);

4901 i‡(
mode
 & 
FALLOC_FL_ZERO_RANGE
)

4902  
	`pxt4_zîo_ønge
(
fûe
, 
off£t
, 
Àn
, 
mode
);

4904 
	`åa˚_pxt4_ÁŒoˇã_íãr
(
öode
, 
off£t
, 
Àn
, 
mode
);

4905 
lblk
 = 
off£t
 >> 
blkbôs
;

4907 
max_blocks
 = 
	`PXT4_MAX_BLOCKS
(
Àn
, 
off£t
, 
blkbôs
);

4908 
Êags
 = 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
;

4909 i‡(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

4910 
Êags
 |
PXT4_GET_BLOCKS_KEEP_SIZE
;

4912 
	`öode_lock
(
öode
);

4917 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

4918 
ªt
 = -
EOPNOTSUPP
;

4919 
out
;

4922 i‡(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

4923 (
off£t
 + 
Àn
 > 
	`i_size_ªad
(
öode
) ||

4924 
off£t
 + 
Àn
 > 
	`PXT4_I
(
öode
)->
i_disksize
)) {

4925 
√w_size
 = 
off£t
 + 
Àn
;

4926 
ªt
 = 
	`öode_√wsize_ok
(
öode
, 
√w_size
);

4927 i‡(
ªt
)

4928 
out
;

4932 
	`öode_dio_waô
(
öode
);

4934 
ªt
 = 
	`pxt4_Æloc_fûe_blocks
(
fûe
, 
lblk
, 
max_blocks
, 
√w_size
, 
Êags
);

4935 i‡(
ªt
)

4936 
out
;

4938 i‡(
fûe
->
f_Êags
 & 
O_SYNC
 && 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
) {

4939 
ªt
 = 
	`jbd3_com∂ëe_å™ß˘i⁄
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
,

4940 
	`PXT4_I
(
öode
)->
i_sync_tid
);

4942 
out
:

4943 
	`öode_u∆ock
(
öode
);

4944 
	`åa˚_pxt4_ÁŒoˇã_exô
(
öode
, 
off£t
, 
max_blocks
, 
ªt
);

4945  
ªt
;

4946 
	}
}

4958 
	$pxt4_c⁄vît_unwrôãn_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4959 
loff_t
 
off£t
, 
ssize_t
 
Àn
)

4961 
max_blocks
;

4962 
ªt
 = 0;

4963 
ªt2
 = 0;

4964 
pxt4_m≠_blocks
 
m≠
;

4965 
¸edôs
, 
blkbôs
 = 
öode
->
i_blkbôs
;

4967 
m≠
.
m_lblk
 = 
off£t
 >> 
blkbôs
;

4968 
max_blocks
 = 
	`PXT4_MAX_BLOCKS
(
Àn
, 
off£t
, 
blkbôs
);

4975 i‡(
h™dÀ
) {

4976 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_ª£rved
(handle,

4977 
PXT4_HT_EXT_CONVERT
);

4978 i‡(
	`IS_ERR
(
h™dÀ
))

4979  
	`PTR_ERR
(
h™dÀ
);

4980 
¸edôs
 = 0;

4985 
¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
max_blocks
);

4987 
ªt
 >0 &&Ñë < 
max_blocks
) {

4988 
m≠
.
m_lblk
 +
ªt
;

4989 
m≠
.
m_Àn
 = (
max_blocks
 -
ªt
);

4990 i‡(
¸edôs
) {

4991 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
,

4992 
¸edôs
);

4993 i‡(
	`IS_ERR
(
h™dÀ
)) {

4994 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4998 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
,

4999 
PXT4_GET_BLOCKS_IO_CONVERT_EXT
);

5000 i‡(
ªt
 <= 0)

5001 
	`pxt4_w¨nög
(
öode
->
i_sb
,

5004 
öode
->
i_öo
, 
m≠
.
m_lblk
,

5005 
m≠
.
m_Àn
, 
ªt
);

5006 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5007 i‡(
¸edôs
)

5008 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5009 i‡(
ªt
 <0 || 
ªt2
)

5012 i‡(!
¸edôs
)

5013 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5014  
ªt
 > 0 ? 
ªt2
 :Ñet;

5015 
	}
}

5026 
	$pxt4_föd_dñayed_exã¡
(
öode
 *inode,

5027 
exã¡_°©us
 *
√wes
)

5029 
exã¡_°©us
 
es
;

5030 
pxt4_lblk_t
 
block
, 
√xt_dñ
;

5032 i‡(
√wes
->
es_pblk
 == 0) {

5033 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
,

5034 
√wes
->
es_lblk
,

5035 
√wes
->
es_lblk
 +Çewes->
es_Àn
 - 1,

5036 &
es
);

5042 i‡(
es
.
es_Àn
 == 0)

5046 i‡(
es
.
es_lblk
 > 
√wes
->es_lblk) {

5048 
√wes
->
es_Àn
 = 
	`mö
(
es
.
es_lblk
 -Çewes->es_lblk,

5049 
√wes
->
es_Àn
);

5053 
√wes
->
es_Àn
 = 
es
.
es_lblk
 +És.es_len -Çewes->es_lblk;

5056 
block
 = 
√wes
->
es_lblk
 +Çewes->
es_Àn
;

5057 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
block
,

5058 
EXT_MAX_BLOCKS
, &
es
);

5059 i‡(
es
.
es_Àn
 == 0)

5060 
√xt_dñ
 = 
EXT_MAX_BLOCKS
;

5062 
√xt_dñ
 = 
es
.
es_lblk
;

5064  
√xt_dñ
;

5065 
	}
}

5067 
	$pxt4_x©å_fõm≠
(
öode
 *inode,

5068 
fõm≠_exã¡_öfo
 *
fõöfo
)

5070 
__u64
 
physiˇl
 = 0;

5071 
__u64
 
Àngth
;

5072 
__u32
 
Êags
 = 
FIEMAP_EXTENT_LAST
;

5073 
blockbôs
 = 
öode
->
i_sb
->
s_blocksize_bôs
;

5074 
îr‹
 = 0;

5077 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

5078 
pxt4_ûoc
 
ûoc
;

5079 
off£t
;

5081 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

5082 i‡(
îr‹
)

5083  
îr‹
;

5084 
physiˇl
 = (
__u64
)
ûoc
.
bh
->
b_blockƒ
 << 
blockbôs
;

5085 
off£t
 = 
PXT4_GOOD_OLD_INODE_SIZE
 +

5086 
	`PXT4_I
(
öode
)->
i_exåa_isize
;

5087 
physiˇl
 +
off£t
;

5088 
Àngth
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
 - 
off£t
;

5089 
Êags
 |
FIEMAP_EXTENT_DATA_INLINE
;

5090 
	`bªl£
(
ûoc
.
bh
);

5092 
physiˇl
 = (
__u64
)
	`PXT4_I
(
öode
)->
i_fûe_a˛
 << 
blockbôs
;

5093 
Àngth
 = 
öode
->
i_sb
->
s_blocksize
;

5096 i‡(
physiˇl
)

5097 
îr‹
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
, 0, 
physiˇl
,

5098 
Àngth
, 
Êags
);

5099  (
îr‹
 < 0 ?Érror : 0);

5100 
	}
}

5102 
	$_pxt4_fõm≠
(
öode
 *inode,

5103 
fõm≠_exã¡_öfo
 *
fõöfo
,

5104 
__u64
 
°¨t
, __u64 
Àn
,

5105 (*
fûl
)(
öode
 *, 
pxt4_lblk_t
,

5106 
pxt4_lblk_t
,

5107 
fõm≠_exã¡_öfo
 *))

5109 
pxt4_lblk_t
 
°¨t_blk
;

5110 
u32
 
pxt4_fõm≠_Êags
 = 
FIEMAP_FLAG_SYNC
|
FIEMAP_FLAG_XATTR
;

5112 
îr‹
 = 0;

5114 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

5115 
has_ölöe
 = 1;

5117 
îr‹
 = 
	`pxt4_ölöe_d©a_fõm≠
(
öode
, 
fõöfo
, &
has_ölöe
,

5118 
°¨t
, 
Àn
);

5120 i‡(
has_ölöe
)

5121  
îr‹
;

5124 i‡(
fõöfo
->
fi_Êags
 & 
FIEMAP_FLAG_CACHE
) {

5125 
îr‹
 = 
	`pxt4_ext_¥eˇche
(
öode
);

5126 i‡(
îr‹
)

5127  
îr‹
;

5128 
fõöfo
->
fi_Êags
 &~
FIEMAP_FLAG_CACHE
;

5132 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) &&

5133 
fûl
 =
pxt4_fûl_fõm≠_exã¡s
)

5134  
	`gíîic_block_fõm≠
(
öode
, 
fõöfo
, 
°¨t
, 
Àn
,

5135 
pxt4_gë_block
);

5137 i‡(
fûl
 =
pxt4_fûl_es_ˇche_öfo
)

5138 
pxt4_fõm≠_Êags
 &
FIEMAP_FLAG_XATTR
;

5139 i‡(
	`fõm≠_check_Êags
(
fõöfo
, 
pxt4_fõm≠_Êags
))

5140  -
EBADR
;

5142 i‡(
fõöfo
->
fi_Êags
 & 
FIEMAP_FLAG_XATTR
) {

5143 
îr‹
 = 
	`pxt4_x©å_fõm≠
(
öode
, 
fõöfo
);

5145 
pxt4_lblk_t
 
Àn_blks
;

5146 
__u64
 
œ°_blk
;

5148 
°¨t_blk
 = 
°¨t
 >> 
öode
->
i_sb
->
s_blocksize_bôs
;

5149 
œ°_blk
 = (
°¨t
 + 
Àn
 - 1Ë>> 
öode
->
i_sb
->
s_blocksize_bôs
;

5150 i‡(
œ°_blk
 >
EXT_MAX_BLOCKS
)

5151 
œ°_blk
 = 
EXT_MAX_BLOCKS
-1;

5152 
Àn_blks
 = ((
pxt4_lblk_t
Ë
œ°_blk
Ë- 
°¨t_blk
 + 1;

5158 
îr‹
 = 
	`fûl
(
öode
, 
°¨t_blk
, 
Àn_blks
, 
fõöfo
);

5160  
îr‹
;

5161 
	}
}

5163 
	$pxt4_fõm≠
(
öode
 *öode, 
fõm≠_exã¡_öfo
 *
fõöfo
,

5164 
__u64
 
°¨t
, __u64 
Àn
)

5166  
	`_pxt4_fõm≠
(
öode
, 
fõöfo
, 
°¨t
, 
Àn
,

5167 
pxt4_fûl_fõm≠_exã¡s
);

5168 
	}
}

5170 
	$pxt4_gë_es_ˇche
(
öode
 *öode, 
fõm≠_exã¡_öfo
 *
fõöfo
,

5171 
__u64
 
°¨t
, __u64 
Àn
)

5173 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

5174 
has_ölöe
;

5176 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5177 
has_ölöe
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

5178 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5179 i‡(
has_ölöe
)

5183  
	`_pxt4_fõm≠
(
öode
, 
fõöfo
, 
°¨t
, 
Àn
,

5184 
pxt4_fûl_es_ˇche_öfo
);

5185 
	}
}

5195 
	$pxt4_ac˚ss_∑th
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

5196 
pxt4_ext_∑th
 *
∑th
)

5198 
¸edôs
, 
îr
;

5200 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

5209 i‡(
h™dÀ
->
h_buf„r_¸edôs
 < 7) {

5210 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

5211 
îr
 = 
	`pxt4_ext_åunˇã_exãnd_ª°¨t
(
h™dÀ
, 
öode
, 
¸edôs
);

5213 i‡(
îr
 &&Éº !-
EAGAIN
)

5214  
îr
;

5217 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

5218  
îr
;

5219 
	}
}

5228 
	$pxt4_ext_shi·_∑th_exã¡s
(
pxt4_ext_∑th
 *
∑th
, 
pxt4_lblk_t
 
shi·
,

5229 
öode
 *öode, 
h™dÀ_t
 *
h™dÀ
,

5230 
SHIFT_DIRECTION
 
SHIFT
)

5232 
dïth
, 
îr
 = 0;

5233 
pxt4_exã¡
 *
ex_°¨t
, *
ex_œ°
;

5234 
boﬁ
 
upd©e
 = 0;

5235 
dïth
 = 
∑th
->
p_dïth
;

5237 
dïth
 >= 0) {

5238 i‡(
dïth
 =
∑th
->
p_dïth
) {

5239 
ex_°¨t
 = 
∑th
[
dïth
].
p_ext
;

5240 i‡(!
ex_°¨t
)

5241  -
EFSCORRUPTED
;

5243 
ex_œ°
 = 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
);

5245 
îr
 = 
	`pxt4_ac˚ss_∑th
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5246 i‡(
îr
)

5247 
out
;

5249 i‡(
ex_°¨t
 =
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
))

5250 
upd©e
 = 1;

5252 
ex_°¨t
 <
ex_œ°
) {

5253 i‡(
SHIFT
 =
SHIFT_LEFT
) {

5254 
	`À32_add_˝u
(&
ex_°¨t
->
ì_block
,

5255 -
shi·
);

5257 i‡((
ex_°¨t
 >

5258 
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
))

5260 
	`pxt4_ext_åy_to_mîge_right
(
öode
,

5261 
∑th
, 
ex_°¨t
 - 1))

5262 
ex_œ°
--;

5264 
ex_°¨t
++;

5266 
	`À32_add_˝u
(&
ex_œ°
->
ì_block
, 
shi·
);

5267 
	`pxt4_ext_åy_to_mîge_right
(
öode
, 
∑th
,

5268 
ex_œ°
);

5269 
ex_œ°
--;

5272 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5273 i‡(
îr
)

5274 
out
;

5276 i‡(--
dïth
 < 0 || !
upd©e
)

5281 
îr
 = 
	`pxt4_ac˚ss_∑th
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5282 i‡(
îr
)

5283 
out
;

5285 i‡(
SHIFT
 =
SHIFT_LEFT
)

5286 
	`À32_add_˝u
(&
∑th
[
dïth
].
p_idx
->
ei_block
, -
shi·
);

5288 
	`À32_add_˝u
(&
∑th
[
dïth
].
p_idx
->
ei_block
, 
shi·
);

5289 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5290 i‡(
îr
)

5291 
out
;

5294 i‡(
∑th
[
dïth
].
p_idx
 !
	`EXT_FIRST_INDEX
’©h[dïth].
p_hdr
))

5297 
dïth
--;

5300 
out
:

5301  
îr
;

5302 
	}
}

5312 
	$pxt4_ext_shi·_exã¡s
(
öode
 *öode, 
h™dÀ_t
 *
h™dÀ
,

5313 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
shi·
,

5314 
SHIFT_DIRECTION
 
SHIFT
)

5316 
pxt4_ext_∑th
 *
∑th
;

5317 
ªt
 = 0, 
dïth
;

5318 
pxt4_exã¡
 *
exã¡
;

5319 
pxt4_lblk_t
 
°›
, *
ôî©‹
, 
ex_°¨t
, 
ex_íd
;

5322 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
EXT_MAX_BLOCKS
 - 1, 
NULL
,

5323 
PXT4_EX_NOCACHE
);

5324 i‡(
	`IS_ERR
(
∑th
))

5325  
	`PTR_ERR
(
∑th
);

5327 
dïth
 = 
∑th
->
p_dïth
;

5328 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5329 i‡(!
exã¡
)

5330 
out
;

5332 
°›
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

5339 i‡(
SHIFT
 =
SHIFT_LEFT
) {

5340 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
°¨t
 - 1, &path,

5341 
PXT4_EX_NOCACHE
);

5342 i‡(
	`IS_ERR
(
∑th
))

5343  
	`PTR_ERR
(
∑th
);

5344 
dïth
 = 
∑th
->
p_dïth
;

5345 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5346 i‡(
exã¡
) {

5347 
ex_°¨t
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

5348 
ex_íd
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
) +

5349 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
);

5351 
ex_°¨t
 = 0;

5352 
ex_íd
 = 0;

5355 i‡((
°¨t
 =
ex_°¨t
 && 
shi·
 >Éx_start) ||

5356 (
shi·
 > 
°¨t
 - 
ex_íd
)) {

5357 
ªt
 = -
EINVAL
;

5358 
out
;

5361 i‡(
shi·
 > 
EXT_MAX_BLOCKS
 -

5362 (
°›
 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
))) {

5363 
ªt
 = -
EINVAL
;

5364 
out
;

5373 i‡(
SHIFT
 =
SHIFT_LEFT
)

5374 
ôî©‹
 = &
°¨t
;

5376 
ôî©‹
 = &
°›
;

5383 
ôî©‹
 && 
°¨t
 <
°›
) {

5384 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, *
ôî©‹
, &path,

5385 
PXT4_EX_NOCACHE
);

5386 i‡(
	`IS_ERR
(
∑th
))

5387  
	`PTR_ERR
(
∑th
);

5388 
dïth
 = 
∑th
->
p_dïth
;

5389 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5390 i‡(!
exã¡
) {

5391 
	`PXT4_ERROR_INODE
(
öode
, "unexpected holeát %lu",

5392 (Ë*
ôî©‹
);

5393  -
EFSCORRUPTED
;

5395 i‡(
SHIFT
 =
SHIFT_LEFT
 && *
ôî©‹
 >

5396 
	`À32_to_˝u
(
exã¡
->
ì_block
)) {

5398 i‡(
exã¡
 < 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
)) {

5399 
∑th
[
dïth
].
p_ext
++;

5401 *
ôî©‹
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

5406 i‡(
SHIFT
 =
SHIFT_LEFT
) {

5407 
exã¡
 = 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
);

5408 *
ôî©‹
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
) +

5409 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
);

5411 
exã¡
 = 
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
);

5412 i‡(
	`À32_to_˝u
(
exã¡
->
ì_block
) > 0)

5413 *
ôî©‹
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
) - 1;

5416 
ôî©‹
 = 
NULL
;

5418 
	`À32_to_˝u
(
exã¡
->
ì_block
Ë< 
°¨t
)

5419 
exã¡
++;

5420 
∑th
[
dïth
].
p_ext
 = 
exã¡
;

5422 
ªt
 = 
	`pxt4_ext_shi·_∑th_exã¡s
(
∑th
, 
shi·
, 
öode
,

5423 
h™dÀ
, 
SHIFT
);

5424 i‡(
ªt
)

5427 
out
:

5428 
	`pxt4_ext_dr›_ªfs
(
∑th
);

5429 
	`k‰ì
(
∑th
);

5430  
ªt
;

5431 
	}
}

5438 
	$pxt4_cﬁœp£_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
)

5440 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5441 
pxt4_lblk_t
 
punch_°¨t
, 
punch_°›
;

5442 
h™dÀ_t
 *
h™dÀ
;

5443 
¸edôs
;

5444 
loff_t
 
√w_size
, 
ioff£t
;

5445 
ªt
;

5452 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

5453  -
EOPNOTSUPP
;

5456 i‡(
off£t
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1) ||

5457 
Àn
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1))

5458  -
EINVAL
;

5460 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

5461  -
EINVAL
;

5463 
	`åa˚_pxt4_cﬁœp£_ønge
(
öode
, 
off£t
, 
Àn
);

5465 
punch_°¨t
 = 
off£t
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5466 
punch_°›
 = (
off£t
 + 
Àn
Ë>> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5469 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

5470 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

5471 i‡(
ªt
)

5472  
ªt
;

5475 
	`öode_lock
(
öode
);

5480 i‡(
off£t
 + 
Àn
 >
	`i_size_ªad
(
öode
)) {

5481 
ªt
 = -
EINVAL
;

5482 
out_muãx
;

5486 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

5487 
ªt
 = -
EOPNOTSUPP
;

5488 
out_muãx
;

5492 
	`öode_dio_waô
(
öode
);

5498 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5500 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

5501 i‡(
ªt
)

5502 
out_mm≠
;

5508 
ioff£t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

5513 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
öode
->
i_m≠pög
, 
ioff£t
, 
off£t
);

5514 i‡(
ªt
)

5515 
out_mm≠
;

5521 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
öode
->
i_m≠pög
, 
off£t
 + 
Àn
,

5522 
LLONG_MAX
);

5523 i‡(
ªt
)

5524 
out_mm≠
;

5525 
	`åunˇã_∑geˇche
(
öode
, 
ioff£t
);

5527 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

5528 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

5529 i‡(
	`IS_ERR
(
h™dÀ
)) {

5530 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

5531 
out_mm≠
;

5534 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5535 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

5537 
ªt
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
punch_°¨t
,

5538 
EXT_MAX_BLOCKS
 - 
punch_°¨t
);

5539 i‡(
ªt
) {

5540 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5541 
out_°›
;

5544 
ªt
 = 
	`pxt4_ext_ªmove_•a˚
(
öode
, 
punch_°¨t
, 
punch_°›
 - 1);

5545 i‡(
ªt
) {

5546 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5547 
out_°›
;

5549 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

5551 
ªt
 = 
	`pxt4_ext_shi·_exã¡s
(
öode
, 
h™dÀ
, 
punch_°›
,

5552 
punch_°›
 - 
punch_°¨t
, 
SHIFT_LEFT
);

5553 i‡(
ªt
) {

5554 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5555 
out_°›
;

5558 
√w_size
 = 
	`i_size_ªad
(
öode
Ë- 
Àn
;

5559 
	`i_size_wrôe
(
öode
, 
√w_size
);

5560 
	`PXT4_I
(
öode
)->
i_disksize
 = 
√w_size
;

5562 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5563 i‡(
	`IS_SYNC
(
öode
))

5564 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

5565 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

5566 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5567 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

5569 
out_°›
:

5570 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5571 
out_mm≠
:

5572 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5573 
out_muãx
:

5574 
	`öode_u∆ock
(
öode
);

5575  
ªt
;

5576 
	}
}

5586 
	$pxt4_ö£π_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
)

5588 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5589 
h™dÀ_t
 *
h™dÀ
;

5590 
pxt4_ext_∑th
 *
∑th
;

5591 
pxt4_exã¡
 *
exã¡
;

5592 
pxt4_lblk_t
 
off£t_lblk
, 
Àn_lblk
, 
ì_°¨t_lblk
 = 0;

5593 
¸edôs
, 
ì_Àn
;

5594 
ªt
 = 0, 
dïth
, 
•lô_Êag
 = 0;

5595 
loff_t
 
ioff£t
;

5602 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

5603  -
EOPNOTSUPP
;

5606 i‡(
off£t
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1) ||

5607 
Àn
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1))

5608  -
EINVAL
;

5610 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

5611  -
EOPNOTSUPP
;

5613 
	`åa˚_pxt4_ö£π_ønge
(
öode
, 
off£t
, 
Àn
);

5615 
off£t_lblk
 = 
off£t
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5616 
Àn_lblk
 = 
Àn
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5619 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

5620 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

5621 i‡(
ªt
)

5622  
ªt
;

5625 
	`öode_lock
(
öode
);

5627 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

5628 
ªt
 = -
EOPNOTSUPP
;

5629 
out_muãx
;

5633 i‡(
öode
->
i_size
 + 
Àn
 > inode->
i_sb
->
s_maxbyãs
) {

5634 
ªt
 = -
EFBIG
;

5635 
out_muãx
;

5639 i‡(
off£t
 >
	`i_size_ªad
(
öode
)) {

5640 
ªt
 = -
EINVAL
;

5641 
out_muãx
;

5645 
	`öode_dio_waô
(
öode
);

5651 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5653 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

5654 i‡(
ªt
)

5655 
out_mm≠
;

5661 
ioff£t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

5663 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
öode
->
i_m≠pög
, 
ioff£t
,

5664 
LLONG_MAX
);

5665 i‡(
ªt
)

5666 
out_mm≠
;

5667 
	`åunˇã_∑geˇche
(
öode
, 
ioff£t
);

5669 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

5670 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

5671 i‡(
	`IS_ERR
(
h™dÀ
)) {

5672 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

5673 
out_mm≠
;

5677 
öode
->
i_size
 +
Àn
;

5678 
	`PXT4_I
(
öode
)->
i_disksize
 +
Àn
;

5679 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

5680 
ªt
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5681 i‡(
ªt
)

5682 
out_°›
;

5684 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5685 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

5687 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
off£t_lblk
, 
NULL
, 0);

5688 i‡(
	`IS_ERR
(
∑th
)) {

5689 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5690 
out_°›
;

5693 
dïth
 = 
	`ext_dïth
(
öode
);

5694 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5695 i‡(
exã¡
) {

5696 
ì_°¨t_lblk
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

5697 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
);

5703 i‡((
off£t_lblk
 > 
ì_°¨t_lblk
) &&

5704 (
off£t_lblk
 < (
ì_°¨t_lblk
 + 
ì_Àn
))) {

5705 i‡(
	`pxt4_ext_is_unwrôãn
(
exã¡
))

5706 
•lô_Êag
 = 
PXT4_EXT_MARK_UNWRIT1
 |

5707 
PXT4_EXT_MARK_UNWRIT2
;

5708 
ªt
 = 
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, &
∑th
,

5709 
off£t_lblk
, 
•lô_Êag
,

5710 
PXT4_EX_NOCACHE
 |

5711 
PXT4_GET_BLOCKS_PRE_IO
 |

5712 
PXT4_GET_BLOCKS_METADATA_NOFAIL
);

5715 
	`pxt4_ext_dr›_ªfs
(
∑th
);

5716 
	`k‰ì
(
∑th
);

5717 i‡(
ªt
 < 0) {

5718 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5719 
out_°›
;

5722 
	`pxt4_ext_dr›_ªfs
(
∑th
);

5723 
	`k‰ì
(
∑th
);

5726 
ªt
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
off£t_lblk
,

5727 
EXT_MAX_BLOCKS
 - 
off£t_lblk
);

5728 i‡(
ªt
) {

5729 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5730 
out_°›
;

5737 
ªt
 = 
	`pxt4_ext_shi·_exã¡s
(
öode
, 
h™dÀ
,

5738 
ì_°¨t_lblk
 > 
off£t_lblk
 ?Ée_start_lblk : offset_lblk,

5739 
Àn_lblk
, 
SHIFT_RIGHT
);

5741 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5742 i‡(
	`IS_SYNC
(
öode
))

5743 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

5744 i‡(
ªt
 >= 0)

5745 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

5747 
out_°›
:

5748 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5749 
out_mm≠
:

5750 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5751 
out_muãx
:

5752 
	`öode_u∆ock
(
öode
);

5753  
ªt
;

5754 
	}
}

5777 
	$pxt4_sw≠_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
öode1
,

5778 
öode
 *
öode2
, 
pxt4_lblk_t
 
lblk1
,Öxt4_lblk_à
lblk2
,

5779 
pxt4_lblk_t
 
cou¡
, 
unwrôãn
, *
îp
)

5781 
pxt4_ext_∑th
 *
∑th1
 = 
NULL
;

5782 
pxt4_ext_∑th
 *
∑th2
 = 
NULL
;

5783 
ª∂a˚d_cou¡
 = 0;

5785 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode1
)->
i_d©a_£m
));

5786 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode2
)->
i_d©a_£m
));

5787 
	`BUG_ON
(!
	`öode_is_locked
(
öode1
));

5788 
	`BUG_ON
(!
	`öode_is_locked
(
öode2
));

5790 *
îp
 = 
	`pxt4_es_ªmove_exã¡
(
öode1
, 
lblk1
, 
cou¡
);

5791 i‡(
	`u∆ikñy
(*
îp
))

5793 *
îp
 = 
	`pxt4_es_ªmove_exã¡
(
öode2
, 
lblk2
, 
cou¡
);

5794 i‡(
	`u∆ikñy
(*
îp
))

5797 
cou¡
) {

5798 
pxt4_exã¡
 *
ex1
, *
ex2
, 
tmp_ex
;

5799 
pxt4_lblk_t
 
e1_blk
, 
e2_blk
;

5800 
e1_Àn
, 
e2_Àn
, 
Àn
;

5801 
•lô
 = 0;

5803 
∑th1
 = 
	`pxt4_föd_exã¡
(
öode1
, 
lblk1
, 
NULL
, 
PXT4_EX_NOCACHE
);

5804 i‡(
	`IS_ERR
(
∑th1
)) {

5805 *
îp
 = 
	`PTR_ERR
(
∑th1
);

5806 
∑th1
 = 
NULL
;

5807 
föish
:

5808 
cou¡
 = 0;

5809 
ª≥©
;

5811 
∑th2
 = 
	`pxt4_föd_exã¡
(
öode2
, 
lblk2
, 
NULL
, 
PXT4_EX_NOCACHE
);

5812 i‡(
	`IS_ERR
(
∑th2
)) {

5813 *
îp
 = 
	`PTR_ERR
(
∑th2
);

5814 
∑th2
 = 
NULL
;

5815 
föish
;

5817 
ex1
 = 
∑th1
[∑th1->
p_dïth
].
p_ext
;

5818 
ex2
 = 
∑th2
[∑th2->
p_dïth
].
p_ext
;

5820 i‡(
	`u∆ikñy
(!
ex2
 || !
ex1
))

5821 
föish
;

5823 
e1_blk
 = 
	`À32_to_˝u
(
ex1
->
ì_block
);

5824 
e2_blk
 = 
	`À32_to_˝u
(
ex2
->
ì_block
);

5825 
e1_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex1
);

5826 
e2_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex2
);

5829 i‡(!
	`ö_ønge
(
lblk1
, 
e1_blk
, 
e1_Àn
) ||

5830 !
	`ö_ønge
(
lblk2
, 
e2_blk
, 
e2_Àn
)) {

5831 
pxt4_lblk_t
 
√xt1
, 
≈xt2
;

5834 
√xt1
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th1
);

5835 
≈xt2
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th2
);

5837 i‡(
e1_blk
 > 
lblk1
)

5838 
√xt1
 = 
e1_blk
;

5839 i‡(
e2_blk
 > 
lblk2
)

5840 
≈xt2
 = 
e2_blk
;

5842 i‡(
√xt1
 =
EXT_MAX_BLOCKS
 || 
≈xt2
 == EXT_MAX_BLOCKS)

5843 
föish
;

5845 
Àn
 = 
√xt1
 - 
lblk1
;

5846 i‡(
Àn
 < 
≈xt2
 - 
lblk2
)

5847 
Àn
 = 
≈xt2
 - 
lblk2
;

5848 i‡(
Àn
 > 
cou¡
)

5849 
Àn
 = 
cou¡
;

5850 
lblk1
 +
Àn
;

5851 
lblk2
 +
Àn
;

5852 
cou¡
 -
Àn
;

5853 
ª≥©
;

5857 i‡(
e1_blk
 < 
lblk1
) {

5858 
•lô
 = 1;

5859 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode1
,

5860 &
∑th1
, 
lblk1
, 0);

5861 i‡(
	`u∆ikñy
(*
îp
))

5862 
föish
;

5864 i‡(
e2_blk
 < 
lblk2
) {

5865 
•lô
 = 1;

5866 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode2
,

5867 &
∑th2
, 
lblk2
, 0);

5868 i‡(
	`u∆ikñy
(*
îp
))

5869 
föish
;

5873 i‡(
•lô
)

5874 
ª≥©
;

5877 
Àn
 = 
cou¡
;

5878 i‡(
Àn
 > 
e1_blk
 + 
e1_Àn
 - 
lblk1
)

5879 
Àn
 = 
e1_blk
 + 
e1_Àn
 - 
lblk1
;

5880 i‡(
Àn
 > 
e2_blk
 + 
e2_Àn
 - 
lblk2
)

5881 
Àn
 = 
e2_blk
 + 
e2_Àn
 - 
lblk2
;

5883 i‡(
Àn
 !
e1_Àn
) {

5884 
•lô
 = 1;

5885 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode1
,

5886 &
∑th1
, 
lblk1
 + 
Àn
, 0);

5887 i‡(
	`u∆ikñy
(*
îp
))

5888 
föish
;

5890 i‡(
Àn
 !
e2_Àn
) {

5891 
•lô
 = 1;

5892 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode2
,

5893 &
∑th2
, 
lblk2
 + 
Àn
, 0);

5894 i‡(*
îp
)

5895 
föish
;

5899 i‡(
•lô
)

5900 
ª≥©
;

5902 
	`BUG_ON
(
e2_Àn
 !
e1_Àn
);

5903 *
îp
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode1
, 
∑th1
 +Ö©h1->
p_dïth
);

5904 i‡(
	`u∆ikñy
(*
îp
))

5905 
föish
;

5906 *
îp
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode2
, 
∑th2
 +Ö©h2->
p_dïth
);

5907 i‡(
	`u∆ikñy
(*
îp
))

5908 
föish
;

5911 
tmp_ex
 = *
ex1
;

5912 
	`pxt4_ext_°‹e_pblock
(
ex1
, 
	`pxt4_ext_pblock
(
ex2
));

5913 
	`pxt4_ext_°‹e_pblock
(
ex2
, 
	`pxt4_ext_pblock
(&
tmp_ex
));

5914 
ex1
->
ì_Àn
 = 
	`˝u_to_À16
(
e2_Àn
);

5915 
ex2
->
ì_Àn
 = 
	`˝u_to_À16
(
e1_Àn
);

5916 i‡(
unwrôãn
)

5917 
	`pxt4_ext_m¨k_unwrôãn
(
ex2
);

5918 i‡(
	`pxt4_ext_is_unwrôãn
(&
tmp_ex
))

5919 
	`pxt4_ext_m¨k_unwrôãn
(
ex1
);

5921 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode2
, 
∑th2
, 
ex2
);

5922 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode1
, 
∑th1
, 
ex1
);

5923 *
îp
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode2
, 
∑th2
 +

5924 
∑th2
->
p_dïth
);

5925 i‡(
	`u∆ikñy
(*
îp
))

5926 
föish
;

5927 *
îp
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode1
, 
∑th1
 +

5928 
∑th1
->
p_dïth
);

5935 i‡(
	`u∆ikñy
(*
îp
))

5936 
föish
;

5937 
lblk1
 +
Àn
;

5938 
lblk2
 +
Àn
;

5939 
ª∂a˚d_cou¡
 +
Àn
;

5940 
cou¡
 -
Àn
;

5942 
ª≥©
:

5943 
	`pxt4_ext_dr›_ªfs
(
∑th1
);

5944 
	`k‰ì
(
∑th1
);

5945 
	`pxt4_ext_dr›_ªfs
(
∑th2
);

5946 
	`k‰ì
(
∑th2
);

5947 
∑th1
 = 
∑th2
 = 
NULL
;

5949  
ª∂a˚d_cou¡
;

5950 
	}
}

5964 
	$pxt4_˛u_m≠≥d
(
öode
 *öode, 
pxt4_lblk_t
 
l˛u
)

5966 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

5967 
pxt4_ext_∑th
 *
∑th
;

5968 
dïth
, 
m≠≥d
 = 0, 
îr
 = 0;

5969 
pxt4_exã¡
 *
exã¡
;

5970 
pxt4_lblk_t
 
fú°_lblk
, 
fú°_l˛u
, 
œ°_l˛u
;

5973 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
	`PXT4_C2B
(
sbi
, 
l˛u
), 
NULL
, 0);

5974 i‡(
	`IS_ERR
(
∑th
)) {

5975 
îr
 = 
	`PTR_ERR
(
∑th
);

5976 
∑th
 = 
NULL
;

5977 
out
;

5980 
dïth
 = 
	`ext_dïth
(
öode
);

5987 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_ext
 =
NULL
 && depth != 0)) {

5988 
	`PXT4_ERROR_INODE
(
öode
,

5990 (Ë
	`PXT4_C2B
(
sbi
, 
l˛u
),

5991 
dïth
, 
∑th
[dïth].
p_block
);

5992 
îr
 = -
EFSCORRUPTED
;

5993 
out
;

5996 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5999 i‡(
exã¡
 =
NULL
)

6000 
out
;

6002 
fú°_lblk
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

6003 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
fú°_lblk
);

6011 i‡(
l˛u
 >
fú°_l˛u
) {

6012 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
fú°_lblk
 +

6013 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
) - 1);

6014 i‡(
l˛u
 <
œ°_l˛u
) {

6015 
m≠≥d
 = 1;

6017 
fú°_lblk
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

6018 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
fú°_lblk
);

6019 i‡(
l˛u
 =
fú°_l˛u
)

6020 
m≠≥d
 = 1;

6024 
out
:

6025 
	`pxt4_ext_dr›_ªfs
(
∑th
);

6026 
	`k‰ì
(
∑th
);

6028  
îr
 ?Éº : 
m≠≥d
;

6029 
	}
}

	@extents_status.c

13 
	~<löux/li°_s‹t.h
>

14 
	~<löux/¥oc_fs.h
>

15 
	~<löux/£q_fûe.h
>

16 
	~"pxt4.h
"

18 
	~<åa˚/evíts/pxt4.h
>

144 
kmem_ˇche
 *
	gpxt4_es_ˇchï
;

145 
kmem_ˇche
 *
	gpxt4_≥ndög_ˇchï
;

147 
__es_ö£π_exã¡
(
öode
 *öode, 
exã¡_°©us
 *
√wes
);

148 
__es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

149 
pxt4_lblk_t
 
íd
, *
ª£rved
);

150 
es_ª˛aim_exã¡s
(
pxt4_öode_öfo
 *
ei
, *
ƒ_to_sˇn
);

151 
__es_shrök
(
pxt4_sb_öfo
 *
sbi
, 
ƒ_to_sˇn
,

152 
pxt4_öode_öfo
 *
locked_ei
);

153 
__ªvi£_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

154 
pxt4_lblk_t
 
Àn
);

156 
__öô
 
	$pxt4_öô_es
()

158 
pxt4_es_ˇchï
 = 
	`kmem_ˇche_¸óã
("pxt4_extent_status",

159 (
exã¡_°©us
),

160 0, (
SLAB_RECLAIM_ACCOUNT
), 
NULL
);

161 i‡(
pxt4_es_ˇchï
 =
NULL
)

162  -
ENOMEM
;

164 
	}
}

166 
	$pxt4_exô_es
()

168 
	`kmem_ˇche_de°roy
(
pxt4_es_ˇchï
);

169 
	}
}

171 
	$pxt4_es_öô_åì
(
pxt4_es_åì
 *
åì
)

173 
åì
->
roŸ
 = 
RB_ROOT
;

174 
åì
->
ˇche_es
 = 
NULL
;

175 
	}
}

177 #ifde‡
ES_DEBUG__


178 
	$pxt4_es_¥öt_åì
(
öode
 *inode)

180 
pxt4_es_åì
 *
åì
;

181 
rb_node
 *
node
;

183 
	`¥ötk
(
KERN_DEBUG
 "°©u†exã¡†f‹ inodê%lu:", 
öode
->
i_öo
);

184 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

185 
node
 = 
	`rb_fú°
(&
åì
->
roŸ
);

186 
node
) {

187 
exã¡_°©us
 *
es
;

188 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

189 
	`¥ötk
(
KERN_DEBUG
 " [%u/%u) %llu %x",

190 
es
->
es_lblk
,És->
es_Àn
,

191 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

192 
node
 = 
	`rb_√xt
(node);

194 
	`¥ötk
(
KERN_DEBUG
 "\n");

195 
	}
}

197 
	#pxt4_es_¥öt_åì
(
öode
)

	)

200 
ölöe
 
pxt4_lblk_t
 
	$pxt4_es_íd
(
exã¡_°©us
 *
es
)

202 
	`BUG_ON
(
es
->
es_lblk
 +És->
es_Àn
 <És->es_lblk);

203  
es
->
es_lblk
 +És->
es_Àn
 - 1;

204 
	}
}

210 
exã¡_°©us
 *
	$__es_åì_£¨ch
(
rb_roŸ
 *
roŸ
,

211 
pxt4_lblk_t
 
lblk
)

213 
rb_node
 *
node
 = 
roŸ
->rb_node;

214 
exã¡_°©us
 *
es
 = 
NULL
;

216 
node
) {

217 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

218 i‡(
lblk
 < 
es
->
es_lblk
)

219 
node
 =Çode->
rb_À·
;

220 i‡(
lblk
 > 
	`pxt4_es_íd
(
es
))

221 
node
 =Çode->
rb_right
;

223  
es
;

226 i‡(
es
 && 
lblk
 <És->
es_lblk
)

227  
es
;

229 i‡(
es
 && 
lblk
 > 
	`pxt4_es_íd
(es)) {

230 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

231  
node
 ? 
	`rb_íåy
“ode, 
exã¡_°©us
, 
rb_node
) :

232 
NULL
;

235  
NULL
;

236 
	}
}

256 
	$__es_föd_exã¡_ønge
(
öode
 *inode,

257 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

258 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
,

259 
exã¡_°©us
 *
es
)

261 
pxt4_es_åì
 *
åì
 = 
NULL
;

262 
exã¡_°©us
 *
es1
 = 
NULL
;

263 
rb_node
 *
node
;

265 
	`WARN_ON
(
es
 =
NULL
);

266 
	`WARN_ON
(
íd
 < 
lblk
);

268 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

271 
es
->
es_lblk
 =És->
es_Àn
 =És->
es_pblk
 = 0;

272 i‡(
åì
->
ˇche_es
) {

273 
es1
 = 
åì
->
ˇche_es
;

274 i‡(
	`ö_ønge
(
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
)) {

275 
	`es_debug
("%u cached by [%u/%u) %llu %x\n",

276 
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
,

277 
	`pxt4_es_pblock
(
es1
), 
	`pxt4_es_°©us
(es1));

278 
out
;

282 
es1
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
lblk
);

284 
out
:

285 i‡(
es1
 && !
	`m©chög_‚
(es1)) {

286 (
node
 = 
	`rb_√xt
(&
es1
->
rb_node
)Ë!
NULL
) {

287 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

288 i‡(
es1
->
es_lblk
 > 
íd
) {

289 
es1
 = 
NULL
;

292 i‡(
	`m©chög_‚
(
es1
))

297 i‡(
es1
 && 
	`m©chög_‚
(es1)) {

298 
åì
->
ˇche_es
 = 
es1
;

299 
es
->
es_lblk
 = 
es1
->es_lblk;

300 
es
->
es_Àn
 = 
es1
->es_len;

301 
es
->
es_pblk
 = 
es1
->es_pblk;

304 
	}
}

309 
	$pxt4_es_föd_exã¡_ønge
(
öode
 *inode,

310 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

311 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
,

312 
exã¡_°©us
 *
es
)

314 
	`åa˚_pxt4_es_föd_exã¡_ønge_íãr
(
öode
, 
lblk
);

316 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

317 
	`__es_föd_exã¡_ønge
(
öode
, 
m©chög_‚
, 
lblk
, 
íd
, 
es
);

318 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

320 
	`åa˚_pxt4_es_föd_exã¡_ønge_exô
(
öode
, 
es
);

321 
	}
}

338 
boﬁ
 
	$__es_sˇn_ønge
(
öode
 *inode,

339 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

340 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
)

342 
exã¡_°©us
 
es
;

344 
	`__es_föd_exã¡_ønge
(
öode
, 
m©chög_‚
, 
°¨t
, 
íd
, &
es
);

345 i‡(
es
.
es_Àn
 == 0)

346  
Ál£
;

347 i‡(
es
.
es_lblk
 <
°¨t
 &&

348 
°¨t
 < 
es
.
es_lblk
 +És.
es_Àn
)

349  
åue
;

350 i‡(
°¨t
 <
es
.
es_lblk
 &&És.es_lblk <
íd
)

351  
åue
;

353  
Ál£
;

354 
	}
}

358 
boﬁ
 
	$pxt4_es_sˇn_ønge
(
öode
 *inode,

359 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

360 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
)

362 
boﬁ
 
ªt
;

364 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

365 
ªt
 = 
	`__es_sˇn_ønge
(
öode
, 
m©chög_‚
, 
lblk
, 
íd
);

366 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

368  
ªt
;

369 
	}
}

385 
boﬁ
 
	$__es_sˇn_˛u
(
öode
 *inode,

386 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

387 
pxt4_lblk_t
 
lblk
)

389 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

390 
pxt4_lblk_t
 
lblk_°¨t
, 
lblk_íd
;

392 
lblk_°¨t
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
lblk
);

393 
lblk_íd
 = 
lblk_°¨t
 + 
sbi
->
s_˛u°î_øtio
 - 1;

395  
	`__es_sˇn_ønge
(
öode
, 
m©chög_‚
, 
lblk_°¨t
, 
lblk_íd
);

396 
	}
}

401 
boﬁ
 
	$pxt4_es_sˇn_˛u
(
öode
 *inode,

402 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

403 
pxt4_lblk_t
 
lblk
)

405 
boﬁ
 
ªt
;

407 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

408 
ªt
 = 
	`__es_sˇn_˛u
(
öode
, 
m©chög_‚
, 
lblk
);

409 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

411  
ªt
;

412 
	}
}

414 
	$pxt4_es_li°_add
(
öode
 *inode)

416 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

417 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

419 i‡(!
	`li°_em±y
(&
ei
->
i_es_li°
))

422 
	`•ö_lock
(&
sbi
->
s_es_lock
);

423 i‡(
	`li°_em±y
(&
ei
->
i_es_li°
)) {

424 
	`li°_add_èû
(&
ei
->
i_es_li°
, &
sbi
->
s_es_li°
);

425 
sbi
->
s_es_ƒ_öode
++;

427 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

428 
	}
}

430 
	$pxt4_es_li°_dñ
(
öode
 *inode)

432 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

433 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

435 
	`•ö_lock
(&
sbi
->
s_es_lock
);

436 i‡(!
	`li°_em±y
(&
ei
->
i_es_li°
)) {

437 
	`li°_dñ_öô
(&
ei
->
i_es_li°
);

438 
sbi
->
s_es_ƒ_öode
--;

439 
	`WARN_ON_ONCE
(
sbi
->
s_es_ƒ_öode
 < 0);

441 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

442 
	}
}

444 
exã¡_°©us
 *

445 
	$pxt4_es_Æloc_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
Àn
,

446 
pxt4_fsblk_t
 
pblk
)

448 
exã¡_°©us
 *
es
;

449 
es
 = 
	`kmem_ˇche_Æloc
(
pxt4_es_ˇchï
, 
GFP_ATOMIC
);

450 i‡(
es
 =
NULL
)

451  
NULL
;

452 
es
->
es_lblk
 = 
lblk
;

453 
es
->
es_Àn
 = 
Àn
;

454 
es
->
es_pblk
 = 
pblk
;

459 i‡(!
	`pxt4_es_is_dñayed
(
es
)) {

460 i‡(!
	`PXT4_I
(
öode
)->
i_es_shk_ƒ
++)

461 
	`pxt4_es_li°_add
(
öode
);

462 
	`≥r˝u_cou¡î_öc
(&
	`PXT4_SB
(
öode
->
i_sb
)->

463 
s_es_°©s
.
es_°©s_shk_˙t
);

466 
	`PXT4_I
(
öode
)->
i_es_Æl_ƒ
++;

467 
	`≥r˝u_cou¡î_öc
(&
	`PXT4_SB
(
öode
->
i_sb
)->
s_es_°©s
.
es_°©s_Æl_˙t
);

469  
es
;

470 
	}
}

472 
	$pxt4_es_‰ì_exã¡
(
öode
 *öode, 
exã¡_°©us
 *
es
)

474 
	`PXT4_I
(
öode
)->
i_es_Æl_ƒ
--;

475 
	`≥r˝u_cou¡î_dec
(&
	`PXT4_SB
(
öode
->
i_sb
)->
s_es_°©s
.
es_°©s_Æl_˙t
);

478 i‡(!
	`pxt4_es_is_dñayed
(
es
)) {

479 
	`BUG_ON
(
	`PXT4_I
(
öode
)->
i_es_shk_ƒ
 == 0);

480 i‡(!--
	`PXT4_I
(
öode
)->
i_es_shk_ƒ
)

481 
	`pxt4_es_li°_dñ
(
öode
);

482 
	`≥r˝u_cou¡î_dec
(&
	`PXT4_SB
(
öode
->
i_sb
)->

483 
s_es_°©s
.
es_°©s_shk_˙t
);

486 
	`kmem_ˇche_‰ì
(
pxt4_es_ˇchï
, 
es
);

487 
	}
}

496 
	$pxt4_es_ˇn_be_mîged
(
exã¡_°©us
 *
es1
,

497 
exã¡_°©us
 *
es2
)

499 i‡(
	`pxt4_es_ty≥
(
es1
Ë!pxt4_es_ty≥(
es2
))

502 i‡(((
__u64
Ë
es1
->
es_Àn
Ë+ 
es2
->es_À¿> 
EXT_MAX_BLOCKS
) {

503 
	`¥_w¨n
("ESássertion failed when mergingÉxtents. "

506 
es1
->
es_Àn
, 
es2
->es_Àn, 
EXT_MAX_BLOCKS
);

507 
	`WARN_ON
(1);

511 i‡(((
__u64
Ë
es1
->
es_lblk
Ë+És1->
es_Àn
 !
es2
->es_lblk)

514 i‡((
	`pxt4_es_is_wrôãn
(
es1
Ë|| 
	`pxt4_es_is_unwrôãn
(es1)) &&

515 (
	`pxt4_es_pblock
(
es1
Ë+És1->
es_Àn
 =pxt4_es_pblock(
es2
)))

518 i‡(
	`pxt4_es_is_hﬁe
(
es1
))

522 i‡(
	`pxt4_es_is_dñayed
(
es1
Ë&& !
	`pxt4_es_is_unwrôãn
(es1))

526 
	}
}

528 
exã¡_°©us
 *

529 
	$pxt4_es_åy_to_mîge_À·
(
öode
 *öode, 
exã¡_°©us
 *
es
)

531 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

532 
exã¡_°©us
 *
es1
;

533 
rb_node
 *
node
;

535 
node
 = 
	`rb_¥ev
(&
es
->
rb_node
);

536 i‡(!
node
)

537  
es
;

539 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

540 i‡(
	`pxt4_es_ˇn_be_mîged
(
es1
, 
es
)) {

541 
es1
->
es_Àn
 +
es
->es_len;

542 i‡(
	`pxt4_es_is_ª„ªn˚d
(
es
))

543 
	`pxt4_es_£t_ª„ªn˚d
(
es1
);

544 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

545 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

546 
es
 = 
es1
;

549  
es
;

550 
	}
}

552 
exã¡_°©us
 *

553 
	$pxt4_es_åy_to_mîge_right
(
öode
 *öode, 
exã¡_°©us
 *
es
)

555 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

556 
exã¡_°©us
 *
es1
;

557 
rb_node
 *
node
;

559 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

560 i‡(!
node
)

561  
es
;

563 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

564 i‡(
	`pxt4_es_ˇn_be_mîged
(
es
, 
es1
)) {

565 
es
->
es_Àn
 +
es1
->es_len;

566 i‡(
	`pxt4_es_is_ª„ªn˚d
(
es1
))

567 
	`pxt4_es_£t_ª„ªn˚d
(
es
);

568 
	`rb_îa£
(
node
, &
åì
->
roŸ
);

569 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es1
);

572  
es
;

573 
	}
}

575 #ifde‡
ES_AGGRESSIVE_TEST


576 
	~"pxt4_exã¡s.h
"

578 
	$pxt4_es_ö£π_exã¡_ext_check
(
öode
 *inode,

579 
exã¡_°©us
 *
es
)

581 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

582 
pxt4_exã¡
 *
ex
;

583 
pxt4_lblk_t
 
ì_block
;

584 
pxt4_fsblk_t
 
ì_°¨t
;

585 
ì_Àn
;

586 
dïth
, 
ì_°©us
, 
es_°©us
;

588 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
es
->
es_lblk
, 
NULL
, 
PXT4_EX_NOCACHE
);

589 i‡(
	`IS_ERR
(
∑th
))

592 
dïth
 = 
	`ext_dïth
(
öode
);

593 
ex
 = 
∑th
[
dïth
].
p_ext
;

595 i‡(
ex
) {

597 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

598 
ì_°¨t
 = 
	`pxt4_ext_pblock
(
ex
);

599 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

601 
ì_°©us
 = 
	`pxt4_ext_is_unwrôãn
(
ex
) ? 1 : 0;

602 
es_°©us
 = 
	`pxt4_es_is_unwrôãn
(
es
) ? 1 : 0;

608 i‡(!
	`pxt4_es_is_wrôãn
(
es
Ë&& !
	`pxt4_es_is_unwrôãn
(es)) {

609 i‡(
	`ö_ønge
(
es
->
es_lblk
, 
ì_block
, 
ì_Àn
)) {

610 
	`¥_w¨n
("ES insertássertion failed for "

615 
öode
->
i_öo
, 
ì_block
, 
ì_Àn
,

616 
ì_°¨t
, 
ì_°©us
 ? 'u' : 'w',

617 
es
->
es_lblk
,És->
es_Àn
,

618 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

620 
out
;

627 i‡(
es
->
es_lblk
 < 
ì_block
 ||

628 
	`pxt4_es_pblock
(
es
Ë!
ì_°¨t
 +És->
es_lblk
 - 
ì_block
) {

629 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

631 "es_°©u†[%d/%d/%Œu/%c]\n", 
öode
->
i_öo
,

632 
ì_block
, 
ì_Àn
, 
ì_°¨t
,

633 
ì_°©us
 ? 'u' : 'w', 
es
->
es_lblk
,És->
es_Àn
,

634 
	`pxt4_es_pblock
(
es
), 
es_°©us
 ? 'u' : 'w');

635 
out
;

638 i‡(
ì_°©us
 ^ 
es_°©us
) {

639 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

641 "es_°©u†[%d/%d/%Œu/%c]\n", 
öode
->
i_öo
,

642 
ì_block
, 
ì_Àn
, 
ì_°¨t
,

643 
ì_°©us
 ? 'u' : 'w', 
es
->
es_lblk
,És->
es_Àn
,

644 
	`pxt4_es_pblock
(
es
), 
es_°©us
 ? 'u' : 'w');

651 i‡(!
	`pxt4_es_is_dñayed
(
es
Ë&& !
	`pxt4_es_is_hﬁe
(es)) {

652 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

655 "[%d/%d/%Œu/%x]\n", 
öode
->
i_öo
,

656 
es
->
es_lblk
,És->es_lblk,És->
es_Àn
,

657 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

660 
out
:

661 
	`pxt4_ext_dr›_ªfs
(
∑th
);

662 
	`k‰ì
(
∑th
);

663 
	}
}

665 
	$pxt4_es_ö£π_exã¡_öd_check
(
öode
 *inode,

666 
exã¡_°©us
 *
es
)

668 
pxt4_m≠_blocks
 
m≠
;

669 
ªtvÆ
;

678 
m≠
.
m_lblk
 = 
es
->
es_lblk
;

679 
m≠
.
m_Àn
 = 
es
->
es_Àn
;

681 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

682 i‡(
ªtvÆ
 > 0) {

683 i‡(
	`pxt4_es_is_dñayed
(
es
Ë|| 
	`pxt4_es_is_hﬁe
(es)) {

688 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

691 
öode
->
i_öo
, 
es
->
es_lblk
,És->
es_Àn
,

692 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

694 } i‡(
	`pxt4_es_is_wrôãn
(
es
)) {

695 i‡(
ªtvÆ
 !
es
->
es_Àn
) {

696 
	`¥_w¨n
("ES insertássertion failed for "

698 
öode
->
i_öo
, 
ªtvÆ
, 
es
->
es_Àn
);

701 i‡(
m≠
.
m_pblk
 !
	`pxt4_es_pblock
(
es
)) {

702 
	`¥_w¨n
("ES insertássertion failed for "

705 
öode
->
i_öo
, 
m≠
.
m_pblk
,

706 
	`pxt4_es_pblock
(
es
));

714 
	`BUG
();

716 } i‡(
ªtvÆ
 == 0) {

717 i‡(
	`pxt4_es_is_wrôãn
(
es
)) {

718 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

721 
öode
->
i_öo
, 
es
->
es_lblk
,És->
es_Àn
,

722 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

726 
	}
}

728 
ölöe
 
	$pxt4_es_ö£π_exã¡_check
(
öode
 *inode,

729 
exã¡_°©us
 *
es
)

735 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

736 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

737 
	`pxt4_es_ö£π_exã¡_ext_check
(
öode
, 
es
);

739 
	`pxt4_es_ö£π_exã¡_öd_check
(
öode
, 
es
);

740 
	}
}

742 
ölöe
 
	$pxt4_es_ö£π_exã¡_check
(
öode
 *inode,

743 
exã¡_°©us
 *
es
)

745 
	}
}

748 
	$__es_ö£π_exã¡
(
öode
 *öode, 
exã¡_°©us
 *
√wes
)

750 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

751 
rb_node
 **
p
 = &
åì
->
roŸ
.rb_node;

752 
rb_node
 *
∑ª¡
 = 
NULL
;

753 
exã¡_°©us
 *
es
;

755 *
p
) {

756 
∑ª¡
 = *
p
;

757 
es
 = 
	`rb_íåy
(
∑ª¡
, 
exã¡_°©us
, 
rb_node
);

759 i‡(
√wes
->
es_lblk
 < 
es
->es_lblk) {

760 i‡(
	`pxt4_es_ˇn_be_mîged
(
√wes
, 
es
)) {

765 
es
->
es_lblk
 = 
√wes
->es_lblk;

766 
es
->
es_Àn
 +
√wes
->es_len;

767 i‡(
	`pxt4_es_is_wrôãn
(
es
) ||

768 
	`pxt4_es_is_unwrôãn
(
es
))

769 
	`pxt4_es_°‹e_pblock
(
es
,

770 
√wes
->
es_pblk
);

771 
es
 = 
	`pxt4_es_åy_to_mîge_À·
(
öode
,És);

772 
out
;

774 
p
 = &(*p)->
rb_À·
;

775 } i‡(
√wes
->
es_lblk
 > 
	`pxt4_es_íd
(
es
)) {

776 i‡(
	`pxt4_es_ˇn_be_mîged
(
es
, 
√wes
)) {

777 
es
->
es_Àn
 +
√wes
->es_len;

778 
es
 = 
	`pxt4_es_åy_to_mîge_right
(
öode
,És);

779 
out
;

781 
p
 = &(*p)->
rb_right
;

783 
	`BUG
();

784  -
EINVAL
;

788 
es
 = 
	`pxt4_es_Æloc_exã¡
(
öode
, 
√wes
->
es_lblk
,Çewes->
es_Àn
,

789 
√wes
->
es_pblk
);

790 i‡(!
es
)

791  -
ENOMEM
;

792 
	`rb_lök_node
(&
es
->
rb_node
, 
∑ª¡
, 
p
);

793 
	`rb_ö£π_cﬁ‹
(&
es
->
rb_node
, &
åì
->
roŸ
);

795 
out
:

796 
åì
->
ˇche_es
 = 
es
;

798 
	}
}

806 
	$pxt4_es_ö£π_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

807 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

808 
°©us
)

810 
exã¡_°©us
 
√wes
;

811 
pxt4_lblk_t
 
íd
 = 
lblk
 + 
Àn
 - 1;

812 
îr
 = 0;

813 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

815 
	`es_debug
("add [%u/%u) %llu %xÅoÉxtent statusÅree of inode %lu\n",

816 
lblk
, 
Àn
, 
pblk
, 
°©us
, 
öode
->
i_öo
);

818 i‡(!
Àn
)

821 
	`BUG_ON
(
íd
 < 
lblk
);

823 i‡((
°©us
 & 
EXTENT_STATUS_DELAYED
) &&

824 (
°©us
 & 
EXTENT_STATUS_WRITTEN
)) {

825 
	`pxt4_w¨nög
(
öode
->
i_sb
, "InsertingÉxtent [%u/%u]ás "

827 " cau£ d©®loss.", 
lblk
, 
Àn
);

828 
	`WARN_ON
(1);

831 
√wes
.
es_lblk
 = 
lblk
;

832 
√wes
.
es_Àn
 = 
Àn
;

833 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, 
pblk
, 
°©us
);

834 
	`åa˚_pxt4_es_ö£π_exã¡
(
öode
, &
√wes
);

836 
	`pxt4_es_ö£π_exã¡_check
(
öode
, &
√wes
);

838 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

839 
îr
 = 
	`__es_ªmove_exã¡
(
öode
, 
lblk
, 
íd
, 
NULL
);

840 i‡(
îr
 != 0)

841 
îr‹
;

842 
ªåy
:

843 
îr
 = 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

844 i‡(
îr
 =-
ENOMEM
 && 
	`__es_shrök
(
	`PXT4_SB
(
öode
->
i_sb
),

845 128, 
	`PXT4_I
(
öode
)))

846 
ªåy
;

847 i‡(
îr
 =-
ENOMEM
 && !
	`pxt4_es_is_dñayed
(&
√wes
))

848 
îr
 = 0;

850 i‡(
sbi
->
s_˛u°î_øtio
 > 1 && 
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
) &&

851 (
°©us
 & 
EXTENT_STATUS_WRITTEN
 ||

852 
°©us
 & 
EXTENT_STATUS_UNWRITTEN
))

853 
	`__ªvi£_≥ndög
(
öode
, 
lblk
, 
Àn
);

855 
îr‹
:

856 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

858 
	`pxt4_es_¥öt_åì
(
öode
);

860  
îr
;

861 
	}
}

868 
	$pxt4_es_ˇche_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

869 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

870 
°©us
)

872 
exã¡_°©us
 *
es
;

873 
exã¡_°©us
 
√wes
;

874 
pxt4_lblk_t
 
íd
 = 
lblk
 + 
Àn
 - 1;

876 
√wes
.
es_lblk
 = 
lblk
;

877 
√wes
.
es_Àn
 = 
Àn
;

878 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, 
pblk
, 
°©us
);

879 
	`åa˚_pxt4_es_ˇche_exã¡
(
öode
, &
√wes
);

881 i‡(!
Àn
)

884 
	`BUG_ON
(
íd
 < 
lblk
);

886 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

888 
es
 = 
	`__es_åì_£¨ch
(&
	`PXT4_I
(
öode
)->
i_es_åì
.
roŸ
, 
lblk
);

889 i‡(!
es
 ||És->
es_lblk
 > 
íd
)

890 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

891 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

892 
	}
}

901 
	$pxt4_es_lookup_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

902 
pxt4_lblk_t
 *
√xt_lblk
,

903 
exã¡_°©us
 *
es
)

905 
pxt4_es_åì
 *
åì
;

906 
pxt4_es_°©s
 *
°©s
;

907 
exã¡_°©us
 *
es1
 = 
NULL
;

908 
rb_node
 *
node
;

909 
found
 = 0;

911 
	`åa˚_pxt4_es_lookup_exã¡_íãr
(
öode
, 
lblk
);

912 
	`es_debug
("looku∞exã¡ i¿block %u\n", 
lblk
);

914 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

915 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

918 
es
->
es_lblk
 =És->
es_Àn
 =És->
es_pblk
 = 0;

919 i‡(
åì
->
ˇche_es
) {

920 
es1
 = 
åì
->
ˇche_es
;

921 i‡(
	`ö_ønge
(
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
)) {

922 
	`es_debug
("%u cached by [%u/%u)\n",

923 
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
);

924 
found
 = 1;

925 
out
;

929 
node
 = 
åì
->
roŸ
.
rb_node
;

930 
node
) {

931 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

932 i‡(
lblk
 < 
es1
->
es_lblk
)

933 
node
 =Çode->
rb_À·
;

934 i‡(
lblk
 > 
	`pxt4_es_íd
(
es1
))

935 
node
 =Çode->
rb_right
;

937 
found
 = 1;

942 
out
:

943 
°©s
 = &
	`PXT4_SB
(
öode
->
i_sb
)->
s_es_°©s
;

944 i‡(
found
) {

945 
	`BUG_ON
(!
es1
);

946 
es
->
es_lblk
 = 
es1
->es_lblk;

947 
es
->
es_Àn
 = 
es1
->es_len;

948 
es
->
es_pblk
 = 
es1
->es_pblk;

949 i‡(!
	`pxt4_es_is_ª„ªn˚d
(
es1
))

950 
	`pxt4_es_£t_ª„ªn˚d
(
es1
);

951 
	`≥r˝u_cou¡î_öc
(&
°©s
->
es_°©s_ˇche_hôs
);

952 i‡(
√xt_lblk
) {

953 
node
 = 
	`rb_√xt
(&
es1
->
rb_node
);

954 i‡(
node
) {

955 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
,

956 
rb_node
);

957 *
√xt_lblk
 = 
es1
->
es_lblk
;

959 *
√xt_lblk
 = 0;

962 
	`≥r˝u_cou¡î_öc
(&
°©s
->
es_°©s_ˇche_mis£s
);

965 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

967 
	`åa˚_pxt4_es_lookup_exã¡_exô
(
öode
, 
es
, 
found
);

968  
found
;

969 
	}
}

971 
	srsvd_cou¡
 {

972 
	mndñ⁄ly
;

973 
boﬁ
 
	mfú°_do_lblk_found
;

974 
pxt4_lblk_t
 
	mfú°_do_lblk
;

975 
pxt4_lblk_t
 
	mœ°_do_lblk
;

976 
exã¡_°©us
 *
	mÀ·_es
;

977 
boﬁ
 
	m∑πül
;

978 
pxt4_lblk_t
 
	ml˛u
;

992 
	$öô_rsvd
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

993 
exã¡_°©us
 *
es
, 
rsvd_cou¡
 *
rc
)

995 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

996 
rb_node
 *
node
;

998 
rc
->
ndñ⁄ly
 = 0;

1006 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

1007 
rc
->
fú°_do_lblk_found
 = 
Ál£
;

1008 i‡(
lblk
 > 
es
->
es_lblk
) {

1009 
rc
->
À·_es
 = 
es
;

1011 
node
 = 
	`rb_¥ev
(&
es
->
rb_node
);

1012 
rc
->
À·_es
 = 
node
 ? 
	`rb_íåy
(node,

1013 
exã¡_°©us
,

1014 
rb_node
Ë: 
NULL
;

1016 
rc
->
∑πül
 = 
Ál£
;

1018 
	}
}

1034 
	$cou¡_rsvd
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
, 
Àn
,

1035 
exã¡_°©us
 *
es
, 
rsvd_cou¡
 *
rc
)

1037 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1038 
pxt4_lblk_t
 
i
, 
íd
, 
n˛u
;

1040 i‡(!
	`pxt4_es_is_dñ⁄ly
(
es
))

1043 
	`WARN_ON
(
Àn
 <= 0);

1045 i‡(
sbi
->
s_˛u°î_øtio
 == 1) {

1046 
rc
->
ndñ⁄ly
 +(Ë
Àn
;

1052 
i
 = (
lblk
 < 
es
->
es_lblk
) ?És->es_lblk :Üblk;

1053 
íd
 = 
lblk
 + (
pxt4_lblk_t
Ë
Àn
 - 1;

1054 
íd
 = (íd > 
	`pxt4_es_íd
(
es
)) ?Öxt4_es_end(es) :Énd;

1057 i‡(
rc
->
fú°_do_lblk_found
 =
Ál£
) {

1058 
rc
->
fú°_do_lblk
 = 
i
;

1059 
rc
->
fú°_do_lblk_found
 = 
åue
;

1063 
rc
->
œ°_do_lblk
 = 
íd
;

1069 i‡(
rc
->
∑πül
 && (rc->
l˛u
 !
	`PXT4_B2C
(
sbi
, 
i
))) {

1070 
rc
->
ndñ⁄ly
++;

1071 
rc
->
∑πül
 = 
Ál£
;

1078 i‡(
	`PXT4_LBLK_COFF
(
sbi
, 
i
) != 0) {

1079 i‡(
íd
 >
	`PXT4_LBLK_CFILL
(
sbi
, 
i
)) {

1080 
rc
->
ndñ⁄ly
++;

1081 
rc
->
∑πül
 = 
Ál£
;

1082 
i
 = 
	`PXT4_LBLK_CFILL
(
sbi
, i) + 1;

1090 i‡((
i
 + 
sbi
->
s_˛u°î_øtio
 - 1Ë<
íd
) {

1091 
n˛u
 = (
íd
 - 
i
 + 1Ë>> 
sbi
->
s_˛u°î_bôs
;

1092 
rc
->
ndñ⁄ly
 +
n˛u
;

1093 
i
 +
n˛u
 << 
sbi
->
s_˛u°î_bôs
;

1100 i‡(!
rc
->
∑πül
 && 
i
 <
íd
) {

1101 
rc
->
∑πül
 = 
åue
;

1102 
rc
->
l˛u
 = 
	`PXT4_B2C
(
sbi
, 
i
);

1104 
	}
}

1116 
≥ndög_ª£rv©i⁄
 *
	$__¥_åì_£¨ch
(
rb_roŸ
 *
roŸ
,

1117 
pxt4_lblk_t
 
l˛u
)

1119 
rb_node
 *
node
 = 
roŸ
->rb_node;

1120 
≥ndög_ª£rv©i⁄
 *
¥
 = 
NULL
;

1122 
node
) {

1123 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1124 i‡(
l˛u
 < 
¥
->lclu)

1125 
node
 =Çode->
rb_À·
;

1126 i‡(
l˛u
 > 
¥
->lclu)

1127 
node
 =Çode->
rb_right
;

1129  
¥
;

1131 i‡(
¥
 && 
l˛u
 <Ör->lclu)

1132  
¥
;

1133 i‡(
¥
 && 
l˛u
 >Ör->lclu) {

1134 
node
 = 
	`rb_√xt
(&
¥
->
rb_node
);

1135  
node
 ? 
	`rb_íåy
“ode, 
≥ndög_ª£rv©i⁄
,

1136 
rb_node
Ë: 
NULL
;

1138  
NULL
;

1139 
	}
}

1157 
	$gë_rsvd
(
öode
 *öode, 
pxt4_lblk_t
 
íd
,

1158 
exã¡_°©us
 *
right_es
,

1159 
rsvd_cou¡
 *
rc
)

1161 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1162 
≥ndög_ª£rv©i⁄
 *
¥
;

1163 
pxt4_≥ndög_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1164 
rb_node
 *
node
;

1165 
pxt4_lblk_t
 
fú°_l˛u
, 
œ°_l˛u
;

1166 
boﬁ
 
À·_dñ⁄ly
, 
right_dñ⁄ly
, 
cou¡_≥ndög
;

1167 
exã¡_°©us
 *
es
;

1169 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

1171 i‡(
rc
->
∑πül
)

1172 
rc
->
ndñ⁄ly
++;

1174 i‡(
rc
->
ndñ⁄ly
 == 0)

1177 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
rc
->
fú°_do_lblk
);

1178 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
rc
->
œ°_do_lblk
);

1185 
À·_dñ⁄ly
 = 
right_dñ⁄ly
 = 
Ál£
;

1187 
es
 = 
rc
->
À·_es
;

1188 
es
 && 
	`pxt4_es_íd
(es) >=

1189 
	`PXT4_LBLK_CMASK
(
sbi
, 
rc
->
fú°_do_lblk
)) {

1190 i‡(
	`pxt4_es_is_dñ⁄ly
(
es
)) {

1191 
rc
->
ndñ⁄ly
--;

1192 
À·_dñ⁄ly
 = 
åue
;

1195 
node
 = 
	`rb_¥ev
(&
es
->
rb_node
);

1196 i‡(!
node
)

1198 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1200 i‡(
right_es
 && (!
À·_dñ⁄ly
 || 
fú°_l˛u
 !
œ°_l˛u
)) {

1201 i‡(
íd
 < 
	`pxt4_es_íd
(
right_es
)) {

1202 
es
 = 
right_es
;

1204 
node
 = 
	`rb_√xt
(&
right_es
->
rb_node
);

1205 
es
 = 
node
 ? 
	`rb_íåy
“ode, 
exã¡_°©us
,

1206 
rb_node
Ë: 
NULL
;

1208 
es
 &&És->
es_lblk
 <=

1209 
	`PXT4_LBLK_CFILL
(
sbi
, 
rc
->
œ°_do_lblk
)) {

1210 i‡(
	`pxt4_es_is_dñ⁄ly
(
es
)) {

1211 
rc
->
ndñ⁄ly
--;

1212 
right_dñ⁄ly
 = 
åue
;

1215 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1216 i‡(!
node
)

1218 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
,

1219 
rb_node
);

1232 i‡(
fú°_l˛u
 =
œ°_l˛u
) {

1233 i‡(
À·_dñ⁄ly
 | 
right_dñ⁄ly
)

1234 
cou¡_≥ndög
 = 
Ál£
;

1236 
cou¡_≥ndög
 = 
åue
;

1238 i‡(
À·_dñ⁄ly
)

1239 
fú°_l˛u
++;

1240 i‡(
right_dñ⁄ly
)

1241 
œ°_l˛u
--;

1242 i‡(
fú°_l˛u
 <
œ°_l˛u
)

1243 
cou¡_≥ndög
 = 
åue
;

1245 
cou¡_≥ndög
 = 
Ál£
;

1254 i‡(
cou¡_≥ndög
) {

1255 
¥
 = 
	`__¥_åì_£¨ch
(&
åì
->
roŸ
, 
fú°_l˛u
);

1256 
¥
 &&Ör->
l˛u
 <
œ°_l˛u
) {

1257 
rc
->
ndñ⁄ly
--;

1258 
node
 = 
	`rb_√xt
(&
¥
->
rb_node
);

1259 
	`rb_îa£
(&
¥
->
rb_node
, &
åì
->
roŸ
);

1260 
	`kmem_ˇche_‰ì
(
pxt4_≥ndög_ˇchï
, 
¥
);

1261 i‡(!
node
)

1263 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
,

1264 
rb_node
);

1268  
rc
->
ndñ⁄ly
;

1269 
	}
}

1285 
	$__es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1286 
pxt4_lblk_t
 
íd
, *
ª£rved
)

1288 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

1289 
rb_node
 *
node
;

1290 
exã¡_°©us
 *
es
;

1291 
exã¡_°©us
 
‹ig_es
;

1292 
pxt4_lblk_t
 
Àn1
, 
Àn2
;

1293 
pxt4_fsblk_t
 
block
;

1294 
îr
;

1295 
boﬁ
 
cou¡_ª£rved
 = 
åue
;

1296 
rsvd_cou¡
 
rc
;

1298 i‡(
ª£rved
 =
NULL
 || !
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

1299 
cou¡_ª£rved
 = 
Ál£
;

1300 
ªåy
:

1301 
îr
 = 0;

1303 
es
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
lblk
);

1304 i‡(!
es
)

1305 
out
;

1306 i‡(
es
->
es_lblk
 > 
íd
)

1307 
out
;

1310 
åì
->
ˇche_es
 = 
NULL
;

1311 i‡(
cou¡_ª£rved
)

1312 
	`öô_rsvd
(
öode
, 
lblk
, 
es
, &
rc
);

1314 
‹ig_es
.
es_lblk
 = 
es
->es_lblk;

1315 
‹ig_es
.
es_Àn
 = 
es
->es_len;

1316 
‹ig_es
.
es_pblk
 = 
es
->es_pblk;

1318 
Àn1
 = 
lblk
 > 
es
->
es_lblk
 ?Üblk -És->es_lblk : 0;

1319 
Àn2
 = 
	`pxt4_es_íd
(
es
Ë> 
íd
 ?Öxt4_es_end(es) -Énd : 0;

1320 i‡(
Àn1
 > 0)

1321 
es
->
es_Àn
 = 
Àn1
;

1322 i‡(
Àn2
 > 0) {

1323 i‡(
Àn1
 > 0) {

1324 
exã¡_°©us
 
√wes
;

1326 
√wes
.
es_lblk
 = 
íd
 + 1;

1327 
√wes
.
es_Àn
 = 
Àn2
;

1328 
block
 = 0x7FDEADBEEFULL;

1329 i‡(
	`pxt4_es_is_wrôãn
(&
‹ig_es
) ||

1330 
	`pxt4_es_is_unwrôãn
(&
‹ig_es
))

1331 
block
 = 
	`pxt4_es_pblock
(&
‹ig_es
) +

1332 
‹ig_es
.
es_Àn
 - 
Àn2
;

1333 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, 
block
,

1334 
	`pxt4_es_°©us
(&
‹ig_es
));

1335 
îr
 = 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

1336 i‡(
îr
) {

1337 
es
->
es_lblk
 = 
‹ig_es
.es_lblk;

1338 
es
->
es_Àn
 = 
‹ig_es
.es_len;

1339 i‡((
îr
 =-
ENOMEM
) &&

1340 
	`__es_shrök
(
	`PXT4_SB
(
öode
->
i_sb
),

1341 128, 
	`PXT4_I
(
öode
)))

1342 
ªåy
;

1343 
out
;

1346 
es
->
es_lblk
 = 
íd
 + 1;

1347 
es
->
es_Àn
 = 
Àn2
;

1348 i‡(
	`pxt4_es_is_wrôãn
(
es
) ||

1349 
	`pxt4_es_is_unwrôãn
(
es
)) {

1350 
block
 = 
‹ig_es
.
es_pblk
 + orig_es.
es_Àn
 - 
Àn2
;

1351 
	`pxt4_es_°‹e_pblock
(
es
, 
block
);

1354 i‡(
cou¡_ª£rved
)

1355 
	`cou¡_rsvd
(
öode
, 
lblk
, 
‹ig_es
.
es_Àn
 - 
Àn1
 - 
Àn2
,

1356 &
‹ig_es
, &
rc
);

1357 
out
;

1360 i‡(
Àn1
 > 0) {

1361 i‡(
cou¡_ª£rved
)

1362 
	`cou¡_rsvd
(
öode
, 
lblk
, 
‹ig_es
.
es_Àn
 - 
Àn1
,

1363 &
‹ig_es
, &
rc
);

1364 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1365 i‡(
node
)

1366 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1368 
es
 = 
NULL
;

1371 
es
 && 
	`pxt4_es_íd
”sË<
íd
) {

1372 i‡(
cou¡_ª£rved
)

1373 
	`cou¡_rsvd
(
öode
, 
es
->
es_lblk
,És->
es_Àn
,És, &
rc
);

1374 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1375 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

1376 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

1377 i‡(!
node
) {

1378 
es
 = 
NULL
;

1381 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1384 i‡(
es
 &&És->
es_lblk
 < 
íd
 + 1) {

1385 
pxt4_lblk_t
 
‹ig_Àn
 = 
es
->
es_Àn
;

1387 
Àn1
 = 
	`pxt4_es_íd
(
es
Ë- 
íd
;

1388 i‡(
cou¡_ª£rved
)

1389 
	`cou¡_rsvd
(
öode
, 
es
->
es_lblk
, 
‹ig_Àn
 - 
Àn1
,

1390 
es
, &
rc
);

1391 
es
->
es_lblk
 = 
íd
 + 1;

1392 
es
->
es_Àn
 = 
Àn1
;

1393 i‡(
	`pxt4_es_is_wrôãn
(
es
Ë|| 
	`pxt4_es_is_unwrôãn
(es)) {

1394 
block
 = 
es
->
es_pblk
 + 
‹ig_Àn
 - 
Àn1
;

1395 
	`pxt4_es_°‹e_pblock
(
es
, 
block
);

1399 i‡(
cou¡_ª£rved
)

1400 *
ª£rved
 = 
	`gë_rsvd
(
öode
, 
íd
, 
es
, &
rc
);

1401 
out
:

1402  
îr
;

1403 
	}
}

1415 
	$pxt4_es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1416 
pxt4_lblk_t
 
Àn
)

1418 
pxt4_lblk_t
 
íd
;

1419 
îr
 = 0;

1420 
ª£rved
 = 0;

1422 
	`åa˚_pxt4_es_ªmove_exã¡
(
öode
, 
lblk
, 
Àn
);

1423 
	`es_debug
("remove [%u/%u) fromÉxtent statusÅree of inode %lu\n",

1424 
lblk
, 
Àn
, 
öode
->
i_öo
);

1426 i‡(!
Àn
)

1427  
îr
;

1429 
íd
 = 
lblk
 + 
Àn
 - 1;

1430 
	`BUG_ON
(
íd
 < 
lblk
);

1437 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1438 
îr
 = 
	`__es_ªmove_exã¡
(
öode
, 
lblk
, 
íd
, &
ª£rved
);

1439 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1440 
	`pxt4_es_¥öt_åì
(
öode
);

1441 
	`pxt4_da_ªÀa£_•a˚
(
öode
, 
ª£rved
);

1442  
îr
;

1443 
	}
}

1445 
	$__es_shrök
(
pxt4_sb_öfo
 *
sbi
, 
ƒ_to_sˇn
,

1446 
pxt4_öode_öfo
 *
locked_ei
)

1448 
pxt4_öode_öfo
 *
ei
;

1449 
pxt4_es_°©s
 *
es_°©s
;

1450 
ktime_t
 
°¨t_time
;

1451 
u64
 
sˇn_time
;

1452 
ƒ_to_wÆk
;

1453 
ƒ_shrunk
 = 0;

1454 
ªåõd
 = 0, 
ƒ_skù≥d
 = 0;

1456 
es_°©s
 = &
sbi
->
s_es_°©s
;

1457 
°¨t_time
 = 
	`ktime_gë
();

1459 
ªåy
:

1460 
	`•ö_lock
(&
sbi
->
s_es_lock
);

1461 
ƒ_to_wÆk
 = 
sbi
->
s_es_ƒ_öode
;

1462 
ƒ_to_wÆk
-- > 0) {

1463 i‡(
	`li°_em±y
(&
sbi
->
s_es_li°
)) {

1464 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1465 
out
;

1467 
ei
 = 
	`li°_fú°_íåy
(&
sbi
->
s_es_li°
, 
pxt4_öode_öfo
,

1468 
i_es_li°
);

1470 
	`li°_move_èû
(&
ei
->
i_es_li°
, &
sbi
->
s_es_li°
);

1476 i‡(!
ªåõd
 && 
	`pxt4_ã°_öode_°©e
(&
ei
->
vfs_öode
,

1477 
PXT4_STATE_EXT_PRECACHED
)) {

1478 
ƒ_skù≥d
++;

1482 i‡(
ei
 =
locked_ei
 || !
	`wrôe_åylock
(&ei->
i_es_lock
)) {

1483 
ƒ_skù≥d
++;

1490 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1492 
ƒ_shrunk
 +
	`es_ª˛aim_exã¡s
(
ei
, &
ƒ_to_sˇn
);

1493 
	`wrôe_u∆ock
(&
ei
->
i_es_lock
);

1495 i‡(
ƒ_to_sˇn
 <= 0)

1496 
out
;

1497 
	`•ö_lock
(&
sbi
->
s_es_lock
);

1499 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1505 i‡((
ƒ_shrunk
 =0Ë&& 
ƒ_skù≥d
 && !
ªåõd
) {

1506 
ªåõd
++;

1507 
ªåy
;

1510 i‡(
locked_ei
 && 
ƒ_shrunk
 == 0)

1511 
ƒ_shrunk
 = 
	`es_ª˛aim_exã¡s
(
locked_ei
, &
ƒ_to_sˇn
);

1513 
out
:

1514 
sˇn_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_gë
(), 
°¨t_time
));

1515 i‡(
	`likñy
(
es_°©s
->
es_°©s_sˇn_time
))

1516 
es_°©s
->
es_°©s_sˇn_time
 = (
sˇn_time
 +

1517 
es_°©s
->
es_°©s_sˇn_time
*3) / 4;

1519 
es_°©s
->
es_°©s_sˇn_time
 = 
sˇn_time
;

1520 i‡(
sˇn_time
 > 
es_°©s
->
es_°©s_max_sˇn_time
)

1521 
es_°©s
->
es_°©s_max_sˇn_time
 = 
sˇn_time
;

1522 i‡(
	`likñy
(
es_°©s
->
es_°©s_shrunk
))

1523 
es_°©s
->
es_°©s_shrunk
 = (
ƒ_shrunk
 +

1524 
es_°©s
->
es_°©s_shrunk
*3) / 4;

1526 
es_°©s
->
es_°©s_shrunk
 = 
ƒ_shrunk
;

1528 
	`åa˚_pxt4_es_shrök
(
sbi
->
s_sb
, 
ƒ_shrunk
, 
sˇn_time
,

1529 
ƒ_skù≥d
, 
ªåõd
);

1530  
ƒ_shrunk
;

1531 
	}
}

1533 
	$pxt4_es_cou¡
(
shrökî
 *
shrök
,

1534 
shrök_c⁄åﬁ
 *
sc
)

1536 
ƒ
;

1537 
pxt4_sb_öfo
 *
sbi
;

1539 
sbi
 = 
	`c⁄èöî_of
(
shrök
, 
pxt4_sb_öfo
, 
s_es_shrökî
);

1540 
ƒ
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1541 
	`åa˚_pxt4_es_shrök_cou¡
(
sbi
->
s_sb
, 
sc
->
ƒ_to_sˇn
, 
ƒ
);

1542  
ƒ
;

1543 
	}
}

1545 
	$pxt4_es_sˇn
(
shrökî
 *
shrök
,

1546 
shrök_c⁄åﬁ
 *
sc
)

1548 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
shrök
,

1549 
pxt4_sb_öfo
, 
s_es_shrökî
);

1550 
ƒ_to_sˇn
 = 
sc
->nr_to_scan;

1551 
ªt
, 
ƒ_shrunk
;

1553 
ªt
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1554 
	`åa˚_pxt4_es_shrök_sˇn_íãr
(
sbi
->
s_sb
, 
ƒ_to_sˇn
, 
ªt
);

1556 i‡(!
ƒ_to_sˇn
)

1557  
ªt
;

1559 
ƒ_shrunk
 = 
	`__es_shrök
(
sbi
, 
ƒ_to_sˇn
, 
NULL
);

1561 
	`åa˚_pxt4_es_shrök_sˇn_exô
(
sbi
->
s_sb
, 
ƒ_shrunk
, 
ªt
);

1562  
ƒ_shrunk
;

1563 
	}
}

1565 
	$pxt4_£q_es_shrökî_öfo_show
(
£q_fûe
 *
£q
, *
v
)

1567 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
((
su≥r_block
 *Ë
£q
->
¥iv©e
);

1568 
pxt4_es_°©s
 *
es_°©s
 = &
sbi
->
s_es_°©s
;

1569 
pxt4_öode_öfo
 *
ei
, *
max
 = 
NULL
;

1570 
öode_˙t
 = 0;

1572 i‡(
v
 !
SEQ_START_TOKEN
)

1576 
	`•ö_lock
(&
sbi
->
s_es_lock
);

1577 
	`li°_f‹_óch_íåy
(
ei
, &
sbi
->
s_es_li°
, 
i_es_li°
) {

1578 
öode_˙t
++;

1579 i‡(
max
 && max->
i_es_Æl_ƒ
 < 
ei
->i_es_all_nr)

1580 
max
 = 
ei
;

1581 i‡(!
max
)

1582 
max
 = 
ei
;

1584 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1586 
	`£q_¥ötf
(
£q
, "stats:\n %lld objects\n %lldÑeclaimable objects\n",

1587 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_Æl_˙t
),

1588 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_shk_˙t
));

1589 
	`£q_¥ötf
(
£q
, " %lld/%lld cache hits/misses\n",

1590 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_ˇche_hôs
),

1591 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_ˇche_mis£s
));

1592 i‡(
öode_˙t
)

1593 
	`£q_¥ötf
(
£q
, " %d inode†⁄Üi°\n", 
öode_˙t
);

1595 
	`£q_¥ötf
(
£q
, "average:\n %llu us scanÅime\n",

1596 
	`div_u64
(
es_°©s
->
es_°©s_sˇn_time
, 1000));

1597 
	`£q_¥ötf
(
£q
, " %lu shrunk obje˘s\n", 
es_°©s
->
es_°©s_shrunk
);

1598 i‡(
öode_˙t
)

1599 
	`£q_¥ötf
(
£q
,

1602 
max
->
vfs_öode
.
i_öo
, max->
i_es_Æl_ƒ
, max->
i_es_shk_ƒ
,

1603 
	`div_u64
(
es_°©s
->
es_°©s_max_sˇn_time
, 1000));

1606 
	}
}

1608 
	$pxt4_es_ªgi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
)

1610 
îr
;

1613 
	`BUILD_BUG_ON
(
ES_SHIFT
 < 48);

1614 
	`INIT_LIST_HEAD
(&
sbi
->
s_es_li°
);

1615 
sbi
->
s_es_ƒ_öode
 = 0;

1616 
	`•ö_lock_öô
(&
sbi
->
s_es_lock
);

1617 
sbi
->
s_es_°©s
.
es_°©s_shrunk
 = 0;

1618 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_hôs
, 0,

1619 
GFP_KERNEL
);

1620 i‡(
îr
)

1621  
îr
;

1622 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_mis£s
, 0,

1623 
GFP_KERNEL
);

1624 i‡(
îr
)

1625 
îr1
;

1626 
sbi
->
s_es_°©s
.
es_°©s_sˇn_time
 = 0;

1627 
sbi
->
s_es_°©s
.
es_°©s_max_sˇn_time
 = 0;

1628 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_Æl_˙t
, 0, 
GFP_KERNEL
);

1629 i‡(
îr
)

1630 
îr2
;

1631 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
, 0, 
GFP_KERNEL
);

1632 i‡(
îr
)

1633 
îr3
;

1635 
sbi
->
s_es_shrökî
.
sˇn_obje˘s
 = 
pxt4_es_sˇn
;

1636 
sbi
->
s_es_shrökî
.
cou¡_obje˘s
 = 
pxt4_es_cou¡
;

1637 
sbi
->
s_es_shrökî
.
£eks
 = 
DEFAULT_SEEKS
;

1638 
îr
 = 
	`ªgi°î_shrökî
(&
sbi
->
s_es_shrökî
);

1639 i‡(
îr
)

1640 
îr4
;

1643 
îr4
:

1644 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1645 
îr3
:

1646 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_Æl_˙t
);

1647 
îr2
:

1648 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_mis£s
);

1649 
îr1
:

1650 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_hôs
);

1651  
îr
;

1652 
	}
}

1654 
	$pxt4_es_uƒegi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
)

1656 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_hôs
);

1657 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_mis£s
);

1658 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_Æl_˙t
);

1659 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1660 
	`uƒegi°î_shrökî
(&
sbi
->
s_es_shrökî
);

1661 
	}
}

1671 
	$es_do_ª˛aim_exã¡s
(
pxt4_öode_öfo
 *
ei
, 
pxt4_lblk_t
 
íd
,

1672 *
ƒ_to_sˇn
, *
ƒ_shrunk
)

1674 
öode
 *öodê&
ei
->
vfs_öode
;

1675 
pxt4_es_åì
 *
åì
 = &
ei
->
i_es_åì
;

1676 
exã¡_°©us
 *
es
;

1677 
rb_node
 *
node
;

1679 
es
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
ei
->
i_es_shrök_lblk
);

1680 i‡(!
es
)

1681 
out_wøp
;

1683 *
ƒ_to_sˇn
 > 0) {

1684 i‡(
es
->
es_lblk
 > 
íd
) {

1685 
ei
->
i_es_shrök_lblk
 = 
íd
 + 1;

1689 (*
ƒ_to_sˇn
)--;

1690 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1695 i‡(
	`pxt4_es_is_dñayed
(
es
))

1696 
√xt
;

1697 i‡(
	`pxt4_es_is_ª„ªn˚d
(
es
)) {

1698 
	`pxt4_es_˛ór_ª„ªn˚d
(
es
);

1699 
√xt
;

1702 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

1703 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

1704 (*
ƒ_shrunk
)++;

1705 
√xt
:

1706 i‡(!
node
)

1707 
out_wøp
;

1708 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1710 
ei
->
i_es_shrök_lblk
 = 
es
->
es_lblk
;

1712 
out_wøp
:

1713 
ei
->
i_es_shrök_lblk
 = 0;

1715 
	}
}

1717 
	$es_ª˛aim_exã¡s
(
pxt4_öode_öfo
 *
ei
, *
ƒ_to_sˇn
)

1719 
öode
 *öodê&
ei
->
vfs_öode
;

1720 
ƒ_shrunk
 = 0;

1721 
pxt4_lblk_t
 
°¨t
 = 
ei
->
i_es_shrök_lblk
;

1722 
	`DEFINE_RATELIMIT_STATE
(
_rs
, 
DEFAULT_RATELIMIT_INTERVAL
,

1723 
DEFAULT_RATELIMIT_BURST
);

1725 i‡(
ei
->
i_es_shk_ƒ
 == 0)

1728 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
) &&

1729 
	`__øãlimô
(&
_rs
))

1730 
	`pxt4_w¨nög
(
öode
->
i_sb
, "forced shrink ofÖrecachedÉxtents");

1732 i‡(!
	`es_do_ª˛aim_exã¡s
(
ei
, 
EXT_MAX_BLOCKS
, 
ƒ_to_sˇn
, &
ƒ_shrunk
) &&

1733 
°¨t
 != 0)

1734 
	`es_do_ª˛aim_exã¡s
(
ei
, 
°¨t
 - 1, 
ƒ_to_sˇn
, &
ƒ_shrunk
);

1736 
ei
->
i_es_åì
.
ˇche_es
 = 
NULL
;

1737  
ƒ_shrunk
;

1738 
	}
}

1745 
	$pxt4_˛ór_öode_es
(
öode
 *inode)

1747 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1748 
exã¡_°©us
 *
es
;

1749 
pxt4_es_åì
 *
åì
;

1750 
rb_node
 *
node
;

1752 
	`wrôe_lock
(&
ei
->
i_es_lock
);

1753 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

1754 
åì
->
ˇche_es
 = 
NULL
;

1755 
node
 = 
	`rb_fú°
(&
åì
->
roŸ
);

1756 
node
) {

1757 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1758 
node
 = 
	`rb_√xt
(node);

1759 i‡(!
	`pxt4_es_is_dñayed
(
es
)) {

1760 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

1761 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

1764 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
);

1765 
	`wrôe_u∆ock
(&
ei
->
i_es_lock
);

1766 
	}
}

1768 #ifde‡
ES_DEBUG__


1769 
	$pxt4_¥öt_≥ndög_åì
(
öode
 *inode)

1771 
pxt4_≥ndög_åì
 *
åì
;

1772 
rb_node
 *
node
;

1773 
≥ndög_ª£rv©i⁄
 *
¥
;

1775 
	`¥ötk
(
KERN_DEBUG
 "≥ndögÑe£rv©i⁄†f‹ inodê%lu:", 
öode
->
i_öo
);

1776 
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1777 
node
 = 
	`rb_fú°
(&
åì
->
roŸ
);

1778 
node
) {

1779 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1780 
	`¥ötk
(
KERN_DEBUG
 " %u", 
¥
->
l˛u
);

1781 
node
 = 
	`rb_√xt
(node);

1783 
	`¥ötk
(
KERN_DEBUG
 "\n");

1784 
	}
}

1786 
	#pxt4_¥öt_≥ndög_åì
(
öode
)

	)

1789 
__öô
 
	$pxt4_öô_≥ndög
()

1791 
pxt4_≥ndög_ˇchï
 = 
	`kmem_ˇche_¸óã
("pxt4_pending_reservation",

1792 (
≥ndög_ª£rv©i⁄
),

1793 0, (
SLAB_RECLAIM_ACCOUNT
), 
NULL
);

1794 i‡(
pxt4_≥ndög_ˇchï
 =
NULL
)

1795  -
ENOMEM
;

1797 
	}
}

1799 
	$pxt4_exô_≥ndög
()

1801 
	`kmem_ˇche_de°roy
(
pxt4_≥ndög_ˇchï
);

1802 
	}
}

1804 
	$pxt4_öô_≥ndög_åì
(
pxt4_≥ndög_åì
 *
åì
)

1806 
åì
->
roŸ
 = 
RB_ROOT
;

1807 
	}
}

1818 
≥ndög_ª£rv©i⁄
 *
	$__gë_≥ndög
(
öode
 *inode,

1819 
pxt4_lblk_t
 
l˛u
)

1821 
pxt4_≥ndög_åì
 *
åì
;

1822 
rb_node
 *
node
;

1823 
≥ndög_ª£rv©i⁄
 *
¥
 = 
NULL
;

1825 
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1826 
node
 = (&
åì
->
roŸ
)->
rb_node
;

1828 
node
) {

1829 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1830 i‡(
l˛u
 < 
¥
->lclu)

1831 
node
 =Çode->
rb_À·
;

1832 i‡(
l˛u
 > 
¥
->lclu)

1833 
node
 =Çode->
rb_right
;

1834 i‡(
l˛u
 =
¥
->lclu)

1835  
¥
;

1837  
NULL
;

1838 
	}
}

1850 
	$__ö£π_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1852 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1853 
pxt4_≥ndög_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1854 
rb_node
 **
p
 = &
åì
->
roŸ
.rb_node;

1855 
rb_node
 *
∑ª¡
 = 
NULL
;

1856 
≥ndög_ª£rv©i⁄
 *
¥
;

1857 
pxt4_lblk_t
 
l˛u
;

1858 
ªt
 = 0;

1860 
l˛u
 = 
	`PXT4_B2C
(
sbi
, 
lblk
);

1862 *
p
) {

1863 
∑ª¡
 = *
p
;

1864 
¥
 = 
	`rb_íåy
(
∑ª¡
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1866 i‡(
l˛u
 < 
¥
->lclu) {

1867 
p
 = &(*p)->
rb_À·
;

1868 } i‡(
l˛u
 > 
¥
->lclu) {

1869 
p
 = &(*p)->
rb_right
;

1872 
out
;

1876 
¥
 = 
	`kmem_ˇche_Æloc
(
pxt4_≥ndög_ˇchï
, 
GFP_ATOMIC
);

1877 i‡(
¥
 =
NULL
) {

1878 
ªt
 = -
ENOMEM
;

1879 
out
;

1881 
¥
->
l˛u
 =Üclu;

1883 
	`rb_lök_node
(&
¥
->
rb_node
, 
∑ª¡
, 
p
);

1884 
	`rb_ö£π_cﬁ‹
(&
¥
->
rb_node
, &
åì
->
roŸ
);

1886 
out
:

1887  
ªt
;

1888 
	}
}

1899 
	$__ªmove_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1901 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1902 
≥ndög_ª£rv©i⁄
 *
¥
;

1903 
pxt4_≥ndög_åì
 *
åì
;

1905 
¥
 = 
	`__gë_≥ndög
(
öode
, 
	`PXT4_B2C
(
sbi
, 
lblk
));

1906 i‡(
¥
 !
NULL
) {

1907 
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1908 
	`rb_îa£
(&
¥
->
rb_node
, &
åì
->
roŸ
);

1909 
	`kmem_ˇche_‰ì
(
pxt4_≥ndög_ˇchï
, 
¥
);

1911 
	}
}

1922 
	$pxt4_ªmove_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1924 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1926 
	`wrôe_lock
(&
ei
->
i_es_lock
);

1927 
	`__ªmove_≥ndög
(
öode
, 
lblk
);

1928 
	`wrôe_u∆ock
(&
ei
->
i_es_lock
);

1929 
	}
}

1941 
boﬁ
 
	$pxt4_is_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1943 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1944 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1945 
boﬁ
 
ªt
;

1947 
	`ªad_lock
(&
ei
->
i_es_lock
);

1948 
ªt
 = (
boﬁ
)(
	`__gë_≥ndög
(
öode
, 
	`PXT4_B2C
(
sbi
, 
lblk
)Ë!
NULL
);

1949 
	`ªad_u∆ock
(&
ei
->
i_es_lock
);

1951  
ªt
;

1952 
	}
}

1966 
	$pxt4_es_ö£π_dñayed_block
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1967 
boﬁ
 
Æloˇãd
)

1969 
exã¡_°©us
 
√wes
;

1970 
îr
 = 0;

1972 
	`es_debug
("add [%u/1) delayedÅoÉxtent statusÅree of inode %lu\n",

1973 
lblk
, 
öode
->
i_öo
);

1975 
√wes
.
es_lblk
 = 
lblk
;

1976 
√wes
.
es_Àn
 = 1;

1977 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, ~0, 
EXTENT_STATUS_DELAYED
);

1978 
	`åa˚_pxt4_es_ö£π_dñayed_block
(
öode
, &
√wes
, 
Æloˇãd
);

1980 
	`pxt4_es_ö£π_exã¡_check
(
öode
, &
√wes
);

1982 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1984 
îr
 = 
	`__es_ªmove_exã¡
(
öode
, 
lblk
,Üblk, 
NULL
);

1985 i‡(
îr
 != 0)

1986 
îr‹
;

1987 
ªåy
:

1988 
îr
 = 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

1989 i‡(
îr
 =-
ENOMEM
 && 
	`__es_shrök
(
	`PXT4_SB
(
öode
->
i_sb
),

1990 128, 
	`PXT4_I
(
öode
)))

1991 
ªåy
;

1992 i‡(
îr
 != 0)

1993 
îr‹
;

1995 i‡(
Æloˇãd
)

1996 
	`__ö£π_≥ndög
(
öode
, 
lblk
);

1998 
îr‹
:

1999 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

2001 
	`pxt4_es_¥öt_åì
(
öode
);

2002 
	`pxt4_¥öt_≥ndög_åì
(
öode
);

2004  
îr
;

2005 
	}
}

2020 
	$__es_dñayed_˛u
(
öode
 *öode, 
pxt4_lblk_t
 
°¨t
,

2021 
pxt4_lblk_t
 
íd
)

2023 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

2024 
exã¡_°©us
 *
es
;

2025 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2026 
rb_node
 *
node
;

2027 
pxt4_lblk_t
 
fú°_l˛u
, 
œ°_l˛u
;

2028 
œ°_cou¡ed_l˛u
;

2029 
n
 = 0;

2032 
œ°_cou¡ed_l˛u
 = ~0ULL;

2034 
es
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
°¨t
);

2036 
es
 && (es->
es_lblk
 <
íd
)) {

2037 i‡(
	`pxt4_es_is_dñ⁄ly
(
es
)) {

2038 i‡(
es
->
es_lblk
 <
°¨t
)

2039 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
°¨t
);

2041 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
es
->
es_lblk
);

2043 i‡(
	`pxt4_es_íd
(
es
Ë>
íd
)

2044 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
íd
);

2046 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
	`pxt4_es_íd
(
es
));

2048 i‡(
fú°_l˛u
 =
œ°_cou¡ed_l˛u
)

2049 
n
 +
œ°_l˛u
 - 
fú°_l˛u
;

2051 
n
 +
œ°_l˛u
 - 
fú°_l˛u
 + 1;

2052 
œ°_cou¡ed_l˛u
 = 
œ°_l˛u
;

2054 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

2055 i‡(!
node
)

2057 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

2060  
n
;

2061 
	}
}

2073 
	$pxt4_es_dñayed_˛u
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

2074 
pxt4_lblk_t
 
Àn
)

2076 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

2077 
pxt4_lblk_t
 
íd
;

2078 
n
;

2080 i‡(
Àn
 == 0)

2083 
íd
 = 
lblk
 + 
Àn
 - 1;

2084 
	`WARN_ON
(
íd
 < 
lblk
);

2086 
	`ªad_lock
(&
ei
->
i_es_lock
);

2088 
n
 = 
	`__es_dñayed_˛u
(
öode
, 
lblk
, 
íd
);

2090 
	`ªad_u∆ock
(&
ei
->
i_es_lock
);

2092  
n
;

2093 
	}
}

2110 
	$__ªvi£_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

2111 
pxt4_lblk_t
 
Àn
)

2113 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2114 
pxt4_lblk_t
 
íd
 = 
lblk
 + 
Àn
 - 1;

2115 
pxt4_lblk_t
 
fú°
, 
œ°
;

2116 
boﬁ
 
f_dñ
 = 
Ál£
, 
l_dñ
 = false;

2118 i‡(
Àn
 == 0)

2134 i‡(
	`PXT4_B2C
(
sbi
, 
lblk
Ë=PXT4_B2C(sbi, 
íd
)) {

2135 
fú°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
lblk
);

2136 i‡(
fú°
 !
lblk
)

2137 
f_dñ
 = 
	`__es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñ⁄ly
,

2138 
fú°
, 
lblk
 - 1);

2139 i‡(
f_dñ
) {

2140 
	`__ö£π_≥ndög
(
öode
, 
fú°
);

2142 
œ°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
íd
) +

2143 
sbi
->
s_˛u°î_øtio
 - 1;

2144 i‡(
œ°
 !
íd
)

2145 
l_dñ
 = 
	`__es_sˇn_ønge
(
öode
,

2146 &
pxt4_es_is_dñ⁄ly
,

2147 
íd
 + 1, 
œ°
);

2148 i‡(
l_dñ
)

2149 
	`__ö£π_≥ndög
(
öode
, 
œ°
);

2151 
	`__ªmove_≥ndög
(
öode
, 
œ°
);

2154 
fú°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
lblk
);

2155 i‡(
fú°
 !
lblk
)

2156 
f_dñ
 = 
	`__es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñ⁄ly
,

2157 
fú°
, 
lblk
 - 1);

2158 i‡(
f_dñ
)

2159 
	`__ö£π_≥ndög
(
öode
, 
fú°
);

2161 
	`__ªmove_≥ndög
(
öode
, 
fú°
);

2163 
œ°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
íd
Ë+ sbi->
s_˛u°î_øtio
 - 1;

2164 i‡(
œ°
 !
íd
)

2165 
l_dñ
 = 
	`__es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñ⁄ly
,

2166 
íd
 + 1, 
œ°
);

2167 i‡(
l_dñ
)

2168 
	`__ö£π_≥ndög
(
öode
, 
œ°
);

2170 
	`__ªmove_≥ndög
(
öode
, 
œ°
);

2172 
	}
}

	@extents_status.h

12 #i‚de‡
_PXT4_EXTENTS_STATUS_H


13 
	#_PXT4_EXTENTS_STATUS_H


	)

18 #ifde‡
ES_DEBUG__


19 
	#es_debug
(
fmt
, ...Ë
	`¥ötk
(fmt, ##
__VA_ARGS__
)

	)

21 
	#es_debug
(
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

28 
	#ES_AGGRESSIVE_TEST__


	)

34 
	mES_WRITTEN_B
,

35 
	mES_UNWRITTEN_B
,

36 
	mES_DELAYED_B
,

37 
	mES_HOLE_B
,

38 
	mES_REFERENCED_B
,

39 
	mES_FLAGS


42 
	#ES_SHIFT
 ((
pxt4_fsblk_t
)*8 - 
ES_FLAGS
)

	)

43 
	#ES_MASK
 (~((
pxt4_fsblk_t
)0Ë<< 
ES_SHIFT
)

	)

45 
	#EXTENT_STATUS_WRITTEN
 (1 << 
ES_WRITTEN_B
)

	)

46 
	#EXTENT_STATUS_UNWRITTEN
 (1 << 
ES_UNWRITTEN_B
)

	)

47 
	#EXTENT_STATUS_DELAYED
 (1 << 
ES_DELAYED_B
)

	)

48 
	#EXTENT_STATUS_HOLE
 (1 << 
ES_HOLE_B
)

	)

49 
	#EXTENT_STATUS_REFERENCED
 (1 << 
ES_REFERENCED_B
)

	)

51 
	#ES_TYPE_MASK
 ((
pxt4_fsblk_t
)(
EXTENT_STATUS_WRITTEN
 | \

52 
EXTENT_STATUS_UNWRITTEN
 | \

53 
EXTENT_STATUS_DELAYED
 | \

54 
EXTENT_STATUS_HOLE
Ë<< 
ES_SHIFT
)

	)

56 
	gpxt4_sb_öfo
;

57 
	gpxt4_exã¡
;

59 
	sexã¡_°©us
 {

60 
rb_node
 
	mrb_node
;

61 
pxt4_lblk_t
 
	mes_lblk
;

62 
pxt4_lblk_t
 
	mes_Àn
;

63 
pxt4_fsblk_t
 
	mes_pblk
;

66 
	spxt4_es_åì
 {

67 
rb_roŸ
 
	mroŸ
;

68 
exã¡_°©us
 *
	mˇche_es
;

71 
	spxt4_es_°©s
 {

72 
	mes_°©s_shrunk
;

73 
≥r˝u_cou¡î
 
	mes_°©s_ˇche_hôs
;

74 
≥r˝u_cou¡î
 
	mes_°©s_ˇche_mis£s
;

75 
u64
 
	mes_°©s_sˇn_time
;

76 
u64
 
	mes_°©s_max_sˇn_time
;

77 
≥r˝u_cou¡î
 
	mes_°©s_Æl_˙t
;

78 
≥r˝u_cou¡î
 
	mes_°©s_shk_˙t
;

117 
	s≥ndög_ª£rv©i⁄
 {

118 
rb_node
 
	mrb_node
;

119 
pxt4_lblk_t
 
	ml˛u
;

122 
	spxt4_≥ndög_åì
 {

123 
rb_roŸ
 
	mroŸ
;

126 
__öô
 
pxt4_öô_es
();

127 
pxt4_exô_es
();

128 
pxt4_es_öô_åì
(
pxt4_es_åì
 *
åì
);

130 
pxt4_es_ö£π_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

131 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

132 
°©us
);

133 
pxt4_es_ˇche_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

134 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

135 
°©us
);

136 
pxt4_es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

137 
pxt4_lblk_t
 
Àn
);

138 
pxt4_es_föd_exã¡_ønge
(
öode
 *inode,

139 (*
m©ch_‚
)(
exã¡_°©us
 *
es
),

140 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
,

141 
exã¡_°©us
 *
es
);

142 
	`pxt4_es_lookup_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

143 
pxt4_lblk_t
 *
√xt_lblk
,

144 
exã¡_°©us
 *
es
);

145 
boﬁ
 
	`pxt4_es_sˇn_ønge
(
öode
 *inode,

146 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

147 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
);

148 
boﬁ
 
	`pxt4_es_sˇn_˛u
(
öode
 *inode,

149 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

150 
pxt4_lblk_t
 
lblk
);

152 
ölöe
 
	$pxt4_es_°©us
(
exã¡_°©us
 *
es
)

154  
es
->
es_pblk
 >> 
ES_SHIFT
;

155 
	}
}

157 
ölöe
 
	$pxt4_es_ty≥
(
exã¡_°©us
 *
es
)

159  (
es
->
es_pblk
 & 
ES_TYPE_MASK
Ë>> 
ES_SHIFT
;

160 
	}
}

162 
ölöe
 
	$pxt4_es_is_wrôãn
(
exã¡_°©us
 *
es
)

164  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_WRITTEN
) != 0;

165 
	}
}

167 
ölöe
 
	$pxt4_es_is_unwrôãn
(
exã¡_°©us
 *
es
)

169  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_UNWRITTEN
) != 0;

170 
	}
}

172 
ölöe
 
	$pxt4_es_is_dñayed
(
exã¡_°©us
 *
es
)

174  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_DELAYED
) != 0;

175 
	}
}

177 
ölöe
 
	$pxt4_es_is_hﬁe
(
exã¡_°©us
 *
es
)

179  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_HOLE
) != 0;

180 
	}
}

182 
ölöe
 
	$pxt4_es_is_m≠≥d
(
exã¡_°©us
 *
es
)

184  (
	`pxt4_es_is_wrôãn
(
es
Ë|| 
	`pxt4_es_is_unwrôãn
(es));

185 
	}
}

187 
ölöe
 
	$pxt4_es_is_dñ⁄ly
(
exã¡_°©us
 *
es
)

189  (
	`pxt4_es_is_dñayed
(
es
Ë&& !
	`pxt4_es_is_unwrôãn
(es));

190 
	}
}

192 
ölöe
 
	$pxt4_es_£t_ª„ªn˚d
(
exã¡_°©us
 *
es
)

194 
es
->
es_pblk
 |((
pxt4_fsblk_t
)
EXTENT_STATUS_REFERENCED
Ë<< 
ES_SHIFT
;

195 
	}
}

197 
ölöe
 
	$pxt4_es_˛ór_ª„ªn˚d
(
exã¡_°©us
 *
es
)

199 
es
->
es_pblk
 &~(((
pxt4_fsblk_t
)
EXTENT_STATUS_REFERENCED
Ë<< 
ES_SHIFT
);

200 
	}
}

202 
ölöe
 
	$pxt4_es_is_ª„ªn˚d
(
exã¡_°©us
 *
es
)

204  (
	`pxt4_es_°©us
(
es
Ë& 
EXTENT_STATUS_REFERENCED
) != 0;

205 
	}
}

207 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_es_pblock
(
exã¡_°©us
 *
es
)

209  
es
->
es_pblk
 & ~
ES_MASK
;

210 
	}
}

212 
ölöe
 
	$pxt4_es_°‹e_pblock
(
exã¡_°©us
 *
es
,

213 
pxt4_fsblk_t
 
pb
)

215 
pxt4_fsblk_t
 
block
;

217 
block
 = (
pb
 & ~
ES_MASK
Ë| (
es
->
es_pblk
 & ES_MASK);

218 
es
->
es_pblk
 = 
block
;

219 
	}
}

221 
ölöe
 
	$pxt4_es_°‹e_°©us
(
exã¡_°©us
 *
es
,

222 
°©us
)

224 
es
->
es_pblk
 = (((
pxt4_fsblk_t
)
°©us
 << 
ES_SHIFT
Ë& 
ES_MASK
) |

225 (
es
->
es_pblk
 & ~
ES_MASK
);

226 
	}
}

228 
ölöe
 
	$pxt4_es_°‹e_pblock_°©us
(
exã¡_°©us
 *
es
,

229 
pxt4_fsblk_t
 
pb
,

230 
°©us
)

232 
es
->
es_pblk
 = (((
pxt4_fsblk_t
)
°©us
 << 
ES_SHIFT
Ë& 
ES_MASK
) |

233 (
pb
 & ~
ES_MASK
);

234 
	}
}

236 
pxt4_es_ªgi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
);

237 
pxt4_es_uƒegi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
);

239 
pxt4_£q_es_shrökî_öfo_show
(
£q_fûe
 *
£q
, *
v
);

241 
__öô
 
pxt4_öô_≥ndög
();

242 
pxt4_exô_≥ndög
();

243 
pxt4_öô_≥ndög_åì
(
pxt4_≥ndög_åì
 *
åì
);

244 
pxt4_ªmove_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
);

245 
boﬁ
 
pxt4_is_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
);

246 
pxt4_es_ö£π_dñayed_block
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

247 
boﬁ
 
Æloˇãd
);

248 
pxt4_es_dñayed_˛u
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

249 
pxt4_lblk_t
 
Àn
);

250 
pxt4_˛ór_öode_es
(
öode
 *inode);

	@file.c

22 
	~<löux/time.h
>

23 
	~<löux/fs.h
>

24 
	~<löux/iom≠.h
>

25 
	~<löux/mou¡.h
>

26 
	~<löux/∑th.h
>

27 
	~<löux/dax.h
>

28 
	~<löux/quŸa›s.h
>

29 
	~<löux/∑gevec.h
>

30 
	~<löux/uio.h
>

31 
	~<löux/mm™.h
>

32 
	~"pxt4.h
"

33 
	~"pxt4_jbd3.h
"

34 
	~"x©å.h
"

35 
	~"a˛.h
"

37 #ifde‡
CONFIG_FS_DAX


38 
ssize_t
 
	$pxt4_dax_ªad_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
to
)

40 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

41 
ssize_t
 
ªt
;

43 i‡(!
	`öode_åylock_sh¨ed
(
öode
)) {

44 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
)

45  -
EAGAIN
;

46 
	`öode_lock_sh¨ed
(
öode
);

52 i‡(!
	`IS_DAX
(
öode
)) {

53 
	`öode_u∆ock_sh¨ed
(
öode
);

55  
	`gíîic_fûe_ªad_ôî
(
iocb
, 
to
);

57 
ªt
 = 
	`dax_iom≠_rw
(
iocb
, 
to
, &
pxt4_iom≠_›s
);

58 
	`öode_u∆ock_sh¨ed
(
öode
);

60 
	`fûe_ac˚s£d
(
iocb
->
ki_fûp
);

61  
ªt
;

62 
	}
}

65 
ssize_t
 
	$pxt4_fûe_ªad_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
to
)

67 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
	`fûe_öode
(
iocb
->
ki_fûp
)->
i_sb
))))

68  -
EIO
;

70 i‡(!
	`iov_ôî_cou¡
(
to
))

73 #ifde‡
CONFIG_FS_DAX


74 i‡(
	`IS_DAX
(
	`fûe_öode
(
iocb
->
ki_fûp
)))

75  
	`pxt4_dax_ªad_ôî
(
iocb
, 
to
);

77  
	`gíîic_fûe_ªad_ôî
(
iocb
, 
to
);

78 
	}
}

85 
	$pxt4_ªÀa£_fûe
(
öode
 *öode, 
fûe
 *
fûp
)

87 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
)) {

88 
	`pxt4_Æloc_da_blocks
(
öode
);

89 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
);

92 i‡((
fûp
->
f_mode
 & 
FMODE_WRITE
) &&

93 (
	`©omic_ªad
(&
öode
->
i_wrôecou¡
) == 1) &&

94 !
	`PXT4_I
(
öode
)->
i_ª£rved_d©a_blocks
)

96 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

97 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

98 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

100 i‡(
	`is_dx
(
öode
Ë&& 
fûp
->
¥iv©e_d©a
)

101 
	`pxt4_håì_‰ì_dú_öfo
(
fûp
->
¥iv©e_d©a
);

104 
	}
}

106 
	$pxt4_unwrôãn_waô
(
öode
 *inode)

108 
waô_queue_hód_t
 *
wq
 = 
	`pxt4_i€nd_wq
(
öode
);

110 
	`waô_evít
(*
wq
, (
	`©omic_ªad
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
) == 0));

111 
	}
}

123 
	$pxt4_u«lig√d_aio
(
öode
 *öode, 
iov_ôî
 *
‰om
, 
loff_t
 
pos
)

125 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

126 
blockmask
 = 
sb
->
s_blocksize
 - 1;

128 i‡(
pos
 >
	`ALIGN
(
	`i_size_ªad
(
öode
), 
sb
->
s_blocksize
))

131 i‡((
pos
 | 
	`iov_ôî_Æignmít
(
‰om
)Ë& 
blockmask
)

135 
	}
}

138 
boﬁ
 
	$pxt4_ovîwrôe_io
(
öode
 *öode, 
loff_t
 
pos
,Üoff_à
Àn
)

140 
pxt4_m≠_blocks
 
m≠
;

141 
blkbôs
 = 
öode
->
i_blkbôs
;

142 
îr
, 
blkÀn
;

144 i‡(
pos
 + 
Àn
 > 
	`i_size_ªad
(
öode
))

145  
Ál£
;

147 
m≠
.
m_lblk
 = 
pos
 >> 
blkbôs
;

148 
m≠
.
m_Àn
 = 
	`PXT4_MAX_BLOCKS
(
Àn
, 
pos
, 
blkbôs
);

149 
blkÀn
 = 
m≠
.
m_Àn
;

151 
îr
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

157  
îr
 =
blkÀn
 && (
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
);

158 
	}
}

160 
ssize_t
 
	$pxt4_wrôe_checks
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

162 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

163 
ssize_t
 
ªt
;

165 
ªt
 = 
	`gíîic_wrôe_checks
(
iocb
, 
‰om
);

166 i‡(
ªt
 <= 0)

167  
ªt
;

169 i‡(
	`u∆ikñy
(
	`IS_IMMUTABLE
(
öode
)))

170  -
EPERM
;

176 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

177 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

179 i‡(
iocb
->
ki_pos
 >
sbi
->
s_bôm≠_maxbyãs
)

180  -
EFBIG
;

181 
	`iov_ôî_åunˇã
(
‰om
, 
sbi
->
s_bôm≠_maxbyãs
 - 
iocb
->
ki_pos
);

183  
	`iov_ôî_cou¡
(
‰om
);

184 
	}
}

186 #ifde‡
CONFIG_FS_DAX


187 
ssize_t


188 
	$pxt4_dax_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

190 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

191 
ssize_t
 
ªt
;

193 i‡(!
	`öode_åylock
(
öode
)) {

194 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
)

195  -
EAGAIN
;

196 
	`öode_lock
(
öode
);

198 
ªt
 = 
	`pxt4_wrôe_checks
(
iocb
, 
‰om
);

199 i‡(
ªt
 <= 0)

200 
out
;

201 
ªt
 = 
	`fûe_ªmove_¥ivs
(
iocb
->
ki_fûp
);

202 i‡(
ªt
)

203 
out
;

204 
ªt
 = 
	`fûe_upd©e_time
(
iocb
->
ki_fûp
);

205 i‡(
ªt
)

206 
out
;

208 
ªt
 = 
	`dax_iom≠_rw
(
iocb
, 
‰om
, &
pxt4_iom≠_›s
);

209 
out
:

210 
	`öode_u∆ock
(
öode
);

211 i‡(
ªt
 > 0)

212 
ªt
 = 
	`gíîic_wrôe_sync
(
iocb
,Ñet);

213  
ªt
;

214 
	}
}

217 
ssize_t


218 
	$pxt4_fûe_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

220 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

221 
o_dúe˘
 = 
iocb
->
ki_Êags
 & 
IOCB_DIRECT
;

222 
u«lig√d_aio
 = 0;

223 
ovîwrôe
 = 0;

224 
ssize_t
 
ªt
;

226 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

227  -
EIO
;

229 #ifde‡
CONFIG_FS_DAX


230 i‡(
	`IS_DAX
(
öode
))

231  
	`pxt4_dax_wrôe_ôî
(
iocb
, 
‰om
);

234 i‡(!
	`öode_åylock
(
öode
)) {

235 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
)

236  -
EAGAIN
;

237 
	`öode_lock
(
öode
);

240 
ªt
 = 
	`pxt4_wrôe_checks
(
iocb
, 
‰om
);

241 i‡(
ªt
 <= 0)

242 
out
;

249 i‡(
o_dúe˘
 && 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
) &&

250 !
	`is_sync_kiocb
(
iocb
) &&

251 
	`pxt4_u«lig√d_aio
(
öode
, 
‰om
, 
iocb
->
ki_pos
)) {

252 
u«lig√d_aio
 = 1;

253 
	`pxt4_unwrôãn_waô
(
öode
);

256 
iocb
->
¥iv©e
 = &
ovîwrôe
;

258 i‡(
o_dúe˘
 && !
u«lig√d_aio
) {

259 i‡(
	`pxt4_ovîwrôe_io
(
öode
, 
iocb
->
ki_pos
, 
	`iov_ôî_cou¡
(
‰om
))) {

260 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

261 
ovîwrôe
 = 1;

262 } i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

263 
ªt
 = -
EAGAIN
;

264 
out
;

268 
ªt
 = 
	`__gíîic_fûe_wrôe_ôî
(
iocb
, 
‰om
);

274 i‡(
ªt
 =-
EIOCBQUEUED
 && 
u«lig√d_aio
)

275 
	`pxt4_unwrôãn_waô
(
öode
);

276 
	`öode_u∆ock
(
öode
);

278 i‡(
ªt
 > 0)

279 
ªt
 = 
	`gíîic_wrôe_sync
(
iocb
,Ñet);

281  
ªt
;

283 
out
:

284 
	`öode_u∆ock
(
öode
);

285  
ªt
;

286 
	}
}

288 #ifde‡
CONFIG_FS_DAX


289 
vm_Áu…_t
 
	$pxt4_dax_huge_Áu…
(
vm_Áu…
 *
vmf
,

290 
∑ge_íåy_size
 
≥_size
)

292 
îr‹
 = 0;

293 
vm_Áu…_t
 
ªsu…
;

294 
ªåõs
 = 0;

295 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

296 
öode
 *öodê
	`fûe_öode
(
vmf
->
vma
->
vm_fûe
);

297 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

310 
boﬁ
 
wrôe
 = (
vmf
->
Êags
 & 
FAULT_FLAG_WRITE
) &&

311 (
vmf
->
vma
->
vm_Êags
 & 
VM_SHARED
);

312 
p‚_t
 
p‚
;

314 i‡(
wrôe
) {

315 
	`sb_°¨t_∑geÁu…
(
sb
);

316 
	`fûe_upd©e_time
(
vmf
->
vma
->
vm_fûe
);

317 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

318 
ªåy
:

319 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_WRITE_PAGE
,

320 
	`PXT4_DATA_TRANS_BLOCKS
(
sb
));

321 i‡(
	`IS_ERR
(
h™dÀ
)) {

322 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

323 
	`sb_íd_∑geÁu…
(
sb
);

324  
VM_FAULT_SIGBUS
;

327 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

329 
ªsu…
 = 
	`dax_iom≠_Áu…
(
vmf
, 
≥_size
, &
p‚
, &
îr‹
, &
pxt4_iom≠_›s
);

330 i‡(
wrôe
) {

331 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

333 i‡((
ªsu…
 & 
VM_FAULT_ERROR
Ë&& 
îr‹
 =-
ENOSPC
 &&

334 
	`pxt4_should_ªåy_Æloc
(
sb
, &
ªåõs
))

335 
ªåy
;

337 i‡(
ªsu…
 & 
VM_FAULT_NEEDDSYNC
)

338 
ªsu…
 = 
	`dax_föish_sync_Áu…
(
vmf
, 
≥_size
, 
p‚
);

339 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

340 
	`sb_íd_∑geÁu…
(
sb
);

342 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

345  
ªsu…
;

346 
	}
}

348 
vm_Áu…_t
 
	$pxt4_dax_Áu…
(
vm_Áu…
 *
vmf
)

350  
	`pxt4_dax_huge_Áu…
(
vmf
, 
PE_SIZE_PTE
);

351 
	}
}

353 c⁄° 
vm_›î©i⁄s_°ru˘
 
	gpxt4_dax_vm_›s
 = {

354 .
Áu…
 = 
pxt4_dax_Áu…
,

355 .
	ghuge_Áu…
 = 
pxt4_dax_huge_Áu…
,

356 .
	g∑ge_mkwrôe
 = 
pxt4_dax_Áu…
,

357 .
	gp‚_mkwrôe
 = 
pxt4_dax_Áu…
,

360 
	#pxt4_dax_vm_›s
 
pxt4_fûe_vm_›s


	)

363 c⁄° 
vm_›î©i⁄s_°ru˘
 
	gpxt4_fûe_vm_›s
 = {

364 .
Áu…
 = 
pxt4_fûem≠_Áu…
,

365 .
	gm≠_∑ges
 = 
fûem≠_m≠_∑ges
,

366 .
	g∑ge_mkwrôe
 = 
pxt4_∑ge_mkwrôe
,

369 
	$pxt4_fûe_mm≠
(
fûe
 *fûe, 
vm_¨ó_°ru˘
 *
vma
)

371 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

372 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

373 
dax_devi˚
 *
dax_dev
 = 
sbi
->
s_daxdev
;

375 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
sbi
)))

376  -
EIO
;

382 i‡(!
	`daxdev_m≠pög_suµ‹ãd
(
vma
, 
dax_dev
))

383  -
EOPNOTSUPP
;

385 
	`fûe_ac˚s£d
(
fûe
);

386 i‡(
	`IS_DAX
(
	`fûe_öode
(
fûe
))) {

387 
vma
->
vm_›s
 = &
pxt4_dax_vm_›s
;

388 
vma
->
vm_Êags
 |
VM_HUGEPAGE
;

390 
vma
->
vm_›s
 = &
pxt4_fûe_vm_›s
;

393 
	}
}

395 
	$pxt4_ßm∂e_œ°_mou¡ed
(
su≥r_block
 *
sb
,

396 
vfsmou¡
 *
m¡
)

398 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

399 
∑th
Öath;

400 
buf
[64], *
˝
;

401 
h™dÀ_t
 *
h™dÀ
;

402 
îr
;

404 i‡(
	`likñy
(
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_MNTDIR_SAMPLED
))

407 i‡(
	`sb_rd⁄ly
(
sb
Ë|| !
	`sb_°¨t_ötwrôe_åylock
(sb))

410 
sbi
->
s_mou¡_Êags
 |
PXT4_MF_MNTDIR_SAMPLED
;

417 
	`mem£t
(
buf
, 0, (buf));

418 
∑th
.
m¡
 = mnt;

419 
∑th
.
díåy
 = 
m¡
->
m¡_roŸ
;

420 
˝
 = 
	`d_∑th
(&
∑th
, 
buf
, (buf));

421 
îr
 = 0;

422 i‡(
	`IS_ERR
(
˝
))

423 
out
;

425 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_MISC
, 1);

426 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

427 i‡(
	`IS_ERR
(
h™dÀ
))

428 
out
;

429 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

430 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

431 i‡(
îr
)

432 
out_jou∫Æ
;

433 
	`°æ˝y
(
sbi
->
s_es
->
s_œ°_mou¡ed
, 
˝
,

434 (
sbi
->
s_es
->
s_œ°_mou¡ed
));

435 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

436 
out_jou∫Æ
:

437 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

438 
out
:

439 
	`sb_íd_ötwrôe
(
sb
);

440  
îr
;

441 
	}
}

443 
	$pxt4_fûe_›í
(
öode
 * inode, 
fûe
 * 
fûp
)

445 
ªt
;

447 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

448  -
EIO
;

450 
ªt
 = 
	`pxt4_ßm∂e_œ°_mou¡ed
(
öode
->
i_sb
, 
fûp
->
f_∑th
.
m¡
);

451 i‡(
ªt
)

452  
ªt
;

454 
ªt
 = 
	`fs¸y±_fûe_›í
(
öode
, 
fûp
);

455 i‡(
ªt
)

456  
ªt
;

458 
ªt
 = 
	`fsvîôy_fûe_›í
(
öode
, 
fûp
);

459 i‡(
ªt
)

460  
ªt
;

466 i‡(
fûp
->
f_mode
 & 
FMODE_WRITE
) {

467 
ªt
 = 
	`pxt4_öode_©èch_jöode
(
öode
);

468 i‡(
ªt
 < 0)

469  
ªt
;

472 
fûp
->
f_mode
 |
FMODE_NOWAIT
;

473  
	`dquŸ_fûe_›í
(
öode
, 
fûp
);

474 
	}
}

481 
loff_t
 
	$pxt4_Œ£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
whí˚
)

483 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

484 
loff_t
 
maxbyãs
;

486 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

487 
maxbyãs
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_bôm≠_maxbyãs
;

489 
maxbyãs
 = 
öode
->
i_sb
->
s_maxbyãs
;

491 
whí˚
) {

493  
	`gíîic_fûe_Œ£ek_size
(
fûe
, 
off£t
, 
whí˚
,

494 
maxbyãs
, 
	`i_size_ªad
(
öode
));

495 
SEEK_HOLE
:

496 
	`öode_lock_sh¨ed
(
öode
);

497 
off£t
 = 
	`iom≠_£ek_hﬁe
(
öode
, off£t, &
pxt4_iom≠_›s
);

498 
	`öode_u∆ock_sh¨ed
(
öode
);

500 
SEEK_DATA
:

501 
	`öode_lock_sh¨ed
(
öode
);

502 
off£t
 = 
	`iom≠_£ek_d©a
(
öode
, off£t, &
pxt4_iom≠_›s
);

503 
	`öode_u∆ock_sh¨ed
(
öode
);

507 i‡(
off£t
 < 0)

508  
off£t
;

509  
	`vfs_£ços
(
fûe
, 
off£t
, 
maxbyãs
);

510 
	}
}

512 c⁄° 
fûe_›î©i⁄s
 
	gpxt4_fûe_›î©i⁄s
 = {

513 .
Œ£ek
 = 
pxt4_Œ£ek
,

514 .
	gªad_ôî
 = 
pxt4_fûe_ªad_ôî
,

515 .
	gwrôe_ôî
 = 
pxt4_fûe_wrôe_ôî
,

516 .
	gu∆ocked_io˘l
 = 
pxt4_io˘l
,

517 #ifde‡
CONFIG_COMPAT


518 .
	gcom∑t_io˘l
 = 
pxt4_com∑t_io˘l
,

520 .
	gmm≠
 = 
pxt4_fûe_mm≠
,

521 .
	gmm≠_suµ‹ãd_Êags
 = 
MAP_SYNC
,

522 .
	g›í
 = 
pxt4_fûe_›í
,

523 .
	gªÀa£
 = 
pxt4_ªÀa£_fûe
,

524 .
	gfsync
 = 
pxt4_sync_fûe
,

525 .
	ggë_unm≠≥d_¨ó
 = 
thp_gë_unm≠≥d_¨ó
,

526 .
	g•li˚_ªad
 = 
gíîic_fûe_•li˚_ªad
,

527 .
	g•li˚_wrôe
 = 
ôî_fûe_•li˚_wrôe
,

528 .
	gÁŒoˇã
 = 
pxt4_ÁŒoˇã
,

531 c⁄° 
öode_›î©i⁄s
 
	gpxt4_fûe_öode_›î©i⁄s
 = {

532 .
£èâr
 = 
pxt4_£èâr
,

533 .
	ggë©å
 = 
pxt4_fûe_gë©å
,

534 .
	gli°x©å
 = 
pxt4_li°x©å
,

535 .
	ggë_a˛
 = 
pxt4_gë_a˛
,

536 .
	g£t_a˛
 = 
pxt4_£t_a˛
,

537 .
	gfõm≠
 = 
pxt4_fõm≠
,

	@fsmap.c

7 
	~"pxt4.h
"

8 
	~<löux/fsm≠.h
>

9 
	~"fsm≠.h
"

10 
	~"mbÆloc.h
"

11 
	~<löux/s‹t.h
>

12 
	~<löux/li°_s‹t.h
>

13 
	~<åa˚/evíts/pxt4.h
>

16 
	$pxt4_fsm≠_‰om_öã∫Æ
(
su≥r_block
 *
sb
, 
fsm≠
 *
de°
,

17 
pxt4_fsm≠
 *
§c
)

19 
de°
->
fmr_devi˚
 = 
§c
->fmr_device;

20 
de°
->
fmr_Êags
 = 
§c
->fmr_flags;

21 
de°
->
fmr_physiˇl
 = 
§c
->fmr_physiˇ»<< 
sb
->
s_blocksize_bôs
;

22 
de°
->
fmr_ow√r
 = 
§c
->fmr_owner;

23 
de°
->
fmr_off£t
 = 0;

24 
de°
->
fmr_Àngth
 = 
§c
->fmr_Àngth << 
sb
->
s_blocksize_bôs
;

25 
de°
->
fmr_ª£rved
[0] = 0;

26 
de°
->
fmr_ª£rved
[1] = 0;

27 
de°
->
fmr_ª£rved
[2] = 0;

28 
	}
}

31 
	$pxt4_fsm≠_to_öã∫Æ
(
su≥r_block
 *
sb
, 
pxt4_fsm≠
 *
de°
,

32 
fsm≠
 *
§c
)

34 
de°
->
fmr_devi˚
 = 
§c
->fmr_device;

35 
de°
->
fmr_Êags
 = 
§c
->fmr_flags;

36 
de°
->
fmr_physiˇl
 = 
§c
->fmr_physiˇ»>> 
sb
->
s_blocksize_bôs
;

37 
de°
->
fmr_ow√r
 = 
§c
->fmr_owner;

38 
de°
->
fmr_Àngth
 = 
§c
->fmr_Àngth >> 
sb
->
s_blocksize_bôs
;

39 
	}
}

42 
	spxt4_gëfsm≠_öfo
 {

43 
pxt4_fsm≠_hód
 *
	mgfi_hód
;

44 
pxt4_fsm≠_f‹m©_t
 
	mgfi_f‹m©ãr
;

45 *
	mgfi_f‹m©_¨g
;

46 
pxt4_fsblk_t
 
	mgfi_√xt_fsblk
;

47 
u32
 
	mgfi_dev
;

48 
pxt4_group_t
 
	mgfi_agno
;

49 
pxt4_fsm≠
 
	mgfi_low
;

50 
pxt4_fsm≠
 
	mgfi_high
;

51 
pxt4_fsm≠
 
	mgfi_œ°‰ì
;

52 
li°_hód
 
	mgfi_mëa_li°
;

53 
boﬁ
 
	mgfi_œ°
;

57 
	spxt4_gëfsm≠_dev
 {

58 (*
	mgfd_‚
)(
su≥r_block
 *
	msb
,

59 
pxt4_fsm≠
 *
	mkeys
,

60 
pxt4_gëfsm≠_öfo
 *
	möfo
);

61 
u32
 
	mgfd_dev
;

65 
	$pxt4_gëfsm≠_dev_com∑ª
(c⁄° *
p1
, c⁄° *
p2
)

67 c⁄° 
pxt4_gëfsm≠_dev
 *
d1
 = 
p1
;

68 c⁄° 
pxt4_gëfsm≠_dev
 *
d2
 = 
p2
;

70  
d1
->
gfd_dev
 - 
d2
->gfd_dev;

71 
	}
}

74 
boﬁ
 
	$pxt4_gëfsm≠_ªc_bef‹e_low_key
(
pxt4_gëfsm≠_öfo
 *
öfo
,

75 
pxt4_fsm≠
 *
ªc
)

77  
ªc
->
fmr_physiˇl
 < 
öfo
->
gfi_low
.fmr_physical;

78 
	}
}

84 
	$pxt4_gëfsm≠_hñ≥r
(
su≥r_block
 *
sb
,

85 
pxt4_gëfsm≠_öfo
 *
öfo
,

86 
pxt4_fsm≠
 *
ªc
)

88 
pxt4_fsm≠
 
fmr
;

89 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

90 
pxt4_fsblk_t
 
ªc_fsblk
 = 
ªc
->
fmr_physiˇl
;

91 
pxt4_group_t
 
agno
;

92 
pxt4_gΩblk_t
 
˙o
;

93 
îr‹
;

95 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
))

96  -
EINTR
;

102 i‡(
	`pxt4_gëfsm≠_ªc_bef‹e_low_key
(
öfo
, 
ªc
)) {

103 
ªc_fsblk
 +
ªc
->
fmr_Àngth
;

104 i‡(
öfo
->
gfi_√xt_fsblk
 < 
ªc_fsblk
)

105 
öfo
->
gfi_√xt_fsblk
 = 
ªc_fsblk
;

106  
PXT4_QUERY_RANGE_CONTINUE
;

110 i‡(
öfo
->
gfi_hód
->
fmh_cou¡
 == 0) {

111 i‡(
ªc_fsblk
 > 
öfo
->
gfi_√xt_fsblk
)

112 
öfo
->
gfi_hód
->
fmh_íåõs
++;

114 i‡(
öfo
->
gfi_œ°
)

115  
PXT4_QUERY_RANGE_CONTINUE
;

117 
öfo
->
gfi_hód
->
fmh_íåõs
++;

119 
ªc_fsblk
 +
ªc
->
fmr_Àngth
;

120 i‡(
öfo
->
gfi_√xt_fsblk
 < 
ªc_fsblk
)

121 
öfo
->
gfi_√xt_fsblk
 = 
ªc_fsblk
;

122  
PXT4_QUERY_RANGE_CONTINUE
;

130 i‡(
ªc_fsblk
 > 
öfo
->
gfi_√xt_fsblk
) {

131 i‡(
öfo
->
gfi_hód
->
fmh_íåõs
 >öfo->gfi_hód->
fmh_cou¡
)

132  
PXT4_QUERY_RANGE_ABORT
;

134 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
öfo
->
gfi_√xt_fsblk
,

135 &
agno
, &
˙o
);

136 
	`åa˚_pxt4_fsm≠_m≠pög
(
sb
, 
öfo
->
gfi_dev
, 
agno
,

137 
	`PXT4_C2B
(
sbi
, 
˙o
),

138 
ªc_fsblk
 - 
öfo
->
gfi_√xt_fsblk
,

139 
PXT4_FMR_OWN_UNKNOWN
);

141 
fmr
.
fmr_devi˚
 = 
öfo
->
gfi_dev
;

142 
fmr
.
fmr_physiˇl
 = 
öfo
->
gfi_√xt_fsblk
;

143 
fmr
.
fmr_ow√r
 = 
PXT4_FMR_OWN_UNKNOWN
;

144 
fmr
.
fmr_Àngth
 = 
ªc_fsblk
 - 
öfo
->
gfi_√xt_fsblk
;

145 
fmr
.
fmr_Êags
 = 
FMR_OF_SPECIAL_OWNER
;

146 
îr‹
 = 
öfo
->
	`gfi_f‹m©ãr
(&
fmr
, info->
gfi_f‹m©_¨g
);

147 i‡(
îr‹
)

148  
îr‹
;

149 
öfo
->
gfi_hód
->
fmh_íåõs
++;

152 i‡(
öfo
->
gfi_œ°
)

153 
out
;

156 i‡(
öfo
->
gfi_hód
->
fmh_íåõs
 >öfo->gfi_hód->
fmh_cou¡
)

157  
PXT4_QUERY_RANGE_ABORT
;

159 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
ªc_fsblk
, &
agno
, &
˙o
);

160 
	`åa˚_pxt4_fsm≠_m≠pög
(
sb
, 
öfo
->
gfi_dev
, 
agno
, 
	`PXT4_C2B
(
sbi
, 
˙o
),

161 
ªc
->
fmr_Àngth
,Ñec->
fmr_ow√r
);

163 
fmr
.
fmr_devi˚
 = 
öfo
->
gfi_dev
;

164 
fmr
.
fmr_physiˇl
 = 
ªc_fsblk
;

165 
fmr
.
fmr_ow√r
 = 
ªc
->fmr_owner;

166 
fmr
.
fmr_Êags
 = 
FMR_OF_SPECIAL_OWNER
;

167 
fmr
.
fmr_Àngth
 = 
ªc
->fmr_length;

168 
îr‹
 = 
öfo
->
	`gfi_f‹m©ãr
(&
fmr
, info->
gfi_f‹m©_¨g
);

169 i‡(
îr‹
)

170  
îr‹
;

171 
öfo
->
gfi_hód
->
fmh_íåõs
++;

173 
out
:

174 
ªc_fsblk
 +
ªc
->
fmr_Àngth
;

175 i‡(
öfo
->
gfi_√xt_fsblk
 < 
ªc_fsblk
)

176 
öfo
->
gfi_√xt_fsblk
 = 
ªc_fsblk
;

177  
PXT4_QUERY_RANGE_CONTINUE
;

178 
	}
}

180 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_fsm≠_√xt_pblk
(
pxt4_fsm≠
 *
fmr
)

182  
fmr
->
fmr_physiˇl
 + fmr->
fmr_Àngth
;

183 
	}
}

186 
	$pxt4_gëfsm≠_d©adev_hñ≥r
(
su≥r_block
 *
sb
,

187 
pxt4_group_t
 
agno
, 
pxt4_gΩblk_t
 
°¨t
,

188 
pxt4_gΩblk_t
 
Àn
, *
¥iv
)

190 
pxt4_fsm≠
 
úec
;

191 
pxt4_gëfsm≠_öfo
 *
öfo
 = 
¥iv
;

192 
pxt4_fsm≠
 *
p
;

193 
pxt4_fsm≠
 *
tmp
;

194 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

195 
pxt4_fsblk_t
 
fsb
;

196 
pxt4_fsblk_t
 
f¶í
;

197 
îr‹
;

199 
fsb
 = (
	`PXT4_C2B
(
sbi
, 
°¨t
Ë+ 
	`pxt4_group_fú°_block_no
(
sb
, 
agno
));

200 
f¶í
 = 
	`PXT4_C2B
(
sbi
, 
Àn
);

203 i‡(
öfo
->
gfi_œ°‰ì
.
fmr_ow√r
) {

205 i‡(
	`pxt4_fsm≠_√xt_pblk
(&
öfo
->
gfi_œ°‰ì
Ë=
fsb
) {

206 
öfo
->
gfi_œ°‰ì
.
fmr_Àngth
 +
f¶í
;

214 
îr‹
 = 
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &öfo->
gfi_œ°‰ì
);

215 i‡(
îr‹
)

216  
îr‹
;

217 
öfo
->
gfi_œ°‰ì
.
fmr_ow√r
 = 0;

221 
	`li°_f‹_óch_íåy_ß„
(
p
, 
tmp
, &
öfo
->
gfi_mëa_li°
, 
fmr_li°
) {

222 i‡(
p
->
fmr_physiˇl
 +Ö->
fmr_Àngth
 <
öfo
->
gfi_√xt_fsblk
) {

223 
	`li°_dñ
(&
p
->
fmr_li°
);

224 
	`k‰ì
(
p
);

225 } i‡(
p
->
fmr_physiˇl
 < 
fsb
) {

226 
îr‹
 = 
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, 
p
);

227 i‡(
îr‹
)

228  
îr‹
;

230 
	`li°_dñ
(&
p
->
fmr_li°
);

231 
	`k‰ì
(
p
);

235 
úec
.
fmr_devi˚
 = 0;

236 
úec
.
fmr_physiˇl
 = 
fsb
;

237 
úec
.
fmr_Àngth
 = 
f¶í
;

238 
úec
.
fmr_ow√r
 = 
PXT4_FMR_OWN_FREE
;

239 
úec
.
fmr_Êags
 = 0;

242 i‡(
	`pxt4_fsm≠_√xt_pblk
(&
úec
) ==

243 
	`pxt4_group_fú°_block_no
(
sb
, 
agno
 + 1)) {

244 
öfo
->
gfi_œ°‰ì
 = 
úec
;

249  
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &
úec
);

250 
	}
}

253 
	$pxt4_gëfsm≠_logdev
(
su≥r_block
 *
sb
, 
pxt4_fsm≠
 *
keys
,

254 
pxt4_gëfsm≠_öfo
 *
öfo
)

256 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

257 
pxt4_fsm≠
 
úec
;

260 
öfo
->
gfi_low
 = 
keys
[0];

261 
öfo
->
gfi_low
.
fmr_Àngth
 = 0;

263 
	`mem£t
(&
öfo
->
gfi_high
, 0xFF, (info->gfi_high));

265 
	`åa˚_pxt4_fsm≠_low_key
(
sb
, 
öfo
->
gfi_dev
, 0,

266 
öfo
->
gfi_low
.
fmr_physiˇl
,

267 
öfo
->
gfi_low
.
fmr_Àngth
,

268 
öfo
->
gfi_low
.
fmr_ow√r
);

270 
	`åa˚_pxt4_fsm≠_high_key
(
sb
, 
öfo
->
gfi_dev
, 0,

271 
öfo
->
gfi_high
.
fmr_physiˇl
,

272 
öfo
->
gfi_high
.
fmr_Àngth
,

273 
öfo
->
gfi_high
.
fmr_ow√r
);

275 i‡(
keys
[0].
fmr_physiˇl
 > 0)

279 
úec
.
fmr_physiˇl
 = 
jou∫Æ
->
j_blk_off£t
;

280 
úec
.
fmr_Àngth
 = 
jou∫Æ
->
j_maxÀn
;

281 
úec
.
fmr_ow√r
 = 
PXT4_FMR_OWN_LOG
;

282 
úec
.
fmr_Êags
 = 0;

284  
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &
úec
);

285 
	}
}

288 
ölöe
 
	$pxt4_gëfsm≠_fûl
(
li°_hód
 *
mëa_li°
,

289 
pxt4_fsblk_t
 
fsb
,Öxt4_fsblk_à
Àn
,

290 
uöt64_t
 
ow√r
)

292 
pxt4_fsm≠
 *
fsm
;

294 
fsm
 = 
	`kmÆloc
((*fsm), 
GFP_NOFS
);

295 i‡(!
fsm
)

296  -
ENOMEM
;

297 
fsm
->
fmr_devi˚
 = 0;

298 
fsm
->
fmr_Êags
 = 0;

299 
fsm
->
fmr_physiˇl
 = 
fsb
;

300 
fsm
->
fmr_ow√r
 = 
ow√r
;

301 
fsm
->
fmr_Àngth
 = 
Àn
;

302 
	`li°_add_èû
(&
fsm
->
fmr_li°
, 
mëa_li°
);

305 
	}
}

311 
	$pxt4_gëfsm≠_föd_sb
(
su≥r_block
 *
sb
,

312 
pxt4_group_t
 
agno
,

313 
li°_hód
 *
mëa_li°
)

315 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

316 
pxt4_fsblk_t
 
fsb
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
agno
);

317 
pxt4_fsblk_t
 
Àn
;

318 
fú°_mëa_bg
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_mëa_bg
);

319 
mëagroup
 = 
agno
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

320 
îr‹
;

323 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
agno
)) {

324 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
, 
fsb
, 1, 
PXT4_FMR_OWN_FS
);

325 i‡(
îr‹
)

326  
îr‹
;

327 
fsb
++;

331 
Àn
 = 
	`pxt4_bg_num_gdb
(
sb
, 
agno
);

332 i‡(!
Àn
)

334 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
, 
fsb
, 
Àn
,

335 
PXT4_FMR_OWN_GDT
);

336 i‡(
îr‹
)

337  
îr‹
;

338 
fsb
 +
Àn
;

341 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
Ë|| 
mëagroup
 < 
fú°_mëa_bg
) {

342 
Àn
 = 
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
);

343 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
, 
fsb
, 
Àn
,

344 
PXT4_FMR_OWN_RESV_GDT
);

345 i‡(
îr‹
)

346  
îr‹
;

350 
	}
}

353 
	$pxt4_gëfsm≠_com∑ª
(*
¥iv
,

354 
li°_hód
 *
a
,

355 
li°_hód
 *
b
)

357 
pxt4_fsm≠
 *
Á
;

358 
pxt4_fsm≠
 *
fb
;

360 
Á
 = 
	`c⁄èöî_of
(
a
, 
pxt4_fsm≠
, 
fmr_li°
);

361 
fb
 = 
	`c⁄èöî_of
(
b
, 
pxt4_fsm≠
, 
fmr_li°
);

362 i‡(
Á
->
fmr_physiˇl
 < 
fb
->fmr_physical)

364 i‡(
Á
->
fmr_physiˇl
 > 
fb
->fmr_physical)

367 
	}
}

370 
	$pxt4_gëfsm≠_mîge_fixed_mëad©a
(
li°_hód
 *
mëa_li°
)

372 
pxt4_fsm≠
 *
p
;

373 
pxt4_fsm≠
 *
¥ev
 = 
NULL
;

374 
pxt4_fsm≠
 *
tmp
;

376 
	`li°_f‹_óch_íåy_ß„
(
p
, 
tmp
, 
mëa_li°
, 
fmr_li°
) {

377 i‡(!
¥ev
) {

378 
¥ev
 = 
p
;

382 i‡(
¥ev
->
fmr_ow√r
 =
p
->fmr_owner &&

383 
¥ev
->
fmr_physiˇl
 +Öªv->
fmr_Àngth
 =
p
->fmr_physical) {

384 
¥ev
->
fmr_Àngth
 +
p
->fmr_length;

385 
	`li°_dñ
(&
p
->
fmr_li°
);

386 
	`k‰ì
(
p
);

388 
¥ev
 = 
p
;

390 
	}
}

393 
	$pxt4_gëfsm≠_‰ì_fixed_mëad©a
(
li°_hód
 *
mëa_li°
)

395 
pxt4_fsm≠
 *
p
;

396 
pxt4_fsm≠
 *
tmp
;

398 
	`li°_f‹_óch_íåy_ß„
(
p
, 
tmp
, 
mëa_li°
, 
fmr_li°
) {

399 
	`li°_dñ
(&
p
->
fmr_li°
);

400 
	`k‰ì
(
p
);

402 
	}
}

405 
	$pxt4_gëfsm≠_föd_fixed_mëad©a
(
su≥r_block
 *
sb
,

406 
li°_hód
 *
mëa_li°
)

408 
pxt4_group_desc
 *
gdp
;

409 
pxt4_group_t
 
agno
;

410 
îr‹
;

412 
	`INIT_LIST_HEAD
(
mëa_li°
);

415 
agno
 = 0;ágnÿ< 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;ágno++) {

416 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
agno
, 
NULL
);

417 i‡(!
gdp
) {

418 
îr‹
 = -
EFSCORRUPTED
;

419 
îr
;

423 
îr‹
 = 
	`pxt4_gëfsm≠_föd_sb
(
sb
, 
agno
, 
mëa_li°
);

424 i‡(
îr‹
)

425 
îr
;

428 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
,

429 
	`pxt4_block_bôm≠
(
sb
, 
gdp
), 1,

430 
PXT4_FMR_OWN_BLKBM
);

431 i‡(
îr‹
)

432 
îr
;

435 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
,

436 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
), 1,

437 
PXT4_FMR_OWN_INOBM
);

438 i‡(
îr‹
)

439 
îr
;

442 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
,

443 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

444 
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
,

445 
PXT4_FMR_OWN_INODES
);

446 i‡(
îr‹
)

447 
îr
;

451 
	`li°_s‹t
(
NULL
, 
mëa_li°
, 
pxt4_gëfsm≠_com∑ª
);

454 
	`pxt4_gëfsm≠_mîge_fixed_mëad©a
(
mëa_li°
);

457 
îr
:

458 
	`pxt4_gëfsm≠_‰ì_fixed_mëad©a
(
mëa_li°
);

459  
îr‹
;

460 
	}
}

463 
	$pxt4_gëfsm≠_d©adev
(
su≥r_block
 *
sb
,

464 
pxt4_fsm≠
 *
keys
,

465 
pxt4_gëfsm≠_öfo
 *
öfo
)

467 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

468 
pxt4_fsblk_t
 
°¨t_fsb
;

469 
pxt4_fsblk_t
 
íd_fsb
;

470 
pxt4_fsblk_t
 
bofs
;

471 
pxt4_fsblk_t
 
eofs
;

472 
pxt4_group_t
 
°¨t_ag
;

473 
pxt4_group_t
 
íd_ag
;

474 
pxt4_gΩblk_t
 
fú°_˛u°î
;

475 
pxt4_gΩblk_t
 
œ°_˛u°î
;

476 
îr‹
 = 0;

478 
bofs
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
);

479 
eofs
 = 
	`pxt4_blocks_cou¡
(
sbi
->
s_es
);

480 i‡(
keys
[0].
fmr_physiˇl
 >
eofs
)

482 i‡(
keys
[0].
fmr_physiˇl
 < 
bofs
)

483 
keys
[0].
fmr_physiˇl
 = 
bofs
;

484 i‡(
keys
[1].
fmr_physiˇl
 >
eofs
)

485 
keys
[1].
fmr_physiˇl
 = 
eofs
 - 1;

486 
°¨t_fsb
 = 
keys
[0].
fmr_physiˇl
;

487 
íd_fsb
 = 
keys
[1].
fmr_physiˇl
;

490 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
°¨t_fsb
, &
°¨t_ag
, &
fú°_˛u°î
);

491 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
íd_fsb
, &
íd_ag
, &
œ°_˛u°î
);

498 
öfo
->
gfi_low
 = 
keys
[0];

499 
öfo
->
gfi_low
.
fmr_physiˇl
 = 
	`PXT4_C2B
(
sbi
, 
fú°_˛u°î
);

500 
öfo
->
gfi_low
.
fmr_Àngth
 = 0;

502 
	`mem£t
(&
öfo
->
gfi_high
, 0xFF, (info->gfi_high));

505 
îr‹
 = 
	`pxt4_gëfsm≠_föd_fixed_mëad©a
(
sb
, &
öfo
->
gfi_mëa_li°
);

506 i‡(
îr‹
)

507 
îr
;

510 
öfo
->
gfi_agno
 = 
°¨t_ag
;

511 
öfo
->
gfi_agno
 <
íd_ag
;

512 
öfo
->
gfi_agno
++) {

517 i‡(
öfo
->
gfi_agno
 =
íd_ag
) {

518 
öfo
->
gfi_high
 = 
keys
[1];

519 
öfo
->
gfi_high
.
fmr_physiˇl
 = 
	`PXT4_C2B
(
sbi
,

520 
œ°_˛u°î
);

521 
öfo
->
gfi_high
.
fmr_Àngth
 = 0;

524 
	`åa˚_pxt4_fsm≠_low_key
(
sb
, 
öfo
->
gfi_dev
, info->
gfi_agno
,

525 
öfo
->
gfi_low
.
fmr_physiˇl
,

526 
öfo
->
gfi_low
.
fmr_Àngth
,

527 
öfo
->
gfi_low
.
fmr_ow√r
);

529 
	`åa˚_pxt4_fsm≠_high_key
(
sb
, 
öfo
->
gfi_dev
, info->
gfi_agno
,

530 
öfo
->
gfi_high
.
fmr_physiˇl
,

531 
öfo
->
gfi_high
.
fmr_Àngth
,

532 
öfo
->
gfi_high
.
fmr_ow√r
);

534 
îr‹
 = 
	`pxt4_mbÆloc_quîy_ønge
(
sb
, 
öfo
->
gfi_agno
,

535 
	`PXT4_B2C
(
sbi
, 
öfo
->
gfi_low
.
fmr_physiˇl
),

536 
	`PXT4_B2C
(
sbi
, 
öfo
->
gfi_high
.
fmr_physiˇl
),

537 
pxt4_gëfsm≠_d©adev_hñ≥r
, 
öfo
);

538 i‡(
îr‹
)

539 
îr
;

545 i‡(
öfo
->
gfi_agno
 =
°¨t_ag
)

546 
	`mem£t
(&
öfo
->
gfi_low
, 0, (info->gfi_low));

550 i‡(
öfo
->
gfi_œ°‰ì
.
fmr_ow√r
) {

551 
îr‹
 = 
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &öfo->
gfi_œ°‰ì
);

552 i‡(
îr‹
)

553 
îr
;

557 
öfo
->
gfi_œ°
 = 
åue
;

558 
îr‹
 = 
	`pxt4_gëfsm≠_d©adev_hñ≥r
(
sb
, 
íd_ag
, 
œ°_˛u°î
, 0, 
öfo
);

559 i‡(
îr‹
)

560 
îr
;

562 
îr
:

563 
	`pxt4_gëfsm≠_‰ì_fixed_mëad©a
(&
öfo
->
gfi_mëa_li°
);

564  
îr‹
;

565 
	}
}

568 
boﬁ
 
	$pxt4_gëfsm≠_is_vÆid_devi˚
(
su≥r_block
 *
sb
,

569 
pxt4_fsm≠
 *
fm
)

571 i‡(
fm
->
fmr_devi˚
 =0 || fm->fmr_devi˚ =
UINT_MAX
 ||

572 
fm
->
fmr_devi˚
 =
	`√w_ícode_dev
(
sb
->
s_bdev
->
bd_dev
))

573  
åue
;

574 i‡(
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
 &&

575 
fm
->
fmr_devi˚
 =
	`√w_ícode_dev
(
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
->
bd_dev
))

576  
åue
;

577  
Ál£
;

578 
	}
}

581 
boﬁ
 
	$pxt4_gëfsm≠_check_keys
(
pxt4_fsm≠
 *
low_key
,

582 
pxt4_fsm≠
 *
high_key
)

584 i‡(
low_key
->
fmr_devi˚
 > 
high_key
->fmr_device)

585  
Ál£
;

586 i‡(
low_key
->
fmr_devi˚
 < 
high_key
->fmr_device)

587  
åue
;

589 i‡(
low_key
->
fmr_physiˇl
 > 
high_key
->fmr_physical)

590  
Ál£
;

591 i‡(
low_key
->
fmr_physiˇl
 < 
high_key
->fmr_physical)

592  
åue
;

594 i‡(
low_key
->
fmr_ow√r
 > 
high_key
->fmr_owner)

595  
Ál£
;

596 i‡(
low_key
->
fmr_ow√r
 < 
high_key
->fmr_owner)

597  
åue
;

599  
Ál£
;

600 
	}
}

602 
	#PXT4_GETFSMAP_DEVS
 2

	)

624 
	$pxt4_gëfsm≠
(
su≥r_block
 *
sb
, 
pxt4_fsm≠_hód
 *
hód
,

625 
pxt4_fsm≠_f‹m©_t
 
f‹m©ãr
, *
¨g
)

627 
pxt4_fsm≠
 
dkeys
[2];

628 
pxt4_gëfsm≠_dev
 
h™dÀrs
[
PXT4_GETFSMAP_DEVS
];

629 
pxt4_gëfsm≠_öfo
 
öfo
 = { 
NULL
 };

630 
i
;

631 
îr‹
 = 0;

633 i‡(
hód
->
fmh_iÊags
 & ~
FMH_IF_VALID
)

634  -
EINVAL
;

635 i‡(!
	`pxt4_gëfsm≠_is_vÆid_devi˚
(
sb
, &
hód
->
fmh_keys
[0]) ||

636 !
	`pxt4_gëfsm≠_is_vÆid_devi˚
(
sb
, &
hód
->
fmh_keys
[1]))

637  -
EINVAL
;

639 
hód
->
fmh_íåõs
 = 0;

642 
	`mem£t
(
h™dÀrs
, 0, (handlers));

643 
h™dÀrs
[0].
gfd_dev
 = 
	`√w_ícode_dev
(
sb
->
s_bdev
->
bd_dev
);

644 
h™dÀrs
[0].
gfd_‚
 = 
pxt4_gëfsm≠_d©adev
;

645 i‡(
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
) {

646 
h™dÀrs
[1].
gfd_dev
 = 
	`√w_ícode_dev
(

647 
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
->
bd_dev
);

648 
h™dÀrs
[1].
gfd_‚
 = 
pxt4_gëfsm≠_logdev
;

651 
	`s‹t
(
h™dÀrs
, 
PXT4_GETFSMAP_DEVS
, (
pxt4_gëfsm≠_dev
),

652 
pxt4_gëfsm≠_dev_com∑ª
, 
NULL
);

665 
dkeys
[0] = 
hód
->
fmh_keys
[0];

666 
dkeys
[0].
fmr_physiˇl
 +dkeys[0].
fmr_Àngth
;

667 
dkeys
[0].
fmr_ow√r
 = 0;

668 
dkeys
[0].
fmr_Àngth
 = 0;

669 
	`mem£t
(&
dkeys
[1], 0xFF, (
pxt4_fsm≠
));

671 i‡(!
	`pxt4_gëfsm≠_check_keys
(
dkeys
, &
hód
->
fmh_keys
[1]))

672  -
EINVAL
;

674 
öfo
.
gfi_√xt_fsblk
 = 
hód
->
fmh_keys
[0].
fmr_physiˇl
 +

675 
hód
->
fmh_keys
[0].
fmr_Àngth
;

676 
öfo
.
gfi_f‹m©ãr
 = 
f‹m©ãr
;

677 
öfo
.
gfi_f‹m©_¨g
 = 
¨g
;

678 
öfo
.
gfi_hód
 = 
hód
;

681 
i
 = 0; i < 
PXT4_GETFSMAP_DEVS
; i++) {

683 i‡(!
h™dÀrs
[
i
].
gfd_‚
)

685 i‡(
hód
->
fmh_keys
[0].
fmr_devi˚
 > 
h™dÀrs
[
i
].
gfd_dev
)

687 i‡(
hód
->
fmh_keys
[1].
fmr_devi˚
 < 
h™dÀrs
[
i
].
gfd_dev
)

697 i‡(
h™dÀrs
[
i
].
gfd_dev
 =
hód
->
fmh_keys
[1].
fmr_devi˚
)

698 
dkeys
[1] = 
hód
->
fmh_keys
[1];

699 i‡(
h™dÀrs
[
i
].
gfd_dev
 > 
hód
->
fmh_keys
[0].
fmr_devi˚
)

700 
	`mem£t
(&
dkeys
[0], 0, (
pxt4_fsm≠
));

702 
öfo
.
gfi_dev
 = 
h™dÀrs
[
i
].
gfd_dev
;

703 
öfo
.
gfi_œ°
 = 
Ál£
;

704 
öfo
.
gfi_agno
 = -1;

705 
îr‹
 = 
h™dÀrs
[
i
].
	`gfd_‚
(
sb
, 
dkeys
, &
öfo
);

706 i‡(
îr‹
)

708 
öfo
.
gfi_√xt_fsblk
 = 0;

711 
hód
->
fmh_oÊags
 = 
FMH_OF_DEV_T
;

712  
îr‹
;

713 
	}
}

	@fsmap.h

7 #i‚de‡
__PXT4_FSMAP_H__


8 
	#__PXT4_FSMAP_H__


	)

10 
	gfsm≠
;

13 
	spxt4_fsm≠
 {

14 
li°_hód
 
	mfmr_li°
;

15 
dev_t
 
	mfmr_devi˚
;

16 
uöt32_t
 
	mfmr_Êags
;

17 
uöt64_t
 
	mfmr_physiˇl
;

18 
uöt64_t
 
	mfmr_ow√r
;

19 
uöt64_t
 
	mfmr_Àngth
;

22 
	spxt4_fsm≠_hód
 {

23 
uöt32_t
 
	mfmh_iÊags
;

24 
uöt32_t
 
	mfmh_oÊags
;

25 
	mfmh_cou¡
;

26 
	mfmh_íåõs
;

28 
pxt4_fsm≠
 
	mfmh_keys
[2];

31 
pxt4_fsm≠_‰om_öã∫Æ
(
su≥r_block
 *
sb
, 
fsm≠
 *
de°
,

32 
pxt4_fsm≠
 *
§c
);

33 
pxt4_fsm≠_to_öã∫Æ
(
su≥r_block
 *
sb
, 
pxt4_fsm≠
 *
de°
,

34 
fsm≠
 *
§c
);

37 (*
	tpxt4_fsm≠_f‹m©_t
)(
	tpxt4_fsm≠
 *, *);

39 
	`pxt4_gëfsm≠
(
su≥r_block
 *
sb
, 
pxt4_fsm≠_hód
 *
hód
,

40 
pxt4_fsm≠_f‹m©_t
 
f‹m©ãr
, *
¨g
);

42 
	#PXT4_QUERY_RANGE_ABORT
 1

	)

43 
	#PXT4_QUERY_RANGE_CONTINUE
 0

	)

46 
	#PXT4_FMR_OWN_FREE
 
FMR_OWN_FREE


	)

47 
	#PXT4_FMR_OWN_UNKNOWN
 
FMR_OWN_UNKNOWN


	)

48 
	#PXT4_FMR_OWN_FS
 
	`FMR_OWNER
('X', 1Ë

	)

49 
	#PXT4_FMR_OWN_LOG
 
	`FMR_OWNER
('X', 2Ë

	)

50 
	#PXT4_FMR_OWN_INODES
 
	`FMR_OWNER
('X', 5Ë

	)

51 
	#PXT4_FMR_OWN_GDT
 
	`FMR_OWNER
('f', 1Ë

	)

52 
	#PXT4_FMR_OWN_RESV_GDT
 
	`FMR_OWNER
('f', 2Ë

	)

53 
	#PXT4_FMR_OWN_BLKBM
 
	`FMR_OWNER
('f', 3Ë

	)

54 
	#PXT4_FMR_OWN_INOBM
 
	`FMR_OWNER
('f', 4Ë

	)

	@fsync.c

26 
	~<löux/time.h
>

27 
	~<löux/fs.h
>

28 
	~<löux/sched.h
>

29 
	~<löux/wrôeback.h
>

30 
	~<löux/blkdev.h
>

32 
	~"pxt4.h
"

33 
	~"pxt4_jbd3.h
"

35 
	~<åa˚/evíts/pxt4.h
>

45 
	$pxt4_sync_∑ª¡
(
öode
 *inode)

47 
díåy
 *díåy = 
NULL
;

48 
öode
 *
√xt
;

49 
ªt
 = 0;

51 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
))

53 
öode
 = 
	`igøb
(inode);

54 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
)) {

55 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
);

56 
díåy
 = 
	`d_föd_™y_Æüs
(
öode
);

57 i‡(!
díåy
)

59 
√xt
 = 
	`igøb
(
	`d_öode
(
díåy
->
d_∑ª¡
));

60 
	`dput
(
díåy
);

61 i‡(!
√xt
)

63 
	`ùut
(
öode
);

64 
öode
 = 
√xt
;

72 
ªt
 = 
	`sync_m≠pög_buf„rs
(
öode
->
i_m≠pög
);

73 i‡(
ªt
)

75 
ªt
 = 
	`sync_öode_mëad©a
(
öode
, 1);

76 i‡(
ªt
)

79 
	`ùut
(
öode
);

80  
ªt
;

81 
	}
}

95 
	$pxt4_sync_fûe
(
fûe
 *fûe, 
loff_t
 
°¨t
,Üoff_à
íd
, 
d©async
)

97 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

98 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

99 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

100 
ªt
 = 0, 
îr
;

101 
tid_t
 
commô_tid
;

102 
boﬁ
 
√eds_b¨rõr
 = 
Ál£
;

104 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

105  -
EIO
;

107 
	`J_ASSERT
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
(Ë=
NULL
);

109 
	`åa˚_pxt4_sync_fûe_íãr
(
fûe
, 
d©async
);

111 i‡(
	`sb_rd⁄ly
(
öode
->
i_sb
)) {

113 
	`smp_rmb
();

114 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)

115 
ªt
 = -
EROFS
;

116 
out
;

119 i‡(!
jou∫Æ
) {

120 
ªt
 = 
	`__gíîic_fûe_fsync
(
fûe
, 
°¨t
, 
íd
, 
d©async
);

121 i‡(!
ªt
)

122 
ªt
 = 
	`pxt4_sync_∑ª¡
(
öode
);

123 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
BARRIER
))

124 
issue_Êush
;

125 
out
;

128 
ªt
 = 
	`fûe_wrôe_™d_waô_ønge
(
fûe
, 
°¨t
, 
íd
);

129 i‡(
ªt
)

130  
ªt
;

145 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

146 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

147 
out
;

150 
commô_tid
 = 
d©async
 ? 
ei
->
i_d©async_tid
 :Éi->
i_sync_tid
;

151 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
 &&

152 !
	`jbd3_å™s_wûl_£nd_d©a_b¨rõr
(
jou∫Æ
, 
commô_tid
))

153 
√eds_b¨rõr
 = 
åue
;

154 
ªt
 = 
	`jbd3_com∂ëe_å™ß˘i⁄
(
jou∫Æ
, 
commô_tid
);

155 i‡(
√eds_b¨rõr
) {

156 
issue_Êush
:

157 
îr
 = 
	`blkdev_issue_Êush
(
öode
->
i_sb
->
s_bdev
, 
GFP_KERNEL
, 
NULL
);

158 i‡(!
ªt
)

159 
ªt
 = 
îr
;

161 
out
:

162 
îr
 = 
	`fûe_check_™d_adv™˚_wb_îr
(
fûe
);

163 i‡(
ªt
 == 0)

164 
ªt
 = 
îr
;

165 
	`åa˚_pxt4_sync_fûe_exô
(
öode
, 
ªt
);

166  
ªt
;

167 
	}
}

	@hash.c

8 
	~<löux/fs.h
>

9 
	~<löux/unicode.h
>

10 
	~<löux/compûî.h
>

11 
	~<löux/bô›s.h
>

12 
	~"pxt4.h
"

14 
	#DELTA
 0x9E3779B9

	)

16 
	$TEA_å™sf‹m
(
__u32
 
buf
[4], __u32 c⁄° 
ö
[])

18 
__u32
 
sum
 = 0;

19 
__u32
 
b0
 = 
buf
[0], 
b1
 = buf[1];

20 
__u32
 
a
 = 
ö
[0], 
b
 = in[1], 
c
 = in[2], 
d
 = in[3];

21 
n
 = 16;

24 
sum
 +
DELTA
;

25 
b0
 +((
b1
 << 4)+
a
Ë^ (b1+
sum
Ë^ ((b1 >> 5)+
b
);

26 
b1
 +((
b0
 << 4)+
c
Ë^ (b0+
sum
Ë^ ((b0 >> 5)+
d
);

27 } --
n
);

29 
buf
[0] +
b0
;

30 
buf
[1] +
b1
;

31 
	}
}

34 
	#F
(
x
, 
y
, 
z
Ë((zË^ ((xË& ((yË^ (z))))

	)

35 
	#G
(
x
, 
y
, 
z
Ë(((xË& (y)Ë+ (((xË^ (y)Ë& (z)))

	)

36 
	#H
(
x
, 
y
, 
z
Ë((xË^ (yË^ (z))

	)

44 
	#ROUND
(
f
, 
a
, 
b
, 
c
, 
d
, 
x
, 
s
) \

45 (
a
 +
	`f
(
b
, 
c
, 
d
Ë+ 
x
,á = 
	`rﬁ32
◊, 
s
))

	)

46 
	#K1
 0

	)

47 
	#K2
 013240474631UL

	)

48 
	#K3
 015666365641UL

	)

53 
__u32
 
	$hÆf_md4_å™sf‹m
(
__u32
 
buf
[4], __u32 c⁄° 
ö
[8])

55 
__u32
 
a
 = 
buf
[0], 
b
 = buf[1], 
c
 = buf[2], 
d
 = buf[3];

58 
	`ROUND
(
F
, 
a
, 
b
, 
c
, 
d
, 
ö
[0] + 
K1
, 3);

59 
	`ROUND
(
F
, 
d
, 
a
, 
b
, 
c
, 
ö
[1] + 
K1
, 7);

60 
	`ROUND
(
F
, 
c
, 
d
, 
a
, 
b
, 
ö
[2] + 
K1
, 11);

61 
	`ROUND
(
F
, 
b
, 
c
, 
d
, 
a
, 
ö
[3] + 
K1
, 19);

62 
	`ROUND
(
F
, 
a
, 
b
, 
c
, 
d
, 
ö
[4] + 
K1
, 3);

63 
	`ROUND
(
F
, 
d
, 
a
, 
b
, 
c
, 
ö
[5] + 
K1
, 7);

64 
	`ROUND
(
F
, 
c
, 
d
, 
a
, 
b
, 
ö
[6] + 
K1
, 11);

65 
	`ROUND
(
F
, 
b
, 
c
, 
d
, 
a
, 
ö
[7] + 
K1
, 19);

68 
	`ROUND
(
G
, 
a
, 
b
, 
c
, 
d
, 
ö
[1] + 
K2
, 3);

69 
	`ROUND
(
G
, 
d
, 
a
, 
b
, 
c
, 
ö
[3] + 
K2
, 5);

70 
	`ROUND
(
G
, 
c
, 
d
, 
a
, 
b
, 
ö
[5] + 
K2
, 9);

71 
	`ROUND
(
G
, 
b
, 
c
, 
d
, 
a
, 
ö
[7] + 
K2
, 13);

72 
	`ROUND
(
G
, 
a
, 
b
, 
c
, 
d
, 
ö
[0] + 
K2
, 3);

73 
	`ROUND
(
G
, 
d
, 
a
, 
b
, 
c
, 
ö
[2] + 
K2
, 5);

74 
	`ROUND
(
G
, 
c
, 
d
, 
a
, 
b
, 
ö
[4] + 
K2
, 9);

75 
	`ROUND
(
G
, 
b
, 
c
, 
d
, 
a
, 
ö
[6] + 
K2
, 13);

78 
	`ROUND
(
H
, 
a
, 
b
, 
c
, 
d
, 
ö
[3] + 
K3
, 3);

79 
	`ROUND
(
H
, 
d
, 
a
, 
b
, 
c
, 
ö
[7] + 
K3
, 9);

80 
	`ROUND
(
H
, 
c
, 
d
, 
a
, 
b
, 
ö
[2] + 
K3
, 11);

81 
	`ROUND
(
H
, 
b
, 
c
, 
d
, 
a
, 
ö
[6] + 
K3
, 15);

82 
	`ROUND
(
H
, 
a
, 
b
, 
c
, 
d
, 
ö
[1] + 
K3
, 3);

83 
	`ROUND
(
H
, 
d
, 
a
, 
b
, 
c
, 
ö
[5] + 
K3
, 9);

84 
	`ROUND
(
H
, 
c
, 
d
, 
a
, 
b
, 
ö
[0] + 
K3
, 11);

85 
	`ROUND
(
H
, 
b
, 
c
, 
d
, 
a
, 
ö
[4] + 
K3
, 15);

87 
buf
[0] +
a
;

88 
buf
[1] +
b
;

89 
buf
[2] +
c
;

90 
buf
[3] +
d
;

92  
buf
[1];

93 
	}
}

94 #unde‡
ROUND


95 #unde‡
K1


96 #unde‡
K2


97 #unde‡
K3


98 #unde‡
F


99 #unde‡
G


100 #unde‡
H


103 
__u32
 
	$dx_hack_hash_unsig√d
(c⁄° *
«me
, 
Àn
)

105 
__u32
 
hash
, 
hash0
 = 0x12a3„2d, 
hash1
 = 0x37abe8f9;

106 c⁄° *
u˝
 = (c⁄° *Ë
«me
;

108 
Àn
--) {

109 
hash
 = 
hash1
 + (
hash0
 ^ (((Ë*
u˝
++) * 7152373));

111 i‡(
hash
 & 0x80000000)

112 
hash
 -= 0x7fffffff;

113 
hash1
 = 
hash0
;

114 
hash0
 = 
hash
;

116  
hash0
 << 1;

117 
	}
}

119 
__u32
 
	$dx_hack_hash_sig√d
(c⁄° *
«me
, 
Àn
)

121 
__u32
 
hash
, 
hash0
 = 0x12a3„2d, 
hash1
 = 0x37abe8f9;

122 c⁄° sig√d *
s˝
 = (c⁄° sig√d *Ë
«me
;

124 
Àn
--) {

125 
hash
 = 
hash1
 + (
hash0
 ^ (((Ë*
s˝
++) * 7152373));

127 i‡(
hash
 & 0x80000000)

128 
hash
 -= 0x7fffffff;

129 
hash1
 = 
hash0
;

130 
hash0
 = 
hash
;

132  
hash0
 << 1;

133 
	}
}

135 
	$°r2hashbuf_sig√d
(c⁄° *
msg
, 
Àn
, 
__u32
 *
buf
, 
num
)

137 
__u32
 
∑d
, 
vÆ
;

138 
i
;

139 c⁄° sig√d *
s˝
 = (c⁄° sig√d *Ë
msg
;

141 
∑d
 = (
__u32
)
Àn
 | ((__u32)len << 8);

142 
∑d
 |=Öad << 16;

144 
vÆ
 = 
∑d
;

145 i‡(
Àn
 > 
num
*4)

146 
Àn
 = 
num
 * 4;

147 
i
 = 0; i < 
Àn
; i++) {

148 
vÆ
 = ((Ë
s˝
[
i
]) + (val << 8);

149 i‡((
i
 % 4) == 3) {

150 *
buf
++ = 
vÆ
;

151 
vÆ
 = 
∑d
;

152 
num
--;

155 i‡(--
num
 >= 0)

156 *
buf
++ = 
vÆ
;

157 --
num
 >= 0)

158 *
buf
++ = 
∑d
;

159 
	}
}

161 
	$°r2hashbuf_unsig√d
(c⁄° *
msg
, 
Àn
, 
__u32
 *
buf
, 
num
)

163 
__u32
 
∑d
, 
vÆ
;

164 
i
;

165 c⁄° *
u˝
 = (c⁄° *Ë
msg
;

167 
∑d
 = (
__u32
)
Àn
 | ((__u32)len << 8);

168 
∑d
 |=Öad << 16;

170 
vÆ
 = 
∑d
;

171 i‡(
Àn
 > 
num
*4)

172 
Àn
 = 
num
 * 4;

173 
i
 = 0; i < 
Àn
; i++) {

174 
vÆ
 = ((Ë
u˝
[
i
]) + (val << 8);

175 i‡((
i
 % 4) == 3) {

176 *
buf
++ = 
vÆ
;

177 
vÆ
 = 
∑d
;

178 
num
--;

181 i‡(--
num
 >= 0)

182 *
buf
++ = 
vÆ
;

183 --
num
 >= 0)

184 *
buf
++ = 
∑d
;

185 
	}
}

200 
	$__pxt4fs_dúhash
(c⁄° *
«me
, 
Àn
,

201 
dx_hash_öfo
 *
höfo
)

203 
__u32
 
hash
;

204 
__u32
 
mö‹_hash
 = 0;

205 c⁄° *
p
;

206 
i
;

207 
__u32
 
ö
[8], 
buf
[4];

208 (*
°r2hashbuf
)(c⁄° *, , 
__u32
 *, ) =

209 
°r2hashbuf_sig√d
;

212 
buf
[0] = 0x67452301;

213 
buf
[1] = 0xefcdab89;

214 
buf
[2] = 0x98badcfe;

215 
buf
[3] = 0x10325476;

218 i‡(
höfo
->
£ed
) {

219 
i
 = 0; i < 4; i++) {

220 i‡(
höfo
->
£ed
[
i
]) {

221 
	`mem˝y
(
buf
, 
höfo
->
£ed
, (buf));

227 
höfo
->
hash_vîsi⁄
) {

228 
DX_HASH_LEGACY_UNSIGNED
:

229 
hash
 = 
	`dx_hack_hash_unsig√d
(
«me
, 
Àn
);

231 
DX_HASH_LEGACY
:

232 
hash
 = 
	`dx_hack_hash_sig√d
(
«me
, 
Àn
);

234 
DX_HASH_HALF_MD4_UNSIGNED
:

235 
°r2hashbuf
 = 
°r2hashbuf_unsig√d
;

237 
DX_HASH_HALF_MD4
:

238 
p
 = 
«me
;

239 
Àn
 > 0) {

240 (*
°r2hashbuf
)(
p
, 
Àn
, 
ö
, 8);

241 
	`hÆf_md4_å™sf‹m
(
buf
, 
ö
);

242 
Àn
 -= 32;

243 
p
 += 32;

245 
mö‹_hash
 = 
buf
[2];

246 
hash
 = 
buf
[1];

248 
DX_HASH_TEA_UNSIGNED
:

249 
°r2hashbuf
 = 
°r2hashbuf_unsig√d
;

251 
DX_HASH_TEA
:

252 
p
 = 
«me
;

253 
Àn
 > 0) {

254 (*
°r2hashbuf
)(
p
, 
Àn
, 
ö
, 4);

255 
	`TEA_å™sf‹m
(
buf
, 
ö
);

256 
Àn
 -= 16;

257 
p
 += 16;

259 
hash
 = 
buf
[0];

260 
mö‹_hash
 = 
buf
[1];

263 
höfo
->
hash
 = 0;

266 
hash
 = hash & ~1;

267 i‡(
hash
 =(
PXT4_HTREE_EOF_32BIT
 << 1))

268 
hash
 = (
PXT4_HTREE_EOF_32BIT
 - 1) << 1;

269 
höfo
->
hash
 = hash;

270 
höfo
->
mö‹_hash
 = minor_hash;

272 
	}
}

274 
	$pxt4fs_dúhash
(c⁄° 
öode
 *
dú
, c⁄° *
«me
, 
Àn
,

275 
dx_hash_öfo
 *
höfo
)

277 #ifde‡
CONFIG_UNICODE


278 c⁄° 
unicode_m≠
 *
um
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_ícodög
;

279 
r
, 
dÀn
;

280 *
buff
;

281 
q°r
 q°∏{.
«me
 =Çame, .
Àn
 =Üen };

283 i‡(
Àn
 && 
	`IS_CASEFOLDED
(
dú
Ë&& 
um
) {

284 
buff
 = 
	`kzÆloc
((Ë* 
PATH_MAX
, 
GFP_KERNEL
);

285 i‡(!
buff
)

286  -
ENOMEM
;

288 
dÀn
 = 
	`utf8_ˇ£fﬁd
(
um
, &
q°r
, 
buff
, 
PATH_MAX
);

289 i‡(
dÀn
 < 0) {

290 
	`k‰ì
(
buff
);

291 
›aque_£q
;

294 
r
 = 
	`__pxt4fs_dúhash
(
buff
, 
dÀn
, 
höfo
);

296 
	`k‰ì
(
buff
);

297  
r
;

299 
›aque_£q
:

301  
	`__pxt4fs_dúhash
(
«me
, 
Àn
, 
höfo
);

302 
	}
}

	@ialloc.c

16 
	~<löux/time.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/°©.h
>

19 
	~<löux/°rög.h
>

20 
	~<löux/quŸa›s.h
>

21 
	~<löux/buf„r_hód.h
>

22 
	~<löux/øndom.h
>

23 
	~<löux/bô›s.h
>

24 
	~<löux/blkdev.h
>

25 
	~<löux/¸ed.h
>

27 
	~<asm/byã‹dî.h
>

29 
	~"pxt4.h
"

30 
	~"pxt4_jbd3.h
"

31 
	~"x©å.h
"

32 
	~"a˛.h
"

34 
	~<åa˚/evíts/pxt4.h
>

55 
	$pxt4_m¨k_bôm≠_íd
(
°¨t_bô
, 
íd_bô
, *
bôm≠
)

57 
i
;

59 i‡(
°¨t_bô
 >
íd_bô
)

62 
	`pxt4_debug
("m¨kÉnd bô†+%dÅhrough +%d u£d\n", 
°¨t_bô
, 
íd_bô
);

63 
i
 = 
°¨t_bô
; i < ((start_bit + 7) & ~7UL); i++)

64 
	`pxt4_£t_bô
(
i
, 
bôm≠
);

65 i‡(
i
 < 
íd_bô
)

66 
	`mem£t
(
bôm≠
 + (
i
 >> 3), 0xff, (
íd_bô
 - i) >> 3);

67 
	}
}

69 
	$pxt4_íd_bôm≠_ªad
(
buf„r_hód
 *
bh
, 
u±od©e
)

71 i‡(
u±od©e
) {

72 
	`£t_buf„r_u±od©e
(
bh
);

73 
	`£t_bôm≠_u±od©e
(
bh
);

75 
	`u∆ock_buf„r
(
bh
);

76 
	`put_bh
(
bh
);

77 
	}
}

79 
	$pxt4_vÆid©e_öode_bôm≠
(
su≥r_block
 *
sb
,

80 
pxt4_group_desc
 *
desc
,

81 
pxt4_group_t
 
block_group
,

82 
buf„r_hód
 *
bh
)

84 
pxt4_fsblk_t
 
blk
;

85 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
);

87 i‡(
	`buf„r_vîifõd
(
bh
))

89 i‡(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
))

90  -
EFSCORRUPTED
;

92 
	`pxt4_lock_group
(
sb
, 
block_group
);

93 i‡(
	`buf„r_vîifõd
(
bh
))

94 
vîifõd
;

95 
blk
 = 
	`pxt4_öode_bôm≠
(
sb
, 
desc
);

96 i‡(!
	`pxt4_öode_bôm≠_csum_vîify
(
sb
, 
block_group
, 
desc
, 
bh
,

97 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8)) {

98 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

99 
	`pxt4_îr‹
(
sb
, "Corrupt inode bitmap - block_group = %u, "

100 "öode_bôm≠ = %Œu", 
block_group
, 
blk
);

101 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

102 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

103  -
EFSBADCRC
;

105 
	`£t_buf„r_vîifõd
(
bh
);

106 
vîifõd
:

107 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

109 
	}
}

117 
buf„r_hód
 *

118 
	$pxt4_ªad_öode_bôm≠
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
)

120 
pxt4_group_desc
 *
desc
;

121 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

122 
buf„r_hód
 *
bh
 = 
NULL
;

123 
pxt4_fsblk_t
 
bôm≠_blk
;

124 
îr
;

126 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, 
NULL
);

127 i‡(!
desc
)

128  
	`ERR_PTR
(-
EFSCORRUPTED
);

130 
bôm≠_blk
 = 
	`pxt4_öode_bôm≠
(
sb
, 
desc
);

131 i‡((
bôm≠_blk
 <
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
)) ||

132 (
bôm≠_blk
 >
	`pxt4_blocks_cou¡
(
sbi
->
s_es
))) {

133 
	`pxt4_îr‹
(
sb
, "Invalid inode bitmap blk %llu in "

134 "block_grou∞%u", 
bôm≠_blk
, 
block_group
);

135 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

136 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

137  
	`ERR_PTR
(-
EFSCORRUPTED
);

139 
bh
 = 
	`sb_gëblk
(
sb
, 
bôm≠_blk
);

140 i‡(
	`u∆ikñy
(!
bh
)) {

141 
	`pxt4_w¨nög
(
sb
, "CannotÑead inode bitmap - "

143 
block_group
, 
bôm≠_blk
);

144  
	`ERR_PTR
(-
ENOMEM
);

146 i‡(
	`bôm≠_u±od©e
(
bh
))

147 
vîify
;

149 
	`lock_buf„r
(
bh
);

150 i‡(
	`bôm≠_u±od©e
(
bh
)) {

151 
	`u∆ock_buf„r
(
bh
);

152 
vîify
;

155 
	`pxt4_lock_group
(
sb
, 
block_group
);

156 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

157 (
desc
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_UNINIT
))) {

158 i‡(
block_group
 == 0) {

159 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

160 
	`u∆ock_buf„r
(
bh
);

161 
	`pxt4_îr‹
(
sb
, "Inode bitmap for bg 0 marked "

163 
îr
 = -
EFSCORRUPTED
;

164 
out
;

166 
	`mem£t
(
bh
->
b_d©a
, 0, (
	`PXT4_INODES_PER_GROUP
(
sb
) + 7) / 8);

167 
	`pxt4_m¨k_bôm≠_íd
(
	`PXT4_INODES_PER_GROUP
(
sb
),

168 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

169 
	`£t_bôm≠_u±od©e
(
bh
);

170 
	`£t_buf„r_u±od©e
(
bh
);

171 
	`£t_buf„r_vîifõd
(
bh
);

172 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

173 
	`u∆ock_buf„r
(
bh
);

174  
bh
;

176 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

178 i‡(
	`buf„r_u±od©e
(
bh
)) {

183 
	`£t_bôm≠_u±od©e
(
bh
);

184 
	`u∆ock_buf„r
(
bh
);

185 
vîify
;

190 
	`åa˚_pxt4_lﬂd_öode_bôm≠
(
sb
, 
block_group
);

191 
bh
->
b_íd_io
 = 
pxt4_íd_bôm≠_ªad
;

192 
	`gë_bh
(
bh
);

193 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

194 
	`waô_⁄_buf„r
(
bh
);

195 i‡(!
	`buf„r_u±od©e
(
bh
)) {

196 
	`put_bh
(
bh
);

197 
	`pxt4_îr‹
(
sb
, "CannotÑead inode bitmap - "

199 
block_group
, 
bôm≠_blk
);

200 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

201 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

202  
	`ERR_PTR
(-
EIO
);

205 
vîify
:

206 
îr
 = 
	`pxt4_vÆid©e_öode_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

207 i‡(
îr
)

208 
out
;

209  
bh
;

210 
out
:

211 
	`put_bh
(
bh
);

212  
	`ERR_PTR
(
îr
);

213 
	}
}

231 
	$pxt4_‰ì_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

233 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

234 
is_dúe˘‹y
;

235 
öo
;

236 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

237 
buf„r_hód
 *
bh2
;

238 
pxt4_group_t
 
block_group
;

239 
bô
;

240 
pxt4_group_desc
 *
gdp
;

241 
pxt4_su≥r_block
 *
es
;

242 
pxt4_sb_öfo
 *
sbi
;

243 
Áèl
 = 0, 
îr
, 
cou¡
, 
˛óªd
;

244 
pxt4_group_öfo
 *
gΩ
;

246 i‡(!
sb
) {

247 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: %s:%d: inode on "

248 "n⁄exi°íàdevi˚\n", 
__func__
, 
__LINE__
);

251 i‡(
	`©omic_ªad
(&
öode
->
i_cou¡
) > 1) {

252 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu: count=%d",

253 
__func__
, 
__LINE__
, 
öode
->
i_öo
,

254 
	`©omic_ªad
(&
öode
->
i_cou¡
));

257 i‡(
öode
->
i_∆ök
) {

258 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu:Çlink=%d\n",

259 
__func__
, 
__LINE__
, 
öode
->
i_öo
, inode->
i_∆ök
);

262 
sbi
 = 
	`PXT4_SB
(
sb
);

264 
öo
 = 
öode
->
i_öo
;

265 
	`pxt4_debug
("‰ìög inodê%lu\n", 
öo
);

266 
	`åa˚_pxt4_‰ì_öode
(
öode
);

272 
	`dquŸ_öôülize
(
öode
);

273 
	`dquŸ_‰ì_öode
(
öode
);

274 
	`dquŸ_dr›
(
öode
);

276 
is_dúe˘‹y
 = 
	`S_ISDIR
(
öode
->
i_mode
);

279 
	`pxt4_˛ór_öode
(
öode
);

281 
es
 = 
sbi
->
s_es
;

282 i‡(
öo
 < 
	`PXT4_FIRST_INO
(
sb
Ë|| inÿ> 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
)) {

283 
	`pxt4_îr‹
(
sb
, "ª£rved o∏n⁄exi°íàöodê%lu", 
öo
);

284 
îr‹_ªtu∫
;

286 
block_group
 = (
öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

287 
bô
 = (
öo
 - 1Ë% 
	`PXT4_INODES_PER_GROUP
(
sb
);

288 
bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
block_group
);

290 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
);

291 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

292 
Áèl
 = 
	`PTR_ERR
(
bôm≠_bh
);

293 
bôm≠_bh
 = 
NULL
;

294 
îr‹_ªtu∫
;

296 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
))) {

297 
Áèl
 = -
EFSCORRUPTED
;

298 
îr‹_ªtu∫
;

301 
	`BUFFER_TRACE
(
bôm≠_bh
, "get_write_access");

302 
Áèl
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

303 i‡(
Áèl
)

304 
îr‹_ªtu∫
;

306 
Áèl
 = -
ESRCH
;

307 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, &
bh2
);

308 i‡(
gdp
) {

309 
	`BUFFER_TRACE
(
bh2
, "get_write_access");

310 
Áèl
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh2
);

312 
	`pxt4_lock_group
(
sb
, 
block_group
);

313 
˛óªd
 = 
	`pxt4_ã°_™d_˛ór_bô
(
bô
, 
bôm≠_bh
->
b_d©a
);

314 i‡(
Áèl
 || !
˛óªd
) {

315 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

316 
out
;

319 
cou¡
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
) + 1;

320 
	`pxt4_‰ì_öodes_£t
(
sb
, 
gdp
, 
cou¡
);

321 i‡(
is_dúe˘‹y
) {

322 
cou¡
 = 
	`pxt4_u£d_dús_cou¡
(
sb
, 
gdp
) - 1;

323 
	`pxt4_u£d_dús_£t
(
sb
, 
gdp
, 
cou¡
);

324 
	`≥r˝u_cou¡î_dec
(&
sbi
->
s_dús_cou¡î
);

326 
	`pxt4_öode_bôm≠_csum_£t
(
sb
, 
block_group
, 
gdp
, 
bôm≠_bh
,

327 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

328 
	`pxt4_group_desc_csum_£t
(
sb
, 
block_group
, 
gdp
);

329 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

331 
	`≥r˝u_cou¡î_öc
(&
sbi
->
s_‰ìöodes_cou¡î
);

332 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

333 
pxt4_group_t
 
f
 = 
	`pxt4_Êex_group
(
sbi
, 
block_group
);

335 
	`©omic_öc
(&
sbi
->
s_Êex_groups
[
f
].
‰ì_öodes
);

336 i‡(
is_dúe˘‹y
)

337 
	`©omic_dec
(&
sbi
->
s_Êex_groups
[
f
].
u£d_dús
);

339 
	`BUFFER_TRACE
(
bh2
, "callÖxt4_handle_dirty_metadata");

340 
Áèl
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh2
);

341 
out
:

342 i‡(
˛óªd
) {

343 
	`BUFFER_TRACE
(
bôm≠_bh
, "callÖxt4_handle_dirty_metadata");

344 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

345 i‡(!
Áèl
)

346 
Áèl
 = 
îr
;

348 
	`pxt4_îr‹
(
sb
, "bôáÃódy cÀ¨ed f‹ inodê%lu", 
öo
);

349 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

350 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

353 
îr‹_ªtu∫
:

354 
	`bªl£
(
bôm≠_bh
);

355 
	`pxt4_°d_îr‹
(
sb
, 
Áèl
);

356 
	}
}

358 
	s‹lov_°©s
 {

359 
__u64
 
	m‰ì_˛u°îs
;

360 
__u32
 
	m‰ì_öodes
;

361 
__u32
 
	mu£d_dús
;

369 
	$gë_‹lov_°©s
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
g
,

370 
Êex_size
, 
‹lov_°©s
 *
°©s
)

372 
pxt4_group_desc
 *
desc
;

373 
Êex_groups
 *
Êex_group
 = 
	`PXT4_SB
(
sb
)->
s_Êex_groups
;

375 i‡(
Êex_size
 > 1) {

376 
°©s
->
‰ì_öodes
 = 
	`©omic_ªad
(&
Êex_group
[
g
].free_inodes);

377 
°©s
->
‰ì_˛u°îs
 = 
	`©omic64_ªad
(&
Êex_group
[
g
].free_clusters);

378 
°©s
->
u£d_dús
 = 
	`©omic_ªad
(&
Êex_group
[
g
].used_dirs);

382 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
g
, 
NULL
);

383 i‡(
desc
) {

384 
°©s
->
‰ì_öodes
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
desc
);

385 
°©s
->
‰ì_˛u°îs
 = 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
);

386 
°©s
->
u£d_dús
 = 
	`pxt4_u£d_dús_cou¡
(
sb
, 
desc
);

388 
°©s
->
‰ì_öodes
 = 0;

389 
°©s
->
‰ì_˛u°îs
 = 0;

390 
°©s
->
u£d_dús
 = 0;

392 
	}
}

415 
	$föd_group_‹lov
(
su≥r_block
 *
sb
, 
öode
 *
∑ª¡
,

416 
pxt4_group_t
 *
group
, 
umode_t
 
mode
,

417 c⁄° 
q°r
 *qstr)

419 
pxt4_group_t
 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_block_group
;

420 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

421 
pxt4_group_t
 
ªÆ_ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

422 
öodes_≥r_group
 = 
	`PXT4_INODES_PER_GROUP
(
sb
);

423 
‰ìi
, 
ave‰ìi
, 
gΩ_‰ì
;

424 
pxt4_fsblk_t
 
‰ìb
, 
ave‰ìc
;

425 
ndús
;

426 
max_dús
, 
mö_öodes
;

427 
pxt4_gΩblk_t
 
mö_˛u°îs
;

428 
pxt4_group_t
 
i
, 
gΩ
, 
g
, 
ngroups
;

429 
pxt4_group_desc
 *
desc
;

430 
‹lov_°©s
 
°©s
;

431 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
sbi
);

432 
dx_hash_öfo
 
höfo
;

434 
ngroups
 = 
ªÆ_ngroups
;

435 i‡(
Êex_size
 > 1) {

436 
ngroups
 = (
ªÆ_ngroups
 + 
Êex_size
 - 1) >>

437 
sbi
->
s_log_groups_≥r_Êex
;

438 
∑ª¡_group
 >>
sbi
->
s_log_groups_≥r_Êex
;

441 
‰ìi
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_‰ìöodes_cou¡î
);

442 
ave‰ìi
 = 
‰ìi
 / 
ngroups
;

443 
‰ìb
 = 
	`PXT4_C2B
(
sbi
,

444 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_‰ì˛u°îs_cou¡î
));

445 
ave‰ìc
 = 
‰ìb
;

446 
	`do_div
(
ave‰ìc
, 
ngroups
);

447 
ndús
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_dús_cou¡î
);

449 i‡(
	`S_ISDIR
(
mode
) &&

450 ((
∑ª¡
 =
	`d_öode
(
sb
->
s_roŸ
)) ||

451 (
	`pxt4_ã°_öode_Êag
(
∑ª¡
, 
PXT4_INODE_TOPDIR
)))) {

452 
be°_ndú
 = 
öodes_≥r_group
;

453 
ªt
 = -1;

455 i‡(
q°r
) {

456 
höfo
.
hash_vîsi⁄
 = 
DX_HASH_HALF_MD4
;

457 
höfo
.
£ed
 = 
sbi
->
s_hash_£ed
;

458 
	`pxt4fs_dúhash
(
∑ª¡
, 
q°r
->
«me
, q°r->
Àn
, &
höfo
);

459 
gΩ
 = 
höfo
.
hash
;

461 
gΩ
 = 
	`¥™dom_u32
();

462 
∑ª¡_group
 = ()
gΩ
 % 
ngroups
;

463 
i
 = 0; i < 
ngroups
; i++) {

464 
g
 = (
∑ª¡_group
 + 
i
Ë% 
ngroups
;

465 
	`gë_‹lov_°©s
(
sb
, 
g
, 
Êex_size
, &
°©s
);

466 i‡(!
°©s
.
‰ì_öodes
)

468 i‡(
°©s
.
u£d_dús
 >
be°_ndú
)

470 i‡(
°©s
.
‰ì_öodes
 < 
ave‰ìi
)

472 i‡(
°©s
.
‰ì_˛u°îs
 < 
ave‰ìc
)

474 
gΩ
 = 
g
;

475 
ªt
 = 0;

476 
be°_ndú
 = 
°©s
.
u£d_dús
;

478 i‡(
ªt
)

479 
ÁŒback
;

480 
found_Êex_bg
:

481 i‡(
Êex_size
 == 1) {

482 *
group
 = 
gΩ
;

493 
gΩ
 *
Êex_size
;

494 
i
 = 0; i < 
Êex_size
; i++) {

495 i‡(
gΩ
+
i
 >
ªÆ_ngroups
)

497 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
gΩ
+
i
, 
NULL
);

498 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc)) {

499 *
group
 = 
gΩ
+
i
;

503 
ÁŒback
;

506 
max_dús
 = 
ndús
 / 
ngroups
 + 
öodes_≥r_group
 / 16;

507 
mö_öodes
 = 
ave‰ìi
 - 
öodes_≥r_group
*
Êex_size
 / 4;

508 i‡(
mö_öodes
 < 1)

509 
mö_öodes
 = 1;

510 
mö_˛u°îs
 = 
ave‰ìc
 - 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)*
Êex_size
 / 4;

516 i‡(
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
 != ~0) {

517 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
;

518 i‡(
Êex_size
 > 1)

519 
∑ª¡_group
 >>
sbi
->
s_log_groups_≥r_Êex
;

522 
i
 = 0; i < 
ngroups
; i++) {

523 
gΩ
 = (
∑ª¡_group
 + 
i
Ë% 
ngroups
;

524 
	`gë_‹lov_°©s
(
sb
, 
gΩ
, 
Êex_size
, &
°©s
);

525 i‡(
°©s
.
u£d_dús
 >
max_dús
)

527 i‡(
°©s
.
‰ì_öodes
 < 
mö_öodes
)

529 i‡(
°©s
.
‰ì_˛u°îs
 < 
mö_˛u°îs
)

531 
found_Êex_bg
;

534 
ÁŒback
:

535 
ngroups
 = 
ªÆ_ngroups
;

536 
ave‰ìi
 = 
‰ìi
 / 
ngroups
;

537 
ÁŒback_ªåy
:

538 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_block_group
;

539 
i
 = 0; i < 
ngroups
; i++) {

540 
gΩ
 = (
∑ª¡_group
 + 
i
Ë% 
ngroups
;

541 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
gΩ
, 
NULL
);

542 i‡(
desc
) {

543 
gΩ_‰ì
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
desc
);

544 i‡(
gΩ_‰ì
 && gΩ_‰ì >
ave‰ìi
) {

545 *
group
 = 
gΩ
;

551 i‡(
ave‰ìi
) {

556 
ave‰ìi
 = 0;

557 
ÁŒback_ªåy
;

561 
	}
}

563 
	$föd_group_Ÿhî
(
su≥r_block
 *
sb
, 
öode
 *
∑ª¡
,

564 
pxt4_group_t
 *
group
, 
umode_t
 
mode
)

566 
pxt4_group_t
 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_block_group
;

567 
pxt4_group_t
 
i
, 
œ°
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

568 
pxt4_group_desc
 *
desc
;

569 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
	`PXT4_SB
(
sb
));

578 i‡(
Êex_size
 > 1) {

579 
ªåy
 = 0;

581 
åy_agaö
:

582 
∑ª¡_group
 &~(
Êex_size
-1);

583 
œ°
 = 
∑ª¡_group
 + 
Êex_size
;

584 i‡(
œ°
 > 
ngroups
)

585 
œ°
 = 
ngroups
;

586 
i
 = 
∑ª¡_group
; i < 
œ°
; i++) {

587 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

588 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc)) {

589 *
group
 = 
i
;

593 i‡(!
ªåy
 && 
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
 != ~0) {

594 
ªåy
 = 1;

595 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
;

596 
åy_agaö
;

603 *
group
 = 
∑ª¡_group
 + 
Êex_size
;

604 i‡(*
group
 > 
ngroups
)

605 *
group
 = 0;

606  
	`föd_group_‹lov
(
sb
, 
∑ª¡
, 
group
, 
mode
, 
NULL
);

612 *
group
 = 
∑ª¡_group
;

613 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, *
group
, 
NULL
);

614 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc) &&

615 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
))

627 *
group
 = (*grou∞+ 
∑ª¡
->
i_öo
Ë% 
ngroups
;

633 
i
 = 1; i < 
ngroups
; i <<= 1) {

634 *
group
 +
i
;

635 i‡(*
group
 >
ngroups
)

636 *
group
 -
ngroups
;

637 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, *
group
, 
NULL
);

638 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc) &&

639 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
))

647 *
group
 = 
∑ª¡_group
;

648 
i
 = 0; i < 
ngroups
; i++) {

649 i‡(++*
group
 >
ngroups
)

650 *
group
 = 0;

651 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, *
group
, 
NULL
);

652 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc))

657 
	}
}

665 
	#RECENTCY_MIN
 5

	)

666 
	#RECENTCY_DIRTY
 300

	)

668 
	$ª˚¡ly_dñëed
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
, 
öo
)

670 
pxt4_group_desc
 *
gdp
;

671 
pxt4_öode
 *
øw_öode
;

672 
buf„r_hód
 *
bh
;

673 
öodes_≥r_block
 = 
	`PXT4_SB
(
sb
)->
s_öodes_≥r_block
;

674 
off£t
, 
ªt
 = 0;

675 
ª˚¡cy
 = 
RECENTCY_MIN
;

676 
u32
 
dtime
, 
now
;

678 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

679 i‡(
	`u∆ikñy
(!
gdp
))

682 
bh
 = 
	`sb_föd_gë_block
(
sb
, 
	`pxt4_öode_èbÀ
(sb, 
gdp
) +

683 (
öo
 / 
öodes_≥r_block
));

684 i‡(!
bh
 || !
	`buf„r_u±od©e
(bh))

689 
out
;

691 
off£t
 = (
öo
 % 
öodes_≥r_block
Ë* 
	`PXT4_INODE_SIZE
(
sb
);

692 
øw_öode
 = (
pxt4_öode
 *Ë(
bh
->
b_d©a
 + 
off£t
);

698 
dtime
 = 
	`À32_to_˝u
(
øw_öode
->
i_dtime
);

699 
now
 = 
	`ktime_gë_ªÆ_£c⁄ds
();

700 i‡(
	`buf„r_dúty
(
bh
))

701 
ª˚¡cy
 +
RECENTCY_DIRTY
;

703 i‡(
dtime
 && 
	`time_bef‹e32
(dtime, 
now
) &&

704 
	`time_bef‹e32
(
now
, 
dtime
 + 
ª˚¡cy
))

705 
ªt
 = 1;

706 
out
:

707 
	`bªl£
(
bh
);

708  
ªt
;

709 
	}
}

711 
	$föd_öode_bô
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

712 
buf„r_hód
 *
bôm≠
, *
öo
)

714 
√xt
:

715 *
öo
 = 
	`pxt4_föd_√xt_zîo_bô
((*)

716 
bôm≠
->
b_d©a
,

717 
	`PXT4_INODES_PER_GROUP
(
sb
), *
öo
);

718 i‡(*
öo
 >
	`PXT4_INODES_PER_GROUP
(
sb
))

721 i‡((
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 =
NULL
) &&

722 
	`ª˚¡ly_dñëed
(
sb
, 
group
, *
öo
)) {

723 *
öo
 = *ino + 1;

724 i‡(*
öo
 < 
	`PXT4_INODES_PER_GROUP
(
sb
))

725 
√xt
;

730 
	}
}

742 
öode
 *
	$__pxt4_√w_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

743 
umode_t
 
mode
, c⁄° 
q°r
 *qstr,

744 
__u32
 
gﬂl
, 
uid_t
 *
ow√r
, __u32 
i_Êags
,

745 
h™dÀ_ty≥
, 
löe_no
,

746 
nblocks
)

748 
su≥r_block
 *
sb
;

749 
buf„r_hód
 *
öode_bôm≠_bh
 = 
NULL
;

750 
buf„r_hód
 *
group_desc_bh
;

751 
pxt4_group_t
 
ngroups
, 
group
 = 0;

752 
öo
 = 0;

753 
öode
 *inode;

754 
pxt4_group_desc
 *
gdp
 = 
NULL
;

755 
pxt4_öode_öfo
 *
ei
;

756 
pxt4_sb_öfo
 *
sbi
;

757 
ªt2
, 
îr
;

758 
öode
 *
ªt
;

759 
pxt4_group_t
 
i
;

760 
pxt4_group_t
 
Êex_group
;

761 
pxt4_group_öfo
 *
gΩ
;

762 
í¸y±
 = 0;

765 i‡(!
dú
 || !dú->
i_∆ök
)

766  
	`ERR_PTR
(-
EPERM
);

768 
sb
 = 
dú
->
i_sb
;

769 
sbi
 = 
	`PXT4_SB
(
sb
);

771 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
sbi
)))

772  
	`ERR_PTR
(-
EIO
);

774 i‡((
	`IS_ENCRYPTED
(
dú
Ë|| 
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
)) &&

775 (
	`S_ISREG
(
mode
Ë|| 
	`S_ISDIR
(modeË|| 
	`S_ISLNK
(mode)) &&

776 !(
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

777 
îr
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
dú
);

778 i‡(
îr
)

779  
	`ERR_PTR
(
îr
);

780 i‡(!
	`fs¸y±_has_í¸y±i⁄_key
(
dú
))

781  
	`ERR_PTR
(-
ENOKEY
);

782 
í¸y±
 = 1;

785 i‡(!
h™dÀ
 && 
sbi
->
s_jou∫Æ
 && !(
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

786 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


787 
posix_a˛
 *
p
 = 
	`gë_a˛
(
dú
, 
ACL_TYPE_DEFAULT
);

789 i‡(
	`IS_ERR
(
p
))

790  
	`ERR_CAST
(
p
);

791 i‡(
p
) {

792 
a˛_size
 = 
p
->
a_cou¡
 * (
pxt4_a˛_íåy
);

794 
nblocks
 +(
	`S_ISDIR
(
mode
) ? 2 : 1) *

795 
	`__pxt4_x©å_£t_¸edôs
(
sb
, 
NULL
 ,

796 
NULL
 , 
a˛_size
,

797 
åue
 );

798 
	`posix_a˛_ªÀa£
(
p
);

802 #ifde‡
CONFIG_SECURITY


804 
num_£curôy_x©ås
 = 1;

806 #ifde‡
CONFIG_INTEGRITY


807 
num_£curôy_x©ås
++;

814 
nblocks
 +
num_£curôy_x©ås
 *

815 
	`__pxt4_x©å_£t_¸edôs
(
sb
, 
NULL
 ,

816 
NULL
 , 1024,

817 
åue
 );

820 i‡(
í¸y±
)

821 
nblocks
 +
	`__pxt4_x©å_£t_¸edôs
(
sb
,

822 
NULL
 , NULL ,

823 
FSCRYPT_SET_CONTEXT_MAX_SIZE
,

824 
åue
 );

827 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

828 
	`åa˚_pxt4_ªque°_öode
(
dú
, 
mode
);

829 
öode
 = 
	`√w_öode
(
sb
);

830 i‡(!
öode
)

831  
	`ERR_PTR
(-
ENOMEM
);

832 
ei
 = 
	`PXT4_I
(
öode
);

839 i‡(
ow√r
) {

840 
öode
->
i_mode
 = 
mode
;

841 
	`i_uid_wrôe
(
öode
, 
ow√r
[0]);

842 
	`i_gid_wrôe
(
öode
, 
ow√r
[1]);

843 } i‡(
	`ã°_›t
(
sb
, 
GRPID
)) {

844 
öode
->
i_mode
 = 
mode
;

845 
öode
->
i_uid
 = 
	`cuºít_fsuid
();

846 
öode
->
i_gid
 = 
dú
->i_gid;

848 
	`öode_öô_ow√r
(
öode
, 
dú
, 
mode
);

850 i‡(
	`pxt4_has_„©uª_¥oje˘
(
sb
) &&

851 
	`pxt4_ã°_öode_Êag
(
dú
, 
PXT4_INODE_PROJINHERIT
))

852 
ei
->
i_¥ojid
 = 
	`PXT4_I
(
dú
)->i_projid;

854 
ei
->
i_¥ojid
 = 
	`make_k¥ojid
(&
öô_u£r_ns
, 
PXT4_DEF_PROJID
);

856 
îr
 = 
	`dquŸ_öôülize
(
öode
);

857 i‡(
îr
)

858 
out
;

860 i‡(!
gﬂl
)

861 
gﬂl
 = 
sbi
->
s_öode_gﬂl
;

863 i‡(
gﬂl
 && gﬂ»<
	`À32_to_˝u
(
sbi
->
s_es
->
s_öodes_cou¡
)) {

864 
group
 = (
gﬂl
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

865 
öo
 = (
gﬂl
 - 1Ë% 
	`PXT4_INODES_PER_GROUP
(
sb
);

866 
ªt2
 = 0;

867 
gŸ_group
;

870 i‡(
	`S_ISDIR
(
mode
))

871 
ªt2
 = 
	`föd_group_‹lov
(
sb
, 
dú
, &
group
, 
mode
, 
q°r
);

873 
ªt2
 = 
	`föd_group_Ÿhî
(
sb
, 
dú
, &
group
, 
mode
);

875 
gŸ_group
:

876 
	`PXT4_I
(
dú
)->
i_œ°_Æloc_group
 = 
group
;

877 
îr
 = -
ENOSPC
;

878 i‡(
ªt2
 == -1)

879 
out
;

886 
i
 = 0; i < 
ngroups
; i++, 
öo
 = 0) {

887 
îr
 = -
EIO
;

889 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, &
group_desc_bh
);

890 i‡(!
gdp
)

891 
out
;

896 i‡(
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
) == 0)

897 
√xt_group
;

899 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

901 i‡(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
))

902 
√xt_group
;

904 
	`bªl£
(
öode_bôm≠_bh
);

905 
öode_bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
group
);

907 i‡(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
) ||

908 
	`IS_ERR
(
öode_bôm≠_bh
)) {

909 
öode_bôm≠_bh
 = 
NULL
;

910 
√xt_group
;

913 
ª≥©_ö_this_group
:

914 
ªt2
 = 
	`föd_öode_bô
(
sb
, 
group
, 
öode_bôm≠_bh
, &
öo
);

915 i‡(!
ªt2
)

916 
√xt_group
;

918 i‡(
group
 =0 && (
öo
 + 1Ë< 
	`PXT4_FIRST_INO
(
sb
)) {

919 
	`pxt4_îr‹
(
sb
, "reserved inode found cleared - "

920 "öode=%lu", 
öo
 + 1);

921 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
group
,

922 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

923 
√xt_group
;

926 i‡(!
h™dÀ
) {

927 
	`BUG_ON
(
nblocks
 <= 0);

928 
h™dÀ
 = 
	`__pxt4_jou∫Æ_°¨t_sb
(
dú
->
i_sb
, 
löe_no
,

929 
h™dÀ_ty≥
, 
nblocks
,

931 i‡(
	`IS_ERR
(
h™dÀ
)) {

932 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

933 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

934 
out
;

937 
	`BUFFER_TRACE
(
öode_bôm≠_bh
, "get_write_access");

938 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
öode_bôm≠_bh
);

939 i‡(
îr
) {

940 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

941 
out
;

943 
	`pxt4_lock_group
(
sb
, 
group
);

944 
ªt2
 = 
	`pxt4_ã°_™d_£t_bô
(
öo
, 
öode_bôm≠_bh
->
b_d©a
);

945 i‡(
ªt2
) {

949 
ªt2
 = 
	`föd_öode_bô
(
sb
, 
group
, 
öode_bôm≠_bh
, &
öo
);

950 i‡(
ªt2
) {

951 
	`pxt4_£t_bô
(
öo
, 
öode_bôm≠_bh
->
b_d©a
);

952 
ªt2
 = 0;

954 
ªt2
 = 1;

957 
	`pxt4_u∆ock_group
(
sb
, 
group
);

958 
öo
++;

959 i‡(!
ªt2
)

960 
gŸ
;

962 i‡(
öo
 < 
	`PXT4_INODES_PER_GROUP
(
sb
))

963 
ª≥©_ö_this_group
;

964 
√xt_group
:

965 i‡(++
group
 =
ngroups
)

966 
group
 = 0;

968 
îr
 = -
ENOSPC
;

969 
out
;

971 
gŸ
:

972 
	`BUFFER_TRACE
(
öode_bôm≠_bh
, "callÖxt4_handle_dirty_metadata");

973 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
öode_bôm≠_bh
);

974 i‡(
îr
) {

975 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

976 
out
;

979 
	`BUFFER_TRACE
(
group_desc_bh
, "get_write_access");

980 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
group_desc_bh
);

981 i‡(
îr
) {

982 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

983 
out
;

987 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

988 
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
)) {

989 
buf„r_hód
 *
block_bôm≠_bh
;

991 
block_bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

992 i‡(
	`IS_ERR
(
block_bôm≠_bh
)) {

993 
îr
 = 
	`PTR_ERR
(
block_bôm≠_bh
);

994 
out
;

996 
	`BUFFER_TRACE
(
block_bôm≠_bh
, "get block bitmapáccess");

997 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
block_bôm≠_bh
);

998 i‡(
îr
) {

999 
	`bªl£
(
block_bôm≠_bh
);

1000 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1001 
out
;

1004 
	`BUFFER_TRACE
(
block_bôm≠_bh
, "dirty block bitmap");

1005 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
block_bôm≠_bh
);

1008 
	`pxt4_lock_group
(
sb
, 
group
);

1009 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

1010 (
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

1011 
gdp
->
bg_Êags
 &
	`˝u_to_À16
(~
PXT4_BG_BLOCK_UNINIT
);

1012 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
,

1013 
	`pxt4_‰ì_˛u°îs_a·î_öô
(
sb
, 
group
, 
gdp
));

1014 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
,

1015 
block_bôm≠_bh
);

1016 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1018 
	`pxt4_u∆ock_group
(
sb
, 
group
);

1019 
	`bªl£
(
block_bôm≠_bh
);

1021 i‡(
îr
) {

1022 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1023 
out
;

1028 i‡(
	`pxt4_has_group_desc_csum
(
sb
)) {

1029 
‰ì
;

1030 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1032 
	`down_ªad
(&
gΩ
->
Æloc_£m
);

1033 
	`pxt4_lock_group
(
sb
, 
group
);

1034 
‰ì
 = 
	`PXT4_INODES_PER_GROUP
(
sb
) -

1035 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
);

1036 i‡(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_UNINIT
)) {

1037 
gdp
->
bg_Êags
 &
	`˝u_to_À16
(~
PXT4_BG_INODE_UNINIT
);

1038 
‰ì
 = 0;

1045 i‡(
öo
 > 
‰ì
)

1046 
	`pxt4_ôabÀ_unu£d_£t
(
sb
, 
gdp
,

1047 (
	`PXT4_INODES_PER_GROUP
(
sb
Ë- 
öo
));

1048 
	`up_ªad
(&
gΩ
->
Æloc_£m
);

1050 
	`pxt4_lock_group
(
sb
, 
group
);

1053 
	`pxt4_‰ì_öodes_£t
(
sb
, 
gdp
, 
	`pxt4_‰ì_öodes_cou¡
(sb, gdp) - 1);

1054 i‡(
	`S_ISDIR
(
mode
)) {

1055 
	`pxt4_u£d_dús_£t
(
sb
, 
gdp
, 
	`pxt4_u£d_dús_cou¡
(sb, gdp) + 1);

1056 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

1057 
pxt4_group_t
 
f
 = 
	`pxt4_Êex_group
(
sbi
, 
group
);

1059 
	`©omic_öc
(&
sbi
->
s_Êex_groups
[
f
].
u£d_dús
);

1062 i‡(
	`pxt4_has_group_desc_csum
(
sb
)) {

1063 
	`pxt4_öode_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
, 
öode_bôm≠_bh
,

1064 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

1065 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1067 
	`pxt4_u∆ock_group
(
sb
, 
group
);

1069 
	`BUFFER_TRACE
(
group_desc_bh
, "callÖxt4_handle_dirty_metadata");

1070 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
group_desc_bh
);

1071 i‡(
îr
) {

1072 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1073 
out
;

1076 
	`≥r˝u_cou¡î_dec
(&
sbi
->
s_‰ìöodes_cou¡î
);

1077 i‡(
	`S_ISDIR
(
mode
))

1078 
	`≥r˝u_cou¡î_öc
(&
sbi
->
s_dús_cou¡î
);

1080 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

1081 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
group
);

1082 
	`©omic_dec
(&
sbi
->
s_Êex_groups
[
Êex_group
].
‰ì_öodes
);

1085 
öode
->
i_öo
 = 
öo
 + 
group
 * 
	`PXT4_INODES_PER_GROUP
(
sb
);

1087 
öode
->
i_blocks
 = 0;

1088 
öode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

1089 
ei
->
i_¸time
 = 
öode
->
i_mtime
;

1091 
	`mem£t
(
ei
->
i_d©a
, 0, (ei->i_data));

1092 
ei
->
i_dú_°¨t_lookup
 = 0;

1093 
ei
->
i_disksize
 = 0;

1096 
ei
->
i_Êags
 =

1097 
	`pxt4_mask_Êags
(
mode
, 
	`PXT4_I
(
dú
)->
i_Êags
 & 
PXT4_FL_INHERITED
);

1098 
ei
->
i_Êags
 |= i_flags;

1099 
ei
->
i_fûe_a˛
 = 0;

1100 
ei
->
i_dtime
 = 0;

1101 
ei
->
i_block_group
 = 
group
;

1102 
ei
->
i_œ°_Æloc_group
 = ~0;

1104 
	`pxt4_£t_öode_Êags
(
öode
);

1105 i‡(
	`IS_DIRSYNC
(
öode
))

1106 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

1107 i‡(
	`ö£π_öode_locked
(
öode
) < 0) {

1112 
îr
 = -
EIO
;

1113 
	`pxt4_îr‹
(
sb
, "failedÅo insert inode %lu: doublyállocated?",

1114 
öode
->
i_öo
);

1115 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
group
,

1116 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

1117 
out
;

1119 
öode
->
i_gíî©i⁄
 = 
	`¥™dom_u32
();

1122 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

1123 
__u32
 
csum
;

1124 
__À32
 
öum
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

1125 
__À32
 
gí
 = 
	`˝u_to_À32
(
öode
->
i_gíî©i⁄
);

1126 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
öum
,

1127 (
öum
));

1128 
ei
->
i_csum_£ed
 = 
	`pxt4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
gí
,

1129 (
gí
));

1132 
	`pxt4_˛ór_°©e_Êags
(
ei
);

1133 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NEW
);

1135 
ei
->
i_exåa_isize
 = 
sbi
->
s_w™t_exåa_isize
;

1136 
ei
->
i_ölöe_off
 = 0;

1137 i‡(
	`pxt4_has_„©uª_ölöe_d©a
(
sb
))

1138 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

1139 
ªt
 = 
öode
;

1140 
îr
 = 
	`dquŸ_Æloc_öode
(
öode
);

1141 i‡(
îr
)

1142 
Áû_dr›
;

1149 i‡(
í¸y±
) {

1150 
îr
 = 
	`fs¸y±_öhîô_c⁄ãxt
(
dú
, 
öode
, 
h™dÀ
, 
åue
);

1151 i‡(
îr
)

1152 
Áû_‰ì_dr›
;

1155 i‡(!(
ei
->
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

1156 
îr
 = 
	`pxt4_öô_a˛
(
h™dÀ
, 
öode
, 
dú
);

1157 i‡(
îr
)

1158 
Áû_‰ì_dr›
;

1160 
îr
 = 
	`pxt4_öô_£curôy
(
h™dÀ
, 
öode
, 
dú
, 
q°r
);

1161 i‡(
îr
)

1162 
Áû_‰ì_dr›
;

1165 i‡(
	`pxt4_has_„©uª_exã¡s
(
sb
)) {

1167 i‡(
	`S_ISDIR
(
mode
Ë|| 
	`S_ISREG
(modeË|| 
	`S_ISLNK
(mode)) {

1168 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

1169 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
öode
);

1173 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

1174 
ei
->
i_sync_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

1175 
ei
->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

1178 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1179 i‡(
îr
) {

1180 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1181 
Áû_‰ì_dr›
;

1184 
	`pxt4_debug
("Æloˇtög inodê%lu\n", 
öode
->
i_öo
);

1185 
	`åa˚_pxt4_Æloˇã_öode
(
öode
, 
dú
, 
mode
);

1186 
	`bªl£
(
öode_bôm≠_bh
);

1187  
ªt
;

1189 
Áû_‰ì_dr›
:

1190 
	`dquŸ_‰ì_öode
(
öode
);

1191 
Áû_dr›
:

1192 
	`˛ór_∆ök
(
öode
);

1193 
	`u∆ock_√w_öode
(
öode
);

1194 
out
:

1195 
	`dquŸ_dr›
(
öode
);

1196 
öode
->
i_Êags
 |
S_NOQUOTA
;

1197 
	`ùut
(
öode
);

1198 
	`bªl£
(
öode_bôm≠_bh
);

1199  
	`ERR_PTR
(
îr
);

1200 
	}
}

1203 
öode
 *
	$pxt4_‹ph™_gë
(
su≥r_block
 *
sb
, 
öo
)

1205 
max_öo
 = 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
);

1206 
pxt4_group_t
 
block_group
;

1207 
bô
;

1208 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

1209 
öode
 *öodê
NULL
;

1210 
îr
 = -
EFSCORRUPTED
;

1212 i‡(
öo
 < 
	`PXT4_FIRST_INO
(
sb
Ë|| inÿ> 
max_öo
)

1213 
bad_‹ph™
;

1215 
block_group
 = (
öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

1216 
bô
 = (
öo
 - 1Ë% 
	`PXT4_INODES_PER_GROUP
(
sb
);

1217 
bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
block_group
);

1218 i‡(
	`IS_ERR
(
bôm≠_bh
))

1219  
	`ERR_CAST
(
bôm≠_bh
);

1225 i‡(!
	`pxt4_ã°_bô
(
bô
, 
bôm≠_bh
->
b_d©a
))

1226 
bad_‹ph™
;

1228 
öode
 = 
	`pxt4_igë
(
sb
, 
öo
, 
PXT4_IGET_NORMAL
);

1229 i‡(
	`IS_ERR
(
öode
)) {

1230 
îr
 = 
	`PTR_ERR
(
öode
);

1231 
	`pxt4_îr‹
(
sb
, "couldn'tÑead orphan inode %lu (err %d)",

1232 
öo
, 
îr
);

1233  
öode
;

1242 i‡((
öode
->
i_∆ök
 && !
	`pxt4_ˇn_åunˇã
(inode)) ||

1243 
	`is_bad_öode
(
öode
))

1244 
bad_‹ph™
;

1246 i‡(
	`NEXT_ORPHAN
(
öode
Ë> 
max_öo
)

1247 
bad_‹ph™
;

1248 
	`bªl£
(
bôm≠_bh
);

1249  
öode
;

1251 
bad_‹ph™
:

1252 
	`pxt4_îr‹
(
sb
, "bad oΩh™ inodê%lu", 
öo
);

1253 i‡(
bôm≠_bh
)

1254 
	`¥ötk
(
KERN_ERR
 "pxt4_test_bit(bit=%d, block=%llu) = %d\n",

1255 
bô
, ()
bôm≠_bh
->
b_blockƒ
,

1256 
	`pxt4_ã°_bô
(
bô
, 
bôm≠_bh
->
b_d©a
));

1257 i‡(
öode
) {

1258 
	`¥ötk
(
KERN_ERR
 "is_bad_inode(inode)=%d\n",

1259 
	`is_bad_öode
(
öode
));

1260 
	`¥ötk
(
KERN_ERR
 "NEXT_ORPHAN(inode)=%u\n",

1261 
	`NEXT_ORPHAN
(
öode
));

1262 
	`¥ötk
(
KERN_ERR
 "max_öo=%lu\n", 
max_öo
);

1263 
	`¥ötk
(
KERN_ERR
 "i_∆ök=%u\n", 
öode
->
i_∆ök
);

1265 i‡(
öode
->
i_∆ök
 == 0)

1266 
öode
->
i_blocks
 = 0;

1267 
	`ùut
(
öode
);

1269 
	`bªl£
(
bôm≠_bh
);

1270  
	`ERR_PTR
(
îr
);

1271 
	}
}

1273 
	$pxt4_cou¡_‰ì_öodes
(
su≥r_block
 *
sb
)

1275 
desc_cou¡
;

1276 
pxt4_group_desc
 *
gdp
;

1277 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

1278 #ifde‡
PXT4FS_DEBUG


1279 
pxt4_su≥r_block
 *
es
;

1280 
bôm≠_cou¡
, 
x
;

1281 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

1283 
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

1284 
desc_cou¡
 = 0;

1285 
bôm≠_cou¡
 = 0;

1286 
gdp
 = 
NULL
;

1287 
i
 = 0; i < 
ngroups
; i++) {

1288 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

1289 i‡(!
gdp
)

1291 
desc_cou¡
 +
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
);

1292 
	`bªl£
(
bôm≠_bh
);

1293 
bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
i
);

1294 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

1295 
bôm≠_bh
 = 
NULL
;

1299 
x
 = 
	`pxt4_cou¡_‰ì
(
bôm≠_bh
->
b_d©a
,

1300 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

1301 
	`¥ötk
(
KERN_DEBUG
 "group %lu: stored = %d, counted = %lu\n",

1302 (Ë
i
, 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
), 
x
);

1303 
bôm≠_cou¡
 +
x
;

1305 
	`bªl£
(
bôm≠_bh
);

1306 
	`¥ötk
(
KERN_DEBUG
 "pxt4_count_free_inodes: "

1308 
	`À32_to_˝u
(
es
->
s_‰ì_öodes_cou¡
), 
desc_cou¡
, 
bôm≠_cou¡
);

1309  
desc_cou¡
;

1311 
desc_cou¡
 = 0;

1312 
i
 = 0; i < 
ngroups
; i++) {

1313 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

1314 i‡(!
gdp
)

1316 
desc_cou¡
 +
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
);

1317 
	`c⁄d_ªsched
();

1319  
desc_cou¡
;

1321 
	}
}

1324 
	$pxt4_cou¡_dús
(
su≥r_block
 * 
sb
)

1326 
cou¡
 = 0;

1327 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

1329 
i
 = 0; i < 
ngroups
; i++) {

1330 
pxt4_group_desc
 *
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

1331 i‡(!
gdp
)

1333 
cou¡
 +
	`pxt4_u£d_dús_cou¡
(
sb
, 
gdp
);

1335  
cou¡
;

1336 
	}
}

1346 
	$pxt4_öô_öode_èbÀ
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

1347 
b¨rõr
)

1349 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1350 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1351 
pxt4_group_desc
 *
gdp
 = 
NULL
;

1352 
buf„r_hód
 *
group_desc_bh
;

1353 
h™dÀ_t
 *
h™dÀ
;

1354 
pxt4_fsblk_t
 
blk
;

1355 
num
, 
ªt
 = 0, 
u£d_blks
 = 0;

1358 i‡(
	`sb_rd⁄ly
(
sb
)) {

1359 
ªt
 = 1;

1360 
out
;

1363 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, &
group_desc_bh
);

1364 i‡(!
gdp
)

1365 
out
;

1371 i‡(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
))

1372 
out
;

1374 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_MISC
, 1);

1375 i‡(
	`IS_ERR
(
h™dÀ
)) {

1376 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

1377 
out
;

1380 
	`down_wrôe
(&
gΩ
->
Æloc_£m
);

1386 i‡(!(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_UNINIT
)))

1387 
u£d_blks
 = 
	`DIV_ROUND_UP
((
	`PXT4_INODES_PER_GROUP
(
sb
) -

1388 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
)),

1389 
sbi
->
s_öodes_≥r_block
);

1391 i‡((
u£d_blks
 < 0Ë|| (u£d_blk†> 
sbi
->
s_ôb_≥r_group
) ||

1392 ((
group
 =0Ë&& ((
	`PXT4_INODES_PER_GROUP
(
sb
) -

1393 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
)) <

1394 
	`PXT4_FIRST_INO
(
sb
)))) {

1395 
	`pxt4_îr‹
(
sb
, "Something is wrong with group %u: "

1398 
group
, 
u£d_blks
,

1399 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
));

1400 
ªt
 = 1;

1401 
îr_out
;

1404 
blk
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
Ë+ 
u£d_blks
;

1405 
num
 = 
sbi
->
s_ôb_≥r_group
 - 
u£d_blks
;

1407 
	`BUFFER_TRACE
(
group_desc_bh
, "get_write_access");

1408 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

1409 
group_desc_bh
);

1410 i‡(
ªt
)

1411 
îr_out
;

1418 i‡(
	`u∆ikñy
(
num
 == 0))

1419 
skù_zîoout
;

1421 
	`pxt4_debug
("goingÅo zero out inodeÅable in group %d\n",

1422 
group
);

1423 
ªt
 = 
	`sb_issue_zîoout
(
sb
, 
blk
, 
num
, 
GFP_NOFS
);

1424 i‡(
ªt
 < 0)

1425 
îr_out
;

1426 i‡(
b¨rõr
)

1427 
	`blkdev_issue_Êush
(
sb
->
s_bdev
, 
GFP_NOFS
, 
NULL
);

1429 
skù_zîoout
:

1430 
	`pxt4_lock_group
(
sb
, 
group
);

1431 
gdp
->
bg_Êags
 |
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
);

1432 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1433 
	`pxt4_u∆ock_group
(
sb
, 
group
);

1435 
	`BUFFER_TRACE
(
group_desc_bh
,

1437 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
,

1438 
group_desc_bh
);

1440 
îr_out
:

1441 
	`up_wrôe
(&
gΩ
->
Æloc_£m
);

1442 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1443 
out
:

1444  
ªt
;

1445 
	}
}

	@indirect.c

24 
	~"pxt4_jbd3.h
"

25 
	~"åunˇã.h
"

26 
	~<löux/dax.h
>

27 
	~<löux/uio.h
>

29 
	~<åa˚/evíts/pxt4.h
>

32 
__À32
 *
	mp
;

33 
__À32
 
	mkey
;

34 
buf„r_hód
 *
	mbh
;

35 } 
	tIndúe˘
;

37 
ölöe
 
	$add_chaö
(
Indúe˘
 *
p
, 
buf„r_hód
 *
bh
, 
__À32
 *
v
)

39 
p
->
key
 = *’->∞
v
);

40 
p
->
bh
 = bh;

41 
	}
}

74 
	$pxt4_block_to_∑th
(
öode
 *inode,

75 
pxt4_lblk_t
 
i_block
,

76 
pxt4_lblk_t
 
off£ts
[4], *
bound¨y
)

78 
±rs
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

79 
±rs_bôs
 = 
	`PXT4_ADDR_PER_BLOCK_BITS
(
öode
->
i_sb
);

80 c⁄° 
dúe˘_blocks
 = 
PXT4_NDIR_BLOCKS
,

81 
ödúe˘_blocks
 = 
±rs
,

82 
doubÀ_blocks
 = (1 << (
±rs_bôs
 * 2));

83 
n
 = 0;

84 
föÆ
 = 0;

86 i‡(
i_block
 < 
dúe˘_blocks
) {

87 
off£ts
[
n
++] = 
i_block
;

88 
föÆ
 = 
dúe˘_blocks
;

89 } i‡((
i_block
 -
dúe˘_blocks
Ë< 
ödúe˘_blocks
) {

90 
off£ts
[
n
++] = 
PXT4_IND_BLOCK
;

91 
off£ts
[
n
++] = 
i_block
;

92 
föÆ
 = 
±rs
;

93 } i‡((
i_block
 -
ödúe˘_blocks
Ë< 
doubÀ_blocks
) {

94 
off£ts
[
n
++] = 
PXT4_DIND_BLOCK
;

95 
off£ts
[
n
++] = 
i_block
 >> 
±rs_bôs
;

96 
off£ts
[
n
++] = 
i_block
 & (
±rs
 - 1);

97 
föÆ
 = 
±rs
;

98 } i‡(((
i_block
 -
doubÀ_blocks
Ë>> (
±rs_bôs
 * 2)Ë< 
±rs
) {

99 
off£ts
[
n
++] = 
PXT4_TIND_BLOCK
;

100 
off£ts
[
n
++] = 
i_block
 >> (
±rs_bôs
 * 2);

101 
off£ts
[
n
++] = (
i_block
 >> 
±rs_bôs
Ë& (
±rs
 - 1);

102 
off£ts
[
n
++] = 
i_block
 & (
±rs
 - 1);

103 
föÆ
 = 
±rs
;

105 
	`pxt4_w¨nög
(
öode
->
i_sb
, "block %lu > max in inode %lu",

106 
i_block
 + 
dúe˘_blocks
 +

107 
ödúe˘_blocks
 + 
doubÀ_blocks
, 
öode
->
i_öo
);

109 i‡(
bound¨y
)

110 *
bound¨y
 = 
föÆ
 - 1 - (
i_block
 & (
±rs
 - 1));

111  
n
;

112 
	}
}

144 
Indúe˘
 *
	$pxt4_gë_bønch
(
öode
 *öode, 
dïth
,

145 
pxt4_lblk_t
 *
off£ts
,

146 
Indúe˘
 
chaö
[4], *
îr
)

148 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

149 
Indúe˘
 *
p
 = 
chaö
;

150 
buf„r_hód
 *
bh
;

151 
ªt
 = -
EIO
;

153 *
îr
 = 0;

155 
	`add_chaö
(
chaö
, 
NULL
, 
	`PXT4_I
(
öode
)->
i_d©a
 + *
off£ts
);

156 i‡(!
p
->
key
)

157 
no_block
;

158 --
dïth
) {

159 
bh
 = 
	`sb_gëblk
(
sb
, 
	`À32_to_˝u
(
p
->
key
));

160 i‡(
	`u∆ikñy
(!
bh
)) {

161 
ªt
 = -
ENOMEM
;

162 
Áûuª
;

165 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

166 i‡(
	`bh_submô_ªad
(
bh
) < 0) {

167 
	`put_bh
(
bh
);

168 
Áûuª
;

171 i‡(
	`pxt4_check_ödúe˘_blockªf
(
öode
, 
bh
)) {

172 
	`put_bh
(
bh
);

173 
Áûuª
;

177 
	`add_chaö
(++
p
, 
bh
, (
__À32
 *)bh->
b_d©a
 + *++
off£ts
);

179 i‡(!
p
->
key
)

180 
no_block
;

182  
NULL
;

184 
Áûuª
:

185 *
îr
 = 
ªt
;

186 
no_block
:

187  
p
;

188 
	}
}

210 
pxt4_fsblk_t
 
	$pxt4_föd_√¨
(
öode
 *öode, 
Indúe˘
 *
öd
)

212 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

213 
__À32
 *
°¨t
 = 
öd
->
bh
 ? (__À32 *Ëöd->bh->
b_d©a
 : 
ei
->
i_d©a
;

214 
__À32
 *
p
;

217 
p
 = 
öd
->∞- 1;Ö >
°¨t
;Ö--) {

218 i‡(*
p
)

219  
	`À32_to_˝u
(*
p
);

223 i‡(
öd
->
bh
)

224  
öd
->
bh
->
b_blockƒ
;

230  
	`pxt4_öode_to_gﬂl_block
(
öode
);

231 
	}
}

244 
pxt4_fsblk_t
 
	$pxt4_föd_gﬂl
(
öode
 *öode, 
pxt4_lblk_t
 
block
,

245 
Indúe˘
 *
∑πül
)

247 
pxt4_fsblk_t
 
gﬂl
;

253 
gﬂl
 = 
	`pxt4_föd_√¨
(
öode
, 
∑πül
);

254 
gﬂl
 = gﬂ»& 
PXT4_MAX_BLOCK_FILE_PHYS
;

255  
gﬂl
;

256 
	}
}

270 
	$pxt4_blks_to_Æloˇã
(
Indúe˘
 *
bønch
, 
k
, 
blks
,

271 
blocks_to_bound¨y
)

273 
cou¡
 = 0;

279 i‡(
k
 > 0) {

281 i‡(
blks
 < 
blocks_to_bound¨y
 + 1)

282 
cou¡
 +
blks
;

284 
cou¡
 +
blocks_to_bound¨y
 + 1;

285  
cou¡
;

288 
cou¡
++;

289 
cou¡
 < 
blks
 && cou¡ <
blocks_to_bound¨y
 &&

290 
	`À32_to_˝u
(*(
bønch
[0].
p
 + 
cou¡
)) == 0) {

291 
cou¡
++;

293  
cou¡
;

294 
	}
}

321 
	$pxt4_Æloc_bønch
(
h™dÀ_t
 *
h™dÀ
,

322 
pxt4_Æloˇti⁄_ªque°
 *
¨
,

323 
ödúe˘_blks
, 
pxt4_lblk_t
 *
off£ts
,

324 
Indúe˘
 *
bønch
)

326 
buf„r_hód
 * 
bh
;

327 
pxt4_fsblk_t
 
b
, 
√w_blocks
[4];

328 
__À32
 *
p
;

329 
i
, 
j
, 
îr
, 
Àn
 = 1;

331 
i
 = 0; i <
ödúe˘_blks
; i++) {

332 i‡(
i
 =
ödúe˘_blks
) {

333 
√w_blocks
[
i
] = 
	`pxt4_mb_√w_blocks
(
h™dÀ
, 
¨
, &
îr
);

335 
¨
->
gﬂl
 = 
√w_blocks
[
i
] = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
,

336 
¨
->
öode
,ár->
gﬂl
,

337 
¨
->
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
,

338 
NULL
, &
îr
);

339 i‡(
îr
) {

340 
i
--;

341 
Áûed
;

343 
bønch
[
i
].
key
 = 
	`˝u_to_À32
(
√w_blocks
[i]);

344 i‡(
i
 == 0)

347 
bh
 = 
bønch
[
i
].bh = 
	`sb_gëblk
(
¨
->
öode
->
i_sb
, 
√w_blocks
[i-1]);

348 i‡(
	`u∆ikñy
(!
bh
)) {

349 
îr
 = -
ENOMEM
;

350 
Áûed
;

352 
	`lock_buf„r
(
bh
);

353 
	`BUFFER_TRACE
(
bh
, "call get_create_access");

354 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

355 i‡(
îr
) {

356 
	`u∆ock_buf„r
(
bh
);

357 
Áûed
;

360 
	`mem£t
(
bh
->
b_d©a
, 0, bh->
b_size
);

361 
p
 = 
bønch
[
i
].∞(
__À32
 *Ë
bh
->
b_d©a
 + 
off£ts
[i];

362 
b
 = 
√w_blocks
[
i
];

364 i‡(
i
 =
ödúe˘_blks
)

365 
Àn
 = 
¨
->len;

366 
j
 = 0; j < 
Àn
; j++)

367 *
p
++ = 
	`˝u_to_À32
(
b
++);

369 
	`BUFFER_TRACE
(
bh
, "marking uptodate");

370 
	`£t_buf„r_u±od©e
(
bh
);

371 
	`u∆ock_buf„r
(
bh
);

373 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

374 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
¨
->
öode
, 
bh
);

375 i‡(
îr
)

376 
Áûed
;

379 
Áûed
:

380 ; 
i
 >= 0; i--) {

387 i‡(
i
 > 0 && i !
ödúe˘_blks
 && 
bønch
[i].
bh
)

388 
	`pxt4_f‹gë
(
h™dÀ
, 1, 
¨
->
öode
, 
bønch
[
i
].
bh
,

389 
bønch
[
i
].
bh
->
b_blockƒ
);

390 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
¨
->
öode
, 
NULL
, 
√w_blocks
[
i
],

391 (
i
 =
ödúe˘_blks
Ë? 
¨
->
Àn
 : 1, 0);

393  
îr
;

394 
	}
}

407 
	$pxt4_•li˚_bønch
(
h™dÀ_t
 *
h™dÀ
,

408 
pxt4_Æloˇti⁄_ªque°
 *
¨
,

409 
Indúe˘
 *
whîe
, 
num
)

411 
i
;

412 
îr
 = 0;

413 
pxt4_fsblk_t
 
cuºít_block
;

420 i‡(
whîe
->
bh
) {

421 
	`BUFFER_TRACE
(
whîe
->
bh
, "get_write_access");

422 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
whîe
->
bh
);

423 i‡(
îr
)

424 
îr_out
;

428 *
whîe
->
p
 = whîe->
key
;

434 i‡(
num
 =0 && 
¨
->
Àn
 > 1) {

435 
cuºít_block
 = 
	`À32_to_˝u
(
whîe
->
key
) + 1;

436 
i
 = 1; i < 
¨
->
Àn
; i++)

437 *(
whîe
->
p
 + 
i
Ë
	`˝u_to_À32
(
cuºít_block
++);

442 i‡(
whîe
->
bh
) {

451 
	`jbd_debug
(5, "splicing indirect only\n");

452 
	`BUFFER_TRACE
(
whîe
->
bh
, "callÖxt4_handle_dirty_metadata");

453 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
¨
->
öode
, 
whîe
->
bh
);

454 i‡(
îr
)

455 
îr_out
;

460 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
¨
->
öode
);

461 
	`jbd_debug
(5, "splicing direct\n");

463  
îr
;

465 
îr_out
:

466 
i
 = 1; i <
num
; i++) {

472 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
¨
->
öode
, 
whîe
[
i
].
bh
, 0, 1,

473 
PXT4_FREE_BLOCKS_FORGET
);

475 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
¨
->
öode
, 
NULL
, 
	`À32_to_˝u
(
whîe
[
num
].
key
),

476 
¨
->
Àn
, 0);

478  
îr
;

479 
	}
}

509 
	$pxt4_öd_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

510 
pxt4_m≠_blocks
 *
m≠
,

511 
Êags
)

513 
pxt4_Æloˇti⁄_ªque°
 
¨
;

514 
îr
 = -
EIO
;

515 
pxt4_lblk_t
 
off£ts
[4];

516 
Indúe˘
 
chaö
[4];

517 
Indúe˘
 *
∑πül
;

518 
ödúe˘_blks
;

519 
blocks_to_bound¨y
 = 0;

520 
dïth
;

521 
cou¡
 = 0;

522 
pxt4_fsblk_t
 
fú°_block
 = 0;

524 
	`åa˚_pxt4_öd_m≠_blocks_íãr
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
, 
Êags
);

525 
	`J_ASSERT
(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)));

526 
	`J_ASSERT
(
h™dÀ
 !
NULL
 || (
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0);

527 
dïth
 = 
	`pxt4_block_to_∑th
(
öode
, 
m≠
->
m_lblk
, 
off£ts
,

528 &
blocks_to_bound¨y
);

530 i‡(
dïth
 == 0)

531 
out
;

533 
∑πül
 = 
	`pxt4_gë_bønch
(
öode
, 
dïth
, 
off£ts
, 
chaö
, &
îr
);

536 i‡(!
∑πül
) {

537 
fú°_block
 = 
	`À32_to_˝u
(
chaö
[
dïth
 - 1].
key
);

538 
cou¡
++;

540 
cou¡
 < 
m≠
->
m_Àn
 && cou¡ <
blocks_to_bound¨y
) {

541 
pxt4_fsblk_t
 
blk
;

543 
blk
 = 
	`À32_to_˝u
(*(
chaö
[
dïth
-1].
p
 + 
cou¡
));

545 i‡(
blk
 =
fú°_block
 + 
cou¡
)

546 
cou¡
++;

550 
gŸ_ô
;

554 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0) {

555 
ïb
 = 
öode
->
i_sb
->
s_blocksize
 / (
u32
);

556 
i
;

564 
cou¡
 = 0;

565 
i
 = 
∑πül
 - 
chaö
 + 1; i < 
dïth
; i++)

566 
cou¡
 = cou¡ * 
ïb
 + (ïb - 
off£ts
[
i
] - 1);

567 
cou¡
++;

569 
m≠
->
m_pblk
 = 0;

570 
m≠
->
m_Àn
 = 
	`mö_t
(, m≠->m_Àn, 
cou¡
);

571 
˛ónup
;

575 i‡(
îr
 =-
EIO
)

576 
˛ónup
;

581 i‡(
	`pxt4_has_„©uª_bigÆloc
(
öode
->
i_sb
)) {

582 
	`PXT4_ERROR_INODE
(
öode
, "Can'tállocate blocks for "

584  -
EFSCORRUPTED
;

588 
	`mem£t
(&
¨
, 0, (ar));

589 
¨
.
öode
 = inode;

590 
¨
.
logiˇl
 = 
m≠
->
m_lblk
;

591 i‡(
	`S_ISREG
(
öode
->
i_mode
))

592 
¨
.
Êags
 = 
PXT4_MB_HINT_DATA
;

593 i‡(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
)

594 
¨
.
Êags
 |
PXT4_MB_DELALLOC_RESERVED
;

595 i‡(
Êags
 & 
PXT4_GET_BLOCKS_METADATA_NOFAIL
)

596 
¨
.
Êags
 |
PXT4_MB_USE_RESERVED
;

598 
¨
.
gﬂl
 = 
	`pxt4_föd_gﬂl
(
öode
, 
m≠
->
m_lblk
, 
∑πül
);

601 
ödúe˘_blks
 = (
chaö
 + 
dïth
Ë- 
∑πül
 - 1;

607 
¨
.
Àn
 = 
	`pxt4_blks_to_Æloˇã
(
∑πül
, 
ödúe˘_blks
,

608 
m≠
->
m_Àn
, 
blocks_to_bound¨y
);

613 
îr
 = 
	`pxt4_Æloc_bønch
(
h™dÀ
, &
¨
, 
ödúe˘_blks
,

614 
off£ts
 + (
∑πül
 - 
chaö
),Öartial);

623 i‡(!
îr
)

624 
îr
 = 
	`pxt4_•li˚_bønch
(
h™dÀ
, &
¨
, 
∑πül
, 
ödúe˘_blks
);

625 i‡(
îr
)

626 
˛ónup
;

628 
m≠
->
m_Êags
 |
PXT4_MAP_NEW
;

630 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

631 
cou¡
 = 
¨
.
Àn
;

632 
gŸ_ô
:

633 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

634 
m≠
->
m_pblk
 = 
	`À32_to_˝u
(
chaö
[
dïth
-1].
key
);

635 
m≠
->
m_Àn
 = 
cou¡
;

636 i‡(
cou¡
 > 
blocks_to_bound¨y
)

637 
m≠
->
m_Êags
 |
PXT4_MAP_BOUNDARY
;

638 
îr
 = 
cou¡
;

640 
∑πül
 = 
chaö
 + 
dïth
 - 1;

641 
˛ónup
:

642 
∑πül
 > 
chaö
) {

643 
	`BUFFER_TRACE
(
∑πül
->
bh
, "call brelse");

644 
	`bªl£
(
∑πül
->
bh
);

645 
∑πül
--;

647 
out
:

648 
	`åa˚_pxt4_öd_m≠_blocks_exô
(
öode
, 
Êags
, 
m≠
, 
îr
);

649  
îr
;

650 
	}
}

656 
	$pxt4_öd_ˇlc_mëad©a_amou¡
(
öode
 *öode, 
£˘‹_t
 
lblock
)

658 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

659 
£˘‹_t
 
död_mask
 = ~((£˘‹_t)
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
) - 1);

660 
blk_bôs
;

662 i‡(
lblock
 < 
PXT4_NDIR_BLOCKS
)

665 
lblock
 -
PXT4_NDIR_BLOCKS
;

667 i‡(
ei
->
i_da_mëad©a_ˇlc_Àn
 &&

668 (
lblock
 & 
död_mask
Ë=
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
) {

669 
ei
->
i_da_mëad©a_ˇlc_Àn
++;

672 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
 = 
lblock
 & 
död_mask
;

673 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 1;

674 
blk_bôs
 = 
	`‹dî_ba£_2
(
lblock
);

675  (
blk_bôs
 / 
	`PXT4_ADDR_PER_BLOCK_BITS
(
öode
->
i_sb
)) + 1;

676 
	}
}

682 
	$pxt4_öd_å™s_blocks
(
öode
 *öode, 
ƒblocks
)

689  
	`DIV_ROUND_UP
(
ƒblocks
, 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
)) + 4;

690 
	}
}

704 
	$åy_to_exãnd_å™ß˘i⁄
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

706 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

708 i‡(
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
, 
PXT4_RESERVE_TRANS_BLOCKS
+1))

710 i‡(!
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
	`pxt4_blocks_f‹_åunˇã
(
öode
)))

713 
	}
}

720 
ölöe
 
	$Æl_zî€s
(
__À32
 *
p
, __À32 *
q
)

722 
p
 < 
q
)

723 i‡(*
p
++)

726 
	}
}

763 
Indúe˘
 *
	$pxt4_föd_sh¨ed
(
öode
 *öode, 
dïth
,

764 
pxt4_lblk_t
 
off£ts
[4], 
Indúe˘
 
chaö
[4],

765 
__À32
 *
t›
)

767 
Indúe˘
 *
∑πül
, *
p
;

768 
k
, 
îr
;

770 *
t›
 = 0;

772 
k
 = 
dïth
; k > 1 && !
off£ts
[k-1]; k--)

774 
∑πül
 = 
	`pxt4_gë_bønch
(
öode
, 
k
, 
off£ts
, 
chaö
, &
îr
);

776 i‡(!
∑πül
)

777 
∑πül
 = 
chaö
 + 
k
-1;

782 i‡(!
∑πül
->
key
 && *∑πül->
p
)

784 
no_t›
;

785 
p
 = 
∑πül
; (∞> 
chaö
Ë&& 
	`Æl_zî€s
((
__À32
 *Ëp->
bh
->
b_d©a
,Ö->p);Ö--)

793 i‡(
p
 =
chaö
 + 
k
 - 1 &&Ö > chain) {

794 
p
->p--;

796 *
t›
 = *
p
->p;

799 *
p
->p = 0;

804 
∑πül
 > 
p
) {

805 
	`bªl£
(
∑πül
->
bh
);

806 
∑πül
--;

808 
no_t›
:

809  
∑πül
;

810 
	}
}

823 
	$pxt4_˛ór_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

824 
buf„r_hód
 *
bh
,

825 
pxt4_fsblk_t
 
block_to_‰ì
,

826 
cou¡
, 
__À32
 *
fú°
,

827 
__À32
 *
œ°
)

829 
__À32
 *
p
;

830 
Êags
 = 
PXT4_FREE_BLOCKS_VALIDATED
;

831 
îr
;

833 i‡(
	`S_ISDIR
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode) ||

834 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EA_INODE
))

835 
Êags
 |
PXT4_FREE_BLOCKS_FORGET
 | 
PXT4_FREE_BLOCKS_METADATA
;

836 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

837 
Êags
 |
PXT4_FREE_BLOCKS_FORGET
;

839 i‡(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
block_to_‰ì
,

840 
cou¡
)) {

841 
	`PXT4_ERROR_INODE
(
öode
, "attemptÅo clear invalid "

843 (Ë
block_to_‰ì
, 
cou¡
);

847 i‡(
	`åy_to_exãnd_å™ß˘i⁄
(
h™dÀ
, 
öode
)) {

848 i‡(
bh
) {

849 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

850 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

851 i‡(
	`u∆ikñy
(
îr
))

852 
out_îr
;

854 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

855 i‡(
	`u∆ikñy
(
îr
))

856 
out_îr
;

857 
îr
 = 
	`pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ
, 
öode
,

858 
	`pxt4_blocks_f‹_åunˇã
(
öode
));

859 i‡(
	`u∆ikñy
(
îr
))

860 
out_îr
;

861 i‡(
bh
) {

862 
	`BUFFER_TRACE
(
bh
, "retaking writeáccess");

863 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

864 i‡(
	`u∆ikñy
(
îr
))

865 
out_îr
;

869 
p
 = 
fú°
;Ö < 
œ°
;Ö++)

870 *
p
 = 0;

872 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
block_to_‰ì
, 
cou¡
, 
Êags
);

874 
out_îr
:

875 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

876  
îr
;

877 
	}
}

898 
	$pxt4_‰ì_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

899 
buf„r_hód
 *
this_bh
,

900 
__À32
 *
fú°
, __À32 *
œ°
)

902 
pxt4_fsblk_t
 
block_to_‰ì
 = 0;

903 
cou¡
 = 0;

904 
__À32
 *
block_to_‰ì_p
 = 
NULL
;

907 
pxt4_fsblk_t
 
ƒ
;

908 
__À32
 *
p
;

910 
îr
 = 0;

912 i‡(
this_bh
) {

913 
	`BUFFER_TRACE
(
this_bh
, "get_write_access");

914 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
this_bh
);

917 i‡(
îr
)

921 
p
 = 
fú°
;Ö < 
œ°
;Ö++) {

922 
ƒ
 = 
	`À32_to_˝u
(*
p
);

923 i‡(
ƒ
) {

925 i‡(
cou¡
 == 0) {

926 
block_to_‰ì
 = 
ƒ
;

927 
block_to_‰ì_p
 = 
p
;

928 
cou¡
 = 1;

929 } i‡(
ƒ
 =
block_to_‰ì
 + 
cou¡
) {

930 
cou¡
++;

932 
îr
 = 
	`pxt4_˛ór_blocks
(
h™dÀ
, 
öode
, 
this_bh
,

933 
block_to_‰ì
, 
cou¡
,

934 
block_to_‰ì_p
, 
p
);

935 i‡(
îr
)

937 
block_to_‰ì
 = 
ƒ
;

938 
block_to_‰ì_p
 = 
p
;

939 
cou¡
 = 1;

944 i‡(!
îr
 && 
cou¡
 > 0)

945 
îr
 = 
	`pxt4_˛ór_blocks
(
h™dÀ
, 
öode
, 
this_bh
, 
block_to_‰ì
,

946 
cou¡
, 
block_to_‰ì_p
, 
p
);

947 i‡(
îr
 < 0)

951 i‡(
this_bh
) {

952 
	`BUFFER_TRACE
(
this_bh
, "callÖxt4_handle_dirty_metadata");

960 i‡((
	`PXT4_JOURNAL
(
öode
Ë=
NULL
Ë|| 
	`bh2jh
(
this_bh
))

961 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
this_bh
);

963 
	`PXT4_ERROR_INODE
(
öode
,

966 (Ë
this_bh
->
b_blockƒ
);

968 
	}
}

983 
	$pxt4_‰ì_bønches
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

984 
buf„r_hód
 *
∑ª¡_bh
,

985 
__À32
 *
fú°
, __À32 *
œ°
, 
dïth
)

987 
pxt4_fsblk_t
 
ƒ
;

988 
__À32
 *
p
;

990 i‡(
	`pxt4_h™dÀ_is_ab‹ãd
(
h™dÀ
))

993 i‡(
dïth
--) {

994 
buf„r_hód
 *
bh
;

995 
addr_≥r_block
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

996 
p
 = 
œ°
;

997 --
p
 >
fú°
) {

998 
ƒ
 = 
	`À32_to_˝u
(*
p
);

999 i‡(!
ƒ
)

1002 i‡(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
),

1003 
ƒ
, 1)) {

1004 
	`PXT4_ERROR_INODE
(
öode
,

1007 (Ë
ƒ
, 
dïth
);

1012 
bh
 = 
	`sb_bªad
(
öode
->
i_sb
, 
ƒ
);

1018 i‡(!
bh
) {

1019 
	`PXT4_ERROR_INODE_BLOCK
(
öode
, 
ƒ
,

1025 
	`BUFFER_TRACE
(
bh
, "free child branches");

1026 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
bh
,

1027 (
__À32
 *Ë
bh
->
b_d©a
,

1028 (
__À32
 *Ë
bh
->
b_d©a
 + 
addr_≥r_block
,

1029 
dïth
);

1030 
	`bªl£
(
bh
);

1048 i‡(
	`pxt4_h™dÀ_is_ab‹ãd
(
h™dÀ
))

1050 i‡(
	`åy_to_exãnd_å™ß˘i⁄
(
h™dÀ
, 
öode
)) {

1051 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1052 
	`pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ
, 
öode
,

1053 
	`pxt4_blocks_f‹_åunˇã
(
öode
));

1067 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
ƒ
, 1,

1068 
PXT4_FREE_BLOCKS_METADATA
|

1069 
PXT4_FREE_BLOCKS_FORGET
);

1071 i‡(
∑ª¡_bh
) {

1076 
	`BUFFER_TRACE
(
∑ª¡_bh
, "get_write_access");

1077 i‡(!
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

1078 
∑ª¡_bh
)){

1079 *
p
 = 0;

1080 
	`BUFFER_TRACE
(
∑ª¡_bh
,

1082 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

1083 
öode
,

1084 
∑ª¡_bh
);

1090 
	`BUFFER_TRACE
(
∑ª¡_bh
, "free data blocks");

1091 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
∑ª¡_bh
, 
fú°
, 
œ°
);

1093 
	}
}

1095 
	$pxt4_öd_åunˇã
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

1097 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1098 
__À32
 *
i_d©a
 = 
ei
->i_data;

1099 
addr_≥r_block
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

1100 
pxt4_lblk_t
 
off£ts
[4];

1101 
Indúe˘
 
chaö
[4];

1102 
Indúe˘
 *
∑πül
;

1103 
__À32
 
ƒ
 = 0;

1104 
n
 = 0;

1105 
pxt4_lblk_t
 
œ°_block
, 
max_block
;

1106 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

1108 
œ°_block
 = (
öode
->
i_size
 + 
blocksize
-1)

1109 >> 
	`PXT4_BLOCK_SIZE_BITS
(
öode
->
i_sb
);

1110 
max_block
 = (
	`PXT4_SB
(
öode
->
i_sb
)->
s_bôm≠_maxbyãs
 + 
blocksize
-1)

1111 >> 
	`PXT4_BLOCK_SIZE_BITS
(
öode
->
i_sb
);

1113 i‡(
œ°_block
 !
max_block
) {

1114 
n
 = 
	`pxt4_block_to_∑th
(
öode
, 
œ°_block
, 
off£ts
, 
NULL
);

1115 i‡(
n
 == 0)

1119 
	`pxt4_es_ªmove_exã¡
(
öode
, 
œ°_block
, 
EXT_MAX_BLOCKS
 -Üast_block);

1128 
ei
->
i_disksize
 = 
öode
->
i_size
;

1130 i‡(
œ°_block
 =
max_block
) {

1136 } i‡(
n
 == 1) {

1137 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
NULL
, 
i_d©a
+
off£ts
[0],

1138 
i_d©a
 + 
PXT4_NDIR_BLOCKS
);

1139 
do_ödúe˘s
;

1142 
∑πül
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n
, 
off£ts
, 
chaö
, &
ƒ
);

1144 i‡(
ƒ
) {

1145 i‡(
∑πül
 =
chaö
) {

1147 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
,

1148 &
ƒ
, &ƒ+1, (
chaö
+
n
-1Ë- 
∑πül
);

1149 *
∑πül
->
p
 = 0;

1156 
	`BUFFER_TRACE
(
∑πül
->
bh
, "get_write_access");

1157 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1158 
∑πül
->
p
,

1159 
∑πül
->
p
+1, (
chaö
+
n
-1) -Öartial);

1163 
∑πül
 > 
chaö
) {

1164 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,Ö¨tül->
p
 + 1,

1165 (
__À32
*)
∑πül
->
bh
->
b_d©a
+
addr_≥r_block
,

1166 (
chaö
+
n
-1Ë- 
∑πül
);

1167 
	`BUFFER_TRACE
(
∑πül
->
bh
, "call brelse");

1168 
	`bªl£
(
∑πül
->
bh
);

1169 
∑πül
--;

1171 
do_ödúe˘s
:

1173 
off£ts
[0]) {

1175 
ƒ
 = 
i_d©a
[
PXT4_IND_BLOCK
];

1176 i‡(
ƒ
) {

1177 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 1);

1178 
i_d©a
[
PXT4_IND_BLOCK
] = 0;

1181 
PXT4_IND_BLOCK
:

1182 
ƒ
 = 
i_d©a
[
PXT4_DIND_BLOCK
];

1183 i‡(
ƒ
) {

1184 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 2);

1185 
i_d©a
[
PXT4_DIND_BLOCK
] = 0;

1188 
PXT4_DIND_BLOCK
:

1189 
ƒ
 = 
i_d©a
[
PXT4_TIND_BLOCK
];

1190 i‡(
ƒ
) {

1191 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 3);

1192 
i_d©a
[
PXT4_TIND_BLOCK
] = 0;

1195 
PXT4_TIND_BLOCK
:

1198 
	}
}

1210 
	$pxt4_öd_ªmove_•a˚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1211 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
)

1213 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1214 
__À32
 *
i_d©a
 = 
ei
->i_data;

1215 
addr_≥r_block
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

1216 
pxt4_lblk_t
 
off£ts
[4], 
off£ts2
[4];

1217 
Indúe˘
 
chaö
[4], 
chaö2
[4];

1218 
Indúe˘
 *
∑πül
, *
∑πül2
;

1219 
Indúe˘
 *
p
 = 
NULL
, *
p2
 = NULL;

1220 
pxt4_lblk_t
 
max_block
;

1221 
__À32
 
ƒ
 = 0, 
ƒ2
 = 0;

1222 
n
 = 0, 
n2
 = 0;

1223 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

1225 
max_block
 = (
	`PXT4_SB
(
öode
->
i_sb
)->
s_bôm≠_maxbyãs
 + 
blocksize
-1)

1226 >> 
	`PXT4_BLOCK_SIZE_BITS
(
öode
->
i_sb
);

1227 i‡(
íd
 >
max_block
)

1228 
íd
 = 
max_block
;

1229 i‡((
°¨t
 >
íd
Ë|| (°¨à> 
max_block
))

1232 
n
 = 
	`pxt4_block_to_∑th
(
öode
, 
°¨t
, 
off£ts
, 
NULL
);

1233 
n2
 = 
	`pxt4_block_to_∑th
(
öode
, 
íd
, 
off£ts2
, 
NULL
);

1235 
	`BUG_ON
(
n
 > 
n2
);

1237 i‡((
n
 =1Ë&& (¿=
n2
)) {

1239 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
NULL
, 
i_d©a
 + 
off£ts
[0],

1240 
i_d©a
 + 
off£ts2
[0]);

1242 } i‡(
n2
 > 
n
) {

1250 i‡(
n
 == 1) {

1255 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
NULL
, 
i_d©a
 + 
off£ts
[0],

1256 
i_d©a
 + 
PXT4_NDIR_BLOCKS
);

1257 
íd_ønge
;

1261 
∑πül
 = 
p
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n
, 
off£ts
, 
chaö
, &
ƒ
);

1262 i‡(
ƒ
) {

1263 i‡(
∑πül
 =
chaö
) {

1265 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
,

1266 &
ƒ
, &ƒ+1, (
chaö
+
n
-1Ë- 
∑πül
);

1267 *
∑πül
->
p
 = 0;

1270 
	`BUFFER_TRACE
(
∑πül
->
bh
, "get_write_access");

1271 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1272 
∑πül
->
p
,

1273 
∑πül
->
p
+1, (
chaö
+
n
-1) -Öartial);

1281 
∑πül
 > 
chaö
) {

1282 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1283 
∑πül
->
p
 + 1,

1284 (
__À32
 *)
∑πül
->
bh
->
b_d©a
+
addr_≥r_block
,

1285 (
chaö
+
n
-1Ë- 
∑πül
);

1286 
∑πül
--;

1289 
íd_ønge
:

1290 
∑πül2
 = 
p2
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n2
, 
off£ts2
, 
chaö2
, &
ƒ2
);

1291 i‡(
ƒ2
) {

1292 i‡(
∑πül2
 =
chaö2
) {

1299 
do_ödúe˘s
;

1308 
∑πül2
->
p
++;

1315 
∑πül2
 > 
chaö2
) {

1316 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül2
->
bh
,

1317 (
__À32
 *)
∑πül2
->
bh
->
b_d©a
,

1318 
∑πül2
->
p
,

1319 (
chaö2
+
n2
-1Ë- 
∑πül2
);

1320 
∑πül2
--;

1322 
do_ödúe˘s
;

1326 
∑πül
 = 
p
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n
, 
off£ts
, 
chaö
, &
ƒ
);

1327 
∑πül2
 = 
p2
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n2
, 
off£ts2
, 
chaö2
, &
ƒ2
);

1330 i‡(
ƒ
) {

1331 
Àvñ
 = 
	`mö
(
∑πül
 - 
chaö
, 
∑πül2
 - 
chaö2
);

1332 
i
;

1333 
subåì
 = 1;

1335 
i
 = 0; i <
Àvñ
; i++) {

1336 i‡(
off£ts
[
i
] !
off£ts2
[i]) {

1337 
subåì
 = 0;

1342 i‡(!
subåì
) {

1343 i‡(
∑πül
 =
chaö
) {

1345 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
,

1346 &
ƒ
, &nr+1,

1347 (
chaö
+
n
-1Ë- 
∑πül
);

1348 *
∑πül
->
p
 = 0;

1351 
	`BUFFER_TRACE
(
∑πül
->
bh
, "get_write_access");

1352 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1353 
∑πül
->
p
,

1354 
∑πül
->
p
+1,

1355 (
chaö
+
n
-1Ë- 
∑πül
);

1360 i‡(!
ƒ2
) {

1367 
∑πül2
->
p
++;

1370 
∑πül
 > 
chaö
 || 
∑πül2
 > 
chaö2
) {

1371 
dïth
 = (
chaö
+
n
-1Ë- 
∑πül
;

1372 
dïth2
 = (
chaö2
+
n2
-1Ë- 
∑πül2
;

1374 i‡(
∑πül
 > 
chaö
 && 
∑πül2
 > 
chaö2
 &&

1375 
∑πül
->
bh
->
b_blockƒ
 =
∑πül2
->bh->b_blocknr) {

1380 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1381 
∑πül
->
p
 + 1,

1382 
∑πül2
->
p
,

1383 (
chaö
+
n
-1Ë- 
∑πül
);

1384 
˛ónup
;

1394 i‡(
∑πül
 > 
chaö
 && 
dïth
 <
dïth2
) {

1395 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1396 
∑πül
->
p
 + 1,

1397 (
__À32
 *)
∑πül
->
bh
->
b_d©a
+
addr_≥r_block
,

1398 (
chaö
+
n
-1Ë- 
∑πül
);

1399 
∑πül
--;

1401 i‡(
∑πül2
 > 
chaö2
 && 
dïth2
 <
dïth
) {

1402 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül2
->
bh
,

1403 (
__À32
 *)
∑πül2
->
bh
->
b_d©a
,

1404 
∑πül2
->
p
,

1405 (
chaö2
+
n2
-1Ë- 
∑πül2
);

1406 
∑πül2
--;

1410 
˛ónup
:

1411 
p
 &&Ö > 
chaö
) {

1412 
	`BUFFER_TRACE
(
p
->
bh
, "call brelse");

1413 
	`bªl£
(
p
->
bh
);

1414 
p
--;

1416 
p2
 &&Ö2 > 
chaö2
) {

1417 
	`BUFFER_TRACE
(
p2
->
bh
, "call brelse");

1418 
	`bªl£
(
p2
->
bh
);

1419 
p2
--;

1423 
do_ödúe˘s
:

1425 
off£ts
[0]) {

1427 i‡(++
n
 >
n2
)

1429 
ƒ
 = 
i_d©a
[
PXT4_IND_BLOCK
];

1430 i‡(
ƒ
) {

1431 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 1);

1432 
i_d©a
[
PXT4_IND_BLOCK
] = 0;

1435 
PXT4_IND_BLOCK
:

1436 i‡(++
n
 >
n2
)

1438 
ƒ
 = 
i_d©a
[
PXT4_DIND_BLOCK
];

1439 i‡(
ƒ
) {

1440 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 2);

1441 
i_d©a
[
PXT4_DIND_BLOCK
] = 0;

1444 
PXT4_DIND_BLOCK
:

1445 i‡(++
n
 >
n2
)

1447 
ƒ
 = 
i_d©a
[
PXT4_TIND_BLOCK
];

1448 i‡(
ƒ
) {

1449 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 3);

1450 
i_d©a
[
PXT4_TIND_BLOCK
] = 0;

1453 
PXT4_TIND_BLOCK
:

1456 
˛ónup
;

1457 
	}
}

	@inline.c

7 
	~<löux/iom≠.h
>

8 
	~<löux/fõm≠.h
>

9 
	~<löux/ivîsi⁄.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"x©å.h
"

14 
	~"åunˇã.h
"

16 
	#PXT4_XATTR_SYSTEM_DATA
 "d©a"

	)

17 
	#PXT4_MIN_INLINE_DATA_SIZE
 (((
__À32
Ë* 
PXT4_N_BLOCKS
))

	)

18 
	#PXT4_INLINE_DOTDOT_OFFSET
 2

	)

19 
	#PXT4_INLINE_DOTDOT_SIZE
 4

	)

21 
	$pxt4_gë_ölöe_size
(
öode
 *inode)

23 i‡(
	`PXT4_I
(
öode
)->
i_ölöe_off
)

24  
	`PXT4_I
(
öode
)->
i_ölöe_size
;

27 
	}
}

29 
	$gë_max_ölöe_x©å_vÆue_size
(
öode
 *inode,

30 
pxt4_ûoc
 *
ûoc
)

32 
pxt4_x©å_ibody_hódî
 *
hódî
;

33 
pxt4_x©å_íåy
 *
íåy
;

34 
pxt4_öode
 *
øw_öode
;

35 
‰ì
, 
mö_offs
;

37 
mö_offs
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
 -

38 
PXT4_GOOD_OLD_INODE_SIZE
 -

39 
	`PXT4_I
(
öode
)->
i_exåa_isize
 -

40 (
pxt4_x©å_ibody_hódî
);

47 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
))

48  
	`PXT4_XATTR_SIZE
(
mö_offs
 -

49 
	`PXT4_XATTR_LEN
(
	`°æí
(
PXT4_XATTR_SYSTEM_DATA
)) -

50 
PXT4_XATTR_ROUND
 - (
__u32
));

52 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

53 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

54 
íåy
 = 
	`IFIRST
(
hódî
);

57 ; !
	`IS_LAST_ENTRY
(
íåy
);É¡ry = 
	`PXT4_XATTR_NEXT
(entry)) {

58 i‡(!
íåy
->
e_vÆue_öum
 &&É¡ry->
e_vÆue_size
) {

59 
size_t
 
offs
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

60 i‡(
offs
 < 
mö_offs
)

61 
mö_offs
 = 
offs
;

64 
‰ì
 = 
mö_offs
 -

65 ((*)
íåy
 - (*)
	`IFIRST
(
hódî
)Ë- (
__u32
);

67 i‡(
	`PXT4_I
(
öode
)->
i_ölöe_off
) {

68 
íåy
 = (
pxt4_x©å_íåy
 *)

69 ((*)
øw_öode
 + 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

71 
‰ì
 +
	`PXT4_XATTR_SIZE
(
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

72 
out
;

75 
‰ì
 -
	`PXT4_XATTR_LEN
(
	`°æí
(
PXT4_XATTR_SYSTEM_DATA
));

77 i‡(
‰ì
 > 
PXT4_XATTR_ROUND
)

78 
‰ì
 = 
	`PXT4_XATTR_SIZE
(‰ì - 
PXT4_XATTR_ROUND
);

80 
‰ì
 = 0;

82 
out
:

83  
‰ì
;

84 
	}
}

91 
	$pxt4_gë_max_ölöe_size
(
öode
 *inode)

93 
îr‹
, 
max_ölöe_size
;

94 
pxt4_ûoc
 
ûoc
;

96 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

99 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

100 i‡(
îr‹
) {

101 
	`pxt4_îr‹_öode
(
öode
, 
__func__
, 
__LINE__
, 0,

103 
öode
->
i_öo
);

107 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

108 
max_ölöe_size
 = 
	`gë_max_ölöe_x©å_vÆue_size
(
öode
, &
ûoc
);

109 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

111 
	`bªl£
(
ûoc
.
bh
);

113 i‡(!
max_ölöe_size
)

116  
max_ölöe_size
 + 
PXT4_MIN_INLINE_DATA_SIZE
;

117 
	}
}

124 
	$pxt4_föd_ölöe_d©a_nﬁock
(
öode
 *inode)

126 
pxt4_x©å_ibody_föd
 
is
 = {

127 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

129 
pxt4_x©å_öfo
 
i
 = {

130 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

131 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

133 
îr‹
;

135 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

138 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

139 i‡(
îr‹
)

140  
îr‹
;

142 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

143 i‡(
îr‹
)

144 
out
;

146 i‡(!
is
.
s
.
nŸ_found
) {

147 i‡(
is
.
s
.
hîe
->
e_vÆue_öum
) {

148 
	`PXT4_ERROR_INODE
(
öode
, "inline data xattrÑefers "

150 
îr‹
 = -
EFSCORRUPTED
;

151 
out
;

153 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = (
u16
)((*)
is
.
s
.
hîe
 -

154 (*)
	`pxt4_øw_öode
(&
is
.
ûoc
));

155 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 +

156 
	`À32_to_˝u
(
is
.
s
.
hîe
->
e_vÆue_size
);

157 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

159 
out
:

160 
	`bªl£
(
is
.
ûoc
.
bh
);

161  
îr‹
;

162 
	}
}

164 
	$pxt4_ªad_ölöe_d©a
(
öode
 *öode, *
buf„r
,

165 
Àn
,

166 
pxt4_ûoc
 *
ûoc
)

168 
pxt4_x©å_íåy
 *
íåy
;

169 
pxt4_x©å_ibody_hódî
 *
hódî
;

170 
˝_Àn
 = 0;

171 
pxt4_öode
 *
øw_öode
;

173 i‡(!
Àn
)

176 
	`BUG_ON
(
Àn
 > 
	`PXT4_I
(
öode
)->
i_ölöe_size
);

178 
˝_Àn
 = 
Àn
 < 
PXT4_MIN_INLINE_DATA_SIZE
 ?

179 
Àn
 : 
PXT4_MIN_INLINE_DATA_SIZE
;

181 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

182 
	`mem˝y
(
buf„r
, (*)(
øw_öode
->
i_block
), 
˝_Àn
);

184 
Àn
 -
˝_Àn
;

185 
buf„r
 +
˝_Àn
;

187 i‡(!
Àn
)

188 
out
;

190 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

191 
íåy
 = (
pxt4_x©å_íåy
 *)((*)
øw_öode
 +

192 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

193 
Àn
 = 
	`mö_t
(,Üen,

194 ()
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

196 
	`mem˝y
(
buf„r
,

197 (*)
	`IFIRST
(
hódî
Ë+ 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
), 
Àn
);

198 
˝_Àn
 +
Àn
;

200 
out
:

201  
˝_Àn
;

202 
	}
}

210 
	$pxt4_wrôe_ölöe_d©a
(
öode
 *öode, 
pxt4_ûoc
 *
ûoc
,

211 *
buf„r
, 
loff_t
 
pos
, 
Àn
)

213 
pxt4_x©å_íåy
 *
íåy
;

214 
pxt4_x©å_ibody_hódî
 *
hódî
;

215 
pxt4_öode
 *
øw_öode
;

216 
˝_Àn
 = 0;

218 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

221 
	`BUG_ON
(!
	`PXT4_I
(
öode
)->
i_ölöe_off
);

222 
	`BUG_ON
(
pos
 + 
Àn
 > 
	`PXT4_I
(
öode
)->
i_ölöe_size
);

224 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

225 
buf„r
 +
pos
;

227 i‡(
pos
 < 
PXT4_MIN_INLINE_DATA_SIZE
) {

228 
˝_Àn
 = 
pos
 + 
Àn
 > 
PXT4_MIN_INLINE_DATA_SIZE
 ?

229 
PXT4_MIN_INLINE_DATA_SIZE
 - 
pos
 : 
Àn
;

230 
	`mem˝y
((*)
øw_öode
->
i_block
 + 
pos
, 
buf„r
, 
˝_Àn
);

232 
Àn
 -
˝_Àn
;

233 
buf„r
 +
˝_Àn
;

234 
pos
 +
˝_Àn
;

237 i‡(!
Àn
)

240 
pos
 -
PXT4_MIN_INLINE_DATA_SIZE
;

241 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

242 
íåy
 = (
pxt4_x©å_íåy
 *)((*)
øw_öode
 +

243 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

245 
	`mem˝y
((*)
	`IFIRST
(
hódî
Ë+ 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
Ë+ 
pos
,

246 
buf„r
, 
Àn
);

247 
	}
}

249 
	$pxt4_¸óã_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
,

250 
öode
 *öode, 
Àn
)

252 
îr‹
;

253 *
vÆue
 = 
NULL
;

254 
pxt4_x©å_ibody_föd
 
is
 = {

255 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

257 
pxt4_x©å_öfo
 
i
 = {

258 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

259 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

262 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

263 i‡(
îr‹
)

264  
îr‹
;

266 
	`BUFFER_TRACE
(
is
.
ûoc
.
bh
, "get_write_access");

267 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
is
.
ûoc
.
bh
);

268 i‡(
îr‹
)

269 
out
;

271 i‡(
Àn
 > 
PXT4_MIN_INLINE_DATA_SIZE
) {

272 
vÆue
 = 
PXT4_ZERO_XATTR_VALUE
;

273 
Àn
 -
PXT4_MIN_INLINE_DATA_SIZE
;

275 
vÆue
 = "";

276 
Àn
 = 0;

280 
i
.
vÆue
 = value;

281 
i
.
vÆue_Àn
 = 
Àn
;

283 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

284 i‡(
îr‹
)

285 
out
;

287 
	`BUG_ON
(!
is
.
s
.
nŸ_found
);

289 
îr‹
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

290 i‡(
îr‹
) {

291 i‡(
îr‹
 =-
ENOSPC
)

292 
	`pxt4_˛ór_öode_°©e
(
öode
,

293 
PXT4_STATE_MAY_INLINE_DATA
);

294 
out
;

297 
	`mem£t
((*)
	`pxt4_øw_öode
(&
is
.
ûoc
)->
i_block
,

298 0, 
PXT4_MIN_INLINE_DATA_SIZE
);

300 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = (
u16
)((*)
is
.
s
.
hîe
 -

301 (*)
	`pxt4_øw_öode
(&
is
.
ûoc
));

302 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
Àn
 + 
PXT4_MIN_INLINE_DATA_SIZE
;

303 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

304 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_INLINE_DATA
);

305 
	`gë_bh
(
is
.
ûoc
.
bh
);

306 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

308 
out
:

309 
	`bªl£
(
is
.
ûoc
.
bh
);

310  
îr‹
;

311 
	}
}

313 
	$pxt4_upd©e_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

314 
Àn
)

316 
îr‹
;

317 *
vÆue
 = 
NULL
;

318 
pxt4_x©å_ibody_föd
 
is
 = {

319 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

321 
pxt4_x©å_öfo
 
i
 = {

322 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

323 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

327 i‡(
Àn
 <
	`PXT4_I
(
öode
)->
i_ölöe_size
)

330 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

331 i‡(
îr‹
)

332  
îr‹
;

334 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

335 i‡(
îr‹
)

336 
out
;

338 
	`BUG_ON
(
is
.
s
.
nŸ_found
);

340 
Àn
 -
PXT4_MIN_INLINE_DATA_SIZE
;

341 
vÆue
 = 
	`kzÆloc
(
Àn
, 
GFP_NOFS
);

342 i‡(!
vÆue
) {

343 
îr‹
 = -
ENOMEM
;

344 
out
;

347 
îr‹
 = 
	`pxt4_x©å_ibody_gë
(
öode
, 
i
.
«me_ödex
, i.
«me
,

348 
vÆue
, 
Àn
);

349 i‡(
îr‹
 =-
ENODATA
)

350 
out
;

352 
	`BUFFER_TRACE
(
is
.
ûoc
.
bh
, "get_write_access");

353 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
is
.
ûoc
.
bh
);

354 i‡(
îr‹
)

355 
out
;

358 
i
.
vÆue
 = value;

359 
i
.
vÆue_Àn
 = 
Àn
;

361 
îr‹
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

362 i‡(
îr‹
)

363 
out
;

365 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = (
u16
)((*)
is
.
s
.
hîe
 -

366 (*)
	`pxt4_øw_öode
(&
is
.
ûoc
));

367 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 +

368 
	`À32_to_˝u
(
is
.
s
.
hîe
->
e_vÆue_size
);

369 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

370 
	`gë_bh
(
is
.
ûoc
.
bh
);

371 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

373 
out
:

374 
	`k‰ì
(
vÆue
);

375 
	`bªl£
(
is
.
ûoc
.
bh
);

376  
îr‹
;

377 
	}
}

379 
	$pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

380 
Àn
)

382 
ªt
, 
size
, 
no_ex∑nd
;

383 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

385 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
))

386  -
ENOSPC
;

388 
size
 = 
	`pxt4_gë_max_ölöe_size
(
öode
);

389 i‡(
size
 < 
Àn
)

390  -
ENOSPC
;

392 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

394 i‡(
ei
->
i_ölöe_off
)

395 
ªt
 = 
	`pxt4_upd©e_ölöe_d©a
(
h™dÀ
, 
öode
, 
Àn
);

397 
ªt
 = 
	`pxt4_¸óã_ölöe_d©a
(
h™dÀ
, 
öode
, 
Àn
);

399 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

400  
ªt
;

401 
	}
}

403 
	$pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ_t
 *
h™dÀ
,

404 
öode
 *inode)

406 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

407 
pxt4_x©å_ibody_föd
 
is
 = {

408 .
s
 = { .
nŸ_found
 = 0, },

410 
pxt4_x©å_öfo
 
i
 = {

411 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

412 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

413 .
vÆue
 = 
NULL
,

414 .
vÆue_Àn
 = 0,

416 
îr‹
;

418 i‡(!
ei
->
i_ölöe_off
)

421 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

422 i‡(
îr‹
)

423  
îr‹
;

425 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

426 i‡(
îr‹
)

427 
out
;

429 
	`BUFFER_TRACE
(
is
.
ûoc
.
bh
, "get_write_access");

430 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
is
.
ûoc
.
bh
);

431 i‡(
îr‹
)

432 
out
;

434 
îr‹
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

435 i‡(
îr‹
)

436 
out
;

438 
	`mem£t
((*)
	`pxt4_øw_öode
(&
is
.
ûoc
)->
i_block
,

439 0, 
PXT4_MIN_INLINE_DATA_SIZE
);

440 
	`mem£t
(
ei
->
i_d©a
, 0, 
PXT4_MIN_INLINE_DATA_SIZE
);

442 i‡(
	`pxt4_has_„©uª_exã¡s
(
öode
->
i_sb
)) {

443 i‡(
	`S_ISDIR
(
öode
->
i_mode
) ||

444 
	`S_ISREG
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode)) {

445 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

446 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
öode
);

449 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_INLINE_DATA
);

451 
	`gë_bh
(
is
.
ûoc
.
bh
);

452 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

454 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = 0;

455 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 0;

456 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

457 
out
:

458 
	`bªl£
(
is
.
ûoc
.
bh
);

459 i‡(
îr‹
 =-
ENODATA
)

460 
îr‹
 = 0;

461  
îr‹
;

462 
	}
}

464 
	$pxt4_ªad_ölöe_∑ge
(
öode
 *öode, 
∑ge
 *page)

466 *
kaddr
;

467 
ªt
 = 0;

468 
size_t
 
Àn
;

469 
pxt4_ûoc
 
ûoc
;

471 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

472 
	`BUG_ON
(!
	`pxt4_has_ölöe_d©a
(
öode
));

473 
	`BUG_ON
(
∑ge
->
ödex
);

475 i‡(!
	`PXT4_I
(
öode
)->
i_ölöe_off
) {

476 
	`pxt4_w¨nög
(
öode
->
i_sb
, "inode %lu doesn't have inline data.",

477 
öode
->
i_öo
);

478 
out
;

481 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

482 i‡(
ªt
)

483 
out
;

485 
Àn
 = 
	`mö_t
(
size_t
, 
	`pxt4_gë_ölöe_size
(
öode
), 
	`i_size_ªad
(inode));

486 
kaddr
 = 
	`km≠_©omic
(
∑ge
);

487 
ªt
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
kaddr
, 
Àn
, &
ûoc
);

488 
	`Êush_dˇche_∑ge
(
∑ge
);

489 
	`kunm≠_©omic
(
kaddr
);

490 
	`zîo_u£r_£gmít
(
∑ge
, 
Àn
, 
PAGE_SIZE
);

491 
	`SëPageU±od©e
(
∑ge
);

492 
	`bªl£
(
ûoc
.
bh
);

494 
out
:

495  
ªt
;

496 
	}
}

498 
	$pxt4_ªad∑ge_ölöe
(
öode
 *öode, 
∑ge
 *page)

500 
ªt
 = 0;

502 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

503 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

504 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

505  -
EAGAIN
;

512 i‡(!
∑ge
->
ödex
)

513 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

514 i‡(!
	`PageU±od©e
(
∑ge
)) {

515 
	`zîo_u£r_£gmít
(
∑ge
, 0, 
PAGE_SIZE
);

516 
	`SëPageU±od©e
(
∑ge
);

519 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

521 
	`u∆ock_∑ge
(
∑ge
);

522  
ªt
 >= 0 ? 0 :Ñet;

523 
	}
}

525 
	$pxt4_c⁄vît_ölöe_d©a_to_exã¡
(
addªss_•a˚
 *
m≠pög
,

526 
öode
 *inode,

527 
Êags
)

529 
ªt
, 
√eded_blocks
, 
no_ex∑nd
;

530 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

531 
ªåõs
 = 0, 
£m_hñd
 = 0;

532 
∑ge
 *∑gê
NULL
;

533 
‰om
, 
to
;

534 
pxt4_ûoc
 
ûoc
;

536 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

541 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

545 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

547 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

548 i‡(
ªt
)

549  
ªt
;

551 
ªåy
:

552 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
);

553 i‡(
	`IS_ERR
(
h™dÀ
)) {

554 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

555 
h™dÀ
 = 
NULL
;

556 
out
;

561 
Êags
 |
AOP_FLAG_NOFS
;

563 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

564 i‡(!
∑ge
) {

565 
ªt
 = -
ENOMEM
;

566 
out
;

569 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

570 
£m_hñd
 = 1;

572 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

573 
ªt
 = 0;

574 
out
;

577 
‰om
 = 0;

578 
to
 = 
	`pxt4_gë_ölöe_size
(
öode
);

579 i‡(!
	`PageU±od©e
(
∑ge
)) {

580 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

581 i‡(
ªt
 < 0)

582 
out
;

585 
ªt
 = 
	`pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
);

586 i‡(
ªt
)

587 
out
;

589 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
)) {

590 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
‰om
, 
to
,

591 
pxt4_gë_block_unwrôãn
);

593 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
‰om
, 
to
, 
pxt4_gë_block
);

595 i‡(!
ªt
 && 
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

596 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
),

597 
‰om
, 
to
, 
NULL
,

598 
do_jou∫Æ_gë_wrôe_ac˚ss
);

601 i‡(
ªt
) {

602 
	`u∆ock_∑ge
(
∑ge
);

603 
	`put_∑ge
(
∑ge
);

604 
∑ge
 = 
NULL
;

605 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

606 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

607 
£m_hñd
 = 0;

608 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

609 
h™dÀ
 = 
NULL
;

610 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

617 i‡(
öode
->
i_∆ök
)

618 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

621 i‡(
ªt
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

622 
ªåy
;

624 i‡(
∑ge
)

625 
	`block_commô_wrôe
(
∑ge
, 
‰om
, 
to
);

626 
out
:

627 i‡(
∑ge
) {

628 
	`u∆ock_∑ge
(
∑ge
);

629 
	`put_∑ge
(
∑ge
);

631 i‡(
£m_hñd
)

632 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

633 i‡(
h™dÀ
)

634 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

635 
	`bªl£
(
ûoc
.
bh
);

636  
ªt
;

637 
	}
}

645 
	$pxt4_åy_to_wrôe_ölöe_d©a
(
addªss_•a˚
 *
m≠pög
,

646 
öode
 *inode,

647 
loff_t
 
pos
, 
Àn
,

648 
Êags
,

649 
∑ge
 **
∑gï
)

651 
ªt
;

652 
h™dÀ_t
 *
h™dÀ
;

653 
∑ge
 *page;

654 
pxt4_ûoc
 
ûoc
;

656 i‡(
pos
 + 
Àn
 > 
	`pxt4_gë_max_ölöe_size
(
öode
))

657 
c⁄vît
;

659 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

660 i‡(
ªt
)

661  
ªt
;

667 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

668 i‡(
	`IS_ERR
(
h™dÀ
)) {

669 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

670 
h™dÀ
 = 
NULL
;

671 
out
;

674 
ªt
 = 
	`pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ
, 
öode
, 
pos
 + 
Àn
);

675 i‡(
ªt
 &&Ñë !-
ENOSPC
)

676 
out
;

679 i‡(
ªt
 =-
ENOSPC
) {

680 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

681 
	`bªl£
(
ûoc
.
bh
);

682 
c⁄vît
;

685 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
.
bh
);

686 i‡(
ªt
)

687 
out
;

689 
Êags
 |
AOP_FLAG_NOFS
;

691 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

692 i‡(!
∑ge
) {

693 
ªt
 = -
ENOMEM
;

694 
out
;

697 *
∑gï
 = 
∑ge
;

698 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

699 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

700 
ªt
 = 0;

701 
	`u∆ock_∑ge
(
∑ge
);

702 
	`put_∑ge
(
∑ge
);

703 
out_up_ªad
;

706 i‡(!
	`PageU±od©e
(
∑ge
)) {

707 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

708 i‡(
ªt
 < 0) {

709 
	`u∆ock_∑ge
(
∑ge
);

710 
	`put_∑ge
(
∑ge
);

711 
out_up_ªad
;

715 
ªt
 = 1;

716 
h™dÀ
 = 
NULL
;

717 
out_up_ªad
:

718 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

719 
out
:

720 i‡(
h™dÀ
 && (
ªt
 != 1))

721 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

722 
	`bªl£
(
ûoc
.
bh
);

723  
ªt
;

724 
c⁄vît
:

725  
	`pxt4_c⁄vît_ölöe_d©a_to_exã¡
(
m≠pög
,

726 
öode
, 
Êags
);

727 
	}
}

729 
	$pxt4_wrôe_ölöe_d©a_íd
(
öode
 *öode, 
loff_t
 
pos
, 
Àn
,

730 
c›õd
, 
∑ge
 *page)

732 
ªt
, 
no_ex∑nd
;

733 *
kaddr
;

734 
pxt4_ûoc
 
ûoc
;

736 i‡(
	`u∆ikñy
(
c›õd
 < 
Àn
)) {

737 i‡(!
	`PageU±od©e
(
∑ge
)) {

738 
c›õd
 = 0;

739 
out
;

743 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

744 i‡(
ªt
) {

745 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

746 
c›õd
 = 0;

747 
out
;

750 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

751 
	`BUG_ON
(!
	`pxt4_has_ölöe_d©a
(
öode
));

753 
kaddr
 = 
	`km≠_©omic
(
∑ge
);

754 
	`pxt4_wrôe_ölöe_d©a
(
öode
, &
ûoc
, 
kaddr
, 
pos
, 
Àn
);

755 
	`kunm≠_©omic
(
kaddr
);

756 
	`SëPageU±od©e
(
∑ge
);

758 
	`CÀ¨PageDúty
(
∑ge
);

760 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

761 
	`bªl£
(
ûoc
.
bh
);

762 
	`m¨k_öode_dúty
(
öode
);

763 
out
:

764  
c›õd
;

765 
	}
}

767 
buf„r_hód
 *

768 
	$pxt4_jou∫ÆÀd_wrôe_ölöe_d©a
(
öode
 *inode,

769 
Àn
,

770 
∑ge
 *page)

772 
ªt
, 
no_ex∑nd
;

773 *
kaddr
;

774 
pxt4_ûoc
 
ûoc
;

776 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

777 i‡(
ªt
) {

778 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

779  
NULL
;

782 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

783 
kaddr
 = 
	`km≠_©omic
(
∑ge
);

784 
	`pxt4_wrôe_ölöe_d©a
(
öode
, &
ûoc
, 
kaddr
, 0, 
Àn
);

785 
	`kunm≠_©omic
(
kaddr
);

786 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

788  
ûoc
.
bh
;

789 
	}
}

800 
	$pxt4_da_c⁄vît_ölöe_d©a_to_exã¡
(
addªss_•a˚
 *
m≠pög
,

801 
öode
 *inode,

802 
Êags
,

803 **
fsd©a
)

805 
ªt
 = 0, 
ölöe_size
;

806 
∑ge
 *page;

808 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

809 i‡(!
∑ge
)

810  -
ENOMEM
;

812 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

813 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

814 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

815 
out
;

818 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

820 i‡(!
	`PageU±od©e
(
∑ge
)) {

821 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

822 i‡(
ªt
 < 0)

823 
out
;

826 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 0, 
ölöe_size
,

827 
pxt4_da_gë_block_¥ï
);

828 i‡(
ªt
) {

829 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

830 
	`u∆ock_∑ge
(
∑ge
);

831 
	`put_∑ge
(
∑ge
);

832 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

833  
ªt
;

836 
	`SëPageDúty
(
∑ge
);

837 
	`SëPageU±od©e
(
∑ge
);

838 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

839 *
fsd©a
 = (*)
CONVERT_INLINE_DATA
;

841 
out
:

842 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

843 i‡(
∑ge
) {

844 
	`u∆ock_∑ge
(
∑ge
);

845 
	`put_∑ge
(
∑ge
);

847  
ªt
;

848 
	}
}

858 
	$pxt4_da_wrôe_ölöe_d©a_begö
(
addªss_•a˚
 *
m≠pög
,

859 
öode
 *inode,

860 
loff_t
 
pos
, 
Àn
,

861 
Êags
,

862 
∑ge
 **
∑gï
,

863 **
fsd©a
)

865 
ªt
, 
ölöe_size
;

866 
h™dÀ_t
 *
h™dÀ
;

867 
∑ge
 *page;

868 
pxt4_ûoc
 
ûoc
;

869 
ªåõs
 = 0;

871 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

872 i‡(
ªt
)

873  
ªt
;

875 
ªåy_jou∫Æ
:

876 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

877 i‡(
	`IS_ERR
(
h™dÀ
)) {

878 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

879 
out
;

882 
ölöe_size
 = 
	`pxt4_gë_max_ölöe_size
(
öode
);

884 
ªt
 = -
ENOSPC
;

885 i‡(
ölöe_size
 >
pos
 + 
Àn
) {

886 
ªt
 = 
	`pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ
, 
öode
, 
pos
 + 
Àn
);

887 i‡(
ªt
 &&Ñë !-
ENOSPC
)

888 
out_jou∫Æ
;

895 
Êags
 |
AOP_FLAG_NOFS
;

897 i‡(
ªt
 =-
ENOSPC
) {

898 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

899 
ªt
 = 
	`pxt4_da_c⁄vît_ölöe_d©a_to_exã¡
(
m≠pög
,

900 
öode
,

901 
Êags
,

902 
fsd©a
);

903 i‡(
ªt
 =-
ENOSPC
 &&

904 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

905 
ªåy_jou∫Æ
;

906 
out
;

909 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

910 i‡(!
∑ge
) {

911 
ªt
 = -
ENOMEM
;

912 
out_jou∫Æ
;

915 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

916 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

917 
ªt
 = 0;

918 
out_ªÀa£_∑ge
;

921 i‡(!
	`PageU±od©e
(
∑ge
)) {

922 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

923 i‡(
ªt
 < 0)

924 
out_ªÀa£_∑ge
;

926 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
.
bh
);

927 i‡(
ªt
)

928 
out_ªÀa£_∑ge
;

930 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

931 *
∑gï
 = 
∑ge
;

932 
	`bªl£
(
ûoc
.
bh
);

934 
out_ªÀa£_∑ge
:

935 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

936 
	`u∆ock_∑ge
(
∑ge
);

937 
	`put_∑ge
(
∑ge
);

938 
out_jou∫Æ
:

939 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

940 
out
:

941 
	`bªl£
(
ûoc
.
bh
);

942  
ªt
;

943 
	}
}

945 
	$pxt4_da_wrôe_ölöe_d©a_íd
(
öode
 *öode, 
loff_t
 
pos
,

946 
Àn
, 
c›õd
,

947 
∑ge
 *page)

949 
ªt
;

951 
ªt
 = 
	`pxt4_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
, 
∑ge
);

952 i‡(
ªt
 < 0) {

953 
	`u∆ock_∑ge
(
∑ge
);

954 
	`put_∑ge
(
∑ge
);

955  
ªt
;

957 
c›õd
 = 
ªt
;

966 i‡(
pos
+
c›õd
 > 
öode
->
i_size
)

967 
	`i_size_wrôe
(
öode
, 
pos
+
c›õd
);

968 
	`u∆ock_∑ge
(
∑ge
);

969 
	`put_∑ge
(
∑ge
);

977 
	`m¨k_öode_dúty
(
öode
);

979  
c›õd
;

980 
	}
}

982 #ifde‡
INLINE_DIR_DEBUG


983 
	$pxt4_show_ölöe_dú
(
öode
 *
dú
, 
buf„r_hód
 *
bh
,

984 *
ölöe_°¨t
, 
ölöe_size
)

986 
off£t
;

987 
de_Àn
;

988 
pxt4_dú_íåy_2
 *
de
 = 
ölöe_°¨t
;

989 *
dlimô
 = 
ölöe_°¨t
 + 
ölöe_size
;

991 
	`åa˚_¥ötk
("öodê%lu\n", 
dú
->
i_öo
);

992 
off£t
 = 0;

993 (*)
de
 < 
dlimô
) {

994 
de_Àn
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ölöe_size
);

995 
	`åa˚_¥ötk
("de: off %uÑlen %uÇame %.*sÇlen %u ino %u\n",

996 
off£t
, 
de_Àn
, 
de
->
«me_Àn
, de->
«me
,

997 
de
->
«me_Àn
, 
	`À32_to_˝u
(de->
öode
));

998 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

999 
ölöe_°¨t
, 
ölöe_size
, 
off£t
))

1000 
	`BUG
();

1002 
off£t
 +
de_Àn
;

1003 
de
 = (
pxt4_dú_íåy_2
 *Ë((*Ëdê+ 
de_Àn
);

1005 
	}
}

1007 
	#pxt4_show_ölöe_dú
(
dú
, 
bh
, 
ölöe_°¨t
, 
ölöe_size
)

	)

1015 
	$pxt4_add_dúít_to_ölöe
(
h™dÀ_t
 *
h™dÀ
,

1016 
pxt4_fûíame
 *
‚ame
,

1017 
öode
 *
dú
,

1018 
öode
 *inode,

1019 
pxt4_ûoc
 *
ûoc
,

1020 *
ölöe_°¨t
, 
ölöe_size
)

1022 
îr
;

1023 
pxt4_dú_íåy_2
 *
de
;

1025 
îr
 = 
	`pxt4_föd_de°_de
(
dú
, 
öode
, 
ûoc
->
bh
, 
ölöe_°¨t
,

1026 
ölöe_size
, 
‚ame
, &
de
);

1027 i‡(
îr
)

1028  
îr
;

1030 
	`BUFFER_TRACE
(
ûoc
->
bh
, "get_write_access");

1031 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
->
bh
);

1032 i‡(
îr
)

1033  
îr
;

1034 
	`pxt4_ö£π_díåy
(
öode
, 
de
, 
ölöe_size
, 
‚ame
);

1036 
	`pxt4_show_ölöe_dú
(
dú
, 
ûoc
->
bh
, 
ölöe_°¨t
, 
ölöe_size
);

1049 
dú
->
i_mtime
 = dú->
i_˘ime
 = 
	`cuºít_time
(dir);

1050 
	`pxt4_upd©e_dx_Êag
(
dú
);

1051 
	`öode_öc_ivîsi⁄
(
dú
);

1053 
	}
}

1055 *
	$pxt4_gë_ölöe_x©å_pos
(
öode
 *inode,

1056 
pxt4_ûoc
 *
ûoc
)

1058 
pxt4_x©å_íåy
 *
íåy
;

1059 
pxt4_x©å_ibody_hódî
 *
hódî
;

1061 
	`BUG_ON
(!
	`PXT4_I
(
öode
)->
i_ölöe_off
);

1063 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(
ûoc
));

1064 
íåy
 = (
pxt4_x©å_íåy
 *)((*)
	`pxt4_øw_öode
(
ûoc
) +

1065 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

1067  (*)
	`IFIRST
(
hódî
Ë+ 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

1068 
	}
}

1071 
	$pxt4_upd©e_föÆ_de
(*
de_buf
, 
ﬁd_size
, 
√w_size
)

1073 
pxt4_dú_íåy_2
 *
de
, *
¥ev_de
;

1074 *
limô
;

1075 
de_Àn
;

1077 
de
 = (
pxt4_dú_íåy_2
 *)
de_buf
;

1078 i‡(
ﬁd_size
) {

1079 
limô
 = 
de_buf
 + 
ﬁd_size
;

1081 
¥ev_de
 = 
de
;

1082 
de_Àn
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ﬁd_size
);

1083 
de_buf
 +
de_Àn
;

1084 
de
 = (
pxt4_dú_íåy_2
 *)
de_buf
;

1085 } 
de_buf
 < 
limô
);

1087 
¥ev_de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
de_Àn
 + 
√w_size
 -

1088 
ﬁd_size
, 
√w_size
);

1091 
de
->
öode
 = 0;

1092 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
√w_size
,Çew_size);

1094 
	}
}

1096 
	$pxt4_upd©e_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

1097 
pxt4_ûoc
 *
ûoc
)

1099 
ªt
;

1100 
ﬁd_size
 = 
	`PXT4_I
(
dú
)->
i_ölöe_size
 - 
PXT4_MIN_INLINE_DATA_SIZE
;

1101 
√w_size
 = 
	`gë_max_ölöe_x©å_vÆue_size
(
dú
, 
ûoc
);

1103 i‡(
√w_size
 - 
ﬁd_size
 <
	`PXT4_DIR_REC_LEN
(1))

1104  -
ENOSPC
;

1106 
ªt
 = 
	`pxt4_upd©e_ölöe_d©a
(
h™dÀ
, 
dú
,

1107 
√w_size
 + 
PXT4_MIN_INLINE_DATA_SIZE
);

1108 i‡(
ªt
)

1109  
ªt
;

1111 
	`pxt4_upd©e_föÆ_de
(
	`pxt4_gë_ölöe_x©å_pos
(
dú
, 
ûoc
), 
ﬁd_size
,

1112 
	`PXT4_I
(
dú
)->
i_ölöe_size
 -

1113 
PXT4_MIN_INLINE_DATA_SIZE
);

1114 
dú
->
i_size
 = 
	`PXT4_I
(dú)->
i_disksize
 = PXT4_I(dú)->
i_ölöe_size
;

1116 
	}
}

1118 
	$pxt4_ª°‹e_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1119 
pxt4_ûoc
 *
ûoc
,

1120 *
buf
, 
ölöe_size
)

1122 
	`pxt4_¸óã_ölöe_d©a
(
h™dÀ
, 
öode
, 
ölöe_size
);

1123 
	`pxt4_wrôe_ölöe_d©a
(
öode
, 
ûoc
, 
buf
, 0, 
ölöe_size
);

1124 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

1125 
	}
}

1127 
	$pxt4_föish_c⁄vît_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
,

1128 
öode
 *inode,

1129 
buf„r_hód
 *
dú_block
,

1130 *
buf
,

1131 
ölöe_size
)

1133 
îr
, 
csum_size
 = 0, 
hódî_size
 = 0;

1134 
pxt4_dú_íåy_2
 *
de
;

1135 *
èrgë
 = 
dú_block
->
b_d©a
;

1141 
de
 = (
pxt4_dú_íåy_2
 *)
èrgë
;

1142 
de
 = 
	`pxt4_öô_dŸ_dŸdŸ
(
öode
, de,

1143 
öode
->
i_sb
->
s_blocksize
, 
csum_size
,

1144 
	`À32_to_˝u
(((
pxt4_dú_íåy_2
 *)
buf
)->
öode
), 1);

1145 
hódî_size
 = (*)
de
 - 
èrgë
;

1147 
	`mem˝y
((*)
de
, 
buf
 + 
PXT4_INLINE_DOTDOT_SIZE
,

1148 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
);

1150 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

1151 
csum_size
 = (
pxt4_dú_íåy_èû
);

1153 
öode
->
i_size
 = inode->
i_sb
->
s_blocksize
;

1154 
	`i_size_wrôe
(
öode
, inode->
i_sb
->
s_blocksize
);

1155 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_sb
->
s_blocksize
;

1156 
	`pxt4_upd©e_föÆ_de
(
dú_block
->
b_d©a
,

1157 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
 + 
hódî_size
,

1158 
öode
->
i_sb
->
s_blocksize
 - 
csum_size
);

1160 i‡(
csum_size
)

1161 
	`pxt4_öôülize_dúít_èû
(
dú_block
,

1162 
öode
->
i_sb
->
s_blocksize
);

1163 
	`£t_buf„r_u±od©e
(
dú_block
);

1164 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
öode
, 
dú_block
);

1165 i‡(
îr
)

1166  
îr
;

1167 
	`£t_buf„r_vîifõd
(
dú_block
);

1168  
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1169 
	}
}

1171 
	$pxt4_c⁄vît_ölöe_d©a_nﬁock
(
h™dÀ_t
 *
h™dÀ
,

1172 
öode
 *inode,

1173 
pxt4_ûoc
 *
ûoc
)

1175 
îr‹
;

1176 *
buf
 = 
NULL
;

1177 
buf„r_hód
 *
d©a_bh
 = 
NULL
;

1178 
pxt4_m≠_blocks
 
m≠
;

1179 
ölöe_size
;

1181 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1182 
buf
 = 
	`kmÆloc
(
ölöe_size
, 
GFP_NOFS
);

1183 i‡(!
buf
) {

1184 
îr‹
 = -
ENOMEM
;

1185 
out
;

1188 
îr‹
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
buf
, 
ölöe_size
, 
ûoc
);

1189 i‡(
îr‹
 < 0)

1190 
out
;

1196 i‡(
	`S_ISDIR
(
öode
->
i_mode
)) {

1197 
îr‹
 = 
	`pxt4_check_Æl_de
(
öode
, 
ûoc
->
bh
,

1198 
buf
 + 
PXT4_INLINE_DOTDOT_SIZE
,

1199 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
);

1200 i‡(
îr‹
)

1201 
out
;

1204 
îr‹
 = 
	`pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
);

1205 i‡(
îr‹
)

1206 
out
;

1208 
m≠
.
m_lblk
 = 0;

1209 
m≠
.
m_Àn
 = 1;

1210 
m≠
.
m_Êags
 = 0;

1211 
îr‹
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
, 
PXT4_GET_BLOCKS_CREATE
);

1212 i‡(
îr‹
 < 0)

1213 
out_ª°‹e
;

1214 i‡(!(
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
)) {

1215 
îr‹
 = -
EIO
;

1216 
out_ª°‹e
;

1219 
d©a_bh
 = 
	`sb_gëblk
(
öode
->
i_sb
, 
m≠
.
m_pblk
);

1220 i‡(!
d©a_bh
) {

1221 
îr‹
 = -
ENOMEM
;

1222 
out_ª°‹e
;

1225 
	`lock_buf„r
(
d©a_bh
);

1226 
îr‹
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
d©a_bh
);

1227 i‡(
îr‹
) {

1228 
	`u∆ock_buf„r
(
d©a_bh
);

1229 
îr‹
 = -
EIO
;

1230 
out_ª°‹e
;

1232 
	`mem£t
(
d©a_bh
->
b_d©a
, 0, 
öode
->
i_sb
->
s_blocksize
);

1234 i‡(!
	`S_ISDIR
(
öode
->
i_mode
)) {

1235 
	`mem˝y
(
d©a_bh
->
b_d©a
, 
buf
, 
ölöe_size
);

1236 
	`£t_buf„r_u±od©e
(
d©a_bh
);

1237 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

1238 
öode
, 
d©a_bh
);

1240 
îr‹
 = 
	`pxt4_föish_c⁄vît_ölöe_dú
(
h™dÀ
, 
öode
, 
d©a_bh
,

1241 
buf
, 
ölöe_size
);

1244 
	`u∆ock_buf„r
(
d©a_bh
);

1245 
out_ª°‹e
:

1246 i‡(
îr‹
)

1247 
	`pxt4_ª°‹e_ölöe_d©a
(
h™dÀ
, 
öode
, 
ûoc
, 
buf
, 
ölöe_size
);

1249 
out
:

1250 
	`bªl£
(
d©a_bh
);

1251 
	`k‰ì
(
buf
);

1252  
îr‹
;

1253 
	}
}

1260 
	$pxt4_åy_add_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

1261 
öode
 *
dú
, inode *inode)

1263 
ªt
, 
ölöe_size
, 
no_ex∑nd
;

1264 *
ölöe_°¨t
;

1265 
pxt4_ûoc
 
ûoc
;

1267 
ªt
 = 
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
);

1268 i‡(
ªt
)

1269  
ªt
;

1271 
	`pxt4_wrôe_lock_x©å
(
dú
, &
no_ex∑nd
);

1272 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
))

1273 
out
;

1275 
ölöe_°¨t
 = (*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
 +

1276 
PXT4_INLINE_DOTDOT_SIZE
;

1277 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 - 
PXT4_INLINE_DOTDOT_SIZE
;

1279 
ªt
 = 
	`pxt4_add_dúít_to_ölöe
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, &
ûoc
,

1280 
ölöe_°¨t
, 
ölöe_size
);

1281 i‡(
ªt
 !-
ENOSPC
)

1282 
out
;

1285 
ölöe_size
 = 
	`PXT4_I
(
dú
)->
i_ölöe_size
 -

1286 
PXT4_MIN_INLINE_DATA_SIZE
;

1287 i‡(!
ölöe_size
) {

1289 
ªt
 = 
	`pxt4_upd©e_ölöe_dú
(
h™dÀ
, 
dú
, &
ûoc
);

1290 i‡(
ªt
 &&Ñë !-
ENOSPC
)

1291 
out
;

1293 
ölöe_size
 = 
	`PXT4_I
(
dú
)->
i_ölöe_size
 -

1294 
PXT4_MIN_INLINE_DATA_SIZE
;

1297 i‡(
ölöe_size
) {

1298 
ölöe_°¨t
 = 
	`pxt4_gë_ölöe_x©å_pos
(
dú
, &
ûoc
);

1300 
ªt
 = 
	`pxt4_add_dúít_to_ölöe
(
h™dÀ
, 
‚ame
, 
dú
,

1301 
öode
, &
ûoc
, 
ölöe_°¨t
,

1302 
ölöe_size
);

1304 i‡(
ªt
 !-
ENOSPC
)

1305 
out
;

1313 
ªt
 = 
	`pxt4_c⁄vît_ölöe_d©a_nﬁock
(
h™dÀ
, 
dú
, &
ûoc
);

1315 
out
:

1316 
	`pxt4_wrôe_u∆ock_x©å
(
dú
, &
no_ex∑nd
);

1317 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

1318 
	`bªl£
(
ûoc
.
bh
);

1319  
ªt
;

1320 
	}
}

1327 
	$pxt4_ölöedú_to_åì
(
fûe
 *
dú_fûe
,

1328 
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

1329 
dx_hash_öfo
 *
höfo
,

1330 
__u32
 
°¨t_hash
, __u32 
°¨t_mö‹_hash
,

1331 *
has_ölöe_d©a
)

1333 
îr
 = 0, 
cou¡
 = 0;

1334 
∑ª¡_öo
;

1335 
pos
;

1336 
pxt4_dú_íåy_2
 *
de
;

1337 
öode
 *öodê
	`fûe_öode
(
dú_fûe
);

1338 
ªt
, 
ölöe_size
 = 0;

1339 
pxt4_ûoc
 
ûoc
;

1340 *
dú_buf
 = 
NULL
;

1341 
pxt4_dú_íåy_2
 
Áke
;

1342 
fs¸y±_°r
 
tmp_°r
;

1344 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1345 i‡(
ªt
)

1346  
ªt
;

1348 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1349 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1350 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1351 *
has_ölöe_d©a
 = 0;

1352 
out
;

1355 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1356 
dú_buf
 = 
	`kmÆloc
(
ölöe_size
, 
GFP_NOFS
);

1357 i‡(!
dú_buf
) {

1358 
ªt
 = -
ENOMEM
;

1359 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1360 
out
;

1363 
ªt
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
dú_buf
, 
ölöe_size
, &
ûoc
);

1364 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1365 i‡(
ªt
 < 0)

1366 
out
;

1368 
pos
 = 0;

1369 
∑ª¡_öo
 = 
	`À32_to_˝u
(((
pxt4_dú_íåy_2
 *)
dú_buf
)->
öode
);

1370 
pos
 < 
ölöe_size
) {

1376 i‡(
pos
 == 0) {

1377 
Áke
.
öode
 = 
	`˝u_to_À32
(öode->
i_öo
);

1378 
Áke
.
«me_Àn
 = 1;

1379 
	`°r˝y
(
Áke
.
«me
, ".");

1380 
Áke
.
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

1381 
	`PXT4_DIR_REC_LEN
(
Áke
.
«me_Àn
),

1382 
ölöe_size
);

1383 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, &
Áke
, 
S_IFDIR
);

1384 
de
 = &
Áke
;

1385 
pos
 = 
PXT4_INLINE_DOTDOT_OFFSET
;

1386 } i‡(
pos
 =
PXT4_INLINE_DOTDOT_OFFSET
) {

1387 
Áke
.
öode
 = 
	`˝u_to_À32
(
∑ª¡_öo
);

1388 
Áke
.
«me_Àn
 = 2;

1389 
	`°r˝y
(
Áke
.
«me
, "..");

1390 
Áke
.
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

1391 
	`PXT4_DIR_REC_LEN
(
Áke
.
«me_Àn
),

1392 
ölöe_size
);

1393 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, &
Áke
, 
S_IFDIR
);

1394 
de
 = &
Áke
;

1395 
pos
 = 
PXT4_INLINE_DOTDOT_SIZE
;

1397 
de
 = (
pxt4_dú_íåy_2
 *)(
dú_buf
 + 
pos
);

1398 
pos
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ölöe_size
);

1399 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
dú_fûe
, 
de
,

1400 
ûoc
.
bh
, 
dú_buf
,

1401 
ölöe_size
, 
pos
)) {

1402 
ªt
 = 
cou¡
;

1403 
out
;

1407 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
, de->
«me_Àn
, 
höfo
);

1408 i‡((
höfo
->
hash
 < 
°¨t_hash
) ||

1409 ((
höfo
->
hash
 =
°¨t_hash
) &&

1410 (
höfo
->
mö‹_hash
 < 
°¨t_mö‹_hash
)))

1412 i‡(
de
->
öode
 == 0)

1414 
tmp_°r
.
«me
 = 
de
->name;

1415 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1416 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
, 
höfo
->
hash
,

1417 
höfo
->
mö‹_hash
, 
de
, &
tmp_°r
);

1418 i‡(
îr
) {

1419 
ªt
 = 
îr
;

1420 
out
;

1422 
cou¡
++;

1424 
ªt
 = 
cou¡
;

1425 
out
:

1426 
	`k‰ì
(
dú_buf
);

1427 
	`bªl£
(
ûoc
.
bh
);

1428  
ªt
;

1429 
	}
}

1439 
	$pxt4_ªad_ölöe_dú
(
fûe
 *file,

1440 
dú_c⁄ãxt
 *
˘x
,

1441 *
has_ölöe_d©a
)

1443 
off£t
, 
∑ª¡_öo
;

1444 
i
;

1445 
pxt4_dú_íåy_2
 *
de
;

1446 
su≥r_block
 *
sb
;

1447 
öode
 *öodê
	`fûe_öode
(
fûe
);

1448 
ªt
, 
ölöe_size
 = 0;

1449 
pxt4_ûoc
 
ûoc
;

1450 *
dú_buf
 = 
NULL
;

1451 
dŸdŸ_off£t
, 
dŸdŸ_size
, 
exåa_off£t
, 
exåa_size
;

1453 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1454 i‡(
ªt
)

1455  
ªt
;

1457 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1458 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1459 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1460 *
has_ölöe_d©a
 = 0;

1461 
out
;

1464 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1465 
dú_buf
 = 
	`kmÆloc
(
ölöe_size
, 
GFP_NOFS
);

1466 i‡(!
dú_buf
) {

1467 
ªt
 = -
ENOMEM
;

1468 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1469 
out
;

1472 
ªt
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
dú_buf
, 
ölöe_size
, &
ûoc
);

1473 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1474 i‡(
ªt
 < 0)

1475 
out
;

1477 
ªt
 = 0;

1478 
sb
 = 
öode
->
i_sb
;

1479 
∑ª¡_öo
 = 
	`À32_to_˝u
(((
pxt4_dú_íåy_2
 *)
dú_buf
)->
öode
);

1480 
off£t
 = 
˘x
->
pos
;

1489 
dŸdŸ_off£t
 = 
	`PXT4_DIR_REC_LEN
(1);

1490 
dŸdŸ_size
 = 
dŸdŸ_off£t
 + 
	`PXT4_DIR_REC_LEN
(2);

1491 
exåa_off£t
 = 
dŸdŸ_size
 - 
PXT4_INLINE_DOTDOT_SIZE
;

1492 
exåa_size
 = 
exåa_off£t
 + 
ölöe_size
;

1500 i‡(!
	`öode_eq_ivîsi⁄
(
öode
, 
fûe
->
f_vîsi⁄
)) {

1501 
i
 = 0; i < 
exåa_size
 && i < 
off£t
;) {

1506 i‡(!
i
) {

1507 
i
 = 
dŸdŸ_off£t
;

1509 } i‡(
i
 =
dŸdŸ_off£t
) {

1510 
i
 = 
dŸdŸ_size
;

1516 
de
 = (
pxt4_dú_íåy_2
 *)

1517 (
dú_buf
 + 
i
 - 
exåa_off£t
);

1524 i‡(
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
exåa_size
)

1525 < 
	`PXT4_DIR_REC_LEN
(1))

1527 
i
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

1528 
exåa_size
);

1530 
off£t
 = 
i
;

1531 
˘x
->
pos
 = 
off£t
;

1532 
fûe
->
f_vîsi⁄
 = 
	`öode_quîy_ivîsi⁄
(
öode
);

1535 
˘x
->
pos
 < 
exåa_size
) {

1536 i‡(
˘x
->
pos
 == 0) {

1537 i‡(!
	`dú_emô
(
˘x
, ".", 1, 
öode
->
i_öo
, 
DT_DIR
))

1538 
out
;

1539 
˘x
->
pos
 = 
dŸdŸ_off£t
;

1543 i‡(
˘x
->
pos
 =
dŸdŸ_off£t
) {

1544 i‡(!
	`dú_emô
(
˘x
, "..", 2, 
∑ª¡_öo
, 
DT_DIR
))

1545 
out
;

1546 
˘x
->
pos
 = 
dŸdŸ_size
;

1550 
de
 = (
pxt4_dú_íåy_2
 *)

1551 (
dú_buf
 + 
˘x
->
pos
 - 
exåa_off£t
);

1552 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
fûe
, 
de
, 
ûoc
.
bh
, 
dú_buf
,

1553 
exåa_size
, 
˘x
->
pos
))

1554 
out
;

1555 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

1556 i‡(!
	`dú_emô
(
˘x
, 
de
->
«me
, de->
«me_Àn
,

1557 
	`À32_to_˝u
(
de
->
öode
),

1558 
	`gë_dty≥
(
sb
, 
de
->
fûe_ty≥
)))

1559 
out
;

1561 
˘x
->
pos
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
exåa_size
);

1563 
out
:

1564 
	`k‰ì
(
dú_buf
);

1565 
	`bªl£
(
ûoc
.
bh
);

1566  
ªt
;

1567 
	}
}

1569 
buf„r_hód
 *
	$pxt4_gë_fú°_ölöe_block
(
öode
 *inode,

1570 
pxt4_dú_íåy_2
 **
∑ª¡_de
,

1571 *
ªtvÆ
)

1573 
pxt4_ûoc
 
ûoc
;

1575 *
ªtvÆ
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1576 i‡(*
ªtvÆ
)

1577  
NULL
;

1579 *
∑ª¡_de
 = (
pxt4_dú_íåy_2
 *)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
;

1581  
ûoc
.
bh
;

1582 
	}
}

1589 
	$pxt4_åy_¸óã_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
∑ª¡
,

1590 
öode
 *inode)

1592 
ªt
, 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
;

1593 
pxt4_ûoc
 
ûoc
;

1594 
pxt4_dú_íåy_2
 *
de
;

1596 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1597 i‡(
ªt
)

1598  
ªt
;

1600 
ªt
 = 
	`pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ
, 
öode
, 
ölöe_size
);

1601 i‡(
ªt
)

1602 
out
;

1608 
de
 = (
pxt4_dú_íåy_2
 *)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
;

1609 
de
->
öode
 = 
	`˝u_to_À32
(
∑ª¡
->
i_öo
);

1610 
de
 = (
pxt4_dú_íåy_2
 *)((*)dê+ 
PXT4_INLINE_DOTDOT_SIZE
);

1611 
de
->
öode
 = 0;

1612 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

1613 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
,

1614 
ölöe_size
);

1615 
	`£t_∆ök
(
öode
, 2);

1616 
öode
->
i_size
 = 
	`PXT4_I
(öode)->
i_disksize
 = 
ölöe_size
;

1617 
out
:

1618 
	`bªl£
(
ûoc
.
bh
);

1619  
ªt
;

1620 
	}
}

1622 
buf„r_hód
 *
	$pxt4_föd_ölöe_íåy
(
öode
 *
dú
,

1623 
pxt4_fûíame
 *
‚ame
,

1624 
pxt4_dú_íåy_2
 **
ªs_dú
,

1625 *
has_ölöe_d©a
)

1627 
ªt
;

1628 
pxt4_ûoc
 
ûoc
;

1629 *
ölöe_°¨t
;

1630 
ölöe_size
;

1632 i‡(
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
))

1633  
NULL
;

1635 
	`down_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1636 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
)) {

1637 *
has_ölöe_d©a
 = 0;

1638 
out
;

1641 
ölöe_°¨t
 = (*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
 +

1642 
PXT4_INLINE_DOTDOT_SIZE
;

1643 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 - 
PXT4_INLINE_DOTDOT_SIZE
;

1644 
ªt
 = 
	`pxt4_£¨ch_dú
(
ûoc
.
bh
, 
ölöe_°¨t
, 
ölöe_size
,

1645 
dú
, 
‚ame
, 0, 
ªs_dú
);

1646 i‡(
ªt
 == 1)

1647 
out_föd
;

1648 i‡(
ªt
 < 0)

1649 
out
;

1651 i‡(
	`pxt4_gë_ölöe_size
(
dú
Ë=
PXT4_MIN_INLINE_DATA_SIZE
)

1652 
out
;

1654 
ölöe_°¨t
 = 
	`pxt4_gë_ölöe_x©å_pos
(
dú
, &
ûoc
);

1655 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
dú
Ë- 
PXT4_MIN_INLINE_DATA_SIZE
;

1657 
ªt
 = 
	`pxt4_£¨ch_dú
(
ûoc
.
bh
, 
ölöe_°¨t
, 
ölöe_size
,

1658 
dú
, 
‚ame
, 0, 
ªs_dú
);

1659 i‡(
ªt
 == 1)

1660 
out_föd
;

1662 
out
:

1663 
	`bªl£
(
ûoc
.
bh
);

1664 
ûoc
.
bh
 = 
NULL
;

1665 
out_föd
:

1666 
	`up_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1667  
ûoc
.
bh
;

1668 
	}
}

1670 
	$pxt4_dñëe_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
,

1671 
öode
 *
dú
,

1672 
pxt4_dú_íåy_2
 *
de_dñ
,

1673 
buf„r_hód
 *
bh
,

1674 *
has_ölöe_d©a
)

1676 
îr
, 
ölöe_size
, 
no_ex∑nd
;

1677 
pxt4_ûoc
 
ûoc
;

1678 *
ölöe_°¨t
;

1680 
îr
 = 
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
);

1681 i‡(
îr
)

1682  
îr
;

1684 
	`pxt4_wrôe_lock_x©å
(
dú
, &
no_ex∑nd
);

1685 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
)) {

1686 *
has_ölöe_d©a
 = 0;

1687 
out
;

1690 i‡((*)
de_dñ
 - ((*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
) <

1691 
PXT4_MIN_INLINE_DATA_SIZE
) {

1692 
ölöe_°¨t
 = (*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
 +

1693 
PXT4_INLINE_DOTDOT_SIZE
;

1694 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 -

1695 
PXT4_INLINE_DOTDOT_SIZE
;

1697 
ölöe_°¨t
 = 
	`pxt4_gë_ölöe_x©å_pos
(
dú
, &
ûoc
);

1698 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
dú
) -

1699 
PXT4_MIN_INLINE_DATA_SIZE
;

1702 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1703 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1704 i‡(
îr
)

1705 
out
;

1707 
îr
 = 
	`pxt4_gíîic_dñëe_íåy
(
h™dÀ
, 
dú
, 
de_dñ
, 
bh
,

1708 
ölöe_°¨t
, 
ölöe_size
, 0);

1709 i‡(
îr
)

1710 
out
;

1712 
	`pxt4_show_ölöe_dú
(
dú
, 
ûoc
.
bh
, 
ölöe_°¨t
, 
ölöe_size
);

1713 
out
:

1714 
	`pxt4_wrôe_u∆ock_x©å
(
dú
, &
no_ex∑nd
);

1715 i‡(
	`likñy
(
îr
 == 0))

1716 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

1717 
	`bªl£
(
ûoc
.
bh
);

1718 i‡(
îr
 !-
ENOENT
)

1719 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

1720  
îr
;

1721 
	}
}

1726 
ölöe
 
pxt4_dú_íåy_2
 *

1727 
	$pxt4_gë_ölöe_íåy
(
öode
 *inode,

1728 
pxt4_ûoc
 *
ûoc
,

1729 
off£t
,

1730 **
ölöe_°¨t
,

1731 *
ölöe_size
)

1733 *
ölöe_pos
;

1735 
	`BUG_ON
(
off£t
 > 
	`pxt4_gë_ölöe_size
(
öode
));

1737 i‡(
off£t
 < 
PXT4_MIN_INLINE_DATA_SIZE
) {

1738 
ölöe_pos
 = (*)
	`pxt4_øw_öode
(
ûoc
)->
i_block
;

1739 *
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
;

1741 
ölöe_pos
 = 
	`pxt4_gë_ölöe_x©å_pos
(
öode
, 
ûoc
);

1742 
off£t
 -
PXT4_MIN_INLINE_DATA_SIZE
;

1743 *
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
) -

1744 
PXT4_MIN_INLINE_DATA_SIZE
;

1747 i‡(
ölöe_°¨t
)

1748 *
ölöe_°¨t
 = 
ölöe_pos
;

1749  (
pxt4_dú_íåy_2
 *)(
ölöe_pos
 + 
off£t
);

1750 
	}
}

1752 
boﬁ
 
	$em±y_ölöe_dú
(
öode
 *
dú
, *
has_ölöe_d©a
)

1754 
îr
, 
ölöe_size
;

1755 
pxt4_ûoc
 
ûoc
;

1756 
size_t
 
ölöe_Àn
;

1757 *
ölöe_pos
;

1758 
off£t
;

1759 
pxt4_dú_íåy_2
 *
de
;

1760 
boﬁ
 
ªt
 = 
åue
;

1762 
îr
 = 
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
);

1763 i‡(
îr
) {

1764 
	`PXT4_ERROR_INODE
(
dú
, "error %d getting inode %lu block",

1765 
îr
, 
dú
->
i_öo
);

1766  
åue
;

1769 
	`down_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1770 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
)) {

1771 *
has_ölöe_d©a
 = 0;

1772 
out
;

1775 
de
 = (
pxt4_dú_íåy_2
 *)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
;

1776 i‡(!
	`À32_to_˝u
(
de
->
öode
)) {

1777 
	`pxt4_w¨nög
(
dú
->
i_sb
,

1779 
dú
->
i_öo
);

1780 
ªt
 = 
åue
;

1781 
out
;

1784 
ölöe_Àn
 = 
	`pxt4_gë_ölöe_size
(
dú
);

1785 
off£t
 = 
PXT4_INLINE_DOTDOT_SIZE
;

1786 
off£t
 < 
ölöe_Àn
) {

1787 
de
 = 
	`pxt4_gë_ölöe_íåy
(
dú
, &
ûoc
, 
off£t
,

1788 &
ölöe_pos
, &
ölöe_size
);

1789 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
,

1790 
ûoc
.
bh
, 
ölöe_pos
,

1791 
ölöe_size
, 
off£t
)) {

1792 
	`pxt4_w¨nög
(
dú
->
i_sb
,

1796 
dú
->
i_öo
, 
	`À32_to_˝u
(
de
->
öode
),

1797 
	`À16_to_˝u
(
de
->
ªc_Àn
), de->
«me_Àn
,

1798 
ölöe_size
);

1799 
ªt
 = 
åue
;

1800 
out
;

1802 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

1803 
ªt
 = 
Ál£
;

1804 
out
;

1806 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ölöe_size
);

1809 
out
:

1810 
	`up_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1811 
	`bªl£
(
ûoc
.
bh
);

1812  
ªt
;

1813 
	}
}

1815 
	$pxt4_de°roy_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

1817 
ªt
, 
no_ex∑nd
;

1819 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

1820 
ªt
 = 
	`pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
);

1821 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

1823  
ªt
;

1824 
	}
}

1826 
	$pxt4_ölöe_d©a_iom≠
(
öode
 *öode, 
iom≠
 *iomap)

1828 
__u64
 
addr
;

1829 
îr‹
 = -
EAGAIN
;

1830 
pxt4_ûoc
 
ûoc
;

1832 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1833 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
))

1834 
out
;

1836 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1837 i‡(
îr‹
)

1838 
out
;

1840 
addr
 = (
__u64
)
ûoc
.
bh
->
b_blockƒ
 << 
öode
->
i_sb
->
s_blocksize_bôs
;

1841 
addr
 +(*)
	`pxt4_øw_öode
(&
ûoc
Ë- iloc.
bh
->
b_d©a
;

1842 
addr
 +
	`off£tof
(
pxt4_öode
, 
i_block
);

1844 
	`bªl£
(
ûoc
.
bh
);

1846 
iom≠
->
addr
 =áddr;

1847 
iom≠
->
off£t
 = 0;

1848 
iom≠
->
Àngth
 = 
	`mö_t
(
loff_t
, 
	`pxt4_gë_ölöe_size
(
öode
),

1849 
	`i_size_ªad
(
öode
));

1850 
iom≠
->
ty≥
 = 
IOMAP_INLINE
;

1851 
iom≠
->
Êags
 = 0;

1853 
out
:

1854 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1855  
îr‹
;

1856 
	}
}

1858 
	$pxt4_ölöe_d©a_fõm≠
(
öode
 *inode,

1859 
fõm≠_exã¡_öfo
 *
fõöfo
,

1860 *
has_ölöe
, 
__u64
 
°¨t
, __u64 
Àn
)

1862 
__u64
 
physiˇl
 = 0;

1863 
__u64
 
ölöe_Àn
;

1864 
__u32
 
Êags
 = 
FIEMAP_EXTENT_DATA_INLINE
 | 
FIEMAP_EXTENT_NOT_ALIGNED
 |

1865 
FIEMAP_EXTENT_LAST
;

1866 
îr‹
 = 0;

1867 
pxt4_ûoc
 
ûoc
;

1869 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1870 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1871 *
has_ölöe
 = 0;

1872 
out
;

1874 
ölöe_Àn
 = 
	`mö_t
(
size_t
, 
	`pxt4_gë_ölöe_size
(
öode
),

1875 
	`i_size_ªad
(
öode
));

1876 i‡(
°¨t
 >
ölöe_Àn
)

1877 
out
;

1878 i‡(
°¨t
 + 
Àn
 < 
ölöe_Àn
)

1879 
ölöe_Àn
 = 
°¨t
 + 
Àn
;

1880 
ölöe_Àn
 -
°¨t
;

1882 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1883 i‡(
îr‹
)

1884 
out
;

1886 
physiˇl
 = (
__u64
)
ûoc
.
bh
->
b_blockƒ
 << 
öode
->
i_sb
->
s_blocksize_bôs
;

1887 
physiˇl
 +(*)
	`pxt4_øw_öode
(&
ûoc
Ë- iloc.
bh
->
b_d©a
;

1888 
physiˇl
 +
	`off£tof
(
pxt4_öode
, 
i_block
);

1890 
	`bªl£
(
ûoc
.
bh
);

1891 
out
:

1892 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1893 i‡(
physiˇl
)

1894 
îr‹
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
, 
°¨t
, 
physiˇl
,

1895 
ölöe_Àn
, 
Êags
);

1896  (
îr‹
 < 0 ?Érror : 0);

1897 
	}
}

1899 
	$pxt4_ölöe_d©a_åunˇã
(
öode
 *öode, *
has_ölöe
)

1901 
h™dÀ_t
 *
h™dÀ
;

1902 
ölöe_size
, 
vÆue_Àn
, 
√eded_blocks
, 
no_ex∑nd
, 
îr
 = 0;

1903 
size_t
 
i_size
;

1904 *
vÆue
 = 
NULL
;

1905 
pxt4_x©å_ibody_föd
 
is
 = {

1906 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

1908 
pxt4_x©å_öfo
 
i
 = {

1909 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

1910 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

1914 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

1915 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 
√eded_blocks
);

1916 i‡(
	`IS_ERR
(
h™dÀ
))

1917  
	`PTR_ERR
(
h™dÀ
);

1919 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

1920 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1921 *
has_ölöe
 = 0;

1922 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1926 i‡((
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
)) != 0)

1927 
out
;

1929 i‡((
îr
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
)) != 0)

1930 
out
;

1932 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1933 
i_size
 = 
öode
->i_size;

1934 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1935 
	`PXT4_I
(
öode
)->
i_disksize
 = 
i_size
;

1937 i‡(
i_size
 < 
ölöe_size
) {

1939 i‡(
ölöe_size
 > 
PXT4_MIN_INLINE_DATA_SIZE
) {

1940 i‡((
îr
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
)) != 0)

1941 
out_îr‹
;

1943 
	`BUG_ON
(
is
.
s
.
nŸ_found
);

1945 
vÆue_Àn
 = 
	`À32_to_˝u
(
is
.
s
.
hîe
->
e_vÆue_size
);

1946 
vÆue
 = 
	`kmÆloc
(
vÆue_Àn
, 
GFP_NOFS
);

1947 i‡(!
vÆue
) {

1948 
îr
 = -
ENOMEM
;

1949 
out_îr‹
;

1952 
îr
 = 
	`pxt4_x©å_ibody_gë
(
öode
, 
i
.
«me_ödex
,

1953 
i
.
«me
, 
vÆue
, 
vÆue_Àn
);

1954 i‡(
îr
 <= 0)

1955 
out_îr‹
;

1957 
i
.
vÆue
 = value;

1958 
i
.
vÆue_Àn
 = 
i_size
 > 
PXT4_MIN_INLINE_DATA_SIZE
 ?

1959 
i_size
 - 
PXT4_MIN_INLINE_DATA_SIZE
 : 0;

1960 
îr
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
,

1961 &
i
, &
is
);

1962 i‡(
îr
)

1963 
out_îr‹
;

1967 i‡(
i_size
 < 
PXT4_MIN_INLINE_DATA_SIZE
) {

1968 *
p
 = (*Ë
	`pxt4_øw_öode
(&
is
.
ûoc
)->
i_block
;

1969 
	`mem£t
(
p
 + 
i_size
, 0,

1970 
PXT4_MIN_INLINE_DATA_SIZE
 - 
i_size
);

1973 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
i_size
 <

1974 
PXT4_MIN_INLINE_DATA_SIZE
 ?

1975 
PXT4_MIN_INLINE_DATA_SIZE
 : 
i_size
;

1978 
out_îr‹
:

1979 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1980 
out
:

1981 
	`bªl£
(
is
.
ûoc
.
bh
);

1982 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

1983 
	`k‰ì
(
vÆue
);

1984 i‡(
öode
->
i_∆ök
)

1985 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

1987 i‡(
îr
 == 0) {

1988 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

1989 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1990 i‡(
	`IS_SYNC
(
öode
))

1991 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

1993 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1994  
îr
;

1995 
	}
}

1997 
	$pxt4_c⁄vît_ölöe_d©a
(
öode
 *inode)

1999 
îr‹
, 
√eded_blocks
, 
no_ex∑nd
;

2000 
h™dÀ_t
 *
h™dÀ
;

2001 
pxt4_ûoc
 
ûoc
;

2003 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

2004 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

2008 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

2010 
ûoc
.
bh
 = 
NULL
;

2011 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

2012 i‡(
îr‹
)

2013  
îr‹
;

2015 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
);

2016 i‡(
	`IS_ERR
(
h™dÀ
)) {

2017 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

2018 
out_‰ì
;

2021 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

2022 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

2023 
îr‹
 = 
	`pxt4_c⁄vît_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
, &
ûoc
);

2024 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

2025 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2026 
out_‰ì
:

2027 
	`bªl£
(
ûoc
.
bh
);

2028  
îr‹
;

2029 
	}
}

	@inode.c

22 
	~<löux/fs.h
>

23 
	~<löux/time.h
>

24 
	~<löux/highuid.h
>

25 
	~<löux/∑gem≠.h
>

26 
	~<löux/dax.h
>

27 
	~<löux/quŸa›s.h
>

28 
	~<löux/°rög.h
>

29 
	~<löux/buf„r_hód.h
>

30 
	~<löux/wrôeback.h
>

31 
	~<löux/∑gevec.h
>

32 
	~<löux/m∑ge.h
>

33 
	~<löux/«mei.h
>

34 
	~<löux/uio.h
>

35 
	~<löux/bio.h
>

36 
	~<löux/w‹kqueue.h
>

37 
	~<löux/kî√l.h
>

38 
	~<löux/¥ötk.h
>

39 
	~<löux/¶ab.h
>

40 
	~<löux/bô›s.h
>

41 
	~<löux/iom≠.h
>

42 
	~<löux/ivîsi⁄.h
>

44 
	~"pxt4_jbd3.h
"

45 
	~"x©å.h
"

46 
	~"a˛.h
"

47 
	~"åunˇã.h
"

49 
	~<åa˚/evíts/pxt4.h
>

51 
	#MPAGE_DA_EXTENT_TAIL
 0x01

	)

53 
__u32
 
	$pxt4_öode_csum
(
öode
 *öode, 
pxt4_öode
 *
øw
,

54 
pxt4_öode_öfo
 *
ei
)

56 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

57 
__u32
 
csum
;

58 
__u16
 
dummy_csum
 = 0;

59 
off£t
 = 
	`off£tof
(
pxt4_öode
, 
i_checksum_lo
);

60 
csum_size
 = (
dummy_csum
);

62 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
øw
, 
off£t
);

63 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, 
csum_size
);

64 
off£t
 +
csum_size
;

65 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
øw
 + 
off£t
,

66 
PXT4_GOOD_OLD_INODE_SIZE
 - 
off£t
);

68 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

69 
off£t
 = 
	`off£tof
(
pxt4_öode
, 
i_checksum_hi
);

70 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
øw
 +

71 
PXT4_GOOD_OLD_INODE_SIZE
,

72 
off£t
 - 
PXT4_GOOD_OLD_INODE_SIZE
);

73 i‡(
	`PXT4_FITS_IN_INODE
(
øw
, 
ei
, 
i_checksum_hi
)) {

74 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
,

75 
csum_size
);

76 
off£t
 +
csum_size
;

78 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
øw
 + 
off£t
,

79 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë- 
off£t
);

82  
csum
;

83 
	}
}

85 
	$pxt4_öode_csum_vîify
(
öode
 *öode, 
pxt4_öode
 *
øw
,

86 
pxt4_öode_öfo
 *
ei
)

88 
__u32
 
¥ovided
, 
ˇlcuœãd
;

90 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_¸ót‹_os
 !=

91 
	`˝u_to_À32
(
PXT4_OS_LINUX
) ||

92 !
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

95 
¥ovided
 = 
	`À16_to_˝u
(
øw
->
i_checksum_lo
);

96 
ˇlcuœãd
 = 
	`pxt4_öode_csum
(
öode
, 
øw
, 
ei
);

97 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

98 
	`PXT4_FITS_IN_INODE
(
øw
, 
ei
, 
i_checksum_hi
))

99 
¥ovided
 |((
__u32
)
	`À16_to_˝u
(
øw
->
i_checksum_hi
)) << 16;

101 
ˇlcuœãd
 &= 0xFFFF;

103  
¥ovided
 =
ˇlcuœãd
;

104 
	}
}

106 
	$pxt4_öode_csum_£t
(
öode
 *öode, 
pxt4_öode
 *
øw
,

107 
pxt4_öode_öfo
 *
ei
)

109 
__u32
 
csum
;

111 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_¸ót‹_os
 !=

112 
	`˝u_to_À32
(
PXT4_OS_LINUX
) ||

113 !
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

116 
csum
 = 
	`pxt4_öode_csum
(
öode
, 
øw
, 
ei
);

117 
øw
->
i_checksum_lo
 = 
	`˝u_to_À16
(
csum
 & 0xFFFF);

118 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

119 
	`PXT4_FITS_IN_INODE
(
øw
, 
ei
, 
i_checksum_hi
))

120 
øw
->
i_checksum_hi
 = 
	`˝u_to_À16
(
csum
 >> 16);

121 
	}
}

123 
ölöe
 
	$pxt4_begö_‹dîed_åunˇã
(
öode
 *inode,

124 
loff_t
 
√w_size
)

126 
	`åa˚_pxt4_begö_‹dîed_åunˇã
(
öode
, 
√w_size
);

133 i‡(!
	`PXT4_I
(
öode
)->
jöode
)

135  
	`jbd3_jou∫Æ_begö_‹dîed_åunˇã
(
	`PXT4_JOURNAL
(
öode
),

136 
	`PXT4_I
(
öode
)->
jöode
,

137 
√w_size
);

138 
	}
}

140 
pxt4_övÆid©ïage
(
∑ge
 *∑ge, 
off£t
,

141 
Àngth
);

142 
__pxt4_jou∫ÆÀd_wrôïage
(
∑ge
 *∑ge, 
Àn
);

143 
pxt4_bh_dñay_‹_unwrôãn
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
);

144 
pxt4_mëa_å™s_blocks
(
öode
 *öode, 
lblocks
,

145 
≥xã¡s
);

151 
	$pxt4_öode_is_Á°_symlök
(
öode
 *inode)

153 i‡(!(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

154 
ó_blocks
 = 
	`PXT4_I
(
öode
)->
i_fûe_a˛
 ?

155 
	`PXT4_CLUSTER_SIZE
(
öode
->
i_sb
) >> 9 : 0;

157 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

160  (
	`S_ISLNK
(
öode
->
i_mode
Ë&& inode->
i_blocks
 - 
ó_blocks
 == 0);

162  
	`S_ISLNK
(
öode
->
i_mode
Ë&& inode->
i_size
 &&

163 (
öode
->
i_size
 < 
PXT4_N_BLOCKS
 * 4);

164 
	}
}

171 
	$pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

172 
nblocks
)

174 
ªt
;

182 
	`BUG_ON
(
	`PXT4_JOURNAL
(
öode
Ë=
NULL
);

183 
	`jbd_debug
(2, "ª°¨tög h™dÀ %p\n", 
h™dÀ
);

184 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

185 
ªt
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
nblocks
);

186 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

187 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

189  
ªt
;

190 
	}
}

195 
	$pxt4_evi˘_öode
(
öode
 *inode)

197 
h™dÀ_t
 *
h™dÀ
;

198 
îr
;

199 
exåa_¸edôs
 = 3;

200 
pxt4_x©å_öode_¨øy
 *
ó_öode_¨øy
 = 
NULL
;

202 
	`åa˚_pxt4_evi˘_öode
(
öode
);

204 i‡(
öode
->
i_∆ök
) {

223 i‡(
öode
->
i_öo
 !
PXT4_JOURNAL_INO
 &&

224 
	`pxt4_should_jou∫Æ_d©a
(
öode
) &&

225 (
	`S_ISLNK
(
öode
->
i_mode
Ë|| 
	`S_ISREG
(inode->i_mode)) &&

226 
öode
->
i_d©a
.
ƒ∑ges
) {

227 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

228 
tid_t
 
commô_tid
 = 
	`PXT4_I
(
öode
)->
i_d©async_tid
;

230 
	`jbd3_com∂ëe_å™ß˘i⁄
(
jou∫Æ
, 
commô_tid
);

231 
	`fûem≠_wrôe_™d_waô
(&
öode
->
i_d©a
);

233 
	`åunˇã_öode_∑ges_föÆ
(&
öode
->
i_d©a
);

235 
no_dñëe
;

238 i‡(
	`is_bad_öode
(
öode
))

239 
no_dñëe
;

240 
	`dquŸ_öôülize
(
öode
);

242 i‡(
	`pxt4_should_‹dî_d©a
(
öode
))

243 
	`pxt4_begö_‹dîed_åunˇã
(
öode
, 0);

244 
	`åunˇã_öode_∑ges_föÆ
(&
öode
->
i_d©a
);

250 
	`sb_°¨t_ötwrôe
(
öode
->
i_sb
);

252 i‡(!
	`IS_NOQUOTA
(
öode
))

253 
exåa_¸edôs
 +
	`PXT4_MAXQUOTAS_DEL_BLOCKS
(
öode
->
i_sb
);

255 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
,

256 
	`pxt4_blocks_f‹_åunˇã
(
öode
)+
exåa_¸edôs
);

257 i‡(
	`IS_ERR
(
h™dÀ
)) {

258 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
	`PTR_ERR
(
h™dÀ
));

264 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

265 
	`sb_íd_ötwrôe
(
öode
->
i_sb
);

266 
no_dñëe
;

269 i‡(
	`IS_SYNC
(
öode
))

270 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

279 i‡(
	`pxt4_öode_is_Á°_symlök
(
öode
))

280 
	`mem£t
(
	`PXT4_I
(
öode
)->
i_d©a
, 0, (PXT4_I(inode)->i_data));

281 
öode
->
i_size
 = 0;

282 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

283 i‡(
îr
) {

284 
	`pxt4_w¨nög
(
öode
->
i_sb
,

285 "couldn'àm¨k inodêdúty (î∏%d)", 
îr
);

286 
°›_h™dÀ
;

288 i‡(
öode
->
i_blocks
) {

289 
îr
 = 
	`pxt4_åunˇã
(
öode
);

290 i‡(
îr
) {

291 
	`pxt4_îr‹
(
öode
->
i_sb
,

293 
öode
->
i_öo
, 
îr
);

294 
°›_h™dÀ
;

299 
îr
 = 
	`pxt4_x©å_dñëe_öode
(
h™dÀ
, 
öode
, &
ó_öode_¨øy
,

300 
exåa_¸edôs
);

301 i‡(
îr
) {

302 
	`pxt4_w¨nög
(
öode
->
i_sb
, "x©å dñëê”º %d)", 
îr
);

303 
°›_h™dÀ
:

304 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

305 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

306 
	`sb_íd_ötwrôe
(
öode
->
i_sb
);

307 
	`pxt4_x©å_öode_¨øy_‰ì
(
ó_öode_¨øy
);

308 
no_dñëe
;

319 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

320 
	`PXT4_I
(
öode
)->
i_dtime
 = (
__u32
)
	`ktime_gë_ªÆ_£c⁄ds
();

329 i‡(
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
))

331 
	`pxt4_˛ór_öode
(
öode
);

333 
	`pxt4_‰ì_öode
(
h™dÀ
, 
öode
);

334 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

335 
	`sb_íd_ötwrôe
(
öode
->
i_sb
);

336 
	`pxt4_x©å_öode_¨øy_‰ì
(
ó_öode_¨øy
);

338 
no_dñëe
:

339 
	`pxt4_˛ór_öode
(
öode
);

340 
	}
}

342 #ifde‡
CONFIG_QUOTA


343 
qsize_t
 *
	$pxt4_gë_ª£rved_•a˚
(
öode
 *inode)

345  &
	`PXT4_I
(
öode
)->
i_ª£rved_quŸa
;

346 
	}
}

353 
	$pxt4_da_upd©e_ª£rve_•a˚
(
öode
 *inode,

354 
u£d
, 
quŸa_˛aim
)

356 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

357 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

359 
	`•ö_lock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

360 
	`åa˚_pxt4_da_upd©e_ª£rve_•a˚
(
öode
, 
u£d
, 
quŸa_˛aim
);

361 i‡(
	`u∆ikñy
(
u£d
 > 
ei
->
i_ª£rved_d©a_blocks
)) {

362 
	`pxt4_w¨nög
(
öode
->
i_sb
, "%s: ino %lu, used %d "

364 
__func__
, 
öode
->
i_öo
, 
u£d
,

365 
ei
->
i_ª£rved_d©a_blocks
);

366 
	`WARN_ON
(1);

367 
u£d
 = 
ei
->
i_ª£rved_d©a_blocks
;

371 
ei
->
i_ª£rved_d©a_blocks
 -
u£d
;

372 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 
u£d
);

374 
	`•ö_u∆ock
(&
	`PXT4_I
(
öode
)->
i_block_ª£rv©i⁄_lock
);

377 i‡(
quŸa_˛aim
)

378 
	`dquŸ_˛aim_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
u£d
));

385 
	`dquŸ_ªÀa£_ª£rv©i⁄_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
u£d
));

393 i‡((
ei
->
i_ª£rved_d©a_blocks
 == 0) &&

394 !
	`öode_is_›í_f‹_wrôe
(
öode
))

395 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

396 
	}
}

398 
	$__check_block_vÆidôy
(
öode
 *öode, c⁄° *
func
,

399 
löe
,

400 
pxt4_m≠_blocks
 *
m≠
)

402 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
öode
->
i_sb
) &&

403 (
öode
->
i_öo
 ==

404 
	`À32_to_˝u
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_jou∫Æ_öum
)))

406 i‡(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
m≠
->
m_pblk
,

407 
m≠
->
m_Àn
)) {

408 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
m≠
->
m_pblk
,

410 "÷ígth %d)", (Ë
m≠
->
m_lblk
,

411 
m≠
->
m_pblk
, m≠->
m_Àn
);

412  -
EFSCORRUPTED
;

415 
	}
}

417 
	$pxt4_issue_zîoout
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
, 
pxt4_fsblk_t
 
pblk
,

418 
pxt4_lblk_t
 
Àn
)

420 
ªt
;

422 i‡(
	`IS_ENCRYPTED
(
öode
))

423  
	`fs¸y±_zîoout_ønge
(
öode
, 
lblk
, 
pblk
, 
Àn
);

425 
ªt
 = 
	`sb_issue_zîoout
(
öode
->
i_sb
, 
pblk
, 
Àn
, 
GFP_NOFS
);

426 i‡(
ªt
 > 0)

427 
ªt
 = 0;

429  
ªt
;

430 
	}
}

432 
	#check_block_vÆidôy
(
öode
, 
m≠
) \

433 
	`__check_block_vÆidôy
((
öode
), 
__func__
, 
__LINE__
, (
m≠
))

	)

435 #ifde‡
ES_AGGRESSIVE_TEST


436 
	$pxt4_m≠_blocks_es_ªcheck
(
h™dÀ_t
 *
h™dÀ
,

437 
öode
 *inode,

438 
pxt4_m≠_blocks
 *
es_m≠
,

439 
pxt4_m≠_blocks
 *
m≠
,

440 
Êags
)

442 
ªtvÆ
;

444 
m≠
->
m_Êags
 = 0;

452 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

453 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

454 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

455 
PXT4_GET_BLOCKS_KEEP_SIZE
);

457 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

458 
PXT4_GET_BLOCKS_KEEP_SIZE
);

460 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

466 i‡(
es_m≠
->
m_lblk
 !
m≠
->m_lblk ||

467 
es_m≠
->
m_Êags
 !
m≠
->m_flags ||

468 
es_m≠
->
m_pblk
 !
m≠
->m_pblk) {

469 
	`¥ötk
("ES cacheássertion failed for inode: %lu "

472 
öode
->
i_öo
, 
es_m≠
->
m_lblk
,És_m≠->
m_Àn
,

473 
es_m≠
->
m_pblk
,És_m≠->
m_Êags
, 
m≠
->
m_lblk
,

474 
m≠
->
m_Àn
, m≠->
m_pblk
, m≠->
m_Êags
,

475 
ªtvÆ
, 
Êags
);

477 
	}
}

502 
	$pxt4_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

503 
pxt4_m≠_blocks
 *
m≠
, 
Êags
)

505 
exã¡_°©us
 
es
;

506 
ªtvÆ
;

507 
ªt
 = 0;

508 #ifde‡
ES_AGGRESSIVE_TEST


509 
pxt4_m≠_blocks
 
‹ig_m≠
;

511 
	`mem˝y
(&
‹ig_m≠
, 
m≠
, (*map));

514 
m≠
->
m_Êags
 = 0;

515 
	`ext_debug
("pxt4_map_blocks(): inode %lu, flag %d, max_blocks %u,"

516 "logiˇ»block %lu\n", 
öode
->
i_öo
, 
Êags
, 
m≠
->
m_Àn
,

517 (Ë
m≠
->
m_lblk
);

522 i‡(
	`u∆ikñy
(
m≠
->
m_Àn
 > 
INT_MAX
))

523 
m≠
->
m_Àn
 = 
INT_MAX
;

526 i‡(
	`u∆ikñy
(
m≠
->
m_lblk
 >
EXT_MAX_BLOCKS
))

527  -
EFSCORRUPTED
;

530 i‡(
	`pxt4_es_lookup_exã¡
(
öode
, 
m≠
->
m_lblk
, 
NULL
, &
es
)) {

531 i‡(
	`pxt4_es_is_wrôãn
(&
es
Ë|| 
	`pxt4_es_is_unwrôãn
(&es)) {

532 
m≠
->
m_pblk
 = 
	`pxt4_es_pblock
(&
es
) +

533 
m≠
->
m_lblk
 - 
es
.
es_lblk
;

534 
m≠
->
m_Êags
 |
	`pxt4_es_is_wrôãn
(&
es
) ?

535 
PXT4_MAP_MAPPED
 : 
PXT4_MAP_UNWRITTEN
;

536 
ªtvÆ
 = 
es
.
es_Àn
 - (
m≠
->
m_lblk
 -És.
es_lblk
);

537 i‡(
ªtvÆ
 > 
m≠
->
m_Àn
)

538 
ªtvÆ
 = 
m≠
->
m_Àn
;

539 
m≠
->
m_Àn
 = 
ªtvÆ
;

540 } i‡(
	`pxt4_es_is_dñayed
(&
es
Ë|| 
	`pxt4_es_is_hﬁe
(&es)) {

541 
m≠
->
m_pblk
 = 0;

542 
ªtvÆ
 = 
es
.
es_Àn
 - (
m≠
->
m_lblk
 -És.
es_lblk
);

543 i‡(
ªtvÆ
 > 
m≠
->
m_Àn
)

544 
ªtvÆ
 = 
m≠
->
m_Àn
;

545 
m≠
->
m_Àn
 = 
ªtvÆ
;

546 
ªtvÆ
 = 0;

548 
	`BUG
();

550 #ifde‡
ES_AGGRESSIVE_TEST


551 
	`pxt4_m≠_blocks_es_ªcheck
(
h™dÀ
, 
öode
, 
m≠
,

552 &
‹ig_m≠
, 
Êags
);

554 
found
;

561 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

562 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

563 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

564 
PXT4_GET_BLOCKS_KEEP_SIZE
);

566 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

567 
PXT4_GET_BLOCKS_KEEP_SIZE
);

569 i‡(
ªtvÆ
 > 0) {

570 
°©us
;

572 i‡(
	`u∆ikñy
(
ªtvÆ
 !
m≠
->
m_Àn
)) {

573 
	`pxt4_w¨nög
(
öode
->
i_sb
,

576 
öode
->
i_öo
, 
ªtvÆ
, 
m≠
->
m_Àn
);

577 
	`WARN_ON
(1);

580 
°©us
 = 
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
 ?

581 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

582 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
) &&

583 !(
°©us
 & 
EXTENT_STATUS_WRITTEN
) &&

584 
	`pxt4_es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
m≠
->
m_lblk
,

585 
m≠
->
m_lblk
 + m≠->
m_Àn
 - 1))

586 
°©us
 |
EXTENT_STATUS_DELAYED
;

587 
ªt
 = 
	`pxt4_es_ö£π_exã¡
(
öode
, 
m≠
->
m_lblk
,

588 
m≠
->
m_Àn
, m≠->
m_pblk
, 
°©us
);

589 i‡(
ªt
 < 0)

590 
ªtvÆ
 = 
ªt
;

592 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

594 
found
:

595 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
) {

596 
ªt
 = 
	`check_block_vÆidôy
(
öode
, 
m≠
);

597 i‡(
ªt
 != 0)

598  
ªt
;

602 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0)

603  
ªtvÆ
;

612 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
)

618 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
))

619  
ªtvÆ
;

625 
m≠
->
m_Êags
 &~
PXT4_MAP_FLAGS
;

633 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

639 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

640 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
);

642 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
);

644 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_NEW
) {

650 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
);

659 i‡((
ªtvÆ
 > 0) &&

660 (
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
))

661 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
, 
ªtvÆ
, 1);

664 i‡(
ªtvÆ
 > 0) {

665 
°©us
;

667 i‡(
	`u∆ikñy
(
ªtvÆ
 !
m≠
->
m_Àn
)) {

668 
	`pxt4_w¨nög
(
öode
->
i_sb
,

671 
öode
->
i_öo
, 
ªtvÆ
, 
m≠
->
m_Àn
);

672 
	`WARN_ON
(1);

682 i‡(
Êags
 & 
PXT4_GET_BLOCKS_ZERO
 &&

683 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
 &&

684 
m≠
->
m_Êags
 & 
PXT4_MAP_NEW
) {

685 
ªt
 = 
	`pxt4_issue_zîoout
(
öode
, 
m≠
->
m_lblk
,

686 
m≠
->
m_pblk
, m≠->
m_Àn
);

687 i‡(
ªt
) {

688 
ªtvÆ
 = 
ªt
;

689 
out_£m
;

697 i‡((
Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
) &&

698 
	`pxt4_es_lookup_exã¡
(
öode
, 
m≠
->
m_lblk
, 
NULL
, &
es
)) {

699 i‡(
	`pxt4_es_is_wrôãn
(&
es
))

700 
out_£m
;

702 
°©us
 = 
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
 ?

703 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

704 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
) &&

705 !(
°©us
 & 
EXTENT_STATUS_WRITTEN
) &&

706 
	`pxt4_es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
m≠
->
m_lblk
,

707 
m≠
->
m_lblk
 + m≠->
m_Àn
 - 1))

708 
°©us
 |
EXTENT_STATUS_DELAYED
;

709 
ªt
 = 
	`pxt4_es_ö£π_exã¡
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
,

710 
m≠
->
m_pblk
, 
°©us
);

711 i‡(
ªt
 < 0) {

712 
ªtvÆ
 = 
ªt
;

713 
out_£m
;

717 
out_£m
:

718 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

719 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
) {

720 
ªt
 = 
	`check_block_vÆidôy
(
öode
, 
m≠
);

721 i‡(
ªt
 != 0)

722  
ªt
;

729 i‡(
m≠
->
m_Êags
 & 
PXT4_MAP_NEW
 &&

730 !(
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
) &&

731 !(
Êags
 & 
PXT4_GET_BLOCKS_ZERO
) &&

732 !
	`pxt4_is_quŸa_fûe
(
öode
) &&

733 
	`pxt4_should_‹dî_d©a
(
öode
)) {

734 
loff_t
 
°¨t_byã
 =

735 (
loff_t
)
m≠
->
m_lblk
 << 
öode
->
i_blkbôs
;

736 
loff_t
 
Àngth
 = (loff_t)
m≠
->
m_Àn
 << 
öode
->
i_blkbôs
;

738 i‡(
Êags
 & 
PXT4_GET_BLOCKS_IO_SUBMIT
)

739 
ªt
 = 
	`pxt4_jbd3_öode_add_waô
(
h™dÀ
, 
öode
,

740 
°¨t_byã
, 
Àngth
);

742 
ªt
 = 
	`pxt4_jbd3_öode_add_wrôe
(
h™dÀ
, 
öode
,

743 
°¨t_byã
, 
Àngth
);

744 i‡(
ªt
)

745  
ªt
;

748  
ªtvÆ
;

749 
	}
}

755 
	$pxt4_upd©e_bh_°©e
(
buf„r_hód
 *
bh
, 
Êags
)

757 
ﬁd_°©e
;

758 
√w_°©e
;

760 
Êags
 &
PXT4_MAP_FLAGS
;

763 i‡(!
bh
->
b_∑ge
) {

764 
bh
->
b_°©e
 = (bh->b_°©ê& ~
PXT4_MAP_FLAGS
Ë| 
Êags
;

773 
ﬁd_°©e
 = 
	`READ_ONCE
(
bh
->
b_°©e
);

774 
√w_°©e
 = (
ﬁd_°©e
 & ~
PXT4_MAP_FLAGS
Ë| 
Êags
;

775 } 
	`u∆ikñy
(

776 
	`cmpxchg
(&
bh
->
b_°©e
, 
ﬁd_°©e
, 
√w_°©e
) != old_state));

777 
	}
}

779 
	$_pxt4_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

780 
buf„r_hód
 *
bh
, 
Êags
)

782 
pxt4_m≠_blocks
 
m≠
;

783 
ªt
 = 0;

785 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

786  -
ERANGE
;

788 
m≠
.
m_lblk
 = 
iblock
;

789 
m≠
.
m_Àn
 = 
bh
->
b_size
 >> 
öode
->
i_blkbôs
;

791 
ªt
 = 
	`pxt4_m≠_blocks
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
(), 
öode
, &
m≠
,

792 
Êags
);

793 i‡(
ªt
 > 0) {

794 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
m≠
.
m_pblk
);

795 
	`pxt4_upd©e_bh_°©e
(
bh
, 
m≠
.
m_Êags
);

796 
bh
->
b_size
 = 
öode
->
i_sb
->
s_blocksize
 * 
m≠
.
m_Àn
;

797 
ªt
 = 0;

798 } i‡(
ªt
 == 0) {

800 
bh
->
b_size
 = 
öode
->
i_sb
->
s_blocksize
 * 
m≠
.
m_Àn
;

802  
ªt
;

803 
	}
}

805 
	$pxt4_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

806 
buf„r_hód
 *
bh
, 
¸óã
)

808  
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh
,

809 
¸óã
 ? 
PXT4_GET_BLOCKS_CREATE
 : 0);

810 
	}
}

817 
	$pxt4_gë_block_unwrôãn
(
öode
 *öode, 
£˘‹_t
 
iblock
,

818 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

820 
	`pxt4_debug
("pxt4_get_block_unwritten: inode %lu, create flag %d\n",

821 
öode
->
i_öo
, 
¸óã
);

822  
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh_ªsu…
,

823 
PXT4_GET_BLOCKS_IO_CREATE_EXT
);

824 
	}
}

827 
	#DIO_MAX_BLOCKS
 4096

	)

834 
	$pxt4_gë_block_å™s
(
öode
 *öode, 
£˘‹_t
 
iblock
,

835 
buf„r_hód
 *
bh_ªsu…
, 
Êags
)

837 
dio_¸edôs
;

838 
h™dÀ_t
 *
h™dÀ
;

839 
ªåõs
 = 0;

840 
ªt
;

843 i‡(
bh_ªsu…
->
b_size
 >> 
öode
->
i_blkbôs
 > 
DIO_MAX_BLOCKS
)

844 
bh_ªsu…
->
b_size
 = 
DIO_MAX_BLOCKS
 << 
öode
->
i_blkbôs
;

845 
dio_¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
,

846 
bh_ªsu…
->
b_size
 >> 
öode
->
i_blkbôs
);

847 
ªåy
:

848 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
, 
dio_¸edôs
);

849 i‡(
	`IS_ERR
(
h™dÀ
))

850  
	`PTR_ERR
(
h™dÀ
);

852 
ªt
 = 
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh_ªsu…
, 
Êags
);

853 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

855 i‡(
ªt
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

856 
ªåy
;

857  
ªt
;

858 
	}
}

861 
	$pxt4_dio_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

862 
buf„r_hód
 *
bh
, 
¸óã
)

865 
	`WARN_ON_ONCE
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
());

867 i‡(!
¸óã
)

868  
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh
, 0);

869  
	`pxt4_gë_block_å™s
(
öode
, 
iblock
, 
bh
, 
PXT4_GET_BLOCKS_CREATE
);

870 
	}
}

877 
	$pxt4_dio_gë_block_unwrôãn_async
(
öode
 *inode,

878 
£˘‹_t
 
iblock
, 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

880 
ªt
;

883 
	`WARN_ON_ONCE
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
());

885 
ªt
 = 
	`pxt4_gë_block_å™s
(
öode
, 
iblock
, 
bh_ªsu…
,

886 
PXT4_GET_BLOCKS_IO_CREATE_EXT
);

895 i‡(!
ªt
 && 
	`buf„r_unwrôãn
(
bh_ªsu…
)) {

896 i‡(!
bh_ªsu…
->
b_¥iv©e
) {

897 
pxt4_io_íd_t
 *
io_íd
;

899 
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_KERNEL
);

900 i‡(!
io_íd
)

901  -
ENOMEM
;

902 
bh_ªsu…
->
b_¥iv©e
 = 
io_íd
;

903 
	`pxt4_£t_io_unwrôãn_Êag
(
öode
, 
io_íd
);

905 
	`£t_buf„r_de„r_com∂ëi⁄
(
bh_ªsu…
);

908  
ªt
;

909 
	}
}

916 
	$pxt4_dio_gë_block_unwrôãn_sync
(
öode
 *inode,

917 
£˘‹_t
 
iblock
, 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

919 
ªt
;

922 
	`WARN_ON_ONCE
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
());

924 
ªt
 = 
	`pxt4_gë_block_å™s
(
öode
, 
iblock
, 
bh_ªsu…
,

925 
PXT4_GET_BLOCKS_IO_CREATE_EXT
);

932 i‡(!
ªt
 && 
	`buf„r_unwrôãn
(
bh_ªsu…
))

933 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_DIO_UNWRITTEN
);

935  
ªt
;

936 
	}
}

938 
	$pxt4_dio_gë_block_ovîwrôe
(
öode
 *öode, 
£˘‹_t
 
iblock
,

939 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

941 
ªt
;

943 
	`pxt4_debug
("pxt4_dio_get_block_overwrite: inode %lu, create flag %d\n",

944 
öode
->
i_öo
, 
¸óã
);

946 
	`WARN_ON_ONCE
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
());

948 
ªt
 = 
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh_ªsu…
, 0);

953 
	`WARN_ON_ONCE
(!
	`buf„r_m≠≥d
(
bh_ªsu…
Ë|| 
	`buf„r_unwrôãn
(bh_result));

955  
ªt
;

956 
	}
}

962 
buf„r_hód
 *
	$pxt4_gëblk
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

963 
pxt4_lblk_t
 
block
, 
m≠_Êags
)

965 
pxt4_m≠_blocks
 
m≠
;

966 
buf„r_hód
 *
bh
;

967 
¸óã
 = 
m≠_Êags
 & 
PXT4_GET_BLOCKS_CREATE
;

968 
îr
;

970 
	`J_ASSERT
(
h™dÀ
 !
NULL
 || 
¸óã
 == 0);

972 
m≠
.
m_lblk
 = 
block
;

973 
m≠
.
m_Àn
 = 1;

974 
îr
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
, 
m≠_Êags
);

976 i‡(
îr
 == 0)

977  
¸óã
 ? 
	`ERR_PTR
(-
ENOSPC
Ë: 
NULL
;

978 i‡(
îr
 < 0)

979  
	`ERR_PTR
(
îr
);

981 
bh
 = 
	`sb_gëblk
(
öode
->
i_sb
, 
m≠
.
m_pblk
);

982 i‡(
	`u∆ikñy
(!
bh
))

983  
	`ERR_PTR
(-
ENOMEM
);

984 i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_NEW
) {

985 
	`J_ASSERT
(
¸óã
 != 0);

986 
	`J_ASSERT
(
h™dÀ
 !
NULL
);

995 
	`lock_buf„r
(
bh
);

996 
	`BUFFER_TRACE
(
bh
, "call get_create_access");

997 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

998 i‡(
	`u∆ikñy
(
îr
)) {

999 
	`u∆ock_buf„r
(
bh
);

1000 
îrout
;

1002 i‡(!
	`buf„r_u±od©e
(
bh
)) {

1003 
	`mem£t
(
bh
->
b_d©a
, 0, 
öode
->
i_sb
->
s_blocksize
);

1004 
	`£t_buf„r_u±od©e
(
bh
);

1006 
	`u∆ock_buf„r
(
bh
);

1007 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

1008 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1009 i‡(
	`u∆ikñy
(
îr
))

1010 
îrout
;

1012 
	`BUFFER_TRACE
(
bh
, "notáÇew buffer");

1013  
bh
;

1014 
îrout
:

1015 
	`bªl£
(
bh
);

1016  
	`ERR_PTR
(
îr
);

1017 
	}
}

1019 
buf„r_hód
 *
	$pxt4_bªad
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1020 
pxt4_lblk_t
 
block
, 
m≠_Êags
)

1022 
buf„r_hód
 *
bh
;

1024 
bh
 = 
	`pxt4_gëblk
(
h™dÀ
, 
öode
, 
block
, 
m≠_Êags
);

1025 i‡(
	`IS_ERR
(
bh
))

1026  
bh
;

1027 i‡(!
bh
 || 
	`pxt4_buf„r_u±od©e
(bh))

1028  
bh
;

1029 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1, &
bh
);

1030 
	`waô_⁄_buf„r
(
bh
);

1031 i‡(
	`buf„r_u±od©e
(
bh
))

1032  
bh
;

1033 
	`put_bh
(
bh
);

1034  
	`ERR_PTR
(-
EIO
);

1035 
	}
}

1038 
	$pxt4_bªad_b©ch
(
öode
 *öode, 
pxt4_lblk_t
 
block
, 
bh_cou¡
,

1039 
boﬁ
 
waô
, 
buf„r_hód
 **
bhs
)

1041 
i
, 
îr
;

1043 
i
 = 0; i < 
bh_cou¡
; i++) {

1044 
bhs
[
i
] = 
	`pxt4_gëblk
(
NULL
, 
öode
, 
block
 + i, 0 );

1045 i‡(
	`IS_ERR
(
bhs
[
i
])) {

1046 
îr
 = 
	`PTR_ERR
(
bhs
[
i
]);

1047 
bh_cou¡
 = 
i
;

1048 
out_bªl£
;

1052 
i
 = 0; i < 
bh_cou¡
; i++)

1054 i‡(
bhs
[
i
] && !
	`pxt4_buf„r_u±od©e
(bhs[i]))

1055 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1,

1056 &
bhs
[
i
]);

1058 i‡(!
waô
)

1061 
i
 = 0; i < 
bh_cou¡
; i++)

1062 i‡(
bhs
[
i
])

1063 
	`waô_⁄_buf„r
(
bhs
[
i
]);

1065 
i
 = 0; i < 
bh_cou¡
; i++) {

1066 i‡(
bhs
[
i
] && !
	`buf„r_u±od©e
(bhs[i])) {

1067 
îr
 = -
EIO
;

1068 
out_bªl£
;

1073 
out_bªl£
:

1074 
i
 = 0; i < 
bh_cou¡
; i++) {

1075 
	`bªl£
(
bhs
[
i
]);

1076 
bhs
[
i
] = 
NULL
;

1078  
îr
;

1079 
	}
}

1081 
	$pxt4_wÆk_∑ge_buf„rs
(
h™dÀ_t
 *
h™dÀ
,

1082 
buf„r_hód
 *
hód
,

1083 
‰om
,

1084 
to
,

1085 *
∑πül
,

1086 (*
‚
)(
h™dÀ_t
 *
h™dÀ
,

1087 
buf„r_hód
 *
bh
))

1089 
buf„r_hód
 *
bh
;

1090 
block_°¨t
, 
block_íd
;

1091 
blocksize
 = 
hód
->
b_size
;

1092 
îr
, 
ªt
 = 0;

1093 
buf„r_hód
 *
√xt
;

1095 
bh
 = 
hód
, 
block_°¨t
 = 0;

1096 
ªt
 =0 && (
bh
 !
hód
 || !
block_°¨t
);

1097 
block_°¨t
 = 
block_íd
, 
bh
 = 
√xt
) {

1098 
√xt
 = 
bh
->
b_this_∑ge
;

1099 
block_íd
 = 
block_°¨t
 + 
blocksize
;

1100 i‡(
block_íd
 <
‰om
 || 
block_°¨t
 >
to
) {

1101 i‡(
∑πül
 && !
	`buf„r_u±od©e
(
bh
))

1102 *
∑πül
 = 1;

1105 
îr
 = (*
‚
)(
h™dÀ
, 
bh
);

1106 i‡(!
ªt
)

1107 
ªt
 = 
îr
;

1109  
ªt
;

1110 
	}
}

1136 
	$do_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ_t
 *
h™dÀ
,

1137 
buf„r_hód
 *
bh
)

1139 
dúty
 = 
	`buf„r_dúty
(
bh
);

1140 
ªt
;

1142 i‡(!
	`buf„r_m≠≥d
(
bh
Ë|| 
	`buf„r_‰ìd
(bh))

1152 i‡(
dúty
)

1153 
	`˛ór_buf„r_dúty
(
bh
);

1154 
	`BUFFER_TRACE
(
bh
, "get writeáccess");

1155 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1156 i‡(!
ªt
 && 
dúty
)

1157 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1158  
ªt
;

1159 
	}
}

1161 #ifde‡
CONFIG_FS_ENCRYPTION


1162 
	$pxt4_block_wrôe_begö
(
∑ge
 *∑ge, 
loff_t
 
pos
, 
Àn
,

1163 
gë_block_t
 *
gë_block
)

1165 
‰om
 = 
pos
 & (
PAGE_SIZE
 - 1);

1166 
to
 = 
‰om
 + 
Àn
;

1167 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

1168 
block_°¨t
, 
block_íd
;

1169 
£˘‹_t
 
block
;

1170 
îr
 = 0;

1171 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

1172 
bbôs
;

1173 
buf„r_hód
 *
bh
, *
hód
, *
waô
[2];

1174 
ƒ_waô
 = 0;

1175 
i
;

1177 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

1178 
	`BUG_ON
(
‰om
 > 
PAGE_SIZE
);

1179 
	`BUG_ON
(
to
 > 
PAGE_SIZE
);

1180 
	`BUG_ON
(
‰om
 > 
to
);

1182 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

1183 
	`¸óã_em±y_buf„rs
(
∑ge
, 
blocksize
, 0);

1184 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

1185 
bbôs
 = 
	`ûog2
(
blocksize
);

1186 
block
 = (
£˘‹_t
)
∑ge
->
ödex
 << (
PAGE_SHIFT
 - 
bbôs
);

1188 
bh
 = 
hód
, 
block_°¨t
 = 0; bh != head || !block_start;

1189 
block
++, 
block_°¨t
 = 
block_íd
, 
bh
 = bh->
b_this_∑ge
) {

1190 
block_íd
 = 
block_°¨t
 + 
blocksize
;

1191 i‡(
block_íd
 <
‰om
 || 
block_°¨t
 >
to
) {

1192 i‡(
	`PageU±od©e
(
∑ge
)) {

1193 i‡(!
	`buf„r_u±od©e
(
bh
))

1194 
	`£t_buf„r_u±od©e
(
bh
);

1198 i‡(
	`buf„r_√w
(
bh
))

1199 
	`˛ór_buf„r_√w
(
bh
);

1200 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

1201 
	`WARN_ON
(
bh
->
b_size
 !
blocksize
);

1202 
îr
 = 
	`gë_block
(
öode
, 
block
, 
bh
, 1);

1203 i‡(
îr
)

1205 i‡(
	`buf„r_√w
(
bh
)) {

1206 i‡(
	`PageU±od©e
(
∑ge
)) {

1207 
	`˛ór_buf„r_√w
(
bh
);

1208 
	`£t_buf„r_u±od©e
(
bh
);

1209 
	`m¨k_buf„r_dúty
(
bh
);

1212 i‡(
block_íd
 > 
to
 || 
block_°¨t
 < 
‰om
)

1213 
	`zîo_u£r_£gmíts
(
∑ge
, 
to
, 
block_íd
,

1214 
block_°¨t
, 
‰om
);

1218 i‡(
	`PageU±od©e
(
∑ge
)) {

1219 i‡(!
	`buf„r_u±od©e
(
bh
))

1220 
	`£t_buf„r_u±od©e
(
bh
);

1223 i‡(!
	`buf„r_u±od©e
(
bh
Ë&& !
	`buf„r_dñay
(bh) &&

1224 !
	`buf„r_unwrôãn
(
bh
) &&

1225 (
block_°¨t
 < 
‰om
 || 
block_íd
 > 
to
)) {

1226 
	`Œ_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

1227 
waô
[
ƒ_waô
++] = 
bh
;

1233 
i
 = 0; i < 
ƒ_waô
; i++) {

1234 
	`waô_⁄_buf„r
(
waô
[
i
]);

1235 i‡(!
	`buf„r_u±od©e
(
waô
[
i
]))

1236 
îr
 = -
EIO
;

1238 i‡(
	`u∆ikñy
(
îr
)) {

1239 
	`∑ge_zîo_√w_buf„rs
(
∑ge
, 
‰om
, 
to
);

1240 } i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
)) {

1241 
i
 = 0; i < 
ƒ_waô
; i++) {

1242 
îr2
;

1244 
îr2
 = 
	`fs¸y±_de¸y±_∑geˇche_blocks
(
∑ge
, 
blocksize
,

1245 
	`bh_off£t
(
waô
[
i
]));

1246 i‡(
îr2
) {

1247 
	`˛ór_buf„r_u±od©e
(
waô
[
i
]);

1248 
îr
 = 
îr2
;

1253  
îr
;

1254 
	}
}

1257 
	$pxt4_wrôe_begö
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

1258 
loff_t
 
pos
, 
Àn
, 
Êags
,

1259 
∑ge
 **
∑gï
, **
fsd©a
)

1261 
öode
 *öodê
m≠pög
->
ho°
;

1262 
ªt
, 
√eded_blocks
;

1263 
h™dÀ_t
 *
h™dÀ
;

1264 
ªåõs
 = 0;

1265 
∑ge
 *page;

1266 
pgoff_t
 
ödex
;

1267 
‰om
, 
to
;

1269 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

1270  -
EIO
;

1272 
	`åa˚_pxt4_wrôe_begö
(
öode
, 
pos
, 
Àn
, 
Êags
);

1277 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
) + 1;

1278 
ödex
 = 
pos
 >> 
PAGE_SHIFT
;

1279 
‰om
 = 
pos
 & (
PAGE_SIZE
 - 1);

1280 
to
 = 
‰om
 + 
Àn
;

1282 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
)) {

1283 
ªt
 = 
	`pxt4_åy_to_wrôe_ölöe_d©a
(
m≠pög
, 
öode
, 
pos
, 
Àn
,

1284 
Êags
, 
∑gï
);

1285 i‡(
ªt
 < 0)

1286  
ªt
;

1287 i‡(
ªt
 == 1)

1298 
ªåy_gøb
:

1299 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 
ödex
, 
Êags
);

1300 i‡(!
∑ge
)

1301  -
ENOMEM
;

1302 
	`u∆ock_∑ge
(
∑ge
);

1304 
ªåy_jou∫Æ
:

1305 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
);

1306 i‡(
	`IS_ERR
(
h™dÀ
)) {

1307 
	`put_∑ge
(
∑ge
);

1308  
	`PTR_ERR
(
h™dÀ
);

1311 
	`lock_∑ge
(
∑ge
);

1312 i‡(
∑ge
->
m≠pög
 != mapping) {

1314 
	`u∆ock_∑ge
(
∑ge
);

1315 
	`put_∑ge
(
∑ge
);

1316 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1317 
ªåy_gøb
;

1320 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

1322 #ifde‡
CONFIG_FS_ENCRYPTION


1323 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

1324 
ªt
 = 
	`pxt4_block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

1325 
pxt4_gë_block_unwrôãn
);

1327 
ªt
 = 
	`pxt4_block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

1328 
pxt4_gë_block
);

1330 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

1331 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

1332 
pxt4_gë_block_unwrôãn
);

1334 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
, 
pxt4_gë_block
);

1336 i‡(!
ªt
 && 
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

1337 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
),

1338 
‰om
, 
to
, 
NULL
,

1339 
do_jou∫Æ_gë_wrôe_ac˚ss
);

1342 i‡(
ªt
) {

1343 
boﬁ
 
exãnded
 = (
pos
 + 
Àn
 > 
öode
->
i_size
) &&

1344 !
	`pxt4_vîôy_ö_¥ogªss
(
öode
);

1346 
	`u∆ock_∑ge
(
∑ge
);

1355 i‡(
exãnded
 && 
	`pxt4_ˇn_åunˇã
(
öode
))

1356 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

1358 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1359 i‡(
exãnded
) {

1360 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

1367 i‡(
öode
->
i_∆ök
)

1368 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

1371 i‡(
ªt
 =-
ENOSPC
 &&

1372 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

1373 
ªåy_jou∫Æ
;

1374 
	`put_∑ge
(
∑ge
);

1375  
ªt
;

1377 *
∑gï
 = 
∑ge
;

1378  
ªt
;

1379 
	}
}

1382 
	$wrôe_íd_‚
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1384 
ªt
;

1385 i‡(!
	`buf„r_m≠≥d
(
bh
Ë|| 
	`buf„r_‰ìd
(bh))

1387 
	`£t_buf„r_u±od©e
(
bh
);

1388 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1389 
	`˛ór_buf„r_mëa
(
bh
);

1390 
	`˛ór_buf„r_¥io
(
bh
);

1391  
ªt
;

1392 
	}
}

1401 
	$pxt4_wrôe_íd
(
fûe
 *file,

1402 
addªss_•a˚
 *
m≠pög
,

1403 
loff_t
 
pos
, 
Àn
, 
c›õd
,

1404 
∑ge
 *∑ge, *
fsd©a
)

1406 
h™dÀ_t
 *
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

1407 
öode
 *öodê
m≠pög
->
ho°
;

1408 
loff_t
 
ﬁd_size
 = 
öode
->
i_size
;

1409 
ªt
 = 0, 
ªt2
;

1410 
i_size_ch™ged
 = 0;

1411 
ölöe_d©a
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

1412 
boﬁ
 
vîôy
 = 
	`pxt4_vîôy_ö_¥ogªss
(
öode
);

1414 
	`åa˚_pxt4_wrôe_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
);

1415 i‡(
ölöe_d©a
) {

1416 
ªt
 = 
	`pxt4_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
,

1417 
c›õd
, 
∑ge
);

1418 i‡(
ªt
 < 0) {

1419 
	`u∆ock_∑ge
(
∑ge
);

1420 
	`put_∑ge
(
∑ge
);

1421 
îrout
;

1423 
c›õd
 = 
ªt
;

1425 
c›õd
 = 
	`block_wrôe_íd
(
fûe
, 
m≠pög
, 
pos
,

1426 
Àn
, 
c›õd
, 
∑ge
, 
fsd©a
);

1434 i‡(!
vîôy
)

1435 
i_size_ch™ged
 = 
	`pxt4_upd©e_öode_size
(
öode
, 
pos
 + 
c›õd
);

1436 
	`u∆ock_∑ge
(
∑ge
);

1437 
	`put_∑ge
(
∑ge
);

1439 i‡(
ﬁd_size
 < 
pos
 && !
vîôy
)

1440 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁd_size
, 
pos
);

1447 i‡(
i_size_ch™ged
 || 
ölöe_d©a
)

1448 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1450 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && !
vîôy
 && 
	`pxt4_ˇn_åunˇã
(inode))

1455 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

1456 
îrout
:

1457 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1458 i‡(!
ªt
)

1459 
ªt
 = 
ªt2
;

1461 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && !
vîôy
) {

1462 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

1468 i‡(
öode
->
i_∆ök
)

1469 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

1472  
ªt
 ?Ñë : 
c›õd
;

1473 
	}
}

1480 
	$pxt4_jou∫ÆÀd_zîo_√w_buf„rs
(
h™dÀ_t
 *
h™dÀ
,

1481 
∑ge
 *page,

1482 
‰om
, 
to
)

1484 
block_°¨t
 = 0, 
block_íd
;

1485 
buf„r_hód
 *
hód
, *
bh
;

1487 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

1489 
block_íd
 = 
block_°¨t
 + 
bh
->
b_size
;

1490 i‡(
	`buf„r_√w
(
bh
)) {

1491 i‡(
block_íd
 > 
‰om
 && 
block_°¨t
 < 
to
) {

1492 i‡(!
	`PageU±od©e
(
∑ge
)) {

1493 
°¨t
, 
size
;

1495 
°¨t
 = 
	`max
(
‰om
, 
block_°¨t
);

1496 
size
 = 
	`mö
(
to
, 
block_íd
Ë- 
°¨t
;

1498 
	`zîo_u£r
(
∑ge
, 
°¨t
, 
size
);

1499 
	`wrôe_íd_‚
(
h™dÀ
, 
bh
);

1501 
	`˛ór_buf„r_√w
(
bh
);

1504 
block_°¨t
 = 
block_íd
;

1505 
bh
 = bh->
b_this_∑ge
;

1506 } 
bh
 !
hód
);

1507 
	}
}

1509 
	$pxt4_jou∫ÆÀd_wrôe_íd
(
fûe
 *file,

1510 
addªss_•a˚
 *
m≠pög
,

1511 
loff_t
 
pos
, 
Àn
, 
c›õd
,

1512 
∑ge
 *∑ge, *
fsd©a
)

1514 
h™dÀ_t
 *
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

1515 
öode
 *öodê
m≠pög
->
ho°
;

1516 
loff_t
 
ﬁd_size
 = 
öode
->
i_size
;

1517 
ªt
 = 0, 
ªt2
;

1518 
∑πül
 = 0;

1519 
‰om
, 
to
;

1520 
size_ch™ged
 = 0;

1521 
ölöe_d©a
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

1522 
boﬁ
 
vîôy
 = 
	`pxt4_vîôy_ö_¥ogªss
(
öode
);

1524 
	`åa˚_pxt4_jou∫ÆÀd_wrôe_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
);

1525 
‰om
 = 
pos
 & (
PAGE_SIZE
 - 1);

1526 
to
 = 
‰om
 + 
Àn
;

1528 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

1530 i‡(
ölöe_d©a
) {

1531 
ªt
 = 
	`pxt4_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
,

1532 
c›õd
, 
∑ge
);

1533 i‡(
ªt
 < 0) {

1534 
	`u∆ock_∑ge
(
∑ge
);

1535 
	`put_∑ge
(
∑ge
);

1536 
îrout
;

1538 
c›õd
 = 
ªt
;

1539 } i‡(
	`u∆ikñy
(
c›õd
 < 
Àn
Ë&& !
	`PageU±od©e
(
∑ge
)) {

1540 
c›õd
 = 0;

1541 
	`pxt4_jou∫ÆÀd_zîo_√w_buf„rs
(
h™dÀ
, 
∑ge
, 
‰om
, 
to
);

1543 i‡(
	`u∆ikñy
(
c›õd
 < 
Àn
))

1544 
	`pxt4_jou∫ÆÀd_zîo_√w_buf„rs
(
h™dÀ
, 
∑ge
,

1545 
‰om
 + 
c›õd
, 
to
);

1546 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
), 
‰om
,

1547 
‰om
 + 
c›õd
, &
∑πül
,

1548 
wrôe_íd_‚
);

1549 i‡(!
∑πül
)

1550 
	`SëPageU±od©e
(
∑ge
);

1552 i‡(!
vîôy
)

1553 
size_ch™ged
 = 
	`pxt4_upd©e_öode_size
(
öode
, 
pos
 + 
c›õd
);

1554 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

1555 
	`PXT4_I
(
öode
)->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

1556 
	`u∆ock_∑ge
(
∑ge
);

1557 
	`put_∑ge
(
∑ge
);

1559 i‡(
ﬁd_size
 < 
pos
 && !
vîôy
)

1560 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁd_size
, 
pos
);

1562 i‡(
size_ch™ged
 || 
ölöe_d©a
) {

1563 
ªt2
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1564 i‡(!
ªt
)

1565 
ªt
 = 
ªt2
;

1568 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && !
vîôy
 && 
	`pxt4_ˇn_åunˇã
(inode))

1573 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

1575 
îrout
:

1576 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1577 i‡(!
ªt
)

1578 
ªt
 = 
ªt2
;

1579 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && !
vîôy
) {

1580 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

1586 i‡(
öode
->
i_∆ök
)

1587 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

1590  
ªt
 ?Ñë : 
c›õd
;

1591 
	}
}

1596 
	$pxt4_da_ª£rve_•a˚
(
öode
 *inode)

1598 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1599 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1600 
ªt
;

1607 
ªt
 = 
	`dquŸ_ª£rve_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 1));

1608 i‡(
ªt
)

1609  
ªt
;

1611 
	`•ö_lock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

1612 i‡(
	`pxt4_˛aim_‰ì_˛u°îs
(
sbi
, 1, 0)) {

1613 
	`•ö_u∆ock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

1614 
	`dquŸ_ªÀa£_ª£rv©i⁄_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 1));

1615  -
ENOSPC
;

1617 
ei
->
i_ª£rved_d©a_blocks
++;

1618 
	`åa˚_pxt4_da_ª£rve_•a˚
(
öode
);

1619 
	`•ö_u∆ock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

1622 
	}
}

1624 
	$pxt4_da_ªÀa£_•a˚
(
öode
 *öode, 
to_‰ì
)

1626 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1627 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1629 i‡(!
to_‰ì
)

1632 
	`•ö_lock
(&
	`PXT4_I
(
öode
)->
i_block_ª£rv©i⁄_lock
);

1634 
	`åa˚_pxt4_da_ªÀa£_•a˚
(
öode
, 
to_‰ì
);

1635 i‡(
	`u∆ikñy
(
to_‰ì
 > 
ei
->
i_ª£rved_d©a_blocks
)) {

1642 
	`pxt4_w¨nög
(
öode
->
i_sb
, "pxt4_da_release_space: "

1644 "d©®blocks", 
öode
->
i_öo
, 
to_‰ì
,

1645 
ei
->
i_ª£rved_d©a_blocks
);

1646 
	`WARN_ON
(1);

1647 
to_‰ì
 = 
ei
->
i_ª£rved_d©a_blocks
;

1649 
ei
->
i_ª£rved_d©a_blocks
 -
to_‰ì
;

1652 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 
to_‰ì
);

1654 
	`•ö_u∆ock
(&
	`PXT4_I
(
öode
)->
i_block_ª£rv©i⁄_lock
);

1656 
	`dquŸ_ªÀa£_ª£rv©i⁄_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
to_‰ì
));

1657 
	}
}

1663 
	sm∑ge_da_d©a
 {

1664 
öode
 *
	möode
;

1665 
wrôeback_c⁄åﬁ
 *
	mwbc
;

1667 
pgoff_t
 
	mfú°_∑ge
;

1668 
pgoff_t
 
	m√xt_∑ge
;

1669 
pgoff_t
 
	mœ°_∑ge
;

1675 
pxt4_m≠_blocks
 
	mm≠
;

1676 
pxt4_io_submô
 
	mio_submô
;

1677 
	mdo_m≠
:1;

1680 
	$m∑ge_ªÀa£_unu£d_∑ges
(
m∑ge_da_d©a
 *
mpd
,

1681 
boﬁ
 
övÆid©e
)

1683 
ƒ_∑ges
, 
i
;

1684 
pgoff_t
 
ödex
, 
íd
;

1685 
∑gevec
 
pvec
;

1686 
öode
 *öodê
mpd
->inode;

1687 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

1690 i‡(
mpd
->
fú°_∑ge
 >mpd->
√xt_∑ge
)

1693 
ödex
 = 
mpd
->
fú°_∑ge
;

1694 
íd
 = 
mpd
->
√xt_∑ge
 - 1;

1695 i‡(
övÆid©e
) {

1696 
pxt4_lblk_t
 
°¨t
, 
œ°
;

1697 
°¨t
 = 
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

1698 
œ°
 = 
íd
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

1699 
	`pxt4_es_ªmove_exã¡
(
öode
, 
°¨t
, 
œ°
 - start + 1);

1702 
	`∑gevec_öô
(&
pvec
);

1703 
ödex
 <
íd
) {

1704 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge
(&
pvec
, 
m≠pög
, &
ödex
, 
íd
);

1705 i‡(
ƒ_∑ges
 == 0)

1707 
i
 = 0; i < 
ƒ_∑ges
; i++) {

1708 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

1710 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

1711 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

1712 i‡(
övÆid©e
) {

1713 i‡(
	`∑ge_m≠≥d
(
∑ge
))

1714 
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
);

1715 
	`block_övÆid©ïage
(
∑ge
, 0, 
PAGE_SIZE
);

1716 
	`CÀ¨PageU±od©e
(
∑ge
);

1718 
	`u∆ock_∑ge
(
∑ge
);

1720 
	`∑gevec_ªÀa£
(&
pvec
);

1722 
	}
}

1724 
	$pxt4_¥öt_‰ì_blocks
(
öode
 *inode)

1726 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1727 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1728 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1730 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Total free blocks count %lld",

1731 
	`PXT4_C2B
(
	`PXT4_SB
(
öode
->
i_sb
),

1732 
	`pxt4_cou¡_‰ì_˛u°îs
(
sb
)));

1733 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Free/Dirty block details");

1734 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "free_blocks=%lld",

1735 (Ë
	`PXT4_C2B
(
	`PXT4_SB
(
sb
),

1736 
	`≥r˝u_cou¡î_sum
(&
sbi
->
s_‰ì˛u°îs_cou¡î
)));

1737 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "dirty_blocks=%lld",

1738 (Ë
	`PXT4_C2B
(
	`PXT4_SB
(
sb
),

1739 
	`≥r˝u_cou¡î_sum
(&
sbi
->
s_dúty˛u°îs_cou¡î
)));

1740 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "BlockÑeservation details");

1741 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "i_reserved_data_blocks=%u",

1742 
ei
->
i_ª£rved_d©a_blocks
);

1744 
	}
}

1746 
	$pxt4_bh_dñay_‹_unwrôãn
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1748  (
	`buf„r_dñay
(
bh
Ë|| 
	`buf„r_unwrôãn
(bh)Ë&& 
	`buf„r_dúty
(bh);

1749 
	}
}

1762 
	$pxt4_ö£π_dñayed_block
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1764 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1765 
ªt
;

1766 
boﬁ
 
Æloˇãd
 = 
Ál£
;

1779 i‡(
sbi
->
s_˛u°î_øtio
 == 1) {

1780 
ªt
 = 
	`pxt4_da_ª£rve_•a˚
(
öode
);

1781 i‡(
ªt
 != 0)

1782 
îrout
;

1784 i‡(!
	`pxt4_es_sˇn_˛u
(
öode
, &
pxt4_es_is_dñ⁄ly
, 
lblk
)) {

1785 i‡(!
	`pxt4_es_sˇn_˛u
(
öode
,

1786 &
pxt4_es_is_m≠≥d
, 
lblk
)) {

1787 
ªt
 = 
	`pxt4_˛u_m≠≥d
(
öode
,

1788 
	`PXT4_B2C
(
sbi
, 
lblk
));

1789 i‡(
ªt
 < 0)

1790 
îrout
;

1791 i‡(
ªt
 == 0) {

1792 
ªt
 = 
	`pxt4_da_ª£rve_•a˚
(
öode
);

1793 i‡(
ªt
 != 0)

1794 
îrout
;

1796 
Æloˇãd
 = 
åue
;

1799 
Æloˇãd
 = 
åue
;

1804 
ªt
 = 
	`pxt4_es_ö£π_dñayed_block
(
öode
, 
lblk
, 
Æloˇãd
);

1806 
îrout
:

1807  
ªt
;

1808 
	}
}

1816 
	$pxt4_da_m≠_blocks
(
öode
 *öode, 
£˘‹_t
 
iblock
,

1817 
pxt4_m≠_blocks
 *
m≠
,

1818 
buf„r_hód
 *
bh
)

1820 
exã¡_°©us
 
es
;

1821 
ªtvÆ
;

1822 
£˘‹_t
 
övÆid_block
 = ~((sector_t) 0xffff);

1823 #ifde‡
ES_AGGRESSIVE_TEST


1824 
pxt4_m≠_blocks
 
‹ig_m≠
;

1826 
	`mem˝y
(&
‹ig_m≠
, 
m≠
, (*map));

1829 i‡(
övÆid_block
 < 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
))

1830 
övÆid_block
 = ~0;

1832 
m≠
->
m_Êags
 = 0;

1833 
	`ext_debug
("pxt4_da_map_blocks(): inode %lu, max_blocks %u,"

1834 "logiˇ»block %lu\n", 
öode
->
i_öo
, 
m≠
->
m_Àn
,

1835 (Ë
m≠
->
m_lblk
);

1838 i‡(
	`pxt4_es_lookup_exã¡
(
öode
, 
iblock
, 
NULL
, &
es
)) {

1839 i‡(
	`pxt4_es_is_hﬁe
(&
es
)) {

1840 
ªtvÆ
 = 0;

1841 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1842 
add_dñayed
;

1849 i‡(
	`pxt4_es_is_dñayed
(&
es
Ë&& !
	`pxt4_es_is_unwrôãn
(&es)) {

1850 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
övÆid_block
);

1851 
	`£t_buf„r_√w
(
bh
);

1852 
	`£t_buf„r_dñay
(
bh
);

1856 
m≠
->
m_pblk
 = 
	`pxt4_es_pblock
(&
es
Ë+ 
iblock
 -És.
es_lblk
;

1857 
ªtvÆ
 = 
es
.
es_Àn
 - (
iblock
 -És.
es_lblk
);

1858 i‡(
ªtvÆ
 > 
m≠
->
m_Àn
)

1859 
ªtvÆ
 = 
m≠
->
m_Àn
;

1860 
m≠
->
m_Àn
 = 
ªtvÆ
;

1861 i‡(
	`pxt4_es_is_wrôãn
(&
es
))

1862 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

1863 i‡(
	`pxt4_es_is_unwrôãn
(&
es
))

1864 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

1866 
	`BUG
();

1868 #ifde‡
ES_AGGRESSIVE_TEST


1869 
	`pxt4_m≠_blocks_es_ªcheck
(
NULL
, 
öode
, 
m≠
, &
‹ig_m≠
, 0);

1871  
ªtvÆ
;

1878 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1879 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

1880 
ªtvÆ
 = 0;

1881 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

1882 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
NULL
, 
öode
, 
m≠
, 0);

1884 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
NULL
, 
öode
, 
m≠
, 0);

1886 
add_dñayed
:

1887 i‡(
ªtvÆ
 == 0) {

1888 
ªt
;

1895 
ªt
 = 
	`pxt4_ö£π_dñayed_block
(
öode
, 
m≠
->
m_lblk
);

1896 i‡(
ªt
 != 0) {

1897 
ªtvÆ
 = 
ªt
;

1898 
out_u∆ock
;

1901 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
övÆid_block
);

1902 
	`£t_buf„r_√w
(
bh
);

1903 
	`£t_buf„r_dñay
(
bh
);

1904 } i‡(
ªtvÆ
 > 0) {

1905 
ªt
;

1906 
°©us
;

1908 i‡(
	`u∆ikñy
(
ªtvÆ
 !
m≠
->
m_Àn
)) {

1909 
	`pxt4_w¨nög
(
öode
->
i_sb
,

1912 
öode
->
i_öo
, 
ªtvÆ
, 
m≠
->
m_Àn
);

1913 
	`WARN_ON
(1);

1916 
°©us
 = 
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
 ?

1917 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

1918 
ªt
 = 
	`pxt4_es_ö£π_exã¡
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
,

1919 
m≠
->
m_pblk
, 
°©us
);

1920 i‡(
ªt
 != 0)

1921 
ªtvÆ
 = 
ªt
;

1924 
out_u∆ock
:

1925 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

1927  
ªtvÆ
;

1928 
	}
}

1942 
	$pxt4_da_gë_block_¥ï
(
öode
 *öode, 
£˘‹_t
 
iblock
,

1943 
buf„r_hód
 *
bh
, 
¸óã
)

1945 
pxt4_m≠_blocks
 
m≠
;

1946 
ªt
 = 0;

1948 
	`BUG_ON
(
¸óã
 == 0);

1949 
	`BUG_ON
(
bh
->
b_size
 !
öode
->
i_sb
->
s_blocksize
);

1951 
m≠
.
m_lblk
 = 
iblock
;

1952 
m≠
.
m_Àn
 = 1;

1959 
ªt
 = 
	`pxt4_da_m≠_blocks
(
öode
, 
iblock
, &
m≠
, 
bh
);

1960 i‡(
ªt
 <= 0)

1961  
ªt
;

1963 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
m≠
.
m_pblk
);

1964 
	`pxt4_upd©e_bh_°©e
(
bh
, 
m≠
.
m_Êags
);

1966 i‡(
	`buf„r_unwrôãn
(
bh
)) {

1973 
	`£t_buf„r_√w
(
bh
);

1974 
	`£t_buf„r_m≠≥d
(
bh
);

1977 
	}
}

1979 
	$bgë_⁄e
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1981 
	`gë_bh
(
bh
);

1983 
	}
}

1985 
	$bput_⁄e
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1987 
	`put_bh
(
bh
);

1989 
	}
}

1991 
	$__pxt4_jou∫ÆÀd_wrôïage
(
∑ge
 *page,

1992 
Àn
)

1994 
addªss_•a˚
 *
m≠pög
 = 
∑ge
->mapping;

1995 
öode
 *öodê
m≠pög
->
ho°
;

1996 
buf„r_hód
 *
∑ge_bufs
 = 
NULL
;

1997 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

1998 
ªt
 = 0, 
îr
 = 0;

1999 
ölöe_d©a
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

2000 
buf„r_hód
 *
öode_bh
 = 
NULL
;

2002 
	`CÀ¨PageChecked
(
∑ge
);

2004 i‡(
ölöe_d©a
) {

2005 
	`BUG_ON
(
∑ge
->
ödex
 != 0);

2006 
	`BUG_ON
(
Àn
 > 
	`pxt4_gë_max_ölöe_size
(
öode
));

2007 
öode_bh
 = 
	`pxt4_jou∫ÆÀd_wrôe_ölöe_d©a
(
öode
, 
Àn
, 
∑ge
);

2008 i‡(
öode_bh
 =
NULL
)

2009 
out
;

2011 
∑ge_bufs
 = 
	`∑ge_buf„rs
(
∑ge
);

2012 i‡(!
∑ge_bufs
) {

2013 
	`BUG
();

2014 
out
;

2016 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
∑ge_bufs
, 0, 
Àn
,

2017 
NULL
, 
bgë_⁄e
);

2024 
	`gë_∑ge
(
∑ge
);

2025 
	`u∆ock_∑ge
(
∑ge
);

2027 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
,

2028 
	`pxt4_wrôïage_å™s_blocks
(
öode
));

2029 i‡(
	`IS_ERR
(
h™dÀ
)) {

2030 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

2031 
	`put_∑ge
(
∑ge
);

2032 
out_no_∑gñock
;

2034 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

2036 
	`lock_∑ge
(
∑ge
);

2037 
	`put_∑ge
(
∑ge
);

2038 i‡(
∑ge
->
m≠pög
 != mapping) {

2040 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2041 
ªt
 = 0;

2042 
out
;

2045 i‡(
ölöe_d©a
) {

2046 
ªt
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2048 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
∑ge_bufs
, 0, 
Àn
, 
NULL
,

2049 
do_jou∫Æ_gë_wrôe_ac˚ss
);

2051 
îr
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
∑ge_bufs
, 0, 
Àn
, 
NULL
,

2052 
wrôe_íd_‚
);

2054 i‡(
ªt
 == 0)

2055 
ªt
 = 
îr
;

2056 
	`PXT4_I
(
öode
)->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

2057 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2058 i‡(!
ªt
)

2059 
ªt
 = 
îr
;

2061 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
))

2062 
	`pxt4_wÆk_∑ge_buf„rs
(
NULL
, 
∑ge_bufs
, 0, 
Àn
,

2063 
NULL
, 
bput_⁄e
);

2064 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

2065 
out
:

2066 
	`u∆ock_∑ge
(
∑ge
);

2067 
out_no_∑gñock
:

2068 
	`bªl£
(
öode_bh
);

2069  
ªt
;

2070 
	}
}

2113 
	$pxt4_wrôïage
(
∑ge
 *page,

2114 
wrôeback_c⁄åﬁ
 *
wbc
)

2116 
ªt
 = 0;

2117 
loff_t
 
size
;

2118 
Àn
;

2119 
buf„r_hód
 *
∑ge_bufs
 = 
NULL
;

2120 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

2121 
pxt4_io_submô
 
io_submô
;

2122 
boﬁ
 
kìp_towrôe
 = 
Ál£
;

2124 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
)))) {

2125 
	`pxt4_övÆid©ïage
(
∑ge
, 0, 
PAGE_SIZE
);

2126 
	`u∆ock_∑ge
(
∑ge
);

2127  -
EIO
;

2130 
	`åa˚_pxt4_wrôïage
(
∑ge
);

2131 
size
 = 
	`i_size_ªad
(
öode
);

2132 i‡(
∑ge
->
ödex
 =
size
 >> 
PAGE_SHIFT
 &&

2133 !
	`pxt4_vîôy_ö_¥ogªss
(
öode
))

2134 
Àn
 = 
size
 & ~
PAGE_MASK
;

2136 
Àn
 = 
PAGE_SIZE
;

2138 
∑ge_bufs
 = 
	`∑ge_buf„rs
(
∑ge
);

2156 i‡(
	`pxt4_wÆk_∑ge_buf„rs
(
NULL
, 
∑ge_bufs
, 0, 
Àn
, NULL,

2157 
pxt4_bh_dñay_‹_unwrôãn
)) {

2158 
	`ªdúty_∑ge_f‹_wrôïage
(
wbc
, 
∑ge
);

2159 i‡((
cuºít
->
Êags
 & 
PF_MEMALLOC
) ||

2160 (
öode
->
i_sb
->
s_blocksize
 =
PAGE_SIZE
)) {

2166 
	`WARN_ON_ONCE
((
cuºít
->
Êags
 & (
PF_MEMALLOC
|
PF_KSWAPD
))

2167 =
PF_MEMALLOC
);

2168 
	`u∆ock_∑ge
(
∑ge
);

2171 
kìp_towrôe
 = 
åue
;

2174 i‡(
	`PageChecked
(
∑ge
Ë&& 
	`pxt4_should_jou∫Æ_d©a
(
öode
))

2179  
	`__pxt4_jou∫ÆÀd_wrôïage
(
∑ge
, 
Àn
);

2181 
	`pxt4_io_submô_öô
(&
io_submô
, 
wbc
);

2182 
io_submô
.
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_NOFS
);

2183 i‡(!
io_submô
.
io_íd
) {

2184 
	`ªdúty_∑ge_f‹_wrôïage
(
wbc
, 
∑ge
);

2185 
	`u∆ock_∑ge
(
∑ge
);

2186  -
ENOMEM
;

2188 
ªt
 = 
	`pxt4_bio_wrôe_∑ge
(&
io_submô
, 
∑ge
, 
Àn
, 
wbc
, 
kìp_towrôe
);

2189 
	`pxt4_io_submô
(&
io_submô
);

2191 
	`pxt4_put_io_íd_de„r
(
io_submô
.
io_íd
);

2192  
ªt
;

2193 
	}
}

2195 
	$m∑ge_submô_∑ge
(
m∑ge_da_d©a
 *
mpd
, 
∑ge
 *page)

2197 
Àn
;

2198 
loff_t
 
size
;

2199 
îr
;

2201 
	`BUG_ON
(
∑ge
->
ödex
 !
mpd
->
fú°_∑ge
);

2202 
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
);

2216 
size
 = 
	`i_size_ªad
(
mpd
->
öode
);

2217 i‡(
∑ge
->
ödex
 =
size
 >> 
PAGE_SHIFT
 &&

2218 !
	`pxt4_vîôy_ö_¥ogªss
(
mpd
->
öode
))

2219 
Àn
 = 
size
 & ~
PAGE_MASK
;

2221 
Àn
 = 
PAGE_SIZE
;

2222 
îr
 = 
	`pxt4_bio_wrôe_∑ge
(&
mpd
->
io_submô
, 
∑ge
, 
Àn
, mpd->
wbc
, 
Ál£
);

2223 i‡(!
îr
)

2224 
mpd
->
wbc
->
ƒ_to_wrôe
--;

2225 
mpd
->
fú°_∑ge
++;

2227  
îr
;

2228 
	}
}

2230 
	#BH_FLAGS
 ((1 << 
BH_Unwrôãn
Ë| (1 << 
BH_Dñay
))

	)

2237 
	#MAX_WRITEPAGES_EXTENT_LEN
 2048

	)

2253 
boﬁ
 
	$m∑ge_add_bh_to_exã¡
(
m∑ge_da_d©a
 *
mpd
, 
pxt4_lblk_t
 
lblk
,

2254 
buf„r_hód
 *
bh
)

2256 
pxt4_m≠_blocks
 *
m≠
 = &
mpd
->map;

2259 i‡(!
	`buf„r_dúty
(
bh
Ë|| !
	`buf„r_m≠≥d
(bh) ||

2260 (!
	`buf„r_dñay
(
bh
Ë&& !
	`buf„r_unwrôãn
(bh))) {

2262 i‡(
m≠
->
m_Àn
 == 0)

2263  
åue
;

2264  
Ál£
;

2268 i‡(
m≠
->
m_Àn
 == 0) {

2270 i‡(!
mpd
->
do_m≠
)

2271  
Ál£
;

2272 
m≠
->
m_lblk
 = 
lblk
;

2273 
m≠
->
m_Àn
 = 1;

2274 
m≠
->
m_Êags
 = 
bh
->
b_°©e
 & 
BH_FLAGS
;

2275  
åue
;

2279 i‡(
m≠
->
m_Àn
 >
MAX_WRITEPAGES_EXTENT_LEN
)

2280  
Ál£
;

2283 i‡(
lblk
 =
m≠
->
m_lblk
 + m≠->
m_Àn
 &&

2284 (
bh
->
b_°©e
 & 
BH_FLAGS
Ë=
m≠
->
m_Êags
) {

2285 
m≠
->
m_Àn
++;

2286  
åue
;

2288  
Ál£
;

2289 
	}
}

2307 
	$m∑ge_¥o˚ss_∑ge_bufs
(
m∑ge_da_d©a
 *
mpd
,

2308 
buf„r_hód
 *
hód
,

2309 
buf„r_hód
 *
bh
,

2310 
pxt4_lblk_t
 
lblk
)

2312 
öode
 *öodê
mpd
->inode;

2313 
îr
;

2314 
pxt4_lblk_t
 
blocks
 = (
	`i_size_ªad
(
öode
Ë+ 
	`i_blocksize
(inode) - 1)

2315 >> 
öode
->
i_blkbôs
;

2317 i‡(
	`pxt4_vîôy_ö_¥ogªss
(
öode
))

2318 
blocks
 = 
EXT_MAX_BLOCKS
;

2321 
	`BUG_ON
(
	`buf„r_locked
(
bh
));

2323 i‡(
lblk
 >
blocks
 || !
	`m∑ge_add_bh_to_exã¡
(
mpd
,Üblk, 
bh
)) {

2325 i‡(
mpd
->
m≠
.
m_Àn
)

2328 i‡(!
mpd
->
do_m≠
)

2333 } 
lblk
++, (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

2335 i‡(
mpd
->
m≠
.
m_Àn
 == 0) {

2336 
îr
 = 
	`m∑ge_submô_∑ge
(
mpd
, 
hód
->
b_∑ge
);

2337 i‡(
îr
 < 0)

2338  
îr
;

2340  
lblk
 < 
blocks
;

2341 
	}
}

2357 
	$m∑ge_m≠_™d_submô_buf„rs
(
m∑ge_da_d©a
 *
mpd
)

2359 
∑gevec
 
pvec
;

2360 
ƒ_∑ges
, 
i
;

2361 
öode
 *öodê
mpd
->inode;

2362 
buf„r_hód
 *
hód
, *
bh
;

2363 
bµ_bôs
 = 
PAGE_SHIFT
 - 
öode
->
i_blkbôs
;

2364 
pgoff_t
 
°¨t
, 
íd
;

2365 
pxt4_lblk_t
 
lblk
;

2366 
£˘‹_t
 
pblock
;

2367 
îr
;

2369 
°¨t
 = 
mpd
->
m≠
.
m_lblk
 >> 
bµ_bôs
;

2370 
íd
 = (
mpd
->
m≠
.
m_lblk
 + mpd->m≠.
m_Àn
 - 1Ë>> 
bµ_bôs
;

2371 
lblk
 = 
°¨t
 << 
bµ_bôs
;

2372 
pblock
 = 
mpd
->
m≠
.
m_pblk
;

2374 
	`∑gevec_öô
(&
pvec
);

2375 
°¨t
 <
íd
) {

2376 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge
(&
pvec
, 
öode
->
i_m≠pög
,

2377 &
°¨t
, 
íd
);

2378 i‡(
ƒ_∑ges
 == 0)

2380 
i
 = 0; i < 
ƒ_∑ges
; i++) {

2381 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

2383 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

2385 i‡(
lblk
 < 
mpd
->
m≠
.
m_lblk
)

2387 i‡(
lblk
 >
mpd
->
m≠
.
m_lblk
 + mpd->m≠.
m_Àn
) {

2392 
mpd
->
m≠
.
m_Àn
 = 0;

2393 
mpd
->
m≠
.
m_Êags
 = 0;

2401 
îr
 = 
	`m∑ge_¥o˚ss_∑ge_bufs
(
mpd
, 
hód
,

2402 
bh
, 
lblk
);

2403 
	`∑gevec_ªÀa£
(&
pvec
);

2404 i‡(
îr
 > 0)

2405 
îr
 = 0;

2406  
îr
;

2408 i‡(
	`buf„r_dñay
(
bh
)) {

2409 
	`˛ór_buf„r_dñay
(
bh
);

2410 
bh
->
b_blockƒ
 = 
pblock
++;

2412 
	`˛ór_buf„r_unwrôãn
(
bh
);

2413 } 
lblk
++, (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

2420 
mpd
->
io_submô
.
io_íd
->
size
 +
PAGE_SIZE
;

2422 
îr
 = 
	`m∑ge_submô_∑ge
(
mpd
, 
∑ge
);

2423 i‡(
îr
 < 0) {

2424 
	`∑gevec_ªÀa£
(&
pvec
);

2425  
îr
;

2428 
	`∑gevec_ªÀa£
(&
pvec
);

2431 
mpd
->
m≠
.
m_Àn
 = 0;

2432 
mpd
->
m≠
.
m_Êags
 = 0;

2434 
	}
}

2436 
	$m∑ge_m≠_⁄e_exã¡
(
h™dÀ_t
 *
h™dÀ
, 
m∑ge_da_d©a
 *
mpd
)

2438 
öode
 *öodê
mpd
->inode;

2439 
pxt4_m≠_blocks
 *
m≠
 = &
mpd
->map;

2440 
gë_blocks_Êags
;

2441 
îr
, 
di‹ód_nﬁock
;

2443 
	`åa˚_pxt4_da_wrôe_∑ges_exã¡
(
öode
, 
m≠
);

2459 
gë_blocks_Êags
 = 
PXT4_GET_BLOCKS_CREATE
 |

2460 
PXT4_GET_BLOCKS_METADATA_NOFAIL
 |

2461 
PXT4_GET_BLOCKS_IO_SUBMIT
;

2462 
di‹ód_nﬁock
 = 
	`pxt4_should_di‹ód_nﬁock
(
öode
);

2463 i‡(
di‹ód_nﬁock
)

2464 
gë_blocks_Êags
 |
PXT4_GET_BLOCKS_IO_CREATE_EXT
;

2465 i‡(
m≠
->
m_Êags
 & (1 << 
BH_Dñay
))

2466 
gë_blocks_Êags
 |
PXT4_GET_BLOCKS_DELALLOC_RESERVE
;

2468 
îr
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
gë_blocks_Êags
);

2469 i‡(
îr
 < 0)

2470  
îr
;

2471 i‡(
di‹ód_nﬁock
 && (
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
)) {

2472 i‡(!
mpd
->
io_submô
.
io_íd
->
h™dÀ
 &&

2473 
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

2474 
mpd
->
io_submô
.
io_íd
->
h™dÀ
 = h™dÀ->
h_rsv_h™dÀ
;

2475 
h™dÀ
->
h_rsv_h™dÀ
 = 
NULL
;

2477 
	`pxt4_£t_io_unwrôãn_Êag
(
öode
, 
mpd
->
io_submô
.
io_íd
);

2480 
	`BUG_ON
(
m≠
->
m_Àn
 == 0);

2482 
	}
}

2504 
	$m∑ge_m≠_™d_submô_exã¡
(
h™dÀ_t
 *
h™dÀ
,

2505 
m∑ge_da_d©a
 *
mpd
,

2506 
boﬁ
 *
give_up_⁄_wrôe
)

2508 
öode
 *öodê
mpd
->inode;

2509 
pxt4_m≠_blocks
 *
m≠
 = &
mpd
->map;

2510 
îr
;

2511 
loff_t
 
disksize
;

2512 
¥ogªss
 = 0;

2514 
mpd
->
io_submô
.
io_íd
->
off£t
 =

2515 ((
loff_t
)
m≠
->
m_lblk
Ë<< 
öode
->
i_blkbôs
;

2517 
îr
 = 
	`m∑ge_m≠_⁄e_exã¡
(
h™dÀ
, 
mpd
);

2518 i‡(
îr
 < 0) {

2519 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

2521 i‡(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
)) ||

2522 
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)

2523 
övÆid©e_dúty_∑ges
;

2529 i‡((
îr
 =-
ENOMEM
) ||

2530 (
îr
 =-
ENOSPC
 && 
	`pxt4_cou¡_‰ì_˛u°îs
(
sb
))) {

2531 i‡(
¥ogªss
)

2532 
upd©e_disksize
;

2533  
îr
;

2535 
	`pxt4_msg
(
sb
, 
KERN_CRIT
,

2539 
öode
->
i_öo
,

2540 ()
m≠
->
m_lblk
,

2541 ()
m≠
->
m_Àn
, -
îr
);

2542 
	`pxt4_msg
(
sb
, 
KERN_CRIT
,

2545 i‡(
îr
 =-
ENOSPC
)

2546 
	`pxt4_¥öt_‰ì_blocks
(
öode
);

2547 
övÆid©e_dúty_∑ges
:

2548 *
give_up_⁄_wrôe
 = 
åue
;

2549  
îr
;

2551 
¥ogªss
 = 1;

2556 
îr
 = 
	`m∑ge_m≠_™d_submô_buf„rs
(
mpd
);

2557 i‡(
îr
 < 0)

2558 
upd©e_disksize
;

2559 } 
m≠
->
m_Àn
);

2561 
upd©e_disksize
:

2566 
disksize
 = ((
loff_t
)
mpd
->
fú°_∑ge
Ë<< 
PAGE_SHIFT
;

2567 i‡(
disksize
 > 
	`PXT4_I
(
öode
)->
i_disksize
) {

2568 
îr2
;

2569 
loff_t
 
i_size
;

2571 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2572 
i_size
 = 
	`i_size_ªad
(
öode
);

2573 i‡(
disksize
 > 
i_size
)

2574 
disksize
 = 
i_size
;

2575 i‡(
disksize
 > 
	`PXT4_I
(
öode
)->
i_disksize
)

2576 
	`PXT4_I
(
öode
)->
i_disksize
 = 
disksize
;

2577 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2578 
îr2
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2579 i‡(
îr2
)

2580 
	`pxt4_îr‹
(
öode
->
i_sb
,

2582 
öode
->
i_öo
);

2583 i‡(!
îr
)

2584 
îr
 = 
îr2
;

2586  
îr
;

2587 
	}
}

2596 
	$pxt4_da_wrôïages_å™s_blocks
(
öode
 *inode)

2598 
bµ
 = 
	`pxt4_jou∫Æ_blocks_≥r_∑ge
(
öode
);

2600  
	`pxt4_mëa_å™s_blocks
(
öode
,

2601 
MAX_WRITEPAGES_EXTENT_LEN
 + 
bµ
 - 1, bpp);

2602 
	}
}

2622 
	$m∑ge_¥ï¨e_exã¡_to_m≠
(
m∑ge_da_d©a
 *
mpd
)

2624 
addªss_•a˚
 *
m≠pög
 = 
mpd
->
öode
->
i_m≠pög
;

2625 
∑gevec
 
pvec
;

2626 
ƒ_∑ges
;

2627 
À·
 = 
mpd
->
wbc
->
ƒ_to_wrôe
;

2628 
pgoff_t
 
ödex
 = 
mpd
->
fú°_∑ge
;

2629 
pgoff_t
 
íd
 = 
mpd
->
œ°_∑ge
;

2630 
xa_m¨k_t
 
èg
;

2631 
i
, 
îr
 = 0;

2632 
blkbôs
 = 
mpd
->
öode
->
i_blkbôs
;

2633 
pxt4_lblk_t
 
lblk
;

2634 
buf„r_hód
 *
hód
;

2636 i‡(
mpd
->
wbc
->
sync_mode
 =
WB_SYNC_ALL
 || mpd->wbc->
ègged_wrôïages
)

2637 
èg
 = 
PAGECACHE_TAG_TOWRITE
;

2639 
èg
 = 
PAGECACHE_TAG_DIRTY
;

2641 
	`∑gevec_öô
(&
pvec
);

2642 
mpd
->
m≠
.
m_Àn
 = 0;

2643 
mpd
->
√xt_∑ge
 = 
ödex
;

2644 
ödex
 <
íd
) {

2645 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge_èg
(&
pvec
, 
m≠pög
, &
ödex
, 
íd
,

2646 
èg
);

2647 i‡(
ƒ_∑ges
 == 0)

2648 
out
;

2650 
i
 = 0; i < 
ƒ_∑ges
; i++) {

2651 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

2661 i‡(
mpd
->
wbc
->
sync_mode
 =
WB_SYNC_NONE
 && 
À·
 <= 0)

2662 
out
;

2665 i‡(
mpd
->
m≠
.
m_Àn
 > 0 && mpd->
√xt_∑ge
 !
∑ge
->
ödex
)

2666 
out
;

2668 
	`lock_∑ge
(
∑ge
);

2676 i‡(!
	`PageDúty
(
∑ge
) ||

2677 (
	`PageWrôeback
(
∑ge
) &&

2678 (
mpd
->
wbc
->
sync_mode
 =
WB_SYNC_NONE
)) ||

2679 
	`u∆ikñy
(
∑ge
->
m≠pög
 != mapping)) {

2680 
	`u∆ock_∑ge
(
∑ge
);

2684 
	`waô_⁄_∑ge_wrôeback
(
∑ge
);

2685 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

2687 i‡(
mpd
->
m≠
.
m_Àn
 == 0)

2688 
mpd
->
fú°_∑ge
 = 
∑ge
->
ödex
;

2689 
mpd
->
√xt_∑ge
 = 
∑ge
->
ödex
 + 1;

2691 
lblk
 = ((
pxt4_lblk_t
)
∑ge
->
ödex
) <<

2692 (
PAGE_SHIFT
 - 
blkbôs
);

2693 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

2694 
îr
 = 
	`m∑ge_¥o˚ss_∑ge_bufs
(
mpd
, 
hód
, hód, 
lblk
);

2695 i‡(
îr
 <= 0)

2696 
out
;

2697 
îr
 = 0;

2698 
À·
--;

2700 
	`∑gevec_ªÀa£
(&
pvec
);

2701 
	`c⁄d_ªsched
();

2704 
out
:

2705 
	`∑gevec_ªÀa£
(&
pvec
);

2706  
îr
;

2707 
	}
}

2709 
	$pxt4_wrôïages
(
addªss_•a˚
 *
m≠pög
,

2710 
wrôeback_c⁄åﬁ
 *
wbc
)

2712 
pgoff_t
 
wrôeback_ödex
 = 0;

2713 
ƒ_to_wrôe
 = 
wbc
->nr_to_write;

2714 
ønge_whﬁe
 = 0;

2715 
cy˛ed
 = 1;

2716 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

2717 
m∑ge_da_d©a
 
mpd
;

2718 
öode
 *öodê
m≠pög
->
ho°
;

2719 
√eded_blocks
, 
rsv_blocks
 = 0, 
ªt
 = 0;

2720 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
m≠pög
->
ho°
->
i_sb
);

2721 
boﬁ
 
d⁄e
;

2722 
blk_∂ug
 
∂ug
;

2723 
boﬁ
 
give_up_⁄_wrôe
 = 
Ál£
;

2725 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

2726  -
EIO
;

2728 
	`≥r˝u_down_ªad
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

2729 
	`åa˚_pxt4_wrôïages
(
öode
, 
wbc
);

2736 i‡(!
m≠pög
->
ƒ∑ges
 || !
	`m≠pög_ègged
(m≠pög, 
PAGECACHE_TAG_DIRTY
))

2737 
out_wrôïages
;

2739 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

2740 
ªt
 = 
	`gíîic_wrôïages
(
m≠pög
, 
wbc
);

2741 
out_wrôïages
;

2754 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
m≠pög
->
ho°
->
i_sb
)) ||

2755 
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)) {

2756 
ªt
 = -
EROFS
;

2757 
out_wrôïages
;

2765 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

2767 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

2768 i‡(
	`IS_ERR
(
h™dÀ
)) {

2769 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

2770 
out_wrôïages
;

2772 
	`BUG_ON
(
	`pxt4_ã°_öode_°©e
(
öode
,

2773 
PXT4_STATE_MAY_INLINE_DATA
));

2774 
	`pxt4_de°roy_ölöe_d©a
(
h™dÀ
, 
öode
);

2775 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2778 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
)) {

2783 
rsv_blocks
 = 1 + 
	`pxt4_chunk_å™s_blocks
(
öode
,

2784 
PAGE_SIZE
 >> 
öode
->
i_blkbôs
);

2787 i‡(
wbc
->
ønge_°¨t
 =0 && wbc->
ønge_íd
 =
LLONG_MAX
)

2788 
ønge_whﬁe
 = 1;

2790 i‡(
wbc
->
ønge_cy˛ic
) {

2791 
wrôeback_ödex
 = 
m≠pög
->writeback_index;

2792 i‡(
wrôeback_ödex
)

2793 
cy˛ed
 = 0;

2794 
mpd
.
fú°_∑ge
 = 
wrôeback_ödex
;

2795 
mpd
.
œ°_∑ge
 = -1;

2797 
mpd
.
fú°_∑ge
 = 
wbc
->
ønge_°¨t
 >> 
PAGE_SHIFT
;

2798 
mpd
.
œ°_∑ge
 = 
wbc
->
ønge_íd
 >> 
PAGE_SHIFT
;

2801 
mpd
.
öode
 = inode;

2802 
mpd
.
wbc
 = wbc;

2803 
	`pxt4_io_submô_öô
(&
mpd
.
io_submô
, 
wbc
);

2804 
ªåy
:

2805 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
 || wbc->
ègged_wrôïages
)

2806 
	`èg_∑ges_f‹_wrôeback
(
m≠pög
, 
mpd
.
fú°_∑ge
, mpd.
œ°_∑ge
);

2807 
d⁄e
 = 
Ál£
;

2808 
	`blk_°¨t_∂ug
(&
∂ug
);

2816 
mpd
.
do_m≠
 = 0;

2817 
mpd
.
io_submô
.
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_KERNEL
);

2818 i‡(!
mpd
.
io_submô
.
io_íd
) {

2819 
ªt
 = -
ENOMEM
;

2820 
u≈lug
;

2822 
ªt
 = 
	`m∑ge_¥ï¨e_exã¡_to_m≠
(&
mpd
);

2824 
	`m∑ge_ªÀa£_unu£d_∑ges
(&
mpd
, 
Ál£
);

2826 
	`pxt4_io_submô
(&
mpd
.
io_submô
);

2827 
	`pxt4_put_io_íd_de„r
(
mpd
.
io_submô
.
io_íd
);

2828 
mpd
.
io_submô
.
io_íd
 = 
NULL
;

2829 i‡(
ªt
 < 0)

2830 
u≈lug
;

2832 !
d⁄e
 && 
mpd
.
fú°_∑ge
 <mpd.
œ°_∑ge
) {

2834 
mpd
.
io_submô
.
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_KERNEL
);

2835 i‡(!
mpd
.
io_submô
.
io_íd
) {

2836 
ªt
 = -
ENOMEM
;

2847 
	`BUG_ON
(
	`pxt4_should_jou∫Æ_d©a
(
öode
));

2848 
√eded_blocks
 = 
	`pxt4_da_wrôïages_å™s_blocks
(
öode
);

2851 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_wôh_ª£rve
(
öode
,

2852 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
, 
rsv_blocks
);

2853 i‡(
	`IS_ERR
(
h™dÀ
)) {

2854 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

2855 
	`pxt4_msg
(
öode
->
i_sb
, 
KERN_CRIT
, "%s: jbd3_start: "

2856 "%ldÖages, inÿ%lu;Éº %d", 
__func__
,

2857 
wbc
->
ƒ_to_wrôe
, 
öode
->
i_öo
, 
ªt
);

2859 
	`pxt4_put_io_íd
(
mpd
.
io_submô
.
io_íd
);

2860 
mpd
.
io_submô
.
io_íd
 = 
NULL
;

2863 
mpd
.
do_m≠
 = 1;

2865 
	`åa˚_pxt4_da_wrôe_∑ges
(
öode
, 
mpd
.
fú°_∑ge
, mpd.
wbc
);

2866 
ªt
 = 
	`m∑ge_¥ï¨e_exã¡_to_m≠
(&
mpd
);

2867 i‡(!
ªt
) {

2868 i‡(
mpd
.
m≠
.
m_Àn
)

2869 
ªt
 = 
	`m∑ge_m≠_™d_submô_exã¡
(
h™dÀ
, &
mpd
,

2870 &
give_up_⁄_wrôe
);

2878 
d⁄e
 = 
åue
;

2891 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë|| h™dÀ->
h_sync
 == 0) {

2892 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2893 
h™dÀ
 = 
NULL
;

2894 
mpd
.
do_m≠
 = 0;

2897 
	`m∑ge_ªÀa£_unu£d_∑ges
(&
mpd
, 
give_up_⁄_wrôe
);

2899 
	`pxt4_io_submô
(&
mpd
.
io_submô
);

2908 i‡(
h™dÀ
) {

2909 
	`pxt4_put_io_íd_de„r
(
mpd
.
io_submô
.
io_íd
);

2910 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2912 
	`pxt4_put_io_íd
(
mpd
.
io_submô
.
io_íd
);

2913 
mpd
.
io_submô
.
io_íd
 = 
NULL
;

2915 i‡(
ªt
 =-
ENOSPC
 && 
sbi
->
s_jou∫Æ
) {

2921 
	`jbd3_jou∫Æ_f‹˚_commô_√°ed
(
sbi
->
s_jou∫Æ
);

2922 
ªt
 = 0;

2926 i‡(
ªt
)

2929 
u≈lug
:

2930 
	`blk_föish_∂ug
(&
∂ug
);

2931 i‡(!
ªt
 && !
cy˛ed
 && 
wbc
->
ƒ_to_wrôe
 > 0) {

2932 
cy˛ed
 = 1;

2933 
mpd
.
œ°_∑ge
 = 
wrôeback_ödex
 - 1;

2934 
mpd
.
fú°_∑ge
 = 0;

2935 
ªåy
;

2939 i‡(
wbc
->
ønge_cy˛ic
 || (
ønge_whﬁe
 && wbc->
ƒ_to_wrôe
 > 0))

2944 
m≠pög
->
wrôeback_ödex
 = 
mpd
.
fú°_∑ge
;

2946 
out_wrôïages
:

2947 
	`åa˚_pxt4_wrôïages_ªsu…
(
öode
, 
wbc
, 
ªt
,

2948 
ƒ_to_wrôe
 - 
wbc
->nr_to_write);

2949 
	`≥r˝u_up_ªad
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

2950  
ªt
;

2951 
	}
}

2953 
	$pxt4_dax_wrôïages
(
addªss_•a˚
 *
m≠pög
,

2954 
wrôeback_c⁄åﬁ
 *
wbc
)

2956 
ªt
;

2957 
ƒ_to_wrôe
 = 
wbc
->nr_to_write;

2958 
öode
 *öodê
m≠pög
->
ho°
;

2959 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
m≠pög
->
ho°
->
i_sb
);

2961 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

2962  -
EIO
;

2964 
	`≥r˝u_down_ªad
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

2965 
	`åa˚_pxt4_wrôïages
(
öode
, 
wbc
);

2967 
ªt
 = 
	`dax_wrôeback_m≠pög_ønge
(
m≠pög
, 
öode
->
i_sb
->
s_bdev
, 
wbc
);

2968 
	`åa˚_pxt4_wrôïages_ªsu…
(
öode
, 
wbc
, 
ªt
,

2969 
ƒ_to_wrôe
 - 
wbc
->nr_to_write);

2970 
	`≥r˝u_up_ªad
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

2971  
ªt
;

2972 
	}
}

2974 
	$pxt4_n⁄da_swôch
(
su≥r_block
 *
sb
)

2976 
s64
 
‰ì_˛u°îs
, 
dúty_˛u°îs
;

2977 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2987 
‰ì_˛u°îs
 =

2988 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_‰ì˛u°îs_cou¡î
);

2989 
dúty_˛u°îs
 =

2990 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

2994 i‡(
dúty_˛u°îs
 && (
‰ì_˛u°îs
 < 2 * dirty_clusters))

2995 
	`åy_to_wrôeback_öodes_sb
(
sb
, 
WB_REASON_FS_FREE_SPACE
);

2997 i‡(2 * 
‰ì_˛u°îs
 < 3 * 
dúty_˛u°îs
 ||

2998 
‰ì_˛u°îs
 < (
dúty_˛u°îs
 + 
PXT4_FREECLUSTERS_WATERMARK
)) {

3006 
	}
}

3009 
	$pxt4_da_wrôe_¸edôs
(
öode
 *öode, 
loff_t
 
pos
, 
Àn
)

3011 i‡(
	`likñy
(
	`pxt4_has_„©uª_œrge_fûe
(
öode
->
i_sb
)))

3014 i‡(
pos
 + 
Àn
 <= 0x7fffffffULL)

3019 
	}
}

3021 
	$pxt4_da_wrôe_begö
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

3022 
loff_t
 
pos
, 
Àn
, 
Êags
,

3023 
∑ge
 **
∑gï
, **
fsd©a
)

3025 
ªt
, 
ªåõs
 = 0;

3026 
∑ge
 *page;

3027 
pgoff_t
 
ödex
;

3028 
öode
 *öodê
m≠pög
->
ho°
;

3029 
h™dÀ_t
 *
h™dÀ
;

3031 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

3032  -
EIO
;

3034 
ödex
 = 
pos
 >> 
PAGE_SHIFT
;

3036 i‡(
	`pxt4_n⁄da_swôch
(
öode
->
i_sb
Ë|| 
	`S_ISLNK
(öode->
i_mode
) ||

3037 
	`pxt4_vîôy_ö_¥ogªss
(
öode
)) {

3038 *
fsd©a
 = (*)
FALL_BACK_TO_NONDELALLOC
;

3039  
	`pxt4_wrôe_begö
(
fûe
, 
m≠pög
, 
pos
,

3040 
Àn
, 
Êags
, 
∑gï
, 
fsd©a
);

3042 *
fsd©a
 = (*)0;

3043 
	`åa˚_pxt4_da_wrôe_begö
(
öode
, 
pos
, 
Àn
, 
Êags
);

3045 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
)) {

3046 
ªt
 = 
	`pxt4_da_wrôe_ölöe_d©a_begö
(
m≠pög
, 
öode
,

3047 
pos
, 
Àn
, 
Êags
,

3048 
∑gï
, 
fsd©a
);

3049 i‡(
ªt
 < 0)

3050  
ªt
;

3051 i‡(
ªt
 == 1)

3062 
ªåy_gøb
:

3063 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 
ödex
, 
Êags
);

3064 i‡(!
∑ge
)

3065  -
ENOMEM
;

3066 
	`u∆ock_∑ge
(
∑ge
);

3074 
ªåy_jou∫Æ
:

3075 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
,

3076 
	`pxt4_da_wrôe_¸edôs
(
öode
, 
pos
, 
Àn
));

3077 i‡(
	`IS_ERR
(
h™dÀ
)) {

3078 
	`put_∑ge
(
∑ge
);

3079  
	`PTR_ERR
(
h™dÀ
);

3082 
	`lock_∑ge
(
∑ge
);

3083 i‡(
∑ge
->
m≠pög
 != mapping) {

3085 
	`u∆ock_∑ge
(
∑ge
);

3086 
	`put_∑ge
(
∑ge
);

3087 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3088 
ªåy_gøb
;

3091 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

3093 #ifde‡
CONFIG_FS_ENCRYPTION


3094 
ªt
 = 
	`pxt4_block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

3095 
pxt4_da_gë_block_¥ï
);

3097 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
, 
pxt4_da_gë_block_¥ï
);

3099 i‡(
ªt
 < 0) {

3100 
	`u∆ock_∑ge
(
∑ge
);

3101 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3107 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
)

3108 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

3110 i‡(
ªt
 =-
ENOSPC
 &&

3111 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

3112 
ªåy_jou∫Æ
;

3114 
	`put_∑ge
(
∑ge
);

3115  
ªt
;

3118 *
∑gï
 = 
∑ge
;

3119  
ªt
;

3120 
	}
}

3126 
	$pxt4_da_should_upd©e_i_disksize
(
∑ge
 *page,

3127 
off£t
)

3129 
buf„r_hód
 *
bh
;

3130 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

3131 
idx
;

3132 
i
;

3134 
bh
 = 
	`∑ge_buf„rs
(
∑ge
);

3135 
idx
 = 
off£t
 >> 
öode
->
i_blkbôs
;

3137 
i
 = 0; i < 
idx
; i++)

3138 
bh
 = bh->
b_this_∑ge
;

3140 i‡(!
	`buf„r_m≠≥d
(
bh
Ë|| (
	`buf„r_dñay
(bh)Ë|| 
	`buf„r_unwrôãn
(bh))

3143 
	}
}

3145 
	$pxt4_da_wrôe_íd
(
fûe
 *file,

3146 
addªss_•a˚
 *
m≠pög
,

3147 
loff_t
 
pos
, 
Àn
, 
c›õd
,

3148 
∑ge
 *∑ge, *
fsd©a
)

3150 
öode
 *öodê
m≠pög
->
ho°
;

3151 
ªt
 = 0, 
ªt2
;

3152 
h™dÀ_t
 *
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

3153 
loff_t
 
√w_i_size
;

3154 
°¨t
, 
íd
;

3155 
wrôe_mode
 = ()()
fsd©a
;

3157 i‡(
wrôe_mode
 =
FALL_BACK_TO_NONDELALLOC
)

3158  
	`pxt4_wrôe_íd
(
fûe
, 
m≠pög
, 
pos
,

3159 
Àn
, 
c›õd
, 
∑ge
, 
fsd©a
);

3161 
	`åa˚_pxt4_da_wrôe_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
);

3162 
°¨t
 = 
pos
 & (
PAGE_SIZE
 - 1);

3163 
íd
 = 
°¨t
 + 
c›õd
 - 1;

3170 
√w_i_size
 = 
pos
 + 
c›õd
;

3171 i‡(
c›õd
 && 
√w_i_size
 > 
	`PXT4_I
(
öode
)->
i_disksize
) {

3172 i‡(
	`pxt4_has_ölöe_d©a
(
öode
) ||

3173 
	`pxt4_da_should_upd©e_i_disksize
(
∑ge
, 
íd
)) {

3174 
	`pxt4_upd©e_i_disksize
(
öode
, 
√w_i_size
);

3179 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3183 i‡(
wrôe_mode
 !
CONVERT_INLINE_DATA
 &&

3184 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
) &&

3185 
	`pxt4_has_ölöe_d©a
(
öode
))

3186 
ªt2
 = 
	`pxt4_da_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
,

3187 
∑ge
);

3189 
ªt2
 = 
	`gíîic_wrôe_íd
(
fûe
, 
m≠pög
, 
pos
, 
Àn
, 
c›õd
,

3190 
∑ge
, 
fsd©a
);

3192 
c›õd
 = 
ªt2
;

3193 i‡(
ªt2
 < 0)

3194 
ªt
 = 
ªt2
;

3195 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3196 i‡(!
ªt
)

3197 
ªt
 = 
ªt2
;

3199  
ªt
 ?Ñë : 
c›õd
;

3200 
	}
}

3205 
	$pxt4_Æloc_da_blocks
(
öode
 *inode)

3207 
	`åa˚_pxt4_Æloc_da_blocks
(
öode
);

3209 i‡(!
	`PXT4_I
(
öode
)->
i_ª£rved_d©a_blocks
)

3243  
	`fûem≠_Êush
(
öode
->
i_m≠pög
);

3244 
	}
}

3260 
£˘‹_t
 
	$pxt4_bm≠
(
addªss_•a˚
 *
m≠pög
, 
£˘‹_t
 
block
)

3262 
öode
 *öodê
m≠pög
->
ho°
;

3263 
jou∫Æ_t
 *
jou∫Æ
;

3264 
îr
;

3269 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3272 i‡(
	`m≠pög_ègged
(
m≠pög
, 
PAGECACHE_TAG_DIRTY
) &&

3273 
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
)) {

3279 
	`fûem≠_wrôe_™d_waô
(
m≠pög
);

3282 i‡(
	`PXT4_JOURNAL
(
öode
) &&

3283 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
)) {

3302 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

3303 
jou∫Æ
 = 
	`PXT4_JOURNAL
(
öode
);

3304 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

3305 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

3306 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

3308 i‡(
îr
)

3312  
	`gíîic_block_bm≠
(
m≠pög
, 
block
, 
pxt4_gë_block
);

3313 
	}
}

3315 
	$pxt4_ªad∑ge
(
fûe
 *fûe, 
∑ge
 *page)

3317 
ªt
 = -
EAGAIN
;

3318 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

3320 
	`åa˚_pxt4_ªad∑ge
(
∑ge
);

3322 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3323 
ªt
 = 
	`pxt4_ªad∑ge_ölöe
(
öode
, 
∑ge
);

3325 i‡(
ªt
 =-
EAGAIN
)

3326  
	`pxt4_m∑ge_ªad∑ges
(
∑ge
->
m≠pög
, 
NULL
,Öage, 1,

3327 
Ál£
);

3329  
ªt
;

3330 
	}
}

3333 
	$pxt4_ªad∑ges
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

3334 
li°_hód
 *
∑ges
, 
ƒ_∑ges
)

3336 
öode
 *öodê
m≠pög
->
ho°
;

3339 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3342  
	`pxt4_m∑ge_ªad∑ges
(
m≠pög
, 
∑ges
, 
NULL
, 
ƒ_∑ges
, 
åue
);

3343 
	}
}

3345 
	$pxt4_övÆid©ïage
(
∑ge
 *∑ge, 
off£t
,

3346 
Àngth
)

3348 
	`åa˚_pxt4_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
);

3351 
	`WARN_ON
(
	`∑ge_has_buf„rs
(
∑ge
Ë&& 
	`buf„r_jbd
(
	`∑ge_buf„rs
(page)));

3353 
	`block_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
);

3354 
	}
}

3356 
	$__pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
 *page,

3357 
off£t
,

3358 
Àngth
)

3360 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_JOURNAL
(
∑ge
->
m≠pög
->
ho°
);

3362 
	`åa˚_pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
);

3367 i‡(
off£t
 =0 && 
Àngth
 =
PAGE_SIZE
)

3368 
	`CÀ¨PageChecked
(
∑ge
);

3370  
	`jbd3_jou∫Æ_övÆid©ïage
(
jou∫Æ
, 
∑ge
, 
off£t
, 
Àngth
);

3371 
	}
}

3374 
	$pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
 *page,

3375 
off£t
,

3376 
Àngth
)

3378 
	`WARN_ON
(
	`__pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
) < 0);

3379 
	}
}

3381 
	$pxt4_ªÀa£∑ge
(
∑ge
 *∑ge, 
gÂ_t
 
waô
)

3383 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_JOURNAL
(
∑ge
->
m≠pög
->
ho°
);

3385 
	`åa˚_pxt4_ªÀa£∑ge
(
∑ge
);

3388 i‡(
	`PageChecked
(
∑ge
))

3390 i‡(
jou∫Æ
)

3391  
	`jbd3_jou∫Æ_åy_to_‰ì_buf„rs
(
jou∫Æ
, 
∑ge
, 
waô
);

3393  
	`åy_to_‰ì_buf„rs
(
∑ge
);

3394 
	}
}

3396 
boﬁ
 
	$pxt4_öode_d©async_dúty
(
öode
 *inode)

3398 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

3400 i‡(
jou∫Æ
)

3401  !
	`jbd3_å™ß˘i⁄_commôãd
(
jou∫Æ
,

3402 
	`PXT4_I
(
öode
)->
i_d©async_tid
);

3404 i‡(!
	`li°_em±y
(&
öode
->
i_m≠pög
->
¥iv©e_li°
))

3405  
åue
;

3406  
öode
->
i_°©e
 & 
I_DIRTY_DATASYNC
;

3407 
	}
}

3409 
	$pxt4_iom≠_begö
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
,

3410 
Êags
, 
iom≠
 *iomap)

3412 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

3413 
blkbôs
 = 
öode
->
i_blkbôs
;

3414 
fú°_block
, 
œ°_block
;

3415 
pxt4_m≠_blocks
 
m≠
;

3416 
boﬁ
 
dñÆloc
 = 
Ál£
;

3417 
ªt
;

3419 i‡((
off£t
 >> 
blkbôs
Ë> 
PXT4_MAX_LOGICAL_BLOCK
)

3420  -
EINVAL
;

3421 
fú°_block
 = 
off£t
 >> 
blkbôs
;

3422 
œ°_block
 = 
	`mö_t
(
loff_t
, (
off£t
 + 
Àngth
 - 1Ë>> 
blkbôs
,

3423 
PXT4_MAX_LOGICAL_BLOCK
);

3425 i‡(
Êags
 & 
IOMAP_REPORT
) {

3426 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

3427 
ªt
 = 
	`pxt4_ölöe_d©a_iom≠
(
öode
, 
iom≠
);

3428 i‡(
ªt
 !-
EAGAIN
) {

3429 i‡(
ªt
 =0 && 
off£t
 >
iom≠
->
Àngth
)

3430 
ªt
 = -
ENOENT
;

3431  
ªt
;

3435 i‡(
	`WARN_ON_ONCE
(
	`pxt4_has_ölöe_d©a
(
öode
)))

3436  -
ERANGE
;

3439 
m≠
.
m_lblk
 = 
fú°_block
;

3440 
m≠
.
m_Àn
 = 
œ°_block
 - 
fú°_block
 + 1;

3442 i‡(
Êags
 & 
IOMAP_REPORT
) {

3443 
ªt
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

3444 i‡(
ªt
 < 0)

3445  
ªt
;

3447 i‡(
ªt
 == 0) {

3448 
pxt4_lblk_t
 
íd
 = 
m≠
.
m_lblk
 + m≠.
m_Àn
 - 1;

3449 
exã¡_°©us
 
es
;

3451 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
,

3452 
m≠
.
m_lblk
, 
íd
, &
es
);

3454 i‡(!
es
.
es_Àn
 ||És.
es_lblk
 > 
íd
) {

3456 } i‡(
es
.
es_lblk
 > 
m≠
.
m_lblk
) {

3458 
m≠
.
m_Àn
 = 
es
.
es_lblk
 - m≠.
m_lblk
;

3460 
pxt4_lblk_t
 
offs
 = 0;

3462 i‡(
es
.
es_lblk
 < 
m≠
.
m_lblk
)

3463 
offs
 = 
m≠
.
m_lblk
 - 
es
.
es_lblk
;

3464 
m≠
.
m_lblk
 = 
es
.
es_lblk
 + 
offs
;

3465 
m≠
.
m_Àn
 = 
es
.
es_Àn
 - 
offs
;

3466 
dñÆloc
 = 
åue
;

3469 } i‡(
Êags
 & 
IOMAP_WRITE
) {

3470 
dio_¸edôs
;

3471 
h™dÀ_t
 *
h™dÀ
;

3472 
ªåõs
 = 0;

3475 i‡(
m≠
.
m_Àn
 > 
DIO_MAX_BLOCKS
)

3476 
m≠
.
m_Àn
 = 
DIO_MAX_BLOCKS
;

3477 
dio_¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
m≠
.
m_Àn
);

3478 
ªåy
:

3485 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
,

3486 
dio_¸edôs
);

3487 i‡(
	`IS_ERR
(
h™dÀ
))

3488  
	`PTR_ERR
(
h™dÀ
);

3490 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
,

3491 
PXT4_GET_BLOCKS_CREATE_ZERO
);

3492 i‡(
ªt
 < 0) {

3493 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3494 i‡(
ªt
 =-
ENOSPC
 &&

3495 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

3496 
ªåy
;

3497  
ªt
;

3509 i‡(!(
Êags
 & 
IOMAP_FAULT
Ë&& 
fú°_block
 + 
m≠
.
m_Àn
 >

3510 (
	`i_size_ªad
(
öode
Ë+ (1 << 
blkbôs
) - 1) >> blkbits) {

3511 
îr
;

3513 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3514 i‡(
îr
 < 0) {

3515 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3516  
îr
;

3519 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3521 
ªt
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

3522 i‡(
ªt
 < 0)

3523  
ªt
;

3526 
iom≠
->
Êags
 = 0;

3527 i‡(
	`pxt4_öode_d©async_dúty
(
öode
))

3528 
iom≠
->
Êags
 |
IOMAP_F_DIRTY
;

3529 
iom≠
->
bdev
 = 
öode
->
i_sb
->
s_bdev
;

3530 
iom≠
->
dax_dev
 = 
sbi
->
s_daxdev
;

3531 
iom≠
->
off£t
 = (
u64
)
fú°_block
 << 
blkbôs
;

3532 
iom≠
->
Àngth
 = (
u64
)
m≠
.
m_Àn
 << 
blkbôs
;

3534 i‡(
ªt
 == 0) {

3535 
iom≠
->
ty≥
 = 
dñÆloc
 ? 
IOMAP_DELALLOC
 : 
IOMAP_HOLE
;

3536 
iom≠
->
addr
 = 
IOMAP_NULL_ADDR
;

3538 i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
) {

3539 
iom≠
->
ty≥
 = 
IOMAP_MAPPED
;

3540 } i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_UNWRITTEN
) {

3541 
iom≠
->
ty≥
 = 
IOMAP_UNWRITTEN
;

3543 
	`WARN_ON_ONCE
(1);

3544  -
EIO
;

3546 
iom≠
->
addr
 = (
u64
)
m≠
.
m_pblk
 << 
blkbôs
;

3549 i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_NEW
)

3550 
iom≠
->
Êags
 |
IOMAP_F_NEW
;

3553 
	}
}

3555 
	$pxt4_iom≠_íd
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
,

3556 
ssize_t
 
wrôãn
, 
Êags
, 
iom≠
 *iomap)

3558 
ªt
 = 0;

3559 
h™dÀ_t
 *
h™dÀ
;

3560 
blkbôs
 = 
öode
->
i_blkbôs
;

3561 
boﬁ
 
åunˇã
 = 
Ál£
;

3563 i‡(!(
Êags
 & 
IOMAP_WRITE
Ë|| (Êag†& 
IOMAP_FAULT
))

3566 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

3567 i‡(
	`IS_ERR
(
h™dÀ
)) {

3568 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

3569 
‹ph™_dñ
;

3571 i‡(
	`pxt4_upd©e_öode_size
(
öode
, 
off£t
 + 
wrôãn
))

3572 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3576 i‡(
iom≠
->
off£t
 + iom≠->
Àngth
 >

3577 
	`ALIGN
(
öode
->
i_size
, 1 << 
blkbôs
)) {

3578 
pxt4_lblk_t
 
wrôãn_blk
, 
íd_blk
;

3580 
wrôãn_blk
 = (
off£t
 + 
wrôãn
Ë>> 
blkbôs
;

3581 
íd_blk
 = (
off£t
 + 
Àngth
Ë>> 
blkbôs
;

3582 i‡(
wrôãn_blk
 < 
íd_blk
 && 
	`pxt4_ˇn_åunˇã
(
öode
))

3583 
åunˇã
 = 
åue
;

3589 i‡(!
åunˇã
 && 
öode
->
i_∆ök
 &&

3590 !
	`li°_em±y
(&
	`PXT4_I
(
öode
)->
i_‹ph™
))

3591 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3592 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3593 i‡(
åunˇã
) {

3594 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

3595 
‹ph™_dñ
:

3601 i‡(
öode
->
i_∆ök
)

3602 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

3604  
ªt
;

3605 
	}
}

3607 c⁄° 
iom≠_›s
 
	gpxt4_iom≠_›s
 = {

3608 .
iom≠_begö
 = 
pxt4_iom≠_begö
,

3609 .
	giom≠_íd
 = 
pxt4_iom≠_íd
,

3612 
	$pxt4_íd_io_dio
(
kiocb
 *
iocb
, 
loff_t
 
off£t
,

3613 
ssize_t
 
size
, *
¥iv©e
)

3615 
pxt4_io_íd_t
 *
io_íd
 = 
¥iv©e
;

3618 i‡(!
io_íd
)

3621 
	`ext_debug
("pxt4_end_io_dio(): io_end 0x%p "

3623 
io_íd
, io_íd->
öode
->
i_öo
, 
iocb
, 
off£t
, 
size
);

3629 i‡(
size
 <= 0) {

3630 
	`pxt4_˛ór_io_unwrôãn_Êag
(
io_íd
);

3631 
size
 = 0;

3633 
io_íd
->
off£t
 = offset;

3634 
io_íd
->
size
 = size;

3635 
	`pxt4_put_io_íd
(
io_íd
);

3638 
	}
}

3661 
ssize_t
 
	$pxt4_dúe˘_IO_wrôe
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
)

3663 
fûe
 *fûê
iocb
->
ki_fûp
;

3664 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

3665 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

3666 
ssize_t
 
ªt
;

3667 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

3668 
size_t
 
cou¡
 = 
	`iov_ôî_cou¡
(
ôî
);

3669 
ovîwrôe
 = 0;

3670 
gë_block_t
 *
gë_block_func
 = 
NULL
;

3671 
dio_Êags
 = 0;

3672 
loff_t
 
föÆ_size
 = 
off£t
 + 
cou¡
;

3673 
‹ph™
 = 0;

3674 
h™dÀ_t
 *
h™dÀ
;

3676 i‡(
föÆ_size
 > 
öode
->
i_size
 || föÆ_sizê> 
ei
->
i_disksize
) {

3678 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

3679 i‡(
	`IS_ERR
(
h™dÀ
)) {

3680 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

3681 
out
;

3683 
ªt
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3684 i‡(
ªt
) {

3685 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3686 
out
;

3688 
‹ph™
 = 1;

3689 
	`pxt4_upd©e_i_disksize
(
öode
, inode->
i_size
);

3690 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3693 
	`BUG_ON
(
iocb
->
¥iv©e
 =
NULL
);

3700 
	`öode_dio_begö
(
öode
);

3703 
ovîwrôe
 = *((*)
iocb
->
¥iv©e
);

3705 i‡(
ovîwrôe
)

3706 
	`öode_u∆ock
(
öode
);

3728 
iocb
->
¥iv©e
 = 
NULL
;

3729 i‡(
ovîwrôe
)

3730 
gë_block_func
 = 
pxt4_dio_gë_block_ovîwrôe
;

3731 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
) ||

3732 
	`round_down
(
off£t
, 
	`i_blocksize
(
öode
)Ë>öode->
i_size
) {

3733 
gë_block_func
 = 
pxt4_dio_gë_block
;

3734 
dio_Êags
 = 
DIO_LOCKING
 | 
DIO_SKIP_HOLES
;

3735 } i‡(
	`is_sync_kiocb
(
iocb
)) {

3736 
gë_block_func
 = 
pxt4_dio_gë_block_unwrôãn_sync
;

3737 
dio_Êags
 = 
DIO_LOCKING
;

3739 
gë_block_func
 = 
pxt4_dio_gë_block_unwrôãn_async
;

3740 
dio_Êags
 = 
DIO_LOCKING
;

3742 
ªt
 = 
	`__blockdev_dúe˘_IO
(
iocb
, 
öode
, inode->
i_sb
->
s_bdev
, 
ôî
,

3743 
gë_block_func
, 
pxt4_íd_io_dio
, 
NULL
,

3744 
dio_Êags
);

3746 i‡(
ªt
 > 0 && !
ovîwrôe
 && 
	`pxt4_ã°_öode_°©e
(
öode
,

3747 
PXT4_STATE_DIO_UNWRITTEN
)) {

3748 
îr
;

3753 
îr
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s
(
NULL
, 
öode
,

3754 
off£t
, 
ªt
);

3755 i‡(
îr
 < 0)

3756 
ªt
 = 
îr
;

3757 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_DIO_UNWRITTEN
);

3760 
	`öode_dio_íd
(
öode
);

3762 i‡(
ovîwrôe
)

3763 
	`öode_lock
(
öode
);

3765 i‡(
ªt
 < 0 && 
föÆ_size
 > 
öode
->
i_size
)

3766 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

3769 i‡(
‹ph™
) {

3770 
îr
;

3773 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

3774 i‡(
	`IS_ERR
(
h™dÀ
)) {

3785 i‡(!
ªt
)

3786 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

3787 i‡(
öode
->
i_∆ök
)

3788 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

3790 
out
;

3792 i‡(
öode
->
i_∆ök
)

3793 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3794 i‡(
ªt
 > 0) {

3795 
loff_t
 
íd
 = 
off£t
 + 
ªt
;

3796 i‡(
íd
 > 
öode
->
i_size
 ||Énd > 
ei
->
i_disksize
) {

3797 
	`pxt4_upd©e_i_disksize
(
öode
, 
íd
);

3798 i‡(
íd
 > 
öode
->
i_size
)

3799 
	`i_size_wrôe
(
öode
, 
íd
);

3807 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3810 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3811 i‡(
ªt
 == 0)

3812 
ªt
 = 
îr
;

3814 
out
:

3815  
ªt
;

3816 
	}
}

3818 
ssize_t
 
	$pxt4_dúe˘_IO_ªad
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
)

3820 
addªss_•a˚
 *
m≠pög
 = 
iocb
->
ki_fûp
->
f_m≠pög
;

3821 
öode
 *öodê
m≠pög
->
ho°
;

3822 
size_t
 
cou¡
 = 
	`iov_ôî_cou¡
(
ôî
);

3823 
ssize_t
 
ªt
;

3830 
	`öode_lock_sh¨ed
(
öode
);

3831 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
m≠pög
, 
iocb
->
ki_pos
,

3832 
iocb
->
ki_pos
 + 
cou¡
 - 1);

3833 i‡(
ªt
)

3834 
out_u∆ock
;

3835 
ªt
 = 
	`__blockdev_dúe˘_IO
(
iocb
, 
öode
, inode->
i_sb
->
s_bdev
,

3836 
ôî
, 
pxt4_dio_gë_block
, 
NULL
, NULL, 0);

3837 
out_u∆ock
:

3838 
	`öode_u∆ock_sh¨ed
(
öode
);

3839  
ªt
;

3840 
	}
}

3842 
ssize_t
 
	$pxt4_dúe˘_IO
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
)

3844 
fûe
 *fûê
iocb
->
ki_fûp
;

3845 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

3846 
size_t
 
cou¡
 = 
	`iov_ôî_cou¡
(
ôî
);

3847 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

3848 
ssize_t
 
ªt
;

3850 #ifde‡
CONFIG_FS_ENCRYPTION


3851 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
))

3854 i‡(
	`fsvîôy_a˘ive
(
öode
))

3860 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

3864 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3867 
	`åa˚_pxt4_dúe˘_IO_íãr
(
öode
, 
off£t
, 
cou¡
, 
	`iov_ôî_rw
(
ôî
));

3868 i‡(
	`iov_ôî_rw
(
ôî
Ë=
READ
)

3869 
ªt
 = 
	`pxt4_dúe˘_IO_ªad
(
iocb
, 
ôî
);

3871 
ªt
 = 
	`pxt4_dúe˘_IO_wrôe
(
iocb
, 
ôî
);

3872 
	`åa˚_pxt4_dúe˘_IO_exô
(
öode
, 
off£t
, 
cou¡
, 
	`iov_ôî_rw
(
ôî
), 
ªt
);

3873  
ªt
;

3874 
	}
}

3889 
	$pxt4_jou∫ÆÀd_£t_∑ge_dúty
(
∑ge
 *page)

3891 
	`SëPageChecked
(
∑ge
);

3892  
	`__£t_∑ge_dúty_nobuf„rs
(
∑ge
);

3893 
	}
}

3895 
	$pxt4_£t_∑ge_dúty
(
∑ge
 *page)

3897 
	`WARN_ON_ONCE
(!
	`PageLocked
(
∑ge
Ë&& !
	`PageDúty
(page));

3898 
	`WARN_ON_ONCE
(!
	`∑ge_has_buf„rs
(
∑ge
));

3899  
	`__£t_∑ge_dúty_buf„rs
(
∑ge
);

3900 
	}
}

3902 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_a›s
 = {

3903 .
ªad∑ge
 = 
pxt4_ªad∑ge
,

3904 .
	gªad∑ges
 = 
pxt4_ªad∑ges
,

3905 .
	gwrôïage
 = 
pxt4_wrôïage
,

3906 .
	gwrôïages
 = 
pxt4_wrôïages
,

3907 .
	gwrôe_begö
 = 
pxt4_wrôe_begö
,

3908 .
	gwrôe_íd
 = 
pxt4_wrôe_íd
,

3909 .
	g£t_∑ge_dúty
 = 
pxt4_£t_∑ge_dúty
,

3910 .
	gbm≠
 = 
pxt4_bm≠
,

3911 .
	gövÆid©ïage
 = 
pxt4_övÆid©ïage
,

3912 .
	gªÀa£∑ge
 = 
pxt4_ªÀa£∑ge
,

3913 .
	gdúe˘_IO
 = 
pxt4_dúe˘_IO
,

3914 .
	gmigøã∑ge
 = 
buf„r_migøã_∑ge
,

3915 .
	gis_∑πüŒy_u±od©e
 = 
block_is_∑πüŒy_u±od©e
,

3916 .
	gîr‹_ªmove_∑ge
 = 
gíîic_îr‹_ªmove_∑ge
,

3919 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_jou∫ÆÀd_a›s
 = {

3920 .
ªad∑ge
 = 
pxt4_ªad∑ge
,

3921 .
	gªad∑ges
 = 
pxt4_ªad∑ges
,

3922 .
	gwrôïage
 = 
pxt4_wrôïage
,

3923 .
	gwrôïages
 = 
pxt4_wrôïages
,

3924 .
	gwrôe_begö
 = 
pxt4_wrôe_begö
,

3925 .
	gwrôe_íd
 = 
pxt4_jou∫ÆÀd_wrôe_íd
,

3926 .
	g£t_∑ge_dúty
 = 
pxt4_jou∫ÆÀd_£t_∑ge_dúty
,

3927 .
	gbm≠
 = 
pxt4_bm≠
,

3928 .
	gövÆid©ïage
 = 
pxt4_jou∫ÆÀd_övÆid©ïage
,

3929 .
	gªÀa£∑ge
 = 
pxt4_ªÀa£∑ge
,

3930 .
	gdúe˘_IO
 = 
pxt4_dúe˘_IO
,

3931 .
	gis_∑πüŒy_u±od©e
 = 
block_is_∑πüŒy_u±od©e
,

3932 .
	gîr‹_ªmove_∑ge
 = 
gíîic_îr‹_ªmove_∑ge
,

3935 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_da_a›s
 = {

3936 .
ªad∑ge
 = 
pxt4_ªad∑ge
,

3937 .
	gªad∑ges
 = 
pxt4_ªad∑ges
,

3938 .
	gwrôïage
 = 
pxt4_wrôïage
,

3939 .
	gwrôïages
 = 
pxt4_wrôïages
,

3940 .
	gwrôe_begö
 = 
pxt4_da_wrôe_begö
,

3941 .
	gwrôe_íd
 = 
pxt4_da_wrôe_íd
,

3942 .
	g£t_∑ge_dúty
 = 
pxt4_£t_∑ge_dúty
,

3943 .
	gbm≠
 = 
pxt4_bm≠
,

3944 .
	gövÆid©ïage
 = 
pxt4_övÆid©ïage
,

3945 .
	gªÀa£∑ge
 = 
pxt4_ªÀa£∑ge
,

3946 .
	gdúe˘_IO
 = 
pxt4_dúe˘_IO
,

3947 .
	gmigøã∑ge
 = 
buf„r_migøã_∑ge
,

3948 .
	gis_∑πüŒy_u±od©e
 = 
block_is_∑πüŒy_u±od©e
,

3949 .
	gîr‹_ªmove_∑ge
 = 
gíîic_îr‹_ªmove_∑ge
,

3952 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_dax_a›s
 = {

3953 .
wrôïages
 = 
pxt4_dax_wrôïages
,

3954 .
	gdúe˘_IO
 = 
no›_dúe˘_IO
,

3955 .
	g£t_∑ge_dúty
 = 
no›_£t_∑ge_dúty
,

3956 .
	gbm≠
 = 
pxt4_bm≠
,

3957 .
	gövÆid©ïage
 = 
no›_övÆid©ïage
,

3960 
	$pxt4_£t_a›s
(
öode
 *inode)

3962 
	`pxt4_öode_jou∫Æ_mode
(
öode
)) {

3963 
PXT4_INODE_ORDERED_DATA_MODE
:

3964 
PXT4_INODE_WRITEBACK_DATA_MODE
:

3966 
PXT4_INODE_JOURNAL_DATA_MODE
:

3967 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_jou∫ÆÀd_a›s
;

3970 
	`BUG
();

3972 i‡(
	`IS_DAX
(
öode
))

3973 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_dax_a›s
;

3974 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

3975 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_da_a›s
;

3977 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_a›s
;

3978 
	}
}

3980 
	$__pxt4_block_zîo_∑ge_ønge
(
h™dÀ_t
 *
h™dÀ
,

3981 
addªss_•a˚
 *
m≠pög
, 
loff_t
 
‰om
,Üoff_à
Àngth
)

3983 
pxt4_fsblk_t
 
ödex
 = 
‰om
 >> 
PAGE_SHIFT
;

3984 
off£t
 = 
‰om
 & (
PAGE_SIZE
-1);

3985 
blocksize
, 
pos
;

3986 
pxt4_lblk_t
 
iblock
;

3987 
öode
 *öodê
m≠pög
->
ho°
;

3988 
buf„r_hód
 *
bh
;

3989 
∑ge
 *page;

3990 
îr
 = 0;

3992 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
m≠pög
, 
‰om
 >> 
PAGE_SHIFT
,

3993 
	`m≠pög_gÂ_c⁄°øöt
(
m≠pög
, ~
__GFP_FS
));

3994 i‡(!
∑ge
)

3995  -
ENOMEM
;

3997 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

3999 
iblock
 = 
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_sb
->
s_blocksize_bôs
);

4001 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

4002 
	`¸óã_em±y_buf„rs
(
∑ge
, 
blocksize
, 0);

4005 
bh
 = 
	`∑ge_buf„rs
(
∑ge
);

4006 
pos
 = 
blocksize
;

4007 
off£t
 >
pos
) {

4008 
bh
 = bh->
b_this_∑ge
;

4009 
iblock
++;

4010 
pos
 +
blocksize
;

4012 i‡(
	`buf„r_‰ìd
(
bh
)) {

4013 
	`BUFFER_TRACE
(
bh
, "freed: skip");

4014 
u∆ock
;

4016 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

4017 
	`BUFFER_TRACE
(
bh
, "unmapped");

4018 
	`pxt4_gë_block
(
öode
, 
iblock
, 
bh
, 0);

4020 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

4021 
	`BUFFER_TRACE
(
bh
, "still unmapped");

4022 
u∆ock
;

4027 i‡(
	`PageU±od©e
(
∑ge
))

4028 
	`£t_buf„r_u±od©e
(
bh
);

4030 i‡(!
	`buf„r_u±od©e
(
bh
)) {

4031 
îr
 = -
EIO
;

4032 
	`Œ_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

4033 
	`waô_⁄_buf„r
(
bh
);

4035 i‡(!
	`buf„r_u±od©e
(
bh
))

4036 
u∆ock
;

4037 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë&& 
	`IS_ENCRYPTED
(inode)) {

4039 
	`BUG_ON
(!
	`fs¸y±_has_í¸y±i⁄_key
(
öode
));

4040 
	`WARN_ON_ONCE
(
	`fs¸y±_de¸y±_∑geˇche_blocks
(

4041 
∑ge
, 
blocksize
, 
	`bh_off£t
(
bh
)));

4044 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

4045 
	`BUFFER_TRACE
(
bh
, "get writeáccess");

4046 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

4047 i‡(
îr
)

4048 
u∆ock
;

4050 
	`zîo_u£r
(
∑ge
, 
off£t
, 
Àngth
);

4051 
	`BUFFER_TRACE
(
bh
, "zeroedÉnd of block");

4053 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

4054 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

4056 
îr
 = 0;

4057 
	`m¨k_buf„r_dúty
(
bh
);

4058 i‡(
	`pxt4_should_‹dî_d©a
(
öode
))

4059 
îr
 = 
	`pxt4_jbd3_öode_add_wrôe
(
h™dÀ
, 
öode
, 
‰om
,

4060 
Àngth
);

4063 
u∆ock
:

4064 
	`u∆ock_∑ge
(
∑ge
);

4065 
	`put_∑ge
(
∑ge
);

4066  
îr
;

4067 
	}
}

4076 
	$pxt4_block_zîo_∑ge_ønge
(
h™dÀ_t
 *
h™dÀ
,

4077 
addªss_•a˚
 *
m≠pög
, 
loff_t
 
‰om
,Üoff_à
Àngth
)

4079 
öode
 *öodê
m≠pög
->
ho°
;

4080 
off£t
 = 
‰om
 & (
PAGE_SIZE
-1);

4081 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

4082 
max
 = 
blocksize
 - (
off£t
 & (blocksize - 1));

4088 i‡(
Àngth
 > 
max
 ||Üength < 0)

4089 
Àngth
 = 
max
;

4091 i‡(
	`IS_DAX
(
öode
)) {

4092  
	`iom≠_zîo_ønge
(
öode
, 
‰om
, 
Àngth
, 
NULL
,

4093 &
pxt4_iom≠_›s
);

4095  
	`__pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
, 
‰om
, 
Àngth
);

4096 
	}
}

4104 
	$pxt4_block_åunˇã_∑ge
(
h™dÀ_t
 *
h™dÀ
,

4105 
addªss_•a˚
 *
m≠pög
, 
loff_t
 
‰om
)

4107 
off£t
 = 
‰om
 & (
PAGE_SIZE
-1);

4108 
Àngth
;

4109 
blocksize
;

4110 
öode
 *öodê
m≠pög
->
ho°
;

4113 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& !
	`fs¸y±_has_í¸y±i⁄_key
(inode))

4116 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

4117 
Àngth
 = 
blocksize
 - (
off£t
 & (blocksize - 1));

4119  
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
, 
‰om
, 
Àngth
);

4120 
	}
}

4122 
	$pxt4_zîo_∑πül_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4123 
loff_t
 
l°¨t
,Üoff_à
Àngth
)

4125 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4126 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

4127 
∑πül_°¨t
, 
∑πül_íd
;

4128 
pxt4_fsblk_t
 
°¨t
, 
íd
;

4129 
loff_t
 
byã_íd
 = (
l°¨t
 + 
Àngth
 - 1);

4130 
îr
 = 0;

4132 
∑πül_°¨t
 = 
l°¨t
 & (
sb
->
s_blocksize
 - 1);

4133 
∑πül_íd
 = 
byã_íd
 & (
sb
->
s_blocksize
 - 1);

4135 
°¨t
 = 
l°¨t
 >> 
sb
->
s_blocksize_bôs
;

4136 
íd
 = 
byã_íd
 >> 
sb
->
s_blocksize_bôs
;

4139 i‡(
°¨t
 =
íd
 &&

4140 (
∑πül_°¨t
 || (
∑πül_íd
 !
sb
->
s_blocksize
 - 1))) {

4141 
îr
 = 
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
,

4142 
l°¨t
, 
Àngth
);

4143  
îr
;

4146 i‡(
∑πül_°¨t
) {

4147 
îr
 = 
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
,

4148 
l°¨t
, 
sb
->
s_blocksize
);

4149 i‡(
îr
)

4150  
îr
;

4153 i‡(
∑πül_íd
 !
sb
->
s_blocksize
 - 1)

4154 
îr
 = 
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
,

4155 
byã_íd
 - 
∑πül_íd
,

4156 
∑πül_íd
 + 1);

4157  
îr
;

4158 
	}
}

4160 
	$pxt4_ˇn_åunˇã
(
öode
 *inode)

4162 i‡(
	`S_ISREG
(
öode
->
i_mode
))

4164 i‡(
	`S_ISDIR
(
öode
->
i_mode
))

4166 i‡(
	`S_ISLNK
(
öode
->
i_mode
))

4167  !
	`pxt4_öode_is_Á°_symlök
(
öode
);

4169 
	}
}

4177 
	$pxt4_upd©e_disksize_bef‹e_punch
(
öode
 *öode, 
loff_t
 
off£t
,

4178 
loff_t
 
Àn
)

4180 
h™dÀ_t
 *
h™dÀ
;

4181 
loff_t
 
size
 = 
	`i_size_ªad
(
öode
);

4183 
	`WARN_ON
(!
	`öode_is_locked
(
öode
));

4184 i‡(
off£t
 > 
size
 || off£à+ 
Àn
 < size)

4187 i‡(
	`PXT4_I
(
öode
)->
i_disksize
 >
size
)

4190 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MISC
, 1);

4191 i‡(
	`IS_ERR
(
h™dÀ
))

4192  
	`PTR_ERR
(
h™dÀ
);

4193 
	`pxt4_upd©e_i_disksize
(
öode
, 
size
);

4194 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4195 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4198 
	}
}

4200 
	$pxt4_waô_dax_∑ge
(
pxt4_öode_öfo
 *
ei
)

4202 
	`up_wrôe
(&
ei
->
i_mm≠_£m
);

4203 
	`scheduÀ
();

4204 
	`down_wrôe
(&
ei
->
i_mm≠_£m
);

4205 
	}
}

4207 
	$pxt4_bªak_œyouts
(
öode
 *inode)

4209 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4210 
∑ge
 *page;

4211 
îr‹
;

4213 i‡(
	`WARN_ON_ONCE
(!
	`rw£m_is_locked
(&
ei
->
i_mm≠_£m
)))

4214  -
EINVAL
;

4217 
∑ge
 = 
	`dax_œyout_busy_∑ge
(
öode
->
i_m≠pög
);

4218 i‡(!
∑ge
)

4221 
îr‹
 = 
	`___waô_v¨_evít
(&
∑ge
->
_ªfcou¡
,

4222 
	`©omic_ªad
(&
∑ge
->
_ªfcou¡
) == 1,

4223 
TASK_INTERRUPTIBLE
, 0, 0,

4224 
	`pxt4_waô_dax_∑ge
(
ei
));

4225 } 
îr‹
 == 0);

4227  
îr‹
;

4228 
	}
}

4241 
	$pxt4_punch_hﬁe
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
)

4243 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4244 
pxt4_lblk_t
 
fú°_block
, 
°›_block
;

4245 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

4246 
loff_t
 
fú°_block_off£t
, 
œ°_block_off£t
;

4247 
h™dÀ_t
 *
h™dÀ
;

4248 
¸edôs
;

4249 
ªt
 = 0;

4251 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

4252  -
EOPNOTSUPP
;

4254 
	`åa˚_pxt4_punch_hﬁe
(
öode
, 
off£t
, 
Àngth
, 0);

4256 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

4257 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

4258 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4259 
ªt
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

4260 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4261 i‡(
ªt
)

4262  
ªt
;

4269 i‡(
	`m≠pög_ègged
(
m≠pög
, 
PAGECACHE_TAG_DIRTY
)) {

4270 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
m≠pög
, 
off£t
,

4271 
off£t
 + 
Àngth
 - 1);

4272 i‡(
ªt
)

4273  
ªt
;

4276 
	`öode_lock
(
öode
);

4279 i‡(
off£t
 >
öode
->
i_size
)

4280 
out_muãx
;

4286 i‡(
off£t
 + 
Àngth
 > 
öode
->
i_size
) {

4287 
Àngth
 = 
öode
->
i_size
 +

4288 
PAGE_SIZE
 - (
öode
->
i_size
 & (PAGE_SIZE - 1)) -

4289 
off£t
;

4292 i‡(
off£t
 & (
sb
->
s_blocksize
 - 1) ||

4293 (
off£t
 + 
Àngth
Ë& (
sb
->
s_blocksize
 - 1)) {

4298 
ªt
 = 
	`pxt4_öode_©èch_jöode
(
öode
);

4299 i‡(
ªt
 < 0)

4300 
out_muãx
;

4305 
	`öode_dio_waô
(
öode
);

4311 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4313 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

4314 i‡(
ªt
)

4315 
out_dio
;

4317 
fú°_block_off£t
 = 
	`round_up
(
off£t
, 
sb
->
s_blocksize
);

4318 
œ°_block_off£t
 = 
	`round_down
((
off£t
 + 
Àngth
), 
sb
->
s_blocksize
) - 1;

4321 i‡(
œ°_block_off£t
 > 
fú°_block_off£t
) {

4322 
ªt
 = 
	`pxt4_upd©e_disksize_bef‹e_punch
(
öode
, 
off£t
, 
Àngth
);

4323 i‡(
ªt
)

4324 
out_dio
;

4325 
	`åunˇã_∑geˇche_ønge
(
öode
, 
fú°_block_off£t
,

4326 
œ°_block_off£t
);

4329 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4330 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

4332 
¸edôs
 = 
	`pxt4_blocks_f‹_åunˇã
(
öode
);

4333 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

4334 i‡(
	`IS_ERR
(
h™dÀ
)) {

4335 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4336 
	`pxt4_°d_îr‹
(
sb
, 
ªt
);

4337 
out_dio
;

4340 
ªt
 = 
	`pxt4_zîo_∑πül_blocks
(
h™dÀ
, 
öode
, 
off£t
,

4341 
Àngth
);

4342 i‡(
ªt
)

4343 
out_°›
;

4345 
fú°_block
 = (
off£t
 + 
sb
->
s_blocksize
 - 1) >>

4346 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

4347 
°›_block
 = (
off£t
 + 
Àngth
Ë>> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

4350 i‡(
°›_block
 > 
fú°_block
) {

4352 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4353 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4355 
ªt
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
fú°_block
,

4356 
°›_block
 - 
fú°_block
);

4357 i‡(
ªt
) {

4358 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4359 
out_°›
;

4362 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4363 
ªt
 = 
	`pxt4_ext_ªmove_•a˚
(
öode
, 
fú°_block
,

4364 
°›_block
 - 1);

4366 
ªt
 = 
	`pxt4_öd_ªmove_•a˚
(
h™dÀ
, 
öode
, 
fú°_block
,

4367 
°›_block
);

4369 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4371 i‡(
	`IS_SYNC
(
öode
))

4372 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

4374 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4375 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4376 i‡(
ªt
 >= 0)

4377 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4378 
out_°›
:

4379 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4380 
out_dio
:

4381 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4382 
out_muãx
:

4383 
	`öode_u∆ock
(
öode
);

4384  
ªt
;

4385 
	}
}

4387 
	$pxt4_öode_©èch_jöode
(
öode
 *inode)

4389 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4390 
jbd3_öode
 *
jöode
;

4392 i‡(
ei
->
jöode
 || !
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
)

4395 
jöode
 = 
	`jbd3_Æloc_öode
(
GFP_KERNEL
);

4396 
	`•ö_lock
(&
öode
->
i_lock
);

4397 i‡(!
ei
->
jöode
) {

4398 i‡(!
jöode
) {

4399 
	`•ö_u∆ock
(&
öode
->
i_lock
);

4400  -
ENOMEM
;

4402 
ei
->
jöode
 = jinode;

4403 
	`jbd3_jou∫Æ_öô_jbd_öode
(
ei
->
jöode
, 
öode
);

4404 
jöode
 = 
NULL
;

4406 
	`•ö_u∆ock
(&
öode
->
i_lock
);

4407 i‡(
	`u∆ikñy
(
jöode
 !
NULL
))

4408 
	`jbd3_‰ì_öode
(
jöode
);

4410 
	}
}

4440 
	$pxt4_åunˇã
(
öode
 *inode)

4442 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4443 
¸edôs
;

4444 
îr
 = 0;

4445 
h™dÀ_t
 *
h™dÀ
;

4446 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

4453 i‡(!(
öode
->
i_°©e
 & (
I_NEW
|
I_FREEING
)))

4454 
	`WARN_ON
(!
	`öode_is_locked
(
öode
));

4455 
	`åa˚_pxt4_åunˇã_íãr
(
öode
);

4457 i‡(!
	`pxt4_ˇn_åunˇã
(
öode
))

4460 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
);

4462 i‡(
öode
->
i_size
 =0 && !
	`ã°_›t
(öode->
i_sb
, 
NO_AUTO_DA_ALLOC
))

4463 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
);

4465 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

4466 
has_ölöe
 = 1;

4468 
îr
 = 
	`pxt4_ölöe_d©a_åunˇã
(
öode
, &
has_ölöe
);

4469 i‡(
îr
)

4470  
îr
;

4471 i‡(
has_ölöe
)

4476 i‡(
öode
->
i_size
 & (öode->
i_sb
->
s_blocksize
 - 1)) {

4477 i‡(
	`pxt4_öode_©èch_jöode
(
öode
) < 0)

4481 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4482 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

4484 
¸edôs
 = 
	`pxt4_blocks_f‹_åunˇã
(
öode
);

4486 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

4487 i‡(
	`IS_ERR
(
h™dÀ
))

4488  
	`PTR_ERR
(
h™dÀ
);

4490 i‡(
öode
->
i_size
 & (öode->
i_sb
->
s_blocksize
 - 1))

4491 
	`pxt4_block_åunˇã_∑ge
(
h™dÀ
, 
m≠pög
, 
öode
->
i_size
);

4502 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

4503 i‡(
îr
)

4504 
out_°›
;

4506 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4508 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4510 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4511 
îr
 = 
	`pxt4_ext_åunˇã
(
h™dÀ
, 
öode
);

4513 
	`pxt4_öd_åunˇã
(
h™dÀ
, 
öode
);

4515 
	`up_wrôe
(&
ei
->
i_d©a_£m
);

4516 i‡(
îr
)

4517 
out_°›
;

4519 i‡(
	`IS_SYNC
(
öode
))

4520 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

4522 
out_°›
:

4530 i‡(
öode
->
i_∆ök
)

4531 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

4533 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4534 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4535 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4537 
	`åa˚_pxt4_åunˇã_exô
(
öode
);

4538  
îr
;

4539 
	}
}

4547 
	$__pxt4_gë_öode_loc
(
öode
 *inode,

4548 
pxt4_ûoc
 *
ûoc
, 
ö_mem
)

4550 
pxt4_group_desc
 *
gdp
;

4551 
buf„r_hód
 *
bh
;

4552 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4553 
pxt4_fsblk_t
 
block
;

4554 
blk_∂ug
 
∂ug
;

4555 
öodes_≥r_block
, 
öode_off£t
;

4557 
ûoc
->
bh
 = 
NULL
;

4558 i‡(
öode
->
i_öo
 < 
PXT4_ROOT_INO
 ||

4559 
öode
->
i_öo
 > 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
))

4560  -
EFSCORRUPTED
;

4562 
ûoc
->
block_group
 = (
öode
->
i_öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

4563 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
ûoc
->
block_group
, 
NULL
);

4564 i‡(!
gdp
)

4565  -
EIO
;

4570 
öodes_≥r_block
 = 
	`PXT4_SB
(
sb
)->
s_öodes_≥r_block
;

4571 
öode_off£t
 = ((
öode
->
i_öo
 - 1) %

4572 
	`PXT4_INODES_PER_GROUP
(
sb
));

4573 
block
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
Ë+ (
öode_off£t
 / 
öodes_≥r_block
);

4574 
ûoc
->
off£t
 = (
öode_off£t
 % 
öodes_≥r_block
Ë* 
	`PXT4_INODE_SIZE
(
sb
);

4576 
bh
 = 
	`sb_gëblk
(
sb
, 
block
);

4577 i‡(
	`u∆ikñy
(!
bh
))

4578  -
ENOMEM
;

4579 i‡(!
	`buf„r_u±od©e
(
bh
)) {

4580 
	`lock_buf„r
(
bh
);

4588 i‡(
	`buf„r_wrôe_io_îr‹
(
bh
Ë&& !
	`buf„r_u±od©e
(bh))

4589 
	`£t_buf„r_u±od©e
(
bh
);

4591 i‡(
	`buf„r_u±od©e
(
bh
)) {

4593 
	`u∆ock_buf„r
(
bh
);

4594 
has_buf„r
;

4602 i‡(
ö_mem
) {

4603 
buf„r_hód
 *
bôm≠_bh
;

4604 
i
, 
°¨t
;

4606 
°¨t
 = 
öode_off£t
 & ~(
öodes_≥r_block
 - 1);

4609 
bôm≠_bh
 = 
	`sb_gëblk
(
sb
, 
	`pxt4_öode_bôm≠
(sb, 
gdp
));

4610 i‡(
	`u∆ikñy
(!
bôm≠_bh
))

4611 
make_io
;

4618 i‡(!
	`buf„r_u±od©e
(
bôm≠_bh
)) {

4619 
	`bªl£
(
bôm≠_bh
);

4620 
make_io
;

4622 
i
 = 
°¨t
; i < sèπ + 
öodes_≥r_block
; i++) {

4623 i‡(
i
 =
öode_off£t
)

4625 i‡(
	`pxt4_ã°_bô
(
i
, 
bôm≠_bh
->
b_d©a
))

4628 
	`bªl£
(
bôm≠_bh
);

4629 i‡(
i
 =
°¨t
 + 
öodes_≥r_block
) {

4631 
	`mem£t
(
bh
->
b_d©a
, 0, bh->
b_size
);

4632 
	`£t_buf„r_u±od©e
(
bh
);

4633 
	`u∆ock_buf„r
(
bh
);

4634 
has_buf„r
;

4638 
make_io
:

4643 
	`blk_°¨t_∂ug
(&
∂ug
);

4644 i‡(
	`PXT4_SB
(
sb
)->
s_öode_ªadahód_blks
) {

4645 
pxt4_fsblk_t
 
b
, 
íd
, 
èbÀ
;

4646 
num
;

4647 
__u32
 
ø_blks
 = 
	`PXT4_SB
(
sb
)->
s_öode_ªadahód_blks
;

4649 
èbÀ
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

4651 
b
 = 
block
 & ~((
pxt4_fsblk_t
Ë
ø_blks
 - 1);

4652 i‡(
èbÀ
 > 
b
)

4653 
b
 = 
èbÀ
;

4654 
íd
 = 
b
 + 
ø_blks
;

4655 
num
 = 
	`PXT4_INODES_PER_GROUP
(
sb
);

4656 i‡(
	`pxt4_has_group_desc_csum
(
sb
))

4657 
num
 -
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
);

4658 
èbÀ
 +
num
 / 
öodes_≥r_block
;

4659 i‡(
íd
 > 
èbÀ
)

4660 
íd
 = 
èbÀ
;

4661 
b
 <
íd
)

4662 
	`sb_bªadahód
(
sb
, 
b
++);

4670 
	`åa˚_pxt4_lﬂd_öode
(
öode
);

4671 
	`gë_bh
(
bh
);

4672 
bh
->
b_íd_io
 = 
íd_buf„r_ªad_sync
;

4673 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

4674 
	`blk_föish_∂ug
(&
∂ug
);

4675 
	`waô_⁄_buf„r
(
bh
);

4676 i‡(!
	`buf„r_u±od©e
(
bh
)) {

4677 
	`PXT4_ERROR_INODE_BLOCK
(
öode
, 
block
,

4679 
	`bªl£
(
bh
);

4680  -
EIO
;

4683 
has_buf„r
:

4684 
ûoc
->
bh
 = bh;

4686 
	}
}

4688 
	$pxt4_gë_öode_loc
(
öode
 *öode, 
pxt4_ûoc
 *
ûoc
)

4691  
	`__pxt4_gë_öode_loc
(
öode
, 
ûoc
,

4692 !
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
));

4693 
	}
}

4695 
boﬁ
 
	$pxt4_should_u£_dax
(
öode
 *inode)

4697 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
DAX
))

4698  
Ál£
;

4699 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

4700  
Ál£
;

4701 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

4702  
Ál£
;

4703 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

4704  
Ál£
;

4705 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_ENCRYPT
))

4706  
Ál£
;

4707 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_VERITY
))

4708  
Ál£
;

4709  
åue
;

4710 
	}
}

4712 
	$pxt4_£t_öode_Êags
(
öode
 *inode)

4714 
Êags
 = 
	`PXT4_I
(
öode
)->
i_Êags
;

4715 
√w_Ê
 = 0;

4717 i‡(
Êags
 & 
PXT4_SYNC_FL
)

4718 
√w_Ê
 |
S_SYNC
;

4719 i‡(
Êags
 & 
PXT4_APPEND_FL
)

4720 
√w_Ê
 |
S_APPEND
;

4721 i‡(
Êags
 & 
PXT4_IMMUTABLE_FL
)

4722 
√w_Ê
 |
S_IMMUTABLE
;

4723 i‡(
Êags
 & 
PXT4_NOATIME_FL
)

4724 
√w_Ê
 |
S_NOATIME
;

4725 i‡(
Êags
 & 
PXT4_DIRSYNC_FL
)

4726 
√w_Ê
 |
S_DIRSYNC
;

4727 i‡(
	`pxt4_should_u£_dax
(
öode
))

4728 
√w_Ê
 |
S_DAX
;

4729 i‡(
Êags
 & 
PXT4_ENCRYPT_FL
)

4730 
√w_Ê
 |
S_ENCRYPTED
;

4731 i‡(
Êags
 & 
PXT4_CASEFOLD_FL
)

4732 
√w_Ê
 |
S_CASEFOLD
;

4733 i‡(
Êags
 & 
PXT4_VERITY_FL
)

4734 
√w_Ê
 |
S_VERITY
;

4735 
	`öode_£t_Êags
(
öode
, 
√w_Ê
,

4736 
S_SYNC
|
S_APPEND
|
S_IMMUTABLE
|
S_NOATIME
|
S_DIRSYNC
|
S_DAX
|

4737 
S_ENCRYPTED
|
S_CASEFOLD
|
S_VERITY
);

4738 
	}
}

4740 
blk˙t_t
 
	$pxt4_öode_blocks
(
pxt4_öode
 *
øw_öode
,

4741 
pxt4_öode_öfo
 *
ei
)

4743 
blk˙t_t
 
i_blocks
 ;

4744 
öode
 *öodê&(
ei
->
vfs_öode
);

4745 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4747 i‡(
	`pxt4_has_„©uª_huge_fûe
(
sb
)) {

4749 
i_blocks
 = ((
u64
)
	`À16_to_˝u
(
øw_öode
->
i_blocks_high
)) << 32 |

4750 
	`À32_to_˝u
(
øw_öode
->
i_blocks_lo
);

4751 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
)) {

4753  
i_blocks
 << (
öode
->
i_blkbôs
 - 9);

4755  
i_blocks
;

4758  
	`À32_to_˝u
(
øw_öode
->
i_blocks_lo
);

4760 
	}
}

4762 
ölöe
 
	$pxt4_igë_exåa_öode
(
öode
 *inode,

4763 
pxt4_öode
 *
øw_öode
,

4764 
pxt4_öode_öfo
 *
ei
)

4766 
__À32
 *
magic
 = (*)
øw_öode
 +

4767 
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
;

4769 i‡(
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
 + (
__À32
) <=

4770 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
) &&

4771 *
magic
 =
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
)) {

4772 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

4773  
	`pxt4_föd_ölöe_d©a_nﬁock
(
öode
);

4775 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = 0;

4777 
	}
}

4779 
	$pxt4_gë_¥ojid
(
öode
 *öode, 
k¥ojid_t
 *
¥ojid
)

4781 i‡(!
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
))

4782  -
EOPNOTSUPP
;

4783 *
¥ojid
 = 
	`PXT4_I
(
öode
)->
i_¥ojid
;

4785 
	}
}

4792 
ölöe
 
	$pxt4_öode_£t_ivîsi⁄_quîõd
(
öode
 *öode, 
u64
 
vÆ
)

4794 i‡(
	`u∆ikñy
(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
))

4795 
	`öode_£t_ivîsi⁄_øw
(
öode
, 
vÆ
);

4797 
	`öode_£t_ivîsi⁄_quîõd
(
öode
, 
vÆ
);

4798 
	}
}

4799 
ölöe
 
u64
 
	$pxt4_öode_≥ek_ivîsi⁄
(c⁄° 
öode
 *inode)

4801 i‡(
	`u∆ikñy
(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
))

4802  
	`öode_≥ek_ivîsi⁄_øw
(
öode
);

4804  
	`öode_≥ek_ivîsi⁄
(
öode
);

4805 
	}
}

4807 
öode
 *
	$__pxt4_igë
(
su≥r_block
 *
sb
, 
öo
,

4808 
pxt4_igë_Êags
 
Êags
, c⁄° *
fun˘i⁄
,

4809 
löe
)

4811 
pxt4_ûoc
 
ûoc
;

4812 
pxt4_öode
 *
øw_öode
;

4813 
pxt4_öode_öfo
 *
ei
;

4814 
öode
 *inode;

4815 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

4816 
ªt
;

4817 
loff_t
 
size
;

4818 
block
;

4819 
uid_t
 
i_uid
;

4820 
gid_t
 
i_gid
;

4821 
¥ojid_t
 
i_¥ojid
;

4823 i‡((!(
Êags
 & 
PXT4_IGET_SPECIAL
) &&

4824 (
öo
 < 
	`PXT4_FIRST_INO
(
sb
Ë&& inÿ!
PXT4_ROOT_INO
)) ||

4825 (
öo
 < 
PXT4_ROOT_INO
) ||

4826 (
öo
 > 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
))) {

4827 i‡(
Êags
 & 
PXT4_IGET_HANDLE
)

4828  
	`ERR_PTR
(-
ESTALE
);

4829 
	`__pxt4_îr‹
(
sb
, 
fun˘i⁄
, 
löe
,

4831 
öo
, 
cuºít
->
comm
);

4832  
	`ERR_PTR
(-
EFSCORRUPTED
);

4835 
öode
 = 
	`igë_locked
(
sb
, 
öo
);

4836 i‡(!
öode
)

4837  
	`ERR_PTR
(-
ENOMEM
);

4838 i‡(!(
öode
->
i_°©e
 & 
I_NEW
))

4839  
öode
;

4841 
ei
 = 
	`PXT4_I
(
öode
);

4842 
ûoc
.
bh
 = 
NULL
;

4844 
ªt
 = 
	`__pxt4_gë_öode_loc
(
öode
, &
ûoc
, 0);

4845 i‡(
ªt
 < 0)

4846 
bad_öode
;

4847 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

4849 i‡((
öo
 =
PXT4_ROOT_INO
Ë&& (
øw_öode
->
i_löks_cou¡
 == 0)) {

4850 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4852 
ªt
 = -
EFSCORRUPTED
;

4853 
bad_öode
;

4856 i‡((
Êags
 & 
PXT4_IGET_HANDLE
) &&

4857 (
øw_öode
->
i_löks_cou¡
 =0Ë&& (øw_öode->
i_mode
 == 0)) {

4858 
ªt
 = -
ESTALE
;

4859 
bad_öode
;

4862 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

4863 
ei
->
i_exåa_isize
 = 
	`À16_to_˝u
(
øw_öode
->i_extra_isize);

4864 i‡(
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
 >

4865 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
) ||

4866 (
ei
->
i_exåa_isize
 & 3)) {

4867 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4870 
ei
->
i_exåa_isize
,

4871 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
));

4872 
ªt
 = -
EFSCORRUPTED
;

4873 
bad_öode
;

4876 
ei
->
i_exåa_isize
 = 0;

4879 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

4880 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

4881 
__u32
 
csum
;

4882 
__À32
 
öum
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

4883 
__À32
 
gí
 = 
øw_öode
->
i_gíî©i⁄
;

4884 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
öum
,

4885 (
öum
));

4886 
ei
->
i_csum_£ed
 = 
	`pxt4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
gí
,

4887 (
gí
));

4890 i‡(!
	`pxt4_öode_csum_vîify
(
öode
, 
øw_öode
, 
ei
)) {

4891 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4893 
ªt
 = -
EFSBADCRC
;

4894 
bad_öode
;

4897 
öode
->
i_mode
 = 
	`À16_to_˝u
(
øw_öode
->i_mode);

4898 
i_uid
 = (
uid_t
)
	`À16_to_˝u
(
øw_öode
->
i_uid_low
);

4899 
i_gid
 = (
gid_t
)
	`À16_to_˝u
(
øw_öode
->
i_gid_low
);

4900 i‡(
	`pxt4_has_„©uª_¥oje˘
(
sb
) &&

4901 
	`PXT4_INODE_SIZE
(
sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

4902 
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¥ojid
))

4903 
i_¥ojid
 = (
¥ojid_t
)
	`À32_to_˝u
(
øw_öode
->i_projid);

4905 
i_¥ojid
 = 
PXT4_DEF_PROJID
;

4907 i‡(!(
	`ã°_›t
(
öode
->
i_sb
, 
NO_UID32
))) {

4908 
i_uid
 |
	`À16_to_˝u
(
øw_öode
->
i_uid_high
) << 16;

4909 
i_gid
 |
	`À16_to_˝u
(
øw_öode
->
i_gid_high
) << 16;

4911 
	`i_uid_wrôe
(
öode
, 
i_uid
);

4912 
	`i_gid_wrôe
(
öode
, 
i_gid
);

4913 
ei
->
i_¥ojid
 = 
	`make_k¥ojid
(&
öô_u£r_ns
, i_projid);

4914 
	`£t_∆ök
(
öode
, 
	`À16_to_˝u
(
øw_öode
->
i_löks_cou¡
));

4916 
	`pxt4_˛ór_°©e_Êags
(
ei
);

4917 
ei
->
i_ölöe_off
 = 0;

4918 
ei
->
i_dú_°¨t_lookup
 = 0;

4919 
ei
->
i_dtime
 = 
	`À32_to_˝u
(
øw_öode
->i_dtime);

4925 i‡(
öode
->
i_∆ök
 == 0) {

4926 i‡((
öode
->
i_mode
 == 0 ||

4927 !(
	`PXT4_SB
(
öode
->
i_sb
)->
s_mou¡_°©e
 & 
PXT4_ORPHAN_FS
)) &&

4928 
öo
 !
PXT4_BOOT_LOADER_INO
) {

4930 
ªt
 = -
ESTALE
;

4931 
bad_öode
;

4940 
ei
->
i_Êags
 = 
	`À32_to_˝u
(
øw_öode
->i_flags);

4941 
	`pxt4_£t_öode_Êags
(
öode
);

4942 
öode
->
i_blocks
 = 
	`pxt4_öode_blocks
(
øw_öode
, 
ei
);

4943 
ei
->
i_fûe_a˛
 = 
	`À32_to_˝u
(
øw_öode
->
i_fûe_a˛_lo
);

4944 i‡(
	`pxt4_has_„©uª_64bô
(
sb
))

4945 
ei
->
i_fûe_a˛
 |=

4946 ((
__u64
)
	`À16_to_˝u
(
øw_öode
->
i_fûe_a˛_high
)) << 32;

4947 
öode
->
i_size
 = 
	`pxt4_isize
(
sb
, 
øw_öode
);

4948 i‡((
size
 = 
	`i_size_ªad
(
öode
)) < 0) {

4949 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4950 "igë: bad i_sizêvÆue: %Œd", 
size
);

4951 
ªt
 = -
EFSCORRUPTED
;

4952 
bad_öode
;

4954 
ei
->
i_disksize
 = 
öode
->
i_size
;

4955 #ifde‡
CONFIG_QUOTA


4956 
ei
->
i_ª£rved_quŸa
 = 0;

4958 
öode
->
i_gíî©i⁄
 = 
	`À32_to_˝u
(
øw_öode
->i_generation);

4959 
ei
->
i_block_group
 = 
ûoc
.
block_group
;

4960 
ei
->
i_œ°_Æloc_group
 = ~0;

4965 
block
 = 0; block < 
PXT4_N_BLOCKS
; block++)

4966 
ei
->
i_d©a
[
block
] = 
øw_öode
->
i_block
[block];

4967 
	`INIT_LIST_HEAD
(&
ei
->
i_‹ph™
);

4976 i‡(
jou∫Æ
) {

4977 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

4978 
tid_t
 
tid
;

4980 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

4981 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
)

4982 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

4984 
å™ß˘i⁄
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
;

4985 i‡(
å™ß˘i⁄
)

4986 
tid
 = 
å™ß˘i⁄
->
t_tid
;

4988 
tid
 = 
jou∫Æ
->
j_commô_£quí˚
;

4989 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

4990 
ei
->
i_sync_tid
 = 
tid
;

4991 
ei
->
i_d©async_tid
 = 
tid
;

4994 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

4995 i‡(
ei
->
i_exåa_isize
 == 0) {

4997 
	`BUILD_BUG_ON
((
pxt4_öode
) & 3);

4998 
ei
->
i_exåa_isize
 = (
pxt4_öode
) -

4999 
PXT4_GOOD_OLD_INODE_SIZE
;

5001 
ªt
 = 
	`pxt4_igë_exåa_öode
(
öode
, 
øw_öode
, 
ei
);

5002 i‡(
ªt
)

5003 
bad_öode
;

5007 
	`PXT4_INODE_GET_XTIME
(
i_˘ime
, 
öode
, 
øw_öode
);

5008 
	`PXT4_INODE_GET_XTIME
(
i_mtime
, 
öode
, 
øw_öode
);

5009 
	`PXT4_INODE_GET_XTIME
(
i_©ime
, 
öode
, 
øw_öode
);

5010 
	`PXT4_EINODE_GET_XTIME
(
i_¸time
, 
ei
, 
øw_öode
);

5012 i‡(
	`likñy
(!
	`ã°_›t2
(
öode
->
i_sb
, 
HURD_COMPAT
))) {

5013 
u64
 
ivîs
 = 
	`À32_to_˝u
(
øw_öode
->
i_disk_vîsi⁄
);

5015 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

5016 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_vîsi⁄_hi
))

5017 
ivîs
 |=

5018 (
__u64
)(
	`À32_to_˝u
(
øw_öode
->
i_vîsi⁄_hi
)) << 32;

5020 
	`pxt4_öode_£t_ivîsi⁄_quîõd
(
öode
, 
ivîs
);

5023 
ªt
 = 0;

5024 i‡(
ei
->
i_fûe_a˛
 &&

5025 !
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
sb
), 
ei
->
i_fûe_a˛
, 1)) {

5026 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

5028 
ei
->
i_fûe_a˛
);

5029 
ªt
 = -
EFSCORRUPTED
;

5030 
bad_öode
;

5031 } i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

5033 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë|| 
	`S_ISDIR
(inode->i_mode) ||

5034 (
	`S_ISLNK
(
öode
->
i_mode
) &&

5035 !
	`pxt4_öode_is_Á°_symlök
(
öode
))) {

5036 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

5037 
ªt
 = 
	`pxt4_ext_check_öode
(
öode
);

5039 
ªt
 = 
	`pxt4_öd_check_öode
(
öode
);

5042 i‡(
ªt
)

5043 
bad_öode
;

5045 i‡(
	`S_ISREG
(
öode
->
i_mode
)) {

5046 
öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

5047 
öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

5048 
	`pxt4_£t_a›s
(
öode
);

5049 } i‡(
	`S_ISDIR
(
öode
->
i_mode
)) {

5050 
öode
->
i_›
 = &
pxt4_dú_öode_›î©i⁄s
;

5051 
öode
->
i_f›
 = &
pxt4_dú_›î©i⁄s
;

5052 } i‡(
	`S_ISLNK
(
öode
->
i_mode
)) {

5054 i‡(
	`IS_APPEND
(
öode
Ë|| 
	`IS_IMMUTABLE
(inode)) {

5055 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

5058 
ªt
 = -
EFSCORRUPTED
;

5059 
bad_öode
;

5061 i‡(
	`IS_ENCRYPTED
(
öode
)) {

5062 
öode
->
i_›
 = &
pxt4_í¸y±ed_symlök_öode_›î©i⁄s
;

5063 
	`pxt4_£t_a›s
(
öode
);

5064 } i‡(
	`pxt4_öode_is_Á°_symlök
(
öode
)) {

5065 
öode
->
i_lök
 = (*)
ei
->
i_d©a
;

5066 
öode
->
i_›
 = &
pxt4_Á°_symlök_öode_›î©i⁄s
;

5067 
	`nd_ãrmö©e_lök
(
ei
->
i_d©a
, 
öode
->
i_size
,

5068 (
ei
->
i_d©a
) - 1);

5070 
öode
->
i_›
 = &
pxt4_symlök_öode_›î©i⁄s
;

5071 
	`pxt4_£t_a›s
(
öode
);

5073 
	`öode_nohighmem
(
öode
);

5074 } i‡(
	`S_ISCHR
(
öode
->
i_mode
Ë|| 
	`S_ISBLK
(inode->i_mode) ||

5075 
	`S_ISFIFO
(
öode
->
i_mode
Ë|| 
	`S_ISSOCK
(inode->i_mode)) {

5076 
öode
->
i_›
 = &
pxt4_•ecül_öode_›î©i⁄s
;

5077 i‡(
øw_öode
->
i_block
[0])

5078 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
,

5079 
	`ﬁd_decode_dev
(
	`À32_to_˝u
(
øw_öode
->
i_block
[0])));

5081 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
,

5082 
	`√w_decode_dev
(
	`À32_to_˝u
(
øw_öode
->
i_block
[1])));

5083 } i‡(
öo
 =
PXT4_BOOT_LOADER_INO
) {

5084 
	`make_bad_öode
(
öode
);

5086 
ªt
 = -
EFSCORRUPTED
;

5087 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

5088 "igë: bogu†i_modê(%o)", 
öode
->
i_mode
);

5089 
bad_öode
;

5091 i‡(
	`IS_CASEFOLDED
(
öode
Ë&& !
	`pxt4_has_„©uª_ˇ£fﬁd
(öode->
i_sb
))

5092 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

5094 
	`bªl£
(
ûoc
.
bh
);

5096 
	`u∆ock_√w_öode
(
öode
);

5097  
öode
;

5099 
bad_öode
:

5100 
	`bªl£
(
ûoc
.
bh
);

5101 
	`igë_Áûed
(
öode
);

5102  
	`ERR_PTR
(
ªt
);

5103 
	}
}

5105 
	$pxt4_öode_blocks_£t
(
h™dÀ_t
 *
h™dÀ
,

5106 
pxt4_öode
 *
øw_öode
,

5107 
pxt4_öode_öfo
 *
ei
)

5109 
öode
 *öodê&(
ei
->
vfs_öode
);

5110 
u64
 
i_blocks
 = 
öode
->i_blocks;

5111 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5113 i‡(
i_blocks
 <= ~0U) {

5118 
øw_öode
->
i_blocks_lo
 = 
	`˝u_to_À32
(
i_blocks
);

5119 
øw_öode
->
i_blocks_high
 = 0;

5120 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
);

5123 i‡(!
	`pxt4_has_„©uª_huge_fûe
(
sb
))

5124  -
EFBIG
;

5126 i‡(
i_blocks
 <= 0xffffffffffffULL) {

5131 
øw_öode
->
i_blocks_lo
 = 
	`˝u_to_À32
(
i_blocks
);

5132 
øw_öode
->
i_blocks_high
 = 
	`˝u_to_À16
(
i_blocks
 >> 32);

5133 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
);

5135 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
);

5137 
i_blocks
 = i_block†>> (
öode
->
i_blkbôs
 - 9);

5138 
øw_öode
->
i_blocks_lo
 = 
	`˝u_to_À32
(
i_blocks
);

5139 
øw_öode
->
i_blocks_high
 = 
	`˝u_to_À16
(
i_blocks
 >> 32);

5142 
	}
}

5144 
	sŸhî_öode
 {

5145 
	m‹ig_öo
;

5146 
pxt4_öode
 *
	møw_öode
;

5149 
	$Ÿhî_öode_m©ch
(
öode
 * inode, 
öo
,

5150 *
d©a
)

5152 
Ÿhî_öode
 *
oi
 = (Ÿhî_öodê*Ë
d©a
;

5154 i‡((
öode
->
i_öo
 !
öo
) ||

5155 (
öode
->
i_°©e
 & (
I_FREEING
 | 
I_WILL_FREE
 | 
I_NEW
 |

5156 
I_DIRTY_INODE
)) ||

5157 ((
öode
->
i_°©e
 & 
I_DIRTY_TIME
) == 0))

5159 
	`•ö_lock
(&
öode
->
i_lock
);

5160 i‡(((
öode
->
i_°©e
 & (
I_FREEING
 | 
I_WILL_FREE
 | 
I_NEW
 |

5161 
I_DIRTY_INODE
)) == 0) &&

5162 (
öode
->
i_°©e
 & 
I_DIRTY_TIME
)) {

5163 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5165 
öode
->
i_°©e
 &~(
I_DIRTY_TIME
 | 
I_DIRTY_TIME_EXPIRED
);

5166 
	`•ö_u∆ock
(&
öode
->
i_lock
);

5168 
	`•ö_lock
(&
ei
->
i_øw_lock
);

5169 
	`PXT4_INODE_SET_XTIME
(
i_˘ime
, 
öode
, 
oi
->
øw_öode
);

5170 
	`PXT4_INODE_SET_XTIME
(
i_mtime
, 
öode
, 
oi
->
øw_öode
);

5171 
	`PXT4_INODE_SET_XTIME
(
i_©ime
, 
öode
, 
oi
->
øw_öode
);

5172 
	`pxt4_öode_csum_£t
(
öode
, 
oi
->
øw_öode
, 
ei
);

5173 
	`•ö_u∆ock
(&
ei
->
i_øw_lock
);

5174 
	`åa˚_pxt4_Ÿhî_öode_upd©e_time
(
öode
, 
oi
->
‹ig_öo
);

5177 
	`•ö_u∆ock
(&
öode
->
i_lock
);

5179 
	}
}

5185 
	$pxt4_upd©e_Ÿhî_öodes_time
(
su≥r_block
 *
sb
,

5186 
‹ig_öo
, *
buf
)

5188 
Ÿhî_öode
 
oi
;

5189 
öo
;

5190 
i
, 
öodes_≥r_block
 = 
	`PXT4_SB
(
sb
)->
s_öodes_≥r_block
;

5191 
öode_size
 = 
	`PXT4_INODE_SIZE
(
sb
);

5193 
oi
.
‹ig_öo
 = orig_ino;

5199 
öo
 = ((
‹ig_öo
 - 1Ë& ~(
öodes_≥r_block
 - 1)) + 1;

5200 
i
 = 0; i < 
öodes_≥r_block
; i++, 
öo
++, 
buf
 +
öode_size
) {

5201 i‡(
öo
 =
‹ig_öo
)

5203 
oi
.
øw_öode
 = (
pxt4_öode
 *Ë
buf
;

5204 (Ë
	`föd_öode_nowaô
(
sb
, 
öo
, 
Ÿhî_öode_m©ch
, &
oi
);

5206 
	}
}

5215 
	$pxt4_do_upd©e_öode
(
h™dÀ_t
 *
h™dÀ
,

5216 
öode
 *inode,

5217 
pxt4_ûoc
 *
ûoc
)

5219 
pxt4_öode
 *
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

5220 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5221 
buf„r_hód
 *
bh
 = 
ûoc
->bh;

5222 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5223 
îr
 = 0, 
rc
, 
block
;

5224 
√ed_d©async
 = 0, 
£t_œrge_fûe
 = 0;

5225 
uid_t
 
i_uid
;

5226 
gid_t
 
i_gid
;

5227 
¥ojid_t
 
i_¥ojid
;

5229 
	`•ö_lock
(&
ei
->
i_øw_lock
);

5233 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEW
))

5234 
	`mem£t
(
øw_öode
, 0, 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
);

5236 
øw_öode
->
i_mode
 = 
	`˝u_to_À16
(
öode
->i_mode);

5237 
i_uid
 = 
	`i_uid_ªad
(
öode
);

5238 
i_gid
 = 
	`i_gid_ªad
(
öode
);

5239 
i_¥ojid
 = 
	`‰om_k¥ojid
(&
öô_u£r_ns
, 
ei
->i_projid);

5240 i‡(!(
	`ã°_›t
(
öode
->
i_sb
, 
NO_UID32
))) {

5241 
øw_öode
->
i_uid_low
 = 
	`˝u_to_À16
(
	`low_16_bôs
(
i_uid
));

5242 
øw_öode
->
i_gid_low
 = 
	`˝u_to_À16
(
	`low_16_bôs
(
i_gid
));

5247 i‡(
ei
->
i_dtime
 && 
	`li°_em±y
(&ei->
i_‹ph™
)) {

5248 
øw_öode
->
i_uid_high
 = 0;

5249 
øw_öode
->
i_gid_high
 = 0;

5251 
øw_öode
->
i_uid_high
 =

5252 
	`˝u_to_À16
(
	`high_16_bôs
(
i_uid
));

5253 
øw_öode
->
i_gid_high
 =

5254 
	`˝u_to_À16
(
	`high_16_bôs
(
i_gid
));

5257 
øw_öode
->
i_uid_low
 = 
	`˝u_to_À16
(
	`fs_high2lowuid
(
i_uid
));

5258 
øw_öode
->
i_gid_low
 = 
	`˝u_to_À16
(
	`fs_high2lowgid
(
i_gid
));

5259 
øw_öode
->
i_uid_high
 = 0;

5260 
øw_öode
->
i_gid_high
 = 0;

5262 
øw_öode
->
i_löks_cou¡
 = 
	`˝u_to_À16
(
öode
->
i_∆ök
);

5264 
	`PXT4_INODE_SET_XTIME
(
i_˘ime
, 
öode
, 
øw_öode
);

5265 
	`PXT4_INODE_SET_XTIME
(
i_mtime
, 
öode
, 
øw_öode
);

5266 
	`PXT4_INODE_SET_XTIME
(
i_©ime
, 
öode
, 
øw_öode
);

5267 
	`PXT4_EINODE_SET_XTIME
(
i_¸time
, 
ei
, 
øw_öode
);

5269 
îr
 = 
	`pxt4_öode_blocks_£t
(
h™dÀ
, 
øw_öode
, 
ei
);

5270 i‡(
îr
) {

5271 
	`•ö_u∆ock
(&
ei
->
i_øw_lock
);

5272 
out_bªl£
;

5274 
øw_öode
->
i_dtime
 = 
	`˝u_to_À32
(
ei
->i_dtime);

5275 
øw_öode
->
i_Êags
 = 
	`˝u_to_À32
(
ei
->i_flags & 0xFFFFFFFF);

5276 i‡(
	`likñy
(!
	`ã°_›t2
(
öode
->
i_sb
, 
HURD_COMPAT
)))

5277 
øw_öode
->
i_fûe_a˛_high
 =

5278 
	`˝u_to_À16
(
ei
->
i_fûe_a˛
 >> 32);

5279 
øw_öode
->
i_fûe_a˛_lo
 = 
	`˝u_to_À32
(
ei
->
i_fûe_a˛
);

5280 i‡(
ei
->
i_disksize
 !
	`pxt4_isize
(
öode
->
i_sb
, 
øw_öode
)) {

5281 
	`pxt4_isize_£t
(
øw_öode
, 
ei
->
i_disksize
);

5282 
√ed_d©async
 = 1;

5284 i‡(
ei
->
i_disksize
 > 0x7fffffffULL) {

5285 i‡(!
	`pxt4_has_„©uª_œrge_fûe
(
sb
) ||

5286 
	`PXT4_SB
(
sb
)->
s_es
->
s_ªv_Àvñ
 ==

5287 
	`˝u_to_À32
(
PXT4_GOOD_OLD_REV
))

5288 
£t_œrge_fûe
 = 1;

5290 
øw_öode
->
i_gíî©i⁄
 = 
	`˝u_to_À32
(
öode
->i_generation);

5291 i‡(
	`S_ISCHR
(
öode
->
i_mode
Ë|| 
	`S_ISBLK
(inode->i_mode)) {

5292 i‡(
	`ﬁd_vÆid_dev
(
öode
->
i_rdev
)) {

5293 
øw_öode
->
i_block
[0] =

5294 
	`˝u_to_À32
(
	`ﬁd_ícode_dev
(
öode
->
i_rdev
));

5295 
øw_öode
->
i_block
[1] = 0;

5297 
øw_öode
->
i_block
[0] = 0;

5298 
øw_öode
->
i_block
[1] =

5299 
	`˝u_to_À32
(
	`√w_ícode_dev
(
öode
->
i_rdev
));

5300 
øw_öode
->
i_block
[2] = 0;

5302 } i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

5303 
block
 = 0; block < 
PXT4_N_BLOCKS
; block++)

5304 
øw_öode
->
i_block
[
block
] = 
ei
->
i_d©a
[block];

5307 i‡(
	`likñy
(!
	`ã°_›t2
(
öode
->
i_sb
, 
HURD_COMPAT
))) {

5308 
u64
 
ivîs
 = 
	`pxt4_öode_≥ek_ivîsi⁄
(
öode
);

5310 
øw_öode
->
i_disk_vîsi⁄
 = 
	`˝u_to_À32
(
ivîs
);

5311 i‡(
ei
->
i_exåa_isize
) {

5312 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_vîsi⁄_hi
))

5313 
øw_öode
->
i_vîsi⁄_hi
 =

5314 
	`˝u_to_À32
(
ivîs
 >> 32);

5315 
øw_öode
->
i_exåa_isize
 =

5316 
	`˝u_to_À16
(
ei
->
i_exåa_isize
);

5320 
	`BUG_ON
(!
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
) &&

5321 
i_¥ojid
 !
PXT4_DEF_PROJID
);

5323 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

5324 
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¥ojid
))

5325 
øw_öode
->
i_¥ojid
 = 
	`˝u_to_À32
(i_projid);

5327 
	`pxt4_öode_csum_£t
(
öode
, 
øw_öode
, 
ei
);

5328 
	`•ö_u∆ock
(&
ei
->
i_øw_lock
);

5329 i‡(
öode
->
i_sb
->
s_Êags
 & 
SB_LAZYTIME
)

5330 
	`pxt4_upd©e_Ÿhî_öodes_time
(
öode
->
i_sb
, inode->
i_öo
,

5331 
bh
->
b_d©a
);

5333 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

5334 
rc
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

5335 i‡(!
îr
)

5336 
îr
 = 
rc
;

5337 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NEW
);

5338 i‡(
£t_œrge_fûe
) {

5339 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get writeáccess");

5340 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
);

5341 i‡(
îr
)

5342 
out_bªl£
;

5343 
	`pxt4_£t_„©uª_œrge_fûe
(
sb
);

5344 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

5345 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

5347 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 
√ed_d©async
);

5348 
out_bªl£
:

5349 
	`bªl£
(
bh
);

5350 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

5351  
îr
;

5352 
	}
}

5388 
	$pxt4_wrôe_öode
(
öode
 *öode, 
wrôeback_c⁄åﬁ
 *
wbc
)

5390 
îr
;

5392 i‡(
	`WARN_ON_ONCE
(
cuºít
->
Êags
 & 
PF_MEMALLOC
) ||

5393 
	`sb_rd⁄ly
(
öode
->
i_sb
))

5396 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

5397  -
EIO
;

5399 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
) {

5400 i‡(
	`pxt4_jou∫Æ_cuºít_h™dÀ
()) {

5401 
	`jbd_debug
(1, "calledÑecursively,Çon-PF_MEMALLOC!\n");

5402 
	`dump_°ack
();

5403  -
EIO
;

5411 i‡(
wbc
->
sync_mode
 !
WB_SYNC_ALL
 || wbc->
f‹_sync
)

5414 
îr
 = 
	`jbd3_com∂ëe_å™ß˘i⁄
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
,

5415 
	`PXT4_I
(
öode
)->
i_sync_tid
);

5417 
pxt4_ûoc
 
ûoc
;

5419 
îr
 = 
	`__pxt4_gë_öode_loc
(
öode
, &
ûoc
, 0);

5420 i‡(
îr
)

5421  
îr
;

5426 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
 && !wbc->
f‹_sync
)

5427 
	`sync_dúty_buf„r
(
ûoc
.
bh
);

5428 i‡(
	`buf„r_ªq
(
ûoc
.
bh
Ë&& !
	`buf„r_u±od©e
(iloc.bh)) {

5429 
	`PXT4_ERROR_INODE_BLOCK
(
öode
, 
ûoc
.
bh
->
b_blockƒ
,

5431 
îr
 = -
EIO
;

5433 
	`bªl£
(
ûoc
.
bh
);

5435  
îr
;

5436 
	}
}

5443 
	$pxt4_waô_f‹_èû_∑ge_commô
(
öode
 *inode)

5445 
∑ge
 *page;

5446 
off£t
;

5447 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

5448 
tid_t
 
commô_tid
 = 0;

5449 
ªt
;

5451 
off£t
 = 
öode
->
i_size
 & (
PAGE_SIZE
 - 1);

5457 i‡(
off£t
 > 
PAGE_SIZE
 - 
	`i_blocksize
(
öode
))

5460 
∑ge
 = 
	`föd_lock_∑ge
(
öode
->
i_m≠pög
,

5461 
öode
->
i_size
 >> 
PAGE_SHIFT
);

5462 i‡(!
∑ge
)

5464 
ªt
 = 
	`__pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
, 
off£t
,

5465 
PAGE_SIZE
 - 
off£t
);

5466 
	`u∆ock_∑ge
(
∑ge
);

5467 
	`put_∑ge
(
∑ge
);

5468 i‡(
ªt
 !-
EBUSY
)

5470 
commô_tid
 = 0;

5471 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

5472 i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
)

5473 
commô_tid
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
->
t_tid
;

5474 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

5475 i‡(
commô_tid
)

5476 
	`jbd3_log_waô_commô
(
jou∫Æ
, 
commô_tid
);

5478 
	}
}

5504 
	$pxt4_£èâr
(
díåy
 *díåy, 
üâr
 *
©å
)

5506 
öode
 *öodê
	`d_öode
(
díåy
);

5507 
îr‹
, 
rc
 = 0;

5508 
‹ph™
 = 0;

5509 c⁄° 
ü_vÆid
 = 
©å
->ia_valid;

5511 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

5512  -
EIO
;

5514 i‡(
	`u∆ikñy
(
	`IS_IMMUTABLE
(
öode
)))

5515  -
EPERM
;

5517 i‡(
	`u∆ikñy
(
	`IS_APPEND
(
öode
) &&

5518 (
ü_vÆid
 & (
ATTR_MODE
 | 
ATTR_UID
 |

5519 
ATTR_GID
 | 
ATTR_TIMES_SET
))))

5520  -
EPERM
;

5522 
îr‹
 = 
	`£èâr_¥ï¨e
(
díåy
, 
©å
);

5523 i‡(
îr‹
)

5524  
îr‹
;

5526 
îr‹
 = 
	`fs¸y±_¥ï¨e_£èâr
(
díåy
, 
©å
);

5527 i‡(
îr‹
)

5528  
îr‹
;

5530 
îr‹
 = 
	`fsvîôy_¥ï¨e_£èâr
(
díåy
, 
©å
);

5531 i‡(
îr‹
)

5532  
îr‹
;

5534 i‡(
	`is_quŸa_modifiˇti⁄
(
öode
, 
©å
)) {

5535 
îr‹
 = 
	`dquŸ_öôülize
(
öode
);

5536 i‡(
îr‹
)

5537  
îr‹
;

5539 i‡((
ü_vÆid
 & 
ATTR_UID
 && !
	`uid_eq
(
©å
->
ü_uid
, 
öode
->
i_uid
)) ||

5540 (
ü_vÆid
 & 
ATTR_GID
 && !
	`gid_eq
(
©å
->
ü_gid
, 
öode
->
i_gid
))) {

5541 
h™dÀ_t
 *
h™dÀ
;

5545 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
,

5546 (
	`PXT4_MAXQUOTAS_INIT_BLOCKS
(
öode
->
i_sb
) +

5547 
	`PXT4_MAXQUOTAS_DEL_BLOCKS
(
öode
->
i_sb
)) + 3);

5548 i‡(
	`IS_ERR
(
h™dÀ
)) {

5549 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

5550 
îr_out
;

5556 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5557 
îr‹
 = 
	`dquŸ_å™s„r
(
öode
, 
©å
);

5558 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5560 i‡(
îr‹
) {

5561 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5562  
îr‹
;

5566 i‡(
©å
->
ü_vÆid
 & 
ATTR_UID
)

5567 
öode
->
i_uid
 = 
©å
->
ü_uid
;

5568 i‡(
©å
->
ü_vÆid
 & 
ATTR_GID
)

5569 
öode
->
i_gid
 = 
©å
->
ü_gid
;

5570 
îr‹
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5571 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5574 i‡(
©å
->
ü_vÆid
 & 
ATTR_SIZE
) {

5575 
h™dÀ_t
 *
h™dÀ
;

5576 
loff_t
 
ﬁdsize
 = 
öode
->
i_size
;

5577 
shrök
 = (
©å
->
ü_size
 < 
öode
->
i_size
);

5579 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

5580 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

5582 i‡(
©å
->
ü_size
 > 
sbi
->
s_bôm≠_maxbyãs
)

5583  -
EFBIG
;

5585 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

5586  -
EINVAL
;

5588 i‡(
	`IS_I_VERSION
(
öode
Ë&& 
©å
->
ü_size
 !öode->
i_size
)

5589 
	`öode_öc_ivîsi⁄
(
öode
);

5591 i‡(
shrök
) {

5592 i‡(
	`pxt4_should_‹dî_d©a
(
öode
)) {

5593 
îr‹
 = 
	`pxt4_begö_‹dîed_åunˇã
(
öode
,

5594 
©å
->
ü_size
);

5595 i‡(
îr‹
)

5596 
îr_out
;

5602 
	`öode_dio_waô
(
öode
);

5605 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5607 
rc
 = 
	`pxt4_bªak_œyouts
(
öode
);

5608 i‡(
rc
) {

5609 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5610  
rc
;

5613 i‡(
©å
->
ü_size
 !
öode
->
i_size
) {

5614 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 3);

5615 i‡(
	`IS_ERR
(
h™dÀ
)) {

5616 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

5617 
out_mm≠_£m
;

5619 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë&& 
shrök
) {

5620 
îr‹
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

5621 
‹ph™
 = 1;

5627 i‡(!
shrök
) {

5628 
öode
->
i_mtime
 = 
	`cuºít_time
(inode);

5629 
öode
->
i_˘ime
 = inode->
i_mtime
;

5631 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5632 
	`PXT4_I
(
öode
)->
i_disksize
 = 
©å
->
ü_size
;

5633 
rc
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5634 i‡(!
îr‹
)

5635 
îr‹
 = 
rc
;

5641 i‡(!
îr‹
)

5642 
	`i_size_wrôe
(
öode
, 
©å
->
ü_size
);

5643 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5644 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5645 i‡(
îr‹
)

5646 
out_mm≠_£m
;

5647 i‡(!
shrök
) {

5648 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁdsize
,

5649 
öode
->
i_size
);

5650 } i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

5651 
	`pxt4_waô_f‹_èû_∑ge_commô
(
öode
);

5659 
	`åunˇã_∑geˇche
(
öode
, inode->
i_size
);

5664 i‡(
©å
->
ü_size
 <
ﬁdsize
) {

5665 
rc
 = 
	`pxt4_åunˇã
(
öode
);

5666 i‡(
rc
)

5667 
îr‹
 = 
rc
;

5669 
out_mm≠_£m
:

5670 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5673 i‡(!
îr‹
) {

5674 
	`£èâr_c›y
(
öode
, 
©å
);

5675 
	`m¨k_öode_dúty
(
öode
);

5682 i‡(
‹ph™
 && 
öode
->
i_∆ök
)

5683 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

5685 i‡(!
îr‹
 && (
ü_vÆid
 & 
ATTR_MODE
))

5686 
rc
 = 
	`posix_a˛_chmod
(
öode
, inode->
i_mode
);

5688 
îr_out
:

5689 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr‹
);

5690 i‡(!
îr‹
)

5691 
îr‹
 = 
rc
;

5692  
îr‹
;

5693 
	}
}

5695 
	$pxt4_gë©å
(c⁄° 
∑th
 *∑th, 
k°©
 *
°©
,

5696 
u32
 
ªque°_mask
, 
quîy_Êags
)

5698 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

5699 
pxt4_öode
 *
øw_öode
;

5700 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5701 
Êags
;

5703 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¸time
)) {

5704 
°©
->
ªsu…_mask
 |
STATX_BTIME
;

5705 
°©
->
btime
.
tv_£c
 = 
ei
->
i_¸time
.tv_sec;

5706 
°©
->
btime
.
tv_n£c
 = 
ei
->
i_¸time
.tv_nsec;

5709 
Êags
 = 
ei
->
i_Êags
 & 
PXT4_FL_USER_VISIBLE
;

5710 i‡(
Êags
 & 
PXT4_APPEND_FL
)

5711 
°©
->
©åibuãs
 |
STATX_ATTR_APPEND
;

5712 i‡(
Êags
 & 
PXT4_COMPR_FL
)

5713 
°©
->
©åibuãs
 |
STATX_ATTR_COMPRESSED
;

5714 i‡(
Êags
 & 
PXT4_ENCRYPT_FL
)

5715 
°©
->
©åibuãs
 |
STATX_ATTR_ENCRYPTED
;

5716 i‡(
Êags
 & 
PXT4_IMMUTABLE_FL
)

5717 
°©
->
©åibuãs
 |
STATX_ATTR_IMMUTABLE
;

5718 i‡(
Êags
 & 
PXT4_NODUMP_FL
)

5719 
°©
->
©åibuãs
 |
STATX_ATTR_NODUMP
;

5721 
°©
->
©åibuãs_mask
 |(
STATX_ATTR_APPEND
 |

5722 
STATX_ATTR_COMPRESSED
 |

5723 
STATX_ATTR_ENCRYPTED
 |

5724 
STATX_ATTR_IMMUTABLE
 |

5725 
STATX_ATTR_NODUMP
);

5727 
	`gíîic_fûœâr
(
öode
, 
°©
);

5729 
	}
}

5731 
	$pxt4_fûe_gë©å
(c⁄° 
∑th
 *∑th, 
k°©
 *
°©
,

5732 
u32
 
ªque°_mask
, 
quîy_Êags
)

5734 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

5735 
u64
 
dñÆloc_blocks
;

5737 
	`pxt4_gë©å
(
∑th
, 
°©
, 
ªque°_mask
, 
quîy_Êags
);

5745 i‡(
	`u∆ikñy
(
	`pxt4_has_ölöe_d©a
(
öode
)))

5746 
°©
->
blocks
 +(°©->
size
 + 511) >> 9;

5758 
dñÆloc_blocks
 = 
	`PXT4_C2B
(
	`PXT4_SB
(
öode
->
i_sb
),

5759 
	`PXT4_I
(
öode
)->
i_ª£rved_d©a_blocks
);

5760 
°©
->
blocks
 +
dñÆloc_blocks
 << (
öode
->
i_sb
->
s_blocksize_bôs
 - 9);

5762 
	}
}

5764 
	$pxt4_ödex_å™s_blocks
(
öode
 *öode, 
lblocks
,

5765 
≥xã¡s
)

5767 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

5768  
	`pxt4_öd_å™s_blocks
(
öode
, 
lblocks
);

5769  
	`pxt4_ext_ödex_å™s_blocks
(
öode
, 
≥xã¡s
);

5770 
	}
}

5783 
	$pxt4_mëa_å™s_blocks
(
öode
 *öode, 
lblocks
,

5784 
≥xã¡s
)

5786 
pxt4_group_t
 
groups
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
öode
->
i_sb
);

5787 
gdpblocks
;

5788 
idxblocks
;

5789 
ªt
 = 0;

5795 
idxblocks
 = 
	`pxt4_ödex_å™s_blocks
(
öode
, 
lblocks
, 
≥xã¡s
);

5797 
ªt
 = 
idxblocks
;

5803 
groups
 = 
idxblocks
 + 
≥xã¡s
;

5804 
gdpblocks
 = 
groups
;

5805 i‡(
groups
 > 
ngroups
)

5806 
groups
 = 
ngroups
;

5807 i‡(
groups
 > 
	`PXT4_SB
(
öode
->
i_sb
)->
s_gdb_cou¡
)

5808 
gdpblocks
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_gdb_cou¡
;

5811 
ªt
 +
groups
 + 
gdpblocks
;

5814 
ªt
 +
	`PXT4_META_TRANS_BLOCKS
(
öode
->
i_sb
);

5816  
ªt
;

5817 
	}
}

5829 
	$pxt4_wrôïage_å™s_blocks
(
öode
 *inode)

5831 
bµ
 = 
	`pxt4_jou∫Æ_blocks_≥r_∑ge
(
öode
);

5832 
ªt
;

5834 
ªt
 = 
	`pxt4_mëa_å™s_blocks
(
öode
, 
bµ
, bpp);

5837 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

5838 
ªt
 +
bµ
;

5839  
ªt
;

5840 
	}
}

5851 
	$pxt4_chunk_å™s_blocks
(
öode
 *öode, 
ƒblocks
)

5853  
	`pxt4_mëa_å™s_blocks
(
öode
, 
ƒblocks
, 1);

5854 
	}
}

5860 
	$pxt4_m¨k_ûoc_dúty
(
h™dÀ_t
 *
h™dÀ
,

5861 
öode
 *öode, 
pxt4_ûoc
 *
ûoc
)

5863 
îr
 = 0;

5865 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
)))) {

5866 
	`put_bh
(
ûoc
->
bh
);

5867  -
EIO
;

5869 i‡(
	`IS_I_VERSION
(
öode
))

5870 
	`öode_öc_ivîsi⁄
(
öode
);

5873 
	`gë_bh
(
ûoc
->
bh
);

5876 
îr
 = 
	`pxt4_do_upd©e_öode
(
h™dÀ
, 
öode
, 
ûoc
);

5877 
	`put_bh
(
ûoc
->
bh
);

5878  
îr
;

5879 
	}
}

5887 
	$pxt4_ª£rve_öode_wrôe
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

5888 
pxt4_ûoc
 *
ûoc
)

5890 
îr
;

5892 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

5893  -
EIO
;

5895 
îr
 = 
	`pxt4_gë_öode_loc
(
öode
, 
ûoc
);

5896 i‡(!
îr
) {

5897 
	`BUFFER_TRACE
(
ûoc
->
bh
, "get_write_access");

5898 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
->
bh
);

5899 i‡(
îr
) {

5900 
	`bªl£
(
ûoc
->
bh
);

5901 
ûoc
->
bh
 = 
NULL
;

5904 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

5905  
îr
;

5906 
	}
}

5908 
	$__pxt4_ex∑nd_exåa_isize
(
öode
 *inode,

5909 
√w_exåa_isize
,

5910 
pxt4_ûoc
 *
ûoc
,

5911 
h™dÀ_t
 *
h™dÀ
, *
no_ex∑nd
)

5913 
pxt4_öode
 *
øw_öode
;

5914 
pxt4_x©å_ibody_hódî
 *
hódî
;

5915 
îr‹
;

5917 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

5919 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

5922 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
) ||

5923 
hódî
->
h_magic
 !
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
)) {

5924 
	`mem£t
((*)
øw_öode
 + 
PXT4_GOOD_OLD_INODE_SIZE
 +

5925 
	`PXT4_I
(
öode
)->
i_exåa_isize
, 0,

5926 
√w_exåa_isize
 - 
	`PXT4_I
(
öode
)->
i_exåa_isize
);

5927 
	`PXT4_I
(
öode
)->
i_exåa_isize
 = 
√w_exåa_isize
;

5932 
îr‹
 = 
	`pxt4_ex∑nd_exåa_isize_ó
(
öode
, 
√w_exåa_isize
,

5933 
øw_öode
, 
h™dÀ
);

5934 i‡(
îr‹
) {

5938 *
no_ex∑nd
 = 1;

5941  
îr‹
;

5942 
	}
}

5948 
	$pxt4_åy_to_ex∑nd_exåa_isize
(
öode
 *inode,

5949 
√w_exåa_isize
,

5950 
pxt4_ûoc
 
ûoc
,

5951 
h™dÀ_t
 *
h™dÀ
)

5953 
no_ex∑nd
;

5954 
îr‹
;

5956 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
))

5957  -
EOVERFLOW
;

5968 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
) &&

5969 
	`jbd3_jou∫Æ_exãnd
(
h™dÀ
,

5970 
	`PXT4_DATA_TRANS_BLOCKS
(
öode
->
i_sb
)) != 0)

5971  -
ENOSPC
;

5973 i‡(
	`pxt4_wrôe_åylock_x©å
(
öode
, &
no_ex∑nd
) == 0)

5974  -
EBUSY
;

5976 
îr‹
 = 
	`__pxt4_ex∑nd_exåa_isize
(
öode
, 
√w_exåa_isize
, &
ûoc
,

5977 
h™dÀ
, &
no_ex∑nd
);

5978 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

5980  
îr‹
;

5981 
	}
}

5983 
	$pxt4_ex∑nd_exåa_isize
(
öode
 *inode,

5984 
√w_exåa_isize
,

5985 
pxt4_ûoc
 *
ûoc
)

5987 
h™dÀ_t
 *
h™dÀ
;

5988 
no_ex∑nd
;

5989 
îr‹
, 
rc
;

5991 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
)) {

5992 
	`bªl£
(
ûoc
->
bh
);

5993  -
EOVERFLOW
;

5996 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
,

5997 
	`PXT4_DATA_TRANS_BLOCKS
(
öode
->
i_sb
));

5998 i‡(
	`IS_ERR
(
h™dÀ
)) {

5999 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

6000 
	`bªl£
(
ûoc
->
bh
);

6001  
îr‹
;

6004 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

6006 
	`BUFFER_TRACE
(
ûoc
->
bh
, "get_write_access");

6007 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
->
bh
);

6008 i‡(
îr‹
) {

6009 
	`bªl£
(
ûoc
->
bh
);

6010 
out_°›
;

6013 
îr‹
 = 
	`__pxt4_ex∑nd_exåa_isize
(
öode
, 
√w_exåa_isize
, 
ûoc
,

6014 
h™dÀ
, &
no_ex∑nd
);

6016 
rc
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, 
ûoc
);

6017 i‡(!
îr‹
)

6018 
îr‹
 = 
rc
;

6020 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

6021 
out_°›
:

6022 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6023  
îr‹
;

6024 
	}
}

6039 
	$pxt4_m¨k_öode_dúty
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

6041 
pxt4_ûoc
 
ûoc
;

6042 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

6043 
îr
;

6045 
	`might_¶ìp
();

6046 
	`åa˚_pxt4_m¨k_öode_dúty
(
öode
, 
_RET_IP_
);

6047 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

6048 i‡(
îr
)

6049  
îr
;

6051 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 < 
sbi
->
s_w™t_exåa_isize
)

6052 
	`pxt4_åy_to_ex∑nd_exåa_isize
(
öode
, 
sbi
->
s_w™t_exåa_isize
,

6053 
ûoc
, 
h™dÀ
);

6055  
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

6056 
	}
}

6076 
	$pxt4_dúty_öode
(
öode
 *öode, 
Êags
)

6078 
h™dÀ_t
 *
h™dÀ
;

6080 i‡(
Êags
 =
I_DIRTY_TIME
)

6082 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

6083 i‡(
	`IS_ERR
(
h™dÀ
))

6084 
out
;

6086 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

6088 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6089 
out
:

6091 
	}
}

6093 
	$pxt4_ch™ge_öode_jou∫Æ_Êag
(
öode
 *öode, 
vÆ
)

6095 
jou∫Æ_t
 *
jou∫Æ
;

6096 
h™dÀ_t
 *
h™dÀ
;

6097 
îr
;

6098 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

6110 
jou∫Æ
 = 
	`PXT4_JOURNAL
(
öode
);

6111 i‡(!
jou∫Æ
)

6113 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

6114  -
EROFS
;

6117 
	`öode_dio_waô
(
öode
);

6127 i‡(
vÆ
) {

6128 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6129 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

6130 i‡(
îr
 < 0) {

6131 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6132  
îr
;

6136 
	`≥r˝u_down_wrôe
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

6137 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

6147 i‡(
vÆ
)

6148 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_JOURNAL_DATA
);

6150 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

6151 i‡(
îr
 < 0) {

6152 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

6153 
	`≥r˝u_up_wrôe
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

6154  
îr
;

6156 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_JOURNAL_DATA
);

6158 
	`pxt4_£t_a›s
(
öode
);

6160 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

6161 
	`≥r˝u_up_wrôe
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

6163 i‡(
vÆ
)

6164 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6168 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

6169 i‡(
	`IS_ERR
(
h™dÀ
))

6170  
	`PTR_ERR
(
h™dÀ
);

6172 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

6173 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

6174 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6175 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

6177  
îr
;

6178 
	}
}

6180 
	$pxt4_bh_unm≠≥d
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

6182  !
	`buf„r_m≠≥d
(
bh
);

6183 
	}
}

6185 
vm_Áu…_t
 
	$pxt4_∑ge_mkwrôe
(
vm_Áu…
 *
vmf
)

6187 
vm_¨ó_°ru˘
 *
vma
 = 
vmf
->vma;

6188 
∑ge
 *∑gê
vmf
->page;

6189 
loff_t
 
size
;

6190 
Àn
;

6191 
îr
;

6192 
vm_Áu…_t
 
ªt
;

6193 
fûe
 *fûê
vma
->
vm_fûe
;

6194 
öode
 *öodê
	`fûe_öode
(
fûe
);

6195 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

6196 
h™dÀ_t
 *
h™dÀ
;

6197 
gë_block_t
 *
gë_block
;

6198 
ªåõs
 = 0;

6200 i‡(
	`u∆ikñy
(
	`IS_IMMUTABLE
(
öode
)))

6201  
VM_FAULT_SIGBUS
;

6203 
	`sb_°¨t_∑geÁu…
(
öode
->
i_sb
);

6204 
	`fûe_upd©e_time
(
vma
->
vm_fûe
);

6206 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6208 
îr
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

6209 i‡(
îr
)

6210 
out_ªt
;

6213 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
) &&

6214 !
	`pxt4_should_jou∫Æ_d©a
(
öode
) &&

6215 !
	`pxt4_n⁄da_swôch
(
öode
->
i_sb
)) {

6217 
îr
 = 
	`block_∑ge_mkwrôe
(
vma
, 
vmf
,

6218 
pxt4_da_gë_block_¥ï
);

6219 } 
îr
 =-
ENOSPC
 &&

6220 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
));

6221 
out_ªt
;

6224 
	`lock_∑ge
(
∑ge
);

6225 
size
 = 
	`i_size_ªad
(
öode
);

6227 i‡(
∑ge
->
m≠pög
 !m≠pög || 
	`∑ge_off£t
’ageË> 
size
) {

6228 
	`u∆ock_∑ge
(
∑ge
);

6229 
ªt
 = 
VM_FAULT_NOPAGE
;

6230 
out
;

6233 i‡(
∑ge
->
ödex
 =
size
 >> 
PAGE_SHIFT
)

6234 
Àn
 = 
size
 & ~
PAGE_MASK
;

6236 
Àn
 = 
PAGE_SIZE
;

6241 i‡(
	`∑ge_has_buf„rs
(
∑ge
)) {

6242 i‡(!
	`pxt4_wÆk_∑ge_buf„rs
(
NULL
, 
	`∑ge_buf„rs
(
∑ge
),

6243 0, 
Àn
, 
NULL
,

6244 
pxt4_bh_unm≠≥d
)) {

6246 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

6247 
ªt
 = 
VM_FAULT_LOCKED
;

6248 
out
;

6251 
	`u∆ock_∑ge
(
∑ge
);

6253 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

6254 
gë_block
 = 
pxt4_gë_block_unwrôãn
;

6256 
gë_block
 = 
pxt4_gë_block
;

6257 
ªåy_Æloc
:

6258 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
,

6259 
	`pxt4_wrôïage_å™s_blocks
(
öode
));

6260 i‡(
	`IS_ERR
(
h™dÀ
)) {

6261 
ªt
 = 
VM_FAULT_SIGBUS
;

6262 
out
;

6264 
îr
 = 
	`block_∑ge_mkwrôe
(
vma
, 
vmf
, 
gë_block
);

6265 i‡(!
îr
 && 
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

6266 i‡(
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
), 0,

6267 
PAGE_SIZE
, 
NULL
, 
do_jou∫Æ_gë_wrôe_ac˚ss
)) {

6268 
	`u∆ock_∑ge
(
∑ge
);

6269 
ªt
 = 
VM_FAULT_SIGBUS
;

6270 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6271 
out
;

6273 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

6275 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6276 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

6277 
ªåy_Æloc
;

6278 
out_ªt
:

6279 
ªt
 = 
	`block_∑ge_mkwrôe_ªtu∫
(
îr
);

6280 
out
:

6281 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6282 
	`sb_íd_∑geÁu…
(
öode
->
i_sb
);

6283  
ªt
;

6284 
	}
}

6286 
vm_Áu…_t
 
	$pxt4_fûem≠_Áu…
(
vm_Áu…
 *
vmf
)

6288 
öode
 *öodê
	`fûe_öode
(
vmf
->
vma
->
vm_fûe
);

6289 
vm_Áu…_t
 
ªt
;

6291 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6292 
ªt
 = 
	`fûem≠_Áu…
(
vmf
);

6293 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6295  
ªt
;

6296 
	}
}

	@ioctl.c

11 
	~<löux/fs.h
>

12 
	~<löux/ˇ∑bûôy.h
>

13 
	~<löux/time.h
>

14 
	~<löux/com∑t.h
>

15 
	~<löux/mou¡.h
>

16 
	~<löux/fûe.h
>

17 
	~<löux/quŸa›s.h
>

18 
	~<löux/øndom.h
>

19 
	~<löux/uuid.h
>

20 
	~<löux/uac˚ss.h
>

21 
	~<löux/dñay.h
>

22 
	~<löux/ivîsi⁄.h
>

23 
	~"pxt4_jbd3.h
"

24 
	~"pxt4.h
"

25 
	~<löux/fsm≠.h
>

26 
	~"fsm≠.h
"

27 
	~<åa˚/evíts/pxt4.h
>

37 
	$memsw≠
(*
a
, *
b
, 
size_t
 
Àn
)

39 *
≠
, *
bp
;

41 
≠
 = (*)
a
;

42 
bp
 = (*)
b
;

43 
Àn
-- > 0) {

44 
	`sw≠
(*
≠
, *
bp
);

45 
≠
++;

46 
bp
++;

48 
	}
}

61 
	$sw≠_öode_d©a
(
öode
 *
öode1
, öodê*
öode2
)

63 
loff_t
 
isize
;

64 
pxt4_öode_öfo
 *
ei1
;

65 
pxt4_öode_öfo
 *
ei2
;

66 
tmp
;

68 
ei1
 = 
	`PXT4_I
(
öode1
);

69 
ei2
 = 
	`PXT4_I
(
öode2
);

71 
	`sw≠
(
öode1
->
i_vîsi⁄
, 
öode2
->i_version);

72 
	`sw≠
(
öode1
->
i_©ime
, 
öode2
->i_atime);

73 
	`sw≠
(
öode1
->
i_mtime
, 
öode2
->i_mtime);

75 
	`memsw≠
(
ei1
->
i_d©a
, 
ei2
->i_data, (ei1->i_data));

76 
tmp
 = 
ei1
->
i_Êags
 & 
PXT4_FL_SHOULD_SWAP
;

77 
ei1
->
i_Êags
 = (
ei2
->i_Êag†& 
PXT4_FL_SHOULD_SWAP
) |

78 (
ei1
->
i_Êags
 & ~
PXT4_FL_SHOULD_SWAP
);

79 
ei2
->
i_Êags
 = 
tmp
 | (ei2->i_Êag†& ~
PXT4_FL_SHOULD_SWAP
);

80 
	`sw≠
(
ei1
->
i_disksize
, 
ei2
->i_disksize);

81 
	`pxt4_es_ªmove_exã¡
(
öode1
, 0, 
EXT_MAX_BLOCKS
);

82 
	`pxt4_es_ªmove_exã¡
(
öode2
, 0, 
EXT_MAX_BLOCKS
);

84 
isize
 = 
	`i_size_ªad
(
öode1
);

85 
	`i_size_wrôe
(
öode1
, 
	`i_size_ªad
(
öode2
));

86 
	`i_size_wrôe
(
öode2
, 
isize
);

87 
	}
}

89 
	$ª£t_öode_£ed
(
öode
 *inode)

91 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

92 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

93 
__À32
 
öum
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

94 
__À32
 
gí
 = 
	`˝u_to_À32
(
öode
->
i_gíî©i⁄
);

95 
__u32
 
csum
;

97 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

100 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
öum
, (inum));

101 
ei
->
i_csum_£ed
 = 
	`pxt4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
gí
, (gen));

102 
	}
}

113 
	$sw≠_öode_boŸ_lﬂdî
(
su≥r_block
 *
sb
,

114 
öode
 *inode)

116 
h™dÀ_t
 *
h™dÀ
;

117 
îr
;

118 
öode
 *
öode_bl
;

119 
pxt4_öode_öfo
 *
ei_bl
;

120 
qsize_t
 
size
, 
size_bl
, 
diff
;

121 
blk˙t_t
 
blocks
;

122 
byãs
;

124 
öode_bl
 = 
	`pxt4_igë
(
sb
, 
PXT4_BOOT_LOADER_INO
, 
PXT4_IGET_SPECIAL
);

125 i‡(
	`IS_ERR
(
öode_bl
))

126  
	`PTR_ERR
(
öode_bl
);

127 
ei_bl
 = 
	`PXT4_I
(
öode_bl
);

131 
	`lock_two_n⁄dúe˘‹õs
(
öode
, 
öode_bl
);

133 i‡(
öode
->
i_∆ök
 !1 || !
	`S_ISREG
(öode->
i_mode
) ||

134 
	`IS_SWAPFILE
(
öode
Ë|| 
	`IS_ENCRYPTED
(inode) ||

135 (
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_JOURNAL_DATA_FL
) ||

136 
	`pxt4_has_ölöe_d©a
(
öode
)) {

137 
îr
 = -
EINVAL
;

138 
jou∫Æ_îr_out
;

141 i‡(
	`IS_RDONLY
(
öode
Ë|| 
	`IS_APPEND
(öodeË|| 
	`IS_IMMUTABLE
(inode) ||

142 !
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
Ë|| !
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
)) {

143 
îr
 = -
EPERM
;

144 
jou∫Æ_îr_out
;

147 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

148 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

149 i‡(
îr
)

150 
îr_out
;

152 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode_bl
->
i_m≠pög
);

153 i‡(
îr
)

154 
îr_out
;

157 
	`öode_dio_waô
(
öode
);

158 
	`öode_dio_waô
(
öode_bl
);

160 
	`åunˇã_öode_∑ges
(&
öode
->
i_d©a
, 0);

161 
	`åunˇã_öode_∑ges
(&
öode_bl
->
i_d©a
, 0);

163 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode_bl
, 
PXT4_HT_MOVE_EXTENTS
, 2);

164 i‡(
	`IS_ERR
(
h™dÀ
)) {

165 
îr
 = -
EINVAL
;

166 
îr_out
;

170 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
öode
, 
öode_bl
);

172 i‡(
öode_bl
->
i_∆ök
 == 0) {

174 
	`£t_∆ök
(
öode_bl
, 1);

175 
	`i_uid_wrôe
(
öode_bl
, 0);

176 
	`i_gid_wrôe
(
öode_bl
, 0);

177 
öode_bl
->
i_Êags
 = 0;

178 
ei_bl
->
i_Êags
 = 0;

179 
	`öode_£t_ivîsi⁄
(
öode_bl
, 1);

180 
	`i_size_wrôe
(
öode_bl
, 0);

181 
öode_bl
->
i_mode
 = 
S_IFREG
;

182 i‡(
	`pxt4_has_„©uª_exã¡s
(
sb
)) {

183 
	`pxt4_£t_öode_Êag
(
öode_bl
, 
PXT4_INODE_EXTENTS
);

184 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
öode_bl
);

186 
	`mem£t
(
ei_bl
->
i_d©a
, 0, (ei_bl->i_data));

189 
îr
 = 
	`dquŸ_öôülize
(
öode
);

190 i‡(
îr
)

191 
îr_out1
;

193 
size
 = (
qsize_t
)(
öode
->
i_blocks
Ë* (1 << 9Ë+ inode->
i_byãs
;

194 
size_bl
 = (
qsize_t
)(
öode_bl
->
i_blocks
Ë* (1 << 9Ë+ inode_bl->
i_byãs
;

195 
diff
 = 
size
 - 
size_bl
;

196 
	`sw≠_öode_d©a
(
öode
, 
öode_bl
);

198 
öode
->
i_˘ime
 = 
öode_bl
->i_˘imê
	`cuºít_time
(inode);

200 
öode
->
i_gíî©i⁄
 = 
	`¥™dom_u32
();

201 
öode_bl
->
i_gíî©i⁄
 = 
	`¥™dom_u32
();

202 
	`ª£t_öode_£ed
(
öode
);

203 
	`ª£t_öode_£ed
(
öode_bl
);

205 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

207 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

208 i‡(
îr
 < 0) {

210 
	`pxt4_w¨nög
(
öode
->
i_sb
,

212 
öode
->
i_öo
, 
îr
);

214 
	`sw≠_öode_d©a
(
öode
, 
öode_bl
);

215 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

216 
îr_out1
;

219 
blocks
 = 
öode_bl
->
i_blocks
;

220 
byãs
 = 
öode_bl
->
i_byãs
;

221 
öode_bl
->
i_blocks
 = 
öode
->i_blocks;

222 
öode_bl
->
i_byãs
 = 
öode
->i_bytes;

223 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode_bl
);

224 i‡(
îr
 < 0) {

226 
	`pxt4_w¨nög
(
öode_bl
->
i_sb
,

228 
öode_bl
->
i_öo
, 
îr
);

229 
ªvît
;

233 i‡(
diff
 > 0)

234 
	`dquŸ_‰ì_•a˚
(
öode
, 
diff
);

236 
îr
 = 
	`dquŸ_Æloc_•a˚
(
öode
, -1 * 
diff
);

238 i‡(
îr
 < 0) {

239 
ªvît
:

241 
öode_bl
->
i_blocks
 = 
blocks
;

242 
öode_bl
->
i_byãs
 = 
byãs
;

243 
	`sw≠_öode_d©a
(
öode
, 
öode_bl
);

244 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

245 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode_bl
);

248 
îr_out1
:

249 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

250 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
öode
, 
öode_bl
);

252 
îr_out
:

253 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

254 
jou∫Æ_îr_out
:

255 
	`u∆ock_two_n⁄dúe˘‹õs
(
öode
, 
öode_bl
);

256 
	`ùut
(
öode_bl
);

257  
îr
;

258 
	}
}

260 #ifde‡
CONFIG_FS_ENCRYPTION


261 
	$uuid_is_zîo
(
__u8
 
u
[16])

263 
i
;

265 
i
 = 0; i < 16; i++)

266 i‡(
u
[
i
])

269 
	}
}

277 
	$pxt4_io˘l_check_immuèbÀ
(
öode
 *öode, 
__u32
 
√w_¥ojid
,

278 
Êags
)

280 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

281 
ﬁdÊags
 = 
ei
->
i_Êags
;

283 i‡(!(
ﬁdÊags
 & 
PXT4_IMMUTABLE_FL
Ë|| !(
Êags
 & PXT4_IMMUTABLE_FL))

286 i‡((
ﬁdÊags
 & ~
PXT4_IMMUTABLE_FL
Ë!(
Êags
 & ~PXT4_IMMUTABLE_FL))

287  -
EPERM
;

288 i‡(
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
) &&

289 
	`__k¥ojid_vÆ
(
ei
->
i_¥ojid
Ë!
√w_¥ojid
)

290  -
EPERM
;

293 
	}
}

295 
	$pxt4_io˘l_£tÊags
(
öode
 *inode,

296 
Êags
)

298 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

299 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

300 
îr
 = -
EPERM
, 
migøã
 = 0;

301 
pxt4_ûoc
 
ûoc
;

302 
ﬁdÊags
, 
mask
, 
i
;

303 
jÊag
;

304 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

307 i‡(
	`pxt4_is_quŸa_fûe
(
öode
))

308 
Êags_out
;

310 
ﬁdÊags
 = 
ei
->
i_Êags
;

313 
jÊag
 = 
Êags
 & 
PXT4_JOURNAL_DATA_FL
;

315 
îr
 = 
	`vfs_ioc_£tÊags_¥ï¨e
(
öode
, 
ﬁdÊags
, 
Êags
);

316 i‡(
îr
)

317 
Êags_out
;

323 i‡((
jÊag
 ^ 
ﬁdÊags
Ë& (
PXT4_JOURNAL_DATA_FL
)) {

324 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
))

325 
Êags_out
;

327 i‡((
Êags
 ^ 
ﬁdÊags
Ë& 
PXT4_EXTENTS_FL
)

328 
migøã
 = 1;

330 i‡(
Êags
 & 
PXT4_EOFBLOCKS_FL
) {

332 i‡(!(
ﬁdÊags
 & 
PXT4_EOFBLOCKS_FL
)) {

333 
îr
 = -
EOPNOTSUPP
;

334 
Êags_out
;

336 } i‡(
ﬁdÊags
 & 
PXT4_EOFBLOCKS_FL
) {

337 
îr
 = 
	`pxt4_åunˇã
(
öode
);

338 i‡(
îr
)

339 
Êags_out
;

342 i‡((
Êags
 ^ 
ﬁdÊags
Ë& 
PXT4_CASEFOLD_FL
) {

343 i‡(!
	`pxt4_has_„©uª_ˇ£fﬁd
(
sb
)) {

344 
îr
 = -
EOPNOTSUPP
;

345 
Êags_out
;

348 i‡(!
	`S_ISDIR
(
öode
->
i_mode
)) {

349 
îr
 = -
ENOTDIR
;

350 
Êags_out
;

353 i‡(!
	`pxt4_em±y_dú
(
öode
)) {

354 
îr
 = -
ENOTEMPTY
;

355 
Êags_out
;

365 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë&& !
	`IS_IMMUTABLE
(inode) &&

366 (
Êags
 & 
PXT4_IMMUTABLE_FL
)) {

367 
	`öode_dio_waô
(
öode
);

368 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

369 i‡(
îr
)

370 
Êags_out
;

373 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

374 i‡(
	`IS_ERR
(
h™dÀ
)) {

375 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

376 
Êags_out
;

378 i‡(
	`IS_SYNC
(
öode
))

379 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

380 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

381 i‡(
îr
)

382 
Êags_îr
;

384 
i
 = 0, 
mask
 = 1; i < 32; i++, mask <<= 1) {

385 i‡(!(
mask
 & 
PXT4_FL_USER_MODIFIABLE
))

388 i‡(
mask
 =
PXT4_JOURNAL_DATA_FL
 || mask =
PXT4_EXTENTS_FL
)

390 i‡(
mask
 & 
Êags
)

391 
	`pxt4_£t_öode_Êag
(
öode
, 
i
);

393 
	`pxt4_˛ór_öode_Êag
(
öode
, 
i
);

396 
	`pxt4_£t_öode_Êags
(
öode
);

397 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

399 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

400 
Êags_îr
:

401 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

402 i‡(
îr
)

403 
Êags_out
;

405 i‡((
jÊag
 ^ 
ﬁdÊags
Ë& (
PXT4_JOURNAL_DATA_FL
)) {

410 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DAX
)) {

411 
îr
 = -
EBUSY
;

412 
Êags_out
;

415 
îr
 = 
	`pxt4_ch™ge_öode_jou∫Æ_Êag
(
öode
, 
jÊag
);

416 i‡(
îr
)

417 
Êags_out
;

419 i‡(
migøã
) {

420 i‡(
Êags
 & 
PXT4_EXTENTS_FL
)

421 
îr
 = 
	`pxt4_ext_migøã
(
öode
);

423 
îr
 = 
	`pxt4_öd_migøã
(
öode
);

426 
Êags_out
:

427  
îr
;

428 
	}
}

430 #ifde‡
CONFIG_QUOTA


431 
	$pxt4_io˘l_£çroje˘
(
fûe
 *
fûp
, 
__u32
 
¥ojid
)

433 
öode
 *öodê
	`fûe_öode
(
fûp
);

434 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

435 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

436 
îr
, 
rc
;

437 
h™dÀ_t
 *
h™dÀ
;

438 
k¥ojid_t
 
k¥ojid
;

439 
pxt4_ûoc
 
ûoc
;

440 
pxt4_öode
 *
øw_öode
;

441 
dquŸ
 *
å™s„r_to
[
MAXQUOTAS
] = { };

443 i‡(!
	`pxt4_has_„©uª_¥oje˘
(
sb
)) {

444 i‡(
¥ojid
 !
PXT4_DEF_PROJID
)

445  -
EOPNOTSUPP
;

450 i‡(
	`PXT4_INODE_SIZE
(
sb
Ë<
PXT4_GOOD_OLD_INODE_SIZE
)

451  -
EOPNOTSUPP
;

453 
k¥ojid
 = 
	`make_k¥ojid
(&
öô_u£r_ns
, (
¥ojid_t
)
¥ojid
);

455 i‡(
	`¥ojid_eq
(
k¥ojid
, 
	`PXT4_I
(
öode
)->
i_¥ojid
))

458 
îr
 = -
EPERM
;

460 i‡(
	`pxt4_is_quŸa_fûe
(
öode
))

461  
îr
;

463 
îr
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

464 i‡(
îr
)

465  
îr
;

467 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

468 i‡(!
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¥ojid
)) {

469 
îr
 = 
	`pxt4_ex∑nd_exåa_isize
(
öode
,

470 
	`PXT4_SB
(
sb
)->
s_w™t_exåa_isize
,

471 &
ûoc
);

472 i‡(
îr
)

473  
îr
;

475 
	`bªl£
(
ûoc
.
bh
);

478 
îr
 = 
	`dquŸ_öôülize
(
öode
);

479 i‡(
îr
)

480  
îr
;

482 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
,

483 
	`PXT4_QUOTA_INIT_BLOCKS
(
sb
) +

484 
	`PXT4_QUOTA_DEL_BLOCKS
(
sb
) + 3);

485 i‡(
	`IS_ERR
(
h™dÀ
))

486  
	`PTR_ERR
(
h™dÀ
);

488 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

489 i‡(
îr
)

490 
out_°›
;

492 
å™s„r_to
[
PRJQUOTA
] = 
	`dqgë
(
sb
, 
	`make_kqid_¥ojid
(
k¥ojid
));

493 i‡(!
	`IS_ERR
(
å™s„r_to
[
PRJQUOTA
])) {

498 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

499 
îr
 = 
	`__dquŸ_å™s„r
(
öode
, 
å™s„r_to
);

500 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

501 
	`dqput
(
å™s„r_to
[
PRJQUOTA
]);

502 i‡(
îr
)

503 
out_dúty
;

506 
	`PXT4_I
(
öode
)->
i_¥ojid
 = 
k¥ojid
;

507 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

508 
out_dúty
:

509 
rc
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

510 i‡(!
îr
)

511 
îr
 = 
rc
;

512 
out_°›
:

513 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

514  
îr
;

515 
	}
}

517 
	$pxt4_io˘l_£çroje˘
(
fûe
 *
fûp
, 
__u32
 
¥ojid
)

519 i‡(
¥ojid
 !
PXT4_DEF_PROJID
)

520  -
EOPNOTSUPP
;

522 
	}
}

526 
ölöe
 
__u32
 
	$pxt4_iÊags_to_xÊags
(
iÊags
)

528 
__u32
 
xÊags
 = 0;

530 i‡(
iÊags
 & 
PXT4_SYNC_FL
)

531 
xÊags
 |
FS_XFLAG_SYNC
;

532 i‡(
iÊags
 & 
PXT4_IMMUTABLE_FL
)

533 
xÊags
 |
FS_XFLAG_IMMUTABLE
;

534 i‡(
iÊags
 & 
PXT4_APPEND_FL
)

535 
xÊags
 |
FS_XFLAG_APPEND
;

536 i‡(
iÊags
 & 
PXT4_NODUMP_FL
)

537 
xÊags
 |
FS_XFLAG_NODUMP
;

538 i‡(
iÊags
 & 
PXT4_NOATIME_FL
)

539 
xÊags
 |
FS_XFLAG_NOATIME
;

540 i‡(
iÊags
 & 
PXT4_PROJINHERIT_FL
)

541 
xÊags
 |
FS_XFLAG_PROJINHERIT
;

542  
xÊags
;

543 
	}
}

545 
	#PXT4_SUPPORTED_FS_XFLAGS
 (
FS_XFLAG_SYNC
 | 
FS_XFLAG_IMMUTABLE
 | \

546 
FS_XFLAG_APPEND
 | 
FS_XFLAG_NODUMP
 | \

547 
FS_XFLAG_NOATIME
 | 
FS_XFLAG_PROJINHERIT
)

	)

550 
ölöe
 
	$pxt4_xÊags_to_iÊags
(
__u32
 
xÊags
)

552 
iÊags
 = 0;

554 i‡(
xÊags
 & 
FS_XFLAG_SYNC
)

555 
iÊags
 |
PXT4_SYNC_FL
;

556 i‡(
xÊags
 & 
FS_XFLAG_IMMUTABLE
)

557 
iÊags
 |
PXT4_IMMUTABLE_FL
;

558 i‡(
xÊags
 & 
FS_XFLAG_APPEND
)

559 
iÊags
 |
PXT4_APPEND_FL
;

560 i‡(
xÊags
 & 
FS_XFLAG_NODUMP
)

561 
iÊags
 |
PXT4_NODUMP_FL
;

562 i‡(
xÊags
 & 
FS_XFLAG_NOATIME
)

563 
iÊags
 |
PXT4_NOATIME_FL
;

564 i‡(
xÊags
 & 
FS_XFLAG_PROJINHERIT
)

565 
iÊags
 |
PXT4_PROJINHERIT_FL
;

567  
iÊags
;

568 
	}
}

570 
	$pxt4_shutdown
(
su≥r_block
 *
sb
, 
¨g
)

572 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

573 
__u32
 
Êags
;

575 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

576  -
EPERM
;

578 i‡(
	`gë_u£r
(
Êags
, (
__u32
 
__u£r
 *)
¨g
))

579  -
EFAULT
;

581 i‡(
Êags
 > 
PXT4_GOING_FLAGS_NOLOGFLUSH
)

582  -
EINVAL
;

584 i‡(
	`pxt4_f‹˚d_shutdown
(
sbi
))

587 
	`pxt4_msg
(
sb
, 
KERN_ALERT
, "shuàdow¿ªque°ed (%d)", 
Êags
);

588 
	`åa˚_pxt4_shutdown
(
sb
, 
Êags
);

590 
Êags
) {

591 
PXT4_GOING_FLAGS_DEFAULT
:

592 
	`‰ìze_bdev
(
sb
->
s_bdev
);

593 
	`£t_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

594 
	`thaw_bdev
(
sb
->
s_bdev
, sb);

596 
PXT4_GOING_FLAGS_LOGFLUSH
:

597 
	`£t_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

598 i‡(
sbi
->
s_jou∫Æ
 && !
	`is_jou∫Æ_ab‹ãd
(sbi->s_journal)) {

599 (Ë
	`pxt4_f‹˚_commô
(
sb
);

600 
	`jbd3_jou∫Æ_ab‹t
(
sbi
->
s_jou∫Æ
, -
ESHUTDOWN
);

603 
PXT4_GOING_FLAGS_NOLOGFLUSH
:

604 
	`£t_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

605 i‡(
sbi
->
s_jou∫Æ
 && !
	`is_jou∫Æ_ab‹ãd
(sbi->s_journal))

606 
	`jbd3_jou∫Æ_ab‹t
(
sbi
->
s_jou∫Æ
, -
ESHUTDOWN
);

609  -
EINVAL
;

611 
	`˛ór_›t
(
sb
, 
DISCARD
);

613 
	}
}

615 
	sgëfsm≠_öfo
 {

616 
su≥r_block
 *
	mgi_sb
;

617 
fsm≠_hód
 
__u£r
 *
	mgi_d©a
;

618 
	mgi_idx
;

619 
__u32
 
	mgi_œ°_Êags
;

622 
	$pxt4_gëfsm≠_f‹m©
(
pxt4_fsm≠
 *
xfm
, *
¥iv
)

624 
gëfsm≠_öfo
 *
öfo
 = 
¥iv
;

625 
fsm≠
 
fm
;

627 
	`åa˚_pxt4_gëfsm≠_m≠pög
(
öfo
->
gi_sb
, 
xfm
);

629 
öfo
->
gi_œ°_Êags
 = 
xfm
->
fmr_Êags
;

630 
	`pxt4_fsm≠_‰om_öã∫Æ
(
öfo
->
gi_sb
, &
fm
, 
xfm
);

631 i‡(
	`c›y_to_u£r
(&
öfo
->
gi_d©a
->
fmh_ªcs
[öfo->
gi_idx
++], &
fm
,

632 (
fsm≠
)))

633  -
EFAULT
;

636 
	}
}

638 
	$pxt4_ioc_gëfsm≠
(
su≥r_block
 *
sb
,

639 
fsm≠_hód
 
__u£r
 *
¨g
)

641 
gëfsm≠_öfo
 
öfo
 = { 
NULL
 };

642 
pxt4_fsm≠_hód
 
xhód
 = {0};

643 
fsm≠_hód
 
hód
;

644 
boﬁ
 
ab‹ãd
 = 
Ál£
;

645 
îr‹
;

647 i‡(
	`c›y_‰om_u£r
(&
hód
, 
¨g
, (
fsm≠_hód
)))

648  -
EFAULT
;

649 i‡(
	`memchr_öv
(
hód
.
fmh_ª£rved
, 0, (head.fmh_reserved)) ||

650 
	`memchr_öv
(
hód
.
fmh_keys
[0].
fmr_ª£rved
, 0,

651 (
hód
.
fmh_keys
[0].
fmr_ª£rved
)) ||

652 
	`memchr_öv
(
hód
.
fmh_keys
[1].
fmr_ª£rved
, 0,

653 (
hód
.
fmh_keys
[1].
fmr_ª£rved
)))

654  -
EINVAL
;

659 i‡(
hód
.
fmh_keys
[0].
fmr_off£t
 ||

660 (
hód
.
fmh_keys
[1].
fmr_off£t
 != 0 &&

661 
hód
.
fmh_keys
[1].
fmr_off£t
 != -1ULL))

662  -
EINVAL
;

664 
xhód
.
fmh_iÊags
 = 
hód
.fmh_iflags;

665 
xhód
.
fmh_cou¡
 = 
hód
.fmh_count;

666 
	`pxt4_fsm≠_to_öã∫Æ
(
sb
, &
xhód
.
fmh_keys
[0], &
hód
.fmh_keys[0]);

667 
	`pxt4_fsm≠_to_öã∫Æ
(
sb
, &
xhód
.
fmh_keys
[1], &
hód
.fmh_keys[1]);

669 
	`åa˚_pxt4_gëfsm≠_low_key
(
sb
, &
xhód
.
fmh_keys
[0]);

670 
	`åa˚_pxt4_gëfsm≠_high_key
(
sb
, &
xhód
.
fmh_keys
[1]);

672 
öfo
.
gi_sb
 = 
sb
;

673 
öfo
.
gi_d©a
 = 
¨g
;

674 
îr‹
 = 
	`pxt4_gëfsm≠
(
sb
, &
xhód
, 
pxt4_gëfsm≠_f‹m©
, &
öfo
);

675 i‡(
îr‹
 =
PXT4_QUERY_RANGE_ABORT
) {

676 
îr‹
 = 0;

677 
ab‹ãd
 = 
åue
;

678 } i‡(
îr‹
)

679  
îr‹
;

682 i‡(!
ab‹ãd
 && 
öfo
.
gi_idx
) {

683 
öfo
.
gi_œ°_Êags
 |
FMR_OF_LAST
;

684 i‡(
	`c›y_to_u£r
(&
öfo
.
gi_d©a
->
fmh_ªcs
[öfo.
gi_idx
 - 1].
fmr_Êags
,

685 &
öfo
.
gi_œ°_Êags
,

686 (
öfo
.
gi_œ°_Êags
)))

687  -
EFAULT
;

691 
hód
.
fmh_íåõs
 = 
xhód
.fmh_entries;

692 
hód
.
fmh_oÊags
 = 
xhód
.fmh_oflags;

693 i‡(
	`c›y_to_u£r
(
¨g
, &
hód
, (
fsm≠_hód
)))

694  -
EFAULT
;

697 
	}
}

699 
	$pxt4_io˘l_group_add
(
fûe
 *file,

700 
pxt4_√w_group_d©a
 *
öput
)

702 
su≥r_block
 *
sb
 = 
	`fûe_öode
(
fûe
)->
i_sb
;

703 
îr
, 
îr2
=0;

705 
îr
 = 
	`pxt4_ªsize_begö
(
sb
);

706 i‡(
îr
)

707  
îr
;

709 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
)) {

710 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

712 
îr
 = -
EOPNOTSUPP
;

713 
group_add_out
;

716 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

717 i‡(
îr
)

718 
group_add_out
;

720 
îr
 = 
	`pxt4_group_add
(
sb
, 
öput
);

721 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

722 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

723 
îr2
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

724 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

726 i‡(
îr
 == 0)

727 
îr
 = 
îr2
;

728 
	`m¡_dr›_wrôe_fûe
(
fûe
);

729 i‡(!
îr
 && 
	`pxt4_has_group_desc_csum
(
sb
) &&

730 
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

731 
îr
 = 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
öput
->
group
);

732 
group_add_out
:

733 
	`pxt4_ªsize_íd
(
sb
);

734  
îr
;

735 
	}
}

737 
	$pxt4_fûl_fsx©å
(
öode
 *öode, 
fsx©å
 *
Á
)

739 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

741 
	`sim∂e_fûl_fsx©å
(
Á
, 
	`pxt4_iÊags_to_xÊags
(
ei
->
i_Êags
 &

742 
PXT4_FL_USER_VISIBLE
));

744 i‡(
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
))

745 
Á
->
fsx_¥ojid
 = 
	`‰om_k¥ojid
(&
öô_u£r_ns
, 
ei
->
i_¥ojid
);

746 
	}
}

749 
	$fõm≠_check_ønges
(
su≥r_block
 *
sb
,

750 
u64
 
°¨t
, u64 
Àn
, u64 *
√w_Àn
)

752 
u64
 
maxbyãs
 = (u64Ë
sb
->
s_maxbyãs
;

754 *
√w_Àn
 = 
Àn
;

756 i‡(
Àn
 == 0)

757  -
EINVAL
;

759 i‡(
°¨t
 > 
maxbyãs
)

760  -
EFBIG
;

765 i‡(
Àn
 > 
maxbyãs
 || (maxbyã†-ÜíË< 
°¨t
)

766 *
√w_Àn
 = 
maxbyãs
 - 
°¨t
;

769 
	}
}

772 
	#FIEMAP_MAX_EXTENTS
 (
UINT_MAX
 / (
fõm≠_exã¡
))

	)

774 
	$pxt4_io˘l_gë_es_ˇche
(
fûe
 *
fûp
, 
¨g
)

776 
fõm≠
 fiemap;

777 
fõm≠
 
__u£r
 *
ufõm≠
 = (fõm≠ __u£∏*Ë
¨g
;

778 
fõm≠_exã¡_öfo
 
fõöfo
 = { 0, };

779 
öode
 *öodê
	`fûe_öode
(
fûp
);

780 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

781 
u64
 
Àn
;

782 
îr‹
;

784 i‡(
	`c›y_‰om_u£r
(&
fõm≠
, 
ufõm≠
, (fiemap)))

785  -
EFAULT
;

787 i‡(
fõm≠
.
fm_exã¡_cou¡
 > 
FIEMAP_MAX_EXTENTS
)

788  -
EINVAL
;

790 
îr‹
 = 
	`fõm≠_check_ønges
(
sb
, 
fõm≠
.
fm_°¨t
, fõm≠.
fm_Àngth
,

791 &
Àn
);

792 i‡(
îr‹
)

793  
îr‹
;

795 
fõöfo
.
fi_Êags
 = 
fõm≠
.
fm_Êags
;

796 
fõöfo
.
fi_exã¡s_max
 = 
fõm≠
.
fm_exã¡_cou¡
;

797 
fõöfo
.
fi_exã¡s_°¨t
 = 
ufõm≠
->
fm_exã¡s
;

799 i‡(
fõm≠
.
fm_exã¡_cou¡
 != 0 &&

800 !
	`ac˚ss_ok
(
fõöfo
.
fi_exã¡s_°¨t
,

801 
fõöfo
.
fi_exã¡s_max
 * (
fõm≠_exã¡
)))

802  -
EFAULT
;

804 i‡(
fõöfo
.
fi_Êags
 & 
FIEMAP_FLAG_SYNC
)

805 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

807 
îr‹
 = 
	`pxt4_gë_es_ˇche
(
öode
, &
fõöfo
, 
fõm≠
.
fm_°¨t
, 
Àn
);

808 
fõm≠
.
fm_Êags
 = 
fõöfo
.
fi_Êags
;

809 
fõm≠
.
fm_m≠≥d_exã¡s
 = 
fõöfo
.
fi_exã¡s_m≠≥d
;

810 i‡(
	`c›y_to_u£r
(
ufõm≠
, &
fõm≠
, (fiemap)))

811 
îr‹
 = -
EFAULT
;

813  
îr‹
;

814 
	}
}

816 
	$pxt4_io˘l
(
fûe
 *
fûp
, 
cmd
, 
¨g
)

818 
öode
 *öodê
	`fûe_öode
(
fûp
);

819 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

820 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

821 
Êags
;

823 
	`pxt4_debug
("cmd = %u,árg = %lu\n", 
cmd
, 
¨g
);

825 
cmd
) {

826 
FS_IOC_GETFSMAP
:

827  
	`pxt4_ioc_gëfsm≠
(
sb
, (
__u£r
 *)
¨g
);

828 
PXT4_IOC_GETFLAGS
:

829 
Êags
 = 
ei
->
i_Êags
 & 
PXT4_FL_USER_VISIBLE
;

830 i‡(
	`S_ISREG
(
öode
->
i_mode
))

831 
Êags
 &~
PXT4_PROJINHERIT_FL
;

832  
	`put_u£r
(
Êags
, (
__u£r
 *Ë
¨g
);

833 
PXT4_IOC_SETFLAGS
: {

834 
îr
;

836 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

837  -
EACCES
;

839 i‡(
	`gë_u£r
(
Êags
, (
__u£r
 *Ë
¨g
))

840  -
EFAULT
;

842 i‡(
Êags
 & ~
PXT4_FL_USER_VISIBLE
)

843  -
EOPNOTSUPP
;

850 
Êags
 &
PXT4_FL_USER_MODIFIABLE
;

851 i‡(
	`pxt4_mask_Êags
(
öode
->
i_mode
, 
Êags
) != flags)

852  -
EOPNOTSUPP
;

854 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

855 i‡(
îr
)

856  
îr
;

858 
	`öode_lock
(
öode
);

859 
îr
 = 
	`pxt4_io˘l_check_immuèbÀ
(
öode
,

860 
	`‰om_k¥ojid
(&
öô_u£r_ns
, 
ei
->
i_¥ojid
),

861 
Êags
);

862 i‡(!
îr
)

863 
îr
 = 
	`pxt4_io˘l_£tÊags
(
öode
, 
Êags
);

864 
	`öode_u∆ock
(
öode
);

865 
	`m¡_dr›_wrôe_fûe
(
fûp
);

866  
îr
;

868 
PXT4_IOC_GETVERSION
:

869 
PXT4_IOC_GETVERSION_OLD
:

870  
	`put_u£r
(
öode
->
i_gíî©i⁄
, (
__u£r
 *Ë
¨g
);

871 
PXT4_IOC_SETVERSION
:

872 
PXT4_IOC_SETVERSION_OLD
: {

873 
h™dÀ_t
 *
h™dÀ
;

874 
pxt4_ûoc
 
ûoc
;

875 
__u32
 
gíî©i⁄
;

876 
îr
;

878 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

879  -
EPERM
;

881 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
)) {

882 
	`pxt4_w¨nög
(
sb
, "Setting inode version isÇot "

884  -
ENOTTY
;

887 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

888 i‡(
îr
)

889  
îr
;

890 i‡(
	`gë_u£r
(
gíî©i⁄
, (
__u£r
 *Ë
¨g
)) {

891 
îr
 = -
EFAULT
;

892 
£tvîsi⁄_out
;

895 
	`öode_lock
(
öode
);

896 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

897 i‡(
	`IS_ERR
(
h™dÀ
)) {

898 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

899 
u∆ock_out
;

901 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

902 i‡(
îr
 == 0) {

903 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

904 
öode
->
i_gíî©i⁄
 = 
gíî©i⁄
;

905 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

907 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

909 
u∆ock_out
:

910 
	`öode_u∆ock
(
öode
);

911 
£tvîsi⁄_out
:

912 
	`m¡_dr›_wrôe_fûe
(
fûp
);

913  
îr
;

915 
PXT4_IOC_GROUP_EXTEND
: {

916 
pxt4_fsblk_t
 
n_blocks_cou¡
;

917 
îr
, 
îr2
=0;

919 
îr
 = 
	`pxt4_ªsize_begö
(
sb
);

920 i‡(
îr
)

921  
îr
;

923 i‡(
	`gë_u£r
(
n_blocks_cou¡
, (
__u32
 
__u£r
 *)
¨g
)) {

924 
îr
 = -
EFAULT
;

925 
group_exãnd_out
;

928 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
)) {

929 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

931 
îr
 = -
EOPNOTSUPP
;

932 
group_exãnd_out
;

935 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

936 i‡(
îr
)

937 
group_exãnd_out
;

939 
îr
 = 
	`pxt4_group_exãnd
(
sb
, 
	`PXT4_SB
(sb)->
s_es
, 
n_blocks_cou¡
);

940 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

941 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

942 
îr2
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

943 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

945 i‡(
îr
 == 0)

946 
îr
 = 
îr2
;

947 
	`m¡_dr›_wrôe_fûe
(
fûp
);

948 
group_exãnd_out
:

949 
	`pxt4_ªsize_íd
(
sb
);

950  
îr
;

953 
PXT4_IOC_MOVE_EXT
: {

954 
move_exã¡
 
me
;

955 
fd
 
d⁄‹
;

956 
îr
;

958 i‡(!(
fûp
->
f_mode
 & 
FMODE_READ
) ||

959 !(
fûp
->
f_mode
 & 
FMODE_WRITE
))

960  -
EBADF
;

962 i‡(
	`c›y_‰om_u£r
(&
me
,

963 (
move_exã¡
 
__u£r
 *)
¨g
, (
me
)))

964  -
EFAULT
;

965 
me
.
moved_Àn
 = 0;

967 
d⁄‹
 = 
	`fdgë
(
me
.
d⁄‹_fd
);

968 i‡(!
d⁄‹
.
fûe
)

969  -
EBADF
;

971 i‡(!(
d⁄‹
.
fûe
->
f_mode
 & 
FMODE_WRITE
)) {

972 
îr
 = -
EBADF
;

973 
mext_out
;

976 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
)) {

977 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

979 
îr
 = -
EOPNOTSUPP
;

980 
mext_out
;

981 } i‡(
	`IS_DAX
(
öode
)) {

982 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

984 
îr
 = -
EOPNOTSUPP
;

985 
mext_out
;

988 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

989 i‡(
îr
)

990 
mext_out
;

992 
îr
 = 
	`pxt4_move_exã¡s
(
fûp
, 
d⁄‹
.
fûe
, 
me
.
‹ig_°¨t
,

993 
me
.
d⁄‹_°¨t
, me.
Àn
, &me.
moved_Àn
);

994 
	`m¡_dr›_wrôe_fûe
(
fûp
);

996 i‡(
	`c›y_to_u£r
((
move_exã¡
 
__u£r
 *)
¨g
,

997 &
me
, (me)))

998 
îr
 = -
EFAULT
;

999 
mext_out
:

1000 
	`fdput
(
d⁄‹
);

1001  
îr
;

1004 
PXT4_IOC_GROUP_ADD
: {

1005 
pxt4_√w_group_d©a
 
öput
;

1007 i‡(
	`c›y_‰om_u£r
(&
öput
, (
pxt4_√w_group_öput
 
__u£r
 *)
¨g
,

1008 (
öput
)))

1009  -
EFAULT
;

1011  
	`pxt4_io˘l_group_add
(
fûp
, &
öput
);

1014 
PXT4_IOC_MIGRATE
:

1016 
îr
;

1017 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1018  -
EACCES
;

1020 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1021 i‡(
îr
)

1022  
îr
;

1029 
	`öode_lock
((
öode
));

1030 
îr
 = 
	`pxt4_ext_migøã
(
öode
);

1031 
	`öode_u∆ock
((
öode
));

1032 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1033  
îr
;

1036 
PXT4_IOC_ALLOC_DA_BLKS
:

1038 
îr
;

1039 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1040  -
EACCES
;

1042 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1043 i‡(
îr
)

1044  
îr
;

1045 
îr
 = 
	`pxt4_Æloc_da_blocks
(
öode
);

1046 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1047  
îr
;

1050 
PXT4_IOC_SWAP_BOOT
:

1052 
îr
;

1053 i‡(!(
fûp
->
f_mode
 & 
FMODE_WRITE
))

1054  -
EBADF
;

1055 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1056 i‡(
îr
)

1057  
îr
;

1058 
îr
 = 
	`sw≠_öode_boŸ_lﬂdî
(
sb
, 
öode
);

1059 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1060  
îr
;

1063 
PXT4_IOC_RESIZE_FS
: {

1064 
pxt4_fsblk_t
 
n_blocks_cou¡
;

1065 
îr
 = 0, 
îr2
 = 0;

1066 
pxt4_group_t
 
o_group
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

1068 i‡(
	`c›y_‰om_u£r
(&
n_blocks_cou¡
, (
__u64
 
__u£r
 *)
¨g
,

1069 (
__u64
))) {

1070  -
EFAULT
;

1073 
îr
 = 
	`pxt4_ªsize_begö
(
sb
);

1074 i‡(
îr
)

1075  
îr
;

1077 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1078 i‡(
îr
)

1079 
ªsizefs_out
;

1081 
îr
 = 
	`pxt4_ªsize_fs
(
sb
, 
n_blocks_cou¡
);

1082 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

1083 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

1084 
îr2
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

1085 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

1087 i‡(
îr
 == 0)

1088 
îr
 = 
îr2
;

1089 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1090 i‡(!
îr
 && (
o_group
 < 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
) &&

1091 
	`pxt4_has_group_desc_csum
(
sb
) &&

1092 
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

1093 
îr
 = 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
o_group
);

1095 
ªsizefs_out
:

1096 
	`pxt4_ªsize_íd
(
sb
);

1097  
îr
;

1100 
FITRIM
:

1102 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
sb
->
s_bdev
);

1103 
f°rim_ønge
 
ønge
;

1104 
ªt
 = 0;

1106 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

1107  -
EPERM
;

1109 i‡(!
	`blk_queue_disˇrd
(
q
))

1110  -
EOPNOTSUPP
;

1116 i‡(
	`ã°_›t
(
sb
, 
NOLOAD
Ë&& 
	`pxt4_has_„©uª_jou∫Æ
(sb))

1117  -
EROFS
;

1119 i‡(
	`c›y_‰om_u£r
(&
ønge
, (
f°rim_ønge
 
__u£r
 *)
¨g
,

1120 (
ønge
)))

1121  -
EFAULT
;

1123 
ønge
.
möÀn
 = 
	`max
(()range.minlen,

1124 
q
->
limôs
.
disˇrd_gønuœrôy
);

1125 
ªt
 = 
	`pxt4_åim_fs
(
sb
, &
ønge
);

1126 i‡(
ªt
 < 0)

1127  
ªt
;

1129 i‡(
	`c›y_to_u£r
((
f°rim_ønge
 
__u£r
 *)
¨g
, &
ønge
,

1130 (
ønge
)))

1131  -
EFAULT
;

1135 
PXT4_IOC_PRECACHE_EXTENTS
:

1136  
	`pxt4_ext_¥eˇche
(
öode
);

1138 
PXT4_IOC_SET_ENCRYPTION_POLICY
:

1139 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1140  -
EOPNOTSUPP
;

1141  
	`fs¸y±_io˘l_£t_pﬁicy
(
fûp
, (c⁄° 
__u£r
 *)
¨g
);

1143 
PXT4_IOC_GET_ENCRYPTION_PWSALT
: {

1144 #ifde‡
CONFIG_FS_ENCRYPTION


1145 
îr
, 
îr2
;

1146 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1147 
h™dÀ_t
 *
h™dÀ
;

1149 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1150  -
EOPNOTSUPP
;

1151 i‡(
	`uuid_is_zîo
(
sbi
->
s_es
->
s_í¸y±_pw_ß…
)) {

1152 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1153 i‡(
îr
)

1154  
îr
;

1155 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_MISC
, 1);

1156 i‡(
	`IS_ERR
(
h™dÀ
)) {

1157 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1158 
pwß…_îr_exô
;

1160 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

1161 i‡(
îr
)

1162 
pwß…_îr_jou∫Æ
;

1163 
	`gíî©e_øndom_uuid
(
sbi
->
s_es
->
s_í¸y±_pw_ß…
);

1164 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
,

1165 
sbi
->
s_sbh
);

1166 
pwß…_îr_jou∫Æ
:

1167 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1168 i‡(
îr2
 && !
îr
)

1169 
îr
 = 
îr2
;

1170 
pwß…_îr_exô
:

1171 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1172 i‡(
îr
)

1173  
îr
;

1175 i‡(
	`c›y_to_u£r
((
__u£r
 *Ë
¨g
,

1176 
sbi
->
s_es
->
s_í¸y±_pw_ß…
, 16))

1177  -
EFAULT
;

1180  -
EOPNOTSUPP
;

1183 
PXT4_IOC_GET_ENCRYPTION_POLICY
:

1184 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1185  -
EOPNOTSUPP
;

1186  
	`fs¸y±_io˘l_gë_pﬁicy
(
fûp
, (
__u£r
 *)
¨g
);

1188 
FS_IOC_GET_ENCRYPTION_POLICY_EX
:

1189 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1190  -
EOPNOTSUPP
;

1191  
	`fs¸y±_io˘l_gë_pﬁicy_ex
(
fûp
, (
__u£r
 *)
¨g
);

1193 
FS_IOC_ADD_ENCRYPTION_KEY
:

1194 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1195  -
EOPNOTSUPP
;

1196  
	`fs¸y±_io˘l_add_key
(
fûp
, (
__u£r
 *)
¨g
);

1198 
FS_IOC_REMOVE_ENCRYPTION_KEY
:

1199 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1200  -
EOPNOTSUPP
;

1201  
	`fs¸y±_io˘l_ªmove_key
(
fûp
, (
__u£r
 *)
¨g
);

1203 
FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
:

1204 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1205  -
EOPNOTSUPP
;

1206  
	`fs¸y±_io˘l_ªmove_key_Æl_u£rs
(
fûp
,

1207 (
__u£r
 *)
¨g
);

1208 
FS_IOC_GET_ENCRYPTION_KEY_STATUS
:

1209 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1210  -
EOPNOTSUPP
;

1211  
	`fs¸y±_io˘l_gë_key_°©us
(
fûp
, (
__u£r
 *)
¨g
);

1213 
PXT4_IOC_CLEAR_ES_CACHE
:

1215 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1216  -
EACCES
;

1217 
	`pxt4_˛ór_öode_es
(
öode
);

1221 
PXT4_IOC_GETSTATE
:

1223 
__u32
 
°©e
 = 0;

1225 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
))

1226 
°©e
 |
PXT4_STATE_FLAG_EXT_PRECACHED
;

1227 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEW
))

1228 
°©e
 |
PXT4_STATE_FLAG_NEW
;

1229 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
))

1230 
°©e
 |
PXT4_STATE_FLAG_NEWENTRY
;

1231 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
))

1232 
°©e
 |
PXT4_STATE_FLAG_DA_ALLOC_CLOSE
;

1234  
	`put_u£r
(
°©e
, (
__u32
 
__u£r
 *Ë
¨g
);

1237 
PXT4_IOC_GET_ES_CACHE
:

1238  
	`pxt4_io˘l_gë_es_ˇche
(
fûp
, 
¨g
);

1240 
PXT4_IOC_FSGETXATTR
:

1242 
fsx©å
 
Á
;

1244 
	`pxt4_fûl_fsx©å
(
öode
, &
Á
);

1246 i‡(
	`c›y_to_u£r
((
fsx©å
 
__u£r
 *)
¨g
,

1247 &
Á
, (fa)))

1248  -
EFAULT
;

1251 
PXT4_IOC_FSSETXATTR
:

1253 
fsx©å
 
Á
, 
ﬁd_Á
;

1254 
îr
;

1256 i‡(
	`c›y_‰om_u£r
(&
Á
, (
fsx©å
 
__u£r
 *)
¨g
,

1257 (
Á
)))

1258  -
EFAULT
;

1261 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1262  -
EACCES
;

1264 i‡(
Á
.
fsx_xÊags
 & ~
PXT4_SUPPORTED_FS_XFLAGS
)

1265  -
EOPNOTSUPP
;

1267 
Êags
 = 
	`pxt4_xÊags_to_iÊags
(
Á
.
fsx_xÊags
);

1268 i‡(
	`pxt4_mask_Êags
(
öode
->
i_mode
, 
Êags
) != flags)

1269  -
EOPNOTSUPP
;

1271 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1272 i‡(
îr
)

1273  
îr
;

1275 
	`öode_lock
(
öode
);

1276 
	`pxt4_fûl_fsx©å
(
öode
, &
ﬁd_Á
);

1277 
îr
 = 
	`vfs_ioc_fs£tx©å_check
(
öode
, &
ﬁd_Á
, &
Á
);

1278 i‡(
îr
)

1279 
out
;

1280 
Êags
 = (
ei
->
i_Êags
 & ~
PXT4_FL_XFLAG_VISIBLE
) |

1281 (
Êags
 & 
PXT4_FL_XFLAG_VISIBLE
);

1282 
îr
 = 
	`pxt4_io˘l_check_immuèbÀ
(
öode
, 
Á
.
fsx_¥ojid
, 
Êags
);

1283 i‡(
îr
)

1284 
out
;

1285 
îr
 = 
	`pxt4_io˘l_£tÊags
(
öode
, 
Êags
);

1286 i‡(
îr
)

1287 
out
;

1288 
îr
 = 
	`pxt4_io˘l_£çroje˘
(
fûp
, 
Á
.
fsx_¥ojid
);

1289 
out
:

1290 
	`öode_u∆ock
(
öode
);

1291 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1292  
îr
;

1294 
PXT4_IOC_SHUTDOWN
:

1295  
	`pxt4_shutdown
(
sb
, 
¨g
);

1297 
FS_IOC_ENABLE_VERITY
:

1298 i‡(!
	`pxt4_has_„©uª_vîôy
(
sb
))

1299  -
EOPNOTSUPP
;

1300  
	`fsvîôy_io˘l_íabÀ
(
fûp
, (c⁄° 
__u£r
 *)
¨g
);

1302 
FS_IOC_MEASURE_VERITY
:

1303 i‡(!
	`pxt4_has_„©uª_vîôy
(
sb
))

1304  -
EOPNOTSUPP
;

1305  
	`fsvîôy_io˘l_mósuª
(
fûp
, (
__u£r
 *)
¨g
);

1308  -
ENOTTY
;

1310 
	}
}

1312 #ifde‡
CONFIG_COMPAT


1313 
	$pxt4_com∑t_io˘l
(
fûe
 *fûe, 
cmd
, 
¨g
)

1316 
cmd
) {

1317 
PXT4_IOC32_GETFLAGS
:

1318 
cmd
 = 
PXT4_IOC_GETFLAGS
;

1320 
PXT4_IOC32_SETFLAGS
:

1321 
cmd
 = 
PXT4_IOC_SETFLAGS
;

1323 
PXT4_IOC32_GETVERSION
:

1324 
cmd
 = 
PXT4_IOC_GETVERSION
;

1326 
PXT4_IOC32_SETVERSION
:

1327 
cmd
 = 
PXT4_IOC_SETVERSION
;

1329 
PXT4_IOC32_GROUP_EXTEND
:

1330 
cmd
 = 
PXT4_IOC_GROUP_EXTEND
;

1332 
PXT4_IOC32_GETVERSION_OLD
:

1333 
cmd
 = 
PXT4_IOC_GETVERSION_OLD
;

1335 
PXT4_IOC32_SETVERSION_OLD
:

1336 
cmd
 = 
PXT4_IOC_SETVERSION_OLD
;

1338 
PXT4_IOC32_GETRSVSZ
:

1339 
cmd
 = 
PXT4_IOC_GETRSVSZ
;

1341 
PXT4_IOC32_SETRSVSZ
:

1342 
cmd
 = 
PXT4_IOC_SETRSVSZ
;

1344 
PXT4_IOC32_GROUP_ADD
: {

1345 
com∑t_pxt4_√w_group_öput
 
__u£r
 *
uöput
;

1346 
pxt4_√w_group_d©a
 
öput
;

1347 
îr
;

1349 
uöput
 = 
	`com∑t_±r
(
¨g
);

1350 
îr
 = 
	`gë_u£r
(
öput
.
group
, &
uöput
->group);

1351 
îr
 |
	`gë_u£r
(
öput
.
block_bôm≠
, &
uöput
->block_bitmap);

1352 
îr
 |
	`gë_u£r
(
öput
.
öode_bôm≠
, &
uöput
->inode_bitmap);

1353 
îr
 |
	`gë_u£r
(
öput
.
öode_èbÀ
, &
uöput
->inode_table);

1354 
îr
 |
	`gë_u£r
(
öput
.
blocks_cou¡
, &
uöput
->blocks_count);

1355 
îr
 |
	`gë_u£r
(
öput
.
ª£rved_blocks
,

1356 &
uöput
->
ª£rved_blocks
);

1357 i‡(
îr
)

1358  -
EFAULT
;

1359  
	`pxt4_io˘l_group_add
(
fûe
, &
öput
);

1361 
PXT4_IOC_MOVE_EXT
:

1362 
PXT4_IOC_RESIZE_FS
:

1363 
PXT4_IOC_PRECACHE_EXTENTS
:

1364 
PXT4_IOC_SET_ENCRYPTION_POLICY
:

1365 
PXT4_IOC_GET_ENCRYPTION_PWSALT
:

1366 
PXT4_IOC_GET_ENCRYPTION_POLICY
:

1367 
FS_IOC_GET_ENCRYPTION_POLICY_EX
:

1368 
FS_IOC_ADD_ENCRYPTION_KEY
:

1369 
FS_IOC_REMOVE_ENCRYPTION_KEY
:

1370 
FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
:

1371 
FS_IOC_GET_ENCRYPTION_KEY_STATUS
:

1372 
PXT4_IOC_SHUTDOWN
:

1373 
FS_IOC_GETFSMAP
:

1374 
FS_IOC_ENABLE_VERITY
:

1375 
FS_IOC_MEASURE_VERITY
:

1376 
PXT4_IOC_CLEAR_ES_CACHE
:

1377 
PXT4_IOC_GETSTATE
:

1378 
PXT4_IOC_GET_ES_CACHE
:

1381  -
ENOIOCTLCMD
;

1383  
	`pxt4_io˘l
(
fûe
, 
cmd
, (Ë
	`com∑t_±r
(
¨g
));

1384 
	}
}

	@mballoc.c

12 
	~"pxt4_jbd3.h
"

13 
	~"mbÆloc.h
"

14 
	~<löux/log2.h
>

15 
	~<löux/moduÀ.h
>

16 
	~<löux/¶ab.h
>

17 
	~<löux/no•ec.h
>

18 
	~<löux/backög-dev.h
>

19 
	~<åa˚/evíts/pxt4.h
>

21 #ifde‡
CONFIG_PXT4_DEBUG


22 
ush‹t
 
pxt4_mbÆloc_debug
 
	g__ªad_mo°ly
;

24 
moduÀ_∑øm_«med
(
mbÆloc_debug
, 
pxt4_mbÆloc_debug
, 
ush‹t
, 0644);

25 
MODULE_PARM_DESC
(
mbÆloc_debug
, "DebuggingÜevel forÖxt4's mballoc");

339 
kmem_ˇche
 *
	gpxt4_p•a˚_ˇchï
;

340 
kmem_ˇche
 *
	gpxt4_ac_ˇchï
;

341 
kmem_ˇche
 *
	gpxt4_‰ì_d©a_ˇchï
;

346 
	#NR_GRPINFO_CACHES
 8

	)

347 
kmem_ˇche
 *
	gpxt4_groupöfo_ˇches
[
NR_GRPINFO_CACHES
];

349 c⁄° * c⁄° 
	gpxt4_groupöfo_¶ab_«mes
[
NR_GRPINFO_CACHES
] = {

355 
pxt4_mb_gíî©e_‰om_∑
(
su≥r_block
 *
sb
, *
bôm≠
,

356 
pxt4_group_t
 
group
);

357 
pxt4_mb_gíî©e_‰om_‰ìli°
(
su≥r_block
 *
sb
, *
bôm≠
,

358 
pxt4_group_t
 
group
);

360 
ölöe
 *
	$mb_c‹ª˘_addr_™d_bô
(*
bô
, *
addr
)

362 #i‡
BITS_PER_LONG
 == 64

363 *
bô
 +((Ë
addr
 & 7UL) << 3;

364 
addr
 = (*) (()áddr & ~7UL);

365 #ñi‡
BITS_PER_LONG
 == 32

366 *
bô
 +((Ë
addr
 & 3UL) << 3;

367 
addr
 = (*) (()áddr & ~3UL);

371  
addr
;

372 
	}
}

374 
ölöe
 
	$mb_ã°_bô
(
bô
, *
addr
)

380 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

381  
	`pxt4_ã°_bô
(
bô
, 
addr
);

382 
	}
}

384 
ölöe
 
	$mb_£t_bô
(
bô
, *
addr
)

386 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

387 
	`pxt4_£t_bô
(
bô
, 
addr
);

388 
	}
}

390 
ölöe
 
	$mb_˛ór_bô
(
bô
, *
addr
)

392 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

393 
	`pxt4_˛ór_bô
(
bô
, 
addr
);

394 
	}
}

396 
ölöe
 
	$mb_ã°_™d_˛ór_bô
(
bô
, *
addr
)

398 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

399  
	`pxt4_ã°_™d_˛ór_bô
(
bô
, 
addr
);

400 
	}
}

402 
ölöe
 
	$mb_föd_√xt_zîo_bô
(*
addr
, 
max
, 
°¨t
)

404 
fix
 = 0, 
ªt
, 
tmpmax
;

405 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
fix
,áddr);

406 
tmpmax
 = 
max
 + 
fix
;

407 
°¨t
 +
fix
;

409 
ªt
 = 
	`pxt4_föd_√xt_zîo_bô
(
addr
, 
tmpmax
, 
°¨t
Ë- 
fix
;

410 i‡(
ªt
 > 
max
)

411  
max
;

412  
ªt
;

413 
	}
}

415 
ölöe
 
	$mb_föd_√xt_bô
(*
addr
, 
max
, 
°¨t
)

417 
fix
 = 0, 
ªt
, 
tmpmax
;

418 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
fix
,áddr);

419 
tmpmax
 = 
max
 + 
fix
;

420 
°¨t
 +
fix
;

422 
ªt
 = 
	`pxt4_föd_√xt_bô
(
addr
, 
tmpmax
, 
°¨t
Ë- 
fix
;

423 i‡(
ªt
 > 
max
)

424  
max
;

425  
ªt
;

426 
	}
}

428 *
	$mb_föd_buddy
(
pxt4_buddy
 *
e4b
, 
‹dî
, *
max
)

430 *
bb
;

432 
	`BUG_ON
(
e4b
->
bd_bôm≠
 =e4b->
bd_buddy
);

433 
	`BUG_ON
(
max
 =
NULL
);

435 i‡(
‹dî
 > 
e4b
->
bd_blkbôs
 + 1) {

436 *
max
 = 0;

437  
NULL
;

441 i‡(
‹dî
 == 0) {

442 *
max
 = 1 << (
e4b
->
bd_blkbôs
 + 3);

443  
e4b
->
bd_bôm≠
;

446 
bb
 = 
e4b
->
bd_buddy
 + 
	`PXT4_SB
”4b->
bd_sb
)->
s_mb_off£ts
[
‹dî
];

447 *
max
 = 
	`PXT4_SB
(
e4b
->
bd_sb
)->
s_mb_maxs
[
‹dî
];

449  
bb
;

450 
	}
}

452 #ifde‡
DOUBLE_CHECK


453 
	$mb_‰ì_blocks_doubÀ
(
öode
 *öode, 
pxt4_buddy
 *
e4b
,

454 
fú°
, 
cou¡
)

456 
i
;

457 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

459 i‡(
	`u∆ikñy
(
e4b
->
bd_öfo
->
bb_bôm≠
 =
NULL
))

461 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
sb
, 
e4b
->
bd_group
));

462 
i
 = 0; i < 
cou¡
; i++) {

463 i‡(!
	`mb_ã°_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
)) {

464 
pxt4_fsblk_t
 
blockƒ
;

466 
blockƒ
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
e4b
->
bd_group
);

467 
blockƒ
 +
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
fú°
 + 
i
);

468 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
,

469 
öode
 ? inode->
i_öo
 : 0,

470 
blockƒ
,

473 
fú°
 + 
i
);

474 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

475 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

477 
	`mb_˛ór_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
);

479 
	}
}

481 
	$mb_m¨k_u£d_doubÀ
(
pxt4_buddy
 *
e4b
, 
fú°
, 
cou¡
)

483 
i
;

485 i‡(
	`u∆ikñy
(
e4b
->
bd_öfo
->
bb_bôm≠
 =
NULL
))

487 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
e4b
->
bd_sb
,É4b->
bd_group
));

488 
i
 = 0; i < 
cou¡
; i++) {

489 
	`BUG_ON
(
	`mb_ã°_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
));

490 
	`mb_£t_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
);

492 
	}
}

494 
	$mb_cmp_bôm≠s
(
pxt4_buddy
 *
e4b
, *
bôm≠
)

496 i‡(
	`memcmp
(
e4b
->
bd_öfo
->
bb_bôm≠
, 
bôm≠
,É4b->
bd_sb
->
s_blocksize
)) {

497 *
b1
, *
b2
;

498 
i
;

499 
b1
 = (*Ë
e4b
->
bd_öfo
->
bb_bôm≠
;

500 
b2
 = (*Ë
bôm≠
;

501 
i
 = 0; i < 
e4b
->
bd_sb
->
s_blocksize
; i++) {

502 i‡(
b1
[
i
] !
b2
[i]) {

503 
	`pxt4_msg
(
e4b
->
bd_sb
, 
KERN_ERR
,

507 
e4b
->
bd_group
, 
i
, i * 8, 
b1
[i], 
b2
[i]);

508 
	`BUG
();

512 
	}
}

515 
ölöe
 
	$mb_‰ì_blocks_doubÀ
(
öode
 *inode,

516 
pxt4_buddy
 *
e4b
, 
fú°
, 
cou¡
)

519 
	}
}

520 
ölöe
 
	$mb_m¨k_u£d_doubÀ
(
pxt4_buddy
 *
e4b
,

521 
fú°
, 
cou¡
)

524 
	}
}

525 
ölöe
 
	$mb_cmp_bôm≠s
(
pxt4_buddy
 *
e4b
, *
bôm≠
)

528 
	}
}

531 #ifde‡
AGGRESSIVE_CHECK


533 
	#MB_CHECK_ASSERT
(
as£π
) \

535 i‡(!(
as£π
)) { \

536 
	`¥ötk
(
KERN_EMERG
 \

538 
fun˘i⁄
, 
fûe
, 
löe
, #assert); \

539 
	`BUG
(); \

541 } 0)

	)

543 
	$__mb_check_buddy
(
pxt4_buddy
 *
e4b
, *
fûe
,

544 c⁄° *
fun˘i⁄
, 
löe
)

546 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

547 
‹dî
 = 
e4b
->
bd_blkbôs
 + 1;

548 
max
;

549 
max2
;

550 
i
;

551 
j
;

552 
k
;

553 
cou¡
;

554 
pxt4_group_öfo
 *
gΩ
;

555 
‰agmíts
 = 0;

556 
f°¨t
;

557 
li°_hód
 *
cur
;

558 *
buddy
;

559 *
buddy2
;

562 
mb_check_cou¡î
;

563 i‡(
mb_check_cou¡î
++ % 100 != 0)

567 
‹dî
 > 1) {

568 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
);

569 
	`MB_CHECK_ASSERT
(
buddy
);

570 
buddy2
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
 - 1, &
max2
);

571 
	`MB_CHECK_ASSERT
(
buddy2
);

572 
	`MB_CHECK_ASSERT
(
buddy
 !
buddy2
);

573 
	`MB_CHECK_ASSERT
(
max
 * 2 =
max2
);

575 
cou¡
 = 0;

576 
i
 = 0; i < 
max
; i++) {

578 i‡(
	`mb_ã°_bô
(
i
, 
buddy
)) {

580 i‡(!
	`mb_ã°_bô
(
i
 << 1, 
buddy2
)) {

581 
	`MB_CHECK_ASSERT
(

582 
	`mb_ã°_bô
((
i
<<1)+1, 
buddy2
));

583 } i‡(!
	`mb_ã°_bô
((
i
 << 1Ë+ 1, 
buddy2
)) {

584 
	`MB_CHECK_ASSERT
(

585 
	`mb_ã°_bô
(
i
 << 1, 
buddy2
));

591 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
(
i
 << 1, 
buddy2
));

592 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
((
i
 << 1Ë+ 1, 
buddy2
));

594 
j
 = 0; j < (1 << 
‹dî
); j++) {

595 
k
 = (
i
 * (1 << 
‹dî
)Ë+ 
j
;

596 
	`MB_CHECK_ASSERT
(

597 !
	`mb_ã°_bô
(
k
, 
e4b
->
bd_bôm≠
));

599 
cou¡
++;

601 
	`MB_CHECK_ASSERT
(
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
] =
cou¡
);

602 
‹dî
--;

605 
f°¨t
 = -1;

606 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 0, &
max
);

607 
i
 = 0; i < 
max
; i++) {

608 i‡(!
	`mb_ã°_bô
(
i
, 
buddy
)) {

609 
	`MB_CHECK_ASSERT
(
i
 >
e4b
->
bd_öfo
->
bb_fú°_‰ì
);

610 i‡(
f°¨t
 == -1) {

611 
‰agmíts
++;

612 
f°¨t
 = 
i
;

616 
f°¨t
 = -1;

618 
j
 = 0; j < 
e4b
->
bd_blkbôs
 + 1; j++) {

619 
buddy2
 = 
	`mb_föd_buddy
(
e4b
, 
j
, &
max2
);

620 
k
 = 
i
 >> 
j
;

621 
	`MB_CHECK_ASSERT
(
k
 < 
max2
);

622 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
(
k
, 
buddy2
));

625 
	`MB_CHECK_ASSERT
(!
	`PXT4_MB_GRP_NEED_INIT
(
e4b
->
bd_öfo
));

626 
	`MB_CHECK_ASSERT
(
e4b
->
bd_öfo
->
bb_‰agmíts
 =
‰agmíts
);

628 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
e4b
->
bd_group
);

629 
	`li°_f‹_óch
(
cur
, &
gΩ
->
bb_¥óŒoc_li°
) {

630 
pxt4_group_t
 
grou≤r
;

631 
pxt4_¥óŒoc_•a˚
 *
∑
;

632 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
, 
∑_group_li°
);

633 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
, &
grou≤r
, &
k
);

634 
	`MB_CHECK_ASSERT
(
grou≤r
 =
e4b
->
bd_group
);

635 
i
 = 0; i < 
∑
->
∑_Àn
; i++)

636 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
(
k
 + 
i
, 
buddy
));

639 
	}
}

640 #unde‡
MB_CHECK_ASSERT


641 
	#mb_check_buddy
(
e4b
Ë
	`__mb_check_buddy
(e4b, \

642 
__FILE__
, 
__func__
, 
__LINE__
)

	)

644 
	#mb_check_buddy
(
e4b
)

	)

653 
	$pxt4_mb_m¨k_‰ì_sim∂e
(
su≥r_block
 *
sb
,

654 *
buddy
, 
pxt4_gΩblk_t
 
fú°
,Öxt4_gΩblk_à
Àn
,

655 
pxt4_group_öfo
 *
gΩ
)

657 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

658 
pxt4_gΩblk_t
 
mö
;

659 
pxt4_gΩblk_t
 
max
;

660 
pxt4_gΩblk_t
 
chunk
;

661 
b‹dî
;

663 
	`BUG_ON
(
Àn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
));

665 
b‹dî
 = 2 << 
sb
->
s_blocksize_bôs
;

667 
Àn
 > 0) {

669 
max
 = 
	`ffs
(
fú°
 | 
b‹dî
) - 1;

672 
mö
 = 
	`Ês
(
Àn
) - 1;

674 i‡(
max
 < 
mö
)

675 
mö
 = 
max
;

676 
chunk
 = 1 << 
mö
;

679 
gΩ
->
bb_cou¡îs
[
mö
]++;

680 i‡(
mö
 > 0)

681 
	`mb_˛ór_bô
(
fú°
 >> 
mö
,

682 
buddy
 + 
sbi
->
s_mb_off£ts
[
mö
]);

684 
Àn
 -
chunk
;

685 
fú°
 +
chunk
;

687 
	}
}

694 
	$mb_£t_œrge°_‰ì_‹dî
(
su≥r_block
 *
sb
, 
pxt4_group_öfo
 *
gΩ
)

696 
i
;

697 
bôs
;

699 
gΩ
->
bb_œrge°_‰ì_‹dî
 = -1;

701 
bôs
 = 
sb
->
s_blocksize_bôs
 + 1;

702 
i
 = 
bôs
; i >= 0; i--) {

703 i‡(
gΩ
->
bb_cou¡îs
[
i
] > 0) {

704 
gΩ
->
bb_œrge°_‰ì_‹dî
 = 
i
;

708 
	}
}

710 
noölöe_f‹_°ack


711 
	$pxt4_mb_gíî©e_buddy
(
su≥r_block
 *
sb
,

712 *
buddy
, *
bôm≠
, 
pxt4_group_t
 
group
)

714 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

715 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

716 
pxt4_gΩblk_t
 
max
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

717 
pxt4_gΩblk_t
 
i
 = 0;

718 
pxt4_gΩblk_t
 
fú°
;

719 
pxt4_gΩblk_t
 
Àn
;

720 
‰ì
 = 0;

721 
‰agmíts
 = 0;

722 
≥riod
 = 
	`gë_cy˛es
();

726 
i
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
max
, 0);

727 
gΩ
->
bb_fú°_‰ì
 = 
i
;

728 
i
 < 
max
) {

729 
‰agmíts
++;

730 
fú°
 = 
i
;

731 
i
 = 
	`mb_föd_√xt_bô
(
bôm≠
, 
max
, i);

732 
Àn
 = 
i
 - 
fú°
;

733 
‰ì
 +
Àn
;

734 i‡(
Àn
 > 1)

735 
	`pxt4_mb_m¨k_‰ì_sim∂e
(
sb
, 
buddy
, 
fú°
, 
Àn
, 
gΩ
);

737 
gΩ
->
bb_cou¡îs
[0]++;

738 i‡(
i
 < 
max
)

739 
i
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
max
, i);

741 
gΩ
->
bb_‰agmíts
 = 
‰agmíts
;

743 i‡(
‰ì
 !
gΩ
->
bb_‰ì
) {

744 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
group
, 0, 0,

747 
‰ì
, 
gΩ
->
bb_‰ì
);

752 
gΩ
->
bb_‰ì
 = 
‰ì
;

753 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
group
,

754 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

756 
	`mb_£t_œrge°_‰ì_‹dî
(
sb
, 
gΩ
);

758 
	`˛ór_bô
(
PXT4_GROUP_INFO_NEED_INIT_BIT
, &(
gΩ
->
bb_°©e
));

760 
≥riod
 = 
	`gë_cy˛es
() -Öeriod;

761 
	`•ö_lock
(&
sbi
->
s_bÆ_lock
);

762 
sbi
->
s_mb_buddõs_gíî©ed
++;

763 
sbi
->
s_mb_gíî©i⁄_time
 +
≥riod
;

764 
	`•ö_u∆ock
(&
sbi
->
s_bÆ_lock
);

765 
	}
}

767 
	$mb_ªgíî©e_buddy
(
pxt4_buddy
 *
e4b
)

769 
cou¡
;

770 
‹dî
 = 1;

771 *
buddy
;

773 (
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
++, &
cou¡
))) {

774 
	`pxt4_£t_bôs
(
buddy
, 0, 
cou¡
);

776 
e4b
->
bd_öfo
->
bb_‰agmíts
 = 0;

777 
	`mem£t
(
e4b
->
bd_öfo
->
bb_cou¡îs
, 0,

778 (*
e4b
->
bd_öfo
->
bb_cou¡îs
) *

779 (
e4b
->
bd_sb
->
s_blocksize_bôs
 + 2));

781 
	`pxt4_mb_gíî©e_buddy
(
e4b
->
bd_sb
,É4b->
bd_buddy
,

782 
e4b
->
bd_bôm≠
,É4b->
bd_group
);

783 
	}
}

805 
	$pxt4_mb_öô_ˇche
(
∑ge
 *∑ge, *
öc‹e
, 
gÂ_t
 
gÂ
)

807 
pxt4_group_t
 
ngroups
;

808 
blocksize
;

809 
blocks_≥r_∑ge
;

810 
groups_≥r_∑ge
;

811 
îr
 = 0;

812 
i
;

813 
pxt4_group_t
 
fú°_group
, 
group
;

814 
fú°_block
;

815 
su≥r_block
 *
sb
;

816 
buf„r_hód
 *
bhs
;

817 
buf„r_hód
 **
bh
 = 
NULL
;

818 
öode
 *inode;

819 *
d©a
;

820 *
bôm≠
;

821 
pxt4_group_öfo
 *
gröfo
;

823 
	`mb_debug
(1, "öôÖagê%lu\n", 
∑ge
->
ödex
);

825 
öode
 = 
∑ge
->
m≠pög
->
ho°
;

826 
sb
 = 
öode
->
i_sb
;

827 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

828 
blocksize
 = 
	`i_blocksize
(
öode
);

829 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 / 
blocksize
;

831 
groups_≥r_∑ge
 = 
blocks_≥r_∑ge
 >> 1;

832 i‡(
groups_≥r_∑ge
 == 0)

833 
groups_≥r_∑ge
 = 1;

836 i‡(
groups_≥r_∑ge
 > 1) {

837 
i
 = (
buf„r_hód
 *Ë* 
groups_≥r_∑ge
;

838 
bh
 = 
	`kzÆloc
(
i
, 
gÂ
);

839 i‡(
bh
 =
NULL
) {

840 
îr
 = -
ENOMEM
;

841 
out
;

844 
bh
 = &
bhs
;

846 
fú°_group
 = 
∑ge
->
ödex
 * 
blocks_≥r_∑ge
 / 2;

849 
i
 = 0, 
group
 = 
fú°_group
; i < 
groups_≥r_∑ge
; i++, group++) {

850 i‡(
group
 >
ngroups
)

853 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

860 i‡(
	`PageU±od©e
(
∑ge
Ë&& !
	`PXT4_MB_GRP_NEED_INIT
(
gröfo
)) {

861 
bh
[
i
] = 
NULL
;

864 
bh
[
i
] = 
	`pxt4_ªad_block_bôm≠_nowaô
(
sb
, 
group
);

865 i‡(
	`IS_ERR
(
bh
[
i
])) {

866 
îr
 = 
	`PTR_ERR
(
bh
[
i
]);

867 
bh
[
i
] = 
NULL
;

868 
out
;

870 
	`mb_debug
(1, "ªad bôm≠ f‹ grou∞%u\n", 
group
);

874 
i
 = 0, 
group
 = 
fú°_group
; i < 
groups_≥r_∑ge
; i++, group++) {

875 
îr2
;

877 i‡(!
bh
[
i
])

879 
îr2
 = 
	`pxt4_waô_block_bôm≠
(
sb
, 
group
, 
bh
[
i
]);

880 i‡(!
îr
)

881 
îr
 = 
îr2
;

884 
fú°_block
 = 
∑ge
->
ödex
 * 
blocks_≥r_∑ge
;

885 
i
 = 0; i < 
blocks_≥r_∑ge
; i++) {

886 
group
 = (
fú°_block
 + 
i
) >> 1;

887 i‡(
group
 >
ngroups
)

890 i‡(!
bh
[
group
 - 
fú°_group
])

894 i‡(!
	`buf„r_vîifõd
(
bh
[
group
 - 
fú°_group
]))

897 
îr
 = 0;

905 
d©a
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
i
 * 
blocksize
);

906 
bôm≠
 = 
bh
[
group
 - 
fú°_group
]->
b_d©a
;

912 i‡((
fú°_block
 + 
i
) & 1) {

914 
	`BUG_ON
(
öc‹e
 =
NULL
);

915 
	`mb_debug
(1, "put buddy for group %u inÖage %lu/%x\n",

916 
group
, 
∑ge
->
ödex
, 
i
 * 
blocksize
);

917 
	`åa˚_pxt4_mb_buddy_bôm≠_lﬂd
(
sb
, 
group
);

918 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

919 
gröfo
->
bb_‰agmíts
 = 0;

920 
	`mem£t
(
gröfo
->
bb_cou¡îs
, 0,

921 (*
gröfo
->
bb_cou¡îs
) *

922 (
sb
->
s_blocksize_bôs
+2));

926 
	`pxt4_lock_group
(
sb
, 
group
);

928 
	`mem£t
(
d©a
, 0xff, 
blocksize
);

929 
	`pxt4_mb_gíî©e_buddy
(
sb
, 
d©a
, 
öc‹e
, 
group
);

930 
	`pxt4_u∆ock_group
(
sb
, 
group
);

931 
öc‹e
 = 
NULL
;

934 
	`BUG_ON
(
öc‹e
 !
NULL
);

935 
	`mb_debug
(1, "put bitmap for group %u inÖage %lu/%x\n",

936 
group
, 
∑ge
->
ödex
, 
i
 * 
blocksize
);

937 
	`åa˚_pxt4_mb_bôm≠_lﬂd
(
sb
, 
group
);

940 
	`pxt4_lock_group
(
sb
, 
group
);

941 
	`mem˝y
(
d©a
, 
bôm≠
, 
blocksize
);

944 
	`pxt4_mb_gíî©e_‰om_∑
(
sb
, 
d©a
, 
group
);

945 
	`pxt4_mb_gíî©e_‰om_‰ìli°
(
sb
, 
d©a
, 
group
);

946 
	`pxt4_u∆ock_group
(
sb
, 
group
);

951 
öc‹e
 = 
d©a
;

954 
	`SëPageU±od©e
(
∑ge
);

956 
out
:

957 i‡(
bh
) {

958 
i
 = 0; i < 
groups_≥r_∑ge
; i++)

959 
	`bªl£
(
bh
[
i
]);

960 i‡(
bh
 !&
bhs
)

961 
	`k‰ì
(
bh
);

963  
îr
;

964 
	}
}

972 
	$pxt4_mb_gë_buddy_∑ge_lock
(
su≥r_block
 *
sb
,

973 
pxt4_group_t
 
group
, 
pxt4_buddy
 *
e4b
, 
gÂ_t
 
gÂ
)

975 
öode
 *öodê
	`PXT4_SB
(
sb
)->
s_buddy_ˇche
;

976 
block
, 
≤um
, 
poff
;

977 
blocks_≥r_∑ge
;

978 
∑ge
 *page;

980 
e4b
->
bd_buddy_∑ge
 = 
NULL
;

981 
e4b
->
bd_bôm≠_∑ge
 = 
NULL
;

983 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 / 
sb
->
s_blocksize
;

989 
block
 = 
group
 * 2;

990 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

991 
poff
 = 
block
 % 
blocks_≥r_∑ge
;

992 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

993 i‡(!
∑ge
)

994  -
ENOMEM
;

995 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

996 
e4b
->
bd_bôm≠_∑ge
 = 
∑ge
;

997 
e4b
->
bd_bôm≠
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
poff
 * 
sb
->
s_blocksize
);

999 i‡(
blocks_≥r_∑ge
 >= 2) {

1004 
block
++;

1005 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

1006 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

1007 i‡(!
∑ge
)

1008  -
ENOMEM
;

1009 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

1010 
e4b
->
bd_buddy_∑ge
 = 
∑ge
;

1012 
	}
}

1014 
	$pxt4_mb_put_buddy_∑ge_lock
(
pxt4_buddy
 *
e4b
)

1016 i‡(
e4b
->
bd_bôm≠_∑ge
) {

1017 
	`u∆ock_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1018 
	`put_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1020 i‡(
e4b
->
bd_buddy_∑ge
) {

1021 
	`u∆ock_∑ge
(
e4b
->
bd_buddy_∑ge
);

1022 
	`put_∑ge
(
e4b
->
bd_buddy_∑ge
);

1024 
	}
}

1031 
noölöe_f‹_°ack


1032 
	$pxt4_mb_öô_group
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
, 
gÂ_t
 
gÂ
)

1035 
pxt4_group_öfo
 *
this_gΩ
;

1036 
pxt4_buddy
 
e4b
;

1037 
∑ge
 *page;

1038 
ªt
 = 0;

1040 
	`might_¶ìp
();

1041 
	`mb_debug
(1, "öô grou∞%u\n", 
group
);

1042 
this_gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1052 
ªt
 = 
	`pxt4_mb_gë_buddy_∑ge_lock
(
sb
, 
group
, &
e4b
, 
gÂ
);

1053 i‡(
ªt
 || !
	`PXT4_MB_GRP_NEED_INIT
(
this_gΩ
)) {

1058 
îr
;

1061 
∑ge
 = 
e4b
.
bd_bôm≠_∑ge
;

1062 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
NULL
, 
gÂ
);

1063 i‡(
ªt
)

1064 
îr
;

1065 i‡(!
	`PageU±od©e
(
∑ge
)) {

1066 
ªt
 = -
EIO
;

1067 
îr
;

1070 i‡(
e4b
.
bd_buddy_∑ge
 =
NULL
) {

1076 
ªt
 = 0;

1077 
îr
;

1080 
∑ge
 = 
e4b
.
bd_buddy_∑ge
;

1081 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
e4b
.
bd_bôm≠
, 
gÂ
);

1082 i‡(
ªt
)

1083 
îr
;

1084 i‡(!
	`PageU±od©e
(
∑ge
)) {

1085 
ªt
 = -
EIO
;

1086 
îr
;

1088 
îr
:

1089 
	`pxt4_mb_put_buddy_∑ge_lock
(&
e4b
);

1090  
ªt
;

1091 
	}
}

1098 
noölöe_f‹_°ack
 

1099 
	$pxt4_mb_lﬂd_buddy_gÂ
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

1100 
pxt4_buddy
 *
e4b
, 
gÂ_t
 
gÂ
)

1102 
blocks_≥r_∑ge
;

1103 
block
;

1104 
≤um
;

1105 
poff
;

1106 
∑ge
 *page;

1107 
ªt
;

1108 
pxt4_group_öfo
 *
gΩ
;

1109 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1110 
öode
 *öodê
sbi
->
s_buddy_ˇche
;

1112 
	`might_¶ìp
();

1113 
	`mb_debug
(1, "lﬂd grou∞%u\n", 
group
);

1115 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 / 
sb
->
s_blocksize
;

1116 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1118 
e4b
->
bd_blkbôs
 = 
sb
->
s_blocksize_bôs
;

1119 
e4b
->
bd_öfo
 = 
gΩ
;

1120 
e4b
->
bd_sb
 = 
sb
;

1121 
e4b
->
bd_group
 = 
group
;

1122 
e4b
->
bd_buddy_∑ge
 = 
NULL
;

1123 
e4b
->
bd_bôm≠_∑ge
 = 
NULL
;

1125 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gΩ
))) {

1130 
ªt
 = 
	`pxt4_mb_öô_group
(
sb
, 
group
, 
gÂ
);

1131 i‡(
ªt
)

1132  
ªt
;

1140 
block
 = 
group
 * 2;

1141 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

1142 
poff
 = 
block
 % 
blocks_≥r_∑ge
;

1146 
∑ge
 = 
	`föd_gë_∑ge_Êags
(
öode
->
i_m≠pög
, 
≤um
, 
FGP_ACCESSED
);

1147 i‡(
∑ge
 =
NULL
 || !
	`PageU±od©e
(page)) {

1148 i‡(
∑ge
)

1157 
	`put_∑ge
(
∑ge
);

1158 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

1159 i‡(
∑ge
) {

1160 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

1161 i‡(!
	`PageU±od©e
(
∑ge
)) {

1162 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
NULL
, 
gÂ
);

1163 i‡(
ªt
) {

1164 
	`u∆ock_∑ge
(
∑ge
);

1165 
îr
;

1167 
	`mb_cmp_bôm≠s
(
e4b
, 
	`∑ge_addªss
(
∑ge
) +

1168 (
poff
 * 
sb
->
s_blocksize
));

1170 
	`u∆ock_∑ge
(
∑ge
);

1173 i‡(
∑ge
 =
NULL
) {

1174 
ªt
 = -
ENOMEM
;

1175 
îr
;

1177 i‡(!
	`PageU±od©e
(
∑ge
)) {

1178 
ªt
 = -
EIO
;

1179 
îr
;

1183 
e4b
->
bd_bôm≠_∑ge
 = 
∑ge
;

1184 
e4b
->
bd_bôm≠
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
poff
 * 
sb
->
s_blocksize
);

1186 
block
++;

1187 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

1188 
poff
 = 
block
 % 
blocks_≥r_∑ge
;

1190 
∑ge
 = 
	`föd_gë_∑ge_Êags
(
öode
->
i_m≠pög
, 
≤um
, 
FGP_ACCESSED
);

1191 i‡(
∑ge
 =
NULL
 || !
	`PageU±od©e
(page)) {

1192 i‡(
∑ge
)

1193 
	`put_∑ge
(
∑ge
);

1194 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

1195 i‡(
∑ge
) {

1196 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

1197 i‡(!
	`PageU±od©e
(
∑ge
)) {

1198 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
e4b
->
bd_bôm≠
,

1199 
gÂ
);

1200 i‡(
ªt
) {

1201 
	`u∆ock_∑ge
(
∑ge
);

1202 
îr
;

1205 
	`u∆ock_∑ge
(
∑ge
);

1208 i‡(
∑ge
 =
NULL
) {

1209 
ªt
 = -
ENOMEM
;

1210 
îr
;

1212 i‡(!
	`PageU±od©e
(
∑ge
)) {

1213 
ªt
 = -
EIO
;

1214 
îr
;

1218 
e4b
->
bd_buddy_∑ge
 = 
∑ge
;

1219 
e4b
->
bd_buddy
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
poff
 * 
sb
->
s_blocksize
);

1221 
	`BUG_ON
(
e4b
->
bd_bôm≠_∑ge
 =
NULL
);

1222 
	`BUG_ON
(
e4b
->
bd_buddy_∑ge
 =
NULL
);

1226 
îr
:

1227 i‡(
∑ge
)

1228 
	`put_∑ge
(
∑ge
);

1229 i‡(
e4b
->
bd_bôm≠_∑ge
)

1230 
	`put_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1231 i‡(
e4b
->
bd_buddy_∑ge
)

1232 
	`put_∑ge
(
e4b
->
bd_buddy_∑ge
);

1233 
e4b
->
bd_buddy
 = 
NULL
;

1234 
e4b
->
bd_bôm≠
 = 
NULL
;

1235  
ªt
;

1236 
	}
}

1238 
	$pxt4_mb_lﬂd_buddy
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

1239 
pxt4_buddy
 *
e4b
)

1241  
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
group
, 
e4b
, 
GFP_NOFS
);

1242 
	}
}

1244 
	$pxt4_mb_u∆ﬂd_buddy
(
pxt4_buddy
 *
e4b
)

1246 i‡(
e4b
->
bd_bôm≠_∑ge
)

1247 
	`put_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1248 i‡(
e4b
->
bd_buddy_∑ge
)

1249 
	`put_∑ge
(
e4b
->
bd_buddy_∑ge
);

1250 
	}
}

1253 
	$mb_föd_‹dî_f‹_block
(
pxt4_buddy
 *
e4b
, 
block
)

1255 
‹dî
 = 1;

1256 
bb_ö¸
 = 1 << (
e4b
->
bd_blkbôs
 - 1);

1257 *
bb
;

1259 
	`BUG_ON
(
e4b
->
bd_bôm≠
 =e4b->
bd_buddy
);

1260 
	`BUG_ON
(
block
 >(1 << (
e4b
->
bd_blkbôs
 + 3)));

1262 
bb
 = 
e4b
->
bd_buddy
;

1263 
‹dî
 <
e4b
->
bd_blkbôs
 + 1) {

1264 
block
 = block >> 1;

1265 i‡(!
	`mb_ã°_bô
(
block
, 
bb
)) {

1267  
‹dî
;

1269 
bb
 +
bb_ö¸
;

1270 
bb_ö¸
 >>= 1;

1271 
‹dî
++;

1274 
	}
}

1276 
	$mb_˛ór_bôs
(*
bm
, 
cur
, 
Àn
)

1278 
__u32
 *
addr
;

1280 
Àn
 = 
cur
 +Üen;

1281 
cur
 < 
Àn
) {

1282 i‡((
cur
 & 31Ë=0 && (
Àn
 - cur) >= 32) {

1284 
addr
 = 
bm
 + (
cur
 >> 3);

1285 *
addr
 = 0;

1286 
cur
 += 32;

1289 
	`mb_˛ór_bô
(
cur
, 
bm
);

1290 
cur
++;

1292 
	}
}

1297 
	$mb_ã°_™d_˛ór_bôs
(*
bm
, 
cur
, 
Àn
)

1299 
__u32
 *
addr
;

1300 
zîo_bô
 = -1;

1302 
Àn
 = 
cur
 +Üen;

1303 
cur
 < 
Àn
) {

1304 i‡((
cur
 & 31Ë=0 && (
Àn
 - cur) >= 32) {

1306 
addr
 = 
bm
 + (
cur
 >> 3);

1307 i‡(*
addr
 !(
__u32
)(-1Ë&& 
zîo_bô
 == -1)

1308 
zîo_bô
 = 
cur
 + 
	`mb_föd_√xt_zîo_bô
(
addr
, 32, 0);

1309 *
addr
 = 0;

1310 
cur
 += 32;

1313 i‡(!
	`mb_ã°_™d_˛ór_bô
(
cur
, 
bm
Ë&& 
zîo_bô
 == -1)

1314 
zîo_bô
 = 
cur
;

1315 
cur
++;

1318  
zîo_bô
;

1319 
	}
}

1321 
	$pxt4_£t_bôs
(*
bm
, 
cur
, 
Àn
)

1323 
__u32
 *
addr
;

1325 
Àn
 = 
cur
 +Üen;

1326 
cur
 < 
Àn
) {

1327 i‡((
cur
 & 31Ë=0 && (
Àn
 - cur) >= 32) {

1329 
addr
 = 
bm
 + (
cur
 >> 3);

1330 *
addr
 = 0xffffffff;

1331 
cur
 += 32;

1334 
	`mb_£t_bô
(
cur
, 
bm
);

1335 
cur
++;

1337 
	}
}

1342 
ölöe
 
	$mb_buddy_adju°_b‹dî
(* 
bô
, * 
bôm≠
, 
side
)

1344 i‡(
	`mb_ã°_bô
(*
bô
 + 
side
, 
bôm≠
)) {

1345 
	`mb_˛ór_bô
(*
bô
, 
bôm≠
);

1346 (*
bô
Ë-
side
;

1350 (*
bô
Ë+
side
;

1351 
	`mb_£t_bô
(*
bô
, 
bôm≠
);

1354 
	}
}

1356 
	$mb_buddy_m¨k_‰ì
(
pxt4_buddy
 *
e4b
, 
fú°
, 
œ°
)

1358 
max
;

1359 
‹dî
 = 1;

1360 *
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
);

1362 
buddy
) {

1363 *
buddy2
;

1394 i‡(
fú°
 & 1)

1395 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
] +
	`mb_buddy_adju°_b‹dî
(&
fú°
, 
buddy
, -1);

1396 i‡(!(
œ°
 & 1))

1397 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
] +
	`mb_buddy_adju°_b‹dî
(&
œ°
, 
buddy
, 1);

1398 i‡(
fú°
 > 
œ°
)

1400 
‹dî
++;

1402 i‡(
fú°
 =
œ°
 || !(
buddy2
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
))) {

1403 
	`mb_˛ór_bôs
(
buddy
, 
fú°
, 
œ°
 - first + 1);

1404 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
 - 1] +
œ°
 - 
fú°
 + 1;

1407 
fú°
 >>= 1;

1408 
œ°
 >>= 1;

1409 
buddy
 = 
buddy2
;

1411 
	}
}

1413 
	$mb_‰ì_blocks
(
öode
 *öode, 
pxt4_buddy
 *
e4b
,

1414 
fú°
, 
cou¡
)

1416 
À·_is_‰ì
 = 0;

1417 
right_is_‰ì
 = 0;

1418 
block
;

1419 
œ°
 = 
fú°
 + 
cou¡
 - 1;

1420 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

1422 i‡(
	`WARN_ON
(
cou¡
 == 0))

1424 
	`BUG_ON
(
œ°
 >(
sb
->
s_blocksize
 << 3));

1425 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
sb
, 
e4b
->
bd_group
));

1427 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
e4b
->
bd_öfo
)))

1430 
	`mb_check_buddy
(
e4b
);

1431 
	`mb_‰ì_blocks_doubÀ
(
öode
, 
e4b
, 
fú°
, 
cou¡
);

1433 
e4b
->
bd_öfo
->
bb_‰ì
 +
cou¡
;

1434 i‡(
fú°
 < 
e4b
->
bd_öfo
->
bb_fú°_‰ì
)

1435 
e4b
->
bd_öfo
->
bb_fú°_‰ì
 = 
fú°
;

1440 i‡(
fú°
 != 0)

1441 
À·_is_‰ì
 = !
	`mb_ã°_bô
(
fú°
 - 1, 
e4b
->
bd_bôm≠
);

1442 
block
 = 
	`mb_ã°_™d_˛ór_bôs
(
e4b
->
bd_bôm≠
, 
fú°
, 
cou¡
);

1443 i‡(
œ°
 + 1 < 
	`PXT4_SB
(
sb
)->
s_mb_maxs
[0])

1444 
right_is_‰ì
 = !
	`mb_ã°_bô
(
œ°
 + 1, 
e4b
->
bd_bôm≠
);

1446 i‡(
	`u∆ikñy
(
block
 != -1)) {

1447 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1448 
pxt4_fsblk_t
 
blockƒ
;

1450 
blockƒ
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
e4b
->
bd_group
);

1451 
blockƒ
 +
	`PXT4_C2B
(
sbi
, 
block
);

1452 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
,

1453 
öode
 ? inode->
i_öo
 : 0,

1454 
blockƒ
,

1457 
block
);

1458 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

1459 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1460 
	`mb_ªgíî©e_buddy
(
e4b
);

1461 
d⁄e
;

1465 i‡(
À·_is_‰ì
 && 
right_is_‰ì
)

1466 
e4b
->
bd_öfo
->
bb_‰agmíts
--;

1467 i‡(!
À·_is_‰ì
 && !
right_is_‰ì
)

1468 
e4b
->
bd_öfo
->
bb_‰agmíts
++;

1476 i‡(
fú°
 & 1) {

1477 
fú°
 +!
À·_is_‰ì
;

1478 
e4b
->
bd_öfo
->
bb_cou¡îs
[0] +
À·_is_‰ì
 ? -1 : 1;

1480 i‡(!(
œ°
 & 1)) {

1481 
œ°
 -!
right_is_‰ì
;

1482 
e4b
->
bd_öfo
->
bb_cou¡îs
[0] +
right_is_‰ì
 ? -1 : 1;

1485 i‡(
fú°
 <
œ°
)

1486 
	`mb_buddy_m¨k_‰ì
(
e4b
, 
fú°
 >> 1, 
œ°
 >> 1);

1488 
d⁄e
:

1489 
	`mb_£t_œrge°_‰ì_‹dî
(
sb
, 
e4b
->
bd_öfo
);

1490 
	`mb_check_buddy
(
e4b
);

1491 
	}
}

1493 
	$mb_föd_exã¡
(
pxt4_buddy
 *
e4b
, 
block
,

1494 
√eded
, 
pxt4_‰ì_exã¡
 *
ex
)

1496 
√xt
 = 
block
;

1497 
max
, 
‹dî
;

1498 *
buddy
;

1500 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
e4b
->
bd_sb
,É4b->
bd_group
));

1501 
	`BUG_ON
(
ex
 =
NULL
);

1503 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 0, &
max
);

1504 
	`BUG_ON
(
buddy
 =
NULL
);

1505 
	`BUG_ON
(
block
 >
max
);

1506 i‡(
	`mb_ã°_bô
(
block
, 
buddy
)) {

1507 
ex
->
„_Àn
 = 0;

1508 
ex
->
„_°¨t
 = 0;

1509 
ex
->
„_group
 = 0;

1514 
‹dî
 = 
	`mb_föd_‹dî_f‹_block
(
e4b
, 
block
);

1515 
block
 = block >> 
‹dî
;

1517 
ex
->
„_Àn
 = 1 << 
‹dî
;

1518 
ex
->
„_°¨t
 = 
block
 << 
‹dî
;

1519 
ex
->
„_group
 = 
e4b
->
bd_group
;

1522 
√xt
 =Çexà- 
ex
->
„_°¨t
;

1523 
ex
->
„_Àn
 -
√xt
;

1524 
ex
->
„_°¨t
 +
√xt
;

1526 
√eded
 > 
ex
->
„_Àn
 &&

1527 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
)) {

1529 i‡(
block
 + 1 >
max
)

1532 
√xt
 = (
block
 + 1Ë* (1 << 
‹dî
);

1533 i‡(
	`mb_ã°_bô
(
√xt
, 
e4b
->
bd_bôm≠
))

1536 
‹dî
 = 
	`mb_föd_‹dî_f‹_block
(
e4b
, 
√xt
);

1538 
block
 = 
√xt
 >> 
‹dî
;

1539 
ex
->
„_Àn
 +1 << 
‹dî
;

1542 i‡(
ex
->
„_°¨t
 +Éx->
„_Àn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
e4b
->
bd_sb
)) {

1544 
	`WARN_ON
(1);

1545 
	`pxt4_îr‹
(
e4b
->
bd_sb
, "corruption or bug in mb_find_extent "

1547 
block
, 
‹dî
, 
√eded
, 
ex
->
„_group
,Éx->
„_°¨t
,

1548 
ex
->
„_Àn
,Éx->
„_logiˇl
);

1549 
ex
->
„_Àn
 = 0;

1550 
ex
->
„_°¨t
 = 0;

1551 
ex
->
„_group
 = 0;

1553  
ex
->
„_Àn
;

1554 
	}
}

1556 
	$mb_m¨k_u£d
(
pxt4_buddy
 *
e4b
, 
pxt4_‰ì_exã¡
 *
ex
)

1558 
‹d
;

1559 
mÀn
 = 0;

1560 
max
 = 0;

1561 
cur
;

1562 
°¨t
 = 
ex
->
„_°¨t
;

1563 
Àn
 = 
ex
->
„_Àn
;

1564 
ªt
 = 0;

1565 
Àn0
 = 
Àn
;

1566 *
buddy
;

1568 
	`BUG_ON
(
°¨t
 + 
Àn
 > (
e4b
->
bd_sb
->
s_blocksize
 << 3));

1569 
	`BUG_ON
(
e4b
->
bd_group
 !
ex
->
„_group
);

1570 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
e4b
->
bd_sb
,É4b->
bd_group
));

1571 
	`mb_check_buddy
(
e4b
);

1572 
	`mb_m¨k_u£d_doubÀ
(
e4b
, 
°¨t
, 
Àn
);

1574 
e4b
->
bd_öfo
->
bb_‰ì
 -
Àn
;

1575 i‡(
e4b
->
bd_öfo
->
bb_fú°_‰ì
 =
°¨t
)

1576 
e4b
->
bd_öfo
->
bb_fú°_‰ì
 +
Àn
;

1579 i‡(
°¨t
 != 0)

1580 
mÀn
 = !
	`mb_ã°_bô
(
°¨t
 - 1, 
e4b
->
bd_bôm≠
);

1581 i‡(
°¨t
 + 
Àn
 < 
	`PXT4_SB
(
e4b
->
bd_sb
)->
s_mb_maxs
[0])

1582 
max
 = !
	`mb_ã°_bô
(
°¨t
 + 
Àn
, 
e4b
->
bd_bôm≠
);

1583 i‡(
mÀn
 && 
max
)

1584 
e4b
->
bd_öfo
->
bb_‰agmíts
++;

1585 i‡(!
mÀn
 && !
max
)

1586 
e4b
->
bd_öfo
->
bb_‰agmíts
--;

1589 
Àn
) {

1590 
‹d
 = 
	`mb_föd_‹dî_f‹_block
(
e4b
, 
°¨t
);

1592 i‡(((
°¨t
 >> 
‹d
Ë<< ordË=°¨à&& 
Àn
 >= (1 << ord)) {

1594 
mÀn
 = 1 << 
‹d
;

1595 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹d
, &
max
);

1596 
	`BUG_ON
((
°¨t
 >> 
‹d
Ë>
max
);

1597 
	`mb_£t_bô
(
°¨t
 >> 
‹d
, 
buddy
);

1598 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]--;

1599 
°¨t
 +
mÀn
;

1600 
Àn
 -
mÀn
;

1601 
	`BUG_ON
(
Àn
 < 0);

1606 i‡(
ªt
 == 0)

1607 
ªt
 = 
Àn
 | (
‹d
 << 16);

1610 
	`BUG_ON
(
‹d
 <= 0);

1611 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹d
, &
max
);

1612 
	`mb_£t_bô
(
°¨t
 >> 
‹d
, 
buddy
);

1613 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]--;

1615 
‹d
--;

1616 
cur
 = (
°¨t
 >> 
‹d
) & ~1U;

1617 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹d
, &
max
);

1618 
	`mb_˛ór_bô
(
cur
, 
buddy
);

1619 
	`mb_˛ór_bô
(
cur
 + 1, 
buddy
);

1620 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]++;

1621 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]++;

1623 
	`mb_£t_œrge°_‰ì_‹dî
(
e4b
->
bd_sb
,É4b->
bd_öfo
);

1625 
	`pxt4_£t_bôs
(
e4b
->
bd_bôm≠
, 
ex
->
„_°¨t
, 
Àn0
);

1626 
	`mb_check_buddy
(
e4b
);

1628  
ªt
;

1629 
	}
}

1634 
	$pxt4_mb_u£_be°_found
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1635 
pxt4_buddy
 *
e4b
)

1637 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

1638 
ªt
;

1640 
	`BUG_ON
(
ac
->
ac_b_ex
.
„_group
 !
e4b
->
bd_group
);

1641 
	`BUG_ON
(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
);

1643 
ac
->
ac_b_ex
.
„_Àn
 = 
	`mö
◊c->ac_b_ex.„_Àn,ác->
ac_g_ex
.fe_len);

1644 
ac
->
ac_b_ex
.
„_logiˇl
 =ác->
ac_g_ex
.fe_logical;

1645 
ªt
 = 
	`mb_m¨k_u£d
(
e4b
, &
ac
->
ac_b_ex
);

1649 
ac
->
ac_f_ex
 =ác->
ac_b_ex
;

1651 
ac
->
ac_°©us
 = 
AC_STATUS_FOUND
;

1652 
ac
->
ac_èû
 = 
ªt
 & 0xffff;

1653 
ac
->
ac_buddy
 = 
ªt
 >> 16;

1662 
ac
->
ac_bôm≠_∑ge
 = 
e4b
->
bd_bôm≠_∑ge
;

1663 
	`gë_∑ge
(
ac
->
ac_bôm≠_∑ge
);

1664 
ac
->
ac_buddy_∑ge
 = 
e4b
->
bd_buddy_∑ge
;

1665 
	`gë_∑ge
(
ac
->
ac_buddy_∑ge
);

1667 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_STREAM_ALLOC
) {

1668 
	`•ö_lock
(&
sbi
->
s_md_lock
);

1669 
sbi
->
s_mb_œ°_group
 = 
ac
->
ac_f_ex
.
„_group
;

1670 
sbi
->
s_mb_œ°_°¨t
 = 
ac
->
ac_f_ex
.
„_°¨t
;

1671 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

1673 
	}
}

1679 
	$pxt4_mb_check_limôs
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1680 
pxt4_buddy
 *
e4b
,

1681 
föish_group
)

1683 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

1684 
pxt4_‰ì_exã¡
 *
bex
 = &
ac
->
ac_b_ex
;

1685 
pxt4_‰ì_exã¡
 *
gex
 = &
ac
->
ac_g_ex
;

1686 
pxt4_‰ì_exã¡
 
ex
;

1687 
max
;

1689 i‡(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
)

1694 i‡(
ac
->
ac_found
 > 
sbi
->
s_mb_max_to_sˇn
 &&

1695 !(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_FIRST
)) {

1696 
ac
->
ac_°©us
 = 
AC_STATUS_BREAK
;

1703 i‡(
bex
->
„_Àn
 < 
gex
->fe_len)

1706 i‡((
föish_group
 || 
ac
->
ac_found
 > 
sbi
->
s_mb_mö_to_sˇn
)

1707 && 
bex
->
„_group
 =
e4b
->
bd_group
) {

1711 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
bex
->
„_°¨t
, 
gex
->
„_Àn
, &
ex
);

1712 i‡(
max
 >
gex
->
„_Àn
) {

1713 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1717 
	}
}

1729 
	$pxt4_mb_mósuª_exã¡
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1730 
pxt4_‰ì_exã¡
 *
ex
,

1731 
pxt4_buddy
 *
e4b
)

1733 
pxt4_‰ì_exã¡
 *
bex
 = &
ac
->
ac_b_ex
;

1734 
pxt4_‰ì_exã¡
 *
gex
 = &
ac
->
ac_g_ex
;

1736 
	`BUG_ON
(
ex
->
„_Àn
 <= 0);

1737 
	`BUG_ON
(
ex
->
„_Àn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
ac
->
ac_sb
));

1738 
	`BUG_ON
(
ex
->
„_°¨t
 >
	`PXT4_CLUSTERS_PER_GROUP
(
ac
->
ac_sb
));

1739 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_CONTINUE
);

1741 
ac
->
ac_found
++;

1746 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_FIRST
)) {

1747 *
bex
 = *
ex
;

1748 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1755 i‡(
ex
->
„_Àn
 =
gex
->fe_len) {

1756 *
bex
 = *
ex
;

1757 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1764 i‡(
bex
->
„_Àn
 == 0) {

1765 *
bex
 = *
ex
;

1772 i‡(
bex
->
„_Àn
 < 
gex
->fe_len) {

1775 i‡(
ex
->
„_Àn
 > 
bex
->fe_len)

1776 *
bex
 = *
ex
;

1777 } i‡(
ex
->
„_Àn
 > 
gex
->fe_len) {

1781 i‡(
ex
->
„_Àn
 < 
bex
->fe_len)

1782 *
bex
 = *
ex
;

1785 
	`pxt4_mb_check_limôs
(
ac
, 
e4b
, 0);

1786 
	}
}

1788 
noölöe_f‹_°ack


1789 
	$pxt4_mb_åy_be°_found
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1790 
pxt4_buddy
 *
e4b
)

1792 
pxt4_‰ì_exã¡
 
ex
 = 
ac
->
ac_b_ex
;

1793 
pxt4_group_t
 
group
 = 
ex
.
„_group
;

1794 
max
;

1795 
îr
;

1797 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1798 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
ac
->
ac_sb
, 
group
, 
e4b
);

1799 i‡(
îr
)

1800  
îr
;

1802 
	`pxt4_lock_group
(
ac
->
ac_sb
, 
group
);

1803 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
ex
.
„_°¨t
,Éx.
„_Àn
, &ex);

1805 i‡(
max
 > 0) {

1806 
ac
->
ac_b_ex
 = 
ex
;

1807 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1810 
	`pxt4_u∆ock_group
(
ac
->
ac_sb
, 
group
);

1811 
	`pxt4_mb_u∆ﬂd_buddy
(
e4b
);

1814 
	}
}

1816 
noölöe_f‹_°ack


1817 
	$pxt4_mb_föd_by_gﬂl
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1818 
pxt4_buddy
 *
e4b
)

1820 
pxt4_group_t
 
group
 = 
ac
->
ac_g_ex
.
„_group
;

1821 
max
;

1822 
îr
;

1823 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

1824 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
ac
->
ac_sb
, 
group
);

1825 
pxt4_‰ì_exã¡
 
ex
;

1827 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_TRY_GOAL
))

1829 i‡(
gΩ
->
bb_‰ì
 == 0)

1832 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
ac
->
ac_sb
, 
group
, 
e4b
);

1833 i‡(
îr
)

1834  
îr
;

1836 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
e4b
->
bd_öfo
))) {

1837 
	`pxt4_mb_u∆ﬂd_buddy
(
e4b
);

1841 
	`pxt4_lock_group
(
ac
->
ac_sb
, 
group
);

1842 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
ac
->
ac_g_ex
.
„_°¨t
,

1843 
ac
->
ac_g_ex
.
„_Àn
, &
ex
);

1844 
ex
.
„_logiˇl
 = 0xDEADFA11;

1846 i‡(
max
 >
ac
->
ac_g_ex
.
„_Àn
 &&ác->ac_g_ex.„_À¿=
sbi
->
s_°rùe
) {

1847 
pxt4_fsblk_t
 
°¨t
;

1849 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
ac
->
ac_sb
, 
e4b
->
bd_group
) +

1850 
ex
.
„_°¨t
;

1852 i‡(
	`do_div
(
°¨t
, 
sbi
->
s_°rùe
) == 0) {

1853 
ac
->
ac_found
++;

1854 
ac
->
ac_b_ex
 = 
ex
;

1855 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1857 } i‡(
max
 >
ac
->
ac_g_ex
.
„_Àn
) {

1858 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1859 
	`BUG_ON
(
ex
.
„_group
 !
ac
->
ac_g_ex
.fe_group);

1860 
	`BUG_ON
(
ex
.
„_°¨t
 !
ac
->
ac_g_ex
.fe_start);

1861 
ac
->
ac_found
++;

1862 
ac
->
ac_b_ex
 = 
ex
;

1863 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1864 } i‡(
max
 > 0 && (
ac
->
ac_Êags
 & 
PXT4_MB_HINT_MERGE
)) {

1867 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1868 
	`BUG_ON
(
ex
.
„_group
 !
ac
->
ac_g_ex
.fe_group);

1869 
	`BUG_ON
(
ex
.
„_°¨t
 !
ac
->
ac_g_ex
.fe_start);

1870 
ac
->
ac_found
++;

1871 
ac
->
ac_b_ex
 = 
ex
;

1872 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1874 
	`pxt4_u∆ock_group
(
ac
->
ac_sb
, 
group
);

1875 
	`pxt4_mb_u∆ﬂd_buddy
(
e4b
);

1878 
	}
}

1884 
noölöe_f‹_°ack


1885 
	$pxt4_mb_sim∂e_sˇn_group
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1886 
pxt4_buddy
 *
e4b
)

1888 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

1889 
pxt4_group_öfo
 *
gΩ
 = 
e4b
->
bd_öfo
;

1890 *
buddy
;

1891 
i
;

1892 
k
;

1893 
max
;

1895 
	`BUG_ON
(
ac
->
ac_2‹dî
 <= 0);

1896 
i
 = 
ac
->
ac_2‹dî
; i <
sb
->
s_blocksize_bôs
 + 1; i++) {

1897 i‡(
gΩ
->
bb_cou¡îs
[
i
] == 0)

1900 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
i
, &
max
);

1901 
	`BUG_ON
(
buddy
 =
NULL
);

1903 
k
 = 
	`mb_föd_√xt_zîo_bô
(
buddy
, 
max
, 0);

1904 
	`BUG_ON
(
k
 >
max
);

1906 
ac
->
ac_found
++;

1908 
ac
->
ac_b_ex
.
„_Àn
 = 1 << 
i
;

1909 
ac
->
ac_b_ex
.
„_°¨t
 = 
k
 << 
i
;

1910 
ac
->
ac_b_ex
.
„_group
 = 
e4b
->
bd_group
;

1912 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1914 
	`BUG_ON
(
ac
->
ac_b_ex
.
„_Àn
 !ac->
ac_g_ex
.fe_len);

1916 i‡(
	`PXT4_SB
(
sb
)->
s_mb_°©s
)

1917 
	`©omic_öc
(&
	`PXT4_SB
(
sb
)->
s_bÆ_2‹dîs
);

1921 
	}
}

1928 
noölöe_f‹_°ack


1929 
	$pxt4_mb_com∂ex_sˇn_group
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1930 
pxt4_buddy
 *
e4b
)

1932 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

1933 *
bôm≠
 = 
e4b
->
bd_bôm≠
;

1934 
pxt4_‰ì_exã¡
 
ex
;

1935 
i
;

1936 
‰ì
;

1938 
‰ì
 = 
e4b
->
bd_öfo
->
bb_‰ì
;

1939 
	`BUG_ON
(
‰ì
 <= 0);

1941 
i
 = 
e4b
->
bd_öfo
->
bb_fú°_‰ì
;

1943 
‰ì
 && 
ac
->
ac_°©us
 =
AC_STATUS_CONTINUE
) {

1944 
i
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
,

1945 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
), 
i
);

1946 i‡(
i
 >
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)) {

1952 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
, 0, 0,

1955 
‰ì
);

1956 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

1957 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1961 
	`mb_föd_exã¡
(
e4b
, 
i
, 
ac
->
ac_g_ex
.
„_Àn
, &
ex
);

1962 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1963 i‡(
‰ì
 < 
ex
.
„_Àn
) {

1964 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
, 0, 0,

1967 
‰ì
, 
ex
.
„_Àn
);

1968 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

1969 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1977 
ex
.
„_logiˇl
 = 0xDEADC0DE;

1978 
	`pxt4_mb_mósuª_exã¡
(
ac
, &
ex
, 
e4b
);

1980 
i
 +
ex
.
„_Àn
;

1981 
‰ì
 -
ex
.
„_Àn
;

1984 
	`pxt4_mb_check_limôs
(
ac
, 
e4b
, 1);

1985 
	}
}

1991 
noölöe_f‹_°ack


1992 
	$pxt4_mb_sˇn_Æig√d
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1993 
pxt4_buddy
 *
e4b
)

1995 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

1996 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1997 *
bôm≠
 = 
e4b
->
bd_bôm≠
;

1998 
pxt4_‰ì_exã¡
 
ex
;

1999 
pxt4_fsblk_t
 
fú°_group_block
;

2000 
pxt4_fsblk_t
 
a
;

2001 
pxt4_gΩblk_t
 
i
;

2002 
max
;

2004 
	`BUG_ON
(
sbi
->
s_°rùe
 == 0);

2007 
fú°_group_block
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
e4b
->
bd_group
);

2009 
a
 = 
fú°_group_block
 + 
sbi
->
s_°rùe
 - 1;

2010 
	`do_div
(
a
, 
sbi
->
s_°rùe
);

2011 
i
 = (
a
 * 
sbi
->
s_°rùe
Ë- 
fú°_group_block
;

2013 
i
 < 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)) {

2014 i‡(!
	`mb_ã°_bô
(
i
, 
bôm≠
)) {

2015 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
i
, 
sbi
->
s_°rùe
, &
ex
);

2016 i‡(
max
 >
sbi
->
s_°rùe
) {

2017 
ac
->
ac_found
++;

2018 
ex
.
„_logiˇl
 = 0xDEADF00D;

2019 
ac
->
ac_b_ex
 = 
ex
;

2020 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

2024 
i
 +
sbi
->
s_°rùe
;

2026 
	}
}

2034 
	$pxt4_mb_good_group
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

2035 
pxt4_group_t
 
group
, 
¸
)

2037 
‰ì
, 
‰agmíts
;

2038 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
	`PXT4_SB
(
ac
->
ac_sb
));

2039 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
ac
->
ac_sb
, 
group
);

2041 
	`BUG_ON
(
¸
 < 0 || cr >= 4);

2043 
‰ì
 = 
gΩ
->
bb_‰ì
;

2044 i‡(
‰ì
 == 0)

2046 i‡(
¸
 <2 && 
‰ì
 < 
ac
->
ac_g_ex
.
„_Àn
)

2049 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
gΩ
)))

2053 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gΩ
))) {

2054 
ªt
 = 
	`pxt4_mb_öô_group
(
ac
->
ac_sb
, 
group
, 
GFP_NOFS
);

2055 i‡(
ªt
)

2056  
ªt
;

2059 
‰agmíts
 = 
gΩ
->
bb_‰agmíts
;

2060 i‡(
‰agmíts
 == 0)

2063 
¸
) {

2065 
	`BUG_ON
(
ac
->
ac_2‹dî
 == 0);

2068 i‡((
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
) &&

2069 (
Êex_size
 >
PXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
) &&

2070 ((
group
 % 
Êex_size
) == 0))

2073 i‡((
ac
->
ac_2‹dî
 >ác->
ac_sb
->
s_blocksize_bôs
+1) ||

2074 (
‰ì
 / 
‰agmíts
Ë>
ac
->
ac_g_ex
.
„_Àn
)

2077 i‡(
gΩ
->
bb_œrge°_‰ì_‹dî
 < 
ac
->
ac_2‹dî
)

2082 i‡((
‰ì
 / 
‰agmíts
Ë>
ac
->
ac_g_ex
.
„_Àn
)

2086 i‡(
‰ì
 >
ac
->
ac_g_ex
.
„_Àn
)

2092 
	`BUG
();

2096 
	}
}

2098 
noölöe_f‹_°ack
 

2099 
	$pxt4_mb_ªguœr_Æloˇt‹
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

2101 
pxt4_group_t
 
ngroups
, 
group
, 
i
;

2102 
¸
;

2103 
îr
 = 0, 
fú°_îr
 = 0;

2104 
pxt4_sb_öfo
 *
sbi
;

2105 
su≥r_block
 *
sb
;

2106 
pxt4_buddy
 
e4b
;

2108 
sb
 = 
ac
->
ac_sb
;

2109 
sbi
 = 
	`PXT4_SB
(
sb
);

2110 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

2112 i‡(!(
	`pxt4_ã°_öode_Êag
(
ac
->
ac_öode
, 
PXT4_INODE_EXTENTS
)))

2113 
ngroups
 = 
sbi
->
s_blockfûe_groups
;

2115 
	`BUG_ON
(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
);

2118 
îr
 = 
	`pxt4_mb_föd_by_gﬂl
(
ac
, &
e4b
);

2119 i‡(
îr
 || 
ac
->
ac_°©us
 =
AC_STATUS_FOUND
)

2120 
out
;

2122 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GOAL_ONLY
))

2123 
out
;

2130 
i
 = 
	`Ês
(
ac
->
ac_g_ex
.
„_Àn
);

2131 
ac
->
ac_2‹dî
 = 0;

2139 i‡(
i
 >
sbi
->
s_mb_‹dî2_ªqs
 && i <
sb
->
s_blocksize_bôs
 + 2) {

2143 i‡((
ac
->
ac_g_ex
.
„_Àn
 & (~(1 << (
i
 - 1)))) == 0)

2144 
ac
->
ac_2‹dî
 = 
	`¨øy_ödex_no•ec
(
i
 - 1,

2145 
sb
->
s_blocksize_bôs
 + 2);

2149 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_STREAM_ALLOC
) {

2151 
	`•ö_lock
(&
sbi
->
s_md_lock
);

2152 
ac
->
ac_g_ex
.
„_group
 = 
sbi
->
s_mb_œ°_group
;

2153 
ac
->
ac_g_ex
.
„_°¨t
 = 
sbi
->
s_mb_œ°_°¨t
;

2154 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

2158 
¸
 = 
ac
->
ac_2‹dî
 ? 0 : 1;

2163 
ª≥©
:

2164 ; 
¸
 < 4 && 
ac
->
ac_°©us
 =
AC_STATUS_CONTINUE
; cr++) {

2165 
ac
->
ac_¸ôîü
 = 
¸
;

2170 
group
 = 
ac
->
ac_g_ex
.
„_group
;

2172 
i
 = 0; i < 
ngroups
; 
group
++, i++) {

2173 
ªt
 = 0;

2174 
	`c⁄d_ªsched
();

2179 i‡(
group
 >
ngroups
)

2180 
group
 = 0;

2183 
ªt
 = 
	`pxt4_mb_good_group
(
ac
, 
group
, 
¸
);

2184 i‡(
ªt
 <= 0) {

2185 i‡(!
fú°_îr
)

2186 
fú°_îr
 = 
ªt
;

2190 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

2191 i‡(
îr
)

2192 
out
;

2194 
	`pxt4_lock_group
(
sb
, 
group
);

2200 
ªt
 = 
	`pxt4_mb_good_group
(
ac
, 
group
, 
¸
);

2201 i‡(
ªt
 <= 0) {

2202 
	`pxt4_u∆ock_group
(
sb
, 
group
);

2203 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2204 i‡(!
fú°_îr
)

2205 
fú°_îr
 = 
ªt
;

2209 
ac
->
ac_groups_sˇ¬ed
++;

2210 i‡(
¸
 == 0)

2211 
	`pxt4_mb_sim∂e_sˇn_group
(
ac
, &
e4b
);

2212 i‡(
¸
 =1 && 
sbi
->
s_°rùe
 &&

2213 !(
ac
->
ac_g_ex
.
„_Àn
 % 
sbi
->
s_°rùe
))

2214 
	`pxt4_mb_sˇn_Æig√d
(
ac
, &
e4b
);

2216 
	`pxt4_mb_com∂ex_sˇn_group
(
ac
, &
e4b
);

2218 
	`pxt4_u∆ock_group
(
sb
, 
group
);

2219 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2221 i‡(
ac
->
ac_°©us
 !
AC_STATUS_CONTINUE
)

2226 i‡(
ac
->
ac_b_ex
.
„_Àn
 > 0 &&ác->
ac_°©us
 !
AC_STATUS_FOUND
 &&

2227 !(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_FIRST
)) {

2233 
	`pxt4_mb_åy_be°_found
(
ac
, &
e4b
);

2234 i‡(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
) {

2241 
ac
->
ac_b_ex
.
„_group
 = 0;

2242 
ac
->
ac_b_ex
.
„_°¨t
 = 0;

2243 
ac
->
ac_b_ex
.
„_Àn
 = 0;

2244 
ac
->
ac_°©us
 = 
AC_STATUS_CONTINUE
;

2245 
ac
->
ac_Êags
 |
PXT4_MB_HINT_FIRST
;

2246 
¸
 = 3;

2247 
	`©omic_öc
(&
sbi
->
s_mb_lo°_chunks
);

2248 
ª≥©
;

2251 
out
:

2252 i‡(!
îr
 && 
ac
->
ac_°©us
 !
AC_STATUS_FOUND
 && 
fú°_îr
)

2253 
îr
 = 
fú°_îr
;

2254  
îr
;

2255 
	}
}

2257 *
	$pxt4_mb_£q_groups_°¨t
(
£q_fûe
 *
£q
, 
loff_t
 *
pos
)

2259 
su≥r_block
 *
sb
 = 
	`PDE_DATA
(
	`fûe_öode
(
£q
->
fûe
));

2260 
pxt4_group_t
 
group
;

2262 i‡(*
pos
 < 0 || *po†>
	`pxt4_gë_groups_cou¡
(
sb
))

2263  
NULL
;

2264 
group
 = *
pos
 + 1;

2265  (*Ë((Ë
group
);

2266 
	}
}

2268 *
	$pxt4_mb_£q_groups_√xt
(
£q_fûe
 *
£q
, *
v
, 
loff_t
 *
pos
)

2270 
su≥r_block
 *
sb
 = 
	`PDE_DATA
(
	`fûe_öode
(
£q
->
fûe
));

2271 
pxt4_group_t
 
group
;

2273 ++*
pos
;

2274 i‡(*
pos
 < 0 || *po†>
	`pxt4_gë_groups_cou¡
(
sb
))

2275  
NULL
;

2276 
group
 = *
pos
 + 1;

2277  (*Ë((Ë
group
);

2278 
	}
}

2280 
	$pxt4_mb_£q_groups_show
(
£q_fûe
 *
£q
, *
v
)

2282 
su≥r_block
 *
sb
 = 
	`PDE_DATA
(
	`fûe_öode
(
£q
->
fûe
));

2283 
pxt4_group_t
 
group
 = (pxt4_group_tË((Ë
v
);

2284 
i
;

2285 
îr
, 
buddy_lﬂded
 = 0;

2286 
pxt4_buddy
 
e4b
;

2287 
pxt4_group_öfo
 *
gröfo
;

2288 
blocksize_bôs
 = 
	`mö_t
(,

2289 
sb
->
s_blocksize_bôs
,

2290 
PXT4_MAX_BLOCK_LOG_SIZE
);

2291 
	ssg
 {

2292 
pxt4_group_öfo
 
öfo
;

2293 
pxt4_gΩblk_t
 
cou¡îs
[
PXT4_MAX_BLOCK_LOG_SIZE
 + 2];

2294 } 
sg
;

2296 
group
--;

2297 i‡(
group
 == 0)

2298 
	`£q_puts
(
£q
, "#group: free frags first ["

2302 
i
 = (
blocksize_bôs
 + 2Ë* (
sg
.
öfo
.
bb_cou¡îs
[0]) +

2303 (
pxt4_group_öfo
);

2305 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

2307 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gröfo
))) {

2308 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

2309 i‡(
îr
) {

2310 
	`£q_¥ötf
(
£q
, "#%-5u: I/OÉº‹\n", 
group
);

2313 
buddy_lﬂded
 = 1;

2316 
	`mem˝y
(&
sg
, 
	`pxt4_gë_group_öfo
(
sb
, 
group
), 
i
);

2318 i‡(
buddy_lﬂded
)

2319 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2321 
	`£q_¥ötf
(
£q
, "#%-5u: %-5u %-5u %-5u [", 
group
, 
sg
.
öfo
.
bb_‰ì
,

2322 
sg
.
öfo
.
bb_‰agmíts
, sg.öfo.
bb_fú°_‰ì
);

2323 
i
 = 0; i <= 13; i++)

2324 
	`£q_¥ötf
(
£q
, " %-5u", 
i
 <
blocksize_bôs
 + 1 ?

2325 
sg
.
öfo
.
bb_cou¡îs
[
i
] : 0);

2326 
	`£q_¥ötf
(
£q
, " ]\n");

2329 
	}
}

2331 
	$pxt4_mb_£q_groups_°›
(
£q_fûe
 *
£q
, *
v
)

2333 
	}
}

2335 c⁄° 
£q_›î©i⁄s
 
	gpxt4_mb_£q_groups_›s
 = {

2336 .
°¨t
 = 
pxt4_mb_£q_groups_°¨t
,

2337 .
	g√xt
 = 
pxt4_mb_£q_groups_√xt
,

2338 .
	g°›
 = 
pxt4_mb_£q_groups_°›
,

2339 .
	gshow
 = 
pxt4_mb_£q_groups_show
,

2342 
kmem_ˇche
 *
	$gë_groupöfo_ˇche
(
blocksize_bôs
)

2344 
ˇche_ödex
 = 
blocksize_bôs
 - 
PXT4_MIN_BLOCK_LOG_SIZE
;

2345 
kmem_ˇche
 *
ˇchï
 = 
pxt4_groupöfo_ˇches
[
ˇche_ödex
];

2347 
	`BUG_ON
(!
ˇchï
);

2348  
ˇchï
;

2349 
	}
}

2355 
	$pxt4_mb_Æloc_groupöfo
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
ngroups
)

2357 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2358 
size
;

2359 
pxt4_group_öfo
 ***
√w_groupöfo
;

2361 
size
 = (
ngroups
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) >>

2362 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2363 i‡(
size
 <
sbi
->
s_group_öfo_size
)

2366 
size
 = 
	`roundup_pow_of_two
((*
sbi
->
s_group_öfo
) * size);

2367 
√w_groupöfo
 = 
	`kvzÆloc
(
size
, 
GFP_KERNEL
);

2368 i‡(!
√w_groupöfo
) {

2369 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tállocate buddy meta group");

2370  -
ENOMEM
;

2372 i‡(
sbi
->
s_group_öfo
) {

2373 
	`mem˝y
(
√w_groupöfo
, 
sbi
->
s_group_öfo
,

2374 
sbi
->
s_group_öfo_size
 * (*sbi->
s_group_öfo
));

2375 
	`kv‰ì
(
sbi
->
s_group_öfo
);

2377 
sbi
->
s_group_öfo
 = 
√w_groupöfo
;

2378 
sbi
->
s_group_öfo_size
 = 
size
 / (*sbi->
s_group_öfo
);

2379 
	`pxt4_debug
("allocated s_groupinfoárray for %d meta_bg's\n",

2380 
sbi
->
s_group_öfo_size
);

2382 
	}
}

2385 
	$pxt4_mb_add_groupöfo
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2386 
pxt4_group_desc
 *
desc
)

2388 
i
;

2389 
mëÆí
 = 0;

2390 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2391 
pxt4_group_öfo
 **
mëa_group_öfo
;

2392 
kmem_ˇche
 *
ˇchï
 = 
	`gë_groupöfo_ˇche
(
sb
->
s_blocksize_bôs
);

2399 i‡(
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
) == 0) {

2400 
mëÆí
 = (*
mëa_group_öfo
) <<

2401 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2402 
mëa_group_öfo
 = 
	`kmÆloc
(
mëÆí
, 
GFP_NOFS
);

2403 i‡(
mëa_group_öfo
 =
NULL
) {

2404 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tállocate mem "

2406 
exô_mëa_group_öfo
;

2408 
sbi
->
s_group_öfo
[
group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
)] =

2409 
mëa_group_öfo
;

2412 
mëa_group_öfo
 =

2413 
sbi
->
s_group_öfo
[
group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
)];

2414 
i
 = 
group
 & (
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1);

2416 
mëa_group_öfo
[
i
] = 
	`kmem_ˇche_zÆloc
(
ˇchï
, 
GFP_NOFS
);

2417 i‡(
mëa_group_öfo
[
i
] =
NULL
) {

2418 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tállocate buddy mem");

2419 
exô_group_öfo
;

2421 
	`£t_bô
(
PXT4_GROUP_INFO_NEED_INIT_BIT
,

2422 &(
mëa_group_öfo
[
i
]->
bb_°©e
));

2428 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

2429 (
desc
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

2430 
mëa_group_öfo
[
i
]->
bb_‰ì
 =

2431 
	`pxt4_‰ì_˛u°îs_a·î_öô
(
sb
, 
group
, 
desc
);

2433 
mëa_group_öfo
[
i
]->
bb_‰ì
 =

2434 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
);

2437 
	`INIT_LIST_HEAD
(&
mëa_group_öfo
[
i
]->
bb_¥óŒoc_li°
);

2438 
	`öô_rw£m
(&
mëa_group_öfo
[
i
]->
Æloc_£m
);

2439 
mëa_group_öfo
[
i
]->
bb_‰ì_roŸ
 = 
RB_ROOT
;

2440 
mëa_group_öfo
[
i
]->
bb_œrge°_‰ì_‹dî
 = -1;

2442 #ifde‡
DOUBLE_CHECK


2444 
buf„r_hód
 *
bh
;

2445 
mëa_group_öfo
[
i
]->
bb_bôm≠
 =

2446 
	`kmÆloc
(
sb
->
s_blocksize
, 
GFP_NOFS
);

2447 
	`BUG_ON
(
mëa_group_öfo
[
i
]->
bb_bôm≠
 =
NULL
);

2448 
bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

2449 
	`BUG_ON
(
	`IS_ERR_OR_NULL
(
bh
));

2450 
	`mem˝y
(
mëa_group_öfo
[
i
]->
bb_bôm≠
, 
bh
->
b_d©a
,

2451 
sb
->
s_blocksize
);

2452 
	`put_bh
(
bh
);

2458 
exô_group_öfo
:

2460 i‡(
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
) == 0) {

2461 
	`k‰ì
(
sbi
->
s_group_öfo
[
group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
)]);

2462 
sbi
->
s_group_öfo
[
group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
)] = 
NULL
;

2464 
exô_mëa_group_öfo
:

2465  -
ENOMEM
;

2466 
	}
}

2468 
	$pxt4_mb_öô_backíd
(
su≥r_block
 *
sb
)

2470 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

2471 
pxt4_group_t
 
i
;

2472 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2473 
îr
;

2474 
pxt4_group_desc
 *
desc
;

2475 
kmem_ˇche
 *
ˇchï
;

2477 
îr
 = 
	`pxt4_mb_Æloc_groupöfo
(
sb
, 
ngroups
);

2478 i‡(
îr
)

2479  
îr
;

2481 
sbi
->
s_buddy_ˇche
 = 
	`√w_öode
(
sb
);

2482 i‡(
sbi
->
s_buddy_ˇche
 =
NULL
) {

2483 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't getÇew inode");

2484 
îr_‰ìsgi
;

2490 
sbi
->
s_buddy_ˇche
->
i_öo
 = 
PXT4_BAD_INO
;

2491 
	`PXT4_I
(
sbi
->
s_buddy_ˇche
)->
i_disksize
 = 0;

2492 
i
 = 0; i < 
ngroups
; i++) {

2493 
	`c⁄d_ªsched
();

2494 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

2495 i‡(
desc
 =
NULL
) {

2496 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "ˇn'àªad des¸ùt‹ %u", 
i
);

2497 
îr_‰ìbuddy
;

2499 i‡(
	`pxt4_mb_add_groupöfo
(
sb
, 
i
, 
desc
) != 0)

2500 
îr_‰ìbuddy
;

2505 
îr_‰ìbuddy
:

2506 
ˇchï
 = 
	`gë_groupöfo_ˇche
(
sb
->
s_blocksize_bôs
);

2507 
i
-- > 0)

2508 
	`kmem_ˇche_‰ì
(
ˇchï
, 
	`pxt4_gë_group_öfo
(
sb
, 
i
));

2509 
i
 = 
sbi
->
s_group_öfo_size
;

2510 
i
-- > 0)

2511 
	`k‰ì
(
sbi
->
s_group_öfo
[
i
]);

2512 
	`ùut
(
sbi
->
s_buddy_ˇche
);

2513 
îr_‰ìsgi
:

2514 
	`kv‰ì
(
sbi
->
s_group_öfo
);

2515  -
ENOMEM
;

2516 
	}
}

2518 
	$pxt4_groupöfo_de°roy_¶abs
()

2520 
i
;

2522 
i
 = 0; i < 
NR_GRPINFO_CACHES
; i++) {

2523 
	`kmem_ˇche_de°roy
(
pxt4_groupöfo_ˇches
[
i
]);

2524 
pxt4_groupöfo_ˇches
[
i
] = 
NULL
;

2526 
	}
}

2528 
	$pxt4_groupöfo_¸óã_¶ab
(
size_t
 
size
)

2530 
	`DEFINE_MUTEX
(
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2531 
¶ab_size
;

2532 
blocksize_bôs
 = 
	`‹dî_ba£_2
(
size
);

2533 
ˇche_ödex
 = 
blocksize_bôs
 - 
PXT4_MIN_BLOCK_LOG_SIZE
;

2534 
kmem_ˇche
 *
ˇchï
;

2536 i‡(
ˇche_ödex
 >
NR_GRPINFO_CACHES
)

2537  -
EINVAL
;

2539 i‡(
	`u∆ikñy
(
ˇche_ödex
 < 0))

2540 
ˇche_ödex
 = 0;

2542 
	`muãx_lock
(&
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2543 i‡(
pxt4_groupöfo_ˇches
[
ˇche_ödex
]) {

2544 
	`muãx_u∆ock
(&
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2548 
¶ab_size
 = 
	`off£tof
(
pxt4_group_öfo
,

2549 
bb_cou¡îs
[
blocksize_bôs
 + 2]);

2551 
ˇchï
 = 
	`kmem_ˇche_¸óã
(
pxt4_groupöfo_¶ab_«mes
[
ˇche_ödex
],

2552 
¶ab_size
, 0, 
SLAB_RECLAIM_ACCOUNT
,

2553 
NULL
);

2555 
pxt4_groupöfo_ˇches
[
ˇche_ödex
] = 
ˇchï
;

2557 
	`muãx_u∆ock
(&
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2558 i‡(!
ˇchï
) {

2559 
	`¥ötk
(
KERN_EMERG


2561  -
ENOMEM
;

2565 
	}
}

2567 
	$pxt4_mb_öô
(
su≥r_block
 *
sb
)

2569 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2570 
i
, 
j
;

2571 
off£t
, 
off£t_ö¸
;

2572 
max
;

2573 
ªt
;

2575 
i
 = (
sb
->
s_blocksize_bôs
 + 2Ë* (*
sbi
->
s_mb_off£ts
);

2577 
sbi
->
s_mb_off£ts
 = 
	`kmÆloc
(
i
, 
GFP_KERNEL
);

2578 i‡(
sbi
->
s_mb_off£ts
 =
NULL
) {

2579 
ªt
 = -
ENOMEM
;

2580 
out
;

2583 
i
 = (
sb
->
s_blocksize_bôs
 + 2Ë* (*
sbi
->
s_mb_maxs
);

2584 
sbi
->
s_mb_maxs
 = 
	`kmÆloc
(
i
, 
GFP_KERNEL
);

2585 i‡(
sbi
->
s_mb_maxs
 =
NULL
) {

2586 
ªt
 = -
ENOMEM
;

2587 
out
;

2590 
ªt
 = 
	`pxt4_groupöfo_¸óã_¶ab
(
sb
->
s_blocksize
);

2591 i‡(
ªt
 < 0)

2592 
out
;

2595 
sbi
->
s_mb_maxs
[0] = 
sb
->
s_blocksize
 << 3;

2596 
sbi
->
s_mb_off£ts
[0] = 0;

2598 
i
 = 1;

2599 
off£t
 = 0;

2600 
off£t_ö¸
 = 1 << (
sb
->
s_blocksize_bôs
 - 1);

2601 
max
 = 
sb
->
s_blocksize
 << 2;

2603 
sbi
->
s_mb_off£ts
[
i
] = 
off£t
;

2604 
sbi
->
s_mb_maxs
[
i
] = 
max
;

2605 
off£t
 +
off£t_ö¸
;

2606 
off£t_ö¸
 = offset_incr >> 1;

2607 
max
 = max >> 1;

2608 
i
++;

2609 } 
i
 <
sb
->
s_blocksize_bôs
 + 1);

2611 
	`•ö_lock_öô
(&
sbi
->
s_md_lock
);

2612 
	`•ö_lock_öô
(&
sbi
->
s_bÆ_lock
);

2613 
sbi
->
s_mb_‰ì_≥ndög
 = 0;

2614 
	`INIT_LIST_HEAD
(&
sbi
->
s_‰ìd_d©a_li°
);

2616 
sbi
->
s_mb_max_to_sˇn
 = 
MB_DEFAULT_MAX_TO_SCAN
;

2617 
sbi
->
s_mb_mö_to_sˇn
 = 
MB_DEFAULT_MIN_TO_SCAN
;

2618 
sbi
->
s_mb_°©s
 = 
MB_DEFAULT_STATS
;

2619 
sbi
->
s_mb_°ªam_ªque°
 = 
MB_DEFAULT_STREAM_THRESHOLD
;

2620 
sbi
->
s_mb_‹dî2_ªqs
 = 
MB_DEFAULT_ORDER2_REQS
;

2633 
sbi
->
s_mb_group_¥óŒoc
 = 
	`max
(
MB_DEFAULT_GROUP_PREALLOC
 >>

2634 
sbi
->
s_˛u°î_bôs
, 32);

2643 i‡(
sbi
->
s_°rùe
 > 1) {

2644 
sbi
->
s_mb_group_¥óŒoc
 = 
	`roundup
(

2645 
sbi
->
s_mb_group_¥óŒoc
, sbi->
s_°rùe
);

2648 
sbi
->
s_loˇlôy_groups
 = 
	`Æloc_≥r˝u
(
pxt4_loˇlôy_group
);

2649 i‡(
sbi
->
s_loˇlôy_groups
 =
NULL
) {

2650 
ªt
 = -
ENOMEM
;

2651 
out
;

2653 
	`f‹_óch_possibÀ_˝u
(
i
) {

2654 
pxt4_loˇlôy_group
 *
lg
;

2655 
lg
 = 
	`≥r_˝u_±r
(
sbi
->
s_loˇlôy_groups
, 
i
);

2656 
	`muãx_öô
(&
lg
->
lg_muãx
);

2657 
j
 = 0; j < 
PREALLOC_TB_SIZE
; j++)

2658 
	`INIT_LIST_HEAD
(&
lg
->
lg_¥óŒoc_li°
[
j
]);

2659 
	`•ö_lock_öô
(&
lg
->
lg_¥óŒoc_lock
);

2663 
ªt
 = 
	`pxt4_mb_öô_backíd
(
sb
);

2664 i‡(
ªt
 != 0)

2665 
out_‰ì_loˇlôy_groups
;

2669 
out_‰ì_loˇlôy_groups
:

2670 
	`‰ì_≥r˝u
(
sbi
->
s_loˇlôy_groups
);

2671 
sbi
->
s_loˇlôy_groups
 = 
NULL
;

2672 
out
:

2673 
	`k‰ì
(
sbi
->
s_mb_off£ts
);

2674 
sbi
->
s_mb_off£ts
 = 
NULL
;

2675 
	`k‰ì
(
sbi
->
s_mb_maxs
);

2676 
sbi
->
s_mb_maxs
 = 
NULL
;

2677  
ªt
;

2678 
	}
}

2681 
	$pxt4_mb_˛ónup_∑
(
pxt4_group_öfo
 *
gΩ
)

2683 
pxt4_¥óŒoc_•a˚
 *
∑
;

2684 
li°_hód
 *
cur
, *
tmp
;

2685 
cou¡
 = 0;

2687 
	`li°_f‹_óch_ß„
(
cur
, 
tmp
, &
gΩ
->
bb_¥óŒoc_li°
) {

2688 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
, 
∑_group_li°
);

2689 
	`li°_dñ
(&
∑
->
∑_group_li°
);

2690 
cou¡
++;

2691 
	`kmem_ˇche_‰ì
(
pxt4_p•a˚_ˇchï
, 
∑
);

2693 i‡(
cou¡
)

2694 
	`mb_debug
(1, "mbÆloc: %u PA†À·\n", 
cou¡
);

2696 
	}
}

2698 
	$pxt4_mb_ªÀa£
(
su≥r_block
 *
sb
)

2700 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

2701 
pxt4_group_t
 
i
;

2702 
num_mëa_group_öfos
;

2703 
pxt4_group_öfo
 *
gröfo
;

2704 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2705 
kmem_ˇche
 *
ˇchï
 = 
	`gë_groupöfo_ˇche
(
sb
->
s_blocksize_bôs
);

2707 i‡(
sbi
->
s_group_öfo
) {

2708 
i
 = 0; i < 
ngroups
; i++) {

2709 
	`c⁄d_ªsched
();

2710 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

2711 #ifde‡
DOUBLE_CHECK


2712 
	`k‰ì
(
gröfo
->
bb_bôm≠
);

2714 
	`pxt4_lock_group
(
sb
, 
i
);

2715 
	`pxt4_mb_˛ónup_∑
(
gröfo
);

2716 
	`pxt4_u∆ock_group
(
sb
, 
i
);

2717 
	`kmem_ˇche_‰ì
(
ˇchï
, 
gröfo
);

2719 
num_mëa_group_öfos
 = (
ngroups
 +

2720 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) >>

2721 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2722 
i
 = 0; i < 
num_mëa_group_öfos
; i++)

2723 
	`k‰ì
(
sbi
->
s_group_öfo
[
i
]);

2724 
	`kv‰ì
(
sbi
->
s_group_öfo
);

2726 
	`k‰ì
(
sbi
->
s_mb_off£ts
);

2727 
	`k‰ì
(
sbi
->
s_mb_maxs
);

2728 
	`ùut
(
sbi
->
s_buddy_ˇche
);

2729 i‡(
sbi
->
s_mb_°©s
) {

2730 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2732 
	`©omic_ªad
(&
sbi
->
s_bÆ_Æloˇãd
),

2733 
	`©omic_ªad
(&
sbi
->
s_bÆ_ªqs
),

2734 
	`©omic_ªad
(&
sbi
->
s_bÆ_suc˚ss
));

2735 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2738 
	`©omic_ªad
(&
sbi
->
s_bÆ_ex_sˇ¬ed
),

2739 
	`©omic_ªad
(&
sbi
->
s_bÆ_gﬂls
),

2740 
	`©omic_ªad
(&
sbi
->
s_bÆ_2‹dîs
),

2741 
	`©omic_ªad
(&
sbi
->
s_bÆ_bªaks
),

2742 
	`©omic_ªad
(&
sbi
->
s_mb_lo°_chunks
));

2743 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2745 
sbi
->
s_mb_buddõs_gíî©ed
,

2746 
sbi
->
s_mb_gíî©i⁄_time
);

2747 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2749 
	`©omic_ªad
(&
sbi
->
s_mb_¥óŒoˇãd
),

2750 
	`©omic_ªad
(&
sbi
->
s_mb_disˇrded
));

2753 
	`‰ì_≥r˝u
(
sbi
->
s_loˇlôy_groups
);

2756 
	}
}

2758 
ölöe
 
	$pxt4_issue_disˇrd
(
su≥r_block
 *
sb
,

2759 
pxt4_group_t
 
block_group
, 
pxt4_gΩblk_t
 
˛u°î
, 
cou¡
,

2760 
bio
 **
bi›
)

2762 
pxt4_fsblk_t
 
disˇrd_block
;

2764 
disˇrd_block
 = (
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
˛u°î
) +

2765 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
));

2766 
cou¡
 = 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), count);

2767 
	`åa˚_pxt4_disˇrd_blocks
(
sb
,

2768 (Ë
disˇrd_block
, 
cou¡
);

2769 i‡(
bi›
) {

2770  
	`__blkdev_issue_disˇrd
(
sb
->
s_bdev
,

2771 (
£˘‹_t
)
disˇrd_block
 << (
sb
->
s_blocksize_bôs
 - 9),

2772 (
£˘‹_t
)
cou¡
 << (
sb
->
s_blocksize_bôs
 - 9),

2773 
GFP_NOFS
, 0, 
bi›
);

2775  
	`sb_issue_disˇrd
(
sb
, 
disˇrd_block
, 
cou¡
, 
GFP_NOFS
, 0);

2776 
	}
}

2778 
	$pxt4_‰ì_d©a_ö_buddy
(
su≥r_block
 *
sb
,

2779 
pxt4_‰ì_d©a
 *
íåy
)

2781 
pxt4_buddy
 
e4b
;

2782 
pxt4_group_öfo
 *
db
;

2783 
îr
, 
cou¡
 = 0, 
cou¡2
 = 0;

2785 
	`mb_debug
(1, "gonna free %u blocks in group %u (0x%p):",

2786 
íåy
->
efd_cou¡
,É¡ry->
efd_group
,Éntry);

2788 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
íåy
->
efd_group
, &
e4b
);

2790 
	`BUG_ON
(
îr
 != 0);

2792 
	`•ö_lock
(&
	`PXT4_SB
(
sb
)->
s_md_lock
);

2793 
	`PXT4_SB
(
sb
)->
s_mb_‰ì_≥ndög
 -
íåy
->
efd_cou¡
;

2794 
	`•ö_u∆ock
(&
	`PXT4_SB
(
sb
)->
s_md_lock
);

2796 
db
 = 
e4b
.
bd_öfo
;

2798 
cou¡
 +
íåy
->
efd_cou¡
;

2799 
cou¡2
++;

2800 
	`pxt4_lock_group
(
sb
, 
íåy
->
efd_group
);

2802 
	`rb_îa£
(&
íåy
->
efd_node
, &(
db
->
bb_‰ì_roŸ
));

2803 
	`mb_‰ì_blocks
(
NULL
, &
e4b
, 
íåy
->
efd_°¨t_˛u°î
,É¡ry->
efd_cou¡
);

2811 i‡(!
	`ã°_›t
(
sb
, 
DISCARD
))

2812 
	`PXT4_MB_GRP_CLEAR_TRIMMED
(
db
);

2814 i‡(!
db
->
bb_‰ì_roŸ
.
rb_node
) {

2818 
	`put_∑ge
(
e4b
.
bd_buddy_∑ge
);

2819 
	`put_∑ge
(
e4b
.
bd_bôm≠_∑ge
);

2821 
	`pxt4_u∆ock_group
(
sb
, 
íåy
->
efd_group
);

2822 
	`kmem_ˇche_‰ì
(
pxt4_‰ì_d©a_ˇchï
, 
íåy
);

2823 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2825 
	`mb_debug
(1, "‰ìd %u block†ö %u såu˘uªs\n", 
cou¡
, 
cou¡2
);

2826 
	}
}

2832 
	$pxt4_¥o˚ss_‰ìd_d©a
(
su≥r_block
 *
sb
, 
tid_t
 
commô_tid
)

2834 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2835 
pxt4_‰ì_d©a
 *
íåy
, *
tmp
;

2836 
bio
 *
disˇrd_bio
 = 
NULL
;

2837 
li°_hód
 
‰ìd_d©a_li°
;

2838 
li°_hód
 *
cut_pos
 = 
NULL
;

2839 
îr
;

2841 
	`INIT_LIST_HEAD
(&
‰ìd_d©a_li°
);

2843 
	`•ö_lock
(&
sbi
->
s_md_lock
);

2844 
	`li°_f‹_óch_íåy
(
íåy
, &
sbi
->
s_‰ìd_d©a_li°
, 
efd_li°
) {

2845 i‡(
íåy
->
efd_tid
 !
commô_tid
)

2847 
cut_pos
 = &
íåy
->
efd_li°
;

2849 i‡(
cut_pos
)

2850 
	`li°_cut_posôi⁄
(&
‰ìd_d©a_li°
, &
sbi
->
s_‰ìd_d©a_li°
,

2851 
cut_pos
);

2852 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

2854 i‡(
	`ã°_›t
(
sb
, 
DISCARD
)) {

2855 
	`li°_f‹_óch_íåy
(
íåy
, &
‰ìd_d©a_li°
, 
efd_li°
) {

2856 
îr
 = 
	`pxt4_issue_disˇrd
(
sb
, 
íåy
->
efd_group
,

2857 
íåy
->
efd_°¨t_˛u°î
,

2858 
íåy
->
efd_cou¡
,

2859 &
disˇrd_bio
);

2860 i‡(
îr
 &&Éº !-
EOPNOTSUPP
) {

2861 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "discardÑequest in"

2863 " wôh %d", 
íåy
->
efd_group
,

2864 
íåy
->
efd_°¨t_˛u°î
,

2865 
íåy
->
efd_cou¡
, 
îr
);

2866 } i‡(
îr
 =-
EOPNOTSUPP
)

2870 i‡(
disˇrd_bio
) {

2871 
	`submô_bio_waô
(
disˇrd_bio
);

2872 
	`bio_put
(
disˇrd_bio
);

2876 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
tmp
, &
‰ìd_d©a_li°
, 
efd_li°
)

2877 
	`pxt4_‰ì_d©a_ö_buddy
(
sb
, 
íåy
);

2878 
	}
}

2880 
__öô
 
	$pxt4_öô_mbÆloc
()

2882 
pxt4_p•a˚_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_¥óŒoc_•a˚
,

2883 
SLAB_RECLAIM_ACCOUNT
);

2884 i‡(
pxt4_p•a˚_ˇchï
 =
NULL
)

2885  -
ENOMEM
;

2887 
pxt4_ac_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_Æloˇti⁄_c⁄ãxt
,

2888 
SLAB_RECLAIM_ACCOUNT
);

2889 i‡(
pxt4_ac_ˇchï
 =
NULL
) {

2890 
	`kmem_ˇche_de°roy
(
pxt4_p•a˚_ˇchï
);

2891  -
ENOMEM
;

2894 
pxt4_‰ì_d©a_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_‰ì_d©a
,

2895 
SLAB_RECLAIM_ACCOUNT
);

2896 i‡(
pxt4_‰ì_d©a_ˇchï
 =
NULL
) {

2897 
	`kmem_ˇche_de°roy
(
pxt4_p•a˚_ˇchï
);

2898 
	`kmem_ˇche_de°roy
(
pxt4_ac_ˇchï
);

2899  -
ENOMEM
;

2902 
	}
}

2904 
	$pxt4_exô_mbÆloc
()

2910 
	`rcu_b¨rõr
();

2911 
	`kmem_ˇche_de°roy
(
pxt4_p•a˚_ˇchï
);

2912 
	`kmem_ˇche_de°roy
(
pxt4_ac_ˇchï
);

2913 
	`kmem_ˇche_de°roy
(
pxt4_‰ì_d©a_ˇchï
);

2914 
	`pxt4_groupöfo_de°roy_¶abs
();

2915 
	}
}

2922 
noölöe_f‹_°ack
 

2923 
	$pxt4_mb_m¨k_disk•a˚_u£d
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

2924 
h™dÀ_t
 *
h™dÀ
, 
ª£rv_˛°rs
)

2926 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

2927 
pxt4_group_desc
 *
gdp
;

2928 
buf„r_hód
 *
gdp_bh
;

2929 
pxt4_sb_öfo
 *
sbi
;

2930 
su≥r_block
 *
sb
;

2931 
pxt4_fsblk_t
 
block
;

2932 
îr
, 
Àn
;

2934 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
);

2935 
	`BUG_ON
(
ac
->
ac_b_ex
.
„_Àn
 <= 0);

2937 
sb
 = 
ac
->
ac_sb
;

2938 
sbi
 = 
	`PXT4_SB
(
sb
);

2940 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

2941 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

2942 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

2943 
bôm≠_bh
 = 
NULL
;

2944 
out_îr
;

2947 
	`BUFFER_TRACE
(
bôm≠_bh
, "getting writeáccess");

2948 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

2949 i‡(
îr
)

2950 
out_îr
;

2952 
îr
 = -
EIO
;

2953 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
ac
->
ac_b_ex
.
„_group
, &
gdp_bh
);

2954 i‡(!
gdp
)

2955 
out_îr
;

2957 
	`pxt4_debug
("usög block grou∞%u(%d)\n", 
ac
->
ac_b_ex
.
„_group
,

2958 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
));

2960 
	`BUFFER_TRACE
(
gdp_bh
, "get_write_access");

2961 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdp_bh
);

2962 i‡(
îr
)

2963 
out_îr
;

2965 
block
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

2967 
Àn
 = 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

2968 i‡(!
	`pxt4_d©a_block_vÆid
(
sbi
, 
block
, 
Àn
)) {

2969 
	`pxt4_îr‹
(
sb
, "Allocating blocks %llu-%llu which overlap "

2970 "f†mëad©a", 
block
, block+
Àn
);

2975 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

2976 
	`pxt4_£t_bôs
(
bôm≠_bh
->
b_d©a
, 
ac
->
ac_b_ex
.
„_°¨t
,

2977 
ac
->
ac_b_ex
.
„_Àn
);

2978 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

2979 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

2980 i‡(!
îr
)

2981 
îr
 = -
EFSCORRUPTED
;

2982 
out_îr
;

2985 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

2986 #ifde‡
AGGRESSIVE_CHECK


2988 
i
;

2989 
i
 = 0; i < 
ac
->
ac_b_ex
.
„_Àn
; i++) {

2990 
	`BUG_ON
(
	`mb_ã°_bô
(
ac
->
ac_b_ex
.
„_°¨t
 + 
i
,

2991 
bôm≠_bh
->
b_d©a
));

2995 
	`pxt4_£t_bôs
(
bôm≠_bh
->
b_d©a
, 
ac
->
ac_b_ex
.
„_°¨t
,

2996 
ac
->
ac_b_ex
.
„_Àn
);

2997 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

2998 (
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

2999 
gdp
->
bg_Êags
 &
	`˝u_to_À16
(~
PXT4_BG_BLOCK_UNINIT
);

3000 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
,

3001 
	`pxt4_‰ì_˛u°îs_a·î_öô
(
sb
,

3002 
ac
->
ac_b_ex
.
„_group
, 
gdp
));

3004 
Àn
 = 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
Ë- 
ac
->
ac_b_ex
.
„_Àn
;

3005 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
, 
Àn
);

3006 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
ac
->
ac_b_ex
.
„_group
, 
gdp
, 
bôm≠_bh
);

3007 
	`pxt4_group_desc_csum_£t
(
sb
, 
ac
->
ac_b_ex
.
„_group
, 
gdp
);

3009 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3010 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_‰ì˛u°îs_cou¡î
, 
ac
->
ac_b_ex
.
„_Àn
);

3014 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_DELALLOC_RESERVED
))

3016 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
,

3017 
ª£rv_˛°rs
);

3019 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

3020 
pxt4_group_t
 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
,

3021 
ac
->
ac_b_ex
.
„_group
);

3022 
	`©omic64_sub
(
ac
->
ac_b_ex
.
„_Àn
,

3023 &
sbi
->
s_Êex_groups
[
Êex_group
].
‰ì_˛u°îs
);

3026 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

3027 i‡(
îr
)

3028 
out_îr
;

3029 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdp_bh
);

3031 
out_îr
:

3032 
	`bªl£
(
bôm≠_bh
);

3033  
îr
;

3034 
	}
}

3045 
	$pxt4_mb_n‹mÆize_group_ªque°
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3047 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

3048 
pxt4_loˇlôy_group
 *
lg
 = 
ac
->
ac_lg
;

3050 
	`BUG_ON
(
lg
 =
NULL
);

3051 
ac
->
ac_g_ex
.
„_Àn
 = 
	`PXT4_SB
(
sb
)->
s_mb_group_¥óŒoc
;

3052 
	`mb_debug
(1, "#%u: goal %u blocks forÜocality group\n",

3053 
cuºít
->
pid
, 
ac
->
ac_g_ex
.
„_Àn
);

3054 
	}
}

3060 
noölöe_f‹_°ack
 

3061 
	$pxt4_mb_n‹mÆize_ªque°
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3062 
pxt4_Æloˇti⁄_ªque°
 *
¨
)

3064 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3065 
bsbôs
, 
max
;

3066 
pxt4_lblk_t
 
íd
;

3067 
loff_t
 
size
, 
°¨t_off
;

3068 
loff_t
 
‹ig_size
 
__maybe_unu£d
;

3069 
pxt4_lblk_t
 
°¨t
;

3070 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
ac
->
ac_öode
);

3071 
pxt4_¥óŒoc_•a˚
 *
∑
;

3075 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
))

3079 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GOAL_ONLY
))

3084 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_NOPREALLOC
)

3087 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
) {

3088 
	`pxt4_mb_n‹mÆize_group_ªque°
(
ac
);

3092 
bsbôs
 = 
ac
->
ac_sb
->
s_blocksize_bôs
;

3096 
size
 = 
ac
->
ac_o_ex
.
„_logiˇl
 + 
	`PXT4_C2B
(
sbi
,ác->ac_o_ex.
„_Àn
);

3097 
size
 = sizê<< 
bsbôs
;

3098 i‡(
size
 < 
	`i_size_ªad
(
ac
->
ac_öode
))

3099 
size
 = 
	`i_size_ªad
(
ac
->
ac_öode
);

3100 
‹ig_size
 = 
size
;

3103 
max
 = 2 << 
bsbôs
;

3105 
	#NRL_CHECK_SIZE
(
ªq
, 
size
, 
max
, 
chunk_size
) \

3106 (
ªq
 <(
size
Ë|| 
max
 <(
chunk_size
))

	)

3110 
°¨t_off
 = 0;

3111 i‡(
size
 <= 16 * 1024) {

3112 
size
 = 16 * 1024;

3113 } i‡(
size
 <= 32 * 1024) {

3114 
size
 = 32 * 1024;

3115 } i‡(
size
 <= 64 * 1024) {

3116 
size
 = 64 * 1024;

3117 } i‡(
size
 <= 128 * 1024) {

3118 
size
 = 128 * 1024;

3119 } i‡(
size
 <= 256 * 1024) {

3120 
size
 = 256 * 1024;

3121 } i‡(
size
 <= 512 * 1024) {

3122 
size
 = 512 * 1024;

3123 } i‡(
size
 <= 1024 * 1024) {

3124 
size
 = 1024 * 1024;

3125 } i‡(
	`NRL_CHECK_SIZE
(
size
, 4 * 1024 * 1024, 
max
, 2 * 1024)) {

3126 
°¨t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
„_logiˇl
 >>

3127 (21 - 
bsbôs
)) << 21;

3128 
size
 = 2 * 1024 * 1024;

3129 } i‡(
	`NRL_CHECK_SIZE
(
size
, 8 * 1024 * 1024, 
max
, 4 * 1024)) {

3130 
°¨t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
„_logiˇl
 >>

3131 (22 - 
bsbôs
)) << 22;

3132 
size
 = 4 * 1024 * 1024;

3133 } i‡(
	`NRL_CHECK_SIZE
(
ac
->
ac_o_ex
.
„_Àn
,

3134 (8<<20)>>
bsbôs
, 
max
, 8 * 1024)) {

3135 
°¨t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
„_logiˇl
 >>

3136 (23 - 
bsbôs
)) << 23;

3137 
size
 = 8 * 1024 * 1024;

3139 
°¨t_off
 = (
loff_t
Ë
ac
->
ac_o_ex
.
„_logiˇl
 << 
bsbôs
;

3140 
size
 = (
loff_t
Ë
	`PXT4_C2B
(
	`PXT4_SB
(
ac
->
ac_sb
),

3141 
ac
->
ac_o_ex
.
„_Àn
Ë<< 
bsbôs
;

3143 
size
 = sizê>> 
bsbôs
;

3144 
°¨t
 = 
°¨t_off
 >> 
bsbôs
;

3147 i‡(
¨
->
∂e·
 && 
°¨t
 <¨->
Œe·
) {

3148 
size
 -
¨
->
Œe·
 + 1 - 
°¨t
;

3149 
°¨t
 = 
¨
->
Œe·
 + 1;

3151 i‡(
¨
->
¥ight
 && 
°¨t
 + 
size
 - 1 >¨->
Ãight
)

3152 
size
 -
°¨t
 + sizê- 
¨
->
Ãight
;

3158 i‡(
size
 > 
	`PXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
))

3159 
size
 = 
	`PXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
);

3161 
íd
 = 
°¨t
 + 
size
;

3164 
	`rcu_ªad_lock
();

3165 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
ei
->
i_¥óŒoc_li°
, 
∑_öode_li°
) {

3166 
pxt4_lblk_t
 
∑_íd
;

3168 i‡(
∑
->
∑_dñëed
)

3170 
	`•ö_lock
(&
∑
->
∑_lock
);

3171 i‡(
∑
->
∑_dñëed
) {

3172 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3176 
∑_íd
 = 
∑
->
∑_l°¨t
 + 
	`PXT4_C2B
(
	`PXT4_SB
(
ac
->
ac_sb
),

3177 
∑
->
∑_Àn
);

3180 
	`BUG_ON
(!(
ac
->
ac_o_ex
.
„_logiˇl
 >
∑_íd
 ||

3181 
ac
->
ac_o_ex
.
„_logiˇl
 < 
∑
->
∑_l°¨t
));

3184 i‡(
∑
->
∑_l°¨t
 >
íd
 || 
∑_íd
 <
°¨t
) {

3185 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3188 
	`BUG_ON
(
∑
->
∑_l°¨t
 <
°¨t
 && 
∑_íd
 >
íd
);

3191 i‡(
∑_íd
 <
ac
->
ac_o_ex
.
„_logiˇl
) {

3192 
	`BUG_ON
(
∑_íd
 < 
°¨t
);

3193 
°¨t
 = 
∑_íd
;

3194 } i‡(
∑
->
∑_l°¨t
 > 
ac
->
ac_o_ex
.
„_logiˇl
) {

3195 
	`BUG_ON
(
∑
->
∑_l°¨t
 > 
íd
);

3196 
íd
 = 
∑
->
∑_l°¨t
;

3198 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3200 
	`rcu_ªad_u∆ock
();

3201 
size
 = 
íd
 - 
°¨t
;

3204 
	`rcu_ªad_lock
();

3205 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
ei
->
i_¥óŒoc_li°
, 
∑_öode_li°
) {

3206 
pxt4_lblk_t
 
∑_íd
;

3208 
	`•ö_lock
(&
∑
->
∑_lock
);

3209 i‡(
∑
->
∑_dñëed
 == 0) {

3210 
∑_íd
 = 
∑
->
∑_l°¨t
 + 
	`PXT4_C2B
(
	`PXT4_SB
(
ac
->
ac_sb
),

3211 
∑
->
∑_Àn
);

3212 
	`BUG_ON
(!(
°¨t
 >
∑_íd
 || 
íd
 <
∑
->
∑_l°¨t
));

3214 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3216 
	`rcu_ªad_u∆ock
();

3218 i‡(
°¨t
 + 
size
 <
ac
->
ac_o_ex
.
„_logiˇl
 &&

3219 
°¨t
 > 
ac
->
ac_o_ex
.
„_logiˇl
) {

3220 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
,

3222 (Ë
°¨t
, (Ë
size
,

3223 (Ë
ac
->
ac_o_ex
.
„_logiˇl
);

3224 
	`BUG
();

3226 
	`BUG_ON
(
size
 <0 || sizê> 
	`PXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
));

3232 
ac
->
ac_g_ex
.
„_logiˇl
 = 
°¨t
;

3233 
ac
->
ac_g_ex
.
„_Àn
 = 
	`PXT4_NUM_B2C
(
sbi
, 
size
);

3236 i‡(
¨
->
¥ight
 && (¨->
Ãight
 =(
°¨t
 + 
size
))) {

3238 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
¨
->
¥ight
 - 
size
,

3239 &
ac
->
ac_f_ex
.
„_group
,

3240 &
ac
->
ac_f_ex
.
„_°¨t
);

3241 
ac
->
ac_Êags
 |
PXT4_MB_HINT_TRY_GOAL
;

3243 i‡(
¨
->
∂e·
 && (¨->
Œe·
 + 1 =
°¨t
)) {

3245 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
¨
->
∂e·
 + 1,

3246 &
ac
->
ac_f_ex
.
„_group
,

3247 &
ac
->
ac_f_ex
.
„_°¨t
);

3248 
ac
->
ac_Êags
 |
PXT4_MB_HINT_TRY_GOAL
;

3251 
	`mb_debug
(1, "gﬂl: %u(wa†%uËblock†© %u\n", (Ë
size
,

3252 (Ë
‹ig_size
, (Ë
°¨t
);

3253 
	}
}

3255 
	$pxt4_mb_cﬁÀ˘_°©s
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3257 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3259 i‡(
sbi
->
s_mb_°©s
 && 
ac
->
ac_g_ex
.
„_Àn
 > 1) {

3260 
	`©omic_öc
(&
sbi
->
s_bÆ_ªqs
);

3261 
	`©omic_add
(
ac
->
ac_b_ex
.
„_Àn
, &
sbi
->
s_bÆ_Æloˇãd
);

3262 i‡(
ac
->
ac_b_ex
.
„_Àn
 >ac->
ac_o_ex
.fe_len)

3263 
	`©omic_öc
(&
sbi
->
s_bÆ_suc˚ss
);

3264 
	`©omic_add
(
ac
->
ac_found
, &
sbi
->
s_bÆ_ex_sˇ¬ed
);

3265 i‡(
ac
->
ac_g_ex
.
„_°¨t
 =ac->
ac_b_ex
.fe_start &&

3266 
ac
->
ac_g_ex
.
„_group
 =ac->
ac_b_ex
.fe_group)

3267 
	`©omic_öc
(&
sbi
->
s_bÆ_gﬂls
);

3268 i‡(
ac
->
ac_found
 > 
sbi
->
s_mb_max_to_sˇn
)

3269 
	`©omic_öc
(&
sbi
->
s_bÆ_bªaks
);

3272 i‡(
ac
->
ac_›
 =
PXT4_MB_HISTORY_ALLOC
)

3273 
	`åa˚_pxt4_mbÆloc_Æloc
(
ac
);

3275 
	`åa˚_pxt4_mbÆloc_¥óŒoc
(
ac
);

3276 
	}
}

3284 
	$pxt4_disˇrd_Æloˇãd_blocks
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3286 
pxt4_¥óŒoc_•a˚
 *
∑
 = 
ac
->
ac_∑
;

3287 
pxt4_buddy
 
e4b
;

3288 
îr
;

3290 i‡(
∑
 =
NULL
) {

3291 i‡(
ac
->
ac_f_ex
.
„_Àn
 == 0)

3293 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
ac
->
ac_sb
,ác->
ac_f_ex
.
„_group
, &
e4b
);

3294 i‡(
îr
) {

3300 
	`WARN
(1, "mb_lﬂd_buddy faûed (%d)", 
îr
);

3303 
	`pxt4_lock_group
(
ac
->
ac_sb
,ác->
ac_f_ex
.
„_group
);

3304 
	`mb_‰ì_blocks
(
ac
->
ac_öode
, &
e4b
,ác->
ac_f_ex
.
„_°¨t
,

3305 
ac
->
ac_f_ex
.
„_Àn
);

3306 
	`pxt4_u∆ock_group
(
ac
->
ac_sb
,ác->
ac_f_ex
.
„_group
);

3307 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

3310 i‡(
∑
->
∑_ty≥
 =
MB_INODE_PA
)

3311 
∑
->
∑_‰ì
 +
ac
->
ac_b_ex
.
„_Àn
;

3312 
	}
}

3317 
	$pxt4_mb_u£_öode_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3318 
pxt4_¥óŒoc_•a˚
 *
∑
)

3320 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3321 
pxt4_fsblk_t
 
°¨t
;

3322 
pxt4_fsblk_t
 
íd
;

3323 
Àn
;

3326 
°¨t
 = 
∑
->
∑_p°¨t
 + (
ac
->
ac_o_ex
.
„_logiˇl
 -Öa->
∑_l°¨t
);

3327 
íd
 = 
	`mö
(
∑
->
∑_p°¨t
 + 
	`PXT4_C2B
(
sbi
,Öa->
∑_Àn
),

3328 
°¨t
 + 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_o_ex
.
„_Àn
));

3329 
Àn
 = 
	`PXT4_NUM_B2C
(
sbi
, 
íd
 - 
°¨t
);

3330 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
°¨t
, &ac->
ac_b_ex
.
„_group
,

3331 &
ac
->
ac_b_ex
.
„_°¨t
);

3332 
ac
->
ac_b_ex
.
„_Àn
 = 
Àn
;

3333 
ac
->
ac_°©us
 = 
AC_STATUS_FOUND
;

3334 
ac
->
ac_∑
 = 
∑
;

3336 
	`BUG_ON
(
°¨t
 < 
∑
->
∑_p°¨t
);

3337 
	`BUG_ON
(
íd
 > 
∑
->
∑_p°¨t
 + 
	`PXT4_C2B
(
sbi
,Öa->
∑_Àn
));

3338 
	`BUG_ON
(
∑
->
∑_‰ì
 < 
Àn
);

3339 
∑
->
∑_‰ì
 -
Àn
;

3341 
	`mb_debug
(1, "u£ %Œu/%u from inodê∑ %p\n", 
°¨t
, 
Àn
, 
∑
);

3342 
	}
}

3347 
	$pxt4_mb_u£_group_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3348 
pxt4_¥óŒoc_•a˚
 *
∑
)

3350 
Àn
 = 
ac
->
ac_o_ex
.
„_Àn
;

3352 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
∑
->
∑_p°¨t
,

3353 &
ac
->
ac_b_ex
.
„_group
,

3354 &
ac
->
ac_b_ex
.
„_°¨t
);

3355 
ac
->
ac_b_ex
.
„_Àn
 = 
Àn
;

3356 
ac
->
ac_°©us
 = 
AC_STATUS_FOUND
;

3357 
ac
->
ac_∑
 = 
∑
;

3365 
	`mb_debug
(1, "u£ %u/%u from grou∞∑ %p\n", 
∑
->
∑_l°¨t
-
Àn
,Üen,Öa);

3366 
	}
}

3374 
pxt4_¥óŒoc_•a˚
 *

3375 
	$pxt4_mb_check_group_∑
(
pxt4_fsblk_t
 
gﬂl_block
,

3376 
pxt4_¥óŒoc_•a˚
 *
∑
,

3377 
pxt4_¥óŒoc_•a˚
 *
˝a
)

3379 
pxt4_fsblk_t
 
cur_di°™˚
, 
√w_di°™˚
;

3381 i‡(
˝a
 =
NULL
) {

3382 
	`©omic_öc
(&
∑
->
∑_cou¡
);

3383  
∑
;

3385 
cur_di°™˚
 = 
	`abs
(
gﬂl_block
 - 
˝a
->
∑_p°¨t
);

3386 
√w_di°™˚
 = 
	`abs
(
gﬂl_block
 - 
∑
->
∑_p°¨t
);

3388 i‡(
cur_di°™˚
 <
√w_di°™˚
)

3389  
˝a
;

3392 
	`©omic_dec
(&
˝a
->
∑_cou¡
);

3393 
	`©omic_öc
(&
∑
->
∑_cou¡
);

3394  
∑
;

3395 
	}
}

3400 
noölöe_f‹_°ack
 

3401 
	$pxt4_mb_u£_¥óŒoˇãd
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3403 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3404 
‹dî
, 
i
;

3405 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
ac
->
ac_öode
);

3406 
pxt4_loˇlôy_group
 *
lg
;

3407 
pxt4_¥óŒoc_•a˚
 *
∑
, *
˝a
 = 
NULL
;

3408 
pxt4_fsblk_t
 
gﬂl_block
;

3411 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
))

3415 
	`rcu_ªad_lock
();

3416 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
ei
->
i_¥óŒoc_li°
, 
∑_öode_li°
) {

3420 i‡(
ac
->
ac_o_ex
.
„_logiˇl
 < 
∑
->
∑_l°¨t
 ||

3421 
ac
->
ac_o_ex
.
„_logiˇl
 >(
∑
->
∑_l°¨t
 +

3422 
	`PXT4_C2B
(
sbi
, 
∑
->
∑_Àn
)))

3426 i‡(!(
	`pxt4_ã°_öode_Êag
(
ac
->
ac_öode
, 
PXT4_INODE_EXTENTS
)) &&

3427 (
∑
->
∑_p°¨t
 + 
	`PXT4_C2B
(
sbi
,Öa->
∑_Àn
) >

3428 
PXT4_MAX_BLOCK_FILE_PHYS
))

3432 
	`•ö_lock
(&
∑
->
∑_lock
);

3433 i‡(
∑
->
∑_dñëed
 =0 &&Öa->
∑_‰ì
) {

3434 
	`©omic_öc
(&
∑
->
∑_cou¡
);

3435 
	`pxt4_mb_u£_öode_∑
(
ac
, 
∑
);

3436 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3437 
ac
->
ac_¸ôîü
 = 10;

3438 
	`rcu_ªad_u∆ock
();

3441 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3443 
	`rcu_ªad_u∆ock
();

3446 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
))

3450 
lg
 = 
ac
->
ac_lg
;

3451 i‡(
lg
 =
NULL
)

3453 
‹dî
 = 
	`Ês
(
ac
->
ac_o_ex
.
„_Àn
) - 1;

3454 i‡(
‹dî
 > 
PREALLOC_TB_SIZE
 - 1)

3456 
‹dî
 = 
PREALLOC_TB_SIZE
 - 1;

3458 
gﬂl_block
 = 
	`pxt4_gΩ_offs_to_block
(
ac
->
ac_sb
, &ac->
ac_g_ex
);

3463 
i
 = 
‹dî
; i < 
PREALLOC_TB_SIZE
; i++) {

3464 
	`rcu_ªad_lock
();

3465 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
lg
->
lg_¥óŒoc_li°
[
i
],

3466 
∑_öode_li°
) {

3467 
	`•ö_lock
(&
∑
->
∑_lock
);

3468 i‡(
∑
->
∑_dñëed
 == 0 &&

3469 
∑
->
∑_‰ì
 >
ac
->
ac_o_ex
.
„_Àn
) {

3471 
˝a
 = 
	`pxt4_mb_check_group_∑
(
gﬂl_block
,

3472 
∑
, 
˝a
);

3474 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3476 
	`rcu_ªad_u∆ock
();

3478 i‡(
˝a
) {

3479 
	`pxt4_mb_u£_group_∑
(
ac
, 
˝a
);

3480 
ac
->
ac_¸ôîü
 = 20;

3484 
	}
}

3492 
	$pxt4_mb_gíî©e_‰om_‰ìli°
(
su≥r_block
 *
sb
, *
bôm≠
,

3493 
pxt4_group_t
 
group
)

3495 
rb_node
 *
n
;

3496 
pxt4_group_öfo
 *
gΩ
;

3497 
pxt4_‰ì_d©a
 *
íåy
;

3499 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

3500 
n
 = 
	`rb_fú°
(&(
gΩ
->
bb_‰ì_roŸ
));

3502 
n
) {

3503 
íåy
 = 
	`rb_íåy
(
n
, 
pxt4_‰ì_d©a
, 
efd_node
);

3504 
	`pxt4_£t_bôs
(
bôm≠
, 
íåy
->
efd_°¨t_˛u°î
,É¡ry->
efd_cou¡
);

3505 
n
 = 
	`rb_√xt
(n);

3508 
	}
}

3515 
noölöe_f‹_°ack


3516 
	$pxt4_mb_gíî©e_‰om_∑
(
su≥r_block
 *
sb
, *
bôm≠
,

3517 
pxt4_group_t
 
group
)

3519 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

3520 
pxt4_¥óŒoc_•a˚
 *
∑
;

3521 
li°_hód
 *
cur
;

3522 
pxt4_group_t
 
grou≤r
;

3523 
pxt4_gΩblk_t
 
°¨t
;

3524 
¥óŒoˇãd
 = 0;

3525 
Àn
;

3535 
	`li°_f‹_óch
(
cur
, &
gΩ
->
bb_¥óŒoc_li°
) {

3536 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
, 
∑_group_li°
);

3537 
	`•ö_lock
(&
∑
->
∑_lock
);

3538 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
,

3539 &
grou≤r
, &
°¨t
);

3540 
Àn
 = 
∑
->
∑_Àn
;

3541 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3542 i‡(
	`u∆ikñy
(
Àn
 == 0))

3544 
	`BUG_ON
(
grou≤r
 !
group
);

3545 
	`pxt4_£t_bôs
(
bôm≠
, 
°¨t
, 
Àn
);

3546 
¥óŒoˇãd
 +
Àn
;

3548 
	`mb_debug
(1, "¥óŒoˇãd %u f‹ grou∞%u\n", 
¥óŒoˇãd
, 
group
);

3549 
	}
}

3551 
	$pxt4_mb_∑_ˇŒback
(
rcu_hód
 *
hód
)

3553 
pxt4_¥óŒoc_•a˚
 *
∑
;

3554 
∑
 = 
	`c⁄èöî_of
(
hód
, 
pxt4_¥óŒoc_•a˚
, 
u
.
∑_rcu
);

3556 
	`BUG_ON
(
	`©omic_ªad
(&
∑
->
∑_cou¡
));

3557 
	`BUG_ON
(
∑
->
∑_dñëed
 == 0);

3558 
	`kmem_ˇche_‰ì
(
pxt4_p•a˚_ˇchï
, 
∑
);

3559 
	}
}

3565 
	$pxt4_mb_put_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3566 
su≥r_block
 *
sb
, 
pxt4_¥óŒoc_•a˚
 *
∑
)

3568 
pxt4_group_t
 
gΩ
;

3569 
pxt4_fsblk_t
 
gΩ_blk
;

3572 
	`•ö_lock
(&
∑
->
∑_lock
);

3573 i‡(!
	`©omic_dec_™d_ã°
(&
∑
->
∑_cou¡
Ë||Öa->
∑_‰ì
 != 0) {

3574 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3578 i‡(
∑
->
∑_dñëed
 == 1) {

3579 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3583 
∑
->
∑_dñëed
 = 1;

3584 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3586 
gΩ_blk
 = 
∑
->
∑_p°¨t
;

3591 i‡(
∑
->
∑_ty≥
 =
MB_GROUP_PA
)

3592 
gΩ_blk
--;

3594 
gΩ
 = 
	`pxt4_gë_group_numbî
(
sb
, 
gΩ_blk
);

3610 
	`pxt4_lock_group
(
sb
, 
gΩ
);

3611 
	`li°_dñ
(&
∑
->
∑_group_li°
);

3612 
	`pxt4_u∆ock_group
(
sb
, 
gΩ
);

3614 
	`•ö_lock
(
∑
->
∑_obj_lock
);

3615 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

3616 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

3618 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

3619 
	}
}

3624 
noölöe_f‹_°ack
 

3625 
	$pxt4_mb_√w_öode_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3627 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

3628 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3629 
pxt4_¥óŒoc_•a˚
 *
∑
;

3630 
pxt4_group_öfo
 *
gΩ
;

3631 
pxt4_öode_öfo
 *
ei
;

3634 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_Àn
 >ac->
ac_b_ex
.fe_len);

3635 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
);

3636 
	`BUG_ON
(!
	`S_ISREG
(
ac
->
ac_öode
->
i_mode
));

3638 
∑
 = 
	`kmem_ˇche_Æloc
(
pxt4_p•a˚_ˇchï
, 
GFP_NOFS
);

3639 i‡(
∑
 =
NULL
)

3640  -
ENOMEM
;

3642 i‡(
ac
->
ac_b_ex
.
„_Àn
 <ác->
ac_g_ex
.fe_len) {

3643 
wöl
;

3644 
wös
;

3645 
wö
;

3646 
offs
;

3651 
	`BUG_ON
(
ac
->
ac_g_ex
.
„_logiˇl
 >ác->
ac_o_ex
.fe_logical);

3652 
	`BUG_ON
(
ac
->
ac_g_ex
.
„_Àn
 <ác->
ac_o_ex
.fe_len);

3657 
wöl
 = 
ac
->
ac_o_ex
.
„_logiˇl
 -ác->
ac_g_ex
.fe_logical;

3660 
wös
 = 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
 -ác->
ac_o_ex
.fe_len);

3663 
wö
 = 
	`mö
(
wöl
, 
wös
);

3665 
offs
 = 
ac
->
ac_o_ex
.
„_logiˇl
 %

3666 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

3667 i‡(
offs
 && off†< 
wö
)

3668 
wö
 = 
offs
;

3670 
ac
->
ac_b_ex
.
„_logiˇl
 =ác->
ac_o_ex
.fe_logical -

3671 
	`PXT4_NUM_B2C
(
sbi
, 
wö
);

3672 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_logiˇl
 <ác->
ac_b_ex
.fe_logical);

3673 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_Àn
 >ác->
ac_b_ex
.fe_len);

3678 
ac
->
ac_f_ex
 =ác->
ac_b_ex
;

3680 
∑
->
∑_l°¨t
 = 
ac
->
ac_b_ex
.
„_logiˇl
;

3681 
∑
->
∑_p°¨t
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

3682 
∑
->
∑_Àn
 = 
ac
->
ac_b_ex
.
„_Àn
;

3683 
∑
->
∑_‰ì
 =Öa->
∑_Àn
;

3684 
	`©omic_£t
(&
∑
->
∑_cou¡
, 1);

3685 
	`•ö_lock_öô
(&
∑
->
∑_lock
);

3686 
	`INIT_LIST_HEAD
(&
∑
->
∑_öode_li°
);

3687 
	`INIT_LIST_HEAD
(&
∑
->
∑_group_li°
);

3688 
∑
->
∑_dñëed
 = 0;

3689 
∑
->
∑_ty≥
 = 
MB_INODE_PA
;

3691 
	`mb_debug
(1, "√w inodê∑ %p: %Œu/%u f‹ %u\n", 
∑
,

3692 
∑
->
∑_p°¨t
,Öa->
∑_Àn
,Öa->
∑_l°¨t
);

3693 
	`åa˚_pxt4_mb_√w_öode_∑
(
ac
, 
∑
);

3695 
	`pxt4_mb_u£_öode_∑
(
ac
, 
∑
);

3696 
	`©omic_add
(
∑
->
∑_‰ì
, &
sbi
->
s_mb_¥óŒoˇãd
);

3698 
ei
 = 
	`PXT4_I
(
ac
->
ac_öode
);

3699 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3701 
∑
->
∑_obj_lock
 = &
ei
->
i_¥óŒoc_lock
;

3702 
∑
->
∑_öode
 = 
ac
->
ac_öode
;

3704 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3705 
	`li°_add
(&
∑
->
∑_group_li°
, &
gΩ
->
bb_¥óŒoc_li°
);

3706 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3708 
	`•ö_lock
(
∑
->
∑_obj_lock
);

3709 
	`li°_add_rcu
(&
∑
->
∑_öode_li°
, &
ei
->
i_¥óŒoc_li°
);

3710 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

3713 
	}
}

3718 
noölöe_f‹_°ack
 

3719 
	$pxt4_mb_√w_group_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3721 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

3722 
pxt4_loˇlôy_group
 *
lg
;

3723 
pxt4_¥óŒoc_•a˚
 *
∑
;

3724 
pxt4_group_öfo
 *
gΩ
;

3727 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_Àn
 >ac->
ac_b_ex
.fe_len);

3728 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
);

3729 
	`BUG_ON
(!
	`S_ISREG
(
ac
->
ac_öode
->
i_mode
));

3731 
	`BUG_ON
(
pxt4_p•a˚_ˇchï
 =
NULL
);

3732 
∑
 = 
	`kmem_ˇche_Æloc
(
pxt4_p•a˚_ˇchï
, 
GFP_NOFS
);

3733 i‡(
∑
 =
NULL
)

3734  -
ENOMEM
;

3738 
ac
->
ac_f_ex
 =ác->
ac_b_ex
;

3740 
∑
->
∑_p°¨t
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

3741 
∑
->
∑_l°¨t
 =Öa->
∑_p°¨t
;

3742 
∑
->
∑_Àn
 = 
ac
->
ac_b_ex
.
„_Àn
;

3743 
∑
->
∑_‰ì
 =Öa->
∑_Àn
;

3744 
	`©omic_£t
(&
∑
->
∑_cou¡
, 1);

3745 
	`•ö_lock_öô
(&
∑
->
∑_lock
);

3746 
	`INIT_LIST_HEAD
(&
∑
->
∑_öode_li°
);

3747 
	`INIT_LIST_HEAD
(&
∑
->
∑_group_li°
);

3748 
∑
->
∑_dñëed
 = 0;

3749 
∑
->
∑_ty≥
 = 
MB_GROUP_PA
;

3751 
	`mb_debug
(1, "√w grou∞∑ %p: %Œu/%u f‹ %u\n", 
∑
,

3752 
∑
->
∑_p°¨t
,Öa->
∑_Àn
,Öa->
∑_l°¨t
);

3753 
	`åa˚_pxt4_mb_√w_group_∑
(
ac
, 
∑
);

3755 
	`pxt4_mb_u£_group_∑
(
ac
, 
∑
);

3756 
	`©omic_add
(
∑
->
∑_‰ì
, &
	`PXT4_SB
(
sb
)->
s_mb_¥óŒoˇãd
);

3758 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3759 
lg
 = 
ac
->
ac_lg
;

3760 
	`BUG_ON
(
lg
 =
NULL
);

3762 
∑
->
∑_obj_lock
 = &
lg
->
lg_¥óŒoc_lock
;

3763 
∑
->
∑_öode
 = 
NULL
;

3765 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3766 
	`li°_add
(&
∑
->
∑_group_li°
, &
gΩ
->
bb_¥óŒoc_li°
);

3767 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3774 
	}
}

3776 
	$pxt4_mb_√w_¥óŒoˇti⁄
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3778 
îr
;

3780 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
)

3781 
îr
 = 
	`pxt4_mb_√w_group_∑
(
ac
);

3783 
îr
 = 
	`pxt4_mb_√w_öode_∑
(
ac
);

3784  
îr
;

3785 
	}
}

3795 
noölöe_f‹_°ack
 

3796 
	$pxt4_mb_ªÀa£_öode_∑
(
pxt4_buddy
 *
e4b
, 
buf„r_hód
 *
bôm≠_bh
,

3797 
pxt4_¥óŒoc_•a˚
 *
∑
)

3799 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

3800 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3801 
íd
;

3802 
√xt
;

3803 
pxt4_group_t
 
group
;

3804 
pxt4_gΩblk_t
 
bô
;

3805 
gΩ_blk_°¨t
;

3806 
‰ì
 = 0;

3808 
	`BUG_ON
(
∑
->
∑_dñëed
 == 0);

3809 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
, &
group
, &
bô
);

3810 
gΩ_blk_°¨t
 = 
∑
->
∑_p°¨t
 - 
	`PXT4_C2B
(
sbi
, 
bô
);

3811 
	`BUG_ON
(
group
 !
e4b
->
bd_group
 && 
∑
->
∑_Àn
 != 0);

3812 
íd
 = 
bô
 + 
∑
->
∑_Àn
;

3814 
bô
 < 
íd
) {

3815 
bô
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠_bh
->
b_d©a
, 
íd
, bit);

3816 i‡(
bô
 >
íd
)

3818 
√xt
 = 
	`mb_föd_√xt_bô
(
bôm≠_bh
->
b_d©a
, 
íd
, 
bô
);

3819 
	`mb_debug
(1, " freeÖreallocated %u/%u in group %u\n",

3820 (Ë
	`pxt4_group_fú°_block_no
(
sb
, 
group
Ë+ 
bô
,

3821 (Ë
√xt
 - 
bô
, (Ë
group
);

3822 
‰ì
 +
√xt
 - 
bô
;

3824 
	`åa˚_pxt4_mbÆloc_disˇrd
(
sb
, 
NULL
, 
group
, 
bô
, 
√xt
 - bit);

3825 
	`åa˚_pxt4_mb_ªÀa£_öode_∑
(
∑
, (
gΩ_blk_°¨t
 +

3826 
	`PXT4_C2B
(
sbi
, 
bô
)),

3827 
√xt
 - 
bô
);

3828 
	`mb_‰ì_blocks
(
∑
->
∑_öode
, 
e4b
, 
bô
, 
√xt
 - bit);

3829 
bô
 = 
√xt
 + 1;

3831 i‡(
‰ì
 !
∑
->
∑_‰ì
) {

3832 
	`pxt4_msg
(
e4b
->
bd_sb
, 
KERN_CRIT
,

3834 
∑
, (Ë∑->
∑_l°¨t
,

3835 (Ë
∑
->
∑_p°¨t
,

3836 (Ë
∑
->
∑_Àn
);

3837 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
group
, 0, 0, "free %u,Öa_free %u",

3838 
‰ì
, 
∑
->
∑_‰ì
);

3844 
	`©omic_add
(
‰ì
, &
sbi
->
s_mb_disˇrded
);

3847 
	}
}

3849 
noölöe_f‹_°ack
 

3850 
	$pxt4_mb_ªÀa£_group_∑
(
pxt4_buddy
 *
e4b
,

3851 
pxt4_¥óŒoc_•a˚
 *
∑
)

3853 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

3854 
pxt4_group_t
 
group
;

3855 
pxt4_gΩblk_t
 
bô
;

3857 
	`åa˚_pxt4_mb_ªÀa£_group_∑
(
sb
, 
∑
);

3858 
	`BUG_ON
(
∑
->
∑_dñëed
 == 0);

3859 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
, &
group
, &
bô
);

3860 
	`BUG_ON
(
group
 !
e4b
->
bd_group
 && 
∑
->
∑_Àn
 != 0);

3861 
	`mb_‰ì_blocks
(
∑
->
∑_öode
, 
e4b
, 
bô
,Öa->
∑_Àn
);

3862 
	`©omic_add
(
∑
->
∑_Àn
, &
	`PXT4_SB
(
sb
)->
s_mb_disˇrded
);

3863 
	`åa˚_pxt4_mbÆloc_disˇrd
(
sb
, 
NULL
, 
group
, 
bô
, 
∑
->
∑_Àn
);

3866 
	}
}

3877 
noölöe_f‹_°ack
 

3878 
	$pxt4_mb_disˇrd_group_¥óŒoˇti⁄s
(
su≥r_block
 *
sb
,

3879 
pxt4_group_t
 
group
, 
√eded
)

3881 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

3882 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

3883 
pxt4_¥óŒoc_•a˚
 *
∑
, *
tmp
;

3884 
li°_hód
 
li°
;

3885 
pxt4_buddy
 
e4b
;

3886 
îr
;

3887 
busy
 = 0;

3888 
‰ì
 = 0;

3890 
	`mb_debug
(1, "disˇrdÖªÆloˇti⁄ f‹ grou∞%u\n", 
group
);

3892 i‡(
	`li°_em±y
(&
gΩ
->
bb_¥óŒoc_li°
))

3895 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

3896 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

3897 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

3898 
	`pxt4_îr‹
(
sb
, "Error %dÑeading block bitmap for %u",

3899 
îr
, 
group
);

3903 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

3904 i‡(
îr
) {

3905 
	`pxt4_w¨nög
(
sb
, "Error %dÜoading buddy information for %u",

3906 
îr
, 
group
);

3907 
	`put_bh
(
bôm≠_bh
);

3911 i‡(
√eded
 == 0)

3912 
√eded
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) + 1;

3914 
	`INIT_LIST_HEAD
(&
li°
);

3915 
ª≥©
:

3916 
	`pxt4_lock_group
(
sb
, 
group
);

3917 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
,

3918 &
gΩ
->
bb_¥óŒoc_li°
, 
∑_group_li°
) {

3919 
	`•ö_lock
(&
∑
->
∑_lock
);

3920 i‡(
	`©omic_ªad
(&
∑
->
∑_cou¡
)) {

3921 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3922 
busy
 = 1;

3925 i‡(
∑
->
∑_dñëed
) {

3926 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3931 
∑
->
∑_dñëed
 = 1;

3934 
‰ì
 +
∑
->
∑_‰ì
;

3936 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3938 
	`li°_dñ
(&
∑
->
∑_group_li°
);

3939 
	`li°_add
(&
∑
->
u
.
∑_tmp_li°
, &
li°
);

3943 i‡(
‰ì
 < 
√eded
 && 
busy
) {

3944 
busy
 = 0;

3945 
	`pxt4_u∆ock_group
(
sb
, 
group
);

3946 
	`c⁄d_ªsched
();

3947 
ª≥©
;

3951 i‡(
	`li°_em±y
(&
li°
)) {

3952 
	`BUG_ON
(
‰ì
 != 0);

3953 
out
;

3957 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
, &
li°
, 
u
.
∑_tmp_li°
) {

3960 
	`•ö_lock
(
∑
->
∑_obj_lock
);

3961 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

3962 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

3964 i‡(
∑
->
∑_ty≥
 =
MB_GROUP_PA
)

3965 
	`pxt4_mb_ªÀa£_group_∑
(&
e4b
, 
∑
);

3967 
	`pxt4_mb_ªÀa£_öode_∑
(&
e4b
, 
bôm≠_bh
, 
∑
);

3969 
	`li°_dñ
(&
∑
->
u
.
∑_tmp_li°
);

3970 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

3973 
out
:

3974 
	`pxt4_u∆ock_group
(
sb
, 
group
);

3975 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

3976 
	`put_bh
(
bôm≠_bh
);

3977  
‰ì
;

3978 
	}
}

3989 
	$pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
 *inode)

3991 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

3992 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

3993 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

3994 
pxt4_¥óŒoc_•a˚
 *
∑
, *
tmp
;

3995 
pxt4_group_t
 
group
 = 0;

3996 
li°_hód
 
li°
;

3997 
pxt4_buddy
 
e4b
;

3998 
îr
;

4000 i‡(!
	`S_ISREG
(
öode
->
i_mode
)) {

4005 
	`mb_debug
(1, "disˇrdÖªÆloˇti⁄ f‹ inodê%lu\n", 
öode
->
i_öo
);

4006 
	`åa˚_pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4008 
	`INIT_LIST_HEAD
(&
li°
);

4010 
ª≥©
:

4012 
	`•ö_lock
(&
ei
->
i_¥óŒoc_lock
);

4013 !
	`li°_em±y
(&
ei
->
i_¥óŒoc_li°
)) {

4014 
∑
 = 
	`li°_íåy
(
ei
->
i_¥óŒoc_li°
.
√xt
,

4015 
pxt4_¥óŒoc_•a˚
, 
∑_öode_li°
);

4016 
	`BUG_ON
(
∑
->
∑_obj_lock
 !&
ei
->
i_¥óŒoc_lock
);

4017 
	`•ö_lock
(&
∑
->
∑_lock
);

4018 i‡(
	`©omic_ªad
(&
∑
->
∑_cou¡
)) {

4021 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4022 
	`•ö_u∆ock
(&
ei
->
i_¥óŒoc_lock
);

4023 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4025 
	`WARN_ON
(1);

4026 
	`scheduÀ_timeout_unöãºu±ibÀ
(
HZ
);

4027 
ª≥©
;

4030 i‡(
∑
->
∑_dñëed
 == 0) {

4031 
∑
->
∑_dñëed
 = 1;

4032 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4033 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

4034 
	`li°_add
(&
∑
->
u
.
∑_tmp_li°
, &
li°
);

4039 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4040 
	`•ö_u∆ock
(&
ei
->
i_¥óŒoc_lock
);

4054 
	`scheduÀ_timeout_unöãºu±ibÀ
(
HZ
);

4055 
ª≥©
;

4057 
	`•ö_u∆ock
(&
ei
->
i_¥óŒoc_lock
);

4059 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
, &
li°
, 
u
.
∑_tmp_li°
) {

4060 
	`BUG_ON
(
∑
->
∑_ty≥
 !
MB_INODE_PA
);

4061 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
∑
->
∑_p°¨t
);

4063 
îr
 = 
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
group
, &
e4b
,

4064 
GFP_NOFS
|
__GFP_NOFAIL
);

4065 i‡(
îr
) {

4066 
	`pxt4_îr‹
(
sb
, "Error %dÜoading buddy information for %u",

4067 
îr
, 
group
);

4071 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

4072 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

4073 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

4074 
	`pxt4_îr‹
(
sb
, "Error %dÑeading block bitmap for %u",

4075 
îr
, 
group
);

4076 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4080 
	`pxt4_lock_group
(
sb
, 
group
);

4081 
	`li°_dñ
(&
∑
->
∑_group_li°
);

4082 
	`pxt4_mb_ªÀa£_öode_∑
(&
e4b
, 
bôm≠_bh
, 
∑
);

4083 
	`pxt4_u∆ock_group
(
sb
, 
group
);

4085 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4086 
	`put_bh
(
bôm≠_bh
);

4088 
	`li°_dñ
(&
∑
->
u
.
∑_tmp_li°
);

4089 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

4091 
	}
}

4093 #ifde‡
CONFIG_PXT4_DEBUG


4094 
	$pxt4_mb_show_ac
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4096 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

4097 
pxt4_group_t
 
ngroups
, 
i
;

4099 i‡(!
pxt4_mbÆloc_debug
 ||

4100 (
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
))

4103 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "Can'tállocate:"

4105 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "status %d flags %d",

4106 
ac
->
ac_°©us
,ác->
ac_Êags
);

4107 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "orig %lu/%lu/%lu@%lu, "

4110 ()
ac
->
ac_o_ex
.
„_group
,

4111 ()
ac
->
ac_o_ex
.
„_°¨t
,

4112 ()
ac
->
ac_o_ex
.
„_Àn
,

4113 ()
ac
->
ac_o_ex
.
„_logiˇl
,

4114 ()
ac
->
ac_g_ex
.
„_group
,

4115 ()
ac
->
ac_g_ex
.
„_°¨t
,

4116 ()
ac
->
ac_g_ex
.
„_Àn
,

4117 ()
ac
->
ac_g_ex
.
„_logiˇl
,

4118 ()
ac
->
ac_b_ex
.
„_group
,

4119 ()
ac
->
ac_b_ex
.
„_°¨t
,

4120 ()
ac
->
ac_b_ex
.
„_Àn
,

4121 ()
ac
->
ac_b_ex
.
„_logiˇl
,

4122 ()
ac
->
ac_¸ôîü
);

4123 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "%d found",ác->
ac_found
);

4124 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "groups: ");

4125 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

4126 
i
 = 0; i < 
ngroups
; i++) {

4127 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

4128 
pxt4_¥óŒoc_•a˚
 *
∑
;

4129 
pxt4_gΩblk_t
 
°¨t
;

4130 
li°_hód
 *
cur
;

4131 
	`pxt4_lock_group
(
sb
, 
i
);

4132 
	`li°_f‹_óch
(
cur
, &
gΩ
->
bb_¥óŒoc_li°
) {

4133 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
,

4134 
∑_group_li°
);

4135 
	`•ö_lock
(&
∑
->
∑_lock
);

4136 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
,

4137 
NULL
, &
°¨t
);

4138 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4139 
	`¥ötk
(
KERN_ERR
 "PA:%u:%d:%u \n", 
i
,

4140 
°¨t
, 
∑
->
∑_Àn
);

4142 
	`pxt4_u∆ock_group
(
sb
, 
i
);

4144 i‡(
gΩ
->
bb_‰ì
 == 0)

4146 
	`¥ötk
(
KERN_ERR
 "%u: %d/%d \n",

4147 
i
, 
gΩ
->
bb_‰ì
, gΩ->
bb_‰agmíts
);

4149 
	`¥ötk
(
KERN_ERR
 "\n");

4150 
	}
}

4152 
ölöe
 
	$pxt4_mb_show_ac
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4155 
	}
}

4165 
	$pxt4_mb_group_‹_fûe
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4167 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

4168 
bsbôs
 = 
ac
->
ac_sb
->
s_blocksize_bôs
;

4169 
loff_t
 
size
, 
isize
;

4171 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
))

4174 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GOAL_ONLY
))

4177 
size
 = 
ac
->
ac_o_ex
.
„_logiˇl
 + 
	`PXT4_C2B
(
sbi
,ác->ac_o_ex.
„_Àn
);

4178 
isize
 = (
	`i_size_ªad
(
ac
->
ac_öode
Ë+ác->
ac_sb
->
s_blocksize
 - 1)

4179 >> 
bsbôs
;

4181 i‡((
size
 =
isize
Ë&& !
	`pxt4_fs_is_busy
(
sbi
) &&

4182 !
	`öode_is_›í_f‹_wrôe
(
ac
->
ac_öode
)) {

4183 
ac
->
ac_Êags
 |
PXT4_MB_HINT_NOPREALLOC
;

4187 i‡(
sbi
->
s_mb_group_¥óŒoc
 <= 0) {

4188 
ac
->
ac_Êags
 |
PXT4_MB_STREAM_ALLOC
;

4193 
size
 = 
	`max
(size, 
isize
);

4194 i‡(
size
 > 
sbi
->
s_mb_°ªam_ªque°
) {

4195 
ac
->
ac_Êags
 |
PXT4_MB_STREAM_ALLOC
;

4199 
	`BUG_ON
(
ac
->
ac_lg
 !
NULL
);

4205 
ac
->
ac_lg
 = 
	`øw_˝u_±r
(
sbi
->
s_loˇlôy_groups
);

4208 
ac
->
ac_Êags
 |
PXT4_MB_HINT_GROUP_ALLOC
;

4211 
	`muãx_lock
(&
ac
->
ac_lg
->
lg_muãx
);

4212 
	}
}

4214 
noölöe_f‹_°ack
 

4215 
	$pxt4_mb_öôülize_c⁄ãxt
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

4216 
pxt4_Æloˇti⁄_ªque°
 *
¨
)

4218 
su≥r_block
 *
sb
 = 
¨
->
öode
->
i_sb
;

4219 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4220 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

4221 
pxt4_group_t
 
group
;

4222 
Àn
;

4223 
pxt4_fsblk_t
 
gﬂl
;

4224 
pxt4_gΩblk_t
 
block
;

4227 
Àn
 = 
¨
->len;

4230 i‡(
Àn
 >
	`PXT4_CLUSTERS_PER_GROUP
(
sb
))

4231 
Àn
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

4234 
gﬂl
 = 
¨
->goal;

4235 i‡(
gﬂl
 < 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
) ||

4236 
gﬂl
 >
	`pxt4_blocks_cou¡
(
es
))

4237 
gﬂl
 = 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
);

4238 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
gﬂl
, &
group
, &
block
);

4241 
ac
->
ac_b_ex
.
„_logiˇl
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
¨
->
logiˇl
);

4242 
ac
->
ac_°©us
 = 
AC_STATUS_CONTINUE
;

4243 
ac
->
ac_sb
 = 
sb
;

4244 
ac
->
ac_öode
 = 
¨
->
öode
;

4245 
ac
->
ac_o_ex
.
„_logiˇl
 =ác->
ac_b_ex
.fe_logical;

4246 
ac
->
ac_o_ex
.
„_group
 = 
group
;

4247 
ac
->
ac_o_ex
.
„_°¨t
 = 
block
;

4248 
ac
->
ac_o_ex
.
„_Àn
 = 
Àn
;

4249 
ac
->
ac_g_ex
 =ác->
ac_o_ex
;

4250 
ac
->
ac_Êags
 = 
¨
->
Êags
;

4254 
	`pxt4_mb_group_‹_fûe
(
ac
);

4256 
	`mb_debug
(1, "initác: %u blocks @ %u, goal %u, flags %x, 2^%d, "

4258 (Ë
¨
->
Àn
, (Ë¨->
logiˇl
,

4259 (Ë
¨
->
gﬂl
, 
ac
->
ac_Êags
,ác->
ac_2‹dî
,

4260 (Ë
¨
->
Œe·
, (Ë¨->
∂e·
,

4261 (Ë
¨
->
Ãight
, (Ë¨->
¥ight
,

4262 
	`öode_is_›í_f‹_wrôe
(
¨
->
öode
) ? "" : "non-");

4265 
	}
}

4267 
noölöe_f‹_°ack
 

4268 
	$pxt4_mb_disˇrd_lg_¥óŒoˇti⁄s
(
su≥r_block
 *
sb
,

4269 
pxt4_loˇlôy_group
 *
lg
,

4270 
‹dî
, 
tŸÆ_íåõs
)

4272 
pxt4_group_t
 
group
 = 0;

4273 
pxt4_buddy
 
e4b
;

4274 
li°_hód
 
disˇrd_li°
;

4275 
pxt4_¥óŒoc_•a˚
 *
∑
, *
tmp
;

4277 
	`mb_debug
(1, "discardÜocality groupÖreallocation\n");

4279 
	`INIT_LIST_HEAD
(&
disˇrd_li°
);

4281 
	`•ö_lock
(&
lg
->
lg_¥óŒoc_lock
);

4282 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
lg
->
lg_¥óŒoc_li°
[
‹dî
],

4283 
∑_öode_li°
) {

4284 
	`•ö_lock
(&
∑
->
∑_lock
);

4285 i‡(
	`©omic_ªad
(&
∑
->
∑_cou¡
)) {

4291 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4294 i‡(
∑
->
∑_dñëed
) {

4295 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4299 
	`BUG_ON
(
∑
->
∑_ty≥
 !
MB_GROUP_PA
);

4302 
∑
->
∑_dñëed
 = 1;

4303 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4305 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

4306 
	`li°_add
(&
∑
->
u
.
∑_tmp_li°
, &
disˇrd_li°
);

4308 
tŸÆ_íåõs
--;

4309 i‡(
tŸÆ_íåõs
 <= 5) {

4319 
	`•ö_u∆ock
(&
lg
->
lg_¥óŒoc_lock
);

4321 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
, &
disˇrd_li°
, 
u
.
∑_tmp_li°
) {

4322 
îr
;

4324 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
∑
->
∑_p°¨t
);

4325 
îr
 = 
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
group
, &
e4b
,

4326 
GFP_NOFS
|
__GFP_NOFAIL
);

4327 i‡(
îr
) {

4328 
	`pxt4_îr‹
(
sb
, "Error %dÜoading buddy information for %u",

4329 
îr
, 
group
);

4332 
	`pxt4_lock_group
(
sb
, 
group
);

4333 
	`li°_dñ
(&
∑
->
∑_group_li°
);

4334 
	`pxt4_mb_ªÀa£_group_∑
(&
e4b
, 
∑
);

4335 
	`pxt4_u∆ock_group
(
sb
, 
group
);

4337 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4338 
	`li°_dñ
(&
∑
->
u
.
∑_tmp_li°
);

4339 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

4341 
	}
}

4352 
	$pxt4_mb_add_n_åim
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4354 
‹dî
, 
added
 = 0, 
lg_¥óŒoc_cou¡
 = 1;

4355 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

4356 
pxt4_loˇlôy_group
 *
lg
 = 
ac
->
ac_lg
;

4357 
pxt4_¥óŒoc_•a˚
 *
tmp_∑
, *
∑
 = 
ac
->
ac_∑
;

4359 
‹dî
 = 
	`Ês
(
∑
->
∑_‰ì
) - 1;

4360 i‡(
‹dî
 > 
PREALLOC_TB_SIZE
 - 1)

4362 
‹dî
 = 
PREALLOC_TB_SIZE
 - 1;

4364 
	`•ö_lock
(&
lg
->
lg_¥óŒoc_lock
);

4365 
	`li°_f‹_óch_íåy_rcu
(
tmp_∑
, &
lg
->
lg_¥óŒoc_li°
[
‹dî
],

4366 
∑_öode_li°
) {

4367 
	`•ö_lock
(&
tmp_∑
->
∑_lock
);

4368 i‡(
tmp_∑
->
∑_dñëed
) {

4369 
	`•ö_u∆ock
(&
tmp_∑
->
∑_lock
);

4372 i‡(!
added
 && 
∑
->
∑_‰ì
 < 
tmp_∑
->pa_free) {

4374 
	`li°_add_èû_rcu
(&
∑
->
∑_öode_li°
,

4375 &
tmp_∑
->
∑_öode_li°
);

4376 
added
 = 1;

4382 
	`•ö_u∆ock
(&
tmp_∑
->
∑_lock
);

4383 
lg_¥óŒoc_cou¡
++;

4385 i‡(!
added
)

4386 
	`li°_add_èû_rcu
(&
∑
->
∑_öode_li°
,

4387 &
lg
->
lg_¥óŒoc_li°
[
‹dî
]);

4388 
	`•ö_u∆ock
(&
lg
->
lg_¥óŒoc_lock
);

4391 i‡(
lg_¥óŒoc_cou¡
 > 8) {

4392 
	`pxt4_mb_disˇrd_lg_¥óŒoˇti⁄s
(
sb
, 
lg
,

4393 
‹dî
, 
lg_¥óŒoc_cou¡
);

4397 
	}
}

4402 
	$pxt4_mb_ªÀa£_c⁄ãxt
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4404 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

4405 
pxt4_¥óŒoc_•a˚
 *
∑
 = 
ac
->
ac_∑
;

4406 i‡(
∑
) {

4407 i‡(
∑
->
∑_ty≥
 =
MB_GROUP_PA
) {

4409 
	`•ö_lock
(&
∑
->
∑_lock
);

4410 
∑
->
∑_p°¨t
 +
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

4411 
∑
->
∑_l°¨t
 +
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

4412 
∑
->
∑_‰ì
 -
ac
->
ac_b_ex
.
„_Àn
;

4413 
∑
->
∑_Àn
 -
ac
->
ac_b_ex
.
„_Àn
;

4414 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4417 i‡(
∑
) {

4424 i‡((
∑
->
∑_ty≥
 =
MB_GROUP_PA
Ë&& 
	`likñy
’a->
∑_‰ì
)) {

4425 
	`•ö_lock
(
∑
->
∑_obj_lock
);

4426 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

4427 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

4428 
	`pxt4_mb_add_n_åim
(
ac
);

4430 
	`pxt4_mb_put_∑
(
ac
,ác->
ac_sb
, 
∑
);

4432 i‡(
ac
->
ac_bôm≠_∑ge
)

4433 
	`put_∑ge
(
ac
->
ac_bôm≠_∑ge
);

4434 i‡(
ac
->
ac_buddy_∑ge
)

4435 
	`put_∑ge
(
ac
->
ac_buddy_∑ge
);

4436 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
)

4437 
	`muãx_u∆ock
(&
ac
->
ac_lg
->
lg_muãx
);

4438 
	`pxt4_mb_cﬁÀ˘_°©s
(
ac
);

4440 
	}
}

4442 
	$pxt4_mb_disˇrd_¥óŒoˇti⁄s
(
su≥r_block
 *
sb
, 
√eded
)

4444 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

4445 
ªt
;

4446 
‰ìd
 = 0;

4448 
	`åa˚_pxt4_mb_disˇrd_¥óŒoˇti⁄s
(
sb
, 
√eded
);

4449 
i
 = 0; i < 
ngroups
 && 
√eded
 > 0; i++) {

4450 
ªt
 = 
	`pxt4_mb_disˇrd_group_¥óŒoˇti⁄s
(
sb
, 
i
, 
√eded
);

4451 
‰ìd
 +
ªt
;

4452 
√eded
 -
ªt
;

4455  
‰ìd
;

4456 
	}
}

4463 
pxt4_fsblk_t
 
	$pxt4_mb_√w_blocks
(
h™dÀ_t
 *
h™dÀ
,

4464 
pxt4_Æloˇti⁄_ªque°
 *
¨
, *
îΩ
)

4466 
‰ìd
;

4467 
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
 = 
NULL
;

4468 
pxt4_sb_öfo
 *
sbi
;

4469 
su≥r_block
 *
sb
;

4470 
pxt4_fsblk_t
 
block
 = 0;

4471 
öquŸa
 = 0;

4472 
ª£rv_˛°rs
 = 0;

4474 
	`might_¶ìp
();

4475 
sb
 = 
¨
->
öode
->
i_sb
;

4476 
sbi
 = 
	`PXT4_SB
(
sb
);

4478 
	`åa˚_pxt4_ªque°_blocks
(
¨
);

4481 i‡(
	`pxt4_is_quŸa_fûe
(
¨
->
öode
))

4482 
¨
->
Êags
 |
PXT4_MB_USE_ROOT_BLOCKS
;

4484 i‡((
¨
->
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
) == 0) {

4489 
¨
->
Àn
 &&

4490 
	`pxt4_˛aim_‰ì_˛u°îs
(
sbi
, 
¨
->
Àn
,ár->
Êags
)) {

4493 
	`c⁄d_ªsched
();

4494 
¨
->
Àn
 =ár->len >> 1;

4496 i‡(!
¨
->
Àn
) {

4497 *
îΩ
 = -
ENOSPC
;

4500 
ª£rv_˛°rs
 = 
¨
->
Àn
;

4501 i‡(
¨
->
Êags
 & 
PXT4_MB_USE_ROOT_BLOCKS
) {

4502 
	`dquŸ_Æloc_block_noÁû
(
¨
->
öode
,

4503 
	`PXT4_C2B
(
sbi
, 
¨
->
Àn
));

4505 
¨
->
Àn
 &&

4506 
	`dquŸ_Æloc_block
(
¨
->
öode
,

4507 
	`PXT4_C2B
(
sbi
, 
¨
->
Àn
))) {

4509 
¨
->
Êags
 |
PXT4_MB_HINT_NOPREALLOC
;

4510 
¨
->
Àn
--;

4513 
öquŸa
 = 
¨
->
Àn
;

4514 i‡(
¨
->
Àn
 == 0) {

4515 *
îΩ
 = -
EDQUOT
;

4516 
out
;

4520 
ac
 = 
	`kmem_ˇche_zÆloc
(
pxt4_ac_ˇchï
, 
GFP_NOFS
);

4521 i‡(!
ac
) {

4522 
¨
->
Àn
 = 0;

4523 *
îΩ
 = -
ENOMEM
;

4524 
out
;

4527 *
îΩ
 = 
	`pxt4_mb_öôülize_c⁄ãxt
(
ac
, 
¨
);

4528 i‡(*
îΩ
) {

4529 
¨
->
Àn
 = 0;

4530 
out
;

4533 
ac
->
ac_›
 = 
PXT4_MB_HISTORY_PREALLOC
;

4534 i‡(!
	`pxt4_mb_u£_¥óŒoˇãd
(
ac
)) {

4535 
ac
->
ac_›
 = 
PXT4_MB_HISTORY_ALLOC
;

4536 
	`pxt4_mb_n‹mÆize_ªque°
(
ac
, 
¨
);

4537 
ª≥©
:

4539 *
îΩ
 = 
	`pxt4_mb_ªguœr_Æloˇt‹
(
ac
);

4540 i‡(*
îΩ
)

4541 
disˇrd_™d_exô
;

4546 i‡(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
 &&

4547 
ac
->
ac_o_ex
.
„_Àn
 <ác->
ac_b_ex
.fe_len)

4548 *
îΩ
 = 
	`pxt4_mb_√w_¥óŒoˇti⁄
(
ac
);

4549 i‡(*
îΩ
) {

4550 
disˇrd_™d_exô
:

4551 
	`pxt4_disˇrd_Æloˇãd_blocks
(
ac
);

4552 
îrout
;

4555 i‡(
	`likñy
(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
)) {

4556 *
îΩ
 = 
	`pxt4_mb_m¨k_disk•a˚_u£d
(
ac
, 
h™dÀ
, 
ª£rv_˛°rs
);

4557 i‡(*
îΩ
) {

4558 
	`pxt4_disˇrd_Æloˇãd_blocks
(
ac
);

4559 
îrout
;

4561 
block
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

4562 
¨
->
Àn
 = 
ac
->
ac_b_ex
.
„_Àn
;

4565 
‰ìd
 = 
	`pxt4_mb_disˇrd_¥óŒoˇti⁄s
(
sb
, 
ac
->
ac_o_ex
.
„_Àn
);

4566 i‡(
‰ìd
)

4567 
ª≥©
;

4568 *
îΩ
 = -
ENOSPC
;

4571 
îrout
:

4572 i‡(*
îΩ
) {

4573 
ac
->
ac_b_ex
.
„_Àn
 = 0;

4574 
¨
->
Àn
 = 0;

4575 
	`pxt4_mb_show_ac
(
ac
);

4577 
	`pxt4_mb_ªÀa£_c⁄ãxt
(
ac
);

4578 
out
:

4579 i‡(
ac
)

4580 
	`kmem_ˇche_‰ì
(
pxt4_ac_ˇchï
, 
ac
);

4581 i‡(
öquŸa
 && 
¨
->
Àn
 < inquota)

4582 
	`dquŸ_‰ì_block
(
¨
->
öode
, 
	`PXT4_C2B
(
sbi
, 
öquŸa
 -ár->
Àn
));

4583 i‡(!
¨
->
Àn
) {

4584 i‡((
¨
->
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
) == 0)

4586 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
,

4587 
ª£rv_˛°rs
);

4590 
	`åa˚_pxt4_Æloˇã_blocks
(
¨
, ()
block
);

4592  
block
;

4593 
	}
}

4600 
	$pxt4_åy_mîge_‰ìd_exã¡
(
pxt4_sb_öfo
 *
sbi
,

4601 
pxt4_‰ì_d©a
 *
íåy
,

4602 
pxt4_‰ì_d©a
 *
√w_íåy
,

4603 
rb_roŸ
 *
íåy_rb_roŸ
)

4605 i‡((
íåy
->
efd_tid
 !
√w_íåy
->efd_tid) ||

4606 (
íåy
->
efd_group
 !
√w_íåy
->efd_group))

4608 i‡(
íåy
->
efd_°¨t_˛u°î
 +É¡ry->
efd_cou¡
 ==

4609 
√w_íåy
->
efd_°¨t_˛u°î
) {

4610 
√w_íåy
->
efd_°¨t_˛u°î
 = 
íåy
->efd_start_cluster;

4611 
√w_íåy
->
efd_cou¡
 +
íåy
->efd_count;

4612 } i‡(
√w_íåy
->
efd_°¨t_˛u°î
 +Çew_íåy->
efd_cou¡
 ==

4613 
íåy
->
efd_°¨t_˛u°î
) {

4614 
√w_íåy
->
efd_cou¡
 +
íåy
->efd_count;

4617 
	`•ö_lock
(&
sbi
->
s_md_lock
);

4618 
	`li°_dñ
(&
íåy
->
efd_li°
);

4619 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

4620 
	`rb_îa£
(&
íåy
->
efd_node
, 
íåy_rb_roŸ
);

4621 
	`kmem_ˇche_‰ì
(
pxt4_‰ì_d©a_ˇchï
, 
íåy
);

4622 
	}
}

4624 
noölöe_f‹_°ack
 

4625 
	$pxt4_mb_‰ì_mëad©a
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_buddy
 *
e4b
,

4626 
pxt4_‰ì_d©a
 *
√w_íåy
)

4628 
pxt4_group_t
 
group
 = 
e4b
->
bd_group
;

4629 
pxt4_gΩblk_t
 
˛u°î
;

4630 
pxt4_gΩblk_t
 
˛u°îs
 = 
√w_íåy
->
efd_cou¡
;

4631 
pxt4_‰ì_d©a
 *
íåy
;

4632 
pxt4_group_öfo
 *
db
 = 
e4b
->
bd_öfo
;

4633 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

4634 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4635 
rb_node
 **
n
 = &
db
->
bb_‰ì_roŸ
.rb_node, *
node
;

4636 
rb_node
 *
∑ª¡
 = 
NULL
, *
√w_node
;

4638 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

4639 
	`BUG_ON
(
e4b
->
bd_bôm≠_∑ge
 =
NULL
);

4640 
	`BUG_ON
(
e4b
->
bd_buddy_∑ge
 =
NULL
);

4642 
√w_node
 = &
√w_íåy
->
efd_node
;

4643 
˛u°î
 = 
√w_íåy
->
efd_°¨t_˛u°î
;

4645 i‡(!*
n
) {

4651 
	`gë_∑ge
(
e4b
->
bd_buddy_∑ge
);

4652 
	`gë_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

4654 *
n
) {

4655 
∑ª¡
 = *
n
;

4656 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
pxt4_‰ì_d©a
, 
efd_node
);

4657 i‡(
˛u°î
 < 
íåy
->
efd_°¨t_˛u°î
)

4658 
n
 = &(*n)->
rb_À·
;

4659 i‡(
˛u°î
 >(
íåy
->
efd_°¨t_˛u°î
 +É¡ry->
efd_cou¡
))

4660 
n
 = &(*n)->
rb_right
;

4662 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
group
, 0,

4663 
	`pxt4_group_fú°_block_no
(
sb
, 
group
) +

4664 
	`PXT4_C2B
(
sbi
, 
˛u°î
),

4670 
	`rb_lök_node
(
√w_node
, 
∑ª¡
, 
n
);

4671 
	`rb_ö£π_cﬁ‹
(
√w_node
, &
db
->
bb_‰ì_roŸ
);

4674 
node
 = 
	`rb_¥ev
(
√w_node
);

4675 i‡(
node
) {

4676 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_‰ì_d©a
, 
efd_node
);

4677 
	`pxt4_åy_mîge_‰ìd_exã¡
(
sbi
, 
íåy
, 
√w_íåy
,

4678 &(
db
->
bb_‰ì_roŸ
));

4681 
node
 = 
	`rb_√xt
(
√w_node
);

4682 i‡(
node
) {

4683 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_‰ì_d©a
, 
efd_node
);

4684 
	`pxt4_åy_mîge_‰ìd_exã¡
(
sbi
, 
íåy
, 
√w_íåy
,

4685 &(
db
->
bb_‰ì_roŸ
));

4688 
	`•ö_lock
(&
sbi
->
s_md_lock
);

4689 
	`li°_add_èû
(&
√w_íåy
->
efd_li°
, &
sbi
->
s_‰ìd_d©a_li°
);

4690 
sbi
->
s_mb_‰ì_≥ndög
 +
˛u°îs
;

4691 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

4693 
	}
}

4704 
	$pxt4_‰ì_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4705 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
block
,

4706 
cou¡
, 
Êags
)

4708 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

4709 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4710 
pxt4_group_desc
 *
gdp
;

4711 
ovîÊow
;

4712 
pxt4_gΩblk_t
 
bô
;

4713 
buf„r_hód
 *
gd_bh
;

4714 
pxt4_group_t
 
block_group
;

4715 
pxt4_sb_öfo
 *
sbi
;

4716 
pxt4_buddy
 
e4b
;

4717 
cou¡_˛u°îs
;

4718 
îr
 = 0;

4719 
ªt
;

4721 
	`might_¶ìp
();

4722 i‡(
bh
) {

4723 i‡(
block
)

4724 
	`BUG_ON
(
block
 !
bh
->
b_blockƒ
);

4726 
block
 = 
bh
->
b_blockƒ
;

4729 
sbi
 = 
	`PXT4_SB
(
sb
);

4730 i‡(!(
Êags
 & 
PXT4_FREE_BLOCKS_VALIDATED
) &&

4731 !
	`pxt4_d©a_block_vÆid
(
sbi
, 
block
, 
cou¡
)) {

4732 
	`pxt4_îr‹
(
sb
, "Freeing blocksÇot in datazone - "

4733 "block = %Œu, cou¡ = %lu", 
block
, 
cou¡
);

4734 
îr‹_ªtu∫
;

4737 
	`pxt4_debug
("‰ìög block %Œu\n", 
block
);

4738 
	`åa˚_pxt4_‰ì_blocks
(
öode
, 
block
, 
cou¡
, 
Êags
);

4740 i‡(
bh
 && (
Êags
 & 
PXT4_FREE_BLOCKS_FORGET
)) {

4741 
	`BUG_ON
(
cou¡
 > 1);

4743 
	`pxt4_f‹gë
(
h™dÀ
, 
Êags
 & 
PXT4_FREE_BLOCKS_METADATA
,

4744 
öode
, 
bh
, 
block
);

4754 
ovîÊow
 = 
	`PXT4_PBLK_COFF
(
sbi
, 
block
);

4755 i‡(
ovîÊow
) {

4756 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
) {

4757 
ovîÊow
 = 
sbi
->
s_˛u°î_øtio
 - overflow;

4758 
block
 +
ovîÊow
;

4759 i‡(
cou¡
 > 
ovîÊow
)

4760 
cou¡
 -
ovîÊow
;

4764 
block
 -
ovîÊow
;

4765 
cou¡
 +
ovîÊow
;

4768 
ovîÊow
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
cou¡
);

4769 i‡(
ovîÊow
) {

4770 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
) {

4771 i‡(
cou¡
 > 
ovîÊow
)

4772 
cou¡
 -
ovîÊow
;

4776 
cou¡
 +
sbi
->
s_˛u°î_øtio
 - 
ovîÊow
;

4779 i‡(!
bh
 && (
Êags
 & 
PXT4_FREE_BLOCKS_FORGET
)) {

4780 
i
;

4781 
is_mëad©a
 = 
Êags
 & 
PXT4_FREE_BLOCKS_METADATA
;

4783 
i
 = 0; i < 
cou¡
; i++) {

4784 
	`c⁄d_ªsched
();

4785 i‡(
is_mëad©a
)

4786 
bh
 = 
	`sb_föd_gë_block
(
öode
->
i_sb
, 
block
 + 
i
);

4787 
	`pxt4_f‹gë
(
h™dÀ
, 
is_mëad©a
, 
öode
, 
bh
, 
block
 + 
i
);

4791 
do_m‹e
:

4792 
ovîÊow
 = 0;

4793 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
block
, &
block_group
, &
bô
);

4795 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(

4796 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
))))

4803 i‡(
	`PXT4_C2B
(
sbi
, 
bô
Ë+ 
cou¡
 > 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)) {

4804 
ovîÊow
 = 
	`PXT4_C2B
(
sbi
, 
bô
Ë+ 
cou¡
 -

4805 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

4806 
cou¡
 -
ovîÊow
;

4808 
cou¡_˛u°îs
 = 
	`PXT4_NUM_B2C
(
sbi
, 
cou¡
);

4809 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
block_group
);

4810 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

4811 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

4812 
bôm≠_bh
 = 
NULL
;

4813 
îr‹_ªtu∫
;

4815 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, &
gd_bh
);

4816 i‡(!
gdp
) {

4817 
îr
 = -
EIO
;

4818 
îr‹_ªtu∫
;

4821 i‡(
	`ö_ønge
(
	`pxt4_block_bôm≠
(
sb
, 
gdp
), 
block
, 
cou¡
) ||

4822 
	`ö_ønge
(
	`pxt4_öode_bôm≠
(
sb
, 
gdp
), 
block
, 
cou¡
) ||

4823 
	`ö_ønge
(
block
, 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

4824 
sbi
->
s_ôb_≥r_group
) ||

4825 
	`ö_ønge
(
block
 + 
cou¡
 - 1, 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

4826 
sbi
->
s_ôb_≥r_group
)) {

4828 
	`pxt4_îr‹
(
sb
, "Freeing blocks in system zone - "

4829 "Block = %Œu, cou¡ = %lu", 
block
, 
cou¡
);

4831 
îr‹_ªtu∫
;

4834 
	`BUFFER_TRACE
(
bôm≠_bh
, "getting writeáccess");

4835 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

4836 i‡(
îr
)

4837 
îr‹_ªtu∫
;

4844 
	`BUFFER_TRACE
(
gd_bh
, "get_write_access");

4845 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gd_bh
);

4846 i‡(
îr
)

4847 
îr‹_ªtu∫
;

4848 #ifde‡
AGGRESSIVE_CHECK


4850 
i
;

4851 
i
 = 0; i < 
cou¡_˛u°îs
; i++)

4852 
	`BUG_ON
(!
	`mb_ã°_bô
(
bô
 + 
i
, 
bôm≠_bh
->
b_d©a
));

4855 
	`åa˚_pxt4_mbÆloc_‰ì
(
sb
, 
öode
, 
block_group
, 
bô
, 
cou¡_˛u°îs
);

4858 
îr
 = 
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
block_group
, &
e4b
,

4859 
GFP_NOFS
|
__GFP_NOFAIL
);

4860 i‡(
îr
)

4861 
îr‹_ªtu∫
;

4869 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
) &&

4870 ((
Êags
 & 
PXT4_FREE_BLOCKS_METADATA
) ||

4871 !
	`pxt4_should_wrôeback_d©a
(
öode
))) {

4872 
pxt4_‰ì_d©a
 *
√w_íåy
;

4877 
√w_íåy
 = 
	`kmem_ˇche_Æloc
(
pxt4_‰ì_d©a_ˇchï
,

4878 
GFP_NOFS
|
__GFP_NOFAIL
);

4879 
√w_íåy
->
efd_°¨t_˛u°î
 = 
bô
;

4880 
√w_íåy
->
efd_group
 = 
block_group
;

4881 
√w_íåy
->
efd_cou¡
 = 
cou¡_˛u°îs
;

4882 
√w_íåy
->
efd_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

4884 
	`pxt4_lock_group
(
sb
, 
block_group
);

4885 
	`mb_˛ór_bôs
(
bôm≠_bh
->
b_d©a
, 
bô
, 
cou¡_˛u°îs
);

4886 
	`pxt4_mb_‰ì_mëad©a
(
h™dÀ
, &
e4b
, 
√w_íåy
);

4892 i‡(
	`ã°_›t
(
sb
, 
DISCARD
)) {

4893 
îr
 = 
	`pxt4_issue_disˇrd
(
sb
, 
block_group
, 
bô
, 
cou¡
,

4894 
NULL
);

4895 i‡(
îr
 &&Éº !-
EOPNOTSUPP
)

4896 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "discardÑequest in"

4898 " wôh %d", 
block_group
, 
bô
, 
cou¡
,

4899 
îr
);

4901 
	`PXT4_MB_GRP_CLEAR_TRIMMED
(
e4b
.
bd_öfo
);

4903 
	`pxt4_lock_group
(
sb
, 
block_group
);

4904 
	`mb_˛ór_bôs
(
bôm≠_bh
->
b_d©a
, 
bô
, 
cou¡_˛u°îs
);

4905 
	`mb_‰ì_blocks
(
öode
, &
e4b
, 
bô
, 
cou¡_˛u°îs
);

4908 
ªt
 = 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
Ë+ 
cou¡_˛u°îs
;

4909 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
, 
ªt
);

4910 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
block_group
, 
gdp
, 
bôm≠_bh
);

4911 
	`pxt4_group_desc_csum_£t
(
sb
, 
block_group
, 
gdp
);

4912 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

4914 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

4915 
pxt4_group_t
 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
block_group
);

4916 
	`©omic64_add
(
cou¡_˛u°îs
,

4917 &
sbi
->
s_Êex_groups
[
Êex_group
].
‰ì_˛u°îs
);

4925 i‡(!(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)) {

4926 i‡(!(
Êags
 & 
PXT4_FREE_BLOCKS_NO_QUOT_UPDATE
))

4927 
	`dquŸ_‰ì_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
cou¡_˛u°îs
));

4928 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

4929 
cou¡_˛u°îs
);

4932 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4935 
	`BUFFER_TRACE
(
bôm≠_bh
, "dirtied bitmap block");

4936 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

4939 
	`BUFFER_TRACE
(
gd_bh
, "dirtied group descriptor block");

4940 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gd_bh
);

4941 i‡(!
îr
)

4942 
îr
 = 
ªt
;

4944 i‡(
ovîÊow
 && !
îr
) {

4945 
block
 +
cou¡
;

4946 
cou¡
 = 
ovîÊow
;

4947 
	`put_bh
(
bôm≠_bh
);

4948 
do_m‹e
;

4950 
îr‹_ªtu∫
:

4951 
	`bªl£
(
bôm≠_bh
);

4952 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

4954 
	}
}

4965 
	$pxt4_group_add_blocks
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

4966 
pxt4_fsblk_t
 
block
, 
cou¡
)

4968 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

4969 
buf„r_hód
 *
gd_bh
;

4970 
pxt4_group_t
 
block_group
;

4971 
pxt4_gΩblk_t
 
bô
;

4972 
i
;

4973 
pxt4_group_desc
 *
desc
;

4974 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4975 
pxt4_buddy
 
e4b
;

4976 
îr
 = 0, 
ªt
, 
‰ì_˛u°îs_cou¡
;

4977 
pxt4_gΩblk_t
 
˛u°îs_‰ìd
;

4978 
pxt4_fsblk_t
 
fú°_˛u°î
 = 
	`PXT4_B2C
(
sbi
, 
block
);

4979 
pxt4_fsblk_t
 
œ°_˛u°î
 = 
	`PXT4_B2C
(
sbi
, 
block
 + 
cou¡
 - 1);

4980 
˛u°î_cou¡
 = 
œ°_˛u°î
 - 
fú°_˛u°î
 + 1;

4982 
	`pxt4_debug
("Addög block(sË%Œu-%Œu\n", 
block
, block + 
cou¡
 - 1);

4984 i‡(
cou¡
 == 0)

4987 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
block
, &
block_group
, &
bô
);

4992 i‡(
bô
 + 
˛u°î_cou¡
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)) {

4993 
	`pxt4_w¨nög
(
sb
, "too many blocksáddedÅo group %u",

4994 
block_group
);

4995 
îr
 = -
EINVAL
;

4996 
îr‹_ªtu∫
;

4999 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
block_group
);

5000 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

5001 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

5002 
bôm≠_bh
 = 
NULL
;

5003 
îr‹_ªtu∫
;

5006 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, &
gd_bh
);

5007 i‡(!
desc
) {

5008 
îr
 = -
EIO
;

5009 
îr‹_ªtu∫
;

5012 i‡(
	`ö_ønge
(
	`pxt4_block_bôm≠
(
sb
, 
desc
), 
block
, 
cou¡
) ||

5013 
	`ö_ønge
(
	`pxt4_öode_bôm≠
(
sb
, 
desc
), 
block
, 
cou¡
) ||

5014 
	`ö_ønge
(
block
, 
	`pxt4_öode_èbÀ
(
sb
, 
desc
), 
sbi
->
s_ôb_≥r_group
) ||

5015 
	`ö_ønge
(
block
 + 
cou¡
 - 1, 
	`pxt4_öode_èbÀ
(
sb
, 
desc
),

5016 
sbi
->
s_ôb_≥r_group
)) {

5017 
	`pxt4_îr‹
(
sb
, "Adding blocks in system zones - "

5019 
block
, 
cou¡
);

5020 
îr
 = -
EINVAL
;

5021 
îr‹_ªtu∫
;

5024 
	`BUFFER_TRACE
(
bôm≠_bh
, "getting writeáccess");

5025 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

5026 i‡(
îr
)

5027 
îr‹_ªtu∫
;

5034 
	`BUFFER_TRACE
(
gd_bh
, "get_write_access");

5035 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gd_bh
);

5036 i‡(
îr
)

5037 
îr‹_ªtu∫
;

5039 
i
 = 0, 
˛u°îs_‰ìd
 = 0; i < 
˛u°î_cou¡
; i++) {

5040 
	`BUFFER_TRACE
(
bôm≠_bh
, "clear bit");

5041 i‡(!
	`mb_ã°_bô
(
bô
 + 
i
, 
bôm≠_bh
->
b_d©a
)) {

5042 
	`pxt4_îr‹
(
sb
, "bitálready cleared for block %llu",

5043 (
pxt4_fsblk_t
)(
block
 + 
i
));

5044 
	`BUFFER_TRACE
(
bôm≠_bh
, "bitálready cleared");

5046 
˛u°îs_‰ìd
++;

5050 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
block_group
, &
e4b
);

5051 i‡(
îr
)

5052 
îr‹_ªtu∫
;

5059 
	`pxt4_lock_group
(
sb
, 
block_group
);

5060 
	`mb_˛ór_bôs
(
bôm≠_bh
->
b_d©a
, 
bô
, 
˛u°î_cou¡
);

5061 
	`mb_‰ì_blocks
(
NULL
, &
e4b
, 
bô
, 
˛u°î_cou¡
);

5062 
‰ì_˛u°îs_cou¡
 = 
˛u°îs_‰ìd
 +

5063 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
);

5064 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
desc
, 
‰ì_˛u°îs_cou¡
);

5065 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
block_group
, 
desc
, 
bôm≠_bh
);

5066 
	`pxt4_group_desc_csum_£t
(
sb
, 
block_group
, 
desc
);

5067 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

5068 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

5069 
˛u°îs_‰ìd
);

5071 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

5072 
pxt4_group_t
 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
block_group
);

5073 
	`©omic64_add
(
˛u°îs_‰ìd
,

5074 &
sbi
->
s_Êex_groups
[
Êex_group
].
‰ì_˛u°îs
);

5077 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

5080 
	`BUFFER_TRACE
(
bôm≠_bh
, "dirtied bitmap block");

5081 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

5084 
	`BUFFER_TRACE
(
gd_bh
, "dirtied group descriptor block");

5085 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gd_bh
);

5086 i‡(!
îr
)

5087 
îr
 = 
ªt
;

5089 
îr‹_ªtu∫
:

5090 
	`bªl£
(
bôm≠_bh
);

5091 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

5092  
îr
;

5093 
	}
}

5107 
	$pxt4_åim_exã¡
(
su≥r_block
 *
sb
, 
°¨t
, 
cou¡
,

5108 
pxt4_group_t
 
group
, 
pxt4_buddy
 *
e4b
)

5109 
	$__ªÀa£s
(
bôlock
)

5110 
	$__acquúes
(
bôlock
)

5112 
pxt4_‰ì_exã¡
 
ex
;

5113 
ªt
 = 0;

5115 
	`åa˚_pxt4_åim_exã¡
(
sb
, 
group
, 
°¨t
, 
cou¡
);

5117 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
sb
, 
group
));

5119 
ex
.
„_°¨t
 = 
°¨t
;

5120 
ex
.
„_group
 = 
group
;

5121 
ex
.
„_Àn
 = 
cou¡
;

5127 
	`mb_m¨k_u£d
(
e4b
, &
ex
);

5128 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5129 
ªt
 = 
	`pxt4_issue_disˇrd
(
sb
, 
group
, 
°¨t
, 
cou¡
, 
NULL
);

5130 
	`pxt4_lock_group
(
sb
, 
group
);

5131 
	`mb_‰ì_blocks
(
NULL
, 
e4b
, 
°¨t
, 
ex
.
„_Àn
);

5132  
ªt
;

5133 
	}
}

5153 
pxt4_gΩblk_t


5154 
	$pxt4_åim_Æl_‰ì
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

5155 
pxt4_gΩblk_t
 
°¨t
,Öxt4_gΩblk_à
max
,

5156 
pxt4_gΩblk_t
 
möblocks
)

5158 *
bôm≠
;

5159 
pxt4_gΩblk_t
 
√xt
, 
cou¡
 = 0, 
‰ì_cou¡
 = 0;

5160 
pxt4_buddy
 
e4b
;

5161 
ªt
 = 0;

5163 
	`åa˚_pxt4_åim_Æl_‰ì
(
sb
, 
group
, 
°¨t
, 
max
);

5165 
ªt
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

5166 i‡(
ªt
) {

5167 
	`pxt4_w¨nög
(
sb
, "Error %dÜoading buddy information for %u",

5168 
ªt
, 
group
);

5169  
ªt
;

5171 
bôm≠
 = 
e4b
.
bd_bôm≠
;

5173 
	`pxt4_lock_group
(
sb
, 
group
);

5174 i‡(
	`PXT4_MB_GRP_WAS_TRIMMED
(
e4b
.
bd_öfo
) &&

5175 
möblocks
 >
	`©omic_ªad
(&
	`PXT4_SB
(
sb
)->
s_œ°_åim_möblks
))

5176 
out
;

5178 
°¨t
 = (
e4b
.
bd_öfo
->
bb_fú°_‰ì
 > start) ?

5179 
e4b
.
bd_öfo
->
bb_fú°_‰ì
 : 
°¨t
;

5181 
°¨t
 <
max
) {

5182 
°¨t
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
max
 + 1, start);

5183 i‡(
°¨t
 > 
max
)

5185 
√xt
 = 
	`mb_föd_√xt_bô
(
bôm≠
, 
max
 + 1, 
°¨t
);

5187 i‡((
√xt
 - 
°¨t
Ë>
möblocks
) {

5188 
ªt
 = 
	`pxt4_åim_exã¡
(
sb
, 
°¨t
,

5189 
√xt
 - 
°¨t
, 
group
, &
e4b
);

5190 i‡(
ªt
 &&Ñë !-
EOPNOTSUPP
)

5192 
ªt
 = 0;

5193 
cou¡
 +
√xt
 - 
°¨t
;

5195 
‰ì_cou¡
 +
√xt
 - 
°¨t
;

5196 
°¨t
 = 
√xt
 + 1;

5198 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

5199 
cou¡
 = -
ERESTARTSYS
;

5203 i‡(
	`√ed_ªsched
()) {

5204 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5205 
	`c⁄d_ªsched
();

5206 
	`pxt4_lock_group
(
sb
, 
group
);

5209 i‡((
e4b
.
bd_öfo
->
bb_‰ì
 - 
‰ì_cou¡
Ë< 
möblocks
)

5213 i‡(!
ªt
) {

5214 
ªt
 = 
cou¡
;

5215 
	`PXT4_MB_GRP_SET_TRIMMED
(
e4b
.
bd_öfo
);

5217 
out
:

5218 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5219 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

5221 
	`pxt4_debug
("trimmed %d blocks inÅhe group %d\n",

5222 
cou¡
, 
group
);

5224  
ªt
;

5225 
	}
}

5239 
	$pxt4_åim_fs
(
su≥r_block
 *
sb
, 
f°rim_ønge
 *
ønge
)

5241 
pxt4_group_öfo
 *
gΩ
;

5242 
pxt4_group_t
 
group
, 
fú°_group
, 
œ°_group
;

5243 
pxt4_gΩblk_t
 
˙t
 = 0, 
fú°_˛u°î
, 
œ°_˛u°î
;

5244 
uöt64_t
 
°¨t
, 
íd
, 
möÀn
, 
åimmed
 = 0;

5245 
pxt4_fsblk_t
 
fú°_d©a_blk
 =

5246 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
);

5247 
pxt4_fsblk_t
 
max_blks
 = 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
sb
)->
s_es
);

5248 
ªt
 = 0;

5250 
°¨t
 = 
ønge
->°¨à>> 
sb
->
s_blocksize_bôs
;

5251 
íd
 = 
°¨t
 + (
ønge
->
Àn
 >> 
sb
->
s_blocksize_bôs
) - 1;

5252 
möÀn
 = 
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
),

5253 
ønge
->
möÀn
 >> 
sb
->
s_blocksize_bôs
);

5255 i‡(
möÀn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) ||

5256 
°¨t
 >
max_blks
 ||

5257 
ønge
->
Àn
 < 
sb
->
s_blocksize
)

5258  -
EINVAL
;

5259 i‡(
íd
 >
max_blks
)

5260 
íd
 = 
max_blks
 - 1;

5261 i‡(
íd
 <
fú°_d©a_blk
)

5262 
out
;

5263 i‡(
°¨t
 < 
fú°_d©a_blk
)

5264 
°¨t
 = 
fú°_d©a_blk
;

5267 
	`pxt4_gë_group_no_™d_off£t
(
sb
, (
pxt4_fsblk_t
Ë
°¨t
,

5268 &
fú°_group
, &
fú°_˛u°î
);

5269 
	`pxt4_gë_group_no_™d_off£t
(
sb
, (
pxt4_fsblk_t
Ë
íd
,

5270 &
œ°_group
, &
œ°_˛u°î
);

5273 
íd
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) - 1;

5275 
group
 = 
fú°_group
; grou∞<
œ°_group
; group++) {

5276 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

5278 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gΩ
))) {

5279 
ªt
 = 
	`pxt4_mb_öô_group
(
sb
, 
group
, 
GFP_NOFS
);

5280 i‡(
ªt
)

5290 i‡(
group
 =
œ°_group
)

5291 
íd
 = 
œ°_˛u°î
;

5293 i‡(
gΩ
->
bb_‰ì
 >
möÀn
) {

5294 
˙t
 = 
	`pxt4_åim_Æl_‰ì
(
sb
, 
group
, 
fú°_˛u°î
,

5295 
íd
, 
möÀn
);

5296 i‡(
˙t
 < 0) {

5297 
ªt
 = 
˙t
;

5300 
åimmed
 +
˙t
;

5307 
fú°_˛u°î
 = 0;

5310 i‡(!
ªt
)

5311 
	`©omic_£t
(&
	`PXT4_SB
(
sb
)->
s_œ°_åim_möblks
, 
möÀn
);

5313 
out
:

5314 
ønge
->
Àn
 = 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
åimmed
Ë<< sb->
s_blocksize_bôs
;

5315  
ªt
;

5316 
	}
}

5320 
	$pxt4_mbÆloc_quîy_ønge
(

5321 
su≥r_block
 *
sb
,

5322 
pxt4_group_t
 
group
,

5323 
pxt4_gΩblk_t
 
°¨t
,

5324 
pxt4_gΩblk_t
 
íd
,

5325 
pxt4_mbÆloc_quîy_ønge_‚
 
f‹m©ãr
,

5326 *
¥iv
)

5328 *
bôm≠
;

5329 
pxt4_gΩblk_t
 
√xt
;

5330 
pxt4_buddy
 
e4b
;

5331 
îr‹
;

5333 
îr‹
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

5334 i‡(
îr‹
)

5335  
îr‹
;

5336 
bôm≠
 = 
e4b
.
bd_bôm≠
;

5338 
	`pxt4_lock_group
(
sb
, 
group
);

5340 
°¨t
 = (
e4b
.
bd_öfo
->
bb_fú°_‰ì
 > start) ?

5341 
e4b
.
bd_öfo
->
bb_fú°_‰ì
 : 
°¨t
;

5342 i‡(
íd
 >
	`PXT4_CLUSTERS_PER_GROUP
(
sb
))

5343 
íd
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) - 1;

5345 
°¨t
 <
íd
) {

5346 
°¨t
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
íd
 + 1, start);

5347 i‡(
°¨t
 > 
íd
)

5349 
√xt
 = 
	`mb_föd_√xt_bô
(
bôm≠
, 
íd
 + 1, 
°¨t
);

5351 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5352 
îr‹
 = 
	`f‹m©ãr
(
sb
, 
group
, 
°¨t
, 
√xt
 - sèπ, 
¥iv
);

5353 i‡(
îr‹
)

5354 
out_u∆ﬂd
;

5355 
	`pxt4_lock_group
(
sb
, 
group
);

5357 
°¨t
 = 
√xt
 + 1;

5360 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5361 
out_u∆ﬂd
:

5362 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

5364  
îr‹
;

5365 
	}
}

	@mballoc.h

8 #i‚de‡
_PXT4_MBALLOC_H


9 
	#_PXT4_MBALLOC_H


	)

11 
	~<löux/time.h
>

12 
	~<löux/fs.h
>

13 
	~<löux/«mei.h
>

14 
	~<löux/quŸa›s.h
>

15 
	~<löux/buf„r_hód.h
>

16 
	~<löux/moduÀ.h
>

17 
	~<löux/sw≠.h
>

18 
	~<löux/¥oc_fs.h
>

19 
	~<löux/∑gem≠.h
>

20 
	~<löux/£q_fûe.h
>

21 
	~<löux/blkdev.h
>

22 
	~<löux/muãx.h
>

23 
	~"pxt4_jbd3.h
"

24 
	~"pxt4.h
"

28 #ifde‡
CONFIG_PXT4_DEBUG


29 
ush‹t
 
pxt4_mbÆloc_debug
;

31 
	#mb_debug
(
n
, 
fmt
, ...) \

33 i‡((
n
Ë<
pxt4_mbÆloc_debug
) { \

34 
	`¥ötk
(
KERN_DEBUG
 "(%s, %d): %s: " 
fmt
, \

35 
__FILE__
, 
__LINE__
, 
__func__
, ##
__VA_ARGS__
); \

37 } 0)

	)

39 
	#mb_debug
(
n
, 
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

42 
	#PXT4_MB_HISTORY_ALLOC
 1

	)

43 
	#PXT4_MB_HISTORY_PREALLOC
 2

	)

48 
	#MB_DEFAULT_MAX_TO_SCAN
 200

	)

53 
	#MB_DEFAULT_MIN_TO_SCAN
 10

	)

59 
	#MB_DEFAULT_STATS
 0

	)

68 
	#MB_DEFAULT_STREAM_THRESHOLD
 16

	)

73 
	#MB_DEFAULT_ORDER2_REQS
 2

	)

78 
	#MB_DEFAULT_GROUP_PREALLOC
 512

	)

81 
	spxt4_‰ì_d©a
 {

83 
li°_hód
 
	mefd_li°
;

86 
rb_node
 
	mefd_node
;

89 
pxt4_group_t
 
	mefd_group
;

92 
pxt4_gΩblk_t
 
	mefd_°¨t_˛u°î
;

93 
pxt4_gΩblk_t
 
	mefd_cou¡
;

96 
tid_t
 
	mefd_tid
;

99 
	spxt4_¥óŒoc_•a˚
 {

100 
li°_hód
 
	m∑_öode_li°
;

101 
li°_hód
 
	m∑_group_li°
;

103 
li°_hód
 
	m∑_tmp_li°
;

104 
rcu_hód
 
	m∑_rcu
;

105 } 
	mu
;

106 
•ölock_t
 
	m∑_lock
;

107 
©omic_t
 
	m∑_cou¡
;

108 
	m∑_dñëed
;

109 
pxt4_fsblk_t
 
	m∑_p°¨t
;

110 
pxt4_lblk_t
 
	m∑_l°¨t
;

111 
pxt4_gΩblk_t
 
	m∑_Àn
;

112 
pxt4_gΩblk_t
 
	m∑_‰ì
;

113 
	m∑_ty≥
;

114 
•ölock_t
 *
	m∑_obj_lock
;

115 
öode
 *
	m∑_öode
;

119 
	mMB_INODE_PA
 = 0,

120 
	mMB_GROUP_PA
 = 1

123 
	spxt4_‰ì_exã¡
 {

124 
pxt4_lblk_t
 
	m„_logiˇl
;

125 
pxt4_gΩblk_t
 
	m„_°¨t
;

126 
pxt4_group_t
 
	m„_group
;

127 
pxt4_gΩblk_t
 
	m„_Àn
;

138 
	#PREALLOC_TB_SIZE
 10

	)

139 
	spxt4_loˇlôy_group
 {

142 
muãx
 
	mlg_muãx
;

144 
li°_hód
 
	mlg_¥óŒoc_li°
[
PREALLOC_TB_SIZE
];

145 
•ölock_t
 
	mlg_¥óŒoc_lock
;

148 
	spxt4_Æloˇti⁄_c⁄ãxt
 {

149 
öode
 *
	mac_öode
;

150 
su≥r_block
 *
	mac_sb
;

153 
pxt4_‰ì_exã¡
 
	mac_o_ex
;

156 
pxt4_‰ì_exã¡
 
	mac_g_ex
;

159 
pxt4_‰ì_exã¡
 
	mac_b_ex
;

162 
pxt4_‰ì_exã¡
 
	mac_f_ex
;

164 
__u16
 
	mac_groups_sˇ¬ed
;

165 
__u16
 
	mac_found
;

166 
__u16
 
	mac_èû
;

167 
__u16
 
	mac_buddy
;

168 
__u16
 
	mac_Êags
;

169 
__u8
 
	mac_°©us
;

170 
__u8
 
	mac_¸ôîü
;

171 
__u8
 
	mac_2‹dî
;

173 
__u8
 
	mac_›
;

174 
∑ge
 *
	mac_bôm≠_∑ge
;

175 
∑ge
 *
	mac_buddy_∑ge
;

176 
pxt4_¥óŒoc_•a˚
 *
	mac_∑
;

177 
pxt4_loˇlôy_group
 *
	mac_lg
;

180 
	#AC_STATUS_CONTINUE
 1

	)

181 
	#AC_STATUS_FOUND
 2

	)

182 
	#AC_STATUS_BREAK
 3

	)

184 
	spxt4_buddy
 {

185 
∑ge
 *
	mbd_buddy_∑ge
;

186 *
	mbd_buddy
;

187 
∑ge
 *
	mbd_bôm≠_∑ge
;

188 *
	mbd_bôm≠
;

189 
pxt4_group_öfo
 *
	mbd_öfo
;

190 
su≥r_block
 *
	mbd_sb
;

191 
__u16
 
	mbd_blkbôs
;

192 
pxt4_group_t
 
	mbd_group
;

195 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_gΩ_offs_to_block
(
su≥r_block
 *
sb
,

196 
pxt4_‰ì_exã¡
 *
„x
)

198  
	`pxt4_group_fú°_block_no
(
sb
, 
„x
->
„_group
) +

199 (
„x
->
„_°¨t
 << 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
);

200 
	}
}

202 (*
	tpxt4_mbÆloc_quîy_ønge_‚
)(

203 
	tsu≥r_block
 *
	tsb
,

204 
	tpxt4_group_t
 
	tagno
,

205 
	tpxt4_gΩblk_t
 
	t°¨t
,

206 
	tpxt4_gΩblk_t
 
	tÀn
,

207 *
	t¥iv
);

210 
	`pxt4_mbÆloc_quîy_ønge
(

211 
su≥r_block
 *
sb
,

212 
pxt4_group_t
 
agno
,

213 
pxt4_gΩblk_t
 
°¨t
,

214 
pxt4_gΩblk_t
 
íd
,

215 
pxt4_mbÆloc_quîy_ønge_‚
 
f‹m©ãr
,

216 *
¥iv
);

	@migrate.c

8 
	~<löux/¶ab.h
>

9 
	~"pxt4_jbd3.h
"

10 
	~"pxt4_exã¡s.h
"

16 
	smigøã_°ru˘
 {

17 
pxt4_lblk_t
 
	mfú°_block
, 
	mœ°_block
, 
	mcuº_block
;

18 
pxt4_fsblk_t
 
	mfú°_pblock
, 
	mœ°_pblock
;

21 
	$föish_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

22 
migøã_°ru˘
 *
lb
)

25 
ªtvÆ
 = 0, 
√eded
;

26 
pxt4_exã¡
 
√wext
;

27 
pxt4_ext_∑th
 *
∑th
;

28 i‡(
lb
->
fú°_pblock
 == 0)

32 
√wext
.
ì_block
 = 
	`˝u_to_À32
(
lb
->
fú°_block
);

33 
√wext
.
ì_Àn
 = 
	`˝u_to_À16
(
lb
->
œ°_block
 -Üb->
fú°_block
 + 1);

34 
	`pxt4_ext_°‹e_pblock
(&
√wext
, 
lb
->
fú°_pblock
);

36 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

37 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
lb
->
fú°_block
, 
NULL
, 0);

38 i‡(
	`IS_ERR
(
∑th
)) {

39 
ªtvÆ
 = 
	`PTR_ERR
(
∑th
);

40 
∑th
 = 
NULL
;

41 
îr_out
;

50 
√eded
 = 
	`pxt4_ext_ˇlc_¸edôs_f‹_sögÀ_exã¡
(
öode
,

51 
lb
->
œ°_block
 -Üb->
fú°_block
 + 1, 
∑th
);

56 i‡(
√eded
 && 
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
,

57 
PXT4_RESERVE_TRANS_BLOCKS
)) {

58 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

59 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
√eded
);

60 
	`down_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

61 i‡(
ªtvÆ
)

62 
îr_out
;

63 } i‡(
√eded
) {

64 
ªtvÆ
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
√eded
);

65 i‡(
ªtvÆ
) {

69 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

70 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
√eded
);

71 
	`down_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

72 i‡(
ªtvÆ
)

73 
îr_out
;

76 
ªtvÆ
 = 
	`pxt4_ext_ö£π_exã¡
(
h™dÀ
, 
öode
, &
∑th
, &
√wext
, 0);

77 
îr_out
:

78 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

79 
	`pxt4_ext_dr›_ªfs
(
∑th
);

80 
	`k‰ì
(
∑th
);

81 
lb
->
fú°_pblock
 = 0;

82  
ªtvÆ
;

83 
	}
}

85 
	$upd©e_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

86 
pxt4_fsblk_t
 
pblock
, 
migøã_°ru˘
 *
lb
)

88 
ªtvÆ
;

92 i‡(
lb
->
fú°_pblock
 &&

93 (
lb
->
œ°_pblock
+1 =
pblock
) &&

94 (
lb
->
œ°_block
+1 =lb->
cuº_block
)) {

95 
lb
->
œ°_pblock
 = 
pblock
;

96 
lb
->
œ°_block
 =Üb->
cuº_block
;

97 
lb
->
cuº_block
++;

103 
ªtvÆ
 = 
	`föish_ønge
(
h™dÀ
, 
öode
, 
lb
);

104 
lb
->
fú°_pblock
 =Üb->
œ°_pblock
 = 
pblock
;

105 
lb
->
fú°_block
 =Üb->
œ°_block
 =Üb->
cuº_block
;

106 
lb
->
cuº_block
++;

107  
ªtvÆ
;

108 
	}
}

110 
	$upd©e_öd_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

111 
pxt4_fsblk_t
 
pblock
,

112 
migøã_°ru˘
 *
lb
)

114 
buf„r_hód
 *
bh
;

115 
__À32
 *
i_d©a
;

116 
i
, 
ªtvÆ
 = 0;

117 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

119 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
pblock
, 0);

120 i‡(
	`IS_ERR
(
bh
))

121  
	`PTR_ERR
(
bh
);

123 
i_d©a
 = (
__À32
 *)
bh
->
b_d©a
;

124 
i
 = 0; i < 
max_íåõs
; i++) {

125 i‡(
i_d©a
[
i
]) {

126 
ªtvÆ
 = 
	`upd©e_exã¡_ønge
(
h™dÀ
, 
öode
,

127 
	`À32_to_˝u
(
i_d©a
[
i
]), 
lb
);

128 i‡(
ªtvÆ
)

131 
lb
->
cuº_block
++;

134 
	`put_bh
(
bh
);

135  
ªtvÆ
;

137 
	}
}

139 
	$upd©e_död_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

140 
pxt4_fsblk_t
 
pblock
,

141 
migøã_°ru˘
 *
lb
)

143 
buf„r_hód
 *
bh
;

144 
__À32
 *
i_d©a
;

145 
i
, 
ªtvÆ
 = 0;

146 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

148 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
pblock
, 0);

149 i‡(
	`IS_ERR
(
bh
))

150  
	`PTR_ERR
(
bh
);

152 
i_d©a
 = (
__À32
 *)
bh
->
b_d©a
;

153 
i
 = 0; i < 
max_íåõs
; i++) {

154 i‡(
i_d©a
[
i
]) {

155 
ªtvÆ
 = 
	`upd©e_öd_exã¡_ønge
(
h™dÀ
, 
öode
,

156 
	`À32_to_˝u
(
i_d©a
[
i
]), 
lb
);

157 i‡(
ªtvÆ
)

161 
lb
->
cuº_block
 +
max_íåõs
;

164 
	`put_bh
(
bh
);

165  
ªtvÆ
;

167 
	}
}

169 
	$upd©e_töd_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

170 
pxt4_fsblk_t
 
pblock
,

171 
migøã_°ru˘
 *
lb
)

173 
buf„r_hód
 *
bh
;

174 
__À32
 *
i_d©a
;

175 
i
, 
ªtvÆ
 = 0;

176 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

178 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
pblock
, 0);

179 i‡(
	`IS_ERR
(
bh
))

180  
	`PTR_ERR
(
bh
);

182 
i_d©a
 = (
__À32
 *)
bh
->
b_d©a
;

183 
i
 = 0; i < 
max_íåõs
; i++) {

184 i‡(
i_d©a
[
i
]) {

185 
ªtvÆ
 = 
	`upd©e_död_exã¡_ønge
(
h™dÀ
, 
öode
,

186 
	`À32_to_˝u
(
i_d©a
[
i
]), 
lb
);

187 i‡(
ªtvÆ
)

191 
lb
->
cuº_block
 +
max_íåõs
 * max_entries;

194 
	`put_bh
(
bh
);

195  
ªtvÆ
;

197 
	}
}

199 
	$exãnd_¸edô_f‹_blkdñ
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

201 
ªtvÆ
 = 0, 
√eded
;

203 i‡(
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
, 
PXT4_RESERVE_TRANS_BLOCKS
+1))

211 
√eded
 = 3 + 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
öode
->
i_sb
);

213 i‡(
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
√eded
) != 0)

214 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
√eded
);

216  
ªtvÆ
;

217 
	}
}

219 
	$‰ì_död_blocks
(
h™dÀ_t
 *
h™dÀ
,

220 
öode
 *öode, 
__À32
 
i_d©a
)

222 
i
;

223 
__À32
 *
tmp_id©a
;

224 
buf„r_hód
 *
bh
;

225 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

227 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`À32_to_˝u
(
i_d©a
), 0);

228 i‡(
	`IS_ERR
(
bh
))

229  
	`PTR_ERR
(
bh
);

231 
tmp_id©a
 = (
__À32
 *)
bh
->
b_d©a
;

232 
i
 = 0; i < 
max_íåõs
; i++) {

233 i‡(
tmp_id©a
[
i
]) {

234 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

235 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

236 
	`À32_to_˝u
(
tmp_id©a
[
i
]), 1,

237 
PXT4_FREE_BLOCKS_METADATA
 |

238 
PXT4_FREE_BLOCKS_FORGET
);

241 
	`put_bh
(
bh
);

242 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

243 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
	`À32_to_˝u
(
i_d©a
), 1,

244 
PXT4_FREE_BLOCKS_METADATA
 |

245 
PXT4_FREE_BLOCKS_FORGET
);

247 
	}
}

249 
	$‰ì_töd_blocks
(
h™dÀ_t
 *
h™dÀ
,

250 
öode
 *öode, 
__À32
 
i_d©a
)

252 
i
, 
ªtvÆ
 = 0;

253 
__À32
 *
tmp_id©a
;

254 
buf„r_hód
 *
bh
;

255 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

257 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`À32_to_˝u
(
i_d©a
), 0);

258 i‡(
	`IS_ERR
(
bh
))

259  
	`PTR_ERR
(
bh
);

261 
tmp_id©a
 = (
__À32
 *)
bh
->
b_d©a
;

262 
i
 = 0; i < 
max_íåõs
; i++) {

263 i‡(
tmp_id©a
[
i
]) {

264 
ªtvÆ
 = 
	`‰ì_död_blocks
(
h™dÀ
,

265 
öode
, 
tmp_id©a
[
i
]);

266 i‡(
ªtvÆ
) {

267 
	`put_bh
(
bh
);

268  
ªtvÆ
;

272 
	`put_bh
(
bh
);

273 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

274 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
	`À32_to_˝u
(
i_d©a
), 1,

275 
PXT4_FREE_BLOCKS_METADATA
 |

276 
PXT4_FREE_BLOCKS_FORGET
);

278 
	}
}

280 
	$‰ì_öd_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, 
__À32
 *
i_d©a
)

282 
ªtvÆ
;

285 i‡(
i_d©a
[0]) {

286 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

287 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

288 
	`À32_to_˝u
(
i_d©a
[0]), 1,

289 
PXT4_FREE_BLOCKS_METADATA
 |

290 
PXT4_FREE_BLOCKS_FORGET
);

294 i‡(
i_d©a
[1]) {

295 
ªtvÆ
 = 
	`‰ì_död_blocks
(
h™dÀ
, 
öode
, 
i_d©a
[1]);

296 i‡(
ªtvÆ
)

297  
ªtvÆ
;

301 i‡(
i_d©a
[2]) {

302 
ªtvÆ
 = 
	`‰ì_töd_blocks
(
h™dÀ
, 
öode
, 
i_d©a
[2]);

303 i‡(
ªtvÆ
)

304  
ªtvÆ
;

307 
	}
}

309 
	$pxt4_ext_sw≠_öode_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

310 
öode
 *
tmp_öode
)

312 
ªtvÆ
;

313 
__À32
 
i_d©a
[3];

314 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

315 
pxt4_öode_öfo
 *
tmp_ei
 = 
	`PXT4_I
(
tmp_öode
);

321 
ªtvÆ
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 1);

322 i‡(
ªtvÆ
) {

323 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 1);

324 i‡(
ªtvÆ
)

325 
îr_out
;

328 
i_d©a
[0] = 
ei
->i_d©a[
PXT4_IND_BLOCK
];

329 
i_d©a
[1] = 
ei
->i_d©a[
PXT4_DIND_BLOCK
];

330 
i_d©a
[2] = 
ei
->i_d©a[
PXT4_TIND_BLOCK
];

332 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

338 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
)) {

339 
ªtvÆ
 = -
EAGAIN
;

340 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

341 
îr_out
;

343 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
);

348 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

349 
	`mem˝y
(
ei
->
i_d©a
, 
tmp_ei
->i_data, (ei->i_data));

360 
	`•ö_lock
(&
öode
->
i_lock
);

361 
öode
->
i_blocks
 +
tmp_öode
->i_blocks;

362 
	`•ö_u∆ock
(&
öode
->
i_lock
);

363 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

369 
ªtvÆ
 = 
	`‰ì_öd_block
(
h™dÀ
, 
öode
, 
i_d©a
);

370 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

372 
îr_out
:

373  
ªtvÆ
;

374 
	}
}

376 
	$‰ì_ext_idx
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

377 
pxt4_exã¡_idx
 *
ix
)

379 
i
, 
ªtvÆ
 = 0;

380 
pxt4_fsblk_t
 
block
;

381 
buf„r_hód
 *
bh
;

382 
pxt4_exã¡_hódî
 *
eh
;

384 
block
 = 
	`pxt4_idx_pblock
(
ix
);

385 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
block
, 0);

386 i‡(
	`IS_ERR
(
bh
))

387  
	`PTR_ERR
(
bh
);

389 
eh
 = (
pxt4_exã¡_hódî
 *)
bh
->
b_d©a
;

390 i‡(
eh
->
eh_dïth
 != 0) {

391 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

392 
i
 = 0; i < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i++, 
ix
++) {

393 
ªtvÆ
 = 
	`‰ì_ext_idx
(
h™dÀ
, 
öode
, 
ix
);

394 i‡(
ªtvÆ
)

398 
	`put_bh
(
bh
);

399 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

400 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
block
, 1,

401 
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
);

402  
ªtvÆ
;

403 
	}
}

408 
	$‰ì_ext_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

410 
i
, 
ªtvÆ
 = 0;

411 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

412 
pxt4_exã¡_hódî
 *
eh
 = (pxt4_exã¡_hódî *)
ei
->
i_d©a
;

413 
pxt4_exã¡_idx
 *
ix
;

414 i‡(
eh
->
eh_dïth
 == 0)

419 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

420 
i
 = 0; i < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i++, 
ix
++) {

421 
ªtvÆ
 = 
	`‰ì_ext_idx
(
h™dÀ
, 
öode
, 
ix
);

422 i‡(
ªtvÆ
)

423  
ªtvÆ
;

425  
ªtvÆ
;

426 
	}
}

428 
	$pxt4_ext_migøã
(
öode
 *inode)

430 
h™dÀ_t
 *
h™dÀ
;

431 
ªtvÆ
 = 0, 
i
;

432 
__À32
 *
i_d©a
;

433 
pxt4_öode_öfo
 *
ei
;

434 
öode
 *
tmp_öode
 = 
NULL
;

435 
migøã_°ru˘
 
lb
;

436 
max_íåõs
;

437 
__u32
 
gﬂl
;

438 
uid_t
 
ow√r
[2];

444 i‡(!
	`pxt4_has_„©uª_exã¡s
(
öode
->
i_sb
) ||

445 (
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

446  -
EINVAL
;

448 i‡(
	`S_ISLNK
(
öode
->
i_mode
Ë&& inode->
i_blocks
 == 0)

452  
ªtvÆ
;

459 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MIGRATE
,

460 4 + 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
öode
->
i_sb
));

462 i‡(
	`IS_ERR
(
h™dÀ
)) {

463 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

464  
ªtvÆ
;

466 
gﬂl
 = (((
öode
->
i_öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(öode->
i_sb
)) *

467 
	`PXT4_INODES_PER_GROUP
(
öode
->
i_sb
)) + 1;

468 
ow√r
[0] = 
	`i_uid_ªad
(
öode
);

469 
ow√r
[1] = 
	`i_gid_ªad
(
öode
);

470 
tmp_öode
 = 
	`pxt4_√w_öode
(
h™dÀ
, 
	`d_öode
(
öode
->
i_sb
->
s_roŸ
),

471 
S_IFREG
, 
NULL
, 
gﬂl
, 
ow√r
, 0);

472 i‡(
	`IS_ERR
(
tmp_öode
)) {

473 
ªtvÆ
 = 
	`PTR_ERR
(
tmp_öode
);

474 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

475  
ªtvÆ
;

477 
	`i_size_wrôe
(
tmp_öode
, 
	`i_size_ªad
(
öode
));

482 
	`˛ór_∆ök
(
tmp_öode
);

484 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
tmp_öode
);

485 
	`pxt4_‹ph™_add
(
h™dÀ
, 
tmp_öode
);

486 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

504 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

505 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
);

506 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

508 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MIGRATE
, 1);

509 i‡(
	`IS_ERR
(
h™dÀ
)) {

515 
	`pxt4_‹ph™_dñ
(
NULL
, 
tmp_öode
);

516 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

517 
out
;

520 
ei
 = 
	`PXT4_I
(
öode
);

521 
i_d©a
 = 
ei
->i_data;

522 
	`mem£t
(&
lb
, 0, (lb));

525 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

526 
i
 = 0; i < 
PXT4_NDIR_BLOCKS
; i++) {

527 i‡(
i_d©a
[
i
]) {

528 
ªtvÆ
 = 
	`upd©e_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

529 
	`À32_to_˝u
(
i_d©a
[
i
]), &
lb
);

530 i‡(
ªtvÆ
)

531 
îr_out
;

533 
lb
.
cuº_block
++;

535 i‡(
i_d©a
[
PXT4_IND_BLOCK
]) {

536 
ªtvÆ
 = 
	`upd©e_öd_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

537 
	`À32_to_˝u
(
i_d©a
[
PXT4_IND_BLOCK
]), &
lb
);

538 i‡(
ªtvÆ
)

539 
îr_out
;

541 
lb
.
cuº_block
 +
max_íåõs
;

542 i‡(
i_d©a
[
PXT4_DIND_BLOCK
]) {

543 
ªtvÆ
 = 
	`upd©e_död_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

544 
	`À32_to_˝u
(
i_d©a
[
PXT4_DIND_BLOCK
]), &
lb
);

545 i‡(
ªtvÆ
)

546 
îr_out
;

548 
lb
.
cuº_block
 +
max_íåõs
 * max_entries;

549 i‡(
i_d©a
[
PXT4_TIND_BLOCK
]) {

550 
ªtvÆ
 = 
	`upd©e_töd_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

551 
	`À32_to_˝u
(
i_d©a
[
PXT4_TIND_BLOCK
]), &
lb
);

552 i‡(
ªtvÆ
)

553 
îr_out
;

558 
ªtvÆ
 = 
	`föish_ønge
(
h™dÀ
, 
tmp_öode
, &
lb
);

559 
îr_out
:

560 i‡(
ªtvÆ
)

565 
	`‰ì_ext_block
(
h™dÀ
, 
tmp_öode
);

567 
ªtvÆ
 = 
	`pxt4_ext_sw≠_öode_d©a
(
h™dÀ
, 
öode
, 
tmp_öode
);

568 i‡(
ªtvÆ
)

573 
	`‰ì_ext_block
(
h™dÀ
, 
tmp_öode
);

577 i‡(
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 1) != 0)

578 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 1);

583 
	`i_size_wrôe
(
tmp_öode
, 0);

593 
tmp_öode
->
i_blocks
 = 0;

596 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
tmp_öode
);

597 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

598 
out
:

599 
	`u∆ock_√w_öode
(
tmp_öode
);

600 
	`ùut
(
tmp_öode
);

602  
ªtvÆ
;

603 
	}
}

608 
	$pxt4_öd_migøã
(
öode
 *inode)

610 
pxt4_exã¡_hódî
 *
eh
;

611 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

612 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

613 
pxt4_exã¡
 *
ex
;

614 
i
, 
Àn
;

615 
pxt4_lblk_t
 
°¨t
, 
íd
;

616 
pxt4_fsblk_t
 
blk
;

617 
h™dÀ_t
 *
h™dÀ
;

618 
ªt
;

620 i‡(!
	`pxt4_has_„©uª_exã¡s
(
öode
->
i_sb
) ||

621 (!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

622  -
EINVAL
;

624 i‡(
	`pxt4_has_„©uª_bigÆloc
(
öode
->
i_sb
))

625  -
EOPNOTSUPP
;

632 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

633 
	`pxt4_Æloc_da_blocks
(
öode
);

635 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MIGRATE
, 1);

636 i‡(
	`IS_ERR
(
h™dÀ
))

637  
	`PTR_ERR
(
h™dÀ
);

639 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

640 
ªt
 = 
	`pxt4_ext_check_öode
(
öode
);

641 i‡(
ªt
)

642 
îrout
;

644 
eh
 = 
	`ext_öode_hdr
(
öode
);

645 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

646 i‡(
	`pxt4_blocks_cou¡
(
es
Ë> 
PXT4_MAX_BLOCK_FILE_PHYS
 ||

647 
eh
->
eh_dïth
 !0 || 
	`À16_to_˝u
”h->
eh_íåõs
) > 1) {

648 
ªt
 = -
EOPNOTSUPP
;

649 
îrout
;

651 i‡(
eh
->
eh_íåõs
 == 0)

652 
blk
 = 
Àn
 = 
°¨t
 = 
íd
 = 0;

654 
Àn
 = 
	`À16_to_˝u
(
ex
->
ì_Àn
);

655 
blk
 = 
	`pxt4_ext_pblock
(
ex
);

656 
°¨t
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

657 
íd
 = 
°¨t
 + 
Àn
 - 1;

658 i‡(
íd
 >
PXT4_NDIR_BLOCKS
) {

659 
ªt
 = -
EOPNOTSUPP
;

660 
îrout
;

664 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

665 
	`mem£t
(
ei
->
i_d©a
, 0, (ei->i_data));

666 
i
 = 
°¨t
; i <
íd
; i++)

667 
ei
->
i_d©a
[
i
] = 
	`˝u_to_À32
(
blk
++);

668 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

669 
îrout
:

670 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

671 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

672  
ªt
;

673 
	}
}

	@mmp.c

2 
	~<löux/fs.h
>

3 
	~<löux/øndom.h
>

4 
	~<löux/buf„r_hód.h
>

5 
	~<löux/ut¢ame.h
>

6 
	~<löux/kthªad.h
>

8 
	~"pxt4.h
"

11 
__À32
 
	$pxt4_mmp_csum
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
)

13 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

14 
off£t
 = 
	`off£tof
(
mmp_°ru˘
, 
mmp_checksum
);

15 
__u32
 
csum
;

17 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (*)
mmp
, 
off£t
);

19  
	`˝u_to_À32
(
csum
);

20 
	}
}

22 
	$pxt4_mmp_csum_vîify
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
)

24 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

27  
mmp
->
mmp_checksum
 =
	`pxt4_mmp_csum
(
sb
, mmp);

28 
	}
}

30 
	$pxt4_mmp_csum_£t
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
)

32 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

35 
mmp
->
mmp_checksum
 = 
	`pxt4_mmp_csum
(
sb
, mmp);

36 
	}
}

42 
	$wrôe_mmp_block
(
su≥r_block
 *
sb
, 
buf„r_hód
 *
bh
)

44 
mmp_°ru˘
 *
mmp
 = (mmp_°ru˘ *)(
bh
->
b_d©a
);

50 
	`sb_°¨t_wrôe
(
sb
);

51 
	`pxt4_mmp_csum_£t
(
sb
, 
mmp
);

52 
	`lock_buf„r
(
bh
);

53 
bh
->
b_íd_io
 = 
íd_buf„r_wrôe_sync
;

54 
	`gë_bh
(
bh
);

55 
	`submô_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
 | 
REQ_META
 | 
REQ_PRIO
, 
bh
);

56 
	`waô_⁄_buf„r
(
bh
);

57 
	`sb_íd_wrôe
(
sb
);

58 i‡(
	`u∆ikñy
(!
	`buf„r_u±od©e
(
bh
)))

62 
	}
}

68 
	$ªad_mmp_block
(
su≥r_block
 *
sb
, 
buf„r_hód
 **
bh
,

69 
pxt4_fsblk_t
 
mmp_block
)

71 
mmp_°ru˘
 *
mmp
;

72 
ªt
;

74 i‡(*
bh
)

75 
	`˛ór_buf„r_u±od©e
(*
bh
);

80 i‡(!*
bh
) {

81 *
bh
 = 
	`sb_gëblk
(
sb
, 
mmp_block
);

82 i‡(!*
bh
) {

83 
ªt
 = -
ENOMEM
;

84 
w¨n_exô
;

88 
	`gë_bh
(*
bh
);

89 
	`lock_buf„r
(*
bh
);

90 (*
bh
)->
b_íd_io
 = 
íd_buf„r_ªad_sync
;

91 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, *
bh
);

92 
	`waô_⁄_buf„r
(*
bh
);

93 i‡(!
	`buf„r_u±od©e
(*
bh
)) {

94 
ªt
 = -
EIO
;

95 
w¨n_exô
;

97 
mmp
 = (
mmp_°ru˘
 *)((*
bh
)->
b_d©a
);

98 i‡(
	`À32_to_˝u
(
mmp
->
mmp_magic
Ë!
PXT4_MMP_MAGIC
) {

99 
ªt
 = -
EFSCORRUPTED
;

100 
w¨n_exô
;

102 i‡(!
	`pxt4_mmp_csum_vîify
(
sb
, 
mmp
)) {

103 
ªt
 = -
EFSBADCRC
;

104 
w¨n_exô
;

107 
w¨n_exô
:

108 
	`bªl£
(*
bh
);

109 *
bh
 = 
NULL
;

110 
	`pxt4_w¨nög
(
sb
, "Error %d whileÑeading MMP block %llu",

111 
ªt
, 
mmp_block
);

112  
ªt
;

113 
	}
}

118 
	$__dump_mmp_msg
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
,

119 c⁄° *
fun˘i⁄
, 
löe
, c⁄° *
msg
)

121 
	`__pxt4_w¨nög
(
sb
, 
fun˘i⁄
, 
löe
, "%s", 
msg
);

122 
	`__pxt4_w¨nög
(
sb
, 
fun˘i⁄
, 
löe
,

125 (Ë
	`À64_to_˝u
(
mmp
->
mmp_time
),

126 
mmp
->
mmp_nodíame
, mmp->
mmp_bdev«me
);

127 
	}
}

132 
	$kmmpd
(*
d©a
)

134 
su≥r_block
 *
sb
 = ((
mmpd_d©a
 *Ë
d©a
)->sb;

135 
buf„r_hód
 *
bh
 = ((
mmpd_d©a
 *Ë
d©a
)->bh;

136 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

137 
mmp_°ru˘
 *
mmp
;

138 
pxt4_fsblk_t
 
mmp_block
;

139 
u32
 
£q
 = 0;

140 
Áûed_wrôes
 = 0;

141 
mmp_upd©e_öãrvÆ
 = 
	`À16_to_˝u
(
es
->
s_mmp_upd©e_öãrvÆ
);

142 
mmp_check_öãrvÆ
;

143 
œ°_upd©e_time
;

144 
diff
;

145 
ªtvÆ
;

147 
mmp_block
 = 
	`À64_to_˝u
(
es
->
s_mmp_block
);

148 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

149 
mmp
->
mmp_time
 = 
	`˝u_to_À64
(
	`ktime_gë_ªÆ_£c⁄ds
());

154 
mmp_check_öãrvÆ
 = 
	`max
(
PXT4_MMP_CHECK_MULT
 * 
mmp_upd©e_öãrvÆ
,

155 
PXT4_MMP_MIN_CHECK_INTERVAL
);

156 
mmp
->
mmp_check_öãrvÆ
 = 
	`˝u_to_À16
(mmp_check_interval);

157 
	`bdev«me
(
bh
->
b_bdev
, 
mmp
->
mmp_bdev«me
);

159 
	`mem˝y
(
mmp
->
mmp_nodíame
, 
	`öô_ut¢ame
()->
nodíame
,

160 (
mmp
->
mmp_nodíame
));

162 !
	`kthªad_should_°›
()) {

163 i‡(++
£q
 > 
PXT4_MMP_SEQ_MAX
)

164 
£q
 = 1;

166 
mmp
->
mmp_£q
 = 
	`˝u_to_À32
(
£q
);

167 
mmp
->
mmp_time
 = 
	`˝u_to_À64
(
	`ktime_gë_ªÆ_£c⁄ds
());

168 
œ°_upd©e_time
 = 
jiffõs
;

170 
ªtvÆ
 = 
	`wrôe_mmp_block
(
sb
, 
bh
);

175 i‡(
ªtvÆ
) {

176 i‡((
Áûed_wrôes
 % 60) == 0)

177 
	`pxt4_îr‹
(
sb
, "Error writingÅo MMP block");

178 
Áûed_wrôes
++;

181 i‡(!(
	`À32_to_˝u
(
es
->
s_„©uª_öcom∑t
) &

182 
PXT4_FEATURE_INCOMPAT_MMP
)) {

183 
	`pxt4_w¨nög
(
sb
, "kmmpd being stopped since MMP feature"

185 
exô_thªad
;

188 i‡(
	`sb_rd⁄ly
(
sb
))

191 
diff
 = 
jiffõs
 - 
œ°_upd©e_time
;

192 i‡(
diff
 < 
mmp_upd©e_öãrvÆ
 * 
HZ
)

193 
	`scheduÀ_timeout_öãºu±ibÀ
(
mmp_upd©e_öãrvÆ
 *

194 
HZ
 - 
diff
);

201 
diff
 = 
jiffõs
 - 
œ°_upd©e_time
;

202 i‡(
diff
 > 
mmp_check_öãrvÆ
 * 
HZ
) {

203 
buf„r_hód
 *
bh_check
 = 
NULL
;

204 
mmp_°ru˘
 *
mmp_check
;

206 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh_check
, 
mmp_block
);

207 i‡(
ªtvÆ
) {

208 
	`pxt4_îr‹
(
sb
, "errorÑeading MMP data: %d",

209 
ªtvÆ
);

210 
exô_thªad
;

213 
mmp_check
 = (
mmp_°ru˘
 *)(
bh_check
->
b_d©a
);

214 i‡(
mmp
->
mmp_£q
 !
mmp_check
->mmp_seq ||

215 
	`memcmp
(
mmp
->
mmp_nodíame
, 
mmp_check
->mmp_nodename,

216 (
mmp
->
mmp_nodíame
))) {

217 
	`dump_mmp_msg
(
sb
, 
mmp_check
,

221 
	`pxt4_îr‹
(
sb
, "abort");

222 
	`put_bh
(
bh_check
);

223 
ªtvÆ
 = -
EBUSY
;

224 
exô_thªad
;

226 
	`put_bh
(
bh_check
);

233 
mmp_check_öãrvÆ
 = 
	`max
(
	`mö
(
PXT4_MMP_CHECK_MULT
 * 
diff
 / 
HZ
,

234 
PXT4_MMP_MAX_CHECK_INTERVAL
),

235 
PXT4_MMP_MIN_CHECK_INTERVAL
);

236 
mmp
->
mmp_check_öãrvÆ
 = 
	`˝u_to_À16
(mmp_check_interval);

242 
mmp
->
mmp_£q
 = 
	`˝u_to_À32
(
PXT4_MMP_SEQ_CLEAN
);

243 
mmp
->
mmp_time
 = 
	`˝u_to_À64
(
	`ktime_gë_ªÆ_£c⁄ds
());

245 
ªtvÆ
 = 
	`wrôe_mmp_block
(
sb
, 
bh
);

247 
exô_thªad
:

248 
	`PXT4_SB
(
sb
)->
s_mmp_tsk
 = 
NULL
;

249 
	`k‰ì
(
d©a
);

250 
	`bªl£
(
bh
);

251  
ªtvÆ
;

252 
	}
}

258 
	$mmp_√w_£q
()

260 
u32
 
√w_£q
;

263 
√w_£q
 = 
	`¥™dom_u32
();

264 } 
√w_£q
 > 
PXT4_MMP_SEQ_MAX
);

266  
√w_£q
;

267 
	}
}

272 
	$pxt4_mu…i_mou¡_¥Ÿe˘
(
su≥r_block
 *
sb
,

273 
pxt4_fsblk_t
 
mmp_block
)

275 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

276 
buf„r_hód
 *
bh
 = 
NULL
;

277 
mmp_°ru˘
 *
mmp
 = 
NULL
;

278 
mmpd_d©a
 *mmpd_data;

279 
u32
 
£q
;

280 
mmp_check_öãrvÆ
 = 
	`À16_to_˝u
(
es
->
s_mmp_upd©e_öãrvÆ
);

281 
waô_time
 = 0;

282 
ªtvÆ
;

284 i‡(
mmp_block
 < 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
) ||

285 
mmp_block
 >
	`pxt4_blocks_cou¡
(
es
)) {

286 
	`pxt4_w¨nög
(
sb
, "Invalid MMP block in superblock");

287 
Áûed
;

290 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

291 i‡(
ªtvÆ
)

292 
Áûed
;

294 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

296 i‡(
mmp_check_öãrvÆ
 < 
PXT4_MMP_MIN_CHECK_INTERVAL
)

297 
mmp_check_öãrvÆ
 = 
PXT4_MMP_MIN_CHECK_INTERVAL
;

303 i‡(
	`À16_to_˝u
(
mmp
->
mmp_check_öãrvÆ
) > mmp_check_interval)

304 
mmp_check_öãrvÆ
 = 
	`À16_to_˝u
(
mmp
->mmp_check_interval);

306 
£q
 = 
	`À32_to_˝u
(
mmp
->
mmp_£q
);

307 i‡(
£q
 =
PXT4_MMP_SEQ_CLEAN
)

308 
skù
;

310 i‡(
£q
 =
PXT4_MMP_SEQ_FSCK
) {

311 
	`dump_mmp_msg
(
sb
, 
mmp
, "fsck isÑunning onÅhe filesystem");

312 
Áûed
;

315 
waô_time
 = 
	`mö
(
mmp_check_öãrvÆ
 * 2 + 1,

316 
mmp_check_öãrvÆ
 + 60);

319 i‡(
waô_time
 > 
PXT4_MMP_MIN_CHECK_INTERVAL
 * 4)

320 
	`pxt4_w¨nög
(
sb
, "MMP interval %u higherÅhanÉxpected,Ölease"

321 " waô.\n", 
waô_time
 * 2);

323 i‡(
	`scheduÀ_timeout_öãºu±ibÀ
(
HZ
 * 
waô_time
) != 0) {

324 
	`pxt4_w¨nög
(
sb
, "MMP startup interrupted, failing mount\n");

325 
Áûed
;

328 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

329 i‡(
ªtvÆ
)

330 
Áûed
;

331 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

332 i‡(
£q
 !
	`À32_to_˝u
(
mmp
->
mmp_£q
)) {

333 
	`dump_mmp_msg
(
sb
, 
mmp
,

335 
Áûed
;

338 
skù
:

342 
£q
 = 
	`mmp_√w_£q
();

343 
mmp
->
mmp_£q
 = 
	`˝u_to_À32
(
£q
);

345 
ªtvÆ
 = 
	`wrôe_mmp_block
(
sb
, 
bh
);

346 i‡(
ªtvÆ
)

347 
Áûed
;

352 i‡(
	`scheduÀ_timeout_öãºu±ibÀ
(
HZ
 * 
waô_time
) != 0) {

353 
	`pxt4_w¨nög
(
sb
, "MMP startup interrupted, failing mount");

354 
Áûed
;

357 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

358 i‡(
ªtvÆ
)

359 
Áûed
;

360 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

361 i‡(
£q
 !
	`À32_to_˝u
(
mmp
->
mmp_£q
)) {

362 
	`dump_mmp_msg
(
sb
, 
mmp
,

364 
Áûed
;

367 
mmpd_d©a
 = 
	`kmÆloc
((*mmpd_d©a), 
GFP_KERNEL
);

368 i‡(!
mmpd_d©a
) {

369 
	`pxt4_w¨nög
(
sb
, "notÉnough memory for mmpd_data");

370 
Áûed
;

372 
mmpd_d©a
->
sb
 = sb;

373 
mmpd_d©a
->
bh
 = bh;

378 
	`PXT4_SB
(
sb
)->
s_mmp_tsk
 = 
	`kthªad_run
(
kmmpd
, 
mmpd_d©a
, "kmmpd-%s",

379 
	`bdev«me
(
bh
->
b_bdev
,

380 
mmp
->
mmp_bdev«me
));

381 i‡(
	`IS_ERR
(
	`PXT4_SB
(
sb
)->
s_mmp_tsk
)) {

382 
	`PXT4_SB
(
sb
)->
s_mmp_tsk
 = 
NULL
;

383 
	`k‰ì
(
mmpd_d©a
);

384 
	`pxt4_w¨nög
(
sb
, "UnableÅo create kmmpdÅhread for %s.",

385 
sb
->
s_id
);

386 
Áûed
;

391 
Áûed
:

392 
	`bªl£
(
bh
);

394 
	}
}

	@move_extent.c

8 
	~<löux/fs.h
>

9 
	~<löux/quŸa›s.h
>

10 
	~<löux/¶ab.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"pxt4_exã¡s.h
"

24 
ölöe
 

25 
	$gë_ext_∑th
(
öode
 *öode, 
pxt4_lblk_t
 
lblock
,

26 
pxt4_ext_∑th
 **
µ©h
)

28 
pxt4_ext_∑th
 *
∑th
;

30 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
lblock
, 
µ©h
, 
PXT4_EX_NOCACHE
);

31 i‡(
	`IS_ERR
(
∑th
))

32  
	`PTR_ERR
(
∑th
);

33 i‡(
∑th
[
	`ext_dïth
(
öode
)].
p_ext
 =
NULL
) {

34 
	`pxt4_ext_dr›_ªfs
(
∑th
);

35 
	`k‰ì
(
∑th
);

36 *
µ©h
 = 
NULL
;

37  -
ENODATA
;

39 *
µ©h
 = 
∑th
;

41 
	}
}

51 
	$pxt4_doubÀ_down_wrôe_d©a_£m
(
öode
 *
fú°
, öodê*
£c⁄d
)

53 i‡(
fú°
 < 
£c⁄d
) {

54 
	`down_wrôe
(&
	`PXT4_I
(
fú°
)->
i_d©a_£m
);

55 
	`down_wrôe_√°ed
(&
	`PXT4_I
(
£c⁄d
)->
i_d©a_£m
, 
I_DATA_SEM_OTHER
);

57 
	`down_wrôe
(&
	`PXT4_I
(
£c⁄d
)->
i_d©a_£m
);

58 
	`down_wrôe_√°ed
(&
	`PXT4_I
(
fú°
)->
i_d©a_£m
, 
I_DATA_SEM_OTHER
);

61 
	}
}

71 
	$pxt4_doubÀ_up_wrôe_d©a_£m
(
öode
 *
‹ig_öode
,

72 
öode
 *
d⁄‹_öode
)

74 
	`up_wrôe
(&
	`PXT4_I
(
‹ig_öode
)->
i_d©a_£m
);

75 
	`up_wrôe
(&
	`PXT4_I
(
d⁄‹_öode
)->
i_d©a_£m
);

76 
	}
}

90 
	$mext_check_covîage
(
öode
 *öode, 
pxt4_lblk_t
 
‰om
,Öxt4_lblk_à
cou¡
,

91 
unwrôãn
, *
îr
)

93 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

94 
pxt4_exã¡
 *
ext
;

95 
ªt
 = 0;

96 
pxt4_lblk_t
 
œ°
 = 
‰om
 + 
cou¡
;

97 
‰om
 < 
œ°
) {

98 *
îr
 = 
	`gë_ext_∑th
(
öode
, 
‰om
, &
∑th
);

99 i‡(*
îr
)

100 
out
;

101 
ext
 = 
∑th
[
	`ext_dïth
(
öode
)].
p_ext
;

102 i‡(
unwrôãn
 !
	`pxt4_ext_is_unwrôãn
(
ext
))

103 
out
;

104 
‰om
 +
	`pxt4_ext_gë_a˘uÆ_Àn
(
ext
);

105 
	`pxt4_ext_dr›_ªfs
(
∑th
);

107 
ªt
 = 1;

108 
out
:

109 
	`pxt4_ext_dr›_ªfs
(
∑th
);

110 
	`k‰ì
(
∑th
);

111  
ªt
;

112 
	}
}

126 
	$mext_∑ge_doubÀ_lock
(
öode
 *
öode1
, öodê*
öode2
,

127 
pgoff_t
 
ödex1
,Ögoff_à
ödex2
, 
∑ge
 *page[2])

129 
addªss_•a˚
 *
m≠pög
[2];

130 
Ê
 = 
AOP_FLAG_NOFS
;

132 
	`BUG_ON
(!
öode1
 || !
öode2
);

133 i‡(
öode1
 < 
öode2
) {

134 
m≠pög
[0] = 
öode1
->
i_m≠pög
;

135 
m≠pög
[1] = 
öode2
->
i_m≠pög
;

137 
	`sw≠
(
ödex1
, 
ödex2
);

138 
m≠pög
[0] = 
öode2
->
i_m≠pög
;

139 
m≠pög
[1] = 
öode1
->
i_m≠pög
;

142 
∑ge
[0] = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
[0], 
ödex1
, 
Ê
);

143 i‡(!
∑ge
[0])

144  -
ENOMEM
;

146 
∑ge
[1] = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
[1], 
ödex2
, 
Ê
);

147 i‡(!
∑ge
[1]) {

148 
	`u∆ock_∑ge
(
∑ge
[0]);

149 
	`put_∑ge
(
∑ge
[0]);

150  -
ENOMEM
;

157 
	`waô_⁄_∑ge_wrôeback
(
∑ge
[0]);

158 
	`waô_⁄_∑ge_wrôeback
(
∑ge
[1]);

159 i‡(
öode1
 > 
öode2
)

160 
	`sw≠
(
∑ge
[0],Öage[1]);

163 
	}
}

167 
	$mext_∑ge_mku±od©e
(
∑ge
 *∑ge, 
‰om
, 
to
)

169 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

170 
£˘‹_t
 
block
;

171 
buf„r_hód
 *
bh
, *
hód
, *
¨r
[
MAX_BUF_PER_PAGE
];

172 
blocksize
, 
block_°¨t
, 
block_íd
;

173 
i
, 
îr
, 
ƒ
 = 0, 
∑πül
 = 0;

174 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

175 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

177 i‡(
	`PageU±od©e
(
∑ge
))

180 
blocksize
 = 
	`i_blocksize
(
öode
);

181 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

182 
	`¸óã_em±y_buf„rs
(
∑ge
, 
blocksize
, 0);

184 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

185 
block
 = (
£˘‹_t
)
∑ge
->
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

186 
bh
 = 
hód
, 
block_°¨t
 = 0; bh != head || !block_start;

187 
block
++, 
block_°¨t
 = 
block_íd
, 
bh
 = bh->
b_this_∑ge
) {

188 
block_íd
 = 
block_°¨t
 + 
blocksize
;

189 i‡(
block_íd
 <
‰om
 || 
block_°¨t
 >
to
) {

190 i‡(!
	`buf„r_u±od©e
(
bh
))

191 
∑πül
 = 1;

194 i‡(
	`buf„r_u±od©e
(
bh
))

196 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

197 
îr
 = 
	`pxt4_gë_block
(
öode
, 
block
, 
bh
, 0);

198 i‡(
îr
) {

199 
	`SëPageEº‹
(
∑ge
);

200  
îr
;

202 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

203 
	`zîo_u£r
(
∑ge
, 
block_°¨t
, 
blocksize
);

204 
	`£t_buf„r_u±od©e
(
bh
);

208 
	`BUG_ON
(
ƒ
 >
MAX_BUF_PER_PAGE
);

209 
¨r
[
ƒ
++] = 
bh
;

212 i‡(!
ƒ
)

213 
out
;

215 
i
 = 0; i < 
ƒ
; i++) {

216 
bh
 = 
¨r
[
i
];

217 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

218 
îr
 = 
	`bh_submô_ªad
(
bh
);

219 i‡(
îr
)

220  
îr
;

223 
out
:

224 i‡(!
∑πül
)

225 
	`SëPageU±od©e
(
∑ge
);

227 
	}
}

247 
	$move_exã¡_≥r_∑ge
(
fûe
 *
o_fûp
, 
öode
 *
d⁄‹_öode
,

248 
pgoff_t
 
‹ig_∑ge_off£t
,Ögoff_à
d⁄‹_∑ge_off£t
,

249 
d©a_off£t_ö_∑ge
,

250 
block_Àn_ö_∑ge
, 
unwrôãn
, *
îr
)

252 
öode
 *
‹ig_öode
 = 
	`fûe_öode
(
o_fûp
);

253 
∑ge
 *
∑gï
[2] = {
NULL
, NULL};

254 
h™dÀ_t
 *
h™dÀ
;

255 
pxt4_lblk_t
 
‹ig_blk_off£t
, 
d⁄‹_blk_off£t
;

256 
blocksize
 = 
‹ig_öode
->
i_sb
->
s_blocksize
;

257 
tmp_d©a_size
, 
d©a_size
, 
ª∂a˚d_size
;

258 
i
, 
îr2
, 
jblocks
, 
ªåõs
 = 0;

259 
ª∂a˚d_cou¡
 = 0;

260 
‰om
 = 
d©a_off£t_ö_∑ge
 << 
‹ig_öode
->
i_blkbôs
;

261 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 >> 
‹ig_öode
->
i_blkbôs
;

262 
su≥r_block
 *
sb
 = 
‹ig_öode
->
i_sb
;

263 
buf„r_hód
 *
bh
 = 
NULL
;

269 
agaö
:

270 *
îr
 = 0;

271 
jblocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
‹ig_öode
) * 2;

272 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
‹ig_öode
, 
PXT4_HT_MOVE_EXTENTS
, 
jblocks
);

273 i‡(
	`IS_ERR
(
h™dÀ
)) {

274 *
îr
 = 
	`PTR_ERR
(
h™dÀ
);

278 
‹ig_blk_off£t
 = 
‹ig_∑ge_off£t
 * 
blocks_≥r_∑ge
 +

279 
d©a_off£t_ö_∑ge
;

281 
d⁄‹_blk_off£t
 = 
d⁄‹_∑ge_off£t
 * 
blocks_≥r_∑ge
 +

282 
d©a_off£t_ö_∑ge
;

285 i‡((
‹ig_blk_off£t
 + 
block_Àn_ö_∑ge
 - 1) ==

286 ((
‹ig_öode
->
i_size
 - 1Ë>> orig_öode->
i_blkbôs
)) {

288 
tmp_d©a_size
 = 
‹ig_öode
->
i_size
 & (
blocksize
 - 1);

293 i‡(
tmp_d©a_size
 == 0)

294 
tmp_d©a_size
 = 
blocksize
;

296 
d©a_size
 = 
tmp_d©a_size
 +

297 ((
block_Àn_ö_∑ge
 - 1Ë<< 
‹ig_öode
->
i_blkbôs
);

299 
d©a_size
 = 
block_Àn_ö_∑ge
 << 
‹ig_öode
->
i_blkbôs
;

301 
ª∂a˚d_size
 = 
d©a_size
;

303 *
îr
 = 
	`mext_∑ge_doubÀ_lock
(
‹ig_öode
, 
d⁄‹_öode
, 
‹ig_∑ge_off£t
,

304 
d⁄‹_∑ge_off£t
, 
∑gï
);

305 i‡(
	`u∆ikñy
(*
îr
 < 0))

306 
°›_jou∫Æ
;

314 i‡(
unwrôãn
) {

315 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

318 
unwrôãn
 = 
	`mext_check_covîage
(
‹ig_öode
, 
‹ig_blk_off£t
,

319 
block_Àn_ö_∑ge
, 1, 
îr
);

320 i‡(*
îr
)

321 
dr›_d©a_£m
;

323 
unwrôãn
 &
	`mext_check_covîage
(
d⁄‹_öode
, 
d⁄‹_blk_off£t
,

324 
block_Àn_ö_∑ge
, 1, 
îr
);

325 i‡(*
îr
)

326 
dr›_d©a_£m
;

328 i‡(!
unwrôãn
) {

329 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

330 
d©a_c›y
;

332 i‡((
	`∑ge_has_¥iv©e
(
∑gï
[0]) &&

333 !
	`åy_to_ªÀa£_∑ge
(
∑gï
[0], 0)) ||

334 (
	`∑ge_has_¥iv©e
(
∑gï
[1]) &&

335 !
	`åy_to_ªÀa£_∑ge
(
∑gï
[1], 0))) {

336 *
îr
 = -
EBUSY
;

337 
dr›_d©a_£m
;

339 
ª∂a˚d_cou¡
 = 
	`pxt4_sw≠_exã¡s
(
h™dÀ
, 
‹ig_öode
,

340 
d⁄‹_öode
, 
‹ig_blk_off£t
,

341 
d⁄‹_blk_off£t
,

342 
block_Àn_ö_∑ge
, 1, 
îr
);

343 
dr›_d©a_£m
:

344 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

345 
u∆ock_∑ges
;

347 
d©a_c›y
:

348 *
îr
 = 
	`mext_∑ge_mku±od©e
(
∑gï
[0], 
‰om
, from + 
ª∂a˚d_size
);

349 i‡(*
îr
)

350 
u∆ock_∑ges
;

354 i‡((
	`∑ge_has_¥iv©e
(
∑gï
[0]Ë&& !
	`åy_to_ªÀa£_∑ge
(pagep[0], 0)) ||

355 (
	`∑ge_has_¥iv©e
(
∑gï
[1]Ë&& !
	`åy_to_ªÀa£_∑ge
(pagep[1], 0))) {

356 *
îr
 = -
EBUSY
;

357 
u∆ock_∑ges
;

359 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

360 
ª∂a˚d_cou¡
 = 
	`pxt4_sw≠_exã¡s
(
h™dÀ
, 
‹ig_öode
, 
d⁄‹_öode
,

361 
‹ig_blk_off£t
, 
d⁄‹_blk_off£t
,

362 
block_Àn_ö_∑ge
, 1, 
îr
);

363 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

364 i‡(*
îr
) {

365 i‡(
ª∂a˚d_cou¡
) {

366 
block_Àn_ö_∑ge
 = 
ª∂a˚d_cou¡
;

367 
ª∂a˚d_size
 =

368 
block_Àn_ö_∑ge
 << 
‹ig_öode
->
i_blkbôs
;

370 
u∆ock_∑ges
;

374 i‡(!
	`∑ge_has_buf„rs
(
∑gï
[0]))

375 
	`¸óã_em±y_buf„rs
(
∑gï
[0], 1 << 
‹ig_öode
->
i_blkbôs
, 0);

376 
bh
 = 
	`∑ge_buf„rs
(
∑gï
[0]);

377 
i
 = 0; i < 
d©a_off£t_ö_∑ge
; i++)

378 
bh
 = bh->
b_this_∑ge
;

379 
i
 = 0; i < 
block_Àn_ö_∑ge
; i++) {

380 *
îr
 = 
	`pxt4_gë_block
(
‹ig_öode
, 
‹ig_blk_off£t
 + 
i
, 
bh
, 0);

381 i‡(*
îr
 < 0)

383 
bh
 = bh->
b_this_∑ge
;

385 i‡(!*
îr
)

386 *
îr
 = 
	`block_commô_wrôe
(
∑gï
[0], 
‰om
, from + 
ª∂a˚d_size
);

388 i‡(
	`u∆ikñy
(*
îr
 < 0))

389 
ª∑ú_bønches
;

393 *
îr
 = 
	`pxt4_jbd3_öode_add_wrôe
(
h™dÀ
, 
‹ig_öode
,

394 (
loff_t
)
‹ig_∑ge_off£t
 << 
PAGE_SHIFT
, 
ª∂a˚d_size
);

396 
u∆ock_∑ges
:

397 
	`u∆ock_∑ge
(
∑gï
[0]);

398 
	`put_∑ge
(
∑gï
[0]);

399 
	`u∆ock_∑ge
(
∑gï
[1]);

400 
	`put_∑ge
(
∑gï
[1]);

401 
°›_jou∫Æ
:

402 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

403 i‡(*
îr
 =-
ENOSPC
 &&

404 
	`pxt4_should_ªåy_Æloc
(
sb
, &
ªåõs
))

405 
agaö
;

408 i‡(*
îr
 =-
EBUSY
 && 
ªåõs
++ < 4 && 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

409 
	`jbd3_jou∫Æ_f‹˚_commô_√°ed
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
))

410 
agaö
;

411  
ª∂a˚d_cou¡
;

413 
ª∑ú_bønches
:

419 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

420 
ª∂a˚d_cou¡
 = 
	`pxt4_sw≠_exã¡s
(
h™dÀ
, 
d⁄‹_öode
, 
‹ig_öode
,

421 
‹ig_blk_off£t
, 
d⁄‹_blk_off£t
,

422 
block_Àn_ö_∑ge
, 0, &
îr2
);

423 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

424 i‡(
ª∂a˚d_cou¡
 !
block_Àn_ö_∑ge
) {

425 
	`PXT4_ERROR_INODE_BLOCK
(
‹ig_öode
, (
£˘‹_t
)(
‹ig_blk_off£t
),

428 *
îr
 = -
EIO
;

430 
ª∂a˚d_cou¡
 = 0;

431 
u∆ock_∑ges
;

432 
	}
}

448 
	$mext_check_¨gumíts
(
öode
 *
‹ig_öode
,

449 
öode
 *
d⁄‹_öode
, 
__u64
 
‹ig_°¨t
,

450 
__u64
 
d⁄‹_°¨t
, __u64 *
Àn
)

452 
__u64
 
‹ig_eof
, 
d⁄‹_eof
;

453 
blkbôs
 = 
‹ig_öode
->
i_blkbôs
;

454 
blocksize
 = 1 << 
blkbôs
;

456 
‹ig_eof
 = (
	`i_size_ªad
(
‹ig_öode
Ë+ 
blocksize
 - 1Ë>> 
blkbôs
;

457 
d⁄‹_eof
 = (
	`i_size_ªad
(
d⁄‹_öode
Ë+ 
blocksize
 - 1Ë>> 
blkbôs
;

460 i‡(
d⁄‹_öode
->
i_mode
 & (
S_ISUID
|
S_ISGID
)) {

461 
	`pxt4_debug
("pxt4 moveÉxtent: suid or sgid is set"

463 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

464  -
EINVAL
;

467 i‡(
	`IS_IMMUTABLE
(
d⁄‹_öode
Ë|| 
	`IS_APPEND
(donor_inode))

468  -
EPERM
;

471 i‡(
	`IS_SWAPFILE
(
‹ig_öode
Ë|| IS_SWAPFILE(
d⁄‹_öode
)) {

472 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files should "

474 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

475  -
EBUSY
;

478 i‡(
	`pxt4_is_quŸa_fûe
(
‹ig_öode
Ë&&Öxt4_is_quŸa_fûe(
d⁄‹_öode
)) {

479 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files should "

481 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

482  -
EBUSY
;

486 i‡(!(
	`pxt4_ã°_öode_Êag
(
‹ig_öode
, 
PXT4_INODE_EXTENTS
))) {

487 
	`pxt4_debug
("pxt4 moveÉxtent: orig file isÇotÉxtents "

488 "ba£d fûê[öo:‹ig %lu]\n", 
‹ig_öode
->
i_öo
);

489  -
EOPNOTSUPP
;

490 } i‡(!(
	`pxt4_ã°_öode_Êag
(
d⁄‹_öode
, 
PXT4_INODE_EXTENTS
))) {

491 
	`pxt4_debug
("pxt4 moveÉxtent: donor file isÇotÉxtents "

492 "ba£d fûê[öo:d⁄‹ %lu]\n", 
d⁄‹_öode
->
i_öo
);

493  -
EOPNOTSUPP
;

496 i‡((!
‹ig_öode
->
i_size
Ë|| (!
d⁄‹_öode
->i_size)) {

497 
	`pxt4_debug
("pxt4 moveÉxtent: File size is 0 byte\n");

498  -
EINVAL
;

502 i‡((
‹ig_°¨t
 & ~(
PAGE_MASK
 >> 
‹ig_öode
->
i_blkbôs
)) !=

503 (
d⁄‹_°¨t
 & ~(
PAGE_MASK
 >> 
‹ig_öode
->
i_blkbôs
))) {

504 
	`pxt4_debug
("pxt4 moveÉxtent: origánd donor's start "

506 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

507  -
EINVAL
;

510 i‡((
‹ig_°¨t
 >
EXT_MAX_BLOCKS
) ||

511 (
d⁄‹_°¨t
 >
EXT_MAX_BLOCKS
) ||

512 (*
Àn
 > 
EXT_MAX_BLOCKS
) ||

513 (
d⁄‹_°¨t
 + *
Àn
 >
EXT_MAX_BLOCKS
) ||

514 (
‹ig_°¨t
 + *
Àn
 >
EXT_MAX_BLOCKS
)) {

515 
	`pxt4_debug
("pxt4 moveÉxtent: Can't handle over [%u] blocks "

516 "[öo:‹ig %lu, d⁄‹ %lu]\n", 
EXT_MAX_BLOCKS
,

517 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

518  -
EINVAL
;

520 i‡(
‹ig_eof
 <
‹ig_°¨t
)

521 *
Àn
 = 0;

522 i‡(
‹ig_eof
 < 
‹ig_°¨t
 + *
Àn
 - 1)

523 *
Àn
 = 
‹ig_eof
 - 
‹ig_°¨t
;

524 i‡(
d⁄‹_eof
 <
d⁄‹_°¨t
)

525 *
Àn
 = 0;

526 i‡(
d⁄‹_eof
 < 
d⁄‹_°¨t
 + *
Àn
 - 1)

527 *
Àn
 = 
d⁄‹_eof
 - 
d⁄‹_°¨t
;

528 i‡(!*
Àn
) {

529 
	`pxt4_debug
("pxt4 moveÉxtent:Üen shouldÇot be 0 "

530 "[öo:‹ig %lu, d⁄‹ %lu]\n", 
‹ig_öode
->
i_öo
,

531 
d⁄‹_öode
->
i_öo
);

532  -
EINVAL
;

536 
	}
}

553 
	$pxt4_move_exã¡s
(
fûe
 *
o_fûp
, fûê*
d_fûp
, 
__u64
 
‹ig_blk
,

554 
__u64
 
d⁄‹_blk
, __u64 
Àn
, __u64 *
moved_Àn
)

556 
öode
 *
‹ig_öode
 = 
	`fûe_öode
(
o_fûp
);

557 
öode
 *
d⁄‹_öode
 = 
	`fûe_öode
(
d_fûp
);

558 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

559 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 >> 
‹ig_öode
->
i_blkbôs
;

560 
pxt4_lblk_t
 
o_íd
, 
o_°¨t
 = 
‹ig_blk
;

561 
pxt4_lblk_t
 
d_°¨t
 = 
d⁄‹_blk
;

562 
ªt
;

564 i‡(
‹ig_öode
->
i_sb
 !
d⁄‹_öode
->i_sb) {

565 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files "

567 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

568  -
EINVAL
;

572 i‡(
‹ig_öode
 =
d⁄‹_öode
) {

573 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files shouldÇot "

575 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

576  -
EINVAL
;

580 i‡(!
	`S_ISREG
(
‹ig_öode
->
i_mode
Ë|| !S_ISREG(
d⁄‹_öode
->i_mode)) {

581 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files should be "

583 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

584  -
EINVAL
;

589 i‡(
	`pxt4_should_jou∫Æ_d©a
(
‹ig_öode
) ||

590 
	`pxt4_should_jou∫Æ_d©a
(
d⁄‹_öode
)) {

591 
	`pxt4_msg
(
‹ig_öode
->
i_sb
, 
KERN_ERR
,

593  -
EOPNOTSUPP
;

596 i‡(
	`IS_ENCRYPTED
(
‹ig_öode
Ë|| IS_ENCRYPTED(
d⁄‹_öode
)) {

597 
	`pxt4_msg
(
‹ig_öode
->
i_sb
, 
KERN_ERR
,

599  -
EOPNOTSUPP
;

603 
	`lock_two_n⁄dúe˘‹õs
(
‹ig_öode
, 
d⁄‹_öode
);

606 
	`öode_dio_waô
(
‹ig_öode
);

607 
	`öode_dio_waô
(
d⁄‹_öode
);

610 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

612 
ªt
 = 
	`mext_check_¨gumíts
(
‹ig_öode
, 
d⁄‹_öode
, 
‹ig_blk
,

613 
d⁄‹_blk
, &
Àn
);

614 i‡(
ªt
)

615 
out
;

616 
o_íd
 = 
o_°¨t
 + 
Àn
;

618 
o_°¨t
 < 
o_íd
) {

619 
pxt4_exã¡
 *
ex
;

620 
pxt4_lblk_t
 
cur_blk
, 
√xt_blk
;

621 
pgoff_t
 
‹ig_∑ge_ödex
, 
d⁄‹_∑ge_ödex
;

622 
off£t_ö_∑ge
;

623 
unwrôãn
, 
cur_Àn
;

625 
ªt
 = 
	`gë_ext_∑th
(
‹ig_öode
, 
o_°¨t
, &
∑th
);

626 i‡(
ªt
)

627 
out
;

628 
ex
 = 
∑th
[∑th->
p_dïth
].
p_ext
;

629 
√xt_blk
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

630 
cur_blk
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

631 
cur_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

633 i‡(
cur_blk
 + 
cur_Àn
 - 1 < 
o_°¨t
) {

634 i‡(
√xt_blk
 =
EXT_MAX_BLOCKS
) {

635 
o_°¨t
 = 
o_íd
;

636 
ªt
 = -
ENODATA
;

637 
out
;

639 
d_°¨t
 +
√xt_blk
 - 
o_°¨t
;

640 
o_°¨t
 = 
√xt_blk
;

643 } i‡(
cur_blk
 > 
o_°¨t
) {

645 
d_°¨t
 +
cur_blk
 - 
o_°¨t
;

646 
o_°¨t
 = 
cur_blk
;

648 i‡(
cur_blk
 >
o_íd
)

649 
out
;

651 
cur_Àn
 +
cur_blk
 - 
o_°¨t
;

653 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

654 i‡(
o_íd
 - 
o_°¨t
 < 
cur_Àn
)

655 
cur_Àn
 = 
o_íd
 - 
o_°¨t
;

657 
‹ig_∑ge_ödex
 = 
o_°¨t
 >> (
PAGE_SHIFT
 -

658 
‹ig_öode
->
i_blkbôs
);

659 
d⁄‹_∑ge_ödex
 = 
d_°¨t
 >> (
PAGE_SHIFT
 -

660 
d⁄‹_öode
->
i_blkbôs
);

661 
off£t_ö_∑ge
 = 
o_°¨t
 % 
blocks_≥r_∑ge
;

662 i‡(
cur_Àn
 > 
blocks_≥r_∑ge
- 
off£t_ö_∑ge
)

663 
cur_Àn
 = 
blocks_≥r_∑ge
 - 
off£t_ö_∑ge
;

671 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

673 
	`move_exã¡_≥r_∑ge
(
o_fûp
, 
d⁄‹_öode
,

674 
‹ig_∑ge_ödex
, 
d⁄‹_∑ge_ödex
,

675 
off£t_ö_∑ge
, 
cur_Àn
,

676 
unwrôãn
, &
ªt
);

677 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

678 i‡(
ªt
 < 0)

680 
o_°¨t
 +
cur_Àn
;

681 
d_°¨t
 +
cur_Àn
;

683 *
moved_Àn
 = 
o_°¨t
 - 
‹ig_blk
;

684 i‡(*
moved_Àn
 > 
Àn
)

685 *
moved_Àn
 = 
Àn
;

687 
out
:

688 i‡(*
moved_Àn
) {

689 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
‹ig_öode
);

690 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
d⁄‹_öode
);

693 
	`pxt4_ext_dr›_ªfs
(
∑th
);

694 
	`k‰ì
(
∑th
);

695 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

696 
	`u∆ock_two_n⁄dúe˘‹õs
(
‹ig_öode
, 
d⁄‹_öode
);

698  
ªt
;

699 
	}
}

	@namei.c

28 
	~<löux/fs.h
>

29 
	~<löux/∑gem≠.h
>

30 
	~<löux/time.h
>

31 
	~<löux/f˙é.h
>

32 
	~<löux/°©.h
>

33 
	~<löux/°rög.h
>

34 
	~<löux/quŸa›s.h
>

35 
	~<löux/buf„r_hód.h
>

36 
	~<löux/bio.h
>

37 
	~<löux/ivîsi⁄.h
>

38 
	~<löux/unicode.h
>

39 
	~"pxt4.h
"

40 
	~"pxt4_jbd3.h
"

42 
	~"x©å.h
"

43 
	~"a˛.h
"

45 
	~<åa˚/evíts/pxt4.h
>

49 
	#NAMEI_RA_CHUNKS
 2

	)

50 
	#NAMEI_RA_BLOCKS
 4

	)

51 
	#NAMEI_RA_SIZE
 (
NAMEI_RA_CHUNKS
 * 
NAMEI_RA_BLOCKS
)

	)

53 
buf„r_hód
 *
	$pxt4_≠≥nd
(
h™dÀ_t
 *
h™dÀ
,

54 
öode
 *inode,

55 
pxt4_lblk_t
 *
block
)

57 
buf„r_hód
 *
bh
;

58 
îr
;

60 i‡(
	`u∆ikñy
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_max_dú_size_kb
 &&

61 ((
öode
->
i_size
 >> 10) >=

62 
	`PXT4_SB
(
öode
->
i_sb
)->
s_max_dú_size_kb
)))

63  
	`ERR_PTR
(-
ENOSPC
);

65 *
block
 = 
öode
->
i_size
 >> inode->
i_sb
->
s_blocksize_bôs
;

67 
bh
 = 
	`pxt4_bªad
(
h™dÀ
, 
öode
, *
block
, 
PXT4_GET_BLOCKS_CREATE
);

68 i‡(
	`IS_ERR
(
bh
))

69  
bh
;

70 
öode
->
i_size
 +öode->
i_sb
->
s_blocksize
;

71 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

72 
	`BUFFER_TRACE
(
bh
, "get_write_access");

73 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

74 i‡(
îr
) {

75 
	`bªl£
(
bh
);

76 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

77  
	`ERR_PTR
(
îr
);

79  
bh
;

80 
	}
}

82 
pxt4_dx_csum_vîify
(
öode
 *inode,

83 
pxt4_dú_íåy
 *
dúít
);

96 
	mEITHER
, 
	mINDEX
, 
	mDIRENT
, 
	mDIRENT_HTREE


97 } 
	tdúblock_ty≥_t
;

99 
	#pxt4_ªad_dúblock
(
öode
, 
block
, 
ty≥
) \

100 
	`__pxt4_ªad_dúblock
((
öode
), (
block
), (
ty≥
), 
__func__
, 
__LINE__
)

	)

102 
buf„r_hód
 *
	$__pxt4_ªad_dúblock
(
öode
 *inode,

103 
pxt4_lblk_t
 
block
,

104 
dúblock_ty≥_t
 
ty≥
,

105 c⁄° *
func
,

106 
löe
)

108 
buf„r_hód
 *
bh
;

109 
pxt4_dú_íåy
 *
dúít
;

110 
is_dx_block
 = 0;

112 
bh
 = 
	`pxt4_bªad
(
NULL
, 
öode
, 
block
, 0);

113 i‡(
	`IS_ERR
(
bh
)) {

114 
	`__pxt4_w¨nög
(
öode
->
i_sb
, 
func
, 
löe
,

117 
öode
->
i_öo
, ()
block
,

118 
cuºít
->
comm
, 
	`PTR_ERR
(
bh
));

120  
bh
;

122 i‡(!
bh
 && (
ty≥
 =
INDEX
 ||Åy≥ =
DIRENT_HTREE
)) {

123 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

125 (
ty≥
 =
INDEX
) ? "index" : "leaf");

126  
	`ERR_PTR
(-
EFSCORRUPTED
);

128 i‡(!
bh
)

129  
NULL
;

130 
dúít
 = (
pxt4_dú_íåy
 *Ë
bh
->
b_d©a
;

132 i‡(
	`is_dx
(
öode
)) {

133 i‡(
block
 == 0)

134 
is_dx_block
 = 1;

135 i‡(
	`pxt4_ªc_Àn_‰om_disk
(
dúít
->
ªc_Àn
,

136 
öode
->
i_sb
->
s_blocksize
) ==

137 
öode
->
i_sb
->
s_blocksize
)

138 
is_dx_block
 = 1;

140 i‡(!
is_dx_block
 && 
ty≥
 =
INDEX
) {

141 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

143 
	`bªl£
(
bh
);

144  
	`ERR_PTR
(-
EFSCORRUPTED
);

146 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
) ||

147 
	`buf„r_vîifõd
(
bh
))

148  
bh
;

155 i‡(
is_dx_block
 && 
ty≥
 =
INDEX
) {

156 i‡(
	`pxt4_dx_csum_vîify
(
öode
, 
dúít
))

157 
	`£t_buf„r_vîifõd
(
bh
);

159 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

161 
	`bªl£
(
bh
);

162  
	`ERR_PTR
(-
EFSBADCRC
);

165 i‡(!
is_dx_block
) {

166 i‡(
	`pxt4_dúblock_csum_vîify
(
öode
, 
bh
))

167 
	`£t_buf„r_vîifõd
(
bh
);

169 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

171 
	`bªl£
(
bh
);

172  
	`ERR_PTR
(-
EFSBADCRC
);

175  
bh
;

176 
	}
}

178 #i‚de‡
as£π


179 
	#as£π
(
ã°
Ë
	`J_ASSERT
—e°)

	)

182 #ifde‡
DX_DEBUG


183 
	#dxåa˚
(
comm™d
Ë
	)
command

185 
	#dxåa˚
(
comm™d
)

	)

188 
	sÁke_dúít


190 
__À32
 
	möode
;

191 
__À16
 
	mªc_Àn
;

192 
u8
 
	m«me_Àn
;

193 
u8
 
	mfûe_ty≥
;

196 
	sdx_cou¡limô


198 
__À16
 
	mlimô
;

199 
__À16
 
	mcou¡
;

202 
	sdx_íåy


204 
__À32
 
	mhash
;

205 
__À32
 
	mblock
;

214 
	sdx_roŸ


216 
Áke_dúít
 
	mdŸ
;

217 
	mdŸ_«me
[4];

218 
Áke_dúít
 
	mdŸdŸ
;

219 
	mdŸdŸ_«me
[4];

220 
	sdx_roŸ_öfo


222 
__À32
 
	mª£rved_zîo
;

223 
u8
 
	mhash_vîsi⁄
;

224 
u8
 
	möfo_Àngth
;

225 
u8
 
	mödúe˘_Àvñs
;

226 
u8
 
	munu£d_Êags
;

228 
	möfo
;

229 
dx_íåy
 
	míåõs
[0];

232 
	sdx_node


234 
Áke_dúít
 
	mÁke
;

235 
dx_íåy
 
	míåõs
[0];

239 
	sdx_‰ame


241 
buf„r_hód
 *
	mbh
;

242 
dx_íåy
 *
	míåõs
;

243 
dx_íåy
 *
	m©
;

246 
	sdx_m≠_íåy


248 
u32
 
	mhash
;

249 
u16
 
	moffs
;

250 
u16
 
	msize
;

256 
	sdx_èû
 {

257 
u32
 
	mdt_ª£rved
;

258 
__À32
 
	mdt_checksum
;

261 
ölöe
 
pxt4_lblk_t
 
dx_gë_block
(
dx_íåy
 *
íåy
);

262 
dx_£t_block
(
dx_íåy
 *
íåy
, 
pxt4_lblk_t
 
vÆue
);

263 
ölöe
 
dx_gë_hash
(
dx_íåy
 *
íåy
);

264 
dx_£t_hash
(
dx_íåy
 *
íåy
, 
vÆue
);

265 
dx_gë_cou¡
(
dx_íåy
 *
íåõs
);

266 
dx_gë_limô
(
dx_íåy
 *
íåõs
);

267 
dx_£t_cou¡
(
dx_íåy
 *
íåõs
, 
vÆue
);

268 
dx_£t_limô
(
dx_íåy
 *
íåõs
, 
vÆue
);

269 
dx_roŸ_limô
(
öode
 *
dú
, 
öfosize
);

270 
dx_node_limô
(
öode
 *
dú
);

271 
dx_‰ame
 *
dx_¥obe
(
pxt4_fûíame
 *
‚ame
,

272 
öode
 *
dú
,

273 
dx_hash_öfo
 *
höfo
,

274 
dx_‰ame
 *
‰ame
);

275 
dx_ªÀa£
(
dx_‰ame
 *
‰ames
);

276 
dx_make_m≠
(
öode
 *
dú
, 
pxt4_dú_íåy_2
 *
de
,

277 
blocksize
, 
dx_hash_öfo
 *
höfo
,

278 
dx_m≠_íåy
 
m≠
[]);

279 
dx_s‹t_m≠
(
dx_m≠_íåy
 *
m≠
, 
cou¡
);

280 
pxt4_dú_íåy_2
 *
dx_move_dúíts
(*
‰om
, *
to
,

281 
dx_m≠_íåy
 *
off£ts
, 
cou¡
, 
blocksize
);

282 
pxt4_dú_íåy_2
* 
dx_∑ck_dúíts
(*
ba£
, 
blocksize
);

283 
dx_ö£π_block
(
dx_‰ame
 *
‰ame
,

284 
u32
 
hash
, 
pxt4_lblk_t
 
block
);

285 
pxt4_håì_√xt_block
(
öode
 *
dú
, 
__u32
 
hash
,

286 
dx_‰ame
 *
‰ame
,

287 
dx_‰ame
 *
‰ames
,

288 
__u32
 *
°¨t_hash
);

289 
buf„r_hód
 * 
pxt4_dx_föd_íåy
(
öode
 *
dú
,

290 
pxt4_fûíame
 *
‚ame
,

291 
pxt4_dú_íåy_2
 **
ªs_dú
);

292 
pxt4_dx_add_íåy
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

293 
öode
 *
dú
, inode *inode);

296 
	$pxt4_öôülize_dúít_èû
(
buf„r_hód
 *
bh
,

297 
blocksize
)

299 
pxt4_dú_íåy_èû
 *
t
 = 
	`PXT4_DIRENT_TAIL
(
bh
->
b_d©a
, 
blocksize
);

301 
	`mem£t
(
t
, 0, (
pxt4_dú_íåy_èû
));

302 
t
->
dë_ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

303 (
pxt4_dú_íåy_èû
), 
blocksize
);

304 
t
->
dë_ª£rved_·
 = 
PXT4_FT_DIR_CSUM
;

305 
	}
}

308 
pxt4_dú_íåy_èû
 *
	$gë_dúít_èû
(
öode
 *inode,

309 
buf„r_hód
 *
bh
)

311 
pxt4_dú_íåy_èû
 *
t
;

313 #ifde‡
PARANOID


314 
pxt4_dú_íåy
 *
d
, *
t›
;

316 
d
 = (
pxt4_dú_íåy
 *)
bh
->
b_d©a
;

317 
t›
 = (
pxt4_dú_íåy
 *)(
bh
->
b_d©a
 +

318 (
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
) -

319 (
pxt4_dú_íåy_èû
)));

320 
d
 < 
t›
 && d->
ªc_Àn
)

321 
d
 = (
pxt4_dú_íåy
 *)(((*)d) +

322 
	`À16_to_˝u
(
d
->
ªc_Àn
));

324 i‡(
d
 !
t›
)

325  
NULL
;

327 
t
 = (
pxt4_dú_íåy_èû
 *)
d
;

329 
t
 = 
	`PXT4_DIRENT_TAIL
(
bh
->
b_d©a
, 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
));

332 i‡(
t
->
dë_ª£rved_zîo1
 ||

333 
	`À16_to_˝u
(
t
->
dë_ªc_Àn
Ë!(
pxt4_dú_íåy_èû
) ||

334 
t
->
dë_ª£rved_zîo2
 ||

335 
t
->
dë_ª£rved_·
 !
PXT4_FT_DIR_CSUM
)

336  
NULL
;

338  
t
;

339 
	}
}

341 
__À32
 
	$pxt4_dúblock_csum
(
öode
 *öode, *
dúít
, 
size
)

343 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

344 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

345 
__u32
 
csum
;

347 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
dúít
, 
size
);

348  
	`˝u_to_À32
(
csum
);

349 
	}
}

351 
	#w¨n_no_•a˚_f‹_csum
(
öode
) \

352 
	`__w¨n_no_•a˚_f‹_csum
((
öode
), 
__func__
, 
__LINE__
)

	)

354 
	$__w¨n_no_•a˚_f‹_csum
(
öode
 *öode, c⁄° *
func
,

355 
löe
)

357 
	`__pxt4_w¨nög_öode
(
öode
, 
func
, 
löe
,

359 
	}
}

361 
	$pxt4_dúblock_csum_vîify
(
öode
 *öode, 
buf„r_hód
 *
bh
)

363 
pxt4_dú_íåy_èû
 *
t
;

365 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

368 
t
 = 
	`gë_dúít_èû
(
öode
, 
bh
);

369 i‡(!
t
) {

370 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

374 i‡(
t
->
dë_checksum
 !
	`pxt4_dúblock_csum
(
öode
, 
bh
->
b_d©a
,

375 (*)
t
 - 
bh
->
b_d©a
))

379 
	}
}

381 
	$pxt4_dúblock_csum_£t
(
öode
 *inode,

382 
buf„r_hód
 *
bh
)

384 
pxt4_dú_íåy_èû
 *
t
;

386 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

389 
t
 = 
	`gë_dúít_èû
(
öode
, 
bh
);

390 i‡(!
t
) {

391 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

395 
t
->
dë_checksum
 = 
	`pxt4_dúblock_csum
(
öode
, 
bh
->
b_d©a
,

396 (*)
t
 - 
bh
->
b_d©a
);

397 
	}
}

399 
	$pxt4_h™dÀ_dúty_dúblock
(
h™dÀ_t
 *
h™dÀ
,

400 
öode
 *inode,

401 
buf„r_hód
 *
bh
)

403 
	`pxt4_dúblock_csum_£t
(
öode
, 
bh
);

404  
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

405 
	}
}

407 
dx_cou¡limô
 *
	$gë_dx_cou¡limô
(
öode
 *inode,

408 
pxt4_dú_íåy
 *
dúít
,

409 *
off£t
)

411 
pxt4_dú_íåy
 *
dp
;

412 
dx_roŸ_öfo
 *
roŸ
;

413 
cou¡_off£t
;

415 i‡(
	`À16_to_˝u
(
dúít
->
ªc_Àn
Ë=
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
))

416 
cou¡_off£t
 = 8;

417 i‡(
	`À16_to_˝u
(
dúít
->
ªc_Àn
) == 12) {

418 
dp
 = (
pxt4_dú_íåy
 *)(((*)
dúít
) + 12);

419 i‡(
	`À16_to_˝u
(
dp
->
ªc_Àn
) !=

420 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
) - 12)

421  
NULL
;

422 
roŸ
 = (
dx_roŸ_öfo
 *)(((*)
dp
 + 12));

423 i‡(
roŸ
->
ª£rved_zîo
 ||

424 
roŸ
->
öfo_Àngth
 !(
dx_roŸ_öfo
))

425  
NULL
;

426 
cou¡_off£t
 = 32;

428  
NULL
;

430 i‡(
off£t
)

431 *
off£t
 = 
cou¡_off£t
;

432  (
dx_cou¡limô
 *)(((*)
dúít
Ë+ 
cou¡_off£t
);

433 
	}
}

435 
__À32
 
	$pxt4_dx_csum
(
öode
 *öode, 
pxt4_dú_íåy
 *
dúít
,

436 
cou¡_off£t
, 
cou¡
, 
dx_èû
 *
t
)

438 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

439 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

440 
__u32
 
csum
;

441 
size
;

442 
__u32
 
dummy_csum
 = 0;

443 
off£t
 = 
	`off£tof
(
dx_èû
, 
dt_checksum
);

445 
size
 = 
cou¡_off£t
 + (
cou¡
 * (
dx_íåy
));

446 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
dúít
, 
size
);

447 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
t
, 
off£t
);

448 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, (dummy_csum));

450  
	`˝u_to_À32
(
csum
);

451 
	}
}

453 
	$pxt4_dx_csum_vîify
(
öode
 *inode,

454 
pxt4_dú_íåy
 *
dúít
)

456 
dx_cou¡limô
 *
c
;

457 
dx_èû
 *
t
;

458 
cou¡_off£t
, 
limô
, 
cou¡
;

460 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

463 
c
 = 
	`gë_dx_cou¡limô
(
öode
, 
dúít
, &
cou¡_off£t
);

464 i‡(!
c
) {

465 
	`PXT4_ERROR_INODE
(
öode
, "dir seems corrupt? RunÉ2fsck -D.");

468 
limô
 = 
	`À16_to_˝u
(
c
->limit);

469 
cou¡
 = 
	`À16_to_˝u
(
c
->count);

470 i‡(
cou¡_off£t
 + (
limô
 * (
dx_íåy
)) >

471 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
Ë- (
dx_èû
)) {

472 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

475 
t
 = (
dx_èû
 *)(((
dx_íåy
 *)
c
Ë+ 
limô
);

477 i‡(
t
->
dt_checksum
 !
	`pxt4_dx_csum
(
öode
, 
dúít
, 
cou¡_off£t
,

478 
cou¡
, 
t
))

481 
	}
}

483 
	$pxt4_dx_csum_£t
(
öode
 *öode, 
pxt4_dú_íåy
 *
dúít
)

485 
dx_cou¡limô
 *
c
;

486 
dx_èû
 *
t
;

487 
cou¡_off£t
, 
limô
, 
cou¡
;

489 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

492 
c
 = 
	`gë_dx_cou¡limô
(
öode
, 
dúít
, &
cou¡_off£t
);

493 i‡(!
c
) {

494 
	`PXT4_ERROR_INODE
(
öode
, "dir seems corrupt? RunÉ2fsck -D.");

497 
limô
 = 
	`À16_to_˝u
(
c
->limit);

498 
cou¡
 = 
	`À16_to_˝u
(
c
->count);

499 i‡(
cou¡_off£t
 + (
limô
 * (
dx_íåy
)) >

500 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
Ë- (
dx_èû
)) {

501 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

504 
t
 = (
dx_èû
 *)(((
dx_íåy
 *)
c
Ë+ 
limô
);

506 
t
->
dt_checksum
 = 
	`pxt4_dx_csum
(
öode
, 
dúít
, 
cou¡_off£t
, 
cou¡
,Å);

507 
	}
}

509 
ölöe
 
	$pxt4_h™dÀ_dúty_dx_node
(
h™dÀ_t
 *
h™dÀ
,

510 
öode
 *inode,

511 
buf„r_hód
 *
bh
)

513 
	`pxt4_dx_csum_£t
(
öode
, (
pxt4_dú_íåy
 *)
bh
->
b_d©a
);

514  
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

515 
	}
}

520 
ölöe
 
pxt4_dú_íåy_2
 *

521 
	$pxt4_√xt_íåy
(
pxt4_dú_íåy_2
 *
p
, 
blocksize
)

523  (
pxt4_dú_íåy_2
 *)((*)
p
 +

524 
	`pxt4_ªc_Àn_‰om_disk
(
p
->
ªc_Àn
, 
blocksize
));

525 
	}
}

532 
ölöe
 
pxt4_lblk_t
 
	$dx_gë_block
(
dx_íåy
 *
íåy
)

534  
	`À32_to_˝u
(
íåy
->
block
) & 0x0fffffff;

535 
	}
}

537 
ölöe
 
	$dx_£t_block
(
dx_íåy
 *
íåy
, 
pxt4_lblk_t
 
vÆue
)

539 
íåy
->
block
 = 
	`˝u_to_À32
(
vÆue
);

540 
	}
}

542 
ölöe
 
	$dx_gë_hash
(
dx_íåy
 *
íåy
)

544  
	`À32_to_˝u
(
íåy
->
hash
);

545 
	}
}

547 
ölöe
 
	$dx_£t_hash
(
dx_íåy
 *
íåy
, 
vÆue
)

549 
íåy
->
hash
 = 
	`˝u_to_À32
(
vÆue
);

550 
	}
}

552 
ölöe
 
	$dx_gë_cou¡
(
dx_íåy
 *
íåõs
)

554  
	`À16_to_˝u
(((
dx_cou¡limô
 *Ë
íåõs
)->
cou¡
);

555 
	}
}

557 
ölöe
 
	$dx_gë_limô
(
dx_íåy
 *
íåõs
)

559  
	`À16_to_˝u
(((
dx_cou¡limô
 *Ë
íåõs
)->
limô
);

560 
	}
}

562 
ölöe
 
	$dx_£t_cou¡
(
dx_íåy
 *
íåõs
, 
vÆue
)

564 ((
dx_cou¡limô
 *Ë
íåõs
)->
cou¡
 = 
	`˝u_to_À16
(
vÆue
);

565 
	}
}

567 
ölöe
 
	$dx_£t_limô
(
dx_íåy
 *
íåõs
, 
vÆue
)

569 ((
dx_cou¡limô
 *Ë
íåõs
)->
limô
 = 
	`˝u_to_À16
(
vÆue
);

570 
	}
}

572 
ölöe
 
	$dx_roŸ_limô
(
öode
 *
dú
, 
öfosize
)

574 
íåy_•a˚
 = 
dú
->
i_sb
->
s_blocksize
 - 
	`PXT4_DIR_REC_LEN
(1) -

575 
	`PXT4_DIR_REC_LEN
(2Ë- 
öfosize
;

577 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

578 
íåy_•a˚
 -(
dx_èû
);

579  
íåy_•a˚
 / (
dx_íåy
);

580 
	}
}

582 
ölöe
 
	$dx_node_limô
(
öode
 *
dú
)

584 
íåy_•a˚
 = 
dú
->
i_sb
->
s_blocksize
 - 
	`PXT4_DIR_REC_LEN
(0);

586 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

587 
íåy_•a˚
 -(
dx_èû
);

588  
íåy_•a˚
 / (
dx_íåy
);

589 
	}
}

594 #ifde‡
DX_DEBUG


595 
	$dx_show_ödex
(* 
œbñ
, 
dx_íåy
 *
íåõs
)

597 
i
, 
n
 = 
	`dx_gë_cou¡
 (
íåõs
);

598 
	`¥ötk
(
KERN_DEBUG
 "%†ödex", 
œbñ
);

599 
i
 = 0; i < 
n
; i++) {

600 
	`¥ötk
(
KERN_CONT
 " %x->%lu",

601 
i
 ? 
	`dx_gë_hash
(
íåõs
 + i) : 0,

602 ()
	`dx_gë_block
(
íåõs
 + 
i
));

604 
	`¥ötk
(
KERN_CONT
 "\n");

605 
	}
}

607 
	s°©s


609 
	m«mes
;

610 
	m•a˚
;

611 
	mbcou¡
;

614 
°©s
 
	$dx_show_Àaf
(
öode
 *
dú
,

615 
dx_hash_öfo
 *
höfo
,

616 
pxt4_dú_íåy_2
 *
de
,

617 
size
, 
show_«mes
)

619 
«mes
 = 0, 
•a˚
 = 0;

620 *
ba£
 = (*Ë
de
;

621 
dx_hash_öfo
 
h
 = *
höfo
;

623 
	`¥ötk
("names: ");

624 (*Ë
de
 < 
ba£
 + 
size
)

626 i‡(
de
->
öode
)

628 i‡(
show_«mes
)

630 #ifde‡
CONFIG_FS_ENCRYPTION


631 
Àn
;

632 *
«me
;

633 
fs¸y±_°r
 
‚ame_¸y±o_°r
 =

634 
	`FSTR_INIT
(
NULL
, 0);

635 
ªs
 = 0;

637 
«me
 = 
de
->name;

638 
Àn
 = 
de
->
«me_Àn
;

639 i‡(
	`IS_ENCRYPTED
(
dú
))

640 
ªs
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
dú
);

641 i‡(
ªs
) {

642 
	`¥ötk
(
KERN_WARNING
 "Error setting up"

643 " f«mê¸y±o: %d\n", 
ªs
);

645 i‡(!
	`fs¸y±_has_í¸y±i⁄_key
(
dú
)) {

647 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
,

648 
de
->
«me_Àn
, &
h
);

649 
	`¥ötk
("%*.s:(U)%x.%u ", 
Àn
,

650 
«me
, 
h
.
hash
,

651 (Ë((*Ë
de


652 - 
ba£
));

654 
fs¸y±_°r
 
de_«me
 =

655 
	`FSTR_INIT
(
«me
, 
Àn
);

658 
ªs
 = 
	`fs¸y±_‚ame_Æloc_buf„r
(

659 
dú
, 
Àn
,

660 &
‚ame_¸y±o_°r
);

661 i‡(
ªs
)

662 
	`¥ötk
(
KERN_WARNING
 "Error "

666 
ªs
 = 
	`fs¸y±_‚ame_disk_to_u§
(
dú
,

667 0, 0, &
de_«me
,

668 &
‚ame_¸y±o_°r
);

669 i‡(
ªs
) {

670 
	`¥ötk
(
KERN_WARNING
 "Error "

674 
«me
 = "??";

675 
Àn
 = 2;

677 
«me
 = 
‚ame_¸y±o_°r
.name;

678 
Àn
 = 
‚ame_¸y±o_°r
.len;

680 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
,

681 
de
->
«me_Àn
, &
h
);

682 
	`¥ötk
("%*.s:(E)%x.%u ", 
Àn
, 
«me
,

683 
h
.
hash
, (Ë((*Ë
de


684 - 
ba£
));

685 
	`fs¸y±_‚ame_‰ì_buf„r
(

686 &
‚ame_¸y±o_°r
);

689 
Àn
 = 
de
->
«me_Àn
;

690 *
«me
 = 
de
->name;

691 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
, de->
«me_Àn
, &
h
);

692 
	`¥ötk
("%*.s:%x.%u ", 
Àn
, 
«me
, 
h
.
hash
,

693 (Ë((*Ë
de
 - 
ba£
));

696 
•a˚
 +
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

697 
«mes
++;

699 
de
 = 
	`pxt4_√xt_íåy
(de, 
size
);

701 
	`¥ötk
(
KERN_CONT
 "(%i)\n", 
«mes
);

702  (
°©s
Ë{ 
«mes
, 
•a˚
, 1 };

703 
	}
}

705 
°©s
 
	$dx_show_íåõs
(
dx_hash_öfo
 *
höfo
, 
öode
 *
dú
,

706 
dx_íåy
 *
íåõs
, 
Àvñs
)

708 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

709 
cou¡
 = 
	`dx_gë_cou¡
(
íåõs
), 
«mes
 = 0, 
•a˚
 = 0, 
i
;

710 
bcou¡
 = 0;

711 
buf„r_hód
 *
bh
;

712 
	`¥ötk
("%òödexed blocks...\n", 
cou¡
);

713 
i
 = 0; i < 
cou¡
; i++, 
íåõs
++)

715 
pxt4_lblk_t
 
block
 = 
	`dx_gë_block
(
íåõs
);

716 
pxt4_lblk_t
 
hash
 = 
i
 ? 
	`dx_gë_hash
(
íåõs
): 0;

717 
u32
 
ønge
 = 
i
 < 
cou¡
 - 1? (
	`dx_gë_hash
(
íåõs
 + 1Ë- 
hash
): ~hash;

718 
°©s
 stats;

719 
	`¥ötk
("%s%3u:%03u hash %8x/%8x ",
Àvñs
?"":" ", 
i
, 
block
, 
hash
, 
ønge
);

720 
bh
 = 
	`pxt4_bªad
(
NULL
,
dú
, 
block
, 0);

721 i‡(!
bh
 || 
	`IS_ERR
(bh))

723 
°©s
 = 
Àvñs
?

724 
	`dx_show_íåõs
(
höfo
, 
dú
, ((
dx_node
 *Ë
bh
->
b_d©a
)->
íåõs
, 
Àvñs
 - 1):

725 
	`dx_show_Àaf
(
dú
, 
höfo
, (
pxt4_dú_íåy_2
 *)

726 
bh
->
b_d©a
, 
blocksize
, 0);

727 
«mes
 +
°©s
.names;

728 
•a˚
 +
°©s
.space;

729 
bcou¡
 +
°©s
.bcount;

730 
	`bªl£
(
bh
);

732 i‡(
bcou¡
)

733 
	`¥ötk
(
KERN_DEBUG
 "%snames %u, fullness %u (%u%%)\n",

734 
Àvñs
 ? "" : " ", 
«mes
, 
•a˚
/
bcou¡
,

735 (
•a˚
/
bcou¡
)*100/
blocksize
);

736  (
°©s
Ë{ 
«mes
, 
•a˚
, 
bcou¡
};

737 
	}
}

749 
dx_‰ame
 *

750 
	$dx_¥obe
(
pxt4_fûíame
 *
‚ame
, 
öode
 *
dú
,

751 
dx_hash_öfo
 *
höfo
, 
dx_‰ame
 *
‰ame_ö
)

753 
cou¡
, 
ödúe˘
;

754 
dx_íåy
 *
©
, *
íåõs
, *
p
, *
q
, *
m
;

755 
dx_roŸ
 *
roŸ
;

756 
dx_‰ame
 *
‰ame
 = 
‰ame_ö
;

757 
dx_‰ame
 *
ªt_îr
 = 
	`ERR_PTR
(
ERR_BAD_DX_DIR
);

758 
u32
 
hash
;

760 
	`mem£t
(
‰ame_ö
, 0, 
PXT4_HTREE_LEVEL
 * (frame_in[0]));

761 
‰ame
->
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 0, 
INDEX
);

762 i‡(
	`IS_ERR
(
‰ame
->
bh
))

763  (
dx_‰ame
 *Ë
‰ame
->
bh
;

765 
roŸ
 = (
dx_roŸ
 *Ë
‰ame
->
bh
->
b_d©a
;

766 i‡(
roŸ
->
öfo
.
hash_vîsi⁄
 !
DX_HASH_TEA
 &&

767 
roŸ
->
öfo
.
hash_vîsi⁄
 !
DX_HASH_HALF_MD4
 &&

768 
roŸ
->
öfo
.
hash_vîsi⁄
 !
DX_HASH_LEGACY
) {

769 
	`pxt4_w¨nög_öode
(
dú
, "Unrecognised inode hash code %u",

770 
roŸ
->
öfo
.
hash_vîsi⁄
);

771 
Áû
;

773 i‡(
‚ame
)

774 
höfo
 = &
‚ame
->hinfo;

775 
höfo
->
hash_vîsi⁄
 = 
roŸ
->
öfo
.hash_version;

776 i‡(
höfo
->
hash_vîsi⁄
 <
DX_HASH_TEA
)

777 
höfo
->
hash_vîsi⁄
 +
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_unsig√d
;

778 
höfo
->
£ed
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_£ed
;

779 i‡(
‚ame
 && 
	`‚ame_«me
(fname))

780 
	`pxt4fs_dúhash
(
dú
, 
	`‚ame_«me
(
‚ame
), 
	`‚ame_Àn
(‚ame), 
höfo
);

781 
hash
 = 
höfo
->hash;

783 i‡(
roŸ
->
öfo
.
unu£d_Êags
 & 1) {

784 
	`pxt4_w¨nög_öode
(
dú
, "Unimplemented hash flags: %#06x",

785 
roŸ
->
öfo
.
unu£d_Êags
);

786 
Áû
;

789 
ödúe˘
 = 
roŸ
->
öfo
.
ödúe˘_Àvñs
;

790 i‡(
ödúe˘
 >
	`pxt4_dú_håì_Àvñ
(
dú
->
i_sb
)) {

791 
	`pxt4_w¨nög
(
dú
->
i_sb
,

793 "suµ‹ãd vÆue", 
dú
->
i_öo
,

794 
	`pxt4_dú_håì_Àvñ
(
dú
->
i_sb
));

795 i‡(
	`pxt4_dú_håì_Àvñ
(
dú
->
i_sb
Ë< 
PXT4_HTREE_LEVEL
) {

796 
	`pxt4_w¨nög
(
dú
->
i_sb
, "EnableÜarge directory "

799 
Áû
;

802 
íåõs
 = (
dx_íåy
 *)(((*)&
roŸ
->
öfo
) +

803 
roŸ
->
öfo
.
öfo_Àngth
);

805 i‡(
	`dx_gë_limô
(
íåõs
Ë!
	`dx_roŸ_limô
(
dú
,

806 
roŸ
->
öfo
.
öfo_Àngth
)) {

807 
	`pxt4_w¨nög_öode
(
dú
, "dxÉntry:Üimit %u !=ÑootÜimit %u",

808 
	`dx_gë_limô
(
íåõs
),

809 
	`dx_roŸ_limô
(
dú
, 
roŸ
->
öfo
.
öfo_Àngth
));

810 
Áû
;

813 
	`dxåa˚
(
	`¥ötk
("Look u∞%x", 
hash
));

815 
cou¡
 = 
	`dx_gë_cou¡
(
íåõs
);

816 i‡(!
cou¡
 || cou¡ > 
	`dx_gë_limô
(
íåõs
)) {

817 
	`pxt4_w¨nög_öode
(
dú
,

819 
cou¡
, 
	`dx_gë_limô
(
íåõs
));

820 
Áû
;

823 
p
 = 
íåõs
 + 1;

824 
q
 = 
íåõs
 + 
cou¡
 - 1;

825 
p
 <
q
) {

826 
m
 = 
p
 + (
q
 -Ö) / 2;

827 
	`dxåa˚
(
	`¥ötk
(
KERN_CONT
 "."));

828 i‡(
	`dx_gë_hash
(
m
Ë> 
hash
)

829 
q
 = 
m
 - 1;

831 
p
 = 
m
 + 1;

835 
n
 = 
cou¡
 - 1;

836 
©
 = 
íåõs
;

837 
n
--)

839 
	`dxåa˚
(
	`¥ötk
(
KERN_CONT
 ","));

840 i‡(
	`dx_gë_hash
(++
©
Ë> 
hash
)

842 
©
--;

846 
	`as£π
 (
©
 =
p
 - 1);

849 
©
 = 
p
 - 1;

850 
	`dxåa˚
(
	`¥ötk
(
KERN_CONT
 " %x->%u\n",

851 
©
 =
íåõs
 ? 0 : 
	`dx_gë_hash
(at),

852 
	`dx_gë_block
(
©
)));

853 
‰ame
->
íåõs
 =Éntries;

854 
‰ame
->
©
 =át;

855 i‡(!
ödúe˘
--)

856  
‰ame
;

857 
‰ame
++;

858 
‰ame
->
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
	`dx_gë_block
(
©
), 
INDEX
);

859 i‡(
	`IS_ERR
(
‰ame
->
bh
)) {

860 
ªt_îr
 = (
dx_‰ame
 *Ë
‰ame
->
bh
;

861 
‰ame
->
bh
 = 
NULL
;

862 
Áû
;

864 
íåõs
 = ((
dx_node
 *Ë
‰ame
->
bh
->
b_d©a
)->entries;

866 i‡(
	`dx_gë_limô
(
íåõs
Ë!
	`dx_node_limô
(
dú
)) {

867 
	`pxt4_w¨nög_öode
(
dú
,

869 
	`dx_gë_limô
(
íåõs
), 
	`dx_node_limô
(
dú
));

870 
Áû
;

873 
Áû
:

874 
‰ame
 >
‰ame_ö
) {

875 
	`bªl£
(
‰ame
->
bh
);

876 
‰ame
--;

879 i‡(
ªt_îr
 =
	`ERR_PTR
(
ERR_BAD_DX_DIR
))

880 
	`pxt4_w¨nög_öode
(
dú
,

882  
ªt_îr
;

883 
	}
}

885 
	$dx_ªÀa£
(
dx_‰ame
 *
‰ames
)

887 
dx_roŸ_öfo
 *
öfo
;

888 
i
;

889 
ödúe˘_Àvñs
;

891 i‡(
‰ames
[0].
bh
 =
NULL
)

894 
öfo
 = &((
dx_roŸ
 *)
‰ames
[0].
bh
->
b_d©a
)->info;

896 
ödúe˘_Àvñs
 = 
öfo
->indirect_levels;

897 
i
 = 0; i <
ödúe˘_Àvñs
; i++) {

898 i‡(
‰ames
[
i
].
bh
 =
NULL
)

900 
	`bªl£
(
‰ames
[
i
].
bh
);

901 
‰ames
[
i
].
bh
 = 
NULL
;

903 
	}
}

922 
	$pxt4_håì_√xt_block
(
öode
 *
dú
, 
__u32
 
hash
,

923 
dx_‰ame
 *
‰ame
,

924 
dx_‰ame
 *
‰ames
,

925 
__u32
 *
°¨t_hash
)

927 
dx_‰ame
 *
p
;

928 
buf„r_hód
 *
bh
;

929 
num_‰ames
 = 0;

930 
__u32
 
bhash
;

932 
p
 = 
‰ame
;

941 i‡(++(
p
->
©
Ë<Ö->
íåõs
 + 
	`dx_gë_cou¡
(p->entries))

943 i‡(
p
 =
‰ames
)

945 
num_‰ames
++;

946 
p
--;

956 
bhash
 = 
	`dx_gë_hash
(
p
->
©
);

957 i‡(
°¨t_hash
)

958 *
°¨t_hash
 = 
bhash
;

959 i‡((
hash
 & 1) == 0) {

960 i‡((
bhash
 & ~1Ë!
hash
)

967 
num_‰ames
--) {

968 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
	`dx_gë_block
(
p
->
©
), 
INDEX
);

969 i‡(
	`IS_ERR
(
bh
))

970  
	`PTR_ERR
(
bh
);

971 
p
++;

972 
	`bªl£
(
p
->
bh
);

973 
p
->
bh
 = bh;

974 
p
->
©
 =Ö->
íåõs
 = ((
dx_node
 *Ë
bh
->
b_d©a
)->entries;

977 
	}
}

985 
	$håì_dúblock_to_åì
(
fûe
 *
dú_fûe
,

986 
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

987 
dx_hash_öfo
 *
höfo
,

988 
__u32
 
°¨t_hash
, __u32 
°¨t_mö‹_hash
)

990 
buf„r_hód
 *
bh
;

991 
pxt4_dú_íåy_2
 *
de
, *
t›
;

992 
îr
 = 0, 
cou¡
 = 0;

993 
fs¸y±_°r
 
‚ame_¸y±o_°r
 = 
	`FSTR_INIT
(
NULL
, 0), 
tmp_°r
;

995 
	`dxåa˚
(
	`¥ötk
(
KERN_INFO
 "In htree dirblock_to_tree: block %lu\n",

996 ()
block
));

997 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
block
, 
DIRENT_HTREE
);

998 i‡(
	`IS_ERR
(
bh
))

999  
	`PTR_ERR
(
bh
);

1001 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

1002 
t›
 = (
pxt4_dú_íåy_2
 *Ë((*Ë
de
 +

1003 
dú
->
i_sb
->
s_blocksize
 -

1004 
	`PXT4_DIR_REC_LEN
(0));

1005 #ifde‡
CONFIG_FS_ENCRYPTION


1007 i‡(
	`IS_ENCRYPTED
(
dú
)) {

1008 
îr
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
dú
);

1009 i‡(
îr
 < 0) {

1010 
	`bªl£
(
bh
);

1011  
îr
;

1013 
îr
 = 
	`fs¸y±_‚ame_Æloc_buf„r
(
dú
, 
PXT4_NAME_LEN
,

1014 &
‚ame_¸y±o_°r
);

1015 i‡(
îr
 < 0) {

1016 
	`bªl£
(
bh
);

1017  
îr
;

1021 ; 
de
 < 
t›
; dê
	`pxt4_√xt_íåy
(de, 
dú
->
i_sb
->
s_blocksize
)) {

1022 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

1023 
bh
->
b_d©a
, bh->
b_size
,

1024 (
block
<<
	`PXT4_BLOCK_SIZE_BITS
(
dú
->
i_sb
))

1025 + ((*)
de
 - 
bh
->
b_d©a
))) {

1029 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
, de->
«me_Àn
, 
höfo
);

1030 i‡((
höfo
->
hash
 < 
°¨t_hash
) ||

1031 ((
höfo
->
hash
 =
°¨t_hash
) &&

1032 (
höfo
->
mö‹_hash
 < 
°¨t_mö‹_hash
)))

1034 i‡(
de
->
öode
 == 0)

1036 i‡(!
	`IS_ENCRYPTED
(
dú
)) {

1037 
tmp_°r
.
«me
 = 
de
->name;

1038 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1039 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
,

1040 
höfo
->
hash
, höfo->
mö‹_hash
, 
de
,

1041 &
tmp_°r
);

1043 
ßve_Àn
 = 
‚ame_¸y±o_°r
.
Àn
;

1044 
fs¸y±_°r
 
de_«me
 = 
	`FSTR_INIT
(
de
->
«me
,

1045 
de
->
«me_Àn
);

1048 
îr
 = 
	`fs¸y±_‚ame_disk_to_u§
(
dú
, 
höfo
->
hash
,

1049 
höfo
->
mö‹_hash
, &
de_«me
,

1050 &
‚ame_¸y±o_°r
);

1051 i‡(
îr
) {

1052 
cou¡
 = 
îr
;

1053 
îrout
;

1055 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
,

1056 
höfo
->
hash
, höfo->
mö‹_hash
, 
de
,

1057 &
‚ame_¸y±o_°r
);

1058 
‚ame_¸y±o_°r
.
Àn
 = 
ßve_Àn
;

1060 i‡(
îr
 != 0) {

1061 
cou¡
 = 
îr
;

1062 
îrout
;

1064 
cou¡
++;

1066 
îrout
:

1067 
	`bªl£
(
bh
);

1068 #ifde‡
CONFIG_FS_ENCRYPTION


1069 
	`fs¸y±_‚ame_‰ì_buf„r
(&
‚ame_¸y±o_°r
);

1071  
cou¡
;

1072 
	}
}

1083 
	$pxt4_håì_fûl_åì
(
fûe
 *
dú_fûe
, 
__u32
 
°¨t_hash
,

1084 
__u32
 
°¨t_mö‹_hash
, __u32 *
√xt_hash
)

1086 
dx_hash_öfo
 
höfo
;

1087 
pxt4_dú_íåy_2
 *
de
;

1088 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

1089 
öode
 *
dú
;

1090 
pxt4_lblk_t
 
block
;

1091 
cou¡
 = 0;

1092 
ªt
, 
îr
;

1093 
__u32
 
hashvÆ
;

1094 
fs¸y±_°r
 
tmp_°r
;

1096 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "In htree_fill_tree, start hash: %x:%x\n",

1097 
°¨t_hash
, 
°¨t_mö‹_hash
));

1098 
dú
 = 
	`fûe_öode
(
dú_fûe
);

1099 i‡(!(
	`pxt4_ã°_öode_Êag
(
dú
, 
PXT4_INODE_INDEX
))) {

1100 
höfo
.
hash_vîsi⁄
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_def_hash_vîsi⁄
;

1101 i‡(
höfo
.
hash_vîsi⁄
 <
DX_HASH_TEA
)

1102 
höfo
.
hash_vîsi⁄
 +=

1103 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_unsig√d
;

1104 
höfo
.
£ed
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_£ed
;

1105 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

1106 
has_ölöe_d©a
 = 1;

1107 
cou¡
 = 
	`pxt4_ölöedú_to_åì
(
dú_fûe
, 
dú
, 0,

1108 &
höfo
, 
°¨t_hash
,

1109 
°¨t_mö‹_hash
,

1110 &
has_ölöe_d©a
);

1111 i‡(
has_ölöe_d©a
) {

1112 *
√xt_hash
 = ~0;

1113  
cou¡
;

1116 
cou¡
 = 
	`håì_dúblock_to_åì
(
dú_fûe
, 
dú
, 0, &
höfo
,

1117 
°¨t_hash
, 
°¨t_mö‹_hash
);

1118 *
√xt_hash
 = ~0;

1119  
cou¡
;

1121 
höfo
.
hash
 = 
°¨t_hash
;

1122 
höfo
.
mö‹_hash
 = 0;

1123 
‰ame
 = 
	`dx_¥obe
(
NULL
, 
dú
, &
höfo
, 
‰ames
);

1124 i‡(
	`IS_ERR
(
‰ame
))

1125  
	`PTR_ERR
(
‰ame
);

1128 i‡(!
°¨t_hash
 && !
°¨t_mö‹_hash
) {

1129 
de
 = (
pxt4_dú_íåy_2
 *Ë
‰ames
[0].
bh
->
b_d©a
;

1130 
tmp_°r
.
«me
 = 
de
->name;

1131 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1132 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
, 0, 0,

1133 
de
, &
tmp_°r
);

1134 i‡(
îr
 != 0)

1135 
îrout
;

1136 
cou¡
++;

1138 i‡(
°¨t_hash
 < 2 || (°¨t_hash ==2 && 
°¨t_mö‹_hash
==0)) {

1139 
de
 = (
pxt4_dú_íåy_2
 *Ë
‰ames
[0].
bh
->
b_d©a
;

1140 
de
 = 
	`pxt4_√xt_íåy
(de, 
dú
->
i_sb
->
s_blocksize
);

1141 
tmp_°r
.
«me
 = 
de
->name;

1142 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1143 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
, 2, 0,

1144 
de
, &
tmp_°r
);

1145 i‡(
îr
 != 0)

1146 
îrout
;

1147 
cou¡
++;

1151 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

1152 
îr
 = -
ERESTARTSYS
;

1153 
îrout
;

1155 
	`c⁄d_ªsched
();

1156 
block
 = 
	`dx_gë_block
(
‰ame
->
©
);

1157 
ªt
 = 
	`håì_dúblock_to_åì
(
dú_fûe
, 
dú
, 
block
, &
höfo
,

1158 
°¨t_hash
, 
°¨t_mö‹_hash
);

1159 i‡(
ªt
 < 0) {

1160 
îr
 = 
ªt
;

1161 
îrout
;

1163 
cou¡
 +
ªt
;

1164 
hashvÆ
 = ~0;

1165 
ªt
 = 
	`pxt4_håì_√xt_block
(
dú
, 
HASH_NB_ALWAYS
,

1166 
‰ame
, 
‰ames
, &
hashvÆ
);

1167 *
√xt_hash
 = 
hashvÆ
;

1168 i‡(
ªt
 < 0) {

1169 
îr
 = 
ªt
;

1170 
îrout
;

1177 i‡((
ªt
 == 0) ||

1178 (
cou¡
 && ((
hashvÆ
 & 1) == 0)))

1181 
	`dx_ªÀa£
(
‰ames
);

1182 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "FillÅree:Ñeturned %dÉntries, "

1183 "√xàhash: %x\n", 
cou¡
, *
√xt_hash
));

1184  
cou¡
;

1185 
îrout
:

1186 
	`dx_ªÀa£
(
‰ames
);

1187  (
îr
);

1188 
	}
}

1190 
ölöe
 
	$£¨ch_dúblock
(
buf„r_hód
 *
bh
,

1191 
öode
 *
dú
,

1192 
pxt4_fûíame
 *
‚ame
,

1193 
off£t
,

1194 
pxt4_dú_íåy_2
 **
ªs_dú
)

1196  
	`pxt4_£¨ch_dú
(
bh
, bh->
b_d©a
, 
dú
->
i_sb
->
s_blocksize
, dir,

1197 
‚ame
, 
off£t
, 
ªs_dú
);

1198 
	}
}

1208 
	$dx_make_m≠
(
öode
 *
dú
, 
pxt4_dú_íåy_2
 *
de
,

1209 
blocksize
, 
dx_hash_öfo
 *
höfo
,

1210 
dx_m≠_íåy
 *
m≠_èû
)

1212 
cou¡
 = 0;

1213 *
ba£
 = (*Ë
de
;

1214 
dx_hash_öfo
 
h
 = *
höfo
;

1216 (*Ë
de
 < 
ba£
 + 
blocksize
) {

1217 i‡(
de
->
«me_Àn
 && de->
öode
) {

1218 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
, de->
«me_Àn
, &
h
);

1219 
m≠_èû
--;

1220 
m≠_èû
->
hash
 = 
h
.hash;

1221 
m≠_èû
->
offs
 = ((*Ë
de
 - 
ba£
)>>2;

1222 
m≠_èû
->
size
 = 
	`À16_to_˝u
(
de
->
ªc_Àn
);

1223 
cou¡
++;

1224 
	`c⁄d_ªsched
();

1227 
de
 = 
	`pxt4_√xt_íåy
(de, 
blocksize
);

1229  
cou¡
;

1230 
	}
}

1233 
	$dx_s‹t_m≠
 (
dx_m≠_íåy
 *
m≠
, 
cou¡
)

1235 
dx_m≠_íåy
 *
p
, *
q
, *
t›
 = 
m≠
 + 
cou¡
 - 1;

1236 
m‹e
;

1238 
cou¡
 > 2) {

1239 
cou¡
 = count*10/13;

1240 i‡(
cou¡
 - 9 < 2)

1241 
cou¡
 = 11;

1242 
p
 = 
t›
, 
q
 =Ö - 
cou¡
; q >
m≠
;Ö--, q--)

1243 i‡(
p
->
hash
 < 
q
->hash)

1244 
	`sw≠
(*
p
, *
q
);

1248 
m‹e
 = 0;

1249 
q
 = 
t›
;

1250 
q
-- > 
m≠
) {

1251 i‡(
q
[1].
hash
 >= q[0].hash)

1253 
	`sw≠
(*(
q
+1), *q);

1254 
m‹e
 = 1;

1256 } 
m‹e
);

1257 
	}
}

1259 
	$dx_ö£π_block
(
dx_‰ame
 *
‰ame
, 
u32
 
hash
, 
pxt4_lblk_t
 
block
)

1261 
dx_íåy
 *
íåõs
 = 
‰ame
->entries;

1262 
dx_íåy
 *
ﬁd
 = 
‰ame
->
©
, *
√w
 = old + 1;

1263 
cou¡
 = 
	`dx_gë_cou¡
(
íåõs
);

1265 
	`as£π
(
cou¡
 < 
	`dx_gë_limô
(
íåõs
));

1266 
	`as£π
(
ﬁd
 < 
íåõs
 + 
cou¡
);

1267 
	`memmove
(
√w
 + 1,Çew, (*)(
íåõs
 + 
cou¡
) - (*)(new));

1268 
	`dx_£t_hash
(
√w
, 
hash
);

1269 
	`dx_£t_block
(
√w
, 
block
);

1270 
	`dx_£t_cou¡
(
íåõs
, 
cou¡
 + 1);

1271 
	}
}

1273 #ifde‡
CONFIG_UNICODE


1282 
	$pxt4_ci_com∑ª
(c⁄° 
öode
 *
∑ª¡
, c⁄° 
q°r
 *
«me
,

1283 c⁄° 
q°r
 *
íåy
, 
boﬁ
 
quick
)

1285 c⁄° 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
∑ª¡
->
i_sb
);

1286 c⁄° 
unicode_m≠
 *
um
 = 
sbi
->
s_ícodög
;

1287 
ªt
;

1289 i‡(
quick
)

1290 
ªt
 = 
	`utf8_°∫ˇ£cmp_fﬁded
(
um
, 
«me
, 
íåy
);

1292 
ªt
 = 
	`utf8_°∫ˇ£cmp
(
um
, 
«me
, 
íåy
);

1294 i‡(
ªt
 < 0) {

1298 i‡(
	`pxt4_has_°ri˘_mode
(
sbi
))

1299  -
EINVAL
;

1301 i‡(
«me
->
Àn
 !
íåy
->len)

1304  !!
	`memcmp
(
«me
->«me, 
íåy
->«me,Çame->
Àn
);

1307  
ªt
;

1308 
	}
}

1310 
	$pxt4_‚ame_£tup_ci_fûíame
(
öode
 *
dú
, c⁄° 
q°r
 *
öame
,

1311 
fs¸y±_°r
 *
cf_«me
)

1313 
Àn
;

1315 i‡(!
	`IS_CASEFOLDED
(
dú
Ë|| !
	`PXT4_SB
(dú->
i_sb
)->
s_ícodög
) {

1316 
cf_«me
->
«me
 = 
NULL
;

1320 
cf_«me
->
«me
 = 
	`kmÆloc
(
PXT4_NAME_LEN
, 
GFP_NOFS
);

1321 i‡(!
cf_«me
->
«me
)

1324 
Àn
 = 
	`utf8_ˇ£fﬁd
(
	`PXT4_SB
(
dú
->
i_sb
)->
s_ícodög
,

1325 
öame
, 
cf_«me
->
«me
,

1326 
PXT4_NAME_LEN
);

1327 i‡(
Àn
 <= 0) {

1328 
	`k‰ì
(
cf_«me
->
«me
);

1329 
cf_«me
->
«me
 = 
NULL
;

1332 
cf_«me
->
Àn
 = ()Üen;

1334 
	}
}

1342 
ölöe
 
boﬁ
 
	$pxt4_m©ch
(c⁄° 
öode
 *
∑ª¡
,

1343 c⁄° 
pxt4_fûíame
 *
‚ame
,

1344 c⁄° 
pxt4_dú_íåy_2
 *
de
)

1346 
fs¸y±_«me
 
f
;

1347 #ifde‡
CONFIG_UNICODE


1348 c⁄° 
q°r
 
íåy
 = {.
«me
 = 
de
->«me, .
Àn
 = de->
«me_Àn
};

1351 i‡(!
de
->
öode
)

1352  
Ál£
;

1354 
f
.
u§_‚ame
 = 
‚ame
->usr_fname;

1355 
f
.
disk_«me
 = 
‚ame
->disk_name;

1356 #ifde‡
CONFIG_FS_ENCRYPTION


1357 
f
.
¸y±o_buf
 = 
‚ame
->crypto_buf;

1360 #ifde‡
CONFIG_UNICODE


1361 i‡(
	`PXT4_SB
(
∑ª¡
->
i_sb
)->
s_ícodög
 && 
	`IS_CASEFOLDED
(parent)) {

1362 i‡(
‚ame
->
cf_«me
.
«me
) {

1363 
q°r
 
cf
 = {.
«me
 = 
‚ame
->
cf_«me
.name,

1364 .
Àn
 = 
‚ame
->
cf_«me
.len};

1365  !
	`pxt4_ci_com∑ª
(
∑ª¡
, &
cf
, &
íåy
, 
åue
);

1367  !
	`pxt4_ci_com∑ª
(
∑ª¡
, 
‚ame
->
u§_‚ame
, &
íåy
,

1368 
Ál£
);

1372  
	`fs¸y±_m©ch_«me
(&
f
, 
de
->
«me
, de->
«me_Àn
);

1373 
	}
}

1378 
	$pxt4_£¨ch_dú
(
buf„r_hód
 *
bh
, *
£¨ch_buf
, 
buf_size
,

1379 
öode
 *
dú
, 
pxt4_fûíame
 *
‚ame
,

1380 
off£t
, 
pxt4_dú_íåy_2
 **
ªs_dú
)

1382 
pxt4_dú_íåy_2
 * 
de
;

1383 * 
dlimô
;

1384 
de_Àn
;

1386 
de
 = (
pxt4_dú_íåy_2
 *)
£¨ch_buf
;

1387 
dlimô
 = 
£¨ch_buf
 + 
buf_size
;

1388 (*Ë
de
 < 
dlimô
) {

1391 i‡((*Ë
de
 + de->
«me_Àn
 <
dlimô
 &&

1392 
	`pxt4_m©ch
(
dú
, 
‚ame
, 
de
)) {

1395 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
, bh->
b_d©a
,

1396 
bh
->
b_size
, 
off£t
))

1398 *
ªs_dú
 = 
de
;

1402 
de_Àn
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

1403 
dú
->
i_sb
->
s_blocksize
);

1404 i‡(
de_Àn
 <= 0)

1406 
off£t
 +
de_Àn
;

1407 
de
 = (
pxt4_dú_íåy_2
 *Ë((*Ëdê+ 
de_Àn
);

1410 
	}
}

1412 
	$is_dx_öã∫Æ_node
(
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

1413 
pxt4_dú_íåy
 *
de
)

1415 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

1417 i‡(!
	`is_dx
(
dú
))

1419 i‡(
block
 == 0)

1421 i‡(
de
->
öode
 == 0 &&

1422 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
) ==

1423 
sb
->
s_blocksize
)

1426 
	}
}

1439 
buf„r_hód
 *
	$__pxt4_föd_íåy
(
öode
 *
dú
,

1440 
pxt4_fûíame
 *
‚ame
,

1441 
pxt4_dú_íåy_2
 **
ªs_dú
,

1442 *
ölöed
)

1444 
su≥r_block
 *
sb
;

1445 
buf„r_hód
 *
bh_u£
[
NAMEI_RA_SIZE
];

1446 
buf„r_hód
 *
bh
, *
ªt
 = 
NULL
;

1447 
pxt4_lblk_t
 
°¨t
, 
block
;

1448 c⁄° 
u8
 *
«me
 = 
‚ame
->
u§_‚ame
->name;

1449 
size_t
 
ø_max
 = 0;

1451 
size_t
 
ø_±r
 = 0;

1453 
pxt4_lblk_t
 
nblocks
;

1454 
i
, 
«mñí
, 
ªtvÆ
;

1456 *
ªs_dú
 = 
NULL
;

1457 
sb
 = 
dú
->
i_sb
;

1458 
«mñí
 = 
‚ame
->
u§_‚ame
->
Àn
;

1459 i‡(
«mñí
 > 
PXT4_NAME_LEN
)

1460  
NULL
;

1462 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

1463 
has_ölöe_d©a
 = 1;

1464 
ªt
 = 
	`pxt4_föd_ölöe_íåy
(
dú
, 
‚ame
, 
ªs_dú
,

1465 &
has_ölöe_d©a
);

1466 i‡(
has_ölöe_d©a
) {

1467 i‡(
ölöed
)

1468 *
ölöed
 = 1;

1469 
˛ónup_™d_exô
;

1473 i‡((
«mñí
 <2Ë&& (
«me
[0] == '.') &&

1474 (
«me
[1] == '.' ||Çame[1] == '\0')) {

1479 
block
 = 
°¨t
 = 0;

1480 
nblocks
 = 1;

1481 
ª°¨t
;

1483 i‡(
	`is_dx
(
dú
)) {

1484 
ªt
 = 
	`pxt4_dx_föd_íåy
(
dú
, 
‚ame
, 
ªs_dú
);

1490 i‡(!
	`IS_ERR
(
ªt
Ë|| 
	`PTR_ERR
‘ëË!
ERR_BAD_DX_DIR
)

1491 
˛ónup_™d_exô
;

1492 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "pxt4_find_entry: dx failed, "

1494 
ªt
 = 
NULL
;

1496 
nblocks
 = 
dú
->
i_size
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

1497 i‡(!
nblocks
) {

1498 
ªt
 = 
NULL
;

1499 
˛ónup_™d_exô
;

1501 
°¨t
 = 
	`PXT4_I
(
dú
)->
i_dú_°¨t_lookup
;

1502 i‡(
°¨t
 >
nblocks
)

1503 
°¨t
 = 0;

1504 
block
 = 
°¨t
;

1505 
ª°¨t
:

1510 i‡(
ø_±r
 >
ø_max
) {

1512 
ø_±r
 = 0;

1513 i‡(
block
 < 
°¨t
)

1514 
ø_max
 = 
°¨t
 - 
block
;

1516 
ø_max
 = 
nblocks
 - 
block
;

1517 
ø_max
 = 
	`mö
‘a_max, 
	`ARRAY_SIZE
(
bh_u£
));

1518 
ªtvÆ
 = 
	`pxt4_bªad_b©ch
(
dú
, 
block
, 
ø_max
,

1519 
Ál£
 , 
bh_u£
);

1520 i‡(
ªtvÆ
) {

1521 
ªt
 = 
	`ERR_PTR
(
ªtvÆ
);

1522 
ø_max
 = 0;

1523 
˛ónup_™d_exô
;

1526 i‡((
bh
 = 
bh_u£
[
ø_±r
++]Ë=
NULL
)

1527 
√xt
;

1528 
	`waô_⁄_buf„r
(
bh
);

1529 i‡(!
	`buf„r_u±od©e
(
bh
)) {

1530 
	`PXT4_ERROR_INODE
(
dú
, "reading directoryÜblock %lu",

1531 (Ë
block
);

1532 
	`bªl£
(
bh
);

1533 
ªt
 = 
	`ERR_PTR
(-
EIO
);

1534 
˛ónup_™d_exô
;

1536 i‡(!
	`buf„r_vîifõd
(
bh
) &&

1537 !
	`is_dx_öã∫Æ_node
(
dú
, 
block
,

1538 (
pxt4_dú_íåy
 *)
bh
->
b_d©a
) &&

1539 !
	`pxt4_dúblock_csum_vîify
(
dú
, 
bh
)) {

1540 
	`PXT4_ERROR_INODE
(
dú
, "checksumming directory "

1541 "block %lu", ()
block
);

1542 
	`bªl£
(
bh
);

1543 
ªt
 = 
	`ERR_PTR
(-
EFSBADCRC
);

1544 
˛ónup_™d_exô
;

1546 
	`£t_buf„r_vîifõd
(
bh
);

1547 
i
 = 
	`£¨ch_dúblock
(
bh
, 
dú
, 
‚ame
,

1548 
block
 << 
	`PXT4_BLOCK_SIZE_BITS
(
sb
), 
ªs_dú
);

1549 i‡(
i
 == 1) {

1550 
	`PXT4_I
(
dú
)->
i_dú_°¨t_lookup
 = 
block
;

1551 
ªt
 = 
bh
;

1552 
˛ónup_™d_exô
;

1554 
	`bªl£
(
bh
);

1555 i‡(
i
 < 0)

1556 
˛ónup_™d_exô
;

1558 
√xt
:

1559 i‡(++
block
 >
nblocks
)

1560 
block
 = 0;

1561 } 
block
 !
°¨t
);

1567 
block
 = 
nblocks
;

1568 
nblocks
 = 
dú
->
i_size
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

1569 i‡(
block
 < 
nblocks
) {

1570 
°¨t
 = 0;

1571 
ª°¨t
;

1574 
˛ónup_™d_exô
:

1576 ; 
ø_±r
 < 
ø_max
;Ña_ptr++)

1577 
	`bªl£
(
bh_u£
[
ø_±r
]);

1578  
ªt
;

1579 
	}
}

1581 
buf„r_hód
 *
	$pxt4_föd_íåy
(
öode
 *
dú
,

1582 c⁄° 
q°r
 *
d_«me
,

1583 
pxt4_dú_íåy_2
 **
ªs_dú
,

1584 *
ölöed
)

1586 
îr
;

1587 
pxt4_fûíame
 
‚ame
;

1588 
buf„r_hód
 *
bh
;

1590 
îr
 = 
	`pxt4_‚ame_£tup_fûíame
(
dú
, 
d_«me
, 1, &
‚ame
);

1591 i‡(
îr
 =-
ENOENT
)

1592  
NULL
;

1593 i‡(
îr
)

1594  
	`ERR_PTR
(
îr
);

1596 
bh
 = 
	`__pxt4_föd_íåy
(
dú
, &
‚ame
, 
ªs_dú
, 
ölöed
);

1598 
	`pxt4_‚ame_‰ì_fûíame
(&
‚ame
);

1599  
bh
;

1600 
	}
}

1602 
buf„r_hód
 *
	$pxt4_lookup_íåy
(
öode
 *
dú
,

1603 
díåy
 *dentry,

1604 
pxt4_dú_íåy_2
 **
ªs_dú
)

1606 
îr
;

1607 
pxt4_fûíame
 
‚ame
;

1608 
buf„r_hód
 *
bh
;

1610 
îr
 = 
	`pxt4_‚ame_¥ï¨e_lookup
(
dú
, 
díåy
, &
‚ame
);

1611 i‡(
îr
 =-
ENOENT
)

1612  
NULL
;

1613 i‡(
îr
)

1614  
	`ERR_PTR
(
îr
);

1616 
bh
 = 
	`__pxt4_föd_íåy
(
dú
, &
‚ame
, 
ªs_dú
, 
NULL
);

1618 
	`pxt4_‚ame_‰ì_fûíame
(&
‚ame
);

1619  
bh
;

1620 
	}
}

1622 
buf„r_hód
 * 
	$pxt4_dx_föd_íåy
(
öode
 *
dú
,

1623 
pxt4_fûíame
 *
‚ame
,

1624 
pxt4_dú_íåy_2
 **
ªs_dú
)

1626 
su≥r_block
 * 
sb
 = 
dú
->
i_sb
;

1627 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

1628 
buf„r_hód
 *
bh
;

1629 
pxt4_lblk_t
 
block
;

1630 
ªtvÆ
;

1632 #ifde‡
CONFIG_FS_ENCRYPTION


1633 *
ªs_dú
 = 
NULL
;

1635 
‰ame
 = 
	`dx_¥obe
(
‚ame
, 
dú
, 
NULL
, 
‰ames
);

1636 i‡(
	`IS_ERR
(
‰ame
))

1637  (
buf„r_hód
 *Ë
‰ame
;

1639 
block
 = 
	`dx_gë_block
(
‰ame
->
©
);

1640 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
block
, 
DIRENT_HTREE
);

1641 i‡(
	`IS_ERR
(
bh
))

1642 
îrout
;

1644 
ªtvÆ
 = 
	`£¨ch_dúblock
(
bh
, 
dú
, 
‚ame
,

1645 
block
 << 
	`PXT4_BLOCK_SIZE_BITS
(
sb
),

1646 
ªs_dú
);

1647 i‡(
ªtvÆ
 == 1)

1648 
suc˚ss
;

1649 
	`bªl£
(
bh
);

1650 i‡(
ªtvÆ
 == -1) {

1651 
bh
 = 
	`ERR_PTR
(
ERR_BAD_DX_DIR
);

1652 
îrout
;

1656 
ªtvÆ
 = 
	`pxt4_håì_√xt_block
(
dú
, 
‚ame
->
höfo
.
hash
, 
‰ame
,

1657 
‰ames
, 
NULL
);

1658 i‡(
ªtvÆ
 < 0) {

1659 
	`pxt4_w¨nög_öode
(
dú
,

1661 
ªtvÆ
);

1662 
bh
 = 
	`ERR_PTR
(
ªtvÆ
);

1663 
îrout
;

1665 } 
ªtvÆ
 == 1);

1667 
bh
 = 
NULL
;

1668 
îrout
:

1669 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "%†nŸ found\n", 
‚ame
->
u§_‚ame
->
«me
));

1670 
suc˚ss
:

1671 
	`dx_ªÀa£
(
‰ames
);

1672  
bh
;

1673 
	}
}

1675 
díåy
 *
	$pxt4_lookup
(
öode
 *
dú
, 
díåy
 *díåy, 
Êags
)

1677 
öode
 *inode;

1678 
pxt4_dú_íåy_2
 *
de
;

1679 
buf„r_hód
 *
bh
;

1681 i‡(
díåy
->
d_«me
.
Àn
 > 
PXT4_NAME_LEN
)

1682  
	`ERR_PTR
(-
ENAMETOOLONG
);

1684 
bh
 = 
	`pxt4_lookup_íåy
(
dú
, 
díåy
, &
de
);

1685 i‡(
	`IS_ERR
(
bh
))

1686  
	`ERR_CAST
(
bh
);

1687 
öode
 = 
NULL
;

1688 i‡(
bh
) {

1689 
__u32
 
öo
 = 
	`À32_to_˝u
(
de
->
öode
);

1690 
	`bªl£
(
bh
);

1691 i‡(!
	`pxt4_vÆid_öum
(
dú
->
i_sb
, 
öo
)) {

1692 
	`PXT4_ERROR_INODE
(
dú
, "bad inodênumbî: %u", 
öo
);

1693  
	`ERR_PTR
(-
EFSCORRUPTED
);

1695 i‡(
	`u∆ikñy
(
öo
 =
dú
->
i_öo
)) {

1696 
	`PXT4_ERROR_INODE
(
dú
, "'%pd'ÜinkedÅoÖarent dir",

1697 
díåy
);

1698  
	`ERR_PTR
(-
EFSCORRUPTED
);

1700 
öode
 = 
	`pxt4_igë
(
dú
->
i_sb
, 
öo
, 
PXT4_IGET_NORMAL
);

1701 i‡(
öode
 =
	`ERR_PTR
(-
ESTALE
)) {

1702 
	`PXT4_ERROR_INODE
(
dú
,

1704 
öo
);

1705  
	`ERR_PTR
(-
EFSCORRUPTED
);

1707 i‡(!
	`IS_ERR
(
öode
Ë&& 
	`IS_ENCRYPTED
(
dú
) &&

1708 (
	`S_ISDIR
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode)) &&

1709 !
	`fs¸y±_has_≥rmôãd_c⁄ãxt
(
dú
, 
öode
)) {

1710 
	`pxt4_w¨nög
(
öode
->
i_sb
,

1712 
dú
->
i_öo
, 
öode
->i_ino);

1713 
	`ùut
(
öode
);

1714  
	`ERR_PTR
(-
EPERM
);

1718 #ifde‡
CONFIG_UNICODE


1719 i‡(!
öode
 && 
	`IS_CASEFOLDED
(
dú
)) {

1725  
NULL
;

1728  
	`d_•li˚_Æüs
(
öode
, 
díåy
);

1729 
	}
}

1732 
díåy
 *
	$pxt4_gë_∑ª¡
(
díåy
 *
chûd
)

1734 
__u32
 
öo
;

1735 c⁄° 
q°r
 
dŸdŸ
 = 
	`QSTR_INIT
("..", 2);

1736 
pxt4_dú_íåy_2
 * 
de
;

1737 
buf„r_hód
 *
bh
;

1739 
bh
 = 
	`pxt4_föd_íåy
(
	`d_öode
(
chûd
), &
dŸdŸ
, &
de
, 
NULL
);

1740 i‡(
	`IS_ERR
(
bh
))

1741  
	`ERR_CAST
(
bh
);

1742 i‡(!
bh
)

1743  
	`ERR_PTR
(-
ENOENT
);

1744 
öo
 = 
	`À32_to_˝u
(
de
->
öode
);

1745 
	`bªl£
(
bh
);

1747 i‡(!
	`pxt4_vÆid_öum
(
chûd
->
d_sb
, 
öo
)) {

1748 
	`PXT4_ERROR_INODE
(
	`d_öode
(
chûd
),

1749 "badÖ¨íàöodênumbî: %u", 
öo
);

1750  
	`ERR_PTR
(-
EFSCORRUPTED
);

1753  
	`d_obèö_Æüs
(
	`pxt4_igë
(
chûd
->
d_sb
, 
öo
, 
PXT4_IGET_NORMAL
));

1754 
	}
}

1760 
pxt4_dú_íåy_2
 *

1761 
	$dx_move_dúíts
(*
‰om
, *
to
, 
dx_m≠_íåy
 *
m≠
, 
cou¡
,

1762 
blocksize
)

1764 
ªc_Àn
 = 0;

1766 
cou¡
--) {

1767 
pxt4_dú_íåy_2
 *
de
 = (pxt4_dir_entry_2 *)

1768 (
‰om
 + (
m≠
->
offs
<<2));

1769 
ªc_Àn
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1770 
	`mem˝y
 (
to
, 
de
, 
ªc_Àn
);

1771 ((
pxt4_dú_íåy_2
 *Ë
to
)->
ªc_Àn
 =

1772 
	`pxt4_ªc_Àn_to_disk
(
ªc_Àn
, 
blocksize
);

1773 
de
->
öode
 = 0;

1774 
m≠
++;

1775 
to
 +
ªc_Àn
;

1777  (
pxt4_dú_íåy_2
 *Ë(
to
 - 
ªc_Àn
);

1778 
	}
}

1784 
pxt4_dú_íåy_2
* 
	$dx_∑ck_dúíts
(*
ba£
, 
blocksize
)

1786 
pxt4_dú_íåy_2
 *
√xt
, *
to
, *
¥ev
, *
de
 = (pxt4_dú_íåy_2 *Ë
ba£
;

1787 
ªc_Àn
 = 0;

1789 
¥ev
 = 
to
 = 
de
;

1790 (*)
de
 < 
ba£
 + 
blocksize
) {

1791 
√xt
 = 
	`pxt4_√xt_íåy
(
de
, 
blocksize
);

1792 i‡(
de
->
öode
 && de->
«me_Àn
) {

1793 
ªc_Àn
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1794 i‡(
de
 > 
to
)

1795 
	`memmove
(
to
, 
de
, 
ªc_Àn
);

1796 
to
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
‘ec_Àn, 
blocksize
);

1797 
¥ev
 = 
to
;

1798 
to
 = (
pxt4_dú_íåy_2
 *Ë(((*ËtoË+ 
ªc_Àn
);

1800 
de
 = 
√xt
;

1802  
¥ev
;

1803 
	}
}

1810 
pxt4_dú_íåy_2
 *
	$do_•lô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

1811 
buf„r_hód
 **
bh
,
dx_‰ame
 *
‰ame
,

1812 
dx_hash_öfo
 *
höfo
)

1814 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

1815 
cou¡
, 
c⁄töued
;

1816 
buf„r_hód
 *
bh2
;

1817 
pxt4_lblk_t
 
√wblock
;

1818 
u32
 
hash2
;

1819 
dx_m≠_íåy
 *
m≠
;

1820 *
d©a1
 = (*
bh
)->
b_d©a
, *
d©a2
;

1821 
•lô
, 
move
, 
size
;

1822 
pxt4_dú_íåy_2
 *
de
 = 
NULL
, *
de2
;

1823 
csum_size
 = 0;

1824 
îr
 = 0, 
i
;

1826 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

1827 
csum_size
 = (
pxt4_dú_íåy_èû
);

1829 
bh2
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
√wblock
);

1830 i‡(
	`IS_ERR
(
bh2
)) {

1831 
	`bªl£
(*
bh
);

1832 *
bh
 = 
NULL
;

1833  (
pxt4_dú_íåy_2
 *Ë
bh2
;

1836 
	`BUFFER_TRACE
(*
bh
, "get_write_access");

1837 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, *
bh
);

1838 i‡(
îr
)

1839 
jou∫Æ_îr‹
;

1841 
	`BUFFER_TRACE
(
‰ame
->
bh
, "get_write_access");

1842 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
‰ame
->
bh
);

1843 i‡(
îr
)

1844 
jou∫Æ_îr‹
;

1846 
d©a2
 = 
bh2
->
b_d©a
;

1849 
m≠
 = (
dx_m≠_íåy
 *Ë(
d©a2
 + 
blocksize
);

1850 
cou¡
 = 
	`dx_make_m≠
(
dú
, (
pxt4_dú_íåy_2
 *Ë
d©a1
,

1851 
blocksize
, 
höfo
, 
m≠
);

1852 
m≠
 -
cou¡
;

1853 
	`dx_s‹t_m≠
(
m≠
, 
cou¡
);

1855 
size
 = 0;

1856 
move
 = 0;

1857 
i
 = 
cou¡
-1; i >= 0; i--) {

1859 i‡(
size
 + 
m≠
[
i
].size/2 > 
blocksize
/2)

1861 
size
 +
m≠
[
i
].size;

1862 
move
++;

1865 
•lô
 = 
cou¡
 - 
move
;

1866 
hash2
 = 
m≠
[
•lô
].
hash
;

1867 
c⁄töued
 = 
hash2
 =
m≠
[
•lô
 - 1].
hash
;

1868 
	`dxåa˚
(
	`¥ötk
(
KERN_INFO
 "Split block %luát %x, %i/%i\n",

1869 ()
	`dx_gë_block
(
‰ame
->
©
),

1870 
hash2
, 
•lô
, 
cou¡
-split));

1873 
de2
 = 
	`dx_move_dúíts
(
d©a1
, 
d©a2
, 
m≠
 + 
•lô
, 
cou¡
 - split,

1874 
blocksize
);

1875 
de
 = 
	`dx_∑ck_dúíts
(
d©a1
, 
blocksize
);

1876 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
d©a1
 + (
blocksize
 - 
csum_size
) -

1877 (*Ë
de
,

1878 
blocksize
);

1879 
de2
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
d©a2
 + (
blocksize
 - 
csum_size
) -

1880 (*Ë
de2
,

1881 
blocksize
);

1882 i‡(
csum_size
) {

1883 
	`pxt4_öôülize_dúít_èû
(*
bh
, 
blocksize
);

1884 
	`pxt4_öôülize_dúít_èû
(
bh2
, 
blocksize
);

1887 
	`dxåa˚
(
	`dx_show_Àaf
(
dú
, 
höfo
, (
pxt4_dú_íåy_2
 *Ë
d©a1
,

1888 
blocksize
, 1));

1889 
	`dxåa˚
(
	`dx_show_Àaf
(
dú
, 
höfo
, (
pxt4_dú_íåy_2
 *Ë
d©a2
,

1890 
blocksize
, 1));

1893 i‡(
höfo
->
hash
 >
hash2
) {

1894 
	`sw≠
(*
bh
, 
bh2
);

1895 
de
 = 
de2
;

1897 
	`dx_ö£π_block
(
‰ame
, 
hash2
 + 
c⁄töued
, 
√wblock
);

1898 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
dú
, 
bh2
);

1899 i‡(
îr
)

1900 
jou∫Æ_îr‹
;

1901 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
‰ame
->
bh
);

1902 i‡(
îr
)

1903 
jou∫Æ_îr‹
;

1904 
	`bªl£
(
bh2
);

1905 
	`dxåa˚
(
	`dx_show_ödex
("‰ame", 
‰ame
->
íåõs
));

1906  
de
;

1908 
jou∫Æ_îr‹
:

1909 
	`bªl£
(*
bh
);

1910 
	`bªl£
(
bh2
);

1911 *
bh
 = 
NULL
;

1912 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

1913  
	`ERR_PTR
(
îr
);

1914 
	}
}

1916 
	$pxt4_föd_de°_de
(
öode
 *
dú
, inode *inode,

1917 
buf„r_hód
 *
bh
,

1918 *
buf
, 
buf_size
,

1919 
pxt4_fûíame
 *
‚ame
,

1920 
pxt4_dú_íåy_2
 **
de°_de
)

1922 
pxt4_dú_íåy_2
 *
de
;

1923 
ª˛í
 = 
	`PXT4_DIR_REC_LEN
(
	`‚ame_Àn
(
‚ame
));

1924 
∆í
, 
æí
;

1925 
off£t
 = 0;

1926 *
t›
;

1928 
de
 = (
pxt4_dú_íåy_2
 *)
buf
;

1929 
t›
 = 
buf
 + 
buf_size
 - 
ª˛í
;

1930 (*Ë
de
 <
t›
) {

1931 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

1932 
buf
, 
buf_size
, 
off£t
))

1933  -
EFSCORRUPTED
;

1934 i‡(
	`pxt4_m©ch
(
dú
, 
‚ame
, 
de
))

1935  -
EEXIST
;

1936 
∆í
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1937 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
buf_size
);

1938 i‡((
de
->
öode
 ? 
æí
 - 
∆í
 :ÑÀnË>
ª˛í
)

1940 
de
 = (
pxt4_dú_íåy_2
 *)((*)dê+ 
æí
);

1941 
off£t
 +
æí
;

1943 i‡((*Ë
de
 > 
t›
)

1944  -
ENOSPC
;

1946 *
de°_de
 = 
de
;

1948 
	}
}

1950 
	$pxt4_ö£π_díåy
(
öode
 *inode,

1951 
pxt4_dú_íåy_2
 *
de
,

1952 
buf_size
,

1953 
pxt4_fûíame
 *
‚ame
)

1956 
∆í
, 
æí
;

1958 
∆í
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1959 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
buf_size
);

1960 i‡(
de
->
öode
) {

1961 
pxt4_dú_íåy_2
 *
de1
 =

1962 (
pxt4_dú_íåy_2
 *)((*)
de
 + 
∆í
);

1963 
de1
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
æí
 - 
∆í
, 
buf_size
);

1964 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
∆í
, 
buf_size
);

1965 
de
 = 
de1
;

1967 
de
->
fûe_ty≥
 = 
PXT4_FT_UNKNOWN
;

1968 
de
->
öode
 = 
	`˝u_to_À32
(öode->
i_öo
);

1969 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, 
de
, inode->
i_mode
);

1970 
de
->
«me_Àn
 = 
	`‚ame_Àn
(
‚ame
);

1971 
	`mem˝y
(
de
->
«me
, 
	`‚ame_«me
(
‚ame
), 
	`‚ame_Àn
(fname));

1972 
	}
}

1982 
	$add_dúít_to_buf
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

1983 
öode
 *
dú
,

1984 
öode
 *öode, 
pxt4_dú_íåy_2
 *
de
,

1985 
buf„r_hód
 *
bh
)

1987 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

1988 
csum_size
 = 0;

1989 
îr
;

1991 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

1992 
csum_size
 = (
pxt4_dú_íåy_èû
);

1994 i‡(!
de
) {

1995 
îr
 = 
	`pxt4_föd_de°_de
(
dú
, 
öode
, 
bh
, bh->
b_d©a
,

1996 
blocksize
 - 
csum_size
, 
‚ame
, &
de
);

1997 i‡(
îr
)

1998  
îr
;

2000 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2001 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2002 i‡(
îr
) {

2003 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2004  
îr
;

2008 
	`pxt4_ö£π_díåy
(
öode
, 
de
, 
blocksize
, 
‚ame
);

2021 
dú
->
i_mtime
 = dú->
i_˘ime
 = 
	`cuºít_time
(dir);

2022 
	`pxt4_upd©e_dx_Êag
(
dú
);

2023 
	`öode_öc_ivîsi⁄
(
dú
);

2024 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2025 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

2026 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
dú
, 
bh
);

2027 i‡(
îr
)

2028 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2030 
	}
}

2036 
	$make_ödexed_dú
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

2037 
öode
 *
dú
,

2038 
öode
 *öode, 
buf„r_hód
 *
bh
)

2040 
buf„r_hód
 *
bh2
;

2041 
dx_roŸ
 *
roŸ
;

2042 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

2043 
dx_íåy
 *
íåõs
;

2044 
pxt4_dú_íåy_2
 *
de
, *
de2
;

2045 *
d©a2
, *
t›
;

2046 
Àn
;

2047 
ªtvÆ
;

2048 
blocksize
;

2049 
pxt4_lblk_t
 
block
;

2050 
Áke_dúít
 *
fde
;

2051 
csum_size
 = 0;

2053 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

2054 
csum_size
 = (
pxt4_dú_íåy_èû
);

2056 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

2057 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "Cª©ög index: inodê%lu\n", 
dú
->
i_öo
));

2058 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2059 
ªtvÆ
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2060 i‡(
ªtvÆ
) {

2061 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
ªtvÆ
);

2062 
	`bªl£
(
bh
);

2063  
ªtvÆ
;

2065 
roŸ
 = (
dx_roŸ
 *Ë
bh
->
b_d©a
;

2068 
fde
 = &
roŸ
->
dŸdŸ
;

2069 
de
 = (
pxt4_dú_íåy_2
 *)((*)
fde
 +

2070 
	`pxt4_ªc_Àn_‰om_disk
(
fde
->
ªc_Àn
, 
blocksize
));

2071 i‡((*Ë
de
 >(((*Ë
roŸ
Ë+ 
blocksize
)) {

2072 
	`PXT4_ERROR_INODE
(
dú
, "invalidÑec_len for '..'");

2073 
	`bªl£
(
bh
);

2074  -
EFSCORRUPTED
;

2076 
Àn
 = ((*Ë
roŸ
Ë+ (
blocksize
 - 
csum_size
Ë- (*Ë
de
;

2079 
bh2
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
block
);

2080 i‡(
	`IS_ERR
(
bh2
)) {

2081 
	`bªl£
(
bh
);

2082  
	`PTR_ERR
(
bh2
);

2084 
	`pxt4_£t_öode_Êag
(
dú
, 
PXT4_INODE_INDEX
);

2085 
d©a2
 = 
bh2
->
b_d©a
;

2087 
	`mem˝y
(
d©a2
, 
de
, 
Àn
);

2088 
de
 = (
pxt4_dú_íåy_2
 *Ë
d©a2
;

2089 
t›
 = 
d©a2
 + 
Àn
;

2090 (*)(
de2
 = 
	`pxt4_√xt_íåy
(
de
, 
blocksize
)Ë< 
t›
)

2091 
de
 = 
de2
;

2092 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
d©a2
 + (
blocksize
 - 
csum_size
) -

2093 (*Ë
de
, 
blocksize
);

2095 i‡(
csum_size
)

2096 
	`pxt4_öôülize_dúít_èû
(
bh2
, 
blocksize
);

2099 
de
 = (
pxt4_dú_íåy_2
 *Ë(&
roŸ
->
dŸdŸ
);

2100 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
blocksize
 - 
	`PXT4_DIR_REC_LEN
(2),

2101 
blocksize
);

2102 
	`mem£t
 (&
roŸ
->
öfo
, 0, (root->info));

2103 
roŸ
->
öfo
.
öfo_Àngth
 = (root->info);

2104 
roŸ
->
öfo
.
hash_vîsi⁄
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_def_hash_vîsi⁄
;

2105 
íåõs
 = 
roŸ
->entries;

2106 
	`dx_£t_block
(
íåõs
, 1);

2107 
	`dx_£t_cou¡
(
íåõs
, 1);

2108 
	`dx_£t_limô
(
íåõs
, 
	`dx_roŸ_limô
(
dú
, (
roŸ
->
öfo
)));

2111 
‚ame
->
höfo
.
hash_vîsi⁄
 = 
roŸ
->
öfo
.hash_version;

2112 i‡(
‚ame
->
höfo
.
hash_vîsi⁄
 <
DX_HASH_TEA
)

2113 
‚ame
->
höfo
.
hash_vîsi⁄
 +
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_unsig√d
;

2114 
‚ame
->
höfo
.
£ed
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_£ed
;

2115 
	`pxt4fs_dúhash
(
dú
, 
	`‚ame_«me
(
‚ame
), 
	`‚ame_Àn
(‚ame), &‚ame->
höfo
);

2117 
	`mem£t
(
‰ames
, 0, (frames));

2118 
‰ame
 = 
‰ames
;

2119 
‰ame
->
íåõs
 =Éntries;

2120 
‰ame
->
©
 = 
íåõs
;

2121 
‰ame
->
bh
 = bh;

2123 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
‰ame
->
bh
);

2124 i‡(
ªtvÆ
)

2125 
out_‰ames
;

2126 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
dú
, 
bh2
);

2127 i‡(
ªtvÆ
)

2128 
out_‰ames
;

2130 
de
 = 
	`do_•lô
(
h™dÀ
,
dú
, &
bh2
, 
‰ame
, &
‚ame
->
höfo
);

2131 i‡(
	`IS_ERR
(
de
)) {

2132 
ªtvÆ
 = 
	`PTR_ERR
(
de
);

2133 
out_‰ames
;

2136 
ªtvÆ
 = 
	`add_dúít_to_buf
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, 
de
, 
bh2
);

2137 
out_‰ames
:

2143 i‡(
ªtvÆ
)

2144 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2145 
	`dx_ªÀa£
(
‰ames
);

2146 
	`bªl£
(
bh2
);

2147  
ªtvÆ
;

2148 
	}
}

2160 
	$pxt4_add_íåy
(
h™dÀ_t
 *
h™dÀ
, 
díåy
 *dentry,

2161 
öode
 *inode)

2163 
öode
 *
dú
 = 
	`d_öode
(
díåy
->
d_∑ª¡
);

2164 
buf„r_hód
 *
bh
 = 
NULL
;

2165 
pxt4_dú_íåy_2
 *
de
;

2166 
su≥r_block
 *
sb
;

2167 
pxt4_sb_öfo
 *
sbi
;

2168 
pxt4_fûíame
 
‚ame
;

2169 
ªtvÆ
;

2170 
dx_ÁŒback
=0;

2171 
blocksize
;

2172 
pxt4_lblk_t
 
block
, 
blocks
;

2173 
csum_size
 = 0;

2175 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

2176 
csum_size
 = (
pxt4_dú_íåy_èû
);

2178 
sb
 = 
dú
->
i_sb
;

2179 
sbi
 = 
	`PXT4_SB
(
sb
);

2180 
blocksize
 = 
sb
->
s_blocksize
;

2181 i‡(!
díåy
->
d_«me
.
Àn
)

2182  -
EINVAL
;

2184 #ifde‡
CONFIG_UNICODE


2185 i‡(
	`pxt4_has_°ri˘_mode
(
sbi
Ë&& 
	`IS_CASEFOLDED
(
dú
) &&

2186 
sbi
->
s_ícodög
 && 
	`utf8_vÆid©e
(sbi->s_ícodög, &
díåy
->
d_«me
))

2187  -
EINVAL
;

2190 
ªtvÆ
 = 
	`pxt4_‚ame_£tup_fûíame
(
dú
, &
díåy
->
d_«me
, 0, &
‚ame
);

2191 i‡(
ªtvÆ
)

2192  
ªtvÆ
;

2194 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

2195 
ªtvÆ
 = 
	`pxt4_åy_add_ölöe_íåy
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
);

2196 i‡(
ªtvÆ
 < 0)

2197 
out
;

2198 i‡(
ªtvÆ
 == 1) {

2199 
ªtvÆ
 = 0;

2200 
out
;

2204 i‡(
	`is_dx
(
dú
)) {

2205 
ªtvÆ
 = 
	`pxt4_dx_add_íåy
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
);

2206 i‡(!
ªtvÆ
 || (ªtvÆ !
ERR_BAD_DX_DIR
))

2207 
out
;

2208 
	`pxt4_˛ór_öode_Êag
(
dú
, 
PXT4_INODE_INDEX
);

2209 
dx_ÁŒback
++;

2210 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2212 
blocks
 = 
dú
->
i_size
 >> 
sb
->
s_blocksize_bôs
;

2213 
block
 = 0; block < 
blocks
; block++) {

2214 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
block
, 
DIRENT
);

2215 i‡(
bh
 =
NULL
) {

2216 
bh
 = 
	`pxt4_bªad
(
h™dÀ
, 
dú
, 
block
,

2217 
PXT4_GET_BLOCKS_CREATE
);

2218 
add_to_√w_block
;

2220 i‡(
	`IS_ERR
(
bh
)) {

2221 
ªtvÆ
 = 
	`PTR_ERR
(
bh
);

2222 
bh
 = 
NULL
;

2223 
out
;

2225 
ªtvÆ
 = 
	`add_dúít_to_buf
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
,

2226 
NULL
, 
bh
);

2227 i‡(
ªtvÆ
 !-
ENOSPC
)

2228 
out
;

2230 i‡(
blocks
 =1 && !
dx_ÁŒback
 &&

2231 
	`pxt4_has_„©uª_dú_ödex
(
sb
)) {

2232 
ªtvÆ
 = 
	`make_ödexed_dú
(
h™dÀ
, &
‚ame
, 
dú
,

2233 
öode
, 
bh
);

2234 
bh
 = 
NULL
;

2235 
out
;

2237 
	`bªl£
(
bh
);

2239 
bh
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
block
);

2240 
add_to_√w_block
:

2241 i‡(
	`IS_ERR
(
bh
)) {

2242 
ªtvÆ
 = 
	`PTR_ERR
(
bh
);

2243 
bh
 = 
NULL
;

2244 
out
;

2246 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

2247 
de
->
öode
 = 0;

2248 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
blocksize
 - 
csum_size
, blocksize);

2250 i‡(
csum_size
)

2251 
	`pxt4_öôülize_dúít_èû
(
bh
, 
blocksize
);

2253 
ªtvÆ
 = 
	`add_dúít_to_buf
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
, 
de
, 
bh
);

2254 
out
:

2255 
	`pxt4_‚ame_‰ì_fûíame
(&
‚ame
);

2256 
	`bªl£
(
bh
);

2257 i‡(
ªtvÆ
 == 0)

2258 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
);

2259  
ªtvÆ
;

2260 
	}
}

2265 
	$pxt4_dx_add_íåy
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

2266 
öode
 *
dú
, inode *inode)

2268 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

2269 
dx_íåy
 *
íåõs
, *
©
;

2270 
buf„r_hód
 *
bh
;

2271 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

2272 
pxt4_dú_íåy_2
 *
de
;

2273 
ª°¨t
;

2274 
îr
;

2276 
agaö
:

2277 
ª°¨t
 = 0;

2278 
‰ame
 = 
	`dx_¥obe
(
‚ame
, 
dú
, 
NULL
, 
‰ames
);

2279 i‡(
	`IS_ERR
(
‰ame
))

2280  
	`PTR_ERR
(
‰ame
);

2281 
íåõs
 = 
‰ame
->entries;

2282 
©
 = 
‰ame
->at;

2283 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
	`dx_gë_block
(
‰ame
->
©
), 
DIRENT_HTREE
);

2284 i‡(
	`IS_ERR
(
bh
)) {

2285 
îr
 = 
	`PTR_ERR
(
bh
);

2286 
bh
 = 
NULL
;

2287 
˛ónup
;

2290 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2291 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2292 i‡(
îr
)

2293 
jou∫Æ_îr‹
;

2295 
îr
 = 
	`add_dúít_to_buf
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, 
NULL
, 
bh
);

2296 i‡(
îr
 !-
ENOSPC
)

2297 
˛ónup
;

2299 
îr
 = 0;

2301 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "using %u of %uÇodeÉntries\n",

2302 
	`dx_gë_cou¡
(
íåõs
), 
	`dx_gë_limô
(entries)));

2304 i‡(
	`dx_gë_cou¡
(
íåõs
Ë=
	`dx_gë_limô
(entries)) {

2305 
pxt4_lblk_t
 
√wblock
;

2306 
Àvñs
 = 
‰ame
 - 
‰ames
 + 1;

2307 
icou¡
;

2308 
add_Àvñ
 = 1;

2309 
dx_íåy
 *
íåõs2
;

2310 
dx_node
 *
node2
;

2311 
buf„r_hód
 *
bh2
;

2313 
‰ame
 > 
‰ames
) {

2314 i‡(
	`dx_gë_cou¡
((
‰ame
 - 1)->
íåõs
) <

2315 
	`dx_gë_limô
((
‰ame
 - 1)->
íåõs
)) {

2316 
add_Àvñ
 = 0;

2319 
‰ame
--;

2320 
©
 = 
‰ame
->at;

2321 
íåõs
 = 
‰ame
->entries;

2322 
ª°¨t
 = 1;

2324 i‡(
add_Àvñ
 && 
Àvñs
 =
	`pxt4_dú_håì_Àvñ
(
sb
)) {

2325 
	`pxt4_w¨nög
(
sb
, "Directory (ino: %lu) index full, "

2327 
dú
->
i_öo
, 
Àvñs
);

2328 i‡(
	`pxt4_dú_håì_Àvñ
(
sb
Ë< 
PXT4_HTREE_LEVEL
) {

2329 
	`pxt4_w¨nög
(
sb
, "Large directory feature is "

2333 
îr
 = -
ENOSPC
;

2334 
˛ónup
;

2336 
icou¡
 = 
	`dx_gë_cou¡
(
íåõs
);

2337 
bh2
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
√wblock
);

2338 i‡(
	`IS_ERR
(
bh2
)) {

2339 
îr
 = 
	`PTR_ERR
(
bh2
);

2340 
˛ónup
;

2342 
node2
 = (
dx_node
 *)(
bh2
->
b_d©a
);

2343 
íåõs2
 = 
node2
->
íåõs
;

2344 
	`mem£t
(&
node2
->
Áke
, 0, (
Áke_dúít
));

2345 
node2
->
Áke
.
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
sb
->
s_blocksize
,

2346 
sb
->
s_blocksize
);

2347 
	`BUFFER_TRACE
(
‰ame
->
bh
, "get_write_access");

2348 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
‰ame
->
bh
);

2349 i‡(
îr
)

2350 
jou∫Æ_îr‹
;

2351 i‡(!
add_Àvñ
) {

2352 
icou¡1
 = 
icou¡
/2, 
icou¡2
 = icount - icount1;

2353 
hash2
 = 
	`dx_gë_hash
(
íåõs
 + 
icou¡1
);

2354 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "Split index %i/%i\n",

2355 
icou¡1
, 
icou¡2
));

2357 
	`BUFFER_TRACE
(
‰ame
->
bh
, "get_write_access");

2358 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

2359 (
‰ame
 - 1)->
bh
);

2360 i‡(
îr
)

2361 
jou∫Æ_îr‹
;

2363 
	`mem˝y
((*Ë
íåõs2
, (*Ë(
íåõs
 + 
icou¡1
),

2364 
icou¡2
 * (
dx_íåy
));

2365 
	`dx_£t_cou¡
(
íåõs
, 
icou¡1
);

2366 
	`dx_£t_cou¡
(
íåõs2
, 
icou¡2
);

2367 
	`dx_£t_limô
(
íåõs2
, 
	`dx_node_limô
(
dú
));

2370 i‡(
©
 - 
íåõs
 >
icou¡1
) {

2371 
‰ame
->
©
 =áà© - 
íåõs
 - 
icou¡1
 + 
íåõs2
;

2372 
‰ame
->
íåõs
 =É¡rõ†
íåõs2
;

2373 
	`sw≠
(
‰ame
->
bh
, 
bh2
);

2375 
	`dx_ö£π_block
((
‰ame
 - 1), 
hash2
, 
√wblock
);

2376 
	`dxåa˚
(
	`dx_show_ödex
("node", 
‰ame
->
íåõs
));

2377 
	`dxåa˚
(
	`dx_show_ödex
("node",

2378 ((
dx_node
 *Ë
bh2
->
b_d©a
)->
íåõs
));

2379 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
bh2
);

2380 i‡(
îr
)

2381 
jou∫Æ_îr‹
;

2382 
	`bªl£
 (
bh2
);

2383 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
,

2384 (
‰ame
 - 1)->
bh
);

2385 i‡(
îr
)

2386 
jou∫Æ_îr‹
;

2387 i‡(
ª°¨t
) {

2388 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
,

2389 
‰ame
->
bh
);

2390 
jou∫Æ_îr‹
;

2393 
dx_roŸ
 *
dxroŸ
;

2394 
	`mem˝y
((*Ë
íåõs2
, (*Ë
íåõs
,

2395 
icou¡
 * (
dx_íåy
));

2396 
	`dx_£t_limô
(
íåõs2
, 
	`dx_node_limô
(
dú
));

2399 
	`dx_£t_cou¡
(
íåõs
, 1);

2400 
	`dx_£t_block
(
íåõs
 + 0, 
√wblock
);

2401 
dxroŸ
 = (
dx_roŸ
 *)
‰ames
[0].
bh
->
b_d©a
;

2402 
dxroŸ
->
öfo
.
ödúe˘_Àvñs
 += 1;

2403 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG


2405 
dxroŸ
->
öfo
.
ödúe˘_Àvñs
));

2406 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
‰ame
->
bh
);

2407 i‡(
îr
)

2408 
jou∫Æ_îr‹
;

2409 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
bh2
);

2410 
	`bªl£
(
bh2
);

2411 
ª°¨t
 = 1;

2412 
jou∫Æ_îr‹
;

2415 
de
 = 
	`do_•lô
(
h™dÀ
, 
dú
, &
bh
, 
‰ame
, &
‚ame
->
höfo
);

2416 i‡(
	`IS_ERR
(
de
)) {

2417 
îr
 = 
	`PTR_ERR
(
de
);

2418 
˛ónup
;

2420 
îr
 = 
	`add_dúít_to_buf
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, 
de
, 
bh
);

2421 
˛ónup
;

2423 
jou∫Æ_îr‹
:

2424 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2425 
˛ónup
:

2426 
	`bªl£
(
bh
);

2427 
	`dx_ªÀa£
(
‰ames
);

2431 i‡(
ª°¨t
 && 
îr
 == 0)

2432 
agaö
;

2433  
îr
;

2434 
	}
}

2440 
	$pxt4_gíîic_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
,

2441 
öode
 *
dú
,

2442 
pxt4_dú_íåy_2
 *
de_dñ
,

2443 
buf„r_hód
 *
bh
,

2444 *
íåy_buf
,

2445 
buf_size
,

2446 
csum_size
)

2448 
pxt4_dú_íåy_2
 *
de
, *
pde
;

2449 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

2450 
i
;

2452 
i
 = 0;

2453 
pde
 = 
NULL
;

2454 
de
 = (
pxt4_dú_íåy_2
 *)
íåy_buf
;

2455 
i
 < 
buf_size
 - 
csum_size
) {

2456 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

2457 
bh
->
b_d©a
, bh->
b_size
, 
i
))

2458  -
EFSCORRUPTED
;

2459 i‡(
de
 =
de_dñ
) {

2460 i‡(
pde
)

2461 
pde
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

2462 
	`pxt4_ªc_Àn_‰om_disk
(
pde
->
ªc_Àn
,

2463 
blocksize
) +

2464 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

2465 
blocksize
),

2466 
blocksize
);

2468 
de
->
öode
 = 0;

2469 
	`öode_öc_ivîsi⁄
(
dú
);

2472 
i
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
blocksize
);

2473 
pde
 = 
de
;

2474 
de
 = 
	`pxt4_√xt_íåy
(de, 
blocksize
);

2476  -
ENOENT
;

2477 
	}
}

2479 
	$pxt4_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
,

2480 
öode
 *
dú
,

2481 
pxt4_dú_íåy_2
 *
de_dñ
,

2482 
buf„r_hód
 *
bh
)

2484 
îr
, 
csum_size
 = 0;

2486 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

2487 
has_ölöe_d©a
 = 1;

2488 
îr
 = 
	`pxt4_dñëe_ölöe_íåy
(
h™dÀ
, 
dú
, 
de_dñ
, 
bh
,

2489 &
has_ölöe_d©a
);

2490 i‡(
has_ölöe_d©a
)

2491  
îr
;

2494 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

2495 
csum_size
 = (
pxt4_dú_íåy_èû
);

2497 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2498 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2499 i‡(
	`u∆ikñy
(
îr
))

2500 
out
;

2502 
îr
 = 
	`pxt4_gíîic_dñëe_íåy
(
h™dÀ
, 
dú
, 
de_dñ
,

2503 
bh
, bh->
b_d©a
,

2504 
dú
->
i_sb
->
s_blocksize
, 
csum_size
);

2505 i‡(
îr
)

2506 
out
;

2508 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

2509 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
dú
, 
bh
);

2510 i‡(
	`u∆ikñy
(
îr
))

2511 
out
;

2514 
out
:

2515 i‡(
îr
 !-
ENOENT
)

2516 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2517  
îr
;

2518 
	}
}

2531 
	$pxt4_öc_cou¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2533 
	`öc_∆ök
(
öode
);

2534 i‡(
	`is_dx
(
öode
) &&

2535 (
öode
->
i_∆ök
 > 
PXT4_LINK_MAX
 || inode->i_nlink == 2))

2536 
	`£t_∆ök
(
öode
, 1);

2537 
	}
}

2543 
	$pxt4_dec_cou¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2545 i‡(!
	`S_ISDIR
(
öode
->
i_mode
Ë|| inode->
i_∆ök
 > 2)

2546 
	`dr›_∆ök
(
öode
);

2547 
	}
}

2550 
	$pxt4_add_n⁄dú
(
h™dÀ_t
 *
h™dÀ
,

2551 
díåy
 *díåy, 
öode
 *inode)

2553 
îr
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
díåy
, 
öode
);

2554 i‡(!
îr
) {

2555 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2556 
	`d_ö°™tüã_√w
(
díåy
, 
öode
);

2559 
	`dr›_∆ök
(
öode
);

2560 
	`u∆ock_√w_öode
(
öode
);

2561 
	`ùut
(
öode
);

2562  
îr
;

2563 
	}
}

2573 
	$pxt4_¸óã
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
,

2574 
boﬁ
 
ex˛
)

2576 
h™dÀ_t
 *
h™dÀ
;

2577 
öode
 *inode;

2578 
îr
, 
¸edôs
, 
ªåõs
 = 0;

2580 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2581 i‡(
îr
)

2582  
îr
;

2584 
¸edôs
 = (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

2585 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2586 
ªåy
:

2587 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
, &
díåy
->
d_«me
, 0,

2588 
NULL
, 
PXT4_HT_DIR
, 
¸edôs
);

2589 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2590 
îr
 = 
	`PTR_ERR
(
öode
);

2591 i‡(!
	`IS_ERR
(
öode
)) {

2592 
öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

2593 
öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

2594 
	`pxt4_£t_a›s
(
öode
);

2595 
îr
 = 
	`pxt4_add_n⁄dú
(
h™dÀ
, 
díåy
, 
öode
);

2596 i‡(!
îr
 && 
	`IS_DIRSYNC
(
dú
))

2597 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2599 i‡(
h™dÀ
)

2600 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2601 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2602 
ªåy
;

2603  
îr
;

2604 
	}
}

2606 
	$pxt4_mknod
(
öode
 *
dú
, 
díåy
 *dentry,

2607 
umode_t
 
mode
, 
dev_t
 
rdev
)

2609 
h™dÀ_t
 *
h™dÀ
;

2610 
öode
 *inode;

2611 
îr
, 
¸edôs
, 
ªåõs
 = 0;

2613 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2614 i‡(
îr
)

2615  
îr
;

2617 
¸edôs
 = (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

2618 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2619 
ªåy
:

2620 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
, &
díåy
->
d_«me
, 0,

2621 
NULL
, 
PXT4_HT_DIR
, 
¸edôs
);

2622 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2623 
îr
 = 
	`PTR_ERR
(
öode
);

2624 i‡(!
	`IS_ERR
(
öode
)) {

2625 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
, 
rdev
);

2626 
öode
->
i_›
 = &
pxt4_•ecül_öode_›î©i⁄s
;

2627 
îr
 = 
	`pxt4_add_n⁄dú
(
h™dÀ
, 
díåy
, 
öode
);

2628 i‡(!
îr
 && 
	`IS_DIRSYNC
(
dú
))

2629 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2631 i‡(
h™dÀ
)

2632 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2633 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2634 
ªåy
;

2635  
îr
;

2636 
	}
}

2638 
	$pxt4_tmpfûe
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
)

2640 
h™dÀ_t
 *
h™dÀ
;

2641 
öode
 *inode;

2642 
îr
, 
ªåõs
 = 0;

2644 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2645 i‡(
îr
)

2646  
îr
;

2648 
ªåy
:

2649 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
,

2650 
NULL
, 0, NULL,

2651 
PXT4_HT_DIR
,

2652 
	`PXT4_MAXQUOTAS_INIT_BLOCKS
(
dú
->
i_sb
) +

2653 4 + 
PXT4_XATTR_TRANS_BLOCKS
);

2654 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2655 
îr
 = 
	`PTR_ERR
(
öode
);

2656 i‡(!
	`IS_ERR
(
öode
)) {

2657 
öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

2658 
öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

2659 
	`pxt4_£t_a›s
(
öode
);

2660 
	`d_tmpfûe
(
díåy
, 
öode
);

2661 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

2662 i‡(
îr
)

2663 
îr_u∆ock_öode
;

2664 
	`m¨k_öode_dúty
(
öode
);

2665 
	`u∆ock_√w_öode
(
öode
);

2667 i‡(
h™dÀ
)

2668 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2669 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2670 
ªåy
;

2671  
îr
;

2672 
îr_u∆ock_öode
:

2673 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2674 
	`u∆ock_√w_öode
(
öode
);

2675  
îr
;

2676 
	}
}

2678 
pxt4_dú_íåy_2
 *
	$pxt4_öô_dŸ_dŸdŸ
(
öode
 *inode,

2679 
pxt4_dú_íåy_2
 *
de
,

2680 
blocksize
, 
csum_size
,

2681 
∑ª¡_öo
, 
dŸdŸ_ªÆ_Àn
)

2683 
de
->
öode
 = 
	`˝u_to_À32
(öode->
i_öo
);

2684 
de
->
«me_Àn
 = 1;

2685 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
	`PXT4_DIR_REC_LEN
(de->
«me_Àn
),

2686 
blocksize
);

2687 
	`°r˝y
(
de
->
«me
, ".");

2688 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, 
de
, 
S_IFDIR
);

2690 
de
 = 
	`pxt4_√xt_íåy
(de, 
blocksize
);

2691 
de
->
öode
 = 
	`˝u_to_À32
(
∑ª¡_öo
);

2692 
de
->
«me_Àn
 = 2;

2693 i‡(!
dŸdŸ_ªÆ_Àn
)

2694 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
blocksize
 -

2695 (
csum_size
 + 
	`PXT4_DIR_REC_LEN
(1)),

2696 
blocksize
);

2698 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

2699 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
), 
blocksize
);

2700 
	`°r˝y
(
de
->
«me
, "..");

2701 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, 
de
, 
S_IFDIR
);

2703  
	`pxt4_√xt_íåy
(
de
, 
blocksize
);

2704 
	}
}

2706 
	$pxt4_öô_√w_dú
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

2707 
öode
 *inode)

2709 
buf„r_hód
 *
dú_block
 = 
NULL
;

2710 
pxt4_dú_íåy_2
 *
de
;

2711 
pxt4_lblk_t
 
block
 = 0;

2712 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

2713 
csum_size
 = 0;

2714 
îr
;

2716 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

2717 
csum_size
 = (
pxt4_dú_íåy_èû
);

2719 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
)) {

2720 
îr
 = 
	`pxt4_åy_¸óã_ölöe_dú
(
h™dÀ
, 
dú
, 
öode
);

2721 i‡(
îr
 < 0 &&Éº !-
ENOSPC
)

2722 
out
;

2723 i‡(!
îr
)

2724 
out
;

2727 
öode
->
i_size
 = 0;

2728 
dú_block
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
öode
, &
block
);

2729 i‡(
	`IS_ERR
(
dú_block
))

2730  
	`PTR_ERR
(
dú_block
);

2731 
de
 = (
pxt4_dú_íåy_2
 *)
dú_block
->
b_d©a
;

2732 
	`pxt4_öô_dŸ_dŸdŸ
(
öode
, 
de
, 
blocksize
, 
csum_size
, 
dú
->
i_öo
, 0);

2733 
	`£t_∆ök
(
öode
, 2);

2734 i‡(
csum_size
)

2735 
	`pxt4_öôülize_dúít_èû
(
dú_block
, 
blocksize
);

2737 
	`BUFFER_TRACE
(
dú_block
, "callÖxt4_handle_dirty_metadata");

2738 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
öode
, 
dú_block
);

2739 i‡(
îr
)

2740 
out
;

2741 
	`£t_buf„r_vîifõd
(
dú_block
);

2742 
out
:

2743 
	`bªl£
(
dú_block
);

2744  
îr
;

2745 
	}
}

2747 
	$pxt4_mkdú
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
)

2749 
h™dÀ_t
 *
h™dÀ
;

2750 
öode
 *inode;

2751 
îr
, 
¸edôs
, 
ªåõs
 = 0;

2753 i‡(
	`PXT4_DIR_LINK_MAX
(
dú
))

2754  -
EMLINK
;

2756 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2757 i‡(
îr
)

2758  
îr
;

2760 
¸edôs
 = (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

2761 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2762 
ªåy
:

2763 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
S_IFDIR
 | 
mode
,

2764 &
díåy
->
d_«me
,

2765 0, 
NULL
, 
PXT4_HT_DIR
, 
¸edôs
);

2766 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2767 
îr
 = 
	`PTR_ERR
(
öode
);

2768 i‡(
	`IS_ERR
(
öode
))

2769 
out_°›
;

2771 
öode
->
i_›
 = &
pxt4_dú_öode_›î©i⁄s
;

2772 
öode
->
i_f›
 = &
pxt4_dú_›î©i⁄s
;

2773 
îr
 = 
	`pxt4_öô_√w_dú
(
h™dÀ
, 
dú
, 
öode
);

2774 i‡(
îr
)

2775 
out_˛ór_öode
;

2776 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2777 i‡(!
îr
)

2778 
îr
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
díåy
, 
öode
);

2779 i‡(
îr
) {

2780 
out_˛ór_öode
:

2781 
	`˛ór_∆ök
(
öode
);

2782 
	`u∆ock_√w_öode
(
öode
);

2783 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2784 
	`ùut
(
öode
);

2785 
out_°›
;

2787 
	`pxt4_öc_cou¡
(
h™dÀ
, 
dú
);

2788 
	`pxt4_upd©e_dx_Êag
(
dú
);

2789 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2790 i‡(
îr
)

2791 
out_˛ór_öode
;

2792 
	`d_ö°™tüã_√w
(
díåy
, 
öode
);

2793 i‡(
	`IS_DIRSYNC
(
dú
))

2794 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2796 
out_°›
:

2797 i‡(
h™dÀ
)

2798 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2799 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2800 
ªåy
;

2801  
îr
;

2802 
	}
}

2807 
boﬁ
 
	$pxt4_em±y_dú
(
öode
 *inode)

2809 
off£t
;

2810 
buf„r_hód
 *
bh
;

2811 
pxt4_dú_íåy_2
 *
de
, *
de1
;

2812 
su≥r_block
 *
sb
;

2814 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

2815 
has_ölöe_d©a
 = 1;

2816 
ªt
;

2818 
ªt
 = 
	`em±y_ölöe_dú
(
öode
, &
has_ölöe_d©a
);

2819 i‡(
has_ölöe_d©a
)

2820  
ªt
;

2823 
sb
 = 
öode
->
i_sb
;

2824 i‡(
öode
->
i_size
 < 
	`PXT4_DIR_REC_LEN
(1) + PXT4_DIR_REC_LEN(2)) {

2825 
	`PXT4_ERROR_INODE
(
öode
, "invalid size");

2826  
åue
;

2831 
bh
 = 
	`pxt4_ªad_dúblock
(
öode
, 0, 
DIRENT_HTREE
);

2832 i‡(
	`IS_ERR
(
bh
))

2833  
åue
;

2835 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

2836 
de1
 = 
	`pxt4_√xt_íåy
(
de
, 
sb
->
s_blocksize
);

2837 i‡(
	`À32_to_˝u
(
de
->
öode
Ë!öode->
i_öo
 ||

2838 
	`À32_to_˝u
(
de1
->
öode
) == 0 ||

2839 
	`°rcmp
(".", 
de
->
«me
Ë|| såcmp("..", 
de1
->name)) {

2840 
	`pxt4_w¨nög_öode
(
öode
, "directory missing '.'ánd/or '..'");

2841 
	`bªl£
(
bh
);

2842  
åue
;

2844 
off£t
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
) +

2845 
	`pxt4_ªc_Àn_‰om_disk
(
de1
->
ªc_Àn
, 
sb
->
s_blocksize
);

2846 
de
 = 
	`pxt4_√xt_íåy
(
de1
, 
sb
->
s_blocksize
);

2847 
off£t
 < 
öode
->
i_size
) {

2848 i‡((*Ë
de
 >(*Ë(
bh
->
b_d©a
+
sb
->
s_blocksize
)) {

2849 
lblock
;

2850 
	`bªl£
(
bh
);

2851 
lblock
 = 
off£t
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

2852 
bh
 = 
	`pxt4_ªad_dúblock
(
öode
, 
lblock
, 
EITHER
);

2853 i‡(
bh
 =
NULL
) {

2854 
off£t
 +
sb
->
s_blocksize
;

2857 i‡(
	`IS_ERR
(
bh
))

2858  
åue
;

2859 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

2861 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
NULL
, 
de
, 
bh
,

2862 
bh
->
b_d©a
, bh->
b_size
, 
off£t
)) {

2863 
de
 = (
pxt4_dú_íåy_2
 *)(
bh
->
b_d©a
 +

2864 
sb
->
s_blocksize
);

2865 
off£t
 = (off£à| (
sb
->
s_blocksize
 - 1)) + 1;

2868 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

2869 
	`bªl£
(
bh
);

2870  
Ál£
;

2872 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
);

2873 
de
 = 
	`pxt4_√xt_íåy
(de, 
sb
->
s_blocksize
);

2875 
	`bªl£
(
bh
);

2876  
åue
;

2877 
	}
}

2891 
	$pxt4_‹ph™_add
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2893 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

2894 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2895 
pxt4_ûoc
 
ûoc
;

2896 
îr
 = 0, 
rc
;

2897 
boﬁ
 
dúty
 = 
Ál£
;

2899 i‡(!
sbi
->
s_jou∫Æ
 || 
	`is_bad_öode
(
öode
))

2902 
	`WARN_ON_ONCE
(!(
öode
->
i_°©e
 & (
I_NEW
 | 
I_FREEING
)) &&

2903 !
	`öode_is_locked
(
öode
));

2908 i‡(!
	`li°_em±y
(&
	`PXT4_I
(
öode
)->
i_‹ph™
))

2917 
	`J_ASSERT
((
	`S_ISREG
(
öode
->
i_mode
Ë|| 
	`S_ISDIR
(inode->i_mode) ||

2918 
	`S_ISLNK
(
öode
->
i_mode
)Ë|| inode->
i_∆ök
 == 0);

2920 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

2921 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

2922 i‡(
îr
)

2923 
out
;

2925 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

2926 i‡(
îr
)

2927 
out
;

2929 
	`muãx_lock
(&
sbi
->
s_‹ph™_lock
);

2934 i‡(!
	`NEXT_ORPHAN
(
öode
) || NEXT_ORPHAN(inode) >

2935 (
	`À32_to_˝u
(
sbi
->
s_es
->
s_öodes_cou¡
))) {

2937 
	`NEXT_ORPHAN
(
öode
Ë
	`À32_to_˝u
(
sbi
->
s_es
->
s_œ°_‹ph™
);

2938 
sbi
->
s_es
->
s_œ°_‹ph™
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

2939 
dúty
 = 
åue
;

2941 
	`li°_add
(&
	`PXT4_I
(
öode
)->
i_‹ph™
, &
sbi
->
s_‹ph™
);

2942 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

2944 i‡(
dúty
) {

2945 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

2946 
rc
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

2947 i‡(!
îr
)

2948 
îr
 = 
rc
;

2949 i‡(
îr
) {

2955 
	`muãx_lock
(&
sbi
->
s_‹ph™_lock
);

2956 
	`li°_dñ_öô
(&
	`PXT4_I
(
öode
)->
i_‹ph™
);

2957 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

2960 
	`bªl£
(
ûoc
.
bh
);

2962 
	`jbd_debug
(4, "su≥rblock wû»poöàtÿ%lu\n", 
öode
->
i_öo
);

2963 
	`jbd_debug
(4, "orphan inode %lu willÖointÅo %d\n",

2964 
öode
->
i_öo
, 
	`NEXT_ORPHAN
(inode));

2965 
out
:

2966 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

2967  
îr
;

2968 
	}
}

2974 
	$pxt4_‹ph™_dñ
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2976 
li°_hód
 *
¥ev
;

2977 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

2978 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2979 
__u32
 
öo_√xt
;

2980 
pxt4_ûoc
 
ûoc
;

2981 
îr
 = 0;

2983 i‡(!
sbi
->
s_jou∫Æ
 && !(sbi->
s_mou¡_°©e
 & 
PXT4_ORPHAN_FS
))

2986 
	`WARN_ON_ONCE
(!(
öode
->
i_°©e
 & (
I_NEW
 | 
I_FREEING
)) &&

2987 !
	`öode_is_locked
(
öode
));

2989 i‡(
	`li°_em±y
(&
ei
->
i_‹ph™
))

2992 i‡(
h™dÀ
) {

2994 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

2997 
	`muãx_lock
(&
sbi
->
s_‹ph™_lock
);

2998 
	`jbd_debug
(4, "ªmovêöodê%lu from oΩh™Üi°\n", 
öode
->
i_öo
);

3000 
¥ev
 = 
ei
->
i_‹ph™
.prev;

3001 
	`li°_dñ_öô
(&
ei
->
i_‹ph™
);

3007 i‡(!
h™dÀ
 || 
îr
) {

3008 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3009 
out_îr
;

3012 
öo_√xt
 = 
	`NEXT_ORPHAN
(
öode
);

3013 i‡(
¥ev
 =&
sbi
->
s_‹ph™
) {

3014 
	`jbd_debug
(4, "su≥rblock wû»poöàtÿ%u\n", 
öo_√xt
);

3015 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

3016 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

3017 i‡(
îr
) {

3018 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3019 
out_bªl£
;

3021 
sbi
->
s_es
->
s_œ°_‹ph™
 = 
	`˝u_to_À32
(
öo_√xt
);

3022 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3023 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
öode
->
i_sb
);

3025 
pxt4_ûoc
 
ûoc2
;

3026 
öode
 *
i_¥ev
 =

3027 &
	`li°_íåy
(
¥ev
, 
pxt4_öode_öfo
, 
i_‹ph™
)->
vfs_öode
;

3029 
	`jbd_debug
(4, "orphan inode %lu willÖointÅo %u\n",

3030 
i_¥ev
->
i_öo
, 
öo_√xt
);

3031 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
i_¥ev
, &
ûoc2
);

3032 i‡(
îr
) {

3033 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3034 
out_bªl£
;

3036 
	`NEXT_ORPHAN
(
i_¥ev
Ë
öo_√xt
;

3037 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
i_¥ev
, &
ûoc2
);

3038 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3040 i‡(
îr
)

3041 
out_bªl£
;

3042 
	`NEXT_ORPHAN
(
öode
) = 0;

3043 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

3044 
out_îr
:

3045 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

3046  
îr
;

3048 
out_bªl£
:

3049 
	`bªl£
(
ûoc
.
bh
);

3050 
out_îr
;

3051 
	}
}

3053 
	$pxt4_rmdú
(
öode
 *
dú
, 
díåy
 *dentry)

3055 
ªtvÆ
;

3056 
öode
 *inode;

3057 
buf„r_hód
 *
bh
;

3058 
pxt4_dú_íåy_2
 *
de
;

3059 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3061 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
dú
->
i_sb
))))

3062  -
EIO
;

3066 
ªtvÆ
 = 
	`dquŸ_öôülize
(
dú
);

3067 i‡(
ªtvÆ
)

3068  
ªtvÆ
;

3069 
ªtvÆ
 = 
	`dquŸ_öôülize
(
	`d_öode
(
díåy
));

3070 i‡(
ªtvÆ
)

3071  
ªtvÆ
;

3073 
ªtvÆ
 = -
ENOENT
;

3074 
bh
 = 
	`pxt4_föd_íåy
(
dú
, &
díåy
->
d_«me
, &
de
, 
NULL
);

3075 i‡(
	`IS_ERR
(
bh
))

3076  
	`PTR_ERR
(
bh
);

3077 i‡(!
bh
)

3078 
íd_rmdú
;

3080 
öode
 = 
	`d_öode
(
díåy
);

3082 
ªtvÆ
 = -
EFSCORRUPTED
;

3083 i‡(
	`À32_to_˝u
(
de
->
öode
Ë!öode->
i_öo
)

3084 
íd_rmdú
;

3086 
ªtvÆ
 = -
ENOTEMPTY
;

3087 i‡(!
	`pxt4_em±y_dú
(
öode
))

3088 
íd_rmdú
;

3090 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3091 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
));

3092 i‡(
	`IS_ERR
(
h™dÀ
)) {

3093 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3094 
h™dÀ
 = 
NULL
;

3095 
íd_rmdú
;

3098 i‡(
	`IS_DIRSYNC
(
dú
))

3099 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3101 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
dú
, 
de
, 
bh
);

3102 i‡(
ªtvÆ
)

3103 
íd_rmdú
;

3104 i‡(!
	`PXT4_DIR_LINK_EMPTY
(
öode
))

3105 
	`pxt4_w¨nög_öode
(
öode
,

3107 
díåy
->
d_«me
.
Àn
, díåy->d_«me.
«me
,

3108 
öode
->
i_∆ök
);

3109 
	`öode_öc_ivîsi⁄
(
öode
);

3110 
	`˛ór_∆ök
(
öode
);

3114 
öode
->
i_size
 = 0;

3115 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3116 
öode
->
i_˘ime
 = 
dú
->i_˘imêdú->
i_mtime
 = 
	`cuºít_time
(inode);

3117 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3118 
	`pxt4_dec_cou¡
(
h™dÀ
, 
dú
);

3119 
	`pxt4_upd©e_dx_Êag
(
dú
);

3120 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

3122 #ifde‡
CONFIG_UNICODE


3129 i‡(
	`IS_CASEFOLDED
(
dú
))

3130 
	`d_övÆid©e
(
díåy
);

3133 
íd_rmdú
:

3134 
	`bªl£
(
bh
);

3135 i‡(
h™dÀ
)

3136 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3137  
ªtvÆ
;

3138 
	}
}

3140 
	$pxt4_u∆ök
(
öode
 *
dú
, 
díåy
 *dentry)

3142 
ªtvÆ
;

3143 
öode
 *inode;

3144 
buf„r_hód
 *
bh
;

3145 
pxt4_dú_íåy_2
 *
de
;

3146 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3148 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
dú
->
i_sb
))))

3149  -
EIO
;

3151 
	`åa˚_pxt4_u∆ök_íãr
(
dú
, 
díåy
);

3154 
ªtvÆ
 = 
	`dquŸ_öôülize
(
dú
);

3155 i‡(
ªtvÆ
)

3156  
ªtvÆ
;

3157 
ªtvÆ
 = 
	`dquŸ_öôülize
(
	`d_öode
(
díåy
));

3158 i‡(
ªtvÆ
)

3159  
ªtvÆ
;

3161 
ªtvÆ
 = -
ENOENT
;

3162 
bh
 = 
	`pxt4_föd_íåy
(
dú
, &
díåy
->
d_«me
, &
de
, 
NULL
);

3163 i‡(
	`IS_ERR
(
bh
))

3164  
	`PTR_ERR
(
bh
);

3165 i‡(!
bh
)

3166 
íd_u∆ök
;

3168 
öode
 = 
	`d_öode
(
díåy
);

3170 
ªtvÆ
 = -
EFSCORRUPTED
;

3171 i‡(
	`À32_to_˝u
(
de
->
öode
Ë!öode->
i_öo
)

3172 
íd_u∆ök
;

3174 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3175 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
));

3176 i‡(
	`IS_ERR
(
h™dÀ
)) {

3177 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3178 
h™dÀ
 = 
NULL
;

3179 
íd_u∆ök
;

3182 i‡(
	`IS_DIRSYNC
(
dú
))

3183 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3185 i‡(
öode
->
i_∆ök
 == 0) {

3186 
	`pxt4_w¨nög_öode
(
öode
, "Deleting file '%.*s' withÇoÜinks",

3187 
díåy
->
d_«me
.
Àn
, díåy->d_«me.
«me
);

3188 
	`£t_∆ök
(
öode
, 1);

3190 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
dú
, 
de
, 
bh
);

3191 i‡(
ªtvÆ
)

3192 
íd_u∆ök
;

3193 
dú
->
i_˘ime
 = dú->
i_mtime
 = 
	`cuºít_time
(dir);

3194 
	`pxt4_upd©e_dx_Êag
(
dú
);

3195 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

3196 
	`dr›_∆ök
(
öode
);

3197 i‡(!
öode
->
i_∆ök
)

3198 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3199 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

3200 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3202 #ifde‡
CONFIG_UNICODE


3209 i‡(
	`IS_CASEFOLDED
(
dú
))

3210 
	`d_övÆid©e
(
díåy
);

3213 
íd_u∆ök
:

3214 
	`bªl£
(
bh
);

3215 i‡(
h™dÀ
)

3216 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3217 
	`åa˚_pxt4_u∆ök_exô
(
díåy
, 
ªtvÆ
);

3218  
ªtvÆ
;

3219 
	}
}

3221 
	$pxt4_symlök
(
öode
 *
dú
,

3222 
díåy
 *díåy, c⁄° *
sym«me
)

3224 
h™dÀ_t
 *
h™dÀ
;

3225 
öode
 *inode;

3226 
îr
, 
Àn
 = 
	`°æí
(
sym«me
);

3227 
¸edôs
;

3228 
fs¸y±_°r
 
disk_lök
;

3230 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
dú
->
i_sb
))))

3231  -
EIO
;

3233 
îr
 = 
	`fs¸y±_¥ï¨e_symlök
(
dú
, 
sym«me
, 
Àn
, dú->
i_sb
->
s_blocksize
,

3234 &
disk_lök
);

3235 i‡(
îr
)

3236  
îr
;

3238 
îr
 = 
	`dquŸ_öôülize
(
dú
);

3239 i‡(
îr
)

3240  
îr
;

3242 i‡((
disk_lök
.
Àn
 > 
PXT4_N_BLOCKS
 * 4)) {

3249 
¸edôs
 = 4 + 
	`PXT4_MAXQUOTAS_INIT_BLOCKS
(
dú
->
i_sb
) +

3250 
PXT4_XATTR_TRANS_BLOCKS
;

3258 
¸edôs
 = 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

3259 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3;

3262 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
S_IFLNK
|
S_IRWXUGO
,

3263 &
díåy
->
d_«me
, 0, 
NULL
,

3264 
PXT4_HT_DIR
, 
¸edôs
);

3265 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

3266 i‡(
	`IS_ERR
(
öode
)) {

3267 i‡(
h™dÀ
)

3268 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3269  
	`PTR_ERR
(
öode
);

3272 i‡(
	`IS_ENCRYPTED
(
öode
)) {

3273 
îr
 = 
	`fs¸y±_í¸y±_symlök
(
öode
, 
sym«me
, 
Àn
, &
disk_lök
);

3274 i‡(
îr
)

3275 
îr_dr›_öode
;

3276 
öode
->
i_›
 = &
pxt4_í¸y±ed_symlök_öode_›î©i⁄s
;

3279 i‡((
disk_lök
.
Àn
 > 
PXT4_N_BLOCKS
 * 4)) {

3280 i‡(!
	`IS_ENCRYPTED
(
öode
))

3281 
öode
->
i_›
 = &
pxt4_symlök_öode_›î©i⁄s
;

3282 
	`öode_nohighmem
(
öode
);

3283 
	`pxt4_£t_a›s
(
öode
);

3294 
	`dr›_∆ök
(
öode
);

3295 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3296 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3297 
h™dÀ
 = 
NULL
;

3298 i‡(
îr
)

3299 
îr_dr›_öode
;

3300 
îr
 = 
	`__∑ge_symlök
(
öode
, 
disk_lök
.
«me
, disk_lök.
Àn
, 1);

3301 i‡(
îr
)

3302 
îr_dr›_öode
;

3307 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3308 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

3309 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 1);

3310 i‡(
	`IS_ERR
(
h™dÀ
)) {

3311 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

3312 
h™dÀ
 = 
NULL
;

3313 
îr_dr›_öode
;

3315 
	`£t_∆ök
(
öode
, 1);

3316 
îr
 = 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3317 i‡(
îr
)

3318 
îr_dr›_öode
;

3321 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

3322 i‡(!
	`IS_ENCRYPTED
(
öode
)) {

3323 
öode
->
i_›
 = &
pxt4_Á°_symlök_öode_›î©i⁄s
;

3324 
öode
->
i_lök
 = (*)&
	`PXT4_I
(öode)->
i_d©a
;

3326 
	`mem˝y
((*)&
	`PXT4_I
(
öode
)->
i_d©a
, 
disk_lök
.
«me
,

3327 
disk_lök
.
Àn
);

3328 
öode
->
i_size
 = 
disk_lök
.
Àn
 - 1;

3330 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

3331 
îr
 = 
	`pxt4_add_n⁄dú
(
h™dÀ
, 
díåy
, 
öode
);

3332 i‡(!
îr
 && 
	`IS_DIRSYNC
(
dú
))

3333 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3335 i‡(
h™dÀ
)

3336 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3337 
out_‰ì_í¸y±ed_lök
;

3339 
îr_dr›_öode
:

3340 i‡(
h™dÀ
)

3341 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3342 
	`˛ór_∆ök
(
öode
);

3343 
	`u∆ock_√w_öode
(
öode
);

3344 
	`ùut
(
öode
);

3345 
out_‰ì_í¸y±ed_lök
:

3346 i‡(
disk_lök
.
«me
 !(*)
sym«me
)

3347 
	`k‰ì
(
disk_lök
.
«me
);

3348  
îr
;

3349 
	}
}

3351 
	$pxt4_lök
(
díåy
 *
ﬁd_díåy
,

3352 
öode
 *
dú
, 
díåy
 *dentry)

3354 
h™dÀ_t
 *
h™dÀ
;

3355 
öode
 *öodê
	`d_öode
(
ﬁd_díåy
);

3356 
îr
, 
ªåõs
 = 0;

3358 i‡(
öode
->
i_∆ök
 >
PXT4_LINK_MAX
)

3359  -
EMLINK
;

3361 
îr
 = 
	`fs¸y±_¥ï¨e_lök
(
ﬁd_díåy
, 
dú
, 
díåy
);

3362 i‡(
îr
)

3363  
îr
;

3365 i‡((
	`pxt4_ã°_öode_Êag
(
dú
, 
PXT4_INODE_PROJINHERIT
)) &&

3366 (!
	`¥ojid_eq
(
	`PXT4_I
(
dú
)->
i_¥ojid
,

3367 
	`PXT4_I
(
ﬁd_díåy
->
d_öode
)->
i_¥ojid
)))

3368  -
EXDEV
;

3370 
îr
 = 
	`dquŸ_öôülize
(
dú
);

3371 i‡(
îr
)

3372  
îr
;

3374 
ªåy
:

3375 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3376 (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

3377 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
) + 1);

3378 i‡(
	`IS_ERR
(
h™dÀ
))

3379  
	`PTR_ERR
(
h™dÀ
);

3381 i‡(
	`IS_DIRSYNC
(
dú
))

3382 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3384 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

3385 
	`pxt4_öc_cou¡
(
h™dÀ
, 
öode
);

3386 
	`ihﬁd
(
öode
);

3388 
îr
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
díåy
, 
öode
);

3389 i‡(!
îr
) {

3390 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3394 i‡(
öode
->
i_∆ök
 == 1)

3395 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3396 
	`d_ö°™tüã
(
díåy
, 
öode
);

3398 
	`dr›_∆ök
(
öode
);

3399 
	`ùut
(
öode
);

3401 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3402 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

3403 
ªåy
;

3404  
îr
;

3405 
	}
}

3413 
buf„r_hód
 *
	$pxt4_gë_fú°_dú_block
(
h™dÀ_t
 *
h™dÀ
,

3414 
öode
 *inode,

3415 *
ªtvÆ
,

3416 
pxt4_dú_íåy_2
 **
∑ª¡_de
,

3417 *
ölöed
)

3419 
buf„r_hód
 *
bh
;

3421 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

3425 
bh
 = 
	`pxt4_ªad_dúblock
(
öode
, 0, 
DIRENT_HTREE
);

3426 i‡(
	`IS_ERR
(
bh
)) {

3427 *
ªtvÆ
 = 
	`PTR_ERR
(
bh
);

3428  
NULL
;

3430 *
∑ª¡_de
 = 
	`pxt4_√xt_íåy
(

3431 (
pxt4_dú_íåy_2
 *)
bh
->
b_d©a
,

3432 
öode
->
i_sb
->
s_blocksize
);

3433  
bh
;

3436 *
ölöed
 = 1;

3437  
	`pxt4_gë_fú°_ölöe_block
(
öode
, 
∑ª¡_de
, 
ªtvÆ
);

3438 
	}
}

3440 
	spxt4_ª«mít
 {

3441 
öode
 *
	mdú
;

3442 
díåy
 *
	mdíåy
;

3443 
öode
 *
	möode
;

3444 
boﬁ
 
	mis_dú
;

3445 
	mdú_∆ök_dñè
;

3448 
buf„r_hód
 *
	mbh
;

3449 
pxt4_dú_íåy_2
 *
	mde
;

3450 
	mölöed
;

3453 
buf„r_hód
 *
	mdú_bh
;

3454 
pxt4_dú_íåy_2
 *
	m∑ª¡_de
;

3455 
	mdú_ölöed
;

3458 
	$pxt4_ª«me_dú_¥ï¨e
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
)

3460 
ªtvÆ
;

3462 
ít
->
dú_bh
 = 
	`pxt4_gë_fú°_dú_block
(
h™dÀ
,É¡->
öode
,

3463 &
ªtvÆ
, &
ít
->
∑ª¡_de
,

3464 &
ít
->
dú_ölöed
);

3465 i‡(!
ít
->
dú_bh
)

3466  
ªtvÆ
;

3467 i‡(
	`À32_to_˝u
(
ít
->
∑ª¡_de
->
öode
Ë!ít->
dú
->
i_öo
)

3468  -
EFSCORRUPTED
;

3469 
	`BUFFER_TRACE
(
ít
->
dú_bh
, "get_write_access");

3470  
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ít
->
dú_bh
);

3471 
	}
}

3473 
	$pxt4_ª«me_dú_föish
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
,

3474 
dú_öo
)

3476 
ªtvÆ
;

3478 
ít
->
∑ª¡_de
->
öode
 = 
	`˝u_to_À32
(
dú_öo
);

3479 
	`BUFFER_TRACE
(
ít
->
dú_bh
, "callÖxt4_handle_dirty_metadata");

3480 i‡(!
ít
->
dú_ölöed
) {

3481 i‡(
	`is_dx
(
ít
->
öode
)) {

3482 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
,

3483 
ít
->
öode
,

3484 
ít
->
dú_bh
);

3486 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
ít
->
öode
,

3487 
ít
->
dú_bh
);

3490 
ªtvÆ
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ít
->
öode
);

3492 i‡(
ªtvÆ
) {

3493 
	`pxt4_°d_îr‹
(
ít
->
dú
->
i_sb
, 
ªtvÆ
);

3494  
ªtvÆ
;

3497 
	}
}

3499 
	$pxt4_£ã¡
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
,

3500 
öo
, 
fûe_ty≥
)

3502 
ªtvÆ
;

3504 
	`BUFFER_TRACE
(
ít
->
bh
, "get writeáccess");

3505 
ªtvÆ
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ít
->
bh
);

3506 i‡(
ªtvÆ
)

3507  
ªtvÆ
;

3508 
ít
->
de
->
öode
 = 
	`˝u_to_À32
(
öo
);

3509 i‡(
	`pxt4_has_„©uª_fûëy≥
(
ít
->
dú
->
i_sb
))

3510 
ít
->
de
->
fûe_ty≥
 = file_type;

3511 
	`öode_öc_ivîsi⁄
(
ít
->
dú
);

3512 
ít
->
dú
->
i_˘ime
 =É¡->dú->
i_mtime
 =

3513 
	`cuºít_time
(
ít
->
dú
);

3514 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ít
->
dú
);

3515 
	`BUFFER_TRACE
(
ít
->
bh
, "callÖxt4_handle_dirty_metadata");

3516 i‡(!
ít
->
ölöed
) {

3517 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
ít
->
dú
,É¡->
bh
);

3518 i‡(
	`u∆ikñy
(
ªtvÆ
)) {

3519 
	`pxt4_°d_îr‹
(
ít
->
dú
->
i_sb
, 
ªtvÆ
);

3520  
ªtvÆ
;

3523 
	`bªl£
(
ít
->
bh
);

3524 
ít
->
bh
 = 
NULL
;

3527 
	}
}

3529 
	$pxt4_föd_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

3530 c⁄° 
q°r
 *
d_«me
)

3532 
ªtvÆ
 = -
ENOENT
;

3533 
buf„r_hód
 *
bh
;

3534 
pxt4_dú_íåy_2
 *
de
;

3536 
bh
 = 
	`pxt4_föd_íåy
(
dú
, 
d_«me
, &
de
, 
NULL
);

3537 i‡(
	`IS_ERR
(
bh
))

3538  
	`PTR_ERR
(
bh
);

3539 i‡(
bh
) {

3540 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
dú
, 
de
, 
bh
);

3541 
	`bªl£
(
bh
);

3543  
ªtvÆ
;

3544 
	}
}

3546 
	$pxt4_ª«me_dñëe
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
,

3547 
f‹˚_ªªad
)

3549 
ªtvÆ
;

3556 i‡(
	`À32_to_˝u
(
ít
->
de
->
öode
Ë!ít->öode->
i_öo
 ||

3557 
ít
->
de
->
«me_Àn
 !ít->
díåy
->
d_«me
.
Àn
 ||

3558 
	`°∫cmp
(
ít
->
de
->
«me
,É¡->
díåy
->
d_«me
.name,

3559 
ít
->
de
->
«me_Àn
) ||

3560 
f‹˚_ªªad
) {

3561 
ªtvÆ
 = 
	`pxt4_föd_dñëe_íåy
(
h™dÀ
, 
ít
->
dú
,

3562 &
ít
->
díåy
->
d_«me
);

3564 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
ít
->
dú
,É¡->
de
,É¡->
bh
);

3565 i‡(
ªtvÆ
 =-
ENOENT
) {

3566 
ªtvÆ
 = 
	`pxt4_föd_dñëe_íåy
(
h™dÀ
, 
ít
->
dú
,

3567 &
ít
->
díåy
->
d_«me
);

3571 i‡(
ªtvÆ
) {

3572 
	`pxt4_w¨nög_öode
(
ít
->
dú
,

3574 
ít
->
dú
->
i_∆ök
, 
ªtvÆ
);

3576 
	}
}

3578 
	$pxt4_upd©e_dú_cou¡
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
)

3580 i‡(
ít
->
dú_∆ök_dñè
) {

3581 i‡(
ít
->
dú_∆ök_dñè
 == -1)

3582 
	`pxt4_dec_cou¡
(
h™dÀ
, 
ít
->
dú
);

3584 
	`pxt4_öc_cou¡
(
h™dÀ
, 
ít
->
dú
);

3585 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ít
->
dú
);

3587 
	}
}

3589 
öode
 *
	$pxt4_whôeout_f‹_ª«me
(
pxt4_ª«mít
 *
ít
,

3590 
¸edôs
, 
h™dÀ_t
 **
h
)

3592 
öode
 *
wh
;

3593 
h™dÀ_t
 *
h™dÀ
;

3594 
ªåõs
 = 0;

3600 
¸edôs
 +(
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
ít
->
dú
->
i_sb
) +

3601 
PXT4_XATTR_TRANS_BLOCKS
 + 4);

3602 
ªåy
:

3603 
wh
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
ít
->
dú
, 
S_IFCHR
 | 
WHITEOUT_MODE
,

3604 &
ít
->
díåy
->
d_«me
, 0, 
NULL
,

3605 
PXT4_HT_DIR
, 
¸edôs
);

3607 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

3608 i‡(
	`IS_ERR
(
wh
)) {

3609 i‡(
h™dÀ
)

3610 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3611 i‡(
	`PTR_ERR
(
wh
Ë=-
ENOSPC
 &&

3612 
	`pxt4_should_ªåy_Æloc
(
ít
->
dú
->
i_sb
, &
ªåõs
))

3613 
ªåy
;

3615 *
h
 = 
h™dÀ
;

3616 
	`öô_•ecül_öode
(
wh
, wh->
i_mode
, 
WHITEOUT_DEV
);

3617 
wh
->
i_›
 = &
pxt4_•ecül_öode_›î©i⁄s
;

3619  
wh
;

3620 
	}
}

3630 
	$pxt4_ª«me
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

3631 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
,

3632 
Êags
)

3634 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3635 
pxt4_ª«mít
 
ﬁd
 = {

3636 .
dú
 = 
ﬁd_dú
,

3637 .
díåy
 = 
ﬁd_díåy
,

3638 .
öode
 = 
	`d_öode
(
ﬁd_díåy
),

3640 
pxt4_ª«mít
 
√w
 = {

3641 .
dú
 = 
√w_dú
,

3642 .
díåy
 = 
√w_díåy
,

3643 .
öode
 = 
	`d_öode
(
√w_díåy
),

3645 
f‹˚_ªªad
;

3646 
ªtvÆ
;

3647 
öode
 *
whôeout
 = 
NULL
;

3648 
¸edôs
;

3649 
u8
 
ﬁd_fûe_ty≥
;

3651 i‡(
√w
.
öode
 &&Çew.öode->
i_∆ök
 == 0) {

3652 
	`PXT4_ERROR_INODE
(
√w
.
öode
,

3654  -
EFSCORRUPTED
;

3657 i‡((
	`pxt4_ã°_öode_Êag
(
√w_dú
, 
PXT4_INODE_PROJINHERIT
)) &&

3658 (!
	`¥ojid_eq
(
	`PXT4_I
(
√w_dú
)->
i_¥ojid
,

3659 
	`PXT4_I
(
ﬁd_díåy
->
d_öode
)->
i_¥ojid
)))

3660  -
EXDEV
;

3662 
ªtvÆ
 = 
	`dquŸ_öôülize
(
ﬁd
.
dú
);

3663 i‡(
ªtvÆ
)

3664  
ªtvÆ
;

3665 
ªtvÆ
 = 
	`dquŸ_öôülize
(
√w
.
dú
);

3666 i‡(
ªtvÆ
)

3667  
ªtvÆ
;

3671 i‡(
√w
.
öode
) {

3672 
ªtvÆ
 = 
	`dquŸ_öôülize
(
√w
.
öode
);

3673 i‡(
ªtvÆ
)

3674  
ªtvÆ
;

3677 
ﬁd
.
bh
 = 
	`pxt4_föd_íåy
(ﬁd.
dú
, &ﬁd.
díåy
->
d_«me
, &ﬁd.
de
, 
NULL
);

3678 i‡(
	`IS_ERR
(
ﬁd
.
bh
))

3679  
	`PTR_ERR
(
ﬁd
.
bh
);

3686 
ªtvÆ
 = -
ENOENT
;

3687 i‡(!
ﬁd
.
bh
 || 
	`À32_to_˝u
(ﬁd.
de
->
öode
Ë!ﬁd.öode->
i_öo
)

3688 
íd_ª«me
;

3690 
√w
.
bh
 = 
	`pxt4_föd_íåy
“ew.
dú
, &√w.
díåy
->
d_«me
,

3691 &
√w
.
de
, &√w.
ölöed
);

3692 i‡(
	`IS_ERR
(
√w
.
bh
)) {

3693 
ªtvÆ
 = 
	`PTR_ERR
(
√w
.
bh
);

3694 
√w
.
bh
 = 
NULL
;

3695 
íd_ª«me
;

3697 i‡(
√w
.
bh
) {

3698 i‡(!
√w
.
öode
) {

3699 
	`bªl£
(
√w
.
bh
);

3700 
√w
.
bh
 = 
NULL
;

3703 i‡(
√w
.
öode
 && !
	`ã°_›t
“ew.
dú
->
i_sb
, 
NO_AUTO_DA_ALLOC
))

3704 
	`pxt4_Æloc_da_blocks
(
ﬁd
.
öode
);

3706 
¸edôs
 = (2 * 
	`PXT4_DATA_TRANS_BLOCKS
(
ﬁd
.
dú
->
i_sb
) +

3707 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 2);

3708 i‡(!(
Êags
 & 
RENAME_WHITEOUT
)) {

3709 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
ﬁd
.
dú
, 
PXT4_HT_DIR
, 
¸edôs
);

3710 i‡(
	`IS_ERR
(
h™dÀ
)) {

3711 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3712 
h™dÀ
 = 
NULL
;

3713 
íd_ª«me
;

3716 
whôeout
 = 
	`pxt4_whôeout_f‹_ª«me
(&
ﬁd
, 
¸edôs
, &
h™dÀ
);

3717 i‡(
	`IS_ERR
(
whôeout
)) {

3718 
ªtvÆ
 = 
	`PTR_ERR
(
whôeout
);

3719 
whôeout
 = 
NULL
;

3720 
íd_ª«me
;

3724 i‡(
	`IS_DIRSYNC
(
ﬁd
.
dú
Ë|| IS_DIRSYNC(
√w
.dir))

3725 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3727 i‡(
	`S_ISDIR
(
ﬁd
.
öode
->
i_mode
)) {

3728 i‡(
√w
.
öode
) {

3729 
ªtvÆ
 = -
ENOTEMPTY
;

3730 i‡(!
	`pxt4_em±y_dú
(
√w
.
öode
))

3731 
íd_ª«me
;

3733 
ªtvÆ
 = -
EMLINK
;

3734 i‡(
√w
.
dú
 !
ﬁd
.dú && 
	`PXT4_DIR_LINK_MAX
(new.dir))

3735 
íd_ª«me
;

3737 
ªtvÆ
 = 
	`pxt4_ª«me_dú_¥ï¨e
(
h™dÀ
, &
ﬁd
);

3738 i‡(
ªtvÆ
)

3739 
íd_ª«me
;

3748 
f‹˚_ªªad
 = (
√w
.
dú
->
i_öo
 =
ﬁd
.dir->i_ino &&

3749 
	`pxt4_ã°_öode_Êag
(
√w
.
dú
, 
PXT4_INODE_INLINE_DATA
));

3751 
ﬁd_fûe_ty≥
 = 
ﬁd
.
de
->
fûe_ty≥
;

3752 i‡(
whôeout
) {

3757 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
ﬁd
, 
whôeout
->
i_öo
,

3758 
PXT4_FT_CHRDEV
);

3759 i‡(
ªtvÆ
)

3760 
íd_ª«me
;

3761 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
whôeout
);

3763 i‡(!
√w
.
bh
) {

3764 
ªtvÆ
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
√w
.
díåy
, 
ﬁd
.
öode
);

3765 i‡(
ªtvÆ
)

3766 
íd_ª«me
;

3768 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
√w
,

3769 
ﬁd
.
öode
->
i_öo
, 
ﬁd_fûe_ty≥
);

3770 i‡(
ªtvÆ
)

3771 
íd_ª«me
;

3773 i‡(
f‹˚_ªªad
)

3774 
f‹˚_ªªad
 = !
	`pxt4_ã°_öode_Êag
(
√w
.
dú
,

3775 
PXT4_INODE_INLINE_DATA
);

3781 
ﬁd
.
öode
->
i_˘ime
 = 
	`cuºít_time
(old.inode);

3782 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ﬁd
.
öode
);

3784 i‡(!
whôeout
) {

3788 
	`pxt4_ª«me_dñëe
(
h™dÀ
, &
ﬁd
, 
f‹˚_ªªad
);

3791 i‡(
√w
.
öode
) {

3792 
	`pxt4_dec_cou¡
(
h™dÀ
, 
√w
.
öode
);

3793 
√w
.
öode
->
i_˘ime
 = 
	`cuºít_time
(new.inode);

3795 
ﬁd
.
dú
->
i_˘ime
 = old.dú->
i_mtime
 = 
	`cuºít_time
(old.dir);

3796 
	`pxt4_upd©e_dx_Êag
(
ﬁd
.
dú
);

3797 i‡(
ﬁd
.
dú_bh
) {

3798 
ªtvÆ
 = 
	`pxt4_ª«me_dú_föish
(
h™dÀ
, &
ﬁd
, 
√w
.
dú
->
i_öo
);

3799 i‡(
ªtvÆ
)

3800 
íd_ª«me
;

3802 
	`pxt4_dec_cou¡
(
h™dÀ
, 
ﬁd
.
dú
);

3803 i‡(
√w
.
öode
) {

3807 
	`˛ór_∆ök
(
√w
.
öode
);

3809 
	`pxt4_öc_cou¡
(
h™dÀ
, 
√w
.
dú
);

3810 
	`pxt4_upd©e_dx_Êag
(
√w
.
dú
);

3811 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
√w
.
dú
);

3814 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ﬁd
.
dú
);

3815 i‡(
√w
.
öode
) {

3816 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
√w
.
öode
);

3817 i‡(!
√w
.
öode
->
i_∆ök
)

3818 
	`pxt4_‹ph™_add
(
h™dÀ
, 
√w
.
öode
);

3820 
ªtvÆ
 = 0;

3822 
íd_ª«me
:

3823 
	`bªl£
(
ﬁd
.
dú_bh
);

3824 
	`bªl£
(
ﬁd
.
bh
);

3825 
	`bªl£
(
√w
.
bh
);

3826 i‡(
whôeout
) {

3827 i‡(
ªtvÆ
)

3828 
	`dr›_∆ök
(
whôeout
);

3829 
	`u∆ock_√w_öode
(
whôeout
);

3830 
	`ùut
(
whôeout
);

3832 i‡(
h™dÀ
)

3833 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3834  
ªtvÆ
;

3835 
	}
}

3837 
	$pxt4_¸oss_ª«me
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

3838 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
)

3840 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3841 
pxt4_ª«mít
 
ﬁd
 = {

3842 .
dú
 = 
ﬁd_dú
,

3843 .
díåy
 = 
ﬁd_díåy
,

3844 .
öode
 = 
	`d_öode
(
ﬁd_díåy
),

3846 
pxt4_ª«mít
 
√w
 = {

3847 .
dú
 = 
√w_dú
,

3848 .
díåy
 = 
√w_díåy
,

3849 .
öode
 = 
	`d_öode
(
√w_díåy
),

3851 
u8
 
√w_fûe_ty≥
;

3852 
ªtvÆ
;

3853 
time•ec64
 
˘ime
;

3855 i‡((
	`pxt4_ã°_öode_Êag
(
√w_dú
, 
PXT4_INODE_PROJINHERIT
) &&

3856 !
	`¥ojid_eq
(
	`PXT4_I
(
√w_dú
)->
i_¥ojid
,

3857 
	`PXT4_I
(
ﬁd_díåy
->
d_öode
)->
i_¥ojid
)) ||

3858 (
	`pxt4_ã°_öode_Êag
(
ﬁd_dú
, 
PXT4_INODE_PROJINHERIT
) &&

3859 !
	`¥ojid_eq
(
	`PXT4_I
(
ﬁd_dú
)->
i_¥ojid
,

3860 
	`PXT4_I
(
√w_díåy
->
d_öode
)->
i_¥ojid
)))

3861  -
EXDEV
;

3863 
ªtvÆ
 = 
	`dquŸ_öôülize
(
ﬁd
.
dú
);

3864 i‡(
ªtvÆ
)

3865  
ªtvÆ
;

3866 
ªtvÆ
 = 
	`dquŸ_öôülize
(
√w
.
dú
);

3867 i‡(
ªtvÆ
)

3868  
ªtvÆ
;

3870 
ﬁd
.
bh
 = 
	`pxt4_föd_íåy
(ﬁd.
dú
, &ﬁd.
díåy
->
d_«me
,

3871 &
ﬁd
.
de
, &ﬁd.
ölöed
);

3872 i‡(
	`IS_ERR
(
ﬁd
.
bh
))

3873  
	`PTR_ERR
(
ﬁd
.
bh
);

3880 
ªtvÆ
 = -
ENOENT
;

3881 i‡(!
ﬁd
.
bh
 || 
	`À32_to_˝u
(ﬁd.
de
->
öode
Ë!ﬁd.öode->
i_öo
)

3882 
íd_ª«me
;

3884 
√w
.
bh
 = 
	`pxt4_föd_íåy
“ew.
dú
, &√w.
díåy
->
d_«me
,

3885 &
√w
.
de
, &√w.
ölöed
);

3886 i‡(
	`IS_ERR
(
√w
.
bh
)) {

3887 
ªtvÆ
 = 
	`PTR_ERR
(
√w
.
bh
);

3888 
√w
.
bh
 = 
NULL
;

3889 
íd_ª«me
;

3893 i‡(!
√w
.
bh
 || 
	`À32_to_˝u
“ew.
de
->
öode
Ë!√w.öode->
i_öo
)

3894 
íd_ª«me
;

3896 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
ﬁd
.
dú
, 
PXT4_HT_DIR
,

3897 (2 * 
	`PXT4_DATA_TRANS_BLOCKS
(
ﬁd
.
dú
->
i_sb
) +

3898 2 * 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 2));

3899 i‡(
	`IS_ERR
(
h™dÀ
)) {

3900 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3901 
h™dÀ
 = 
NULL
;

3902 
íd_ª«me
;

3905 i‡(
	`IS_DIRSYNC
(
ﬁd
.
dú
Ë|| IS_DIRSYNC(
√w
.dir))

3906 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3908 i‡(
	`S_ISDIR
(
ﬁd
.
öode
->
i_mode
)) {

3909 
ﬁd
.
is_dú
 = 
åue
;

3910 
ªtvÆ
 = 
	`pxt4_ª«me_dú_¥ï¨e
(
h™dÀ
, &
ﬁd
);

3911 i‡(
ªtvÆ
)

3912 
íd_ª«me
;

3914 i‡(
	`S_ISDIR
(
√w
.
öode
->
i_mode
)) {

3915 
√w
.
is_dú
 = 
åue
;

3916 
ªtvÆ
 = 
	`pxt4_ª«me_dú_¥ï¨e
(
h™dÀ
, &
√w
);

3917 i‡(
ªtvÆ
)

3918 
íd_ª«me
;

3925 i‡(
ﬁd
.
dú
 !
√w
.dú && old.
is_dú
 !=Çew.is_dir) {

3926 
ﬁd
.
dú_∆ök_dñè
 = old.
is_dú
 ? -1 : 1;

3927 
√w
.
dú_∆ök_dñè
 = -
ﬁd
.dir_nlink_delta;

3928 
ªtvÆ
 = -
EMLINK
;

3929 i‡((
ﬁd
.
dú_∆ök_dñè
 > 0 && 
	`PXT4_DIR_LINK_MAX
(ﬁd.
dú
)) ||

3930 (
√w
.
dú_∆ök_dñè
 > 0 && 
	`PXT4_DIR_LINK_MAX
“ew.
dú
)))

3931 
íd_ª«me
;

3934 
√w_fûe_ty≥
 = 
√w
.
de
->
fûe_ty≥
;

3935 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
√w
, 
ﬁd
.
öode
->
i_öo
, old.
de
->
fûe_ty≥
);

3936 i‡(
ªtvÆ
)

3937 
íd_ª«me
;

3939 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
ﬁd
, 
√w
.
öode
->
i_öo
, 
√w_fûe_ty≥
);

3940 i‡(
ªtvÆ
)

3941 
íd_ª«me
;

3947 
˘ime
 = 
	`cuºít_time
(
ﬁd
.
öode
);

3948 
ﬁd
.
öode
->
i_˘ime
 = 
˘ime
;

3949 
√w
.
öode
->
i_˘ime
 = 
˘ime
;

3950 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ﬁd
.
öode
);

3951 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
√w
.
öode
);

3953 i‡(
ﬁd
.
dú_bh
) {

3954 
ªtvÆ
 = 
	`pxt4_ª«me_dú_föish
(
h™dÀ
, &
ﬁd
, 
√w
.
dú
->
i_öo
);

3955 i‡(
ªtvÆ
)

3956 
íd_ª«me
;

3958 i‡(
√w
.
dú_bh
) {

3959 
ªtvÆ
 = 
	`pxt4_ª«me_dú_föish
(
h™dÀ
, &
√w
, 
ﬁd
.
dú
->
i_öo
);

3960 i‡(
ªtvÆ
)

3961 
íd_ª«me
;

3963 
	`pxt4_upd©e_dú_cou¡
(
h™dÀ
, &
ﬁd
);

3964 
	`pxt4_upd©e_dú_cou¡
(
h™dÀ
, &
√w
);

3965 
ªtvÆ
 = 0;

3967 
íd_ª«me
:

3968 
	`bªl£
(
ﬁd
.
dú_bh
);

3969 
	`bªl£
(
√w
.
dú_bh
);

3970 
	`bªl£
(
ﬁd
.
bh
);

3971 
	`bªl£
(
√w
.
bh
);

3972 i‡(
h™dÀ
)

3973 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3974  
ªtvÆ
;

3975 
	}
}

3977 
	$pxt4_ª«me2
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

3978 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
,

3979 
Êags
)

3981 
îr
;

3983 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
ﬁd_dú
->
i_sb
))))

3984  -
EIO
;

3986 i‡(
Êags
 & ~(
RENAME_NOREPLACE
 | 
RENAME_EXCHANGE
 | 
RENAME_WHITEOUT
))

3987  -
EINVAL
;

3989 
îr
 = 
	`fs¸y±_¥ï¨e_ª«me
(
ﬁd_dú
, 
ﬁd_díåy
, 
√w_dú
, 
√w_díåy
,

3990 
Êags
);

3991 i‡(
îr
)

3992  
îr
;

3994 i‡(
Êags
 & 
RENAME_EXCHANGE
) {

3995  
	`pxt4_¸oss_ª«me
(
ﬁd_dú
, 
ﬁd_díåy
,

3996 
√w_dú
, 
√w_díåy
);

3999  
	`pxt4_ª«me
(
ﬁd_dú
, 
ﬁd_díåy
, 
√w_dú
, 
√w_díåy
, 
Êags
);

4000 
	}
}

4005 c⁄° 
öode_›î©i⁄s
 
	gpxt4_dú_öode_›î©i⁄s
 = {

4006 .
¸óã
 = 
pxt4_¸óã
,

4007 .
	glookup
 = 
pxt4_lookup
,

4008 .
	glök
 = 
pxt4_lök
,

4009 .
	gu∆ök
 = 
pxt4_u∆ök
,

4010 .
	gsymlök
 = 
pxt4_symlök
,

4011 .
	gmkdú
 = 
pxt4_mkdú
,

4012 .
	grmdú
 = 
pxt4_rmdú
,

4013 .
	gmknod
 = 
pxt4_mknod
,

4014 .
	gtmpfûe
 = 
pxt4_tmpfûe
,

4015 .
	gª«me
 = 
pxt4_ª«me2
,

4016 .
	g£èâr
 = 
pxt4_£èâr
,

4017 .
	ggë©å
 = 
pxt4_gë©å
,

4018 .
	gli°x©å
 = 
pxt4_li°x©å
,

4019 .
	ggë_a˛
 = 
pxt4_gë_a˛
,

4020 .
	g£t_a˛
 = 
pxt4_£t_a˛
,

4021 .
	gfõm≠
 = 
pxt4_fõm≠
,

4024 c⁄° 
öode_›î©i⁄s
 
	gpxt4_•ecül_öode_›î©i⁄s
 = {

4025 .
£èâr
 = 
pxt4_£èâr
,

4026 .
	ggë©å
 = 
pxt4_gë©å
,

4027 .
	gli°x©å
 = 
pxt4_li°x©å
,

4028 .
	ggë_a˛
 = 
pxt4_gë_a˛
,

4029 .
	g£t_a˛
 = 
pxt4_£t_a˛
,

	@page-io.c

10 
	~<löux/fs.h
>

11 
	~<löux/time.h
>

12 
	~<löux/highuid.h
>

13 
	~<löux/∑gem≠.h
>

14 
	~<löux/quŸa›s.h
>

15 
	~<löux/°rög.h
>

16 
	~<löux/buf„r_hód.h
>

17 
	~<löux/wrôeback.h
>

18 
	~<löux/∑gevec.h
>

19 
	~<löux/m∑ge.h
>

20 
	~<löux/«mei.h
>

21 
	~<löux/uio.h
>

22 
	~<löux/bio.h
>

23 
	~<löux/w‹kqueue.h
>

24 
	~<löux/kî√l.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/mm.h
>

27 
	~<löux/backög-dev.h
>

29 
	~"pxt4_jbd3.h
"

30 
	~"x©å.h
"

31 
	~"a˛.h
"

33 
kmem_ˇche
 *
	gio_íd_ˇchï
;

35 
__öô
 
	$pxt4_öô_∑geio
()

37 
io_íd_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_io_íd
, 
SLAB_RECLAIM_ACCOUNT
);

38 i‡(
io_íd_ˇchï
 =
NULL
)

39  -
ENOMEM
;

41 
	}
}

43 
	$pxt4_exô_∑geio
()

45 
	`kmem_ˇche_de°roy
(
io_íd_ˇchï
);

46 
	}
}

55 
	$buf„r_io_îr‹
(
buf„r_hód
 *
bh
)

57 
	`¥ötk_øãlimôed
(
KERN_ERR
 "Buffer I/OÉrror on device %pg,Üogical block %llu\n",

58 
bh
->
b_bdev
,

59 ()
bh
->
b_blockƒ
);

60 
	}
}

62 
	$pxt4_föish_bio
(
bio
 *bio)

64 
bio_vec
 *
bvec
;

65 
bvec_ôî_Æl
 
ôî_Æl
;

67 
	`bio_f‹_óch_£gmít_Æl
(
bvec
, 
bio
, 
ôî_Æl
) {

68 
∑ge
 *∑gê
bvec
->
bv_∑ge
;

69 
∑ge
 *
boun˚_∑ge
 = 
NULL
;

70 
buf„r_hód
 *
bh
, *
hód
;

71 
bio_°¨t
 = 
bvec
->
bv_off£t
;

72 
bio_íd
 = 
bio_°¨t
 + 
bvec
->
bv_Àn
;

73 
undî_io
 = 0;

74 
Êags
;

76 i‡(!
∑ge
)

79 i‡(
	`fs¸y±_is_boun˚_∑ge
(
∑ge
)) {

80 
boun˚_∑ge
 = 
∑ge
;

81 
∑ge
 = 
	`fs¸y±_∑geˇche_∑ge
(
boun˚_∑ge
);

84 i‡(
bio
->
bi_°©us
) {

85 
	`SëPageEº‹
(
∑ge
);

86 
	`m≠pög_£t_îr‹
(
∑ge
->
m≠pög
, -
EIO
);

88 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

93 
	`loˇl_úq_ßve
(
Êags
);

94 
	`bô_•ö_lock
(
BH_U±od©e_Lock
, &
hód
->
b_°©e
);

96 i‡(
	`bh_off£t
(
bh
Ë< 
bio_°¨t
 ||

97 
	`bh_off£t
(
bh
Ë+ bh->
b_size
 > 
bio_íd
) {

98 i‡(
	`buf„r_async_wrôe
(
bh
))

99 
undî_io
++;

102 
	`˛ór_buf„r_async_wrôe
(
bh
);

103 i‡(
bio
->
bi_°©us
)

104 
	`buf„r_io_îr‹
(
bh
);

105 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

106 
	`bô_•ö_u∆ock
(
BH_U±od©e_Lock
, &
hód
->
b_°©e
);

107 
	`loˇl_úq_ª°‹e
(
Êags
);

108 i‡(!
undî_io
) {

109 
	`fs¸y±_‰ì_boun˚_∑ge
(
boun˚_∑ge
);

110 
	`íd_∑ge_wrôeback
(
∑ge
);

113 
	}
}

115 
	$pxt4_ªÀa£_io_íd
(
pxt4_io_íd_t
 *
io_íd
)

117 
bio
 *bio, *
√xt_bio
;

119 
	`BUG_ON
(!
	`li°_em±y
(&
io_íd
->
li°
));

120 
	`BUG_ON
(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
);

121 
	`WARN_ON
(
io_íd
->
h™dÀ
);

123 
bio
 = 
io_íd
->bio; bio; biÿ
√xt_bio
) {

124 
√xt_bio
 = 
bio
->
bi_¥iv©e
;

125 
	`pxt4_föish_bio
(
bio
);

126 
	`bio_put
(
bio
);

128 
	`kmem_ˇche_‰ì
(
io_íd_ˇchï
, 
io_íd
);

129 
	}
}

139 
	$pxt4_íd_io
(
pxt4_io_íd_t
 *
io
)

141 
öode
 *öodê
io
->inode;

142 
loff_t
 
off£t
 = 
io
->offset;

143 
ssize_t
 
size
 = 
io
->size;

144 
h™dÀ_t
 *
h™dÀ
 = 
io
->handle;

145 
ªt
 = 0;

147 
	`pxt4_debug
("pxt4_end_io_nolock: io 0x%p from inode %lu,list->next 0x%p,"

149 
io
, 
öode
->
i_öo
, io->
li°
.
√xt
, io->li°.
¥ev
);

151 
io
->
h™dÀ
 = 
NULL
;

152 
ªt
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s
(
h™dÀ
, 
öode
, 
off£t
, 
size
);

153 i‡(
ªt
 < 0 && !
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))) {

154 
	`pxt4_msg
(
öode
->
i_sb
, 
KERN_EMERG
,

158 
öode
->
i_öo
, 
off£t
, 
size
, 
ªt
);

160 
	`pxt4_˛ór_io_unwrôãn_Êag
(
io
);

161 
	`pxt4_ªÀa£_io_íd
(
io
);

162  
ªt
;

163 
	}
}

165 
	$dump_com∂ëed_IO
(
öode
 *öode, 
li°_hód
 *
hód
)

167 #ifdef 
PXT4FS_DEBUG


168 
li°_hód
 *
cur
, *
bef‹e
, *
a·î
;

169 
pxt4_io_íd_t
 *
io
, *
io0
, *
io1
;

171 i‡(
	`li°_em±y
(
hód
))

174 
	`pxt4_debug
("Dum∞öodê%lu com∂ëed iÿli°\n", 
öode
->
i_öo
);

175 
	`li°_f‹_óch_íåy
(
io
, 
hód
, 
li°
) {

176 
cur
 = &
io
->
li°
;

177 
bef‹e
 = 
cur
->
¥ev
;

178 
io0
 = 
	`c⁄èöî_of
(
bef‹e
, 
pxt4_io_íd_t
, 
li°
);

179 
a·î
 = 
cur
->
√xt
;

180 
io1
 = 
	`c⁄èöî_of
(
a·î
, 
pxt4_io_íd_t
, 
li°
);

182 
	`pxt4_debug
("io 0x%p from inode %lu,prev 0x%p,next 0x%p\n",

183 
io
, 
öode
->
i_öo
, 
io0
, 
io1
);

186 
	}
}

189 
	$pxt4_add_com∂ëe_io
(
pxt4_io_íd_t
 *
io_íd
)

191 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
io_íd
->
öode
);

192 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
io_íd
->
öode
->
i_sb
);

193 
w‹kqueue_°ru˘
 *
wq
;

194 
Êags
;

197 
	`WARN_ON
(!(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
));

198 
	`WARN_ON
(!
io_íd
->
h™dÀ
 && 
sbi
->
s_jou∫Æ
);

199 
	`•ö_lock_úqßve
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

200 
wq
 = 
sbi
->
rsv_c⁄vîsi⁄_wq
;

201 i‡(
	`li°_em±y
(&
ei
->
i_rsv_c⁄vîsi⁄_li°
))

202 
	`queue_w‹k
(
wq
, &
ei
->
i_rsv_c⁄vîsi⁄_w‹k
);

203 
	`li°_add_èû
(&
io_íd
->
li°
, &
ei
->
i_rsv_c⁄vîsi⁄_li°
);

204 
	`•ö_u∆ock_úqª°‹e
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

205 
	}
}

207 
	$pxt4_do_Êush_com∂ëed_IO
(
öode
 *inode,

208 
li°_hód
 *
hód
)

210 
pxt4_io_íd_t
 *
io
;

211 
li°_hód
 
unwrôãn
;

212 
Êags
;

213 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

214 
îr
, 
ªt
 = 0;

216 
	`•ö_lock_úqßve
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

217 
	`dump_com∂ëed_IO
(
öode
, 
hód
);

218 
	`li°_ª∂a˚_öô
(
hód
, &
unwrôãn
);

219 
	`•ö_u∆ock_úqª°‹e
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

221 !
	`li°_em±y
(&
unwrôãn
)) {

222 
io
 = 
	`li°_íåy
(
unwrôãn
.
√xt
, 
pxt4_io_íd_t
, 
li°
);

223 
	`BUG_ON
(!(
io
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
));

224 
	`li°_dñ_öô
(&
io
->
li°
);

226 
îr
 = 
	`pxt4_íd_io
(
io
);

227 i‡(
	`u∆ikñy
(!
ªt
 && 
îr
))

228 
ªt
 = 
îr
;

230  
ªt
;

231 
	}
}

236 
	$pxt4_íd_io_rsv_w‹k
(
w‹k_°ru˘
 *
w‹k
)

238 
pxt4_öode_öfo
 *
ei
 = 
	`c⁄èöî_of
(
w‹k
, pxt4_inode_info,

239 
i_rsv_c⁄vîsi⁄_w‹k
);

240 
	`pxt4_do_Êush_com∂ëed_IO
(&
ei
->
vfs_öode
, &ei->
i_rsv_c⁄vîsi⁄_li°
);

241 
	}
}

243 
pxt4_io_íd_t
 *
	$pxt4_öô_io_íd
(
öode
 *öode, 
gÂ_t
 
Êags
)

245 
pxt4_io_íd_t
 *
io
 = 
	`kmem_ˇche_zÆloc
(
io_íd_ˇchï
, 
Êags
);

246 i‡(
io
) {

247 
io
->
öode
 = inode;

248 
	`INIT_LIST_HEAD
(&
io
->
li°
);

249 
	`©omic_£t
(&
io
->
cou¡
, 1);

251  
io
;

252 
	}
}

254 
	$pxt4_put_io_íd_de„r
(
pxt4_io_íd_t
 *
io_íd
)

256 i‡(
	`©omic_dec_™d_ã°
(&
io_íd
->
cou¡
)) {

257 i‡(!(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
Ë|| !io_íd->
size
) {

258 
	`pxt4_ªÀa£_io_íd
(
io_íd
);

261 
	`pxt4_add_com∂ëe_io
(
io_íd
);

263 
	}
}

265 
	$pxt4_put_io_íd
(
pxt4_io_íd_t
 *
io_íd
)

267 
îr
 = 0;

269 i‡(
	`©omic_dec_™d_ã°
(&
io_íd
->
cou¡
)) {

270 i‡(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
) {

271 
îr
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s
(
io_íd
->
h™dÀ
,

272 
io_íd
->
öode
, io_íd->
off£t
,

273 
io_íd
->
size
);

274 
io_íd
->
h™dÀ
 = 
NULL
;

275 
	`pxt4_˛ór_io_unwrôãn_Êag
(
io_íd
);

277 
	`pxt4_ªÀa£_io_íd
(
io_íd
);

279  
îr
;

280 
	}
}

282 
pxt4_io_íd_t
 *
	$pxt4_gë_io_íd
(
pxt4_io_íd_t
 *
io_íd
)

284 
	`©omic_öc
(&
io_íd
->
cou¡
);

285  
io_íd
;

286 
	}
}

289 
	$pxt4_íd_bio
(
bio
 *bio)

291 
pxt4_io_íd_t
 *
io_íd
 = 
bio
->
bi_¥iv©e
;

292 
£˘‹_t
 
bi_£˘‹
 = 
bio
->
bi_ôî
.bi_sector;

293 
b
[
BDEVNAME_SIZE
];

295 i‡(
	`WARN_ONCE
(!
io_íd
, "io_end is NULL: %s: sector %LuÜen %uÉrr %d\n",

296 
	`bio_dev«me
(
bio
, 
b
),

297 (Ë
bio
->
bi_ôî
.
bi_£˘‹
,

298 (Ë
	`bio_£˘‹s
(
bio
),

299 
bio
->
bi_°©us
)) {

300 
	`pxt4_föish_bio
(
bio
);

301 
	`bio_put
(
bio
);

304 
bio
->
bi_íd_io
 = 
NULL
;

306 i‡(
bio
->
bi_°©us
) {

307 
öode
 *öodê
io_íd
->inode;

309 
	`pxt4_w¨nög
(
öode
->
i_sb
, "I/OÉrror %d writingÅo inode %lu "

311 
bio
->
bi_°©us
, 
öode
->
i_öo
,

312 (Ë
io_íd
->
off£t
,

313 (Ë
io_íd
->
size
,

315 
bi_£˘‹
 >> (
öode
->
i_blkbôs
 - 9));

316 
	`m≠pög_£t_îr‹
(
öode
->
i_m≠pög
,

317 
	`blk_°©us_to_î∫o
(
bio
->
bi_°©us
));

320 i‡(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
) {

326 
bio
->
bi_¥iv©e
 = 
	`xchg
(&
io_íd
->bio, bio);

327 
	`pxt4_put_io_íd_de„r
(
io_íd
);

333 
	`pxt4_put_io_íd_de„r
(
io_íd
);

334 
	`pxt4_föish_bio
(
bio
);

335 
	`bio_put
(
bio
);

337 
	}
}

339 
	$pxt4_io_submô
(
pxt4_io_submô
 *
io
)

341 
bio
 *biÿ
io
->
io_bio
;

343 i‡(
bio
) {

344 
io_›_Êags
 = 
io
->
io_wbc
->
sync_mode
 =
WB_SYNC_ALL
 ?

345 
REQ_SYNC
 : 0;

346 
io
->
io_bio
->
bi_wrôe_höt
 = io->
io_íd
->
öode
->
i_wrôe_höt
;

347 
	`bio_£t_›_©ås
(
io
->
io_bio
, 
REQ_OP_WRITE
, 
io_›_Êags
);

348 
	`submô_bio
(
io
->
io_bio
);

350 
io
->
io_bio
 = 
NULL
;

351 
	}
}

353 
	$pxt4_io_submô_öô
(
pxt4_io_submô
 *
io
,

354 
wrôeback_c⁄åﬁ
 *
wbc
)

356 
io
->
io_wbc
 = 
wbc
;

357 
io
->
io_bio
 = 
NULL
;

358 
io
->
io_íd
 = 
NULL
;

359 
	}
}

361 
	$io_submô_öô_bio
(
pxt4_io_submô
 *
io
,

362 
buf„r_hód
 *
bh
)

364 
bio
 *bio;

366 
bio
 = 
	`bio_Æloc
(
GFP_NOIO
, 
BIO_MAX_PAGES
);

367 i‡(!
bio
)

368  -
ENOMEM
;

369 
bio
->
bi_ôî
.
bi_£˘‹
 = 
bh
->
b_blockƒ
 * (bh->
b_size
 >> 9);

370 
	`bio_£t_dev
(
bio
, 
bh
->
b_bdev
);

371 
bio
->
bi_íd_io
 = 
pxt4_íd_bio
;

372 
bio
->
bi_¥iv©e
 = 
	`pxt4_gë_io_íd
(
io
->
io_íd
);

373 
io
->
io_bio
 = 
bio
;

374 
io
->
io_√xt_block
 = 
bh
->
b_blockƒ
;

375 
	`wbc_öô_bio
(
io
->
io_wbc
, 
bio
);

377 
	}
}

379 
	$io_submô_add_bh
(
pxt4_io_submô
 *
io
,

380 
öode
 *inode,

381 
∑ge
 *page,

382 
buf„r_hód
 *
bh
)

384 
ªt
;

386 i‡(
io
->
io_bio
 && 
bh
->
b_blockƒ
 !io->
io_√xt_block
) {

387 
submô_™d_ªåy
:

388 
	`pxt4_io_submô
(
io
);

390 i‡(
io
->
io_bio
 =
NULL
) {

391 
ªt
 = 
	`io_submô_öô_bio
(
io
, 
bh
);

392 i‡(
ªt
)

393  
ªt
;

394 
io
->
io_bio
->
bi_wrôe_höt
 = 
öode
->
i_wrôe_höt
;

396 
ªt
 = 
	`bio_add_∑ge
(
io
->
io_bio
, 
∑ge
, 
bh
->
b_size
, 
	`bh_off£t
(bh));

397 i‡(
ªt
 !
bh
->
b_size
)

398 
submô_™d_ªåy
;

399 
	`wbc_accou¡_cgroup_ow√r
(
io
->
io_wbc
, 
∑ge
, 
bh
->
b_size
);

400 
io
->
io_√xt_block
++;

402 
	}
}

404 
	$pxt4_bio_wrôe_∑ge
(
pxt4_io_submô
 *
io
,

405 
∑ge
 *page,

406 
Àn
,

407 
wrôeback_c⁄åﬁ
 *
wbc
,

408 
boﬁ
 
kìp_towrôe
)

410 
∑ge
 *
boun˚_∑ge
 = 
NULL
;

411 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

412 
block_°¨t
;

413 
buf„r_hód
 *
bh
, *
hód
;

414 
ªt
 = 0;

415 
ƒ_submôãd
 = 0;

416 
ƒ_to_submô
 = 0;

418 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

419 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

421 i‡(
kìp_towrôe
)

422 
	`£t_∑ge_wrôeback_kìpwrôe
(
∑ge
);

424 
	`£t_∑ge_wrôeback
(
∑ge
);

425 
	`CÀ¨PageEº‹
(
∑ge
);

436 i‡(
Àn
 < 
PAGE_SIZE
)

437 
	`zîo_u£r_£gmít
(
∑ge
, 
Àn
, 
PAGE_SIZE
);

445 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

447 
block_°¨t
 = 
	`bh_off£t
(
bh
);

448 i‡(
block_°¨t
 >
Àn
) {

449 
	`˛ór_buf„r_dúty
(
bh
);

450 
	`£t_buf„r_u±od©e
(
bh
);

453 i‡(!
	`buf„r_dúty
(
bh
Ë|| 
	`buf„r_dñay
(bh) ||

454 !
	`buf„r_m≠≥d
(
bh
Ë|| 
	`buf„r_unwrôãn
(bh)) {

456 i‡(!
	`buf„r_m≠≥d
(
bh
))

457 
	`˛ór_buf„r_dúty
(
bh
);

458 i‡(
io
->
io_bio
)

459 
	`pxt4_io_submô
(
io
);

462 i‡(
	`buf„r_√w
(
bh
))

463 
	`˛ór_buf„r_√w
(
bh
);

464 
	`£t_buf„r_async_wrôe
(
bh
);

465 
ƒ_to_submô
++;

466 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

468 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

477 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
Ë&& 
ƒ_to_submô
) {

478 
gÂ_t
 
gÂ_Êags
 = 
GFP_NOFS
;

479 
íc_byãs
 = 
	`round_up
(
Àn
, 
	`i_blocksize
(
öode
));

481 
ªåy_í¸y±
:

482 
boun˚_∑ge
 = 
	`fs¸y±_í¸y±_∑geˇche_blocks
(
∑ge
, 
íc_byãs
,

483 0, 
gÂ_Êags
);

484 i‡(
	`IS_ERR
(
boun˚_∑ge
)) {

485 
ªt
 = 
	`PTR_ERR
(
boun˚_∑ge
);

486 i‡(
ªt
 =-
ENOMEM
 && 
wbc
->
sync_mode
 =
WB_SYNC_ALL
) {

487 i‡(
io
->
io_bio
) {

488 
	`pxt4_io_submô
(
io
);

489 
	`c⁄ge°i⁄_waô
(
BLK_RW_ASYNC
, 
HZ
/50);

491 
gÂ_Êags
 |
__GFP_NOFAIL
;

492 
ªåy_í¸y±
;

494 
boun˚_∑ge
 = 
NULL
;

495 
out
;

501 i‡(!
	`buf„r_async_wrôe
(
bh
))

503 
ªt
 = 
	`io_submô_add_bh
(
io
, 
öode
, 
boun˚_∑ge
 ?: 
∑ge
, 
bh
);

504 i‡(
ªt
) {

512 
ƒ_submôãd
++;

513 
	`˛ór_buf„r_dúty
(
bh
);

514 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

517 i‡(
ªt
) {

518 
out
:

519 
	`fs¸y±_‰ì_boun˚_∑ge
(
boun˚_∑ge
);

520 
	`¥ötk_øãlimôed
(
KERN_ERR
 "%s:Ñë = %d\n", 
__func__
, 
ªt
);

521 
	`ªdúty_∑ge_f‹_wrôïage
(
wbc
, 
∑ge
);

523 
	`˛ór_buf„r_async_wrôe
(
bh
);

524 
bh
 = bh->
b_this_∑ge
;

525 } 
bh
 !
hód
);

527 
	`u∆ock_∑ge
(
∑ge
);

529 i‡(!
ƒ_submôãd
)

530 
	`íd_∑ge_wrôeback
(
∑ge
);

531  
ªt
;

532 
	}
}

	@readpage.c

31 
	~<löux/kî√l.h
>

32 
	~<löux/exp‹t.h
>

33 
	~<löux/mm.h
>

34 
	~<löux/kdev_t.h
>

35 
	~<löux/gÂ.h
>

36 
	~<löux/bio.h
>

37 
	~<löux/fs.h
>

38 
	~<löux/buf„r_hód.h
>

39 
	~<löux/blkdev.h
>

40 
	~<löux/highmem.h
>

41 
	~<löux/¥e„tch.h
>

42 
	~<löux/m∑ge.h
>

43 
	~<löux/wrôeback.h
>

44 
	~<löux/backög-dev.h
>

45 
	~<löux/∑gevec.h
>

46 
	~<löux/˛ónˇche.h
>

48 
	~"pxt4.h
"

50 
	#NUM_PREALLOC_POST_READ_CTXS
 128

	)

52 
kmem_ˇche
 *
	gbio_po°_ªad_˘x_ˇche
;

53 
mempoﬁ_t
 *
	gbio_po°_ªad_˘x_poﬁ
;

56 
	ebio_po°_ªad_°ï
 {

57 
	mSTEP_INITIAL
 = 0,

58 
	mSTEP_DECRYPT
,

59 
	mSTEP_VERITY
,

62 
	sbio_po°_ªad_˘x
 {

63 
bio
 *
	mbio
;

64 
w‹k_°ru˘
 
	mw‹k
;

65 
	mcur_°ï
;

66 
	míabÀd_°ïs
;

69 
	$__ªad_íd_io
(
bio
 *bio)

71 
∑ge
 *page;

72 
bio_vec
 *
bv
;

73 
bvec_ôî_Æl
 
ôî_Æl
;

75 
	`bio_f‹_óch_£gmít_Æl
(
bv
, 
bio
, 
ôî_Æl
) {

76 
∑ge
 = 
bv
->
bv_∑ge
;

79 i‡(
bio
->
bi_°©us
 || 
	`PageEº‹
(
∑ge
)) {

80 
	`CÀ¨PageU±od©e
(
∑ge
);

82 
	`CÀ¨PageEº‹
(
∑ge
);

84 
	`SëPageU±od©e
(
∑ge
);

86 
	`u∆ock_∑ge
(
∑ge
);

88 i‡(
bio
->
bi_¥iv©e
)

89 
	`mempoﬁ_‰ì
(
bio
->
bi_¥iv©e
, 
bio_po°_ªad_˘x_poﬁ
);

90 
	`bio_put
(
bio
);

91 
	}
}

93 
bio_po°_ªad_¥o˚ssög
(
bio_po°_ªad_˘x
 *
˘x
);

95 
	$de¸y±_w‹k
(
w‹k_°ru˘
 *
w‹k
)

97 
bio_po°_ªad_˘x
 *
˘x
 =

98 
	`c⁄èöî_of
(
w‹k
, 
bio_po°_ªad_˘x
, work);

100 
	`fs¸y±_de¸y±_bio
(
˘x
->
bio
);

102 
	`bio_po°_ªad_¥o˚ssög
(
˘x
);

103 
	}
}

105 
	$vîôy_w‹k
(
w‹k_°ru˘
 *
w‹k
)

107 
bio_po°_ªad_˘x
 *
˘x
 =

108 
	`c⁄èöî_of
(
w‹k
, 
bio_po°_ªad_˘x
, work);

110 
	`fsvîôy_vîify_bio
(
˘x
->
bio
);

112 
	`bio_po°_ªad_¥o˚ssög
(
˘x
);

113 
	}
}

115 
	$bio_po°_ªad_¥o˚ssög
(
bio_po°_ªad_˘x
 *
˘x
)

122 ++
˘x
->
cur_°ï
) {

123 
STEP_DECRYPT
:

124 i‡(
˘x
->
íabÀd_°ïs
 & (1 << 
STEP_DECRYPT
)) {

125 
	`INIT_WORK
(&
˘x
->
w‹k
, 
de¸y±_w‹k
);

126 
	`fs¸y±_íqueue_de¸y±_w‹k
(&
˘x
->
w‹k
);

129 
˘x
->
cur_°ï
++;

131 
STEP_VERITY
:

132 i‡(
˘x
->
íabÀd_°ïs
 & (1 << 
STEP_VERITY
)) {

133 
	`INIT_WORK
(&
˘x
->
w‹k
, 
vîôy_w‹k
);

134 
	`fsvîôy_íqueue_vîify_w‹k
(&
˘x
->
w‹k
);

137 
˘x
->
cur_°ï
++;

140 
	`__ªad_íd_io
(
˘x
->
bio
);

142 
	}
}

144 
boﬁ
 
	$bio_po°_ªad_ªquúed
(
bio
 *bio)

146  
bio
->
bi_¥iv©e
 && !bio->
bi_°©us
;

147 
	}
}

161 
	$m∑ge_íd_io
(
bio
 *bio)

163 i‡(
	`bio_po°_ªad_ªquúed
(
bio
)) {

164 
bio_po°_ªad_˘x
 *
˘x
 = 
bio
->
bi_¥iv©e
;

166 
˘x
->
cur_°ï
 = 
STEP_INITIAL
;

167 
	`bio_po°_ªad_¥o˚ssög
(
˘x
);

170 
	`__ªad_íd_io
(
bio
);

171 
	}
}

173 
ölöe
 
boﬁ
 
	$pxt4_√ed_vîôy
(c⁄° 
öode
 *öode, 
pgoff_t
 
idx
)

175  
	`fsvîôy_a˘ive
(
öode
) &&

176 
idx
 < 
	`DIV_ROUND_UP
(
öode
->
i_size
, 
PAGE_SIZE
);

177 
	}
}

179 
bio_po°_ªad_˘x
 *
	$gë_bio_po°_ªad_˘x
(
öode
 *inode,

180 
bio
 *bio,

181 
pgoff_t
 
fú°_idx
)

183 
po°_ªad_°ïs
 = 0;

184 
bio_po°_ªad_˘x
 *
˘x
 = 
NULL
;

186 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
))

187 
po°_ªad_°ïs
 |1 << 
STEP_DECRYPT
;

189 i‡(
	`pxt4_√ed_vîôy
(
öode
, 
fú°_idx
))

190 
po°_ªad_°ïs
 |1 << 
STEP_VERITY
;

192 i‡(
po°_ªad_°ïs
) {

193 
˘x
 = 
	`mempoﬁ_Æloc
(
bio_po°_ªad_˘x_poﬁ
, 
GFP_NOFS
);

194 i‡(!
˘x
)

195  
	`ERR_PTR
(-
ENOMEM
);

196 
˘x
->
bio
 = bio;

197 
˘x
->
íabÀd_°ïs
 = 
po°_ªad_°ïs
;

198 
bio
->
bi_¥iv©e
 = 
˘x
;

200  
˘x
;

201 
	}
}

203 
ölöe
 
loff_t
 
	$pxt4_ªad∑ge_limô
(
öode
 *inode)

205 i‡(
	`IS_ENABLED
(
CONFIG_FS_VERITY
) &&

206 (
	`IS_VERITY
(
öode
Ë|| 
	`pxt4_vîôy_ö_¥ogªss
(inode)))

207  
öode
->
i_sb
->
s_maxbyãs
;

209  
	`i_size_ªad
(
öode
);

210 
	}
}

212 
	$pxt4_m∑ge_ªad∑ges
(
addªss_•a˚
 *
m≠pög
,

213 
li°_hód
 *
∑ges
, 
∑ge
 *page,

214 
ƒ_∑ges
, 
boﬁ
 
is_ªadahód
)

216 
bio
 *biÿ
NULL
;

217 
£˘‹_t
 
œ°_block_ö_bio
 = 0;

219 
öode
 *öodê
m≠pög
->
ho°
;

220 c⁄° 
blkbôs
 = 
öode
->
i_blkbôs
;

221 c⁄° 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 >> 
blkbôs
;

222 c⁄° 
blocksize
 = 1 << 
blkbôs
;

223 
£˘‹_t
 
block_ö_fûe
;

224 
£˘‹_t
 
œ°_block
;

225 
£˘‹_t
 
œ°_block_ö_fûe
;

226 
£˘‹_t
 
blocks
[
MAX_BUF_PER_PAGE
];

227 
∑ge_block
;

228 
block_devi˚
 *
bdev
 = 
öode
->
i_sb
->
s_bdev
;

229 
Àngth
;

230 
ªœtive_block
 = 0;

231 
pxt4_m≠_blocks
 
m≠
;

233 
m≠
.
m_pblk
 = 0;

234 
m≠
.
m_lblk
 = 0;

235 
m≠
.
m_Àn
 = 0;

236 
m≠
.
m_Êags
 = 0;

238 ; 
ƒ_∑ges
;Çr_pages--) {

239 
fuŒy_m≠≥d
 = 1;

240 
fú°_hﬁe
 = 
blocks_≥r_∑ge
;

242 i‡(
∑ges
) {

243 
∑ge
 = 
	`Ãu_to_∑ge
(
∑ges
);

245 
	`¥e„tchw
(&
∑ge
->
Êags
);

246 
	`li°_dñ
(&
∑ge
->
Ãu
);

247 i‡(
	`add_to_∑ge_ˇche_Ãu
(
∑ge
, 
m≠pög
,Öage->
ödex
,

248 
	`ªadahód_gÂ_mask
(
m≠pög
)))

249 
√xt_∑ge
;

252 i‡(
	`∑ge_has_buf„rs
(
∑ge
))

253 
c⁄fu£d
;

255 
block_ö_fûe
 = (
£˘‹_t
)
∑ge
->
ödex
 << (
PAGE_SHIFT
 - 
blkbôs
);

256 
œ°_block
 = 
block_ö_fûe
 + 
ƒ_∑ges
 * 
blocks_≥r_∑ge
;

257 
œ°_block_ö_fûe
 = (
	`pxt4_ªad∑ge_limô
(
öode
) +

258 
blocksize
 - 1Ë>> 
blkbôs
;

259 i‡(
œ°_block
 > 
œ°_block_ö_fûe
)

260 
œ°_block
 = 
œ°_block_ö_fûe
;

261 
∑ge_block
 = 0;

266 i‡((
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
) &&

267 
block_ö_fûe
 > 
m≠
.
m_lblk
 &&

268 
block_ö_fûe
 < (
m≠
.
m_lblk
 + m≠.
m_Àn
)) {

269 
m≠_off£t
 = 
block_ö_fûe
 - 
m≠
.
m_lblk
;

270 
œ°
 = 
m≠
.
m_Àn
 - 
m≠_off£t
;

272 
ªœtive_block
 = 0; ;Ñelative_block++) {

273 i‡(
ªœtive_block
 =
œ°
) {

275 
m≠
.
m_Êags
 &~
PXT4_MAP_MAPPED
;

278 i‡(
∑ge_block
 =
blocks_≥r_∑ge
)

280 
blocks
[
∑ge_block
] = 
m≠
.
m_pblk
 + 
m≠_off£t
 +

281 
ªœtive_block
;

282 
∑ge_block
++;

283 
block_ö_fûe
++;

291 
∑ge_block
 < 
blocks_≥r_∑ge
) {

292 i‡(
block_ö_fûe
 < 
œ°_block
) {

293 
m≠
.
m_lblk
 = 
block_ö_fûe
;

294 
m≠
.
m_Àn
 = 
œ°_block
 - 
block_ö_fûe
;

296 i‡(
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0) < 0) {

297 
£t_îr‹_∑ge
:

298 
	`SëPageEº‹
(
∑ge
);

299 
	`zîo_u£r_£gmít
(
∑ge
, 0,

300 
PAGE_SIZE
);

301 
	`u∆ock_∑ge
(
∑ge
);

302 
√xt_∑ge
;

305 i‡((
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
) == 0) {

306 
fuŒy_m≠≥d
 = 0;

307 i‡(
fú°_hﬁe
 =
blocks_≥r_∑ge
)

308 
fú°_hﬁe
 = 
∑ge_block
;

309 
∑ge_block
++;

310 
block_ö_fûe
++;

313 i‡(
fú°_hﬁe
 !
blocks_≥r_∑ge
)

314 
c⁄fu£d
;

317 i‡(
∑ge_block
 && 
blocks
[∑ge_block-1] !
m≠
.
m_pblk
-1)

318 
c⁄fu£d
;

319 
ªœtive_block
 = 0; ;Ñelative_block++) {

320 i‡(
ªœtive_block
 =
m≠
.
m_Àn
) {

322 
m≠
.
m_Êags
 &~
PXT4_MAP_MAPPED
;

324 } i‡(
∑ge_block
 =
blocks_≥r_∑ge
)

326 
blocks
[
∑ge_block
] = 
m≠
.
m_pblk
+
ªœtive_block
;

327 
∑ge_block
++;

328 
block_ö_fûe
++;

331 i‡(
fú°_hﬁe
 !
blocks_≥r_∑ge
) {

332 
	`zîo_u£r_£gmít
(
∑ge
, 
fú°_hﬁe
 << 
blkbôs
,

333 
PAGE_SIZE
);

334 i‡(
fú°_hﬁe
 == 0) {

335 i‡(
	`pxt4_√ed_vîôy
(
öode
, 
∑ge
->
ödex
) &&

336 !
	`fsvîôy_vîify_∑ge
(
∑ge
))

337 
£t_îr‹_∑ge
;

338 
	`SëPageU±od©e
(
∑ge
);

339 
	`u∆ock_∑ge
(
∑ge
);

340 
√xt_∑ge
;

342 } i‡(
fuŒy_m≠≥d
) {

343 
	`SëPageM≠≥dToDisk
(
∑ge
);

345 i‡(
fuŒy_m≠≥d
 && 
blocks_≥r_∑ge
 == 1 &&

346 !
	`PageU±od©e
(
∑ge
Ë&& 
	`˛ónˇche_gë_∑ge
(page) == 0) {

347 
	`SëPageU±od©e
(
∑ge
);

348 
c⁄fu£d
;

355 i‡(
bio
 && (
œ°_block_ö_bio
 !
blocks
[0] - 1)) {

356 
submô_™d_ªÆloc
:

357 
	`submô_bio
(
bio
);

358 
bio
 = 
NULL
;

360 i‡(
bio
 =
NULL
) {

361 
bio_po°_ªad_˘x
 *
˘x
;

363 
bio
 = 
	`bio_Æloc
(
GFP_KERNEL
,

364 
	`mö_t
(, 
ƒ_∑ges
, 
BIO_MAX_PAGES
));

365 i‡(!
bio
)

366 
£t_îr‹_∑ge
;

367 
˘x
 = 
	`gë_bio_po°_ªad_˘x
(
öode
, 
bio
, 
∑ge
->
ödex
);

368 i‡(
	`IS_ERR
(
˘x
)) {

369 
	`bio_put
(
bio
);

370 
bio
 = 
NULL
;

371 
£t_îr‹_∑ge
;

373 
	`bio_£t_dev
(
bio
, 
bdev
);

374 
bio
->
bi_ôî
.
bi_£˘‹
 = 
blocks
[0] << (
blkbôs
 - 9);

375 
bio
->
bi_íd_io
 = 
m∑ge_íd_io
;

376 
bio
->
bi_¥iv©e
 = 
˘x
;

377 
	`bio_£t_›_©ås
(
bio
, 
REQ_OP_READ
,

378 
is_ªadahód
 ? 
REQ_RAHEAD
 : 0);

381 
Àngth
 = 
fú°_hﬁe
 << 
blkbôs
;

382 i‡(
	`bio_add_∑ge
(
bio
, 
∑ge
, 
Àngth
, 0) <Üength)

383 
submô_™d_ªÆloc
;

385 i‡(((
m≠
.
m_Êags
 & 
PXT4_MAP_BOUNDARY
) &&

386 (
ªœtive_block
 =
m≠
.
m_Àn
)) ||

387 (
fú°_hﬁe
 !
blocks_≥r_∑ge
)) {

388 
	`submô_bio
(
bio
);

389 
bio
 = 
NULL
;

391 
œ°_block_ö_bio
 = 
blocks
[
blocks_≥r_∑ge
 - 1];

392 
√xt_∑ge
;

393 
c⁄fu£d
:

394 i‡(
bio
) {

395 
	`submô_bio
(
bio
);

396 
bio
 = 
NULL
;

398 i‡(!
	`PageU±od©e
(
∑ge
))

399 
	`block_ªad_fuŒ_∑ge
(
∑ge
, 
pxt4_gë_block
);

401 
	`u∆ock_∑ge
(
∑ge
);

402 
√xt_∑ge
:

403 i‡(
∑ges
)

404 
	`put_∑ge
(
∑ge
);

406 
	`BUG_ON
(
∑ges
 && !
	`li°_em±y
(pages));

407 i‡(
bio
)

408 
	`submô_bio
(
bio
);

410 
	}
}

412 
__öô
 
	$pxt4_öô_po°_ªad_¥o˚ssög
()

414 
bio_po°_ªad_˘x_ˇche
 =

415 
	`kmem_ˇche_¸óã
("pxt4_bio_post_read_ctx",

416 (
bio_po°_ªad_˘x
), 0, 0, 
NULL
);

417 i‡(!
bio_po°_ªad_˘x_ˇche
)

418 
Áû
;

419 
bio_po°_ªad_˘x_poﬁ
 =

420 
	`mempoﬁ_¸óã_¶ab_poﬁ
(
NUM_PREALLOC_POST_READ_CTXS
,

421 
bio_po°_ªad_˘x_ˇche
);

422 i‡(!
bio_po°_ªad_˘x_poﬁ
)

423 
Áû_‰ì_ˇche
;

426 
Áû_‰ì_ˇche
:

427 
	`kmem_ˇche_de°roy
(
bio_po°_ªad_˘x_ˇche
);

428 
Áû
:

429  -
ENOMEM
;

430 
	}
}

432 
	$pxt4_exô_po°_ªad_¥o˚ssög
()

434 
	`mempoﬁ_de°roy
(
bio_po°_ªad_˘x_poﬁ
);

435 
	`kmem_ˇche_de°roy
(
bio_po°_ªad_˘x_ˇche
);

436 
	}
}

	@resize.c

13 
	#PXT4FS_DEBUG


	)

15 
	~<löux/î∫o.h
>

16 
	~<löux/¶ab.h
>

18 
	~"pxt4_jbd3.h
"

20 
	$pxt4_ªsize_begö
(
su≥r_block
 *
sb
)

22 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

23 
ªt
 = 0;

25 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
))

26  -
EPERM
;

33 i‡(
	`PXT4_B2C
(
sbi
, sbi->
s_sbh
->
b_blockƒ
) !=

34 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
)) {

35 
	`pxt4_w¨nög
(
sb
, "won'tÑesize using backup superblockát %llu",

36 ()
	`PXT4_SB
(
sb
)->
s_sbh
->
b_blockƒ
);

37  -
EPERM
;

44 i‡(
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
) {

45 
	`pxt4_w¨nög
(
sb
, "ThereáreÉrrors inÅhe filesystem, "

47  -
EPERM
;

50 i‡(
	`ã°_™d_£t_bô_lock
(
PXT4_FLAGS_RESIZING
,

51 &
	`PXT4_SB
(
sb
)->
s_pxt4_Êags
))

52 
ªt
 = -
EBUSY
;

54  
ªt
;

55 
	}
}

57 
	$pxt4_ªsize_íd
(
su≥r_block
 *
sb
)

59 
	`˛ór_bô_u∆ock
(
PXT4_FLAGS_RESIZING
, &
	`PXT4_SB
(
sb
)->
s_pxt4_Êags
);

60 
	`smp_mb__a·î_©omic
();

61 
	}
}

63 
pxt4_group_t
 
	$pxt4_mëa_bg_fú°_group
(
su≥r_block
 *
sb
,

64 
pxt4_group_t
 
group
) {

65  (
group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
)) <<

66 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

67 
	}
}

69 
pxt4_fsblk_t
 
	$pxt4_mëa_bg_fú°_block_no
(
su≥r_block
 *
sb
,

70 
pxt4_group_t
 
group
) {

71 
group
 = 
	`pxt4_mëa_bg_fú°_group
(
sb
, group);

72  
	`pxt4_group_fú°_block_no
(
sb
, 
group
);

73 
	}
}

75 
pxt4_gΩblk_t
 
	$pxt4_group_ovîhód_blocks
(
su≥r_block
 *
sb
,

76 
pxt4_group_t
 
group
) {

77 
pxt4_gΩblk_t
 
ovîhód
;

78 
ovîhód
 = 
	`pxt4_bg_num_gdb
(
sb
, 
group
);

79 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
group
))

80 
ovîhód
 += 1 +

81 
	`À16_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_ª£rved_gdt_blocks
);

82  
ovîhód
;

83 
	}
}

85 
	#outside
(
b
, 
fú°
, 
œ°
Ë((bË< (fú°Ë|| (bË>÷a°))

	)

86 
	#öside
(
b
, 
fú°
, 
œ°
Ë((bË>(fú°Ë&& (bË< (œ°))

	)

88 
	$vîify_group_öput
(
su≥r_block
 *
sb
,

89 
pxt4_√w_group_d©a
 *
öput
)

91 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

92 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

93 
pxt4_fsblk_t
 
°¨t
 = 
	`pxt4_blocks_cou¡
(
es
);

94 
pxt4_fsblk_t
 
íd
 = 
°¨t
 + 
öput
->
blocks_cou¡
;

95 
pxt4_group_t
 
group
 = 
öput
->group;

96 
pxt4_fsblk_t
 
ôíd
 = 
öput
->
öode_èbÀ
 + 
sbi
->
s_ôb_≥r_group
;

97 
ovîhód
;

98 
pxt4_fsblk_t
 
më´nd
;

99 
buf„r_hód
 *
bh
 = 
NULL
;

100 
pxt4_gΩblk_t
 
‰ì_blocks_cou¡
, 
off£t
;

101 
îr
 = -
EINVAL
;

103 i‡(
group
 !
sbi
->
s_groups_cou¡
) {

104 
	`pxt4_w¨nög
(
sb
, "Cannotáddát group %u (only %u groups)",

105 
öput
->
group
, 
sbi
->
s_groups_cou¡
);

106  -
EINVAL
;

109 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
group
);

110 
më´nd
 = 
°¨t
 + 
ovîhód
;

111 
öput
->
‰ì_˛u°îs_cou¡
 = 
‰ì_blocks_cou¡
 =

112 
öput
->
blocks_cou¡
 - 2 - 
ovîhód
 - 
sbi
->
s_ôb_≥r_group
;

114 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

115 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:ádding %s group %u: %u blocks "

117 
	`pxt4_bg_has_su≥r
(
sb
, 
öput
->
group
) ? "normal" :

118 "no-su≥r", 
öput
->
group
, i≈ut->
blocks_cou¡
,

119 
‰ì_blocks_cou¡
, 
öput
->
ª£rved_blocks
);

121 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
°¨t
, 
NULL
, &
off£t
);

122 i‡(
off£t
 != 0)

123 
	`pxt4_w¨nög
(
sb
, "Last groupÇot full");

124 i‡(
öput
->
ª£rved_blocks
 > i≈ut->
blocks_cou¡
 / 5)

125 
	`pxt4_w¨nög
(
sb
, "Reserved blocksÅoo high (%u)",

126 
öput
->
ª£rved_blocks
);

127 i‡(
‰ì_blocks_cou¡
 < 0)

128 
	`pxt4_w¨nög
(
sb
, "Bad blocks count %u",

129 
öput
->
blocks_cou¡
);

130 i‡(
	`IS_ERR
(
bh
 = 
	`pxt4_sb_bªad
(
sb
, 
íd
 - 1, 0))) {

131 
îr
 = 
	`PTR_ERR
(
bh
);

132 
bh
 = 
NULL
;

133 
	`pxt4_w¨nög
(
sb
, "CannotÑeadÜast block (%llu)",

134 
íd
 - 1);

135 } i‡(
	`outside
(
öput
->
block_bôm≠
, 
°¨t
, 
íd
))

136 
	`pxt4_w¨nög
(
sb
, "Block bitmapÇot in group (block %llu)",

137 ()
öput
->
block_bôm≠
);

138 i‡(
	`outside
(
öput
->
öode_bôm≠
, 
°¨t
, 
íd
))

139 
	`pxt4_w¨nög
(
sb
, "Inode bitmapÇot in group (block %llu)",

140 ()
öput
->
öode_bôm≠
);

141 i‡(
	`outside
(
öput
->
öode_èbÀ
, 
°¨t
, 
íd
) ||

142 
	`outside
(
ôíd
 - 1, 
°¨t
, 
íd
))

143 
	`pxt4_w¨nög
(
sb
, "InodeÅableÇot in group (blocks %llu-%llu)",

144 ()
öput
->
öode_èbÀ
, 
ôíd
 - 1);

145 i‡(
öput
->
öode_bôm≠
 =öput->
block_bôm≠
)

146 
	`pxt4_w¨nög
(
sb
, "Block bitmap sameás inode bitmap (%llu)",

147 ()
öput
->
block_bôm≠
);

148 i‡(
	`öside
(
öput
->
block_bôm≠
, i≈ut->
öode_èbÀ
, 
ôíd
))

149 
	`pxt4_w¨nög
(
sb
, "Block bitmap (%llu) in inodeÅable "

151 ()
öput
->
block_bôm≠
,

152 ()
öput
->
öode_èbÀ
, 
ôíd
 - 1);

153 i‡(
	`öside
(
öput
->
öode_bôm≠
, i≈ut->
öode_èbÀ
, 
ôíd
))

154 
	`pxt4_w¨nög
(
sb
, "Inode bitmap (%llu) in inodeÅable "

156 ()
öput
->
öode_bôm≠
,

157 ()
öput
->
öode_èbÀ
, 
ôíd
 - 1);

158 i‡(
	`öside
(
öput
->
block_bôm≠
, 
°¨t
, 
më´nd
))

159 
	`pxt4_w¨nög
(
sb
, "Block bitmap (%llu) in GDTÅable (%llu-%llu)",

160 ()
öput
->
block_bôm≠
,

161 
°¨t
, 
më´nd
 - 1);

162 i‡(
	`öside
(
öput
->
öode_bôm≠
, 
°¨t
, 
më´nd
))

163 
	`pxt4_w¨nög
(
sb
, "Inode bitmap (%llu) in GDTÅable (%llu-%llu)",

164 ()
öput
->
öode_bôm≠
,

165 
°¨t
, 
më´nd
 - 1);

166 i‡(
	`öside
(
öput
->
öode_èbÀ
, 
°¨t
, 
më´nd
) ||

167 
	`öside
(
ôíd
 - 1, 
°¨t
, 
më´nd
))

168 
	`pxt4_w¨nög
(
sb
, "InodeÅable (%llu-%llu) overlaps GDTÅable "

170 ()
öput
->
öode_èbÀ
,

171 
ôíd
 - 1, 
°¨t
, 
më´nd
 - 1);

173 
îr
 = 0;

174 
	`bªl£
(
bh
);

176  
îr
;

177 
	}
}

183 
	spxt4_√w_Êex_group_d©a
 {

184 
pxt4_√w_group_d©a
 *
	mgroups
;

186 
__u16
 *
	mbg_Êags
;

188 
pxt4_group_t
 
	mcou¡
;

198 
pxt4_√w_Êex_group_d©a
 *
	$Æloc_Êex_gd
(
Êexbg_size
)

200 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
;

202 
Êex_gd
 = 
	`kmÆloc
((*Êex_gd), 
GFP_NOFS
);

203 i‡(
Êex_gd
 =
NULL
)

204 
out3
;

206 i‡(
Êexbg_size
 >
UINT_MAX
 / (
pxt4_√w_group_d©a
))

207 
out2
;

208 
Êex_gd
->
cou¡
 = 
Êexbg_size
;

210 
Êex_gd
->
groups
 = 
	`kmÆloc_¨øy
(
Êexbg_size
,

211 (
pxt4_√w_group_d©a
),

212 
GFP_NOFS
);

213 i‡(
Êex_gd
->
groups
 =
NULL
)

214 
out2
;

216 
Êex_gd
->
bg_Êags
 = 
	`kmÆloc_¨øy
(
Êexbg_size
, (
__u16
),

217 
GFP_NOFS
);

218 i‡(
Êex_gd
->
bg_Êags
 =
NULL
)

219 
out1
;

221  
Êex_gd
;

223 
out1
:

224 
	`k‰ì
(
Êex_gd
->
groups
);

225 
out2
:

226 
	`k‰ì
(
Êex_gd
);

227 
out3
:

228  
NULL
;

229 
	}
}

231 
	$‰ì_Êex_gd
(
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

233 
	`k‰ì
(
Êex_gd
->
bg_Êags
);

234 
	`k‰ì
(
Êex_gd
->
groups
);

235 
	`k‰ì
(
Êex_gd
);

236 
	}
}

251 
	$pxt4_Æloc_group_èbÀs
(
su≥r_block
 *
sb
,

252 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
,

253 
Êexbg_size
)

255 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

256 
pxt4_fsblk_t
 
°¨t_blk
;

257 
pxt4_fsblk_t
 
œ°_blk
;

258 
pxt4_group_t
 
§c_group
;

259 
pxt4_group_t
 
bb_ödex
 = 0;

260 
pxt4_group_t
 
ib_ödex
 = 0;

261 
pxt4_group_t
 
ô_ödex
 = 0;

262 
pxt4_group_t
 
group
;

263 
pxt4_group_t
 
œ°_group
;

264 
ovîhód
;

265 
__u16
 
unöô_mask
 = (
Êexbg_size
 > 1Ë? ~
PXT4_BG_BLOCK_UNINIT
 : ~0;

266 
i
;

268 
	`BUG_ON
(
Êex_gd
->
cou¡
 =0 || 
group_d©a
 =
NULL
);

270 
§c_group
 = 
group_d©a
[0].
group
;

271 
œ°_group
 = 
§c_group
 + 
Êex_gd
->
cou¡
 - 1;

273 
	`BUG_ON
((
Êexbg_size
 > 1Ë&& ((
§c_group
 & ~(flexbg_size - 1)) !=

274 (
œ°_group
 & ~(
Êexbg_size
 - 1))));

275 
√xt_group
:

276 
group
 = 
group_d©a
[0].group;

277 i‡(
§c_group
 >
group_d©a
[0].
group
 + 
Êex_gd
->
cou¡
)

278  -
ENOSPC
;

279 
°¨t_blk
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
§c_group
);

280 
œ°_blk
 = 
°¨t_blk
 + 
group_d©a
[
§c_group
 - 
group
].
blocks_cou¡
;

282 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
§c_group
);

284 
°¨t_blk
 +
ovîhód
;

287 
§c_group
++;

288 ; 
§c_group
 <
œ°_group
; src_group++) {

289 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
§c_group
);

290 i‡(
ovîhód
 == 0)

291 
œ°_blk
 +
group_d©a
[
§c_group
 - 
group
].
blocks_cou¡
;

297 ; 
bb_ödex
 < 
Êex_gd
->
cou¡
; bb_index++) {

298 i‡(
°¨t_blk
 >
œ°_blk
)

299 
√xt_group
;

300 
group_d©a
[
bb_ödex
].
block_bôm≠
 = 
°¨t_blk
++;

301 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
°¨t_blk
 - 1);

302 
group
 -
group_d©a
[0].group;

303 
group_d©a
[
group
].
md©a_blocks
++;

304 
Êex_gd
->
bg_Êags
[
group
] &
unöô_mask
;

308 ; 
ib_ödex
 < 
Êex_gd
->
cou¡
; ib_index++) {

309 i‡(
°¨t_blk
 >
œ°_blk
)

310 
√xt_group
;

311 
group_d©a
[
ib_ödex
].
öode_bôm≠
 = 
°¨t_blk
++;

312 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
°¨t_blk
 - 1);

313 
group
 -
group_d©a
[0].group;

314 
group_d©a
[
group
].
md©a_blocks
++;

315 
Êex_gd
->
bg_Êags
[
group
] &
unöô_mask
;

319 ; 
ô_ödex
 < 
Êex_gd
->
cou¡
; it_index++) {

320 
ôb
 = 
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
;

321 
pxt4_fsblk_t
 
√xt_group_°¨t
;

323 i‡(
°¨t_blk
 + 
ôb
 > 
œ°_blk
)

324 
√xt_group
;

325 
group_d©a
[
ô_ödex
].
öode_èbÀ
 = 
°¨t_blk
;

326 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
°¨t_blk
);

327 
√xt_group_°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
group
 + 1);

328 
group
 -
group_d©a
[0].group;

330 i‡(
°¨t_blk
 + 
ôb
 > 
√xt_group_°¨t
) {

331 
Êex_gd
->
bg_Êags
[
group
 + 1] &
unöô_mask
;

332 
ovîhód
 = 
°¨t_blk
 + 
ôb
 - 
√xt_group_°¨t
;

333 
group_d©a
[
group
 + 1].
md©a_blocks
 +
ovîhód
;

334 
ôb
 -
ovîhód
;

337 
group_d©a
[
group
].
md©a_blocks
 +
ôb
;

338 
Êex_gd
->
bg_Êags
[
group
] &
unöô_mask
;

339 
°¨t_blk
 +
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
;

343 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

344 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
 -=

345 
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
),

346 
group_d©a
[
i
].
md©a_blocks
);

349 i‡(
	`ã°_›t
(
sb
, 
DEBUG
)) {

350 
i
;

351 
group
 = 
group_d©a
[0].group;

353 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:áddingá flex group with "

354 "%d groups, fÀxbg sizêi†%d:\n", 
Êex_gd
->
cou¡
,

355 
Êexbg_size
);

357 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

358 
	`pxt4_debug
(

360 
	`pxt4_bg_has_su≥r
(
sb
, 
group
 + 
i
) ? "normal" :

361 "no-su≥r", 
group
 + 
i
,

362 
group_d©a
[
i
].
blocks_cou¡
,

363 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
,

364 
group_d©a
[
i
].
md©a_blocks
);

368 
	}
}

370 
buf„r_hód
 *
	$b˛ón
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

371 
pxt4_fsblk_t
 
blk
)

373 
buf„r_hód
 *
bh
;

374 
îr
;

376 
bh
 = 
	`sb_gëblk
(
sb
, 
blk
);

377 i‡(
	`u∆ikñy
(!
bh
))

378  
	`ERR_PTR
(-
ENOMEM
);

379 
	`BUFFER_TRACE
(
bh
, "get_write_access");

380 i‡((
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
))) {

381 
	`bªl£
(
bh
);

382 
bh
 = 
	`ERR_PTR
(
îr
);

384 
	`mem£t
(
bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

385 
	`£t_buf„r_u±od©e
(
bh
);

388  
bh
;

389 
	}
}

396 
	$exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ_t
 *
h™dÀ
, 
thªsh
)

398 
îr
;

400 i‡(
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
, 
thªsh
))

403 
îr
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
PXT4_MAX_TRANS_DATA
);

404 i‡(
îr
 < 0)

405  
îr
;

406 i‡(
îr
) {

407 
îr
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
PXT4_MAX_TRANS_DATA
);

408 i‡(
îr
)

409  
îr
;

413 
	}
}

424 
	$£t_Êexbg_block_bôm≠
(
su≥r_block
 *
sb
, 
h™dÀ_t
 *
h™dÀ
,

425 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
,

426 
pxt4_fsblk_t
 
fú°_˛u°î
,Öxt4_fsblk_à
œ°_˛u°î
)

428 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

429 
pxt4_group_t
 
cou¡
 = 
œ°_˛u°î
 - 
fú°_˛u°î
 + 1;

430 
pxt4_group_t
 
cou¡2
;

432 
	`pxt4_debug
("m¨k clu°î†[%Œu-%Œu] u£d\n", 
fú°_˛u°î
,

433 
œ°_˛u°î
);

434 
cou¡2
 = 
cou¡
; count > 0;

435 
cou¡
 -
cou¡2
, 
fú°_˛u°î
 += count2) {

436 
pxt4_fsblk_t
 
°¨t
;

437 
buf„r_hód
 *
bh
;

438 
pxt4_group_t
 
group
;

439 
îr
;

441 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
	`PXT4_C2B
(
sbi
, 
fú°_˛u°î
));

442 
°¨t
 = 
	`PXT4_B2C
(
sbi
, 
	`pxt4_group_fú°_block_no
(
sb
, 
group
));

443 
group
 -
Êex_gd
->
groups
[0].group;

445 
cou¡2
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
Ë- (
fú°_˛u°î
 - 
°¨t
);

446 i‡(
cou¡2
 > 
cou¡
)

447 
cou¡2
 = 
cou¡
;

449 i‡(
Êex_gd
->
bg_Êags
[
group
] & 
PXT4_BG_BLOCK_UNINIT
) {

450 
	`BUG_ON
(
Êex_gd
->
cou¡
 > 1);

454 
îr
 = 
	`exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ
, 1);

455 i‡(
îr
)

456  
îr
;

458 
bh
 = 
	`sb_gëblk
(
sb
, 
Êex_gd
->
groups
[
group
].
block_bôm≠
);

459 i‡(
	`u∆ikñy
(!
bh
))

460  -
ENOMEM
;

462 
	`BUFFER_TRACE
(
bh
, "get_write_access");

463 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

464 i‡(
îr
) {

465 
	`bªl£
(
bh
);

466  
îr
;

468 
	`pxt4_debug
("mark block bitmap %#04llx (+%llu/%u)\n",

469 
fú°_˛u°î
, fú°_˛u°î - 
°¨t
, 
cou¡2
);

470 
	`pxt4_£t_bôs
(
bh
->
b_d©a
, 
fú°_˛u°î
 - 
°¨t
, 
cou¡2
);

472 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

473 
	`bªl£
(
bh
);

474 i‡(
	`u∆ikñy
(
îr
))

475  
îr
;

479 
	}
}

495 
	$£tup_√w_Êex_group_blocks
(
su≥r_block
 *
sb
,

496 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

498 
group_èbÀ_cou¡
[] = {1, 1, 
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
};

499 
pxt4_fsblk_t
 
°¨t
;

500 
pxt4_fsblk_t
 
block
;

501 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

502 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

503 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

504 
__u16
 *
bg_Êags
 = 
Êex_gd
->bg_flags;

505 
h™dÀ_t
 *
h™dÀ
;

506 
pxt4_group_t
 
group
, 
cou¡
;

507 
buf„r_hód
 *
bh
 = 
NULL
;

508 
ª£rved_gdb
, 
i
, 
j
, 
îr
 = 0, 
îr2
;

509 
mëa_bg
;

511 
	`BUG_ON
(!
Êex_gd
->
cou¡
 || !
group_d©a
 ||

512 
group_d©a
[0].
group
 !
sbi
->
s_groups_cou¡
);

514 
ª£rved_gdb
 = 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
);

515 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

518 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
PXT4_MAX_TRANS_DATA
);

519 i‡(
	`IS_ERR
(
h™dÀ
))

520  
	`PTR_ERR
(
h™dÀ
);

522 
group
 = 
group_d©a
[0].group;

523 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++, 
group
++) {

524 
gdblocks
;

525 
pxt4_gΩblk_t
 
ovîhód
;

527 
gdblocks
 = 
	`pxt4_bg_num_gdb
(
sb
, 
group
);

528 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
group
);

530 i‡(
mëa_bg
 =0 && !
	`pxt4_bg_has_su≥r
(
sb
, 
group
))

531 
h™dÀ_ôb
;

533 i‡(
mëa_bg
 == 1) {

534 
pxt4_group_t
 
fú°_group
;

535 
fú°_group
 = 
	`pxt4_mëa_bg_fú°_group
(
sb
, 
group
);

536 i‡(
fú°_group
 !
group
 + 1 &&

537 
fú°_group
 !
group
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1)

538 
h™dÀ_ôb
;

541 
block
 = 
°¨t
 + 
	`pxt4_bg_has_su≥r
(
sb
, 
group
);

543 
j
 = 0; j < 
gdblocks
; j++, 
block
++) {

544 
buf„r_hód
 *
gdb
;

546 
	`pxt4_debug
("upd©êbacku∞grou∞%#04Œx\n", 
block
);

547 
îr
 = 
	`exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ
, 1);

548 i‡(
îr
)

549 
out
;

551 
gdb
 = 
	`sb_gëblk
(
sb
, 
block
);

552 i‡(
	`u∆ikñy
(!
gdb
)) {

553 
îr
 = -
ENOMEM
;

554 
out
;

557 
	`BUFFER_TRACE
(
gdb
, "get_write_access");

558 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb
);

559 i‡(
îr
) {

560 
	`bªl£
(
gdb
);

561 
out
;

563 
	`mem˝y
(
gdb
->
b_d©a
, 
sbi
->
s_group_desc
[
j
]->b_data,

564 
gdb
->
b_size
);

565 
	`£t_buf„r_u±od©e
(
gdb
);

567 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdb
);

568 i‡(
	`u∆ikñy
(
îr
)) {

569 
	`bªl£
(
gdb
);

570 
out
;

572 
	`bªl£
(
gdb
);

578 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
group
)) {

579 
îr
 = 
	`sb_issue_zîoout
(
sb
, 
gdblocks
 + 
°¨t
 + 1,

580 
ª£rved_gdb
, 
GFP_NOFS
);

581 i‡(
îr
)

582 
out
;

585 
h™dÀ_ôb
:

587 i‡(!(
bg_Êags
[
i
] & 
PXT4_BG_INODE_ZEROED
))

588 
h™dÀ_bb
;

591 
block
 = 
group_d©a
[
i
].
öode_èbÀ
;

592 
	`pxt4_debug
("clear inodeÅable blocks %#04llx -> %#04lx\n",

593 
block
, 
sbi
->
s_ôb_≥r_group
);

594 
îr
 = 
	`sb_issue_zîoout
(
sb
, 
block
, 
sbi
->
s_ôb_≥r_group
,

595 
GFP_NOFS
);

596 i‡(
îr
)

597 
out
;

599 
h™dÀ_bb
:

600 i‡(
bg_Êags
[
i
] & 
PXT4_BG_BLOCK_UNINIT
)

601 
h™dÀ_ib
;

604 
block
 = 
group_d©a
[
i
].
block_bôm≠
;

605 
îr
 = 
	`exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ
, 1);

606 i‡(
îr
)

607 
out
;

609 
bh
 = 
	`b˛ón
(
h™dÀ
, 
sb
, 
block
);

610 i‡(
	`IS_ERR
(
bh
)) {

611 
îr
 = 
	`PTR_ERR
(
bh
);

612 
out
;

614 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
group
);

615 i‡(
ovîhód
 != 0) {

616 
	`pxt4_debug
("mark backup superblock %#04llx (+0)\n",

617 
°¨t
);

618 
	`pxt4_£t_bôs
(
bh
->
b_d©a
, 0,

619 
	`PXT4_NUM_B2C
(
sbi
, 
ovîhód
));

621 
	`pxt4_m¨k_bôm≠_íd
(
	`PXT4_B2C
(
sbi
, 
group_d©a
[
i
].
blocks_cou¡
),

622 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

623 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

624 
	`bªl£
(
bh
);

625 i‡(
îr
)

626 
out
;

628 
h™dÀ_ib
:

629 i‡(
bg_Êags
[
i
] & 
PXT4_BG_INODE_UNINIT
)

633 
block
 = 
group_d©a
[
i
].
öode_bôm≠
;

634 
îr
 = 
	`exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ
, 1);

635 i‡(
îr
)

636 
out
;

638 
bh
 = 
	`b˛ón
(
h™dÀ
, 
sb
, 
block
);

639 i‡(
	`IS_ERR
(
bh
)) {

640 
îr
 = 
	`PTR_ERR
(
bh
);

641 
out
;

644 
	`pxt4_m¨k_bôm≠_íd
(
	`PXT4_INODES_PER_GROUP
(
sb
),

645 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

646 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

647 
	`bªl£
(
bh
);

648 i‡(
îr
)

649 
out
;

653 
j
 = 0; j < 
GROUP_TABLE_COUNT
; j++) {

654 
cou¡
 = 
group_èbÀ_cou¡
[
j
];

655 
°¨t
 = (&
group_d©a
[0].
block_bôm≠
)[
j
];

656 
block
 = 
°¨t
;

657 
i
 = 1; i < 
Êex_gd
->
cou¡
; i++) {

658 
block
 +
group_èbÀ_cou¡
[
j
];

659 i‡(
block
 =(&
group_d©a
[
i
].
block_bôm≠
)[
j
]) {

660 
cou¡
 +
group_èbÀ_cou¡
[
j
];

663 
îr
 = 
	`£t_Êexbg_block_bôm≠
(
sb
, 
h™dÀ
,

664 
Êex_gd
,

665 
	`PXT4_B2C
(
sbi
, 
°¨t
),

666 
	`PXT4_B2C
(
sbi
,

667 
°¨t
 + 
cou¡


669 i‡(
îr
)

670 
out
;

671 
cou¡
 = 
group_èbÀ_cou¡
[
j
];

672 
°¨t
 = (&
group_d©a
[
i
].
block_bôm≠
)[
j
];

673 
block
 = 
°¨t
;

676 i‡(
cou¡
) {

677 
îr
 = 
	`£t_Êexbg_block_bôm≠
(
sb
, 
h™dÀ
,

678 
Êex_gd
,

679 
	`PXT4_B2C
(
sbi
, 
°¨t
),

680 
	`PXT4_B2C
(
sbi
,

681 
°¨t
 + 
cou¡


683 i‡(
îr
)

684 
out
;

688 
out
:

689 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

690 i‡(
îr2
 && !
îr
)

691 
îr
 = 
îr2
;

693  
îr
;

694 
	}
}

703 
	$pxt4_li°_backups
(
su≥r_block
 *
sb
, *
thªe
,

704 *
five
, *
£ví
)

706 *
mö
 = 
thªe
;

707 
mu…
 = 3;

708 
ªt
;

710 i‡(!
	`pxt4_has_„©uª_•¨£_su≥r
(
sb
)) {

711 
ªt
 = *
mö
;

712 *
mö
 += 1;

713  
ªt
;

716 i‡(*
five
 < *
mö
) {

717 
mö
 = 
five
;

718 
mu…
 = 5;

720 i‡(*
£ví
 < *
mö
) {

721 
mö
 = 
£ví
;

722 
mu…
 = 7;

725 
ªt
 = *
mö
;

726 *
mö
 *
mu…
;

728  
ªt
;

729 
	}
}

736 
	$vîify_ª£rved_gdb
(
su≥r_block
 *
sb
,

737 
pxt4_group_t
 
íd
,

738 
buf„r_hód
 *
¥im¨y
)

740 c⁄° 
pxt4_fsblk_t
 
blk
 = 
¥im¨y
->
b_blockƒ
;

741 
thªe
 = 1;

742 
five
 = 5;

743 
£ví
 = 7;

744 
gΩ
;

745 
__À32
 *
p
 = (__À32 *)
¥im¨y
->
b_d©a
;

746 
gdbackups
 = 0;

748 (
gΩ
 = 
	`pxt4_li°_backups
(
sb
, &
thªe
, &
five
, &
£ví
)Ë< 
íd
) {

749 i‡(
	`À32_to_˝u
(*
p
++) !=

750 
gΩ
 * 
	`PXT4_BLOCKS_PER_GROUP
(
sb
Ë+ 
blk
){

751 
	`pxt4_w¨nög
(
sb
, "reserved GDT %llu"

753 
blk
, 
gΩ
,

754 
gΩ
 *

755 (
pxt4_fsblk_t
)
	`PXT4_BLOCKS_PER_GROUP
(
sb
) +

756 
blk
);

757  -
EINVAL
;

759 i‡(++
gdbackups
 > 
	`PXT4_ADDR_PER_BLOCK
(
sb
))

760  -
EFBIG
;

763  
gdbackups
;

764 
	}
}

779 
	$add_√w_gdb
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

780 
pxt4_group_t
 
group
)

782 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

783 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

784 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

785 
pxt4_fsblk_t
 
gdblock
 = 
	`PXT4_SB
(
sb
)->
s_sbh
->
b_blockƒ
 + 1 + 
gdb_num
;

786 
buf„r_hód
 **
o_group_desc
, **
n_group_desc
 = 
NULL
;

787 
buf„r_hód
 *
död
 = 
NULL
;

788 
buf„r_hód
 *
gdb_bh
 = 
NULL
;

789 
gdbackups
;

790 
pxt4_ûoc
 
ûoc
 = { .
bh
 = 
NULL
 };

791 
__À32
 *
d©a
;

792 
îr
;

794 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

795 
	`¥ötk
(
KERN_DEBUG


797 
gdb_num
);

799 
gdb_bh
 = 
	`pxt4_sb_bªad
(
sb
, 
gdblock
, 0);

800 i‡(
	`IS_ERR
(
gdb_bh
))

801  
	`PTR_ERR
(
gdb_bh
);

803 
gdbackups
 = 
	`vîify_ª£rved_gdb
(
sb
, 
group
, 
gdb_bh
);

804 i‡(
gdbackups
 < 0) {

805 
îr
 = 
gdbackups
;

806 
îrout
;

809 
d©a
 = 
	`PXT4_I
(
öode
)->
i_d©a
 + 
PXT4_DIND_BLOCK
;

810 
död
 = 
	`pxt4_sb_bªad
(
sb
, 
	`À32_to_˝u
(*
d©a
), 0);

811 i‡(
	`IS_ERR
(
död
)) {

812 
îr
 = 
	`PTR_ERR
(
död
);

813 
död
 = 
NULL
;

814 
îrout
;

817 
d©a
 = (
__À32
 *)
död
->
b_d©a
;

818 i‡(
	`À32_to_˝u
(
d©a
[
gdb_num
 % 
	`PXT4_ADDR_PER_BLOCK
(
sb
)]Ë!
gdblock
) {

819 
	`pxt4_w¨nög
(
sb
, "new group %u GDT block %lluÇotÑeserved",

820 
group
, 
gdblock
);

821 
îr
 = -
EINVAL
;

822 
îrout
;

825 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

826 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
);

827 i‡(
	`u∆ikñy
(
îr
))

828 
îrout
;

830 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

831 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb_bh
);

832 i‡(
	`u∆ikñy
(
îr
))

833 
îrout
;

835 
	`BUFFER_TRACE
(
död
, "get_write_access");

836 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
död
);

837 i‡(
	`u∆ikñy
(
îr
))

838 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

841 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

842 i‡(
	`u∆ikñy
(
îr
))

843 
îrout
;

845 
n_group_desc
 = 
	`pxt4_kvmÆloc
((
gdb_num
 + 1) *

846 (
buf„r_hód
 *),

847 
GFP_NOFS
);

848 i‡(!
n_group_desc
) {

849 
îr
 = -
ENOMEM
;

850 
	`pxt4_w¨nög
(
sb
, "notÉnough memory for %lu groups",

851 
gdb_num
 + 1);

852 
îrout
;

864 
d©a
[
gdb_num
 % 
	`PXT4_ADDR_PER_BLOCK
(
sb
)] = 0;

865 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
död
);

866 i‡(
	`u∆ikñy
(
îr
)) {

867 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

868 
îrout
;

870 
öode
->
i_blocks
 -(
gdbackups
 + 1Ë* 
sb
->
s_blocksize
 >>

871 (9 - 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
);

872 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

873 
	`mem£t
(
gdb_bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

874 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdb_bh
);

875 i‡(
	`u∆ikñy
(
îr
)) {

876 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

877 
ûoc
.
bh
 = 
NULL
;

878 
îrout
;

880 
	`bªl£
(
död
);

882 
o_group_desc
 = 
	`PXT4_SB
(
sb
)->
s_group_desc
;

883 
	`mem˝y
(
n_group_desc
, 
o_group_desc
,

884 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
 * (
buf„r_hód
 *));

885 
n_group_desc
[
gdb_num
] = 
gdb_bh
;

886 
	`PXT4_SB
(
sb
)->
s_group_desc
 = 
n_group_desc
;

887 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
++;

888 
	`kv‰ì
(
o_group_desc
);

890 
	`À16_add_˝u
(&
es
->
s_ª£rved_gdt_blocks
, -1);

891 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

892 i‡(
îr
)

893 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

894  
îr
;

895 
îrout
:

896 
	`kv‰ì
(
n_group_desc
);

897 
	`bªl£
(
ûoc
.
bh
);

898 
	`bªl£
(
död
);

899 
	`bªl£
(
gdb_bh
);

901 
	`pxt4_debug
("Àavög wôhÉº‹ %d\n", 
îr
);

902  
îr
;

903 
	}
}

908 
	$add_√w_gdb_mëa_bg
(
su≥r_block
 *
sb
,

909 
h™dÀ_t
 *
h™dÀ
, 
pxt4_group_t
 
group
) {

910 
pxt4_fsblk_t
 
gdblock
;

911 
buf„r_hód
 *
gdb_bh
;

912 
buf„r_hód
 **
o_group_desc
, **
n_group_desc
;

913 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

914 
îr
;

916 
gdblock
 = 
	`pxt4_mëa_bg_fú°_block_no
(
sb
, 
group
) +

917 
	`pxt4_bg_has_su≥r
(
sb
, 
group
);

918 
gdb_bh
 = 
	`pxt4_sb_bªad
(
sb
, 
gdblock
, 0);

919 i‡(
	`IS_ERR
(
gdb_bh
))

920  
	`PTR_ERR
(
gdb_bh
);

921 
n_group_desc
 = 
	`pxt4_kvmÆloc
((
gdb_num
 + 1) *

922 (
buf„r_hód
 *),

923 
GFP_NOFS
);

924 i‡(!
n_group_desc
) {

925 
	`bªl£
(
gdb_bh
);

926 
îr
 = -
ENOMEM
;

927 
	`pxt4_w¨nög
(
sb
, "notÉnough memory for %lu groups",

928 
gdb_num
 + 1);

929  
îr
;

932 
o_group_desc
 = 
	`PXT4_SB
(
sb
)->
s_group_desc
;

933 
	`mem˝y
(
n_group_desc
, 
o_group_desc
,

934 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
 * (
buf„r_hód
 *));

935 
n_group_desc
[
gdb_num
] = 
gdb_bh
;

937 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

938 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb_bh
);

939 i‡(
îr
) {

940 
	`kv‰ì
(
n_group_desc
);

941 
	`bªl£
(
gdb_bh
);

942  
îr
;

945 
	`PXT4_SB
(
sb
)->
s_group_desc
 = 
n_group_desc
;

946 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
++;

947 
	`kv‰ì
(
o_group_desc
);

948  
îr
;

949 
	}
}

964 
	$ª£rve_backup_gdb
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

965 
pxt4_group_t
 
group
)

967 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

968 
ª£rved_gdb
 =
	`À16_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_ª£rved_gdt_blocks
);

969 
˛u°î_bôs
 = 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
;

970 
buf„r_hód
 **
¥im¨y
;

971 
buf„r_hód
 *
död
;

972 
pxt4_ûoc
 
ûoc
;

973 
pxt4_fsblk_t
 
blk
;

974 
__À32
 *
d©a
, *
íd
;

975 
gdbackups
 = 0;

976 
ªs
, 
i
;

977 
îr
;

979 
¥im¨y
 = 
	`kmÆloc_¨øy
(
ª£rved_gdb
, (*¥im¨y), 
GFP_NOFS
);

980 i‡(!
¥im¨y
)

981  -
ENOMEM
;

983 
d©a
 = 
	`PXT4_I
(
öode
)->
i_d©a
 + 
PXT4_DIND_BLOCK
;

984 
död
 = 
	`pxt4_sb_bªad
(
sb
, 
	`À32_to_˝u
(*
d©a
), 0);

985 i‡(
	`IS_ERR
(
död
)) {

986 
îr
 = 
	`PTR_ERR
(
död
);

987 
död
 = 
NULL
;

988 
exô_‰ì
;

991 
blk
 = 
	`PXT4_SB
(
sb
)->
s_sbh
->
b_blockƒ
 + 1 + PXT4_SB(sb)->
s_gdb_cou¡
;

992 
d©a
 = (
__À32
 *)
död
->
b_d©a
 + (
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
 %

993 
	`PXT4_ADDR_PER_BLOCK
(
sb
));

994 
íd
 = (
__À32
 *)
död
->
b_d©a
 + 
	`PXT4_ADDR_PER_BLOCK
(
sb
);

997 
ªs
 = 0;Ñe†< 
ª£rved_gdb
;Ñes++, 
blk
++) {

998 i‡(
	`À32_to_˝u
(*
d©a
Ë!
blk
) {

999 
	`pxt4_w¨nög
(
sb
, "reserved block %llu"

1001 
blk
,

1002 ()(
d©a
 - (
__À32
 *)
död
->
b_d©a
));

1003 
îr
 = -
EINVAL
;

1004 
exô_bh
;

1006 
¥im¨y
[
ªs
] = 
	`pxt4_sb_bªad
(
sb
, 
blk
, 0);

1007 i‡(
	`IS_ERR
(
¥im¨y
[
ªs
])) {

1008 
îr
 = 
	`PTR_ERR
(
¥im¨y
[
ªs
]);

1009 
¥im¨y
[
ªs
] = 
NULL
;

1010 
exô_bh
;

1012 
gdbackups
 = 
	`vîify_ª£rved_gdb
(
sb
, 
group
, 
¥im¨y
[
ªs
]);

1013 i‡(
gdbackups
 < 0) {

1014 
	`bªl£
(
¥im¨y
[
ªs
]);

1015 
îr
 = 
gdbackups
;

1016 
exô_bh
;

1018 i‡(++
d©a
 >
íd
)

1019 
d©a
 = (
__À32
 *)
död
->
b_d©a
;

1022 
i
 = 0; i < 
ª£rved_gdb
; i++) {

1023 
	`BUFFER_TRACE
(
¥im¨y
[
i
], "get_write_access");

1024 i‡((
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
¥im¨y
[
i
])))

1025 
exô_bh
;

1028 i‡((
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
)))

1029 
exô_bh
;

1035 
blk
 = 
group
 * 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

1036 
i
 = 0; i < 
ª£rved_gdb
; i++) {

1037 
îr2
;

1038 
d©a
 = (
__À32
 *)
¥im¨y
[
i
]->
b_d©a
;

1042 
d©a
[
gdbackups
] = 
	`˝u_to_À32
(
blk
 + 
¥im¨y
[
i
]->
b_blockƒ
);

1043 
îr2
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
¥im¨y
[
i
]);

1044 i‡(!
îr
)

1045 
îr
 = 
îr2
;

1048 
öode
->
i_blocks
 +
ª£rved_gdb
 * 
sb
->
s_blocksize
 >> (9 - 
˛u°î_bôs
);

1049 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

1051 
exô_bh
:

1052 --
ªs
 >= 0)

1053 
	`bªl£
(
¥im¨y
[
ªs
]);

1054 
	`bªl£
(
död
);

1056 
exô_‰ì
:

1057 
	`k‰ì
(
¥im¨y
);

1059  
îr
;

1060 
	}
}

1078 
	$upd©e_backups
(
su≥r_block
 *
sb
, 
£˘‹_t
 
blk_off
, *
d©a
,

1079 
size
, 
mëa_bg
)

1081 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1082 
pxt4_group_t
 
œ°
;

1083 c⁄° 
bpg
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

1084 
thªe
 = 1;

1085 
five
 = 5;

1086 
£ví
 = 7;

1087 
pxt4_group_t
 
group
 = 0;

1088 
ª°
 = 
sb
->
s_blocksize
 - 
size
;

1089 
h™dÀ_t
 *
h™dÀ
;

1090 
îr
 = 0, 
îr2
;

1092 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
PXT4_MAX_TRANS_DATA
);

1093 i‡(
	`IS_ERR
(
h™dÀ
)) {

1094 
group
 = 1;

1095 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1096 
exô_îr
;

1099 i‡(
mëa_bg
 == 0) {

1100 
group
 = 
	`pxt4_li°_backups
(
sb
, &
thªe
, &
five
, &
£ví
);

1101 
œ°
 = 
sbi
->
s_groups_cou¡
;

1103 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
blk_off
) + 1;

1104 
œ°
 = (
pxt4_group_t
)(
group
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 2);

1107 
group
 < 
sbi
->
s_groups_cou¡
) {

1108 
buf„r_hód
 *
bh
;

1109 
pxt4_fsblk_t
 
backup_block
;

1112 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
) &&

1113 
h™dÀ
->
h_buf„r_¸edôs
 == 0 &&

1114 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
PXT4_MAX_TRANS_DATA
) &&

1115 (
îr
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
PXT4_MAX_TRANS_DATA
)))

1118 i‡(
mëa_bg
 == 0)

1119 
backup_block
 = ((
pxt4_fsblk_t
)
group
Ë* 
bpg
 + 
blk_off
;

1121 
backup_block
 = (
	`pxt4_group_fú°_block_no
(
sb
, 
group
) +

1122 
	`pxt4_bg_has_su≥r
(
sb
, 
group
));

1124 
bh
 = 
	`sb_gëblk
(
sb
, 
backup_block
);

1125 i‡(
	`u∆ikñy
(!
bh
)) {

1126 
îr
 = -
ENOMEM
;

1129 
	`pxt4_debug
("update metadata backup %llu(+%llu)\n",

1130 
backup_block
, backup_block -

1131 
	`pxt4_group_fú°_block_no
(
sb
, 
group
));

1132 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1133 i‡((
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
))) {

1134 
	`bªl£
(
bh
);

1137 
	`lock_buf„r
(
bh
);

1138 
	`mem˝y
(
bh
->
b_d©a
, 
d©a
, 
size
);

1139 i‡(
ª°
)

1140 
	`mem£t
(
bh
->
b_d©a
 + 
size
, 0, 
ª°
);

1141 
	`£t_buf„r_u±od©e
(
bh
);

1142 
	`u∆ock_buf„r
(
bh
);

1143 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1144 i‡(
	`u∆ikñy
(
îr
))

1145 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1146 
	`bªl£
(
bh
);

1148 i‡(
mëa_bg
 == 0)

1149 
group
 = 
	`pxt4_li°_backups
(
sb
, &
thªe
, &
five
, &
£ví
);

1150 i‡(
group
 =
œ°
)

1153 
group
 = 
œ°
;

1155 i‡((
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
)Ë&& !
îr
)

1156 
îr
 = 
îr2
;

1168 
exô_îr
:

1169 i‡(
îr
) {

1170 
	`pxt4_w¨nög
(
sb
, "can't update backup for group %u (err %d), "

1171 "f‹cög fsck o¿√xàªboŸ", 
group
, 
îr
);

1172 
sbi
->
s_mou¡_°©e
 &~
PXT4_VALID_FS
;

1173 
sbi
->
s_es
->
s_°©e
 &
	`˝u_to_À16
(~
PXT4_VALID_FS
);

1174 
	`m¨k_buf„r_dúty
(
sbi
->
s_sbh
);

1176 
	}
}

1188 
	$pxt4_add_√w_descs
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

1189 
pxt4_group_t
 
group
, 
öode
 *
ªsize_öode
,

1190 
pxt4_group_t
 
cou¡
)

1192 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1193 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1194 
buf„r_hód
 *
gdb_bh
;

1195 
i
, 
gdb_off
, 
gdb_num
, 
îr
 = 0;

1196 
mëa_bg
;

1198 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

1199 
i
 = 0; i < 
cou¡
; i++, 
group
++) {

1200 
ª£rved_gdb
 = 
	`pxt4_bg_has_su≥r
(
sb
, 
group
) ?

1201 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
) : 0;

1203 
gdb_off
 = 
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1204 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1212 i‡(
gdb_off
) {

1213 
gdb_bh
 = 
sbi
->
s_group_desc
[
gdb_num
];

1214 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

1215 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb_bh
);

1217 i‡(!
îr
 && 
ª£rved_gdb
 && 
	`pxt4_bg_num_gdb
(
sb
, 
group
))

1218 
îr
 = 
	`ª£rve_backup_gdb
(
h™dÀ
, 
ªsize_öode
, 
group
);

1219 } i‡(
mëa_bg
 != 0) {

1220 
îr
 = 
	`add_√w_gdb_mëa_bg
(
sb
, 
h™dÀ
, 
group
);

1222 
îr
 = 
	`add_√w_gdb
(
h™dÀ
, 
ªsize_öode
, 
group
);

1224 i‡(
îr
)

1227  
îr
;

1228 
	}
}

1230 
buf„r_hód
 *
	$pxt4_gë_bôm≠
(
su≥r_block
 *
sb
, 
__u64
 
block
)

1232 
buf„r_hód
 *
bh
 = 
	`sb_gëblk
(
sb
, 
block
);

1233 i‡(
	`u∆ikñy
(!
bh
))

1234  
NULL
;

1235 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

1236 i‡(
	`bh_submô_ªad
(
bh
) < 0) {

1237 
	`bªl£
(
bh
);

1238  
NULL
;

1242  
bh
;

1243 
	}
}

1245 
	$pxt4_£t_bôm≠_checksums
(
su≥r_block
 *
sb
,

1246 
pxt4_group_t
 
group
,

1247 
pxt4_group_desc
 *
gdp
,

1248 
pxt4_√w_group_d©a
 *
group_d©a
)

1250 
buf„r_hód
 *
bh
;

1252 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

1255 
bh
 = 
	`pxt4_gë_bôm≠
(
sb
, 
group_d©a
->
öode_bôm≠
);

1256 i‡(!
bh
)

1257  -
EIO
;

1258 
	`pxt4_öode_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
, 
bh
,

1259 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

1260 
	`bªl£
(
bh
);

1262 
bh
 = 
	`pxt4_gë_bôm≠
(
sb
, 
group_d©a
->
block_bôm≠
);

1263 i‡(!
bh
)

1264  -
EIO
;

1265 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
, 
bh
);

1266 
	`bªl£
(
bh
);

1269 
	}
}

1274 
	$pxt4_£tup_√w_descs
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

1275 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

1277 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

1278 
pxt4_group_desc
 *
gdp
;

1279 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1280 
buf„r_hód
 *
gdb_bh
;

1281 
pxt4_group_t
 
group
;

1282 
__u16
 *
bg_Êags
 = 
Êex_gd
->bg_flags;

1283 
i
, 
gdb_off
, 
gdb_num
, 
îr
 = 0;

1286 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++, 
group_d©a
++, 
bg_Êags
++) {

1287 
group
 = 
group_d©a
->group;

1289 
gdb_off
 = 
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1290 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1295 
gdb_bh
 = 
sbi
->
s_group_desc
[
gdb_num
];

1297 
gdp
 = (
pxt4_group_desc
 *)(
gdb_bh
->
b_d©a
 +

1298 
gdb_off
 * 
	`PXT4_DESC_SIZE
(
sb
));

1300 
	`mem£t
(
gdp
, 0, 
	`PXT4_DESC_SIZE
(
sb
));

1301 
	`pxt4_block_bôm≠_£t
(
sb
, 
gdp
, 
group_d©a
->
block_bôm≠
);

1302 
	`pxt4_öode_bôm≠_£t
(
sb
, 
gdp
, 
group_d©a
->
öode_bôm≠
);

1303 
îr
 = 
	`pxt4_£t_bôm≠_checksums
(
sb
, 
group
, 
gdp
, 
group_d©a
);

1304 i‡(
îr
) {

1305 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1309 
	`pxt4_öode_èbÀ_£t
(
sb
, 
gdp
, 
group_d©a
->
öode_èbÀ
);

1310 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
,

1311 
group_d©a
->
‰ì_˛u°îs_cou¡
);

1312 
	`pxt4_‰ì_öodes_£t
(
sb
, 
gdp
, 
	`PXT4_INODES_PER_GROUP
(sb));

1313 i‡(
	`pxt4_has_group_desc_csum
(
sb
))

1314 
	`pxt4_ôabÀ_unu£d_£t
(
sb
, 
gdp
,

1315 
	`PXT4_INODES_PER_GROUP
(
sb
));

1316 
gdp
->
bg_Êags
 = 
	`˝u_to_À16
(*bg_flags);

1317 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1319 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdb_bh
);

1320 i‡(
	`u∆ikñy
(
îr
)) {

1321 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1329 
îr
 = 
	`pxt4_mb_add_groupöfo
(
sb
, 
group
, 
gdp
);

1330 i‡(
îr
)

1333  
îr
;

1334 
	}
}

1343 
	$pxt4_upd©e_su≥r
(
su≥r_block
 *
sb
,

1344 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

1346 
pxt4_fsblk_t
 
blocks_cou¡
 = 0;

1347 
pxt4_fsblk_t
 
‰ì_blocks
 = 0;

1348 
pxt4_fsblk_t
 
ª£rved_blocks
 = 0;

1349 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

1350 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1351 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1352 
i
;

1354 
	`BUG_ON
(
Êex_gd
->
cou¡
 =0 || 
group_d©a
 =
NULL
);

1365 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

1366 
blocks_cou¡
 +
group_d©a
[
i
].blocks_count;

1367 
‰ì_blocks
 +
	`PXT4_C2B
(
sbi
, 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
);

1370 
ª£rved_blocks
 = 
	`pxt4_r_blocks_cou¡
(
es
) * 100;

1371 
ª£rved_blocks
 = 
	`div64_u64
‘e£rved_blocks, 
	`pxt4_blocks_cou¡
(
es
));

1372 
ª£rved_blocks
 *
blocks_cou¡
;

1373 
	`do_div
(
ª£rved_blocks
, 100);

1375 
	`pxt4_blocks_cou¡_£t
(
es
, 
	`pxt4_blocks_cou¡
”sË+ 
blocks_cou¡
);

1376 
	`pxt4_‰ì_blocks_cou¡_£t
(
es
, 
	`pxt4_‰ì_blocks_cou¡
”sË+ 
‰ì_blocks
);

1377 
	`À32_add_˝u
(&
es
->
s_öodes_cou¡
, 
	`PXT4_INODES_PER_GROUP
(
sb
) *

1378 
Êex_gd
->
cou¡
);

1379 
	`À32_add_˝u
(&
es
->
s_‰ì_öodes_cou¡
, 
	`PXT4_INODES_PER_GROUP
(
sb
) *

1380 
Êex_gd
->
cou¡
);

1382 
	`pxt4_debug
("‰ì block†cou¡ %Œu", 
	`pxt4_‰ì_blocks_cou¡
(
es
));

1401 
	`smp_wmb
();

1404 
sbi
->
s_groups_cou¡
 +
Êex_gd
->
cou¡
;

1405 
sbi
->
s_blockfûe_groups
 = 
	`mö_t
(
pxt4_group_t
, sbi->
s_groups_cou¡
,

1406 (
PXT4_MAX_BLOCK_FILE_PHYS
 / 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)));

1410 
	`pxt4_r_blocks_cou¡_£t
(
es
, 
	`pxt4_r_blocks_cou¡
(es) +

1411 
ª£rved_blocks
);

1414 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

1415 
	`PXT4_NUM_B2C
(
sbi
, 
‰ì_blocks
));

1416 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ìöodes_cou¡î
,

1417 
	`PXT4_INODES_PER_GROUP
(
sb
Ë* 
Êex_gd
->
cou¡
);

1419 
	`pxt4_debug
("free blocks count %llu",

1420 
	`≥r˝u_cou¡î_ªad
(&
sbi
->
s_‰ì˛u°îs_cou¡î
));

1421 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
Ë&& 
sbi
->
s_log_groups_≥r_Êex
) {

1422 
pxt4_group_t
 
Êex_group
;

1423 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
group_d©a
[0].
group
);

1424 
	`©omic64_add
(
	`PXT4_NUM_B2C
(
sbi
, 
‰ì_blocks
),

1425 &
sbi
->
s_Êex_groups
[
Êex_group
].
‰ì_˛u°îs
);

1426 
	`©omic_add
(
	`PXT4_INODES_PER_GROUP
(
sb
Ë* 
Êex_gd
->
cou¡
,

1427 &
sbi
->
s_Êex_groups
[
Êex_group
].
‰ì_öodes
);

1433 
	`pxt4_ˇlcuœã_ovîhód
(
sb
);

1435 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

1436 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:ádded group %u:"

1437 "%Œu blocks(%Œu fªê%ŒuÑe£rved)\n", 
Êex_gd
->
cou¡
,

1438 
blocks_cou¡
, 
‰ì_blocks
, 
ª£rved_blocks
);

1439 
	}
}

1445 
	$pxt4_Êex_group_add
(
su≥r_block
 *
sb
,

1446 
öode
 *
ªsize_öode
,

1447 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

1449 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1450 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1451 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1452 
pxt4_gΩblk_t
 
œ°
;

1453 
pxt4_group_t
 
group
;

1454 
h™dÀ_t
 *
h™dÀ
;

1455 
ª£rved_gdb
;

1456 
îr
 = 0, 
îr2
 = 0, 
¸edô
;

1458 
	`BUG_ON
(!
Êex_gd
->
cou¡
 || !Êex_gd->
groups
 || !Êex_gd->
bg_Êags
);

1460 
ª£rved_gdb
 = 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
);

1461 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1462 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
, &
group
, &
œ°
);

1463 
	`BUG_ON
(
œ°
);

1465 
îr
 = 
	`£tup_√w_Êex_group_blocks
(
sb
, 
Êex_gd
);

1466 i‡(
îr
)

1467 
exô
;

1475 
¸edô
 = 3;

1477 
¸edô
 +1 + 
	`DIV_ROUND_UP
(
Êex_gd
->
cou¡
, 
	`PXT4_DESC_PER_BLOCK
(
sb
));

1478 
¸edô
 +
ª£rved_gdb
;

1479 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
¸edô
);

1480 i‡(
	`IS_ERR
(
h™dÀ
)) {

1481 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1482 
exô
;

1485 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

1486 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

1487 i‡(
îr
)

1488 
exô_jou∫Æ
;

1490 
group
 = 
Êex_gd
->
groups
[0].group;

1491 
	`BUG_ON
(
group
 !
sbi
->
s_groups_cou¡
);

1492 
îr
 = 
	`pxt4_add_√w_descs
(
h™dÀ
, 
sb
, 
group
,

1493 
ªsize_öode
, 
Êex_gd
->
cou¡
);

1494 i‡(
îr
)

1495 
exô_jou∫Æ
;

1497 
îr
 = 
	`pxt4_£tup_√w_descs
(
h™dÀ
, 
sb
, 
Êex_gd
);

1498 i‡(
îr
)

1499 
exô_jou∫Æ
;

1501 
	`pxt4_upd©e_su≥r
(
sb
, 
Êex_gd
);

1503 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

1505 
exô_jou∫Æ
:

1506 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1507 i‡(!
îr
)

1508 
îr
 = 
îr2
;

1510 i‡(!
îr
) {

1511 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1512 
gdb_num_íd
 = ((
group
 + 
Êex_gd
->
cou¡
 - 1) /

1513 
	`PXT4_DESC_PER_BLOCK
(
sb
));

1514 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

1515 
£˘‹_t
 
ﬁd_gdb
 = 0;

1517 
	`upd©e_backups
(
sb
, 
sbi
->
s_sbh
->
b_blockƒ
, (*)
es
,

1518 (
pxt4_su≥r_block
), 0);

1519 ; 
gdb_num
 <
gdb_num_íd
; gdb_num++) {

1520 
buf„r_hód
 *
gdb_bh
;

1522 
gdb_bh
 = 
sbi
->
s_group_desc
[
gdb_num
];

1523 i‡(
ﬁd_gdb
 =
gdb_bh
->
b_blockƒ
)

1525 
	`upd©e_backups
(
sb
, 
gdb_bh
->
b_blockƒ
, gdb_bh->
b_d©a
,

1526 
gdb_bh
->
b_size
, 
mëa_bg
);

1527 
ﬁd_gdb
 = 
gdb_bh
->
b_blockƒ
;

1530 
exô
:

1531  
îr
;

1532 
	}
}

1534 
	$pxt4_£tup_√xt_Êex_gd
(
su≥r_block
 *
sb
,

1535 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
,

1536 
pxt4_fsblk_t
 
n_blocks_cou¡
,

1537 
Êexbg_size
)

1539 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1540 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1541 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

1542 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1543 
pxt4_group_t
 
n_group
;

1544 
pxt4_group_t
 
group
;

1545 
pxt4_group_t
 
œ°_group
;

1546 
pxt4_gΩblk_t
 
œ°
;

1547 
pxt4_gΩblk_t
 
˛u°îs_≥r_group
;

1548 
i
;

1550 
˛u°îs_≥r_group
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

1552 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1554 i‡(
o_blocks_cou¡
 =
n_blocks_cou¡
)

1557 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
, &
group
, &
œ°
);

1558 
	`BUG_ON
(
œ°
);

1559 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
n_blocks_cou¡
 - 1, &
n_group
, &
œ°
);

1561 
œ°_group
 = 
group
 | (
Êexbg_size
 - 1);

1562 i‡(
œ°_group
 > 
n_group
)

1563 
œ°_group
 = 
n_group
;

1565 
Êex_gd
->
cou¡
 = 
œ°_group
 - 
group
 + 1;

1567 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

1568 
ovîhód
;

1570 
group_d©a
[
i
].
group
 = group + i;

1571 
group_d©a
[
i
].
blocks_cou¡
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

1572 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
group
 + 
i
);

1573 
group_d©a
[
i
].
md©a_blocks
 = 
ovîhód
;

1574 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

1575 i‡(
	`pxt4_has_group_desc_csum
(
sb
)) {

1576 
Êex_gd
->
bg_Êags
[
i
] = 
PXT4_BG_BLOCK_UNINIT
 |

1577 
PXT4_BG_INODE_UNINIT
;

1578 i‡(!
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

1579 
Êex_gd
->
bg_Êags
[
i
] |
PXT4_BG_INODE_ZEROED
;

1581 
Êex_gd
->
bg_Êags
[
i
] = 
PXT4_BG_INODE_ZEROED
;

1584 i‡(
œ°_group
 =
n_group
 && 
	`pxt4_has_group_desc_csum
(
sb
))

1586 
Êex_gd
->
bg_Êags
[
i
 - 1] &~
PXT4_BG_BLOCK_UNINIT
;

1588 i‡((
œ°_group
 =
n_group
Ë&& (
œ°
 !
˛u°îs_≥r_group
 - 1)) {

1589 
group_d©a
[
i
 - 1].
blocks_cou¡
 = 
	`PXT4_C2B
(
sbi
, 
œ°
 + 1);

1590 
group_d©a
[
i
 - 1].
‰ì_˛u°îs_cou¡
 -
˛u°îs_≥r_group
 -

1591 
œ°
 - 1;

1595 
	}
}

1610 
	$pxt4_group_add
(
su≥r_block
 *
sb
, 
pxt4_√w_group_d©a
 *
öput
)

1612 
pxt4_√w_Êex_group_d©a
 
Êex_gd
;

1613 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1614 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1615 
ª£rved_gdb
 = 
	`pxt4_bg_has_su≥r
(
sb
, 
öput
->
group
) ?

1616 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
) : 0;

1617 
öode
 *öodê
NULL
;

1618 
gdb_off
;

1619 
îr
;

1620 
__u16
 
bg_Êags
 = 0;

1622 
gdb_off
 = 
öput
->
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1624 i‡(
gdb_off
 =0 && !
	`pxt4_has_„©uª_•¨£_su≥r
(
sb
)) {

1625 
	`pxt4_w¨nög
(
sb
, "Can'tÑesizeÇon-sparse filesystem further");

1626  -
EPERM
;

1629 i‡(
	`pxt4_blocks_cou¡
(
es
Ë+ 
öput
->
blocks_cou¡
 <

1630 
	`pxt4_blocks_cou¡
(
es
)) {

1631 
	`pxt4_w¨nög
(
sb
, "blocks_count overflow");

1632  -
EINVAL
;

1635 i‡(
	`À32_to_˝u
(
es
->
s_öodes_cou¡
Ë+ 
	`PXT4_INODES_PER_GROUP
(
sb
) <

1636 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
)) {

1637 
	`pxt4_w¨nög
(
sb
, "inodes_count overflow");

1638  -
EINVAL
;

1641 i‡(
ª£rved_gdb
 || 
gdb_off
 == 0) {

1642 i‡(!
	`pxt4_has_„©uª_ªsize_öode
(
sb
) ||

1643 !
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
)) {

1644 
	`pxt4_w¨nög
(
sb
,

1646  -
EPERM
;

1648 
öode
 = 
	`pxt4_igë
(
sb
, 
PXT4_RESIZE_INO
, 
PXT4_IGET_SPECIAL
);

1649 i‡(
	`IS_ERR
(
öode
)) {

1650 
	`pxt4_w¨nög
(
sb
, "Error openingÑesize inode");

1651  
	`PTR_ERR
(
öode
);

1656 
îr
 = 
	`vîify_group_öput
(
sb
, 
öput
);

1657 i‡(
îr
)

1658 
out
;

1660 
îr
 = 
	`pxt4_Æloc_Êex_bg_¨øy
(
sb
, 
öput
->
group
 + 1);

1661 i‡(
îr
)

1662 
out
;

1664 
îr
 = 
	`pxt4_mb_Æloc_groupöfo
(
sb
, 
öput
->
group
 + 1);

1665 i‡(
îr
)

1666 
out
;

1668 
Êex_gd
.
cou¡
 = 1;

1669 
Êex_gd
.
groups
 = 
öput
;

1670 
Êex_gd
.
bg_Êags
 = &bg_flags;

1671 
îr
 = 
	`pxt4_Êex_group_add
(
sb
, 
öode
, &
Êex_gd
);

1672 
out
:

1673 
	`ùut
(
öode
);

1674  
îr
;

1675 
	}
}

1680 
	$pxt4_group_exãnd_no_check
(
su≥r_block
 *
sb
,

1681 
pxt4_fsblk_t
 
o_blocks_cou¡
, 
pxt4_gΩblk_t
 
add
)

1683 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

1684 
h™dÀ_t
 *
h™dÀ
;

1685 
îr
 = 0, 
îr2
;

1690 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 3);

1691 i‡(
	`IS_ERR
(
h™dÀ
)) {

1692 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1693 
	`pxt4_w¨nög
(
sb
, "îr‹ %d o¿jou∫Æ sèπ", 
îr
);

1694  
îr
;

1697 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

1698 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
);

1699 i‡(
îr
) {

1700 
	`pxt4_w¨nög
(
sb
, "îr‹ %d o¿jou∫Æ wrôêac˚ss", 
îr
);

1701 
îrout
;

1704 
	`pxt4_blocks_cou¡_£t
(
es
, 
o_blocks_cou¡
 + 
add
);

1705 
	`pxt4_‰ì_blocks_cou¡_£t
(
es
, 
	`pxt4_‰ì_blocks_cou¡
”sË+ 
add
);

1706 
	`pxt4_debug
("‰ìög block†%ŒuÅhrough %Œu\n", 
o_blocks_cou¡
,

1707 
o_blocks_cou¡
 + 
add
);

1709 
îr
 = 
	`pxt4_group_add_blocks
(
h™dÀ
, 
sb
, 
o_blocks_cou¡
, 
add
);

1710 i‡(
îr
)

1711 
îrout
;

1712 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

1713 
	`pxt4_debug
("‰ìd block†%ŒuÅhrough %Œu\n", 
o_blocks_cou¡
,

1714 
o_blocks_cou¡
 + 
add
);

1715 
îrout
:

1716 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1717 i‡(
îr2
 && !
îr
)

1718 
îr
 = 
îr2
;

1720 i‡(!
îr
) {

1721 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

1722 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:Éxtended groupÅo %llu "

1723 "blocks\n", 
	`pxt4_blocks_cou¡
(
es
));

1724 
	`upd©e_backups
(
sb
, 
	`PXT4_SB
(sb)->
s_sbh
->
b_blockƒ
,

1725 (*)
es
, (
pxt4_su≥r_block
), 0);

1727  
îr
;

1728 
	}
}

1740 
	$pxt4_group_exãnd
(
su≥r_block
 *
sb
, 
pxt4_su≥r_block
 *
es
,

1741 
pxt4_fsblk_t
 
n_blocks_cou¡
)

1743 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1744 
pxt4_gΩblk_t
 
œ°
;

1745 
pxt4_gΩblk_t
 
add
;

1746 
buf„r_hód
 *
bh
;

1747 
îr
;

1748 
pxt4_group_t
 
group
;

1750 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1752 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

1753 
	`pxt4_msg
(
sb
, 
KERN_DEBUG
,

1755 
o_blocks_cou¡
, 
n_blocks_cou¡
);

1757 i‡(
n_blocks_cou¡
 =0 ||Ç_blocks_cou¡ =
o_blocks_cou¡
)

1760 i‡(
n_blocks_cou¡
 > (
£˘‹_t
)(~0ULLË>> (
sb
->
s_blocksize_bôs
 - 9)) {

1761 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1763 
n_blocks_cou¡
);

1764  -
EINVAL
;

1767 i‡(
n_blocks_cou¡
 < 
o_blocks_cou¡
) {

1768 
	`pxt4_w¨nög
(
sb
, "can't shrink FS -Ñesizeáborted");

1769  -
EINVAL
;

1773 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
, &
group
, &
œ°
);

1775 i‡(
œ°
 == 0) {

1776 
	`pxt4_w¨nög
(
sb
, "needÅo useÖxt2onlineÅoÑesize further");

1777  -
EPERM
;

1780 
add
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
Ë- 
œ°
;

1782 i‡(
o_blocks_cou¡
 + 
add
 < o_blocks_count) {

1783 
	`pxt4_w¨nög
(
sb
, "blocks_count overflow");

1784  -
EINVAL
;

1787 i‡(
o_blocks_cou¡
 + 
add
 > 
n_blocks_cou¡
)

1788 
add
 = 
n_blocks_cou¡
 - 
o_blocks_cou¡
;

1790 i‡(
o_blocks_cou¡
 + 
add
 < 
n_blocks_cou¡
)

1791 
	`pxt4_w¨nög
(
sb
, "will only finish group (%llu blocks, %uÇew)",

1792 
o_blocks_cou¡
 + 
add
,ádd);

1795 
bh
 = 
	`sb_bªad
(
sb
, 
o_blocks_cou¡
 + 
add
 - 1);

1796 i‡(!
bh
) {

1797 
	`pxt4_w¨nög
(
sb
, "can'tÑeadÜast block,Ñesizeáborted");

1798  -
ENOSPC
;

1800 
	`bªl£
(
bh
);

1802 
îr
 = 
	`pxt4_group_exãnd_no_check
(
sb
, 
o_blocks_cou¡
, 
add
);

1803  
îr
;

1804 
	}
}

1807 
	$num_desc_blocks
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
groups
)

1809  (
groups
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) / PXT4_DESC_PER_BLOCK(sb);

1810 
	}
}

1817 
	$pxt4_c⁄vît_mëa_bg
(
su≥r_block
 *
sb
, 
öode
 *inode)

1819 
h™dÀ_t
 *
h™dÀ
;

1820 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1821 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1822 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1823 
pxt4_fsblk_t
 
ƒ
;

1824 
i
, 
ªt
, 
îr
 = 0;

1825 
¸edôs
 = 1;

1827 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Converting file systemÅo meta_bg");

1828 i‡(
öode
) {

1829 i‡(
es
->
s_ª£rved_gdt_blocks
) {

1830 
	`pxt4_îr‹
(
sb
, "UnexpectedÇon-zero "

1832  -
EPERM
;

1836 i‡(
öode
->
i_blocks
 !1 << (öode->
i_blkbôs
 -

1837 (9 - 
sbi
->
s_˛u°î_bôs
)))

1838 
övÆid_ªsize_öode
;

1839 
i
 = 0; i < 
PXT4_N_BLOCKS
; i++) {

1840 i‡(
i
 =
PXT4_DIND_BLOCK
) {

1841 i‡(
ei
->
i_d©a
[
i
])

1844 
övÆid_ªsize_öode
;

1846 i‡(
ei
->
i_d©a
[
i
])

1847 
övÆid_ªsize_öode
;

1849 
¸edôs
 += 3;

1852 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
¸edôs
);

1853 i‡(
	`IS_ERR
(
h™dÀ
))

1854  
	`PTR_ERR
(
h™dÀ
);

1856 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

1857 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

1858 i‡(
îr
)

1859 
îrout
;

1861 
	`pxt4_˛ór_„©uª_ªsize_öode
(
sb
);

1862 
	`pxt4_£t_„©uª_mëa_bg
(
sb
);

1863 
sbi
->
s_es
->
s_fú°_mëa_bg
 =

1864 
	`˝u_to_À32
(
	`num_desc_blocks
(
sb
, 
sbi
->
s_groups_cou¡
));

1866 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

1867 i‡(
îr
) {

1868 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1869 
îrout
;

1872 i‡(
öode
) {

1873 
ƒ
 = 
	`À32_to_˝u
(
ei
->
i_d©a
[
PXT4_DIND_BLOCK
]);

1874 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
ƒ
, 1,

1875 
PXT4_FREE_BLOCKS_METADATA
 |

1876 
PXT4_FREE_BLOCKS_FORGET
);

1877 
ei
->
i_d©a
[
PXT4_DIND_BLOCK
] = 0;

1878 
öode
->
i_blocks
 = 0;

1880 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1881 i‡(
îr
)

1882 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1885 
îrout
:

1886 
ªt
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1887 i‡(!
îr
)

1888 
îr
 = 
ªt
;

1889  
ªt
;

1891 
övÆid_ªsize_öode
:

1892 
	`pxt4_îr‹
(
sb
, "corrupted/inconsistentÑesize inode");

1893  -
EINVAL
;

1894 
	}
}

1902 
	$pxt4_ªsize_fs
(
su≥r_block
 *
sb
, 
pxt4_fsblk_t
 
n_blocks_cou¡
)

1904 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
 = 
NULL
;

1905 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1906 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1907 
buf„r_hód
 *
bh
;

1908 
öode
 *
ªsize_öode
 = 
NULL
;

1909 
pxt4_gΩblk_t
 
add
, 
off£t
;

1910 
n_desc_blocks
;

1911 
o_desc_blocks
;

1912 
pxt4_group_t
 
o_group
;

1913 
pxt4_group_t
 
n_group
;

1914 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1915 
pxt4_fsblk_t
 
n_blocks_cou¡_ªåy
 = 0;

1916 
œ°_upd©e_time
 = 0;

1917 
îr
 = 0, 
Êexbg_size
 = 1 << 
sbi
->
s_log_groups_≥r_Êex
;

1918 
mëa_bg
;

1921 
bh
 = 
	`sb_bªad
(
sb
, 
n_blocks_cou¡
 - 1);

1922 i‡(!
bh
) {

1923 
	`pxt4_w¨nög
(
sb
, "can'tÑeadÜast block,Ñesizeáborted");

1924  -
ENOSPC
;

1926 
	`bªl£
(
bh
);

1928 
ªåy
:

1929 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1931 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "resizing filesystem from %llu "

1932 "tÿ%Œu blocks", 
o_blocks_cou¡
, 
n_blocks_cou¡
);

1934 i‡(
n_blocks_cou¡
 < 
o_blocks_cou¡
) {

1936 
	`pxt4_w¨nög
(
sb
, "can't shrink FS -Ñesizeáborted");

1937  -
EINVAL
;

1940 i‡(
n_blocks_cou¡
 =
o_blocks_cou¡
)

1944 
n_group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
n_blocks_cou¡
 - 1);

1945 i‡(
n_group
 >(0xFFFFFFFFUL / 
	`PXT4_INODES_PER_GROUP
(
sb
))) {

1946 
	`pxt4_w¨nög
(
sb
, "resize would cause inodes_count overflow");

1947  -
EINVAL
;

1949 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
 - 1, &
o_group
, &
off£t
);

1951 
n_desc_blocks
 = 
	`num_desc_blocks
(
sb
, 
n_group
 + 1);

1952 
o_desc_blocks
 = 
	`num_desc_blocks
(
sb
, 
sbi
->
s_groups_cou¡
);

1954 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

1956 i‡(
	`pxt4_has_„©uª_ªsize_öode
(
sb
)) {

1957 i‡(
mëa_bg
) {

1958 
	`pxt4_îr‹
(
sb
, "resize_inodeánd meta_bgÉnabled "

1960  -
EINVAL
;

1962 i‡(
n_desc_blocks
 > 
o_desc_blocks
 +

1963 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
)) {

1964 
n_blocks_cou¡_ªåy
 = 
n_blocks_cou¡
;

1965 
n_desc_blocks
 = 
o_desc_blocks
 +

1966 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
);

1967 
n_group
 = 
n_desc_blocks
 * 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1968 
n_blocks_cou¡
 = (
pxt4_fsblk_t
)
n_group
 *

1969 
	`PXT4_BLOCKS_PER_GROUP
(
sb
) +

1970 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
);

1971 
n_group
--;

1974 i‡(!
ªsize_öode
)

1975 
ªsize_öode
 = 
	`pxt4_igë
(
sb
, 
PXT4_RESIZE_INO
,

1976 
PXT4_IGET_SPECIAL
);

1977 i‡(
	`IS_ERR
(
ªsize_öode
)) {

1978 
	`pxt4_w¨nög
(
sb
, "Error openingÑesize inode");

1979  
	`PTR_ERR
(
ªsize_öode
);

1983 i‡((!
ªsize_öode
 && !
mëa_bg
Ë|| 
n_blocks_cou¡
 =
o_blocks_cou¡
) {

1984 
îr
 = 
	`pxt4_c⁄vît_mëa_bg
(
sb
, 
ªsize_öode
);

1985 i‡(
îr
)

1986 
out
;

1987 i‡(
ªsize_öode
) {

1988 
	`ùut
(
ªsize_öode
);

1989 
ªsize_öode
 = 
NULL
;

1991 i‡(
n_blocks_cou¡_ªåy
) {

1992 
n_blocks_cou¡
 = 
n_blocks_cou¡_ªåy
;

1993 
n_blocks_cou¡_ªåy
 = 0;

1994 
ªåy
;

2005 i‡((
	`pxt4_group_fú°_block_no
(
sb
, 
n_group
) +

2006 
	`pxt4_group_ovîhód_blocks
(
sb
, 
n_group
) + 2 +

2007 
sbi
->
s_ôb_≥r_group
 + sbi->
s_˛u°î_øtio
Ë>
n_blocks_cou¡
) {

2008 
n_blocks_cou¡
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
n_group
);

2009 
n_group
--;

2010 
n_blocks_cou¡_ªåy
 = 0;

2011 i‡(
ªsize_öode
) {

2012 
	`ùut
(
ªsize_öode
);

2013 
ªsize_öode
 = 
NULL
;

2015 
ªåy
;

2019 i‡(
n_group
 =
o_group
)

2020 
add
 = 
n_blocks_cou¡
 - 
o_blocks_cou¡
;

2022 
add
 = 
	`PXT4_C2B
(
sbi
, 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
Ë- (
off£t
 + 1));

2023 i‡(
add
 > 0) {

2024 
îr
 = 
	`pxt4_group_exãnd_no_check
(
sb
, 
o_blocks_cou¡
, 
add
);

2025 i‡(
îr
)

2026 
out
;

2029 i‡(
	`pxt4_blocks_cou¡
(
es
Ë=
n_blocks_cou¡
)

2030 
out
;

2032 
îr
 = 
	`pxt4_Æloc_Êex_bg_¨øy
(
sb
, 
n_group
 + 1);

2033 i‡(
îr
)

2034 
out
;

2036 
îr
 = 
	`pxt4_mb_Æloc_groupöfo
(
sb
, 
n_group
 + 1);

2037 i‡(
îr
)

2038 
out
;

2040 
Êex_gd
 = 
	`Æloc_Êex_gd
(
Êexbg_size
);

2041 i‡(
Êex_gd
 =
NULL
) {

2042 
îr
 = -
ENOMEM
;

2043 
out
;

2049 
	`pxt4_£tup_√xt_Êex_gd
(
sb
, 
Êex_gd
, 
n_blocks_cou¡
,

2050 
Êexbg_size
)) {

2051 i‡(
jiffõs
 - 
œ°_upd©e_time
 > 
HZ
 * 10) {

2052 i‡(
œ°_upd©e_time
)

2053 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2055 
	`pxt4_blocks_cou¡
(
es
));

2056 
œ°_upd©e_time
 = 
jiffõs
;

2058 i‡(
	`pxt4_Æloc_group_èbÀs
(
sb
, 
Êex_gd
, 
Êexbg_size
) != 0)

2060 
îr
 = 
	`pxt4_Êex_group_add
(
sb
, 
ªsize_öode
, 
Êex_gd
);

2061 i‡(
	`u∆ikñy
(
îr
))

2065 i‡(!
îr
 && 
n_blocks_cou¡_ªåy
) {

2066 
n_blocks_cou¡
 = 
n_blocks_cou¡_ªåy
;

2067 
n_blocks_cou¡_ªåy
 = 0;

2068 
	`‰ì_Êex_gd
(
Êex_gd
);

2069 
Êex_gd
 = 
NULL
;

2070 i‡(
ªsize_öode
) {

2071 
	`ùut
(
ªsize_öode
);

2072 
ªsize_öode
 = 
NULL
;

2074 
ªåy
;

2077 
out
:

2078 i‡(
Êex_gd
)

2079 
	`‰ì_Êex_gd
(
Êex_gd
);

2080 i‡(
ªsize_öode
 !
NULL
)

2081 
	`ùut
(
ªsize_öode
);

2082 i‡(
îr
)

2083 
	`pxt4_w¨nög
(
sb
, "error (%d) occurred during "

2084 "fûêsy°emÑesize", 
îr
);

2085 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "resized filesystemÅo %llu",

2086 
	`pxt4_blocks_cou¡
(
es
));

2087  
îr
;

2088 
	}
}

	@super.c

20 
	~<löux/moduÀ.h
>

21 
	~<löux/°rög.h
>

22 
	~<löux/fs.h
>

23 
	~<löux/time.h
>

24 
	~<löux/vmÆloc.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/öô.h
>

27 
	~<löux/blkdev.h
>

28 
	~<löux/backög-dev.h
>

29 
	~<löux/∑r£r.h
>

30 
	~<löux/buf„r_hód.h
>

31 
	~<löux/exp‹tfs.h
>

32 
	~<löux/vfs.h
>

33 
	~<löux/øndom.h
>

34 
	~<löux/mou¡.h
>

35 
	~<löux/«mei.h
>

36 
	~<löux/quŸa›s.h
>

37 
	~<löux/£q_fûe.h
>

38 
	~<löux/˘y≥.h
>

39 
	~<löux/log2.h
>

40 
	~<löux/¸c16.h
>

41 
	~<löux/dax.h
>

42 
	~<löux/˛ónˇche.h
>

43 
	~<löux/uac˚ss.h
>

44 
	~<löux/ivîsi⁄.h
>

45 
	~<löux/unicode.h
>

47 
	~<löux/kthªad.h
>

48 
	~<löux/‰ìzî.h
>

50 
	~"pxt4.h
"

51 
	~"pxt4_exã¡s.h
"

52 
	~"pxt4_jbd3.h
"

53 
	~"x©å.h
"

54 
	~"a˛.h
"

55 
	~"mbÆloc.h
"

56 
	~"fsm≠.h
"

58 
	#CREATE_TRACE_POINTS


	)

59 
	~<åa˚/evíts/pxt4.h
>

61 
pxt4_œzy_öô
 *
	gpxt4_li_öfo
;

62 
muãx
 
	gpxt4_li_mtx
;

63 
øãlimô_°©e
 
	gpxt4_mou¡_msg_øãlimô
;

65 
pxt4_lﬂd_jou∫Æ
(
su≥r_block
 *, 
pxt4_su≥r_block
 *,

66 
jou∫Æ_devnum
);

67 
pxt4_show_›ti⁄s
(
£q_fûe
 *
£q
, 
díåy
 *
roŸ
);

68 
pxt4_commô_su≥r
(
su≥r_block
 *
sb
, 
sync
);

69 
pxt4_m¨k_ªcovîy_com∂ëe
(
su≥r_block
 *
sb
,

70 
pxt4_su≥r_block
 *
es
);

71 
pxt4_˛ór_jou∫Æ_îr
(
su≥r_block
 *
sb
,

72 
pxt4_su≥r_block
 *
es
);

73 
pxt4_sync_fs
(
su≥r_block
 *
sb
, 
waô
);

74 
pxt4_ªmou¡
(
su≥r_block
 *
sb
, *
Êags
, *
d©a
);

75 
pxt4_°©fs
(
díåy
 *díåy, 
k°©fs
 *
buf
);

76 
pxt4_un‰ìze
(
su≥r_block
 *
sb
);

77 
pxt4_‰ìze
(
su≥r_block
 *
sb
);

78 
díåy
 *
pxt4_mou¡
(
fûe_sy°em_ty≥
 *
fs_ty≥
, 
Êags
,

79 c⁄° *
dev_«me
, *
d©a
);

80 
ölöe
 
pxt2_„©uª_£t_ok
(
su≥r_block
 *
sb
);

81 
ölöe
 
ext3_„©uª_£t_ok
(
su≥r_block
 *
sb
);

82 
pxt4_„©uª_£t_ok
(
su≥r_block
 *
sb
, 
ªad⁄ly
);

83 
pxt4_de°roy_œzyöô_thªad
();

84 
pxt4_uƒegi°î_li_ªque°
(
su≥r_block
 *
sb
);

85 
pxt4_˛ór_ªque°_li°
();

86 
öode
 *
pxt4_gë_jou∫Æ_öode
(
su≥r_block
 *
sb
,

87 
jou∫Æ_öum
);

117 #i‡!
deföed
(
CONFIG_PXT2_FS
Ë&& !deföed(
CONFIG_PXT2_FS_MODULE
Ë&& deföed(
CONFIG_PXT4_USE_FOR_PXT2
)

118 
fûe_sy°em_ty≥
 
	gpxt2_fs_ty≥
 = {

119 .
ow√r
 = 
THIS_MODULE
,

120 .
	g«me
 = "pxt2",

121 .
	gmou¡
 = 
pxt4_mou¡
,

122 .
	gkûl_sb
 = 
kûl_block_su≥r
,

123 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

125 
MODULE_ALIAS_FS
("pxt2");

126 
MODULE_ALIAS
("pxt2");

127 
	#IS_PXT2_SB
(
sb
Ë((sb)->
s_bdev
->
bd_hﬁdî
 =&
pxt2_fs_ty≥
)

	)

129 
	#IS_PXT2_SB
(
sb
Ë(0)

	)

133 
fûe_sy°em_ty≥
 
	gext3_fs_ty≥
 = {

134 .
ow√r
 = 
THIS_MODULE
,

135 .
	g«me
 = "ext3",

136 .
	gmou¡
 = 
pxt4_mou¡
,

137 .
	gkûl_sb
 = 
kûl_block_su≥r
,

138 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

140 
MODULE_ALIAS_FS
("ext3");

141 
MODULE_ALIAS
("ext3");

142 
	#IS_EXT3_SB
(
sb
Ë((sb)->
s_bdev
->
bd_hﬁdî
 =&
ext3_fs_ty≥
)

	)

150 
buf„r_hód
 *

151 
	$pxt4_sb_bªad
(
su≥r_block
 *
sb
, 
£˘‹_t
 
block
, 
›_Êags
)

153 
buf„r_hód
 *
bh
 = 
	`sb_gëblk
(
sb
, 
block
);

155 i‡(
bh
 =
NULL
)

156  
	`ERR_PTR
(-
ENOMEM
);

157 i‡(
	`buf„r_u±od©e
(
bh
))

158  
bh
;

159 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
›_Êags
, 1, &
bh
);

160 
	`waô_⁄_buf„r
(
bh
);

161 i‡(
	`buf„r_u±od©e
(
bh
))

162  
bh
;

163 
	`put_bh
(
bh
);

164  
	`ERR_PTR
(-
EIO
);

165 
	}
}

167 
	$pxt4_vîify_csum_ty≥
(
su≥r_block
 *
sb
,

168 
pxt4_su≥r_block
 *
es
)

170 i‡(!
	`pxt4_has_„©uª_mëad©a_csum
(
sb
))

173  
es
->
s_checksum_ty≥
 =
PXT4_CRC32C_CHKSUM
;

174 
	}
}

176 
__À32
 
	$pxt4_su≥rblock_csum
(
su≥r_block
 *
sb
,

177 
pxt4_su≥r_block
 *
es
)

179 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

180 
off£t
 = 
	`off£tof
(
pxt4_su≥r_block
, 
s_checksum
);

181 
__u32
 
csum
;

183 
csum
 = 
	`pxt4_chksum
(
sbi
, ~0, (*)
es
, 
off£t
);

185  
	`˝u_to_À32
(
csum
);

186 
	}
}

188 
	$pxt4_su≥rblock_csum_vîify
(
su≥r_block
 *
sb
,

189 
pxt4_su≥r_block
 *
es
)

191 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

194  
es
->
s_checksum
 =
	`pxt4_su≥rblock_csum
(
sb
,És);

195 
	}
}

197 
	$pxt4_su≥rblock_csum_£t
(
su≥r_block
 *
sb
)

199 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

201 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

204 
es
->
s_checksum
 = 
	`pxt4_su≥rblock_csum
(
sb
,És);

205 
	}
}

207 *
	$pxt4_kvmÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
)

209 *
ªt
;

211 
ªt
 = 
	`kmÆloc
(
size
, 
Êags
 | 
__GFP_NOWARN
);

212 i‡(!
ªt
)

213 
ªt
 = 
	`__vmÆloc
(
size
, 
Êags
, 
PAGE_KERNEL
);

214  
ªt
;

215 
	}
}

217 *
	$pxt4_kvzÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
)

219 *
ªt
;

221 
ªt
 = 
	`kzÆloc
(
size
, 
Êags
 | 
__GFP_NOWARN
);

222 i‡(!
ªt
)

223 
ªt
 = 
	`__vmÆloc
(
size
, 
Êags
 | 
__GFP_ZERO
, 
PAGE_KERNEL
);

224  
ªt
;

225 
	}
}

227 
pxt4_fsblk_t
 
	$pxt4_block_bôm≠
(
su≥r_block
 *
sb
,

228 
pxt4_group_desc
 *
bg
)

230  
	`À32_to_˝u
(
bg
->
bg_block_bôm≠_lo
) |

231 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

232 (
pxt4_fsblk_t
)
	`À32_to_˝u
(
bg
->
bg_block_bôm≠_hi
) << 32 : 0);

233 
	}
}

235 
pxt4_fsblk_t
 
	$pxt4_öode_bôm≠
(
su≥r_block
 *
sb
,

236 
pxt4_group_desc
 *
bg
)

238  
	`À32_to_˝u
(
bg
->
bg_öode_bôm≠_lo
) |

239 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

240 (
pxt4_fsblk_t
)
	`À32_to_˝u
(
bg
->
bg_öode_bôm≠_hi
) << 32 : 0);

241 
	}
}

243 
pxt4_fsblk_t
 
	$pxt4_öode_èbÀ
(
su≥r_block
 *
sb
,

244 
pxt4_group_desc
 *
bg
)

246  
	`À32_to_˝u
(
bg
->
bg_öode_èbÀ_lo
) |

247 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

248 (
pxt4_fsblk_t
)
	`À32_to_˝u
(
bg
->
bg_öode_èbÀ_hi
) << 32 : 0);

249 
	}
}

251 
__u32
 
	$pxt4_‰ì_group_˛u°îs
(
su≥r_block
 *
sb
,

252 
pxt4_group_desc
 *
bg
)

254  
	`À16_to_˝u
(
bg
->
bg_‰ì_blocks_cou¡_lo
) |

255 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

256 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_‰ì_blocks_cou¡_hi
) << 16 : 0);

257 
	}
}

259 
__u32
 
	$pxt4_‰ì_öodes_cou¡
(
su≥r_block
 *
sb
,

260 
pxt4_group_desc
 *
bg
)

262  
	`À16_to_˝u
(
bg
->
bg_‰ì_öodes_cou¡_lo
) |

263 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

264 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_‰ì_öodes_cou¡_hi
) << 16 : 0);

265 
	}
}

267 
__u32
 
	$pxt4_u£d_dús_cou¡
(
su≥r_block
 *
sb
,

268 
pxt4_group_desc
 *
bg
)

270  
	`À16_to_˝u
(
bg
->
bg_u£d_dús_cou¡_lo
) |

271 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

272 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_u£d_dús_cou¡_hi
) << 16 : 0);

273 
	}
}

275 
__u32
 
	$pxt4_ôabÀ_unu£d_cou¡
(
su≥r_block
 *
sb
,

276 
pxt4_group_desc
 *
bg
)

278  
	`À16_to_˝u
(
bg
->
bg_ôabÀ_unu£d_lo
) |

279 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

280 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_ôabÀ_unu£d_hi
) << 16 : 0);

281 
	}
}

283 
	$pxt4_block_bôm≠_£t
(
su≥r_block
 *
sb
,

284 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
)

286 
bg
->
bg_block_bôm≠_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

287 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

288 
bg
->
bg_block_bôm≠_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

289 
	}
}

291 
	$pxt4_öode_bôm≠_£t
(
su≥r_block
 *
sb
,

292 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
)

294 
bg
->
bg_öode_bôm≠_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

295 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

296 
bg
->
bg_öode_bôm≠_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

297 
	}
}

299 
	$pxt4_öode_èbÀ_£t
(
su≥r_block
 *
sb
,

300 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
)

302 
bg
->
bg_öode_èbÀ_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

303 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

304 
bg
->
bg_öode_èbÀ_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

305 
	}
}

307 
	$pxt4_‰ì_group_˛u°îs_£t
(
su≥r_block
 *
sb
,

308 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

310 
bg
->
bg_‰ì_blocks_cou¡_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

311 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

312 
bg
->
bg_‰ì_blocks_cou¡_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

313 
	}
}

315 
	$pxt4_‰ì_öodes_£t
(
su≥r_block
 *
sb
,

316 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

318 
bg
->
bg_‰ì_öodes_cou¡_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

319 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

320 
bg
->
bg_‰ì_öodes_cou¡_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

321 
	}
}

323 
	$pxt4_u£d_dús_£t
(
su≥r_block
 *
sb
,

324 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

326 
bg
->
bg_u£d_dús_cou¡_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

327 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

328 
bg
->
bg_u£d_dús_cou¡_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

329 
	}
}

331 
	$pxt4_ôabÀ_unu£d_£t
(
su≥r_block
 *
sb
,

332 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

334 
bg
->
bg_ôabÀ_unu£d_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

335 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

336 
bg
->
bg_ôabÀ_unu£d_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

337 
	}
}

339 
	$__pxt4_upd©e_t°amp
(
__À32
 *
lo
, 
__u8
 *
hi
)

341 
time64_t
 
now
 = 
	`ktime_gë_ªÆ_£c⁄ds
();

343 
now
 = 
	`˛amp_vÆ
(now, 0, (1ull << 40) - 1);

345 *
lo
 = 
	`˝u_to_À32
(
	`lowî_32_bôs
(
now
));

346 *
hi
 = 
	`uµî_32_bôs
(
now
);

347 
	}
}

349 
time64_t
 
	$__pxt4_gë_t°amp
(
__À32
 *
lo
, 
__u8
 *
hi
)

351  ((
time64_t
)(*
hi
Ë<< 32Ë+ 
	`À32_to_˝u
(*
lo
);

352 
	}
}

353 
	#pxt4_upd©e_t°amp
(
es
, 
t°amp
) \

354 
	`__pxt4_upd©e_t°amp
(&(
es
)->
t°amp
, &”s)->t°am∞## 
_hi
)

	)

355 
	#pxt4_gë_t°amp
(
es
, 
t°amp
) \

356 
	`__pxt4_gë_t°amp
(&(
es
)->
t°amp
, &”s)->t°am∞## 
_hi
)

	)

358 
	$__ßve_îr‹_öfo
(
su≥r_block
 *
sb
, c⁄° *
func
,

359 
löe
)

361 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

363 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 |
PXT4_ERROR_FS
;

364 i‡(
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
))

366 
es
->
s_°©e
 |
	`˝u_to_À16
(
PXT4_ERROR_FS
);

367 
	`pxt4_upd©e_t°amp
(
es
, 
s_œ°_îr‹_time
);

368 
	`°∫˝y
(
es
->
s_œ°_îr‹_func
, 
func
, (es->s_last_error_func));

369 
es
->
s_œ°_îr‹_löe
 = 
	`˝u_to_À32
(
löe
);

370 i‡(!
es
->
s_fú°_îr‹_time
) {

371 
es
->
s_fú°_îr‹_time
 =És->
s_œ°_îr‹_time
;

372 
es
->
s_fú°_îr‹_time_hi
 =És->
s_œ°_îr‹_time_hi
;

373 
	`°∫˝y
(
es
->
s_fú°_îr‹_func
, 
func
,

374 (
es
->
s_fú°_îr‹_func
));

375 
es
->
s_fú°_îr‹_löe
 = 
	`˝u_to_À32
(
löe
);

376 
es
->
s_fú°_îr‹_öo
 =És->
s_œ°_îr‹_öo
;

377 
es
->
s_fú°_îr‹_block
 =És->
s_œ°_îr‹_block
;

383 i‡(!
es
->
s_îr‹_cou¡
)

384 
	`mod_timî
(&
	`PXT4_SB
(
sb
)->
s_îr_ªp‹t
, 
jiffõs
 + 24*60*60*
HZ
);

385 
	`À32_add_˝u
(&
es
->
s_îr‹_cou¡
, 1);

386 
	}
}

388 
	$ßve_îr‹_öfo
(
su≥r_block
 *
sb
, c⁄° *
func
,

389 
löe
)

391 
	`__ßve_îr‹_öfo
(
sb
, 
func
, 
löe
);

392 
	`pxt4_commô_su≥r
(
sb
, 1);

393 
	}
}

403 
	$block_devi˚_eje˘ed
(
su≥r_block
 *
sb
)

405 
öode
 *
bd_öode
 = 
sb
->
s_bdev
->bd_inode;

406 
backög_dev_öfo
 *
bdi
 = 
	`öode_to_bdi
(
bd_öode
);

408  
bdi
->
dev
 =
NULL
;

409 
	}
}

411 
	$pxt4_jou∫Æ_commô_ˇŒback
(
jou∫Æ_t
 *
jou∫Æ
, 
å™ß˘i⁄_t
 *
txn
)

413 
su≥r_block
 *
sb
 = 
jou∫Æ
->
j_¥iv©e
;

414 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

415 
îr‹
 = 
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
);

416 
pxt4_jou∫Æ_cb_íåy
 *
j˚
;

418 
	`BUG_ON
(
txn
->
t_°©e
 =
T_FINISHED
);

420 
	`pxt4_¥o˚ss_‰ìd_d©a
(
sb
, 
txn
->
t_tid
);

422 
	`•ö_lock
(&
sbi
->
s_md_lock
);

423 !
	`li°_em±y
(&
txn
->
t_¥iv©e_li°
)) {

424 
j˚
 = 
	`li°_íåy
(
txn
->
t_¥iv©e_li°
.
√xt
,

425 
pxt4_jou∫Æ_cb_íåy
, 
j˚_li°
);

426 
	`li°_dñ_öô
(&
j˚
->
j˚_li°
);

427 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

428 
j˚
->
	`j˚_func
(
sb
, j˚, 
îr‹
);

429 
	`•ö_lock
(&
sbi
->
s_md_lock
);

431 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

432 
	}
}

434 
boﬁ
 
	$sy°em_goög_down
()

436  
sy°em_°©e
 =
SYSTEM_HALT
 || sy°em_°©ê=
SYSTEM_POWER_OFF


437 || 
sy°em_°©e
 =
SYSTEM_RESTART
;

438 
	}
}

455 
	$pxt4_h™dÀ_îr‹
(
su≥r_block
 *
sb
)

457 i‡(
	`ã°_›t
(
sb
, 
WARN_ON_ERROR
))

458 
	`WARN_ON_ONCE
(1);

460 i‡(
	`sb_rd⁄ly
(
sb
))

463 i‡(!
	`ã°_›t
(
sb
, 
ERRORS_CONT
)) {

464 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

466 
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 |
PXT4_MF_FS_ABORTED
;

467 i‡(
jou∫Æ
)

468 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, -
EIO
);

475 i‡(
	`ã°_›t
(
sb
, 
ERRORS_RO
Ë|| 
	`sy°em_goög_down
()) {

476 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Remounting filesystemÑead-only");

481 
	`smp_wmb
();

482 
sb
->
s_Êags
 |
SB_RDONLY
;

483 } i‡(
	`ã°_›t
(
sb
, 
ERRORS_PANIC
)) {

484 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

485 !(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
->
j_Êags
 & 
JBD3_REC_ERR
))

487 
	`∑nic
("PXT4-fs (device %s):Öanic forcedáfterÉrror\n",

488 
sb
->
s_id
);

490 
	}
}

492 
	#pxt4_îr‹_øãlimô
(
sb
) \

493 
	`___øãlimô
(&(
	`PXT4_SB
(
sb
)->
s_îr_øãlimô_°©e
), \

494 "PXT4-f†îr‹")

	)

496 
	$__pxt4_îr‹
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

497 
löe
, c⁄° *
fmt
, ...)

499 
va_f‹m©
 
vaf
;

500 
va_li°
 
¨gs
;

502 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

505 
	`åa˚_pxt4_îr‹
(
sb
, 
fun˘i⁄
, 
löe
);

506 i‡(
	`pxt4_îr‹_øãlimô
(
sb
)) {

507 
	`va_°¨t
(
¨gs
, 
fmt
);

508 
vaf
.
fmt
 = fmt;

509 
vaf
.
va
 = &
¨gs
;

510 
	`¥ötk
(
KERN_CRIT


512 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, 
cuºít
->
comm
, &
vaf
);

513 
	`va_íd
(
¨gs
);

515 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

516 
	`pxt4_h™dÀ_îr‹
(
sb
);

517 
	}
}

519 
	$__pxt4_îr‹_öode
(
öode
 *öode, c⁄° *
fun˘i⁄
,

520 
löe
, 
pxt4_fsblk_t
 
block
,

521 c⁄° *
fmt
, ...)

523 
va_li°
 
¨gs
;

524 
va_f‹m©
 
vaf
;

525 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

527 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

530 
	`åa˚_pxt4_îr‹
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

531 
es
->
s_œ°_îr‹_öo
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

532 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
block
);

533 i‡(
	`pxt4_îr‹_øãlimô
(
öode
->
i_sb
)) {

534 
	`va_°¨t
(
¨gs
, 
fmt
);

535 
vaf
.
fmt
 = fmt;

536 
vaf
.
va
 = &
¨gs
;

537 i‡(
block
)

538 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: "

540 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

541 
block
, 
cuºít
->
comm
, &
vaf
);

543 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: "

545 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

546 
cuºít
->
comm
, &
vaf
);

547 
	`va_íd
(
¨gs
);

549 
	`ßve_îr‹_öfo
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

550 
	`pxt4_h™dÀ_îr‹
(
öode
->
i_sb
);

551 
	}
}

553 
	$__pxt4_îr‹_fûe
(
fûe
 *fûe, c⁄° *
fun˘i⁄
,

554 
löe
, 
pxt4_fsblk_t
 
block
,

555 c⁄° *
fmt
, ...)

557 
va_li°
 
¨gs
;

558 
va_f‹m©
 
vaf
;

559 
pxt4_su≥r_block
 *
es
;

560 
öode
 *öodê
	`fûe_öode
(
fûe
);

561 
∑th«me
[80], *
∑th
;

563 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

566 
	`åa˚_pxt4_îr‹
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

567 
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

568 
es
->
s_œ°_îr‹_öo
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

569 i‡(
	`pxt4_îr‹_øãlimô
(
öode
->
i_sb
)) {

570 
∑th
 = 
	`fûe_∑th
(
fûe
, 
∑th«me
, (pathname));

571 i‡(
	`IS_ERR
(
∑th
))

572 
∑th
 = "(unknown)";

573 
	`va_°¨t
(
¨gs
, 
fmt
);

574 
vaf
.
fmt
 = fmt;

575 
vaf
.
va
 = &
¨gs
;

576 i‡(
block
)

577 
	`¥ötk
(
KERN_CRIT


580 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

581 
block
, 
cuºít
->
comm
, 
∑th
, &
vaf
);

583 
	`¥ötk
(
KERN_CRIT


586 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

587 
cuºít
->
comm
, 
∑th
, &
vaf
);

588 
	`va_íd
(
¨gs
);

590 
	`ßve_îr‹_öfo
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

591 
	`pxt4_h™dÀ_îr‹
(
öode
->
i_sb
);

592 
	}
}

594 c⁄° *
	$pxt4_decode_îr‹
(
su≥r_block
 *
sb
, 
î∫o
,

595 
nbuf
[16])

597 *
îr°r
 = 
NULL
;

599 
î∫o
) {

600 -
EFSCORRUPTED
:

601 
îr°r
 = "Corrupt filesystem";

603 -
EFSBADCRC
:

604 
îr°r
 = "Filesystem failed CRC";

606 -
EIO
:

607 
îr°r
 = "IO failure";

609 -
ENOMEM
:

610 
îr°r
 = "Out of memory";

612 -
EROFS
:

613 i‡(!
sb
 || (
	`PXT4_SB
(sb)->
s_jou∫Æ
 &&

614 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
->
j_Êags
 & 
JBD3_ABORT
))

615 
îr°r
 = "Journal hasáborted";

617 
îr°r
 = "Readonly filesystem";

623 i‡(
nbuf
) {

625 i‡(
	`¢¥ötf
(
nbuf
, 16, "îr‹ %d", -
î∫o
) >= 0)

626 
îr°r
 = 
nbuf
;

631  
îr°r
;

632 
	}
}

637 
	$__pxt4_°d_îr‹
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

638 
löe
, 
î∫o
)

640 
nbuf
[16];

641 c⁄° *
îr°r
;

643 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

649 i‡(
î∫o
 =-
EROFS
 && 
	`jou∫Æ_cuºít_h™dÀ
(Ë=
NULL
 && 
	`sb_rd⁄ly
(
sb
))

652 i‡(
	`pxt4_îr‹_øãlimô
(
sb
)) {

653 
îr°r
 = 
	`pxt4_decode_îr‹
(
sb
, 
î∫o
, 
nbuf
);

654 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s) in %s:%d: %s\n",

655 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, 
îr°r
);

658 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

659 
	`pxt4_h™dÀ_îr‹
(
sb
);

660 
	}
}

672 
	$__pxt4_ab‹t
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

673 
löe
, c⁄° *
fmt
, ...)

675 
va_f‹m©
 
vaf
;

676 
va_li°
 
¨gs
;

678 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

681 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

682 
	`va_°¨t
(
¨gs
, 
fmt
);

683 
vaf
.
fmt
 = fmt;

684 
vaf
.
va
 = &
¨gs
;

685 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: %pV\n",

686 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, &
vaf
);

687 
	`va_íd
(
¨gs
);

689 i‡(
	`sb_rd⁄ly
(
sb
) == 0) {

690 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Remounting filesystemÑead-only");

691 
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 |
PXT4_MF_FS_ABORTED
;

696 
	`smp_wmb
();

697 
sb
->
s_Êags
 |
SB_RDONLY
;

698 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
)

699 
	`jbd3_jou∫Æ_ab‹t
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
, -
EIO
);

700 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

702 i‡(
	`ã°_›t
(
sb
, 
ERRORS_PANIC
Ë&& !
	`sy°em_goög_down
()) {

703 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

704 !(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
->
j_Êags
 & 
JBD3_REC_ERR
))

706 
	`∑nic
("PXT4-fsÖanic fromÖreviousÉrror\n");

708 
	}
}

710 
	$__pxt4_msg
(
su≥r_block
 *
sb
,

711 c⁄° *
¥efix
, c⁄° *
fmt
, ...)

713 
va_f‹m©
 
vaf
;

714 
va_li°
 
¨gs
;

716 i‡(!
	`___øãlimô
(&(
	`PXT4_SB
(
sb
)->
s_msg_øãlimô_°©e
), "PXT4-fs"))

719 
	`va_°¨t
(
¨gs
, 
fmt
);

720 
vaf
.
fmt
 = fmt;

721 
vaf
.
va
 = &
¨gs
;

722 
	`¥ötk
("%sPXT4-f†(%s): %pV\n", 
¥efix
, 
sb
->
s_id
, &
vaf
);

723 
	`va_íd
(
¨gs
);

724 
	}
}

726 
	#pxt4_w¨nög_øãlimô
(
sb
) \

727 
	`___øãlimô
(&(
	`PXT4_SB
(
sb
)->
s_w¨nög_øãlimô_°©e
), \

728 "PXT4-f†w¨nög")

	)

730 
	$__pxt4_w¨nög
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

731 
löe
, c⁄° *
fmt
, ...)

733 
va_f‹m©
 
vaf
;

734 
va_li°
 
¨gs
;

736 i‡(!
	`pxt4_w¨nög_øãlimô
(
sb
))

739 
	`va_°¨t
(
¨gs
, 
fmt
);

740 
vaf
.
fmt
 = fmt;

741 
vaf
.
va
 = &
¨gs
;

742 
	`¥ötk
(
KERN_WARNING
 "PXT4-fs warning (device %s): %s:%d: %pV\n",

743 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, &
vaf
);

744 
	`va_íd
(
¨gs
);

745 
	}
}

747 
	$__pxt4_w¨nög_öode
(c⁄° 
öode
 *öode, c⁄° *
fun˘i⁄
,

748 
löe
, c⁄° *
fmt
, ...)

750 
va_f‹m©
 
vaf
;

751 
va_li°
 
¨gs
;

753 i‡(!
	`pxt4_w¨nög_øãlimô
(
öode
->
i_sb
))

756 
	`va_°¨t
(
¨gs
, 
fmt
);

757 
vaf
.
fmt
 = fmt;

758 
vaf
.
va
 = &
¨gs
;

759 
	`¥ötk
(
KERN_WARNING
 "PXT4-fs warning (device %s): %s:%d: "

760 "öodê#%lu: comm %s: %pV\n", 
öode
->
i_sb
->
s_id
,

761 
fun˘i⁄
, 
löe
, 
öode
->
i_öo
, 
cuºít
->
comm
, &
vaf
);

762 
	`va_íd
(
¨gs
);

763 
	}
}

765 
	$__pxt4_gΩ_locked_îr‹
(c⁄° *
fun˘i⁄
, 
löe
,

766 
su≥r_block
 *
sb
, 
pxt4_group_t
 
gΩ
,

767 
öo
, 
pxt4_fsblk_t
 
block
,

768 c⁄° *
fmt
, ...)

769 
	$__ªÀa£s
(
bôlock
)

770 
	$__acquúes
(
bôlock
)

772 
va_f‹m©
 
vaf
;

773 
va_li°
 
¨gs
;

774 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

776 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

779 
	`åa˚_pxt4_îr‹
(
sb
, 
fun˘i⁄
, 
löe
);

780 
es
->
s_œ°_îr‹_öo
 = 
	`˝u_to_À32
(
öo
);

781 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
block
);

782 
	`__ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

784 i‡(
	`pxt4_îr‹_øãlimô
(
sb
)) {

785 
	`va_°¨t
(
¨gs
, 
fmt
);

786 
vaf
.
fmt
 = fmt;

787 
vaf
.
va
 = &
¨gs
;

788 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: group %u, ",

789 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, 
gΩ
);

790 i‡(
öo
)

791 
	`¥ötk
(
KERN_CONT
 "öodê%lu: ", 
öo
);

792 i‡(
block
)

793 
	`¥ötk
(
KERN_CONT
 "block %llu:",

794 (Ë
block
);

795 
	`¥ötk
(
KERN_CONT
 "%pV\n", &
vaf
);

796 
	`va_íd
(
¨gs
);

799 i‡(
	`ã°_›t
(
sb
, 
WARN_ON_ERROR
))

800 
	`WARN_ON_ONCE
(1);

802 i‡(
	`ã°_›t
(
sb
, 
ERRORS_CONT
)) {

803 
	`pxt4_commô_su≥r
(
sb
, 0);

807 
	`pxt4_u∆ock_group
(
sb
, 
gΩ
);

808 
	`pxt4_commô_su≥r
(
sb
, 1);

809 
	`pxt4_h™dÀ_îr‹
(
sb
);

821 
	`pxt4_lock_group
(
sb
, 
gΩ
);

823 
	}
}

825 
	$pxt4_m¨k_group_bôm≠_c‹ru±ed
(
su≥r_block
 *
sb
,

826 
pxt4_group_t
 
group
,

827 
Êags
)

829 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

830 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

831 
pxt4_group_desc
 *
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

832 
ªt
;

834 i‡(
Êags
 & 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
) {

835 
ªt
 = 
	`pxt4_ã°_™d_£t_bô
(
PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
,

836 &
gΩ
->
bb_°©e
);

837 i‡(!
ªt
)

838 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

839 
gΩ
->
bb_‰ì
);

842 i‡(
Êags
 & 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
) {

843 
ªt
 = 
	`pxt4_ã°_™d_£t_bô
(
PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
,

844 &
gΩ
->
bb_°©e
);

845 i‡(!
ªt
 && 
gdp
) {

846 
cou¡
;

848 
cou¡
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
);

849 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_‰ìöodes_cou¡î
,

850 
cou¡
);

853 
	}
}

855 
	$pxt4_upd©e_dy«mic_ªv
(
su≥r_block
 *
sb
)

857 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

859 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë> 
PXT4_GOOD_OLD_REV
)

862 
	`pxt4_w¨nög
(
sb
,

865 
PXT4_DYNAMIC_REV
);

867 
es
->
s_fú°_öo
 = 
	`˝u_to_À32
(
PXT4_GOOD_OLD_FIRST_INO
);

868 
es
->
s_öode_size
 = 
	`˝u_to_À16
(
PXT4_GOOD_OLD_INODE_SIZE
);

869 
es
->
s_ªv_Àvñ
 = 
	`˝u_to_À32
(
PXT4_DYNAMIC_REV
);

878 
	}
}

883 
block_devi˚
 *
	$pxt4_blkdev_gë
(
dev_t
 
dev
, 
su≥r_block
 *
sb
)

885 
block_devi˚
 *
bdev
;

886 
b
[
BDEVNAME_SIZE
];

888 
bdev
 = 
	`blkdev_gë_by_dev
(
dev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
, 
sb
);

889 i‡(
	`IS_ERR
(
bdev
))

890 
Áû
;

891  
bdev
;

893 
Áû
:

894 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo open journal device %s: %ld",

895 
	`__bdev«me
(
dev
, 
b
), 
	`PTR_ERR
(
bdev
));

896  
NULL
;

897 
	}
}

902 
	$pxt4_blkdev_put
(
block_devi˚
 *
bdev
)

904 
	`blkdev_put
(
bdev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
);

905 
	}
}

907 
	$pxt4_blkdev_ªmove
(
pxt4_sb_öfo
 *
sbi
)

909 
block_devi˚
 *
bdev
;

910 
bdev
 = 
sbi
->
jou∫Æ_bdev
;

911 i‡(
bdev
) {

912 
	`pxt4_blkdev_put
(
bdev
);

913 
sbi
->
jou∫Æ_bdev
 = 
NULL
;

915 
	}
}

917 
ölöe
 
öode
 *
	$‹ph™_li°_íåy
(
li°_hód
 *
l
)

919  &
	`li°_íåy
(
l
, 
pxt4_öode_öfo
, 
i_‹ph™
)->
vfs_öode
;

920 
	}
}

922 
	$dump_‹ph™_li°
(
su≥r_block
 *
sb
, 
pxt4_sb_öfo
 *
sbi
)

924 
li°_hód
 *
l
;

926 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "sb orphan head is %d",

927 
	`À32_to_˝u
(
sbi
->
s_es
->
s_œ°_‹ph™
));

929 
	`¥ötk
(
KERN_ERR
 "sb_info orphanÜist:\n");

930 
	`li°_f‹_óch
(
l
, &
sbi
->
s_‹ph™
) {

931 
öode
 *öodê
	`‹ph™_li°_íåy
(
l
);

932 
	`¥ötk
(
KERN_ERR
 " "

934 
öode
->
i_sb
->
s_id
, inode->
i_öo
, inode,

935 
öode
->
i_mode
, inode->
i_∆ök
,

936 
	`NEXT_ORPHAN
(
öode
));

938 
	}
}

940 #ifde‡
CONFIG_QUOTA


941 
pxt4_quŸa_off
(
su≥r_block
 *
sb
, 
ty≥
);

943 
ölöe
 
	$pxt4_quŸa_off_umou¡
(
su≥r_block
 *
sb
)

945 
ty≥
;

948 
ty≥
 = 0;Åy≥ < 
PXT4_MAXQUOTAS
;Åype++)

949 
	`pxt4_quŸa_off
(
sb
, 
ty≥
);

950 
	}
}

956 
ölöe
 *
	$gë_qf_«me
(
su≥r_block
 *
sb
,

957 
pxt4_sb_öfo
 *
sbi
,

958 
ty≥
)

960  
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
sbi
->
s_qf_«mes
[
ty≥
],

961 
	`lockdï_is_hñd
(&
sb
->
s_umou¡
));

962 
	}
}

964 
ölöe
 
	$pxt4_quŸa_off_umou¡
(
su≥r_block
 *
sb
)

966 
	}
}

969 
	$pxt4_put_su≥r
(
su≥r_block
 *
sb
)

971 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

972 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

973 
ab‹ãd
 = 0;

974 
i
, 
îr
;

976 
	`pxt4_uƒegi°î_li_ªque°
(
sb
);

977 
	`pxt4_quŸa_off_umou¡
(
sb
);

979 
	`de°roy_w‹kqueue
(
sbi
->
rsv_c⁄vîsi⁄_wq
);

981 i‡(
sbi
->
s_jou∫Æ
) {

982 
ab‹ãd
 = 
	`is_jou∫Æ_ab‹ãd
(
sbi
->
s_jou∫Æ
);

983 
îr
 = 
	`jbd3_jou∫Æ_de°roy
(
sbi
->
s_jou∫Æ
);

984 
sbi
->
s_jou∫Æ
 = 
NULL
;

985 i‡((
îr
 < 0Ë&& !
ab‹ãd
)

986 
	`pxt4_ab‹t
(
sb
, "Couldn't clean upÅhe journal");

989 
	`pxt4_uƒegi°î_sysfs
(
sb
);

990 
	`pxt4_es_uƒegi°î_shrökî
(
sbi
);

991 
	`dñ_timî_sync
(&
sbi
->
s_îr_ªp‹t
);

992 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

993 
	`pxt4_mb_ªÀa£
(
sb
);

994 
	`pxt4_ext_ªÀa£
(
sb
);

996 i‡(!
	`sb_rd⁄ly
(
sb
Ë&& !
ab‹ãd
) {

997 
	`pxt4_˛ór_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

998 
es
->
s_°©e
 = 
	`˝u_to_À16
(
sbi
->
s_mou¡_°©e
);

1000 i‡(!
	`sb_rd⁄ly
(
sb
))

1001 
	`pxt4_commô_su≥r
(
sb
, 1);

1003 
i
 = 0; i < 
sbi
->
s_gdb_cou¡
; i++)

1004 
	`bªl£
(
sbi
->
s_group_desc
[
i
]);

1005 
	`kv‰ì
(
sbi
->
s_group_desc
);

1006 
	`kv‰ì
(
sbi
->
s_Êex_groups
);

1007 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ì˛u°îs_cou¡î
);

1008 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ìöodes_cou¡î
);

1009 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dús_cou¡î
);

1010 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

1011 
	`≥r˝u_‰ì_rw£m
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

1012 #ifde‡
CONFIG_QUOTA


1013 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

1014 
	`k‰ì
(
	`gë_qf_«me
(
sb
, 
sbi
, 
i
));

1021 i‡(!
	`li°_em±y
(&
sbi
->
s_‹ph™
))

1022 
	`dump_‹ph™_li°
(
sb
, 
sbi
);

1023 
	`J_ASSERT
(
	`li°_em±y
(&
sbi
->
s_‹ph™
));

1025 
	`sync_blockdev
(
sb
->
s_bdev
);

1026 
	`övÆid©e_bdev
(
sb
->
s_bdev
);

1027 i‡(
sbi
->
jou∫Æ_bdev
 && sbi->jou∫Æ_bdev !
sb
->
s_bdev
) {

1033 
	`sync_blockdev
(
sbi
->
jou∫Æ_bdev
);

1034 
	`övÆid©e_bdev
(
sbi
->
jou∫Æ_bdev
);

1035 
	`pxt4_blkdev_ªmove
(
sbi
);

1038 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_öode_ˇche
);

1039 
sbi
->
s_ó_öode_ˇche
 = 
NULL
;

1041 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_block_ˇche
);

1042 
sbi
->
s_ó_block_ˇche
 = 
NULL
;

1044 i‡(
sbi
->
s_mmp_tsk
)

1045 
	`kthªad_°›
(
sbi
->
s_mmp_tsk
);

1046 
	`bªl£
(
sbi
->
s_sbh
);

1047 
sb
->
s_fs_öfo
 = 
NULL
;

1052 
	`kobje˘_put
(&
sbi
->
s_kobj
);

1053 
	`waô_f‹_com∂ëi⁄
(&
sbi
->
s_kobj_uƒegi°î
);

1054 i‡(
sbi
->
s_chksum_drivî
)

1055 
	`¸y±o_‰ì_shash
(
sbi
->
s_chksum_drivî
);

1056 
	`k‰ì
(
sbi
->
s_blockgroup_lock
);

1057 
	`fs_put_dax
(
sbi
->
s_daxdev
);

1058 #ifde‡
CONFIG_UNICODE


1059 
	`utf8_u∆ﬂd
(
sbi
->
s_ícodög
);

1061 
	`k‰ì
(
sbi
);

1062 
	}
}

1064 
kmem_ˇche
 *
	gpxt4_öode_ˇchï
;

1069 
öode
 *
	$pxt4_Æloc_öode
(
su≥r_block
 *
sb
)

1071 
pxt4_öode_öfo
 *
ei
;

1073 
ei
 = 
	`kmem_ˇche_Æloc
(
pxt4_öode_ˇchï
, 
GFP_NOFS
);

1074 i‡(!
ei
)

1075  
NULL
;

1077 
	`öode_£t_ivîsi⁄
(&
ei
->
vfs_öode
, 1);

1078 
	`•ö_lock_öô
(&
ei
->
i_øw_lock
);

1079 
	`INIT_LIST_HEAD
(&
ei
->
i_¥óŒoc_li°
);

1080 
	`•ö_lock_öô
(&
ei
->
i_¥óŒoc_lock
);

1081 
	`pxt4_es_öô_åì
(&
ei
->
i_es_åì
);

1082 
	`rwlock_öô
(&
ei
->
i_es_lock
);

1083 
	`INIT_LIST_HEAD
(&
ei
->
i_es_li°
);

1084 
ei
->
i_es_Æl_ƒ
 = 0;

1085 
ei
->
i_es_shk_ƒ
 = 0;

1086 
ei
->
i_es_shrök_lblk
 = 0;

1087 
ei
->
i_ª£rved_d©a_blocks
 = 0;

1088 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 0;

1089 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
 = 0;

1090 
	`•ö_lock_öô
(&(
ei
->
i_block_ª£rv©i⁄_lock
));

1091 
	`pxt4_öô_≥ndög_åì
(&
ei
->
i_≥ndög_åì
);

1092 #ifde‡
CONFIG_QUOTA


1093 
ei
->
i_ª£rved_quŸa
 = 0;

1094 
	`mem£t
(&
ei
->
i_dquŸ
, 0, (ei->i_dquot));

1096 
ei
->
jöode
 = 
NULL
;

1097 
	`INIT_LIST_HEAD
(&
ei
->
i_rsv_c⁄vîsi⁄_li°
);

1098 
	`•ö_lock_öô
(&
ei
->
i_com∂ëed_io_lock
);

1099 
ei
->
i_sync_tid
 = 0;

1100 
ei
->
i_d©async_tid
 = 0;

1101 
	`©omic_£t
(&
ei
->
i_unwrôãn
, 0);

1102 
	`INIT_WORK
(&
ei
->
i_rsv_c⁄vîsi⁄_w‹k
, 
pxt4_íd_io_rsv_w‹k
);

1103  &
ei
->
vfs_öode
;

1104 
	}
}

1106 
	$pxt4_dr›_öode
(
öode
 *inode)

1108 
dr›
 = 
	`gíîic_dr›_öode
(
öode
);

1110 i‡(!
dr›
)

1111 
dr›
 = 
	`fs¸y±_dr›_öode
(
öode
);

1113 
	`åa˚_pxt4_dr›_öode
(
öode
, 
dr›
);

1114  
dr›
;

1115 
	}
}

1117 
	$pxt4_‰ì_ö_c‹e_öode
(
öode
 *inode)

1119 
	`fs¸y±_‰ì_öode
(
öode
);

1120 
	`kmem_ˇche_‰ì
(
pxt4_öode_ˇchï
, 
	`PXT4_I
(
öode
));

1121 
	}
}

1123 
	$pxt4_de°roy_öode
(
öode
 *inode)

1125 i‡(!
	`li°_em±y
(&(
	`PXT4_I
(
öode
)->
i_‹ph™
))) {

1126 
	`pxt4_msg
(
öode
->
i_sb
, 
KERN_ERR
,

1128 
öode
->
i_öo
, 
	`PXT4_I
(inode));

1129 
	`¥öt_hex_dump
(
KERN_INFO
, "", 
DUMP_PREFIX_ADDRESS
, 16, 4,

1130 
	`PXT4_I
(
öode
), (
pxt4_öode_öfo
),

1131 
åue
);

1132 
	`dump_°ack
();

1134 
	}
}

1136 
	$öô_⁄˚
(*
foo
)

1138 
pxt4_öode_öfo
 *
ei
 = (pxt4_öode_öfÿ*Ë
foo
;

1140 
	`INIT_LIST_HEAD
(&
ei
->
i_‹ph™
);

1141 
	`öô_rw£m
(&
ei
->
x©å_£m
);

1142 
	`öô_rw£m
(&
ei
->
i_d©a_£m
);

1143 
	`öô_rw£m
(&
ei
->
i_mm≠_£m
);

1144 
	`öode_öô_⁄˚
(&
ei
->
vfs_öode
);

1145 
	}
}

1147 
__öô
 
	$öô_öodeˇche
()

1149 
pxt4_öode_ˇchï
 = 
	`kmem_ˇche_¸óã_u£rc›y
("pxt4_inode_cache",

1150 (
pxt4_öode_öfo
), 0,

1151 (
SLAB_RECLAIM_ACCOUNT
|
SLAB_MEM_SPREAD
|

1152 
SLAB_ACCOUNT
),

1153 
	`off£tof
(
pxt4_öode_öfo
, 
i_d©a
),

1154 
	`sizeof_fõld
(
pxt4_öode_öfo
, 
i_d©a
),

1155 
öô_⁄˚
);

1156 i‡(
pxt4_öode_ˇchï
 =
NULL
)

1157  -
ENOMEM
;

1159 
	}
}

1161 
	$de°roy_öodeˇche
()

1167 
	`rcu_b¨rõr
();

1168 
	`kmem_ˇche_de°roy
(
pxt4_öode_ˇchï
);

1169 
	}
}

1171 
	$pxt4_˛ór_öode
(
öode
 *inode)

1173 
	`övÆid©e_öode_buf„rs
(
öode
);

1174 
	`˛ór_öode
(
öode
);

1175 
	`dquŸ_dr›
(
öode
);

1176 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

1177 
	`pxt4_es_ªmove_exã¡
(
öode
, 0, 
EXT_MAX_BLOCKS
);

1178 i‡(
	`PXT4_I
(
öode
)->
jöode
) {

1179 
	`jbd3_jou∫Æ_ªÀa£_jbd_öode
(
	`PXT4_JOURNAL
(
öode
),

1180 
	`PXT4_I
(
öode
)->
jöode
);

1181 
	`jbd3_‰ì_öode
(
	`PXT4_I
(
öode
)->
jöode
);

1182 
	`PXT4_I
(
öode
)->
jöode
 = 
NULL
;

1184 
	`fs¸y±_put_í¸y±i⁄_öfo
(
öode
);

1185 
	`fsvîôy_˛ónup_öode
(
öode
);

1186 
	}
}

1188 
öode
 *
	$pxt4_nfs_gë_öode
(
su≥r_block
 *
sb
,

1189 
u64
 
öo
, 
u32
 
gíî©i⁄
)

1191 
öode
 *inode;

1197 
öode
 = 
	`pxt4_igë
(
sb
, 
öo
, 
PXT4_IGET_HANDLE
);

1198 i‡(
	`IS_ERR
(
öode
))

1199  
	`ERR_CAST
(
öode
);

1200 i‡(
gíî©i⁄
 && 
öode
->
i_gíî©i⁄
 != generation) {

1201 
	`ùut
(
öode
);

1202  
	`ERR_PTR
(-
ESTALE
);

1205  
öode
;

1206 
	}
}

1208 
díåy
 *
	$pxt4_fh_to_díåy
(
su≥r_block
 *
sb
, 
fid
 *fid,

1209 
fh_Àn
, 
fh_ty≥
)

1211  
	`gíîic_fh_to_díåy
(
sb
, 
fid
, 
fh_Àn
, 
fh_ty≥
,

1212 
pxt4_nfs_gë_öode
);

1213 
	}
}

1215 
díåy
 *
	$pxt4_fh_to_∑ª¡
(
su≥r_block
 *
sb
, 
fid
 *fid,

1216 
fh_Àn
, 
fh_ty≥
)

1218  
	`gíîic_fh_to_∑ª¡
(
sb
, 
fid
, 
fh_Àn
, 
fh_ty≥
,

1219 
pxt4_nfs_gë_öode
);

1220 
	}
}

1222 
	$pxt4_nfs_commô_mëad©a
(
öode
 *inode)

1224 
wrôeback_c⁄åﬁ
 
wbc
 = {

1225 .
sync_mode
 = 
WB_SYNC_ALL


1228 
	`åa˚_pxt4_nfs_commô_mëad©a
(
öode
);

1229  
	`pxt4_wrôe_öode
(
öode
, &
wbc
);

1230 
	}
}

1238 
	$bdev_åy_to_‰ì_∑ge
(
su≥r_block
 *
sb
, 
∑ge
 *page,

1239 
gÂ_t
 
waô
)

1241 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

1243 
	`WARN_ON
(
	`PageChecked
(
∑ge
));

1244 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

1246 i‡(
jou∫Æ
)

1247  
	`jbd3_jou∫Æ_åy_to_‰ì_buf„rs
(
jou∫Æ
, 
∑ge
,

1248 
waô
 & ~
__GFP_DIRECT_RECLAIM
);

1249  
	`åy_to_‰ì_buf„rs
(
∑ge
);

1250 
	}
}

1252 #ifde‡
CONFIG_FS_ENCRYPTION


1253 
	$pxt4_gë_c⁄ãxt
(
öode
 *öode, *
˘x
, 
size_t
 
Àn
)

1255  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_ENCRYPTION
,

1256 
PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
, 
˘x
, 
Àn
);

1257 
	}
}

1259 
	$pxt4_£t_c⁄ãxt
(
öode
 *öode, c⁄° *
˘x
, 
size_t
 
Àn
,

1260 *
fs_d©a
)

1262 
h™dÀ_t
 *
h™dÀ
 = 
fs_d©a
;

1263 
ªs
, 
ªs2
, 
¸edôs
, 
ªåõs
 = 0;

1271 i‡(
öode
->
i_öo
 =
PXT4_ROOT_INO
)

1272  -
EPERM
;

1274 i‡(
	`WARN_ON_ONCE
(
	`IS_DAX
(
öode
Ë&& 
	`i_size_ªad
(inode)))

1275  -
EINVAL
;

1277 
ªs
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

1278 i‡(
ªs
)

1279  
ªs
;

1289 i‡(
h™dÀ
) {

1290 
ªs
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
,

1291 
PXT4_XATTR_INDEX_ENCRYPTION
,

1292 
PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
,

1293 
˘x
, 
Àn
, 0);

1294 i‡(!
ªs
) {

1295 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_ENCRYPT
);

1296 
	`pxt4_˛ór_öode_°©e
(
öode
,

1297 
PXT4_STATE_MAY_INLINE_DATA
);

1302 
	`pxt4_£t_öode_Êags
(
öode
);

1304  
ªs
;

1307 
ªs
 = 
	`dquŸ_öôülize
(
öode
);

1308 i‡(
ªs
)

1309  
ªs
;

1310 
ªåy
:

1311 
ªs
 = 
	`pxt4_x©å_£t_¸edôs
(
öode
, 
Àn
, 
Ál£
 ,

1312 &
¸edôs
);

1313 i‡(
ªs
)

1314  
ªs
;

1316 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MISC
, 
¸edôs
);

1317 i‡(
	`IS_ERR
(
h™dÀ
))

1318  
	`PTR_ERR
(
h™dÀ
);

1320 
ªs
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
, 
PXT4_XATTR_INDEX_ENCRYPTION
,

1321 
PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
,

1322 
˘x
, 
Àn
, 0);

1323 i‡(!
ªs
) {

1324 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_ENCRYPT
);

1329 
	`pxt4_£t_öode_Êags
(
öode
);

1330 
ªs
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1331 i‡(
ªs
)

1332 
	`PXT4_ERROR_INODE
(
öode
, "FailedÅo mark inode dirty");

1334 
ªs2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1336 i‡(
ªs
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

1337 
ªåy
;

1338 i‡(!
ªs
)

1339 
ªs
 = 
ªs2
;

1340  
ªs
;

1341 
	}
}

1343 
boﬁ
 
	$pxt4_dummy_c⁄ãxt
(
öode
 *inode)

1345  
	`DUMMY_ENCRYPTION_ENABLED
(
	`PXT4_SB
(
öode
->
i_sb
));

1346 
	}
}

1348 c⁄° 
fs¸y±_›î©i⁄s
 
	gpxt4_¸y±›s
 = {

1349 .
key_¥efix
 = "pxt4:",

1350 .
	ggë_c⁄ãxt
 = 
pxt4_gë_c⁄ãxt
,

1351 .
	g£t_c⁄ãxt
 = 
pxt4_£t_c⁄ãxt
,

1352 .
	gdummy_c⁄ãxt
 = 
pxt4_dummy_c⁄ãxt
,

1353 .
	gem±y_dú
 = 
pxt4_em±y_dú
,

1354 .
	gmax_«mñí
 = 
PXT4_NAME_LEN
,

1358 #ifde‡
CONFIG_QUOTA


1359 c⁄° * c⁄° 
	gquŸ©y≥s
[] = 
INITQFNAMES
;

1360 
	#QTYPE2NAME
(
t
Ë(
quŸ©y≥s
[t])

	)

1362 
pxt4_wrôe_dquŸ
(
dquŸ
 *dquot);

1363 
pxt4_acquúe_dquŸ
(
dquŸ
 *dquot);

1364 
pxt4_ªÀa£_dquŸ
(
dquŸ
 *dquot);

1365 
pxt4_m¨k_dquŸ_dúty
(
dquŸ
 *dquot);

1366 
pxt4_wrôe_öfo
(
su≥r_block
 *
sb
, 
ty≥
);

1367 
pxt4_quŸa_⁄
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

1368 c⁄° 
∑th
 *path);

1369 
pxt4_quŸa_⁄_mou¡
(
su≥r_block
 *
sb
, 
ty≥
);

1370 
ssize_t
 
pxt4_quŸa_ªad
(
su≥r_block
 *
sb
, 
ty≥
, *
d©a
,

1371 
size_t
 
Àn
, 
loff_t
 
off
);

1372 
ssize_t
 
pxt4_quŸa_wrôe
(
su≥r_block
 *
sb
, 
ty≥
,

1373 c⁄° *
d©a
, 
size_t
 
Àn
, 
loff_t
 
off
);

1374 
pxt4_quŸa_íabÀ
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

1375 
Êags
);

1376 
pxt4_íabÀ_quŸas
(
su≥r_block
 *
sb
);

1377 
pxt4_gë_√xt_id
(
su≥r_block
 *
sb
, 
kqid
 *
qid
);

1379 
dquŸ
 **
	$pxt4_gë_dquŸs
(
öode
 *inode)

1381  
	`PXT4_I
(
öode
)->
i_dquŸ
;

1382 
	}
}

1384 c⁄° 
dquŸ_›î©i⁄s
 
	gpxt4_quŸa_›î©i⁄s
 = {

1385 .
gë_ª£rved_•a˚
 = 
pxt4_gë_ª£rved_•a˚
,

1386 .
	gwrôe_dquŸ
 = 
pxt4_wrôe_dquŸ
,

1387 .
	gacquúe_dquŸ
 = 
pxt4_acquúe_dquŸ
,

1388 .
	gªÀa£_dquŸ
 = 
pxt4_ªÀa£_dquŸ
,

1389 .
	gm¨k_dúty
 = 
pxt4_m¨k_dquŸ_dúty
,

1390 .
	gwrôe_öfo
 = 
pxt4_wrôe_öfo
,

1391 .
	gÆloc_dquŸ
 = 
dquŸ_Æloc
,

1392 .
	gde°roy_dquŸ
 = 
dquŸ_de°roy
,

1393 .
	ggë_¥ojid
 = 
pxt4_gë_¥ojid
,

1394 .
	ggë_öode_ußge
 = 
pxt4_gë_öode_ußge
,

1395 .
	ggë_√xt_id
 = 
pxt4_gë_√xt_id
,

1398 c⁄° 
quŸa˘l_›s
 
	gpxt4_q˘l_›î©i⁄s
 = {

1399 .
quŸa_⁄
 = 
pxt4_quŸa_⁄
,

1400 .
	gquŸa_off
 = 
pxt4_quŸa_off
,

1401 .
	gquŸa_sync
 = 
dquŸ_quŸa_sync
,

1402 .
	ggë_°©e
 = 
dquŸ_gë_°©e
,

1403 .
	g£t_öfo
 = 
dquŸ_£t_dqöfo
,

1404 .
	ggë_dqblk
 = 
dquŸ_gë_dqblk
,

1405 .
	g£t_dqblk
 = 
dquŸ_£t_dqblk
,

1406 .
	ggë_√xtdqblk
 = 
dquŸ_gë_√xt_dqblk
,

1410 c⁄° 
su≥r_›î©i⁄s
 
	gpxt4_s›s
 = {

1411 .
Æloc_öode
 = 
pxt4_Æloc_öode
,

1412 .
	g‰ì_öode
 = 
pxt4_‰ì_ö_c‹e_öode
,

1413 .
	gde°roy_öode
 = 
pxt4_de°roy_öode
,

1414 .
	gwrôe_öode
 = 
pxt4_wrôe_öode
,

1415 .
	gdúty_öode
 = 
pxt4_dúty_öode
,

1416 .
	gdr›_öode
 = 
pxt4_dr›_öode
,

1417 .
	gevi˘_öode
 = 
pxt4_evi˘_öode
,

1418 .
	gput_su≥r
 = 
pxt4_put_su≥r
,

1419 .
	gsync_fs
 = 
pxt4_sync_fs
,

1420 .
	g‰ìze_fs
 = 
pxt4_‰ìze
,

1421 .
	gun‰ìze_fs
 = 
pxt4_un‰ìze
,

1422 .
	g°©fs
 = 
pxt4_°©fs
,

1423 .
	gªmou¡_fs
 = 
pxt4_ªmou¡
,

1424 .
	gshow_›ti⁄s
 = 
pxt4_show_›ti⁄s
,

1425 #ifde‡
CONFIG_QUOTA


1426 .
	gquŸa_ªad
 = 
pxt4_quŸa_ªad
,

1427 .
	gquŸa_wrôe
 = 
pxt4_quŸa_wrôe
,

1428 .
	ggë_dquŸs
 = 
pxt4_gë_dquŸs
,

1430 .
	gbdev_åy_to_‰ì_∑ge
 = 
bdev_åy_to_‰ì_∑ge
,

1433 c⁄° 
exp‹t_›î©i⁄s
 
	gpxt4_exp‹t_›s
 = {

1434 .
fh_to_díåy
 = 
pxt4_fh_to_díåy
,

1435 .
	gfh_to_∑ª¡
 = 
pxt4_fh_to_∑ª¡
,

1436 .
	ggë_∑ª¡
 = 
pxt4_gë_∑ª¡
,

1437 .
	gcommô_mëad©a
 = 
pxt4_nfs_commô_mëad©a
,

1441 
	mO±_bsd_df
, 
	mO±_möix_df
, 
	mO±_gΩid
, 
	mO±_nogΩid
,

1442 
	mO±_ªsgid
, 
	mO±_ªsuid
, 
	mO±_sb
, 
	mO±_îr_c⁄t
, 
	mO±_îr_∑nic
, 
	mO±_îr_ro
,

1443 
	mO±_nouid32
, 
	mO±_debug
, 
	mO±_ªmoved
,

1444 
	mO±_u£r_x©å
, 
	mO±_nou£r_x©å
, 
	mO±_a˛
, 
	mO±_nﬂ˛
,

1445 
	mO±_auto_da_Æloc
, 
	mO±_nﬂuto_da_Æloc
, 
	mO±_nﬁﬂd
,

1446 
	mO±_commô
, 
	mO±_mö_b©ch_time
, 
	mO±_max_b©ch_time
, 
	mO±_jou∫Æ_dev
,

1447 
	mO±_jou∫Æ_∑th
, 
	mO±_jou∫Æ_checksum
, 
	mO±_jou∫Æ_async_commô
,

1448 
	mO±_ab‹t
, 
	mO±_d©a_jou∫Æ
, 
	mO±_d©a_‹dîed
, 
	mO±_d©a_wrôeback
,

1449 
	mO±_d©a_îr_ab‹t
, 
	mO±_d©a_îr_ign‹e
, 
	mO±_ã°_dummy_í¸y±i⁄
,

1450 
	mO±_u§jquŸa
, 
	mO±_gΩjquŸa
, 
	mO±_offu§jquŸa
, 
	mO±_offgΩjquŸa
,

1451 
	mO±_jqfmt_vfsﬁd
, 
	mO±_jqfmt_vfsv0
, 
	mO±_jqfmt_vfsv1
, 
	mO±_quŸa
,

1452 
	mO±_noquŸa
, 
	mO±_b¨rõr
, 
	mO±_nob¨rõr
, 
	mO±_îr
,

1453 
	mO±_u§quŸa
, 
	mO±_gΩquŸa
, 
	mO±_¥jquŸa
, 
	mO±_i_vîsi⁄
, 
	mO±_dax
,

1454 
	mO±_°rùe
, 
	mO±_dñÆloc
, 
	mO±_nodñÆloc
, 
	mO±_w¨n_⁄_îr‹
,

1455 
	mO±_now¨n_⁄_îr‹
, 
	mO±_mblk_io_submô
,

1456 
	mO±_œzytime
, 
	mO±_nﬁazytime
, 
	mO±_debug_w™t_exåa_isize
,

1457 
	mO±_nomblk_io_submô
, 
	mO±_block_vÆidôy
, 
	mO±_noblock_vÆidôy
,

1458 
	mO±_öode_ªadahód_blks
, 
	mO±_jou∫Æ_i›rio
,

1459 
	mO±_di‹ód_nﬁock
, 
	mO±_di‹ód_lock
,

1460 
	mO±_disˇrd
, 
	mO±_nodisˇrd
, 
	mO±_öô_ôabÀ
, 
	mO±_noöô_ôabÀ
,

1461 
	mO±_max_dú_size_kb
, 
	mO±_nojou∫Æ_checksum
, 
	mO±_nombˇche
,

1464 c⁄° 
m©ch_èbÀ_t
 
	gtokís
 = {

1465 {
O±_bsd_df
, "bsddf"},

1466 {
O±_möix_df
, "minixdf"},

1467 {
O±_gΩid
, "grpid"},

1468 {
O±_gΩid
, "bsdgroups"},

1469 {
O±_nogΩid
, "nogrpid"},

1470 {
O±_nogΩid
, "sysvgroups"},

1471 {
O±_ªsgid
, "resgid=%u"},

1472 {
O±_ªsuid
, "resuid=%u"},

1473 {
O±_sb
, "sb=%u"},

1474 {
O±_îr_c⁄t
, "errors=continue"},

1475 {
O±_îr_∑nic
, "errors=panic"},

1476 {
O±_îr_ro
, "errors=remount-ro"},

1477 {
O±_nouid32
, "nouid32"},

1478 {
O±_debug
, "debug"},

1479 {
O±_ªmoved
, "oldalloc"},

1480 {
O±_ªmoved
, "orlov"},

1481 {
O±_u£r_x©å
, "user_xattr"},

1482 {
O±_nou£r_x©å
, "nouser_xattr"},

1483 {
O±_a˛
, "acl"},

1484 {
O±_nﬂ˛
, "noacl"},

1485 {
O±_nﬁﬂd
, "norecovery"},

1486 {
O±_nﬁﬂd
, "noload"},

1487 {
O±_ªmoved
, "nobh"},

1488 {
O±_ªmoved
, "bh"},

1489 {
O±_commô
, "commit=%u"},

1490 {
O±_mö_b©ch_time
, "min_batch_time=%u"},

1491 {
O±_max_b©ch_time
, "max_batch_time=%u"},

1492 {
O±_jou∫Æ_dev
, "journal_dev=%u"},

1493 {
O±_jou∫Æ_∑th
, "journal_path=%s"},

1494 {
O±_jou∫Æ_checksum
, "journal_checksum"},

1495 {
O±_nojou∫Æ_checksum
, "nojournal_checksum"},

1496 {
O±_jou∫Æ_async_commô
, "journal_async_commit"},

1497 {
O±_ab‹t
, "abort"},

1498 {
O±_d©a_jou∫Æ
, "data=journal"},

1499 {
O±_d©a_‹dîed
, "data=ordered"},

1500 {
O±_d©a_wrôeback
, "data=writeback"},

1501 {
O±_d©a_îr_ab‹t
, "data_err=abort"},

1502 {
O±_d©a_îr_ign‹e
, "data_err=ignore"},

1503 {
O±_offu§jquŸa
, "usrjquota="},

1504 {
O±_u§jquŸa
, "usrjquota=%s"},

1505 {
O±_offgΩjquŸa
, "grpjquota="},

1506 {
O±_gΩjquŸa
, "grpjquota=%s"},

1507 {
O±_jqfmt_vfsﬁd
, "jqfmt=vfsold"},

1508 {
O±_jqfmt_vfsv0
, "jqfmt=vfsv0"},

1509 {
O±_jqfmt_vfsv1
, "jqfmt=vfsv1"},

1510 {
O±_gΩquŸa
, "grpquota"},

1511 {
O±_noquŸa
, "noquota"},

1512 {
O±_quŸa
, "quota"},

1513 {
O±_u§quŸa
, "usrquota"},

1514 {
O±_¥jquŸa
, "prjquota"},

1515 {
O±_b¨rõr
, "barrier=%u"},

1516 {
O±_b¨rõr
, "barrier"},

1517 {
O±_nob¨rõr
, "nobarrier"},

1518 {
O±_i_vîsi⁄
, "i_version"},

1519 {
O±_dax
, "dax"},

1520 {
O±_°rùe
, "stripe=%u"},

1521 {
O±_dñÆloc
, "delalloc"},

1522 {
O±_w¨n_⁄_îr‹
, "warn_on_error"},

1523 {
O±_now¨n_⁄_îr‹
, "nowarn_on_error"},

1524 {
O±_œzytime
, "lazytime"},

1525 {
O±_nﬁazytime
, "nolazytime"},

1526 {
O±_debug_w™t_exåa_isize
, "debug_want_extra_isize=%u"},

1527 {
O±_nodñÆloc
, "nodelalloc"},

1528 {
O±_ªmoved
, "mblk_io_submit"},

1529 {
O±_ªmoved
, "nomblk_io_submit"},

1530 {
O±_block_vÆidôy
, "block_validity"},

1531 {
O±_noblock_vÆidôy
, "noblock_validity"},

1532 {
O±_öode_ªadahód_blks
, "inode_readahead_blks=%u"},

1533 {
O±_jou∫Æ_i›rio
, "journal_ioprio=%u"},

1534 {
O±_auto_da_Æloc
, "auto_da_alloc=%u"},

1535 {
O±_auto_da_Æloc
, "auto_da_alloc"},

1536 {
O±_nﬂuto_da_Æloc
, "noauto_da_alloc"},

1537 {
O±_di‹ód_nﬁock
, "dioread_nolock"},

1538 {
O±_di‹ód_lock
, "dioread_lock"},

1539 {
O±_disˇrd
, "discard"},

1540 {
O±_nodisˇrd
, "nodiscard"},

1541 {
O±_öô_ôabÀ
, "init_itable=%u"},

1542 {
O±_öô_ôabÀ
, "init_itable"},

1543 {
O±_noöô_ôabÀ
, "noinit_itable"},

1544 {
O±_max_dú_size_kb
, "max_dir_size_kb=%u"},

1545 {
O±_ã°_dummy_í¸y±i⁄
, "test_dummy_encryption"},

1546 {
O±_nombˇche
, "nombcache"},

1547 {
O±_nombˇche
, "no_mbcache"},

1548 {
O±_ªmoved
, "check=none"},

1549 {
O±_ªmoved
, "nocheck"},

1550 {
O±_ªmoved
, "reservation"},

1551 {
O±_ªmoved
, "noreservation"},

1552 {
O±_ªmoved
, "journal=%u"},

1553 {
O±_îr
, 
NULL
},

1556 
pxt4_fsblk_t
 
	$gë_sb_block
(**
d©a
)

1558 
pxt4_fsblk_t
 
sb_block
;

1559 *
›ti⁄s
 = (*Ë*
d©a
;

1561 i‡(!
›ti⁄s
 || 
	`°∫cmp
(options, "sb=", 3) != 0)

1564 
›ti⁄s
 += 3;

1566 
sb_block
 = 
	`sim∂e_°πoul
(
›ti⁄s
, &options, 0);

1567 i‡(*
›ti⁄s
 && *options != ',') {

1568 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: Invalid sb specification: %s\n",

1569 (*Ë*
d©a
);

1572 i‡(*
›ti⁄s
 == ',')

1573 
›ti⁄s
++;

1574 *
d©a
 = (*Ë
›ti⁄s
;

1576  
sb_block
;

1577 
	}
}

1579 
	#DEFAULT_JOURNAL_IOPRIO
 (
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 3))

	)

1580 c⁄° 
	gdïªˇãd_msg
[] =

1584 #ifde‡
CONFIG_QUOTA


1585 
	$£t_qf_«me
(
su≥r_block
 *
sb
, 
qty≥
, 
sub°rög_t
 *
¨gs
)

1587 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1588 *
q«me
, *
ﬁd_q«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
qty≥
);

1589 
ªt
 = -1;

1591 i‡(
	`sb_™y_quŸa_lﬂded
(
sb
Ë&& !
ﬁd_q«me
) {

1592 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1597 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
)) {

1598 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Journaled quota options "

1602 
q«me
 = 
	`m©ch_°rdup
(
¨gs
);

1603 i‡(!
q«me
) {

1604 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1608 i‡(
ﬁd_q«me
) {

1609 i‡(
	`°rcmp
(
ﬁd_q«me
, 
q«me
) == 0)

1610 
ªt
 = 1;

1612 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1614 
	`QTYPE2NAME
(
qty≥
));

1615 
îrout
;

1617 i‡(
	`°rchr
(
q«me
, '/')) {

1618 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1620 
îrout
;

1622 
	`rcu_assign_poöãr
(
sbi
->
s_qf_«mes
[
qty≥
], 
q«me
);

1623 
	`£t_›t
(
sb
, 
QUOTA
);

1625 
îrout
:

1626 
	`k‰ì
(
q«me
);

1627  
ªt
;

1628 
	}
}

1630 
	$˛ór_qf_«me
(
su≥r_block
 *
sb
, 
qty≥
)

1633 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1634 *
ﬁd_q«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
qty≥
);

1636 i‡(
	`sb_™y_quŸa_lﬂded
(
sb
Ë&& 
ﬁd_q«me
) {

1637 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot change journaled quota options"

1641 
	`rcu_assign_poöãr
(
sbi
->
s_qf_«mes
[
qty≥
], 
NULL
);

1642 
	`synchr⁄ize_rcu
();

1643 
	`k‰ì
(
ﬁd_q«me
);

1645 
	}
}

1648 
	#MOPT_SET
 0x0001

	)

1649 
	#MOPT_CLEAR
 0x0002

	)

1650 
	#MOPT_NOSUPPORT
 0x0004

	)

1651 
	#MOPT_EXPLICIT
 0x0008

	)

1652 
	#MOPT_CLEAR_ERR
 0x0010

	)

1653 
	#MOPT_GTE0
 0x0020

	)

1654 #ifde‡
CONFIG_QUOTA


1655 
	#MOPT_Q
 0

	)

1656 
	#MOPT_QFMT
 0x0040

	)

1658 
	#MOPT_Q
 
MOPT_NOSUPPORT


	)

1659 
	#MOPT_QFMT
 
MOPT_NOSUPPORT


	)

1661 
	#MOPT_DATAJ
 0x0080

	)

1662 
	#MOPT_NO_PXT2
 0x0100

	)

1663 
	#MOPT_NO_EXT3
 0x0200

	)

1664 
	#MOPT_PXT4_ONLY
 (
MOPT_NO_PXT2
 | 
MOPT_NO_EXT3
)

	)

1665 
	#MOPT_STRING
 0x0400

	)

1667 c⁄° 
	smou¡_›ts
 {

1668 
	mtokí
;

1669 
	mmou¡_›t
;

1670 
	mÊags
;

1671 } 
	gpxt4_mou¡_›ts
[] = {

1672 {
O±_möix_df
, 
PXT4_MOUNT_MINIX_DF
, 
MOPT_SET
},

1673 {
O±_bsd_df
, 
PXT4_MOUNT_MINIX_DF
, 
MOPT_CLEAR
},

1674 {
O±_gΩid
, 
PXT4_MOUNT_GRPID
, 
MOPT_SET
},

1675 {
O±_nogΩid
, 
PXT4_MOUNT_GRPID
, 
MOPT_CLEAR
},

1676 {
O±_block_vÆidôy
, 
PXT4_MOUNT_BLOCK_VALIDITY
, 
MOPT_SET
},

1677 {
O±_noblock_vÆidôy
, 
PXT4_MOUNT_BLOCK_VALIDITY
, 
MOPT_CLEAR
},

1678 {
O±_di‹ód_nﬁock
, 
PXT4_MOUNT_DIOREAD_NOLOCK
,

1679 
MOPT_PXT4_ONLY
 | 
MOPT_SET
},

1680 {
O±_di‹ód_lock
, 
PXT4_MOUNT_DIOREAD_NOLOCK
,

1681 
MOPT_PXT4_ONLY
 | 
MOPT_CLEAR
},

1682 {
O±_disˇrd
, 
PXT4_MOUNT_DISCARD
, 
MOPT_SET
},

1683 {
O±_nodisˇrd
, 
PXT4_MOUNT_DISCARD
, 
MOPT_CLEAR
},

1684 {
O±_dñÆloc
, 
PXT4_MOUNT_DELALLOC
,

1685 
MOPT_PXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1686 {
O±_nodñÆloc
, 
PXT4_MOUNT_DELALLOC
,

1687 
MOPT_PXT4_ONLY
 | 
MOPT_CLEAR
},

1688 {
O±_w¨n_⁄_îr‹
, 
PXT4_MOUNT_WARN_ON_ERROR
, 
MOPT_SET
},

1689 {
O±_now¨n_⁄_îr‹
, 
PXT4_MOUNT_WARN_ON_ERROR
, 
MOPT_CLEAR
},

1690 {
O±_nojou∫Æ_checksum
, 
PXT4_MOUNT_JOURNAL_CHECKSUM
,

1691 
MOPT_PXT4_ONLY
 | 
MOPT_CLEAR
},

1692 {
O±_jou∫Æ_checksum
, 
PXT4_MOUNT_JOURNAL_CHECKSUM
,

1693 
MOPT_PXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1694 {
O±_jou∫Æ_async_commô
, (
PXT4_MOUNT_JOURNAL_ASYNC_COMMIT
 |

1695 
PXT4_MOUNT_JOURNAL_CHECKSUM
),

1696 
MOPT_PXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1697 {
O±_nﬁﬂd
, 
PXT4_MOUNT_NOLOAD
, 
MOPT_NO_PXT2
 | 
MOPT_SET
},

1698 {
O±_îr_∑nic
, 
PXT4_MOUNT_ERRORS_PANIC
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1699 {
O±_îr_ro
, 
PXT4_MOUNT_ERRORS_RO
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1700 {
O±_îr_c⁄t
, 
PXT4_MOUNT_ERRORS_CONT
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1701 {
O±_d©a_îr_ab‹t
, 
PXT4_MOUNT_DATA_ERR_ABORT
,

1702 
MOPT_NO_PXT2
},

1703 {
O±_d©a_îr_ign‹e
, 
PXT4_MOUNT_DATA_ERR_ABORT
,

1704 
MOPT_NO_PXT2
},

1705 {
O±_b¨rõr
, 
PXT4_MOUNT_BARRIER
, 
MOPT_SET
},

1706 {
O±_nob¨rõr
, 
PXT4_MOUNT_BARRIER
, 
MOPT_CLEAR
},

1707 {
O±_nﬂuto_da_Æloc
, 
PXT4_MOUNT_NO_AUTO_DA_ALLOC
, 
MOPT_SET
},

1708 {
O±_auto_da_Æloc
, 
PXT4_MOUNT_NO_AUTO_DA_ALLOC
, 
MOPT_CLEAR
},

1709 {
O±_noöô_ôabÀ
, 
PXT4_MOUNT_INIT_INODE_TABLE
, 
MOPT_CLEAR
},

1710 {
O±_commô
, 0, 
MOPT_GTE0
},

1711 {
O±_max_b©ch_time
, 0, 
MOPT_GTE0
},

1712 {
O±_mö_b©ch_time
, 0, 
MOPT_GTE0
},

1713 {
O±_öode_ªadahód_blks
, 0, 
MOPT_GTE0
},

1714 {
O±_öô_ôabÀ
, 0, 
MOPT_GTE0
},

1715 {
O±_dax
, 
PXT4_MOUNT_DAX
, 
MOPT_SET
},

1716 {
O±_°rùe
, 0, 
MOPT_GTE0
},

1717 {
O±_ªsuid
, 0, 
MOPT_GTE0
},

1718 {
O±_ªsgid
, 0, 
MOPT_GTE0
},

1719 {
O±_jou∫Æ_dev
, 0, 
MOPT_NO_PXT2
 | 
MOPT_GTE0
},

1720 {
O±_jou∫Æ_∑th
, 0, 
MOPT_NO_PXT2
 | 
MOPT_STRING
},

1721 {
O±_jou∫Æ_i›rio
, 0, 
MOPT_NO_PXT2
 | 
MOPT_GTE0
},

1722 {
O±_d©a_jou∫Æ
, 
PXT4_MOUNT_JOURNAL_DATA
, 
MOPT_NO_PXT2
 | 
MOPT_DATAJ
},

1723 {
O±_d©a_‹dîed
, 
PXT4_MOUNT_ORDERED_DATA
, 
MOPT_NO_PXT2
 | 
MOPT_DATAJ
},

1724 {
O±_d©a_wrôeback
, 
PXT4_MOUNT_WRITEBACK_DATA
,

1725 
MOPT_NO_PXT2
 | 
MOPT_DATAJ
},

1726 {
O±_u£r_x©å
, 
PXT4_MOUNT_XATTR_USER
, 
MOPT_SET
},

1727 {
O±_nou£r_x©å
, 
PXT4_MOUNT_XATTR_USER
, 
MOPT_CLEAR
},

1728 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


1729 {
O±_a˛
, 
PXT4_MOUNT_POSIX_ACL
, 
MOPT_SET
},

1730 {
O±_nﬂ˛
, 
PXT4_MOUNT_POSIX_ACL
, 
MOPT_CLEAR
},

1732 {
O±_a˛
, 0, 
MOPT_NOSUPPORT
},

1733 {
O±_nﬂ˛
, 0, 
MOPT_NOSUPPORT
},

1735 {
O±_nouid32
, 
PXT4_MOUNT_NO_UID32
, 
MOPT_SET
},

1736 {
O±_debug
, 
PXT4_MOUNT_DEBUG
, 
MOPT_SET
},

1737 {
O±_debug_w™t_exåa_isize
, 0, 
MOPT_GTE0
},

1738 {
O±_quŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_USRQUOTA
, 
MOPT_SET
 | 
MOPT_Q
},

1739 {
O±_u§quŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_USRQUOTA
,

1740 
MOPT_SET
 | 
MOPT_Q
},

1741 {
O±_gΩquŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_GRPQUOTA
,

1742 
MOPT_SET
 | 
MOPT_Q
},

1743 {
O±_¥jquŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_PRJQUOTA
,

1744 
MOPT_SET
 | 
MOPT_Q
},

1745 {
O±_noquŸa
, (
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_USRQUOTA
 |

1746 
PXT4_MOUNT_GRPQUOTA
 | 
PXT4_MOUNT_PRJQUOTA
),

1747 
MOPT_CLEAR
 | 
MOPT_Q
},

1748 {
O±_u§jquŸa
, 0, 
MOPT_Q
},

1749 {
O±_gΩjquŸa
, 0, 
MOPT_Q
},

1750 {
O±_offu§jquŸa
, 0, 
MOPT_Q
},

1751 {
O±_offgΩjquŸa
, 0, 
MOPT_Q
},

1752 {
O±_jqfmt_vfsﬁd
, 
QFMT_VFS_OLD
, 
MOPT_QFMT
},

1753 {
O±_jqfmt_vfsv0
, 
QFMT_VFS_V0
, 
MOPT_QFMT
},

1754 {
O±_jqfmt_vfsv1
, 
QFMT_VFS_V1
, 
MOPT_QFMT
},

1755 {
O±_max_dú_size_kb
, 0, 
MOPT_GTE0
},

1756 {
O±_ã°_dummy_í¸y±i⁄
, 0, 
MOPT_GTE0
},

1757 {
O±_nombˇche
, 
PXT4_MOUNT_NO_MBCACHE
, 
MOPT_SET
},

1758 {
O±_îr
, 0, 0}

1761 #ifde‡
CONFIG_UNICODE


1762 c⁄° 
	spxt4_sb_ícodögs
 {

1763 
__u16
 
	mmagic
;

1764 *
	m«me
;

1765 *
	mvîsi⁄
;

1766 } 
	gpxt4_sb_ícodög_m≠
[] = {

1767 {
PXT4_ENC_UTF8_12_1
, "utf8", "12.1.0"},

1770 
	$pxt4_sb_ªad_ícodög
(c⁄° 
pxt4_su≥r_block
 *
es
,

1771 c⁄° 
pxt4_sb_ícodögs
 **
ícodög
,

1772 
__u16
 *
Êags
)

1774 
__u16
 
magic
 = 
	`À16_to_˝u
(
es
->
s_ícodög
);

1775 
i
;

1777 
i
 = 0; i < 
	`ARRAY_SIZE
(
pxt4_sb_ícodög_m≠
); i++)

1778 i‡(
magic
 =
pxt4_sb_ícodög_m≠
[
i
].magic)

1781 i‡(
i
 >
	`ARRAY_SIZE
(
pxt4_sb_ícodög_m≠
))

1782  -
EINVAL
;

1784 *
ícodög
 = &
pxt4_sb_ícodög_m≠
[
i
];

1785 *
Êags
 = 
	`À16_to_˝u
(
es
->
s_ícodög_Êags
);

1788 
	}
}

1791 
	$h™dÀ_mou¡_›t
(
su≥r_block
 *
sb
, *
›t
, 
tokí
,

1792 
sub°rög_t
 *
¨gs
, *
jou∫Æ_devnum
,

1793 *
jou∫Æ_i›rio
, 
is_ªmou¡
)

1795 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1796 c⁄° 
mou¡_›ts
 *
m
;

1797 
kuid_t
 
uid
;

1798 
kgid_t
 
gid
;

1799 
¨g
 = 0;

1801 #ifde‡
CONFIG_QUOTA


1802 i‡(
tokí
 =
O±_u§jquŸa
)

1803  
	`£t_qf_«me
(
sb
, 
USRQUOTA
, &
¨gs
[0]);

1804 i‡(
tokí
 =
O±_gΩjquŸa
)

1805  
	`£t_qf_«me
(
sb
, 
GRPQUOTA
, &
¨gs
[0]);

1806 i‡(
tokí
 =
O±_offu§jquŸa
)

1807  
	`˛ór_qf_«me
(
sb
, 
USRQUOTA
);

1808 i‡(
tokí
 =
O±_offgΩjquŸa
)

1809  
	`˛ór_qf_«me
(
sb
, 
GRPQUOTA
);

1811 
tokí
) {

1812 
O±_nﬂ˛
:

1813 
O±_nou£r_x©å
:

1814 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, 
dïªˇãd_msg
, 
›t
, "3.5");

1816 
O±_sb
:

1818 
O±_ªmoved
:

1819 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Ign‹ögÑemoved %†›ti⁄", 
›t
);

1821 
O±_ab‹t
:

1822 
sbi
->
s_mou¡_Êags
 |
PXT4_MF_FS_ABORTED
;

1824 
O±_i_vîsi⁄
:

1825 
sb
->
s_Êags
 |
SB_I_VERSION
;

1827 
O±_œzytime
:

1828 
sb
->
s_Êags
 |
SB_LAZYTIME
;

1830 
O±_nﬁazytime
:

1831 
sb
->
s_Êags
 &~
SB_LAZYTIME
;

1835 
m
 = 
pxt4_mou¡_›ts
; m->
tokí
 !
O±_îr
; m++)

1836 i‡(
tokí
 =
m
->token)

1839 i‡(
m
->
tokí
 =
O±_îr
) {

1840 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Unrecognized mount option \"%s\" "

1841 "‹ missög vÆue", 
›t
);

1845 i‡((
m
->
Êags
 & 
MOPT_NO_PXT2
Ë&& 
	`IS_PXT2_SB
(
sb
)) {

1846 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1847 "Mou¡ o±i⁄ \"%s\" incom∑tibÀ wôhÖxt2", 
›t
);

1850 i‡((
m
->
Êags
 & 
MOPT_NO_EXT3
Ë&& 
	`IS_EXT3_SB
(
sb
)) {

1851 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1852 "Mou¡ o±i⁄ \"%s\" incom∑tibÀ wôhÉxt3", 
›t
);

1856 i‡(
¨gs
->
‰om
 && !(
m
->
Êags
 & 
MOPT_STRING
Ë&& 
	`m©ch_öt
◊rgs, &
¨g
))

1858 i‡(
¨gs
->
‰om
 && (
m
->
Êags
 & 
MOPT_GTE0
Ë&& (
¨g
 < 0))

1860 i‡(
m
->
Êags
 & 
MOPT_EXPLICIT
) {

1861 i‡(
m
->
mou¡_›t
 & 
PXT4_MOUNT_DELALLOC
) {

1862 
	`£t_›t2
(
sb
, 
EXPLICIT_DELALLOC
);

1863 } i‡(
m
->
mou¡_›t
 & 
PXT4_MOUNT_JOURNAL_CHECKSUM
) {

1864 
	`£t_›t2
(
sb
, 
EXPLICIT_JOURNAL_CHECKSUM
);

1868 i‡(
m
->
Êags
 & 
MOPT_CLEAR_ERR
)

1869 
	`˛ór_›t
(
sb
, 
ERRORS_MASK
);

1870 i‡(
tokí
 =
O±_noquŸa
 && 
	`sb_™y_quŸa_lﬂded
(
sb
)) {

1871 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot change quota "

1876 i‡(
m
->
Êags
 & 
MOPT_NOSUPPORT
) {

1877 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%†›ti⁄ÇŸ suµ‹ãd", 
›t
);

1878 } i‡(
tokí
 =
O±_commô
) {

1879 i‡(
¨g
 == 0)

1880 
¨g
 = 
JBD3_DEFAULT_MAX_COMMIT_AGE
;

1881 i‡(
¨g
 > 
INT_MAX
 / 
HZ
) {

1882 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1885 
¨g
, 
INT_MAX
 / 
HZ
);

1888 
sbi
->
s_commô_öãrvÆ
 = 
HZ
 * 
¨g
;

1889 } i‡(
tokí
 =
O±_debug_w™t_exåa_isize
) {

1890 
sbi
->
s_w™t_exåa_isize
 = 
¨g
;

1891 } i‡(
tokí
 =
O±_max_b©ch_time
) {

1892 
sbi
->
s_max_b©ch_time
 = 
¨g
;

1893 } i‡(
tokí
 =
O±_mö_b©ch_time
) {

1894 
sbi
->
s_mö_b©ch_time
 = 
¨g
;

1895 } i‡(
tokí
 =
O±_öode_ªadahód_blks
) {

1896 i‡(
¨g
 && (¨g > (1 << 30Ë|| !
	`is_powî_of_2
(arg))) {

1897 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1902 
sbi
->
s_öode_ªadahód_blks
 = 
¨g
;

1903 } i‡(
tokí
 =
O±_öô_ôabÀ
) {

1904 
	`£t_›t
(
sb
, 
INIT_INODE_TABLE
);

1905 i‡(!
¨gs
->
‰om
)

1906 
¨g
 = 
PXT4_DEF_LI_WAIT_MULT
;

1907 
sbi
->
s_li_waô_mu…
 = 
¨g
;

1908 } i‡(
tokí
 =
O±_max_dú_size_kb
) {

1909 
sbi
->
s_max_dú_size_kb
 = 
¨g
;

1910 } i‡(
tokí
 =
O±_°rùe
) {

1911 
sbi
->
s_°rùe
 = 
¨g
;

1912 } i‡(
tokí
 =
O±_ªsuid
) {

1913 
uid
 = 
	`make_kuid
(
	`cuºít_u£r_ns
(), 
¨g
);

1914 i‡(!
	`uid_vÆid
(
uid
)) {

1915 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "InvÆid uid vÆuê%d", 
¨g
);

1918 
sbi
->
s_ªsuid
 = 
uid
;

1919 } i‡(
tokí
 =
O±_ªsgid
) {

1920 
gid
 = 
	`make_kgid
(
	`cuºít_u£r_ns
(), 
¨g
);

1921 i‡(!
	`gid_vÆid
(
gid
)) {

1922 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "InvÆid gid vÆuê%d", 
¨g
);

1925 
sbi
->
s_ªsgid
 = 
gid
;

1926 } i‡(
tokí
 =
O±_jou∫Æ_dev
) {

1927 i‡(
is_ªmou¡
) {

1928 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1932 *
jou∫Æ_devnum
 = 
¨g
;

1933 } i‡(
tokí
 =
O±_jou∫Æ_∑th
) {

1934 *
jou∫Æ_∑th
;

1935 
öode
 *
jou∫Æ_öode
;

1936 
∑th
Öath;

1937 
îr‹
;

1939 i‡(
is_ªmou¡
) {

1940 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1944 
jou∫Æ_∑th
 = 
	`m©ch_°rdup
(&
¨gs
[0]);

1945 i‡(!
jou∫Æ_∑th
) {

1946 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "error: couldÇot dup "

1951 
îr‹
 = 
	`kîn_∑th
(
jou∫Æ_∑th
, 
LOOKUP_FOLLOW
, &
∑th
);

1952 i‡(
îr‹
) {

1953 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "error: couldÇot find "

1954 "jou∫Æ devi˚Ö©h:Éº‹ %d", 
îr‹
);

1955 
	`k‰ì
(
jou∫Æ_∑th
);

1959 
jou∫Æ_öode
 = 
	`d_öode
(
∑th
.
díåy
);

1960 i‡(!
	`S_ISBLK
(
jou∫Æ_öode
->
i_mode
)) {

1961 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "error: journalÖath %s "

1962 "i†nŸá block devi˚", 
jou∫Æ_∑th
);

1963 
	`∑th_put
(&
∑th
);

1964 
	`k‰ì
(
jou∫Æ_∑th
);

1968 *
jou∫Æ_devnum
 = 
	`√w_ícode_dev
(
jou∫Æ_öode
->
i_rdev
);

1969 
	`∑th_put
(&
∑th
);

1970 
	`k‰ì
(
jou∫Æ_∑th
);

1971 } i‡(
tokí
 =
O±_jou∫Æ_i›rio
) {

1972 i‡(
¨g
 > 7) {

1973 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Invalid journal IOÖriority"

1977 *
jou∫Æ_i›rio
 =

1978 
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 
¨g
);

1979 } i‡(
tokí
 =
O±_ã°_dummy_í¸y±i⁄
) {

1980 #ifde‡
CONFIG_FS_ENCRYPTION


1981 
sbi
->
s_mou¡_Êags
 |
PXT4_MF_TEST_DUMMY_ENCRYPTION
;

1982 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

1985 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

1988 } i‡(
m
->
Êags
 & 
MOPT_DATAJ
) {

1989 i‡(
is_ªmou¡
) {

1990 i‡(!
sbi
->
s_jou∫Æ
)

1991 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Remounting file system withÇo journal so ignoring journalled data option");

1992 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë!
m
->
mou¡_›t
) {

1993 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1998 
	`˛ór_›t
(
sb
, 
DATA_FLAGS
);

1999 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

2001 #ifde‡
CONFIG_QUOTA


2002 } i‡(
m
->
Êags
 & 
MOPT_QFMT
) {

2003 i‡(
	`sb_™y_quŸa_lﬂded
(
sb
) &&

2004 
sbi
->
s_jquŸa_fmt
 !
m
->
mou¡_›t
) {

2005 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot change journaled "

2009 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
)) {

2010 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2015 
sbi
->
s_jquŸa_fmt
 = 
m
->
mou¡_›t
;

2017 } i‡(
tokí
 =
O±_dax
) {

2018 #ifde‡
CONFIG_FS_DAX


2019 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2021 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

2023 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "dax optionÇot supported");

2026 } i‡(
tokí
 =
O±_d©a_îr_ab‹t
) {

2027 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

2028 } i‡(
tokí
 =
O±_d©a_îr_ign‹e
) {

2029 
sbi
->
s_mou¡_›t
 &~
m
->
mou¡_›t
;

2031 i‡(!
¨gs
->
‰om
)

2032 
¨g
 = 1;

2033 i‡(
m
->
Êags
 & 
MOPT_CLEAR
)

2034 
¨g
 = !arg;

2035 i‡(
	`u∆ikñy
(!(
m
->
Êags
 & 
MOPT_SET
))) {

2036 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2037 "buggy h™dlög o‡›ti⁄ %s", 
›t
);

2038 
	`WARN_ON
(1);

2041 i‡(
¨g
 != 0)

2042 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

2044 
sbi
->
s_mou¡_›t
 &~
m
->
mou¡_›t
;

2047 
	}
}

2049 
	$∑r£_›ti⁄s
(*
›ti⁄s
, 
su≥r_block
 *
sb
,

2050 *
jou∫Æ_devnum
,

2051 *
jou∫Æ_i›rio
,

2052 
is_ªmou¡
)

2054 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2055 *
p
, 
__maybe_unu£d
 *
u§_qf_«me
, __maybe_unu£d *
gΩ_qf_«me
;

2056 
sub°rög_t
 
¨gs
[
MAX_OPT_ARGS
];

2057 
tokí
;

2059 i‡(!
›ti⁄s
)

2062 (
p
 = 
	`°r£p
(&
›ti⁄s
, ",")Ë!
NULL
) {

2063 i‡(!*
p
)

2069 
¨gs
[0].
to
 =árgs[0].
‰om
 = 
NULL
;

2070 
tokí
 = 
	`m©ch_tokí
(
p
, 
tokís
, 
¨gs
);

2071 i‡(
	`h™dÀ_mou¡_›t
(
sb
, 
p
, 
tokí
, 
¨gs
, 
jou∫Æ_devnum
,

2072 
jou∫Æ_i›rio
, 
is_ªmou¡
) < 0)

2075 #ifde‡
CONFIG_QUOTA


2081 i‡(
	`ã°_›t
(
sb
, 
PRJQUOTA
Ë&& !
	`pxt4_has_„©uª_¥oje˘
(sb)) {

2082 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Project quota featureÇotÉnabled. "

2086 
u§_qf_«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
USRQUOTA
);

2087 
gΩ_qf_«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
GRPQUOTA
);

2088 i‡(
u§_qf_«me
 || 
gΩ_qf_«me
) {

2089 i‡(
	`ã°_›t
(
sb
, 
USRQUOTA
Ë&& 
u§_qf_«me
)

2090 
	`˛ór_›t
(
sb
, 
USRQUOTA
);

2092 i‡(
	`ã°_›t
(
sb
, 
GRPQUOTA
Ë&& 
gΩ_qf_«me
)

2093 
	`˛ór_›t
(
sb
, 
GRPQUOTA
);

2095 i‡(
	`ã°_›t
(
sb
, 
GRPQUOTA
Ë||Åe°_›t(sb, 
USRQUOTA
)) {

2096 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "oldándÇew quota "

2101 i‡(!
sbi
->
s_jquŸa_fmt
) {

2102 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "journaled quota format "

2108 i‡(
	`ã°_›t
(
sb
, 
DIOREAD_NOLOCK
)) {

2109 
blocksize
 =

2110 
BLOCK_SIZE
 << 
	`À32_to_˝u
(
sbi
->
s_es
->
s_log_block_size
);

2112 i‡(
blocksize
 < 
PAGE_SIZE
) {

2113 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

2119 
	}
}

2121 
ölöe
 
	$pxt4_show_quŸa_›ti⁄s
(
£q_fûe
 *
£q
,

2122 
su≥r_block
 *
sb
)

2124 #i‡
	`deföed
(
CONFIG_QUOTA
)

2125 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2126 *
u§_qf_«me
, *
gΩ_qf_«me
;

2128 i‡(
sbi
->
s_jquŸa_fmt
) {

2129 *
fmäame
 = "";

2131 
sbi
->
s_jquŸa_fmt
) {

2132 
QFMT_VFS_OLD
:

2133 
fmäame
 = "vfsold";

2135 
QFMT_VFS_V0
:

2136 
fmäame
 = "vfsv0";

2138 
QFMT_VFS_V1
:

2139 
fmäame
 = "vfsv1";

2142 
	`£q_¥ötf
(
£q
, ",jqfmt=%s", 
fmäame
);

2145 
	`rcu_ªad_lock
();

2146 
u§_qf_«me
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_qf_«mes
[
USRQUOTA
]);

2147 
gΩ_qf_«me
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_qf_«mes
[
GRPQUOTA
]);

2148 i‡(
u§_qf_«me
)

2149 
	`£q_show_›ti⁄
(
£q
, "u§jquŸa", 
u§_qf_«me
);

2150 i‡(
gΩ_qf_«me
)

2151 
	`£q_show_›ti⁄
(
£q
, "gΩjquŸa", 
gΩ_qf_«me
);

2152 
	`rcu_ªad_u∆ock
();

2154 
	}
}

2156 c⁄° *
	$tokí2°r
(
tokí
)

2158 c⁄° 
m©ch_tokí
 *
t
;

2160 
t
 = 
tokís
;Å->
tokí
 !
O±_îr
;Å++)

2161 i‡(
t
->
tokí
 =tokí && !
	`°rchr
—->
∑âîn
, '='))

2163  
t
->
∑âîn
;

2164 
	}
}

2171 
	$_pxt4_show_›ti⁄s
(
£q_fûe
 *
£q
, 
su≥r_block
 *
sb
,

2172 
nodefs
)

2174 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2175 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

2176 
def_îr‹s
, 
def_mou¡_›t
 = 
sbi
->
s_def_mou¡_›t
;

2177 c⁄° 
mou¡_›ts
 *
m
;

2178 
£p
 = 
nodefs
 ? '\n' : ',';

2180 
	#SEQ_OPTS_PUTS
(
°r
Ë
	`£q_¥ötf
(
£q
, "%c" så, 
£p
)

	)

2181 
	#SEQ_OPTS_PRINT
(
°r
, 
¨g
Ë
	`£q_¥ötf
(
£q
, "%c" så, 
£p
,árg)

	)

2183 i‡(
sbi
->
s_sb_block
 != 1)

2184 
	`SEQ_OPTS_PRINT
("sb=%Œu", 
sbi
->
s_sb_block
);

2186 
m
 = 
pxt4_mou¡_›ts
; m->
tokí
 !
O±_îr
; m++) {

2187 
w™t_£t
 = 
m
->
Êags
 & 
MOPT_SET
;

2188 i‡(((
m
->
Êags
 & (
MOPT_SET
|
MOPT_CLEAR
)) == 0) ||

2189 (
m
->
Êags
 & 
MOPT_CLEAR_ERR
))

2191 i‡(!
nodefs
 && !(
m
->
mou¡_›t
 & (
sbi
->
s_mou¡_›t
 ^ 
def_mou¡_›t
)))

2193 i‡((
w™t_£t
 &&

2194 (
sbi
->
s_mou¡_›t
 & 
m
->
mou¡_›t
) != m->mount_opt) ||

2195 (!
w™t_£t
 && (
sbi
->
s_mou¡_›t
 & 
m
->
mou¡_›t
)))

2197 
	`SEQ_OPTS_PRINT
("%s", 
	`tokí2°r
(
m
->
tokí
));

2200 i‡(
nodefs
 || !
	`uid_eq
(
sbi
->
s_ªsuid
, 
	`make_kuid
(&
öô_u£r_ns
, 
PXT4_DEF_RESUID
)) ||

2201 
	`À16_to_˝u
(
es
->
s_def_ªsuid
Ë!
PXT4_DEF_RESUID
)

2202 
	`SEQ_OPTS_PRINT
("resuid=%u",

2203 
	`‰om_kuid_munged
(&
öô_u£r_ns
, 
sbi
->
s_ªsuid
));

2204 i‡(
nodefs
 || !
	`gid_eq
(
sbi
->
s_ªsgid
, 
	`make_kgid
(&
öô_u£r_ns
, 
PXT4_DEF_RESGID
)) ||

2205 
	`À16_to_˝u
(
es
->
s_def_ªsgid
Ë!
PXT4_DEF_RESGID
)

2206 
	`SEQ_OPTS_PRINT
("resgid=%u",

2207 
	`‰om_kgid_munged
(&
öô_u£r_ns
, 
sbi
->
s_ªsgid
));

2208 
def_îr‹s
 = 
nodefs
 ? -1 : 
	`À16_to_˝u
(
es
->
s_îr‹s
);

2209 i‡(
	`ã°_›t
(
sb
, 
ERRORS_RO
Ë&& 
def_îr‹s
 !
PXT4_ERRORS_RO
)

2210 
	`SEQ_OPTS_PUTS
("errors=remount-ro");

2211 i‡(
	`ã°_›t
(
sb
, 
ERRORS_CONT
Ë&& 
def_îr‹s
 !
PXT4_ERRORS_CONTINUE
)

2212 
	`SEQ_OPTS_PUTS
("errors=continue");

2213 i‡(
	`ã°_›t
(
sb
, 
ERRORS_PANIC
Ë&& 
def_îr‹s
 !
PXT4_ERRORS_PANIC
)

2214 
	`SEQ_OPTS_PUTS
("errors=panic");

2215 i‡(
nodefs
 || 
sbi
->
s_commô_öãrvÆ
 !
JBD3_DEFAULT_MAX_COMMIT_AGE
*
HZ
)

2216 
	`SEQ_OPTS_PRINT
("commô=%lu", 
sbi
->
s_commô_öãrvÆ
 / 
HZ
);

2217 i‡(
nodefs
 || 
sbi
->
s_mö_b©ch_time
 !
PXT4_DEF_MIN_BATCH_TIME
)

2218 
	`SEQ_OPTS_PRINT
("mö_b©ch_time=%u", 
sbi
->
s_mö_b©ch_time
);

2219 i‡(
nodefs
 || 
sbi
->
s_max_b©ch_time
 !
PXT4_DEF_MAX_BATCH_TIME
)

2220 
	`SEQ_OPTS_PRINT
("max_b©ch_time=%u", 
sbi
->
s_max_b©ch_time
);

2221 i‡(
sb
->
s_Êags
 & 
SB_I_VERSION
)

2222 
	`SEQ_OPTS_PUTS
("i_version");

2223 i‡(
nodefs
 || 
sbi
->
s_°rùe
)

2224 
	`SEQ_OPTS_PRINT
("°rùe=%lu", 
sbi
->
s_°rùe
);

2225 i‡(
nodefs
 || 
PXT4_MOUNT_DATA_FLAGS
 &

2226 (
sbi
->
s_mou¡_›t
 ^ 
def_mou¡_›t
)) {

2227 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
)

2228 
	`SEQ_OPTS_PUTS
("data=journal");

2229 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
)

2230 
	`SEQ_OPTS_PUTS
("data=ordered");

2231 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_WRITEBACK_DATA
)

2232 
	`SEQ_OPTS_PUTS
("data=writeback");

2234 i‡(
nodefs
 ||

2235 
sbi
->
s_öode_ªadahód_blks
 !
PXT4_DEF_INODE_READAHEAD_BLKS
)

2236 
	`SEQ_OPTS_PRINT
("inode_readahead_blks=%u",

2237 
sbi
->
s_öode_ªadahód_blks
);

2239 i‡(
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
Ë&& (
nodefs
 ||

2240 (
sbi
->
s_li_waô_mu…
 !
PXT4_DEF_LI_WAIT_MULT
)))

2241 
	`SEQ_OPTS_PRINT
("öô_ôabÀ=%u", 
sbi
->
s_li_waô_mu…
);

2242 i‡(
nodefs
 || 
sbi
->
s_max_dú_size_kb
)

2243 
	`SEQ_OPTS_PRINT
("max_dú_size_kb=%u", 
sbi
->
s_max_dú_size_kb
);

2244 i‡(
	`ã°_›t
(
sb
, 
DATA_ERR_ABORT
))

2245 
	`SEQ_OPTS_PUTS
("data_err=abort");

2246 i‡(
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
))

2247 
	`SEQ_OPTS_PUTS
("test_dummy_encryption");

2249 
	`pxt4_show_quŸa_›ti⁄s
(
£q
, 
sb
);

2251 
	}
}

2253 
	$pxt4_show_›ti⁄s
(
£q_fûe
 *
£q
, 
díåy
 *
roŸ
)

2255  
	`_pxt4_show_›ti⁄s
(
£q
, 
roŸ
->
d_sb
, 0);

2256 
	}
}

2258 
	$pxt4_£q_›ti⁄s_show
(
£q_fûe
 *
£q
, *
off£t
)

2260 
su≥r_block
 *
sb
 = 
£q
->
¥iv©e
;

2261 
rc
;

2263 
	`£q_puts
(
£q
, 
	`sb_rd⁄ly
(
sb
) ? "ro" : "rw");

2264 
rc
 = 
	`_pxt4_show_›ti⁄s
(
£q
, 
sb
, 1);

2265 
	`£q_puts
(
£q
, "\n");

2266  
rc
;

2267 
	}
}

2269 
	$pxt4_£tup_su≥r
(
su≥r_block
 *
sb
, 
pxt4_su≥r_block
 *
es
,

2270 
ªad_⁄ly
)

2272 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2273 
îr
 = 0;

2275 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë> 
PXT4_MAX_SUPP_REV
) {

2276 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "revisionÜevelÅoo high, "

2278 
îr
 = -
EROFS
;

2280 i‡(
ªad_⁄ly
)

2281 
d⁄e
;

2282 i‡(!(
sbi
->
s_mou¡_°©e
 & 
PXT4_VALID_FS
))

2283 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "warning: mounting unchecked fs, "

2285 i‡(
sbi
->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
)

2286 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2289 i‡((
__s16
Ë
	`À16_to_˝u
(
es
->
s_max_m¡_cou¡
) > 0 &&

2290 
	`À16_to_˝u
(
es
->
s_m¡_cou¡
) >=

2291 (Ë(
__s16
Ë
	`À16_to_˝u
(
es
->
s_max_m¡_cou¡
))

2292 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2295 i‡(
	`À32_to_˝u
(
es
->
s_checköãrvÆ
) &&

2296 (
	`pxt4_gë_t°amp
(
es
, 
s_œ°check
) +

2297 
	`À32_to_˝u
(
es
->
s_checköãrvÆ
Ë<
	`ktime_gë_ªÆ_£c⁄ds
()))

2298 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2301 i‡(!
sbi
->
s_jou∫Æ
)

2302 
es
->
s_°©e
 &
	`˝u_to_À16
(~
PXT4_VALID_FS
);

2303 i‡(!(
__s16
Ë
	`À16_to_˝u
(
es
->
s_max_m¡_cou¡
))

2304 
es
->
s_max_m¡_cou¡
 = 
	`˝u_to_À16
(
PXT4_DFL_MAX_MNT_COUNT
);

2305 
	`À16_add_˝u
(&
es
->
s_m¡_cou¡
, 1);

2306 
	`pxt4_upd©e_t°amp
(
es
, 
s_mtime
);

2307 i‡(
sbi
->
s_jou∫Æ
)

2308 
	`pxt4_£t_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

2310 
îr
 = 
	`pxt4_commô_su≥r
(
sb
, 1);

2311 
d⁄e
:

2312 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

2313 
	`¥ötk
(
KERN_INFO
 "[PXT4 FS bs=%lu, gc=%u, "

2315 
sb
->
s_blocksize
,

2316 
sbi
->
s_groups_cou¡
,

2317 
	`PXT4_BLOCKS_PER_GROUP
(
sb
),

2318 
	`PXT4_INODES_PER_GROUP
(
sb
),

2319 
sbi
->
s_mou¡_›t
, sbi->
s_mou¡_›t2
);

2321 
	`˛ónˇche_öô_fs
(
sb
);

2322  
îr
;

2323 
	}
}

2325 
	$pxt4_Æloc_Êex_bg_¨øy
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
ngroup
)

2327 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2328 
Êex_groups
 *
√w_groups
;

2329 
size
;

2331 i‡(!
sbi
->
s_log_groups_≥r_Êex
)

2334 
size
 = 
	`pxt4_Êex_group
(
sbi
, 
ngroup
 - 1) + 1;

2335 i‡(
size
 <
sbi
->
s_Êex_groups_Æloˇãd
)

2338 
size
 = 
	`roundup_pow_of_two
(sizê* (
Êex_groups
));

2339 
√w_groups
 = 
	`kvzÆloc
(
size
, 
GFP_KERNEL
);

2340 i‡(!
√w_groups
) {

2341 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "notÉnough memory for %d flex groups",

2342 
size
 / (Ë(
Êex_groups
));

2343  -
ENOMEM
;

2346 i‡(
sbi
->
s_Êex_groups
) {

2347 
	`mem˝y
(
√w_groups
, 
sbi
->
s_Êex_groups
,

2348 (
sbi
->
s_Êex_groups_Æloˇãd
 *

2349 (
Êex_groups
)));

2350 
	`kv‰ì
(
sbi
->
s_Êex_groups
);

2352 
sbi
->
s_Êex_groups
 = 
√w_groups
;

2353 
sbi
->
s_Êex_groups_Æloˇãd
 = 
size
 / (
Êex_groups
);

2355 
	}
}

2357 
	$pxt4_fûl_Êex_öfo
(
su≥r_block
 *
sb
)

2359 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2360 
pxt4_group_desc
 *
gdp
 = 
NULL
;

2361 
pxt4_group_t
 
Êex_group
;

2362 
i
, 
îr
;

2364 
sbi
->
s_log_groups_≥r_Êex
 = sbi->
s_es
->s_log_groups_per_flex;

2365 i‡(
sbi
->
s_log_groups_≥r_Êex
 < 1 || sbi->s_log_groups_per_flex > 31) {

2366 
sbi
->
s_log_groups_≥r_Êex
 = 0;

2370 
îr
 = 
	`pxt4_Æloc_Êex_bg_¨øy
(
sb
, 
sbi
->
s_groups_cou¡
);

2371 i‡(
îr
)

2372 
Áûed
;

2374 
i
 = 0; i < 
sbi
->
s_groups_cou¡
; i++) {

2375 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

2377 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
i
);

2378 
	`©omic_add
(
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
),

2379 &
sbi
->
s_Êex_groups
[
Êex_group
].
‰ì_öodes
);

2380 
	`©omic64_add
(
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
),

2381 &
sbi
->
s_Êex_groups
[
Êex_group
].
‰ì_˛u°îs
);

2382 
	`©omic_add
(
	`pxt4_u£d_dús_cou¡
(
sb
, 
gdp
),

2383 &
sbi
->
s_Êex_groups
[
Êex_group
].
u£d_dús
);

2387 
Áûed
:

2389 
	}
}

2391 
__À16
 
	$pxt4_group_desc_csum
(
su≥r_block
 *
sb
, 
__u32
 
block_group
,

2392 
pxt4_group_desc
 *
gdp
)

2394 
off£t
 = 
	`off£tof
(
pxt4_group_desc
, 
bg_checksum
);

2395 
__u16
 
¸c
 = 0;

2396 
__À32
 
À_group
 = 
	`˝u_to_À32
(
block_group
);

2397 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2399 i‡(
	`pxt4_has_mëad©a_csum
(
sbi
->
s_sb
)) {

2401 
__u32
 
csum32
;

2402 
__u16
 
dummy_csum
 = 0;

2404 
csum32
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
À_group
,

2405 (
À_group
));

2406 
csum32
 = 
	`pxt4_chksum
(
sbi
, csum32, (
__u8
 *)
gdp
, 
off£t
);

2407 
csum32
 = 
	`pxt4_chksum
(
sbi
, csum32, (
__u8
 *)&
dummy_csum
,

2408 (
dummy_csum
));

2409 
off£t
 +(
dummy_csum
);

2410 i‡(
off£t
 < 
sbi
->
s_desc_size
)

2411 
csum32
 = 
	`pxt4_chksum
(
sbi
, csum32, (
__u8
 *)
gdp
 + 
off£t
,

2412 
sbi
->
s_desc_size
 - 
off£t
);

2414 
¸c
 = 
csum32
 & 0xFFFF;

2415 
out
;

2419 i‡(!
	`pxt4_has_„©uª_gdt_csum
(
sb
))

2422 
¸c
 = 
	`¸c16
(~0, 
sbi
->
s_es
->
s_uuid
, (sbi->s_es->s_uuid));

2423 
¸c
 = 
	`¸c16
(¸c, (
__u8
 *)&
À_group
, (le_group));

2424 
¸c
 = 
	`¸c16
(¸c, (
__u8
 *)
gdp
, 
off£t
);

2425 
off£t
 +(
gdp
->
bg_checksum
);

2427 i‡(
	`pxt4_has_„©uª_64bô
(
sb
) &&

2428 
off£t
 < 
	`À16_to_˝u
(
sbi
->
s_es
->
s_desc_size
))

2429 
¸c
 = 
	`¸c16
(¸c, (
__u8
 *)
gdp
 + 
off£t
,

2430 
	`À16_to_˝u
(
sbi
->
s_es
->
s_desc_size
) -

2431 
off£t
);

2433 
out
:

2434  
	`˝u_to_À16
(
¸c
);

2435 
	}
}

2437 
	$pxt4_group_desc_csum_vîify
(
su≥r_block
 *
sb
, 
__u32
 
block_group
,

2438 
pxt4_group_desc
 *
gdp
)

2440 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

2441 (
gdp
->
bg_checksum
 !
	`pxt4_group_desc_csum
(
sb
, 
block_group
, gdp)))

2445 
	}
}

2447 
	$pxt4_group_desc_csum_£t
(
su≥r_block
 *
sb
, 
__u32
 
block_group
,

2448 
pxt4_group_desc
 *
gdp
)

2450 i‡(!
	`pxt4_has_group_desc_csum
(
sb
))

2452 
gdp
->
bg_checksum
 = 
	`pxt4_group_desc_csum
(
sb
, 
block_group
, gdp);

2453 
	}
}

2456 
	$pxt4_check_des¸ùt‹s
(
su≥r_block
 *
sb
,

2457 
pxt4_fsblk_t
 
sb_block
,

2458 
pxt4_group_t
 *
fú°_nŸ_zî€d
)

2460 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2461 
pxt4_fsblk_t
 
fú°_block
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
);

2462 
pxt4_fsblk_t
 
œ°_block
;

2463 
pxt4_fsblk_t
 
œ°_bg_block
 = 
sb_block
 + 
	`pxt4_bg_num_gdb
(
sb
, 0);

2464 
pxt4_fsblk_t
 
block_bôm≠
;

2465 
pxt4_fsblk_t
 
öode_bôm≠
;

2466 
pxt4_fsblk_t
 
öode_èbÀ
;

2467 
Êexbg_Êag
 = 0;

2468 
pxt4_group_t
 
i
, 
gΩ
 = 
sbi
->
s_groups_cou¡
;

2470 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
))

2471 
Êexbg_Êag
 = 1;

2473 
	`pxt4_debug
("Checking group descriptors");

2475 
i
 = 0; i < 
sbi
->
s_groups_cou¡
; i++) {

2476 
pxt4_group_desc
 *
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

2478 i‡(
i
 =
sbi
->
s_groups_cou¡
 - 1 || 
Êexbg_Êag
)

2479 
œ°_block
 = 
	`pxt4_blocks_cou¡
(
sbi
->
s_es
) - 1;

2481 
œ°_block
 = 
fú°_block
 +

2482 (
	`PXT4_BLOCKS_PER_GROUP
(
sb
) - 1);

2484 i‡((
gΩ
 =
sbi
->
s_groups_cou¡
) &&

2485 !(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
)))

2486 
gΩ
 = 
i
;

2488 
block_bôm≠
 = 
	`pxt4_block_bôm≠
(
sb
, 
gdp
);

2489 i‡(
block_bôm≠
 =
sb_block
) {

2490 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2492 "su≥rblock", 
i
);

2493 i‡(!
	`sb_rd⁄ly
(
sb
))

2496 i‡(
block_bôm≠
 >
sb_block
 + 1 &&

2497 
block_bôm≠
 <
œ°_bg_block
) {

2498 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2500 "block grou∞des¸ùt‹s", 
i
);

2501 i‡(!
	`sb_rd⁄ly
(
sb
))

2504 i‡(
block_bôm≠
 < 
fú°_block
 || block_bôm≠ > 
œ°_block
) {

2505 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2507 "(block %Œu)!", 
i
, 
block_bôm≠
);

2510 
öode_bôm≠
 = 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
);

2511 i‡(
öode_bôm≠
 =
sb_block
) {

2512 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2514 "su≥rblock", 
i
);

2515 i‡(!
	`sb_rd⁄ly
(
sb
))

2518 i‡(
öode_bôm≠
 >
sb_block
 + 1 &&

2519 
öode_bôm≠
 <
œ°_bg_block
) {

2520 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2522 "block grou∞des¸ùt‹s", 
i
);

2523 i‡(!
	`sb_rd⁄ly
(
sb
))

2526 i‡(
öode_bôm≠
 < 
fú°_block
 || inode_bôm≠ > 
œ°_block
) {

2527 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2529 "(block %Œu)!", 
i
, 
öode_bôm≠
);

2532 
öode_èbÀ
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

2533 i‡(
öode_èbÀ
 =
sb_block
) {

2534 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2536 "su≥rblock", 
i
);

2537 i‡(!
	`sb_rd⁄ly
(
sb
))

2540 i‡(
öode_èbÀ
 >
sb_block
 + 1 &&

2541 
öode_èbÀ
 <
œ°_bg_block
) {

2542 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2544 "block grou∞des¸ùt‹s", 
i
);

2545 i‡(!
	`sb_rd⁄ly
(
sb
))

2548 i‡(
öode_èbÀ
 < 
fú°_block
 ||

2549 
öode_èbÀ
 + 
sbi
->
s_ôb_≥r_group
 - 1 > 
œ°_block
) {

2550 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2552 "(block %Œu)!", 
i
, 
öode_èbÀ
);

2555 
	`pxt4_lock_group
(
sb
, 
i
);

2556 i‡(!
	`pxt4_group_desc_csum_vîify
(
sb
, 
i
, 
gdp
)) {

2557 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2559 
i
, 
	`À16_to_˝u
(
	`pxt4_group_desc_csum
(
sb
, i,

2560 
gdp
)), 
	`À16_to_˝u
(gdp->
bg_checksum
));

2561 i‡(!
	`sb_rd⁄ly
(
sb
)) {

2562 
	`pxt4_u∆ock_group
(
sb
, 
i
);

2566 
	`pxt4_u∆ock_group
(
sb
, 
i
);

2567 i‡(!
Êexbg_Êag
)

2568 
fú°_block
 +
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

2570 i‡(
NULL
 !
fú°_nŸ_zî€d
)

2571 *
fú°_nŸ_zî€d
 = 
gΩ
;

2573 
	}
}

2592 
	$pxt4_‹ph™_˛ónup
(
su≥r_block
 *
sb
,

2593 
pxt4_su≥r_block
 *
es
)

2595 
s_Êags
 = 
sb
->s_flags;

2596 
ªt
, 
ƒ_‹ph™s
 = 0, 
ƒ_åunˇãs
 = 0;

2597 #ifde‡
CONFIG_QUOTA


2598 
quŸa_upd©e
 = 0;

2599 
i
;

2601 i‡(!
es
->
s_œ°_‹ph™
) {

2602 
	`jbd_debug
(4, "no orphan inodesÅo clean up\n");

2606 i‡(
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
)) {

2607 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "writeáccess "

2613 i‡(!
	`pxt4_„©uª_£t_ok
(
sb
, 0)) {

2614 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Skipping orphan cleanup dueÅo "

2619 i‡(
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
) {

2621 i‡(
es
->
s_œ°_‹ph™
 && !(
s_Êags
 & 
SB_RDONLY
)) {

2622 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Errors on filesystem, "

2624 
es
->
s_œ°_‹ph™
 = 0;

2626 
	`jbd_debug
(1, "Skipping orphanÑecovery on fs withÉrrors.\n");

2630 i‡(
s_Êags
 & 
SB_RDONLY
) {

2631 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "orphan cleanup onÑeadonly fs");

2632 
sb
->
s_Êags
 &~
SB_RDONLY
;

2634 #ifde‡
CONFIG_QUOTA


2636 
sb
->
s_Êags
 |
SB_ACTIVE
;

2642 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
Ë&& (
s_Êags
 & 
SB_RDONLY
)) {

2643 
ªt
 = 
	`pxt4_íabÀ_quŸas
(
sb
);

2645 i‡(!
ªt
)

2646 
quŸa_upd©e
 = 1;

2648 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2649 "C™nŸÅu∫ o¿quŸas:Éº‹ %d", 
ªt
);

2653 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++) {

2654 i‡(
	`PXT4_SB
(
sb
)->
s_qf_«mes
[
i
]) {

2655 
ªt
 = 
	`pxt4_quŸa_⁄_mou¡
(
sb
, 
i
);

2657 i‡(!
ªt
)

2658 
quŸa_upd©e
 = 1;

2660 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2662 "quŸa:Åy≥ %d:Éº‹ %d", 
i
, 
ªt
);

2667 
es
->
s_œ°_‹ph™
) {

2668 
öode
 *inode;

2674 i‡(
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
) {

2675 
	`jbd_debug
(1, "Skipping orphanÑecovery on fs withÉrrors.\n");

2676 
es
->
s_œ°_‹ph™
 = 0;

2680 
öode
 = 
	`pxt4_‹ph™_gë
(
sb
, 
	`À32_to_˝u
(
es
->
s_œ°_‹ph™
));

2681 i‡(
	`IS_ERR
(
öode
)) {

2682 
es
->
s_œ°_‹ph™
 = 0;

2686 
	`li°_add
(&
	`PXT4_I
(
öode
)->
i_‹ph™
, &
	`PXT4_SB
(
sb
)->
s_‹ph™
);

2687 
	`dquŸ_öôülize
(
öode
);

2688 i‡(
öode
->
i_∆ök
) {

2689 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

2690 
	`pxt4_msg
(
sb
, 
KERN_DEBUG
,

2692 
__func__
, 
öode
->
i_öo
, inode->
i_size
);

2693 
	`jbd_debug
(2, "truncating inode %luÅo %lld bytes\n",

2694 
öode
->
i_öo
, inode->
i_size
);

2695 
	`öode_lock
(
öode
);

2696 
	`åunˇã_öode_∑ges
(
öode
->
i_m≠pög
, inode->
i_size
);

2697 
ªt
 = 
	`pxt4_åunˇã
(
öode
);

2698 i‡(
ªt
)

2699 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

2700 
	`öode_u∆ock
(
öode
);

2701 
ƒ_åunˇãs
++;

2703 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

2704 
	`pxt4_msg
(
sb
, 
KERN_DEBUG
,

2706 
__func__
, 
öode
->
i_öo
);

2707 
	`jbd_debug
(2, "deleting unreferenced inode %lu\n",

2708 
öode
->
i_öo
);

2709 
ƒ_‹ph™s
++;

2711 
	`ùut
(
öode
);

2714 
	#PLURAL
(
x
Ë(x), ((xË=1Ë? "" : "s"

	)

2716 i‡(
ƒ_‹ph™s
)

2717 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "%d orphan inode%s deleted",

2718 
	`PLURAL
(
ƒ_‹ph™s
));

2719 i‡(
ƒ_åunˇãs
)

2720 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "%dÅruncate%s cleaned up",

2721 
	`PLURAL
(
ƒ_åunˇãs
));

2722 #ifde‡
CONFIG_QUOTA


2724 i‡(
quŸa_upd©e
) {

2725 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++) {

2726 i‡(
	`sb_dq›t
(
sb
)->
fûes
[
i
])

2727 
	`dquŸ_quŸa_off
(
sb
, 
i
);

2731 
sb
->
s_Êags
 = s_flags;

2732 
	}
}

2749 
loff_t
 
	$pxt4_max_size
(
blkbôs
, 
has_huge_fûes
)

2751 
loff_t
 
ªs
;

2752 
loff_t
 
uµî_limô
 = 
MAX_LFS_FILESIZE
;

2754 
	`BUILD_BUG_ON
((
blk˙t_t
Ë< (
u64
));

2756 i‡(!
has_huge_fûes
) {

2757 
uµî_limô
 = (1LL << 32) - 1;

2760 
uµî_limô
 >>(
blkbôs
 - 9);

2761 
uµî_limô
 <<
blkbôs
;

2769 
ªs
 = (1LL << 32) - 1;

2770 
ªs
 <<
blkbôs
;

2773 i‡(
ªs
 > 
uµî_limô
)

2774 
ªs
 = 
uµî_limô
;

2776  
ªs
;

2777 
	}
}

2784 
loff_t
 
	$pxt4_max_bôm≠_size
(
bôs
, 
has_huge_fûes
)

2786 
loff_t
 
ªs
 = 
PXT4_NDIR_BLOCKS
;

2787 
mëa_blocks
;

2788 
loff_t
 
uµî_limô
;

2797 i‡(!
has_huge_fûes
) {

2803 
uµî_limô
 = (1LL << 32) - 1;

2806 
uµî_limô
 >>(
bôs
 - 9);

2815 
uµî_limô
 = (1LL << 48) - 1;

2820 
mëa_blocks
 = 1;

2822 
mëa_blocks
 +1 + (1LL << (
bôs
-2));

2824 
mëa_blocks
 +1 + (1LL << (
bôs
-2)) + (1LL << (2*(bits-2)));

2826 
uµî_limô
 -
mëa_blocks
;

2827 
uµî_limô
 <<
bôs
;

2829 
ªs
 +1LL << (
bôs
-2);

2830 
ªs
 +1LL << (2*(
bôs
-2));

2831 
ªs
 +1LL << (3*(
bôs
-2));

2832 
ªs
 <<
bôs
;

2833 i‡(
ªs
 > 
uµî_limô
)

2834 
ªs
 = 
uµî_limô
;

2836 i‡(
ªs
 > 
MAX_LFS_FILESIZE
)

2837 
ªs
 = 
MAX_LFS_FILESIZE
;

2839  
ªs
;

2840 
	}
}

2842 
pxt4_fsblk_t
 
	$des¸ùt‹_loc
(
su≥r_block
 *
sb
,

2843 
pxt4_fsblk_t
 
logiˇl_sb_block
, 
ƒ
)

2845 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2846 
pxt4_group_t
 
bg
, 
fú°_mëa_bg
;

2847 
has_su≥r
 = 0;

2849 
fú°_mëa_bg
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_mëa_bg
);

2851 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
Ë|| 
ƒ
 < 
fú°_mëa_bg
)

2852  
logiˇl_sb_block
 + 
ƒ
 + 1;

2853 
bg
 = 
sbi
->
s_desc_≥r_block
 * 
ƒ
;

2854 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
bg
))

2855 
has_su≥r
 = 1;

2863 i‡(
sb
->
s_blocksize
 =1024 && 
ƒ
 == 0 &&

2864 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
) == 0)

2865 
has_su≥r
++;

2867  (
has_su≥r
 + 
	`pxt4_group_fú°_block_no
(
sb
, 
bg
));

2868 
	}
}

2881 
	$pxt4_gë_°rùe_size
(
pxt4_sb_öfo
 *
sbi
)

2883 
°ride
 = 
	`À16_to_˝u
(
sbi
->
s_es
->
s_øid_°ride
);

2884 
°rùe_width
 =

2885 
	`À32_to_˝u
(
sbi
->
s_es
->
s_øid_°rùe_width
);

2886 
ªt
;

2888 i‡(
sbi
->
s_°rùe
 && sbi->s_°rùê<sbi->
s_blocks_≥r_group
)

2889 
ªt
 = 
sbi
->
s_°rùe
;

2890 i‡(
°rùe_width
 && såùe_width <
sbi
->
s_blocks_≥r_group
)

2891 
ªt
 = 
°rùe_width
;

2892 i‡(
°ride
 && såidê<
sbi
->
s_blocks_≥r_group
)

2893 
ªt
 = 
°ride
;

2895 
ªt
 = 0;

2901 i‡(
ªt
 <= 1)

2902 
ªt
 = 0;

2904  
ªt
;

2905 
	}
}

2913 
	$pxt4_„©uª_£t_ok
(
su≥r_block
 *
sb
, 
ªad⁄ly
)

2915 i‡(
	`pxt4_has_unknown_pxt4_öcom∑t_„©uªs
(
sb
)) {

2916 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2919 (
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
) &

2920 ~
PXT4_FEATURE_INCOMPAT_SUPP
));

2924 #i‚de‡
CONFIG_UNICODE


2925 i‡(
	`pxt4_has_„©uª_ˇ£fﬁd
(
sb
)) {

2926 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2933 i‡(
ªad⁄ly
)

2936 i‡(
	`pxt4_has_„©uª_ªad⁄ly
(
sb
)) {

2937 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "filesystem isÑead-only");

2938 
sb
->
s_Êags
 |
SB_RDONLY
;

2943 i‡(
	`pxt4_has_unknown_pxt4_ro_com∑t_„©uªs
(
sb
)) {

2944 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn't mount RDWR because of "

2946 (
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
) &

2947 ~
PXT4_FEATURE_RO_COMPAT_SUPP
));

2950 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
Ë&& !
	`pxt4_has_„©uª_exã¡s
(sb)) {

2951 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2957 #i‚de‡
CONFIG_QUOTA


2958 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
Ë&& !
ªad⁄ly
) {

2959 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2964 i‡(
	`pxt4_has_„©uª_¥oje˘
(
sb
Ë&& !
ªad⁄ly
) {

2965 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2972 
	}
}

2978 
	$¥öt_daûy_îr‹_öfo
(
timî_li°
 *
t
)

2980 
pxt4_sb_öfo
 *
sbi
 = 
	`‰om_timî
(sbi, 
t
, 
s_îr_ªp‹t
);

2981 
su≥r_block
 *
sb
 = 
sbi
->
s_sb
;

2982 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

2984 i‡(
es
->
s_îr‹_cou¡
)

2986 
	`pxt4_msg
(
sb
, 
KERN_NOTICE
, "error count sinceÜast fsck: %u",

2987 
	`À32_to_˝u
(
es
->
s_îr‹_cou¡
));

2988 i‡(
es
->
s_fú°_îr‹_time
) {

2989 
	`¥ötk
(
KERN_NOTICE
 "PXT4-fs (%s): initialÉrrorátÅime %llu: %.*s:%d",

2990 
sb
->
s_id
,

2991 
	`pxt4_gë_t°amp
(
es
, 
s_fú°_îr‹_time
),

2992 (Ë(
es
->
s_fú°_îr‹_func
),

2993 
es
->
s_fú°_îr‹_func
,

2994 
	`À32_to_˝u
(
es
->
s_fú°_îr‹_löe
));

2995 i‡(
es
->
s_fú°_îr‹_öo
)

2996 
	`¥ötk
(
KERN_CONT
 ": inode %u",

2997 
	`À32_to_˝u
(
es
->
s_fú°_îr‹_öo
));

2998 i‡(
es
->
s_fú°_îr‹_block
)

2999 
	`¥ötk
(
KERN_CONT
 ": block %llu", ()

3000 
	`À64_to_˝u
(
es
->
s_fú°_îr‹_block
));

3001 
	`¥ötk
(
KERN_CONT
 "\n");

3003 i‡(
es
->
s_œ°_îr‹_time
) {

3004 
	`¥ötk
(
KERN_NOTICE
 "PXT4-fs (%s):ÜastÉrrorátÅime %llu: %.*s:%d",

3005 
sb
->
s_id
,

3006 
	`pxt4_gë_t°amp
(
es
, 
s_œ°_îr‹_time
),

3007 (Ë(
es
->
s_œ°_îr‹_func
),

3008 
es
->
s_œ°_îr‹_func
,

3009 
	`À32_to_˝u
(
es
->
s_œ°_îr‹_löe
));

3010 i‡(
es
->
s_œ°_îr‹_öo
)

3011 
	`¥ötk
(
KERN_CONT
 ": inode %u",

3012 
	`À32_to_˝u
(
es
->
s_œ°_îr‹_öo
));

3013 i‡(
es
->
s_œ°_îr‹_block
)

3014 
	`¥ötk
(
KERN_CONT
 ": block %llu", ()

3015 
	`À64_to_˝u
(
es
->
s_œ°_îr‹_block
));

3016 
	`¥ötk
(
KERN_CONT
 "\n");

3018 
	`mod_timî
(&
sbi
->
s_îr_ªp‹t
, 
jiffõs
 + 24*60*60*
HZ
);

3019 
	}
}

3022 
	$pxt4_run_li_ªque°
(
pxt4_li_ªque°
 *
ñr
)

3024 
pxt4_group_desc
 *
gdp
 = 
NULL
;

3025 
pxt4_group_t
 
group
, 
ngroups
;

3026 
su≥r_block
 *
sb
;

3027 
timeout
 = 0;

3028 
ªt
 = 0;

3030 
sb
 = 
ñr
->
Ã_su≥r
;

3031 
ngroups
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

3033 
group
 = 
ñr
->
Ã_√xt_group
; grou∞< 
ngroups
; group++) {

3034 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

3035 i‡(!
gdp
) {

3036 
ªt
 = 1;

3040 i‡(!(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
)))

3044 i‡(
group
 >
ngroups
)

3045 
ªt
 = 1;

3047 i‡(!
ªt
) {

3048 
timeout
 = 
jiffõs
;

3049 
ªt
 = 
	`pxt4_öô_öode_èbÀ
(
sb
, 
group
,

3050 
ñr
->
Ã_timeout
 ? 0 : 1);

3051 i‡(
ñr
->
Ã_timeout
 == 0) {

3052 
timeout
 = (
jiffõs
 -Åimeout) *

3053 
ñr
->
Ã_sbi
->
s_li_waô_mu…
;

3054 
ñr
->
Ã_timeout
 = 
timeout
;

3056 
ñr
->
Ã_√xt_sched
 = 
jiffõs
 +ÉÃ->
Ã_timeout
;

3057 
ñr
->
Ã_√xt_group
 = 
group
 + 1;

3059  
ªt
;

3060 
	}
}

3066 
	$pxt4_ªmove_li_ªque°
(
pxt4_li_ªque°
 *
ñr
)

3068 
pxt4_sb_öfo
 *
sbi
;

3070 i‡(!
ñr
)

3073 
sbi
 = 
ñr
->
Ã_sbi
;

3075 
	`li°_dñ
(&
ñr
->
Ã_ªque°
);

3076 
sbi
->
s_li_ªque°
 = 
NULL
;

3077 
	`k‰ì
(
ñr
);

3078 
	}
}

3080 
	$pxt4_uƒegi°î_li_ªque°
(
su≥r_block
 *
sb
)

3082 
	`muãx_lock
(&
pxt4_li_mtx
);

3083 i‡(!
pxt4_li_öfo
) {

3084 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3088 
	`muãx_lock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3089 
	`pxt4_ªmove_li_ªque°
(
	`PXT4_SB
(
sb
)->
s_li_ªque°
);

3090 
	`muãx_u∆ock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3091 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3092 
	}
}

3094 
èsk_°ru˘
 *
	gpxt4_œzyöô_èsk
;

3105 
	$pxt4_œzyöô_thªad
(*
¨g
)

3107 
pxt4_œzy_öô
 *
ñi
 = (pxt4_œzy_öô *)
¨g
;

3108 
li°_hód
 *
pos
, *
n
;

3109 
pxt4_li_ªque°
 *
ñr
;

3110 
√xt_wakeup
, 
cur
;

3112 
	`BUG_ON
(
NULL
 =
ñi
);

3114 
c⁄t_thªad
:

3115 
åue
) {

3116 
√xt_wakeup
 = 
MAX_JIFFY_OFFSET
;

3118 
	`muãx_lock
(&
ñi
->
li_li°_mtx
);

3119 i‡(
	`li°_em±y
(&
ñi
->
li_ªque°_li°
)) {

3120 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3121 
exô_thªad
;

3123 
	`li°_f‹_óch_ß„
(
pos
, 
n
, &
ñi
->
li_ªque°_li°
) {

3124 
îr
 = 0;

3125 
¥ogªss
 = 0;

3126 
ñr
 = 
	`li°_íåy
(
pos
, 
pxt4_li_ªque°
,

3127 
Ã_ªque°
);

3129 i‡(
	`time_bef‹e
(
jiffõs
, 
ñr
->
Ã_√xt_sched
)) {

3130 i‡(
	`time_bef‹e
(
ñr
->
Ã_√xt_sched
, 
√xt_wakeup
))

3131 
√xt_wakeup
 = 
ñr
->
Ã_√xt_sched
;

3134 i‡(
	`down_ªad_åylock
(&
ñr
->
Ã_su≥r
->
s_umou¡
)) {

3135 i‡(
	`sb_°¨t_wrôe_åylock
(
ñr
->
Ã_su≥r
)) {

3136 
¥ogªss
 = 1;

3142 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3143 
îr
 = 
	`pxt4_run_li_ªque°
(
ñr
);

3144 
	`sb_íd_wrôe
(
ñr
->
Ã_su≥r
);

3145 
	`muãx_lock
(&
ñi
->
li_li°_mtx
);

3146 
n
 = 
pos
->
√xt
;

3148 
	`up_ªad
((&
ñr
->
Ã_su≥r
->
s_umou¡
));

3151 i‡(
îr
) {

3152 
	`pxt4_ªmove_li_ªque°
(
ñr
);

3155 i‡(!
¥ogªss
) {

3156 
ñr
->
Ã_√xt_sched
 = 
jiffõs
 +

3157 (
	`¥™dom_u32
()

3158 % (
PXT4_DEF_LI_MAX_START_DELAY
 * 
HZ
));

3160 i‡(
	`time_bef‹e
(
ñr
->
Ã_√xt_sched
, 
√xt_wakeup
))

3161 
√xt_wakeup
 = 
ñr
->
Ã_√xt_sched
;

3163 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3165 
	`åy_to_‰ìze
();

3167 
cur
 = 
jiffõs
;

3168 i‡((
	`time_a·î_eq
(
cur
, 
√xt_wakeup
)) ||

3169 (
MAX_JIFFY_OFFSET
 =
√xt_wakeup
)) {

3170 
	`c⁄d_ªsched
();

3174 
	`scheduÀ_timeout_öãºu±ibÀ
(
√xt_wakeup
 - 
cur
);

3176 i‡(
	`kthªad_should_°›
()) {

3177 
	`pxt4_˛ór_ªque°_li°
();

3178 
exô_thªad
;

3182 
exô_thªad
:

3191 
	`muãx_lock
(&
pxt4_li_mtx
);

3192 
	`muãx_lock
(&
ñi
->
li_li°_mtx
);

3193 i‡(!
	`li°_em±y
(&
ñi
->
li_ªque°_li°
)) {

3194 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3195 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3196 
c⁄t_thªad
;

3198 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3199 
	`k‰ì
(
pxt4_li_öfo
);

3200 
pxt4_li_öfo
 = 
NULL
;

3201 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3204 
	}
}

3206 
	$pxt4_˛ór_ªque°_li°
()

3208 
li°_hód
 *
pos
, *
n
;

3209 
pxt4_li_ªque°
 *
ñr
;

3211 
	`muãx_lock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3212 
	`li°_f‹_óch_ß„
(
pos
, 
n
, &
pxt4_li_öfo
->
li_ªque°_li°
) {

3213 
ñr
 = 
	`li°_íåy
(
pos
, 
pxt4_li_ªque°
,

3214 
Ã_ªque°
);

3215 
	`pxt4_ªmove_li_ªque°
(
ñr
);

3217 
	`muãx_u∆ock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3218 
	}
}

3220 
	$pxt4_run_œzyöô_thªad
()

3222 
pxt4_œzyöô_èsk
 = 
	`kthªad_run
(
pxt4_œzyöô_thªad
,

3223 
pxt4_li_öfo
, "pxt4lazyinit");

3224 i‡(
	`IS_ERR
(
pxt4_œzyöô_èsk
)) {

3225 
îr
 = 
	`PTR_ERR
(
pxt4_œzyöô_èsk
);

3226 
	`pxt4_˛ór_ªque°_li°
();

3227 
	`k‰ì
(
pxt4_li_öfo
);

3228 
pxt4_li_öfo
 = 
NULL
;

3229 
	`¥ötk
(
KERN_CRIT
 "PXT4-fs:Érror %d creating inodeÅable "

3231 
îr
);

3232  
îr
;

3234 
pxt4_li_öfo
->
li_°©e
 |
PXT4_LAZYINIT_RUNNING
;

3236 
	}
}

3244 
pxt4_group_t
 
	$pxt4_has_unöô_ôabÀ
(
su≥r_block
 *
sb
)

3246 
pxt4_group_t
 
group
, 
ngroups
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

3247 
pxt4_group_desc
 *
gdp
 = 
NULL
;

3249 i‡(!
	`pxt4_has_group_desc_csum
(
sb
))

3250  
ngroups
;

3252 
group
 = 0; grou∞< 
ngroups
; group++) {

3253 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

3254 i‡(!
gdp
)

3257 i‡(!(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
)))

3261  
group
;

3262 
	}
}

3264 
	$pxt4_li_öfo_√w
()

3266 
pxt4_œzy_öô
 *
ñi
 = 
NULL
;

3268 
ñi
 = 
	`kzÆloc
((*ñi), 
GFP_KERNEL
);

3269 i‡(!
ñi
)

3270  -
ENOMEM
;

3272 
	`INIT_LIST_HEAD
(&
ñi
->
li_ªque°_li°
);

3273 
	`muãx_öô
(&
ñi
->
li_li°_mtx
);

3275 
ñi
->
li_°©e
 |
PXT4_LAZYINIT_QUIT
;

3277 
pxt4_li_öfo
 = 
ñi
;

3280 
	}
}

3282 
pxt4_li_ªque°
 *
	$pxt4_li_ªque°_√w
(
su≥r_block
 *
sb
,

3283 
pxt4_group_t
 
°¨t
)

3285 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3286 
pxt4_li_ªque°
 *
ñr
;

3288 
ñr
 = 
	`kzÆloc
((*ñr), 
GFP_KERNEL
);

3289 i‡(!
ñr
)

3290  
NULL
;

3292 
ñr
->
Ã_su≥r
 = 
sb
;

3293 
ñr
->
Ã_sbi
 = 
sbi
;

3294 
ñr
->
Ã_√xt_group
 = 
°¨t
;

3301 
ñr
->
Ã_√xt_sched
 = 
jiffõs
 + (
	`¥™dom_u32
() %

3302 (
PXT4_DEF_LI_MAX_START_DELAY
 * 
HZ
));

3303  
ñr
;

3304 
	}
}

3306 
	$pxt4_ªgi°î_li_ªque°
(
su≥r_block
 *
sb
,

3307 
pxt4_group_t
 
fú°_nŸ_zî€d
)

3309 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3310 
pxt4_li_ªque°
 *
ñr
 = 
NULL
;

3311 
pxt4_group_t
 
ngroups
 = 
sbi
->
s_groups_cou¡
;

3312 
ªt
 = 0;

3314 
	`muãx_lock
(&
pxt4_li_mtx
);

3315 i‡(
sbi
->
s_li_ªque°
 !
NULL
) {

3320 
sbi
->
s_li_ªque°
->
Ã_timeout
 = 0;

3321 
out
;

3324 i‡(
fú°_nŸ_zî€d
 =
ngroups
 || 
	`sb_rd⁄ly
(
sb
) ||

3325 !
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

3326 
out
;

3328 
ñr
 = 
	`pxt4_li_ªque°_√w
(
sb
, 
fú°_nŸ_zî€d
);

3329 i‡(!
ñr
) {

3330 
ªt
 = -
ENOMEM
;

3331 
out
;

3334 i‡(
NULL
 =
pxt4_li_öfo
) {

3335 
ªt
 = 
	`pxt4_li_öfo_√w
();

3336 i‡(
ªt
)

3337 
out
;

3340 
	`muãx_lock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3341 
	`li°_add
(&
ñr
->
Ã_ªque°
, &
pxt4_li_öfo
->
li_ªque°_li°
);

3342 
	`muãx_u∆ock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3344 
sbi
->
s_li_ªque°
 = 
ñr
;

3350 
ñr
 = 
NULL
;

3352 i‡(!(
pxt4_li_öfo
->
li_°©e
 & 
PXT4_LAZYINIT_RUNNING
)) {

3353 
ªt
 = 
	`pxt4_run_œzyöô_thªad
();

3354 i‡(
ªt
)

3355 
out
;

3357 
out
:

3358 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3359 i‡(
ªt
)

3360 
	`k‰ì
(
ñr
);

3361  
ªt
;

3362 
	}
}

3368 
	$pxt4_de°roy_œzyöô_thªad
()

3374 i‡(!
pxt4_li_öfo
 || !
pxt4_œzyöô_èsk
)

3377 
	`kthªad_°›
(
pxt4_œzyöô_èsk
);

3378 
	}
}

3380 
	$£t_jou∫Æ_csum_„©uª_£t
(
su≥r_block
 *
sb
)

3382 
ªt
 = 1;

3383 
com∑t
, 
öcom∑t
;

3384 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3386 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

3388 
com∑t
 = 0;

3389 
öcom∑t
 = 
JBD3_FEATURE_INCOMPAT_CSUM_V3
;

3392 
com∑t
 = 
JBD3_FEATURE_COMPAT_CHECKSUM
;

3393 
öcom∑t
 = 0;

3396 
	`jbd3_jou∫Æ_˛ór_„©uªs
(
sbi
->
s_jou∫Æ
,

3397 
JBD3_FEATURE_COMPAT_CHECKSUM
, 0,

3398 
JBD3_FEATURE_INCOMPAT_CSUM_V3
 |

3399 
JBD3_FEATURE_INCOMPAT_CSUM_V2
);

3400 i‡(
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

3401 
ªt
 = 
	`jbd3_jou∫Æ_£t_„©uªs
(
sbi
->
s_jou∫Æ
,

3402 
com∑t
, 0,

3403 
JBD3_FEATURE_INCOMPAT_ASYNC_COMMIT
 |

3404 
öcom∑t
);

3405 } i‡(
	`ã°_›t
(
sb
, 
JOURNAL_CHECKSUM
)) {

3406 
ªt
 = 
	`jbd3_jou∫Æ_£t_„©uªs
(
sbi
->
s_jou∫Æ
,

3407 
com∑t
, 0,

3408 
öcom∑t
);

3409 
	`jbd3_jou∫Æ_˛ór_„©uªs
(
sbi
->
s_jou∫Æ
, 0, 0,

3410 
JBD3_FEATURE_INCOMPAT_ASYNC_COMMIT
);

3412 
	`jbd3_jou∫Æ_˛ór_„©uªs
(
sbi
->
s_jou∫Æ
, 0, 0,

3413 
JBD3_FEATURE_INCOMPAT_ASYNC_COMMIT
);

3416  
ªt
;

3417 
	}
}

3434 
	$cou¡_ovîhód
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
gΩ
,

3435 *
buf
)

3437 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3438 
pxt4_group_desc
 *
gdp
;

3439 
pxt4_fsblk_t
 
fú°_block
, 
œ°_block
, 
b
;

3440 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

3441 
s
, 
j
, 
cou¡
 = 0;

3443 i‡(!
	`pxt4_has_„©uª_bigÆloc
(
sb
))

3444  (
	`pxt4_bg_has_su≥r
(
sb
, 
gΩ
Ë+ 
	`pxt4_bg_num_gdb
(sb, grp) +

3445 
sbi
->
s_ôb_≥r_group
 + 2);

3447 
fú°_block
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
) +

3448 (
gΩ
 * 
	`PXT4_BLOCKS_PER_GROUP
(
sb
));

3449 
œ°_block
 = 
fú°_block
 + 
	`PXT4_BLOCKS_PER_GROUP
(
sb
) - 1;

3450 
i
 = 0; i < 
ngroups
; i++) {

3451 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

3452 
b
 = 
	`pxt4_block_bôm≠
(
sb
, 
gdp
);

3453 i‡(
b
 >
fú°_block
 && b <
œ°_block
) {

3454 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
b
 - 
fú°_block
), 
buf
);

3455 
cou¡
++;

3457 
b
 = 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
);

3458 i‡(
b
 >
fú°_block
 && b <
œ°_block
) {

3459 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
b
 - 
fú°_block
), 
buf
);

3460 
cou¡
++;

3462 
b
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

3463 i‡(
b
 >
fú°_block
 && b + 
sbi
->
s_ôb_≥r_group
 <
œ°_block
)

3464 
j
 = 0; j < 
sbi
->
s_ôb_≥r_group
; j++, 
b
++) {

3465 
c
 = 
	`PXT4_B2C
(
sbi
, 
b
 - 
fú°_block
);

3466 
	`pxt4_£t_bô
(
c
, 
buf
);

3467 
cou¡
++;

3469 i‡(
i
 !
gΩ
)

3471 
s
 = 0;

3472 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
gΩ
)) {

3473 
	`pxt4_£t_bô
(
s
++, 
buf
);

3474 
cou¡
++;

3476 
j
 = 
	`pxt4_bg_num_gdb
(
sb
, 
gΩ
);

3477 i‡(
s
 + 
j
 > 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)) {

3478 
	`pxt4_îr‹
(
sb
, "InvalidÇumber of block group "

3479 "des¸ùt‹ blocks: %d", 
j
);

3480 
j
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
Ë- 
s
;

3482 
cou¡
 +
j
;

3483 ; 
j
 > 0; j--)

3484 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
s
++), 
buf
);

3486 i‡(!
cou¡
)

3488  
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) -

3489 
	`pxt4_cou¡_‰ì
(
buf
, 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8);

3490 
	}
}

3495 
	$pxt4_ˇlcuœã_ovîhód
(
su≥r_block
 *
sb
)

3497 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3498 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

3499 
öode
 *
j_öode
;

3500 
j_blocks
, 
j_öum
 = 
	`À32_to_˝u
(
es
->
s_jou∫Æ_öum
);

3501 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

3502 
pxt4_fsblk_t
 
ovîhód
 = 0;

3503 *
buf
 = (*Ë
	`gë_zî€d_∑ge
(
GFP_NOFS
);

3505 i‡(!
buf
)

3506  -
ENOMEM
;

3517 
ovîhód
 = 
	`PXT4_B2C
(
sbi
, 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
));

3522 
i
 = 0; i < 
ngroups
; i++) {

3523 
blks
;

3525 
blks
 = 
	`cou¡_ovîhód
(
sb
, 
i
, 
buf
);

3526 
ovîhód
 +
blks
;

3527 i‡(
blks
)

3528 
	`mem£t
(
buf
, 0, 
PAGE_SIZE
);

3529 
	`c⁄d_ªsched
();

3536 i‡(
sbi
->
s_jou∫Æ
 && !sbi->
jou∫Æ_bdev
)

3537 
ovîhód
 +
	`PXT4_NUM_B2C
(
sbi
, sbi->
s_jou∫Æ
->
j_maxÀn
);

3538 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
sb
Ë&& !
sbi
->
s_jou∫Æ
) {

3539 
j_öode
 = 
	`pxt4_gë_jou∫Æ_öode
(
sb
, 
j_öum
);

3540 i‡(
j_öode
) {

3541 
j_blocks
 = 
j_öode
->
i_size
 >> 
sb
->
s_blocksize_bôs
;

3542 
ovîhód
 +
	`PXT4_NUM_B2C
(
sbi
, 
j_blocks
);

3543 
	`ùut
(
j_öode
);

3545 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't get journal size");

3548 
sbi
->
s_ovîhód
 = 
ovîhód
;

3549 
	`smp_wmb
();

3550 
	`‰ì_∑ge
((Ë
buf
);

3552 
	}
}

3554 
	$pxt4_˛amp_w™t_exåa_isize
(
su≥r_block
 *
sb
)

3556 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3557 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

3560 i‡(
sbi
->
s_öode_size
 > 
PXT4_GOOD_OLD_INODE_SIZE
 &&

3561 
sbi
->
s_w™t_exåa_isize
 == 0) {

3562 
sbi
->
s_w™t_exåa_isize
 = (
pxt4_öode
) -

3563 
PXT4_GOOD_OLD_INODE_SIZE
;

3564 i‡(
	`pxt4_has_„©uª_exåa_isize
(
sb
)) {

3565 i‡(
sbi
->
s_w™t_exåa_isize
 <

3566 
	`À16_to_˝u
(
es
->
s_w™t_exåa_isize
))

3567 
sbi
->
s_w™t_exåa_isize
 =

3568 
	`À16_to_˝u
(
es
->
s_w™t_exåa_isize
);

3569 i‡(
sbi
->
s_w™t_exåa_isize
 <

3570 
	`À16_to_˝u
(
es
->
s_mö_exåa_isize
))

3571 
sbi
->
s_w™t_exåa_isize
 =

3572 
	`À16_to_˝u
(
es
->
s_mö_exåa_isize
);

3576 i‡(
PXT4_GOOD_OLD_INODE_SIZE
 + 
sbi
->
s_w™t_exåa_isize
 >

3577 
sbi
->
s_öode_size
) {

3578 
sbi
->
s_w™t_exåa_isize
 = (
pxt4_öode
) -

3579 
PXT4_GOOD_OLD_INODE_SIZE
;

3580 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

3583 
	}
}

3585 
	$pxt4_£t_ªsv_˛u°îs
(
su≥r_block
 *
sb
)

3587 
pxt4_fsblk_t
 
ªsv_˛u°îs
;

3588 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3596 i‡(!
	`pxt4_has_„©uª_exã¡s
(
sb
))

3606 
ªsv_˛u°îs
 = (
	`pxt4_blocks_cou¡
(
sbi
->
s_es
) >>

3607 
sbi
->
s_˛u°î_bôs
);

3609 
	`do_div
(
ªsv_˛u°îs
, 50);

3610 
ªsv_˛u°îs
 = 
	`mö_t
(
pxt4_fsblk_t
,Ñesv_clusters, 4096);

3612 
	`©omic64_£t
(&
sbi
->
s_ªsv_˛u°îs
, 
ªsv_˛u°îs
);

3613 
	}
}

3615 
	$pxt4_fûl_su≥r
(
su≥r_block
 *
sb
, *
d©a
, 
sûít
)

3617 
dax_devi˚
 *
dax_dev
 = 
	`fs_dax_gë_by_bdev
(
sb
->
s_bdev
);

3618 *
‹ig_d©a
 = 
	`k°rdup
(
d©a
, 
GFP_KERNEL
);

3619 
buf„r_hód
 *
bh
;

3620 
pxt4_su≥r_block
 *
es
 = 
NULL
;

3621 
pxt4_sb_öfo
 *
sbi
 = 
	`kzÆloc
((*sbi), 
GFP_KERNEL
);

3622 
pxt4_fsblk_t
 
block
;

3623 
pxt4_fsblk_t
 
sb_block
 = 
	`gë_sb_block
(&
d©a
);

3624 
pxt4_fsblk_t
 
logiˇl_sb_block
;

3625 
off£t
 = 0;

3626 
jou∫Æ_devnum
 = 0;

3627 
def_mou¡_›ts
;

3628 
öode
 *
roŸ
;

3629 c⁄° *
des¸
;

3630 
ªt
 = -
ENOMEM
;

3631 
blocksize
, 
˛u°îsize
;

3632 
db_cou¡
;

3633 
i
;

3634 
√eds_ªcovîy
, 
has_huge_fûes
, 
has_bigÆloc
;

3635 
__u64
 
blocks_cou¡
;

3636 
îr
 = 0;

3637 
jou∫Æ_i›rio
 = 
DEFAULT_JOURNAL_IOPRIO
;

3638 
pxt4_group_t
 
fú°_nŸ_zî€d
;

3640 i‡((
d©a
 && !
‹ig_d©a
Ë|| !
sbi
)

3641 
out_‰ì_ba£
;

3643 
sbi
->
s_daxdev
 = 
dax_dev
;

3644 
sbi
->
s_blockgroup_lock
 =

3645 
	`kzÆloc
((
blockgroup_lock
), 
GFP_KERNEL
);

3646 i‡(!
sbi
->
s_blockgroup_lock
)

3647 
out_‰ì_ba£
;

3649 
sb
->
s_fs_öfo
 = 
sbi
;

3650 
sbi
->
s_sb
 = 
sb
;

3651 
sbi
->
s_öode_ªadahód_blks
 = 
PXT4_DEF_INODE_READAHEAD_BLKS
;

3652 
sbi
->
s_sb_block
 = 
sb_block
;

3653 i‡(
sb
->
s_bdev
->
bd_∑π
)

3654 
sbi
->
s_£˘‹s_wrôãn_°¨t
 =

3655 
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
, 
£˘‹s
[
STAT_WRITE
]);

3658 
	`°ºïœ˚
(
sb
->
s_id
, '/', '!');

3661 
ªt
 = -
EINVAL
;

3662 
blocksize
 = 
	`sb_mö_blocksize
(
sb
, 
PXT4_MIN_BLOCK_SIZE
);

3663 i‡(!
blocksize
) {

3664 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "unableÅo set blocksize");

3665 
out_Áû
;

3672 i‡(
blocksize
 !
PXT4_MIN_BLOCK_SIZE
) {

3673 
logiˇl_sb_block
 = 
sb_block
 * 
PXT4_MIN_BLOCK_SIZE
;

3674 
off£t
 = 
	`do_div
(
logiˇl_sb_block
, 
blocksize
);

3676 
logiˇl_sb_block
 = 
sb_block
;

3679 i‡(!(
bh
 = 
	`sb_bªad_unmovabÀ
(
sb
, 
logiˇl_sb_block
))) {

3680 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "unableÅoÑead superblock");

3681 
out_Áû
;

3687 
es
 = (
pxt4_su≥r_block
 *Ë(
bh
->
b_d©a
 + 
off£t
);

3688 
sbi
->
s_es
 = 
es
;

3689 
sb
->
s_magic
 = 
	`À16_to_˝u
(
es
->s_magic);

3690 i‡(
sb
->
s_magic
 !
PXT4_SUPER_MAGIC
)

3691 
ˇ¡föd_pxt4
;

3692 
sbi
->
s_kbyãs_wrôãn
 = 
	`À64_to_˝u
(
es
->s_kbytes_written);

3695 i‡(
	`pxt4_has_„©uª_mëad©a_csum
(
sb
) &&

3696 
	`pxt4_has_„©uª_gdt_csum
(
sb
))

3697 
	`pxt4_w¨nög
(
sb
, "metadata_csumánd uninit_bgáre "

3701 i‡(!
	`pxt4_vîify_csum_ty≥
(
sb
, 
es
)) {

3702 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "VFS: FoundÖxt4 filesystem with "

3704 
sûít
 = 1;

3705 
ˇ¡föd_pxt4
;

3709 
sbi
->
s_chksum_drivî
 = 
	`¸y±o_Æloc_shash
("crc32c", 0, 0);

3710 i‡(
	`IS_ERR
(
sbi
->
s_chksum_drivî
)) {

3711 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "CannotÜoad crc32c driver.");

3712 
ªt
 = 
	`PTR_ERR
(
sbi
->
s_chksum_drivî
);

3713 
sbi
->
s_chksum_drivî
 = 
NULL
;

3714 
Áûed_mou¡
;

3718 i‡(!
	`pxt4_su≥rblock_csum_vîify
(
sb
, 
es
)) {

3719 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "VFS: FoundÖxt4 filesystem with "

3721 
sûít
 = 1;

3722 
ªt
 = -
EFSBADCRC
;

3723 
ˇ¡föd_pxt4
;

3727 i‡(
	`pxt4_has_„©uª_csum_£ed
(
sb
))

3728 
sbi
->
s_csum_£ed
 = 
	`À32_to_˝u
(
es
->
s_checksum_£ed
);

3729 i‡(
	`pxt4_has_mëad©a_csum
(
sb
Ë|| 
	`pxt4_has_„©uª_ó_öode
(sb))

3730 
sbi
->
s_csum_£ed
 = 
	`pxt4_chksum
(sbi, ~0, 
es
->
s_uuid
,

3731 (
es
->
s_uuid
));

3734 
def_mou¡_›ts
 = 
	`À32_to_˝u
(
es
->
s_deÁu…_mou¡_›ts
);

3735 
	`£t_›t
(
sb
, 
INIT_INODE_TABLE
);

3736 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_DEBUG
)

3737 
	`£t_›t
(
sb
, 
DEBUG
);

3738 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_BSDGROUPS
)

3739 
	`£t_›t
(
sb
, 
GRPID
);

3740 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_UID16
)

3741 
	`£t_›t
(
sb
, 
NO_UID32
);

3743 
	`£t_›t
(
sb
, 
XATTR_USER
);

3744 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


3745 
	`£t_›t
(
sb
, 
POSIX_ACL
);

3748 i‡(
	`pxt4_has_mëad©a_csum
(
sb
))

3749 
	`£t_›t
(
sb
, 
JOURNAL_CHECKSUM
);

3751 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_JMODE
Ë=
PXT4_DEFM_JMODE_DATA
)

3752 
	`£t_›t
(
sb
, 
JOURNAL_DATA
);

3753 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_JMODE
Ë=
PXT4_DEFM_JMODE_ORDERED
)

3754 
	`£t_›t
(
sb
, 
ORDERED_DATA
);

3755 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_JMODE
Ë=
PXT4_DEFM_JMODE_WBACK
)

3756 
	`£t_›t
(
sb
, 
WRITEBACK_DATA
);

3758 i‡(
	`À16_to_˝u
(
sbi
->
s_es
->
s_îr‹s
Ë=
PXT4_ERRORS_PANIC
)

3759 
	`£t_›t
(
sb
, 
ERRORS_PANIC
);

3760 i‡(
	`À16_to_˝u
(
sbi
->
s_es
->
s_îr‹s
Ë=
PXT4_ERRORS_CONTINUE
)

3761 
	`£t_›t
(
sb
, 
ERRORS_CONT
);

3763 
	`£t_›t
(
sb
, 
ERRORS_RO
);

3765 
	`£t_›t
(
sb
, 
BLOCK_VALIDITY
);

3766 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_DISCARD
)

3767 
	`£t_›t
(
sb
, 
DISCARD
);

3769 
sbi
->
s_ªsuid
 = 
	`make_kuid
(&
öô_u£r_ns
, 
	`À16_to_˝u
(
es
->
s_def_ªsuid
));

3770 
sbi
->
s_ªsgid
 = 
	`make_kgid
(&
öô_u£r_ns
, 
	`À16_to_˝u
(
es
->
s_def_ªsgid
));

3771 
sbi
->
s_commô_öãrvÆ
 = 
JBD3_DEFAULT_MAX_COMMIT_AGE
 * 
HZ
;

3772 
sbi
->
s_mö_b©ch_time
 = 
PXT4_DEF_MIN_BATCH_TIME
;

3773 
sbi
->
s_max_b©ch_time
 = 
PXT4_DEF_MAX_BATCH_TIME
;

3775 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_NOBARRIER
) == 0)

3776 
	`£t_›t
(
sb
, 
BARRIER
);

3782 i‡(!
	`IS_EXT3_SB
(
sb
Ë&& !
	`IS_PXT2_SB
(sb) &&

3783 ((
def_mou¡_›ts
 & 
PXT4_DEFM_NODELALLOC
) == 0))

3784 
	`£t_›t
(
sb
, 
DELALLOC
);

3790 
sbi
->
s_li_waô_mu…
 = 
PXT4_DEF_LI_WAIT_MULT
;

3792 i‡(
sbi
->
s_es
->
s_mou¡_›ts
[0]) {

3793 *
s_mou¡_›ts
 = 
	`k°∫dup
(
sbi
->
s_es
->s_mount_opts,

3794 (
sbi
->
s_es
->
s_mou¡_›ts
),

3795 
GFP_KERNEL
);

3796 i‡(!
s_mou¡_›ts
)

3797 
Áûed_mou¡
;

3798 i‡(!
	`∑r£_›ti⁄s
(
s_mou¡_›ts
, 
sb
, &
jou∫Æ_devnum
,

3799 &
jou∫Æ_i›rio
, 0)) {

3800 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

3802 
s_mou¡_›ts
);

3804 
	`k‰ì
(
s_mou¡_›ts
);

3806 
sbi
->
s_def_mou¡_›t
 = sbi->
s_mou¡_›t
;

3807 i‡(!
	`∑r£_›ti⁄s
((*Ë
d©a
, 
sb
, &
jou∫Æ_devnum
,

3808 &
jou∫Æ_i›rio
, 0))

3809 
Áûed_mou¡
;

3811 #ifde‡
CONFIG_UNICODE


3812 i‡(
	`pxt4_has_„©uª_ˇ£fﬁd
(
sb
Ë&& !
sbi
->
s_ícodög
) {

3813 c⁄° 
pxt4_sb_ícodögs
 *
ícodög_öfo
;

3814 
unicode_m≠
 *
ícodög
;

3815 
__u16
 
ícodög_Êags
;

3817 i‡(
	`pxt4_has_„©uª_í¸y±
(
sb
)) {

3818 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3820 
Áûed_mou¡
;

3823 i‡(
	`pxt4_sb_ªad_ícodög
(
es
, &
ícodög_öfo
,

3824 &
ícodög_Êags
)) {

3825 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3827 
Áûed_mou¡
;

3830 
ícodög
 = 
	`utf8_lﬂd
(
ícodög_öfo
->
vîsi⁄
);

3831 i‡(
	`IS_ERR
(
ícodög
)) {

3832 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3835 
ícodög_öfo
->
«me
,Éncodög_öfo->
vîsi⁄
,

3836 
ícodög_Êags
);

3837 
Áûed_mou¡
;

3839 
	`pxt4_msg
(
sb
, 
KERN_INFO
,"UsingÉncoding defined by superblock: "

3840 "%s-%†wôh fœg†0x%hx", 
ícodög_öfo
->
«me
,

3841 
ícodög_öfo
->
vîsi⁄
?:"\b", 
ícodög_Êags
);

3843 
sbi
->
s_ícodög
 = 
ícodög
;

3844 
sbi
->
s_ícodög_Êags
 = 
ícodög_Êags
;

3848 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
) {

3849 
	`¥ötk_⁄˚
(
KERN_WARNING
 "PXT4-fs: Warning: mounting "

3852 i‡(
	`ã°_›t2
(
sb
, 
EXPLICIT_DELALLOC
)) {

3853 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3855 
Áûed_mou¡
;

3857 i‡(
	`ã°_›t
(
sb
, 
DIOREAD_NOLOCK
)) {

3858 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3860 
Áûed_mou¡
;

3862 i‡(
	`ã°_›t
(
sb
, 
DAX
)) {

3863 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3865 
Áûed_mou¡
;

3867 i‡(
	`pxt4_has_„©uª_í¸y±
(
sb
)) {

3868 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

3872 i‡(
	`ã°_›t
(
sb
, 
DELALLOC
))

3873 
	`˛ór_›t
(
sb
, 
DELALLOC
);

3875 
sb
->
s_iÊags
 |
SB_I_CGROUPWB
;

3878 
sb
->
s_Êags
 = (sb->s_Êag†& ~
SB_POSIXACL
) |

3879 (
	`ã°_›t
(
sb
, 
POSIX_ACL
Ë? 
SB_POSIXACL
 : 0);

3881 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë=
PXT4_GOOD_OLD_REV
 &&

3882 (
	`pxt4_has_com∑t_„©uªs
(
sb
) ||

3883 
	`pxt4_has_ro_com∑t_„©uªs
(
sb
) ||

3884 
	`pxt4_has_öcom∑t_„©uªs
(
sb
)))

3885 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

3889 i‡(
es
->
s_¸ót‹_os
 =
	`˝u_to_À32
(
PXT4_OS_HURD
)) {

3890 
	`£t_›t2
(
sb
, 
HURD_COMPAT
);

3891 i‡(
	`pxt4_has_„©uª_64bô
(
sb
)) {

3892 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3894 
Áûed_mou¡
;

3901 i‡(
	`pxt4_has_„©uª_ó_öode
(
sb
)) {

3902 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3904 
Áûed_mou¡
;

3908 i‡(
	`IS_PXT2_SB
(
sb
)) {

3909 i‡(
	`pxt2_„©uª_£t_ok
(
sb
))

3910 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "mountingÖxt2 file system "

3917 i‡(
sûít
 && 
	`pxt4_„©uª_£t_ok
(
sb
, 
	`sb_rd⁄ly
(sb)))

3918 
Áûed_mou¡
;

3919 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn't mountásÖxt2 due "

3921 
Áûed_mou¡
;

3925 i‡(
	`IS_EXT3_SB
(
sb
)) {

3926 i‡(
	`ext3_„©uª_£t_ok
(
sb
))

3927 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "mountingÉxt3 file system "

3934 i‡(
sûít
 && 
	`pxt4_„©uª_£t_ok
(
sb
, 
	`sb_rd⁄ly
(sb)))

3935 
Áûed_mou¡
;

3936 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn't mountásÉxt3 due "

3938 
Áûed_mou¡
;

3947 i‡(!
	`pxt4_„©uª_£t_ok
(
sb
, (
	`sb_rd⁄ly
(sb))))

3948 
Áûed_mou¡
;

3950 
blocksize
 = 
BLOCK_SIZE
 << 
	`À32_to_˝u
(
es
->
s_log_block_size
);

3951 i‡(
blocksize
 < 
PXT4_MIN_BLOCK_SIZE
 ||

3952 
blocksize
 > 
PXT4_MAX_BLOCK_SIZE
) {

3953 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3955 
blocksize
, 
	`À32_to_˝u
(
es
->
s_log_block_size
));

3956 
Áûed_mou¡
;

3958 i‡(
	`À32_to_˝u
(
es
->
s_log_block_size
) >

3959 (
PXT4_MAX_BLOCK_LOG_SIZE
 - 
PXT4_MIN_BLOCK_LOG_SIZE
)) {

3960 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3962 
	`À32_to_˝u
(
es
->
s_log_block_size
));

3963 
Áûed_mou¡
;

3965 i‡(
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
) >

3966 (
PXT4_MAX_CLUSTER_LOG_SIZE
 - 
PXT4_MIN_BLOCK_LOG_SIZE
)) {

3967 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3969 
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
));

3970 
Áûed_mou¡
;

3973 i‡(
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
Ë> (
blocksize
 / 4)) {

3974 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3976 
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
));

3977 
Áûed_mou¡
;

3980 i‡(
sbi
->
s_mou¡_›t
 & 
PXT4_MOUNT_DAX
) {

3981 i‡(
	`pxt4_has_„©uª_ölöe_d©a
(
sb
)) {

3982 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot use DAX oná filesystem"

3984 
Áûed_mou¡
;

3986 i‡(!
	`bdev_dax_suµ‹ãd
(
sb
->
s_bdev
, 
blocksize
)) {

3987 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3989 
Áûed_mou¡
;

3993 i‡(
	`pxt4_has_„©uª_í¸y±
(
sb
Ë&& 
es
->
s_í¸y±i⁄_Àvñ
) {

3994 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "UnsupportedÉncryptionÜevel %d",

3995 
es
->
s_í¸y±i⁄_Àvñ
);

3996 
Áûed_mou¡
;

3999 i‡(
sb
->
s_blocksize
 !
blocksize
) {

4001 i‡(!
	`sb_£t_blocksize
(
sb
, 
blocksize
)) {

4002 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "bad block size %d",

4003 
blocksize
);

4004 
Áûed_mou¡
;

4007 
	`bªl£
(
bh
);

4008 
logiˇl_sb_block
 = 
sb_block
 * 
PXT4_MIN_BLOCK_SIZE
;

4009 
off£t
 = 
	`do_div
(
logiˇl_sb_block
, 
blocksize
);

4010 
bh
 = 
	`sb_bªad_unmovabÀ
(
sb
, 
logiˇl_sb_block
);

4011 i‡(!
bh
) {

4012 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4014 
Áûed_mou¡
;

4016 
es
 = (
pxt4_su≥r_block
 *)(
bh
->
b_d©a
 + 
off£t
);

4017 
sbi
->
s_es
 = 
es
;

4018 i‡(
es
->
s_magic
 !
	`˝u_to_À16
(
PXT4_SUPER_MAGIC
)) {

4019 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4021 
Áûed_mou¡
;

4025 
has_huge_fûes
 = 
	`pxt4_has_„©uª_huge_fûe
(
sb
);

4026 
sbi
->
s_bôm≠_maxbyãs
 = 
	`pxt4_max_bôm≠_size
(
sb
->
s_blocksize_bôs
,

4027 
has_huge_fûes
);

4028 
sb
->
s_maxbyãs
 = 
	`pxt4_max_size
(sb->
s_blocksize_bôs
, 
has_huge_fûes
);

4030 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë=
PXT4_GOOD_OLD_REV
) {

4031 
sbi
->
s_öode_size
 = 
PXT4_GOOD_OLD_INODE_SIZE
;

4032 
sbi
->
s_fú°_öo
 = 
PXT4_GOOD_OLD_FIRST_INO
;

4034 
sbi
->
s_öode_size
 = 
	`À16_to_˝u
(
es
->s_inode_size);

4035 
sbi
->
s_fú°_öo
 = 
	`À32_to_˝u
(
es
->s_first_ino);

4036 i‡(
sbi
->
s_fú°_öo
 < 
PXT4_GOOD_OLD_FIRST_INO
) {

4037 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "invalid first ino: %u",

4038 
sbi
->
s_fú°_öo
);

4039 
Áûed_mou¡
;

4041 i‡((
sbi
->
s_öode_size
 < 
PXT4_GOOD_OLD_INODE_SIZE
) ||

4042 (!
	`is_powî_of_2
(
sbi
->
s_öode_size
)) ||

4043 (
sbi
->
s_öode_size
 > 
blocksize
)) {

4044 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4046 
sbi
->
s_öode_size
);

4047 
Áûed_mou¡
;

4054 i‡(
sbi
->
s_öode_size
 >
	`off£tof
(
pxt4_öode
, 
i_©ime_exåa
) +

4055 (((
pxt4_öode
 *)0)->
i_©ime_exåa
)) {

4056 
sb
->
s_time_gøn
 = 1;

4057 
sb
->
s_time_max
 = 
PXT4_EXTRA_TIMESTAMP_MAX
;

4059 
sb
->
s_time_gøn
 = 
NSEC_PER_SEC
;

4060 
sb
->
s_time_max
 = 
PXT4_NON_EXTRA_TIMESTAMP_MAX
;

4063 
sb
->
s_time_mö
 = 
PXT4_TIMESTAMP_MIN
;

4066 
sbi
->
s_desc_size
 = 
	`À16_to_˝u
(
es
->s_desc_size);

4067 i‡(
	`pxt4_has_„©uª_64bô
(
sb
)) {

4068 i‡(
sbi
->
s_desc_size
 < 
PXT4_MIN_DESC_SIZE_64BIT
 ||

4069 
sbi
->
s_desc_size
 > 
PXT4_MAX_DESC_SIZE
 ||

4070 !
	`is_powî_of_2
(
sbi
->
s_desc_size
)) {

4071 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4073 
sbi
->
s_desc_size
);

4074 
Áûed_mou¡
;

4077 
sbi
->
s_desc_size
 = 
PXT4_MIN_DESC_SIZE
;

4079 
sbi
->
s_blocks_≥r_group
 = 
	`À32_to_˝u
(
es
->s_blocks_per_group);

4080 
sbi
->
s_öodes_≥r_group
 = 
	`À32_to_˝u
(
es
->s_inodes_per_group);

4082 
sbi
->
s_öodes_≥r_block
 = 
blocksize
 / 
	`PXT4_INODE_SIZE
(
sb
);

4083 i‡(
sbi
->
s_öodes_≥r_block
 == 0)

4084 
ˇ¡föd_pxt4
;

4085 i‡(
sbi
->
s_öodes_≥r_group
 < sbi->
s_öodes_≥r_block
 ||

4086 
sbi
->
s_öodes_≥r_group
 > 
blocksize
 * 8) {

4087 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "invalid inodesÖer group: %lu\n",

4088 
sbi
->
s_blocks_≥r_group
);

4089 
Áûed_mou¡
;

4091 
sbi
->
s_ôb_≥r_group
 = sbi->
s_öodes_≥r_group
 /

4092 
sbi
->
s_öodes_≥r_block
;

4093 
sbi
->
s_desc_≥r_block
 = 
blocksize
 / 
	`PXT4_DESC_SIZE
(
sb
);

4094 
sbi
->
s_sbh
 = 
bh
;

4095 
sbi
->
s_mou¡_°©e
 = 
	`À16_to_˝u
(
es
->
s_°©e
);

4096 
sbi
->
s_addr_≥r_block_bôs
 = 
	`ûog2
(
	`PXT4_ADDR_PER_BLOCK
(
sb
));

4097 
sbi
->
s_desc_≥r_block_bôs
 = 
	`ûog2
(
	`PXT4_DESC_PER_BLOCK
(
sb
));

4099 
i
 = 0; i < 4; i++)

4100 
sbi
->
s_hash_£ed
[
i
] = 
	`À32_to_˝u
(
es
->s_hash_seed[i]);

4101 
sbi
->
s_def_hash_vîsi⁄
 = 
es
->s_def_hash_version;

4102 i‡(
	`pxt4_has_„©uª_dú_ödex
(
sb
)) {

4103 
i
 = 
	`À32_to_˝u
(
es
->
s_Êags
);

4104 i‡(
i
 & 
PXT2_FLAGS_UNSIGNED_HASH
)

4105 
sbi
->
s_hash_unsig√d
 = 3;

4106 i‡((
i
 & 
PXT2_FLAGS_SIGNED_HASH
) == 0) {

4107 #ifde‡
__CHAR_UNSIGNED__


4108 i‡(!
	`sb_rd⁄ly
(
sb
))

4109 
es
->
s_Êags
 |=

4110 
	`˝u_to_À32
(
PXT2_FLAGS_UNSIGNED_HASH
);

4111 
sbi
->
s_hash_unsig√d
 = 3;

4113 i‡(!
	`sb_rd⁄ly
(
sb
))

4114 
es
->
s_Êags
 |=

4115 
	`˝u_to_À32
(
PXT2_FLAGS_SIGNED_HASH
);

4121 
˛u°îsize
 = 
BLOCK_SIZE
 << 
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
);

4122 
has_bigÆloc
 = 
	`pxt4_has_„©uª_bigÆloc
(
sb
);

4123 i‡(
has_bigÆloc
) {

4124 i‡(
˛u°îsize
 < 
blocksize
) {

4125 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4127 "block sizê(%d)", 
˛u°îsize
, 
blocksize
);

4128 
Áûed_mou¡
;

4130 
sbi
->
s_˛u°î_bôs
 = 
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
) -

4131 
	`À32_to_˝u
(
es
->
s_log_block_size
);

4132 
sbi
->
s_˛u°îs_≥r_group
 =

4133 
	`À32_to_˝u
(
es
->
s_˛u°îs_≥r_group
);

4134 i‡(
sbi
->
s_˛u°îs_≥r_group
 > 
blocksize
 * 8) {

4135 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4137 
sbi
->
s_˛u°îs_≥r_group
);

4138 
Áûed_mou¡
;

4140 i‡(
sbi
->
s_blocks_≥r_group
 !=

4141 (
sbi
->
s_˛u°îs_≥r_group
 * (
˛u°îsize
 / 
blocksize
))) {

4142 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "blocksÖer group (%lu)ánd "

4144 
sbi
->
s_blocks_≥r_group
,

4145 
sbi
->
s_˛u°îs_≥r_group
);

4146 
Áûed_mou¡
;

4149 i‡(
˛u°îsize
 !
blocksize
) {

4150 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4152 "block sizê(%d)", 
˛u°îsize
, 
blocksize
);

4153 
Áûed_mou¡
;

4155 i‡(
sbi
->
s_blocks_≥r_group
 > 
blocksize
 * 8) {

4156 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4158 
sbi
->
s_blocks_≥r_group
);

4159 
Áûed_mou¡
;

4161 
sbi
->
s_˛u°îs_≥r_group
 = sbi->
s_blocks_≥r_group
;

4162 
sbi
->
s_˛u°î_bôs
 = 0;

4164 
sbi
->
s_˛u°î_øtio
 = 
˛u°îsize
 / 
blocksize
;

4167 i‡(
sbi
->
s_blocks_≥r_group
 =
˛u°îsize
 << 3)

4168 
	`£t_›t2
(
sb
, 
STD_GROUP_SIZE
);

4174 
îr
 = 
	`gíîic_check_addªsßbÀ
(
sb
->
s_blocksize_bôs
,

4175 
	`pxt4_blocks_cou¡
(
es
));

4176 i‡(
îr
) {

4177 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "filesystem"

4179 
Áûed_mou¡
;

4182 i‡(
	`PXT4_BLOCKS_PER_GROUP
(
sb
) == 0)

4183 
ˇ¡föd_pxt4
;

4186 
blocks_cou¡
 = 
sb
->
s_bdev
->
bd_öode
->
i_size
 >> sb->
s_blocksize_bôs
;

4187 i‡(
blocks_cou¡
 && 
	`pxt4_blocks_cou¡
(
es
) > blocks_count) {

4188 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: block count %llu "

4190 
	`pxt4_blocks_cou¡
(
es
), 
blocks_cou¡
);

4191 
Áûed_mou¡
;

4198 i‡(
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
Ë>
	`pxt4_blocks_cou¡
(es)) {

4199 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: first data "

4201 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
),

4202 
	`pxt4_blocks_cou¡
(
es
));

4203 
Áûed_mou¡
;

4205 i‡((
es
->
s_fú°_d©a_block
 =0Ë&& (es->
s_log_block_size
 == 0) &&

4206 (
sbi
->
s_˛u°î_øtio
 == 1)) {

4207 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: first data "

4209 
Áûed_mou¡
;

4212 
blocks_cou¡
 = (
	`pxt4_blocks_cou¡
(
es
) -

4213 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
) +

4214 
	`PXT4_BLOCKS_PER_GROUP
(
sb
) - 1);

4215 
	`do_div
(
blocks_cou¡
, 
	`PXT4_BLOCKS_PER_GROUP
(
sb
));

4216 i‡(
blocks_cou¡
 > ((
uöt64_t
)1<<32Ë- 
	`PXT4_DESC_PER_BLOCK
(
sb
)) {

4217 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "groups countÅooÜarge: %u "

4219 "block†≥∏grou∞%lu)", 
sbi
->
s_groups_cou¡
,

4220 
	`pxt4_blocks_cou¡
(
es
),

4221 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
),

4222 
	`PXT4_BLOCKS_PER_GROUP
(
sb
));

4223 
Áûed_mou¡
;

4225 
sbi
->
s_groups_cou¡
 = 
blocks_cou¡
;

4226 
sbi
->
s_blockfûe_groups
 = 
	`mö_t
(
pxt4_group_t
, sbi->
s_groups_cou¡
,

4227 (
PXT4_MAX_BLOCK_FILE_PHYS
 / 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)));

4228 i‡(((
u64
)
sbi
->
s_groups_cou¡
 * sbi->
s_öodes_≥r_group
) !=

4229 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
)) {

4230 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "inodes countÇot valid: %u vs %llu",

4231 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
),

4232 ((
u64
)
sbi
->
s_groups_cou¡
 * sbi->
s_öodes_≥r_group
));

4233 
ªt
 = -
EINVAL
;

4234 
Áûed_mou¡
;

4236 
db_cou¡
 = (
sbi
->
s_groups_cou¡
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) /

4237 
	`PXT4_DESC_PER_BLOCK
(
sb
);

4238 i‡(
	`pxt4_has_„©uª_mëa_bg
(
sb
)) {

4239 i‡(
	`À32_to_˝u
(
es
->
s_fú°_mëa_bg
Ë> 
db_cou¡
) {

4240 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

4243 
	`À32_to_˝u
(
es
->
s_fú°_mëa_bg
), 
db_cou¡
);

4244 
Áûed_mou¡
;

4247 
sbi
->
s_group_desc
 = 
	`kvmÆloc_¨øy
(
db_cou¡
,

4248 (
buf„r_hód
 *),

4249 
GFP_KERNEL
);

4250 i‡(
sbi
->
s_group_desc
 =
NULL
) {

4251 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "notÉnough memory");

4252 
ªt
 = -
ENOMEM
;

4253 
Áûed_mou¡
;

4256 
	`bgl_lock_öô
(
sbi
->
s_blockgroup_lock
);

4259 
i
 = 0; i < 
db_cou¡
; i++) {

4260 
block
 = 
	`des¸ùt‹_loc
(
sb
, 
logiˇl_sb_block
, 
i
);

4261 
	`sb_bªadahód
(
sb
, 
block
);

4264 
i
 = 0; i < 
db_cou¡
; i++) {

4265 
block
 = 
	`des¸ùt‹_loc
(
sb
, 
logiˇl_sb_block
, 
i
);

4266 
sbi
->
s_group_desc
[
i
] = 
	`sb_bªad_unmovabÀ
(
sb
, 
block
);

4267 i‡(!
sbi
->
s_group_desc
[
i
]) {

4268 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4269 "ˇn'àªad grou∞des¸ùt‹ %d", 
i
);

4270 
db_cou¡
 = 
i
;

4271 
Áûed_mou¡2
;

4274 
sbi
->
s_gdb_cou¡
 = 
db_cou¡
;

4275 i‡(!
	`pxt4_check_des¸ùt‹s
(
sb
, 
logiˇl_sb_block
, &
fú°_nŸ_zî€d
)) {

4276 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "group descriptors corrupted!");

4277 
ªt
 = -
EFSCORRUPTED
;

4278 
Áûed_mou¡2
;

4281 
	`timî_£tup
(&
sbi
->
s_îr_ªp‹t
, 
¥öt_daûy_îr‹_öfo
, 0);

4284 i‡(
	`pxt4_es_ªgi°î_shrökî
(
sbi
))

4285 
Áûed_mou¡3
;

4287 
sbi
->
s_°rùe
 = 
	`pxt4_gë_°rùe_size
(sbi);

4288 
sbi
->
s_exã¡_max_zîoout_kb
 = 32;

4293 
sb
->
s_›
 = &
pxt4_s›s
;

4294 
sb
->
s_exp‹t_›
 = &
pxt4_exp‹t_›s
;

4295 
sb
->
s_x©å
 = 
pxt4_x©å_h™dÀrs
;

4296 #ifde‡
CONFIG_FS_ENCRYPTION


4297 
sb
->
s_c›
 = &
pxt4_¸y±›s
;

4299 #ifde‡
CONFIG_FS_VERITY


4300 
sb
->
s_v›
 = &
pxt4_vîôy›s
;

4302 #ifde‡
CONFIG_QUOTA


4303 
sb
->
dq_›
 = &
pxt4_quŸa_›î©i⁄s
;

4304 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
))

4305 
sb
->
s_qc›
 = &
dquŸ_quŸa˘l_sysfûe_›s
;

4307 
sb
->
s_qc›
 = &
pxt4_q˘l_›î©i⁄s
;

4308 
sb
->
s_quŸa_ty≥s
 = 
QTYPE_MASK_USR
 | 
QTYPE_MASK_GRP
 | 
QTYPE_MASK_PRJ
;

4310 
	`mem˝y
(&
sb
->
s_uuid
, 
es
->s_uuid, (es->s_uuid));

4312 
	`INIT_LIST_HEAD
(&
sbi
->
s_‹ph™
);

4313 
	`muãx_öô
(&
sbi
->
s_‹ph™_lock
);

4315 
sb
->
s_roŸ
 = 
NULL
;

4317 
√eds_ªcovîy
 = (
es
->
s_œ°_‹ph™
 != 0 ||

4318 
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
));

4320 i‡(
	`pxt4_has_„©uª_mmp
(
sb
Ë&& !
	`sb_rd⁄ly
(sb))

4321 i‡(
	`pxt4_mu…i_mou¡_¥Ÿe˘
(
sb
, 
	`À64_to_˝u
(
es
->
s_mmp_block
)))

4322 
Áûed_mou¡3a
;

4328 i‡(!
	`ã°_›t
(
sb
, 
NOLOAD
Ë&& 
	`pxt4_has_„©uª_jou∫Æ
(sb)) {

4329 
îr
 = 
	`pxt4_lﬂd_jou∫Æ
(
sb
, 
es
, 
jou∫Æ_devnum
);

4330 i‡(
îr
)

4331 
Áûed_mou¡3a
;

4332 } i‡(
	`ã°_›t
(
sb
, 
NOLOAD
Ë&& !
	`sb_rd⁄ly
(sb) &&

4333 
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
)) {

4334 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "required journalÑecovery "

4336 
Áûed_mou¡_wq
;

4339 i‡(
	`ã°_›t2
(
sb
, 
EXPLICIT_JOURNAL_CHECKSUM
)) {

4340 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4342 
Áûed_mou¡_wq
;

4344 i‡(
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

4345 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4347 
Áûed_mou¡_wq
;

4349 i‡(
sbi
->
s_commô_öãrvÆ
 !
JBD3_DEFAULT_MAX_COMMIT_AGE
*
HZ
) {

4350 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4352 
sbi
->
s_commô_öãrvÆ
 / 
HZ
);

4353 
Áûed_mou¡_wq
;

4355 i‡(
PXT4_MOUNT_DATA_FLAGS
 &

4356 (
sbi
->
s_mou¡_›t
 ^ sbi->
s_def_mou¡_›t
)) {

4357 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4359 
Áûed_mou¡_wq
;

4361 
sbi
->
s_def_mou¡_›t
 &~
PXT4_MOUNT_JOURNAL_CHECKSUM
;

4362 
	`˛ór_›t
(
sb
, 
JOURNAL_CHECKSUM
);

4363 
	`˛ór_›t
(
sb
, 
DATA_FLAGS
);

4364 
sbi
->
s_jou∫Æ
 = 
NULL
;

4365 
√eds_ªcovîy
 = 0;

4366 
no_jou∫Æ
;

4369 i‡(
	`pxt4_has_„©uª_64bô
(
sb
) &&

4370 !
	`jbd3_jou∫Æ_£t_„©uªs
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
, 0, 0,

4371 
JBD3_FEATURE_INCOMPAT_64BIT
)) {

4372 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "FailedÅo set 64-bit journal feature");

4373 
Áûed_mou¡_wq
;

4376 i‡(!
	`£t_jou∫Æ_csum_„©uª_£t
(
sb
)) {

4377 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "FailedÅo set journal checksum "

4379 
Áûed_mou¡_wq
;

4384 
	`ã°_›t
(
sb
, 
DATA_FLAGS
)) {

4390 i‡(
jbd3_jou∫Æ_check_avaûabÀ_„©uªs


4391 (
sbi
->
s_jou∫Æ
, 0, 0, 
JBD3_FEATURE_INCOMPAT_REVOKE
)) {

4392 
	`£t_›t
(
sb
, 
ORDERED_DATA
);

4393 
sbi
->
s_def_mou¡_›t
 |
PXT4_MOUNT_ORDERED_DATA
;

4395 
	`£t_›t
(
sb
, 
JOURNAL_DATA
);

4396 
sbi
->
s_def_mou¡_›t
 |
PXT4_MOUNT_JOURNAL_DATA
;

4400 
PXT4_MOUNT_ORDERED_DATA
:

4401 
PXT4_MOUNT_WRITEBACK_DATA
:

4402 i‡(!
jbd3_jou∫Æ_check_avaûabÀ_„©uªs


4403 (
sbi
->
s_jou∫Æ
, 0, 0, 
JBD3_FEATURE_INCOMPAT_REVOKE
)) {

4404 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Journal doesÇot support "

4406 
Áûed_mou¡_wq
;

4412 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
 &&

4413 
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

4414 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4416 
Áûed_mou¡_wq
;

4419 
	`£t_èsk_i›rio
(
sbi
->
s_jou∫Æ
->
j_èsk
, 
jou∫Æ_i›rio
);

4421 
sbi
->
s_jou∫Æ
->
j_commô_ˇŒback
 = 
pxt4_jou∫Æ_commô_ˇŒback
;

4423 
no_jou∫Æ
:

4424 i‡(!
	`ã°_›t
(
sb
, 
NO_MBCACHE
)) {

4425 
sbi
->
s_ó_block_ˇche
 = 
	`pxt4_x©å_¸óã_ˇche
();

4426 i‡(!
sbi
->
s_ó_block_ˇche
) {

4427 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4429 
Áûed_mou¡_wq
;

4432 i‡(
	`pxt4_has_„©uª_ó_öode
(
sb
)) {

4433 
sbi
->
s_ó_öode_ˇche
 = 
	`pxt4_x©å_¸óã_ˇche
();

4434 i‡(!
sbi
->
s_ó_öode_ˇche
) {

4435 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4437 
Áûed_mou¡_wq
;

4442 i‡((
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë|| 
	`pxt4_has_„©uª_í¸y±
(
sb
)) &&

4443 (
blocksize
 !
PAGE_SIZE
)) {

4444 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4446 
Áûed_mou¡_wq
;

4449 i‡(
	`pxt4_has_„©uª_vîôy
(
sb
Ë&& 
blocksize
 !
PAGE_SIZE
) {

4450 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Unsupported blocksize for fs-verity");

4451 
Áûed_mou¡_wq
;

4454 i‡(
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë&& !
	`sb_rd⁄ly
(
sb
) &&

4455 !
	`pxt4_has_„©uª_í¸y±
(
sb
)) {

4456 
	`pxt4_£t_„©uª_í¸y±
(
sb
);

4457 
	`pxt4_commô_su≥r
(
sb
, 1);

4464 i‡(
es
->
s_ovîhód_˛u°îs
)

4465 
sbi
->
s_ovîhód
 = 
	`À32_to_˝u
(
es
->
s_ovîhód_˛u°îs
);

4467 
îr
 = 
	`pxt4_ˇlcuœã_ovîhód
(
sb
);

4468 i‡(
îr
)

4469 
Áûed_mou¡_wq
;

4476 
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
 =

4477 
	`Æloc_w‹kqueue
("pxt4-rsv-c⁄vîsi⁄", 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 1);

4478 i‡(!
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
) {

4479 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: failedÅo create workqueue\n");

4480 
ªt
 = -
ENOMEM
;

4481 
Áûed_mou¡4
;

4489 
roŸ
 = 
	`pxt4_igë
(
sb
, 
PXT4_ROOT_INO
, 
PXT4_IGET_SPECIAL
);

4490 i‡(
	`IS_ERR
(
roŸ
)) {

4491 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "getÑoot inode failed");

4492 
ªt
 = 
	`PTR_ERR
(
roŸ
);

4493 
roŸ
 = 
NULL
;

4494 
Áûed_mou¡4
;

4496 i‡(!
	`S_ISDIR
(
roŸ
->
i_mode
Ë|| !roŸ->
i_blocks
 || !roŸ->
i_size
) {

4497 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "corruptÑoot inode,ÑunÉ2fsck");

4498 
	`ùut
(
roŸ
);

4499 
Áûed_mou¡4
;

4502 #ifde‡
CONFIG_UNICODE


4503 i‡(
sbi
->
s_ícodög
)

4504 
sb
->
s_d_›
 = &
pxt4_díåy_›s
;

4507 
sb
->
s_roŸ
 = 
	`d_make_roŸ
(
roŸ
);

4508 i‡(!
sb
->
s_roŸ
) {

4509 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "getÑoot dentry failed");

4510 
ªt
 = -
ENOMEM
;

4511 
Áûed_mou¡4
;

4514 
ªt
 = 
	`pxt4_£tup_su≥r
(
sb
, 
es
, 
	`sb_rd⁄ly
(sb));

4515 i‡(
ªt
 =-
EROFS
) {

4516 
sb
->
s_Êags
 |
SB_RDONLY
;

4517 
ªt
 = 0;

4518 } i‡(
ªt
)

4519 
Áûed_mou¡4a
;

4521 
	`pxt4_˛amp_w™t_exåa_isize
(
sb
);

4523 
	`pxt4_£t_ªsv_˛u°îs
(
sb
);

4525 
îr
 = 
	`pxt4_£tup_sy°em_z⁄e
(
sb
);

4526 i‡(
îr
) {

4527 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo initialize system "

4528 "z⁄ê(%d)", 
îr
);

4529 
Áûed_mou¡4a
;

4532 
	`pxt4_ext_öô
(
sb
);

4533 
îr
 = 
	`pxt4_mb_öô
(
sb
);

4534 i‡(
îr
) {

4535 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo initialize mballoc (%d)",

4536 
îr
);

4537 
Áûed_mou¡5
;

4540 
block
 = 
	`pxt4_cou¡_‰ì_˛u°îs
(
sb
);

4541 
	`pxt4_‰ì_blocks_cou¡_£t
(
sbi
->
s_es
,

4542 
	`PXT4_C2B
(
sbi
, 
block
));

4543 
	`pxt4_su≥rblock_csum_£t
(
sb
);

4544 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_‰ì˛u°îs_cou¡î
, 
block
,

4545 
GFP_KERNEL
);

4546 i‡(!
îr
) {

4547 
‰ìi
 = 
	`pxt4_cou¡_‰ì_öodes
(
sb
);

4548 
sbi
->
s_es
->
s_‰ì_öodes_cou¡
 = 
	`˝u_to_À32
(
‰ìi
);

4549 
	`pxt4_su≥rblock_csum_£t
(
sb
);

4550 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_‰ìöodes_cou¡î
, 
‰ìi
,

4551 
GFP_KERNEL
);

4553 i‡(!
îr
)

4554 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_dús_cou¡î
,

4555 
	`pxt4_cou¡_dús
(
sb
), 
GFP_KERNEL
);

4556 i‡(!
îr
)

4557 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 0,

4558 
GFP_KERNEL
);

4559 i‡(!
îr
)

4560 
îr
 = 
	`≥r˝u_öô_rw£m
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

4562 i‡(
îr
) {

4563 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "insufficient memory");

4564 
Áûed_mou¡6
;

4567 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
))

4568 i‡(!
	`pxt4_fûl_Êex_öfo
(
sb
)) {

4569 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4572 
Áûed_mou¡6
;

4575 
îr
 = 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
fú°_nŸ_zî€d
);

4576 i‡(
îr
)

4577 
Áûed_mou¡6
;

4579 
îr
 = 
	`pxt4_ªgi°î_sysfs
(
sb
);

4580 i‡(
îr
)

4581 
Áûed_mou¡7
;

4583 #ifde‡
CONFIG_QUOTA


4585 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
Ë&& !
	`sb_rd⁄ly
(sb)) {

4586 
îr
 = 
	`pxt4_íabÀ_quŸas
(
sb
);

4587 i‡(
îr
)

4588 
Áûed_mou¡8
;

4592 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 |
PXT4_ORPHAN_FS
;

4593 
	`pxt4_‹ph™_˛ónup
(
sb
, 
es
);

4594 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 &~
PXT4_ORPHAN_FS
;

4595 i‡(
√eds_ªcovîy
) {

4596 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "recovery complete");

4597 
	`pxt4_m¨k_ªcovîy_com∂ëe
(
sb
, 
es
);

4599 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

4600 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
)

4601 
des¸
 = " journalled data mode";

4602 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
)

4603 
des¸
 = " ordered data mode";

4605 
des¸
 = " writeback data mode";

4607 
des¸
 = "out journal";

4609 i‡(
	`ã°_›t
(
sb
, 
DISCARD
)) {

4610 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
sb
->
s_bdev
);

4611 i‡(!
	`blk_queue_disˇrd
(
q
))

4612 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

4617 i‡(
	`___øãlimô
(&
pxt4_mou¡_msg_øãlimô
, "PXT4-fs mount"))

4618 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "mounted filesystem with%s. "

4619 "O±s: %.*s%s%s", 
des¸
,

4620 (Ë(
sbi
->
s_es
->
s_mou¡_›ts
),

4621 
sbi
->
s_es
->
s_mou¡_›ts
,

4622 *
sbi
->
s_es
->
s_mou¡_›ts
 ? "; " : "", 
‹ig_d©a
);

4624 i‡(
es
->
s_îr‹_cou¡
)

4625 
	`mod_timî
(&
sbi
->
s_îr_ªp‹t
, 
jiffõs
 + 300*
HZ
);

4628 
	`øãlimô_°©e_öô
(&
sbi
->
s_îr_øãlimô_°©e
, 5 * 
HZ
, 10);

4629 
	`øãlimô_°©e_öô
(&
sbi
->
s_w¨nög_øãlimô_°©e
, 5 * 
HZ
, 10);

4630 
	`øãlimô_°©e_öô
(&
sbi
->
s_msg_øãlimô_°©e
, 5 * 
HZ
, 10);

4632 
	`k‰ì
(
‹ig_d©a
);

4635 
ˇ¡föd_pxt4
:

4636 i‡(!
sûít
)

4637 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "VFS: Can't findÖxt4 filesystem");

4638 
Áûed_mou¡
;

4640 #ifde‡
CONFIG_QUOTA


4641 
Áûed_mou¡8
:

4642 
	`pxt4_uƒegi°î_sysfs
(
sb
);

4644 
Áûed_mou¡7
:

4645 
	`pxt4_uƒegi°î_li_ªque°
(
sb
);

4646 
Áûed_mou¡6
:

4647 
	`pxt4_mb_ªÀa£
(
sb
);

4648 i‡(
sbi
->
s_Êex_groups
)

4649 
	`kv‰ì
(
sbi
->
s_Êex_groups
);

4650 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ì˛u°îs_cou¡î
);

4651 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ìöodes_cou¡î
);

4652 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dús_cou¡î
);

4653 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

4654 
	`≥r˝u_‰ì_rw£m
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

4655 
Áûed_mou¡5
:

4656 
	`pxt4_ext_ªÀa£
(
sb
);

4657 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

4658 
Áûed_mou¡4a
:

4659 
	`dput
(
sb
->
s_roŸ
);

4660 
sb
->
s_roŸ
 = 
NULL
;

4661 
Áûed_mou¡4
:

4662 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "mount failed");

4663 i‡(
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
)

4664 
	`de°roy_w‹kqueue
(
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
);

4665 
Áûed_mou¡_wq
:

4666 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_öode_ˇche
);

4667 
sbi
->
s_ó_öode_ˇche
 = 
NULL
;

4669 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_block_ˇche
);

4670 
sbi
->
s_ó_block_ˇche
 = 
NULL
;

4672 i‡(
sbi
->
s_jou∫Æ
) {

4673 
	`jbd3_jou∫Æ_de°roy
(
sbi
->
s_jou∫Æ
);

4674 
sbi
->
s_jou∫Æ
 = 
NULL
;

4676 
Áûed_mou¡3a
:

4677 
	`pxt4_es_uƒegi°î_shrökî
(
sbi
);

4678 
Áûed_mou¡3
:

4679 
	`dñ_timî_sync
(&
sbi
->
s_îr_ªp‹t
);

4680 i‡(
sbi
->
s_mmp_tsk
)

4681 
	`kthªad_°›
(
sbi
->
s_mmp_tsk
);

4682 
Áûed_mou¡2
:

4683 
i
 = 0; i < 
db_cou¡
; i++)

4684 
	`bªl£
(
sbi
->
s_group_desc
[
i
]);

4685 
	`kv‰ì
(
sbi
->
s_group_desc
);

4686 
Áûed_mou¡
:

4687 i‡(
sbi
->
s_chksum_drivî
)

4688 
	`¸y±o_‰ì_shash
(
sbi
->
s_chksum_drivî
);

4690 #ifde‡
CONFIG_UNICODE


4691 
	`utf8_u∆ﬂd
(
sbi
->
s_ícodög
);

4694 #ifde‡
CONFIG_QUOTA


4695 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

4696 
	`k‰ì
(
	`gë_qf_«me
(
sb
, 
sbi
, 
i
));

4698 
	`pxt4_blkdev_ªmove
(
sbi
);

4699 
	`bªl£
(
bh
);

4700 
out_Áû
:

4701 
sb
->
s_fs_öfo
 = 
NULL
;

4702 
	`k‰ì
(
sbi
->
s_blockgroup_lock
);

4703 
out_‰ì_ba£
:

4704 
	`k‰ì
(
sbi
);

4705 
	`k‰ì
(
‹ig_d©a
);

4706 
	`fs_put_dax
(
dax_dev
);

4707  
îr
 ?Éº : 
ªt
;

4708 
	}
}

4715 
	$pxt4_öô_jou∫Æ_∑øms
(
su≥r_block
 *
sb
, 
jou∫Æ_t
 *
jou∫Æ
)

4717 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4719 
jou∫Æ
->
j_commô_öãrvÆ
 = 
sbi
->
s_commô_öãrvÆ
;

4720 
jou∫Æ
->
j_mö_b©ch_time
 = 
sbi
->
s_mö_b©ch_time
;

4721 
jou∫Æ
->
j_max_b©ch_time
 = 
sbi
->
s_max_b©ch_time
;

4723 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

4724 i‡(
	`ã°_›t
(
sb
, 
BARRIER
))

4725 
jou∫Æ
->
j_Êags
 |
JBD3_BARRIER
;

4727 
jou∫Æ
->
j_Êags
 &~
JBD3_BARRIER
;

4728 i‡(
	`ã°_›t
(
sb
, 
DATA_ERR_ABORT
))

4729 
jou∫Æ
->
j_Êags
 |
JBD3_ABORT_ON_SYNCDATA_ERR
;

4731 
jou∫Æ
->
j_Êags
 &~
JBD3_ABORT_ON_SYNCDATA_ERR
;

4732 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

4733 
	}
}

4735 
öode
 *
	$pxt4_gë_jou∫Æ_öode
(
su≥r_block
 *
sb
,

4736 
jou∫Æ_öum
)

4738 
öode
 *
jou∫Æ_öode
;

4745 
jou∫Æ_öode
 = 
	`pxt4_igë
(
sb
, 
jou∫Æ_öum
, 
PXT4_IGET_SPECIAL
);

4746 i‡(
	`IS_ERR
(
jou∫Æ_öode
)) {

4747 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "no journal found");

4748  
NULL
;

4750 i‡(!
jou∫Æ_öode
->
i_∆ök
) {

4751 
	`make_bad_öode
(
jou∫Æ_öode
);

4752 
	`ùut
(
jou∫Æ_öode
);

4753 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "journal inode is deleted");

4754  
NULL
;

4757 
	`jbd_debug
(2, "Journal inode foundát %p: %lld bytes\n",

4758 
jou∫Æ_öode
, jou∫Æ_öode->
i_size
);

4759 i‡(!
	`S_ISREG
(
jou∫Æ_öode
->
i_mode
)) {

4760 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "invalid journal inode");

4761 
	`ùut
(
jou∫Æ_öode
);

4762  
NULL
;

4764  
jou∫Æ_öode
;

4765 
	}
}

4767 
jou∫Æ_t
 *
	$pxt4_gë_jou∫Æ
(
su≥r_block
 *
sb
,

4768 
jou∫Æ_öum
)

4770 
öode
 *
jou∫Æ_öode
;

4771 
jou∫Æ_t
 *
jou∫Æ
;

4773 
	`BUG_ON
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
));

4775 
jou∫Æ_öode
 = 
	`pxt4_gë_jou∫Æ_öode
(
sb
, 
jou∫Æ_öum
);

4776 i‡(!
jou∫Æ_öode
)

4777  
NULL
;

4779 
jou∫Æ
 = 
	`jbd3_jou∫Æ_öô_öode
(
jou∫Æ_öode
);

4780 i‡(!
jou∫Æ
) {

4781 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "CouldÇotÜoad journal inode");

4782 
	`ùut
(
jou∫Æ_öode
);

4783  
NULL
;

4785 
jou∫Æ
->
j_¥iv©e
 = 
sb
;

4786 
	`pxt4_öô_jou∫Æ_∑øms
(
sb
, 
jou∫Æ
);

4787  
jou∫Æ
;

4788 
	}
}

4790 
jou∫Æ_t
 *
	$pxt4_gë_dev_jou∫Æ
(
su≥r_block
 *
sb
,

4791 
dev_t
 
j_dev
)

4793 
buf„r_hód
 *
bh
;

4794 
jou∫Æ_t
 *
jou∫Æ
;

4795 
pxt4_fsblk_t
 
°¨t
;

4796 
pxt4_fsblk_t
 
Àn
;

4797 
hblock
, 
blocksize
;

4798 
pxt4_fsblk_t
 
sb_block
;

4799 
off£t
;

4800 
pxt4_su≥r_block
 *
es
;

4801 
block_devi˚
 *
bdev
;

4803 
	`BUG_ON
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
));

4805 
bdev
 = 
	`pxt4_blkdev_gë
(
j_dev
, 
sb
);

4806 i‡(
bdev
 =
NULL
)

4807  
NULL
;

4809 
blocksize
 = 
sb
->
s_blocksize
;

4810 
hblock
 = 
	`bdev_logiˇl_block_size
(
bdev
);

4811 i‡(
blocksize
 < 
hblock
) {

4812 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4814 
out_bdev
;

4817 
sb_block
 = 
PXT4_MIN_BLOCK_SIZE
 / 
blocksize
;

4818 
off£t
 = 
PXT4_MIN_BLOCK_SIZE
 % 
blocksize
;

4819 
	`£t_blocksize
(
bdev
, 
blocksize
);

4820 i‡(!(
bh
 = 
	`__bªad
(
bdev
, 
sb_block
, 
blocksize
))) {

4821 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn'tÑead superblock of "

4823 
out_bdev
;

4826 
es
 = (
pxt4_su≥r_block
 *Ë(
bh
->
b_d©a
 + 
off£t
);

4827 i‡((
	`À16_to_˝u
(
es
->
s_magic
Ë!
PXT4_SUPER_MAGIC
) ||

4828 !(
	`À32_to_˝u
(
es
->
s_„©uª_öcom∑t
) &

4829 
PXT4_FEATURE_INCOMPAT_JOURNAL_DEV
)) {

4830 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "external journal has "

4832 
	`bªl£
(
bh
);

4833 
out_bdev
;

4836 i‡((
	`À32_to_˝u
(
es
->
s_„©uª_ro_com∑t
) &

4837 
PXT4_FEATURE_RO_COMPAT_METADATA_CSUM
) &&

4838 
es
->
s_checksum
 !
	`pxt4_su≥rblock_csum
(
sb
,És)) {

4839 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "external journal has "

4841 
	`bªl£
(
bh
);

4842 
out_bdev
;

4845 i‡(
	`memcmp
(
	`PXT4_SB
(
sb
)->
s_es
->
s_jou∫Æ_uuid
, 
es
->
s_uuid
, 16)) {

4846 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "journal UUID doesÇot match");

4847 
	`bªl£
(
bh
);

4848 
out_bdev
;

4851 
Àn
 = 
	`pxt4_blocks_cou¡
(
es
);

4852 
°¨t
 = 
sb_block
 + 1;

4853 
	`bªl£
(
bh
);

4855 
jou∫Æ
 = 
	`jbd3_jou∫Æ_öô_dev
(
bdev
, 
sb
->
s_bdev
,

4856 
°¨t
, 
Àn
, 
blocksize
);

4857 i‡(!
jou∫Æ
) {

4858 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo create device journal");

4859 
out_bdev
;

4861 
jou∫Æ
->
j_¥iv©e
 = 
sb
;

4862 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1, &
jou∫Æ
->
j_sb_buf„r
);

4863 
	`waô_⁄_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

4864 i‡(!
	`buf„r_u±od©e
(
jou∫Æ
->
j_sb_buf„r
)) {

4865 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "I/OÉrror on journal device");

4866 
out_jou∫Æ
;

4868 i‡(
	`be32_to_˝u
(
jou∫Æ
->
j_su≥rblock
->
s_ƒ_u£rs
) != 1) {

4869 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "External journal has moreÅhan one "

4871 
	`be32_to_˝u
(
jou∫Æ
->
j_su≥rblock
->
s_ƒ_u£rs
));

4872 
out_jou∫Æ
;

4874 
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
 = 
bdev
;

4875 
	`pxt4_öô_jou∫Æ_∑øms
(
sb
, 
jou∫Æ
);

4876  
jou∫Æ
;

4878 
out_jou∫Æ
:

4879 
	`jbd3_jou∫Æ_de°roy
(
jou∫Æ
);

4880 
out_bdev
:

4881 
	`pxt4_blkdev_put
(
bdev
);

4882  
NULL
;

4883 
	}
}

4885 
	$pxt4_lﬂd_jou∫Æ
(
su≥r_block
 *
sb
,

4886 
pxt4_su≥r_block
 *
es
,

4887 
jou∫Æ_devnum
)

4889 
jou∫Æ_t
 *
jou∫Æ
;

4890 
jou∫Æ_öum
 = 
	`À32_to_˝u
(
es
->
s_jou∫Æ_öum
);

4891 
dev_t
 
jou∫Æ_dev
;

4892 
îr
 = 0;

4893 
ªÆly_ªad_⁄ly
;

4895 
	`BUG_ON
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
));

4897 i‡(
jou∫Æ_devnum
 &&

4898 
jou∫Æ_devnum
 !
	`À32_to_˝u
(
es
->
s_jou∫Æ_dev
)) {

4899 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "external journal device major/minor "

4901 
jou∫Æ_dev
 = 
	`√w_decode_dev
(
jou∫Æ_devnum
);

4903 
jou∫Æ_dev
 = 
	`√w_decode_dev
(
	`À32_to_˝u
(
es
->
s_jou∫Æ_dev
));

4905 
ªÆly_ªad_⁄ly
 = 
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
);

4912 i‡(
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
)) {

4913 i‡(
	`sb_rd⁄ly
(
sb
)) {

4914 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "INFO:Ñecovery "

4916 i‡(
ªÆly_ªad_⁄ly
) {

4917 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "writeáccess "

4920  -
EROFS
;

4922 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "writeáccess will "

4927 i‡(
jou∫Æ_öum
 && 
jou∫Æ_dev
) {

4928 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "filesystem has both journal "

4930  -
EINVAL
;

4933 i‡(
jou∫Æ_öum
) {

4934 i‡(!(
jou∫Æ
 = 
	`pxt4_gë_jou∫Æ
(
sb
, 
jou∫Æ_öum
)))

4935  -
EINVAL
;

4937 i‡(!(
jou∫Æ
 = 
	`pxt4_gë_dev_jou∫Æ
(
sb
, 
jou∫Æ_dev
)))

4938  -
EINVAL
;

4941 i‡(!(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
))

4942 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "barriers disabled");

4944 i‡(!
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
))

4945 
îr
 = 
	`jbd3_jou∫Æ_wùe
(
jou∫Æ
, !
ªÆly_ªad_⁄ly
);

4946 i‡(!
îr
) {

4947 *
ßve
 = 
	`kmÆloc
(
PXT4_S_ERR_LEN
, 
GFP_KERNEL
);

4948 i‡(
ßve
)

4949 
	`mem˝y
(
ßve
, ((*Ë
es
) +

4950 
PXT4_S_ERR_START
, 
PXT4_S_ERR_LEN
);

4951 
îr
 = 
	`jbd3_jou∫Æ_lﬂd
(
jou∫Æ
);

4952 i‡(
ßve
)

4953 
	`mem˝y
(((*Ë
es
Ë+ 
PXT4_S_ERR_START
,

4954 
ßve
, 
PXT4_S_ERR_LEN
);

4955 
	`k‰ì
(
ßve
);

4958 i‡(
îr
) {

4959 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "errorÜoading journal");

4960 
	`jbd3_jou∫Æ_de°roy
(
jou∫Æ
);

4961  
îr
;

4964 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 = 
jou∫Æ
;

4965 
	`pxt4_˛ór_jou∫Æ_îr
(
sb
, 
es
);

4967 i‡(!
ªÆly_ªad_⁄ly
 && 
jou∫Æ_devnum
 &&

4968 
jou∫Æ_devnum
 !
	`À32_to_˝u
(
es
->
s_jou∫Æ_dev
)) {

4969 
es
->
s_jou∫Æ_dev
 = 
	`˝u_to_À32
(
jou∫Æ_devnum
);

4972 
	`pxt4_commô_su≥r
(
sb
, 1);

4976 
	}
}

4978 
	$pxt4_commô_su≥r
(
su≥r_block
 *
sb
, 
sync
)

4980 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

4981 
buf„r_hód
 *
sbh
 = 
	`PXT4_SB
(
sb
)->
s_sbh
;

4982 
îr‹
 = 0;

4984 i‡(!
sbh
 || 
	`block_devi˚_eje˘ed
(
sb
))

4985  
îr‹
;

4991 i‡(!
	`buf„r_m≠≥d
(
sbh
))

4992  
îr‹
;

5004 i‡(!(
sb
->
s_Êags
 & 
SB_RDONLY
))

5005 
	`pxt4_upd©e_t°amp
(
es
, 
s_wtime
);

5006 i‡(
sb
->
s_bdev
->
bd_∑π
)

5007 
es
->
s_kbyãs_wrôãn
 =

5008 
	`˝u_to_À64
(
	`PXT4_SB
(
sb
)->
s_kbyãs_wrôãn
 +

5009 ((
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
,

5010 
£˘‹s
[
STAT_WRITE
]) -

5011 
	`PXT4_SB
(
sb
)->
s_£˘‹s_wrôãn_°¨t
) >> 1));

5013 
es
->
s_kbyãs_wrôãn
 =

5014 
	`˝u_to_À64
(
	`PXT4_SB
(
sb
)->
s_kbyãs_wrôãn
);

5015 i‡(
	`≥r˝u_cou¡î_öôülized
(&
	`PXT4_SB
(
sb
)->
s_‰ì˛u°îs_cou¡î
))

5016 
	`pxt4_‰ì_blocks_cou¡_£t
(
es
,

5017 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
	`≥r˝u_cou¡î_sum_posôive
(

5018 &
	`PXT4_SB
(
sb
)->
s_‰ì˛u°îs_cou¡î
)));

5019 i‡(
	`≥r˝u_cou¡î_öôülized
(&
	`PXT4_SB
(
sb
)->
s_‰ìöodes_cou¡î
))

5020 
es
->
s_‰ì_öodes_cou¡
 =

5021 
	`˝u_to_À32
(
	`≥r˝u_cou¡î_sum_posôive
(

5022 &
	`PXT4_SB
(
sb
)->
s_‰ìöodes_cou¡î
));

5023 
	`BUFFER_TRACE
(
sbh
, "marking dirty");

5024 
	`pxt4_su≥rblock_csum_£t
(
sb
);

5025 i‡(
sync
)

5026 
	`lock_buf„r
(
sbh
);

5027 i‡(
	`buf„r_wrôe_io_îr‹
(
sbh
Ë|| !
	`buf„r_u±od©e
(sbh)) {

5036 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "previous I/OÉrrorÅo "

5038 
	`˛ór_buf„r_wrôe_io_îr‹
(
sbh
);

5039 
	`£t_buf„r_u±od©e
(
sbh
);

5041 
	`m¨k_buf„r_dúty
(
sbh
);

5042 i‡(
sync
) {

5043 
	`u∆ock_buf„r
(
sbh
);

5044 
îr‹
 = 
	`__sync_dúty_buf„r
(
sbh
,

5045 
REQ_SYNC
 | (
	`ã°_›t
(
sb
, 
BARRIER
Ë? 
REQ_FUA
 : 0));

5046 i‡(
	`buf„r_wrôe_io_îr‹
(
sbh
)) {

5047 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "I/OÉrror while writing "

5049 
	`˛ór_buf„r_wrôe_io_îr‹
(
sbh
);

5050 
	`£t_buf„r_u±od©e
(
sbh
);

5053  
îr‹
;

5054 
	}
}

5061 
	$pxt4_m¨k_ªcovîy_com∂ëe
(
su≥r_block
 *
sb
,

5062 
pxt4_su≥r_block
 *
es
)

5064 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5066 i‡(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
)) {

5067 
	`BUG_ON
(
jou∫Æ
 !
NULL
);

5070 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

5071 i‡(
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
) < 0)

5072 
out
;

5074 i‡(
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
Ë&& 
	`sb_rd⁄ly
(sb)) {

5075 
	`pxt4_˛ór_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

5076 
	`pxt4_commô_su≥r
(
sb
, 1);

5079 
out
:

5080 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

5081 
	}
}

5088 
	$pxt4_˛ór_jou∫Æ_îr
(
su≥r_block
 *
sb
,

5089 
pxt4_su≥r_block
 *
es
)

5091 
jou∫Æ_t
 *
jou∫Æ
;

5092 
j_î∫o
;

5093 c⁄° *
îr°r
;

5095 
	`BUG_ON
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
));

5097 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5104 
j_î∫o
 = 
	`jbd3_jou∫Æ_î∫o
(
jou∫Æ
);

5105 i‡(
j_î∫o
) {

5106 
nbuf
[16];

5108 
îr°r
 = 
	`pxt4_decode_îr‹
(
sb
, 
j_î∫o
, 
nbuf
);

5109 
	`pxt4_w¨nög
(
sb
, "FilesystemÉrrorÑecorded "

5110 "‰omÖªviou†mou¡: %s", 
îr°r
);

5111 
	`pxt4_w¨nög
(
sb
, "Marking fs inÇeed of filesystem check.");

5113 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 |
PXT4_ERROR_FS
;

5114 
es
->
s_°©e
 |
	`˝u_to_À16
(
PXT4_ERROR_FS
);

5115 
	`pxt4_commô_su≥r
(
sb
, 1);

5117 
	`jbd3_jou∫Æ_˛ór_îr
(
jou∫Æ
);

5118 
	`jbd3_jou∫Æ_upd©e_sb_î∫o
(
jou∫Æ
);

5120 
	}
}

5126 
	$pxt4_f‹˚_commô
(
su≥r_block
 *
sb
)

5128 
jou∫Æ_t
 *
jou∫Æ
;

5130 i‡(
	`sb_rd⁄ly
(
sb
))

5133 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5134  
	`pxt4_jou∫Æ_f‹˚_commô
(
jou∫Æ
);

5135 
	}
}

5137 
	$pxt4_sync_fs
(
su≥r_block
 *
sb
, 
waô
)

5139 
ªt
 = 0;

5140 
tid_t
 
èrgë
;

5141 
boﬁ
 
√eds_b¨rõr
 = 
Ál£
;

5142 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5144 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
sbi
)))

5147 
	`åa˚_pxt4_sync_fs
(
sb
, 
waô
);

5148 
	`Êush_w‹kqueue
(
sbi
->
rsv_c⁄vîsi⁄_wq
);

5153 
	`dquŸ_wrôeback_dquŸs
(
sb
, -1);

5159 i‡(
sbi
->
s_jou∫Æ
) {

5160 
èrgë
 = 
	`jbd3_gë_œã°_å™ß˘i⁄
(
sbi
->
s_jou∫Æ
);

5161 i‡(
waô
 && 
sbi
->
s_jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
 &&

5162 !
	`jbd3_å™s_wûl_£nd_d©a_b¨rõr
(
sbi
->
s_jou∫Æ
, 
èrgë
))

5163 
√eds_b¨rõr
 = 
åue
;

5165 i‡(
	`jbd3_jou∫Æ_°¨t_commô
(
sbi
->
s_jou∫Æ
, &
èrgë
)) {

5166 i‡(
waô
)

5167 
ªt
 = 
	`jbd3_log_waô_commô
(
sbi
->
s_jou∫Æ
,

5168 
èrgë
);

5170 } i‡(
waô
 && 
	`ã°_›t
(
sb
, 
BARRIER
))

5171 
√eds_b¨rõr
 = 
åue
;

5172 i‡(
√eds_b¨rõr
) {

5173 
îr
;

5174 
îr
 = 
	`blkdev_issue_Êush
(
sb
->
s_bdev
, 
GFP_KERNEL
, 
NULL
);

5175 i‡(!
ªt
)

5176 
ªt
 = 
îr
;

5179  
ªt
;

5180 
	}
}

5190 
	$pxt4_‰ìze
(
su≥r_block
 *
sb
)

5192 
îr‹
 = 0;

5193 
jou∫Æ_t
 *
jou∫Æ
;

5195 i‡(
	`sb_rd⁄ly
(
sb
))

5198 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5200 i‡(
jou∫Æ
) {

5202 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

5208 
îr‹
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

5209 i‡(
îr‹
 < 0)

5210 
out
;

5213 
	`pxt4_˛ór_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

5216 
îr‹
 = 
	`pxt4_commô_su≥r
(
sb
, 1);

5217 
out
:

5218 i‡(
jou∫Æ
)

5220 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

5221  
îr‹
;

5222 
	}
}

5228 
	$pxt4_un‰ìze
(
su≥r_block
 *
sb
)

5230 i‡(
	`sb_rd⁄ly
(
sb
Ë|| 
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(sb)))

5233 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

5235 
	`pxt4_£t_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

5238 
	`pxt4_commô_su≥r
(
sb
, 1);

5240 
	}
}

5245 
	spxt4_mou¡_›ti⁄s
 {

5246 
	ms_mou¡_›t
;

5247 
	ms_mou¡_›t2
;

5248 
kuid_t
 
	ms_ªsuid
;

5249 
kgid_t
 
	ms_ªsgid
;

5250 
	ms_commô_öãrvÆ
;

5251 
u32
 
	ms_mö_b©ch_time
, 
	ms_max_b©ch_time
;

5252 #ifde‡
CONFIG_QUOTA


5253 
	ms_jquŸa_fmt
;

5254 *
	ms_qf_«mes
[
PXT4_MAXQUOTAS
];

5258 
	$pxt4_ªmou¡
(
su≥r_block
 *
sb
, *
Êags
, *
d©a
)

5260 
pxt4_su≥r_block
 *
es
;

5261 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5262 
ﬁd_sb_Êags
;

5263 
pxt4_mou¡_›ti⁄s
 
ﬁd_›ts
;

5264 
íabÀ_quŸa
 = 0;

5265 
pxt4_group_t
 
g
;

5266 
jou∫Æ_i›rio
 = 
DEFAULT_JOURNAL_IOPRIO
;

5267 
îr
 = 0;

5268 #ifde‡
CONFIG_QUOTA


5269 
i
, 
j
;

5270 *
to_‰ì
[
PXT4_MAXQUOTAS
];

5272 *
‹ig_d©a
 = 
	`k°rdup
(
d©a
, 
GFP_KERNEL
);

5274 i‡(
d©a
 && !
‹ig_d©a
)

5275  -
ENOMEM
;

5278 
ﬁd_sb_Êags
 = 
sb
->
s_Êags
;

5279 
ﬁd_›ts
.
s_mou¡_›t
 = 
sbi
->s_mount_opt;

5280 
ﬁd_›ts
.
s_mou¡_›t2
 = 
sbi
->s_mount_opt2;

5281 
ﬁd_›ts
.
s_ªsuid
 = 
sbi
->s_resuid;

5282 
ﬁd_›ts
.
s_ªsgid
 = 
sbi
->s_resgid;

5283 
ﬁd_›ts
.
s_commô_öãrvÆ
 = 
sbi
->s_commit_interval;

5284 
ﬁd_›ts
.
s_mö_b©ch_time
 = 
sbi
->s_min_batch_time;

5285 
ﬁd_›ts
.
s_max_b©ch_time
 = 
sbi
->s_max_batch_time;

5286 #ifde‡
CONFIG_QUOTA


5287 
ﬁd_›ts
.
s_jquŸa_fmt
 = 
sbi
->s_jquota_fmt;

5288 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

5289 i‡(
sbi
->
s_qf_«mes
[
i
]) {

5290 *
qf_«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
i
);

5292 
ﬁd_›ts
.
s_qf_«mes
[
i
] = 
	`k°rdup
(
qf_«me
, 
GFP_KERNEL
);

5293 i‡(!
ﬁd_›ts
.
s_qf_«mes
[
i
]) {

5294 
j
 = 0; j < 
i
; j++)

5295 
	`k‰ì
(
ﬁd_›ts
.
s_qf_«mes
[
j
]);

5296 
	`k‰ì
(
‹ig_d©a
);

5297  -
ENOMEM
;

5300 
ﬁd_›ts
.
s_qf_«mes
[
i
] = 
NULL
;

5302 i‡(
sbi
->
s_jou∫Æ
 && sbi->s_jou∫Æ->
j_èsk
->
io_c⁄ãxt
)

5303 
jou∫Æ_i›rio
 = 
sbi
->
s_jou∫Æ
->
j_èsk
->
io_c⁄ãxt
->
i›rio
;

5305 i‡(!
	`∑r£_›ti⁄s
(
d©a
, 
sb
, 
NULL
, &
jou∫Æ_i›rio
, 1)) {

5306 
îr
 = -
EINVAL
;

5307 
ª°‹e_›ts
;

5310 
	`pxt4_˛amp_w™t_exåa_isize
(
sb
);

5312 i‡((
ﬁd_›ts
.
s_mou¡_›t
 & 
PXT4_MOUNT_JOURNAL_CHECKSUM
) ^

5313 
	`ã°_›t
(
sb
, 
JOURNAL_CHECKSUM
)) {

5314 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "changing journal_checksum "

5316 
sbi
->
s_mou¡_›t
 ^
PXT4_MOUNT_JOURNAL_CHECKSUM
;

5319 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
) {

5320 i‡(
	`ã°_›t2
(
sb
, 
EXPLICIT_DELALLOC
)) {

5321 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5323 
îr
 = -
EINVAL
;

5324 
ª°‹e_›ts
;

5326 i‡(
	`ã°_›t
(
sb
, 
DIOREAD_NOLOCK
)) {

5327 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5329 
îr
 = -
EINVAL
;

5330 
ª°‹e_›ts
;

5332 i‡(
	`ã°_›t
(
sb
, 
DAX
)) {

5333 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5335 
îr
 = -
EINVAL
;

5336 
ª°‹e_›ts
;

5338 } i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
) {

5339 i‡(
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

5340 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5342 
îr
 = -
EINVAL
;

5343 
ª°‹e_›ts
;

5347 i‡((
sbi
->
s_mou¡_›t
 ^ 
ﬁd_›ts
.s_mou¡_›tË& 
PXT4_MOUNT_NO_MBCACHE
) {

5348 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tÉnableÇombcache duringÑemount");

5349 
îr
 = -
EINVAL
;

5350 
ª°‹e_›ts
;

5353 i‡((
sbi
->
s_mou¡_›t
 ^ 
ﬁd_›ts
.s_mou¡_›tË& 
PXT4_MOUNT_DAX
) {

5354 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "warning:Ñefusing change of "

5356 
sbi
->
s_mou¡_›t
 ^
PXT4_MOUNT_DAX
;

5359 i‡(
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)

5360 
	`pxt4_ab‹t
(
sb
, "Abort forced by user");

5362 
sb
->
s_Êags
 = (sb->s_Êag†& ~
SB_POSIXACL
) |

5363 (
	`ã°_›t
(
sb
, 
POSIX_ACL
Ë? 
SB_POSIXACL
 : 0);

5365 
es
 = 
sbi
->
s_es
;

5367 i‡(
sbi
->
s_jou∫Æ
) {

5368 
	`pxt4_öô_jou∫Æ_∑øms
(
sb
, 
sbi
->
s_jou∫Æ
);

5369 
	`£t_èsk_i›rio
(
sbi
->
s_jou∫Æ
->
j_èsk
, 
jou∫Æ_i›rio
);

5372 i‡(*
Êags
 & 
SB_LAZYTIME
)

5373 
sb
->
s_Êags
 |
SB_LAZYTIME
;

5375 i‡((
boﬁ
)(*
Êags
 & 
SB_RDONLY
Ë!
	`sb_rd⁄ly
(
sb
)) {

5376 i‡(
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
) {

5377 
îr
 = -
EROFS
;

5378 
ª°‹e_›ts
;

5381 i‡(*
Êags
 & 
SB_RDONLY
) {

5382 
îr
 = 
	`sync_fûesy°em
(
sb
);

5383 i‡(
îr
 < 0)

5384 
ª°‹e_›ts
;

5385 
îr
 = 
	`dquŸ_su•íd
(
sb
, -1);

5386 i‡(
îr
 < 0)

5387 
ª°‹e_›ts
;

5393 
sb
->
s_Êags
 |
SB_RDONLY
;

5400 i‡(!(
es
->
s_°©e
 & 
	`˝u_to_À16
(
PXT4_VALID_FS
)) &&

5401 (
sbi
->
s_mou¡_°©e
 & 
PXT4_VALID_FS
))

5402 
es
->
s_°©e
 = 
	`˝u_to_À16
(
sbi
->
s_mou¡_°©e
);

5404 i‡(
sbi
->
s_jou∫Æ
)

5405 
	`pxt4_m¨k_ªcovîy_com∂ëe
(
sb
, 
es
);

5406 i‡(
sbi
->
s_mmp_tsk
)

5407 
	`kthªad_°›
(
sbi
->
s_mmp_tsk
);

5410 i‡(
	`pxt4_has_„©uª_ªad⁄ly
(
sb
) ||

5411 !
	`pxt4_„©uª_£t_ok
(
sb
, 0)) {

5412 
îr
 = -
EROFS
;

5413 
ª°‹e_›ts
;

5419 
g
 = 0; g < 
sbi
->
s_groups_cou¡
; g++) {

5420 
pxt4_group_desc
 *
gdp
 =

5421 
	`pxt4_gë_group_desc
(
sb
, 
g
, 
NULL
);

5423 i‡(!
	`pxt4_group_desc_csum_vîify
(
sb
, 
g
, 
gdp
)) {

5424 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

5426 
g
, 
	`À16_to_˝u
(
	`pxt4_group_desc_csum
(
sb
, g, 
gdp
)),

5427 
	`À16_to_˝u
(
gdp
->
bg_checksum
));

5428 
îr
 = -
EFSBADCRC
;

5429 
ª°‹e_›ts
;

5438 i‡(
es
->
s_œ°_‹ph™
) {

5439 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Couldn't "

5443 
îr
 = -
EINVAL
;

5444 
ª°‹e_›ts
;

5453 i‡(
sbi
->
s_jou∫Æ
)

5454 
	`pxt4_˛ór_jou∫Æ_îr
(
sb
, 
es
);

5455 
sbi
->
s_mou¡_°©e
 = 
	`À16_to_˝u
(
es
->
s_°©e
);

5457 
îr
 = 
	`pxt4_£tup_su≥r
(
sb
, 
es
, 0);

5458 i‡(
îr
)

5459 
ª°‹e_›ts
;

5461 
sb
->
s_Êags
 &~
SB_RDONLY
;

5462 i‡(
	`pxt4_has_„©uª_mmp
(
sb
))

5463 i‡(
	`pxt4_mu…i_mou¡_¥Ÿe˘
(
sb
,

5464 
	`À64_to_˝u
(
es
->
s_mmp_block
))) {

5465 
îr
 = -
EROFS
;

5466 
ª°‹e_›ts
;

5468 
íabÀ_quŸa
 = 1;

5476 i‡(
	`sb_rd⁄ly
(
sb
Ë|| !
	`ã°_›t
(sb, 
INIT_INODE_TABLE
))

5477 
	`pxt4_uƒegi°î_li_ªque°
(
sb
);

5479 
pxt4_group_t
 
fú°_nŸ_zî€d
;

5480 
fú°_nŸ_zî€d
 = 
	`pxt4_has_unöô_ôabÀ
(
sb
);

5481 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
fú°_nŸ_zî€d
);

5484 
	`pxt4_£tup_sy°em_z⁄e
(
sb
);

5485 i‡(
sbi
->
s_jou∫Æ
 =
NULL
 && !(
ﬁd_sb_Êags
 & 
SB_RDONLY
)) {

5486 
îr
 = 
	`pxt4_commô_su≥r
(
sb
, 1);

5487 i‡(
îr
)

5488 
ª°‹e_›ts
;

5491 #ifde‡
CONFIG_QUOTA


5493 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

5494 
	`k‰ì
(
ﬁd_›ts
.
s_qf_«mes
[
i
]);

5495 i‡(
íabÀ_quŸa
) {

5496 i‡(
	`sb_™y_quŸa_su•íded
(
sb
))

5497 
	`dquŸ_ªsume
(
sb
, -1);

5498 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
)) {

5499 
îr
 = 
	`pxt4_íabÀ_quŸas
(
sb
);

5500 i‡(
îr
)

5501 
ª°‹e_›ts
;

5506 *
Êags
 = (*Êag†& ~
SB_LAZYTIME
Ë| (
sb
->
s_Êags
 & SB_LAZYTIME);

5507 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "ª-mou¡ed. O±s: %s", 
‹ig_d©a
);

5508 
	`k‰ì
(
‹ig_d©a
);

5511 
ª°‹e_›ts
:

5512 
sb
->
s_Êags
 = 
ﬁd_sb_Êags
;

5513 
sbi
->
s_mou¡_›t
 = 
ﬁd_›ts
.s_mount_opt;

5514 
sbi
->
s_mou¡_›t2
 = 
ﬁd_›ts
.s_mount_opt2;

5515 
sbi
->
s_ªsuid
 = 
ﬁd_›ts
.s_resuid;

5516 
sbi
->
s_ªsgid
 = 
ﬁd_›ts
.s_resgid;

5517 
sbi
->
s_commô_öãrvÆ
 = 
ﬁd_›ts
.s_commit_interval;

5518 
sbi
->
s_mö_b©ch_time
 = 
ﬁd_›ts
.s_min_batch_time;

5519 
sbi
->
s_max_b©ch_time
 = 
ﬁd_›ts
.s_max_batch_time;

5520 #ifde‡
CONFIG_QUOTA


5521 
sbi
->
s_jquŸa_fmt
 = 
ﬁd_›ts
.s_jquota_fmt;

5522 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++) {

5523 
to_‰ì
[
i
] = 
	`gë_qf_«me
(
sb
, 
sbi
, i);

5524 
	`rcu_assign_poöãr
(
sbi
->
s_qf_«mes
[
i
], 
ﬁd_›ts
.s_qf_names[i]);

5526 
	`synchr⁄ize_rcu
();

5527 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

5528 
	`k‰ì
(
to_‰ì
[
i
]);

5530 
	`k‰ì
(
‹ig_d©a
);

5531  
îr
;

5532 
	}
}

5534 #ifde‡
CONFIG_QUOTA


5535 
	$pxt4_°©fs_¥oje˘
(
su≥r_block
 *
sb
,

5536 
k¥ojid_t
 
¥ojid
, 
k°©fs
 *
buf
)

5538 
kqid
 
qid
;

5539 
dquŸ
 *dquot;

5540 
u64
 
limô
;

5541 
u64
 
curblock
;

5543 
qid
 = 
	`make_kqid_¥ojid
(
¥ojid
);

5544 
dquŸ
 = 
	`dqgë
(
sb
, 
qid
);

5545 i‡(
	`IS_ERR
(
dquŸ
))

5546  
	`PTR_ERR
(
dquŸ
);

5547 
	`•ö_lock
(&
dquŸ
->
dq_dqb_lock
);

5549 
limô
 = (
dquŸ
->
dq_dqb
.
dqb_bso·limô
 ?

5550 
dquŸ
->
dq_dqb
.
dqb_bso·limô
 :

5551 
dquŸ
->
dq_dqb
.
dqb_bh¨dlimô
Ë>> 
sb
->
s_blocksize_bôs
;

5552 i‡(
limô
 && 
buf
->
f_blocks
 >Üimit) {

5553 
curblock
 = (
dquŸ
->
dq_dqb
.
dqb_cur•a˚
 +

5554 
dquŸ
->
dq_dqb
.
dqb_rsv•a˚
Ë>> 
sb
->
s_blocksize_bôs
;

5555 
buf
->
f_blocks
 = 
limô
;

5556 
buf
->
f_b‰ì
 = buf->
f_bavaû
 =

5557 (
buf
->
f_blocks
 > 
curblock
) ?

5558 (
buf
->
f_blocks
 - 
curblock
) : 0;

5561 
limô
 = 
dquŸ
->
dq_dqb
.
dqb_iso·limô
 ?

5562 
dquŸ
->
dq_dqb
.
dqb_iso·limô
 :

5563 
dquŸ
->
dq_dqb
.
dqb_ih¨dlimô
;

5564 i‡(
limô
 && 
buf
->
f_fûes
 >Üimit) {

5565 
buf
->
f_fûes
 = 
limô
;

5566 
buf
->
f_f‰ì
 =

5567 (
buf
->
f_fûes
 > 
dquŸ
->
dq_dqb
.
dqb_curöodes
) ?

5568 (
buf
->
f_fûes
 - 
dquŸ
->
dq_dqb
.
dqb_curöodes
) : 0;

5571 
	`•ö_u∆ock
(&
dquŸ
->
dq_dqb_lock
);

5572 
	`dqput
(
dquŸ
);

5574 
	}
}

5577 
	$pxt4_°©fs
(
díåy
 *díåy, 
k°©fs
 *
buf
)

5579 
su≥r_block
 *
sb
 = 
díåy
->
d_sb
;

5580 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5581 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

5582 
pxt4_fsblk_t
 
ovîhód
 = 0, 
ªsv_blocks
;

5583 
u64
 
fsid
;

5584 
s64
 
b‰ì
;

5585 
ªsv_blocks
 = 
	`PXT4_C2B
(
sbi
, 
	`©omic64_ªad
(&sbi->
s_ªsv_˛u°îs
));

5587 i‡(!
	`ã°_›t
(
sb
, 
MINIX_DF
))

5588 
ovîhód
 = 
sbi
->
s_ovîhód
;

5590 
buf
->
f_ty≥
 = 
PXT4_SUPER_MAGIC
;

5591 
buf
->
f_bsize
 = 
sb
->
s_blocksize
;

5592 
buf
->
f_blocks
 = 
	`pxt4_blocks_cou¡
(
es
Ë- 
	`PXT4_C2B
(
sbi
, 
ovîhód
);

5593 
b‰ì
 = 
	`≥r˝u_cou¡î_sum_posôive
(&
sbi
->
s_‰ì˛u°îs_cou¡î
) -

5594 
	`≥r˝u_cou¡î_sum_posôive
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

5596 
buf
->
f_b‰ì
 = 
	`PXT4_C2B
(
sbi
, 
	`max_t
(
s64
, 
b‰ì
, 0));

5597 
buf
->
f_bavaû
 = buf->
f_b‰ì
 -

5598 (
	`pxt4_r_blocks_cou¡
(
es
Ë+ 
ªsv_blocks
);

5599 i‡(
buf
->
f_b‰ì
 < (
	`pxt4_r_blocks_cou¡
(
es
Ë+ 
ªsv_blocks
))

5600 
buf
->
f_bavaû
 = 0;

5601 
buf
->
f_fûes
 = 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
);

5602 
buf
->
f_f‰ì
 = 
	`≥r˝u_cou¡î_sum_posôive
(&
sbi
->
s_‰ìöodes_cou¡î
);

5603 
buf
->
f_«mñí
 = 
PXT4_NAME_LEN
;

5604 
fsid
 = 
	`À64_to_˝up
((*)
es
->
s_uuid
) ^

5605 
	`À64_to_˝up
((*)
es
->
s_uuid
 + (
u64
));

5606 
buf
->
f_fsid
.
vÆ
[0] = 
fsid
 & 0xFFFFFFFFUL;

5607 
buf
->
f_fsid
.
vÆ
[1] = (
fsid
 >> 32) & 0xFFFFFFFFUL;

5609 #ifde‡
CONFIG_QUOTA


5610 i‡(
	`pxt4_ã°_öode_Êag
(
díåy
->
d_öode
, 
PXT4_INODE_PROJINHERIT
) &&

5611 
	`sb_has_quŸa_limôs_íabÀd
(
sb
, 
PRJQUOTA
))

5612 
	`pxt4_°©fs_¥oje˘
(
sb
, 
	`PXT4_I
(
díåy
->
d_öode
)->
i_¥ojid
, 
buf
);

5615 
	}
}

5618 #ifde‡
CONFIG_QUOTA


5624 
ölöe
 
öode
 *
	$dquŸ_to_öode
(
dquŸ
 *dquot)

5626  
	`sb_dq›t
(
dquŸ
->
dq_sb
)->
fûes
[dquŸ->
dq_id
.
ty≥
];

5627 
	}
}

5629 
	$pxt4_wrôe_dquŸ
(
dquŸ
 *dquot)

5631 
ªt
, 
îr
;

5632 
h™dÀ_t
 *
h™dÀ
;

5633 
öode
 *inode;

5635 
öode
 = 
	`dquŸ_to_öode
(
dquŸ
);

5636 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
,

5637 
	`PXT4_QUOTA_TRANS_BLOCKS
(
dquŸ
->
dq_sb
));

5638 i‡(
	`IS_ERR
(
h™dÀ
))

5639  
	`PTR_ERR
(
h™dÀ
);

5640 
ªt
 = 
	`dquŸ_commô
(
dquŸ
);

5641 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5642 i‡(!
ªt
)

5643 
ªt
 = 
îr
;

5644  
ªt
;

5645 
	}
}

5647 
	$pxt4_acquúe_dquŸ
(
dquŸ
 *dquot)

5649 
ªt
, 
îr
;

5650 
h™dÀ_t
 *
h™dÀ
;

5652 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
	`dquŸ_to_öode
(
dquŸ
), 
PXT4_HT_QUOTA
,

5653 
	`PXT4_QUOTA_INIT_BLOCKS
(
dquŸ
->
dq_sb
));

5654 i‡(
	`IS_ERR
(
h™dÀ
))

5655  
	`PTR_ERR
(
h™dÀ
);

5656 
ªt
 = 
	`dquŸ_acquúe
(
dquŸ
);

5657 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5658 i‡(!
ªt
)

5659 
ªt
 = 
îr
;

5660  
ªt
;

5661 
	}
}

5663 
	$pxt4_ªÀa£_dquŸ
(
dquŸ
 *dquot)

5665 
ªt
, 
îr
;

5666 
h™dÀ_t
 *
h™dÀ
;

5668 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
	`dquŸ_to_öode
(
dquŸ
), 
PXT4_HT_QUOTA
,

5669 
	`PXT4_QUOTA_DEL_BLOCKS
(
dquŸ
->
dq_sb
));

5670 i‡(
	`IS_ERR
(
h™dÀ
)) {

5672 
	`dquŸ_ªÀa£
(
dquŸ
);

5673  
	`PTR_ERR
(
h™dÀ
);

5675 
ªt
 = 
	`dquŸ_ªÀa£
(
dquŸ
);

5676 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5677 i‡(!
ªt
)

5678 
ªt
 = 
îr
;

5679  
ªt
;

5680 
	}
}

5682 
	$pxt4_m¨k_dquŸ_dúty
(
dquŸ
 *dquot)

5684 
su≥r_block
 *
sb
 = 
dquŸ
->
dq_sb
;

5685 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5688 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
) ||

5689 
sbi
->
s_qf_«mes
[
USRQUOTA
] || sbi->s_qf_«mes[
GRPQUOTA
]) {

5690 
	`dquŸ_m¨k_dquŸ_dúty
(
dquŸ
);

5691  
	`pxt4_wrôe_dquŸ
(
dquŸ
);

5693  
	`dquŸ_m¨k_dquŸ_dúty
(
dquŸ
);

5695 
	}
}

5697 
	$pxt4_wrôe_öfo
(
su≥r_block
 *
sb
, 
ty≥
)

5699 
ªt
, 
îr
;

5700 
h™dÀ_t
 *
h™dÀ
;

5703 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
	`d_öode
(
sb
->
s_roŸ
), 
PXT4_HT_QUOTA
, 2);

5704 i‡(
	`IS_ERR
(
h™dÀ
))

5705  
	`PTR_ERR
(
h™dÀ
);

5706 
ªt
 = 
	`dquŸ_commô_öfo
(
sb
, 
ty≥
);

5707 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5708 i‡(!
ªt
)

5709 
ªt
 = 
îr
;

5710  
ªt
;

5711 
	}
}

5717 
	$pxt4_quŸa_⁄_mou¡
(
su≥r_block
 *
sb
, 
ty≥
)

5719  
	`dquŸ_quŸa_⁄_mou¡
(
sb
, 
	`gë_qf_«me
(sb, 
	`PXT4_SB
(sb), 
ty≥
),

5720 
	`PXT4_SB
(
sb
)->
s_jquŸa_fmt
, 
ty≥
);

5721 
	}
}

5723 
	$lockdï_£t_quŸa_öode
(
öode
 *öode, 
sub˛ass
)

5725 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5733 (Ë
ei
;

5734 
	`lockdï_£t_sub˛ass
(&
ei
->
i_d©a_£m
, 
sub˛ass
);

5735 
	}
}

5740 
	$pxt4_quŸa_⁄
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

5741 c⁄° 
∑th
 *path)

5743 
îr
;

5745 i‡(!
	`ã°_›t
(
sb
, 
QUOTA
))

5746  -
EINVAL
;

5749 i‡(
∑th
->
díåy
->
d_sb
 !
sb
)

5750  -
EXDEV
;

5752 i‡(
	`PXT4_SB
(
sb
)->
s_qf_«mes
[
ty≥
]) {

5754 i‡(
∑th
->
díåy
->
d_∑ª¡
 !
sb
->
s_roŸ
)

5755 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

5758 
	`sb_dq›t
(
sb
)->
Êags
 |
DQUOT_NOLIST_DIRTY
;

5764 
	`sb_dq›t
(
sb
)->
Êags
 &~
DQUOT_NOLIST_DIRTY
;

5771 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

5772 
	`pxt4_should_jou∫Æ_d©a
(
	`d_öode
(
∑th
->
díåy
))) {

5777 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

5778 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

5779 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

5780 i‡(
îr
)

5781  
îr
;

5784 
	`lockdï_£t_quŸa_öode
(
∑th
->
díåy
->
d_öode
, 
I_DATA_SEM_QUOTA
);

5785 
îr
 = 
	`dquŸ_quŸa_⁄
(
sb
, 
ty≥
, 
f‹m©_id
, 
∑th
);

5786 i‡(
îr
) {

5787 
	`lockdï_£t_quŸa_öode
(
∑th
->
díåy
->
d_öode
,

5788 
I_DATA_SEM_NORMAL
);

5790 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

5791 
h™dÀ_t
 *
h™dÀ
;

5798 
	`öode_lock
(
öode
);

5799 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
, 1);

5800 i‡(
	`IS_ERR
(
h™dÀ
))

5801 
u∆ock_öode
;

5802 
	`PXT4_I
(
öode
)->
i_Êags
 |
PXT4_NOATIME_FL
 | 
PXT4_IMMUTABLE_FL
;

5803 
	`öode_£t_Êags
(
öode
, 
S_NOATIME
 | 
S_IMMUTABLE
,

5804 
S_NOATIME
 | 
S_IMMUTABLE
);

5805 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5806 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5807 
u∆ock_öode
:

5808 
	`öode_u∆ock
(
öode
);

5810  
îr
;

5811 
	}
}

5813 
	$pxt4_quŸa_íabÀ
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

5814 
Êags
)

5816 
îr
;

5817 
öode
 *
qf_öode
;

5818 
qf_öums
[
PXT4_MAXQUOTAS
] = {

5819 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_u§_quŸa_öum
),

5820 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_gΩ_quŸa_öum
),

5821 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_¥j_quŸa_öum
)

5824 
	`BUG_ON
(!
	`pxt4_has_„©uª_quŸa
(
sb
));

5826 i‡(!
qf_öums
[
ty≥
])

5827  -
EPERM
;

5829 
qf_öode
 = 
	`pxt4_igë
(
sb
, 
qf_öums
[
ty≥
], 
PXT4_IGET_SPECIAL
);

5830 i‡(
	`IS_ERR
(
qf_öode
)) {

5831 
	`pxt4_îr‹
(
sb
, "Bad quŸ®öodê# %lu", 
qf_öums
[
ty≥
]);

5832  
	`PTR_ERR
(
qf_öode
);

5836 
qf_öode
->
i_Êags
 |
S_NOQUOTA
;

5837 
	`lockdï_£t_quŸa_öode
(
qf_öode
, 
I_DATA_SEM_QUOTA
);

5838 
îr
 = 
	`dquŸ_íabÀ
(
qf_öode
, 
ty≥
, 
f‹m©_id
, 
Êags
);

5839 i‡(
îr
)

5840 
	`lockdï_£t_quŸa_öode
(
qf_öode
, 
I_DATA_SEM_NORMAL
);

5841 
	`ùut
(
qf_öode
);

5843  
îr
;

5844 
	}
}

5847 
	$pxt4_íabÀ_quŸas
(
su≥r_block
 *
sb
)

5849 
ty≥
, 
îr
 = 0;

5850 
qf_öums
[
PXT4_MAXQUOTAS
] = {

5851 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_u§_quŸa_öum
),

5852 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_gΩ_quŸa_öum
),

5853 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_¥j_quŸa_öum
)

5855 
boﬁ
 
quŸa_m›t
[
PXT4_MAXQUOTAS
] = {

5856 
	`ã°_›t
(
sb
, 
USRQUOTA
),

5857 
	`ã°_›t
(
sb
, 
GRPQUOTA
),

5858 
	`ã°_›t
(
sb
, 
PRJQUOTA
),

5861 
	`sb_dq›t
(
sb
)->
Êags
 |
DQUOT_QUOTA_SYS_FILE
 | 
DQUOT_NOLIST_DIRTY
;

5862 
ty≥
 = 0;Åy≥ < 
PXT4_MAXQUOTAS
;Åype++) {

5863 i‡(
qf_öums
[
ty≥
]) {

5864 
îr
 = 
	`pxt4_quŸa_íabÀ
(
sb
, 
ty≥
, 
QFMT_VFS_V1
,

5865 
DQUOT_USAGE_ENABLED
 |

5866 (
quŸa_m›t
[
ty≥
] ? 
DQUOT_LIMITS_ENABLED
 : 0));

5867 i‡(
îr
) {

5868 
	`pxt4_w¨nög
(
sb
,

5871 "e2fsckÅÿfix.", 
ty≥
, 
îr
);

5872 
ty≥
--;Åype >= 0;Åype--)

5873 
	`dquŸ_quŸa_off
(
sb
, 
ty≥
);

5875  
îr
;

5880 
	}
}

5882 
	$pxt4_quŸa_off
(
su≥r_block
 *
sb
, 
ty≥
)

5884 
öode
 *öodê
	`sb_dq›t
(
sb
)->
fûes
[
ty≥
];

5885 
h™dÀ_t
 *
h™dÀ
;

5886 
îr
;

5890 i‡(
	`ã°_›t
(
sb
, 
DELALLOC
))

5891 
	`sync_fûesy°em
(
sb
);

5893 i‡(!
öode
 || !
	`igøb
(inode))

5894 
out
;

5896 
îr
 = 
	`dquŸ_quŸa_off
(
sb
, 
ty≥
);

5897 i‡(
îr
 || 
	`pxt4_has_„©uª_quŸa
(
sb
))

5898 
out_put
;

5900 
	`öode_lock
(
öode
);

5906 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
, 1);

5907 i‡(
	`IS_ERR
(
h™dÀ
))

5908 
out_u∆ock
;

5909 
	`PXT4_I
(
öode
)->
i_Êags
 &~(
PXT4_NOATIME_FL
 | 
PXT4_IMMUTABLE_FL
);

5910 
	`öode_£t_Êags
(
öode
, 0, 
S_NOATIME
 | 
S_IMMUTABLE
);

5911 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

5912 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5913 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5914 
out_u∆ock
:

5915 
	`öode_u∆ock
(
öode
);

5916 
out_put
:

5917 
	`lockdï_£t_quŸa_öode
(
öode
, 
I_DATA_SEM_NORMAL
);

5918 
	`ùut
(
öode
);

5919  
îr
;

5920 
out
:

5921  
	`dquŸ_quŸa_off
(
sb
, 
ty≥
);

5922 
	}
}

5928 
ssize_t
 
	$pxt4_quŸa_ªad
(
su≥r_block
 *
sb
, 
ty≥
, *
d©a
,

5929 
size_t
 
Àn
, 
loff_t
 
off
)

5931 
öode
 *öodê
	`sb_dq›t
(
sb
)->
fûes
[
ty≥
];

5932 
pxt4_lblk_t
 
blk
 = 
off
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5933 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

5934 
toc›y
;

5935 
size_t
 
t‹ód
;

5936 
buf„r_hód
 *
bh
;

5937 
loff_t
 
i_size
 = 
	`i_size_ªad
(
öode
);

5939 i‡(
off
 > 
i_size
)

5941 i‡(
off
+
Àn
 > 
i_size
)

5942 
Àn
 = 
i_size
-
off
;

5943 
t‹ód
 = 
Àn
;

5944 
t‹ód
 > 0) {

5945 
toc›y
 = 
sb
->
s_blocksize
 - 
off£t
 < 
t‹ód
 ?

5946 
sb
->
s_blocksize
 - 
off£t
 : 
t‹ód
;

5947 
bh
 = 
	`pxt4_bªad
(
NULL
, 
öode
, 
blk
, 0);

5948 i‡(
	`IS_ERR
(
bh
))

5949  
	`PTR_ERR
(
bh
);

5950 i‡(!
bh
)

5951 
	`mem£t
(
d©a
, 0, 
toc›y
);

5953 
	`mem˝y
(
d©a
, 
bh
->
b_d©a
+
off£t
, 
toc›y
);

5954 
	`bªl£
(
bh
);

5955 
off£t
 = 0;

5956 
t‹ód
 -
toc›y
;

5957 
d©a
 +
toc›y
;

5958 
blk
++;

5960  
Àn
;

5961 
	}
}

5965 
ssize_t
 
	$pxt4_quŸa_wrôe
(
su≥r_block
 *
sb
, 
ty≥
,

5966 c⁄° *
d©a
, 
size_t
 
Àn
, 
loff_t
 
off
)

5968 
öode
 *öodê
	`sb_dq›t
(
sb
)->
fûes
[
ty≥
];

5969 
pxt4_lblk_t
 
blk
 = 
off
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5970 
îr
, 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

5971 
ªåõs
 = 0;

5972 
buf„r_hód
 *
bh
;

5973 
h™dÀ_t
 *
h™dÀ
 = 
	`jou∫Æ_cuºít_h™dÀ
();

5975 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 && !
h™dÀ
) {

5976 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Quota write (off=%llu,Üen=%llu)"

5978 ()
off
, ()
Àn
);

5979  -
EIO
;

5985 i‡(
sb
->
s_blocksize
 - 
off£t
 < 
Àn
) {

5986 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Quota write (off=%llu,Üen=%llu)"

5988 ()
off
, ()
Àn
);

5989  -
EIO
;

5993 
bh
 = 
	`pxt4_bªad
(
h™dÀ
, 
öode
, 
blk
,

5994 
PXT4_GET_BLOCKS_CREATE
 |

5995 
PXT4_GET_BLOCKS_METADATA_NOFAIL
);

5996 } 
	`IS_ERR
(
bh
Ë&& (
	`PTR_ERR
(bhË=-
ENOSPC
) &&

5997 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
));

5998 i‡(
	`IS_ERR
(
bh
))

5999  
	`PTR_ERR
(
bh
);

6000 i‡(!
bh
)

6001 
out
;

6002 
	`BUFFER_TRACE
(
bh
, "get writeáccess");

6003 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

6004 i‡(
îr
) {

6005 
	`bªl£
(
bh
);

6006  
îr
;

6008 
	`lock_buf„r
(
bh
);

6009 
	`mem˝y
(
bh
->
b_d©a
+
off£t
, 
d©a
, 
Àn
);

6010 
	`Êush_dˇche_∑ge
(
bh
->
b_∑ge
);

6011 
	`u∆ock_buf„r
(
bh
);

6012 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

6013 
	`bªl£
(
bh
);

6014 
out
:

6015 i‡(
öode
->
i_size
 < 
off
 + 
Àn
) {

6016 
	`i_size_wrôe
(
öode
, 
off
 + 
Àn
);

6017 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

6018 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

6020  
Àn
;

6021 
	}
}

6023 
	$pxt4_gë_√xt_id
(
su≥r_block
 *
sb
, 
kqid
 *
qid
)

6025 c⁄° 
quŸa_f‹m©_›s
 *
›s
;

6027 i‡(!
	`sb_has_quŸa_lﬂded
(
sb
, 
qid
->
ty≥
))

6028  -
ESRCH
;

6029 
›s
 = 
	`sb_dq›t
(
sb
)->›s[
qid
->
ty≥
];

6030 i‡(!
›s
 || !›s->
gë_√xt_id
)

6031  -
ENOSYS
;

6032  
	`dquŸ_gë_√xt_id
(
sb
, 
qid
);

6033 
	}
}

6036 
díåy
 *
	$pxt4_mou¡
(
fûe_sy°em_ty≥
 *
fs_ty≥
, 
Êags
,

6037 c⁄° *
dev_«me
, *
d©a
)

6039  
	`mou¡_bdev
(
fs_ty≥
, 
Êags
, 
dev_«me
, 
d©a
, 
pxt4_fûl_su≥r
);

6040 
	}
}

6042 #i‡!
deföed
(
CONFIG_PXT2_FS
Ë&& !deföed(
CONFIG_PXT2_FS_MODULE
Ë&& deföed(
CONFIG_PXT4_USE_FOR_PXT2
)

6043 
ölöe
 
	$ªgi°î_as_pxt2
()

6045 
îr
 = 
	`ªgi°î_fûesy°em
(&
pxt2_fs_ty≥
);

6046 i‡(
îr
)

6047 
	`¥ötk
(
KERN_WARNING


6048 "PXT4-fs: U«bÀÅÿªgi°îá†pxt2 (%d)\n", 
îr
);

6049 
	}
}

6051 
ölöe
 
	$uƒegi°î_as_pxt2
()

6053 
	`uƒegi°î_fûesy°em
(&
pxt2_fs_ty≥
);

6054 
	}
}

6056 
ölöe
 
	$pxt2_„©uª_£t_ok
(
su≥r_block
 *
sb
)

6058 i‡(
	`pxt4_has_unknown_pxt2_öcom∑t_„©uªs
(
sb
))

6060 i‡(
	`sb_rd⁄ly
(
sb
))

6062 i‡(
	`pxt4_has_unknown_pxt2_ro_com∑t_„©uªs
(
sb
))

6065 
	}
}

6067 
ölöe
 
	$ªgi°î_as_pxt2
(Ë{ 
	}
}

6068 
ölöe
 
	$uƒegi°î_as_pxt2
(Ë{ 
	}
}

6069 
ölöe
 
	$pxt2_„©uª_£t_ok
(
su≥r_block
 *
sb
Ë{  0; 
	}
}

6072 
ölöe
 
	$ªgi°î_as_ext3
()

6074 
îr
 = 
	`ªgi°î_fûesy°em
(&
ext3_fs_ty≥
);

6075 i‡(
îr
)

6076 
	`¥ötk
(
KERN_WARNING


6077 "PXT4-fs: U«bÀÅÿªgi°îá†ext3 (%d)\n", 
îr
);

6078 
	}
}

6080 
ölöe
 
	$uƒegi°î_as_ext3
()

6082 
	`uƒegi°î_fûesy°em
(&
ext3_fs_ty≥
);

6083 
	}
}

6085 
ölöe
 
	$ext3_„©uª_£t_ok
(
su≥r_block
 *
sb
)

6087 i‡(
	`pxt4_has_unknown_ext3_öcom∑t_„©uªs
(
sb
))

6089 i‡(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
))

6091 i‡(
	`sb_rd⁄ly
(
sb
))

6093 i‡(
	`pxt4_has_unknown_ext3_ro_com∑t_„©uªs
(
sb
))

6096 
	}
}

6098 
fûe_sy°em_ty≥
 
	gpxt4_fs_ty≥
 = {

6099 .
ow√r
 = 
THIS_MODULE
,

6100 .
	g«me
 = "pxt4",

6101 .
	gmou¡
 = 
pxt4_mou¡
,

6102 .
	gkûl_sb
 = 
kûl_block_su≥r
,

6103 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

6105 
MODULE_ALIAS_FS
("pxt4");

6108 
waô_queue_hód_t
 
	gpxt4__i€nd_wq
[
PXT4_WQ_HASH_SZ
];

6110 
__öô
 
	$pxt4_öô_fs
()

6112 
i
, 
îr
;

6114 
	`øãlimô_°©e_öô
(&
pxt4_mou¡_msg_øãlimô
, 30 * 
HZ
, 64);

6115 
pxt4_li_öfo
 = 
NULL
;

6116 
	`muãx_öô
(&
pxt4_li_mtx
);

6119 
	`pxt4_check_Êag_vÆues
();

6121 
i
 = 0; i < 
PXT4_WQ_HASH_SZ
; i++)

6122 
	`öô_waôqueue_hód
(&
pxt4__i€nd_wq
[
i
]);

6124 
îr
 = 
	`pxt4_öô_es
();

6125 i‡(
îr
)

6126  
îr
;

6128 
îr
 = 
	`pxt4_öô_≥ndög
();

6129 i‡(
îr
)

6130 
out7
;

6132 
îr
 = 
	`pxt4_öô_po°_ªad_¥o˚ssög
();

6133 i‡(
îr
)

6134 
out6
;

6136 
îr
 = 
	`pxt4_öô_∑geio
();

6137 i‡(
îr
)

6138 
out5
;

6140 
îr
 = 
	`pxt4_öô_sy°em_z⁄e
();

6141 i‡(
îr
)

6142 
out4
;

6144 
îr
 = 
	`pxt4_öô_sysfs
();

6145 i‡(
îr
)

6146 
out3
;

6148 
îr
 = 
	`pxt4_öô_mbÆloc
();

6149 i‡(
îr
)

6150 
out2
;

6151 
îr
 = 
	`öô_öodeˇche
();

6152 i‡(
îr
)

6153 
out1
;

6154 
	`ªgi°î_as_ext3
();

6155 
	`ªgi°î_as_pxt2
();

6156 
îr
 = 
	`ªgi°î_fûesy°em
(&
pxt4_fs_ty≥
);

6157 i‡(
îr
)

6158 
out
;

6161 
out
:

6162 
	`uƒegi°î_as_pxt2
();

6163 
	`uƒegi°î_as_ext3
();

6164 
	`de°roy_öodeˇche
();

6165 
out1
:

6166 
	`pxt4_exô_mbÆloc
();

6167 
out2
:

6168 
	`pxt4_exô_sysfs
();

6169 
out3
:

6170 
	`pxt4_exô_sy°em_z⁄e
();

6171 
out4
:

6172 
	`pxt4_exô_∑geio
();

6173 
out5
:

6174 
	`pxt4_exô_po°_ªad_¥o˚ssög
();

6175 
out6
:

6176 
	`pxt4_exô_≥ndög
();

6177 
out7
:

6178 
	`pxt4_exô_es
();

6180  
îr
;

6181 
	}
}

6183 
__exô
 
	$pxt4_exô_fs
()

6185 
	`pxt4_de°roy_œzyöô_thªad
();

6186 
	`uƒegi°î_as_pxt2
();

6187 
	`uƒegi°î_as_ext3
();

6188 
	`uƒegi°î_fûesy°em
(&
pxt4_fs_ty≥
);

6189 
	`de°roy_öodeˇche
();

6190 
	`pxt4_exô_mbÆloc
();

6191 
	`pxt4_exô_sysfs
();

6192 
	`pxt4_exô_sy°em_z⁄e
();

6193 
	`pxt4_exô_∑geio
();

6194 
	`pxt4_exô_po°_ªad_¥o˚ssög
();

6195 
	`pxt4_exô_es
();

6196 
	`pxt4_exô_≥ndög
();

6197 
	}
}

6199 
MODULE_AUTHOR
("Remy Card, Stephen Tweedie, Andrew Morton, Andreas Dilger, Theodore Ts'oánd others");

6200 
MODULE_DESCRIPTION
("Fourth Extended Filesystem");

6201 
MODULE_LICENSE
("GPL");

6202 
MODULE_SOFTDEP
("pre: crc32c");

6203 
	$moduÀ_öô
(
pxt4_öô_fs
)

6204 
	`moduÀ_exô
(
pxt4_exô_fs
)

	@symlink.c

21 
	~<löux/fs.h
>

22 
	~<löux/«mei.h
>

23 
	~"pxt4.h
"

24 
	~"x©å.h
"

26 c⁄° *
	$pxt4_í¸y±ed_gë_lök
(
díåy
 *dentry,

27 
öode
 *inode,

28 
dñayed_ˇŒ
 *
d⁄e
)

30 
∑ge
 *
˝age
 = 
NULL
;

31 c⁄° *
ˇddr
;

32 
max_size
;

33 c⁄° *
∑ddr
;

35 i‡(!
díåy
)

36  
	`ERR_PTR
(-
ECHILD
);

38 i‡(
	`pxt4_öode_is_Á°_symlök
(
öode
)) {

39 
ˇddr
 = 
	`PXT4_I
(
öode
)->
i_d©a
;

40 
max_size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

42 
˝age
 = 
	`ªad_m≠pög_∑ge
(
öode
->
i_m≠pög
, 0, 
NULL
);

43 i‡(
	`IS_ERR
(
˝age
))

44  
	`ERR_CAST
(
˝age
);

45 
ˇddr
 = 
	`∑ge_addªss
(
˝age
);

46 
max_size
 = 
öode
->
i_sb
->
s_blocksize
;

49 
∑ddr
 = 
	`fs¸y±_gë_symlök
(
öode
, 
ˇddr
, 
max_size
, 
d⁄e
);

50 i‡(
˝age
)

51 
	`put_∑ge
(
˝age
);

52  
∑ddr
;

53 
	}
}

55 c⁄° 
öode_›î©i⁄s
 
	gpxt4_í¸y±ed_symlök_öode_›î©i⁄s
 = {

56 .
gë_lök
 = 
pxt4_í¸y±ed_gë_lök
,

57 .
	g£èâr
 = 
pxt4_£èâr
,

58 .
	ggë©å
 = 
pxt4_gë©å
,

59 .
	gli°x©å
 = 
pxt4_li°x©å
,

62 c⁄° 
öode_›î©i⁄s
 
	gpxt4_symlök_öode_›î©i⁄s
 = {

63 .
gë_lök
 = 
∑ge_gë_lök
,

64 .
	g£èâr
 = 
pxt4_£èâr
,

65 .
	ggë©å
 = 
pxt4_gë©å
,

66 .
	gli°x©å
 = 
pxt4_li°x©å
,

69 c⁄° 
öode_›î©i⁄s
 
	gpxt4_Á°_symlök_öode_›î©i⁄s
 = {

70 .
gë_lök
 = 
sim∂e_gë_lök
,

71 .
	g£èâr
 = 
pxt4_£èâr
,

72 .
	ggë©å
 = 
pxt4_gë©å
,

73 .
	gli°x©å
 = 
pxt4_li°x©å
,

	@sysfs.c

11 
	~<löux/time.h
>

12 
	~<löux/fs.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/¥oc_fs.h
>

17 
	~"pxt4.h
"

18 
	~"pxt4_jbd3.h
"

21 
	m©å_no›
,

22 
	m©å_dñayed_Æloˇti⁄_blocks
,

23 
	m©å_£ssi⁄_wrôe_kbyãs
,

24 
	m©å_li„time_wrôe_kbyãs
,

25 
	m©å_ª£rved_˛u°îs
,

26 
	m©å_öode_ªadahód
,

27 
	m©å_åiggî_ã°_îr‹
,

28 
	m©å_fú°_îr‹_time
,

29 
	m©å_œ°_îr‹_time
,

30 
	m©å_„©uª
,

31 
	m©å_poöãr_ui
,

32 
	m©å_poöãr_©omic
,

33 
	m©å_jou∫Æ_èsk
,

34 } 
	t©å_id_t
;

37 
	m±r_ex∂icô
,

38 
	m±r_pxt4_sb_öfo_off£t
,

39 
	m±r_pxt4_su≥r_block_off£t
,

40 } 
	t©å_±r_t
;

42 c⁄° 
	g¥oc_dú«me
[] = "fs/pxt4";

43 
¥oc_dú_íåy
 *
	gpxt4_¥oc_roŸ
;

45 
	spxt4_©å
 {

46 
©åibuã
 
	m©å
;

47 
	m©å_id
;

48 
	m©å_±r
;

50 
	moff£t
;

51 *
	mex∂icô_±r
;

52 } 
	mu
;

55 
ssize_t
 
	$£ssi⁄_wrôe_kbyãs_show
(
pxt4_sb_öfo
 *
sbi
, *
buf
)

57 
su≥r_block
 *
sb
 = 
sbi
->
s_buddy_ˇche
->
i_sb
;

59 i‡(!
sb
->
s_bdev
->
bd_∑π
)

60  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "0\n");

61  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%lu\n",

62 (
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
,

63 
£˘‹s
[
STAT_WRITE
]) -

64 
sbi
->
s_£˘‹s_wrôãn_°¨t
) >> 1);

65 
	}
}

67 
ssize_t
 
	$li„time_wrôe_kbyãs_show
(
pxt4_sb_öfo
 *
sbi
, *
buf
)

69 
su≥r_block
 *
sb
 = 
sbi
->
s_buddy_ˇche
->
i_sb
;

71 i‡(!
sb
->
s_bdev
->
bd_∑π
)

72  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "0\n");

73  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%llu\n",

74 ()(
sbi
->
s_kbyãs_wrôãn
 +

75 ((
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
,

76 
£˘‹s
[
STAT_WRITE
]) -

77 
	`PXT4_SB
(
sb
)->
s_£˘‹s_wrôãn_°¨t
) >> 1)));

78 
	}
}

80 
ssize_t
 
	$öode_ªadahód_blks_°‹e
(
pxt4_sb_öfo
 *
sbi
,

81 c⁄° *
buf
, 
size_t
 
cou¡
)

83 
t
;

84 
ªt
;

86 
ªt
 = 
	`k°πoul
(
	`skù_•a˚s
(
buf
), 0, &
t
);

87 i‡(
ªt
)

88  
ªt
;

90 i‡(
t
 && (!
	`is_powî_of_2
(t) ||Å > 0x40000000))

91  -
EINVAL
;

93 
sbi
->
s_öode_ªadahód_blks
 = 
t
;

94  
cou¡
;

95 
	}
}

97 
ssize_t
 
	$ª£rved_˛u°îs_°‹e
(
pxt4_sb_öfo
 *
sbi
,

98 c⁄° *
buf
, 
size_t
 
cou¡
)

100 
vÆ
;

101 
pxt4_fsblk_t
 
˛u°îs
 = (
	`pxt4_blocks_cou¡
(
sbi
->
s_es
) >>

102 
sbi
->
s_˛u°î_bôs
);

103 
ªt
;

105 
ªt
 = 
	`k°πouŒ
(
	`skù_•a˚s
(
buf
), 0, &
vÆ
);

106 i‡(
ªt
 || 
vÆ
 >
˛u°îs
)

107  -
EINVAL
;

109 
	`©omic64_£t
(&
sbi
->
s_ªsv_˛u°îs
, 
vÆ
);

110  
cou¡
;

111 
	}
}

113 
ssize_t
 
	$åiggî_ã°_îr‹
(
pxt4_sb_öfo
 *
sbi
,

114 c⁄° *
buf
, 
size_t
 
cou¡
)

116 
Àn
 = 
cou¡
;

118 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

119  -
EPERM
;

121 i‡(
Àn
 && 
buf
[len-1] == '\n')

122 
Àn
--;

124 i‡(
Àn
)

125 
	`pxt4_îr‹
(
sbi
->
s_sb
, "%.*s", 
Àn
, 
buf
);

126  
cou¡
;

127 
	}
}

129 
ssize_t
 
	$jou∫Æ_èsk_show
(
pxt4_sb_öfo
 *
sbi
, *
buf
)

131 i‡(!
sbi
->
s_jou∫Æ
)

132  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "<none>\n");

133  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%d\n",

134 
	`èsk_pid_vƒ
(
sbi
->
s_jou∫Æ
->
j_èsk
));

135 
	}
}

137 
	#PXT4_ATTR
(
_«me
,
_mode
,
_id
) \

138 
pxt4_©å
 
pxt4_©å_
##
_«me
 = { \

139 .
©å
 = {.
«me
 = 
	`__°rögify
(
_«me
), .
mode
 = 
_mode
 }, \

140 .
©å_id
 = 
©å_
##
_id
, \

141 }

	)

143 
	#PXT4_ATTR_FUNC
(
_«me
,
_mode
Ë
	`PXT4_ATTR
(_«me,_mode,_«me)

	)

145 
	#PXT4_ATTR_FEATURE
(
_«me
Ë
	`PXT4_ATTR
(_«me, 0444, 
„©uª
)

	)

147 
	#PXT4_ATTR_OFFSET
(
_«me
,
_mode
,
_id
,
_°ru˘
,
_ñ«me
) \

148 
pxt4_©å
 
pxt4_©å_
##
_«me
 = { \

149 .
©å
 = {.
«me
 = 
	`__°rögify
(
_«me
), .
mode
 = 
_mode
 }, \

150 .
©å_id
 = 
©å_
##
_id
, \

151 .
©å_±r
 = 
±r_
##
_°ru˘
##
_off£t
, \

152 .
u
 = { \

153 .
off£t
 = 
	`off£tof
(
_°ru˘
, 
_ñ«me
),\

155 }

	)

157 
	#PXT4_RO_ATTR_ES_UI
(
_«me
,
_ñ«me
) \

158 
	`PXT4_ATTR_OFFSET
(
_«me
, 0444, 
poöãr_ui
, 
pxt4_su≥r_block
, 
_ñ«me
)

	)

160 
	#PXT4_RW_ATTR_SBI_UI
(
_«me
,
_ñ«me
) \

161 
	`PXT4_ATTR_OFFSET
(
_«me
, 0644, 
poöãr_ui
, 
pxt4_sb_öfo
, 
_ñ«me
)

	)

163 
	#PXT4_ATTR_PTR
(
_«me
,
_mode
,
_id
,
_±r
) \

164 
pxt4_©å
 
pxt4_©å_
##
_«me
 = { \

165 .
©å
 = {.
«me
 = 
	`__°rögify
(
_«me
), .
mode
 = 
_mode
 }, \

166 .
©å_id
 = 
©å_
##
_id
, \

167 .
©å_±r
 = 
±r_ex∂icô
, \

168 .
u
 = { \

169 .
ex∂icô_±r
 = 
_±r
, \

171 }

	)

173 
	#ATTR_LIST
(
«me
Ë&
pxt4_©å_
##«me.
©å


	)

175 
PXT4_ATTR_FUNC
(
dñayed_Æloˇti⁄_blocks
, 0444);

176 
PXT4_ATTR_FUNC
(
£ssi⁄_wrôe_kbyãs
, 0444);

177 
PXT4_ATTR_FUNC
(
li„time_wrôe_kbyãs
, 0444);

178 
PXT4_ATTR_FUNC
(
ª£rved_˛u°îs
, 0644);

180 
PXT4_ATTR_OFFSET
(
öode_ªadahód_blks
, 0644, 
öode_ªadahód
,

181 
pxt4_sb_öfo
, 
s_öode_ªadahód_blks
);

182 
PXT4_RW_ATTR_SBI_UI
(
öode_gﬂl
, 
s_öode_gﬂl
);

183 
PXT4_RW_ATTR_SBI_UI
(
mb_°©s
, 
s_mb_°©s
);

184 
PXT4_RW_ATTR_SBI_UI
(
mb_max_to_sˇn
, 
s_mb_max_to_sˇn
);

185 
PXT4_RW_ATTR_SBI_UI
(
mb_mö_to_sˇn
, 
s_mb_mö_to_sˇn
);

186 
PXT4_RW_ATTR_SBI_UI
(
mb_‹dî2_ªq
, 
s_mb_‹dî2_ªqs
);

187 
PXT4_RW_ATTR_SBI_UI
(
mb_°ªam_ªq
, 
s_mb_°ªam_ªque°
);

188 
PXT4_RW_ATTR_SBI_UI
(
mb_group_¥óŒoc
, 
s_mb_group_¥óŒoc
);

189 
PXT4_RW_ATTR_SBI_UI
(
exã¡_max_zîoout_kb
, 
s_exã¡_max_zîoout_kb
);

190 
PXT4_ATTR
(
åiggî_fs_îr‹
, 0200, 
åiggî_ã°_îr‹
);

191 
PXT4_RW_ATTR_SBI_UI
(
îr_øãlimô_öãrvÆ_ms
, 
s_îr_øãlimô_°©e
.
öãrvÆ
);

192 
PXT4_RW_ATTR_SBI_UI
(
îr_øãlimô_bur°
, 
s_îr_øãlimô_°©e
.
bur°
);

193 
PXT4_RW_ATTR_SBI_UI
(
w¨nög_øãlimô_öãrvÆ_ms
, 
s_w¨nög_øãlimô_°©e
.
öãrvÆ
);

194 
PXT4_RW_ATTR_SBI_UI
(
w¨nög_øãlimô_bur°
, 
s_w¨nög_øãlimô_°©e
.
bur°
);

195 
PXT4_RW_ATTR_SBI_UI
(
msg_øãlimô_öãrvÆ_ms
, 
s_msg_øãlimô_°©e
.
öãrvÆ
);

196 
PXT4_RW_ATTR_SBI_UI
(
msg_øãlimô_bur°
, 
s_msg_øãlimô_°©e
.
bur°
);

197 
PXT4_RO_ATTR_ES_UI
(
îr‹s_cou¡
, 
s_îr‹_cou¡
);

198 
PXT4_ATTR
(
fú°_îr‹_time
, 0444, first_error_time);

199 
PXT4_ATTR
(
œ°_îr‹_time
, 0444,Üast_error_time);

200 
PXT4_ATTR
(
jou∫Æ_èsk
, 0444, journal_task);

202 
	gﬁd_bump_vÆ
 = 128;

203 
PXT4_ATTR_PTR
(
max_wrôeback_mb_bump
, 0444, 
poöãr_ui
, &
ﬁd_bump_vÆ
);

205 
©åibuã
 *
	gpxt4_©ås
[] = {

206 
ATTR_LIST
(
dñayed_Æloˇti⁄_blocks
),

207 
ATTR_LIST
(
£ssi⁄_wrôe_kbyãs
),

208 
ATTR_LIST
(
li„time_wrôe_kbyãs
),

209 
ATTR_LIST
(
ª£rved_˛u°îs
),

210 
ATTR_LIST
(
öode_ªadahód_blks
),

211 
ATTR_LIST
(
öode_gﬂl
),

212 
ATTR_LIST
(
mb_°©s
),

213 
ATTR_LIST
(
mb_max_to_sˇn
),

214 
ATTR_LIST
(
mb_mö_to_sˇn
),

215 
ATTR_LIST
(
mb_‹dî2_ªq
),

216 
ATTR_LIST
(
mb_°ªam_ªq
),

217 
ATTR_LIST
(
mb_group_¥óŒoc
),

218 
ATTR_LIST
(
max_wrôeback_mb_bump
),

219 
ATTR_LIST
(
exã¡_max_zîoout_kb
),

220 
ATTR_LIST
(
åiggî_fs_îr‹
),

221 
ATTR_LIST
(
îr_øãlimô_öãrvÆ_ms
),

222 
ATTR_LIST
(
îr_øãlimô_bur°
),

223 
ATTR_LIST
(
w¨nög_øãlimô_öãrvÆ_ms
),

224 
ATTR_LIST
(
w¨nög_øãlimô_bur°
),

225 
ATTR_LIST
(
msg_øãlimô_öãrvÆ_ms
),

226 
ATTR_LIST
(
msg_øãlimô_bur°
),

227 
ATTR_LIST
(
îr‹s_cou¡
),

228 
ATTR_LIST
(
fú°_îr‹_time
),

229 
ATTR_LIST
(
œ°_îr‹_time
),

230 
ATTR_LIST
(
jou∫Æ_èsk
),

231 
NULL
,

233 
ATTRIBUTE_GROUPS
(
pxt4
);

236 
PXT4_ATTR_FEATURE
(
œzy_ôabÀ_öô
);

237 
PXT4_ATTR_FEATURE
(
b©ched_disˇrd
);

238 
PXT4_ATTR_FEATURE
(
mëa_bg_ªsize
);

239 #ifde‡
CONFIG_FS_ENCRYPTION


240 
PXT4_ATTR_FEATURE
(
í¸y±i⁄
);

242 #ifde‡
CONFIG_UNICODE


243 
PXT4_ATTR_FEATURE
(
ˇ£fﬁd
);

245 #ifde‡
CONFIG_FS_VERITY


246 
PXT4_ATTR_FEATURE
(
vîôy
);

248 
PXT4_ATTR_FEATURE
(
mëad©a_csum_£ed
);

250 
©åibuã
 *
	gpxt4_„©_©ås
[] = {

251 
ATTR_LIST
(
œzy_ôabÀ_öô
),

252 
ATTR_LIST
(
b©ched_disˇrd
),

253 
ATTR_LIST
(
mëa_bg_ªsize
),

254 #ifde‡
CONFIG_FS_ENCRYPTION


255 
ATTR_LIST
(
í¸y±i⁄
),

257 #ifde‡
CONFIG_UNICODE


258 
ATTR_LIST
(
ˇ£fﬁd
),

260 #ifde‡
CONFIG_FS_VERITY


261 
ATTR_LIST
(
vîôy
),

263 
ATTR_LIST
(
mëad©a_csum_£ed
),

264 
NULL
,

266 
ATTRIBUTE_GROUPS
(
pxt4_„©
);

268 *
	$ˇlc_±r
(
pxt4_©å
 *
a
, 
pxt4_sb_öfo
 *
sbi
)

270 
a
->
©å_±r
) {

271 
±r_ex∂icô
:

272  
a
->
u
.
ex∂icô_±r
;

273 
±r_pxt4_sb_öfo_off£t
:

274  (*Ë(((*Ë
sbi
Ë+ 
a
->
u
.
off£t
);

275 
±r_pxt4_su≥r_block_off£t
:

276  (*Ë(((*Ë
sbi
->
s_es
Ë+ 
a
->
u
.
off£t
);

278  
NULL
;

279 
	}
}

281 
ssize_t
 
	$__¥öt_t°amp
(*
buf
, 
__À32
 
lo
, 
__u8
 
hi
)

283  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%lld",

284 ((
time64_t
)
hi
 << 32Ë+ 
	`À32_to_˝u
(
lo
));

285 
	}
}

287 
	#¥öt_t°amp
(
buf
, 
es
, 
t°amp
) \

288 
	`__¥öt_t°amp
(
buf
, (
es
)->
t°amp
, (es)->t°am∞## 
_hi
)

	)

290 
ssize_t
 
	$pxt4_©å_show
(
kobje˘
 *
kobj
,

291 
©åibuã
 *
©å
, *
buf
)

293 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
kobj
, pxt4_sb_info,

294 
s_kobj
);

295 
pxt4_©å
 *
a
 = 
	`c⁄èöî_of
(
©å
, pxt4_attr,áttr);

296 *
±r
 = 
	`ˇlc_±r
(
a
, 
sbi
);

298 
a
->
©å_id
) {

299 
©å_dñayed_Æloˇti⁄_blocks
:

300  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%llu\n",

301 (
s64
Ë
	`PXT4_C2B
(
sbi
,

302 
	`≥r˝u_cou¡î_sum
(&
sbi
->
s_dúty˛u°îs_cou¡î
)));

303 
©å_£ssi⁄_wrôe_kbyãs
:

304  
	`£ssi⁄_wrôe_kbyãs_show
(
sbi
, 
buf
);

305 
©å_li„time_wrôe_kbyãs
:

306  
	`li„time_wrôe_kbyãs_show
(
sbi
, 
buf
);

307 
©å_ª£rved_˛u°îs
:

308  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%llu\n",

310 
	`©omic64_ªad
(&
sbi
->
s_ªsv_˛u°îs
));

311 
©å_öode_ªadahód
:

312 
©å_poöãr_ui
:

313 i‡(!
±r
)

315 i‡(
a
->
©å_±r
 =
±r_pxt4_su≥r_block_off£t
)

316  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%u\n",

317 
	`À32_to_˝up
(
±r
));

319  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%u\n",

320 *((*Ë
±r
));

321 
©å_poöãr_©omic
:

322 i‡(!
±r
)

324  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%d\n",

325 
	`©omic_ªad
((
©omic_t
 *Ë
±r
));

326 
©å_„©uª
:

327  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "supported\n");

328 
©å_fú°_îr‹_time
:

329  
	`¥öt_t°amp
(
buf
, 
sbi
->
s_es
, 
s_fú°_îr‹_time
);

330 
©å_œ°_îr‹_time
:

331  
	`¥öt_t°amp
(
buf
, 
sbi
->
s_es
, 
s_œ°_îr‹_time
);

332 
©å_jou∫Æ_èsk
:

333  
	`jou∫Æ_èsk_show
(
sbi
, 
buf
);

337 
	}
}

339 
ssize_t
 
	$pxt4_©å_°‹e
(
kobje˘
 *
kobj
,

340 
©åibuã
 *
©å
,

341 c⁄° *
buf
, 
size_t
 
Àn
)

343 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
kobj
, pxt4_sb_info,

344 
s_kobj
);

345 
pxt4_©å
 *
a
 = 
	`c⁄èöî_of
(
©å
, pxt4_attr,áttr);

346 *
±r
 = 
	`ˇlc_±r
(
a
, 
sbi
);

347 
t
;

348 
ªt
;

350 
a
->
©å_id
) {

351 
©å_ª£rved_˛u°îs
:

352  
	`ª£rved_˛u°îs_°‹e
(
sbi
, 
buf
, 
Àn
);

353 
©å_poöãr_ui
:

354 i‡(!
±r
)

356 
ªt
 = 
	`k°πoul
(
	`skù_•a˚s
(
buf
), 0, &
t
);

357 i‡(
ªt
)

358  
ªt
;

359 i‡(
a
->
©å_±r
 =
±r_pxt4_su≥r_block_off£t
)

360 *((
__À32
 *Ë
±r
Ë
	`˝u_to_À32
(
t
);

362 *((*Ë
±r
Ë
t
;

363  
Àn
;

364 
©å_öode_ªadahód
:

365  
	`öode_ªadahód_blks_°‹e
(
sbi
, 
buf
, 
Àn
);

366 
©å_åiggî_ã°_îr‹
:

367  
	`åiggî_ã°_îr‹
(
sbi
, 
buf
, 
Àn
);

370 
	}
}

372 
	$pxt4_sb_ªÀa£
(
kobje˘
 *
kobj
)

374 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
kobj
, pxt4_sb_info,

375 
s_kobj
);

376 
	`com∂ëe
(&
sbi
->
s_kobj_uƒegi°î
);

377 
	}
}

379 c⁄° 
sysfs_›s
 
	gpxt4_©å_›s
 = {

380 .
show
 = 
pxt4_©å_show
,

381 .
	g°‹e
 = 
pxt4_©å_°‹e
,

384 
kobj_ty≥
 
	gpxt4_sb_kty≥
 = {

385 .
deÁu…_groups
 = 
pxt4_groups
,

386 .
	gsysfs_›s
 = &
pxt4_©å_›s
,

387 .
	gªÀa£
 = 
pxt4_sb_ªÀa£
,

390 
kobj_ty≥
 
	gpxt4_„©_kty≥
 = {

391 .
deÁu…_groups
 = 
pxt4_„©_groups
,

392 .
	gsysfs_›s
 = &
pxt4_©å_›s
,

393 .
	gªÀa£
 = ((*)(
kobje˘
 *))
k‰ì
,

396 
kobje˘
 *
	gpxt4_roŸ
;

398 
kobje˘
 *
	gpxt4_„©
;

400 
	$pxt4_ªgi°î_sysfs
(
su≥r_block
 *
sb
)

402 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

403 
îr
;

405 
	`öô_com∂ëi⁄
(&
sbi
->
s_kobj_uƒegi°î
);

406 
îr
 = 
	`kobje˘_öô_™d_add
(&
sbi
->
s_kobj
, &
pxt4_sb_kty≥
, 
pxt4_roŸ
,

407 "%s", 
sb
->
s_id
);

408 i‡(
îr
) {

409 
	`kobje˘_put
(&
sbi
->
s_kobj
);

410 
	`waô_f‹_com∂ëi⁄
(&
sbi
->
s_kobj_uƒegi°î
);

411  
îr
;

414 i‡(
pxt4_¥oc_roŸ
)

415 
sbi
->
s_¥oc
 = 
	`¥oc_mkdú
(
sb
->
s_id
, 
pxt4_¥oc_roŸ
);

416 i‡(
sbi
->
s_¥oc
) {

417 
	`¥oc_¸óã_sögÀ_d©a
("›ti⁄s", 
S_IRUGO
, 
sbi
->
s_¥oc
,

418 
pxt4_£q_›ti⁄s_show
, 
sb
);

419 
	`¥oc_¸óã_sögÀ_d©a
("es_shrökî_öfo", 
S_IRUGO
,

420 
sbi
->
s_¥oc
, 
pxt4_£q_es_shrökî_öfo_show
,

421 
sb
);

422 
	`¥oc_¸óã_£q_d©a
("mb_groups", 
S_IRUGO
, 
sbi
->
s_¥oc
,

423 &
pxt4_mb_£q_groups_›s
, 
sb
);

426 
	}
}

428 
	$pxt4_uƒegi°î_sysfs
(
su≥r_block
 *
sb
)

430 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

432 i‡(
sbi
->
s_¥oc
)

433 
	`ªmove_¥oc_subåì
(
sb
->
s_id
, 
pxt4_¥oc_roŸ
);

434 
	`kobje˘_dñ
(&
sbi
->
s_kobj
);

435 
	}
}

437 
__öô
 
	$pxt4_öô_sysfs
()

439 
ªt
;

441 
pxt4_roŸ
 = 
	`kobje˘_¸óã_™d_add
("pxt4", 
fs_kobj
);

442 i‡(!
pxt4_roŸ
)

443  -
ENOMEM
;

445 
pxt4_„©
 = 
	`kzÆloc
((*pxt4_„©), 
GFP_KERNEL
);

446 i‡(!
pxt4_„©
) {

447 
ªt
 = -
ENOMEM
;

448 
roŸ_îr
;

451 
ªt
 = 
	`kobje˘_öô_™d_add
(
pxt4_„©
, &
pxt4_„©_kty≥
,

452 
pxt4_roŸ
, "features");

453 i‡(
ªt
)

454 
„©_îr
;

456 
pxt4_¥oc_roŸ
 = 
	`¥oc_mkdú
(
¥oc_dú«me
, 
NULL
);

457  
ªt
;

459 
„©_îr
:

460 
	`kobje˘_put
(
pxt4_„©
);

461 
pxt4_„©
 = 
NULL
;

462 
roŸ_îr
:

463 
	`kobje˘_put
(
pxt4_roŸ
);

464 
pxt4_roŸ
 = 
NULL
;

465  
ªt
;

466 
	}
}

468 
	$pxt4_exô_sysfs
()

470 
	`kobje˘_put
(
pxt4_„©
);

471 
pxt4_„©
 = 
NULL
;

472 
	`kobje˘_put
(
pxt4_roŸ
);

473 
pxt4_roŸ
 = 
NULL
;

474 
	`ªmove_¥oc_íåy
(
¥oc_dú«me
, 
NULL
);

475 
pxt4_¥oc_roŸ
 = 
NULL
;

476 
	}
}

	@truncate.h

12 
ölöe
 
	$pxt4_åunˇã_Áûed_wrôe
(
öode
 *inode)

18 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

19 
	`åunˇã_öode_∑ges
(
öode
->
i_m≠pög
, inode->
i_size
);

20 
	`pxt4_åunˇã
(
öode
);

21 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

22 
	}
}

28 
ölöe
 
	$pxt4_blocks_f‹_åunˇã
(
öode
 *inode)

30 
pxt4_lblk_t
 
√eded
;

32 
√eded
 = 
öode
->
i_blocks
 >> (öode->
i_sb
->
s_blocksize_bôs
 - 9);

40 i‡(
√eded
 < 2)

41 
√eded
 = 2;

45 i‡(
√eded
 > 
PXT4_MAX_TRANS_DATA
)

46 
√eded
 = 
PXT4_MAX_TRANS_DATA
;

48  
	`PXT4_DATA_TRANS_BLOCKS
(
öode
->
i_sb
Ë+ 
√eded
;

49 
	}
}

	@verity.c

26 
	~<löux/quŸa›s.h
>

28 
	~"pxt4.h
"

29 
	~"pxt4_exã¡s.h
"

30 
	~"pxt4_jbd3.h
"

32 
ölöe
 
loff_t
 
	$pxt4_vîôy_mëad©a_pos
(c⁄° 
öode
 *inode)

34  
	`round_up
(
öode
->
i_size
, 65536);

35 
	}
}

41 
	$∑geˇche_ªad
(
öode
 *öode, *
buf
, 
size_t
 
cou¡
,

42 
loff_t
 
pos
)

44 
cou¡
) {

45 
size_t
 
n
 = 
	`mö_t
(size_t, 
cou¡
,

46 
PAGE_SIZE
 - 
	`off£t_ö_∑ge
(
pos
));

47 
∑ge
 *page;

48 *
addr
;

50 
∑ge
 = 
	`ªad_m≠pög_∑ge
(
öode
->
i_m≠pög
, 
pos
 >> 
PAGE_SHIFT
,

51 
NULL
);

52 i‡(
	`IS_ERR
(
∑ge
))

53  
	`PTR_ERR
(
∑ge
);

55 
addr
 = 
	`km≠_©omic
(
∑ge
);

56 
	`mem˝y
(
buf
, 
addr
 + 
	`off£t_ö_∑ge
(
pos
), 
n
);

57 
	`kunm≠_©omic
(
addr
);

59 
	`put_∑ge
(
∑ge
);

61 
buf
 +
n
;

62 
pos
 +
n
;

63 
cou¡
 -
n
;

66 
	}
}

72 
	$∑geˇche_wrôe
(
öode
 *öode, c⁄° *
buf
, 
size_t
 
cou¡
,

73 
loff_t
 
pos
)

75 i‡(
pos
 + 
cou¡
 > 
öode
->
i_sb
->
s_maxbyãs
)

76  -
EFBIG
;

78 
cou¡
) {

79 
size_t
 
n
 = 
	`mö_t
(size_t, 
cou¡
,

80 
PAGE_SIZE
 - 
	`off£t_ö_∑ge
(
pos
));

81 
∑ge
 *page;

82 *
fsd©a
;

83 *
addr
;

84 
ªs
;

86 
ªs
 = 
	`∑geˇche_wrôe_begö
(
NULL
, 
öode
->
i_m≠pög
, 
pos
, 
n
, 0,

87 &
∑ge
, &
fsd©a
);

88 i‡(
ªs
)

89  
ªs
;

91 
addr
 = 
	`km≠_©omic
(
∑ge
);

92 
	`mem˝y
(
addr
 + 
	`off£t_ö_∑ge
(
pos
), 
buf
, 
n
);

93 
	`kunm≠_©omic
(
addr
);

95 
ªs
 = 
	`∑geˇche_wrôe_íd
(
NULL
, 
öode
->
i_m≠pög
, 
pos
, 
n
,Ç,

96 
∑ge
, 
fsd©a
);

97 i‡(
ªs
 < 0)

98  
ªs
;

99 i‡(
ªs
 !
n
)

100  -
EIO
;

102 
buf
 +
n
;

103 
pos
 +
n
;

104 
cou¡
 -
n
;

107 
	}
}

109 
	$pxt4_begö_íabÀ_vîôy
(
fûe
 *
fûp
)

111 
öode
 *öodê
	`fûe_öode
(
fûp
);

112 c⁄° 
¸edôs
 = 2;

113 
h™dÀ_t
 *
h™dÀ
;

114 
îr
;

116 i‡(
	`pxt4_vîôy_ö_¥ogªss
(
öode
))

117  -
EBUSY
;

125 
îr
 = 
	`pxt4_öode_©èch_jöode
(
öode
);

126 i‡(
îr
)

127  
îr
;

129 
îr
 = 
	`dquŸ_öôülize
(
öode
);

130 i‡(
îr
)

131  
îr
;

133 
îr
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

134 i‡(
îr
)

135  
îr
;

137 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

138 
	`pxt4_w¨nög_öode
(
öode
,

140  -
EOPNOTSUPP
;

147 
îr
 = 
	`pxt4_åunˇã
(
öode
);

148 i‡(
îr
)

149  
îr
;

151 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 
¸edôs
);

152 i‡(
	`IS_ERR
(
h™dÀ
))

153  
	`PTR_ERR
(
h™dÀ
);

155 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

156 i‡(
îr
 == 0)

157 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_VERITY_IN_PROGRESS
);

159 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

160  
îr
;

161 
	}
}

175 
	$pxt4_wrôe_vîôy_des¸ùt‹
(
öode
 *öode, c⁄° *
desc
,

176 
size_t
 
desc_size
, 
u64
 
mîkÀ_åì_size
)

178 c⁄° 
u64
 
desc_pos
 = 
	`round_up
(
	`pxt4_vîôy_mëad©a_pos
(
öode
) +

179 
mîkÀ_åì_size
, 
	`i_blocksize
(
öode
));

180 c⁄° 
u64
 
desc_íd
 = 
desc_pos
 + 
desc_size
;

181 c⁄° 
__À32
 
desc_size_disk
 = 
	`˝u_to_À32
(
desc_size
);

182 c⁄° 
u64
 
desc_size_pos
 = 
	`round_up
(
desc_íd
 + (
desc_size_disk
),

183 
	`i_blocksize
(
öode
)) -

184 (
desc_size_disk
);

185 
îr
;

187 
îr
 = 
	`∑geˇche_wrôe
(
öode
, 
desc
, 
desc_size
, 
desc_pos
);

188 i‡(
îr
)

189  
îr
;

191  
	`∑geˇche_wrôe
(
öode
, &
desc_size_disk
, (desc_size_disk),

192 
desc_size_pos
);

193 
	}
}

195 
	$pxt4_íd_íabÀ_vîôy
(
fûe
 *
fûp
, c⁄° *
desc
,

196 
size_t
 
desc_size
, 
u64
 
mîkÀ_åì_size
)

198 
öode
 *öodê
	`fûe_öode
(
fûp
);

199 c⁄° 
¸edôs
 = 2;

200 
h™dÀ_t
 *
h™dÀ
;

201 
îr
 = 0;

202 
îr2
;

204 i‡(
desc
 !
NULL
) {

206 
îr
 = 
	`pxt4_wrôe_vîôy_des¸ùt‹
(
öode
, 
desc
, 
desc_size
,

207 
mîkÀ_åì_size
);

210 i‡(!
îr
)

211 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

215 i‡(
desc
 =
NULL
 || 
îr
)

216 
	`pxt4_åunˇã
(
öode
);

225 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_VERITY_IN_PROGRESS
);

227 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 
¸edôs
);

228 i‡(
	`IS_ERR
(
h™dÀ
)) {

229 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

230  
	`PTR_ERR
(
h™dÀ
);

233 
îr2
 = 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

234 i‡(
îr2
)

235 
out_°›
;

237 i‡(
desc
 !
NULL
 && !
îr
) {

238 
pxt4_ûoc
 
ûoc
;

240 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

241 i‡(
îr
)

242 
out_°›
;

243 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_VERITY
);

244 
	`pxt4_£t_öode_Êags
(
öode
);

245 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

247 
out_°›
:

248 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

249  
îr
 ?: 
îr2
;

250 
	}
}

252 
	$pxt4_gë_vîôy_des¸ùt‹_loˇti⁄
(
öode
 *inode,

253 
size_t
 *
desc_size_ªt
,

254 
u64
 *
desc_pos_ªt
)

256 
pxt4_ext_∑th
 *
∑th
;

257 
pxt4_exã¡
 *
œ°_exã¡
;

258 
u32
 
íd_lblk
;

259 
u64
 
desc_size_pos
;

260 
__À32
 
desc_size_disk
;

261 
u32
 
desc_size
;

262 
u64
 
desc_pos
;

263 
îr
;

270 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

271 
	`PXT4_ERROR_INODE
(
öode
, "verity file doesn't useÉxtents");

272  -
EFSCORRUPTED
;

275 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
EXT_MAX_BLOCKS
 - 1, 
NULL
, 0);

276 i‡(
	`IS_ERR
(
∑th
))

277  
	`PTR_ERR
(
∑th
);

279 
œ°_exã¡
 = 
∑th
[∑th->
p_dïth
].
p_ext
;

280 i‡(!
œ°_exã¡
) {

281 
	`PXT4_ERROR_INODE
(
öode
, "verity file hasÇoÉxtents");

282 
	`pxt4_ext_dr›_ªfs
(
∑th
);

283 
	`k‰ì
(
∑th
);

284  -
EFSCORRUPTED
;

287 
íd_lblk
 = 
	`À32_to_˝u
(
œ°_exã¡
->
ì_block
) +

288 
	`pxt4_ext_gë_a˘uÆ_Àn
(
œ°_exã¡
);

289 
desc_size_pos
 = (
u64
)
íd_lblk
 << 
öode
->
i_blkbôs
;

290 
	`pxt4_ext_dr›_ªfs
(
∑th
);

291 
	`k‰ì
(
∑th
);

293 i‡(
desc_size_pos
 < (
desc_size_disk
))

294 
bad
;

295 
desc_size_pos
 -(
desc_size_disk
);

297 
îr
 = 
	`∑geˇche_ªad
(
öode
, &
desc_size_disk
, (desc_size_disk),

298 
desc_size_pos
);

299 i‡(
îr
)

300  
îr
;

301 
desc_size
 = 
	`À32_to_˝u
(
desc_size_disk
);

308 i‡(
desc_size
 > 
INT_MAX
 || desc_sizê> 
desc_size_pos
)

309 
bad
;

311 
desc_pos
 = 
	`round_down
(
desc_size_pos
 - 
desc_size
, 
	`i_blocksize
(
öode
));

312 i‡(
desc_pos
 < 
	`pxt4_vîôy_mëad©a_pos
(
öode
))

313 
bad
;

315 *
desc_size_ªt
 = 
desc_size
;

316 *
desc_pos_ªt
 = 
desc_pos
;

319 
bad
:

320 
	`PXT4_ERROR_INODE
(
öode
, "verity file corrupted; can't find descriptor");

321  -
EFSCORRUPTED
;

322 
	}
}

324 
	$pxt4_gë_vîôy_des¸ùt‹
(
öode
 *öode, *
buf
,

325 
size_t
 
buf_size
)

327 
size_t
 
desc_size
 = 0;

328 
u64
 
desc_pos
 = 0;

329 
îr
;

331 
îr
 = 
	`pxt4_gë_vîôy_des¸ùt‹_loˇti⁄
(
öode
, &
desc_size
, &
desc_pos
);

332 i‡(
îr
)

333  
îr
;

335 i‡(
buf_size
) {

336 i‡(
desc_size
 > 
buf_size
)

337  -
ERANGE
;

338 
îr
 = 
	`∑geˇche_ªad
(
öode
, 
buf
, 
desc_size
, 
desc_pos
);

339 i‡(
îr
)

340  
îr
;

342  
desc_size
;

343 
	}
}

345 
∑ge
 *
	$pxt4_ªad_mîkÀ_åì_∑ge
(
öode
 *inode,

346 
pgoff_t
 
ödex
)

348 
ödex
 +
	`pxt4_vîôy_mëad©a_pos
(
öode
Ë>> 
PAGE_SHIFT
;

350  
	`ªad_m≠pög_∑ge
(
öode
->
i_m≠pög
, 
ödex
, 
NULL
);

351 
	}
}

353 
	$pxt4_wrôe_mîkÀ_åì_block
(
öode
 *öode, c⁄° *
buf
,

354 
u64
 
ödex
, 
log_blocksize
)

356 
loff_t
 
pos
 = 
	`pxt4_vîôy_mëad©a_pos
(
öode
Ë+ (
ödex
 << 
log_blocksize
);

358  
	`∑geˇche_wrôe
(
öode
, 
buf
, 1 << 
log_blocksize
, 
pos
);

359 
	}
}

361 c⁄° 
fsvîôy_›î©i⁄s
 
	gpxt4_vîôy›s
 = {

362 .
begö_íabÀ_vîôy
 = 
pxt4_begö_íabÀ_vîôy
,

363 .
	gíd_íabÀ_vîôy
 = 
pxt4_íd_íabÀ_vîôy
,

364 .
	ggë_vîôy_des¸ùt‹
 = 
pxt4_gë_vîôy_des¸ùt‹
,

365 .
	gªad_mîkÀ_åì_∑ge
 = 
pxt4_ªad_mîkÀ_åì_∑ge
,

366 .
	gwrôe_mîkÀ_åì_block
 = 
pxt4_wrôe_mîkÀ_åì_block
,

	@xattr.c

54 
	~<löux/öô.h
>

55 
	~<löux/fs.h
>

56 
	~<löux/¶ab.h
>

57 
	~<löux/mbˇche.h
>

58 
	~<löux/quŸa›s.h
>

59 
	~<löux/ivîsi⁄.h
>

60 
	~"pxt4_jbd3.h
"

61 
	~"pxt4.h
"

62 
	~"x©å.h
"

63 
	~"a˛.h
"

65 #ifde‡
PXT4_XATTR_DEBUG


66 
	#ó_idebug
(
öode
, 
fmt
, ...) \

67 
	`¥ötk
(
KERN_DEBUG
 "öodê%s:%lu: " 
fmt
 "\n", \

68 
öode
->
i_sb
->
s_id
, inode->
i_öo
, ##
__VA_ARGS__
)

	)

69 
	#ó_bdebug
(
bh
, 
fmt
, ...) \

70 
	`¥ötk
(
KERN_DEBUG
 "block %pg:%lu: " 
fmt
 "\n", \

71 
bh
->
b_bdev
, ()bh->
b_blockƒ
, ##
__VA_ARGS__
)

	)

73 
	#ó_idebug
(
öode
, 
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

74 
	#ó_bdebug
(
bh
, 
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

77 
pxt4_x©å_block_ˇche_ö£π
(
mb_ˇche
 *,

78 
buf„r_hód
 *);

79 
buf„r_hód
 *

80 
pxt4_x©å_block_ˇche_föd
(
öode
 *, 
pxt4_x©å_hódî
 *,

81 
mb_ˇche_íåy
 **);

82 
__À32
 
pxt4_x©å_hash_íåy
(*
«me
, 
size_t
 
«me_Àn
, __À32 *
vÆue
,

83 
size_t
 
vÆue_cou¡
);

84 
pxt4_x©å_ªhash
(
pxt4_x©å_hódî
 *);

86 c⁄° 
x©å_h™dÀr
 * c⁄° 
	gpxt4_x©å_h™dÀr_m≠
[] = {

87 [
PXT4_XATTR_INDEX_USER
] = &
pxt4_x©å_u£r_h™dÀr
,

88 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


89 [
PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
] = &
posix_a˛_ac˚ss_x©å_h™dÀr
,

90 [
PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
] = &
posix_a˛_deÁu…_x©å_h™dÀr
,

92 [
PXT4_XATTR_INDEX_TRUSTED
] = &
pxt4_x©å_åu°ed_h™dÀr
,

93 #ifde‡
CONFIG_PXT4_FS_SECURITY


94 [
PXT4_XATTR_INDEX_SECURITY
] = &
pxt4_x©å_£curôy_h™dÀr
,

98 c⁄° 
x©å_h™dÀr
 *
	gpxt4_x©å_h™dÀrs
[] = {

99 &
pxt4_x©å_u£r_h™dÀr
,

100 &
pxt4_x©å_åu°ed_h™dÀr
,

101 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


102 &
posix_a˛_ac˚ss_x©å_h™dÀr
,

103 &
posix_a˛_deÁu…_x©å_h™dÀr
,

105 #ifde‡
CONFIG_PXT4_FS_SECURITY


106 &
pxt4_x©å_£curôy_h™dÀr
,

108 
NULL


111 
	#EA_BLOCK_CACHE
(
öode
Ë(((
pxt4_sb_öfo
 *) \

112 
öode
->
i_sb
->
s_fs_öfo
)->
s_ó_block_ˇche
)

	)

114 
	#EA_INODE_CACHE
(
öode
Ë(((
pxt4_sb_öfo
 *) \

115 
öode
->
i_sb
->
s_fs_öfo
)->
s_ó_öode_ˇche
)

	)

118 
pxt4_ex∑nd_öode_¨øy
(
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

119 
öode
 *inode);

121 #ifde‡
CONFIG_LOCKDEP


122 
	$pxt4_x©å_öode_£t_˛ass
(
öode
 *
ó_öode
)

124 
	`lockdï_£t_sub˛ass
(&
ó_öode
->
i_rw£m
, 1);

125 
	}
}

128 
__À32
 
	$pxt4_x©å_block_csum
(
öode
 *inode,

129 
£˘‹_t
 
block_ƒ
,

130 
pxt4_x©å_hódî
 *
hdr
)

132 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

133 
__u32
 
csum
;

134 
__À64
 
dsk_block_ƒ
 = 
	`˝u_to_À64
(
block_ƒ
);

135 
__u32
 
dummy_csum
 = 0;

136 
off£t
 = 
	`off£tof
(
pxt4_x©å_hódî
, 
h_checksum
);

138 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
dsk_block_ƒ
,

139 (
dsk_block_ƒ
));

140 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
hdr
, 
off£t
);

141 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, (dummy_csum));

142 
off£t
 +(
dummy_csum
);

143 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
hdr
 + 
off£t
,

144 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
Ë- 
off£t
);

146  
	`˝u_to_À32
(
csum
);

147 
	}
}

149 
	$pxt4_x©å_block_csum_vîify
(
öode
 *inode,

150 
buf„r_hód
 *
bh
)

152 
pxt4_x©å_hódî
 *
hdr
 = 
	`BHDR
(
bh
);

153 
ªt
 = 1;

155 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
)) {

156 
	`lock_buf„r
(
bh
);

157 
ªt
 = (
hdr
->
h_checksum
 =
	`pxt4_x©å_block_csum
(
öode
,

158 
bh
->
b_blockƒ
, 
hdr
));

159 
	`u∆ock_buf„r
(
bh
);

161  
ªt
;

162 
	}
}

164 
	$pxt4_x©å_block_csum_£t
(
öode
 *inode,

165 
buf„r_hód
 *
bh
)

167 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

168 
	`BHDR
(
bh
)->
h_checksum
 = 
	`pxt4_x©å_block_csum
(
öode
,

169 
bh
->
b_blockƒ
, 
	`BHDR
(bh));

170 
	}
}

172 
ölöe
 c⁄° 
x©å_h™dÀr
 *

173 
	$pxt4_x©å_h™dÀr
(
«me_ödex
)

175 c⁄° 
x©å_h™dÀr
 *
h™dÀr
 = 
NULL
;

177 i‡(
«me_ödex
 > 0 &&Çame_ödex < 
	`ARRAY_SIZE
(
pxt4_x©å_h™dÀr_m≠
))

178 
h™dÀr
 = 
pxt4_x©å_h™dÀr_m≠
[
«me_ödex
];

179  
h™dÀr
;

180 
	}
}

183 
	$pxt4_x©å_check_íåõs
(
pxt4_x©å_íåy
 *
íåy
, *
íd
,

184 *
vÆue_°¨t
)

186 
pxt4_x©å_íåy
 *
e
 = 
íåy
;

189 !
	`IS_LAST_ENTRY
(
e
)) {

190 
pxt4_x©å_íåy
 *
√xt
 = 
	`PXT4_XATTR_NEXT
(
e
);

191 i‡((*)
√xt
 >
íd
)

192  -
EFSCORRUPTED
;

193 i‡(
	`°∫Àn
(
e
->
e_«me
,É->
e_«me_Àn
) !=É->e_name_len)

194  -
EFSCORRUPTED
;

195 
e
 = 
√xt
;

199 !
	`IS_LAST_ENTRY
(
íåy
)) {

200 
u32
 
size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

202 i‡(
size
 > 
PXT4_XATTR_SIZE_MAX
)

203  -
EFSCORRUPTED
;

205 i‡(
size
 !0 && 
íåy
->
e_vÆue_öum
 == 0) {

206 
u16
 
offs
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

207 *
vÆue
;

215 i‡(
offs
 > 
íd
 - 
vÆue_°¨t
)

216  -
EFSCORRUPTED
;

217 
vÆue
 = 
vÆue_°¨t
 + 
offs
;

218 i‡(
vÆue
 < (*)
e
 + (
u32
) ||

219 
size
 > 
íd
 - 
vÆue
 ||

220 
	`PXT4_XATTR_SIZE
(
size
Ë> 
íd
 - 
vÆue
)

221  -
EFSCORRUPTED
;

223 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry);

227 
	}
}

229 
ölöe
 

230 
	$__pxt4_x©å_check_block
(
öode
 *öode, 
buf„r_hód
 *
bh
,

231 c⁄° *
fun˘i⁄
, 
löe
)

233 
îr‹
 = -
EFSCORRUPTED
;

235 i‡(
	`BHDR
(
bh
)->
h_magic
 !
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
) ||

236 
	`BHDR
(
bh
)->
h_blocks
 !
	`˝u_to_À32
(1))

237 
îrout
;

238 i‡(
	`buf„r_vîifõd
(
bh
))

241 
îr‹
 = -
EFSBADCRC
;

242 i‡(!
	`pxt4_x©å_block_csum_vîify
(
öode
, 
bh
))

243 
îrout
;

244 
îr‹
 = 
	`pxt4_x©å_check_íåõs
(
	`BFIRST
(
bh
), bh->
b_d©a
 + bh->
b_size
,

245 
bh
->
b_d©a
);

246 
îrout
:

247 i‡(
îr‹
)

248 
	`__pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

250 (Ë
bh
->
b_blockƒ
);

252 
	`£t_buf„r_vîifõd
(
bh
);

253  
îr‹
;

254 
	}
}

256 
	#pxt4_x©å_check_block
(
öode
, 
bh
) \

257 
	`__pxt4_x©å_check_block
((
öode
), (
bh
), 
__func__
, 
__LINE__
)

	)

261 
	$__x©å_check_öode
(
öode
 *öode, 
pxt4_x©å_ibody_hódî
 *
hódî
,

262 *
íd
, c⁄° *
fun˘i⁄
, 
löe
)

264 
îr‹
 = -
EFSCORRUPTED
;

266 i‡(
íd
 - (*)
hódî
 < (*hódîË+ (
u32
) ||

267 (
hódî
->
h_magic
 !
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
)))

268 
îrout
;

269 
îr‹
 = 
	`pxt4_x©å_check_íåõs
(
	`IFIRST
(
hódî
), 
íd
, IFIRST(header));

270 
îrout
:

271 i‡(
îr‹
)

272 
	`__pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

274  
îr‹
;

275 
	}
}

277 
	#x©å_check_öode
(
öode
, 
hódî
, 
íd
) \

278 
	`__x©å_check_öode
((
öode
), (
hódî
), (
íd
), 
__func__
, 
__LINE__
)

	)

281 
	$x©å_föd_íåy
(
öode
 *öode, 
pxt4_x©å_íåy
 **
≥¡ry
,

282 *
íd
, 
«me_ödex
, c⁄° *
«me
, 
s‹ãd
)

284 
pxt4_x©å_íåy
 *
íåy
, *
√xt
;

285 
size_t
 
«me_Àn
;

286 
cmp
 = 1;

288 i‡(
«me
 =
NULL
)

289  -
EINVAL
;

290 
«me_Àn
 = 
	`°æí
(
«me
);

291 
íåy
 = *
≥¡ry
; !
	`IS_LAST_ENTRY
”¡ry);É¡ry = 
√xt
) {

292 
√xt
 = 
	`PXT4_XATTR_NEXT
(
íåy
);

293 i‡((*Ë
√xt
 >
íd
) {

294 
	`PXT4_ERROR_INODE
(
öode
, "corrupted xattrÉntries");

295  -
EFSCORRUPTED
;

297 
cmp
 = 
«me_ödex
 - 
íåy
->
e_«me_ödex
;

298 i‡(!
cmp
)

299 
cmp
 = 
«me_Àn
 - 
íåy
->
e_«me_Àn
;

300 i‡(!
cmp
)

301 
cmp
 = 
	`memcmp
(
«me
, 
íåy
->
e_«me
, 
«me_Àn
);

302 i‡(
cmp
 <0 && (
s‹ãd
 || cmp == 0))

305 *
≥¡ry
 = 
íåy
;

306  
cmp
 ? -
ENODATA
 : 0;

307 
	}
}

309 
u32


310 
	$pxt4_x©å_öode_hash
(
pxt4_sb_öfo
 *
sbi
, c⁄° *
buf„r
, 
size_t
 
size
)

312  
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, 
buf„r
, 
size
);

313 
	}
}

315 
u64
 
	$pxt4_x©å_öode_gë_ªf
(
öode
 *
ó_öode
)

317  ((
u64
)
ó_öode
->
i_˘ime
.
tv_£c
 << 32) |

318 (
u32
Ë
	`öode_≥ek_ivîsi⁄_øw
(
ó_öode
);

319 
	}
}

321 
	$pxt4_x©å_öode_£t_ªf
(
öode
 *
ó_öode
, 
u64
 
ªf_cou¡
)

323 
ó_öode
->
i_˘ime
.
tv_£c
 = (
u32
)(
ªf_cou¡
 >> 32);

324 
	`öode_£t_ivîsi⁄_øw
(
ó_öode
, 
ªf_cou¡
 & 0xffffffff);

325 
	}
}

327 
u32
 
	$pxt4_x©å_öode_gë_hash
(
öode
 *
ó_öode
)

329  (
u32
)
ó_öode
->
i_©ime
.
tv_£c
;

330 
	}
}

332 
	$pxt4_x©å_öode_£t_hash
(
öode
 *
ó_öode
, 
u32
 
hash
)

334 
ó_öode
->
i_©ime
.
tv_£c
 = 
hash
;

335 
	}
}

340 
	$pxt4_x©å_öode_ªad
(
öode
 *
ó_öode
, *
buf
, 
size_t
 
size
)

342 
blocksize
 = 1 << 
ó_öode
->
i_blkbôs
;

343 
bh_cou¡
 = (
size
 + 
blocksize
 - 1Ë>> 
ó_öode
->
i_blkbôs
;

344 
èû_size
 = (
size
 % 
blocksize
) ?: blocksize;

345 
buf„r_hód
 *
bhs_ölöe
[8];

346 
buf„r_hód
 **
bhs
 = 
bhs_ölöe
;

347 
i
, 
ªt
;

349 i‡(
bh_cou¡
 > 
	`ARRAY_SIZE
(
bhs_ölöe
)) {

350 
bhs
 = 
	`kmÆloc_¨øy
(
bh_cou¡
, (*bhs), 
GFP_NOFS
);

351 i‡(!
bhs
)

352  -
ENOMEM
;

355 
ªt
 = 
	`pxt4_bªad_b©ch
(
ó_öode
, 0 , 
bh_cou¡
,

356 
åue
 , 
bhs
);

357 i‡(
ªt
)

358 
‰ì_bhs
;

360 
i
 = 0; i < 
bh_cou¡
; i++) {

362 i‡(!
bhs
[
i
]) {

363 
ªt
 = -
EFSCORRUPTED
;

364 
put_bhs
;

366 
	`mem˝y
((*)
buf
 + 
blocksize
 * 
i
, 
bhs
[i]->
b_d©a
,

367 
i
 < 
bh_cou¡
 - 1 ? 
blocksize
 : 
èû_size
);

369 
ªt
 = 0;

370 
put_bhs
:

371 
i
 = 0; i < 
bh_cou¡
; i++)

372 
	`bªl£
(
bhs
[
i
]);

373 
‰ì_bhs
:

374 i‡(
bhs
 !
bhs_ölöe
)

375 
	`k‰ì
(
bhs
);

376  
ªt
;

377 
	}
}

379 
	#PXT4_XATTR_INODE_GET_PARENT
(
öode
Ë((
__u32
)(öode)->
i_mtime
.
tv_£c
)

	)

381 
	$pxt4_x©å_öode_igë
(
öode
 *
∑ª¡
, 
ó_öo
,

382 
u32
 
ó_öode_hash
, 
öode
 **
ó_öode
)

384 
öode
 *inode;

385 
îr
;

387 
öode
 = 
	`pxt4_igë
(
∑ª¡
->
i_sb
, 
ó_öo
, 
PXT4_IGET_NORMAL
);

388 i‡(
	`IS_ERR
(
öode
)) {

389 
îr
 = 
	`PTR_ERR
(
öode
);

390 
	`pxt4_îr‹
(
∑ª¡
->
i_sb
,

391 "îr‹ whûêªadög EA inodê%luÉº=%d", 
ó_öo
,

392 
îr
);

393  
îr
;

396 i‡(
	`is_bad_öode
(
öode
)) {

397 
	`pxt4_îr‹
(
∑ª¡
->
i_sb
,

399 
ó_öo
);

400 
îr
 = -
EIO
;

401 
îr‹
;

404 i‡(!(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

405 
	`pxt4_îr‹
(
∑ª¡
->
i_sb
,

407 
ó_öo
);

408 
îr
 = -
EINVAL
;

409 
îr‹
;

412 
	`pxt4_x©å_öode_£t_˛ass
(
öode
);

419 i‡(
ó_öode_hash
 !
	`pxt4_x©å_öode_gë_hash
(
öode
) &&

420 
	`PXT4_XATTR_INODE_GET_PARENT
(
öode
Ë=
∑ª¡
->
i_öo
 &&

421 
öode
->
i_gíî©i⁄
 =
∑ª¡
->i_generation) {

422 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_LUSTRE_EA_INODE
);

423 
	`pxt4_x©å_öode_£t_ªf
(
öode
, 1);

425 
	`öode_lock
(
öode
);

426 
öode
->
i_Êags
 |
S_NOQUOTA
;

427 
	`öode_u∆ock
(
öode
);

430 *
ó_öode
 = 
öode
;

432 
îr‹
:

433 
	`ùut
(
öode
);

434  
îr
;

435 
	}
}

438 
	$pxt4_x©å_öode_vîify_hashes
(
öode
 *
ó_öode
,

439 
pxt4_x©å_íåy
 *
íåy
, *
buf„r
,

440 
size_t
 
size
)

442 
u32
 
hash
;

445 
hash
 = 
	`pxt4_x©å_öode_hash
(
	`PXT4_SB
(
ó_öode
->
i_sb
), 
buf„r
, 
size
);

446 i‡(
hash
 !
	`pxt4_x©å_öode_gë_hash
(
ó_öode
))

447  -
EFSCORRUPTED
;

449 i‡(
íåy
) {

450 
__À32
 
e_hash
, 
tmp_d©a
;

453 
tmp_d©a
 = 
	`˝u_to_À32
(
hash
);

454 
e_hash
 = 
	`pxt4_x©å_hash_íåy
(
íåy
->
e_«me
,É¡ry->
e_«me_Àn
,

455 &
tmp_d©a
, 1);

456 i‡(
e_hash
 !
íåy
->e_hash)

457  -
EFSCORRUPTED
;

460 
	}
}

466 
	$pxt4_x©å_öode_gë
(
öode
 *öode, 
pxt4_x©å_íåy
 *
íåy
,

467 *
buf„r
, 
size_t
 
size
)

469 
mb_ˇche
 *
ó_öode_ˇche
 = 
	`EA_INODE_CACHE
(
öode
);

470 
öode
 *
ó_öode
;

471 
îr
;

473 
îr
 = 
	`pxt4_x©å_öode_igë
(
öode
, 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
),

474 
	`À32_to_˝u
(
íåy
->
e_hash
), &
ó_öode
);

475 i‡(
îr
) {

476 
ó_öode
 = 
NULL
;

477 
out
;

480 i‡(
	`i_size_ªad
(
ó_öode
Ë!
size
) {

481 
	`pxt4_w¨nög_öode
(
ó_öode
,

483 
	`i_size_ªad
(
ó_öode
), 
size
);

484 
îr
 = -
EFSCORRUPTED
;

485 
out
;

488 
îr
 = 
	`pxt4_x©å_öode_ªad
(
ó_öode
, 
buf„r
, 
size
);

489 i‡(
îr
)

490 
out
;

492 i‡(!
	`pxt4_ã°_öode_°©e
(
ó_öode
, 
PXT4_STATE_LUSTRE_EA_INODE
)) {

493 
îr
 = 
	`pxt4_x©å_öode_vîify_hashes
(
ó_öode
, 
íåy
, 
buf„r
,

494 
size
);

495 i‡(
îr
) {

496 
	`pxt4_w¨nög_öode
(
ó_öode
,

498 
out
;

501 i‡(
ó_öode_ˇche
)

502 
	`mb_ˇche_íåy_¸óã
(
ó_öode_ˇche
, 
GFP_NOFS
,

503 
	`pxt4_x©å_öode_gë_hash
(
ó_öode
),

504 
ó_öode
->
i_öo
, 
åue
 );

506 
out
:

507 
	`ùut
(
ó_öode
);

508  
îr
;

509 
	}
}

512 
	$pxt4_x©å_block_gë
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

513 *
buf„r
, 
size_t
 
buf„r_size
)

515 
buf„r_hód
 *
bh
 = 
NULL
;

516 
pxt4_x©å_íåy
 *
íåy
;

517 
size_t
 
size
;

518 *
íd
;

519 
îr‹
;

520 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

522 
	`ó_idebug
(
öode
, "name=%d.%s, buffer=%p, buffer_size=%ld",

523 
«me_ödex
, 
«me
, 
buf„r
, ()
buf„r_size
);

525 i‡(!
	`PXT4_I
(
öode
)->
i_fûe_a˛
)

526  -
ENODATA
;

527 
	`ó_idebug
(
öode
, "reading block %llu",

528 ()
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

529 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

530 i‡(
	`IS_ERR
(
bh
))

531  
	`PTR_ERR
(
bh
);

532 
	`ó_bdebug
(
bh
, "b_count=%d,Ñefcount=%d",

533 
	`©omic_ªad
(&(
bh
->
b_cou¡
)), 
	`À32_to_˝u
(
	`BHDR
(bh)->
h_ªfcou¡
));

534 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

535 i‡(
îr‹
)

536 
˛ónup
;

537 
	`pxt4_x©å_block_ˇche_ö£π
(
ó_block_ˇche
, 
bh
);

538 
íåy
 = 
	`BFIRST
(
bh
);

539 
íd
 = 
bh
->
b_d©a
 + bh->
b_size
;

540 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
íåy
, 
íd
, 
«me_ödex
, 
«me
, 1);

541 i‡(
îr‹
)

542 
˛ónup
;

543 
size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

544 
îr‹
 = -
ERANGE
;

545 i‡(
	`u∆ikñy
(
size
 > 
PXT4_XATTR_SIZE_MAX
))

546 
˛ónup
;

547 i‡(
buf„r
) {

548 i‡(
size
 > 
buf„r_size
)

549 
˛ónup
;

550 i‡(
íåy
->
e_vÆue_öum
) {

551 
îr‹
 = 
	`pxt4_x©å_öode_gë
(
öode
, 
íåy
, 
buf„r
,

552 
size
);

553 i‡(
îr‹
)

554 
˛ónup
;

556 
u16
 
off£t
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

557 *
p
 = 
bh
->
b_d©a
 + 
off£t
;

559 i‡(
	`u∆ikñy
(
p
 + 
size
 > 
íd
))

560 
˛ónup
;

561 
	`mem˝y
(
buf„r
, 
p
, 
size
);

564 
îr‹
 = 
size
;

566 
˛ónup
:

567 
	`bªl£
(
bh
);

568  
îr‹
;

569 
	}
}

572 
	$pxt4_x©å_ibody_gë
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

573 *
buf„r
, 
size_t
 
buf„r_size
)

575 
pxt4_x©å_ibody_hódî
 *
hódî
;

576 
pxt4_x©å_íåy
 *
íåy
;

577 
pxt4_öode
 *
øw_öode
;

578 
pxt4_ûoc
 
ûoc
;

579 
size_t
 
size
;

580 *
íd
;

581 
îr‹
;

583 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
))

584  -
ENODATA
;

585 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

586 i‡(
îr‹
)

587  
îr‹
;

588 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

589 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

590 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

591 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

592 i‡(
îr‹
)

593 
˛ónup
;

594 
íåy
 = 
	`IFIRST
(
hódî
);

595 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
íåy
, 
íd
, 
«me_ödex
, 
«me
, 0);

596 i‡(
îr‹
)

597 
˛ónup
;

598 
size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

599 
îr‹
 = -
ERANGE
;

600 i‡(
	`u∆ikñy
(
size
 > 
PXT4_XATTR_SIZE_MAX
))

601 
˛ónup
;

602 i‡(
buf„r
) {

603 i‡(
size
 > 
buf„r_size
)

604 
˛ónup
;

605 i‡(
íåy
->
e_vÆue_öum
) {

606 
îr‹
 = 
	`pxt4_x©å_öode_gë
(
öode
, 
íåy
, 
buf„r
,

607 
size
);

608 i‡(
îr‹
)

609 
˛ónup
;

611 
u16
 
off£t
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

612 *
p
 = (*)
	`IFIRST
(
hódî
Ë+ 
off£t
;

614 i‡(
	`u∆ikñy
(
p
 + 
size
 > 
íd
))

615 
˛ónup
;

616 
	`mem˝y
(
buf„r
, 
p
, 
size
);

619 
îr‹
 = 
size
;

621 
˛ónup
:

622 
	`bªl£
(
ûoc
.
bh
);

623  
îr‹
;

624 
	}
}

637 
	$pxt4_x©å_gë
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

638 *
buf„r
, 
size_t
 
buf„r_size
)

640 
îr‹
;

642 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

643  -
EIO
;

645 i‡(
	`°æí
(
«me
) > 255)

646  -
ERANGE
;

648 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

649 
îr‹
 = 
	`pxt4_x©å_ibody_gë
(
öode
, 
«me_ödex
, 
«me
, 
buf„r
,

650 
buf„r_size
);

651 i‡(
îr‹
 =-
ENODATA
)

652 
îr‹
 = 
	`pxt4_x©å_block_gë
(
öode
, 
«me_ödex
, 
«me
, 
buf„r
,

653 
buf„r_size
);

654 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

655  
îr‹
;

656 
	}
}

659 
	$pxt4_x©å_li°_íåõs
(
díåy
 *díåy, 
pxt4_x©å_íåy
 *
íåy
,

660 *
buf„r
, 
size_t
 
buf„r_size
)

662 
size_t
 
ª°
 = 
buf„r_size
;

664 ; !
	`IS_LAST_ENTRY
(
íåy
);É¡ry = 
	`PXT4_XATTR_NEXT
(entry)) {

665 c⁄° 
x©å_h™dÀr
 *
h™dÀr
 =

666 
	`pxt4_x©å_h™dÀr
(
íåy
->
e_«me_ödex
);

668 i‡(
h™dÀr
 && (!h™dÀr->
li°
 || h™dÀr->
	`li°
(
díåy
))) {

669 c⁄° *
¥efix
 = 
h™dÀr
->¥efix ?: h™dÀr->
«me
;

670 
size_t
 
¥efix_Àn
 = 
	`°æí
(
¥efix
);

671 
size_t
 
size
 = 
¥efix_Àn
 + 
íåy
->
e_«me_Àn
 + 1;

673 i‡(
buf„r
) {

674 i‡(
size
 > 
ª°
)

675  -
ERANGE
;

676 
	`mem˝y
(
buf„r
, 
¥efix
, 
¥efix_Àn
);

677 
buf„r
 +
¥efix_Àn
;

678 
	`mem˝y
(
buf„r
, 
íåy
->
e_«me
,É¡ry->
e_«me_Àn
);

679 
buf„r
 +
íåy
->
e_«me_Àn
;

680 *
buf„r
++ = 0;

682 
ª°
 -
size
;

685  
buf„r_size
 - 
ª°
;

686 
	}
}

689 
	$pxt4_x©å_block_li°
(
díåy
 *díåy, *
buf„r
, 
size_t
 
buf„r_size
)

691 
öode
 *öodê
	`d_öode
(
díåy
);

692 
buf„r_hód
 *
bh
 = 
NULL
;

693 
îr‹
;

695 
	`ó_idebug
(
öode
, "buffer=%p, buffer_size=%ld",

696 
buf„r
, ()
buf„r_size
);

698 i‡(!
	`PXT4_I
(
öode
)->
i_fûe_a˛
)

700 
	`ó_idebug
(
öode
, "reading block %llu",

701 ()
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

702 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

703 i‡(
	`IS_ERR
(
bh
))

704  
	`PTR_ERR
(
bh
);

705 
	`ó_bdebug
(
bh
, "b_count=%d,Ñefcount=%d",

706 
	`©omic_ªad
(&(
bh
->
b_cou¡
)), 
	`À32_to_˝u
(
	`BHDR
(bh)->
h_ªfcou¡
));

707 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

708 i‡(
îr‹
)

709 
˛ónup
;

710 
	`pxt4_x©å_block_ˇche_ö£π
(
	`EA_BLOCK_CACHE
(
öode
), 
bh
);

711 
îr‹
 = 
	`pxt4_x©å_li°_íåõs
(
díåy
, 
	`BFIRST
(
bh
), 
buf„r
,

712 
buf„r_size
);

713 
˛ónup
:

714 
	`bªl£
(
bh
);

715  
îr‹
;

716 
	}
}

719 
	$pxt4_x©å_ibody_li°
(
díåy
 *díåy, *
buf„r
, 
size_t
 
buf„r_size
)

721 
öode
 *öodê
	`d_öode
(
díåy
);

722 
pxt4_x©å_ibody_hódî
 *
hódî
;

723 
pxt4_öode
 *
øw_öode
;

724 
pxt4_ûoc
 
ûoc
;

725 *
íd
;

726 
îr‹
;

728 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
))

730 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

731 i‡(
îr‹
)

732  
îr‹
;

733 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

734 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

735 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

736 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

737 i‡(
îr‹
)

738 
˛ónup
;

739 
îr‹
 = 
	`pxt4_x©å_li°_íåõs
(
díåy
, 
	`IFIRST
(
hódî
),

740 
buf„r
, 
buf„r_size
);

742 
˛ónup
:

743 
	`bªl£
(
ûoc
.
bh
);

744  
îr‹
;

745 
	}
}

759 
ssize_t


760 
	$pxt4_li°x©å
(
díåy
 *díåy, *
buf„r
, 
size_t
 
buf„r_size
)

762 
ªt
, 
ªt2
;

764 
	`down_ªad
(&
	`PXT4_I
(
	`d_öode
(
díåy
))->
x©å_£m
);

765 
ªt
 = 
ªt2
 = 
	`pxt4_x©å_ibody_li°
(
díåy
, 
buf„r
, 
buf„r_size
);

766 i‡(
ªt
 < 0)

767 
îrout
;

768 i‡(
buf„r
) {

769 
buf„r
 +
ªt
;

770 
buf„r_size
 -
ªt
;

772 
ªt
 = 
	`pxt4_x©å_block_li°
(
díåy
, 
buf„r
, 
buf„r_size
);

773 i‡(
ªt
 < 0)

774 
îrout
;

775 
ªt
 +
ªt2
;

776 
îrout
:

777 
	`up_ªad
(&
	`PXT4_I
(
	`d_öode
(
díåy
))->
x©å_£m
);

778  
ªt
;

779 
	}
}

785 
	$pxt4_x©å_upd©e_su≥r_block
(
h™dÀ_t
 *
h™dÀ
,

786 
su≥r_block
 *
sb
)

788 i‡(
	`pxt4_has_„©uª_x©å
(
sb
))

791 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

792 i‡(
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
) == 0) {

793 
	`pxt4_£t_„©uª_x©å
(
sb
);

794 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

796 
	}
}

798 
	$pxt4_gë_öode_ußge
(
öode
 *öode, 
qsize_t
 *
ußge
)

800 
pxt4_ûoc
 
ûoc
 = { .
bh
 = 
NULL
 };

801 
buf„r_hód
 *
bh
 = 
NULL
;

802 
pxt4_öode
 *
øw_öode
;

803 
pxt4_x©å_ibody_hódî
 *
hódî
;

804 
pxt4_x©å_íåy
 *
íåy
;

805 
qsize_t
 
ó_öode_ªfs
 = 0;

806 *
íd
;

807 
ªt
;

809 
	`lockdï_as£π_hñd_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

811 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

812 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

813 i‡(
ªt
)

814 
out
;

815 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

816 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

817 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

818 
ªt
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

819 i‡(
ªt
)

820 
out
;

822 
íåy
 = 
	`IFIRST
(
hódî
); !
	`IS_LAST_ENTRY
(entry);

823 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry))

824 i‡(
íåy
->
e_vÆue_öum
)

825 
ó_öode_ªfs
++;

828 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

829 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

830 i‡(
	`IS_ERR
(
bh
)) {

831 
ªt
 = 
	`PTR_ERR
(
bh
);

832 
bh
 = 
NULL
;

833 
out
;

836 
ªt
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

837 i‡(
ªt
)

838 
out
;

840 
íåy
 = 
	`BFIRST
(
bh
); !
	`IS_LAST_ENTRY
(entry);

841 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry))

842 i‡(
íåy
->
e_vÆue_öum
)

843 
ó_öode_ªfs
++;

845 *
ußge
 = 
ó_öode_ªfs
 + 1;

846 
ªt
 = 0;

847 
out
:

848 
	`bªl£
(
ûoc
.
bh
);

849 
	`bªl£
(
bh
);

850  
ªt
;

851 
	}
}

853 
ölöe
 
size_t
 
	$round_up_˛u°î
(
öode
 *öode, 
size_t
 
Àngth
)

855 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

856 
size_t
 
˛u°î_size
 = 1 << (
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
 +

857 
öode
->
i_blkbôs
);

858 
size_t
 
mask
 = ~(
˛u°î_size
 - 1);

860  (
Àngth
 + 
˛u°î_size
 - 1Ë& 
mask
;

861 
	}
}

863 
	$pxt4_x©å_öode_Æloc_quŸa
(
öode
 *öode, 
size_t
 
Àn
)

865 
îr
;

867 
îr
 = 
	`dquŸ_Æloc_öode
(
öode
);

868 i‡(
îr
)

869  
îr
;

870 
îr
 = 
	`dquŸ_Æloc_•a˚_nodúty
(
öode
, 
	`round_up_˛u°î
(öode, 
Àn
));

871 i‡(
îr
)

872 
	`dquŸ_‰ì_öode
(
öode
);

873  
îr
;

874 
	}
}

876 
	$pxt4_x©å_öode_‰ì_quŸa
(
öode
 *
∑ª¡
,

877 
öode
 *
ó_öode
,

878 
size_t
 
Àn
)

880 i‡(
ó_öode
 &&

881 
	`pxt4_ã°_öode_°©e
(
ó_öode
, 
PXT4_STATE_LUSTRE_EA_INODE
))

883 
	`dquŸ_‰ì_•a˚_nodúty
(
∑ª¡
, 
	`round_up_˛u°î
’¨ít, 
Àn
));

884 
	`dquŸ_‰ì_öode
(
∑ª¡
);

885 
	}
}

887 
	$__pxt4_x©å_£t_¸edôs
(
su≥r_block
 *
sb
, 
öode
 *inode,

888 
buf„r_hód
 *
block_bh
, 
size_t
 
vÆue_Àn
,

889 
boﬁ
 
is_¸óã
)

891 
¸edôs
;

892 
blocks
;

907 
¸edôs
 = 7;

910 
¸edôs
 +
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
);

916 i‡(
öode
 && 
	`pxt4_has_ölöe_d©a
(inode))

917 
¸edôs
 +
	`pxt4_wrôïage_å™s_blocks
(
öode
) + 1;

920 i‡(!
	`pxt4_has_„©uª_ó_öode
(
sb
))

921  
¸edôs
;

924 
¸edôs
 += 4;

927 
blocks
 = (
vÆue_Àn
 + 
sb
->
s_blocksize
 - 1Ë>> sb->
s_blocksize_bôs
;

930 
blocks
 += 1;

933 
¸edôs
 +
blocks
 * 2;

936 
¸edôs
 +
blocks
;

938 i‡(!
is_¸óã
) {

942 
¸edôs
 += 4;

945 
blocks
 = 
XATTR_SIZE_MAX
 >> 
sb
->
s_blocksize_bôs
;

950 
blocks
 += 1;

953 
¸edôs
 +
blocks
 * 2;

959 i‡(
block_bh
) {

960 
pxt4_x©å_íåy
 *
íåy
 = 
	`BFIRST
(
block_bh
);

962 ; !
	`IS_LAST_ENTRY
(
íåy
);É¡ry = 
	`PXT4_XATTR_NEXT
(entry))

963 i‡(
íåy
->
e_vÆue_öum
)

965 
¸edôs
 += 1;

967  
¸edôs
;

968 
	}
}

970 
	$pxt4_x©å_ísuª_¸edôs
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

971 
¸edôs
, 
buf„r_hód
 *
bh
,

972 
boﬁ
 
dúty
, boﬁ 
block_csum
)

974 
îr‹
;

976 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

979 i‡(
h™dÀ
->
h_buf„r_¸edôs
 >
¸edôs
)

982 
îr‹
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
¸edôs
 - h™dÀ->
h_buf„r_¸edôs
);

983 i‡(!
îr‹
)

985 i‡(
îr‹
 < 0) {

986 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Exãnd jou∫Æ (îr‹ %d)", 
îr‹
);

987  
îr‹
;

990 i‡(
bh
 && 
dúty
) {

991 i‡(
block_csum
)

992 
	`pxt4_x©å_block_csum_£t
(
öode
, 
bh
);

993 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

994 i‡(
îr‹
) {

995 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Handle metadata (error %d)",

996 
îr‹
);

997  
îr‹
;

1001 
îr‹
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
¸edôs
);

1002 i‡(
îr‹
) {

1003 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Re°¨àjou∫Æ (îr‹ %d)", 
îr‹
);

1004  
îr‹
;

1007 i‡(
bh
) {

1008 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1009 i‡(
îr‹
) {

1010 
	`pxt4_w¨nög
(
öode
->
i_sb
,

1012 
îr‹
);

1013  
îr‹
;

1017 
	}
}

1019 
	$pxt4_x©å_öode_upd©e_ªf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
,

1020 
ªf_ch™ge
)

1022 
mb_ˇche
 *
ó_öode_ˇche
 = 
	`EA_INODE_CACHE
(
ó_öode
);

1023 
pxt4_ûoc
 
ûoc
;

1024 
s64
 
ªf_cou¡
;

1025 
u32
 
hash
;

1026 
ªt
;

1028 
	`öode_lock
(
ó_öode
);

1030 
ªt
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
ó_öode
, &
ûoc
);

1031 i‡(
ªt
)

1032 
out
;

1034 
ªf_cou¡
 = 
	`pxt4_x©å_öode_gë_ªf
(
ó_öode
);

1035 
ªf_cou¡
 +
ªf_ch™ge
;

1036 
	`pxt4_x©å_öode_£t_ªf
(
ó_öode
, 
ªf_cou¡
);

1038 i‡(
ªf_ch™ge
 > 0) {

1039 
	`WARN_ONCE
(
ªf_cou¡
 <= 0, "EA inode %luÑef_count=%lld",

1040 
ó_öode
->
i_öo
, 
ªf_cou¡
);

1042 i‡(
ªf_cou¡
 == 1) {

1043 
	`WARN_ONCE
(
ó_öode
->
i_∆ök
, "EA inode %lu i_nlink=%u",

1044 
ó_öode
->
i_öo
,Éa_öode->
i_∆ök
);

1046 
	`£t_∆ök
(
ó_öode
, 1);

1047 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
ó_öode
);

1049 i‡(
ó_öode_ˇche
) {

1050 
hash
 = 
	`pxt4_x©å_öode_gë_hash
(
ó_öode
);

1051 
	`mb_ˇche_íåy_¸óã
(
ó_öode_ˇche
,

1052 
GFP_NOFS
, 
hash
,

1053 
ó_öode
->
i_öo
,

1054 
åue
 );

1058 
	`WARN_ONCE
(
ªf_cou¡
 < 0, "EA inode %luÑef_count=%lld",

1059 
ó_öode
->
i_öo
, 
ªf_cou¡
);

1061 i‡(
ªf_cou¡
 == 0) {

1062 
	`WARN_ONCE
(
ó_öode
->
i_∆ök
 != 1,

1064 
ó_öode
->
i_öo
,Éa_öode->
i_∆ök
);

1066 
	`˛ór_∆ök
(
ó_öode
);

1067 
	`pxt4_‹ph™_add
(
h™dÀ
, 
ó_öode
);

1069 i‡(
ó_öode_ˇche
) {

1070 
hash
 = 
	`pxt4_x©å_öode_gë_hash
(
ó_öode
);

1071 
	`mb_ˇche_íåy_dñëe
(
ó_öode_ˇche
, 
hash
,

1072 
ó_öode
->
i_öo
);

1077 
ªt
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
ó_öode
, &
ûoc
);

1078 i‡(
ªt
)

1079 
	`pxt4_w¨nög_öode
(
ó_öode
,

1080 "pxt4_m¨k_ûoc_dúty(ËÁûedÑë=%d", 
ªt
);

1081 
out
:

1082 
	`öode_u∆ock
(
ó_öode
);

1083  
ªt
;

1084 
	}
}

1086 
	$pxt4_x©å_öode_öc_ªf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
)

1088  
	`pxt4_x©å_öode_upd©e_ªf
(
h™dÀ
, 
ó_öode
, 1);

1089 
	}
}

1091 
	$pxt4_x©å_öode_dec_ªf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
)

1093  
	`pxt4_x©å_öode_upd©e_ªf
(
h™dÀ
, 
ó_öode
, -1);

1094 
	}
}

1096 
	$pxt4_x©å_öode_öc_ªf_Æl
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
∑ª¡
,

1097 
pxt4_x©å_íåy
 *
fú°
)

1099 
öode
 *
ó_öode
;

1100 
pxt4_x©å_íåy
 *
íåy
;

1101 
pxt4_x©å_íåy
 *
Áûed_íåy
;

1102 
ó_öo
;

1103 
îr
, 
ßved_îr
;

1105 
íåy
 = 
fú°
; !
	`IS_LAST_ENTRY
(entry);

1106 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

1107 i‡(!
íåy
->
e_vÆue_öum
)

1109 
ó_öo
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
);

1110 
îr
 = 
	`pxt4_x©å_öode_igë
(
∑ª¡
, 
ó_öo
,

1111 
	`À32_to_˝u
(
íåy
->
e_hash
),

1112 &
ó_öode
);

1113 i‡(
îr
)

1114 
˛ónup
;

1115 
îr
 = 
	`pxt4_x©å_öode_öc_ªf
(
h™dÀ
, 
ó_öode
);

1116 i‡(
îr
) {

1117 
	`pxt4_w¨nög_öode
(
ó_öode
, "ö¯ª‡îr‹ %d", 
îr
);

1118 
	`ùut
(
ó_öode
);

1119 
˛ónup
;

1121 
	`ùut
(
ó_öode
);

1125 
˛ónup
:

1126 
ßved_îr
 = 
îr
;

1127 
Áûed_íåy
 = 
íåy
;

1129 
íåy
 = 
fú°
;É¡ry !
Áûed_íåy
;

1130 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

1131 i‡(!
íåy
->
e_vÆue_öum
)

1133 
ó_öo
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
);

1134 
îr
 = 
	`pxt4_x©å_öode_igë
(
∑ª¡
, 
ó_öo
,

1135 
	`À32_to_˝u
(
íåy
->
e_hash
),

1136 &
ó_öode
);

1137 i‡(
îr
) {

1138 
	`pxt4_w¨nög
(
∑ª¡
->
i_sb
,

1139 "˛ónu∞ó_öÿ%u igëÉº‹ %d", 
ó_öo
,

1140 
îr
);

1143 
îr
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

1144 i‡(
îr
)

1145 
	`pxt4_w¨nög_öode
(
ó_öode
, "cleanup decÑefÉrror %d",

1146 
îr
);

1147 
	`ùut
(
ó_öode
);

1149  
ßved_îr
;

1150 
	}
}

1153 
	$pxt4_x©å_öode_dec_ªf_Æl
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
∑ª¡
,

1154 
buf„r_hód
 *
bh
,

1155 
pxt4_x©å_íåy
 *
fú°
, 
boﬁ
 
block_csum
,

1156 
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

1157 
exåa_¸edôs
, 
boﬁ
 
skù_quŸa
)

1159 
öode
 *
ó_öode
;

1160 
pxt4_x©å_íåy
 *
íåy
;

1161 
boﬁ
 
dúty
 = 
Ál£
;

1162 
ó_öo
;

1163 
îr
;

1164 
¸edôs
;

1167 
¸edôs
 = 2 + 
exåa_¸edôs
;

1169 
íåy
 = 
fú°
; !
	`IS_LAST_ENTRY
(entry);

1170 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

1171 i‡(!
íåy
->
e_vÆue_öum
)

1173 
ó_öo
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
);

1174 
îr
 = 
	`pxt4_x©å_öode_igë
(
∑ª¡
, 
ó_öo
,

1175 
	`À32_to_˝u
(
íåy
->
e_hash
),

1176 &
ó_öode
);

1177 i‡(
îr
)

1180 
îr
 = 
	`pxt4_ex∑nd_öode_¨øy
(
ó_öode_¨øy
, 
ó_öode
);

1181 i‡(
îr
) {

1182 
	`pxt4_w¨nög_öode
(
ó_öode
,

1183 "Ex∑nd inodê¨øyÉº=%d", 
îr
);

1184 
	`ùut
(
ó_öode
);

1188 
îr
 = 
	`pxt4_x©å_ísuª_¸edôs
(
h™dÀ
, 
∑ª¡
, 
¸edôs
, 
bh
,

1189 
dúty
, 
block_csum
);

1190 i‡(
îr
) {

1191 
	`pxt4_w¨nög_öode
(
ó_öode
, "Ensure creditsÉrr=%d",

1192 
îr
);

1196 
îr
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

1197 i‡(
îr
) {

1198 
	`pxt4_w¨nög_öode
(
ó_öode
, "ea_inode decÑefÉrr=%d",

1199 
îr
);

1203 i‡(!
skù_quŸa
)

1204 
	`pxt4_x©å_öode_‰ì_quŸa
(
∑ª¡
, 
ó_öode
,

1205 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

1213 
íåy
->
e_vÆue_öum
 = 0;

1214 
íåy
->
e_vÆue_size
 = 0;

1216 
dúty
 = 
åue
;

1219 i‡(
dúty
) {

1226 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1227 i‡(
îr
)

1228 
	`pxt4_w¨nög_öode
(
∑ª¡
,

1229 "h™dÀ dúty mëad©®îr=%d", 
îr
);

1231 
	}
}

1238 
	$pxt4_x©å_ªÀa£_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1239 
buf„r_hód
 *
bh
,

1240 
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

1241 
exåa_¸edôs
)

1243 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

1244 
u32
 
hash
, 
ªf
;

1245 
îr‹
 = 0;

1247 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1248 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1249 i‡(
îr‹
)

1250 
out
;

1252 
	`lock_buf„r
(
bh
);

1253 
hash
 = 
	`À32_to_˝u
(
	`BHDR
(
bh
)->
h_hash
);

1254 
ªf
 = 
	`À32_to_˝u
(
	`BHDR
(
bh
)->
h_ªfcou¡
);

1255 i‡(
ªf
 == 1) {

1256 
	`ó_bdebug
(
bh
, "refcountÇow=0; freeing");

1261 i‡(
ó_block_ˇche
)

1262 
	`mb_ˇche_íåy_dñëe
(
ó_block_ˇche
, 
hash
,

1263 
bh
->
b_blockƒ
);

1264 
	`gë_bh
(
bh
);

1265 
	`u∆ock_buf„r
(
bh
);

1267 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
))

1268 
	`pxt4_x©å_öode_dec_ªf_Æl
(
h™dÀ
, 
öode
, 
bh
,

1269 
	`BFIRST
(
bh
),

1270 
åue
 ,

1271 
ó_öode_¨øy
,

1272 
exåa_¸edôs
,

1273 
åue
 );

1274 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
bh
, 0, 1,

1275 
PXT4_FREE_BLOCKS_METADATA
 |

1276 
PXT4_FREE_BLOCKS_FORGET
);

1278 
ªf
--;

1279 
	`BHDR
(
bh
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(
ªf
);

1280 i‡(
ªf
 =
PXT4_XATTR_REFCOUNT_MAX
 - 1) {

1281 
mb_ˇche_íåy
 *
˚
;

1283 i‡(
ó_block_ˇche
) {

1284 
˚
 = 
	`mb_ˇche_íåy_gë
(
ó_block_ˇche
, 
hash
,

1285 
bh
->
b_blockƒ
);

1286 i‡(
˚
) {

1287 
˚
->
e_ªußbÀ
 = 1;

1288 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

1293 
	`pxt4_x©å_block_csum_£t
(
öode
, 
bh
);

1304 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

1305 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1306 
	`u∆ock_buf„r
(
bh
);

1307 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

1308 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1309 i‡(
	`IS_SYNC
(
öode
))

1310 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

1311 
	`dquŸ_‰ì_block
(
öode
, 
	`PXT4_C2B
(
	`PXT4_SB
(öode->
i_sb
), 1));

1312 
	`ó_bdebug
(
bh
, "refcountÇow=%d;Ñeleasing",

1313 
	`À32_to_˝u
(
	`BHDR
(
bh
)->
h_ªfcou¡
));

1315 
out
:

1316 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr‹
);

1318 
	}
}

1324 
size_t
 
	$pxt4_x©å_‰ì_•a˚
(
pxt4_x©å_íåy
 *
œ°
,

1325 
size_t
 *
mö_offs
, *
ba£
, *
tŸÆ
)

1327 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
	`PXT4_XATTR_NEXT
(last)) {

1328 i‡(!
œ°
->
e_vÆue_öum
 &&Üa°->
e_vÆue_size
) {

1329 
size_t
 
offs
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
);

1330 i‡(
offs
 < *
mö_offs
)

1331 *
mö_offs
 = 
offs
;

1333 i‡(
tŸÆ
)

1334 *
tŸÆ
 +
	`PXT4_XATTR_LEN
(
œ°
->
e_«me_Àn
);

1336  (*
mö_offs
 - ((*)
œ°
 - 
ba£
Ë- (
__u32
));

1337 
	}
}

1342 
	$pxt4_x©å_öode_wrôe
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
,

1343 c⁄° *
buf
, 
bufsize
)

1345 
buf„r_hód
 *
bh
 = 
NULL
;

1346 
block
 = 0;

1347 
blocksize
 = 
ó_öode
->
i_sb
->
s_blocksize
;

1348 
max_blocks
 = (
bufsize
 + 
blocksize
 - 1Ë>> 
ó_öode
->
i_blkbôs
;

1349 
csize
, 
wsize
 = 0;

1350 
ªt
 = 0;

1351 
ªåõs
 = 0;

1353 
ªåy
:

1354 
ªt
 >0 &&Ñë < 
max_blocks
) {

1355 
pxt4_m≠_blocks
 
m≠
;

1356 
m≠
.
m_lblk
 = 
block
 +
ªt
;

1357 
m≠
.
m_Àn
 = 
max_blocks
 -
ªt
;

1359 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
ó_öode
, &
m≠
,

1360 
PXT4_GET_BLOCKS_CREATE
);

1361 i‡(
ªt
 <= 0) {

1362 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ó_öode
);

1363 i‡(
ªt
 =-
ENOSPC
 &&

1364 
	`pxt4_should_ªåy_Æloc
(
ó_öode
->
i_sb
, &
ªåõs
)) {

1365 
ªt
 = 0;

1366 
ªåy
;

1372 i‡(
ªt
 < 0)

1373  
ªt
;

1375 
block
 = 0;

1376 
wsize
 < 
bufsize
) {

1377 i‡(
bh
 !
NULL
)

1378 
	`bªl£
(
bh
);

1379 
csize
 = (
bufsize
 - 
wsize
Ë> 
blocksize
 ? blocksize :

1380 
bufsize
 - 
wsize
;

1381 
bh
 = 
	`pxt4_gëblk
(
h™dÀ
, 
ó_öode
, 
block
, 0);

1382 i‡(
	`IS_ERR
(
bh
))

1383  
	`PTR_ERR
(
bh
);

1384 i‡(!
bh
) {

1385 
	`WARN_ON_ONCE
(1);

1386 
	`PXT4_ERROR_INODE
(
ó_öode
,

1388  -
EFSCORRUPTED
;

1390 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1391 i‡(
ªt
)

1392 
out
;

1394 
	`mem˝y
(
bh
->
b_d©a
, 
buf
, 
csize
);

1395 
	`£t_buf„r_u±od©e
(
bh
);

1396 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
ó_öode
, 
bh
);

1398 
buf
 +
csize
;

1399 
wsize
 +
csize
;

1400 
block
 += 1;

1403 
	`öode_lock
(
ó_öode
);

1404 
	`i_size_wrôe
(
ó_öode
, 
wsize
);

1405 
	`pxt4_upd©e_i_disksize
(
ó_öode
, 
wsize
);

1406 
	`öode_u∆ock
(
ó_öode
);

1408 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ó_öode
);

1410 
out
:

1411 
	`bªl£
(
bh
);

1413  
ªt
;

1414 
	}
}

1419 
öode
 *
	$pxt4_x©å_öode_¸óã
(
h™dÀ_t
 *
h™dÀ
,

1420 
öode
 *öode, 
u32
 
hash
)

1422 
öode
 *
ó_öode
 = 
NULL
;

1423 
uid_t
 
ow√r
[2] = { 
	`i_uid_ªad
(
öode
), 
	`i_gid_ªad
(inode) };

1424 
îr
;

1430 
ó_öode
 = 
	`pxt4_√w_öode
(
h™dÀ
, 
öode
->
i_sb
->
s_roŸ
->
d_öode
,

1431 
S_IFREG
 | 0600, 
NULL
, 
öode
->
i_öo
 + 1, 
ow√r
,

1432 
PXT4_EA_INODE_FL
);

1433 i‡(!
	`IS_ERR
(
ó_öode
)) {

1434 
ó_öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

1435 
ó_öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

1436 
	`pxt4_£t_a›s
(
ó_öode
);

1437 
	`pxt4_x©å_öode_£t_˛ass
(
ó_öode
);

1438 
	`u∆ock_√w_öode
(
ó_öode
);

1439 
	`pxt4_x©å_öode_£t_ªf
(
ó_öode
, 1);

1440 
	`pxt4_x©å_öode_£t_hash
(
ó_öode
, 
hash
);

1441 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ó_öode
);

1442 i‡(!
îr
)

1443 
îr
 = 
	`pxt4_öode_©èch_jöode
(
ó_öode
);

1444 i‡(
îr
) {

1445 
	`ùut
(
ó_öode
);

1446  
	`ERR_PTR
(
îr
);

1453 
	`dquŸ_‰ì_öode
(
ó_öode
);

1454 
	`dquŸ_dr›
(
ó_öode
);

1455 
	`öode_lock
(
ó_öode
);

1456 
ó_öode
->
i_Êags
 |
S_NOQUOTA
;

1457 
	`öode_u∆ock
(
ó_öode
);

1460  
ó_öode
;

1461 
	}
}

1463 
öode
 *

1464 
	$pxt4_x©å_öode_ˇche_föd
(
öode
 *öode, c⁄° *
vÆue
,

1465 
size_t
 
vÆue_Àn
, 
u32
 
hash
)

1467 
öode
 *
ó_öode
;

1468 
mb_ˇche_íåy
 *
˚
;

1469 
mb_ˇche
 *
ó_öode_ˇche
 = 
	`EA_INODE_CACHE
(
öode
);

1470 *
ó_d©a
;

1472 i‡(!
ó_öode_ˇche
)

1473  
NULL
;

1475 
˚
 = 
	`mb_ˇche_íåy_föd_fú°
(
ó_öode_ˇche
, 
hash
);

1476 i‡(!
˚
)

1477  
NULL
;

1479 
ó_d©a
 = 
	`pxt4_kvmÆloc
(
vÆue_Àn
, 
GFP_NOFS
);

1480 i‡(!
ó_d©a
) {

1481 
	`mb_ˇche_íåy_put
(
ó_öode_ˇche
, 
˚
);

1482  
NULL
;

1485 
˚
) {

1486 
ó_öode
 = 
	`pxt4_igë
(
öode
->
i_sb
, 
˚
->
e_vÆue
,

1487 
PXT4_IGET_NORMAL
);

1488 i‡(!
	`IS_ERR
(
ó_öode
) &&

1489 !
	`is_bad_öode
(
ó_öode
) &&

1490 (
	`PXT4_I
(
ó_öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
) &&

1491 
	`i_size_ªad
(
ó_öode
Ë=
vÆue_Àn
 &&

1492 !
	`pxt4_x©å_öode_ªad
(
ó_öode
, 
ó_d©a
, 
vÆue_Àn
) &&

1493 !
	`pxt4_x©å_öode_vîify_hashes
(
ó_öode
, 
NULL
, 
ó_d©a
,

1494 
vÆue_Àn
) &&

1495 !
	`memcmp
(
vÆue
, 
ó_d©a
, 
vÆue_Àn
)) {

1496 
	`mb_ˇche_íåy_touch
(
ó_öode_ˇche
, 
˚
);

1497 
	`mb_ˇche_íåy_put
(
ó_öode_ˇche
, 
˚
);

1498 
	`kv‰ì
(
ó_d©a
);

1499  
ó_öode
;

1502 i‡(!
	`IS_ERR
(
ó_öode
))

1503 
	`ùut
(
ó_öode
);

1504 
˚
 = 
	`mb_ˇche_íåy_föd_√xt
(
ó_öode_ˇche
, ce);

1506 
	`kv‰ì
(
ó_d©a
);

1507  
NULL
;

1508 
	}
}

1513 
	$pxt4_x©å_öode_lookup_¸óã
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1514 c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
,

1515 
öode
 **
ªt_öode
)

1517 
öode
 *
ó_öode
;

1518 
u32
 
hash
;

1519 
îr
;

1521 
hash
 = 
	`pxt4_x©å_öode_hash
(
	`PXT4_SB
(
öode
->
i_sb
), 
vÆue
, 
vÆue_Àn
);

1522 
ó_öode
 = 
	`pxt4_x©å_öode_ˇche_föd
(
öode
, 
vÆue
, 
vÆue_Àn
, 
hash
);

1523 i‡(
ó_öode
) {

1524 
îr
 = 
	`pxt4_x©å_öode_öc_ªf
(
h™dÀ
, 
ó_öode
);

1525 i‡(
îr
) {

1526 
	`ùut
(
ó_öode
);

1527  
îr
;

1530 *
ªt_öode
 = 
ó_öode
;

1535 
ó_öode
 = 
	`pxt4_x©å_öode_¸óã
(
h™dÀ
, 
öode
, 
hash
);

1536 i‡(
	`IS_ERR
(
ó_öode
))

1537  
	`PTR_ERR
(
ó_öode
);

1539 
îr
 = 
	`pxt4_x©å_öode_wrôe
(
h™dÀ
, 
ó_öode
, 
vÆue
, 
vÆue_Àn
);

1540 i‡(
îr
) {

1541 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

1542 
	`ùut
(
ó_öode
);

1543  
îr
;

1546 i‡(
	`EA_INODE_CACHE
(
öode
))

1547 
	`mb_ˇche_íåy_¸óã
(
	`EA_INODE_CACHE
(
öode
), 
GFP_NOFS
, 
hash
,

1548 
ó_öode
->
i_öo
, 
åue
 );

1550 *
ªt_öode
 = 
ó_öode
;

1552 
	}
}

1558 
	#PXT4_XATTR_BLOCK_RESERVE
(
öode
Ë
	`mö
(
	`i_blocksize
(öode)/8, 1024U)

	)

1560 
	$pxt4_x©å_£t_íåy
(
pxt4_x©å_öfo
 *
i
,

1561 
pxt4_x©å_£¨ch
 *
s
,

1562 
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1563 
boﬁ
 
is_block
)

1565 
pxt4_x©å_íåy
 *
œ°
, *
√xt
;

1566 
pxt4_x©å_íåy
 *
hîe
 = 
s
->here;

1567 
size_t
 
mö_offs
 = 
s
->
íd
 - s->
ba£
, 
«me_Àn
 = 
	`°æí
(
i
->
«me
);

1568 
ö_öode
 = 
i
->in_inode;

1569 
öode
 *
ﬁd_ó_öode
 = 
NULL
;

1570 
öode
 *
√w_ó_öode
 = 
NULL
;

1571 
size_t
 
ﬁd_size
, 
√w_size
;

1572 
ªt
;

1575 
ﬁd_size
 = (!
s
->
nŸ_found
 && !
hîe
->
e_vÆue_öum
) ?

1576 
	`PXT4_XATTR_SIZE
(
	`À32_to_˝u
(
hîe
->
e_vÆue_size
)) : 0;

1577 
√w_size
 = (
i
->
vÆue
 && !
ö_öode
Ë? 
	`PXT4_XATTR_SIZE
(i->
vÆue_Àn
) : 0;

1583 i‡(
√w_size
 &&Çew_sizê=
ﬁd_size
) {

1584 
size_t
 
offs
 = 
	`À16_to_˝u
(
hîe
->
e_vÆue_offs
);

1585 *
vÆ
 = 
s
->
ba£
 + 
offs
;

1587 
hîe
->
e_vÆue_size
 = 
	`˝u_to_À32
(
i
->
vÆue_Àn
);

1588 i‡(
i
->
vÆue
 =
PXT4_ZERO_XATTR_VALUE
) {

1589 
	`mem£t
(
vÆ
, 0, 
√w_size
);

1591 
	`mem˝y
(
vÆ
, 
i
->
vÆue
, i->
vÆue_Àn
);

1593 
	`mem£t
(
vÆ
 + 
i
->
vÆue_Àn
, 0, 
√w_size
 - i->value_len);

1595 
upd©e_hash
;

1599 
œ°
 = 
s
->
fú°
;

1600 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
√xt
) {

1601 
√xt
 = 
	`PXT4_XATTR_NEXT
(
œ°
);

1602 i‡((*)
√xt
 >
s
->
íd
) {

1603 
	`PXT4_ERROR_INODE
(
öode
, "corrupted xattrÉntries");

1604 
ªt
 = -
EFSCORRUPTED
;

1605 
out
;

1607 i‡(!
œ°
->
e_vÆue_öum
 &&Üa°->
e_vÆue_size
) {

1608 
size_t
 
offs
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
);

1609 i‡(
offs
 < 
mö_offs
)

1610 
mö_offs
 = 
offs
;

1615 i‡(
i
->
vÆue
) {

1616 
size_t
 
‰ì
;

1618 
‰ì
 = 
mö_offs
 - ((*)
œ°
 - 
s
->
ba£
Ë- (
__u32
);

1619 i‡(!
s
->
nŸ_found
)

1620 
‰ì
 +
	`PXT4_XATTR_LEN
(
«me_Àn
Ë+ 
ﬁd_size
;

1622 i‡(
‰ì
 < 
	`PXT4_XATTR_LEN
(
«me_Àn
Ë+ 
√w_size
) {

1623 
ªt
 = -
ENOSPC
;

1624 
out
;

1633 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

1634 
√w_size
 && 
is_block
 &&

1635 (
mö_offs
 + 
ﬁd_size
 - 
√w_size
) <

1636 
	`PXT4_XATTR_BLOCK_RESERVE
(
öode
)) {

1637 
ªt
 = -
ENOSPC
;

1638 
out
;

1646 i‡(!
s
->
nŸ_found
 && 
hîe
->
e_vÆue_öum
) {

1647 
ªt
 = 
	`pxt4_x©å_öode_igë
(
öode
,

1648 
	`À32_to_˝u
(
hîe
->
e_vÆue_öum
),

1649 
	`À32_to_˝u
(
hîe
->
e_hash
),

1650 &
ﬁd_ó_öode
);

1651 i‡(
ªt
) {

1652 
ﬁd_ó_öode
 = 
NULL
;

1653 
out
;

1656 i‡(
i
->
vÆue
 && 
ö_öode
) {

1657 
	`WARN_ON_ONCE
(!
i
->
vÆue_Àn
);

1659 
ªt
 = 
	`pxt4_x©å_öode_Æloc_quŸa
(
öode
, 
i
->
vÆue_Àn
);

1660 i‡(
ªt
)

1661 
out
;

1663 
ªt
 = 
	`pxt4_x©å_öode_lookup_¸óã
(
h™dÀ
, 
öode
, 
i
->
vÆue
,

1664 
i
->
vÆue_Àn
,

1665 &
√w_ó_öode
);

1666 i‡(
ªt
) {

1667 
√w_ó_öode
 = 
NULL
;

1668 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
NULL
, 
i
->
vÆue_Àn
);

1669 
out
;

1673 i‡(
ﬁd_ó_öode
) {

1675 
ªt
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ﬁd_ó_öode
);

1676 i‡(
ªt
) {

1678 i‡(
√w_ó_öode
) {

1679 
îr
;

1681 
îr
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
,

1682 
√w_ó_öode
);

1683 i‡(
îr
)

1684 
	`pxt4_w¨nög_öode
(
√w_ó_öode
,

1686 
îr
);

1687 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
√w_ó_öode
,

1688 
i
->
vÆue_Àn
);

1690 
out
;

1693 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
ﬁd_ó_öode
,

1694 
	`À32_to_˝u
(
hîe
->
e_vÆue_size
));

1699 i‡(!
s
->
nŸ_found
 && 
hîe
->
e_vÆue_size
 && !hîe->
e_vÆue_öum
) {

1701 *
fú°_vÆ
 = 
s
->
ba£
 + 
mö_offs
;

1702 
size_t
 
offs
 = 
	`À16_to_˝u
(
hîe
->
e_vÆue_offs
);

1703 *
vÆ
 = 
s
->
ba£
 + 
offs
;

1705 
	`memmove
(
fú°_vÆ
 + 
ﬁd_size
, fú°_vÆ, 
vÆ
 - first_val);

1706 
	`mem£t
(
fú°_vÆ
, 0, 
ﬁd_size
);

1707 
mö_offs
 +
ﬁd_size
;

1710 
œ°
 = 
s
->
fú°
;

1711 !
	`IS_LAST_ENTRY
(
œ°
)) {

1712 
size_t
 
o
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
);

1714 i‡(!
œ°
->
e_vÆue_öum
 &&

1715 
œ°
->
e_vÆue_size
 && 
o
 < 
offs
)

1716 
œ°
->
e_vÆue_offs
 = 
	`˝u_to_À16
(
o
 + 
ﬁd_size
);

1717 
œ°
 = 
	`PXT4_XATTR_NEXT
(last);

1721 i‡(!
i
->
vÆue
) {

1723 
size_t
 
size
 = 
	`PXT4_XATTR_LEN
(
«me_Àn
);

1725 
œ°
 = 
	`ENTRY
((*Óa° - 
size
);

1726 
	`memmove
(
hîe
, (*)hîê+ 
size
,

1727 (*)
œ°
 - (*)
hîe
 + (
__u32
));

1728 
	`mem£t
(
œ°
, 0, 
size
);

1729 } i‡(
s
->
nŸ_found
) {

1731 
size_t
 
size
 = 
	`PXT4_XATTR_LEN
(
«me_Àn
);

1732 
size_t
 
ª°
 = (*)
œ°
 - (*)
hîe
 + (
__u32
);

1734 
	`memmove
((*)
hîe
 + 
size
, hîe, 
ª°
);

1735 
	`mem£t
(
hîe
, 0, 
size
);

1736 
hîe
->
e_«me_ödex
 = 
i
->
«me_ödex
;

1737 
hîe
->
e_«me_Àn
 = 
«me_Àn
;

1738 
	`mem˝y
(
hîe
->
e_«me
, 
i
->
«me
, 
«me_Àn
);

1741 
hîe
->
e_vÆue_öum
 = 0;

1742 
hîe
->
e_vÆue_offs
 = 0;

1743 
hîe
->
e_vÆue_size
 = 0;

1746 i‡(
i
->
vÆue
) {

1748 i‡(
ö_öode
) {

1749 
hîe
->
e_vÆue_öum
 = 
	`˝u_to_À32
(
√w_ó_öode
->
i_öo
);

1750 } i‡(
i
->
vÆue_Àn
) {

1751 *
vÆ
 = 
s
->
ba£
 + 
mö_offs
 - 
√w_size
;

1753 
hîe
->
e_vÆue_offs
 = 
	`˝u_to_À16
(
mö_offs
 - 
√w_size
);

1754 i‡(
i
->
vÆue
 =
PXT4_ZERO_XATTR_VALUE
) {

1755 
	`mem£t
(
vÆ
, 0, 
√w_size
);

1757 
	`mem˝y
(
vÆ
, 
i
->
vÆue
, i->
vÆue_Àn
);

1759 
	`mem£t
(
vÆ
 + 
i
->
vÆue_Àn
, 0,

1760 
√w_size
 - 
i
->
vÆue_Àn
);

1763 
hîe
->
e_vÆue_size
 = 
	`˝u_to_À32
(
i
->
vÆue_Àn
);

1766 
upd©e_hash
:

1767 i‡(
i
->
vÆue
) {

1768 
__À32
 
hash
 = 0;

1771 i‡(
ö_öode
) {

1772 
__À32
 
¸c32c_hash
;

1779 
¸c32c_hash
 = 
	`˝u_to_À32
(

1780 
	`pxt4_x©å_öode_gë_hash
(
√w_ó_öode
));

1781 
hash
 = 
	`pxt4_x©å_hash_íåy
(
hîe
->
e_«me
,

1782 
hîe
->
e_«me_Àn
,

1783 &
¸c32c_hash
, 1);

1784 } i‡(
is_block
) {

1785 
__À32
 *
vÆue
 = 
s
->
ba£
 + 
	`À16_to_˝u
(

1786 
hîe
->
e_vÆue_offs
);

1788 
hash
 = 
	`pxt4_x©å_hash_íåy
(
hîe
->
e_«me
,

1789 
hîe
->
e_«me_Àn
, 
vÆue
,

1790 
√w_size
 >> 2);

1792 
hîe
->
e_hash
 = 
hash
;

1795 i‡(
is_block
)

1796 
	`pxt4_x©å_ªhash
((
pxt4_x©å_hódî
 *)
s
->
ba£
);

1798 
ªt
 = 0;

1799 
out
:

1800 
	`ùut
(
ﬁd_ó_öode
);

1801 
	`ùut
(
√w_ó_öode
);

1802  
ªt
;

1803 
	}
}

1805 
	spxt4_x©å_block_föd
 {

1806 
pxt4_x©å_£¨ch
 
	ms
;

1807 
buf„r_hód
 *
	mbh
;

1811 
	$pxt4_x©å_block_föd
(
öode
 *öode, 
pxt4_x©å_öfo
 *
i
,

1812 
pxt4_x©å_block_föd
 *
bs
)

1814 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1815 
îr‹
;

1817 
	`ó_idebug
(
öode
, "name=%d.%s, value=%p, value_len=%ld",

1818 
i
->
«me_ödex
, i->
«me
, i->
vÆue
, ()i->
vÆue_Àn
);

1820 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

1822 
bs
->
bh
 = 
	`pxt4_sb_bªad
(
sb
, 
	`PXT4_I
(
öode
)->
i_fûe_a˛
, 
REQ_PRIO
);

1823 i‡(
	`IS_ERR
(
bs
->
bh
))

1824  
	`PTR_ERR
(
bs
->
bh
);

1825 
	`ó_bdebug
(
bs
->
bh
, "b_count=%d,Ñefcount=%d",

1826 
	`©omic_ªad
(&(
bs
->
bh
->
b_cou¡
)),

1827 
	`À32_to_˝u
(
	`BHDR
(
bs
->
bh
)->
h_ªfcou¡
));

1828 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bs
->
bh
);

1829 i‡(
îr‹
)

1830  
îr‹
;

1832 
bs
->
s
.
ba£
 = 
	`BHDR
(bs->
bh
);

1833 
bs
->
s
.
fú°
 = 
	`BFIRST
(bs->
bh
);

1834 
bs
->
s
.
íd
 = bs->
bh
->
b_d©a
 + bs->bh->
b_size
;

1835 
bs
->
s
.
hîe
 = bs->s.
fú°
;

1836 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
bs
->
s
.
hîe
, bs->s.
íd
,

1837 
i
->
«me_ödex
, i->
«me
, 1);

1838 i‡(
îr‹
 &&Éº‹ !-
ENODATA
)

1839  
îr‹
;

1840 
bs
->
s
.
nŸ_found
 = 
îr‹
;

1843 
	}
}

1846 
	$pxt4_x©å_block_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1847 
pxt4_x©å_öfo
 *
i
,

1848 
pxt4_x©å_block_föd
 *
bs
)

1850 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1851 
buf„r_hód
 *
√w_bh
 = 
NULL
;

1852 
pxt4_x©å_£¨ch
 
s_c›y
 = 
bs
->
s
;

1853 
pxt4_x©å_£¨ch
 *
s
 = &
s_c›y
;

1854 
mb_ˇche_íåy
 *
˚
 = 
NULL
;

1855 
îr‹
 = 0;

1856 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

1857 
öode
 *
ó_öode
 = 
NULL
, *
tmp_öode
;

1858 
size_t
 
ﬁd_ó_öode_quŸa
 = 0;

1859 
ó_öo
;

1862 
	#hódî
(
x
Ë((
pxt4_x©å_hódî
 *)(x))

	)

1864 i‡(
s
->
ba£
) {

1865 
	`BUFFER_TRACE
(
bs
->
bh
, "get_write_access");

1866 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bs
->
bh
);

1867 i‡(
îr‹
)

1868 
˛ónup
;

1869 
	`lock_buf„r
(
bs
->
bh
);

1871 i‡(
	`hódî
(
s
->
ba£
)->
h_ªfcou¡
 =
	`˝u_to_À32
(1)) {

1872 
__u32
 
hash
 = 
	`À32_to_˝u
(
	`BHDR
(
bs
->
bh
)->
h_hash
);

1879 i‡(
ó_block_ˇche
)

1880 
	`mb_ˇche_íåy_dñëe
(
ó_block_ˇche
, 
hash
,

1881 
bs
->
bh
->
b_blockƒ
);

1882 
	`ó_bdebug
(
bs
->
bh
, "modifying in-place");

1883 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
,

1884 
åue
 );

1885 
	`pxt4_x©å_block_csum_£t
(
öode
, 
bs
->
bh
);

1886 
	`u∆ock_buf„r
(
bs
->
bh
);

1887 i‡(
îr‹
 =-
EFSCORRUPTED
)

1888 
bad_block
;

1889 i‡(!
îr‹
)

1890 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

1891 
öode
,

1892 
bs
->
bh
);

1893 i‡(
îr‹
)

1894 
˛ónup
;

1895 
ö£πed
;

1897 
off£t
 = (*)
s
->
hîe
 - 
bs
->
bh
->
b_d©a
;

1899 
	`u∆ock_buf„r
(
bs
->
bh
);

1900 
	`ó_bdebug
(
bs
->
bh
, "cloning");

1901 
s
->
ba£
 = 
	`kmÆloc
(
bs
->
bh
->
b_size
, 
GFP_NOFS
);

1902 
îr‹
 = -
ENOMEM
;

1903 i‡(
s
->
ba£
 =
NULL
)

1904 
˛ónup
;

1905 
	`mem˝y
(
s
->
ba£
, 
	`BHDR
(
bs
->
bh
), bs->bh->
b_size
);

1906 
s
->
fú°
 = 
	`ENTRY
(
	`hódî
(s->
ba£
)+1);

1907 
	`hódî
(
s
->
ba£
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(1);

1908 
s
->
hîe
 = 
	`ENTRY
(s->
ba£
 + 
off£t
);

1909 
s
->
íd
 = s->
ba£
 + 
bs
->
bh
->
b_size
;

1918 i‡(!
s
->
nŸ_found
 && s->
hîe
->
e_vÆue_öum
) {

1919 
ó_öo
 = 
	`À32_to_˝u
(
s
->
hîe
->
e_vÆue_öum
);

1920 
îr‹
 = 
	`pxt4_x©å_öode_igë
(
öode
, 
ó_öo
,

1921 
	`À32_to_˝u
(
s
->
hîe
->
e_hash
),

1922 &
tmp_öode
);

1923 i‡(
îr‹
)

1924 
˛ónup
;

1926 i‡(!
	`pxt4_ã°_öode_°©e
(
tmp_öode
,

1927 
PXT4_STATE_LUSTRE_EA_INODE
)) {

1932 
ﬁd_ó_öode_quŸa
 = 
	`À32_to_˝u
(

1933 
s
->
hîe
->
e_vÆue_size
);

1935 
	`ùut
(
tmp_öode
);

1937 
s
->
hîe
->
e_vÆue_öum
 = 0;

1938 
s
->
hîe
->
e_vÆue_size
 = 0;

1943 
s
->
ba£
 = 
	`kzÆloc
(
sb
->
s_blocksize
, 
GFP_NOFS
);

1945 
îr‹
 = -
ENOMEM
;

1946 i‡(
s
->
ba£
 =
NULL
)

1947 
˛ónup
;

1948 
	`hódî
(
s
->
ba£
)->
h_magic
 = 
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
);

1949 
	`hódî
(
s
->
ba£
)->
h_blocks
 = 
	`˝u_to_À32
(1);

1950 
	`hódî
(
s
->
ba£
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(1);

1951 
s
->
fú°
 = 
	`ENTRY
(
	`hódî
(s->
ba£
)+1);

1952 
s
->
hîe
 = 
	`ENTRY
(
	`hódî
(s->
ba£
)+1);

1953 
s
->
íd
 = s->
ba£
 + 
sb
->
s_blocksize
;

1956 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
, 
åue
 );

1957 i‡(
îr‹
 =-
EFSCORRUPTED
)

1958 
bad_block
;

1959 i‡(
îr‹
)

1960 
˛ónup
;

1962 i‡(
i
->
vÆue
 && 
s
->
hîe
->
e_vÆue_öum
) {

1969 
ó_öo
 = 
	`À32_to_˝u
(
s
->
hîe
->
e_vÆue_öum
);

1970 
îr‹
 = 
	`pxt4_x©å_öode_igë
(
öode
, 
ó_öo
,

1971 
	`À32_to_˝u
(
s
->
hîe
->
e_hash
),

1972 &
ó_öode
);

1973 i‡(
îr‹
) {

1974 
ó_öode
 = 
NULL
;

1975 
˛ónup
;

1979 
ö£πed
:

1980 i‡(!
	`IS_LAST_ENTRY
(
s
->
fú°
)) {

1981 
√w_bh
 = 
	`pxt4_x©å_block_ˇche_föd
(
öode
, 
	`hódî
(
s
->
ba£
),

1982 &
˚
);

1983 i‡(
√w_bh
) {

1985 i‡(
√w_bh
 =
bs
->
bh
)

1986 
	`ó_bdebug
(
√w_bh
, "keeping");

1988 
u32
 
ªf
;

1990 
	`WARN_ON_ONCE
(
	`dquŸ_öôülize_√eded
(
öode
));

1994 
îr‹
 = 
	`dquŸ_Æloc_block
(
öode
,

1995 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 1));

1996 i‡(
îr‹
)

1997 
˛ónup
;

1998 
	`BUFFER_TRACE
(
√w_bh
, "get_write_access");

1999 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

2000 
√w_bh
);

2001 i‡(
îr‹
)

2002 
˛ónup_dquŸ
;

2003 
	`lock_buf„r
(
√w_bh
);

2016 i‡(
	`hli°_bl_unhashed
(&
˚
->
e_hash_li°
) ||

2017 !
˚
->
e_ªußbÀ
) {

2022 
	`u∆ock_buf„r
(
√w_bh
);

2023 
	`dquŸ_‰ì_block
(
öode
,

2024 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
),

2026 
	`bªl£
(
√w_bh
);

2027 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

2028 
˚
 = 
NULL
;

2029 
√w_bh
 = 
NULL
;

2030 
ö£πed
;

2032 
ªf
 = 
	`À32_to_˝u
(
	`BHDR
(
√w_bh
)->
h_ªfcou¡
) + 1;

2033 
	`BHDR
(
√w_bh
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(
ªf
);

2034 i‡(
ªf
 >
PXT4_XATTR_REFCOUNT_MAX
)

2035 
˚
->
e_ªußbÀ
 = 0;

2036 
	`ó_bdebug
(
√w_bh
, "reusing;ÑefcountÇow=%d",

2037 
ªf
);

2038 
	`pxt4_x©å_block_csum_£t
(
öode
, 
√w_bh
);

2039 
	`u∆ock_buf„r
(
√w_bh
);

2040 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

2041 
öode
,

2042 
√w_bh
);

2043 i‡(
îr‹
)

2044 
˛ónup_dquŸ
;

2046 
	`mb_ˇche_íåy_touch
(
ó_block_ˇche
, 
˚
);

2047 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

2048 
˚
 = 
NULL
;

2049 } i‡(
bs
->
bh
 && 
s
->
ba£
 =bs->bh->
b_d©a
) {

2051 
	`ó_bdebug
(
bs
->
bh
, "keepingÅhis block");

2052 
	`pxt4_x©å_block_ˇche_ö£π
(
ó_block_ˇche
, 
bs
->
bh
);

2053 
√w_bh
 = 
bs
->
bh
;

2054 
	`gë_bh
(
√w_bh
);

2057 
pxt4_fsblk_t
 
gﬂl
, 
block
;

2059 
	`WARN_ON_ONCE
(
	`dquŸ_öôülize_√eded
(
öode
));

2061 
gﬂl
 = 
	`pxt4_group_fú°_block_no
(
sb
,

2062 
	`PXT4_I
(
öode
)->
i_block_group
);

2065 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

2066 
gﬂl
 = gﬂ»& 
PXT4_MAX_BLOCK_FILE_PHYS
;

2068 
block
 = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
, 
öode
, 
gﬂl
, 0,

2069 
NULL
, &
îr‹
);

2070 i‡(
îr‹
)

2071 
˛ónup
;

2073 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

2074 
	`BUG_ON
(
block
 > 
PXT4_MAX_BLOCK_FILE_PHYS
);

2076 
	`ó_idebug
(
öode
, "creating block %llu",

2077 ()
block
);

2079 
√w_bh
 = 
	`sb_gëblk
(
sb
, 
block
);

2080 i‡(
	`u∆ikñy
(!
√w_bh
)) {

2081 
îr‹
 = -
ENOMEM
;

2082 
gëblk_Áûed
:

2083 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
block
, 1,

2084 
PXT4_FREE_BLOCKS_METADATA
);

2085 
˛ónup
;

2087 
îr‹
 = 
	`pxt4_x©å_öode_öc_ªf_Æl
(
h™dÀ
, 
öode
,

2088 
	`ENTRY
(
	`hódî
(
s
->
ba£
)+1));

2089 i‡(
îr‹
)

2090 
gëblk_Áûed
;

2091 i‡(
ó_öode
) {

2093 
îr‹
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
,

2094 
ó_öode
);

2095 i‡(
îr‹
)

2096 
	`pxt4_w¨nög_öode
(
ó_öode
,

2098 
îr‹
);

2099 
	`ùut
(
ó_öode
);

2100 
ó_öode
 = 
NULL
;

2103 
	`lock_buf„r
(
√w_bh
);

2104 
îr‹
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
√w_bh
);

2105 i‡(
îr‹
) {

2106 
	`u∆ock_buf„r
(
√w_bh
);

2107 
îr‹
 = -
EIO
;

2108 
gëblk_Áûed
;

2110 
	`mem˝y
(
√w_bh
->
b_d©a
, 
s
->
ba£
,Çew_bh->
b_size
);

2111 
	`pxt4_x©å_block_csum_£t
(
öode
, 
√w_bh
);

2112 
	`£t_buf„r_u±od©e
(
√w_bh
);

2113 
	`u∆ock_buf„r
(
√w_bh
);

2114 
	`pxt4_x©å_block_ˇche_ö£π
(
ó_block_ˇche
, 
√w_bh
);

2115 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
,

2116 
√w_bh
);

2117 i‡(
îr‹
)

2118 
˛ónup
;

2122 i‡(
ﬁd_ó_öode_quŸa
)

2123 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
NULL
, 
ﬁd_ó_öode_quŸa
);

2126 
	`PXT4_I
(
öode
)->
i_fûe_a˛
 = 
√w_bh
 ?Çew_bh->
b_blockƒ
 : 0;

2129 i‡(
bs
->
bh
 && bs->bh !
√w_bh
) {

2130 
pxt4_x©å_öode_¨øy
 *
ó_öode_¨øy
 = 
NULL
;

2132 
	`pxt4_x©å_ªÀa£_block
(
h™dÀ
, 
öode
, 
bs
->
bh
,

2133 &
ó_öode_¨øy
,

2135 
	`pxt4_x©å_öode_¨øy_‰ì
(
ó_öode_¨øy
);

2137 
îr‹
 = 0;

2139 
˛ónup
:

2140 i‡(
ó_öode
) {

2141 
îr‹2
;

2143 
îr‹2
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

2144 i‡(
îr‹2
)

2145 
	`pxt4_w¨nög_öode
(
ó_öode
, "decÑefÉrror=%d",

2146 
îr‹2
);

2149 i‡(
îr‹
)

2150 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
ó_öode
,

2151 
	`i_size_ªad
(
ó_öode
));

2152 
	`ùut
(
ó_öode
);

2154 i‡(
˚
)

2155 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

2156 
	`bªl£
(
√w_bh
);

2157 i‡(!(
bs
->
bh
 && 
s
->
ba£
 =bs->bh->
b_d©a
))

2158 
	`k‰ì
(
s
->
ba£
);

2160  
îr‹
;

2162 
˛ónup_dquŸ
:

2163 
	`dquŸ_‰ì_block
(
öode
, 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 1));

2164 
˛ónup
;

2166 
bad_block
:

2167 
	`PXT4_ERROR_INODE
(
öode
, "bad block %llu",

2168 
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

2169 
˛ónup
;

2171 #unde‡
hódî


2172 
	}
}

2174 
	$pxt4_x©å_ibody_föd
(
öode
 *öode, 
pxt4_x©å_öfo
 *
i
,

2175 
pxt4_x©å_ibody_föd
 *
is
)

2177 
pxt4_x©å_ibody_hódî
 *
hódî
;

2178 
pxt4_öode
 *
øw_öode
;

2179 
îr‹
;

2181 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

2183 
øw_öode
 = 
	`pxt4_øw_öode
(&
is
->
ûoc
);

2184 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2185 
is
->
s
.
ba£
 = is->s.
fú°
 = 
	`IFIRST
(
hódî
);

2186 
is
->
s
.
hîe
 = is->s.
fú°
;

2187 
is
->
s
.
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

2188 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

2189 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
is
->
s
.
íd
);

2190 i‡(
îr‹
)

2191  
îr‹
;

2193 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
is
->
s
.
hîe
, is->s.
íd
,

2194 
i
->
«me_ödex
, i->
«me
, 0);

2195 i‡(
îr‹
 &&Éº‹ !-
ENODATA
)

2196  
îr‹
;

2197 
is
->
s
.
nŸ_found
 = 
îr‹
;

2200 
	}
}

2202 
	$pxt4_x©å_ibody_ölöe_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2203 
pxt4_x©å_öfo
 *
i
,

2204 
pxt4_x©å_ibody_föd
 *
is
)

2206 
pxt4_x©å_ibody_hódî
 *
hódî
;

2207 
pxt4_x©å_£¨ch
 *
s
 = &
is
->s;

2208 
îr‹
;

2210 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

2211  -
ENOSPC
;

2212 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
, 
Ál£
 );

2213 i‡(
îr‹
)

2214  
îr‹
;

2215 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(&
is
->
ûoc
));

2216 i‡(!
	`IS_LAST_ENTRY
(
s
->
fú°
)) {

2217 
hódî
->
h_magic
 = 
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
);

2218 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2220 
hódî
->
h_magic
 = 
	`˝u_to_À32
(0);

2221 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2224 
	}
}

2226 
	$pxt4_x©å_ibody_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2227 
pxt4_x©å_öfo
 *
i
,

2228 
pxt4_x©å_ibody_föd
 *
is
)

2230 
pxt4_x©å_ibody_hódî
 *
hódî
;

2231 
pxt4_x©å_£¨ch
 *
s
 = &
is
->s;

2232 
îr‹
;

2234 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

2235  -
ENOSPC
;

2236 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
, 
Ál£
 );

2237 i‡(
îr‹
)

2238  
îr‹
;

2239 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(&
is
->
ûoc
));

2240 i‡(!
	`IS_LAST_ENTRY
(
s
->
fú°
)) {

2241 
hódî
->
h_magic
 = 
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
);

2242 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2244 
hódî
->
h_magic
 = 
	`˝u_to_À32
(0);

2245 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2248 
	}
}

2250 
	$pxt4_x©å_vÆue_ßme
(
pxt4_x©å_£¨ch
 *
s
,

2251 
pxt4_x©å_öfo
 *
i
)

2253 *
vÆue
;

2256 i‡(
s
->
hîe
->
e_vÆue_öum
)

2258 i‡(
	`À32_to_˝u
(
s
->
hîe
->
e_vÆue_size
Ë!
i
->
vÆue_Àn
)

2260 
vÆue
 = ((*)
s
->
ba£
Ë+ 
	`À16_to_˝u
(s->
hîe
->
e_vÆue_offs
);

2261  !
	`memcmp
(
vÆue
, 
i
->vÆue, i->
vÆue_Àn
);

2262 
	}
}

2264 
buf„r_hód
 *
	$pxt4_x©å_gë_block
(
öode
 *inode)

2266 
buf„r_hód
 *
bh
;

2267 
îr‹
;

2269 i‡(!
	`PXT4_I
(
öode
)->
i_fûe_a˛
)

2270  
NULL
;

2271 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

2272 i‡(
	`IS_ERR
(
bh
))

2273  
bh
;

2274 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

2275 i‡(
îr‹
) {

2276 
	`bªl£
(
bh
);

2277  
	`ERR_PTR
(
îr‹
);

2279  
bh
;

2280 
	}
}

2295 
	$pxt4_x©å_£t_h™dÀ
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, 
«me_ödex
,

2296 c⁄° *
«me
, c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
,

2297 
Êags
)

2299 
pxt4_x©å_öfo
 
i
 = {

2300 .
«me_ödex
 =Çame_index,

2301 .
«me
 =Çame,

2302 .
vÆue
 = value,

2303 .
vÆue_Àn
 = value_len,

2304 .
ö_öode
 = 0,

2306 
pxt4_x©å_ibody_föd
 
is
 = {

2307 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

2309 
pxt4_x©å_block_föd
 
bs
 = {

2310 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

2312 
no_ex∑nd
;

2313 
îr‹
;

2315 i‡(!
«me
)

2316  -
EINVAL
;

2317 i‡(
	`°æí
(
«me
) > 255)

2318  -
ERANGE
;

2320 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

2323 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

2324 
buf„r_hód
 *
bh
;

2325 
¸edôs
;

2327 
bh
 = 
	`pxt4_x©å_gë_block
(
öode
);

2328 i‡(
	`IS_ERR
(
bh
)) {

2329 
îr‹
 = 
	`PTR_ERR
(
bh
);

2330 
˛ónup
;

2333 
¸edôs
 = 
	`__pxt4_x©å_£t_¸edôs
(
öode
->
i_sb
, inode, 
bh
,

2334 
vÆue_Àn
,

2335 
Êags
 & 
XATTR_CREATE
);

2336 
	`bªl£
(
bh
);

2338 i‡(!
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
, 
¸edôs
)) {

2339 
îr‹
 = -
ENOSPC
;

2340 
˛ónup
;

2344 
îr‹
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

2345 i‡(
îr‹
)

2346 
˛ónup
;

2348 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEW
)) {

2349 
pxt4_öode
 *
øw_öode
 = 
	`pxt4_øw_öode
(&
is
.
ûoc
);

2350 
	`mem£t
(
øw_öode
, 0, 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
);

2351 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NEW
);

2354 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

2355 i‡(
îr‹
)

2356 
˛ónup
;

2357 i‡(
is
.
s
.
nŸ_found
)

2358 
îr‹
 = 
	`pxt4_x©å_block_föd
(
öode
, &
i
, &
bs
);

2359 i‡(
îr‹
)

2360 
˛ónup
;

2361 i‡(
is
.
s
.
nŸ_found
 && 
bs
.s.not_found) {

2362 
îr‹
 = -
ENODATA
;

2363 i‡(
Êags
 & 
XATTR_REPLACE
)

2364 
˛ónup
;

2365 
îr‹
 = 0;

2366 i‡(!
vÆue
)

2367 
˛ónup
;

2369 
îr‹
 = -
EEXIST
;

2370 i‡(
Êags
 & 
XATTR_CREATE
)

2371 
˛ónup
;

2374 i‡(!
vÆue
) {

2375 i‡(!
is
.
s
.
nŸ_found
)

2376 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

2377 i‡(!
bs
.
s
.
nŸ_found
)

2378 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, &
bs
);

2380 
îr‹
 = 0;

2382 i‡(!
is
.
s
.
nŸ_found
 && 
	`pxt4_x©å_vÆue_ßme
(&is.s, &
i
))

2383 
˛ónup
;

2384 i‡(!
bs
.
s
.
nŸ_found
 && 
	`pxt4_x©å_vÆue_ßme
(&bs.s, &
i
))

2385 
˛ónup
;

2387 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

2388 (
	`PXT4_XATTR_SIZE
(
i
.
vÆue_Àn
) >

2389 
	`PXT4_XATTR_MIN_LARGE_EA_SIZE
(
öode
->
i_sb
->
s_blocksize
)))

2390 
i
.
ö_öode
 = 1;

2391 
ªåy_öode
:

2392 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

2393 i‡(!
îr‹
 && !
bs
.
s
.
nŸ_found
) {

2394 
i
.
vÆue
 = 
NULL
;

2395 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, &
bs
);

2396 } i‡(
îr‹
 =-
ENOSPC
) {

2397 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
 && !
bs
.
s
.
ba£
) {

2398 
	`bªl£
(
bs
.
bh
);

2399 
bs
.
bh
 = 
NULL
;

2400 
îr‹
 = 
	`pxt4_x©å_block_föd
(
öode
, &
i
, &
bs
);

2401 i‡(
îr‹
)

2402 
˛ónup
;

2404 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, &
bs
);

2405 i‡(!
îr‹
 && !
is
.
s
.
nŸ_found
) {

2406 
i
.
vÆue
 = 
NULL
;

2407 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
,

2408 &
is
);

2409 } i‡(
îr‹
 =-
ENOSPC
) {

2414 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

2415 !
i
.
ö_öode
) {

2416 
i
.
ö_öode
 = 1;

2417 
ªåy_öode
;

2422 i‡(!
îr‹
) {

2423 
	`pxt4_x©å_upd©e_su≥r_block
(
h™dÀ
, 
öode
->
i_sb
);

2424 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

2425 i‡(!
vÆue
)

2426 
no_ex∑nd
 = 0;

2427 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

2432 
is
.
ûoc
.
bh
 = 
NULL
;

2433 i‡(
	`IS_SYNC
(
öode
))

2434 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2437 
˛ónup
:

2438 
	`bªl£
(
is
.
ûoc
.
bh
);

2439 
	`bªl£
(
bs
.
bh
);

2440 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

2441  
îr‹
;

2442 
	}
}

2444 
	$pxt4_x©å_£t_¸edôs
(
öode
 *öode, 
size_t
 
vÆue_Àn
,

2445 
boﬁ
 
is_¸óã
, *
¸edôs
)

2447 
buf„r_hód
 *
bh
;

2448 
îr
;

2450 *
¸edôs
 = 0;

2452 i‡(!
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
)

2455 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

2457 
bh
 = 
	`pxt4_x©å_gë_block
(
öode
);

2458 i‡(
	`IS_ERR
(
bh
)) {

2459 
îr
 = 
	`PTR_ERR
(
bh
);

2461 *
¸edôs
 = 
	`__pxt4_x©å_£t_¸edôs
(
öode
->
i_sb
, inode, 
bh
,

2462 
vÆue_Àn
, 
is_¸óã
);

2463 
	`bªl£
(
bh
);

2464 
îr
 = 0;

2467 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

2468  
îr
;

2469 
	}
}

2480 
	$pxt4_x©å_£t
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

2481 c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
, 
Êags
)

2483 
h™dÀ_t
 *
h™dÀ
;

2484 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

2485 
îr‹
, 
ªåõs
 = 0;

2486 
¸edôs
;

2488 
îr‹
 = 
	`dquŸ_öôülize
(
öode
);

2489 i‡(
îr‹
)

2490  
îr‹
;

2492 
ªåy
:

2493 
îr‹
 = 
	`pxt4_x©å_£t_¸edôs
(
öode
, 
vÆue_Àn
, 
Êags
 & 
XATTR_CREATE
,

2494 &
¸edôs
);

2495 i‡(
îr‹
)

2496  
îr‹
;

2498 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_XATTR
, 
¸edôs
);

2499 i‡(
	`IS_ERR
(
h™dÀ
)) {

2500 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

2502 
îr‹2
;

2504 
îr‹
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
, 
«me_ödex
, 
«me
,

2505 
vÆue
, 
vÆue_Àn
, 
Êags
);

2506 
îr‹2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2507 i‡(
îr‹
 =-
ENOSPC
 &&

2508 
	`pxt4_should_ªåy_Æloc
(
sb
, &
ªåõs
))

2509 
ªåy
;

2510 i‡(
îr‹
 == 0)

2511 
îr‹
 = 
îr‹2
;

2514  
îr‹
;

2515 
	}
}

2521 
	$pxt4_x©å_shi·_íåõs
(
pxt4_x©å_íåy
 *
íåy
,

2522 
vÆue_offs_shi·
, *
to
,

2523 *
‰om
, 
size_t
 
n
)

2525 
pxt4_x©å_íåy
 *
œ°
 = 
íåy
;

2526 
√w_offs
;

2529 
	`BUG_ON
(
vÆue_offs_shi·
 > 0);

2532 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
	`PXT4_XATTR_NEXT
(last)) {

2533 i‡(!
œ°
->
e_vÆue_öum
 &&Üa°->
e_vÆue_size
) {

2534 
√w_offs
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
) +

2535 
vÆue_offs_shi·
;

2536 
œ°
->
e_vÆue_offs
 = 
	`˝u_to_À16
(
√w_offs
);

2540 
	`memmove
(
to
, 
‰om
, 
n
);

2541 
	}
}

2546 
	$pxt4_x©å_move_to_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2547 
pxt4_öode
 *
øw_öode
,

2548 
pxt4_x©å_íåy
 *
íåy
)

2550 
pxt4_x©å_ibody_föd
 *
is
 = 
NULL
;

2551 
pxt4_x©å_block_föd
 *
bs
 = 
NULL
;

2552 *
buf„r
 = 
NULL
, *
b_íåy_«me
 = NULL;

2553 
size_t
 
vÆue_size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

2554 
pxt4_x©å_öfo
 
i
 = {

2555 .
vÆue
 = 
NULL
,

2556 .
vÆue_Àn
 = 0,

2557 .
«me_ödex
 = 
íåy
->
e_«me_ödex
,

2558 .
ö_öode
 = !!
íåy
->
e_vÆue_öum
,

2560 
pxt4_x©å_ibody_hódî
 *
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2561 
îr‹
;

2563 
is
 = 
	`kzÆloc
((
pxt4_x©å_ibody_föd
), 
GFP_NOFS
);

2564 
bs
 = 
	`kzÆloc
((
pxt4_x©å_block_föd
), 
GFP_NOFS
);

2565 
buf„r
 = 
	`kmÆloc
(
vÆue_size
, 
GFP_NOFS
);

2566 
b_íåy_«me
 = 
	`kmÆloc
(
íåy
->
e_«me_Àn
 + 1, 
GFP_NOFS
);

2567 i‡(!
is
 || !
bs
 || !
buf„r
 || !
b_íåy_«me
) {

2568 
îr‹
 = -
ENOMEM
;

2569 
out
;

2572 
is
->
s
.
nŸ_found
 = -
ENODATA
;

2573 
bs
->
s
.
nŸ_found
 = -
ENODATA
;

2574 
is
->
ûoc
.
bh
 = 
NULL
;

2575 
bs
->
bh
 = 
NULL
;

2578 i‡(
íåy
->
e_vÆue_öum
) {

2579 
îr‹
 = 
	`pxt4_x©å_öode_gë
(
öode
, 
íåy
, 
buf„r
, 
vÆue_size
);

2580 i‡(
îr‹
)

2581 
out
;

2583 
size_t
 
vÆue_offs
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

2584 
	`mem˝y
(
buf„r
, (*)
	`IFIRST
(
hódî
Ë+ 
vÆue_offs
, 
vÆue_size
);

2587 
	`mem˝y
(
b_íåy_«me
, 
íåy
->
e_«me
,É¡ry->
e_«me_Àn
);

2588 
b_íåy_«me
[
íåy
->
e_«me_Àn
] = '\0';

2589 
i
.
«me
 = 
b_íåy_«me
;

2591 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
->
ûoc
);

2592 i‡(
îr‹
)

2593 
out
;

2595 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, 
is
);

2596 i‡(
îr‹
)

2597 
out
;

2600 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
, 
is
);

2601 i‡(
îr‹
)

2602 
out
;

2604 
i
.
vÆue
 = 
buf„r
;

2605 
i
.
vÆue_Àn
 = 
vÆue_size
;

2606 
îr‹
 = 
	`pxt4_x©å_block_föd
(
öode
, &
i
, 
bs
);

2607 i‡(
îr‹
)

2608 
out
;

2611 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, 
bs
);

2612 i‡(
îr‹
)

2613 
out
;

2614 
îr‹
 = 0;

2615 
out
:

2616 
	`k‰ì
(
b_íåy_«me
);

2617 
	`k‰ì
(
buf„r
);

2618 i‡(
is
)

2619 
	`bªl£
(
is
->
ûoc
.
bh
);

2620 i‡(
bs
)

2621 
	`bªl£
(
bs
->
bh
);

2622 
	`k‰ì
(
is
);

2623 
	`k‰ì
(
bs
);

2625  
îr‹
;

2626 
	}
}

2628 
	$pxt4_x©å_make_öode_•a˚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2629 
pxt4_öode
 *
øw_öode
,

2630 
isize_diff
, 
size_t
 
i‰ì
,

2631 
size_t
 
b‰ì
, *
tŸÆ_öo
)

2633 
pxt4_x©å_ibody_hódî
 *
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2634 
pxt4_x©å_íåy
 *
smÆl_íåy
;

2635 
pxt4_x©å_íåy
 *
íåy
;

2636 
pxt4_x©å_íåy
 *
œ°
;

2637 
íåy_size
;

2638 
tŸÆ_size
;

2639 
mö_tŸÆ_size
;

2640 
îr‹
;

2642 
isize_diff
 > 
i‰ì
) {

2643 
íåy
 = 
NULL
;

2644 
smÆl_íåy
 = 
NULL
;

2645 
mö_tŸÆ_size
 = ~0U;

2646 
œ°
 = 
	`IFIRST
(
hódî
);

2648 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
	`PXT4_XATTR_NEXT
(last)) {

2650 i‡((
œ°
->
e_«me_Àn
 == 4) &&

2651 (
œ°
->
e_«me_ödex
 =
PXT4_XATTR_INDEX_SYSTEM
) &&

2652 !
	`memcmp
(
œ°
->
e_«me
, "data", 4))

2654 
tŸÆ_size
 = 
	`PXT4_XATTR_LEN
(
œ°
->
e_«me_Àn
);

2655 i‡(!
œ°
->
e_vÆue_öum
)

2656 
tŸÆ_size
 +
	`PXT4_XATTR_SIZE
(

2657 
	`À32_to_˝u
(
œ°
->
e_vÆue_size
));

2658 i‡(
tŸÆ_size
 <
b‰ì
 &&

2659 
tŸÆ_size
 < 
mö_tŸÆ_size
) {

2660 i‡(
tŸÆ_size
 + 
i‰ì
 < 
isize_diff
) {

2661 
smÆl_íåy
 = 
œ°
;

2663 
íåy
 = 
œ°
;

2664 
mö_tŸÆ_size
 = 
tŸÆ_size
;

2669 i‡(
íåy
 =
NULL
) {

2670 i‡(
smÆl_íåy
 =
NULL
)

2671  -
ENOSPC
;

2672 
íåy
 = 
smÆl_íåy
;

2675 
íåy_size
 = 
	`PXT4_XATTR_LEN
(
íåy
->
e_«me_Àn
);

2676 
tŸÆ_size
 = 
íåy_size
;

2677 i‡(!
íåy
->
e_vÆue_öum
)

2678 
tŸÆ_size
 +
	`PXT4_XATTR_SIZE
(

2679 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

2680 
îr‹
 = 
	`pxt4_x©å_move_to_block
(
h™dÀ
, 
öode
, 
øw_öode
,

2681 
íåy
);

2682 i‡(
îr‹
)

2683  
îr‹
;

2685 *
tŸÆ_öo
 -
íåy_size
;

2686 
i‰ì
 +
tŸÆ_size
;

2687 
b‰ì
 -
tŸÆ_size
;

2691 
	}
}

2697 
	$pxt4_ex∑nd_exåa_isize_ó
(
öode
 *öode, 
√w_exåa_isize
,

2698 
pxt4_öode
 *
øw_öode
, 
h™dÀ_t
 *
h™dÀ
)

2700 
pxt4_x©å_ibody_hódî
 *
hódî
;

2701 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2702 
m¡_cou¡
;

2703 
size_t
 
mö_offs
;

2704 
size_t
 
i‰ì
, 
b‰ì
;

2705 
tŸÆ_öo
;

2706 *
ba£
, *
íd
;

2707 
îr‹
 = 0, 
åõd_mö_exåa_isize
 = 0;

2708 
s_mö_exåa_isize
 = 
	`À16_to_˝u
(
sbi
->
s_es
->s_min_extra_isize);

2709 
isize_diff
;

2711 
ªåy
:

2712 
isize_diff
 = 
√w_exåa_isize
 - 
	`PXT4_I
(
öode
)->
i_exåa_isize
;

2713 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 >
√w_exåa_isize
)

2716 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2723 
ba£
 = 
	`IFIRST
(
hódî
);

2724 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

2725 
mö_offs
 = 
íd
 - 
ba£
;

2726 
tŸÆ_öo
 = (
pxt4_x©å_ibody_hódî
Ë+ (
u32
);

2728 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

2729 i‡(
îr‹
)

2730 
˛ónup
;

2732 
i‰ì
 = 
	`pxt4_x©å_‰ì_•a˚
(
ba£
, &
mö_offs
, ba£, &
tŸÆ_öo
);

2733 i‡(
i‰ì
 >
isize_diff
)

2734 
shi·
;

2740 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

2741 
buf„r_hód
 *
bh
;

2743 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

2744 i‡(
	`IS_ERR
(
bh
)) {

2745 
îr‹
 = 
	`PTR_ERR
(
bh
);

2746 
˛ónup
;

2748 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

2749 i‡(
îr‹
) {

2750 
	`bªl£
(
bh
);

2751 
˛ónup
;

2753 
ba£
 = 
	`BHDR
(
bh
);

2754 
íd
 = 
bh
->
b_d©a
 + bh->
b_size
;

2755 
mö_offs
 = 
íd
 - 
ba£
;

2756 
b‰ì
 = 
	`pxt4_x©å_‰ì_•a˚
(
	`BFIRST
(
bh
), &
mö_offs
, 
ba£
,

2757 
NULL
);

2758 
	`bªl£
(
bh
);

2759 i‡(
b‰ì
 + 
i‰ì
 < 
isize_diff
) {

2760 i‡(!
åõd_mö_exåa_isize
 && 
s_mö_exåa_isize
) {

2761 
åõd_mö_exåa_isize
++;

2762 
√w_exåa_isize
 = 
s_mö_exåa_isize
;

2763 
ªåy
;

2765 
îr‹
 = -
ENOSPC
;

2766 
˛ónup
;

2769 
b‰ì
 = 
öode
->
i_sb
->
s_blocksize
;

2772 
îr‹
 = 
	`pxt4_x©å_make_öode_•a˚
(
h™dÀ
, 
öode
, 
øw_öode
,

2773 
isize_diff
, 
i‰ì
, 
b‰ì
,

2774 &
tŸÆ_öo
);

2775 i‡(
îr‹
) {

2776 i‡(
îr‹
 =-
ENOSPC
 && !
åõd_mö_exåa_isize
 &&

2777 
s_mö_exåa_isize
) {

2778 
åõd_mö_exåa_isize
++;

2779 
√w_exåa_isize
 = 
s_mö_exåa_isize
;

2780 
ªåy
;

2782 
˛ónup
;

2784 
shi·
:

2786 
	`pxt4_x©å_shi·_íåõs
(
	`IFIRST
(
hódî
), 
	`PXT4_I
(
öode
)->
i_exåa_isize


2787 - 
√w_exåa_isize
, (*)
øw_öode
 +

2788 
PXT4_GOOD_OLD_INODE_SIZE
 + 
√w_exåa_isize
,

2789 (*)
hódî
, 
tŸÆ_öo
);

2790 
	`PXT4_I
(
öode
)->
i_exåa_isize
 = 
√w_exåa_isize
;

2792 
˛ónup
:

2793 i‡(
îr‹
 && (
m¡_cou¡
 !
	`À16_to_˝u
(
sbi
->
s_es
->
s_m¡_cou¡
))) {

2794 
	`pxt4_w¨nög
(
öode
->
i_sb
, "UnableÅoÉxpand inode %lu. Delete some EAs orÑunÉ2fsck.",

2795 
öode
->
i_öo
);

2796 
m¡_cou¡
 = 
	`À16_to_˝u
(
sbi
->
s_es
->
s_m¡_cou¡
);

2798  
îr‹
;

2799 
	}
}

2801 
	#EIA_INCR
 16

	)

2802 
	#EIA_MASK
 (
EIA_INCR
 - 1)

	)

2809 
	$pxt4_ex∑nd_öode_¨øy
(
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

2810 
öode
 *inode)

2812 i‡(*
ó_öode_¨øy
 =
NULL
) {

2817 (*
ó_öode_¨øy
) =

2818 
	`kmÆloc
(
	`off£tof
(
pxt4_x©å_öode_¨øy
,

2819 
öodes
[
EIA_MASK
]),

2820 
GFP_NOFS
);

2821 i‡(*
ó_öode_¨øy
 =
NULL
)

2822  -
ENOMEM
;

2823 (*
ó_öode_¨øy
)->
cou¡
 = 0;

2824 } i‡(((*
ó_öode_¨øy
)->
cou¡
 & 
EIA_MASK
) == EIA_MASK) {

2826 
pxt4_x©å_öode_¨øy
 *
√w_¨øy
 = 
NULL
;

2827 
cou¡
 = (*
ó_öode_¨øy
)->count;

2830 
√w_¨øy
 = 
	`kmÆloc
(

2831 
	`off£tof
(
pxt4_x©å_öode_¨øy
,

2832 
öodes
[
cou¡
 + 
EIA_INCR
]),

2833 
GFP_NOFS
);

2834 i‡(
√w_¨øy
 =
NULL
)

2835  -
ENOMEM
;

2836 
	`mem˝y
(
√w_¨øy
, *
ó_öode_¨øy
,

2837 
	`off£tof
(
pxt4_x©å_öode_¨øy
, 
öodes
[
cou¡
]));

2838 
	`k‰ì
(*
ó_öode_¨øy
);

2839 *
ó_öode_¨øy
 = 
√w_¨øy
;

2841 (*
ó_öode_¨øy
)->
öodes
[(*ó_öode_¨øy)->
cou¡
++] = 
öode
;

2843 
	}
}

2854 
	$pxt4_x©å_dñëe_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2855 
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

2856 
exåa_¸edôs
)

2858 
buf„r_hód
 *
bh
 = 
NULL
;

2859 
pxt4_x©å_ibody_hódî
 *
hódî
;

2860 
pxt4_ûoc
 
ûoc
 = { .
bh
 = 
NULL
 };

2861 
pxt4_x©å_íåy
 *
íåy
;

2862 
öode
 *
ó_öode
;

2863 
îr‹
;

2865 
îr‹
 = 
	`pxt4_x©å_ísuª_¸edôs
(
h™dÀ
, 
öode
, 
exåa_¸edôs
,

2866 
NULL
 ,

2867 
Ál£
 ,

2868 
Ál£
 );

2869 i‡(
îr‹
) {

2870 
	`PXT4_ERROR_INODE
(
öode
, "ísuª cªdô†”º‹ %d)", 
îr‹
);

2871 
˛ónup
;

2874 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

2875 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

2877 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

2878 i‡(
îr‹
) {

2879 
	`PXT4_ERROR_INODE
(
öode
, "öodêlo¯”º‹ %d)", 
îr‹
);

2880 
˛ónup
;

2883 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
.
bh
);

2884 i‡(
îr‹
) {

2885 
	`PXT4_ERROR_INODE
(
öode
, "writeáccess (error %d)",

2886 
îr‹
);

2887 
˛ónup
;

2890 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(&
ûoc
));

2891 i‡(
hódî
->
h_magic
 =
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
))

2892 
	`pxt4_x©å_öode_dec_ªf_Æl
(
h™dÀ
, 
öode
, 
ûoc
.
bh
,

2893 
	`IFIRST
(
hódî
),

2894 
Ál£
 ,

2895 
ó_öode_¨øy
,

2896 
exåa_¸edôs
,

2897 
Ál£
 );

2900 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

2901 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

2902 i‡(
	`IS_ERR
(
bh
)) {

2903 
îr‹
 = 
	`PTR_ERR
(
bh
);

2904 i‡(
îr‹
 =-
EIO
)

2905 
	`PXT4_ERROR_INODE
(
öode
, "block %lluÑeadÉrror",

2906 
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

2907 
bh
 = 
NULL
;

2908 
˛ónup
;

2910 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

2911 i‡(
îr‹
)

2912 
˛ónup
;

2914 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
)) {

2915 
íåy
 = 
	`BFIRST
(
bh
); !
	`IS_LAST_ENTRY
(entry);

2916 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

2917 i‡(!
íåy
->
e_vÆue_öum
)

2919 
îr‹
 = 
	`pxt4_x©å_öode_igë
(
öode
,

2920 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
),

2921 
	`À32_to_˝u
(
íåy
->
e_hash
),

2922 &
ó_öode
);

2923 i‡(
îr‹
)

2925 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
ó_öode
,

2926 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

2927 
	`ùut
(
ó_öode
);

2932 
	`pxt4_x©å_ªÀa£_block
(
h™dÀ
, 
öode
, 
bh
, 
ó_öode_¨øy
,

2933 
exåa_¸edôs
);

2938 
	`PXT4_I
(
öode
)->
i_fûe_a˛
 = 0;

2939 
îr‹
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2940 i‡(
îr‹
) {

2941 
	`PXT4_ERROR_INODE
(
öode
, "mark inode dirty (error %d)",

2942 
îr‹
);

2943 
˛ónup
;

2946 
îr‹
 = 0;

2947 
˛ónup
:

2948 
	`bªl£
(
ûoc
.
bh
);

2949 
	`bªl£
(
bh
);

2950  
îr‹
;

2951 
	}
}

2953 
	$pxt4_x©å_öode_¨øy_‰ì
(
pxt4_x©å_öode_¨øy
 *
ó_öode_¨øy
)

2955 
idx
;

2957 i‡(
ó_öode_¨øy
 =
NULL
)

2960 
idx
 = 0; idx < 
ó_öode_¨øy
->
cou¡
; ++idx)

2961 
	`ùut
(
ó_öode_¨øy
->
öodes
[
idx
]);

2962 
	`k‰ì
(
ó_öode_¨øy
);

2963 
	}
}

2974 
	$pxt4_x©å_block_ˇche_ö£π
(
mb_ˇche
 *
ó_block_ˇche
,

2975 
buf„r_hód
 *
bh
)

2977 
pxt4_x©å_hódî
 *
hódî
 = 
	`BHDR
(
bh
);

2978 
__u32
 
hash
 = 
	`À32_to_˝u
(
hódî
->
h_hash
);

2979 
ªußbÀ
 = 
	`À32_to_˝u
(
hódî
->
h_ªfcou¡
) <

2980 
PXT4_XATTR_REFCOUNT_MAX
;

2981 
îr‹
;

2983 i‡(!
ó_block_ˇche
)

2985 
îr‹
 = 
	`mb_ˇche_íåy_¸óã
(
ó_block_ˇche
, 
GFP_NOFS
, 
hash
,

2986 
bh
->
b_blockƒ
, 
ªußbÀ
);

2987 i‡(
îr‹
) {

2988 i‡(
îr‹
 =-
EBUSY
)

2989 
	`ó_bdebug
(
bh
, "already in cache");

2991 
	`ó_bdebug
(
bh
, "ö£πög [%x]", ()
hash
);

2992 
	}
}

3003 
	$pxt4_x©å_cmp
(
pxt4_x©å_hódî
 *
hódî1
,

3004 
pxt4_x©å_hódî
 *
hódî2
)

3006 
pxt4_x©å_íåy
 *
íåy1
, *
íåy2
;

3008 
íåy1
 = 
	`ENTRY
(
hódî1
+1);

3009 
íåy2
 = 
	`ENTRY
(
hódî2
+1);

3010 !
	`IS_LAST_ENTRY
(
íåy1
)) {

3011 i‡(
	`IS_LAST_ENTRY
(
íåy2
))

3013 i‡(
íåy1
->
e_hash
 !
íåy2
->e_hash ||

3014 
íåy1
->
e_«me_ödex
 !
íåy2
->e_name_index ||

3015 
íåy1
->
e_«me_Àn
 !
íåy2
->e_name_len ||

3016 
íåy1
->
e_vÆue_size
 !
íåy2
->e_value_size ||

3017 
íåy1
->
e_vÆue_öum
 !
íåy2
->e_value_inum ||

3018 
	`memcmp
(
íåy1
->
e_«me
, 
íåy2
->e_«me,É¡ry1->
e_«me_Àn
))

3020 i‡(!
íåy1
->
e_vÆue_öum
 &&

3021 
	`memcmp
((*)
hódî1
 + 
	`À16_to_˝u
(
íåy1
->
e_vÆue_offs
),

3022 (*)
hódî2
 + 
	`À16_to_˝u
(
íåy2
->
e_vÆue_offs
),

3023 
	`À32_to_˝u
(
íåy1
->
e_vÆue_size
)))

3026 
íåy1
 = 
	`PXT4_XATTR_NEXT
(entry1);

3027 
íåy2
 = 
	`PXT4_XATTR_NEXT
(entry2);

3029 i‡(!
	`IS_LAST_ENTRY
(
íåy2
))

3032 
	}
}

3042 
buf„r_hód
 *

3043 
	$pxt4_x©å_block_ˇche_föd
(
öode
 *inode,

3044 
pxt4_x©å_hódî
 *
hódî
,

3045 
mb_ˇche_íåy
 **
p˚
)

3047 
__u32
 
hash
 = 
	`À32_to_˝u
(
hódî
->
h_hash
);

3048 
mb_ˇche_íåy
 *
˚
;

3049 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

3051 i‡(!
ó_block_ˇche
)

3052  
NULL
;

3053 i‡(!
hódî
->
h_hash
)

3054  
NULL
;

3055 
	`ó_idebug
(
öode
, "lookög f‹ cached block†[%x]", ()
hash
);

3056 
˚
 = 
	`mb_ˇche_íåy_föd_fú°
(
ó_block_ˇche
, 
hash
);

3057 
˚
) {

3058 
buf„r_hód
 *
bh
;

3060 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
˚
->
e_vÆue
, 
REQ_PRIO
);

3061 i‡(
	`IS_ERR
(
bh
)) {

3062 i‡(
	`PTR_ERR
(
bh
Ë=-
ENOMEM
)

3063  
NULL
;

3064 
bh
 = 
NULL
;

3065 
	`PXT4_ERROR_INODE
(
öode
, "block %luÑeadÉrror",

3066 ()
˚
->
e_vÆue
);

3067 } i‡(
	`pxt4_x©å_cmp
(
hódî
, 
	`BHDR
(
bh
)) == 0) {

3068 *
p˚
 = 
˚
;

3069  
bh
;

3071 
	`bªl£
(
bh
);

3072 
˚
 = 
	`mb_ˇche_íåy_föd_√xt
(
ó_block_ˇche
, ce);

3074  
NULL
;

3075 
	}
}

3077 
	#NAME_HASH_SHIFT
 5

	)

3078 
	#VALUE_HASH_SHIFT
 16

	)

3085 
__À32
 
	$pxt4_x©å_hash_íåy
(*
«me
, 
size_t
 
«me_Àn
, 
__À32
 *
vÆue
,

3086 
size_t
 
vÆue_cou¡
)

3088 
__u32
 
hash
 = 0;

3090 
«me_Àn
--) {

3091 
hash
 = (hash << 
NAME_HASH_SHIFT
) ^

3092 (
hash
 >> (8*(hashË- 
NAME_HASH_SHIFT
)) ^

3093 *
«me
++;

3095 
vÆue_cou¡
--) {

3096 
hash
 = (hash << 
VALUE_HASH_SHIFT
) ^

3097 (
hash
 >> (8*(hashË- 
VALUE_HASH_SHIFT
)) ^

3098 
	`À32_to_˝u
(*
vÆue
++);

3100  
	`˝u_to_À32
(
hash
);

3101 
	}
}

3103 #unde‡
NAME_HASH_SHIFT


3104 #unde‡
VALUE_HASH_SHIFT


3106 
	#BLOCK_HASH_SHIFT
 16

	)

3113 
	$pxt4_x©å_ªhash
(
pxt4_x©å_hódî
 *
hódî
)

3115 
pxt4_x©å_íåy
 *
hîe
;

3116 
__u32
 
hash
 = 0;

3118 
hîe
 = 
	`ENTRY
(
hódî
+1);

3119 !
	`IS_LAST_ENTRY
(
hîe
)) {

3120 i‡(!
hîe
->
e_hash
) {

3122 
hash
 = 0;

3125 
hash
 = (hash << 
BLOCK_HASH_SHIFT
) ^

3126 (
hash
 >> (8*(hashË- 
BLOCK_HASH_SHIFT
)) ^

3127 
	`À32_to_˝u
(
hîe
->
e_hash
);

3128 
hîe
 = 
	`PXT4_XATTR_NEXT
(here);

3130 
hódî
->
h_hash
 = 
	`˝u_to_À32
(
hash
);

3131 
	}
}

3133 #unde‡
BLOCK_HASH_SHIFT


3135 
	#HASH_BUCKET_BITS
 10

	)

3137 
mb_ˇche
 *

3138 
	$pxt4_x©å_¸óã_ˇche
()

3140  
	`mb_ˇche_¸óã
(
HASH_BUCKET_BITS
);

3141 
	}
}

3143 
	$pxt4_x©å_de°roy_ˇche
(
mb_ˇche
 *
ˇche
)

3145 i‡(
ˇche
)

3146 
	`mb_ˇche_de°roy
(
ˇche
);

3147 
	}
}

	@xattr.h

10 
	~<löux/x©å.h
>

13 
	#PXT4_XATTR_MAGIC
 0xEA020000

	)

16 
	#PXT4_XATTR_REFCOUNT_MAX
 1024

	)

19 
	#PXT4_XATTR_INDEX_USER
 1

	)

20 
	#PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
 2

	)

21 
	#PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
 3

	)

22 
	#PXT4_XATTR_INDEX_TRUSTED
 4

	)

23 
	#PXT4_XATTR_INDEX_LUSTRE
 5

	)

24 
	#PXT4_XATTR_INDEX_SECURITY
 6

	)

25 
	#PXT4_XATTR_INDEX_SYSTEM
 7

	)

26 
	#PXT4_XATTR_INDEX_RICHACL
 8

	)

27 
	#PXT4_XATTR_INDEX_ENCRYPTION
 9

	)

28 
	#PXT4_XATTR_INDEX_HURD
 10

	)

30 
	spxt4_x©å_hódî
 {

31 
__À32
 
	mh_magic
;

32 
__À32
 
	mh_ªfcou¡
;

33 
__À32
 
	mh_blocks
;

34 
__À32
 
	mh_hash
;

35 
__À32
 
	mh_checksum
;

37 
__u32
 
	mh_ª£rved
[3];

40 
	spxt4_x©å_ibody_hódî
 {

41 
__À32
 
	mh_magic
;

44 
	spxt4_x©å_íåy
 {

45 
__u8
 
	me_«me_Àn
;

46 
__u8
 
	me_«me_ödex
;

47 
__À16
 
	me_vÆue_offs
;

48 
__À32
 
	me_vÆue_öum
;

49 
__À32
 
	me_vÆue_size
;

50 
__À32
 
	me_hash
;

51 
	me_«me
[0];

54 
	#PXT4_XATTR_PAD_BITS
 2

	)

55 
	#PXT4_XATTR_PAD
 (1<<
PXT4_XATTR_PAD_BITS
)

	)

56 
	#PXT4_XATTR_ROUND
 (
PXT4_XATTR_PAD
-1)

	)

57 
	#PXT4_XATTR_LEN
(
«me_Àn
) \

58 (((
«me_Àn
Ë+ 
PXT4_XATTR_ROUND
 + \

59 (
pxt4_x©å_íåy
)Ë& ~
PXT4_XATTR_ROUND
)

	)

60 
	#PXT4_XATTR_NEXT
(
íåy
) \

61 ((
pxt4_x©å_íåy
 *)( \

62 (*)(
íåy
Ë+ 
	`PXT4_XATTR_LEN
(”¡ry)->
e_«me_Àn
)))

	)

63 
	#PXT4_XATTR_SIZE
(
size
) \

64 (((
size
Ë+ 
PXT4_XATTR_ROUND
Ë& ~PXT4_XATTR_ROUND)

	)

66 
	#IHDR
(
öode
, 
øw_öode
) \

67 ((
pxt4_x©å_ibody_hódî
 *) \

68 ((*)
øw_öode
 + \

69 
PXT4_GOOD_OLD_INODE_SIZE
 + \

70 
	`PXT4_I
(
öode
)->
i_exåa_isize
))

	)

71 
	#IFIRST
(
hdr
Ë((
pxt4_x©å_íåy
 *)((hdr)+1))

	)

82 
	#PXT4_XATTR_SIZE_MAX
 (1 << 24)

	)

88 
	#PXT4_XATTR_MIN_LARGE_EA_SIZE
(
b
) \

89 ((
b
Ë- 
	`PXT4_XATTR_LEN
(3Ë- (
pxt4_x©å_hódî
Ë- 4)

	)

91 
	#BHDR
(
bh
Ë((
pxt4_x©å_hódî
 *)((bh)->
b_d©a
))

	)

92 
	#ENTRY
(
±r
Ë((
pxt4_x©å_íåy
 *)’å))

	)

93 
	#BFIRST
(
bh
Ë
	`ENTRY
(
	`BHDR
(bh)+1)

	)

94 
	#IS_LAST_ENTRY
(
íåy
Ë(*(
__u32
 *)”¡ryË=0)

	)

96 
	#PXT4_ZERO_XATTR_VALUE
 ((*)-1)

	)

98 
	spxt4_x©å_öfo
 {

99 c⁄° *
	m«me
;

100 c⁄° *
	mvÆue
;

101 
size_t
 
	mvÆue_Àn
;

102 
	m«me_ödex
;

103 
	mö_öode
;

106 
	spxt4_x©å_£¨ch
 {

107 
pxt4_x©å_íåy
 *
	mfú°
;

108 *
	mba£
;

109 *
	míd
;

110 
pxt4_x©å_íåy
 *
	mhîe
;

111 
	mnŸ_found
;

114 
	spxt4_x©å_ibody_föd
 {

115 
pxt4_x©å_£¨ch
 
	ms
;

116 
pxt4_ûoc
 
	mûoc
;

119 
	spxt4_x©å_öode_¨øy
 {

120 
	mcou¡
;

121 
öode
 *
	möodes
[0];

124 c⁄° 
x©å_h™dÀr
 
pxt4_x©å_u£r_h™dÀr
;

125 c⁄° 
x©å_h™dÀr
 
pxt4_x©å_åu°ed_h™dÀr
;

126 c⁄° 
x©å_h™dÀr
 
pxt4_x©å_£curôy_h™dÀr
;

128 
	#PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
 "c"

	)

139 
ölöe
 
	$pxt4_wrôe_lock_x©å
(
öode
 *öode, *
ßve
)

141 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

142 *
ßve
 = 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

143 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

144 
	}
}

146 
ölöe
 
	$pxt4_wrôe_åylock_x©å
(
öode
 *öode, *
ßve
)

148 i‡(
	`down_wrôe_åylock
(&
	`PXT4_I
(
öode
)->
x©å_£m
) == 0)

150 *
ßve
 = 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

151 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

153 
	}
}

155 
ölöe
 
	$pxt4_wrôe_u∆ock_x©å
(
öode
 *öode, *
ßve
)

157 i‡(*
ßve
 == 0)

158 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

159 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

160 
	}
}

162 
ssize_t
 
pxt4_li°x©å
(
díåy
 *, *, 
size_t
);

164 
pxt4_x©å_gë
(
öode
 *, , c⁄° *, *, 
size_t
);

165 
pxt4_x©å_£t
(
öode
 *, , c⁄° *, c⁄° *, 
size_t
, );

166 
pxt4_x©å_£t_h™dÀ
(
h™dÀ_t
 *, 
öode
 *, , c⁄° *, c⁄° *, 
size_t
, );

167 
pxt4_x©å_£t_¸edôs
(
öode
 *öode, 
size_t
 
vÆue_Àn
,

168 
boﬁ
 
is_¸óã
, *
¸edôs
);

169 
__pxt4_x©å_£t_¸edôs
(
su≥r_block
 *
sb
, 
öode
 *inode,

170 
buf„r_hód
 *
block_bh
, 
size_t
 
vÆue_Àn
,

171 
boﬁ
 
is_¸óã
);

173 
pxt4_x©å_dñëe_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

174 
pxt4_x©å_öode_¨øy
 **
¨øy
,

175 
exåa_¸edôs
);

176 
pxt4_x©å_öode_¨øy_‰ì
(
pxt4_x©å_öode_¨øy
 *
¨øy
);

178 
pxt4_ex∑nd_exåa_isize_ó
(
öode
 *öode, 
√w_exåa_isize
,

179 
pxt4_öode
 *
øw_öode
, 
h™dÀ_t
 *
h™dÀ
);

181 c⁄° 
x©å_h™dÀr
 *
pxt4_x©å_h™dÀrs
[];

183 
pxt4_x©å_ibody_föd
(
öode
 *öode, 
pxt4_x©å_öfo
 *
i
,

184 
pxt4_x©å_ibody_föd
 *
is
);

185 
pxt4_x©å_ibody_gë
(
öode
 *öode, 
«me_ödex
,

186 c⁄° *
«me
,

187 *
buf„r
, 
size_t
 
buf„r_size
);

188 
pxt4_x©å_ibody_ölöe_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

189 
pxt4_x©å_öfo
 *
i
,

190 
pxt4_x©å_ibody_föd
 *
is
);

192 
mb_ˇche
 *
pxt4_x©å_¸óã_ˇche
();

193 
pxt4_x©å_de°roy_ˇche
(
mb_ˇche
 *);

195 #ifde‡
CONFIG_PXT4_FS_SECURITY


196 
pxt4_öô_£curôy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

197 
öode
 *
dú
, c⁄° 
q°r
 *qstr);

199 
ölöe
 
	$pxt4_öô_£curôy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

200 
öode
 *
dú
, c⁄° 
q°r
 *qstr)

203 
	}
}

206 #ifde‡
CONFIG_LOCKDEP


207 
pxt4_x©å_öode_£t_˛ass
(
öode
 *
ó_öode
);

209 
ölöe
 
	$pxt4_x©å_öode_£t_˛ass
(
öode
 *
ó_öode
Ë{ 
	}
}

212 
pxt4_gë_öode_ußge
(
öode
 *öode, 
qsize_t
 *
ußge
);

	@xattr_security.c

7 
	~<löux/°rög.h
>

8 
	~<löux/fs.h
>

9 
	~<löux/£curôy.h
>

10 
	~<löux/¶ab.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"x©å.h
"

16 
	$pxt4_x©å_£curôy_gë
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

17 
díåy
 *
unu£d
, 
öode
 *inode,

18 c⁄° *
«me
, *
buf„r
, 
size_t
 
size
)

20  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_SECURITY
,

21 
«me
, 
buf„r
, 
size
);

22 
	}
}

25 
	$pxt4_x©å_£curôy_£t
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

26 
díåy
 *
unu£d
, 
öode
 *inode,

27 c⁄° *
«me
, c⁄° *
vÆue
,

28 
size_t
 
size
, 
Êags
)

30  
	`pxt4_x©å_£t
(
öode
, 
PXT4_XATTR_INDEX_SECURITY
,

31 
«me
, 
vÆue
, 
size
, 
Êags
);

32 
	}
}

35 
	$pxt4_öôx©ås
(
öode
 *öode, c⁄° 
x©å
 *
x©å_¨øy
,

36 *
fs_öfo
)

38 c⁄° 
x©å
 *xattr;

39 
h™dÀ_t
 *
h™dÀ
 = 
fs_öfo
;

40 
îr
 = 0;

42 
x©å
 = 
x©å_¨øy
; x©å->
«me
 !
NULL
; xattr++) {

43 
îr
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
,

44 
PXT4_XATTR_INDEX_SECURITY
,

45 
x©å
->
«me
, x©å->
vÆue
,

46 
x©å
->
vÆue_Àn
, 
XATTR_CREATE
);

47 i‡(
îr
 < 0)

50  
îr
;

51 
	}
}

54 
	$pxt4_öô_£curôy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, öodê*
dú
,

55 c⁄° 
q°r
 *qstr)

57  
	`£curôy_öode_öô_£curôy
(
öode
, 
dú
, 
q°r
,

58 &
pxt4_öôx©ås
, 
h™dÀ
);

59 
	}
}

61 c⁄° 
x©å_h™dÀr
 
	gpxt4_x©å_£curôy_h™dÀr
 = {

62 .
¥efix
 = 
XATTR_SECURITY_PREFIX
,

63 .
	ggë
 = 
pxt4_x©å_£curôy_gë
,

64 .
	g£t
 = 
pxt4_x©å_£curôy_£t
,

	@xattr_trusted.c

9 
	~<löux/°rög.h
>

10 
	~<löux/ˇ∑bûôy.h
>

11 
	~<löux/fs.h
>

12 
	~"pxt4_jbd3.h
"

13 
	~"pxt4.h
"

14 
	~"x©å.h
"

16 
boﬁ


17 
	$pxt4_x©å_åu°ed_li°
(
díåy
 *dentry)

19  
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
);

20 
	}
}

23 
	$pxt4_x©å_åu°ed_gë
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

24 
díåy
 *
unu£d
, 
öode
 *inode,

25 c⁄° *
«me
, *
buf„r
, 
size_t
 
size
)

27  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_TRUSTED
,

28 
«me
, 
buf„r
, 
size
);

29 
	}
}

32 
	$pxt4_x©å_åu°ed_£t
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

33 
díåy
 *
unu£d
, 
öode
 *inode,

34 c⁄° *
«me
, c⁄° *
vÆue
,

35 
size_t
 
size
, 
Êags
)

37  
	`pxt4_x©å_£t
(
öode
, 
PXT4_XATTR_INDEX_TRUSTED
,

38 
«me
, 
vÆue
, 
size
, 
Êags
);

39 
	}
}

41 c⁄° 
x©å_h™dÀr
 
	gpxt4_x©å_åu°ed_h™dÀr
 = {

42 .
¥efix
 = 
XATTR_TRUSTED_PREFIX
,

43 .
	gli°
 = 
pxt4_x©å_åu°ed_li°
,

44 .
	ggë
 = 
pxt4_x©å_åu°ed_gë
,

45 .
	g£t
 = 
pxt4_x©å_åu°ed_£t
,

	@xattr_user.c

9 
	~<löux/°rög.h
>

10 
	~<löux/fs.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"x©å.h
"

15 
boﬁ


16 
	$pxt4_x©å_u£r_li°
(
díåy
 *dentry)

18  
	`ã°_›t
(
díåy
->
d_sb
, 
XATTR_USER
);

19 
	}
}

22 
	$pxt4_x©å_u£r_gë
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

23 
díåy
 *
unu£d
, 
öode
 *inode,

24 c⁄° *
«me
, *
buf„r
, 
size_t
 
size
)

26 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
XATTR_USER
))

27  -
EOPNOTSUPP
;

28  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_USER
,

29 
«me
, 
buf„r
, 
size
);

30 
	}
}

33 
	$pxt4_x©å_u£r_£t
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

34 
díåy
 *
unu£d
, 
öode
 *inode,

35 c⁄° *
«me
, c⁄° *
vÆue
,

36 
size_t
 
size
, 
Êags
)

38 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
XATTR_USER
))

39  -
EOPNOTSUPP
;

40  
	`pxt4_x©å_£t
(
öode
, 
PXT4_XATTR_INDEX_USER
,

41 
«me
, 
vÆue
, 
size
, 
Êags
);

42 
	}
}

44 c⁄° 
x©å_h™dÀr
 
	gpxt4_x©å_u£r_h™dÀr
 = {

45 .
¥efix
 = 
XATTR_USER_PREFIX
,

46 .
	gli°
 = 
pxt4_x©å_u£r_li°
,

47 .
	ggë
 = 
pxt4_x©å_u£r_gë
,

48 .
	g£t
 = 
pxt4_x©å_u£r_£t
,

	@/usr/include/linux/capability.h

14 #i‚de‡
_LINUX_CAPABILITY_H


15 
	#_LINUX_CAPABILITY_H


	)

17 
	~<löux/ty≥s.h
>

30 
	#_LINUX_CAPABILITY_VERSION_1
 0x19980330

	)

31 
	#_LINUX_CAPABILITY_U32S_1
 1

	)

33 
	#_LINUX_CAPABILITY_VERSION_2
 0x20071026

	)

34 
	#_LINUX_CAPABILITY_U32S_2
 2

	)

36 
	#_LINUX_CAPABILITY_VERSION_3
 0x20080522

	)

37 
	#_LINUX_CAPABILITY_U32S_3
 2

	)

39 
	s__u£r_ˇp_hódî_°ru˘
 {

40 
__u32
 
	mvîsi⁄
;

41 
	mpid
;

42 } *
	tˇp_u£r_hódî_t
;

44 
	s__u£r_ˇp_d©a_°ru˘
 {

45 
__u32
 
	mef„˘ive
;

46 
__u32
 
	m≥rmôãd
;

47 
__u32
 
	möhîôabÀ
;

48 } *
	tˇp_u£r_d©a_t
;

51 
	#VFS_CAP_REVISION_MASK
 0xFF000000

	)

52 
	#VFS_CAP_REVISION_SHIFT
 24

	)

53 
	#VFS_CAP_FLAGS_MASK
 ~
VFS_CAP_REVISION_MASK


	)

54 
	#VFS_CAP_FLAGS_EFFECTIVE
 0x000001

	)

56 
	#VFS_CAP_REVISION_1
 0x01000000

	)

57 
	#VFS_CAP_U32_1
 1

	)

58 
	#XATTR_CAPS_SZ_1
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_1
))

	)

60 
	#VFS_CAP_REVISION_2
 0x02000000

	)

61 
	#VFS_CAP_U32_2
 2

	)

62 
	#XATTR_CAPS_SZ_2
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_2
))

	)

64 
	#VFS_CAP_REVISION_3
 0x03000000

	)

65 
	#VFS_CAP_U32_3
 2

	)

66 
	#XATTR_CAPS_SZ_3
 ((
__À32
)*(2 + 2*
VFS_CAP_U32_3
))

	)

68 
	#XATTR_CAPS_SZ
 
XATTR_CAPS_SZ_3


	)

69 
	#VFS_CAP_U32
 
VFS_CAP_U32_3


	)

70 
	#VFS_CAP_REVISION
 
VFS_CAP_REVISION_3


	)

72 
	svfs_ˇp_d©a
 {

73 
__À32
 
	mmagic_ëc
;

75 
__À32
 
	m≥rmôãd
;

76 
__À32
 
	möhîôabÀ
;

77 } 
	md©a
[
VFS_CAP_U32
];

83 
	svfs_ns_ˇp_d©a
 {

84 
__À32
 
	mmagic_ëc
;

86 
__À32
 
	m≥rmôãd
;

87 
__À32
 
	möhîôabÀ
;

88 } 
	md©a
[
VFS_CAP_U32
];

89 
__À32
 
	mroŸid
;

98 
	#_LINUX_CAPABILITY_VERSION
 
_LINUX_CAPABILITY_VERSION_1


	)

99 
	#_LINUX_CAPABILITY_U32S
 
_LINUX_CAPABILITY_U32S_1


	)

111 
	#CAP_CHOWN
 0

	)

117 
	#CAP_DAC_OVERRIDE
 1

	)

123 
	#CAP_DAC_READ_SEARCH
 2

	)

129 
	#CAP_FOWNER
 3

	)

138 
	#CAP_FSETID
 4

	)

144 
	#CAP_KILL
 5

	)

150 
	#CAP_SETGID
 6

	)

155 
	#CAP_SETUID
 7

	)

172 
	#CAP_SETPCAP
 8

	)

176 
	#CAP_LINUX_IMMUTABLE
 9

	)

181 
	#CAP_NET_BIND_SERVICE
 10

	)

185 
	#CAP_NET_BROADCAST
 11

	)

201 
	#CAP_NET_ADMIN
 12

	)

207 
	#CAP_NET_RAW
 13

	)

213 
	#CAP_IPC_LOCK
 14

	)

217 
	#CAP_IPC_OWNER
 15

	)

220 
	#CAP_SYS_MODULE
 16

	)

225 
	#CAP_SYS_RAWIO
 17

	)

229 
	#CAP_SYS_CHROOT
 18

	)

233 
	#CAP_SYS_PTRACE
 19

	)

237 
	#CAP_SYS_PACCT
 20

	)

276 
	#CAP_SYS_ADMIN
 21

	)

280 
	#CAP_SYS_BOOT
 22

	)

289 
	#CAP_SYS_NICE
 23

	)

303 
	#CAP_SYS_RESOURCE
 24

	)

309 
	#CAP_SYS_TIME
 25

	)

314 
	#CAP_SYS_TTY_CONFIG
 26

	)

318 
	#CAP_MKNOD
 27

	)

322 
	#CAP_LEASE
 28

	)

326 
	#CAP_AUDIT_WRITE
 29

	)

330 
	#CAP_AUDIT_CONTROL
 30

	)

332 
	#CAP_SETFCAP
 31

	)

340 
	#CAP_MAC_OVERRIDE
 32

	)

349 
	#CAP_MAC_ADMIN
 33

	)

353 
	#CAP_SYSLOG
 34

	)

357 
	#CAP_WAKE_ALARM
 35

	)

361 
	#CAP_BLOCK_SUSPEND
 36

	)

365 
	#CAP_AUDIT_READ
 37

	)

368 
	#CAP_LAST_CAP
 
CAP_AUDIT_READ


	)

370 
	#ˇp_vÆid
(
x
Ë((xË>0 && (xË<
CAP_LAST_CAP
)

	)

376 
	#CAP_TO_INDEX
(
x
Ë((xË>> 5Ë

	)

377 
	#CAP_TO_MASK
(
x
Ë(1 << ((xË& 31)Ë

	)

	@/usr/include/linux/errno.h

1 
	~<asm/î∫o.h
>

	@/usr/include/linux/falloc.h

2 #i‚de‡
_FALLOC_H_


3 
	#_FALLOC_H_


	)

5 
	#FALLOC_FL_KEEP_SIZE
 0x01

	)

6 
	#FALLOC_FL_PUNCH_HOLE
 0x02

	)

7 
	#FALLOC_FL_NO_HIDE_STALE
 0x04

	)

29 
	#FALLOC_FL_COLLAPSE_RANGE
 0x08

	)

43 
	#FALLOC_FL_ZERO_RANGE
 0x10

	)

60 
	#FALLOC_FL_INSERT_RANGE
 0x20

	)

78 
	#FALLOC_FL_UNSHARE_RANGE
 0x40

	)

	@/usr/include/linux/fcntl.h

2 #i‚de‡
_LINUX_FCNTL_H


3 
	#_LINUX_FCNTL_H


	)

5 
	~<asm/f˙é.h
>

7 
	#F_SETLEASE
 (
F_LINUX_SPECIFIC_BASE
 + 0)

	)

8 
	#F_GETLEASE
 (
F_LINUX_SPECIFIC_BASE
 + 1)

	)

14 
	#F_CANCELLK
 (
F_LINUX_SPECIFIC_BASE
 + 5)

	)

17 
	#F_DUPFD_CLOEXEC
 (
F_LINUX_SPECIFIC_BASE
 + 6)

	)

23 
	#F_NOTIFY
 (
F_LINUX_SPECIFIC_BASE
+2)

	)

28 
	#F_SETPIPE_SZ
 (
F_LINUX_SPECIFIC_BASE
 + 7)

	)

29 
	#F_GETPIPE_SZ
 (
F_LINUX_SPECIFIC_BASE
 + 8)

	)

34 
	#F_ADD_SEALS
 (
F_LINUX_SPECIFIC_BASE
 + 9)

	)

35 
	#F_GET_SEALS
 (
F_LINUX_SPECIFIC_BASE
 + 10)

	)

40 
	#F_SEAL_SEAL
 0x0001

	)

41 
	#F_SEAL_SHRINK
 0x0002

	)

42 
	#F_SEAL_GROW
 0x0004

	)

43 
	#F_SEAL_WRITE
 0x0008

	)

44 
	#F_SEAL_FUTURE_WRITE
 0x0010

	)

52 
	#F_GET_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 11)

	)

53 
	#F_SET_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 12)

	)

54 
	#F_GET_FILE_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 13)

	)

55 
	#F_SET_FILE_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 14)

	)

61 
	#RWF_WRITE_LIFE_NOT_SET
 0

	)

62 
	#RWH_WRITE_LIFE_NONE
 1

	)

63 
	#RWH_WRITE_LIFE_SHORT
 2

	)

64 
	#RWH_WRITE_LIFE_MEDIUM
 3

	)

65 
	#RWH_WRITE_LIFE_LONG
 4

	)

66 
	#RWH_WRITE_LIFE_EXTREME
 5

	)

71 
	#DN_ACCESS
 0x00000001

	)

72 
	#DN_MODIFY
 0x00000002

	)

73 
	#DN_CREATE
 0x00000004

	)

74 
	#DN_DELETE
 0x00000008

	)

75 
	#DN_RENAME
 0x00000010

	)

76 
	#DN_ATTRIB
 0x00000020

	)

77 
	#DN_MULTISHOT
 0x80000000

	)

79 
	#AT_FDCWD
 -100

	)

82 
	#AT_SYMLINK_NOFOLLOW
 0x100

	)

83 
	#AT_REMOVEDIR
 0x200

	)

85 
	#AT_SYMLINK_FOLLOW
 0x400

	)

86 
	#AT_NO_AUTOMOUNT
 0x800

	)

87 
	#AT_EMPTY_PATH
 0x1000

	)

89 
	#AT_STATX_SYNC_TYPE
 0x6000

	)

90 
	#AT_STATX_SYNC_AS_STAT
 0x0000

	)

91 
	#AT_STATX_FORCE_SYNC
 0x2000

	)

92 
	#AT_STATX_DONT_SYNC
 0x4000

	)

94 
	#AT_RECURSIVE
 0x8000

	)

	@/usr/include/linux/fiemap.h

12 #i‚de‡
_LINUX_FIEMAP_H


13 
	#_LINUX_FIEMAP_H


	)

15 
	~<löux/ty≥s.h
>

17 
	sfõm≠_exã¡
 {

18 
__u64
 
	m„_logiˇl
;

20 
__u64
 
	m„_physiˇl
;

22 
__u64
 
	m„_Àngth
;

23 
__u64
 
	m„_ª£rved64
[2];

24 
__u32
 
	m„_Êags
;

25 
__u32
 
	m„_ª£rved
[3];

28 
	sfõm≠
 {

29 
__u64
 
	mfm_°¨t
;

31 
__u64
 
	mfm_Àngth
;

33 
__u32
 
	mfm_Êags
;

34 
__u32
 
	mfm_m≠≥d_exã¡s
;

35 
__u32
 
	mfm_exã¡_cou¡
;

36 
__u32
 
	mfm_ª£rved
;

37 
fõm≠_exã¡
 
	mfm_exã¡s
[0];

40 
	#FIEMAP_MAX_OFFSET
 (~0ULL)

	)

42 
	#FIEMAP_FLAG_SYNC
 0x00000001

	)

43 
	#FIEMAP_FLAG_XATTR
 0x00000002

	)

44 
	#FIEMAP_FLAG_CACHE
 0x00000004

	)

46 
	#FIEMAP_FLAGS_COMPAT
 (
FIEMAP_FLAG_SYNC
 | 
FIEMAP_FLAG_XATTR
)

	)

48 
	#FIEMAP_EXTENT_LAST
 0x00000001

	)

49 
	#FIEMAP_EXTENT_UNKNOWN
 0x00000002

	)

50 
	#FIEMAP_EXTENT_DELALLOC
 0x00000004

	)

52 
	#FIEMAP_EXTENT_ENCODED
 0x00000008

	)

54 
	#FIEMAP_EXTENT_DATA_ENCRYPTED
 0x00000080

	)

56 
	#FIEMAP_EXTENT_NOT_ALIGNED
 0x00000100

	)

58 
	#FIEMAP_EXTENT_DATA_INLINE
 0x00000200

	)

60 
	#FIEMAP_EXTENT_DATA_TAIL
 0x00000400

	)

62 
	#FIEMAP_EXTENT_UNWRITTEN
 0x00000800

	)

64 
	#FIEMAP_EXTENT_MERGED
 0x00001000

	)

67 
	#FIEMAP_EXTENT_SHARED
 0x00002000

	)

	@/usr/include/linux/fs.h

2 #i‚de‡
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<löux/limôs.h
>

14 
	~<löux/io˘l.h
>

15 
	~<löux/ty≥s.h
>

16 
	~<löux/fs¸y±.h
>

19 
	~<löux/mou¡.h
>

32 #unde‡
NR_OPEN


33 
	#INR_OPEN_CUR
 1024

	)

34 
	#INR_OPEN_MAX
 4096

	)

36 
	#BLOCK_SIZE_BITS
 10

	)

37 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

39 
	#SEEK_SET
 0

	)

40 
	#SEEK_CUR
 1

	)

41 
	#SEEK_END
 2

	)

42 
	#SEEK_DATA
 3

	)

43 
	#SEEK_HOLE
 4

	)

44 
	#SEEK_MAX
 
SEEK_HOLE


	)

46 
	#RENAME_NOREPLACE
 (1 << 0Ë

	)

47 
	#RENAME_EXCHANGE
 (1 << 1Ë

	)

48 
	#RENAME_WHITEOUT
 (1 << 2Ë

	)

50 
	sfûe_˛⁄e_ønge
 {

51 
__s64
 
	m§c_fd
;

52 
__u64
 
	m§c_off£t
;

53 
__u64
 
	m§c_Àngth
;

54 
__u64
 
	mde°_off£t
;

57 
	sf°rim_ønge
 {

58 
__u64
 
	m°¨t
;

59 
__u64
 
	mÀn
;

60 
__u64
 
	mmöÀn
;

64 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

65 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

68 
	sfûe_dedu≥_ønge_öfo
 {

69 
__s64
 
	mde°_fd
;

70 
__u64
 
	mde°_off£t
;

71 
__u64
 
	mbyãs_dedu≥d
;

78 
__s32
 
	m°©us
;

79 
__u32
 
	mª£rved
;

83 
	sfûe_dedu≥_ønge
 {

84 
__u64
 
	m§c_off£t
;

85 
__u64
 
	m§c_Àngth
;

86 
__u16
 
	mde°_cou¡
;

87 
__u16
 
	mª£rved1
;

88 
__u32
 
	mª£rved2
;

89 
fûe_dedu≥_ønge_öfo
 
	möfo
[0];

93 
	sfûes_°©_°ru˘
 {

94 
	mƒ_fûes
;

95 
	mƒ_‰ì_fûes
;

96 
	mmax_fûes
;

99 
	söodes_°©_t
 {

100 
	mƒ_öodes
;

101 
	mƒ_unu£d
;

102 
	mdummy
[5];

106 
	#NR_FILE
 8192

	)

111 
	sfsx©å
 {

112 
__u32
 
	mfsx_xÊags
;

113 
__u32
 
	mfsx_extsize
;

114 
__u32
 
	mfsx_√xã¡s
;

115 
__u32
 
	mfsx_¥ojid
;

116 
__u32
 
	mfsx_cowextsize
;

117 
	mfsx_∑d
[8];

123 
	#FS_XFLAG_REALTIME
 0x00000001

	)

124 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

125 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

126 
	#FS_XFLAG_APPEND
 0x00000010

	)

127 
	#FS_XFLAG_SYNC
 0x00000020

	)

128 
	#FS_XFLAG_NOATIME
 0x00000040

	)

129 
	#FS_XFLAG_NODUMP
 0x00000080

	)

130 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

131 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

132 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

133 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

134 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

135 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

136 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

137 
	#FS_XFLAG_DAX
 0x00008000

	)

138 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

139 
	#FS_XFLAG_HASATTR
 0x80000000

	)

144 
	#BLKROSET
 
	`_IO
(0x12,93Ë

	)

145 
	#BLKROGET
 
	`_IO
(0x12,94Ë

	)

146 
	#BLKRRPART
 
	`_IO
(0x12,95Ë

	)

147 
	#BLKGETSIZE
 
	`_IO
(0x12,96Ë

	)

148 
	#BLKFLSBUF
 
	`_IO
(0x12,97Ë

	)

149 
	#BLKRASET
 
	`_IO
(0x12,98Ë

	)

150 
	#BLKRAGET
 
	`_IO
(0x12,99Ë

	)

151 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

152 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

153 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

154 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

155 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

157 
	#BLKPG
 
	`_IO
(0x12,105)

	)

161 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

162 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

167 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

168 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

169 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
Ë

	)

170 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_åa˚_£tup
)

	)

171 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

172 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

173 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

174 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

175 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

176 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

177 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

178 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

179 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

180 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

181 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

182 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

188 
	#BMAP_IOCTL
 1

	)

189 
	#FIBMAP
 
	`_IO
(0x00,1Ë

	)

190 
	#FIGETBSZ
 
	`_IO
(0x00,2Ë

	)

191 
	#FIFREEZE
 
	`_IOWR
('X', 119, Ë

	)

192 
	#FITHAW
 
	`_IOWR
('X', 120, Ë

	)

193 
	#FITRIM
 
	`_IOWR
('X', 121, 
f°rim_ønge
Ë

	)

194 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

195 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fûe_˛⁄e_ønge
)

	)

196 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fûe_dedu≥_ønge
)

	)

198 
	#FSLABEL_MAX
 256

	)

200 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

201 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

202 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

203 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

204 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
fõm≠
)

	)

205 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

206 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

207 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

208 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

209 
	#FS_IOC_FSGETXATTR
 
	`_IOR
('X', 31, 
fsx©å
)

	)

210 
	#FS_IOC_FSSETXATTR
 
	`_IOW
('X', 32, 
fsx©å
)

	)

211 
	#FS_IOC_GETFSLABEL
 
	`_IOR
(0x94, 49, [
FSLABEL_MAX
])

	)

212 
	#FS_IOC_SETFSLABEL
 
	`_IOW
(0x94, 50, [
FSLABEL_MAX
])

	)

234 
	#FS_SECRM_FL
 0x00000001

	)

235 
	#FS_UNRM_FL
 0x00000002

	)

236 
	#FS_COMPR_FL
 0x00000004

	)

237 
	#FS_SYNC_FL
 0x00000008

	)

238 
	#FS_IMMUTABLE_FL
 0x00000010

	)

239 
	#FS_APPEND_FL
 0x00000020

	)

240 
	#FS_NODUMP_FL
 0x00000040

	)

241 
	#FS_NOATIME_FL
 0x00000080

	)

243 
	#FS_DIRTY_FL
 0x00000100

	)

244 
	#FS_COMPRBLK_FL
 0x00000200

	)

245 
	#FS_NOCOMP_FL
 0x00000400

	)

247 
	#FS_ENCRYPT_FL
 0x00000800

	)

248 
	#FS_BTREE_FL
 0x00001000

	)

249 
	#FS_INDEX_FL
 0x00001000

	)

250 
	#FS_IMAGIC_FL
 0x00002000

	)

251 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

252 
	#FS_NOTAIL_FL
 0x00008000

	)

253 
	#FS_DIRSYNC_FL
 0x00010000

	)

254 
	#FS_TOPDIR_FL
 0x00020000

	)

255 
	#FS_HUGE_FILE_FL
 0x00040000

	)

256 
	#FS_EXTENT_FL
 0x00080000

	)

257 
	#FS_VERITY_FL
 0x00100000

	)

258 
	#FS_EA_INODE_FL
 0x00200000

	)

259 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

260 
	#FS_NOCOW_FL
 0x00800000

	)

261 
	#FS_INLINE_DATA_FL
 0x10000000

	)

262 
	#FS_PROJINHERIT_FL
 0x20000000

	)

263 
	#FS_CASEFOLD_FL
 0x40000000

	)

264 
	#FS_RESERVED_FL
 0x80000000

	)

266 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

267 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

270 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

271 
	#SYNC_FILE_RANGE_WRITE
 2

	)

272 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

273 
	#SYNC_FILE_RANGE_WRITE_AND_WAIT
 (
SYNC_FILE_RANGE_WRITE
 | \

274 
SYNC_FILE_RANGE_WAIT_BEFORE
 | \

275 
SYNC_FILE_RANGE_WAIT_AFTER
)

	)

281 
	t__bôwi£
 
	t__kî√l_rwf_t
;

284 
	#RWF_HIPRI
 ((
__kî√l_rwf_t
)0x00000001)

	)

287 
	#RWF_DSYNC
 ((
__kî√l_rwf_t
)0x00000002)

	)

290 
	#RWF_SYNC
 ((
__kî√l_rwf_t
)0x00000004)

	)

293 
	#RWF_NOWAIT
 ((
__kî√l_rwf_t
)0x00000008)

	)

296 
	#RWF_APPEND
 ((
__kî√l_rwf_t
)0x00000010)

	)

299 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
 |\

300 
RWF_APPEND
)

	)

	@/usr/include/linux/fscrypt.h

8 #i‚de‡
_LINUX_FSCRYPT_H


9 
	#_LINUX_FSCRYPT_H


	)

11 
	~<löux/ty≥s.h
>

14 
	#FSCRYPT_POLICY_FLAGS_PAD_4
 0x00

	)

15 
	#FSCRYPT_POLICY_FLAGS_PAD_8
 0x01

	)

16 
	#FSCRYPT_POLICY_FLAGS_PAD_16
 0x02

	)

17 
	#FSCRYPT_POLICY_FLAGS_PAD_32
 0x03

	)

18 
	#FSCRYPT_POLICY_FLAGS_PAD_MASK
 0x03

	)

19 
	#FSCRYPT_POLICY_FLAG_DIRECT_KEY
 0x04

	)

20 
	#FSCRYPT_POLICY_FLAGS_VALID
 0x07

	)

23 
	#FSCRYPT_MODE_AES_256_XTS
 1

	)

24 
	#FSCRYPT_MODE_AES_256_CTS
 4

	)

25 
	#FSCRYPT_MODE_AES_128_CBC
 5

	)

26 
	#FSCRYPT_MODE_AES_128_CTS
 6

	)

27 
	#FSCRYPT_MODE_ADIANTUM
 9

	)

28 
	#__FSCRYPT_MODE_MAX
 9

	)

36 
	#FSCRYPT_POLICY_V1
 0

	)

37 
	#FSCRYPT_KEY_DESCRIPTOR_SIZE
 8

	)

38 
	sfs¸y±_pﬁicy_v1
 {

39 
__u8
 
	mvîsi⁄
;

40 
__u8
 
	mc⁄ã¡s_í¸y±i⁄_mode
;

41 
__u8
 
	mfûíames_í¸y±i⁄_mode
;

42 
__u8
 
	mÊags
;

43 
__u8
 
	mma°î_key_des¸ùt‹
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

45 
	#fs¸y±_pﬁicy
 
fs¸y±_pﬁicy_v1


	)

51 
	#FSCRYPT_KEY_DESC_PREFIX
 "fs¸y±:"

	)

52 
	#FSCRYPT_KEY_DESC_PREFIX_SIZE
 8

	)

53 
	#FSCRYPT_MAX_KEY_SIZE
 64

	)

54 
	sfs¸y±_key
 {

55 
__u32
 
	mmode
;

56 
__u8
 
	møw
[
FSCRYPT_MAX_KEY_SIZE
];

57 
__u32
 
	msize
;

63 
	#FSCRYPT_POLICY_V2
 2

	)

64 
	#FSCRYPT_KEY_IDENTIFIER_SIZE
 16

	)

65 
	sfs¸y±_pﬁicy_v2
 {

66 
__u8
 
	mvîsi⁄
;

67 
__u8
 
	mc⁄ã¡s_í¸y±i⁄_mode
;

68 
__u8
 
	mfûíames_í¸y±i⁄_mode
;

69 
__u8
 
	mÊags
;

70 
__u8
 
	m__ª£rved
[4];

71 
__u8
 
	mma°î_key_idítifõr
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

75 
	sfs¸y±_gë_pﬁicy_ex_¨g
 {

76 
__u64
 
	mpﬁicy_size
;

78 
__u8
 
	mvîsi⁄
;

79 
fs¸y±_pﬁicy_v1
 
	mv1
;

80 
fs¸y±_pﬁicy_v2
 
	mv2
;

81 } 
	mpﬁicy
;

88 
	#FSCRYPT_KEY_SPEC_TYPE_DESCRIPTOR
 1

	)

95 
	#FSCRYPT_KEY_SPEC_TYPE_IDENTIFIER
 2

	)

101 
	sfs¸y±_key_•ecifõr
 {

102 
__u32
 
	mty≥
;

103 
__u32
 
	m__ª£rved
;

105 
__u8
 
	m__ª£rved
[32];

106 
__u8
 
	mdes¸ùt‹
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

107 
__u8
 
	midítifõr
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

108 } 
	mu
;

112 
	sfs¸y±_add_key_¨g
 {

113 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

114 
__u32
 
	møw_size
;

115 
__u32
 
	m__ª£rved
[9];

116 
__u8
 
	møw
[];

120 
	sfs¸y±_ªmove_key_¨g
 {

121 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

122 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_FILES_BUSY
 0x00000001

	)

123 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_OTHER_USERS
 0x00000002

	)

124 
__u32
 
	mªmovÆ_°©us_Êags
;

125 
__u32
 
	m__ª£rved
[5];

129 
	sfs¸y±_gë_key_°©us_¨g
 {

131 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

132 
__u32
 
	m__ª£rved
[6];

135 
	#FSCRYPT_KEY_STATUS_ABSENT
 1

	)

136 
	#FSCRYPT_KEY_STATUS_PRESENT
 2

	)

137 
	#FSCRYPT_KEY_STATUS_INCOMPLETELY_REMOVED
 3

	)

138 
__u32
 
	m°©us
;

139 
	#FSCRYPT_KEY_STATUS_FLAG_ADDED_BY_SELF
 0x00000001

	)

140 
__u32
 
	m°©us_Êags
;

141 
__u32
 
	mu£r_cou¡
;

142 
__u32
 
	m__out_ª£rved
[13];

145 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fs¸y±_pﬁicy
)

	)

146 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

147 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fs¸y±_pﬁicy
)

	)

148 
	#FS_IOC_GET_ENCRYPTION_POLICY_EX
 
	`_IOWR
('f', 22, 
__u8
[9]Ë

	)

149 
	#FS_IOC_ADD_ENCRYPTION_KEY
 
	`_IOWR
('f', 23, 
fs¸y±_add_key_¨g
)

	)

150 
	#FS_IOC_REMOVE_ENCRYPTION_KEY
 
	`_IOWR
('f', 24, 
fs¸y±_ªmove_key_¨g
)

	)

151 
	#FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
 
	`_IOWR
('f', 25, 
fs¸y±_ªmove_key_¨g
)

	)

152 
	#FS_IOC_GET_ENCRYPTION_KEY_STATUS
 
	`_IOWR
('f', 26, 
fs¸y±_gë_key_°©us_¨g
)

	)

157 
	#FS_KEY_DESCRIPTOR_SIZE
 
FSCRYPT_KEY_DESCRIPTOR_SIZE


	)

158 
	#FS_POLICY_FLAGS_PAD_4
 
FSCRYPT_POLICY_FLAGS_PAD_4


	)

159 
	#FS_POLICY_FLAGS_PAD_8
 
FSCRYPT_POLICY_FLAGS_PAD_8


	)

160 
	#FS_POLICY_FLAGS_PAD_16
 
FSCRYPT_POLICY_FLAGS_PAD_16


	)

161 
	#FS_POLICY_FLAGS_PAD_32
 
FSCRYPT_POLICY_FLAGS_PAD_32


	)

162 
	#FS_POLICY_FLAGS_PAD_MASK
 
FSCRYPT_POLICY_FLAGS_PAD_MASK


	)

163 
	#FS_POLICY_FLAG_DIRECT_KEY
 
FSCRYPT_POLICY_FLAG_DIRECT_KEY


	)

164 
	#FS_POLICY_FLAGS_VALID
 
FSCRYPT_POLICY_FLAGS_VALID


	)

165 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

166 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 
FSCRYPT_MODE_AES_256_XTS


	)

167 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

168 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

169 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 
FSCRYPT_MODE_AES_256_CTS


	)

170 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 
FSCRYPT_MODE_AES_128_CBC


	)

171 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 
FSCRYPT_MODE_AES_128_CTS


	)

172 
	#FS_ENCRYPTION_MODE_SPECK128_256_XTS
 7

	)

173 
	#FS_ENCRYPTION_MODE_SPECK128_256_CTS
 8

	)

174 
	#FS_ENCRYPTION_MODE_ADIANTUM
 
FSCRYPT_MODE_ADIANTUM


	)

175 
	#FS_KEY_DESC_PREFIX
 
FSCRYPT_KEY_DESC_PREFIX


	)

176 
	#FS_KEY_DESC_PREFIX_SIZE
 
FSCRYPT_KEY_DESC_PREFIX_SIZE


	)

177 
	#FS_MAX_KEY_SIZE
 
FSCRYPT_MAX_KEY_SIZE


	)

	@/usr/include/linux/fsmap.h

9 #i‚de‡
_LINUX_FSMAP_H


10 
	#_LINUX_FSMAP_H


	)

12 
	~<löux/ty≥s.h
>

50 
	sfsm≠
 {

51 
__u32
 
	mfmr_devi˚
;

52 
__u32
 
	mfmr_Êags
;

53 
__u64
 
	mfmr_physiˇl
;

54 
__u64
 
	mfmr_ow√r
;

55 
__u64
 
	mfmr_off£t
;

56 
__u64
 
	mfmr_Àngth
;

57 
__u64
 
	mfmr_ª£rved
[3];

60 
	sfsm≠_hód
 {

61 
__u32
 
	mfmh_iÊags
;

62 
__u32
 
	mfmh_oÊags
;

63 
__u32
 
	mfmh_cou¡
;

64 
__u32
 
	mfmh_íåõs
;

65 
__u64
 
	mfmh_ª£rved
[6];

67 
fsm≠
 
	mfmh_keys
[2];

68 
fsm≠
 
	mfmh_ªcs
[];

72 
__ölöe__
 
size_t


73 
	$fsm≠_sizeof
(

74 
ƒ
)

76  (
fsm≠_hód
Ë+ 
ƒ
 * (
fsm≠
);

77 
	}
}

80 
__ölöe__
 

81 
	$fsm≠_adv™˚
(

82 
fsm≠_hód
 *
hód
)

84 
hód
->
fmh_keys
[0] = hód->
fmh_ªcs
[hód->
fmh_íåõs
 - 1];

85 
	}
}

89 
	#FMH_IF_VALID
 0

	)

92 
	#FMH_OF_DEV_T
 0x1

	)

95 
	#FMR_OF_PREALLOC
 0x1

	)

96 
	#FMR_OF_ATTR_FORK
 0x2

	)

97 
	#FMR_OF_EXTENT_MAP
 0x4

	)

98 
	#FMR_OF_SHARED
 0x8

	)

99 
	#FMR_OF_SPECIAL_OWNER
 0x10

	)

100 
	#FMR_OF_LAST
 0x20

	)

103 
	#FMR_OWNER
(
ty≥
, 
code
Ë(((
__u64
)type << 32) | \

104 ((
__u64
)
code
 & 0xFFFFFFFFULL))

	)

105 
	#FMR_OWNER_TYPE
(
ow√r
Ë((
__u32
)((
__u64
)ow√∏>> 32))

	)

106 
	#FMR_OWNER_CODE
(
ow√r
Ë((
__u32
)(((
__u64
)ow√∏& 0xFFFFFFFFULL)))

	)

107 
	#FMR_OWN_FREE
 
	`FMR_OWNER
(0, 1Ë

	)

108 
	#FMR_OWN_UNKNOWN
 
	`FMR_OWNER
(0, 2Ë

	)

109 
	#FMR_OWN_METADATA
 
	`FMR_OWNER
(0, 3Ë

	)

111 
	#FS_IOC_GETFSMAP
 
	`_IOWR
('X', 59, 
fsm≠_hód
)

	)

	@/usr/include/linux/fsverity.h

10 #i‚de‡
_LINUX_FSVERITY_H


11 
	#_LINUX_FSVERITY_H


	)

13 
	~<löux/io˘l.h
>

14 
	~<löux/ty≥s.h
>

16 
	#FS_VERITY_HASH_ALG_SHA256
 1

	)

17 
	#FS_VERITY_HASH_ALG_SHA512
 2

	)

19 
	sfsvîôy_íabÀ_¨g
 {

20 
__u32
 
	mvîsi⁄
;

21 
__u32
 
	mhash_Æg‹ôhm
;

22 
__u32
 
	mblock_size
;

23 
__u32
 
	mß…_size
;

24 
__u64
 
	mß…_±r
;

25 
__u32
 
	msig_size
;

26 
__u32
 
	m__ª£rved1
;

27 
__u64
 
	msig_±r
;

28 
__u64
 
	m__ª£rved2
[11];

31 
	sfsvîôy_dige°
 {

32 
__u16
 
	mdige°_Æg‹ôhm
;

33 
__u16
 
	mdige°_size
;

34 
__u8
 
	mdige°
[];

37 
	#FS_IOC_ENABLE_VERITY
 
	`_IOW
('f', 133, 
fsvîôy_íabÀ_¨g
)

	)

38 
	#FS_IOC_MEASURE_VERITY
 
	`_IOWR
('f', 134, 
fsvîôy_dige°
)

	)

	@/usr/include/linux/kdev_t.h

2 #i‚de‡
_LINUX_KDEV_T_H


3 
	#_LINUX_KDEV_T_H


	)

9 
	#MAJOR
(
dev
Ë((dev)>>8)

	)

10 
	#MINOR
(
dev
Ë((devË& 0xff)

	)

11 
	#MKDEV
(
ma
,
mi
Ë((ma)<<8 | (mi))

	)

	@/usr/include/linux/kernel.h

2 #i‚de‡
_LINUX_KERNEL_H


3 
	#_LINUX_KERNEL_H


	)

5 
	~<löux/sysöfo.h
>

10 
	#__ALIGN_KERNEL
(
x
, 
a
Ë
	`__ALIGN_KERNEL_MASK
(x, (
	`ty≥of
(x))◊Ë- 1)

	)

11 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
Ë(((xË+ (mask)Ë& ~(mask))

	)

13 
	#__KERNEL_DIV_ROUND_UP
(
n
, 
d
Ë((“Ë+ (dË- 1Ë/ (d))

	)

	@/usr/include/linux/magic.h

2 #i‚de‡
__LINUX_MAGIC_H__


3 
	#__LINUX_MAGIC_H__


	)

5 
	#ADFS_SUPER_MAGIC
 0xadf5

	)

6 
	#AFFS_SUPER_MAGIC
 0xadff

	)

7 
	#AFS_SUPER_MAGIC
 0x5346414F

	)

8 
	#AUTOFS_SUPER_MAGIC
 0x0187

	)

9 
	#CODA_SUPER_MAGIC
 0x73757245

	)

10 
	#CRAMFS_MAGIC
 0x28cd3d45

	)

11 
	#CRAMFS_MAGIC_WEND
 0x453dcd28

	)

12 
	#DEBUGFS_MAGIC
 0x64626720

	)

13 
	#SECURITYFS_MAGIC
 0x73636673

	)

14 
	#SELINUX_MAGIC
 0xf97cff8c

	)

15 
	#SMACK_MAGIC
 0x43415d53

	)

16 
	#RAMFS_MAGIC
 0x858458f6

	)

17 
	#TMPFS_MAGIC
 0x01021994

	)

18 
	#HUGETLBFS_MAGIC
 0x958458f6

	)

19 
	#SQUASHFS_MAGIC
 0x73717368

	)

20 
	#ECRYPTFS_SUPER_MAGIC
 0xf15f

	)

21 
	#EFS_SUPER_MAGIC
 0x414A53

	)

22 
	#EROFS_SUPER_MAGIC_V1
 0xE0F5E1E2

	)

23 
	#PXT2_SUPER_MAGIC
 0xEF53

	)

24 
	#EXT3_SUPER_MAGIC
 0xEF53

	)

25 
	#XENFS_SUPER_MAGIC
 0xabba1974

	)

26 
	#PXT4_SUPER_MAGIC
 0xEF53

	)

27 
	#BTRFS_SUPER_MAGIC
 0x9123683E

	)

28 
	#NILFS_SUPER_MAGIC
 0x3434

	)

29 
	#F2FS_SUPER_MAGIC
 0xF2F52010

	)

30 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

31 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

32 
	#JFFS2_SUPER_MAGIC
 0x72b6

	)

33 
	#XFS_SUPER_MAGIC
 0x58465342

	)

34 
	#PSTOREFS_MAGIC
 0x6165676C

	)

35 
	#EFIVARFS_MAGIC
 0xde5e81e4

	)

36 
	#HOSTFS_SUPER_MAGIC
 0x00c0f„e

	)

37 
	#OVERLAYFS_SUPER_MAGIC
 0x794c7630

	)

39 
	#MINIX_SUPER_MAGIC
 0x137F

	)

40 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

41 
	#MINIX2_SUPER_MAGIC
 0x2468

	)

42 
	#MINIX2_SUPER_MAGIC2
 0x2478

	)

43 
	#MINIX3_SUPER_MAGIC
 0x4d5®

	)

45 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

46 
	#NCP_SUPER_MAGIC
 0x564¯

	)

47 
	#NFS_SUPER_MAGIC
 0x6969

	)

48 
	#OCFS2_SUPER_MAGIC
 0x7461636f

	)

49 
	#OPENPROM_SUPER_MAGIC
 0x9Á1

	)

50 
	#QNX4_SUPER_MAGIC
 0x002‡

	)

51 
	#QNX6_SUPER_MAGIC
 0x68191122

	)

52 
	#AFS_FS_MAGIC
 0x6B414653

	)

54 
	#REISERFS_SUPER_MAGIC
 0x52654973

	)

57 
	#REISERFS_SUPER_MAGIC_STRING
 "ReIsErFs"

	)

58 
	#REISER2FS_SUPER_MAGIC_STRING
 "ReIsEr2Fs"

	)

59 
	#REISER2FS_JR_SUPER_MAGIC_STRING
 "ReIsEr3Fs"

	)

61 
	#SMB_SUPER_MAGIC
 0x517B

	)

62 
	#CGROUP_SUPER_MAGIC
 0x27e0eb

	)

63 
	#CGROUP2_SUPER_MAGIC
 0x63677270

	)

65 
	#RDTGROUP_SUPER_MAGIC
 0x7655821

	)

67 
	#STACK_END_MAGIC
 0x57AC6E9D

	)

69 
	#TRACEFS_MAGIC
 0x74726163

	)

71 
	#V9FS_MAGIC
 0x01021997

	)

73 
	#BDEVFS_MAGIC
 0x62646576

	)

74 
	#DAXFS_MAGIC
 0x64646178

	)

75 
	#BINFMTFS_MAGIC
 0x42494e4d

	)

76 
	#DEVPTS_SUPER_MAGIC
 0x1cd1

	)

77 
	#BINDERFS_SUPER_MAGIC
 0x6c6f6f70

	)

78 
	#FUTEXFS_SUPER_MAGIC
 0xBAD1DEA

	)

79 
	#PIPEFS_MAGIC
 0x50495045

	)

80 
	#PROC_SUPER_MAGIC
 0x9Á0

	)

81 
	#SOCKFS_MAGIC
 0x534F434B

	)

82 
	#SYSFS_MAGIC
 0x62656572

	)

83 
	#USBDEVICE_SUPER_MAGIC
 0x9Á2

	)

84 
	#MTD_INODE_FS_MAGIC
 0x11307854

	)

85 
	#ANON_INODE_FS_MAGIC
 0x09041934

	)

86 
	#BTRFS_TEST_MAGIC
 0x73727279

	)

87 
	#NSFS_MAGIC
 0x6e736673

	)

88 
	#BPF_FS_MAGIC
 0xˇ„4a11

	)

89 
	#AAFS_MAGIC
 0x5a3c69f0

	)

92 
	#UDF_SUPER_MAGIC
 0x15013346

	)

93 
	#BALLOON_KVM_MAGIC
 0x13661366

	)

94 
	#ZSMALLOC_MAGIC
 0x58295829

	)

95 
	#DMA_BUF_MAGIC
 0x444d4142

	)

96 
	#DEVMEM_MAGIC
 0x454d444d

	)

97 
	#Z3FOLD_MAGIC
 0x33

	)

99 
	#SHIFTFS_MAGIC
 0x6a656a62

	)

	@/usr/include/linux/mman.h

2 #i‚de‡
_LINUX_MMAN_H


3 
	#_LINUX_MMAN_H


	)

5 
	~<asm/mm™.h
>

6 
	~<asm-gíîic/hugëlb_ícode.h
>

8 
	#MREMAP_MAYMOVE
 1

	)

9 
	#MREMAP_FIXED
 2

	)

11 
	#OVERCOMMIT_GUESS
 0

	)

12 
	#OVERCOMMIT_ALWAYS
 1

	)

13 
	#OVERCOMMIT_NEVER
 2

	)

15 
	#MAP_SHARED
 0x01

	)

16 
	#MAP_PRIVATE
 0x02

	)

17 
	#MAP_SHARED_VALIDATE
 0x03

	)

26 
	#MAP_HUGE_SHIFT
 
HUGETLB_FLAG_ENCODE_SHIFT


	)

27 
	#MAP_HUGE_MASK
 
HUGETLB_FLAG_ENCODE_MASK


	)

29 
	#MAP_HUGE_64KB
 
HUGETLB_FLAG_ENCODE_64KB


	)

30 
	#MAP_HUGE_512KB
 
HUGETLB_FLAG_ENCODE_512KB


	)

31 
	#MAP_HUGE_1MB
 
HUGETLB_FLAG_ENCODE_1MB


	)

32 
	#MAP_HUGE_2MB
 
HUGETLB_FLAG_ENCODE_2MB


	)

33 
	#MAP_HUGE_8MB
 
HUGETLB_FLAG_ENCODE_8MB


	)

34 
	#MAP_HUGE_16MB
 
HUGETLB_FLAG_ENCODE_16MB


	)

35 
	#MAP_HUGE_32MB
 
HUGETLB_FLAG_ENCODE_32MB


	)

36 
	#MAP_HUGE_256MB
 
HUGETLB_FLAG_ENCODE_256MB


	)

37 
	#MAP_HUGE_512MB
 
HUGETLB_FLAG_ENCODE_512MB


	)

38 
	#MAP_HUGE_1GB
 
HUGETLB_FLAG_ENCODE_1GB


	)

39 
	#MAP_HUGE_2GB
 
HUGETLB_FLAG_ENCODE_2GB


	)

40 
	#MAP_HUGE_16GB
 
HUGETLB_FLAG_ENCODE_16GB


	)

	@/usr/include/linux/module.h

2 #i‚de‡
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/mount.h

1 #i‚de‡
_LINUX_MOUNT_H


2 
	#_LINUX_MOUNT_H


	)

11 
	#MS_RDONLY
 1

	)

12 
	#MS_NOSUID
 2

	)

13 
	#MS_NODEV
 4

	)

14 
	#MS_NOEXEC
 8

	)

15 
	#MS_SYNCHRONOUS
 16

	)

16 
	#MS_REMOUNT
 32

	)

17 
	#MS_MANDLOCK
 64

	)

18 
	#MS_DIRSYNC
 128

	)

19 
	#MS_NOATIME
 1024

	)

20 
	#MS_NODIRATIME
 2048

	)

21 
	#MS_BIND
 4096

	)

22 
	#MS_MOVE
 8192

	)

23 
	#MS_REC
 16384

	)

24 
	#MS_VERBOSE
 32768

	)

26 
	#MS_SILENT
 32768

	)

27 
	#MS_POSIXACL
 (1<<16Ë

	)

28 
	#MS_UNBINDABLE
 (1<<17Ë

	)

29 
	#MS_PRIVATE
 (1<<18Ë

	)

30 
	#MS_SLAVE
 (1<<19Ë

	)

31 
	#MS_SHARED
 (1<<20Ë

	)

32 
	#MS_RELATIME
 (1<<21Ë

	)

33 
	#MS_KERNMOUNT
 (1<<22Ë

	)

34 
	#MS_I_VERSION
 (1<<23Ë

	)

35 
	#MS_STRICTATIME
 (1<<24Ë

	)

36 
	#MS_LAZYTIME
 (1<<25Ë

	)

39 
	#MS_SUBMOUNT
 (1<<26)

	)

40 
	#MS_NOREMOTELOCK
 (1<<27)

	)

41 
	#MS_NOSEC
 (1<<28)

	)

42 
	#MS_BORN
 (1<<29)

	)

43 
	#MS_ACTIVE
 (1<<30)

	)

44 
	#MS_NOUSER
 (1<<31)

	)

49 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

50 
MS_LAZYTIME
)

	)

55 
	#MS_MGC_VAL
 0xC0ED0000

	)

56 
	#MS_MGC_MSK
 0xffff0000

	)

61 
	#OPEN_TREE_CLONE
 1

	)

62 
	#OPEN_TREE_CLOEXEC
 
O_CLOEXEC


	)

67 
	#MOVE_MOUNT_F_SYMLINKS
 0x00000001

	)

68 
	#MOVE_MOUNT_F_AUTOMOUNTS
 0x00000002

	)

69 
	#MOVE_MOUNT_F_EMPTY_PATH
 0x00000004

	)

70 
	#MOVE_MOUNT_T_SYMLINKS
 0x00000010

	)

71 
	#MOVE_MOUNT_T_AUTOMOUNTS
 0x00000020

	)

72 
	#MOVE_MOUNT_T_EMPTY_PATH
 0x00000040

	)

73 
	#MOVE_MOUNT__MASK
 0x00000077

	)

78 
	#FSOPEN_CLOEXEC
 0x00000001

	)

83 
	#FSPICK_CLOEXEC
 0x00000001

	)

84 
	#FSPICK_SYMLINK_NOFOLLOW
 0x00000002

	)

85 
	#FSPICK_NO_AUTOMOUNT
 0x00000004

	)

86 
	#FSPICK_EMPTY_PATH
 0x00000008

	)

91 
	efsc⁄fig_comm™d
 {

92 
	mFSCONFIG_SET_FLAG
 = 0,

93 
	mFSCONFIG_SET_STRING
 = 1,

94 
	mFSCONFIG_SET_BINARY
 = 2,

95 
	mFSCONFIG_SET_PATH
 = 3,

96 
	mFSCONFIG_SET_PATH_EMPTY
 = 4,

97 
	mFSCONFIG_SET_FD
 = 5,

98 
	mFSCONFIG_CMD_CREATE
 = 6,

99 
	mFSCONFIG_CMD_RECONFIGURE
 = 7,

105 
	#FSMOUNT_CLOEXEC
 0x00000001

	)

110 
	#MOUNT_ATTR_RDONLY
 0x00000001

	)

111 
	#MOUNT_ATTR_NOSUID
 0x00000002

	)

112 
	#MOUNT_ATTR_NODEV
 0x00000004

	)

113 
	#MOUNT_ATTR_NOEXEC
 0x00000008

	)

114 
	#MOUNT_ATTR__ATIME
 0x00000070

	)

115 
	#MOUNT_ATTR_RELATIME
 0x00000000

	)

116 
	#MOUNT_ATTR_NOATIME
 0x00000010

	)

117 
	#MOUNT_ATTR_STRICTATIME
 0x00000020

	)

118 
	#MOUNT_ATTR_NODIRATIME
 0x00000080

	)

	@/usr/include/linux/posix_acl_xattr.h

18 #i‚de‡
__UAPI_POSIX_ACL_XATTR_H


19 
	#__UAPI_POSIX_ACL_XATTR_H


	)

21 
	~<löux/ty≥s.h
>

24 
	#POSIX_ACL_XATTR_VERSION
 0x0002

	)

27 
	#ACL_UNDEFINED_ID
 (-1)

	)

29 
	sposix_a˛_x©å_íåy
 {

30 
__À16
 
	me_èg
;

31 
__À16
 
	me_≥rm
;

32 
__À32
 
	me_id
;

35 
	sposix_a˛_x©å_hódî
 {

36 
__À32
 
	ma_vîsi⁄
;

	@/usr/include/linux/quota.h

33 #i‚de‡
_LINUX_QUOTA_


34 
	#_LINUX_QUOTA_


	)

36 
	~<löux/ty≥s.h
>

38 
	#__DQUOT_VERSION__
 "dquŸ_6.6.0"

	)

40 
	#MAXQUOTAS
 3

	)

41 
	#USRQUOTA
 0

	)

42 
	#GRPQUOTA
 1

	)

43 
	#PRJQUOTA
 2

	)

48 
	#INITQFNAMES
 { \

53 };

	)

61 
	#SUBCMDMASK
 0x00ff

	)

62 
	#SUBCMDSHIFT
 8

	)

63 
	#QCMD
(
cmd
, 
ty≥
Ë(((cmdË<< 
SUBCMDSHIFT
Ë| (—y≥Ë& 
SUBCMDMASK
))

	)

65 
	#Q_SYNC
 0x800001

	)

66 
	#Q_QUOTAON
 0x800002

	)

67 
	#Q_QUOTAOFF
 0x800003

	)

68 
	#Q_GETFMT
 0x800004

	)

69 
	#Q_GETINFO
 0x800005

	)

70 
	#Q_SETINFO
 0x800006

	)

71 
	#Q_GETQUOTA
 0x800007

	)

72 
	#Q_SETQUOTA
 0x800008

	)

73 
	#Q_GETNEXTQUOTA
 0x800009

	)

76 
	#QFMT_VFS_OLD
 1

	)

77 
	#QFMT_VFS_V0
 2

	)

78 
	#QFMT_OCFS2
 3

	)

79 
	#QFMT_VFS_V1
 4

	)

83 
	#QIF_DQBLKSIZE_BITS
 10

	)

84 
	#QIF_DQBLKSIZE
 (1 << 
QIF_DQBLKSIZE_BITS
)

	)

91 
	mQIF_BLIMITS_B
 = 0,

92 
	mQIF_SPACE_B
,

93 
	mQIF_ILIMITS_B
,

94 
	mQIF_INODES_B
,

95 
	mQIF_BTIME_B
,

96 
	mQIF_ITIME_B
,

99 
	#QIF_BLIMITS
 (1 << 
QIF_BLIMITS_B
)

	)

100 
	#QIF_SPACE
 (1 << 
QIF_SPACE_B
)

	)

101 
	#QIF_ILIMITS
 (1 << 
QIF_ILIMITS_B
)

	)

102 
	#QIF_INODES
 (1 << 
QIF_INODES_B
)

	)

103 
	#QIF_BTIME
 (1 << 
QIF_BTIME_B
)

	)

104 
	#QIF_ITIME
 (1 << 
QIF_ITIME_B
)

	)

105 
	#QIF_LIMITS
 (
QIF_BLIMITS
 | 
QIF_ILIMITS
)

	)

106 
	#QIF_USAGE
 (
QIF_SPACE
 | 
QIF_INODES
)

	)

107 
	#QIF_TIMES
 (
QIF_BTIME
 | 
QIF_ITIME
)

	)

108 
	#QIF_ALL
 (
QIF_LIMITS
 | 
QIF_USAGE
 | 
QIF_TIMES
)

	)

110 
	sif_dqblk
 {

111 
__u64
 
	mdqb_bh¨dlimô
;

112 
__u64
 
	mdqb_bso·limô
;

113 
__u64
 
	mdqb_cur•a˚
;

114 
__u64
 
	mdqb_ih¨dlimô
;

115 
__u64
 
	mdqb_iso·limô
;

116 
__u64
 
	mdqb_curöodes
;

117 
__u64
 
	mdqb_btime
;

118 
__u64
 
	mdqb_ôime
;

119 
__u32
 
	mdqb_vÆid
;

122 
	sif_√xtdqblk
 {

123 
__u64
 
	mdqb_bh¨dlimô
;

124 
__u64
 
	mdqb_bso·limô
;

125 
__u64
 
	mdqb_cur•a˚
;

126 
__u64
 
	mdqb_ih¨dlimô
;

127 
__u64
 
	mdqb_iso·limô
;

128 
__u64
 
	mdqb_curöodes
;

129 
__u64
 
	mdqb_btime
;

130 
__u64
 
	mdqb_ôime
;

131 
__u32
 
	mdqb_vÆid
;

132 
__u32
 
	mdqb_id
;

139 
	#IIF_BGRACE
 1

	)

140 
	#IIF_IGRACE
 2

	)

141 
	#IIF_FLAGS
 4

	)

142 
	#IIF_ALL
 (
IIF_BGRACE
 | 
IIF_IGRACE
 | 
IIF_FLAGS
)

	)

145 
	mDQF_ROOT_SQUASH_B
 = 0,

146 
	mDQF_SYS_FILE_B
 = 16,

148 
	mDQF_PRIVATE


152 
	#DQF_ROOT_SQUASH
 (1 << 
DQF_ROOT_SQUASH_B
)

	)

154 
	#DQF_SYS_FILE
 (1 << 
DQF_SYS_FILE_B
)

	)

156 
	sif_dqöfo
 {

157 
__u64
 
	mdqi_bgø˚
;

158 
__u64
 
	mdqi_igø˚
;

159 
__u32
 
	mdqi_Êags
;

160 
__u32
 
	mdqi_vÆid
;

166 
	#QUOTA_NL_NOWARN
 0

	)

167 
	#QUOTA_NL_IHARDWARN
 1

	)

168 
	#QUOTA_NL_ISOFTLONGWARN
 2

	)

169 
	#QUOTA_NL_ISOFTWARN
 3

	)

170 
	#QUOTA_NL_BHARDWARN
 4

	)

171 
	#QUOTA_NL_BSOFTLONGWARN
 5

	)

172 
	#QUOTA_NL_BSOFTWARN
 6

	)

173 
	#QUOTA_NL_IHARDBELOW
 7

	)

174 
	#QUOTA_NL_ISOFTBELOW
 8

	)

175 
	#QUOTA_NL_BHARDBELOW
 9

	)

176 
	#QUOTA_NL_BSOFTBELOW
 10

	)

179 
	mQUOTA_NL_C_UNSPEC
,

180 
	mQUOTA_NL_C_WARNING
,

181 
	m__QUOTA_NL_C_MAX
,

183 
	#QUOTA_NL_C_MAX
 (
__QUOTA_NL_C_MAX
 - 1)

	)

186 
	mQUOTA_NL_A_UNSPEC
,

187 
	mQUOTA_NL_A_QTYPE
,

188 
	mQUOTA_NL_A_EXCESS_ID
,

189 
	mQUOTA_NL_A_WARNING
,

190 
	mQUOTA_NL_A_DEV_MAJOR
,

191 
	mQUOTA_NL_A_DEV_MINOR
,

192 
	mQUOTA_NL_A_CAUSED_ID
,

193 
	mQUOTA_NL_A_PAD
,

194 
	m__QUOTA_NL_A_MAX
,

196 
	#QUOTA_NL_A_MAX
 (
__QUOTA_NL_A_MAX
 - 1)

	)

	@/usr/include/linux/random.h

8 #i‚de‡
_LINUX_RANDOM_H


9 
	#_LINUX_RANDOM_H


	)

11 
	~<löux/ty≥s.h
>

12 
	~<löux/io˘l.h
>

13 
	~<löux/úqƒ.h
>

18 
	#RNDGETENTCNT
 
	`_IOR
–'R', 0x00, )

	)

21 
	#RNDADDTOENTCNT
 
	`_IOW
–'R', 0x01, )

	)

24 
	#RNDGETPOOL
 
	`_IOR
–'R', 0x02, [2] )

	)

30 
	#RNDADDENTROPY
 
	`_IOW
–'R', 0x03, [2] )

	)

33 
	#RNDZAPENTCNT
 
	`_IO
–'R', 0x04 )

	)

36 
	#RNDCLEARPOOL
 
	`_IO
–'R', 0x06 )

	)

39 
	#RNDRESEEDCRNG
 
	`_IO
–'R', 0x07 )

	)

41 
	sønd_poﬁ_öfo
 {

42 
	míå›y_cou¡
;

43 
	mbuf_size
;

44 
__u32
 
	mbuf
[0];

53 
	#GRND_NONBLOCK
 0x0001

	)

54 
	#GRND_RANDOM
 0x0002

	)

	@/usr/include/linux/sched.h

2 #i‚de‡
_LINUX_SCHED_H


3 
	#_LINUX_SCHED_H


	)

5 
	~<löux/ty≥s.h
>

10 
	#CSIGNAL
 0x000000f‡

	)

11 
	#CLONE_VM
 0x00000100

	)

12 
	#CLONE_FS
 0x00000200

	)

13 
	#CLONE_FILES
 0x00000400

	)

14 
	#CLONE_SIGHAND
 0x00000800

	)

15 
	#CLONE_PIDFD
 0x00001000

	)

16 
	#CLONE_PTRACE
 0x00002000

	)

17 
	#CLONE_VFORK
 0x00004000

	)

18 
	#CLONE_PARENT
 0x00008000

	)

19 
	#CLONE_THREAD
 0x00010000

	)

20 
	#CLONE_NEWNS
 0x00020000

	)

21 
	#CLONE_SYSVSEM
 0x00040000

	)

22 
	#CLONE_SETTLS
 0x00080000

	)

23 
	#CLONE_PARENT_SETTID
 0x00100000

	)

24 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

25 
	#CLONE_DETACHED
 0x00400000

	)

26 
	#CLONE_UNTRACED
 0x00800000

	)

27 
	#CLONE_CHILD_SETTID
 0x01000000

	)

28 
	#CLONE_NEWCGROUP
 0x02000000

	)

29 
	#CLONE_NEWUTS
 0x04000000

	)

30 
	#CLONE_NEWIPC
 0x08000000

	)

31 
	#CLONE_NEWUSER
 0x10000000

	)

32 
	#CLONE_NEWPID
 0x20000000

	)

33 
	#CLONE_NEWNET
 0x40000000

	)

34 
	#CLONE_IO
 0x80000000

	)

36 #i‚de‡
__ASSEMBLY__


66 
	s˛⁄e_¨gs
 {

67 
__Æig√d_u64
 
	mÊags
;

68 
__Æig√d_u64
 
	mpidfd
;

69 
__Æig√d_u64
 
	mchûd_tid
;

70 
__Æig√d_u64
 
	m∑ª¡_tid
;

71 
__Æig√d_u64
 
	mexô_sig«l
;

72 
__Æig√d_u64
 
	m°ack
;

73 
__Æig√d_u64
 
	m°ack_size
;

74 
__Æig√d_u64
 
	més
;

78 
	#CLONE_ARGS_SIZE_VER0
 64

	)

83 
	#SCHED_NORMAL
 0

	)

84 
	#SCHED_FIFO
 1

	)

85 
	#SCHED_RR
 2

	)

86 
	#SCHED_BATCH
 3

	)

88 
	#SCHED_IDLE
 5

	)

89 
	#SCHED_DEADLINE
 6

	)

92 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

97 
	#SCHED_FLAG_RESET_ON_FORK
 0x01

	)

98 
	#SCHED_FLAG_RECLAIM
 0x02

	)

99 
	#SCHED_FLAG_DL_OVERRUN
 0x04

	)

100 
	#SCHED_FLAG_KEEP_POLICY
 0x08

	)

101 
	#SCHED_FLAG_KEEP_PARAMS
 0x10

	)

102 
	#SCHED_FLAG_UTIL_CLAMP_MIN
 0x20

	)

103 
	#SCHED_FLAG_UTIL_CLAMP_MAX
 0x40

	)

105 
	#SCHED_FLAG_KEEP_ALL
 (
SCHED_FLAG_KEEP_POLICY
 | \

106 
SCHED_FLAG_KEEP_PARAMS
)

	)

108 
	#SCHED_FLAG_UTIL_CLAMP
 (
SCHED_FLAG_UTIL_CLAMP_MIN
 | \

109 
SCHED_FLAG_UTIL_CLAMP_MAX
)

	)

111 
	#SCHED_FLAG_ALL
 (
SCHED_FLAG_RESET_ON_FORK
 | \

112 
SCHED_FLAG_RECLAIM
 | \

113 
SCHED_FLAG_DL_OVERRUN
 | \

114 
SCHED_FLAG_KEEP_ALL
 | \

115 
SCHED_FLAG_UTIL_CLAMP
)

	)

	@/usr/include/linux/stat.h

2 #i‚de‡
_LINUX_STAT_H


3 
	#_LINUX_STAT_H


	)

5 
	~<löux/ty≥s.h
>

7 #i‡
deföed
(
__KERNEL__
Ë|| !deföed(
__GLIBC__
) || (__GLIBC__ < 2)

9 
	#S_IFMT
 00170000

	)

10 
	#S_IFSOCK
 0140000

	)

11 
	#S_IFLNK
 0120000

	)

12 
	#S_IFREG
 0100000

	)

13 
	#S_IFBLK
 0060000

	)

14 
	#S_IFDIR
 0040000

	)

15 
	#S_IFCHR
 0020000

	)

16 
	#S_IFIFO
 0010000

	)

17 
	#S_ISUID
 0004000

	)

18 
	#S_ISGID
 0002000

	)

19 
	#S_ISVTX
 0001000

	)

21 
	#S_ISLNK
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFLNK
)

	)

22 
	#S_ISREG
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFREG
)

	)

23 
	#S_ISDIR
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFDIR
)

	)

24 
	#S_ISCHR
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFCHR
)

	)

25 
	#S_ISBLK
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFBLK
)

	)

26 
	#S_ISFIFO
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFIFO
)

	)

27 
	#S_ISSOCK
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFSOCK
)

	)

29 
	#S_IRWXU
 00700

	)

30 
	#S_IRUSR
 00400

	)

31 
	#S_IWUSR
 00200

	)

32 
	#S_IXUSR
 00100

	)

34 
	#S_IRWXG
 00070

	)

35 
	#S_IRGRP
 00040

	)

36 
	#S_IWGRP
 00020

	)

37 
	#S_IXGRP
 00010

	)

39 
	#S_IRWXO
 00007

	)

40 
	#S_IROTH
 00004

	)

41 
	#S_IWOTH
 00002

	)

42 
	#S_IXOTH
 00001

	)

56 
	s°©x_time°amp
 {

57 
__s64
 
	mtv_£c
;

58 
__u32
 
	mtv_n£c
;

59 
__s32
 
	m__ª£rved
;

99 
	s°©x
 {

101 
__u32
 
	m°x_mask
;

102 
__u32
 
	m°x_blksize
;

103 
__u64
 
	m°x_©åibuãs
;

105 
__u32
 
	m°x_∆ök
;

106 
__u32
 
	m°x_uid
;

107 
__u32
 
	m°x_gid
;

108 
__u16
 
	m°x_mode
;

109 
__u16
 
	m__•¨e0
[1];

111 
__u64
 
	m°x_öo
;

112 
__u64
 
	m°x_size
;

113 
__u64
 
	m°x_blocks
;

114 
__u64
 
	m°x_©åibuãs_mask
;

116 
°©x_time°amp
 
	m°x_©ime
;

117 
°©x_time°amp
 
	m°x_btime
;

118 
°©x_time°amp
 
	m°x_˘ime
;

119 
°©x_time°amp
 
	m°x_mtime
;

121 
__u32
 
	m°x_rdev_maj‹
;

122 
__u32
 
	m°x_rdev_mö‹
;

123 
__u32
 
	m°x_dev_maj‹
;

124 
__u32
 
	m°x_dev_mö‹
;

126 
__u64
 
	m__•¨e2
[14];

138 
	#STATX_TYPE
 0x00000001U

	)

139 
	#STATX_MODE
 0x00000002U

	)

140 
	#STATX_NLINK
 0x00000004U

	)

141 
	#STATX_UID
 0x00000008U

	)

142 
	#STATX_GID
 0x00000010U

	)

143 
	#STATX_ATIME
 0x00000020U

	)

144 
	#STATX_MTIME
 0x00000040U

	)

145 
	#STATX_CTIME
 0x00000080U

	)

146 
	#STATX_INO
 0x00000100U

	)

147 
	#STATX_SIZE
 0x00000200U

	)

148 
	#STATX_BLOCKS
 0x00000400U

	)

149 
	#STATX_BASIC_STATS
 0x000007ffU

	)

150 
	#STATX_BTIME
 0x00000800U

	)

151 
	#STATX_ALL
 0x00000fffU

	)

152 
	#STATX__RESERVED
 0x80000000U

	)

165 
	#STATX_ATTR_COMPRESSED
 0x00000004

	)

166 
	#STATX_ATTR_IMMUTABLE
 0x00000010

	)

167 
	#STATX_ATTR_APPEND
 0x00000020

	)

168 
	#STATX_ATTR_NODUMP
 0x00000040

	)

169 
	#STATX_ATTR_ENCRYPTED
 0x00000800

	)

171 
	#STATX_ATTR_AUTOMOUNT
 0x00001000

	)

	@/usr/include/linux/string.h

2 #i‚de‡
_LINUX_STRING_H_


3 
	#_LINUX_STRING_H_


	)

7 
	~<°rög.h
>

	@/usr/include/linux/time.h

2 #i‚de‡
_LINUX_TIME_H


3 
	#_LINUX_TIME_H


	)

5 
	~<löux/ty≥s.h
>

6 
	~<löux/time_ty≥s.h
>

8 #i‚de‡
_STRUCT_TIMESPEC


9 
	#_STRUCT_TIMESPEC


	)

10 
	stime•ec
 {

11 
__kî√l_time_t
 
	mtv_£c
;

12 
	mtv_n£c
;

16 
	stimevÆ
 {

17 
__kî√l_time_t
 
	mtv_£c
;

18 
__kî√l_su£c⁄ds_t
 
	mtv_u£c
;

21 
	stimez⁄e
 {

22 
	mtz_möuãswe°
;

23 
	mtz_d°time
;

30 
	#ITIMER_REAL
 0

	)

31 
	#ITIMER_VIRTUAL
 1

	)

32 
	#ITIMER_PROF
 2

	)

34 
	sôimî•ec
 {

35 
time•ec
 
	mô_öãrvÆ
;

36 
time•ec
 
	mô_vÆue
;

39 
	sôimîvÆ
 {

40 
timevÆ
 
	mô_öãrvÆ
;

41 
timevÆ
 
	mô_vÆue
;

47 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

49 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

50 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

51 
	#CLOCK_MONOTONIC_RAW
 4

	)

52 
	#CLOCK_REALTIME_COARSE
 5

	)

53 
	#CLOCK_MONOTONIC_COARSE
 6

	)

54 
	#CLOCK_BOOTTIME
 7

	)

55 
	#CLOCK_REALTIME_ALARM
 8

	)

56 
	#CLOCK_BOOTTIME_ALARM
 9

	)

61 
	#CLOCK_SGI_CYCLE
 10

	)

62 
	#CLOCK_TAI
 11

	)

64 
	#MAX_CLOCKS
 16

	)

65 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

66 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

71 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/types.h

2 #i‚de‡
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty≥s.h
>

7 #i‚de‡
__ASSEMBLY__


9 
	~<löux/posix_ty≥s.h
>

17 #ifde‡
__CHECKER__


18 
	#__bôwi£__
 
	`__©åibuã__
((
bôwi£
))

	)

20 
	#__bôwi£__


	)

22 
	#__bôwi£
 
__bôwi£__


	)

24 
__u16
 
	t__bôwi£
 
	t__À16
;

25 
__u16
 
	t__bôwi£
 
	t__be16
;

26 
__u32
 
	t__bôwi£
 
	t__À32
;

27 
__u32
 
	t__bôwi£
 
	t__be32
;

28 
__u64
 
	t__bôwi£
 
	t__À64
;

29 
__u64
 
	t__bôwi£
 
	t__be64
;

31 
__u16
 
	t__bôwi£
 
	t__sum16
;

32 
__u32
 
	t__bôwi£
 
	t__wsum
;

43 
	#__Æig√d_u64
 
__u64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

44 
	#__Æig√d_be64
 
__be64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

45 
	#__Æig√d_À64
 
__À64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

47 
	t__bôwi£
 
	t__pﬁl_t
;

	@/usr/include/linux/uio.h

10 #i‚de‡
__LINUX_UIO_H


11 
	#__LINUX_UIO_H


	)

14 
	~<löux/ty≥s.h
>

17 
	siovec


19 *
	miov_ba£
;

20 
__kî√l_size_t
 
	miov_Àn
;

27 
	#UIO_FASTIOV
 8

	)

28 
	#UIO_MAXIOV
 1024

	)

	@/usr/include/linux/utsname.h

2 #i‚de‡
_LINUX_UTSNAME_H


3 
	#_LINUX_UTSNAME_H


	)

5 
	#__OLD_UTS_LEN
 8

	)

7 
	sﬁdﬁd_ut¢ame
 {

8 
	msy¢ame
[9];

9 
	mnodíame
[9];

10 
	mªÀa£
[9];

11 
	mvîsi⁄
[9];

12 
	mmachöe
[9];

15 
	#__NEW_UTS_LEN
 64

	)

17 
	sﬁd_ut¢ame
 {

18 
	msy¢ame
[65];

19 
	mnodíame
[65];

20 
	mªÀa£
[65];

21 
	mvîsi⁄
[65];

22 
	mmachöe
[65];

25 
	s√w_ut¢ame
 {

26 
	msy¢ame
[
__NEW_UTS_LEN
 + 1];

27 
	mnodíame
[
__NEW_UTS_LEN
 + 1];

28 
	mªÀa£
[
__NEW_UTS_LEN
 + 1];

29 
	mvîsi⁄
[
__NEW_UTS_LEN
 + 1];

30 
	mmachöe
[
__NEW_UTS_LEN
 + 1];

31 
	mdomaö«me
[
__NEW_UTS_LEN
 + 1];

	@/usr/include/linux/uuid.h

18 #i‚de‡
_LINUX_UUID_H_


19 
	#_LINUX_UUID_H_


	)

21 
	~<löux/ty≥s.h
>

24 
__u8
 
	mb
[16];

25 } 
	tguid_t
;

27 
	#GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

28 ((
guid_t
) \

29 {{ (
a
) & 0xff, ((a) >> 8) & 0xff, ((a) >> 16) & 0xff, ((a) >> 24) & 0xff, \

30 (
b
) & 0xff, ((b) >> 8) & 0xff, \

31 (
c
) & 0xff, ((c) >> 8) & 0xff, \

32 (
d0
), (
d1
), (
d2
), (
d3
), (
d4
), (
d5
), (
d6
), (
d7
Ë}})

	)

35 
guid_t
 
	tuuid_À
;

36 
	#UUID_LE
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

37 
	`GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
)

	)

38 
	#NULL_UUID_LE
 \

39 
	`UUID_LE
(0x00000000, 0x0000, 0x0000, 0x00, 0x00, 0x00, 0x00, \

40 0x00, 0x00, 0x00, 0x00)

	)

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 328769

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
Ë((◊Ë<< 16Ë+ ((bË<< 8Ë+ (c))

	)

	@/usr/include/linux/wait.h

2 #i‚de‡
_LINUX_WAIT_H


3 
	#_LINUX_WAIT_H


	)

5 
	#WNOHANG
 0x00000001

	)

6 
	#WUNTRACED
 0x00000002

	)

7 
	#WSTOPPED
 
WUNTRACED


	)

8 
	#WEXITED
 0x00000004

	)

9 
	#WCONTINUED
 0x00000008

	)

10 
	#WNOWAIT
 0x01000000

	)

12 
	#__WNOTHREAD
 0x20000000

	)

13 
	#__WALL
 0x40000000

	)

14 
	#__WCLONE
 0x80000000

	)

17 
	#P_ALL
 0

	)

18 
	#P_PID
 1

	)

19 
	#P_PGID
 2

	)

20 
	#P_PIDFD
 3

	)

	@/usr/include/linux/xattr.h

12 
	~<löux/libc-com∑t.h
>

14 #i‚de‡
_LINUX_XATTR_H


15 
	#_LINUX_XATTR_H


	)

17 #i‡
__UAPI_DEF_XATTR


18 
	#__USE_KERNEL_XATTR_DEFS


	)

20 
	#XATTR_CREATE
 0x1

	)

21 
	#XATTR_REPLACE
 0x2

	)

25 
	#XATTR_OS2_PREFIX
 "os2."

	)

26 
	#XATTR_OS2_PREFIX_LEN
 ((
XATTR_OS2_PREFIX
Ë- 1)

	)

28 
	#XATTR_MAC_OSX_PREFIX
 "osx."

	)

29 
	#XATTR_MAC_OSX_PREFIX_LEN
 ((
XATTR_MAC_OSX_PREFIX
Ë- 1)

	)

31 
	#XATTR_BTRFS_PREFIX
 "båfs."

	)

32 
	#XATTR_BTRFS_PREFIX_LEN
 ((
XATTR_BTRFS_PREFIX
Ë- 1)

	)

34 
	#XATTR_SECURITY_PREFIX
 "£curôy."

	)

35 
	#XATTR_SECURITY_PREFIX_LEN
 ((
XATTR_SECURITY_PREFIX
Ë- 1)

	)

37 
	#XATTR_SYSTEM_PREFIX
 "sy°em."

	)

38 
	#XATTR_SYSTEM_PREFIX_LEN
 ((
XATTR_SYSTEM_PREFIX
Ë- 1)

	)

40 
	#XATTR_TRUSTED_PREFIX
 "åu°ed."

	)

41 
	#XATTR_TRUSTED_PREFIX_LEN
 ((
XATTR_TRUSTED_PREFIX
Ë- 1)

	)

43 
	#XATTR_USER_PREFIX
 "u£r."

	)

44 
	#XATTR_USER_PREFIX_LEN
 ((
XATTR_USER_PREFIX
Ë- 1)

	)

47 
	#XATTR_EVM_SUFFIX
 "evm"

	)

48 
	#XATTR_NAME_EVM
 
XATTR_SECURITY_PREFIX
 
XATTR_EVM_SUFFIX


	)

50 
	#XATTR_IMA_SUFFIX
 "ima"

	)

51 
	#XATTR_NAME_IMA
 
XATTR_SECURITY_PREFIX
 
XATTR_IMA_SUFFIX


	)

53 
	#XATTR_SELINUX_SUFFIX
 "£löux"

	)

54 
	#XATTR_NAME_SELINUX
 
XATTR_SECURITY_PREFIX
 
XATTR_SELINUX_SUFFIX


	)

56 
	#XATTR_SMACK_SUFFIX
 "SMACK64"

	)

57 
	#XATTR_SMACK_IPIN
 "SMACK64IPIN"

	)

58 
	#XATTR_SMACK_IPOUT
 "SMACK64IPOUT"

	)

59 
	#XATTR_SMACK_EXEC
 "SMACK64EXEC"

	)

60 
	#XATTR_SMACK_TRANSMUTE
 "SMACK64TRANSMUTE"

	)

61 
	#XATTR_SMACK_MMAP
 "SMACK64MMAP"

	)

62 
	#XATTR_NAME_SMACK
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_SUFFIX


	)

63 
	#XATTR_NAME_SMACKIPIN
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPIN


	)

64 
	#XATTR_NAME_SMACKIPOUT
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPOUT


	)

65 
	#XATTR_NAME_SMACKEXEC
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_EXEC


	)

66 
	#XATTR_NAME_SMACKTRANSMUTE
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_TRANSMUTE


	)

67 
	#XATTR_NAME_SMACKMMAP
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_MMAP


	)

69 
	#XATTR_APPARMOR_SUFFIX
 "≠∑rm‹"

	)

70 
	#XATTR_NAME_APPARMOR
 
XATTR_SECURITY_PREFIX
 
XATTR_APPARMOR_SUFFIX


	)

72 
	#XATTR_CAPS_SUFFIX
 "ˇ∑bûôy"

	)

73 
	#XATTR_NAME_CAPS
 
XATTR_SECURITY_PREFIX
 
XATTR_CAPS_SUFFIX


	)

75 
	#XATTR_POSIX_ACL_ACCESS
 "posix_a˛_ac˚ss"

	)

76 
	#XATTR_NAME_POSIX_ACL_ACCESS
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_ACCESS


	)

77 
	#XATTR_POSIX_ACL_DEFAULT
 "posix_a˛_deÁu…"

	)

78 
	#XATTR_NAME_POSIX_ACL_DEFAULT
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_DEFAULT


	)

	@/usr/include/asm-generic/hugetlb_encode.h

1 #i‚de‡
_ASM_GENERIC_HUGETLB_ENCODE_H_


2 
	#_ASM_GENERIC_HUGETLB_ENCODE_H_


	)

20 
	#HUGETLB_FLAG_ENCODE_SHIFT
 26

	)

21 
	#HUGETLB_FLAG_ENCODE_MASK
 0x3f

	)

23 
	#HUGETLB_FLAG_ENCODE_64KB
 (16 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

24 
	#HUGETLB_FLAG_ENCODE_512KB
 (19 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

25 
	#HUGETLB_FLAG_ENCODE_1MB
 (20 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

26 
	#HUGETLB_FLAG_ENCODE_2MB
 (21 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

27 
	#HUGETLB_FLAG_ENCODE_8MB
 (23 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

28 
	#HUGETLB_FLAG_ENCODE_16MB
 (24 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

29 
	#HUGETLB_FLAG_ENCODE_32MB
 (25 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

30 
	#HUGETLB_FLAG_ENCODE_256MB
 (28 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

31 
	#HUGETLB_FLAG_ENCODE_512MB
 (29 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

32 
	#HUGETLB_FLAG_ENCODE_1GB
 (30 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

33 
	#HUGETLB_FLAG_ENCODE_2GB
 (31 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

34 
	#HUGETLB_FLAG_ENCODE_16GB
 (34 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

	@/usr/include/linux/ioctl.h

2 #i‚de‡
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/io˘l.h
>

	@/usr/include/linux/irqnr.h

	@/usr/include/linux/libc-compat.h

49 #i‚de‡
_LIBC_COMPAT_H


50 
	#_LIBC_COMPAT_H


	)

53 #i‡
deföed
(
__GLIBC__
)

56 #i‡
deföed
(
_NET_IF_H
Ë&& deföed(
__USE_MISC
)

61 
	#__UAPI_DEF_IF_IFCONF
 0

	)

62 
	#__UAPI_DEF_IF_IFMAP
 0

	)

63 
	#__UAPI_DEF_IF_IFNAMSIZ
 0

	)

64 
	#__UAPI_DEF_IF_IFREQ
 0

	)

66 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 0

	)

68 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


69 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

78 
	#__UAPI_DEF_IF_IFCONF
 1

	)

79 
	#__UAPI_DEF_IF_IFMAP
 1

	)

80 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

81 
	#__UAPI_DEF_IF_IFREQ
 1

	)

83 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

85 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

90 #i‡
deföed
(
_NETINET_IN_H
)

94 
	#__UAPI_DEF_IN_ADDR
 0

	)

95 
	#__UAPI_DEF_IN_IPPROTO
 0

	)

96 
	#__UAPI_DEF_IN_PKTINFO
 0

	)

97 
	#__UAPI_DEF_IP_MREQ
 0

	)

98 
	#__UAPI_DEF_SOCKADDR_IN
 0

	)

99 
	#__UAPI_DEF_IN_CLASS
 0

	)

101 
	#__UAPI_DEF_IN6_ADDR
 0

	)

106 #i‡
deföed
(
__USE_MISC
Ë|| deföed (
__USE_GNU
)

107 
	#__UAPI_DEF_IN6_ADDR_ALT
 0

	)

109 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

111 
	#__UAPI_DEF_SOCKADDR_IN6
 0

	)

112 
	#__UAPI_DEF_IPV6_MREQ
 0

	)

113 
	#__UAPI_DEF_IPPROTO_V6
 0

	)

114 
	#__UAPI_DEF_IPV6_OPTIONS
 0

	)

115 
	#__UAPI_DEF_IN6_PKTINFO
 0

	)

116 
	#__UAPI_DEF_IP6_MTUINFO
 0

	)

123 
	#__UAPI_DEF_IN_ADDR
 1

	)

124 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

125 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

126 
	#__UAPI_DEF_IP_MREQ
 1

	)

127 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

128 
	#__UAPI_DEF_IN_CLASS
 1

	)

130 
	#__UAPI_DEF_IN6_ADDR
 1

	)

133 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

134 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

135 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

136 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

137 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

138 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

139 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

144 #i‡
deföed
(
__NETIPX_IPX_H
)

146 
	#__UAPI_DEF_SOCKADDR_IPX
 0

	)

147 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 0

	)

148 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 0

	)

149 
	#__UAPI_DEF_IPX_CONFIG_DATA
 0

	)

150 
	#__UAPI_DEF_IPX_ROUTE_DEF
 0

	)

154 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

155 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

156 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

157 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

158 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

163 #i‡
deföed
(
_SYS_XATTR_H
)

164 
	#__UAPI_DEF_XATTR
 0

	)

166 
	#__UAPI_DEF_XATTR
 1

	)

176 #i‚de‡
__UAPI_DEF_IF_IFCONF


177 
	#__UAPI_DEF_IF_IFCONF
 1

	)

179 #i‚de‡
__UAPI_DEF_IF_IFMAP


180 
	#__UAPI_DEF_IF_IFMAP
 1

	)

182 #i‚de‡
__UAPI_DEF_IF_IFNAMSIZ


183 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

185 #i‚de‡
__UAPI_DEF_IF_IFREQ


186 
	#__UAPI_DEF_IF_IFREQ
 1

	)

189 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS


190 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

193 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


194 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

198 #i‚de‡
__UAPI_DEF_IN_ADDR


199 
	#__UAPI_DEF_IN_ADDR
 1

	)

201 #i‚de‡
__UAPI_DEF_IN_IPPROTO


202 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

204 #i‚de‡
__UAPI_DEF_IN_PKTINFO


205 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

207 #i‚de‡
__UAPI_DEF_IP_MREQ


208 
	#__UAPI_DEF_IP_MREQ
 1

	)

210 #i‚de‡
__UAPI_DEF_SOCKADDR_IN


211 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

213 #i‚de‡
__UAPI_DEF_IN_CLASS


214 
	#__UAPI_DEF_IN_CLASS
 1

	)

218 #i‚de‡
__UAPI_DEF_IN6_ADDR


219 
	#__UAPI_DEF_IN6_ADDR
 1

	)

221 #i‚de‡
__UAPI_DEF_IN6_ADDR_ALT


222 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

224 #i‚de‡
__UAPI_DEF_SOCKADDR_IN6


225 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

227 #i‚de‡
__UAPI_DEF_IPV6_MREQ


228 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

230 #i‚de‡
__UAPI_DEF_IPPROTO_V6


231 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

233 #i‚de‡
__UAPI_DEF_IPV6_OPTIONS


234 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

236 #i‚de‡
__UAPI_DEF_IN6_PKTINFO


237 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

239 #i‚de‡
__UAPI_DEF_IP6_MTUINFO


240 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

244 #i‚de‡
__UAPI_DEF_SOCKADDR_IPX


245 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

247 #i‚de‡
__UAPI_DEF_IPX_ROUTE_DEFINITION


248 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

250 #i‚de‡
__UAPI_DEF_IPX_INTERFACE_DEFINITION


251 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

253 #i‚de‡
__UAPI_DEF_IPX_CONFIG_DATA


254 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

256 #i‚de‡
__UAPI_DEF_IPX_ROUTE_DEF


257 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

261 #i‚de‡
__UAPI_DEF_XATTR


262 
	#__UAPI_DEF_XATTR
 1

	)

	@/usr/include/linux/limits.h

2 #i‚de‡
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/posix_types.h

2 #i‚de‡
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<löux/°ddef.h
>

22 #unde‡
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_bôs
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__kî√l_fd_£t
;

30 (*
	t__kî√l_sigh™dÀr_t
)();

33 
	t__kî√l_key_t
;

34 
	t__kî√l_mqd_t
;

36 
	~<asm/posix_ty≥s.h
>

	@/usr/include/linux/sysinfo.h

2 #i‚de‡
_LINUX_SYSINFO_H


3 
	#_LINUX_SYSINFO_H


	)

5 
	~<löux/ty≥s.h
>

7 
	#SI_LOAD_SHIFT
 16

	)

8 
	ssysöfo
 {

9 
__kî√l_l⁄g_t
 
	mu±ime
;

10 
__kî√l_ul⁄g_t
 
	mlﬂds
[3];

11 
__kî√l_ul⁄g_t
 
	mtŸÆøm
;

12 
__kî√l_ul⁄g_t
 
	m‰ìøm
;

13 
__kî√l_ul⁄g_t
 
	msh¨edøm
;

14 
__kî√l_ul⁄g_t
 
	mbuf„ºam
;

15 
__kî√l_ul⁄g_t
 
	mtŸÆsw≠
;

16 
__kî√l_ul⁄g_t
 
	m‰ìsw≠
;

17 
__u16
 
	m¥ocs
;

18 
__u16
 
	m∑d
;

19 
__kî√l_ul⁄g_t
 
	mtŸÆhigh
;

20 
__kî√l_ul⁄g_t
 
	m‰ìhigh
;

21 
__u32
 
	mmem_unô
;

22 
	m_f
[20-2*(
__kî√l_ul⁄g_t
)-(
__u32
)];

	@/usr/include/linux/time_types.h

2 #i‚de‡
_LINUX_TIME_TYPES_H


3 
	#_LINUX_TIME_TYPES_H


	)

5 
	~<löux/ty≥s.h
>

7 
	s__kî√l_time•ec
 {

8 
__kî√l_time64_t
 
	mtv_£c
;

9 
	mtv_n£c
;

12 
	s__kî√l_ôimî•ec
 {

13 
__kî√l_time•ec
 
	mô_öãrvÆ
;

14 
__kî√l_time•ec
 
	mô_vÆue
;

24 #i‚de‡
__kî√l_ﬁd_timevÆ


25 
	s__kî√l_ﬁd_timevÆ
 {

26 
__kî√l_l⁄g_t
 
	mtv_£c
;

27 
__kî√l_l⁄g_t
 
	mtv_u£c
;

31 
	s__kî√l_sock_timevÆ
 {

32 
__s64
 
	mtv_£c
;

33 
__s64
 
	mtv_u£c
;

	@/usr/include/string.h

22 #i‚def 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<bôs/libc-hódî-°¨t.h
>

28 
	g__BEGIN_DECLS


31 
	#__√ed_size_t


	)

32 
	#__√ed_NULL


	)

33 
	~<°ddef.h
>

36 #i‡
deföed
 
__˝lu•lus
 && (
__GNUC_PREREQ
 (4, 4) \

37 || 
	$__glibc_˛™g_¥îeq
 (3, 5))

38 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

43 *
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

44 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

47 *
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

48 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

53 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN
 || 
	`__GLIBC_USE
 (
ISOC2X
)

54 *
	$memc˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

61 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

64 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

65 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

68 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


71 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

72 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

73 c⁄° *
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

74 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

76 #ifde‡
__OPTIMIZE__


77 
__exã∫_Æways_ölöe
 *

78 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


80  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

83 
__exã∫_Æways_ölöe
 const *

84 
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


86  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

89 
	}
}

91 *
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

92 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

95 #ifde‡
__USE_GNU


98 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


99 "C++" *
	$øwmemchr
 (*
__s
, 
__c
)

100 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

101 "C++" c⁄° *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

102 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

104 *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

105 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

109 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


110 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

111 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

112 "C++" c⁄° *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

113 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

115 *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

116 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

122 *
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

123 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

125 *
	$°∫˝y
 (*
__ª°ri˘
 
__de°
,

126 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

127 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

130 *
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

131 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

133 *
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

134 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

137 
	$°rcmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

138 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

140 
	$°∫cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

141 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

144 
	$°rcﬁl
 (c⁄° *
__s1
, c⁄° *
__s2
)

145 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

147 
size_t
 
	$°rx‰m
 (*
__ª°ri˘
 
__de°
,

148 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

149 
__THROW
 
	`__n⁄nuŒ
 ((2));

151 #ifde‡
__USE_XOPEN2K8


153 
	~<bôs/ty≥s/loˇÀ_t.h
>

156 
	$°rcﬁl_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
loˇÀ_t
 
__l
)

157 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

160 
size_t
 
	$°rx‰m_l
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

161 
loˇÀ_t
 
__l
Ë
__THROW
 
	`__n⁄nuŒ
 ((2, 4));

164 #i‡(
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_XOPEN2K8
 \

165 || 
	`__GLIBC_USE
 (
LIB_PXT2
Ë|| 
	$__GLIBC_USE
 (
ISOC2X
))

167 *
	$°rdup
 (c⁄° *
__s
)

168 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

174 #i‡
deföed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_PXT2
Ë|| __GLIBC_USE (
ISOC2X
)

175 *
	$°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

176 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

179 #i‡
deföed
 
__USE_GNU
 && deföed 
__GNUC__


181 
	#°rdu∑
(
s
) \

182 (
__exãnsi⁄__
 \

184 c⁄° *
__ﬁd
 = (
s
); \

185 
size_t
 
__Àn
 = 
	`°æí
 (
__ﬁd
) + 1; \

186 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
); \

187 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

188 
	}
}))

	)

191 
	#°∫du∑
(
s
, 
n
) \

192 (
__exãnsi⁄__
 \

194 c⁄° *
__ﬁd
 = (
s
); \

195 
size_t
 
__Àn
 = 
	`°∫Àn
 (
__ﬁd
, (
n
)); \

196 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
 + 1); \

197 
__√w
[
__Àn
] = '\0'; \

198 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

199 }))

	)

203 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


206 *
°rchr
 (*
__s
, 
__c
)

207 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

208 c⁄° *
°rchr
 (c⁄° *
__s
, 
__c
)

209 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

211 #ifde‡
__OPTIMIZE__


212 
__exã∫_Æways_ölöe
 *

213 
°rchr
 (*
__s
, 
__c
Ë
	g__THROW


215  
__buûtö_°rchr
 (
__s
, 
__c
);

218 
__exã∫_Æways_ölöe
 const *

219 
°rchr
 (c⁄° *
__s
, 
__c
Ë
	g__THROW


221  
__buûtö_°rchr
 (
__s
, 
__c
);

226 *
	$°rchr
 (c⁄° *
__s
, 
__c
)

227 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

230 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


233 *
	`°ºchr
 (*
__s
, 
__c
)

234 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

235 c⁄° *
	`°ºchr
 (c⁄° *
__s
, 
__c
)

236 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

238 #ifde‡
__OPTIMIZE__


239 
__exã∫_Æways_ölöe
 *

240 
	`°ºchr
 (*
__s
, 
__c
Ë
__THROW


242  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

245 
__exã∫_Æways_ölöe
 const *

246 
	`°ºchr
 (c⁄° *
__s
, 
__c
Ë
__THROW


248  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

251 
	}
}

253 *
	$°ºchr
 (c⁄° *
__s
, 
__c
)

254 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

257 #ifde‡
__USE_GNU


260 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


261 "C++" *
	$°rch∫ul
 (*
__s
, 
__c
)

262 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

263 "C++" c⁄° *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

264 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

266 *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

267 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

273 
size_t
 
	$°rc•n
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

274 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

277 
size_t
 
	$°r•n
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

278 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

280 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


283 *
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
)

284 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

285 c⁄° *
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

286 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

288 #ifde‡
__OPTIMIZE__


289 
__exã∫_Æways_ölöe
 *

290 
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
Ë
__THROW


292  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

295 
__exã∫_Æways_ölöe
 const *

296 
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
Ë
__THROW


298  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

301 
	}
}

303 *
	$°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

304 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

307 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


310 *
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

311 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

312 c⁄° *
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

313 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

315 #ifde‡
__OPTIMIZE__


316 
__exã∫_Æways_ölöe
 *

317 
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


319  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

322 
__exã∫_Æways_ölöe
 const *

323 
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


325  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

328 
	}
}

330 *
	$°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

331 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

336 *
	$°πok
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
)

337 
__THROW
 
	`__n⁄nuŒ
 ((2));

341 *
	$__°πok_r
 (*
__ª°ri˘
 
__s
,

342 c⁄° *
__ª°ri˘
 
__dñim
,

343 **
__ª°ri˘
 
__ßve_±r
)

344 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

345 #ifde‡
__USE_POSIX


346 *
	$°πok_r
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
,

347 **
__ª°ri˘
 
__ßve_±r
)

348 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

351 #ifde‡
__USE_GNU


353 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


354 "C++" *
	$°rˇ£°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

355 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

356 "C++" c⁄° *
	$°rˇ£°r
 (c⁄° *
__hay°ack
,

357 c⁄° *
__√edÀ
)

358 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

360 *
	$°rˇ£°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

361 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

365 #ifde‡
__USE_GNU


369 *
	$memmem
 (c⁄° *
__hay°ack
, 
size_t
 
__hay°ackÀn
,

370 c⁄° *
__√edÀ
, 
size_t
 
__√edÀÀn
)

371 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 3));

375 *
	$__memp˝y
 (*
__ª°ri˘
 
__de°
,

376 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

377 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

378 *
	$memp˝y
 (*
__ª°ri˘
 
__de°
,

379 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

380 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

385 
size_t
 
	$°æí
 (c⁄° *
__s
)

386 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

388 #ifdef 
__USE_XOPEN2K8


391 
size_t
 
	$°∫Àn
 (c⁄° *
__°rög
, 
size_t
 
__maxÀn
)

392 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

397 *
	$°ªº‹
 (
__î∫um
Ë
__THROW
;

398 #ifde‡
__USE_XOPEN2K


406 #i‡
deföed
 
__USE_XOPEN2K
 && !deföed 
__USE_GNU


409 #ifde‡
__REDIRECT_NTH


410 
	`__REDIRECT_NTH
 (
°ªº‹_r
,

411 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
),

412 
__xpg_°ªº‹_r
Ë
	`__n⁄nuŒ
 ((2));

414 
	$__xpg_°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

415 
__THROW
 
	`__n⁄nuŒ
 ((2));

416 
	#°ªº‹_r
 
__xpg_°ªº‹_r


	)

421 *
	$°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

422 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
__wur
;

426 #ifde‡
__USE_XOPEN2K8


428 *
	$°ªº‹_l
 (
__î∫um
, 
loˇÀ_t
 
__l
Ë
__THROW
;

431 #ifde‡
__USE_MISC


432 
	~<°rögs.h
>

436 
	$ex∂icô_bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

440 *
	$°r£p
 (**
__ª°ri˘
 
__°rögp
,

441 c⁄° *
__ª°ri˘
 
__dñim
)

442 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

445 #ifdef 
__USE_XOPEN2K8


447 *
	$°rsig«l
 (
__sig
Ë
__THROW
;

450 *
	$__°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

451 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

452 *
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

453 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

457 *
	$__°≤˝y
 (*
__ª°ri˘
 
__de°
,

458 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

459 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

460 *
	$°≤˝y
 (*
__ª°ri˘
 
__de°
,

461 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

462 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

465 #ifdef 
__USE_GNU


467 
	$°rvîscmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

468 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

471 *
	$°r‰y
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

474 *
	$mem‰ob
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

476 #i‚de‡
ba£«me


481 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


482 "C++" *
	$ba£«me
 (*
__fûíame
)

483 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

484 "C++" c⁄° *
	$ba£«me
 (c⁄° *
__fûíame
)

485 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

487 *
	$ba£«me
 (c⁄° *
__fûíame
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

492 #i‡
	`__GNUC_PREREQ
 (3,4)

493 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


495 
	~<bôs/°rög_f‹tifõd.h
>

499 
__END_DECLS


	@/usr/include/linux/stddef.h

4 #i‚de‡
__Æways_ölöe


5 
	#__Æways_ölöe
 
__ölöe__


	)

	@/usr/include/strings.h

18 #i‚def 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

21 
	~<„©uªs.h
>

22 
	#__√ed_size_t


	)

23 
	~<°ddef.h
>

26 #i‡
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (4, 4)

27 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

30 
	g__BEGIN_DECLS


32 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8


34 
	$bcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

35 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

38 
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__n
)

39 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

42 
	$bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

45 #ifde‡
__CORRECT_ISO_CPP_STRINGS_H_PROTO


48 *
	`ödex
 (*
__s
, 
__c
)

49 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

50 c⁄° *
	`ödex
 (c⁄° *
__s
, 
__c
)

51 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

53 #i‡
deföed
 
__OPTIMIZE__


54 
__exã∫_Æways_ölöe
 *

55 
	`ödex
 (*
__s
, 
__c
Ë
__THROW


57  
	`__buûtö_ödex
 (
__s
, 
__c
);

60 
__exã∫_Æways_ölöe
 const *

61 
	`ödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


63  
	`__buûtö_ödex
 (
__s
, 
__c
);

66 
	}
}

68 *
	$ödex
 (c⁄° *
__s
, 
__c
)

69 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

73 #ifde‡
__CORRECT_ISO_CPP_STRINGS_H_PROTO


76 *
	`rödex
 (*
__s
, 
__c
)

77 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

78 c⁄° *
	`rödex
 (c⁄° *
__s
, 
__c
)

79 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

81 #i‡
deföed
 
__OPTIMIZE__


82 
__exã∫_Æways_ölöe
 *

83 
	`rödex
 (*
__s
, 
__c
Ë
__THROW


85  
	`__buûtö_rödex
 (
__s
, 
__c
);

88 
__exã∫_Æways_ölöe
 const *

89 
	`rödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


91  
	`__buûtö_rödex
 (
__s
, 
__c
);

94 
	}
}

96 *
	$rödex
 (c⁄° *
__s
, 
__c
)

97 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

101 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8
 || deföed 
__USE_XOPEN2K8XSI


104 
	$ffs
 (
__i
Ë
__THROW
 
__©åibuã_c⁄°__
;

109 #ifdef 
__USE_MISC


110 
	$ff¶
 (
__l
Ë
__THROW
 
__©åibuã_c⁄°__
;

111 
__exãnsi⁄__
 
	$ff¶l
 (
__Œ
)

112 
__THROW
 
__©åibuã_c⁄°__
;

116 
	$°rˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

117 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

120 
	$°∫ˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

121 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

123 #ifdef 
__USE_XOPEN2K8


125 
	~<bôs/ty≥s/loˇÀ_t.h
>

128 
	$°rˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
loˇÀ_t
 
__loc
)

129 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

133 
	$°∫ˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

134 
size_t
 
__n
, 
loˇÀ_t
 
__loc
)

135 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 4));

138 
__END_DECLS


140 #i‡
	`__GNUC_PREREQ
 (3,4Ë&& 
__USE_FORTIFY_LEVEL
 > 0 \

141 && 
deföed
 
__f‹tify_fun˘i⁄


143 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8


144 
	~<bôs/°rögs_f‹tifõd.h
>

	@/usr/include/features.h

18 #i‚def 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

120 #unde‡
__USE_ISOC11


121 #unde‡
__USE_ISOC99


122 #unde‡
__USE_ISOC95


123 #unde‡
__USE_ISOCXX11


124 #unde‡
__USE_POSIX


125 #unde‡
__USE_POSIX2


126 #unde‡
__USE_POSIX199309


127 #unde‡
__USE_POSIX199506


128 #unde‡
__USE_XOPEN


129 #unde‡
__USE_XOPEN_EXTENDED


130 #unde‡
__USE_UNIX98


131 #unde‡
__USE_XOPEN2K


132 #unde‡
__USE_XOPEN2KXSI


133 #unde‡
__USE_XOPEN2K8


134 #unde‡
__USE_XOPEN2K8XSI


135 #unde‡
__USE_LARGEFILE


136 #unde‡
__USE_LARGEFILE64


137 #unde‡
__USE_FILE_OFFSET64


138 #unde‡
__USE_MISC


139 #unde‡
__USE_ATFILE


140 #unde‡
__USE_GNU


141 #unde‡
__USE_FORTIFY_LEVEL


142 #unde‡
__KERNEL_STRICT_NAMES


143 #unde‡
__GLIBC_USE_ISOC2X


144 #unde‡
__GLIBC_USE_DEPRECATED_GETS


145 #unde‡
__GLIBC_USE_DEPRECATED_SCANF


149 #i‚de‡
_LOOSE_KERNEL_NAMES


150 
	#__KERNEL_STRICT_NAMES


	)

160 #i‡
deföed
 
__GNUC__
 && deföed 
__GNUC_MINOR__


161 
	#__GNUC_PREREQ
(
maj
, 
mö
) \

162 ((
__GNUC__
 << 16Ë+ 
__GNUC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

164 
	#__GNUC_PREREQ
(
maj
, 
mö
Ë0

	)

171 #i‡
deföed
 
__˛™g_maj‹__
 && deföed 
__˛™g_mö‹__


172 
	#__glibc_˛™g_¥îeq
(
maj
, 
mö
) \

173 ((
__˛™g_maj‹__
 << 16Ë+ 
__˛™g_mö‹__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

175 
	#__glibc_˛™g_¥îeq
(
maj
, 
mö
Ë0

	)

179 
	#__GLIBC_USE
(
F
Ë
__GLIBC_USE_
 ## 
	)
F

185 #i‡(
deföed
 
_BSD_SOURCE
 || deföed 
_SVID_SOURCE
) \

186 && !
deföed
 
	g_DEFAULT_SOURCE


188 #unde‡
_DEFAULT_SOURCE


189 
	#_DEFAULT_SOURCE
 1

	)

193 #ifde‡
_GNU_SOURCE


194 #unde‡
_ISOC95_SOURCE


195 
	#_ISOC95_SOURCE
 1

	)

196 #unde‡
_ISOC99_SOURCE


197 
	#_ISOC99_SOURCE
 1

	)

198 #unde‡
_ISOC11_SOURCE


199 
	#_ISOC11_SOURCE
 1

	)

200 #unde‡
_ISOC2X_SOURCE


201 
	#_ISOC2X_SOURCE
 1

	)

202 #unde‡
_POSIX_SOURCE


203 
	#_POSIX_SOURCE
 1

	)

204 #unde‡
_POSIX_C_SOURCE


205 
	#_POSIX_C_SOURCE
 200809L

	)

206 #unde‡
_XOPEN_SOURCE


207 
	#_XOPEN_SOURCE
 700

	)

208 #unde‡
_XOPEN_SOURCE_EXTENDED


209 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

210 #unde‡
_LARGEFILE64_SOURCE


211 
	#_LARGEFILE64_SOURCE
 1

	)

212 #unde‡
_DEFAULT_SOURCE


213 
	#_DEFAULT_SOURCE
 1

	)

214 #unde‡
_ATFILE_SOURCE


215 
	#_ATFILE_SOURCE
 1

	)

220 #i‡(
deföed
 
_DEFAULT_SOURCE
 \

221 || (!
deföed
 
	g__STRICT_ANSI__
 \

222 && !
deföed
 
	g_ISOC99_SOURCE
 && !deföed 
	g_ISOC11_SOURCE
 \

223 && !
deföed
 
	g_ISOC2X_SOURCE
 \

224 && !
deföed
 
	g_POSIX_SOURCE
 && !deföed 
	g_POSIX_C_SOURCE
 \

225 && !
deföed
 
	g_XOPEN_SOURCE
))

226 #unde‡
_DEFAULT_SOURCE


227 
	#_DEFAULT_SOURCE
 1

	)

231 #i‡(
deföed
 
_ISOC2X_SOURCE
 \

232 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ > 201710L))

233 
	#__GLIBC_USE_ISOC2X
 1

	)

235 
	#__GLIBC_USE_ISOC2X
 0

	)

239 #i‡(
deföed
 
_ISOC11_SOURCE
 || deföed 
_ISOC2X_SOURCE
 \

240 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

241 
	#__USE_ISOC11
 1

	)

245 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

246 || 
deföed
 
_ISOC2X_SOURCE
 \

247 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

248 
	#__USE_ISOC99
 1

	)

252 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

253 || 
deföed
 
_ISOC2X_SOURCE
 \

254 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

255 
	#__USE_ISOC95
 1

	)

258 #ifde‡
__˝lu•lus


260 #i‡
__˝lu•lus
 >= 201703L

261 
	#__USE_ISOC11
 1

	)

265 #i‡
__˝lu•lus
 >201103L || 
deföed
 
__GXX_EXPERIMENTAL_CXX0X__


266 
	#__USE_ISOCXX11
 1

	)

267 
	#__USE_ISOC99
 1

	)

274 #ifde‡
_DEFAULT_SOURCE


275 #i‡!
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE


276 
	#__USE_POSIX_IMPLICITLY
 1

	)

278 #unde‡
_POSIX_SOURCE


279 
	#_POSIX_SOURCE
 1

	)

280 #unde‡
_POSIX_C_SOURCE


281 
	#_POSIX_C_SOURCE
 200809L

	)

284 #i‡((!
deföed
 
__STRICT_ANSI__
 \

285 || (
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

286 && !
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE
)

287 
	#_POSIX_SOURCE
 1

	)

288 #i‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

289 
	#_POSIX_C_SOURCE
 2

	)

290 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

291 
	#_POSIX_C_SOURCE
 199506L

	)

292 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

293 
	#_POSIX_C_SOURCE
 200112L

	)

295 
	#_POSIX_C_SOURCE
 200809L

	)

297 
	#__USE_POSIX_IMPLICITLY
 1

	)

306 #i‡((!
deföed
 
_POSIX_C_SOURCE
 || (_POSIX_C_SOURCE - 0) < 199506L) \

307 && (
deföed
 
_REENTRANT
 || deföed 
_THREAD_SAFE
))

308 
	#_POSIX_SOURCE
 1

	)

309 #unde‡
_POSIX_C_SOURCE


310 
	#_POSIX_C_SOURCE
 199506L

	)

313 #i‡(
deföed
 
_POSIX_SOURCE
 \

314 || (
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

315 || 
deföed
 
_XOPEN_SOURCE
)

316 
	#__USE_POSIX
 1

	)

319 #i‡
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >2 || deföed 
_XOPEN_SOURCE


320 
	#__USE_POSIX2
 1

	)

323 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

324 
	#__USE_POSIX199309
 1

	)

327 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

328 
	#__USE_POSIX199506
 1

	)

331 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

332 
	#__USE_XOPEN2K
 1

	)

333 #unde‡
__USE_ISOC95


334 
	#__USE_ISOC95
 1

	)

335 #unde‡
__USE_ISOC99


336 
	#__USE_ISOC99
 1

	)

339 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

340 
	#__USE_XOPEN2K8
 1

	)

341 #unde‡
_ATFILE_SOURCE


342 
	#_ATFILE_SOURCE
 1

	)

345 #ifdef 
_XOPEN_SOURCE


346 
	#__USE_XOPEN
 1

	)

347 #i‡(
_XOPEN_SOURCE
 - 0) >= 500

348 
	#__USE_XOPEN_EXTENDED
 1

	)

349 
	#__USE_UNIX98
 1

	)

350 #unde‡
_LARGEFILE_SOURCE


351 
	#_LARGEFILE_SOURCE
 1

	)

352 #i‡(
_XOPEN_SOURCE
 - 0) >= 600

353 #i‡(
_XOPEN_SOURCE
 - 0) >= 700

354 
	#__USE_XOPEN2K8
 1

	)

355 
	#__USE_XOPEN2K8XSI
 1

	)

357 
	#__USE_XOPEN2K
 1

	)

358 
	#__USE_XOPEN2KXSI
 1

	)

359 #unde‡
__USE_ISOC95


360 
	#__USE_ISOC95
 1

	)

361 #unde‡
__USE_ISOC99


362 
	#__USE_ISOC99
 1

	)

365 #ifde‡
_XOPEN_SOURCE_EXTENDED


366 
	#__USE_XOPEN_EXTENDED
 1

	)

371 #ifde‡
_LARGEFILE_SOURCE


372 
	#__USE_LARGEFILE
 1

	)

375 #ifde‡
_LARGEFILE64_SOURCE


376 
	#__USE_LARGEFILE64
 1

	)

379 #i‡
deföed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

380 
	#__USE_FILE_OFFSET64
 1

	)

383 #i‡
deföed
 
_DEFAULT_SOURCE


384 
	#__USE_MISC
 1

	)

387 #ifdef 
_ATFILE_SOURCE


388 
	#__USE_ATFILE
 1

	)

391 #ifdef 
_GNU_SOURCE


392 
	#__USE_GNU
 1

	)

395 #i‡
deföed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

396 && 
__GNUC_PREREQ
 (4, 1Ë&& 
deföed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

397 #i‡
_FORTIFY_SOURCE
 > 1

398 
	#__USE_FORTIFY_LEVEL
 2

	)

400 
	#__USE_FORTIFY_LEVEL
 1

	)

403 
	#__USE_FORTIFY_LEVEL
 0

	)

410 #i‡
deföed
 
__˝lu•lus
 ? __˝lu•lu†>201402L : deföed 
__USE_ISOC11


411 
	#__GLIBC_USE_DEPRECATED_GETS
 0

	)

413 
	#__GLIBC_USE_DEPRECATED_GETS
 1

	)

428 #i‡(
deföed
 
__USE_GNU
 \

429 && (
deföed
 
	g__˝lu•lus
 \

430 ? (
	g__˝lu•lus
 < 201103L && !
deföed
 
	g__GXX_EXPERIMENTAL_CXX0X__
) \

431 : (!
deföed
 
__STDC_VERSION__
 || __STDC_VERSION__ < 199901L)))

432 
	#__GLIBC_USE_DEPRECATED_SCANF
 1

	)

434 
	#__GLIBC_USE_DEPRECATED_SCANF
 0

	)

439 
	~<°dc-¥edef.h
>

447 #unde‡
__GNU_LIBRARY__


448 
	#__GNU_LIBRARY__
 6

	)

452 
	#__GLIBC__
 2

	)

453 
	#__GLIBC_MINOR__
 31

	)

455 
	#__GLIBC_PREREQ
(
maj
, 
mö
) \

456 ((
__GLIBC__
 << 16Ë+ 
__GLIBC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

459 #i‚de‡
__ASSEMBLER__


460 #i‚de‡
_SYS_CDEFS_H


461 
	~<sys/cdefs.h
>

466 #i‡
deföed
 
__USE_FILE_OFFSET64
 && !deföed 
__REDIRECT


467 
	#__USE_LARGEFILE
 1

	)

468 
	#__USE_LARGEFILE64
 1

	)

474 #i‡
__GNUC_PREREQ
 (2, 7Ë&& 
deföed
 
__OPTIMIZE__
 \

475 && !
deföed
 
	g__OPTIMIZE_SIZE__
 && !deföed 
	g__NO_INLINE__
 \

476 && 
deföed
 
	g__exã∫_ölöe


477 
	#__USE_EXTERN_INLINES
 1

	)

485 
	~<gnu/°ubs.h
>

	@/usr/include/stdc-predef.h

18 #i‚def 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifde‡
__GCC_IEC_559


37 #i‡
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifde‡
__GCC_IEC_559_COMPLEX


45 #i‡
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

58 
	#__STDC_ISO_10646__
 201706L

	)

	@
1
.
1
/usr/include
84
1601
acl.c
acl.h
balloc.c
bitmap.c
block_validity.c
dir.c
ext4.h
ext4_extents.h
ext4_jbd2.c
ext4_jbd2.h
extents.c
extents_status.c
extents_status.h
file.c
fsmap.c
fsmap.h
fsync.c
hash.c
ialloc.c
indirect.c
inline.c
inode.c
ioctl.c
mballoc.c
mballoc.h
migrate.c
mmp.c
move_extent.c
namei.c
page-io.c
readpage.c
resize.c
super.c
symlink.c
sysfs.c
truncate.h
verity.c
xattr.c
xattr.h
xattr_security.c
xattr_trusted.c
xattr_user.c
/usr/include/linux/capability.h
/usr/include/linux/errno.h
/usr/include/linux/falloc.h
/usr/include/linux/fcntl.h
/usr/include/linux/fiemap.h
/usr/include/linux/fs.h
/usr/include/linux/fscrypt.h
/usr/include/linux/fsmap.h
/usr/include/linux/fsverity.h
/usr/include/linux/kdev_t.h
/usr/include/linux/kernel.h
/usr/include/linux/magic.h
/usr/include/linux/mman.h
/usr/include/linux/module.h
/usr/include/linux/mount.h
/usr/include/linux/posix_acl_xattr.h
/usr/include/linux/quota.h
/usr/include/linux/random.h
/usr/include/linux/sched.h
/usr/include/linux/stat.h
/usr/include/linux/string.h
/usr/include/linux/time.h
/usr/include/linux/types.h
/usr/include/linux/uio.h
/usr/include/linux/utsname.h
/usr/include/linux/uuid.h
/usr/include/linux/version.h
/usr/include/linux/wait.h
/usr/include/linux/xattr.h
/usr/include/asm-generic/hugetlb_encode.h
/usr/include/linux/ioctl.h
/usr/include/linux/irqnr.h
/usr/include/linux/libc-compat.h
/usr/include/linux/limits.h
/usr/include/linux/posix_types.h
/usr/include/linux/sysinfo.h
/usr/include/linux/time_types.h
/usr/include/string.h
/usr/include/linux/stddef.h
/usr/include/strings.h
/usr/include/features.h
/usr/include/stdc-predef.h
