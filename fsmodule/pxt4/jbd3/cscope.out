cscope 15 /home/ungung97/fsmodule/jbd3               0000184005
	@checkpoint.c

17 
	~<lšux/time.h
>

18 
	~<lšux/fs.h
>

19 
	~<lšux/jbd3.h
>

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/¦ab.h
>

22 
	~<lšux/blkdev.h
>

23 
	~<Œaû/ev’ts/jbd3.h
>

30 
šlše
 
	$__bufãr_uÆšk_fœ¡
(
jouº®_h—d
 *
jh
)

32 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
;

34 
jh
->
b_ıÃxt
->
b_ı´ev
 = jh->b_cpprev;

35 
jh
->
b_ı´ev
->
b_ıÃxt
 = jh->b_cpnext;

36 ià(
Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
jh
) {

37 
Œª§ùiÚ
->
t_checkpošt_li¡
 = 
jh
->
b_ıÃxt
;

38 ià(
Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
jh
)

39 
Œª§ùiÚ
->
t_checkpošt_li¡
 = 
NULL
;

41 
	}
}

48 
šlše
 
	$__bufãr_uÆšk
(
jouº®_h—d
 *
jh
)

50 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
;

52 
	`__bufãr_uÆšk_fœ¡
(
jh
);

53 ià(
Œª§ùiÚ
->
t_checkpošt_io_li¡
 =ğ
jh
) {

54 
Œª§ùiÚ
->
t_checkpošt_io_li¡
 = 
jh
->
b_ıÃxt
;

55 ià(
Œª§ùiÚ
->
t_checkpošt_io_li¡
 =ğ
jh
)

56 
Œª§ùiÚ
->
t_checkpošt_io_li¡
 = 
NULL
;

58 
	}
}

65 
šlše
 
	$__bufãr_»lšk_io
(
jouº®_h—d
 *
jh
)

67 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
;

69 
	`__bufãr_uÆšk_fœ¡
(
jh
);

71 ià(!
Œª§ùiÚ
->
t_checkpošt_io_li¡
) {

72 
jh
->
b_ıÃxt
 = jh->
b_ı´ev
 = jh;

74 
jh
->
b_ıÃxt
 = 
Œª§ùiÚ
->
t_checkpošt_io_li¡
;

75 
jh
->
b_ı´ev
 = 
Œª§ùiÚ
->
t_checkpošt_io_li¡
->b_cpprev;

76 
jh
->
b_ı´ev
->
b_ıÃxt
 = jh;

77 
jh
->
b_ıÃxt
->
b_ı´ev
 = jh;

79 
Œª§ùiÚ
->
t_checkpošt_io_li¡
 = 
jh
;

80 
	}
}

89 
	$__Œy_to_ä“_ı_buf
(
jouº®_h—d
 *
jh
)

91 
»t
 = 0;

92 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

94 ià(
jh
->
b_Œª§ùiÚ
 =ğ
NULL
 && !
	`bufãr_locked
(
bh
) &&

95 !
	`bufãr_dœty
(
bh
è&& !
	`bufãr_wr™e_io_”rÜ
(bh)) {

96 
	`JBUFFER_TRACE
(
jh
, "remove from checkpoint†ist");

97 
»t
 = 
	`__jbd3_jouº®_»move_checkpošt
(
jh
) + 1;

99  
»t
;

100 
	}
}

108 
	$__jbd3_log_wa™_fÜ_¥aû
(
jouº®_t
 *
jouº®
)

110 
nblocks
, 
¥aû_Ëá
;

113 
nblocks
 = 
	`jbd3_¥aû_Ãeded
(
jouº®
);

114 
	`jbd3_log_¥aû_Ëá
(
jouº®
è< 
nblocks
) {

115 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

116 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

129 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

130 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT
) {

131 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

134 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

135 
¥aû_Ëá
 = 
	`jbd3_log_¥aû_Ëá
(
jouº®
);

136 ià(
¥aû_Ëá
 < 
nblocks
) {

137 
chk±
 = 
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
NULL
;

138 
tid_t
 
tid
 = 0;

140 ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
)

141 
tid
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
;

142 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

143 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

144 ià(
chk±
) {

145 
	`jbd3_log_do_checkpošt
(
jouº®
);

146 } ià(
	`jbd3_ş—nup_jouº®_
(
jouº®
) == 0) {

149 } ià(
tid
) {

155 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

156 
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

157 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

160 
	`´štk
(
KERN_ERR
 "%s:‚eeded %d blocks‡nd "

162 
__func__
, 
nblocks
, 
¥aû_Ëá
);

163 
	`´štk
(
KERN_ERR
 "%s:‚o wayo get more "

164 "jouº® s·û iÀ%s\n", 
__func__
,

165 
jouº®
->
j_devÇme
);

166 
	`WARN_ON
(1);

167 
	`jbd3_jouº®_abÜt
(
jouº®
, 0);

169 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

171 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

173 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

175 
	}
}

178 
	$__æush_b©ch
(
jouº®_t
 *
jouº®
, *
b©ch_couÁ
)

180 
i
;

181 
blk_¶ug
 
¶ug
;

183 
	`blk_¡¬t_¶ug
(&
¶ug
);

184 
i
 = 0; i < *
b©ch_couÁ
; i++)

185 
	`wr™e_dœty_bufãr
(
jouº®
->
j_chk±_bhs
[
i
], 
REQ_SYNC
);

186 
	`blk_fšish_¶ug
(&
¶ug
);

188 
i
 = 0; i < *
b©ch_couÁ
; i++) {

189 
bufãr_h—d
 *
bh
 = 
jouº®
->
j_chk±_bhs
[
i
];

190 
	`BUFFER_TRACE
(
bh
, "brelse");

191 
	`__b»l£
(
bh
);

193 *
b©ch_couÁ
 = 0;

194 
	}
}

204 
	$jbd3_log_do_checkpošt
(
jouº®_t
 *
jouº®
)

206 
jouº®_h—d
 *
jh
;

207 
bufãr_h—d
 *
bh
;

208 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

209 
tid_t
 
this_tid
;

210 
»suÉ
, 
b©ch_couÁ
 = 0;

212 
	`jbd_debug
(1, "Start checkpoint\n");

219 
»suÉ
 = 
	`jbd3_ş—nup_jouº®_
(
jouº®
);

220 
	`Œaû_jbd3_checkpošt
(
jouº®
, 
»suÉ
);

221 
	`jbd_debug
(1, "ş—nup_jouº®_„‘uºed %d\n", 
»suÉ
);

222 ià(
»suÉ
 <= 0)

223  
»suÉ
;

229 
»suÉ
 = 0;

230 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

231 ià(!
jouº®
->
j_checkpošt_Œª§ùiÚs
)

232 
out
;

233 
Œª§ùiÚ
 = 
jouº®
->
j_checkpošt_Œª§ùiÚs
;

234 ià(
Œª§ùiÚ
->
t_chp_¡©s
.
cs_chp_time
 == 0)

235 
Œª§ùiÚ
->
t_chp_¡©s
.
cs_chp_time
 = 
jiff›s
;

236 
this_tid
 = 
Œª§ùiÚ
->
t_tid
;

237 
»¡¬t
:

243 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
Œª§ùiÚ
 ||

244 
Œª§ùiÚ
->
t_tid
 !ğ
this_tid
)

245 
out
;

248 
Œª§ùiÚ
->
t_checkpošt_li¡
) {

249 
jh
 = 
Œª§ùiÚ
->
t_checkpošt_li¡
;

250 
bh
 = 
	`jh2bh
(
jh
);

252 ià(
	`bufãr_locked
(
bh
)) {

253 
	`g‘_bh
(
bh
);

254 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

255 
	`wa™_Ú_bufãr
(
bh
);

257 
	`BUFFER_TRACE
(
bh
, "brelse");

258 
	`__b»l£
(
bh
);

259 
»Œy
;

261 ià(
jh
->
b_Œª§ùiÚ
 !ğ
NULL
) {

262 
Œª§ùiÚ_t
 *
t
 = 
jh
->
b_Œª§ùiÚ
;

263 
tid_t
 
tid
 = 
t
->
t_tid
;

265 
Œª§ùiÚ
->
t_chp_¡©s
.
cs_fÜûd_to_şo£
++;

266 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

267 ià(
	`uÆik–y
(
jouº®
->
j_æags
 & 
JBD3_UNMOUNT
))

274 
	`´štk
(
KERN_ERR


276 
jouº®
->
j_devÇme
, (è
bh
->
b_blockÄ
);

278 ià(
b©ch_couÁ
)

279 
	`__æush_b©ch
(
jouº®
, &
b©ch_couÁ
);

280 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

289 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

290 
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

291 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

292 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

293 
»¡¬t
;

295 ià(!
	`bufãr_dœty
(
bh
)) {

296 ià(
	`uÆik–y
(
	`bufãr_wr™e_io_”rÜ
(
bh
)è&& !
»suÉ
)

297 
»suÉ
 = -
EIO
;

298 
	`BUFFER_TRACE
(
bh
, "remove from checkpoint");

299 ià(
	`__jbd3_jouº®_»move_checkpošt
(
jh
))

301 
out
;

312 
	`BUFFER_TRACE
(
bh
, "queue");

313 
	`g‘_bh
(
bh
);

314 
	`J_ASSERT_BH
(
bh
, !
	`bufãr_jwr™e
(bh));

315 
jouº®
->
j_chk±_bhs
[
b©ch_couÁ
++] = 
bh
;

316 
	`__bufãr_»lšk_io
(
jh
);

317 
Œª§ùiÚ
->
t_chp_¡©s
.
cs_wr™‹n
++;

318 ià((
b©ch_couÁ
 =ğ
JBD3_NR_BATCH
) ||

319 
	`Ãed_»sched
() ||

320 
	`¥š_Ãedb»ak
(&
jouº®
->
j_li¡_lock
))

321 
uÆock_ªd_æush
;

324 ià(
b©ch_couÁ
) {

325 
uÆock_ªd_æush
:

326 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

327 
»Œy
:

328 ià(
b©ch_couÁ
)

329 
	`__æush_b©ch
(
jouº®
, &
b©ch_couÁ
);

330 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

331 
»¡¬t
;

338 
»¡¬t2
:

340 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
Œª§ùiÚ
 ||

341 
Œª§ùiÚ
->
t_tid
 !ğ
this_tid
)

342 
out
;

344 
Œª§ùiÚ
->
t_checkpošt_io_li¡
) {

345 
jh
 = 
Œª§ùiÚ
->
t_checkpošt_io_li¡
;

346 
bh
 = 
	`jh2bh
(
jh
);

347 ià(
	`bufãr_locked
(
bh
)) {

348 
	`g‘_bh
(
bh
);

349 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

350 
	`wa™_Ú_bufãr
(
bh
);

352 
	`BUFFER_TRACE
(
bh
, "brelse");

353 
	`__b»l£
(
bh
);

354 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

355 
»¡¬t2
;

357 ià(
	`uÆik–y
(
	`bufãr_wr™e_io_”rÜ
(
bh
)è&& !
»suÉ
)

358 
»suÉ
 = -
EIO
;

365 ià(
	`__jbd3_jouº®_»move_checkpošt
(
jh
))

368 
out
:

369 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

370 ià(
»suÉ
 < 0)

371 
	`jbd3_jouº®_abÜt
(
jouº®
, 
»suÉ
);

373 
»suÉ
 = 
	`jbd3_ş—nup_jouº®_
(
jouº®
);

375  (
»suÉ
 < 0) ?„esult : 0;

376 
	}
}

396 
	$jbd3_ş—nup_jouº®_
(
jouº®_t
 *
jouº®
)

398 
tid_t
 
fœ¡_tid
;

399 
blockÄ
;

401 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

402  -
EIO
;

404 ià(!
	`jbd3_jouº®_g‘_log_
(
jouº®
, &
fœ¡_tid
, &
blockÄ
))

406 
	`J_ASSERT
(
blockÄ
 != 0);

416 ià(
jouº®
->
j_æags
 & 
JBD3_BARRIER
)

417 
	`blkdev_issue_æush
(
jouº®
->
j_fs_dev
, 
GFP_NOFS
, 
NULL
);

419  
	`__jbd3_upd©e_log_
(
jouº®
, 
fœ¡_tid
, 
blockÄ
);

420 
	}
}

434 
	$jouº®_ş—n_Úe_ı_li¡
(
jouº®_h—d
 *
jh
, 
boŞ
 
de¡roy
)

436 
jouº®_h—d
 *
Ï¡_jh
;

437 
jouº®_h—d
 *
Ãxt_jh
 = 
jh
;

438 
»t
;

440 ià(!
jh
)

443 
Ï¡_jh
 = 
jh
->
b_ı´ev
;

445 
jh
 = 
Ãxt_jh
;

446 
Ãxt_jh
 = 
jh
->
b_ıÃxt
;

447 ià(!
de¡roy
)

448 
»t
 = 
	`__Œy_to_ä“_ı_buf
(
jh
);

450 
»t
 = 
	`__jbd3_jouº®_»move_checkpošt
(
jh
) + 1;

451 ià(!
»t
)

453 ià(
»t
 == 2)

461 ià(
	`Ãed_»sched
())

463 } 
jh
 !ğ
Ï¡_jh
);

466 
	}
}

476 
	$__jbd3_jouº®_ş—n_checkpošt_li¡
(
jouº®_t
 *
jouº®
, 
boŞ
 
de¡roy
)

478 
Œª§ùiÚ_t
 *
Œª§ùiÚ
, *
Ï¡_Œª§ùiÚ
, *
Ãxt_Œª§ùiÚ
;

479 
»t
;

481 
Œª§ùiÚ
 = 
jouº®
->
j_checkpošt_Œª§ùiÚs
;

482 ià(!
Œª§ùiÚ
)

485 
Ï¡_Œª§ùiÚ
 = 
Œª§ùiÚ
->
t_ı´ev
;

486 
Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

488 
Œª§ùiÚ
 = 
Ãxt_Œª§ùiÚ
;

489 
Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
->
t_ıÃxt
;

490 
»t
 = 
	`jouº®_ş—n_Úe_ı_li¡
(
Œª§ùiÚ
->
t_checkpošt_li¡
,

491 
de¡roy
);

497 ià(
	`Ãed_»sched
())

499 ià(
»t
)

506 
»t
 = 
	`jouº®_ş—n_Úe_ı_li¡
(
Œª§ùiÚ
->

507 
t_checkpošt_io_li¡
, 
de¡roy
);

508 ià(
	`Ãed_»sched
())

515 ià(!
»t
)

517 } 
Œª§ùiÚ
 !ğ
Ï¡_Œª§ùiÚ
);

518 
	}
}

524 
	$jbd3_jouº®_de¡roy_checkpošt
(
jouº®_t
 *
jouº®
)

531 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

532 ià(!
jouº®
->
j_checkpošt_Œª§ùiÚs
) {

533 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

536 
	`__jbd3_jouº®_ş—n_checkpošt_li¡
(
jouº®
, 
Œue
);

537 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

538 
	`cÚd_»sched
();

540 
	}
}

560 
	$__jbd3_jouº®_»move_checkpošt
(
jouº®_h—d
 *
jh
)

562 
Œª§ùiÚ_chp_¡©s_s
 *
¡©s
;

563 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

564 
jouº®_t
 *
jouº®
;

565 
»t
 = 0;

567 
	`JBUFFER_TRACE
(
jh
, "entry");

569 ià((
Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
è=ğ
NULL
) {

570 
	`JBUFFER_TRACE
(
jh
, "not onransaction");

571 
out
;

573 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

575 
	`JBUFFER_TRACE
(
jh
, "removing fromransaction");

576 
	`__bufãr_uÆšk
(
jh
);

577 
jh
->
b_ı_Œª§ùiÚ
 = 
NULL
;

578 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

580 ià(
Œª§ùiÚ
->
t_checkpošt_li¡
 !ğ
NULL
 ||

581 
Œª§ùiÚ
->
t_checkpošt_io_li¡
 !ğ
NULL
)

582 
out
;

593 ià(
Œª§ùiÚ
->
t_¡©e
 !ğ
T_FINISHED
)

594 
out
;

598 
¡©s
 = &
Œª§ùiÚ
->
t_chp_¡©s
;

599 ià(
¡©s
->
cs_chp_time
)

600 
¡©s
->
cs_chp_time
 = 
	`jbd3_time_diff
(stats->cs_chp_time,

601 
jiff›s
);

602 
	`Œaû_jbd3_checkpošt_¡©s
(
jouº®
->
j_fs_dev
->
bd_dev
,

603 
Œª§ùiÚ
->
t_tid
, 
¡©s
);

605 
	`__jbd3_jouº®_drİ_Œª§ùiÚ
(
jouº®
, 
Œª§ùiÚ
);

606 
	`jbd3_jouº®_ä“_Œª§ùiÚ
(
Œª§ùiÚ
);

607 
»t
 = 1;

608 
out
:

609  
»t
;

610 
	}
}

620 
	$__jbd3_jouº®_š£¹_checkpošt
(
jouº®_h—d
 *
jh
,

621 
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

623 
	`JBUFFER_TRACE
(
jh
, "entry");

624 
	`J_ASSERT_JH
(
jh
, 
	`bufãr_dœty
(
	`jh2bh
(jh)è|| 
	`bufãr_jbddœty
(jh2bh(jh)));

625 
	`J_ASSERT_JH
(
jh
, jh->
b_ı_Œª§ùiÚ
 =ğ
NULL
);

628 
	`jbd3_jouº®_g¿b_jouº®_h—d
(
	`jh2bh
(
jh
));

629 
jh
->
b_ı_Œª§ùiÚ
 = 
Œª§ùiÚ
;

631 ià(!
Œª§ùiÚ
->
t_checkpošt_li¡
) {

632 
jh
->
b_ıÃxt
 = jh->
b_ı´ev
 = jh;

634 
jh
->
b_ıÃxt
 = 
Œª§ùiÚ
->
t_checkpošt_li¡
;

635 
jh
->
b_ı´ev
 = 
Œª§ùiÚ
->
t_checkpošt_li¡
->b_cpprev;

636 
jh
->
b_ı´ev
->
b_ıÃxt
 = jh;

637 
jh
->
b_ıÃxt
->
b_ı´ev
 = jh;

639 
Œª§ùiÚ
->
t_checkpošt_li¡
 = 
jh
;

640 
	}
}

652 
	$__jbd3_jouº®_drİ_Œª§ùiÚ
(
jouº®_t
 *
jouº®
, 
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

654 
	`as£¹_¥š_locked
(&
jouº®
->
j_li¡_lock
);

655 ià(
Œª§ùiÚ
->
t_ıÃxt
) {

656 
Œª§ùiÚ
->
t_ıÃxt
->
t_ı´ev
 =ransaction->t_cpprev;

657 
Œª§ùiÚ
->
t_ı´ev
->
t_ıÃxt
 =ransaction->t_cpnext;

658 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 =ğ
Œª§ùiÚ
)

659 
jouº®
->
j_checkpošt_Œª§ùiÚs
 =

660 
Œª§ùiÚ
->
t_ıÃxt
;

661 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 =ğ
Œª§ùiÚ
)

662 
jouº®
->
j_checkpošt_Œª§ùiÚs
 = 
NULL
;

665 
	`J_ASSERT
(
Œª§ùiÚ
->
t_¡©e
 =ğ
T_FINISHED
);

666 
	`J_ASSERT
(
Œª§ùiÚ
->
t_bufãrs
 =ğ
NULL
);

667 
	`J_ASSERT
(
Œª§ùiÚ
->
t_fÜg‘
 =ğ
NULL
);

668 
	`J_ASSERT
(
Œª§ùiÚ
->
t_shadow_li¡
 =ğ
NULL
);

669 
	`J_ASSERT
(
Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
NULL
);

670 
	`J_ASSERT
(
Œª§ùiÚ
->
t_checkpošt_io_li¡
 =ğ
NULL
);

671 
	`J_ASSERT
(
	`©omic_»ad
(&
Œª§ùiÚ
->
t_upd©es
) == 0);

672 
	`J_ASSERT
(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 !ğ
Œª§ùiÚ
);

673 
	`J_ASSERT
(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 !ğ
Œª§ùiÚ
);

675 
	`Œaû_jbd3_drİ_Œª§ùiÚ
(
jouº®
, 
Œª§ùiÚ
);

677 
	`jbd_debug
(1, "Drİpšg¿n§ùiÚ %d,‡Î dÚe\n", 
Œª§ùiÚ
->
t_tid
);

678 
	}
}

	@commit.c

13 
	~<lšux/time.h
>

14 
	~<lšux/fs.h
>

15 
	~<lšux/jbd3.h
>

16 
	~<lšux/”ºo.h
>

17 
	~<lšux/¦ab.h
>

18 
	~<lšux/mm.h
>

19 
	~<lšux/·gem­.h
>

20 
	~<lšux/jiff›s.h
>

21 
	~<lšux/üc32.h
>

22 
	~<lšux/wr™eback.h
>

23 
	~<lšux/backšg-dev.h
>

24 
	~<lšux/bio.h
>

25 
	~<lšux/blkdev.h
>

26 
	~<lšux/b™İs.h
>

27 
	~<Œaû/ev’ts/jbd3.h
>

32 
	$jouº®_’d_bufãr_io_sync
(
bufãr_h—d
 *
bh
, 
u±od©e
)

34 
bufãr_h—d
 *
Üig_bh
 = 
bh
->
b_´iv©e
;

36 
	`BUFFER_TRACE
(
bh
, "");

37 ià(
u±od©e
)

38 
	`£t_bufãr_u±od©e
(
bh
);

40 
	`ş—r_bufãr_u±od©e
(
bh
);

41 ià(
Üig_bh
) {

42 
	`ş—r_b™_uÆock
(
BH_Shadow
, &
Üig_bh
->
b_¡©e
);

43 
	`smp_mb__aá”_©omic
();

44 
	`wake_up_b™
(&
Üig_bh
->
b_¡©e
, 
BH_Shadow
);

46 
	`uÆock_bufãr
(
bh
);

47 
	}
}

63 
	$»Ëa£_bufãr_·ge
(
bufãr_h—d
 *
bh
)

65 
·ge
 *page;

67 ià(
	`bufãr_dœty
(
bh
))

68 
nİe
;

69 ià(
	`©omic_»ad
(&
bh
->
b_couÁ
) != 1)

70 
nİe
;

71 
·ge
 = 
bh
->
b_·ge
;

72 ià(!
·ge
)

73 
nİe
;

74 ià(
·ge
->
m­pšg
)

75 
nİe
;

78 ià(!
	`Œylock_·ge
(
·ge
))

79 
nİe
;

81 
	`g‘_·ge
(
·ge
);

82 
	`__b»l£
(
bh
);

83 
	`Œy_to_ä“_bufãrs
(
·ge
);

84 
	`uÆock_·ge
(
·ge
);

85 
	`put_·ge
(
·ge
);

88 
nİe
:

89 
	`__b»l£
(
bh
);

90 
	}
}

92 
	$jbd3_comm™_block_csum_£t
(
jouº®_t
 *
j
, 
bufãr_h—d
 *
bh
)

94 
comm™_h—d”
 *
h
;

95 
__u32
 
csum
;

97 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

100 
h
 = (
comm™_h—d”
 *)(
bh
->
b_d©a
);

101 
h
->
h_chksum_ty³
 = 0;

102 
h
->
h_chksum_size
 = 0;

103 
h
->
h_chksum
[0] = 0;

104 
csum
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
bh
->
b_d©a
, j->
j_blocksize
);

105 
h
->
h_chksum
[0] = 
	`ıu_to_be32
(
csum
);

106 
	}
}

116 
	$jouº®_subm™_comm™_»cÜd
(
jouº®_t
 *
jouº®
,

117 
Œª§ùiÚ_t
 *
comm™_Œª§ùiÚ
,

118 
bufãr_h—d
 **
cbh
,

119 
__u32
 
üc32_sum
)

121 
comm™_h—d”
 *
tmp
;

122 
bufãr_h—d
 *
bh
;

123 
»t
;

124 
time¥ec64
 
now
;

126 *
cbh
 = 
NULL
;

128 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

131 
bh
 = 
	`jbd3_jouº®_g‘_desütÜ_bufãr
(
comm™_Œª§ùiÚ
,

132 
JBD3_COMMIT_BLOCK
);

133 ià(!
bh
)

136 
tmp
 = (
comm™_h—d”
 *)
bh
->
b_d©a
;

137 
	`ktime_g‘_cßr£_»®_ts64
(&
now
);

138 
tmp
->
h_comm™_£c
 = 
	`ıu_to_be64
(
now
.
tv_£c
);

139 
tmp
->
h_comm™_n£c
 = 
	`ıu_to_be32
(
now
.
tv_n£c
);

141 ià(
	`jbd3_has_ã©u»_checksum
(
jouº®
)) {

142 
tmp
->
h_chksum_ty³
 = 
JBD3_CRC32_CHKSUM
;

143 
tmp
->
h_chksum_size
 = 
JBD3_CRC32_CHKSUM_SIZE
;

144 
tmp
->
h_chksum
[0] = 
	`ıu_to_be32
(
üc32_sum
);

146 
	`jbd3_comm™_block_csum_£t
(
jouº®
, 
bh
);

148 
	`BUFFER_TRACE
(
bh
, "submit commit block");

149 
	`lock_bufãr
(
bh
);

150 
	`ş—r_bufãr_dœty
(
bh
);

151 
	`£t_bufãr_u±od©e
(
bh
);

152 
bh
->
b_’d_io
 = 
jouº®_’d_bufãr_io_sync
;

154 ià(
jouº®
->
j_æags
 & 
JBD3_BARRIER
 &&

155 !
	`jbd3_has_ã©u»_async_comm™
(
jouº®
))

156 
»t
 = 
	`subm™_bh
(
REQ_OP_WRITE
,

157 
REQ_SYNC
 | 
REQ_PREFLUSH
 | 
REQ_FUA
, 
bh
);

159 
»t
 = 
	`subm™_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
, 
bh
);

161 *
cbh
 = 
bh
;

162  
»t
;

163 
	}
}

169 
	$jouº®_wa™_Ú_comm™_»cÜd
(
jouº®_t
 *
jouº®
,

170 
bufãr_h—d
 *
bh
)

172 
»t
 = 0;

174 
	`ş—r_bufãr_dœty
(
bh
);

175 
	`wa™_Ú_bufãr
(
bh
);

177 ià(
	`uÆik–y
(!
	`bufãr_u±od©e
(
bh
)))

178 
»t
 = -
EIO
;

179 
	`put_bh
(
bh
);

181  
»t
;

182 
	}
}

190 
	$jouº®_subm™_šode_d©a_bufãrs
(
add»ss_¥aû
 *
m­pšg
,

191 
loff_t
 
dœty_¡¬t
,†off_ˆ
dœty_’d
)

193 
»t
;

194 
wr™eback_cÚŒŞ
 
wbc
 = {

195 .
sync_mode
 = 
WB_SYNC_ALL
,

196 .
Ä_to_wr™e
 = 
m­pšg
->
Ä·ges
 * 2,

197 .
¿nge_¡¬t
 = 
dœty_¡¬t
,

198 .
¿nge_’d
 = 
dœty_’d
,

201 
»t
 = 
	`g’”ic_wr™•ages
(
m­pšg
, &
wbc
);

202  
»t
;

203 
	}
}

213 
	$jouº®_subm™_d©a_bufãrs
(
jouº®_t
 *
jouº®
,

214 
Œª§ùiÚ_t
 *
comm™_Œª§ùiÚ
)

216 
jbd3_šode
 *
jšode
;

217 
”r
, 
»t
 = 0;

218 
add»ss_¥aû
 *
m­pšg
;

220 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

221 
	`li¡_fÜ_—ch_’Œy
(
jšode
, &
comm™_Œª§ùiÚ
->
t_šode_li¡
, 
i_li¡
) {

222 
loff_t
 
dœty_¡¬t
 = 
jšode
->
i_dœty_¡¬t
;

223 
loff_t
 
dœty_’d
 = 
jšode
->
i_dœty_’d
;

225 ià(!(
jšode
->
i_æags
 & 
JI_WRITE_DATA
))

227 
m­pšg
 = 
jšode
->
i_vfs_šode
->
i_m­pšg
;

228 
jšode
->
i_æags
 |ğ
JI_COMMIT_RUNNING
;

229 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

236 
	`Œaû_jbd3_subm™_šode_d©a
(
jšode
->
i_vfs_šode
);

237 
”r
 = 
	`jouº®_subm™_šode_d©a_bufãrs
(
m­pšg
, 
dœty_¡¬t
,

238 
dœty_’d
);

239 ià(!
»t
)

240 
»t
 = 
”r
;

241 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

242 
	`J_ASSERT
(
jšode
->
i_Œª§ùiÚ
 =ğ
comm™_Œª§ùiÚ
);

243 
jšode
->
i_æags
 &ğ~
JI_COMMIT_RUNNING
;

244 
	`smp_mb
();

245 
	`wake_up_b™
(&
jšode
->
i_æags
, 
__JI_COMMIT_RUNNING
);

247 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

248  
»t
;

249 
	}
}

256 
	$jouº®_fšish_šode_d©a_bufãrs
(
jouº®_t
 *
jouº®
,

257 
Œª§ùiÚ_t
 *
comm™_Œª§ùiÚ
)

259 
jbd3_šode
 *
jšode
, *
Ãxt_i
;

260 
”r
, 
»t
 = 0;

263 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

264 
	`li¡_fÜ_—ch_’Œy
(
jšode
, &
comm™_Œª§ùiÚ
->
t_šode_li¡
, 
i_li¡
) {

265 
loff_t
 
dœty_¡¬t
 = 
jšode
->
i_dœty_¡¬t
;

266 
loff_t
 
dœty_’d
 = 
jšode
->
i_dœty_’d
;

268 ià(!(
jšode
->
i_æags
 & 
JI_WAIT_DATA
))

270 
jšode
->
i_æags
 |ğ
JI_COMMIT_RUNNING
;

271 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

272 
”r
 = 
	`fem­_fd©awa™_¿nge_k“p_”rÜs
(

273 
jšode
->
i_vfs_šode
->
i_m­pšg
, 
dœty_¡¬t
,

274 
dœty_’d
);

275 ià(!
»t
)

276 
»t
 = 
”r
;

277 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

278 
jšode
->
i_æags
 &ğ~
JI_COMMIT_RUNNING
;

279 
	`smp_mb
();

280 
	`wake_up_b™
(&
jšode
->
i_æags
, 
__JI_COMMIT_RUNNING
);

284 
	`li¡_fÜ_—ch_’Œy_§ã
(
jšode
, 
Ãxt_i
,

285 &
comm™_Œª§ùiÚ
->
t_šode_li¡
, 
i_li¡
) {

286 
	`li¡_d–
(&
jšode
->
i_li¡
);

287 ià(
jšode
->
i_Ãxt_Œª§ùiÚ
) {

288 
jšode
->
i_Œª§ùiÚ
 = jšode->
i_Ãxt_Œª§ùiÚ
;

289 
jšode
->
i_Ãxt_Œª§ùiÚ
 = 
NULL
;

290 
	`li¡_add
(&
jšode
->
i_li¡
,

291 &
jšode
->
i_Œª§ùiÚ
->
t_šode_li¡
);

293 
jšode
->
i_Œª§ùiÚ
 = 
NULL
;

294 
jšode
->
i_dœty_¡¬t
 = 0;

295 
jšode
->
i_dœty_’d
 = 0;

298 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

300  
»t
;

301 
	}
}

303 
__u32
 
	$jbd3_checksum_d©a
(
__u32
 
üc32_sum
, 
bufãr_h—d
 *
bh
)

305 
·ge
 *·gğ
bh
->
b_·ge
;

306 *
addr
;

307 
__u32
 
checksum
;

309 
addr
 = 
	`km­_©omic
(
·ge
);

310 
checksum
 = 
	`üc32_be
(
üc32_sum
,

311 (*)(
addr
 + 
	`off£t_š_·ge
(
bh
->
b_d©a
)), bh->
b_size
);

312 
	`kunm­_©omic
(
addr
);

314  
checksum
;

315 
	}
}

317 
	$wr™e_g_block
(
jouº®_t
 *
j
, 
jouº®_block_g_t
 *
g
,

318 
block
)

320 
g
->
t_blockÄ
 = 
	`ıu_to_be32
(
block
 & (
u32
)~0);

321 ià(
	`jbd3_has_ã©u»_64b™
(
j
))

322 
g
->
t_blockÄ_high
 = 
	`ıu_to_be32
((
block
 >> 31) >> 1);

323 
	}
}

325 
	$jbd3_block_g_csum_£t
(
jouº®_t
 *
j
, 
jouº®_block_g_t
 *
g
,

326 
bufãr_h—d
 *
bh
, 
__u32
 
£qu’û
)

328 
jouº®_block_g3_t
 *
g3
 = (jouº®_block_g3_ˆ*)
g
;

329 
·ge
 *·gğ
bh
->
b_·ge
;

330 
__u8
 *
addr
;

331 
__u32
 
csum32
;

332 
__be32
 
£q
;

334 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

337 
£q
 = 
	`ıu_to_be32
(
£qu’û
);

338 
addr
 = 
	`km­_©omic
(
·ge
);

339 
csum32
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, (
__u8
 *)&
£q
, (seq));

340 
csum32
 = 
	`jbd3_chksum
(
j
, csum32, 
addr
 + 
	`off£t_š_·ge
(
bh
->
b_d©a
),

341 
bh
->
b_size
);

342 
	`kunm­_©omic
(
addr
);

344 ià(
	`jbd3_has_ã©u»_csum3
(
j
))

345 
g3
->
t_checksum
 = 
	`ıu_to_be32
(
csum32
);

347 
g
->
t_checksum
 = 
	`ıu_to_be16
(
csum32
);

348 
	}
}

355 
	$jbd3_jouº®_comm™_Œª§ùiÚ
(
jouº®_t
 *
jouº®
)

357 
Œª§ùiÚ_¡©s_s
 
¡©s
;

358 
Œª§ùiÚ_t
 *
comm™_Œª§ùiÚ
;

359 
jouº®_h—d
 *
jh
;

360 
bufãr_h—d
 *
desütÜ
;

361 
bufãr_h—d
 **
wbuf
 = 
jouº®
->
j_wbuf
;

362 
bufs
;

363 
æags
;

364 
”r
;

365 
blockÄ
;

366 
ktime_t
 
¡¬t_time
;

367 
u64
 
comm™_time
;

368 *
gp
 = 
NULL
;

369 
jouº®_block_g_t
 *
g
 = 
NULL
;

370 
¥aû_Ëá
 = 0;

371 
fœ¡_g
 = 0;

372 
g_æag
;

373 
i
;

374 
g_by‹s
 = 
	`jouº®_g_by‹s
(
jouº®
);

375 
bufãr_h—d
 *
cbh
 = 
NULL
;

376 
__u32
 
üc32_sum
 = ~0;

377 
blk_¶ug
 
¶ug
;

379 
fœ¡_block
;

380 
tid_t
 
fœ¡_tid
;

381 
upd©e_
;

382 
csum_size
 = 0;

383 
	`LIST_HEAD
(
io_bufs
);

384 
	`LIST_HEAD
(
log_bufs
);

386 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

387 
csum_size
 = (
jbd3_jouº®_block_
);

395 ià(
jouº®
->
j_æags
 & 
JBD3_FLUSHED
) {

396 
	`jbd_debug
(3, "super block updated\n");

397 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

404 
	`jbd3_jouº®_upd©e_sb_log_
(
jouº®
,

405 
jouº®
->
j__£qu’û
,

406 
jouº®
->
j_
,

407 
REQ_SYNC
);

408 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

410 
	`jbd_debug
(3, "superblock‚ot updated\n");

413 
	`J_ASSERT
(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 !ğ
NULL
);

414 
	`J_ASSERT
(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 =ğ
NULL
);

416 
comm™_Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

418 
	`Œaû_jbd3_¡¬t_comm™
(
jouº®
, 
comm™_Œª§ùiÚ
);

419 
	`jbd_debug
(1, "JBD3: starting commit ofransaction %d\n",

420 
comm™_Œª§ùiÚ
->
t_tid
);

422 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

423 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_¡©e
 =ğ
T_RUNNING
);

424 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_LOCKED
;

426 
	`Œaû_jbd3_comm™_lockšg
(
jouº®
, 
comm™_Œª§ùiÚ
);

427 
¡©s
.
run
.
rs_wa™
 = 
comm™_Œª§ùiÚ
->
t_max_wa™
;

428 
¡©s
.
run
.
rs_»que¡_d–ay
 = 0;

429 
¡©s
.
run
.
rs_locked
 = 
jiff›s
;

430 ià(
comm™_Œª§ùiÚ
->
t_»que¡ed
)

431 
¡©s
.
run
.
rs_»que¡_d–ay
 =

432 
	`jbd3_time_diff
(
comm™_Œª§ùiÚ
->
t_»que¡ed
,

433 
¡©s
.
run
.
rs_locked
);

434 
¡©s
.
run
.
rs_ruÂšg
 = 
	`jbd3_time_diff
(
comm™_Œª§ùiÚ
->
t_¡¬t
,

435 
¡©s
.
run
.
rs_locked
);

437 
	`¥š_lock
(&
comm™_Œª§ùiÚ
->
t_hªdË_lock
);

438 
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_upd©es
)) {

439 
	`DEFINE_WAIT
(
wa™
);

441 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
,

442 
TASK_UNINTERRUPTIBLE
);

443 ià(
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_upd©es
)) {

444 
	`¥š_uÆock
(&
comm™_Œª§ùiÚ
->
t_hªdË_lock
);

445 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

446 
	`scheduË
();

447 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

448 
	`¥š_lock
(&
comm™_Œª§ùiÚ
->
t_hªdË_lock
);

450 
	`fšish_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
);

452 
	`¥š_uÆock
(&
comm™_Œª§ùiÚ
->
t_hªdË_lock
);

453 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_SWITCH
;

454 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

456 
	`J_ASSERT
 (
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
) <=

457 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
);

475 
comm™_Œª§ùiÚ
->
t_»£rved_li¡
) {

476 
jh
 = 
comm™_Œª§ùiÚ
->
t_»£rved_li¡
;

477 
	`JBUFFER_TRACE
(
jh
, "reserved, unused:„efile");

482 ià(
jh
->
b_comm™‹d_d©a
) {

483 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

485 
	`jbd_lock_bh_¡©e
(
bh
);

486 
	`jbd3_ä“
(
jh
->
b_comm™‹d_d©a
, 
bh
->
b_size
);

487 
jh
->
b_comm™‹d_d©a
 = 
NULL
;

488 
	`jbd_uÆock_bh_¡©e
(
bh
);

490 
	`jbd3_jouº®_»fe_bufãr
(
jouº®
, 
jh
);

498 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

499 
	`__jbd3_jouº®_ş—n_checkpošt_li¡
(
jouº®
, 
çl£
);

500 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

502 
	`jbd_debug
(3, "JBD3: commit…hase 1\n");

508 
	`jbd3_ş—r_bufãr_»voked_æags
(
jouº®
);

513 
	`jbd3_jouº®_sw™ch_»voke_bË
(
jouº®
);

518 
	`©omic_sub
(
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
),

519 &
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

521 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

522 
	`Œaû_jbd3_comm™_æushšg
(
jouº®
, 
comm™_Œª§ùiÚ
);

523 
¡©s
.
run
.
rs_æushšg
 = 
jiff›s
;

524 
¡©s
.
run
.
rs_locked
 = 
	`jbd3_time_diff
(stats.run.rs_locked,

525 
¡©s
.
run
.
rs_æushšg
);

527 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_FLUSH
;

528 
jouº®
->
j_comm™tšg_Œª§ùiÚ
 = 
comm™_Œª§ùiÚ
;

529 
jouº®
->
j_ruÂšg_Œª§ùiÚ
 = 
NULL
;

530 
¡¬t_time
 = 
	`ktime_g‘
();

531 
comm™_Œª§ùiÚ
->
t_log_¡¬t
 = 
jouº®
->
j_h—d
;

532 
	`wake_up
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
);

533 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

535 
	`jbd_debug
(3, "JBD3: commit…hase 2a\n");

541 
”r
 = 
	`jouº®_subm™_d©a_bufãrs
(
jouº®
, 
comm™_Œª§ùiÚ
);

542 ià(
”r
)

543 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

545 
	`blk_¡¬t_¶ug
(&
¶ug
);

546 
	`jbd3_jouº®_wr™e_»voke_»cÜds
(
comm™_Œª§ùiÚ
, &
log_bufs
);

548 
	`jbd_debug
(3, "JBD3: commit…hase 2b\n");

555 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

556 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_COMMIT
;

557 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

559 
	`Œaû_jbd3_comm™_loggšg
(
jouº®
, 
comm™_Œª§ùiÚ
);

560 
¡©s
.
run
.
rs_loggšg
 = 
jiff›s
;

561 
¡©s
.
run
.
rs_æushšg
 = 
	`jbd3_time_diff
(stats.run.rs_flushing,

562 
¡©s
.
run
.
rs_loggšg
);

563 
¡©s
.
run
.
rs_blocks
 =

564 
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

565 
¡©s
.
run
.
rs_blocks_logged
 = 0;

567 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_Ä_bufãrs
 <=

568 
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
));

570 
”r
 = 0;

571 
bufs
 = 0;

572 
desütÜ
 = 
NULL
;

573 
comm™_Œª§ùiÚ
->
t_bufãrs
) {

577 
jh
 = 
comm™_Œª§ùiÚ
->
t_bufãrs
;

582 ià(
	`is_jouº®_abÜ‹d
(
jouº®
)) {

583 
	`ş—r_bufãr_jbddœty
(
	`jh2bh
(
jh
));

584 
	`JBUFFER_TRACE
(
jh
, "journal is‡borting:„efile");

585 
	`jbd3_bufãr_abÜt_Œigg”
(
jh
,

586 
jh
->
b_äoz’_d©a
 ?

587 
jh
->
b_äoz’_Œigg”s
 :

588 
jh
->
b_Œigg”s
);

589 
	`jbd3_jouº®_»fe_bufãr
(
jouº®
, 
jh
);

594 ià(!
comm™_Œª§ùiÚ
->
t_bufãrs
)

595 
¡¬t_jouº®_io
;

602 ià(!
desütÜ
) {

603 
	`J_ASSERT
 (
bufs
 == 0);

605 
	`jbd_debug
(4, "JBD3: get descriptor\n");

607 
desütÜ
 = 
	`jbd3_jouº®_g‘_desütÜ_bufãr
(

608 
comm™_Œª§ùiÚ
,

609 
JBD3_DESCRIPTOR_BLOCK
);

610 ià(!
desütÜ
) {

611 
	`jbd3_jouº®_abÜt
(
jouº®
, -
EIO
);

615 
	`jbd_debug
(4, "JBD3: got buffer %llu (%p)\n",

616 ()
desütÜ
->
b_blockÄ
,

617 
desütÜ
->
b_d©a
);

618 
gp
 = &
desütÜ
->
b_d©a
[(
jouº®_h—d”_t
)];

619 
¥aû_Ëá
 = 
desütÜ
->
b_size
 -

620 (
jouº®_h—d”_t
);

621 
fœ¡_g
 = 1;

622 
	`£t_bufãr_jwr™e
(
desütÜ
);

623 
	`£t_bufãr_dœty
(
desütÜ
);

624 
wbuf
[
bufs
++] = 
desütÜ
;

628 
	`BUFFER_TRACE
(
desütÜ
, "ph3: file‡s descriptor");

629 
	`jbd3_fe_log_bh
(&
log_bufs
, 
desütÜ
);

634 
”r
 = 
	`jbd3_jouº®_Ãxt_log_block
(
jouº®
, &
blockÄ
);

638 ià(
”r
) {

639 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

648 
	`©omic_dec
(&
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

653 
	`©omic_šc
(&
	`jh2bh
(
jh
)->
b_couÁ
);

659 
	`£t_b™
(
BH_JWr™e
, &
	`jh2bh
(
jh
)->
b_¡©e
);

660 
	`JBUFFER_TRACE
(
jh
, "ph3: write metadata");

661 
æags
 = 
	`jbd3_jouº®_wr™e_m‘ad©a_bufãr
(
comm™_Œª§ùiÚ
,

662 
jh
, &
wbuf
[
bufs
], 
blockÄ
);

663 ià(
æags
 < 0) {

664 
	`jbd3_jouº®_abÜt
(
jouº®
, 
æags
);

667 
	`jbd3_fe_log_bh
(&
io_bufs
, 
wbuf
[
bufs
]);

672 
g_æag
 = 0;

673 ià(
æags
 & 1)

674 
g_æag
 |ğ
JBD3_FLAG_ESCAPE
;

675 ià(!
fœ¡_g
)

676 
g_æag
 |ğ
JBD3_FLAG_SAME_UUID
;

678 
g
 = (
jouº®_block_g_t
 *è
gp
;

679 
	`wr™e_g_block
(
jouº®
, 
g
, 
	`jh2bh
(
jh
)->
b_blockÄ
);

680 
g
->
t_æags
 = 
	`ıu_to_be16
(
g_æag
);

681 
	`jbd3_block_g_csum_£t
(
jouº®
, 
g
, 
wbuf
[
bufs
],

682 
comm™_Œª§ùiÚ
->
t_tid
);

683 
gp
 +ğ
g_by‹s
;

684 
¥aû_Ëá
 -ğ
g_by‹s
;

685 
bufs
++;

687 ià(
fœ¡_g
) {

688 
	`memıy
 (
gp
, 
jouº®
->
j_uuid
, 16);

689 
gp
 += 16;

690 
¥aû_Ëá
 -= 16;

691 
fœ¡_g
 = 0;

697 ià(
bufs
 =ğ
jouº®
->
j_wbufsize
 ||

698 
comm™_Œª§ùiÚ
->
t_bufãrs
 =ğ
NULL
 ||

699 
¥aû_Ëá
 < 
g_by‹s
 + 16 + 
csum_size
) {

701 
	`jbd_debug
(4, "JBD3: Subm™ %d IOs\n", 
bufs
);

707 
g
->
t_æags
 |ğ
	`ıu_to_be16
(
JBD3_FLAG_LAST_TAG
);

708 
¡¬t_jouº®_io
:

709 ià(
desütÜ
)

710 
	`jbd3_desütÜ_block_csum_£t
(
jouº®
,

711 
desütÜ
);

713 
i
 = 0; i < 
bufs
; i++) {

714 
bufãr_h—d
 *
bh
 = 
wbuf
[
i
];

718 ià(
	`jbd3_has_ã©u»_checksum
(
jouº®
)) {

719 
üc32_sum
 =

720 
	`jbd3_checksum_d©a
(
üc32_sum
, 
bh
);

723 
	`lock_bufãr
(
bh
);

724 
	`ş—r_bufãr_dœty
(
bh
);

725 
	`£t_bufãr_u±od©e
(
bh
);

726 
bh
->
b_’d_io
 = 
jouº®_’d_bufãr_io_sync
;

727 
	`subm™_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
, 
bh
);

729 
	`cÚd_»sched
();

730 
¡©s
.
run
.
rs_blocks_logged
 +ğ
bufs
;

734 
desütÜ
 = 
NULL
;

735 
bufs
 = 0;

739 
”r
 = 
	`jouº®_fšish_šode_d©a_bufãrs
(
jouº®
, 
comm™_Œª§ùiÚ
);

740 ià(
”r
) {

741 
	`´štk
(
KERN_WARNING


743 "Ú %s\n", 
jouº®
->
j_devÇme
);

744 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT_ON_SYNCDATA_ERR
)

745 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

746 
”r
 = 0;

756 
upd©e_
 =

757 
	`jbd3_jouº®_g‘_log_
(
jouº®
, &
fœ¡_tid
, &
fœ¡_block
);

759 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

760 ià(
upd©e_
) {

761 
ä“d
 = 
fœ¡_block
 - 
jouº®
->
j_
;

763 ià(
fœ¡_block
 < 
jouº®
->
j_
)

764 
ä“d
 +ğ
jouº®
->
j_Ï¡
 - jouº®->
j_fœ¡
;

766 ià(
ä“d
 < 
jouº®
->
j_maxËn
 / 4)

767 
upd©e_
 = 0;

769 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_¡©e
 =ğ
T_COMMIT
);

770 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_COMMIT_DFLUSH
;

771 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

778 ià(
comm™_Œª§ùiÚ
->
t_Ãed_d©a_æush
 &&

779 (
jouº®
->
j_fs_dev
 !ğjouº®->
j_dev
) &&

780 (
jouº®
->
j_æags
 & 
JBD3_BARRIER
))

781 
	`blkdev_issue_æush
(
jouº®
->
j_fs_dev
, 
GFP_NOFS
, 
NULL
);

784 ià(
	`jbd3_has_ã©u»_async_comm™
(
jouº®
)) {

785 
”r
 = 
	`jouº®_subm™_comm™_»cÜd
(
jouº®
, 
comm™_Œª§ùiÚ
,

786 &
cbh
, 
üc32_sum
);

787 ià(
”r
)

788 
	`__jbd3_jouº®_abÜt_h¬d
(
jouº®
);

791 
	`blk_fšish_¶ug
(&
¶ug
);

804 
	`jbd_debug
(3, "JBD3: commit…hase 3\n");

806 !
	`li¡_em±y
(&
io_bufs
)) {

807 
bufãr_h—d
 *
bh
 = 
	`li¡_’Œy
(
io_bufs
.
´ev
,

808 
bufãr_h—d
,

809 
b_assoc_bufãrs
);

811 
	`wa™_Ú_bufãr
(
bh
);

812 
	`cÚd_»sched
();

814 ià(
	`uÆik–y
(!
	`bufãr_u±od©e
(
bh
)))

815 
”r
 = -
EIO
;

816 
	`jbd3_unfe_log_bh
(
bh
);

822 
	`BUFFER_TRACE
(
bh
, "dumpingemporary bh");

823 
	`__b»l£
(
bh
);

824 
	`J_ASSERT_BH
(
bh
, 
	`©omic_»ad
(&bh->
b_couÁ
) == 0);

825 
	`ä“_bufãr_h—d
(
bh
);

828 
jh
 = 
comm™_Œª§ùiÚ
->
t_shadow_li¡
->
b_»v
;

829 
bh
 = 
	`jh2bh
(
jh
);

830 
	`ş—r_bufãr_jwr™e
(
bh
);

831 
	`J_ASSERT_BH
(
bh
, 
	`bufãr_jbddœty
(bh));

832 
	`J_ASSERT_BH
(
bh
, !
	`bufãr_shadow
(bh));

838 
	`JBUFFER_TRACE
(
jh
, "file‡s BJ_Forget");

839 
	`jbd3_jouº®_fe_bufãr
(
jh
, 
comm™_Œª§ùiÚ
, 
BJ_FÜg‘
);

840 
	`JBUFFER_TRACE
(
jh
, "brelse shadowed buffer");

841 
	`__b»l£
(
bh
);

844 
	`J_ASSERT
 (
comm™_Œª§ùiÚ
->
t_shadow_li¡
 =ğ
NULL
);

846 
	`jbd_debug
(3, "JBD3: commit…hase 4\n");

849 !
	`li¡_em±y
(&
log_bufs
)) {

850 
bufãr_h—d
 *
bh
;

852 
bh
 = 
	`li¡_’Œy
(
log_bufs
.
´ev
, 
bufãr_h—d
, 
b_assoc_bufãrs
);

853 
	`wa™_Ú_bufãr
(
bh
);

854 
	`cÚd_»sched
();

856 ià(
	`uÆik–y
(!
	`bufãr_u±od©e
(
bh
)))

857 
”r
 = -
EIO
;

859 
	`BUFFER_TRACE
(
bh
, "ph5: control buffer writeout done: unfile");

860 
	`ş—r_bufãr_jwr™e
(
bh
);

861 
	`jbd3_unfe_log_bh
(
bh
);

862 
	`__b»l£
(
bh
);

866 ià(
”r
)

867 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

869 
	`jbd_debug
(3, "JBD3: commit…hase 5\n");

870 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

871 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_¡©e
 =ğ
T_COMMIT_DFLUSH
);

872 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_COMMIT_JFLUSH
;

873 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

875 ià(!
	`jbd3_has_ã©u»_async_comm™
(
jouº®
)) {

876 
”r
 = 
	`jouº®_subm™_comm™_»cÜd
(
jouº®
, 
comm™_Œª§ùiÚ
,

877 &
cbh
, 
üc32_sum
);

878 ià(
”r
)

879 
	`__jbd3_jouº®_abÜt_h¬d
(
jouº®
);

881 ià(
cbh
)

882 
”r
 = 
	`jouº®_wa™_Ú_comm™_»cÜd
(
jouº®
, 
cbh
);

883 ià(
	`jbd3_has_ã©u»_async_comm™
(
jouº®
) &&

884 
jouº®
->
j_æags
 & 
JBD3_BARRIER
) {

885 
	`blkdev_issue_æush
(
jouº®
->
j_dev
, 
GFP_NOFS
, 
NULL
);

888 ià(
”r
)

889 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

896 ià(
upd©e_
)

897 
	`jbd3_upd©e_log_
(
jouº®
, 
fœ¡_tid
, 
fœ¡_block
);

904 
	`jbd_debug
(3, "JBD3: commit…hase 6\n");

906 
	`J_ASSERT
(
	`li¡_em±y
(&
comm™_Œª§ùiÚ
->
t_šode_li¡
));

907 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_bufãrs
 =ğ
NULL
);

908 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
NULL
);

909 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_shadow_li¡
 =ğ
NULL
);

911 
»¡¬t_loİ
:

916 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

917 
comm™_Œª§ùiÚ
->
t_fÜg‘
) {

918 
Œª§ùiÚ_t
 *
ı_Œª§ùiÚ
;

919 
bufãr_h—d
 *
bh
;

920 
Œy_to_ä“
 = 0;

922 
jh
 = 
comm™_Œª§ùiÚ
->
t_fÜg‘
;

923 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

924 
bh
 = 
	`jh2bh
(
jh
);

929 
	`g‘_bh
(
bh
);

930 
	`jbd_lock_bh_¡©e
(
bh
);

931 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
comm™_Œª§ùiÚ
);

946 ià(
jh
->
b_comm™‹d_d©a
) {

947 
	`jbd3_ä“
(
jh
->
b_comm™‹d_d©a
, 
bh
->
b_size
);

948 
jh
->
b_comm™‹d_d©a
 = 
NULL
;

949 ià(
jh
->
b_äoz’_d©a
) {

950 
jh
->
b_comm™‹d_d©a
 = jh->
b_äoz’_d©a
;

951 
jh
->
b_äoz’_d©a
 = 
NULL
;

952 
jh
->
b_äoz’_Œigg”s
 = 
NULL
;

954 } ià(
jh
->
b_äoz’_d©a
) {

955 
	`jbd3_ä“
(
jh
->
b_äoz’_d©a
, 
bh
->
b_size
);

956 
jh
->
b_äoz’_d©a
 = 
NULL
;

957 
jh
->
b_äoz’_Œigg”s
 = 
NULL
;

960 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

961 
ı_Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
;

962 ià(
ı_Œª§ùiÚ
) {

963 
	`JBUFFER_TRACE
(
jh
, "remove from old cpransaction");

964 
ı_Œª§ùiÚ
->
t_chp_¡©s
.
cs_drİ³d
++;

965 
	`__jbd3_jouº®_»move_checkpošt
(
jh
);

978 ià(
	`bufãr_ä“d
(
bh
)) {

994 
jh
->
b_modif›d
 = 0;

995 ià(!
jh
->
b_Ãxt_Œª§ùiÚ
) {

996 
	`ş—r_bufãr_ä“d
(
bh
);

997 
	`ş—r_bufãr_jbddœty
(
bh
);

998 
	`ş—r_bufãr_m­³d
(
bh
);

999 
	`ş—r_bufãr_Ãw
(
bh
);

1000 
	`ş—r_bufãr_»q
(
bh
);

1001 
bh
->
b_bdev
 = 
NULL
;

1005 ià(
	`bufãr_jbddœty
(
bh
)) {

1006 
	`JBUFFER_TRACE
(
jh
, "addo‚ew checkpointingrans");

1007 
	`__jbd3_jouº®_š£¹_checkpošt
(
jh
, 
comm™_Œª§ùiÚ
);

1008 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

1009 
	`ş—r_bufãr_jbddœty
(
bh
);

1011 
	`J_ASSERT_BH
(
bh
, !
	`bufãr_dœty
(bh));

1021 ià(!
jh
->
b_Ãxt_Œª§ùiÚ
)

1022 
Œy_to_ä“
 = 1;

1024 
	`JBUFFER_TRACE
(
jh
, "refile or unfile buffer");

1025 
	`__jbd3_jouº®_»fe_bufãr
(
jh
);

1026 
	`jbd_uÆock_bh_¡©e
(
bh
);

1027 ià(
Œy_to_ä“
)

1028 
	`»Ëa£_bufãr_·ge
(
bh
);

1030 
	`__b»l£
(
bh
);

1031 
	`cÚd_»sched_lock
(&
jouº®
->
j_li¡_lock
);

1033 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1040 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1041 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1046 ià(
comm™_Œª§ùiÚ
->
t_fÜg‘
) {

1047 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1048 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1049 
»¡¬t_loİ
;

1055 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 =ğ
NULL
) {

1056 
jouº®
->
j_checkpošt_Œª§ùiÚs
 = 
comm™_Œª§ùiÚ
;

1057 
comm™_Œª§ùiÚ
->
t_ıÃxt
 = commit_transaction;

1058 
comm™_Œª§ùiÚ
->
t_ı´ev
 = commit_transaction;

1060 
comm™_Œª§ùiÚ
->
t_ıÃxt
 =

1061 
jouº®
->
j_checkpošt_Œª§ùiÚs
;

1062 
comm™_Œª§ùiÚ
->
t_ı´ev
 =

1063 
comm™_Œª§ùiÚ
->
t_ıÃxt
->
t_ı´ev
;

1064 
comm™_Œª§ùiÚ
->
t_ıÃxt
->
t_ı´ev
 =

1065 
comm™_Œª§ùiÚ
;

1066 
comm™_Œª§ùiÚ
->
t_ı´ev
->
t_ıÃxt
 =

1067 
comm™_Œª§ùiÚ
;

1069 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1073 
	`jbd_debug
(3, "JBD3: commit…hase 7\n");

1075 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_¡©e
 =ğ
T_COMMIT_JFLUSH
);

1077 
comm™_Œª§ùiÚ
->
t_¡¬t
 = 
jiff›s
;

1078 
¡©s
.
run
.
rs_loggšg
 = 
	`jbd3_time_diff
(stats.run.rs_logging,

1079 
comm™_Œª§ùiÚ
->
t_¡¬t
);

1084 
¡©s
.
ts_tid
 = 
comm™_Œª§ùiÚ
->
t_tid
;

1085 
¡©s
.
run
.
rs_hªdË_couÁ
 =

1086 
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_hªdË_couÁ
);

1087 
	`Œaû_jbd3_run_¡©s
(
jouº®
->
j_fs_dev
->
bd_dev
,

1088 
comm™_Œª§ùiÚ
->
t_tid
, &
¡©s
.
run
);

1089 
¡©s
.
ts_»que¡ed
 = (
comm™_Œª§ùiÚ
->
t_»que¡ed
) ? 1 : 0;

1091 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_COMMIT_CALLBACK
;

1092 
	`J_ASSERT
(
comm™_Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

1093 
jouº®
->
j_comm™_£qu’û
 = 
comm™_Œª§ùiÚ
->
t_tid
;

1094 
jouº®
->
j_comm™tšg_Œª§ùiÚ
 = 
NULL
;

1095 
comm™_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_g‘
(), 
¡¬t_time
));

1101 ià(
	`lik–y
(
jouº®
->
j_av”age_comm™_time
))

1102 
jouº®
->
j_av”age_comm™_time
 = (
comm™_time
 +

1103 
jouº®
->
j_av”age_comm™_time
*3) / 4;

1105 
jouº®
->
j_av”age_comm™_time
 = 
comm™_time
;

1107 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1109 ià(
jouº®
->
j_comm™_ÿÎback
)

1110 
jouº®
->
	`j_comm™_ÿÎback
(jouº®, 
comm™_Œª§ùiÚ
);

1112 
	`Œaû_jbd3_’d_comm™
(
jouº®
, 
comm™_Œª§ùiÚ
);

1113 
	`jbd_debug
(1, "JBD3: commit %d complete, head %d\n",

1114 
jouº®
->
j_comm™_£qu’û
, jouº®->
j__£qu’û
);

1116 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1117 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1118 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_FINISHED
;

1120 ià(
comm™_Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
NULL
 &&

1121 
comm™_Œª§ùiÚ
->
t_checkpošt_io_li¡
 =ğ
NULL
) {

1122 
	`__jbd3_jouº®_drİ_Œª§ùiÚ
(
jouº®
, 
comm™_Œª§ùiÚ
);

1123 
	`jbd3_jouº®_ä“_Œª§ùiÚ
(
comm™_Œª§ùiÚ
);

1125 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1126 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1127 
	`wake_up
(&
jouº®
->
j_wa™_dÚe_comm™
);

1132 
	`¥š_lock
(&
jouº®
->
j_hi¡Üy_lock
);

1133 
jouº®
->
j_¡©s
.
ts_tid
++;

1134 
jouº®
->
j_¡©s
.
ts_»que¡ed
 +ğ
¡©s
.ts_requested;

1135 
jouº®
->
j_¡©s
.
run
.
rs_wa™
 +ğ
¡©s
.run.rs_wait;

1136 
jouº®
->
j_¡©s
.
run
.
rs_»que¡_d–ay
 +ğ
¡©s
.run.rs_request_delay;

1137 
jouº®
->
j_¡©s
.
run
.
rs_ruÂšg
 +ğ
¡©s
.run.rs_running;

1138 
jouº®
->
j_¡©s
.
run
.
rs_locked
 +ğ
¡©s
.run.rs_locked;

1139 
jouº®
->
j_¡©s
.
run
.
rs_æushšg
 +ğ
¡©s
.run.rs_flushing;

1140 
jouº®
->
j_¡©s
.
run
.
rs_loggšg
 +ğ
¡©s
.run.rs_logging;

1141 
jouº®
->
j_¡©s
.
run
.
rs_hªdË_couÁ
 +ğ
¡©s
.run.rs_handle_count;

1142 
jouº®
->
j_¡©s
.
run
.
rs_blocks
 +ğ
¡©s
.run.rs_blocks;

1143 
jouº®
->
j_¡©s
.
run
.
rs_blocks_logged
 +ğ
¡©s
.run.rs_blocks_logged;

1144 
	`¥š_uÆock
(&
jouº®
->
j_hi¡Üy_lock
);

1145 
	}
}

	@journal.c

22 
	~<lšux/moduË.h
>

23 
	~<lšux/time.h
>

24 
	~<lšux/fs.h
>

25 
	~<lšux/jbd3.h
>

26 
	~<lšux/”ºo.h
>

27 
	~<lšux/¦ab.h
>

28 
	~<lšux/š™.h
>

29 
	~<lšux/mm.h
>

30 
	~<lšux/ä“z”.h
>

31 
	~<lšux/·gem­.h
>

32 
	~<lšux/kth»ad.h
>

33 
	~<lšux/poisÚ.h
>

34 
	~<lšux/´oc_fs.h
>

35 
	~<lšux/£q_fe.h
>

36 
	~<lšux/m©h64.h
>

37 
	~<lšux/hash.h
>

38 
	~<lšux/log2.h
>

39 
	~<lšux/vm®loc.h
>

40 
	~<lšux/backšg-dev.h
>

41 
	~<lšux/b™İs.h
>

42 
	~<lšux/¿‹lim™.h
>

43 
	~<lšux/sched/mm.h
>

45 
	#CREATE_TRACE_POINTS


	)

46 
	~<Œaû/ev’ts/jbd3.h
>

48 
	~<lšux/uacûss.h
>

49 
	~<asm/·ge.h
>

51 #ifdeà
CONFIG_JBD3_DEBUG


52 
ushÜt
 
jbd3_jouº®_’abË_debug
 
	g__»ad_mo¡ly
;

53 
EXPORT_SYMBOL
(
jbd3_jouº®_’abË_debug
);

55 
moduË_·¿m_Çmed
(
jbd3_debug
, 
jbd3_jouº®_’abË_debug
, 
ushÜt
, 0644);

56 
MODULE_PARM_DESC
(
jbd3_debug
, "Debugging†evel for jbd3");

59 
EXPORT_SYMBOL
(
jbd3_jouº®_ex‹nd
);

60 
EXPORT_SYMBOL
(
jbd3_jouº®_¡İ
);

61 
EXPORT_SYMBOL
(
jbd3_jouº®_lock_upd©es
);

62 
EXPORT_SYMBOL
(
jbd3_jouº®_uÆock_upd©es
);

63 
EXPORT_SYMBOL
(
jbd3_jouº®_g‘_wr™e_acûss
);

64 
EXPORT_SYMBOL
(
jbd3_jouº®_g‘_ü—‹_acûss
);

65 
EXPORT_SYMBOL
(
jbd3_jouº®_g‘_undo_acûss
);

66 
EXPORT_SYMBOL
(
jbd3_jouº®_£t_Œigg”s
);

67 
EXPORT_SYMBOL
(
jbd3_jouº®_dœty_m‘ad©a
);

68 
EXPORT_SYMBOL
(
jbd3_jouº®_fÜg‘
);

69 
EXPORT_SYMBOL
(
jbd3_jouº®_æush
);

70 
EXPORT_SYMBOL
(
jbd3_jouº®_»voke
);

72 
EXPORT_SYMBOL
(
jbd3_jouº®_š™_dev
);

73 
EXPORT_SYMBOL
(
jbd3_jouº®_š™_šode
);

74 
EXPORT_SYMBOL
(
jbd3_jouº®_check_u£d_ã©u»s
);

75 
EXPORT_SYMBOL
(
jbd3_jouº®_check_avaabË_ã©u»s
);

76 
EXPORT_SYMBOL
(
jbd3_jouº®_£t_ã©u»s
);

77 
EXPORT_SYMBOL
(
jbd3_jouº®_lßd
);

78 
EXPORT_SYMBOL
(
jbd3_jouº®_de¡roy
);

79 
EXPORT_SYMBOL
(
jbd3_jouº®_abÜt
);

80 
EXPORT_SYMBOL
(
jbd3_jouº®_”ºo
);

81 
EXPORT_SYMBOL
(
jbd3_jouº®_ack_”r
);

82 
EXPORT_SYMBOL
(
jbd3_jouº®_ş—r_”r
);

83 
EXPORT_SYMBOL
(
jbd3_log_wa™_comm™
);

84 
EXPORT_SYMBOL
(
jbd3_log_¡¬t_comm™
);

85 
EXPORT_SYMBOL
(
jbd3_jouº®_¡¬t_comm™
);

86 
EXPORT_SYMBOL
(
jbd3_jouº®_fÜû_comm™_Ã¡ed
);

87 
EXPORT_SYMBOL
(
jbd3_jouº®_we
);

88 
EXPORT_SYMBOL
(
jbd3_jouº®_blocks_³r_·ge
);

89 
EXPORT_SYMBOL
(
jbd3_jouº®_šv®id©•age
);

90 
EXPORT_SYMBOL
(
jbd3_jouº®_Œy_to_ä“_bufãrs
);

91 
EXPORT_SYMBOL
(
jbd3_jouº®_fÜû_comm™
);

92 
EXPORT_SYMBOL
(
jbd3_jouº®_šode_¿nged_wr™e
);

93 
EXPORT_SYMBOL
(
jbd3_jouº®_šode_¿nged_wa™
);

94 
EXPORT_SYMBOL
(
jbd3_jouº®_š™_jbd_šode
);

95 
EXPORT_SYMBOL
(
jbd3_jouº®_»Ëa£_jbd_šode
);

96 
EXPORT_SYMBOL
(
jbd3_jouº®_begš_Üd”ed_Œunÿ‹
);

97 
EXPORT_SYMBOL
(
jbd3_šode_ÿche
);

99 
__jouº®_abÜt_soá
 (
jouº®_t
 *
jouº®
, 
”ºo
);

100 
jbd3_jouº®_ü—‹_¦ab
(
size_t
 
¦ab_size
);

102 #ifdeà
CONFIG_JBD3_DEBUG


103 
	$__jbd3_debug
(
Ëv–
, cÚ¡ *
fe
, cÚ¡ *
func
,

104 
lše
, cÚ¡ *
fmt
, ...)

106 
va_fÜm©
 
vaf
;

107 
va_li¡
 
¬gs
;

109 ià(
Ëv–
 > 
jbd3_jouº®_’abË_debug
)

111 
	`va_¡¬t
(
¬gs
, 
fmt
);

112 
vaf
.
fmt
 = fmt;

113 
vaf
.
va
 = &
¬gs
;

114 
	`´štk
(
KERN_DEBUG
 "%s: (%s, %u): %pV", 
fe
, 
func
, 
lše
, &
vaf
);

115 
	`va_’d
(
¬gs
);

116 
	}
}

117 
EXPORT_SYMBOL
(
__jbd3_debug
);

121 
	$jbd3_v”ify_csum_ty³
(
jouº®_t
 *
j
, 
jouº®_su³rblock_t
 *
sb
)

123 ià(!
	`jbd3_jouº®_has_csum_v2Ü3_ã©u»
(
j
))

126  
sb
->
s_checksum_ty³
 =ğ
JBD3_CRC32C_CHKSUM
;

127 
	}
}

129 
__be32
 
	$jbd3_su³rblock_csum
(
jouº®_t
 *
j
, 
jouº®_su³rblock_t
 *
sb
)

131 
__u32
 
csum
;

132 
__be32
 
Şd_csum
;

134 
Şd_csum
 = 
sb
->
s_checksum
;

135 
sb
->
s_checksum
 = 0;

136 
csum
 = 
	`jbd3_chksum
(
j
, ~0, (*)
sb
, (
jouº®_su³rblock_t
));

137 
sb
->
s_checksum
 = 
Şd_csum
;

139  
	`ıu_to_be32
(
csum
);

140 
	}
}

146 
	$comm™_timeout
(
tim”_li¡
 *
t
)

148 
jouº®_t
 *
jouº®
 = 
	`äom_tim”
(jouº®, 
t
, 
j_comm™_tim”
);

150 
	`wake_up_´oûss
(
jouº®
->
j_sk
);

151 
	}
}

169 
	$kjouº®d2
(*
¬g
)

171 
jouº®_t
 *
jouº®
 = 
¬g
;

172 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

178 
	`tim”_£tup
(&
jouº®
->
j_comm™_tim”
, 
comm™_timeout
, 0);

180 
	`£t_ä“zabË
();

183 
jouº®
->
j_sk
 = 
cu¼’t
;

184 
	`wake_up
(&
jouº®
->
j_wa™_dÚe_comm™
);

192 
	`mem®loc_nofs_§ve
();

197 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

199 
loİ
:

200 ià(
jouº®
->
j_æags
 & 
JBD3_UNMOUNT
)

201 
’d_loİ
;

203 
	`jbd_debug
(1, "commit_sequence=%u, commit_request=%u\n",

204 
jouº®
->
j_comm™_£qu’û
, jouº®->
j_comm™_»que¡
);

206 ià(
jouº®
->
j_comm™_£qu’û
 !ğjouº®->
j_comm™_»que¡
) {

207 
	`jbd_debug
(1, "OK,„equests differ\n");

208 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

209 
	`d–_tim”_sync
(&
jouº®
->
j_comm™_tim”
);

210 
	`jbd3_jouº®_comm™_Œª§ùiÚ
(
jouº®
);

211 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

212 
loİ
;

215 
	`wake_up
(&
jouº®
->
j_wa™_dÚe_comm™
);

216 ià(
	`ä“zšg
(
cu¼’t
)) {

222 
	`jbd_debug
(1, "Now suspending kjournald2\n");

223 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

224 
	`Œy_to_ä“ze
();

225 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

231 
	`DEFINE_WAIT
(
wa™
);

232 
should_¦“p
 = 1;

234 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_comm™
, &
wa™
,

235 
TASK_INTERRUPTIBLE
);

236 ià(
jouº®
->
j_comm™_£qu’û
 !ğjouº®->
j_comm™_»que¡
)

237 
should_¦“p
 = 0;

238 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

239 ià(
Œª§ùiÚ
 && 
	`time_aá”_eq
(
jiff›s
,

240 
Œª§ùiÚ
->
t_expœes
))

241 
should_¦“p
 = 0;

242 ià(
jouº®
->
j_æags
 & 
JBD3_UNMOUNT
)

243 
should_¦“p
 = 0;

244 ià(
should_¦“p
) {

245 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

246 
	`scheduË
();

247 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

249 
	`fšish_wa™
(&
jouº®
->
j_wa™_comm™
, &
wa™
);

252 
	`jbd_debug
(1, "kjournald2 wakes\n");

257 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

258 ià(
Œª§ùiÚ
 && 
	`time_aá”_eq
(
jiff›s
,¿n§ùiÚ->
t_expœes
)) {

259 
jouº®
->
j_comm™_»que¡
 = 
Œª§ùiÚ
->
t_tid
;

260 
	`jbd_debug
(1, "woke because ofimeout\n");

262 
loİ
;

264 
’d_loİ
:

265 
	`d–_tim”_sync
(&
jouº®
->
j_comm™_tim”
);

266 
jouº®
->
j_sk
 = 
NULL
;

267 
	`wake_up
(&
jouº®
->
j_wa™_dÚe_comm™
);

268 
	`jbd_debug
(1, "Journalhreadƒxiting.\n");

269 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

271 
	}
}

273 
	$jbd3_jouº®_¡¬t_th»ad
(
jouº®_t
 *
jouº®
)

275 
sk_¡ruù
 *
t
;

277 
t
 = 
	`kth»ad_run
(
kjouº®d2
, 
jouº®
, "jbd3/%s",

278 
jouº®
->
j_devÇme
);

279 ià(
	`IS_ERR
(
t
))

280  
	`PTR_ERR
(
t
);

282 
	`wa™_ev’t
(
jouº®
->
j_wa™_dÚe_comm™
, jouº®->
j_sk
 !ğ
NULL
);

284 
	}
}

286 
	$jouº®_kl_th»ad
(
jouº®_t
 *
jouº®
)

288 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

289 
jouº®
->
j_æags
 |ğ
JBD3_UNMOUNT
;

291 
jouº®
->
j_sk
) {

292 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

293 
	`wake_up
(&
jouº®
->
j_wa™_comm™
);

294 
	`wa™_ev’t
(
jouº®
->
j_wa™_dÚe_comm™
, jouº®->
j_sk
 =ğ
NULL
);

295 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

297 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

298 
	}
}

335 
	$jbd3_jouº®_wr™e_m‘ad©a_bufãr
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
,

336 
jouº®_h—d
 *
jh_š
,

337 
bufãr_h—d
 **
bh_out
,

338 
£ùÜ_t
 
blockÄ
)

340 
Ãed_cİy_out
 = 0;

341 
dÚe_cİy_out
 = 0;

342 
do_esÿ³
 = 0;

343 *
m­³d_d©a
;

344 
bufãr_h—d
 *
Ãw_bh
;

345 
·ge
 *
Ãw_·ge
;

346 
Ãw_off£t
;

347 
bufãr_h—d
 *
bh_š
 = 
	`jh2bh
(
jh_š
);

348 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

359 
	`J_ASSERT_BH
(
bh_š
, 
	`bufãr_jbddœty
(bh_in));

361 
Ãw_bh
 = 
	`®loc_bufãr_h—d
(
GFP_NOFS
|
__GFP_NOFAIL
);

364 
	`©omic_£t
(&
Ãw_bh
->
b_couÁ
, 1);

366 
	`jbd_lock_bh_¡©e
(
bh_š
);

367 
»³©
:

372 ià(
jh_š
->
b_äoz’_d©a
) {

373 
dÚe_cİy_out
 = 1;

374 
Ãw_·ge
 = 
	`vœt_to_·ge
(
jh_š
->
b_äoz’_d©a
);

375 
Ãw_off£t
 = 
	`off£t_š_·ge
(
jh_š
->
b_äoz’_d©a
);

377 
Ãw_·ge
 = 
	`jh2bh
(
jh_š
)->
b_·ge
;

378 
Ãw_off£t
 = 
	`off£t_š_·ge
(
	`jh2bh
(
jh_š
)->
b_d©a
);

381 
m­³d_d©a
 = 
	`km­_©omic
(
Ãw_·ge
);

388 ià(!
dÚe_cİy_out
)

389 
	`jbd3_bufãr_äoz’_Œigg”
(
jh_š
, 
m­³d_d©a
 + 
Ãw_off£t
,

390 
jh_š
->
b_Œigg”s
);

395 ià(*((
__be32
 *)(
m­³d_d©a
 + 
Ãw_off£t
)) ==

396 
	`ıu_to_be32
(
JBD3_MAGIC_NUMBER
)) {

397 
Ãed_cİy_out
 = 1;

398 
do_esÿ³
 = 1;

400 
	`kunm­_©omic
(
m­³d_d©a
);

405 ià(
Ãed_cİy_out
 && !
dÚe_cİy_out
) {

406 *
tmp
;

408 
	`jbd_uÆock_bh_¡©e
(
bh_š
);

409 
tmp
 = 
	`jbd3_®loc
(
bh_š
->
b_size
, 
GFP_NOFS
);

410 ià(!
tmp
) {

411 
	`b»l£
(
Ãw_bh
);

412  -
ENOMEM
;

414 
	`jbd_lock_bh_¡©e
(
bh_š
);

415 ià(
jh_š
->
b_äoz’_d©a
) {

416 
	`jbd3_ä“
(
tmp
, 
bh_š
->
b_size
);

417 
»³©
;

420 
jh_š
->
b_äoz’_d©a
 = 
tmp
;

421 
m­³d_d©a
 = 
	`km­_©omic
(
Ãw_·ge
);

422 
	`memıy
(
tmp
, 
m­³d_d©a
 + 
Ãw_off£t
, 
bh_š
->
b_size
);

423 
	`kunm­_©omic
(
m­³d_d©a
);

425 
Ãw_·ge
 = 
	`vœt_to_·ge
(
tmp
);

426 
Ãw_off£t
 = 
	`off£t_š_·ge
(
tmp
);

427 
dÚe_cİy_out
 = 1;

434 
jh_š
->
b_äoz’_Œigg”s
 = jh_š->
b_Œigg”s
;

441 ià(
do_esÿ³
) {

442 
m­³d_d©a
 = 
	`km­_©omic
(
Ãw_·ge
);

443 *((*)(
m­³d_d©a
 + 
Ãw_off£t
)) = 0;

444 
	`kunm­_©omic
(
m­³d_d©a
);

447 
	`£t_bh_·ge
(
Ãw_bh
, 
Ãw_·ge
, 
Ãw_off£t
);

448 
Ãw_bh
->
b_size
 = 
bh_š
->b_size;

449 
Ãw_bh
->
b_bdev
 = 
jouº®
->
j_dev
;

450 
Ãw_bh
->
b_blockÄ
 = 
blockÄ
;

451 
Ãw_bh
->
b_´iv©e
 = 
bh_š
;

452 
	`£t_bufãr_m­³d
(
Ãw_bh
);

453 
	`£t_bufãr_dœty
(
Ãw_bh
);

455 *
bh_out
 = 
Ãw_bh
;

462 
	`JBUFFER_TRACE
(
jh_š
, "file‡s BJ_Shadow");

463 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

464 
	`__jbd3_jouº®_fe_bufãr
(
jh_š
, 
Œª§ùiÚ
, 
BJ_Shadow
);

465 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

466 
	`£t_bufãr_shadow
(
bh_š
);

467 
	`jbd_uÆock_bh_¡©e
(
bh_š
);

469  
do_esÿ³
 | (
dÚe_cİy_out
 << 1);

470 
	}
}

481 
	$__jbd3_log_¡¬t_comm™
(
jouº®_t
 *
jouº®
, 
tid_t
 
rg‘
)

484 ià(
jouº®
->
j_comm™_»que¡
 =ğ
rg‘
)

492 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 &&

493 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 =ğ
rg‘
) {

499 
jouº®
->
j_comm™_»que¡
 = 
rg‘
;

500 
	`jbd_debug
(1, "JBD3:„equesting commit %u/%u\n",

501 
jouº®
->
j_comm™_»que¡
,

502 
jouº®
->
j_comm™_£qu’û
);

503 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_»que¡ed
 = 
jiff›s
;

504 
	`wake_up
(&
jouº®
->
j_wa™_comm™
);

506 } ià(!
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
rg‘
))

510 
	`WARN_ONCE
(1, "JBD3: bad†og_start_commit: %u %u %u %u\n",

511 
jouº®
->
j_comm™_»que¡
,

512 
jouº®
->
j_comm™_£qu’û
,

513 
rg‘
, 
jouº®
->
j_ruÂšg_Œª§ùiÚ
 ?

514 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 : 0);

516 
	}
}

518 
	$jbd3_log_¡¬t_comm™
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

520 
»t
;

522 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

523 
»t
 = 
	`__jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

524 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

525  
»t
;

526 
	}
}

535 
	$__jbd3_jouº®_fÜû_comm™
(
jouº®_t
 *
jouº®
)

537 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
NULL
;

538 
tid_t
 
tid
;

539 
Ãed_to_¡¬t
 = 0, 
»t
 = 0;

541 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

542 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 && !
cu¼’t
->
jouº®_šfo
) {

543 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

544 ià(!
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
Œª§ùiÚ
->
t_tid
))

545 
Ãed_to_¡¬t
 = 1;

546 } ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
)

547 
Œª§ùiÚ
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

549 ià(!
Œª§ùiÚ
) {

551 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

554 
tid
 = 
Œª§ùiÚ
->
t_tid
;

555 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

556 ià(
Ãed_to_¡¬t
)

557 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

558 
»t
 = 
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

559 ià(!
»t
)

560 
»t
 = 1;

562  
»t
;

563 
	}
}

573 
	$jbd3_jouº®_fÜû_comm™_Ã¡ed
(
jouº®_t
 *
jouº®
)

575 
»t
;

577 
»t
 = 
	`__jbd3_jouº®_fÜû_comm™
(
jouº®
);

578  
»t
 > 0;

579 
	}
}

588 
	$jbd3_jouº®_fÜû_comm™
(
jouº®_t
 *
jouº®
)

590 
»t
;

592 
	`J_ASSERT
(!
cu¼’t
->
jouº®_šfo
);

593 
»t
 = 
	`__jbd3_jouº®_fÜû_comm™
(
jouº®
);

594 ià(
»t
 > 0)

595 
»t
 = 0;

596  
»t
;

597 
	}
}

604 
	$jbd3_jouº®_¡¬t_comm™
(
jouº®_t
 *
jouº®
, 
tid_t
 *
±id
)

606 
»t
 = 0;

608 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

609 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

610 
tid_t
 
tid
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
;

612 
	`__jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

615 ià(
±id
)

616 *
±id
 = 
tid
;

617 
»t
 = 1;

618 } ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
) {

623 ià(
±id
)

624 *
±id
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
;

625 
»t
 = 1;

627 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

628  
»t
;

629 
	}
}

637 
	$jbd3_Œªs_wl_£nd_d©a_b¬r›r
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

639 
»t
 = 0;

640 
Œª§ùiÚ_t
 *
comm™_Œªs
;

642 ià(!(
jouº®
->
j_æags
 & 
JBD3_BARRIER
))

644 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

646 ià(
	`tid_geq
(
jouº®
->
j_comm™_£qu’û
, 
tid
))

647 
out
;

648 
comm™_Œªs
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

649 ià(!
comm™_Œªs
 || comm™_Œªs->
t_tid
 !ğ
tid
) {

650 
»t
 = 1;

651 
out
;

657 ià(
jouº®
->
j_fs_dev
 !ğjouº®->
j_dev
) {

658 ià(!
comm™_Œªs
->
t_Ãed_d©a_æush
 ||

659 
comm™_Œªs
->
t_¡©e
 >ğ
T_COMMIT_DFLUSH
)

660 
out
;

662 ià(
comm™_Œªs
->
t_¡©e
 >ğ
T_COMMIT_JFLUSH
)

663 
out
;

665 
»t
 = 1;

666 
out
:

667 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

668  
»t
;

669 
	}
}

670 
EXPORT_SYMBOL
(
jbd3_Œªs_wl_£nd_d©a_b¬r›r
);

676 
	$jbd3_log_wa™_comm™
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

678 
”r
 = 0;

680 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

681 #ifdeà
CONFIG_PROVE_LOCKING


687 ià(
	`tid_gt
(
tid
, 
jouº®
->
j_comm™_£qu’û
) &&

688 (!
jouº®
->
j_comm™tšg_Œª§ùiÚ
 ||

689 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
 !ğ
tid
)) {

690 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

691 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

692 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

695 #ifdeà
CONFIG_JBD3_DEBUG


696 ià(!
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
tid
)) {

697 
	`´štk
(
KERN_ERR


699 
__func__
, 
jouº®
->
j_comm™_»que¡
, 
tid
);

702 
	`tid_gt
(
tid
, 
jouº®
->
j_comm™_£qu’û
)) {

703 
	`jbd_debug
(1, "JBD3: want %u, j_commit_sequence=%u\n",

704 
tid
, 
jouº®
->
j_comm™_£qu’û
);

705 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

706 
	`wake_up
(&
jouº®
->
j_wa™_comm™
);

707 
	`wa™_ev’t
(
jouº®
->
j_wa™_dÚe_comm™
,

708 !
	`tid_gt
(
tid
, 
jouº®
->
j_comm™_£qu’û
));

709 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

711 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

713 ià(
	`uÆik–y
(
	`is_jouº®_abÜ‹d
(
jouº®
)))

714 
”r
 = -
EIO
;

715  
”r
;

716 
	}
}

719 
	$jbd3_Œª§ùiÚ_comm™‹d
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

721 
»t
 = 1;

723 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

724 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 &&

725 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 =ğ
tid
)

726 
»t
 = 0;

727 ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 &&

728 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
 =ğ
tid
)

729 
»t
 = 0;

730 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

731  
»t
;

732 
	}
}

733 
EXPORT_SYMBOL
(
jbd3_Œª§ùiÚ_comm™‹d
);

742 
	$jbd3_com¶‘e_Œª§ùiÚ
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

744 
Ãed_to_wa™
 = 1;

746 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

747 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 &&

748 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 =ğ
tid
) {

749 ià(
jouº®
->
j_comm™_»que¡
 !ğ
tid
) {

751 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

752 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

753 
wa™_comm™
;

755 } ià(!(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 &&

756 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
 =ğ
tid
))

757 
Ãed_to_wa™
 = 0;

758 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

759 ià(!
Ãed_to_wa™
)

761 
wa™_comm™
:

762  
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

763 
	}
}

764 
EXPORT_SYMBOL
(
jbd3_com¶‘e_Œª§ùiÚ
);

770 
	$jbd3_jouº®_Ãxt_log_block
(
jouº®_t
 *
jouº®
, *
»
)

772 
blockÄ
;

774 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

775 
	`J_ASSERT
(
jouº®
->
j_ä“
 > 1);

777 
blockÄ
 = 
jouº®
->
j_h—d
;

778 
jouº®
->
j_h—d
++;

779 
jouº®
->
j_ä“
--;

780 ià(
jouº®
->
j_h—d
 =ğjouº®->
j_Ï¡
)

781 
jouº®
->
j_h—d
 = jouº®->
j_fœ¡
;

782 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

783  
	`jbd3_jouº®_bm­
(
jouº®
, 
blockÄ
, 
»
);

784 
	}
}

793 
	$jbd3_jouº®_bm­
(
jouº®_t
 *
jouº®
, 
blockÄ
,

794 *
»
)

796 
”r
 = 0;

797 
»t
;

799 ià(
jouº®
->
j_šode
) {

800 
»t
 = 
	`bm­
(
jouº®
->
j_šode
, 
blockÄ
);

801 ià(
»t
)

802 *
»
 = 
»t
;

804 
	`´štk
(
KERN_ALERT
 "%s: journal block‚ot found "

806 
__func__
, 
blockÄ
, 
jouº®
->
j_devÇme
);

807 
”r
 = -
EIO
;

808 
	`__jouº®_abÜt_soá
(
jouº®
, 
”r
);

811 *
»
 = 
blockÄ
;

813  
”r
;

814 
	}
}

826 
bufãr_h—d
 *

827 
	$jbd3_jouº®_g‘_desütÜ_bufãr
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
, 
ty³
)

829 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

830 
bufãr_h—d
 *
bh
;

831 
blockÄ
;

832 
jouº®_h—d”_t
 *
h—d”
;

833 
”r
;

835 
”r
 = 
	`jbd3_jouº®_Ãxt_log_block
(
jouº®
, &
blockÄ
);

837 ià(
”r
)

838  
NULL
;

840 
bh
 = 
	`__g‘blk
(
jouº®
->
j_dev
, 
blockÄ
, jouº®->
j_blocksize
);

841 ià(!
bh
)

842  
NULL
;

843 
	`lock_bufãr
(
bh
);

844 
	`mem£t
(
bh
->
b_d©a
, 0, 
jouº®
->
j_blocksize
);

845 
h—d”
 = (
jouº®_h—d”_t
 *)
bh
->
b_d©a
;

846 
h—d”
->
h_magic
 = 
	`ıu_to_be32
(
JBD3_MAGIC_NUMBER
);

847 
h—d”
->
h_blockty³
 = 
	`ıu_to_be32
(
ty³
);

848 
h—d”
->
h_£qu’û
 = 
	`ıu_to_be32
(
Œª§ùiÚ
->
t_tid
);

849 
	`£t_bufãr_u±od©e
(
bh
);

850 
	`uÆock_bufãr
(
bh
);

851 
	`BUFFER_TRACE
(
bh
, "returnhis buffer");

852  
bh
;

853 
	}
}

855 
	$jbd3_desütÜ_block_csum_£t
(
jouº®_t
 *
j
, 
bufãr_h—d
 *
bh
)

857 
jbd3_jouº®_block_
 *

;

858 
__u32
 
csum
;

860 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

863 

 = (
jbd3_jouº®_block_
 *)(
bh
->
b_d©a
 + 
j
->
j_blocksize
 -

864 (
jbd3_jouº®_block_
));

865 

->
t_checksum
 = 0;

866 
csum
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
bh
->
b_d©a
, j->
j_blocksize
);

867 

->
t_checksum
 = 
	`ıu_to_be32
(
csum
);

868 
	}
}

880 
	$jbd3_jouº®_g‘_log_
(
jouº®_t
 *
jouº®
, 
tid_t
 *
tid
,

881 *
block
)

883 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

884 
»t
;

886 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

887 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

888 
Œª§ùiÚ
 = 
jouº®
->
j_checkpošt_Œª§ùiÚs
;

889 ià(
Œª§ùiÚ
) {

890 *
tid
 = 
Œª§ùiÚ
->
t_tid
;

891 *
block
 = 
Œª§ùiÚ
->
t_log_¡¬t
;

892 } ià((
Œª§ùiÚ
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
è!ğ
NULL
) {

893 *
tid
 = 
Œª§ùiÚ
->
t_tid
;

894 *
block
 = 
Œª§ùiÚ
->
t_log_¡¬t
;

895 } ià((
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
è!ğ
NULL
) {

896 *
tid
 = 
Œª§ùiÚ
->
t_tid
;

897 *
block
 = 
jouº®
->
j_h—d
;

899 *
tid
 = 
jouº®
->
j_Œª§ùiÚ_£qu’û
;

900 *
block
 = 
jouº®
->
j_h—d
;

902 
»t
 = 
	`tid_gt
(*
tid
, 
jouº®
->
j__£qu’û
);

903 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

904 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

906  
»t
;

907 
	}
}

919 
	$__jbd3_upd©e_log_
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
, 
block
)

921 
ä“d
;

922 
»t
;

924 
	`BUG_ON
(!
	`mu‹x_is_locked
(&
jouº®
->
j_checkpošt_mu‹x
));

932 
»t
 = 
	`jbd3_jouº®_upd©e_sb_log_
(
jouº®
, 
tid
, 
block
,

933 
REQ_SYNC
 | 
REQ_FUA
);

934 ià(
»t
)

935 
out
;

937 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

938 
ä“d
 = 
block
 - 
jouº®
->
j_
;

939 ià(
block
 < 
jouº®
->
j_
)

940 
ä“d
 +ğ
jouº®
->
j_Ï¡
 - jouº®->
j_fœ¡
;

942 
	`Œaû_jbd3_upd©e_log_
(
jouº®
, 
tid
, 
block
, 
ä“d
);

943 
	`jbd_debug
(1,

946 
jouº®
->
j__£qu’û
, 
tid
, 
block
, 
ä“d
);

948 
jouº®
->
j_ä“
 +ğ
ä“d
;

949 
jouº®
->
j__£qu’û
 = 
tid
;

950 
jouº®
->
j_
 = 
block
;

951 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

953 
out
:

954  
»t
;

955 
	}
}

962 
	$jbd3_upd©e_log_
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
, 
block
)

964 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

965 ià(
	`tid_gt
(
tid
, 
jouº®
->
j__£qu’û
))

966 
	`__jbd3_upd©e_log_
(
jouº®
, 
tid
, 
block
);

967 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

968 
	}
}

970 
	sjbd3_¡©s_´oc_£ssiÚ
 {

971 
jouº®_t
 *
	mjouº®
;

972 
Œª§ùiÚ_¡©s_s
 *
	m¡©s
;

973 
	m¡¬t
;

974 
	mmax
;

977 *
	$jbd3_£q_šfo_¡¬t
(
£q_fe
 *
£q
, 
loff_t
 *
pos
)

979  *
pos
 ? 
NULL
 : 
SEQ_START_TOKEN
;

980 
	}
}

982 *
	$jbd3_£q_šfo_Ãxt
(
£q_fe
 *
£q
, *
v
, 
loff_t
 *
pos
)

984  
NULL
;

985 
	}
}

987 
	$jbd3_£q_šfo_show
(
£q_fe
 *
£q
, *
v
)

989 
jbd3_¡©s_´oc_£ssiÚ
 *
s
 = 
£q
->
´iv©e
;

991 ià(
v
 !ğ
SEQ_START_TOKEN
)

993 
	`£q_´štf
(
£q
, "%luransactions (%lu„equested), "

995 
s
->
¡©s
->
ts_tid
, s->¡©s->
ts_»que¡ed
,

996 
s
->
jouº®
->
j_max_Œª§ùiÚ_bufãrs
);

997 ià(
s
->
¡©s
->
ts_tid
 == 0)

999 
	`£q_´štf
(
£q
, "average: \n %ums waiting forransaction\n",

1000 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_wa™
 / s->¡©s->
ts_tid
));

1001 
	`£q_´štf
(
£q
, " %ums„equest delay\n",

1002 (
s
->
¡©s
->
ts_»que¡ed
 == 0) ? 0 :

1003 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_»que¡_d–ay
 /

1004 
s
->
¡©s
->
ts_»que¡ed
));

1005 
	`£q_´štf
(
£q
, " %ums„unningransaction\n",

1006 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_ruÂšg
 / s->¡©s->
ts_tid
));

1007 
	`£q_´štf
(
£q
, " %umsransaction was being†ocked\n",

1008 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_locked
 / s->¡©s->
ts_tid
));

1009 
	`£q_´štf
(
£q
, " %ums flushing data (in ordered mode)\n",

1010 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_æushšg
 / s->¡©s->
ts_tid
));

1011 
	`£q_´štf
(
£q
, " %ums†oggingransaction\n",

1012 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_loggšg
 / s->¡©s->
ts_tid
));

1013 
	`£q_´štf
(
£q
, " %lluus‡verageransaction commitime\n",

1014 
	`div_u64
(
s
->
jouº®
->
j_av”age_comm™_time
, 1000));

1015 
	`£q_´štf
(
£q
, " %lu handles…erransaction\n",

1016 
s
->
¡©s
->
run
.
rs_hªdË_couÁ
 / s->¡©s->
ts_tid
);

1017 
	`£q_´štf
(
£q
, " %lu blocks…erransaction\n",

1018 
s
->
¡©s
->
run
.
rs_blocks
 / s->¡©s->
ts_tid
);

1019 
	`£q_´štf
(
£q
, " %lu†ogged blocks…erransaction\n",

1020 
s
->
¡©s
->
run
.
rs_blocks_logged
 / s->¡©s->
ts_tid
);

1022 
	}
}

1024 
	$jbd3_£q_šfo_¡İ
(
£q_fe
 *
£q
, *
v
)

1026 
	}
}

1028 cÚ¡ 
£q_İ”©iÚs
 
	gjbd3_£q_šfo_İs
 = {

1029 .
¡¬t
 = 
jbd3_£q_šfo_¡¬t
,

1030 .
	gÃxt
 = 
jbd3_£q_šfo_Ãxt
,

1031 .
	g¡İ
 = 
jbd3_£q_šfo_¡İ
,

1032 .
	gshow
 = 
jbd3_£q_šfo_show
,

1035 
	$jbd3_£q_šfo_İ’
(
šode
 *šode, 
fe
 *file)

1037 
jouº®_t
 *
jouº®
 = 
	`PDE_DATA
(
šode
);

1038 
jbd3_¡©s_´oc_£ssiÚ
 *
s
;

1039 
rc
, 
size
;

1041 
s
 = 
	`km®loc
((*s), 
GFP_KERNEL
);

1042 ià(
s
 =ğ
NULL
)

1043  -
ENOMEM
;

1044 
size
 = (
Œª§ùiÚ_¡©s_s
);

1045 
s
->
¡©s
 = 
	`km®loc
(
size
, 
GFP_KERNEL
);

1046 ià(
s
->
¡©s
 =ğ
NULL
) {

1047 
	`kä“
(
s
);

1048  -
ENOMEM
;

1050 
	`¥š_lock
(&
jouº®
->
j_hi¡Üy_lock
);

1051 
	`memıy
(
s
->
¡©s
, &
jouº®
->
j_¡©s
, 
size
);

1052 
s
->
jouº®
 = journal;

1053 
	`¥š_uÆock
(&
jouº®
->
j_hi¡Üy_lock
);

1055 
rc
 = 
	`£q_İ’
(
fe
, &
jbd3_£q_šfo_İs
);

1056 ià(
rc
 == 0) {

1057 
£q_fe
 *
m
 = 
fe
->
´iv©e_d©a
;

1058 
m
->
´iv©e
 = 
s
;

1060 
	`kä“
(
s
->
¡©s
);

1061 
	`kä“
(
s
);

1063  
rc
;

1065 
	}
}

1067 
	$jbd3_£q_šfo_»Ëa£
(
šode
 *šode, 
fe
 *file)

1069 
£q_fe
 *
£q
 = 
fe
->
´iv©e_d©a
;

1070 
jbd3_¡©s_´oc_£ssiÚ
 *
s
 = 
£q
->
´iv©e
;

1071 
	`kä“
(
s
->
¡©s
);

1072 
	`kä“
(
s
);

1073  
	`£q_»Ëa£
(
šode
, 
fe
);

1074 
	}
}

1076 cÚ¡ 
fe_İ”©iÚs
 
	gjbd3_£q_šfo_fİs
 = {

1077 .
owÃr
 = 
THIS_MODULE
,

1078 .
	gİ’
 = 
jbd3_£q_šfo_İ’
,

1079 .
	g»ad
 = 
£q_»ad
,

1080 .
	gÎ£ek
 = 
£q_l£ek
,

1081 .
	g»Ëa£
 = 
jbd3_£q_šfo_»Ëa£
,

1084 
´oc_dœ_’Œy
 *
	g´oc_jbd3_¡©s
;

1086 
	$jbd3_¡©s_´oc_š™
(
jouº®_t
 *
jouº®
)

1088 
jouº®
->
j_´oc_’Œy
 = 
	`´oc_mkdœ
(jouº®->
j_devÇme
, 
´oc_jbd3_¡©s
);

1089 ià(
jouº®
->
j_´oc_’Œy
) {

1090 
	`´oc_ü—‹_d©a
("šfo", 
S_IRUGO
, 
jouº®
->
j_´oc_’Œy
,

1091 &
jbd3_£q_šfo_fİs
, 
jouº®
);

1093 
	}
}

1095 
	$jbd3_¡©s_´oc_ex™
(
jouº®_t
 *
jouº®
)

1097 
	`»move_´oc_’Œy
("šfo", 
jouº®
->
j_´oc_’Œy
);

1098 
	`»move_´oc_’Œy
(
jouº®
->
j_devÇme
, 
´oc_jbd3_¡©s
);

1099 
	}
}

1110 
jouº®_t
 *
	$jouº®_š™_commÚ
(
block_deviû
 *
bdev
,

1111 
block_deviû
 *
fs_dev
,

1112 
¡¬t
, 
Ën
, 
blocksize
)

1114 
lock_şass_key
 
jbd3_Œªs_comm™_key
;

1115 
jouº®_t
 *
jouº®
;

1116 
”r
;

1117 
bufãr_h—d
 *
bh
;

1118 
n
;

1120 
jouº®
 = 
	`kz®loc
((*jouº®), 
GFP_KERNEL
);

1121 ià(!
jouº®
)

1122  
NULL
;

1124 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
);

1125 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_dÚe_comm™
);

1126 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_comm™
);

1127 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_upd©es
);

1128 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_»£rved
);

1129 
	`mu‹x_š™
(&
jouº®
->
j_b¬r›r
);

1130 
	`mu‹x_š™
(&
jouº®
->
j_checkpošt_mu‹x
);

1131 
	`¥š_lock_š™
(&
jouº®
->
j_»voke_lock
);

1132 
	`¥š_lock_š™
(&
jouº®
->
j_li¡_lock
);

1133 
	`rwlock_š™
(&
jouº®
->
j_¡©e_lock
);

1135 
jouº®
->
j_comm™_š‹rv®
 = (
HZ
 * 
JBD3_DEFAULT_MAX_COMMIT_AGE
);

1136 
jouº®
->
j_mš_b©ch_time
 = 0;

1137 
jouº®
->
j_max_b©ch_time
 = 15000;

1138 
	`©omic_£t
(&
jouº®
->
j_»£rved_üed™s
, 0);

1141 
jouº®
->
j_æags
 = 
JBD3_ABORT
;

1144 
”r
 = 
	`jbd3_jouº®_š™_»voke
(
jouº®
, 
JOURNAL_REVOKE_DEFAULT_HASH
);

1145 ià(
”r
)

1146 
”r_ş—nup
;

1148 
	`¥š_lock_š™
(&
jouº®
->
j_hi¡Üy_lock
);

1150 
	`lockd•_š™_m­
(&
jouº®
->
j_Œªs_comm™_m­
, "jbd3_handle",

1151 &
jbd3_Œªs_comm™_key
, 0);

1154 
jouº®
->
j_blocksize
 = 
blocksize
;

1155 
jouº®
->
j_dev
 = 
bdev
;

1156 
jouº®
->
j_fs_dev
 = 
fs_dev
;

1157 
jouº®
->
j_blk_off£t
 = 
¡¬t
;

1158 
jouº®
->
j_maxËn
 = 
Ën
;

1159 
n
 = 
jouº®
->
j_blocksize
 / (
jouº®_block_g_t
);

1160 
jouº®
->
j_wbufsize
 = 
n
;

1161 
jouº®
->
j_wbuf
 = 
	`km®loc_¬¿y
(
n
, (
bufãr_h—d
 *),

1162 
GFP_KERNEL
);

1163 ià(!
jouº®
->
j_wbuf
)

1164 
”r_ş—nup
;

1166 
bh
 = 
	`g‘blk_unmovabË
(
jouº®
->
j_dev
, 
¡¬t
, jouº®->
j_blocksize
);

1167 ià(!
bh
) {

1168 
	`´_”r
("%s: Cannot get buffer for journal superblock\n",

1169 
__func__
);

1170 
”r_ş—nup
;

1172 
jouº®
->
j_sb_bufãr
 = 
bh
;

1173 
jouº®
->
j_su³rblock
 = (
jouº®_su³rblock_t
 *)
bh
->
b_d©a
;

1175  
jouº®
;

1177 
”r_ş—nup
:

1178 
	`kä“
(
jouº®
->
j_wbuf
);

1179 
	`jbd3_jouº®_de¡roy_»voke
(
jouº®
);

1180 
	`kä“
(
jouº®
);

1181  
NULL
;

1182 
	}
}

1207 
jouº®_t
 *
	$jbd3_jouº®_š™_dev
(
block_deviû
 *
bdev
,

1208 
block_deviû
 *
fs_dev
,

1209 
¡¬t
, 
Ën
, 
blocksize
)

1211 
jouº®_t
 *
jouº®
;

1213 
jouº®
 = 
	`jouº®_š™_commÚ
(
bdev
, 
fs_dev
, 
¡¬t
, 
Ën
, 
blocksize
);

1214 ià(!
jouº®
)

1215  
NULL
;

1217 
	`bdevÇme
(
jouº®
->
j_dev
, jouº®->
j_devÇme
);

1218 
	`¡¼•Ïû
(
jouº®
->
j_devÇme
, '/', '!');

1219 
	`jbd3_¡©s_´oc_š™
(
jouº®
);

1221  
jouº®
;

1222 
	}
}

1232 
jouº®_t
 *
	$jbd3_jouº®_š™_šode
(
šode
 *inode)

1234 
jouº®_t
 *
jouº®
;

1235 *
p
;

1236 
blockÄ
;

1238 
blockÄ
 = 
	`bm­
(
šode
, 0);

1239 ià(!
blockÄ
) {

1240 
	`´_”r
("%s: Cannot†ocate journal superblock\n",

1241 
__func__
);

1242  
NULL
;

1245 
	`jbd_debug
(1, "JBD3: inode %s/%ld, size %lld, bits %d, blksize %ld\n",

1246 
šode
->
i_sb
->
s_id
, inode->
i_šo
, (èšode->
i_size
,

1247 
šode
->
i_sb
->
s_blocksize_b™s
, inode->i_sb->
s_blocksize
);

1249 
jouº®
 = 
	`jouº®_š™_commÚ
(
šode
->
i_sb
->
s_bdev
, inode->i_sb->s_bdev,

1250 
blockÄ
, 
šode
->
i_size
 >> inode->
i_sb
->
s_blocksize_b™s
,

1251 
šode
->
i_sb
->
s_blocksize
);

1252 ià(!
jouº®
)

1253  
NULL
;

1255 
jouº®
->
j_šode
 = 
šode
;

1256 
	`bdevÇme
(
jouº®
->
j_dev
, jouº®->
j_devÇme
);

1257 
p
 = 
	`¡¼•Ïû
(
jouº®
->
j_devÇme
, '/', '!');

1258 
	`¥rštf
(
p
, "-%lu", 
jouº®
->
j_šode
->
i_šo
);

1259 
	`jbd3_¡©s_´oc_š™
(
jouº®
);

1261  
jouº®
;

1262 
	}
}

1269 
	$jouº®_ç_su³rblock
 (
jouº®_t
 *
jouº®
)

1271 
bufãr_h—d
 *
bh
 = 
jouº®
->
j_sb_bufãr
;

1272 
	`b»l£
(
bh
);

1273 
jouº®
->
j_sb_bufãr
 = 
NULL
;

1274 
	}
}

1283 
	$jouº®_»£t
(
jouº®_t
 *
jouº®
)

1285 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1286 
fœ¡
, 
Ï¡
;

1288 
fœ¡
 = 
	`be32_to_ıu
(
sb
->
s_fœ¡
);

1289 
Ï¡
 = 
	`be32_to_ıu
(
sb
->
s_maxËn
);

1290 ià(
fœ¡
 + 
JBD3_MIN_JOURNAL_BLOCKS
 > 
Ï¡
 + 1) {

1291 
	`´štk
(
KERN_ERR
 "JBD3: Journaloo short (blocks %llu-%llu).\n",

1292 
fœ¡
, 
Ï¡
);

1293 
	`jouº®_ç_su³rblock
(
jouº®
);

1294  -
EINVAL
;

1297 
jouº®
->
j_fœ¡
 = 
fœ¡
;

1298 
jouº®
->
j_Ï¡
 = 
Ï¡
;

1300 
jouº®
->
j_h—d
 = 
fœ¡
;

1301 
jouº®
->
j_
 = 
fœ¡
;

1302 
jouº®
->
j_ä“
 = 
Ï¡
 - 
fœ¡
;

1304 
jouº®
->
j__£qu’û
 = jouº®->
j_Œª§ùiÚ_£qu’û
;

1305 
jouº®
->
j_comm™_£qu’û
 = jouº®->
j_Œª§ùiÚ_£qu’û
 - 1;

1306 
jouº®
->
j_comm™_»que¡
 = jouº®->
j_comm™_£qu’û
;

1308 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
 = jouº®->
j_maxËn
 / 4;

1316 ià(
sb
->
s_¡¬t
 == 0) {

1317 
	`jbd_debug
(1, "JBD3: Skipping superblock update on„ecovered sb "

1319 
jouº®
->
j_
, jouº®->
j__£qu’û
,

1320 
jouº®
->
j_”ºo
);

1321 
jouº®
->
j_æags
 |ğ
JBD3_FLUSHED
;

1324 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

1331 
	`jbd3_jouº®_upd©e_sb_log_
(
jouº®
,

1332 
jouº®
->
j__£qu’û
,

1333 
jouº®
->
j_
,

1334 
REQ_SYNC
 | 
REQ_FUA
);

1335 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

1337  
	`jbd3_jouº®_¡¬t_th»ad
(
jouº®
);

1338 
	}
}

1344 
	$jbd3_wr™e_su³rblock
(
jouº®_t
 *
jouº®
, 
wr™e_æags
)

1346 
bufãr_h—d
 *
bh
 = 
jouº®
->
j_sb_bufãr
;

1347 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1348 
»t
;

1351 ià(!
	`bufãr_m­³d
(
bh
))

1352  -
EIO
;

1354 
	`Œaû_jbd3_wr™e_su³rblock
(
jouº®
, 
wr™e_æags
);

1355 ià(!(
jouº®
->
j_æags
 & 
JBD3_BARRIER
))

1356 
wr™e_æags
 &ğ~(
REQ_FUA
 | 
REQ_PREFLUSH
);

1357 ià(
	`bufãr_wr™e_io_”rÜ
(
bh
)) {

1366 
	`´štk
(
KERN_ERR
 "JBD3:…revious I/Oƒrror detected "

1368 
jouº®
->
j_devÇme
);

1369 
	`ş—r_bufãr_wr™e_io_”rÜ
(
bh
);

1370 
	`£t_bufãr_u±od©e
(
bh
);

1372 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

1373 
sb
->
s_checksum
 = 
	`jbd3_su³rblock_csum
(
jouº®
, sb);

1374 
	`g‘_bh
(
bh
);

1375 
bh
->
b_’d_io
 = 
’d_bufãr_wr™e_sync
;

1376 
»t
 = 
	`subm™_bh
(
REQ_OP_WRITE
, 
wr™e_æags
, 
bh
);

1377 
	`wa™_Ú_bufãr
(
bh
);

1378 ià(
	`bufãr_wr™e_io_”rÜ
(
bh
)) {

1379 
	`ş—r_bufãr_wr™e_io_”rÜ
(
bh
);

1380 
	`£t_bufãr_u±od©e
(
bh
);

1381 
»t
 = -
EIO
;

1383 ià(
»t
) {

1384 
	`´štk
(
KERN_ERR
 "JBD3: Error %d detected when updating "

1385 "jouº® su³rblock fÜ %s.\n", 
»t
,

1386 
jouº®
->
j_devÇme
);

1387 
	`jbd3_jouº®_abÜt
(
jouº®
, 
»t
);

1390  
»t
;

1391 
	}
}

1403 
	$jbd3_jouº®_upd©e_sb_log_
(
jouº®_t
 *
jouº®
, 
tid_t
 
_tid
,

1404 
_block
, 
wr™e_İ
)

1406 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1407 
»t
;

1409 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

1410  -
EIO
;

1412 
	`BUG_ON
(!
	`mu‹x_is_locked
(&
jouº®
->
j_checkpošt_mu‹x
));

1413 
	`jbd_debug
(1, "JBD3: updating superblock (start %lu, seq %u)\n",

1414 
_block
, 
_tid
);

1416 
	`lock_bufãr
(
jouº®
->
j_sb_bufãr
);

1417 
sb
->
s_£qu’û
 = 
	`ıu_to_be32
(
_tid
);

1418 
sb
->
s_¡¬t
 = 
	`ıu_to_be32
(
_block
);

1420 
»t
 = 
	`jbd3_wr™e_su³rblock
(
jouº®
, 
wr™e_İ
);

1421 ià(
»t
)

1422 
out
;

1425 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1426 
	`WARN_ON
(!
sb
->
s_£qu’û
);

1427 
jouº®
->
j_æags
 &ğ~
JBD3_FLUSHED
;

1428 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1430 
out
:

1431  
»t
;

1432 
	}
}

1442 
	$jbd3_m¬k_jouº®_em±y
(
jouº®_t
 *
jouº®
, 
wr™e_İ
)

1444 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1446 
	`BUG_ON
(!
	`mu‹x_is_locked
(&
jouº®
->
j_checkpošt_mu‹x
));

1447 
	`lock_bufãr
(
jouº®
->
j_sb_bufãr
);

1448 ià(
sb
->
s_¡¬t
 == 0) {

1449 
	`uÆock_bufãr
(
jouº®
->
j_sb_bufãr
);

1453 
	`jbd_debug
(1, "JBD3: Marking journal‡sƒmpty (seq %u)\n",

1454 
jouº®
->
j__£qu’û
);

1456 
sb
->
s_£qu’û
 = 
	`ıu_to_be32
(
jouº®
->
j__£qu’û
);

1457 
sb
->
s_¡¬t
 = 
	`ıu_to_be32
(0);

1459 
	`jbd3_wr™e_su³rblock
(
jouº®
, 
wr™e_İ
);

1462 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1463 
jouº®
->
j_æags
 |ğ
JBD3_FLUSHED
;

1464 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1465 
	}
}

1475 
	$jbd3_jouº®_upd©e_sb_”ºo
(
jouº®_t
 *
jouº®
)

1477 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1478 
”rcode
;

1480 
	`lock_bufãr
(
jouº®
->
j_sb_bufãr
);

1481 
”rcode
 = 
jouº®
->
j_”ºo
;

1482 ià(
”rcode
 =ğ-
ESHUTDOWN
)

1483 
”rcode
 = 0;

1484 
	`jbd_debug
(1, "JBD3: upd©šg su³rblockƒ¼Ü (”ºØ%d)\n", 
”rcode
);

1485 
sb
->
s_”ºo
 = 
	`ıu_to_be32
(
”rcode
);

1487 
	`jbd3_wr™e_su³rblock
(
jouº®
, 
REQ_SYNC
 | 
REQ_FUA
);

1488 
	}
}

1489 
EXPORT_SYMBOL
(
jbd3_jouº®_upd©e_sb_”ºo
);

1495 
	$jouº®_g‘_su³rblock
(
jouº®_t
 *
jouº®
)

1497 
bufãr_h—d
 *
bh
;

1498 
jouº®_su³rblock_t
 *
sb
;

1499 
”r
 = -
EIO
;

1501 
bh
 = 
jouº®
->
j_sb_bufãr
;

1503 
	`J_ASSERT
(
bh
 !ğ
NULL
);

1504 ià(!
	`bufãr_u±od©e
(
bh
)) {

1505 
	`Î_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

1506 
	`wa™_Ú_bufãr
(
bh
);

1507 ià(!
	`bufãr_u±od©e
(
bh
)) {

1508 
	`´štk
(
KERN_ERR


1510 
out
;

1514 ià(
	`bufãr_v”if›d
(
bh
))

1517 
sb
 = 
jouº®
->
j_su³rblock
;

1519 
”r
 = -
EINVAL
;

1521 ià(
sb
->
s_h—d”
.
h_magic
 !ğ
	`ıu_to_be32
(
JBD3_MAGIC_NUMBER
) ||

1522 
sb
->
s_blocksize
 !ğ
	`ıu_to_be32
(
jouº®
->
j_blocksize
)) {

1523 
	`´štk
(
KERN_WARNING
 "JBD3:‚o valid journal superblock found\n");

1524 
out
;

1527 
	`be32_to_ıu
(
sb
->
s_h—d”
.
h_blockty³
)) {

1528 
JBD3_SUPERBLOCK_V1
:

1529 
jouº®
->
j_fÜm©_v”siÚ
 = 1;

1531 
JBD3_SUPERBLOCK_V2
:

1532 
jouº®
->
j_fÜm©_v”siÚ
 = 2;

1535 
	`´štk
(
KERN_WARNING
 "JBD3: unrecognised superblock format ID\n");

1536 
out
;

1539 ià(
	`be32_to_ıu
(
sb
->
s_maxËn
è< 
jouº®
->
j_maxËn
)

1540 
jouº®
->
j_maxËn
 = 
	`be32_to_ıu
(
sb
->
s_maxËn
);

1541 ià(
	`be32_to_ıu
(
sb
->
s_maxËn
è> 
jouº®
->
j_maxËn
) {

1542 
	`´štk
(
KERN_WARNING
 "JBD3: journal fileoo short\n");

1543 
out
;

1546 ià(
	`be32_to_ıu
(
sb
->
s_fœ¡
) == 0 ||

1547 
	`be32_to_ıu
(
sb
->
s_fœ¡
è>ğ
jouº®
->
j_maxËn
) {

1548 
	`´štk
(
KERN_WARNING


1550 
	`be32_to_ıu
(
sb
->
s_fœ¡
));

1551 
out
;

1554 ià(
	`jbd3_has_ã©u»_csum2
(
jouº®
) &&

1555 
	`jbd3_has_ã©u»_csum3
(
jouº®
)) {

1557 
	`´štk
(
KERN_ERR
 "JBD3: Can'tƒnable checksumming v2‡nd v3 "

1559 
out
;

1562 ià(
	`jbd3_jouº®_has_csum_v2Ü3_ã©u»
(
jouº®
) &&

1563 
	`jbd3_has_ã©u»_checksum
(
jouº®
)) {

1565 
	`´štk
(
KERN_ERR
 "JBD3: Can'tƒnable checksumming v1‡nd v2/3 "

1567 
out
;

1570 ià(!
	`jbd3_v”ify_csum_ty³
(
jouº®
, 
sb
)) {

1571 
	`´štk
(
KERN_ERR
 "JBD3: Unknown checksumype\n");

1572 
out
;

1576 ià(
	`jbd3_jouº®_has_csum_v2Ü3_ã©u»
(
jouº®
)) {

1577 
jouº®
->
j_chksum_driv”
 = 
	`üy±o_®loc_shash
("crc32c", 0, 0);

1578 ià(
	`IS_ERR
(
jouº®
->
j_chksum_driv”
)) {

1579 
	`´štk
(
KERN_ERR
 "JBD3: Cannot†oad crc32c driver.\n");

1580 
”r
 = 
	`PTR_ERR
(
jouº®
->
j_chksum_driv”
);

1581 
jouº®
->
j_chksum_driv”
 = 
NULL
;

1582 
out
;

1586 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
)) {

1588 ià(
sb
->
s_checksum
 !ğ
	`jbd3_su³rblock_csum
(
jouº®
, sb)) {

1589 
	`´štk
(
KERN_ERR
 "JBD3: journal checksumƒrror\n");

1590 
”r
 = -
EFSBADCRC
;

1591 
out
;

1595 
jouº®
->
j_csum_£ed
 = 
	`jbd3_chksum
(jouº®, ~0, 
sb
->
s_uuid
,

1596 (
sb
->
s_uuid
));

1599 
	`£t_bufãr_v”if›d
(
bh
);

1603 
out
:

1604 
	`jouº®_ç_su³rblock
(
jouº®
);

1605  
”r
;

1606 
	}
}

1613 
	$lßd_su³rblock
(
jouº®_t
 *
jouº®
)

1615 
”r
;

1616 
jouº®_su³rblock_t
 *
sb
;

1618 
”r
 = 
	`jouº®_g‘_su³rblock
(
jouº®
);

1619 ià(
”r
)

1620  
”r
;

1622 
sb
 = 
jouº®
->
j_su³rblock
;

1624 
jouº®
->
j__£qu’û
 = 
	`be32_to_ıu
(
sb
->
s_£qu’û
);

1625 
jouº®
->
j_
 = 
	`be32_to_ıu
(
sb
->
s_¡¬t
);

1626 
jouº®
->
j_fœ¡
 = 
	`be32_to_ıu
(
sb
->
s_fœ¡
);

1627 
jouº®
->
j_Ï¡
 = 
	`be32_to_ıu
(
sb
->
s_maxËn
);

1628 
jouº®
->
j_”ºo
 = 
	`be32_to_ıu
(
sb
->
s_”ºo
);

1631 
	}
}

1642 
	$jbd3_jouº®_lßd
(
jouº®_t
 *
jouº®
)

1644 
”r
;

1645 
jouº®_su³rblock_t
 *
sb
;

1647 
”r
 = 
	`lßd_su³rblock
(
jouº®
);

1648 ià(
”r
)

1649  
”r
;

1651 
sb
 = 
jouº®
->
j_su³rblock
;

1655 ià(
jouº®
->
j_fÜm©_v”siÚ
 >= 2) {

1656 ià((
sb
->
s_ã©u»_ro_com·t
 &

1657 ~
	`ıu_to_be32
(
JBD3_KNOWN_ROCOMPAT_FEATURES
)) ||

1658 (
sb
->
s_ã©u»_šcom·t
 &

1659 ~
	`ıu_to_be32
(
JBD3_KNOWN_INCOMPAT_FEATURES
))) {

1660 
	`´štk
(
KERN_WARNING


1662  -
EINVAL
;

1669 
”r
 = 
	`jbd3_jouº®_ü—‹_¦ab
(
	`be32_to_ıu
(
sb
->
s_blocksize
));

1670 ià(
”r
)

1671  
”r
;

1675 ià(
	`jbd3_jouº®_»cov”
(
jouº®
))

1676 
»cov”y_”rÜ
;

1678 ià(
jouº®
->
j_çed_comm™
) {

1679 
	`´štk
(
KERN_ERR
 "JBD3: journalransaction %u on %s "

1680 "i cÜru±.\n", 
jouº®
->
j_çed_comm™
,

1681 
jouº®
->
j_devÇme
);

1682  -
EFSCORRUPTED
;

1688 ià(
	`jouº®_»£t
(
jouº®
))

1689 
»cov”y_”rÜ
;

1691 
jouº®
->
j_æags
 &ğ~
JBD3_ABORT
;

1692 
jouº®
->
j_æags
 |ğ
JBD3_LOADED
;

1695 
»cov”y_”rÜ
:

1696 
	`´štk
(
KERN_WARNING
 "JBD3:„ecovery failed\n");

1697  -
EIO
;

1698 
	}
}

1708 
	$jbd3_jouº®_de¡roy
(
jouº®_t
 *
jouº®
)

1710 
”r
 = 0;

1713 
	`jouº®_kl_th»ad
(
jouº®
);

1716 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
)

1717 
	`jbd3_jouº®_comm™_Œª§ùiÚ
(
jouº®
);

1722 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1723 
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
NULL
) {

1724 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1725 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

1726 
”r
 = 
	`jbd3_log_do_checkpošt
(
jouº®
);

1727 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

1732 ià(
”r
) {

1733 
	`jbd3_jouº®_de¡roy_checkpošt
(
jouº®
);

1734 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1737 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1740 
	`J_ASSERT
(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 =ğ
NULL
);

1741 
	`J_ASSERT
(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 =ğ
NULL
);

1742 
	`J_ASSERT
(
jouº®
->
j_checkpošt_Œª§ùiÚs
 =ğ
NULL
);

1743 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1745 ià(
jouº®
->
j_sb_bufãr
) {

1746 ià(!
	`is_jouº®_abÜ‹d
(
jouº®
)) {

1747 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

1749 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1750 
jouº®
->
j__£qu’û
 =

1751 ++
jouº®
->
j_Œª§ùiÚ_£qu’û
;

1752 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1754 
	`jbd3_m¬k_jouº®_em±y
(
jouº®
,

1755 
REQ_SYNC
 | 
REQ_PREFLUSH
 | 
REQ_FUA
);

1756 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

1758 
”r
 = -
EIO
;

1759 
	`b»l£
(
jouº®
->
j_sb_bufãr
);

1762 ià(
jouº®
->
j_´oc_’Œy
)

1763 
	`jbd3_¡©s_´oc_ex™
(
jouº®
);

1764 
	`ut
(
jouº®
->
j_šode
);

1765 ià(
jouº®
->
j_»voke
)

1766 
	`jbd3_jouº®_de¡roy_»voke
(
jouº®
);

1767 ià(
jouº®
->
j_chksum_driv”
)

1768 
	`üy±o_ä“_shash
(
jouº®
->
j_chksum_driv”
);

1769 
	`kä“
(
jouº®
->
j_wbuf
);

1770 
	`kä“
(
jouº®
);

1772  
”r
;

1773 
	}
}

1787 
	$jbd3_jouº®_check_u£d_ã©u»s
 (
jouº®_t
 *
jouº®
, 
com·t
,

1788 
ro
, 
šcom·t
)

1790 
jouº®_su³rblock_t
 *
sb
;

1792 ià(!
com·t
 && !
ro
 && !
šcom·t
)

1795 ià(
jouº®
->
j_fÜm©_v”siÚ
 == 0 &&

1796 
	`jouº®_g‘_su³rblock
(
jouº®
) != 0)

1798 ià(
jouº®
->
j_fÜm©_v”siÚ
 == 1)

1801 
sb
 = 
jouº®
->
j_su³rblock
;

1803 ià(((
	`be32_to_ıu
(
sb
->
s_ã©u»_com·t
è& 
com·t
) == compat) &&

1804 ((
	`be32_to_ıu
(
sb
->
s_ã©u»_ro_com·t
è& 
ro
) ==„o) &&

1805 ((
	`be32_to_ıu
(
sb
->
s_ã©u»_šcom·t
è& 
šcom·t
) == incompat))

1809 
	}
}

1822 
	$jbd3_jouº®_check_avaabË_ã©u»s
 (
jouº®_t
 *
jouº®
, 
com·t
,

1823 
ro
, 
šcom·t
)

1825 ià(!
com·t
 && !
ro
 && !
šcom·t
)

1832 ià(
jouº®
->
j_fÜm©_v”siÚ
 != 2)

1835 ià((
com·t
 & 
JBD3_KNOWN_COMPAT_FEATURES
) == compat &&

1836 (
ro
 & 
JBD3_KNOWN_ROCOMPAT_FEATURES
) ==„o &&

1837 (
šcom·t
 & 
JBD3_KNOWN_INCOMPAT_FEATURES
) == incompat)

1841 
	}
}

1855 
	$jbd3_jouº®_£t_ã©u»s
 (
jouº®_t
 *
jouº®
, 
com·t
,

1856 
ro
, 
šcom·t
)

1858 
	#INCOMPAT_FEATURE_ON
(
f
) \

1859 ((
šcom·t
 & (
f
)è&& !(
sb
->
s_ã©u»_šcom·t
 & 
	`ıu_to_be32
(f)))

	)

1860 
	#COMPAT_FEATURE_ON
(
f
) \

1861 ((
com·t
 & (
f
)è&& !(
sb
->
s_ã©u»_com·t
 & 
	`ıu_to_be32
(f)))

	)

1862 
jouº®_su³rblock_t
 *
sb
;

1864 ià(
	`jbd3_jouº®_check_u£d_ã©u»s
(
jouº®
, 
com·t
, 
ro
, 
šcom·t
))

1867 ià(!
	`jbd3_jouº®_check_avaabË_ã©u»s
(
jouº®
, 
com·t
, 
ro
, 
šcom·t
))

1871 ià(
šcom·t
 & 
JBD3_FEATURE_INCOMPAT_CSUM_V2
) {

1872 
šcom·t
 &ğ~
JBD3_FEATURE_INCOMPAT_CSUM_V2
;

1873 
šcom·t
 |ğ
JBD3_FEATURE_INCOMPAT_CSUM_V3
;

1877 ià(
šcom·t
 & 
JBD3_FEATURE_INCOMPAT_CSUM_V3
 &&

1878 
com·t
 & 
JBD3_FEATURE_COMPAT_CHECKSUM
)

1879 
com·t
 &ğ~
JBD3_FEATURE_COMPAT_CHECKSUM
;

1881 
	`jbd_debug
(1, "Setting‚ew features 0x%lx/0x%lx/0x%lx\n",

1882 
com·t
, 
ro
, 
šcom·t
);

1884 
sb
 = 
jouº®
->
j_su³rblock
;

1887 ià((
jouº®
->
j_chksum_driv”
 =ğ
NULL
) &&

1888 
	`INCOMPAT_FEATURE_ON
(
JBD3_FEATURE_INCOMPAT_CSUM_V3
)) {

1889 
jouº®
->
j_chksum_driv”
 = 
	`üy±o_®loc_shash
("crc32c", 0, 0);

1890 ià(
	`IS_ERR
(
jouº®
->
j_chksum_driv”
)) {

1891 
	`´štk
(
KERN_ERR
 "JBD3: Cannot†oad crc32c driver.\n");

1892 
jouº®
->
j_chksum_driv”
 = 
NULL
;

1896 
jouº®
->
j_csum_£ed
 = 
	`jbd3_chksum
(jouº®, ~0, 
sb
->
s_uuid
,

1897 (
sb
->
s_uuid
));

1900 
	`lock_bufãr
(
jouº®
->
j_sb_bufãr
);

1903 ià(
	`INCOMPAT_FEATURE_ON
(
JBD3_FEATURE_INCOMPAT_CSUM_V3
)) {

1904 
sb
->
s_checksum_ty³
 = 
JBD3_CRC32C_CHKSUM
;

1905 
sb
->
s_ã©u»_com·t
 &=

1906 ~
	`ıu_to_be32
(
JBD3_FEATURE_COMPAT_CHECKSUM
);

1910 ià(
	`COMPAT_FEATURE_ON
(
JBD3_FEATURE_COMPAT_CHECKSUM
))

1911 
sb
->
s_ã©u»_šcom·t
 &=

1912 ~
	`ıu_to_be32
(
JBD3_FEATURE_INCOMPAT_CSUM_V2
 |

1913 
JBD3_FEATURE_INCOMPAT_CSUM_V3
);

1915 
sb
->
s_ã©u»_com·t
 |ğ
	`ıu_to_be32
(
com·t
);

1916 
sb
->
s_ã©u»_ro_com·t
 |ğ
	`ıu_to_be32
(
ro
);

1917 
sb
->
s_ã©u»_šcom·t
 |ğ
	`ıu_to_be32
(
šcom·t
);

1918 
	`uÆock_bufãr
(
jouº®
->
j_sb_bufãr
);

1921 #undeà
COMPAT_FEATURE_ON


1922 #undeà
INCOMPAT_FEATURE_ON


1923 
	}
}

1936 
	$jbd3_jouº®_ş—r_ã©u»s
(
jouº®_t
 *
jouº®
, 
com·t
,

1937 
ro
, 
šcom·t
)

1939 
jouº®_su³rblock_t
 *
sb
;

1941 
	`jbd_debug
(1, "Clear features 0x%lx/0x%lx/0x%lx\n",

1942 
com·t
, 
ro
, 
šcom·t
);

1944 
sb
 = 
jouº®
->
j_su³rblock
;

1946 
sb
->
s_ã©u»_com·t
 &ğ~
	`ıu_to_be32
(
com·t
);

1947 
sb
->
s_ã©u»_ro_com·t
 &ğ~
	`ıu_to_be32
(
ro
);

1948 
sb
->
s_ã©u»_šcom·t
 &ğ~
	`ıu_to_be32
(
šcom·t
);

1949 
	}
}

1950 
EXPORT_SYMBOL
(
jbd3_jouº®_ş—r_ã©u»s
);

1961 
	$jbd3_jouº®_æush
(
jouº®_t
 *
jouº®
)

1963 
”r
 = 0;

1964 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
NULL
;

1966 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1969 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

1970 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

1971 
	`__jbd3_log_¡¬t_comm™
(
jouº®
, 
Œª§ùiÚ
->
t_tid
);

1972 } ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
)

1973 
Œª§ùiÚ
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

1976 ià(
Œª§ùiÚ
) {

1977 
tid_t
 
tid
 = 
Œª§ùiÚ
->
t_tid
;

1979 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1980 
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

1982 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1986 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1987 !
”r
 && 
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
NULL
) {

1988 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1989 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

1990 
”r
 = 
	`jbd3_log_do_checkpošt
(
jouº®
);

1991 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

1992 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1994 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1996 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

1997  -
EIO
;

1999 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

2000 ià(!
”r
) {

2001 
”r
 = 
	`jbd3_ş—nup_jouº®_
(
jouº®
);

2002 ià(
”r
 < 0) {

2003 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

2004 
out
;

2006 
”r
 = 0;

2014 
	`jbd3_m¬k_jouº®_em±y
(
jouº®
, 
REQ_SYNC
 | 
REQ_FUA
);

2015 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

2016 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2017 
	`J_ASSERT
(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
);

2018 
	`J_ASSERT
(!
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

2019 
	`J_ASSERT
(!
jouº®
->
j_checkpošt_Œª§ùiÚs
);

2020 
	`J_ASSERT
(
jouº®
->
j_h—d
 =ğjouº®->
j_
);

2021 
	`J_ASSERT
(
jouº®
->
j__£qu’û
 =ğjouº®->
j_Œª§ùiÚ_£qu’û
);

2022 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2023 
out
:

2024  
”r
;

2025 
	}
}

2040 
	$jbd3_jouº®_we
(
jouº®_t
 *
jouº®
, 
wr™e
)

2042 
”r
 = 0;

2044 
	`J_ASSERT
 (!(
jouº®
->
j_æags
 & 
JBD3_LOADED
));

2046 
”r
 = 
	`lßd_su³rblock
(
jouº®
);

2047 ià(
”r
)

2048  
”r
;

2050 ià(!
jouº®
->
j_
)

2051 
no_»cov”y
;

2053 
	`´štk
(
KERN_WARNING
 "JBD3: %s„ecovery information on journal\n",

2054 
wr™e
 ? "Clearing" : "Ignoring");

2056 
”r
 = 
	`jbd3_jouº®_sk_»cov”y
(
jouº®
);

2057 ià(
wr™e
) {

2059 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

2060 
	`jbd3_m¬k_jouº®_em±y
(
jouº®
, 
REQ_SYNC
 | 
REQ_FUA
);

2061 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

2064 
no_»cov”y
:

2065  
”r
;

2066 
	}
}

2081 
	$__jbd3_jouº®_abÜt_h¬d
(
jouº®_t
 *
jouº®
)

2083 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

2085 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT
)

2088 
	`´štk
(
KERN_ERR
 "Aborting journal on device %s.\n",

2089 
jouº®
->
j_devÇme
);

2091 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2092 
jouº®
->
j_æags
 |ğ
JBD3_ABORT
;

2093 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

2094 ià(
Œª§ùiÚ
)

2095 
	`__jbd3_log_¡¬t_comm™
(
jouº®
, 
Œª§ùiÚ
->
t_tid
);

2096 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2097 
	}
}

2101 
	$__jouº®_abÜt_soá
 (
jouº®_t
 *
jouº®
, 
”ºo
)

2103 
Şd_”ºo
;

2105 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2106 
Şd_”ºo
 = 
jouº®
->
j_”ºo
;

2107 ià(!
jouº®
->
j_”ºo
 || 
”ºo
 =ğ-
ESHUTDOWN
)

2108 
jouº®
->
j_”ºo
 = 
”ºo
;

2110 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT
) {

2111 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2112 ià(!
Şd_”ºo
 && old_”ºØ!ğ-
ESHUTDOWN
 &&

2113 
”ºo
 =ğ-
ESHUTDOWN
)

2114 
	`jbd3_jouº®_upd©e_sb_”ºo
(
jouº®
);

2117 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2119 
	`__jbd3_jouº®_abÜt_h¬d
(
jouº®
);

2121 ià(
”ºo
) {

2122 
	`jbd3_jouº®_upd©e_sb_”ºo
(
jouº®
);

2123 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2124 
jouº®
->
j_æags
 |ğ
JBD3_REC_ERR
;

2125 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2127 
	}
}

2175 
	$jbd3_jouº®_abÜt
(
jouº®_t
 *
jouº®
, 
”ºo
)

2177 
	`__jouº®_abÜt_soá
(
jouº®
, 
”ºo
);

2178 
	}
}

2191 
	$jbd3_jouº®_”ºo
(
jouº®_t
 *
jouº®
)

2193 
”r
;

2195 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

2196 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT
)

2197 
”r
 = -
EROFS
;

2199 
”r
 = 
jouº®
->
j_”ºo
;

2200 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

2201  
”r
;

2202 
	}
}

2211 
	$jbd3_jouº®_ş—r_”r
(
jouº®_t
 *
jouº®
)

2213 
”r
 = 0;

2215 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2216 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT
)

2217 
”r
 = -
EROFS
;

2219 
jouº®
->
j_”ºo
 = 0;

2220 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2221  
”r
;

2222 
	}
}

2231 
	$jbd3_jouº®_ack_”r
(
jouº®_t
 *
jouº®
)

2233 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2234 ià(
jouº®
->
j_”ºo
)

2235 
jouº®
->
j_æags
 |ğ
JBD3_ACK_ERR
;

2236 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2237 
	}
}

2239 
	$jbd3_jouº®_blocks_³r_·ge
(
šode
 *inode)

2241  1 << (
PAGE_SHIFT
 - 
šode
->
i_sb
->
s_blocksize_b™s
);

2242 
	}
}

2247 
size_t
 
	$jouº®_g_by‹s
(
jouº®_t
 *
jouº®
)

2249 
size_t
 
sz
;

2251 ià(
	`jbd3_has_ã©u»_csum3
(
jouº®
))

2252  (
jouº®_block_g3_t
);

2254 
sz
 = (
jouº®_block_g_t
);

2256 ià(
	`jbd3_has_ã©u»_csum2
(
jouº®
))

2257 
sz
 +ğ(
__u16
);

2259 ià(
	`jbd3_has_ã©u»_64b™
(
jouº®
))

2260  
sz
;

2262  
sz
 - (
__u32
);

2263 
	}
}

2280 
	#JBD3_MAX_SLABS
 8

	)

2281 
kmem_ÿche
 *
	gjbd3_¦ab
[
JBD3_MAX_SLABS
];

2283 cÚ¡ *
	gjbd3_¦ab_Çmes
[
JBD3_MAX_SLABS
] = {

2289 
	$jbd3_jouº®_de¡roy_¦abs
()

2291 
i
;

2293 
i
 = 0; i < 
JBD3_MAX_SLABS
; i++) {

2294 
	`kmem_ÿche_de¡roy
(
jbd3_¦ab
[
i
]);

2295 
jbd3_¦ab
[
i
] = 
NULL
;

2297 
	}
}

2299 
	$jbd3_jouº®_ü—‹_¦ab
(
size_t
 
size
)

2301 
	`DEFINE_MUTEX
(
jbd3_¦ab_ü—‹_mu‹x
);

2302 
i
 = 
	`Üd”_ba£_2
(
size
) - 10;

2303 
size_t
 
¦ab_size
;

2305 ià(
size
 =ğ
PAGE_SIZE
)

2308 ià(
i
 >ğ
JBD3_MAX_SLABS
)

2309  -
EINVAL
;

2311 ià(
	`uÆik–y
(
i
 < 0))

2312 
i
 = 0;

2313 
	`mu‹x_lock
(&
jbd3_¦ab_ü—‹_mu‹x
);

2314 ià(
jbd3_¦ab
[
i
]) {

2315 
	`mu‹x_uÆock
(&
jbd3_¦ab_ü—‹_mu‹x
);

2319 
¦ab_size
 = 1 << (
i
+10);

2320 
jbd3_¦ab
[
i
] = 
	`kmem_ÿche_ü—‹
(
jbd3_¦ab_Çmes
[i], 
¦ab_size
,

2321 
¦ab_size
, 0, 
NULL
);

2322 
	`mu‹x_uÆock
(&
jbd3_¦ab_ü—‹_mu‹x
);

2323 ià(!
jbd3_¦ab
[
i
]) {

2324 
	`´štk
(
KERN_EMERG
 "JBD3:‚o memory for jbd3_slab cache\n");

2325  -
ENOMEM
;

2328 
	}
}

2330 
kmem_ÿche
 *
	$g‘_¦ab
(
size_t
 
size
)

2332 
i
 = 
	`Üd”_ba£_2
(
size
) - 10;

2334 
	`BUG_ON
(
i
 >ğ
JBD3_MAX_SLABS
);

2335 ià(
	`uÆik–y
(
i
 < 0))

2336 
i
 = 0;

2337 
	`BUG_ON
(
jbd3_¦ab
[
i
] =ğ
NULL
);

2338  
jbd3_¦ab
[
i
];

2339 
	}
}

2341 *
	$jbd3_®loc
(
size_t
 
size
, 
gå_t
 
æags
)

2343 *
±r
;

2345 
	`BUG_ON
(
size
 & (size-1));

2347 ià(
size
 < 
PAGE_SIZE
)

2348 
±r
 = 
	`kmem_ÿche_®loc
(
	`g‘_¦ab
(
size
), 
æags
);

2350 
±r
 = (*)
	`__g‘_ä“_·ges
(
æags
, 
	`g‘_Üd”
(
size
));

2354 
	`BUG_ON
(((è
±r
è& (
size
-1));

2356  
±r
;

2357 
	}
}

2359 
	$jbd3_ä“
(*
±r
, 
size_t
 
size
)

2361 ià(
size
 < 
PAGE_SIZE
)

2362 
	`kmem_ÿche_ä“
(
	`g‘_¦ab
(
size
), 
±r
);

2364 
	`ä“_·ges
(()
±r
, 
	`g‘_Üd”
(
size
));

2365 
	}
};

2370 
kmem_ÿche
 *
	gjbd3_jouº®_h—d_ÿche
;

2371 #ifdeà
CONFIG_JBD3_DEBUG


2372 
©omic_t
 
	gÄ_jouº®_h—ds
 = 
ATOMIC_INIT
(0);

2375 
__š™
 
	$jbd3_jouº®_š™_jouº®_h—d_ÿche
()

2377 
	`J_ASSERT
(!
jbd3_jouº®_h—d_ÿche
);

2378 
jbd3_jouº®_h—d_ÿche
 = 
	`kmem_ÿche_ü—‹
("jbd3_journal_head",

2379 (
jouº®_h—d
),

2381 
SLAB_TEMPORARY
 | 
SLAB_TYPESAFE_BY_RCU
,

2382 
NULL
);

2383 ià(!
jbd3_jouº®_h—d_ÿche
) {

2384 
	`´štk
(
KERN_EMERG
 "JBD3:‚o memory for journal_head cache\n");

2385  -
ENOMEM
;

2388 
	}
}

2390 
	$jbd3_jouº®_de¡roy_jouº®_h—d_ÿche
()

2392 
	`kmem_ÿche_de¡roy
(
jbd3_jouº®_h—d_ÿche
);

2393 
jbd3_jouº®_h—d_ÿche
 = 
NULL
;

2394 
	}
}

2399 
jouº®_h—d
 *
	$jouº®_®loc_jouº®_h—d
()

2401 
jouº®_h—d
 *
»t
;

2403 #ifdeà
CONFIG_JBD3_DEBUG


2404 
	`©omic_šc
(&
Ä_jouº®_h—ds
);

2406 
»t
 = 
	`kmem_ÿche_z®loc
(
jbd3_jouº®_h—d_ÿche
, 
GFP_NOFS
);

2407 ià(!
»t
) {

2408 
	`jbd_debug
(1, "out of memory for journal_head\n");

2409 
	`´_nÙiû_¿‹lim™ed
("ENOMEM iÀ%s,„‘ryšg.\n", 
__func__
);

2410 
»t
 = 
	`kmem_ÿche_z®loc
(
jbd3_jouº®_h—d_ÿche
,

2411 
GFP_NOFS
 | 
__GFP_NOFAIL
);

2413  
»t
;

2414 
	}
}

2416 
	$jouº®_ä“_jouº®_h—d
(
jouº®_h—d
 *
jh
)

2418 #ifdeà
CONFIG_JBD3_DEBUG


2419 
	`©omic_dec
(&
Ä_jouº®_h—ds
);

2420 
	`mem£t
(
jh
, 
JBD3_POISON_FREE
, (*jh));

2422 
	`kmem_ÿche_ä“
(
jbd3_jouº®_h—d_ÿche
, 
jh
);

2423 
	}
}

2466 
jouº®_h—d
 *
	$jbd3_jouº®_add_jouº®_h—d
(
bufãr_h—d
 *
bh
)

2468 
jouº®_h—d
 *
jh
;

2469 
jouº®_h—d
 *
Ãw_jh
 = 
NULL
;

2471 
»³©
:

2472 ià(!
	`bufãr_jbd
(
bh
))

2473 
Ãw_jh
 = 
	`jouº®_®loc_jouº®_h—d
();

2475 
	`jbd_lock_bh_jouº®_h—d
(
bh
);

2476 ià(
	`bufãr_jbd
(
bh
)) {

2477 
jh
 = 
	`bh2jh
(
bh
);

2479 
	`J_ASSERT_BH
(
bh
,

2480 (
	`©omic_»ad
(&
bh
->
b_couÁ
) > 0) ||

2481 (
bh
->
b_·ge
 && bh->b_·ge->
m­pšg
));

2483 ià(!
Ãw_jh
) {

2484 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2485 
»³©
;

2488 
jh
 = 
Ãw_jh
;

2489 
Ãw_jh
 = 
NULL
;

2490 
	`£t_bufãr_jbd
(
bh
);

2491 
bh
->
b_´iv©e
 = 
jh
;

2492 
jh
->
b_bh
 = 
bh
;

2493 
	`g‘_bh
(
bh
);

2494 
	`BUFFER_TRACE
(
bh
, "added journal_head");

2496 
jh
->
b_jcouÁ
++;

2497 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2498 ià(
Ãw_jh
)

2499 
	`jouº®_ä“_jouº®_h—d
(
Ãw_jh
);

2500  
bh
->
b_´iv©e
;

2501 
	}
}

2507 
jouº®_h—d
 *
	$jbd3_jouº®_g¿b_jouº®_h—d
(
bufãr_h—d
 *
bh
)

2509 
jouº®_h—d
 *
jh
 = 
NULL
;

2511 
	`jbd_lock_bh_jouº®_h—d
(
bh
);

2512 ià(
	`bufãr_jbd
(
bh
)) {

2513 
jh
 = 
	`bh2jh
(
bh
);

2514 
jh
->
b_jcouÁ
++;

2516 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2517  
jh
;

2518 
	}
}

2520 
	$__jouº®_»move_jouº®_h—d
(
bufãr_h—d
 *
bh
)

2522 
jouº®_h—d
 *
jh
 = 
	`bh2jh
(
bh
);

2524 
	`J_ASSERT_JH
(
jh
, jh->
b_jcouÁ
 >= 0);

2525 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
NULL
);

2526 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

2527 
	`J_ASSERT_JH
(
jh
, jh->
b_ı_Œª§ùiÚ
 =ğ
NULL
);

2528 
	`J_ASSERT_JH
(
jh
, jh->
b_jli¡
 =ğ
BJ_NÚe
);

2529 
	`J_ASSERT_BH
(
bh
, 
	`bufãr_jbd
(bh));

2530 
	`J_ASSERT_BH
(
bh
, 
	`jh2bh
(
jh
) == bh);

2531 
	`BUFFER_TRACE
(
bh
, "remove journal_head");

2532 ià(
jh
->
b_äoz’_d©a
) {

2533 
	`´štk
(
KERN_WARNING
 "%s: f»ešg b_äoz’_d©a\n", 
__func__
);

2534 
	`jbd3_ä“
(
jh
->
b_äoz’_d©a
, 
bh
->
b_size
);

2536 ià(
jh
->
b_comm™‹d_d©a
) {

2537 
	`´štk
(
KERN_WARNING
 "%s: f»ešg b_comm™‹d_d©a\n", 
__func__
);

2538 
	`jbd3_ä“
(
jh
->
b_comm™‹d_d©a
, 
bh
->
b_size
);

2540 
bh
->
b_´iv©e
 = 
NULL
;

2541 
jh
->
b_bh
 = 
NULL
;

2542 
	`ş—r_bufãr_jbd
(
bh
);

2543 
	`jouº®_ä“_jouº®_h—d
(
jh
);

2544 
	}
}

2550 
	$jbd3_jouº®_put_jouº®_h—d
(
jouº®_h—d
 *
jh
)

2552 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2554 
	`jbd_lock_bh_jouº®_h—d
(
bh
);

2555 
	`J_ASSERT_JH
(
jh
, jh->
b_jcouÁ
 > 0);

2556 --
jh
->
b_jcouÁ
;

2557 ià(!
jh
->
b_jcouÁ
) {

2558 
	`__jouº®_»move_jouº®_h—d
(
bh
);

2559 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2560 
	`__b»l£
(
bh
);

2562 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2563 
	}
}

2568 
	$jbd3_jouº®_š™_jbd_šode
(
jbd3_šode
 *
jšode
, 
šode
 *inode)

2570 
jšode
->
i_Œª§ùiÚ
 = 
NULL
;

2571 
jšode
->
i_Ãxt_Œª§ùiÚ
 = 
NULL
;

2572 
jšode
->
i_vfs_šode
 = 
šode
;

2573 
jšode
->
i_æags
 = 0;

2574 
jšode
->
i_dœty_¡¬t
 = 0;

2575 
jšode
->
i_dœty_’d
 = 0;

2576 
	`INIT_LIST_HEAD
(&
jšode
->
i_li¡
);

2577 
	}
}

2584 
	$jbd3_jouº®_»Ëa£_jbd_šode
(
jouº®_t
 *
jouº®
,

2585 
jbd3_šode
 *
jšode
)

2587 ià(!
jouº®
)

2589 
»¡¬t
:

2590 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2592 ià(
jšode
->
i_æags
 & 
JI_COMMIT_RUNNING
) {

2593 
wa™_queue_h—d_t
 *
wq
;

2594 
	`DEFINE_WAIT_BIT
(
wa™
, &
jšode
->
i_æags
, 
__JI_COMMIT_RUNNING
);

2595 
wq
 = 
	`b™_wa™queue
(&
jšode
->
i_æags
, 
__JI_COMMIT_RUNNING
);

2596 
	`´•¬e_to_wa™
(
wq
, &
wa™
.
wq_’Œy
, 
TASK_UNINTERRUPTIBLE
);

2597 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2598 
	`scheduË
();

2599 
	`fšish_wa™
(
wq
, &
wa™
.
wq_’Œy
);

2600 
»¡¬t
;

2603 ià(
jšode
->
i_Œª§ùiÚ
) {

2604 
	`li¡_d–
(&
jšode
->
i_li¡
);

2605 
jšode
->
i_Œª§ùiÚ
 = 
NULL
;

2607 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2608 
	}
}

2611 #ifdeà
CONFIG_PROC_FS


2613 
	#JBD3_STATS_PROC_NAME
 "fs/jbd3"

	)

2615 
__š™
 
	$jbd3_ü—‹_jbd_¡©s_´oc_’Œy
()

2617 
´oc_jbd3_¡©s
 = 
	`´oc_mkdœ
(
JBD3_STATS_PROC_NAME
, 
NULL
);

2618 
	}
}

2620 
__ex™
 
	$jbd3_»move_jbd_¡©s_´oc_’Œy
()

2622 ià(
´oc_jbd3_¡©s
)

2623 
	`»move_´oc_’Œy
(
JBD3_STATS_PROC_NAME
, 
NULL
);

2624 
	}
}

2628 
	#jbd3_ü—‹_jbd_¡©s_´oc_’Œy
(èdØ{} 0)

	)

2629 
	#jbd3_»move_jbd_¡©s_´oc_’Œy
(èdØ{} 0)

	)

2633 
kmem_ÿche
 *
	gjbd3_hªdË_ÿche
, *
	gjbd3_šode_ÿche
;

2635 
__š™
 
	$jbd3_jouº®_š™_šode_ÿche
()

2637 
	`J_ASSERT
(!
jbd3_šode_ÿche
);

2638 
jbd3_šode_ÿche
 = 
	`KMEM_CACHE
(
jbd3_šode
, 0);

2639 ià(!
jbd3_šode_ÿche
) {

2640 
	`´_em”g
("JBD3: failedo create inode cache\n");

2641  -
ENOMEM
;

2644 
	}
}

2646 
__š™
 
	$jbd3_jouº®_š™_hªdË_ÿche
()

2648 
	`J_ASSERT
(!
jbd3_hªdË_ÿche
);

2649 
jbd3_hªdË_ÿche
 = 
	`KMEM_CACHE
(
jbd3_jouº®_hªdË
, 
SLAB_TEMPORARY
);

2650 ià(!
jbd3_hªdË_ÿche
) {

2651 
	`´štk
(
KERN_EMERG
 "JBD3: failedo create handle cache\n");

2652  -
ENOMEM
;

2655 
	}
}

2657 
	$jbd3_jouº®_de¡roy_šode_ÿche
()

2659 
	`kmem_ÿche_de¡roy
(
jbd3_šode_ÿche
);

2660 
jbd3_šode_ÿche
 = 
NULL
;

2661 
	}
}

2663 
	$jbd3_jouº®_de¡roy_hªdË_ÿche
()

2665 
	`kmem_ÿche_de¡roy
(
jbd3_hªdË_ÿche
);

2666 
jbd3_hªdË_ÿche
 = 
NULL
;

2667 
	}
}

2673 
__š™
 
	$jouº®_š™_ÿches
()

2675 
»t
;

2677 
»t
 = 
	`jbd3_jouº®_š™_»voke_»cÜd_ÿche
();

2678 ià(
»t
 == 0)

2679 
»t
 = 
	`jbd3_jouº®_š™_»voke_bË_ÿche
();

2680 ià(
»t
 == 0)

2681 
»t
 = 
	`jbd3_jouº®_š™_jouº®_h—d_ÿche
();

2682 ià(
»t
 == 0)

2683 
»t
 = 
	`jbd3_jouº®_š™_hªdË_ÿche
();

2684 ià(
»t
 == 0)

2685 
»t
 = 
	`jbd3_jouº®_š™_šode_ÿche
();

2686 ià(
»t
 == 0)

2687 
»t
 = 
	`jbd3_jouº®_š™_Œª§ùiÚ_ÿche
();

2688  
»t
;

2689 
	}
}

2691 
	$jbd3_jouº®_de¡roy_ÿches
()

2693 
	`jbd3_jouº®_de¡roy_»voke_»cÜd_ÿche
();

2694 
	`jbd3_jouº®_de¡roy_»voke_bË_ÿche
();

2695 
	`jbd3_jouº®_de¡roy_jouº®_h—d_ÿche
();

2696 
	`jbd3_jouº®_de¡roy_hªdË_ÿche
();

2697 
	`jbd3_jouº®_de¡roy_šode_ÿche
();

2698 
	`jbd3_jouº®_de¡roy_Œª§ùiÚ_ÿche
();

2699 
	`jbd3_jouº®_de¡roy_¦abs
();

2700 
	}
}

2702 
__š™
 
	$jouº®_š™
()

2704 
»t
;

2706 
	`BUILD_BUG_ON
((
jouº®_su³rblock_s
) != 1024);

2708 
»t
 = 
	`jouº®_š™_ÿches
();

2709 ià(
»t
 == 0) {

2710 
	`jbd3_ü—‹_jbd_¡©s_´oc_’Œy
();

2712 
	`jbd3_jouº®_de¡roy_ÿches
();

2714  
»t
;

2715 
	}
}

2717 
__ex™
 
	$jouº®_ex™
()

2719 #ifdeà
CONFIG_JBD3_DEBUG


2720 
n
 = 
	`©omic_»ad
(&
Ä_jouº®_h—ds
);

2721 ià(
n
)

2722 
	`´štk
(
KERN_ERR
 "JBD3:†—ked %d jouº®_h—ds!\n", 
n
);

2724 
	`jbd3_»move_jbd_¡©s_´oc_’Œy
();

2725 
	`jbd3_jouº®_de¡roy_ÿches
();

2726 
	}
}

2728 
MODULE_LICENSE
("GPL");

2729 
moduË_š™
(
jouº®_š™
);

2730 
moduË_ex™
(
jouº®_ex™
);

	@recovery.c

13 #iâdeà
__KERNEL__


14 
	~"jfs_u£r.h
"

16 
	~<lšux/time.h
>

17 
	~<lšux/fs.h
>

18 
	~<lšux/jbd3.h
>

19 
	~<lšux/”ºo.h
>

20 
	~<lšux/üc32.h
>

21 
	~<lšux/blkdev.h
>

28 
	s»cov”y_šfo


30 
tid_t
 
	m¡¬t_Œª§ùiÚ
;

31 
tid_t
 
	m’d_Œª§ùiÚ
;

33 
	mÄ_»¶ays
;

34 
	mÄ_»vokes
;

35 
	mÄ_»voke_h™s
;

38 
	e·s¡y³
 {
	mPASS_SCAN
, 
	mPASS_REVOKE
, 
	mPASS_REPLAY
};

39 
do_Úe_·ss
(
jouº®_t
 *
jouº®
,

40 
»cov”y_šfo
 *
šfo
, 
·s¡y³
 
·ss
);

41 
sÿn_»voke_»cÜds
(
jouº®_t
 *, 
bufãr_h—d
 *,

42 
tid_t
, 
»cov”y_šfo
 *);

44 #ifdeà
__KERNEL__


47 
	$jouº®_b»l£_¬¿y
(
bufãr_h—d
 *
b
[], 
n
)

49 --
n
 >= 0)

50 
	`b»l£
 (
b
[
n
]);

51 
	}
}

66 
	#MAXBUF
 8

	)

67 
	$do_»adah—d
(
jouº®_t
 *
jouº®
, 
¡¬t
)

69 
”r
;

70 
max
, 
nbufs
, 
Ãxt
;

71 
blockÄ
;

72 
bufãr_h—d
 *
bh
;

74 
bufãr_h—d
 * 
bufs
[
MAXBUF
];

77 
max
 = 
¡¬t
 + (128 * 1024 / 
jouº®
->
j_blocksize
);

78 ià(
max
 > 
jouº®
->
j_maxËn
)

79 
max
 = 
jouº®
->
j_maxËn
;

84 
nbufs
 = 0;

86 
Ãxt
 = 
¡¬t
;‚exˆ< 
max
;‚ext++) {

87 
”r
 = 
	`jbd3_jouº®_bm­
(
jouº®
, 
Ãxt
, &
blockÄ
);

89 ià(
”r
) {

90 
	`´štk
(
KERN_ERR
 "JBD3: bad block‡t offset %u\n",

91 
Ãxt
);

92 
çed
;

95 
bh
 = 
	`__g‘blk
(
jouº®
->
j_dev
, 
blockÄ
, jouº®->
j_blocksize
);

96 ià(!
bh
) {

97 
”r
 = -
ENOMEM
;

98 
çed
;

101 ià(!
	`bufãr_u±od©e
(
bh
è&& !
	`bufãr_locked
(bh)) {

102 
bufs
[
nbufs
++] = 
bh
;

103 ià(
nbufs
 =ğ
MAXBUF
) {

104 
	`Î_rw_block
(
REQ_OP_READ
, 0, 
nbufs
, 
bufs
);

105 
	`jouº®_b»l£_¬¿y
(
bufs
, 
nbufs
);

106 
nbufs
 = 0;

109 
	`b»l£
(
bh
);

112 ià(
nbufs
)

113 
	`Î_rw_block
(
REQ_OP_READ
, 0, 
nbufs
, 
bufs
);

114 
”r
 = 0;

116 
çed
:

117 ià(
nbufs
)

118 
	`jouº®_b»l£_¬¿y
(
bufs
, 
nbufs
);

119  
”r
;

120 
	}
}

129 
	$j»ad
(
bufãr_h—d
 **
bhp
, 
jouº®_t
 *
jouº®
,

130 
off£t
)

132 
”r
;

133 
blockÄ
;

134 
bufãr_h—d
 *
bh
;

136 *
bhp
 = 
NULL
;

138 ià(
off£t
 >ğ
jouº®
->
j_maxËn
) {

139 
	`´štk
(
KERN_ERR
 "JBD3: corrupted journal superblock\n");

140  -
EFSCORRUPTED
;

143 
”r
 = 
	`jbd3_jouº®_bm­
(
jouº®
, 
off£t
, &
blockÄ
);

145 ià(
”r
) {

146 
	`´štk
(
KERN_ERR
 "JBD3: bad block‡t offset %u\n",

147 
off£t
);

148  
”r
;

151 
bh
 = 
	`__g‘blk
(
jouº®
->
j_dev
, 
blockÄ
, jouº®->
j_blocksize
);

152 ià(!
bh
)

153  -
ENOMEM
;

155 ià(!
	`bufãr_u±od©e
(
bh
)) {

158 ià(!
	`bufãr_»q
(
bh
))

159 
	`do_»adah—d
(
jouº®
, 
off£t
);

160 
	`wa™_Ú_bufãr
(
bh
);

163 ià(!
	`bufãr_u±od©e
(
bh
)) {

164 
	`´štk
(
KERN_ERR
 "JBD3: Failedo„ead block‡t offset %u\n",

165 
off£t
);

166 
	`b»l£
(
bh
);

167  -
EIO
;

170 *
bhp
 = 
bh
;

172 
	}
}

174 
	$jbd3_desütÜ_block_csum_v”ify
(
jouº®_t
 *
j
, *
buf
)

176 
jbd3_jouº®_block_
 *

;

177 
__be32
 
´ovided
;

178 
__u32
 
ÿlcuÏ‹d
;

180 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

183 

 = (
jbd3_jouº®_block_
 *)(
buf
 + 
j
->
j_blocksize
 -

184 (
jbd3_jouº®_block_
));

185 
´ovided
 = 

->
t_checksum
;

186 

->
t_checksum
 = 0;

187 
ÿlcuÏ‹d
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
buf
, j->
j_blocksize
);

188 

->
t_checksum
 = 
´ovided
;

190  
´ovided
 =ğ
	`ıu_to_be32
(
ÿlcuÏ‹d
);

191 
	}
}

197 
	$couÁ_gs
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
)

199 * 
gp
;

200 
jouº®_block_g_t
 * 
g
;

201 
Ä
 = 0, 
size
 = 
jouº®
->
j_blocksize
;

202 
g_by‹s
 = 
	`jouº®_g_by‹s
(
jouº®
);

204 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

205 
size
 -ğ(
jbd3_jouº®_block_
);

207 
gp
 = &
bh
->
b_d©a
[(
jouº®_h—d”_t
)];

209 (
gp
 - 
bh
->
b_d©a
 + 
g_by‹s
è<ğ
size
) {

210 
g
 = (
jouº®_block_g_t
 *è
gp
;

212 
Ä
++;

213 
gp
 +ğ
g_by‹s
;

214 ià(!(
g
->
t_æags
 & 
	`ıu_to_be16
(
JBD3_FLAG_SAME_UUID
)))

215 
gp
 += 16;

217 ià(
g
->
t_æags
 & 
	`ıu_to_be16
(
JBD3_FLAG_LAST_TAG
))

221  
Ä
;

222 
	}
}

226 
	#w¿p
(
jouº®
, 
v¬
) \

228 ià(
v¬
 >ğ(
jouº®
)->
j_Ï¡
) \

229 
v¬
 -ğ((
jouº®
)->
j_Ï¡
 - (jouº®)->
j_fœ¡
); \

230 } 0)

	)

244 
	$jbd3_jouº®_»cov”
(
jouº®_t
 *
jouº®
)

246 
”r
, 
”r2
;

247 
jouº®_su³rblock_t
 * 
sb
;

249 
»cov”y_šfo
 
šfo
;

251 
	`mem£t
(&
šfo
, 0, (info));

252 
sb
 = 
jouº®
->
j_su³rblock
;

260 ià(!
sb
->
s_¡¬t
) {

261 
	`jbd_debug
(1, "No„ecovery„equired,†astransaction %d\n",

262 
	`be32_to_ıu
(
sb
->
s_£qu’û
));

263 
jouº®
->
j_Œª§ùiÚ_£qu’û
 = 
	`be32_to_ıu
(
sb
->
s_£qu’û
) + 1;

267 
”r
 = 
	`do_Úe_·ss
(
jouº®
, &
šfo
, 
PASS_SCAN
);

268 ià(!
”r
)

269 
”r
 = 
	`do_Úe_·ss
(
jouº®
, &
šfo
, 
PASS_REVOKE
);

270 ià(!
”r
)

271 
”r
 = 
	`do_Úe_·ss
(
jouº®
, &
šfo
, 
PASS_REPLAY
);

273 
	`jbd_debug
(1, "JBD3:„ecovery,ƒxit status %d, "

275 
”r
, 
šfo
.
¡¬t_Œª§ùiÚ
, info.
’d_Œª§ùiÚ
);

276 
	`jbd_debug
(1, "JBD3: Replayed %d‡nd„evoked %d/%d blocks\n",

277 
šfo
.
Ä_»¶ays
, info.
Ä_»voke_h™s
, info.
Ä_»vokes
);

281 
jouº®
->
j_Œª§ùiÚ_£qu’û
 = ++
šfo
.
’d_Œª§ùiÚ
;

283 
	`jbd3_jouº®_ş—r_»voke
(
jouº®
);

284 
”r2
 = 
	`sync_blockdev
(
jouº®
->
j_fs_dev
);

285 ià(!
”r
)

286 
”r
 = 
”r2
;

288 ià(
jouº®
->
j_æags
 & 
JBD3_BARRIER
) {

289 
”r2
 = 
	`blkdev_issue_æush
(
jouº®
->
j_fs_dev
, 
GFP_KERNEL
, 
NULL
);

290 ià(!
”r
)

291 
”r
 = 
”r2
;

293  
”r
;

294 
	}
}

309 
	$jbd3_jouº®_sk_»cov”y
(
jouº®_t
 *
jouº®
)

311 
”r
;

313 
»cov”y_šfo
 
šfo
;

315 
	`mem£t
 (&
šfo
, 0, (info));

317 
”r
 = 
	`do_Úe_·ss
(
jouº®
, &
šfo
, 
PASS_SCAN
);

319 ià(
”r
) {

320 
	`´štk
(
KERN_ERR
 "JBD3:ƒ¼Ü %d sÿÂšg jouº®\n", 
”r
);

321 ++
jouº®
->
j_Œª§ùiÚ_£qu’û
;

323 #ifdeà
CONFIG_JBD3_DEBUG


324 
drİ³d
 = 
šfo
.
’d_Œª§ùiÚ
 -

325 
	`be32_to_ıu
(
jouº®
->
j_su³rblock
->
s_£qu’û
);

326 
	`jbd_debug
(1,

328 
drİ³d
, (dropped == 1) ? "" : "s");

330 
jouº®
->
j_Œª§ùiÚ_£qu’û
 = ++
šfo
.
’d_Œª§ùiÚ
;

333 
jouº®
->
j_
 = 0;

334  
”r
;

335 
	}
}

337 
šlše
 
	$»ad_g_block
(
jouº®_t
 *
jouº®
,

338 
jouº®_block_g_t
 *
g
)

340 
block
 = 
	`be32_to_ıu
(
g
->
t_blockÄ
);

341 ià(
	`jbd3_has_ã©u»_64b™
(
jouº®
))

342 
block
 |ğ(
u64
)
	`be32_to_ıu
(
g
->
t_blockÄ_high
) << 32;

343  
block
;

344 
	}
}

350 
	$ÿlc_chksums
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
,

351 *
Ãxt_log_block
, 
__u32
 *
üc32_sum
)

353 
i
, 
num_blks
, 
”r
;

354 
io_block
;

355 
bufãr_h—d
 *
obh
;

357 
num_blks
 = 
	`couÁ_gs
(
jouº®
, 
bh
);

359 *
üc32_sum
 = 
	`üc32_be
(*üc32_sum, (*)
bh
->
b_d©a
, bh->
b_size
);

361 
i
 = 0; i < 
num_blks
; i++) {

362 
io_block
 = (*
Ãxt_log_block
)++;

363 
	`w¿p
(
jouº®
, *
Ãxt_log_block
);

364 
”r
 = 
	`j»ad
(&
obh
, 
jouº®
, 
io_block
);

365 ià(
”r
) {

366 
	`´štk
(
KERN_ERR
 "JBD3: IOƒrror %d„ecovering block "

367 "%lu iÀlog\n", 
”r
, 
io_block
);

370 *
üc32_sum
 = 
	`üc32_be
(*üc32_sum, (*)
obh
->
b_d©a
,

371 
obh
->
b_size
);

373 
	`put_bh
(
obh
);

376 
	}
}

378 
	$jbd3_comm™_block_csum_v”ify
(
jouº®_t
 *
j
, *
buf
)

380 
comm™_h—d”
 *
h
;

381 
__be32
 
´ovided
;

382 
__u32
 
ÿlcuÏ‹d
;

384 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

387 
h
 = 
buf
;

388 
´ovided
 = 
h
->
h_chksum
[0];

389 
h
->
h_chksum
[0] = 0;

390 
ÿlcuÏ‹d
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
buf
, j->
j_blocksize
);

391 
h
->
h_chksum
[0] = 
´ovided
;

393  
´ovided
 =ğ
	`ıu_to_be32
(
ÿlcuÏ‹d
);

394 
	}
}

396 
	$jbd3_block_g_csum_v”ify
(
jouº®_t
 *
j
, 
jouº®_block_g_t
 *
g
,

397 *
buf
, 
__u32
 
£qu’û
)

399 
jouº®_block_g3_t
 *
g3
 = (jouº®_block_g3_ˆ*)
g
;

400 
__u32
 
csum32
;

401 
__be32
 
£q
;

403 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

406 
£q
 = 
	`ıu_to_be32
(
£qu’û
);

407 
csum32
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, (
__u8
 *)&
£q
, (seq));

408 
csum32
 = 
	`jbd3_chksum
(
j
, csum32, 
buf
, j->
j_blocksize
);

410 ià(
	`jbd3_has_ã©u»_csum3
(
j
))

411  
g3
->
t_checksum
 =ğ
	`ıu_to_be32
(
csum32
);

413  
g
->
t_checksum
 =ğ
	`ıu_to_be16
(
csum32
);

414 
	}
}

416 
	$do_Úe_·ss
(
jouº®_t
 *
jouº®
,

417 
»cov”y_šfo
 *
šfo
, 
·s¡y³
 
·ss
)

419 
fœ¡_comm™_ID
, 
Ãxt_comm™_ID
;

420 
Ãxt_log_block
;

421 
”r
, 
sucûss
 = 0;

422 
jouº®_su³rblock_t
 * 
sb
;

423 
jouº®_h—d”_t
 * 
tmp
;

424 
bufãr_h—d
 * 
bh
;

425 
£qu’û
;

426 
blockty³
;

427 
g_by‹s
 = 
	`jouº®_g_by‹s
(
jouº®
);

428 
__u32
 
üc32_sum
 = ~0;

429 
desü_csum_size
 = 0;

430 
block_”rÜ
 = 0;

438 
sb
 = 
jouº®
->
j_su³rblock
;

439 
Ãxt_comm™_ID
 = 
	`be32_to_ıu
(
sb
->
s_£qu’û
);

440 
Ãxt_log_block
 = 
	`be32_to_ıu
(
sb
->
s_¡¬t
);

442 
fœ¡_comm™_ID
 = 
Ãxt_comm™_ID
;

443 ià(
·ss
 =ğ
PASS_SCAN
)

444 
šfo
->
¡¬t_Œª§ùiÚ
 = 
fœ¡_comm™_ID
;

446 
	`jbd_debug
(1, "S¹šg„ecov”y…as %d\n", 
·ss
);

456 
æags
;

457 * 
gp
;

458 
jouº®_block_g_t
 * 
g
;

459 
bufãr_h—d
 * 
obh
;

460 
bufãr_h—d
 * 
nbh
;

462 
	`cÚd_»sched
();

468 ià(
·ss
 !ğ
PASS_SCAN
)

469 ià(
	`tid_geq
(
Ãxt_comm™_ID
, 
šfo
->
’d_Œª§ùiÚ
))

472 
	`jbd_debug
(2, "Scanning for sequence ID %u‡t %lu/%lu\n",

473 
Ãxt_comm™_ID
, 
Ãxt_log_block
, 
jouº®
->
j_Ï¡
);

479 
	`jbd_debug
(3, "JBD3: checkšg block %ld\n", 
Ãxt_log_block
);

480 
”r
 = 
	`j»ad
(&
bh
, 
jouº®
, 
Ãxt_log_block
);

481 ià(
”r
)

482 
çed
;

484 
Ãxt_log_block
++;

485 
	`w¿p
(
jouº®
, 
Ãxt_log_block
);

493 
tmp
 = (
jouº®_h—d”_t
 *)
bh
->
b_d©a
;

495 ià(
tmp
->
h_magic
 !ğ
	`ıu_to_be32
(
JBD3_MAGIC_NUMBER
)) {

496 
	`b»l£
(
bh
);

500 
blockty³
 = 
	`be32_to_ıu
(
tmp
->
h_blockty³
);

501 
£qu’û
 = 
	`be32_to_ıu
(
tmp
->
h_£qu’û
);

502 
	`jbd_debug
(3, "Found magic %d, sequence %d\n",

503 
blockty³
, 
£qu’û
);

505 ià(
£qu’û
 !ğ
Ãxt_comm™_ID
) {

506 
	`b»l£
(
bh
);

514 
blockty³
) {

515 
JBD3_DESCRIPTOR_BLOCK
:

517 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

518 
desü_csum_size
 =

519 (
jbd3_jouº®_block_
);

520 ià(
desü_csum_size
 > 0 &&

521 !
	`jbd3_desütÜ_block_csum_v”ify
(
jouº®
,

522 
bh
->
b_d©a
)) {

523 
	`´štk
(
KERN_ERR
 "JBD3: Invalid checksum "

525 
Ãxt_log_block
);

526 
”r
 = -
EFSBADCRC
;

527 
	`b»l£
(
bh
);

528 
çed
;

535 ià(
·ss
 !ğ
PASS_REPLAY
) {

536 ià(
·ss
 =ğ
PASS_SCAN
 &&

537 
	`jbd3_has_ã©u»_checksum
(
jouº®
) &&

538 !
šfo
->
’d_Œª§ùiÚ
) {

539 ià(
	`ÿlc_chksums
(
jouº®
, 
bh
,

540 &
Ãxt_log_block
,

541 &
üc32_sum
)) {

542 
	`put_bh
(
bh
);

545 
	`put_bh
(
bh
);

548 
Ãxt_log_block
 +ğ
	`couÁ_gs
(
jouº®
, 
bh
);

549 
	`w¿p
(
jouº®
, 
Ãxt_log_block
);

550 
	`put_bh
(
bh
);

558 
gp
 = &
bh
->
b_d©a
[(
jouº®_h—d”_t
)];

559 (
gp
 - 
bh
->
b_d©a
 + 
g_by‹s
)

560 <ğ
jouº®
->
j_blocksize
 - 
desü_csum_size
) {

561 
io_block
;

563 
g
 = (
jouº®_block_g_t
 *è
gp
;

564 
æags
 = 
	`be16_to_ıu
(
g
->
t_æags
);

566 
io_block
 = 
Ãxt_log_block
++;

567 
	`w¿p
(
jouº®
, 
Ãxt_log_block
);

568 
”r
 = 
	`j»ad
(&
obh
, 
jouº®
, 
io_block
);

569 ià(
”r
) {

572 
sucûss
 = 
”r
;

573 
	`´štk
(
KERN_ERR


576 
”r
, 
io_block
);

578 
blockÄ
;

580 
	`J_ASSERT
(
obh
 !ğ
NULL
);

581 
blockÄ
 = 
	`»ad_g_block
(
jouº®
,

582 
g
);

587 ià(
jbd3_jouº®_‹¡_»voke


588 (
jouº®
, 
blockÄ
,

589 
Ãxt_comm™_ID
)) {

590 
	`b»l£
(
obh
);

591 ++
šfo
->
Ä_»voke_h™s
;

592 
sk_wr™e
;

596 ià(!
	`jbd3_block_g_csum_v”ify
(

597 
jouº®
, 
g
, 
obh
->
b_d©a
,

598 
	`be32_to_ıu
(
tmp
->
h_£qu’û
))) {

599 
	`b»l£
(
obh
);

600 
sucûss
 = -
EFSBADCRC
;

601 
	`´štk
(
KERN_ERR
 "JBD3: Invalid "

604 "log\n", 
blockÄ
);

605 
block_”rÜ
 = 1;

606 
sk_wr™e
;

611 
nbh
 = 
	`__g‘blk
(
jouº®
->
j_fs_dev
,

612 
blockÄ
,

613 
jouº®
->
j_blocksize
);

614 ià(
nbh
 =ğ
NULL
) {

615 
	`´štk
(
KERN_ERR


618 
”r
 = -
ENOMEM
;

619 
	`b»l£
(
bh
);

620 
	`b»l£
(
obh
);

621 
çed
;

624 
	`lock_bufãr
(
nbh
);

625 
	`memıy
(
nbh
->
b_d©a
, 
obh
->b_data,

626 
jouº®
->
j_blocksize
);

627 ià(
æags
 & 
JBD3_FLAG_ESCAPE
) {

628 *((
__be32
 *)
nbh
->
b_d©a
) =

629 
	`ıu_to_be32
(
JBD3_MAGIC_NUMBER
);

632 
	`BUFFER_TRACE
(
nbh
, "marking dirty");

633 
	`£t_bufãr_u±od©e
(
nbh
);

634 
	`m¬k_bufãr_dœty
(
nbh
);

635 
	`BUFFER_TRACE
(
nbh
, "marking uptodate");

636 ++
šfo
->
Ä_»¶ays
;

638 
	`uÆock_bufãr
(
nbh
);

639 
	`b»l£
(
obh
);

640 
	`b»l£
(
nbh
);

643 
sk_wr™e
:

644 
gp
 +ğ
g_by‹s
;

645 ià(!(
æags
 & 
JBD3_FLAG_SAME_UUID
))

646 
gp
 += 16;

648 ià(
æags
 & 
JBD3_FLAG_LAST_TAG
)

652 
	`b»l£
(
bh
);

655 
JBD3_COMMIT_BLOCK
:

691 ià(
·ss
 =ğ
PASS_SCAN
 &&

692 
	`jbd3_has_ã©u»_checksum
(
jouº®
)) {

693 
chksum_”r
, 
chksum_£’
;

694 
comm™_h—d”
 *
cbh
 =

695 (
comm™_h—d”
 *)
bh
->
b_d©a
;

696 
found_chksum
 =

697 
	`be32_to_ıu
(
cbh
->
h_chksum
[0]);

699 
chksum_”r
 = 
chksum_£’
 = 0;

701 ià(
šfo
->
’d_Œª§ùiÚ
) {

702 
jouº®
->
j_çed_comm™
 =

703 
šfo
->
’d_Œª§ùiÚ
;

704 
	`b»l£
(
bh
);

708 ià(
üc32_sum
 =ğ
found_chksum
 &&

709 
cbh
->
h_chksum_ty³
 =ğ
JBD3_CRC32_CHKSUM
 &&

710 
cbh
->
h_chksum_size
 ==

711 
JBD3_CRC32_CHKSUM_SIZE
)

712 
chksum_£’
 = 1;

713 ià(!(
cbh
->
h_chksum_ty³
 == 0 &&

714 
cbh
->
h_chksum_size
 == 0 &&

715 
found_chksum
 == 0 &&

716 !
chksum_£’
))

727 
chksum_”r
 = 1;

729 ià(
chksum_”r
) {

730 
šfo
->
’d_Œª§ùiÚ
 = 
Ãxt_comm™_ID
;

732 ià(!
	`jbd3_has_ã©u»_async_comm™
(
jouº®
)) {

733 
jouº®
->
j_çed_comm™
 =

734 
Ãxt_comm™_ID
;

735 
	`b»l£
(
bh
);

739 
üc32_sum
 = ~0;

741 ià(
·ss
 =ğ
PASS_SCAN
 &&

742 !
	`jbd3_comm™_block_csum_v”ify
(
jouº®
,

743 
bh
->
b_d©a
)) {

744 
šfo
->
’d_Œª§ùiÚ
 = 
Ãxt_comm™_ID
;

746 ià(!
	`jbd3_has_ã©u»_async_comm™
(
jouº®
)) {

747 
jouº®
->
j_çed_comm™
 =

748 
Ãxt_comm™_ID
;

749 
	`b»l£
(
bh
);

753 
	`b»l£
(
bh
);

754 
Ãxt_comm™_ID
++;

757 
JBD3_REVOKE_BLOCK
:

760 ià(
·ss
 !ğ
PASS_REVOKE
) {

761 
	`b»l£
(
bh
);

765 
”r
 = 
	`sÿn_»voke_»cÜds
(
jouº®
, 
bh
,

766 
Ãxt_comm™_ID
, 
šfo
);

767 
	`b»l£
(
bh
);

768 ià(
”r
)

769 
çed
;

773 
	`jbd_debug
(3, "Unrecognised magic %d,ƒnd of scan.\n",

774 
blockty³
);

775 
	`b»l£
(
bh
);

776 
dÚe
;

780 
dÚe
:

788 ià(
·ss
 =ğ
PASS_SCAN
) {

789 ià(!
šfo
->
’d_Œª§ùiÚ
)

790 
šfo
->
’d_Œª§ùiÚ
 = 
Ãxt_comm™_ID
;

794 ià(
šfo
->
’d_Œª§ùiÚ
 !ğ
Ãxt_comm™_ID
) {

795 
	`´štk
(
KERN_ERR
 "JBD3:„ecovery…ass %dƒnded‡t "

797 
·ss
, 
Ãxt_comm™_ID
, 
šfo
->
’d_Œª§ùiÚ
);

798 ià(!
sucûss
)

799 
sucûss
 = -
EIO
;

802 ià(
block_”rÜ
 && 
sucûss
 == 0)

803 
sucûss
 = -
EIO
;

804  
sucûss
;

806 
çed
:

807  
”r
;

808 
	}
}

812 
	$sÿn_»voke_»cÜds
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
,

813 
tid_t
 
£qu’û
, 
»cov”y_šfo
 *
šfo
)

815 
jbd3_jouº®_»voke_h—d”_t
 *
h—d”
;

816 
off£t
, 
max
;

817 
csum_size
 = 0;

818 
__u32
 
rcouÁ
;

819 
»cÜd_Ën
 = 4;

821 
h—d”
 = (
jbd3_jouº®_»voke_h—d”_t
 *è
bh
->
b_d©a
;

822 
off£t
 = (
jbd3_jouº®_»voke_h—d”_t
);

823 
rcouÁ
 = 
	`be32_to_ıu
(
h—d”
->
r_couÁ
);

825 ià(!
	`jbd3_desütÜ_block_csum_v”ify
(
jouº®
, 
h—d”
))

826  -
EFSBADCRC
;

828 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

829 
csum_size
 = (
jbd3_jouº®_block_
);

830 ià(
rcouÁ
 > 
jouº®
->
j_blocksize
 - 
csum_size
)

831  -
EINVAL
;

832 
max
 = 
rcouÁ
;

834 ià(
	`jbd3_has_ã©u»_64b™
(
jouº®
))

835 
»cÜd_Ën
 = 8;

837 
off£t
 + 
»cÜd_Ën
 <ğ
max
) {

838 
blockÄ
;

839 
”r
;

841 ià(
»cÜd_Ën
 == 4)

842 
blockÄ
 = 
	`be32_to_ıu
(* ((
__be32
 *è(
bh
->
b_d©a
+
off£t
)));

844 
blockÄ
 = 
	`be64_to_ıu
(* ((
__be64
 *è(
bh
->
b_d©a
+
off£t
)));

845 
off£t
 +ğ
»cÜd_Ën
;

846 
”r
 = 
	`jbd3_jouº®_£t_»voke
(
jouº®
, 
blockÄ
, 
£qu’û
);

847 ià(
”r
)

848  
”r
;

849 ++
šfo
->
Ä_»vokes
;

852 
	}
}

	@revoke.c

80 #iâdeà
__KERNEL__


81 
	~"jfs_u£r.h
"

83 
	~<lšux/time.h
>

84 
	~<lšux/fs.h
>

85 
	~<lšux/jbd3.h
>

86 
	~<lšux/”ºo.h
>

87 
	~<lšux/¦ab.h
>

88 
	~<lšux/li¡.h
>

89 
	~<lšux/š™.h
>

90 
	~<lšux/bio.h
>

91 
	~<lšux/log2.h
>

92 
	~<lšux/hash.h
>

95 
kmem_ÿche
 *
	gjbd3_»voke_»cÜd_ÿche
;

96 
kmem_ÿche
 *
	gjbd3_»voke_bË_ÿche
;

102 
	sjbd3_»voke_»cÜd_s


104 
li¡_h—d
 
	mhash
;

105 
tid_t
 
	m£qu’û
;

106 
	mblockÄ
;

111 
	sjbd3_»voke_bË_s


115 
	mhash_size
;

116 
	mhash_shiá
;

117 
li¡_h—d
 *
	mhash_bË
;

121 #ifdeà
__KERNEL__


122 
wr™e_Úe_»voke_»cÜd
(
Œª§ùiÚ_t
 *,

123 
li¡_h—d
 *,

124 
bufãr_h—d
 **, *,

125 
jbd3_»voke_»cÜd_s
 *);

126 
æush_desütÜ
(
jouº®_t
 *, 
bufãr_h—d
 *, );

131 
šlše
 
	$hash
(
jouº®_t
 *
jouº®
, 
block
)

133  
	`hash_64
(
block
, 
jouº®
->
j_»voke
->
hash_shiá
);

134 
	}
}

136 
	$š£¹_»voke_hash
(
jouº®_t
 *
jouº®
, 
blockÄ
,

137 
tid_t
 
£q
)

139 
li¡_h—d
 *
hash_li¡
;

140 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

141 
gå_t
 
gå_mask
 = 
GFP_NOFS
;

143 ià(
jouº®_oom_»Œy
)

144 
gå_mask
 |ğ
__GFP_NOFAIL
;

145 
»cÜd
 = 
	`kmem_ÿche_®loc
(
jbd3_»voke_»cÜd_ÿche
, 
gå_mask
);

146 ià(!
»cÜd
)

147  -
ENOMEM
;

149 
»cÜd
->
£qu’û
 = 
£q
;

150 
»cÜd
->
blockÄ
 = blocknr;

151 
hash_li¡
 = &
jouº®
->
j_»voke
->
hash_bË
[
	`hash
(jouº®, 
blockÄ
)];

152 
	`¥š_lock
(&
jouº®
->
j_»voke_lock
);

153 
	`li¡_add
(&
»cÜd
->
hash
, 
hash_li¡
);

154 
	`¥š_uÆock
(&
jouº®
->
j_»voke_lock
);

156 
	}
}

160 
jbd3_»voke_»cÜd_s
 *
	$fšd_»voke_»cÜd
(
jouº®_t
 *
jouº®
,

161 
blockÄ
)

163 
li¡_h—d
 *
hash_li¡
;

164 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

166 
hash_li¡
 = &
jouº®
->
j_»voke
->
hash_bË
[
	`hash
(jouº®, 
blockÄ
)];

168 
	`¥š_lock
(&
jouº®
->
j_»voke_lock
);

169 
»cÜd
 = (
jbd3_»voke_»cÜd_s
 *è
hash_li¡
->
Ãxt
;

170 &(
»cÜd
->
hash
è!ğ
hash_li¡
) {

171 ià(
»cÜd
->
blockÄ
 == blocknr) {

172 
	`¥š_uÆock
(&
jouº®
->
j_»voke_lock
);

173  
»cÜd
;

175 
»cÜd
 = (
jbd3_»voke_»cÜd_s
 *è»cÜd->
hash
.
Ãxt
;

177 
	`¥š_uÆock
(&
jouº®
->
j_»voke_lock
);

178  
NULL
;

179 
	}
}

181 
	$jbd3_jouº®_de¡roy_»voke_»cÜd_ÿche
()

183 
	`kmem_ÿche_de¡roy
(
jbd3_»voke_»cÜd_ÿche
);

184 
jbd3_»voke_»cÜd_ÿche
 = 
NULL
;

185 
	}
}

187 
	$jbd3_jouº®_de¡roy_»voke_bË_ÿche
()

189 
	`kmem_ÿche_de¡roy
(
jbd3_»voke_bË_ÿche
);

190 
jbd3_»voke_bË_ÿche
 = 
NULL
;

191 
	}
}

193 
__š™
 
	$jbd3_jouº®_š™_»voke_»cÜd_ÿche
()

195 
	`J_ASSERT
(!
jbd3_»voke_»cÜd_ÿche
);

196 
jbd3_»voke_»cÜd_ÿche
 = 
	`KMEM_CACHE
(
jbd3_»voke_»cÜd_s
,

197 
SLAB_HWCACHE_ALIGN
|
SLAB_TEMPORARY
);

199 ià(!
jbd3_»voke_»cÜd_ÿche
) {

200 
	`´_em”g
("JBD3: failedo create„evoke_record cache\n");

201  -
ENOMEM
;

204 
	}
}

206 
__š™
 
	$jbd3_jouº®_š™_»voke_bË_ÿche
()

208 
	`J_ASSERT
(!
jbd3_»voke_bË_ÿche
);

209 
jbd3_»voke_bË_ÿche
 = 
	`KMEM_CACHE
(
jbd3_»voke_bË_s
,

210 
SLAB_TEMPORARY
);

211 ià(!
jbd3_»voke_bË_ÿche
) {

212 
	`´_em”g
("JBD3: failedo create„evoke_table cache\n");

213  -
ENOMEM
;

216 
	}
}

218 
jbd3_»voke_bË_s
 *
	$jbd3_jouº®_š™_»voke_bË
(
hash_size
)

220 
shiá
 = 0;

221 
tmp
 = 
hash_size
;

222 
jbd3_»voke_bË_s
 *
bË
;

224 
bË
 = 
	`kmem_ÿche_®loc
(
jbd3_»voke_bË_ÿche
, 
GFP_KERNEL
);

225 ià(!
bË
)

226 
out
;

228 (
tmp
 >>= 1UL) != 0UL)

229 
shiá
++;

231 
bË
->
hash_size
 = hash_size;

232 
bË
->
hash_shiá
 = 
shiá
;

233 
bË
->
hash_bË
 =

234 
	`km®loc_¬¿y
(
hash_size
, (
li¡_h—d
), 
GFP_KERNEL
);

235 ià(!
bË
->
hash_bË
) {

236 
	`kmem_ÿche_ä“
(
jbd3_»voke_bË_ÿche
, 
bË
);

237 
bË
 = 
NULL
;

238 
out
;

241 
tmp
 = 0;m°< 
hash_size
;mp++)

242 
	`INIT_LIST_HEAD
(&
bË
->
hash_bË
[
tmp
]);

244 
out
:

245  
bË
;

246 
	}
}

248 
	$jbd3_jouº®_de¡roy_»voke_bË
(
jbd3_»voke_bË_s
 *
bË
)

250 
i
;

251 
li¡_h—d
 *
hash_li¡
;

253 
i
 = 0; i < 
bË
->
hash_size
; i++) {

254 
hash_li¡
 = &
bË
->
hash_bË
[
i
];

255 
	`J_ASSERT
(
	`li¡_em±y
(
hash_li¡
));

258 
	`kä“
(
bË
->
hash_bË
);

259 
	`kmem_ÿche_ä“
(
jbd3_»voke_bË_ÿche
, 
bË
);

260 
	}
}

263 
	$jbd3_jouº®_š™_»voke
(
jouº®_t
 *
jouº®
, 
hash_size
)

265 
	`J_ASSERT
(
jouº®
->
j_»voke_bË
[0] =ğ
NULL
);

266 
	`J_ASSERT
(
	`is_pow”_of_2
(
hash_size
));

268 
jouº®
->
j_»voke_bË
[0] = 
	`jbd3_jouº®_š™_»voke_bË
(
hash_size
);

269 ià(!
jouº®
->
j_»voke_bË
[0])

270 
ç0
;

272 
jouº®
->
j_»voke_bË
[1] = 
	`jbd3_jouº®_š™_»voke_bË
(
hash_size
);

273 ià(!
jouº®
->
j_»voke_bË
[1])

274 
ç1
;

276 
jouº®
->
j_»voke
 = jouº®->
j_»voke_bË
[1];

278 
	`¥š_lock_š™
(&
jouº®
->
j_»voke_lock
);

282 
ç1
:

283 
	`jbd3_jouº®_de¡roy_»voke_bË
(
jouº®
->
j_»voke_bË
[0]);

284 
jouº®
->
j_»voke_bË
[0] = 
NULL
;

285 
ç0
:

286  -
ENOMEM
;

287 
	}
}

290 
	$jbd3_jouº®_de¡roy_»voke
(
jouº®_t
 *
jouº®
)

292 
jouº®
->
j_»voke
 = 
NULL
;

293 ià(
jouº®
->
j_»voke_bË
[0])

294 
	`jbd3_jouº®_de¡roy_»voke_bË
(
jouº®
->
j_»voke_bË
[0]);

295 ià(
jouº®
->
j_»voke_bË
[1])

296 
	`jbd3_jouº®_de¡roy_»voke_bË
(
jouº®
->
j_»voke_bË
[1]);

297 
	}
}

300 #ifdeà
__KERNEL__


326 
	$jbd3_jouº®_»voke
(
hªdË_t
 *
hªdË
, 
blockÄ
,

327 
bufãr_h—d
 *
bh_š
)

329 
bufãr_h—d
 *
bh
 = 
NULL
;

330 
jouº®_t
 *
jouº®
;

331 
block_deviû
 *
bdev
;

332 
”r
;

334 
	`might_¦“p
();

335 ià(
bh_š
)

336 
	`BUFFER_TRACE
(
bh_š
, "enter");

338 
jouº®
 = 
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
;

339 ià(!
	`jbd3_jouº®_£t_ã©u»s
(
jouº®
, 0, 0, 
JBD3_FEATURE_INCOMPAT_REVOKE
)){

340 
	`J_ASSERT
 (!"Cannot set„evoke feature!");

341  -
EINVAL
;

344 
bdev
 = 
jouº®
->
j_fs_dev
;

345 
bh
 = 
bh_š
;

347 ià(!
bh
) {

348 
bh
 = 
	`__fšd_g‘_block
(
bdev
, 
blockÄ
, 
jouº®
->
j_blocksize
);

349 ià(
bh
)

350 
	`BUFFER_TRACE
(
bh
, "found on hash");

352 #ifdeà
JBD3_EXPENSIVE_CHECKING


354 
bufãr_h—d
 *
bh2
;

358 
bh2
 = 
	`__fšd_g‘_block
(
bdev
, 
blockÄ
, 
jouº®
->
j_blocksize
);

359 ià(
bh2
) {

361 ià(
bh2
 !ğ
bh
 && 
	`bufãr_»vokev®id
(bh2))

368 
	`J_ASSERT_BH
(
bh2
, 
	`bufãr_»voked
(bh2));

369 
	`put_bh
(
bh2
);

377 ià(
bh
) {

378 ià(!
	`J_EXPECT_BH
(
bh
, !
	`bufãr_»voked
(bh),

380 ià(!
bh_š
)

381 
	`b»l£
(
bh
);

382  -
EIO
;

384 
	`£t_bufãr_»voked
(
bh
);

385 
	`£t_bufãr_»vokev®id
(
bh
);

386 ià(
bh_š
) {

387 
	`BUFFER_TRACE
(
bh_š
, "call jbd3_journal_forget");

388 
	`jbd3_jouº®_fÜg‘
(
hªdË
, 
bh_š
);

390 
	`BUFFER_TRACE
(
bh
, "call brelse");

391 
	`__b»l£
(
bh
);

395 
	`jbd_debug
(2, "š£¹„evokfÜ block %Îu, bh_š=%p\n",
blockÄ
, 
bh_š
);

396 
”r
 = 
	`š£¹_»voke_hash
(
jouº®
, 
blockÄ
,

397 
hªdË
->
h_Œª§ùiÚ
->
t_tid
);

398 
	`BUFFER_TRACE
(
bh_š
, "exit");

399  
”r
;

400 
	}
}

417 
	$jbd3_jouº®_ÿnûl_»voke
(
hªdË_t
 *
hªdË
, 
jouº®_h—d
 *
jh
)

419 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

420 
jouº®_t
 *
jouº®
 = 
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
;

421 
Ãed_ÿnûl
;

422 
did_»voke
 = 0;

423 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

425 
	`jbd_debug
(4, "jouº®_h—d %p, cªûÎšg„evoke\n", 
jh
);

431 ià(
	`‹¡_£t_bufãr_»vokev®id
(
bh
)) {

432 
Ãed_ÿnûl
 = 
	`‹¡_ş—r_bufãr_»voked
(
bh
);

434 
Ãed_ÿnûl
 = 1;

435 
	`ş—r_bufãr_»voked
(
bh
);

438 ià(
Ãed_ÿnûl
) {

439 
»cÜd
 = 
	`fšd_»voke_»cÜd
(
jouº®
, 
bh
->
b_blockÄ
);

440 ià(
»cÜd
) {

441 
	`jbd_debug
(4, "cancelledƒxisting„evoke on "

442 "blockÄ %Îu\n", ()
bh
->
b_blockÄ
);

443 
	`¥š_lock
(&
jouº®
->
j_»voke_lock
);

444 
	`li¡_d–
(&
»cÜd
->
hash
);

445 
	`¥š_uÆock
(&
jouº®
->
j_»voke_lock
);

446 
	`kmem_ÿche_ä“
(
jbd3_»voke_»cÜd_ÿche
, 
»cÜd
);

447 
did_»voke
 = 1;

451 #ifdeà
JBD3_EXPENSIVE_CHECKING


453 
»cÜd
 = 
	`fšd_»voke_»cÜd
(
jouº®
, 
bh
->
b_blockÄ
);

454 
	`J_ASSERT_JH
(
jh
, 
»cÜd
 =ğ
NULL
);

461 ià(
Ãed_ÿnûl
) {

462 
bufãr_h—d
 *
bh2
;

463 
bh2
 = 
	`__fšd_g‘_block
(
bh
->
b_bdev
, bh->
b_blockÄ
, bh->
b_size
);

464 ià(
bh2
) {

465 ià(
bh2
 !ğ
bh
)

466 
	`ş—r_bufãr_»voked
(
bh2
);

467 
	`__b»l£
(
bh2
);

470  
did_»voke
;

471 
	}
}

478 
	$jbd3_ş—r_bufãr_»voked_æags
(
jouº®_t
 *
jouº®
)

480 
jbd3_»voke_bË_s
 *
»voke
 = 
jouº®
->
j_»voke
;

481 
i
 = 0;

483 
i
 = 0; i < 
»voke
->
hash_size
; i++) {

484 
li¡_h—d
 *
hash_li¡
;

485 
li¡_h—d
 *
li¡_’Œy
;

486 
hash_li¡
 = &
»voke
->
hash_bË
[
i
];

488 
	`li¡_fÜ_—ch
(
li¡_’Œy
, 
hash_li¡
) {

489 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

490 
bufãr_h—d
 *
bh
;

491 
»cÜd
 = (
jbd3_»voke_»cÜd_s
 *)
li¡_’Œy
;

492 
bh
 = 
	`__fšd_g‘_block
(
jouº®
->
j_fs_dev
,

493 
»cÜd
->
blockÄ
,

494 
jouº®
->
j_blocksize
);

495 ià(
bh
) {

496 
	`ş—r_bufãr_»voked
(
bh
);

497 
	`__b»l£
(
bh
);

501 
	}
}

507 
	$jbd3_jouº®_sw™ch_»voke_bË
(
jouº®_t
 *
jouº®
)

509 
i
;

511 ià(
jouº®
->
j_»voke
 =ğjouº®->
j_»voke_bË
[0])

512 
jouº®
->
j_»voke
 = jouº®->
j_»voke_bË
[1];

514 
jouº®
->
j_»voke
 = jouº®->
j_»voke_bË
[0];

516 
i
 = 0; i < 
jouº®
->
j_»voke
->
hash_size
; i++)

517 
	`INIT_LIST_HEAD
(&
jouº®
->
j_»voke
->
hash_bË
[
i
]);

518 
	}
}

524 
	$jbd3_jouº®_wr™e_»voke_»cÜds
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
,

525 
li¡_h—d
 *
log_bufs
)

527 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

528 
bufãr_h—d
 *
desütÜ
;

529 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

530 
jbd3_»voke_bË_s
 *
»voke
;

531 
li¡_h—d
 *
hash_li¡
;

532 
i
, 
off£t
, 
couÁ
;

534 
desütÜ
 = 
NULL
;

535 
off£t
 = 0;

536 
couÁ
 = 0;

539 
»voke
 = 
jouº®
->
j_»voke
 =ğjouº®->
j_»voke_bË
[0] ?

540 
jouº®
->
j_»voke_bË
[1] : journal->j_revoke_table[0];

542 
i
 = 0; i < 
»voke
->
hash_size
; i++) {

543 
hash_li¡
 = &
»voke
->
hash_bË
[
i
];

545 !
	`li¡_em±y
(
hash_li¡
)) {

546 
»cÜd
 = (
jbd3_»voke_»cÜd_s
 *)

547 
hash_li¡
->
Ãxt
;

548 
	`wr™e_Úe_»voke_»cÜd
(
Œª§ùiÚ
, 
log_bufs
,

549 &
desütÜ
, &
off£t
, 
»cÜd
);

550 
couÁ
++;

551 
	`li¡_d–
(&
»cÜd
->
hash
);

552 
	`kmem_ÿche_ä“
(
jbd3_»voke_»cÜd_ÿche
, 
»cÜd
);

555 ià(
desütÜ
)

556 
	`æush_desütÜ
(
jouº®
, 
desütÜ
, 
off£t
);

557 
	`jbd_debug
(1, "WrÙ%d„evok»cÜds\n", 
couÁ
);

558 
	}
}

565 
	$wr™e_Úe_»voke_»cÜd
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
,

566 
li¡_h—d
 *
log_bufs
,

567 
bufãr_h—d
 **
desütÜp
,

568 *
off£
,

569 
jbd3_»voke_»cÜd_s
 *
»cÜd
)

571 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

572 
csum_size
 = 0;

573 
bufãr_h—d
 *
desütÜ
;

574 
sz
, 
off£t
;

580 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

583 
desütÜ
 = *
desütÜp
;

584 
off£t
 = *
off£
;

587 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

588 
csum_size
 = (
jbd3_jouº®_block_
);

590 ià(
	`jbd3_has_ã©u»_64b™
(
jouº®
))

591 
sz
 = 8;

593 
sz
 = 4;

596 ià(
desütÜ
) {

597 ià(
off£t
 + 
sz
 > 
jouº®
->
j_blocksize
 - 
csum_size
) {

598 
	`æush_desütÜ
(
jouº®
, 
desütÜ
, 
off£t
);

599 
desütÜ
 = 
NULL
;

603 ià(!
desütÜ
) {

604 
desütÜ
 = 
	`jbd3_jouº®_g‘_desütÜ_bufãr
(
Œª§ùiÚ
,

605 
JBD3_REVOKE_BLOCK
);

606 ià(!
desütÜ
)

610 
	`BUFFER_TRACE
(
desütÜ
, "file in†og_bufs");

611 
	`jbd3_fe_log_bh
(
log_bufs
, 
desütÜ
);

613 
off£t
 = (
jbd3_jouº®_»voke_h—d”_t
);

614 *
desütÜp
 = 
desütÜ
;

617 ià(
	`jbd3_has_ã©u»_64b™
(
jouº®
))

618 * ((
__be64
 *)(&
desütÜ
->
b_d©a
[
off£t
])) =

619 
	`ıu_to_be64
(
»cÜd
->
blockÄ
);

621 * ((
__be32
 *)(&
desütÜ
->
b_d©a
[
off£t
])) =

622 
	`ıu_to_be32
(
»cÜd
->
blockÄ
);

623 
off£t
 +ğ
sz
;

625 *
off£
 = 
off£t
;

626 
	}
}

635 
	$æush_desütÜ
(
jouº®_t
 *
jouº®
,

636 
bufãr_h—d
 *
desütÜ
,

637 
off£t
)

639 
jbd3_jouº®_»voke_h—d”_t
 *
h—d”
;

641 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

644 
h—d”
 = (
jbd3_jouº®_»voke_h—d”_t
 *)
desütÜ
->
b_d©a
;

645 
h—d”
->
r_couÁ
 = 
	`ıu_to_be32
(
off£t
);

646 
	`jbd3_desütÜ_block_csum_£t
(
jouº®
, 
desütÜ
);

648 
	`£t_bufãr_jwr™e
(
desütÜ
);

649 
	`BUFFER_TRACE
(
desütÜ
, "write");

650 
	`£t_bufãr_dœty
(
desütÜ
);

651 
	`wr™e_dœty_bufãr
(
desütÜ
, 
REQ_SYNC
);

652 
	}
}

677 
	$jbd3_jouº®_£t_»voke
(
jouº®_t
 *
jouº®
,

678 
blockÄ
,

679 
tid_t
 
£qu’û
)

681 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

683 
»cÜd
 = 
	`fšd_»voke_»cÜd
(
jouº®
, 
blockÄ
);

684 ià(
»cÜd
) {

687 ià(
	`tid_gt
(
£qu’û
, 
»cÜd
->sequence))

688 
»cÜd
->
£qu’û
 = sequence;

691  
	`š£¹_»voke_hash
(
jouº®
, 
blockÄ
, 
£qu’û
);

692 
	}
}

701 
	$jbd3_jouº®_‹¡_»voke
(
jouº®_t
 *
jouº®
,

702 
blockÄ
,

703 
tid_t
 
£qu’û
)

705 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

707 
»cÜd
 = 
	`fšd_»voke_»cÜd
(
jouº®
, 
blockÄ
);

708 ià(!
»cÜd
)

710 ià(
	`tid_gt
(
£qu’û
, 
»cÜd
->sequence))

713 
	}
}

720 
	$jbd3_jouº®_ş—r_»voke
(
jouº®_t
 *
jouº®
)

722 
i
;

723 
li¡_h—d
 *
hash_li¡
;

724 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

725 
jbd3_»voke_bË_s
 *
»voke
;

727 
»voke
 = 
jouº®
->
j_»voke
;

729 
i
 = 0; i < 
»voke
->
hash_size
; i++) {

730 
hash_li¡
 = &
»voke
->
hash_bË
[
i
];

731 !
	`li¡_em±y
(
hash_li¡
)) {

732 
»cÜd
 = (
jbd3_»voke_»cÜd_s
*è
hash_li¡
->
Ãxt
;

733 
	`li¡_d–
(&
»cÜd
->
hash
);

734 
	`kmem_ÿche_ä“
(
jbd3_»voke_»cÜd_ÿche
, 
»cÜd
);

737 
	}
}

	@transaction.c

17 
	~<lšux/time.h
>

18 
	~<lšux/fs.h
>

19 
	~<lšux/jbd3.h
>

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/¦ab.h
>

22 
	~<lšux/tim”.h
>

23 
	~<lšux/mm.h
>

24 
	~<lšux/highmem.h
>

25 
	~<lšux/h¹im”.h
>

26 
	~<lšux/backšg-dev.h
>

27 
	~<lšux/bug.h
>

28 
	~<lšux/moduË.h
>

29 
	~<lšux/sched/mm.h
>

31 
	~<Œaû/ev’ts/jbd3.h
>

33 
__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jouº®_h—d
 *
jh
);

34 
__jbd3_jouº®_unfe_bufãr
(
jouº®_h—d
 *
jh
);

36 
kmem_ÿche
 *
	gŒª§ùiÚ_ÿche
;

37 
__š™
 
	$jbd3_jouº®_š™_Œª§ùiÚ_ÿche
()

39 
	`J_ASSERT
(!
Œª§ùiÚ_ÿche
);

40 
Œª§ùiÚ_ÿche
 = 
	`kmem_ÿche_ü—‹
("jbd3_transaction_s",

41 (
Œª§ùiÚ_t
),

43 
SLAB_HWCACHE_ALIGN
|
SLAB_TEMPORARY
,

44 
NULL
);

45 ià(!
Œª§ùiÚ_ÿche
) {

46 
	`´_em”g
("JBD3: failedo createransaction cache\n");

47  -
ENOMEM
;

50 
	}
}

52 
	$jbd3_jouº®_de¡roy_Œª§ùiÚ_ÿche
()

54 
	`kmem_ÿche_de¡roy
(
Œª§ùiÚ_ÿche
);

55 
Œª§ùiÚ_ÿche
 = 
NULL
;

56 
	}
}

58 
	$jbd3_jouº®_ä“_Œª§ùiÚ
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

60 ià(
	`uÆik–y
(
	`ZERO_OR_NULL_PTR
(
Œª§ùiÚ
)))

62 
	`kmem_ÿche_ä“
(
Œª§ùiÚ_ÿche
, 
Œª§ùiÚ
);

63 
	}
}

80 
	$jbd3_g‘_Œª§ùiÚ
(
jouº®_t
 *
jouº®
,

81 
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

83 
Œª§ùiÚ
->
t_jouº®
 = 
jouº®
;

84 
Œª§ùiÚ
->
t_¡©e
 = 
T_RUNNING
;

85 
Œª§ùiÚ
->
t_¡¬t_time
 = 
	`ktime_g‘
();

86 
Œª§ùiÚ
->
t_tid
 = 
jouº®
->
j_Œª§ùiÚ_£qu’û
++;

87 
Œª§ùiÚ
->
t_expœes
 = 
jiff›s
 + 
jouº®
->
j_comm™_š‹rv®
;

88 
	`¥š_lock_š™
(&
Œª§ùiÚ
->
t_hªdË_lock
);

89 
	`©omic_£t
(&
Œª§ùiÚ
->
t_upd©es
, 0);

90 
	`©omic_£t
(&
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
,

91 
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
));

92 
	`©omic_£t
(&
Œª§ùiÚ
->
t_hªdË_couÁ
, 0);

93 
	`INIT_LIST_HEAD
(&
Œª§ùiÚ
->
t_šode_li¡
);

94 
	`INIT_LIST_HEAD
(&
Œª§ùiÚ
->
t_´iv©e_li¡
);

97 
jouº®
->
j_comm™_tim”
.
expœes
 = 
	`round_jiff›s_up
(
Œª§ùiÚ
->
t_expœes
);

98 
	`add_tim”
(&
jouº®
->
j_comm™_tim”
);

100 
	`J_ASSERT
(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 =ğ
NULL
);

101 
jouº®
->
j_ruÂšg_Œª§ùiÚ
 = 
Œª§ùiÚ
;

102 
Œª§ùiÚ
->
t_max_wa™
 = 0;

103 
Œª§ùiÚ
->
t_¡¬t
 = 
jiff›s
;

104 
Œª§ùiÚ
->
t_»que¡ed
 = 0;

105 
	}
}

125 
šlše
 
	$upd©e_t_max_wa™
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
,

126 
ts
)

128 #ifdeà
CONFIG_JBD3_DEBUG


129 ià(
jbd3_jouº®_’abË_debug
 &&

130 
	`time_aá”
(
Œª§ùiÚ
->
t_¡¬t
, 
ts
)) {

131 
ts
 = 
	`jbd3_time_diff
Ñs, 
Œª§ùiÚ
->
t_¡¬t
);

132 
	`¥š_lock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

133 ià(
ts
 > 
Œª§ùiÚ
->
t_max_wa™
)

134 
Œª§ùiÚ
->
t_max_wa™
 = 
ts
;

135 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

138 
	}
}

145 
	$wa™_Œª§ùiÚ_locked
(
jouº®_t
 *
jouº®
)

146 
	`__»Ëa£s
(
jouº®
->
j_¡©e_lock
)

148 
	`DEFINE_WAIT
(
wa™
);

149 
Ãed_to_¡¬t
;

150 
tid_t
 
tid
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
;

152 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
, &
wa™
,

153 
TASK_UNINTERRUPTIBLE
);

154 
Ãed_to_¡¬t
 = !
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
tid
);

155 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

156 ià(
Ãed_to_¡¬t
)

157 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

158 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

159 
	`scheduË
();

160 
	`fšish_wa™
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
, &
wa™
);

161 
	}
}

168 
	$wa™_Œª§ùiÚ_sw™chšg
(
jouº®_t
 *
jouº®
)

169 
	`__»Ëa£s
(
jouº®
->
j_¡©e_lock
)

171 
	`DEFINE_WAIT
(
wa™
);

173 ià(
	`WARN_ON
(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
 ||

174 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_¡©e
 !ğ
T_SWITCH
))

176 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
, &
wa™
,

177 
TASK_UNINTERRUPTIBLE
);

178 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

185 
	`scheduË
();

186 
	`fšish_wa™
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
, &
wa™
);

187 
	}
}

189 
	$sub_»£rved_üed™s
(
jouº®_t
 *
jouº®
, 
blocks
)

191 
	`©omic_sub
(
blocks
, &
jouº®
->
j_»£rved_üed™s
);

192 
	`wake_up
(&
jouº®
->
j_wa™_»£rved
);

193 
	}
}

201 
	$add_Œª§ùiÚ_üed™s
(
jouº®_t
 *
jouº®
, 
blocks
,

202 
rsv_blocks
)

204 
Œª§ùiÚ_t
 *
t
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

205 
Ãeded
;

206 
tÙ®
 = 
blocks
 + 
rsv_blocks
;

212 ià(
t
->
t_¡©e
 !ğ
T_RUNNING
) {

213 
	`WARN_ON_ONCE
(
t
->
t_¡©e
 >ğ
T_FLUSH
);

214 
	`wa™_Œª§ùiÚ_locked
(
jouº®
);

223 
Ãeded
 = 
	`©omic_add_»tuº
(
tÙ®
, &
t
->
t_out¡ªdšg_üed™s
);

224 ià(
Ãeded
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
) {

230 
	`©omic_sub
(
tÙ®
, &
t
->
t_out¡ªdšg_üed™s
);

236 ià(
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
è+ 
tÙ®
 >

237 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
) {

238 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

239 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

240 
	`wa™_ev’t
(
jouº®
->
j_wa™_»£rved
,

241 
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
è+ 
tÙ®
 <=

242 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
);

246 
	`wa™_Œª§ùiÚ_locked
(
jouº®
);

261 ià(
	`jbd3_log_¥aû_Ëá
(
jouº®
è< 
	`jbd3_¥aû_Ãeded
(journal)) {

262 
	`©omic_sub
(
tÙ®
, &
t
->
t_out¡ªdšg_üed™s
);

263 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

264 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

265 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

266 ià(
	`jbd3_log_¥aû_Ëá
(
jouº®
è< 
	`jbd3_¥aû_Ãeded
(journal))

267 
	`__jbd3_log_wa™_fÜ_¥aû
(
jouº®
);

268 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

273 ià(!
rsv_blocks
)

276 
Ãeded
 = 
	`©omic_add_»tuº
(
rsv_blocks
, &
jouº®
->
j_»£rved_üed™s
);

278 ià(
Ãeded
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
 / 2) {

279 
	`sub_»£rved_üed™s
(
jouº®
, 
rsv_blocks
);

280 
	`©omic_sub
(
tÙ®
, &
t
->
t_out¡ªdšg_üed™s
);

281 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

282 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

283 
	`wa™_ev’t
(
jouº®
->
j_wa™_»£rved
,

284 
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
è+ 
rsv_blocks


285 <ğ
jouº®
->
j_max_Œª§ùiÚ_bufãrs
 / 2);

289 
	}
}

298 
	$¡¬t_this_hªdË
(
jouº®_t
 *
jouº®
, 
hªdË_t
 *
hªdË
,

299 
gå_t
 
gå_mask
)

301 
Œª§ùiÚ_t
 *
Œª§ùiÚ
, *
Ãw_Œª§ùiÚ
 = 
NULL
;

302 
blocks
 = 
hªdË
->
h_bufãr_üed™s
;

303 
rsv_blocks
 = 0;

304 
ts
 = 
jiff›s
;

306 ià(
hªdË
->
h_rsv_hªdË
)

307 
rsv_blocks
 = 
hªdË
->
h_rsv_hªdË
->
h_bufãr_üed™s
;

314 ià((
rsv_blocks
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
 / 2) ||

315 (
rsv_blocks
 + 
blocks
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
)) {

316 
	`´štk
(
KERN_ERR
 "JBD3: %s wantsoo many credits "

318 
cu¼’t
->
comm
, 
blocks
, 
rsv_blocks
,

319 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
);

320 
	`WARN_ON
(1);

321  -
ENOSPC
;

324 
®loc_Œª§ùiÚ
:

325 ià(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

330 ià((
gå_mask
 & 
__GFP_FS
) == 0)

331 
gå_mask
 |ğ
__GFP_NOFAIL
;

332 
Ãw_Œª§ùiÚ
 = 
	`kmem_ÿche_z®loc
(
Œª§ùiÚ_ÿche
,

333 
gå_mask
);

334 ià(!
Ãw_Œª§ùiÚ
)

335  -
ENOMEM
;

338 
	`jbd_debug
(3, "New hªdË %°gošg†ive.\n", 
hªdË
);

344 
»³©
:

345 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

346 
	`BUG_ON
(
jouº®
->
j_æags
 & 
JBD3_UNMOUNT
);

347 ià(
	`is_jouº®_abÜ‹d
(
jouº®
) ||

348 (
jouº®
->
j_”ºo
 !ğ0 && !(jouº®->
j_æags
 & 
JBD3_ACK_ERR
))) {

349 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

350 
	`jbd3_jouº®_ä“_Œª§ùiÚ
(
Ãw_Œª§ùiÚ
);

351  -
EROFS
;

359 ià(!
hªdË
->
h_»£rved
 && 
jouº®
->
j_b¬r›r_couÁ
) {

360 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

361 
	`wa™_ev’t
(
jouº®
->
j_wa™_Œª§ùiÚ_locked
,

362 
jouº®
->
j_b¬r›r_couÁ
 == 0);

363 
»³©
;

366 ià(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

367 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

368 ià(!
Ãw_Œª§ùiÚ
)

369 
®loc_Œª§ùiÚ
;

370 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

371 ià(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
 &&

372 (
hªdË
->
h_»£rved
 || !
jouº®
->
j_b¬r›r_couÁ
)) {

373 
	`jbd3_g‘_Œª§ùiÚ
(
jouº®
, 
Ãw_Œª§ùiÚ
);

374 
Ãw_Œª§ùiÚ
 = 
NULL
;

376 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

377 
»³©
;

380 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

382 ià(!
hªdË
->
h_»£rved
) {

384 ià(
	`add_Œª§ùiÚ_üed™s
(
jouº®
, 
blocks
, 
rsv_blocks
))

385 
»³©
;

394 ià(
Œª§ùiÚ
->
t_¡©e
 =ğ
T_SWITCH
) {

395 
	`wa™_Œª§ùiÚ_sw™chšg
(
jouº®
);

396 
»³©
;

398 
	`sub_»£rved_üed™s
(
jouº®
, 
blocks
);

399 
hªdË
->
h_»£rved
 = 0;

405 
	`upd©e_t_max_wa™
(
Œª§ùiÚ
, 
ts
);

406 
hªdË
->
h_Œª§ùiÚ
 = 
Œª§ùiÚ
;

407 
hªdË
->
h_»que¡ed_üed™s
 = 
blocks
;

408 
hªdË
->
h_¡¬t_jiff›s
 = 
jiff›s
;

409 
	`©omic_šc
(&
Œª§ùiÚ
->
t_upd©es
);

410 
	`©omic_šc
(&
Œª§ùiÚ
->
t_hªdË_couÁ
);

411 
	`jbd_debug
(4, "Handle %p given %d credits (total %d, free %lu)\n",

412 
hªdË
, 
blocks
,

413 
	`©omic_»ad
(&
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
),

414 
	`jbd3_log_¥aû_Ëá
(
jouº®
));

415 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

416 
cu¼’t
->
jouº®_šfo
 = 
hªdË
;

418 
	`rw£m_acquœe_»ad
(&
jouº®
->
j_Œªs_comm™_m­
, 0, 0, 
_THIS_IP_
);

419 
	`jbd3_jouº®_ä“_Œª§ùiÚ
(
Ãw_Œª§ùiÚ
);

424 
hªdË
->
§ved_®loc_cÚ‹xt
 = 
	`mem®loc_nofs_§ve
();

426 
	}
}

429 
hªdË_t
 *
	$Ãw_hªdË
(
nblocks
)

431 
hªdË_t
 *
hªdË
 = 
	`jbd3_®loc_hªdË
(
GFP_NOFS
);

432 ià(!
hªdË
)

433  
NULL
;

434 
hªdË
->
h_bufãr_üed™s
 = 
nblocks
;

435 
hªdË
->
h_»f
 = 1;

437  
hªdË
;

438 
	}
}

440 
hªdË_t
 *
	$jbd3__jouº®_¡¬t
(
jouº®_t
 *
jouº®
, 
nblocks
, 
rsv_blocks
,

441 
gå_t
 
gå_mask
, 
ty³
,

442 
lše_no
)

444 
hªdË_t
 *
hªdË
 = 
	`jouº®_cu¼’t_hªdË
();

445 
”r
;

447 ià(!
jouº®
)

448  
	`ERR_PTR
(-
EROFS
);

450 ià(
hªdË
) {

451 
	`J_ASSERT
(
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
 =ğ
jouº®
);

452 
hªdË
->
h_»f
++;

453  
hªdË
;

456 
hªdË
 = 
	`Ãw_hªdË
(
nblocks
);

457 ià(!
hªdË
)

458  
	`ERR_PTR
(-
ENOMEM
);

459 ià(
rsv_blocks
) {

460 
hªdË_t
 *
rsv_hªdË
;

462 
rsv_hªdË
 = 
	`Ãw_hªdË
(
rsv_blocks
);

463 ià(!
rsv_hªdË
) {

464 
	`jbd3_ä“_hªdË
(
hªdË
);

465  
	`ERR_PTR
(-
ENOMEM
);

467 
rsv_hªdË
->
h_»£rved
 = 1;

468 
rsv_hªdË
->
h_jouº®
 = 
jouº®
;

469 
hªdË
->
h_rsv_hªdË
 = 
rsv_hªdË
;

472 
”r
 = 
	`¡¬t_this_hªdË
(
jouº®
, 
hªdË
, 
gå_mask
);

473 ià(
”r
 < 0) {

474 ià(
hªdË
->
h_rsv_hªdË
)

475 
	`jbd3_ä“_hªdË
(
hªdË
->
h_rsv_hªdË
);

476 
	`jbd3_ä“_hªdË
(
hªdË
);

477  
	`ERR_PTR
(
”r
);

479 
hªdË
->
h_ty³
 = 
ty³
;

480 
hªdË
->
h_lše_no
 = 
lše_no
;

481 
	`Œaû_jbd3_hªdË_¡¬t
(
jouº®
->
j_fs_dev
->
bd_dev
,

482 
hªdË
->
h_Œª§ùiÚ
->
t_tid
, 
ty³
,

483 
lše_no
, 
nblocks
);

485  
hªdË
;

486 
	}
}

487 
EXPORT_SYMBOL
(
jbd3__jouº®_¡¬t
);

509 
hªdË_t
 *
	$jbd3_jouº®_¡¬t
(
jouº®_t
 *
jouº®
, 
nblocks
)

511  
	`jbd3__jouº®_¡¬t
(
jouº®
, 
nblocks
, 0, 
GFP_NOFS
, 0, 0);

512 
	}
}

513 
EXPORT_SYMBOL
(
jbd3_jouº®_¡¬t
);

515 
	$jbd3_jouº®_ä“_»£rved
(
hªdË_t
 *
hªdË
)

517 
jouº®_t
 *
jouº®
 = 
hªdË
->
h_jouº®
;

519 
	`WARN_ON
(!
hªdË
->
h_»£rved
);

520 
	`sub_»£rved_üed™s
(
jouº®
, 
hªdË
->
h_bufãr_üed™s
);

521 
	`jbd3_ä“_hªdË
(
hªdË
);

522 
	}
}

523 
EXPORT_SYMBOL
(
jbd3_jouº®_ä“_»£rved
);

539 
	$jbd3_jouº®_¡¬t_»£rved
(
hªdË_t
 *
hªdË
, 
ty³
,

540 
lše_no
)

542 
jouº®_t
 *
jouº®
 = 
hªdË
->
h_jouº®
;

543 
»t
 = -
EIO
;

545 ià(
	`WARN_ON
(!
hªdË
->
h_»£rved
)) {

547 
	`jbd3_jouº®_¡İ
(
hªdË
);

548  
»t
;

554 ià(
	`WARN_ON
(
cu¼’t
->
jouº®_šfo
)) {

555 
	`jbd3_jouº®_ä“_»£rved
(
hªdË
);

556  
»t
;

559 
hªdË
->
h_jouº®
 = 
NULL
;

564 
»t
 = 
	`¡¬t_this_hªdË
(
jouº®
, 
hªdË
, 
GFP_NOFS
);

565 ià(
»t
 < 0) {

566 
hªdË
->
h_jouº®
 = 
jouº®
;

567 
	`jbd3_jouº®_ä“_»£rved
(
hªdË
);

568  
»t
;

570 
hªdË
->
h_ty³
 = 
ty³
;

571 
hªdË
->
h_lše_no
 = 
lše_no
;

572 
	`Œaû_jbd3_hªdË_¡¬t
(
jouº®
->
j_fs_dev
->
bd_dev
,

573 
hªdË
->
h_Œª§ùiÚ
->
t_tid
, 
ty³
,

574 
lše_no
, 
hªdË
->
h_bufãr_üed™s
);

576 
	}
}

577 
EXPORT_SYMBOL
(
jbd3_jouº®_¡¬t_»£rved
);

599 
	$jbd3_jouº®_ex‹nd
(
hªdË_t
 *
hªdË
, 
nblocks
)

601 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

602 
jouº®_t
 *
jouº®
;

603 
»suÉ
;

604 
wª‹d
;

606 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

607  -
EROFS
;

608 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

610 
»suÉ
 = 1;

612 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

615 ià(
Œª§ùiÚ
->
t_¡©e
 !ğ
T_RUNNING
) {

616 
	`jbd_debug
(3, "denied handle %p %d blocks: "

617 "Œª§ùiÚ‚Ù„uÂšg\n", 
hªdË
, 
nblocks
);

618 
”rÜ_out
;

621 
	`¥š_lock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

622 
wª‹d
 = 
	`©omic_add_»tuº
(
nblocks
,

623 &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

625 ià(
wª‹d
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
) {

626 
	`jbd_debug
(3, "denied handle %p %d blocks: "

627 "Œª§ùiÚoØÏrge\n", 
hªdË
, 
nblocks
);

628 
	`©omic_sub
(
nblocks
, &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

629 
uÆock
;

632 ià(
wª‹d
 + (wª‹d >> 
JBD3_CONTROL_BLOCKS_SHIFT
) >

633 
	`jbd3_log_¥aû_Ëá
(
jouº®
)) {

634 
	`jbd_debug
(3, "denied handle %p %d blocks: "

635 "šsuffic›Á†og s·û\n", 
hªdË
, 
nblocks
);

636 
	`©omic_sub
(
nblocks
, &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

637 
uÆock
;

640 
	`Œaû_jbd3_hªdË_ex‹nd
(
jouº®
->
j_fs_dev
->
bd_dev
,

641 
Œª§ùiÚ
->
t_tid
,

642 
hªdË
->
h_ty³
, hªdË->
h_lše_no
,

643 
hªdË
->
h_bufãr_üed™s
,

644 
nblocks
);

646 
hªdË
->
h_bufãr_üed™s
 +ğ
nblocks
;

647 
hªdË
->
h_»que¡ed_üed™s
 +ğ
nblocks
;

648 
»suÉ
 = 0;

650 
	`jbd_debug
(3, "ex‹nded hªdË %°by %d\n", 
hªdË
, 
nblocks
);

651 
uÆock
:

652 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

653 
”rÜ_out
:

654 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

655  
»suÉ
;

656 
	}
}

675 
	$jbd3__jouº®_»¡¬t
(
hªdË_t
 *
hªdË
, 
nblocks
, 
gå_t
 
gå_mask
)

677 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

678 
jouº®_t
 *
jouº®
;

679 
tid_t
 
tid
;

680 
Ãed_to_¡¬t
, 
»t
;

684 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

686 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

692 
	`J_ASSERT
(
	`©omic_»ad
(&
Œª§ùiÚ
->
t_upd©es
) > 0);

693 
	`J_ASSERT
(
	`jouº®_cu¼’t_hªdË
(è=ğ
hªdË
);

695 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

696 
	`¥š_lock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

697 
	`©omic_sub
(
hªdË
->
h_bufãr_üed™s
,

698 &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

699 ià(
hªdË
->
h_rsv_hªdË
) {

700 
	`sub_»£rved_üed™s
(
jouº®
,

701 
hªdË
->
h_rsv_hªdË
->
h_bufãr_üed™s
);

703 ià(
	`©omic_dec_ªd_‹¡
(&
Œª§ùiÚ
->
t_upd©es
))

704 
	`wake_up
(&
jouº®
->
j_wa™_upd©es
);

705 
tid
 = 
Œª§ùiÚ
->
t_tid
;

706 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

707 
hªdË
->
h_Œª§ùiÚ
 = 
NULL
;

708 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

710 
	`jbd_debug
(2, "»¡¬tšg hªdË %p\n", 
hªdË
);

711 
Ãed_to_¡¬t
 = !
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
tid
);

712 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

713 ià(
Ãed_to_¡¬t
)

714 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

716 
	`rw£m_»Ëa£
(&
jouº®
->
j_Œªs_comm™_m­
, 1, 
_THIS_IP_
);

717 
hªdË
->
h_bufãr_üed™s
 = 
nblocks
;

723 
	`mem®loc_nofs_»¡Üe
(
hªdË
->
§ved_®loc_cÚ‹xt
);

724 
»t
 = 
	`¡¬t_this_hªdË
(
jouº®
, 
hªdË
, 
gå_mask
);

725  
»t
;

726 
	}
}

727 
EXPORT_SYMBOL
(
jbd3__jouº®_»¡¬t
);

730 
	$jbd3_jouº®_»¡¬t
(
hªdË_t
 *
hªdË
, 
nblocks
)

732  
	`jbd3__jouº®_»¡¬t
(
hªdË
, 
nblocks
, 
GFP_NOFS
);

733 
	}
}

734 
EXPORT_SYMBOL
(
jbd3_jouº®_»¡¬t
);

746 
	$jbd3_jouº®_lock_upd©es
(
jouº®_t
 *
jouº®
)

748 
	`DEFINE_WAIT
(
wa™
);

750 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

752 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

753 ++
jouº®
->
j_b¬r›r_couÁ
;

756 ià(
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
)) {

757 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

758 
	`wa™_ev’t
(
jouº®
->
j_wa™_»£rved
,

759 
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
) == 0);

760 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

765 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

767 ià(!
Œª§ùiÚ
)

770 
	`¥š_lock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

771 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
,

772 
TASK_UNINTERRUPTIBLE
);

773 ià(!
	`©omic_»ad
(&
Œª§ùiÚ
->
t_upd©es
)) {

774 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

775 
	`fšish_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
);

778 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

779 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

780 
	`scheduË
();

781 
	`fšish_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
);

782 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

784 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

792 
	`mu‹x_lock
(&
jouº®
->
j_b¬r›r
);

793 
	}
}

803 
	$jbd3_jouº®_uÆock_upd©es
 (
jouº®_t
 *
jouº®
)

805 
	`J_ASSERT
(
jouº®
->
j_b¬r›r_couÁ
 != 0);

807 
	`mu‹x_uÆock
(&
jouº®
->
j_b¬r›r
);

808 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

809 --
jouº®
->
j_b¬r›r_couÁ
;

810 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

811 
	`wake_up
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
);

812 
	}
}

814 
	$w¬n_dœty_bufãr
(
bufãr_h—d
 *
bh
)

816 
	`´štk
(
KERN_WARNING


820 
bh
->
b_bdev
, ()bh->
b_blockÄ
);

821 
	}
}

824 
	$jbd3_ä“ze_jh_d©a
(
jouº®_h—d
 *
jh
)

826 
·ge
 *page;

827 
off£t
;

828 *
sourû
;

829 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

831 
	`J_EXPECT_JH
(
jh
, 
	`bufãr_u±od©e
(
bh
), "Possible IO failure.\n");

832 
·ge
 = 
bh
->
b_·ge
;

833 
off£t
 = 
	`off£t_š_·ge
(
bh
->
b_d©a
);

834 
sourû
 = 
	`km­_©omic
(
·ge
);

836 
	`jbd3_bufãr_äoz’_Œigg”
(
jh
, 
sourû
 + 
off£t
, jh->
b_Œigg”s
);

837 
	`memıy
(
jh
->
b_äoz’_d©a
, 
sourû
 + 
off£t
, 
bh
->
b_size
);

838 
	`kunm­_©omic
(
sourû
);

844 
jh
->
b_äoz’_Œigg”s
 = jh->
b_Œigg”s
;

845 
	}
}

858 
	$do_g‘_wr™e_acûss
(
hªdË_t
 *
hªdË
, 
jouº®_h—d
 *
jh
,

859 
fÜû_cİy
)

861 
bufãr_h—d
 *
bh
;

862 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

863 
jouº®_t
 *
jouº®
;

864 
”rÜ
;

865 *
äoz’_bufãr
 = 
NULL
;

866 
¡¬t_lock
, 
time_lock
;

868 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

869  -
EROFS
;

870 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

872 
	`jbd_debug
(5, "jouº®_h—d %p, fÜû_cİy %d\n", 
jh
, 
fÜû_cİy
);

874 
	`JBUFFER_TRACE
(
jh
, "entry");

875 
»³©
:

876 
bh
 = 
	`jh2bh
(
jh
);

880 
¡¬t_lock
 = 
jiff›s
;

881 
	`lock_bufãr
(
bh
);

882 
	`jbd_lock_bh_¡©e
(
bh
);

885 
time_lock
 = 
	`jbd3_time_diff
(
¡¬t_lock
, 
jiff›s
);

886 ià(
time_lock
 > 
HZ
/10)

887 
	`Œaû_jbd3_lock_bufãr_¡®l
(
bh
->
b_bdev
->
bd_dev
,

888 
	`jiff›s_to_m£cs
(
time_lock
));

903 ià(
	`bufãr_dœty
(
bh
)) {

908 ià(
jh
->
b_Œª§ùiÚ
) {

909 
	`J_ASSERT_JH
(
jh
,

910 
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

911 
jh
->
b_Œª§ùiÚ
 ==

912 
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

913 ià(
jh
->
b_Ãxt_Œª§ùiÚ
)

914 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 ==

915 
Œª§ùiÚ
);

916 
	`w¬n_dœty_bufãr
(
bh
);

923 
	`JBUFFER_TRACE
(
jh
, "Journalling dirty buffer");

924 
	`ş—r_bufãr_dœty
(
bh
);

925 
	`£t_bufãr_jbddœty
(
bh
);

928 
	`uÆock_bufãr
(
bh
);

930 
”rÜ
 = -
EROFS
;

931 ià(
	`is_hªdË_abÜ‹d
(
hªdË
)) {

932 
	`jbd_uÆock_bh_¡©e
(
bh
);

933 
out
;

935 
”rÜ
 = 0;

941 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

942 
jh
->
b_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
)

943 
dÚe
;

949 
jh
->
b_modif›d
 = 0;

956 ià(!
jh
->
b_Œª§ùiÚ
) {

957 
	`JBUFFER_TRACE
(
jh
, "noransaction");

958 
	`J_ASSERT_JH
(
jh
, !jh->
b_Ãxt_Œª§ùiÚ
);

959 
	`JBUFFER_TRACE
(
jh
, "file‡s BJ_Reserved");

965 
	`smp_wmb
();

966 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

967 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_Re£rved
);

968 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

969 
dÚe
;

975 ià(
jh
->
b_äoz’_d©a
) {

976 
	`JBUFFER_TRACE
(
jh
, "has frozen data");

977 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

978 
©ch_Ãxt
;

981 
	`JBUFFER_TRACE
(
jh
, "owned by olderransaction");

982 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

983 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

994 ià(
	`bufãr_shadow
(
bh
)) {

995 
	`JBUFFER_TRACE
(
jh
, "on shadow: sleep");

996 
	`jbd_uÆock_bh_¡©e
(
bh
);

997 
	`wa™_Ú_b™_io
(&
bh
->
b_¡©e
, 
BH_Shadow
, 
TASK_UNINTERRUPTIBLE
);

998 
»³©
;

1013 ià(
jh
->
b_jli¡
 =ğ
BJ_M‘ad©a
 || 
fÜû_cİy
) {

1014 
	`JBUFFER_TRACE
(
jh
, "generate frozen data");

1015 ià(!
äoz’_bufãr
) {

1016 
	`JBUFFER_TRACE
(
jh
, "allocate memory for buffer");

1017 
	`jbd_uÆock_bh_¡©e
(
bh
);

1018 
äoz’_bufãr
 = 
	`jbd3_®loc
(
	`jh2bh
(
jh
)->
b_size
,

1019 
GFP_NOFS
 | 
__GFP_NOFAIL
);

1020 
»³©
;

1022 
jh
->
b_äoz’_d©a
 = 
äoz’_bufãr
;

1023 
äoz’_bufãr
 = 
NULL
;

1024 
	`jbd3_ä“ze_jh_d©a
(
jh
);

1026 
©ch_Ãxt
:

1032 
	`smp_wmb
();

1033 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

1035 
dÚe
:

1036 
	`jbd_uÆock_bh_¡©e
(
bh
);

1042 
	`jbd3_jouº®_ÿnûl_»voke
(
hªdË
, 
jh
);

1044 
out
:

1045 ià(
	`uÆik–y
(
äoz’_bufãr
))

1046 
	`jbd3_ä“
(
äoz’_bufãr
, 
bh
->
b_size
);

1048 
	`JBUFFER_TRACE
(
jh
, "exit");

1049  
”rÜ
;

1050 
	}
}

1053 
boŞ
 
	$jbd3_wr™e_acûss_g¿Áed
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
,

1054 
boŞ
 
undo
)

1056 
jouº®_h—d
 *
jh
;

1057 
boŞ
 
»t
 = 
çl£
;

1060 ià(
	`bufãr_dœty
(
bh
))

1061  
çl£
;

1074 
	`rcu_»ad_lock
();

1075 ià(!
	`bufãr_jbd
(
bh
))

1076 
out
;

1078 
jh
 = 
	`READ_ONCE
(
bh
->
b_´iv©e
);

1079 ià(!
jh
)

1080 
out
;

1082 ià(
undo
 && !
jh
->
b_comm™‹d_d©a
)

1083 
out
;

1084 ià(
jh
->
b_Œª§ùiÚ
 !ğ
hªdË
->
h_Œª§ùiÚ
 &&

1085 
jh
->
b_Ãxt_Œª§ùiÚ
 !ğ
hªdË
->
h_Œª§ùiÚ
)

1086 
out
;

1096 
	`smp_mb
();

1097 ià(
	`uÆik–y
(
jh
->
b_bh
 !ğ
bh
))

1098 
out
;

1099 
»t
 = 
Œue
;

1100 
out
:

1101 
	`rcu_»ad_uÆock
();

1102  
»t
;

1103 
	}
}

1116 
	$jbd3_jouº®_g‘_wr™e_acûss
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1118 
jouº®_h—d
 *
jh
;

1119 
rc
;

1121 ià(
	`jbd3_wr™e_acûss_g¿Áed
(
hªdË
, 
bh
, 
çl£
))

1124 
jh
 = 
	`jbd3_jouº®_add_jouº®_h—d
(
bh
);

1128 
rc
 = 
	`do_g‘_wr™e_acûss
(
hªdË
, 
jh
, 0);

1129 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1130  
rc
;

1131 
	}
}

1153 
	$jbd3_jouº®_g‘_ü—‹_acûss
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1155 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

1156 
jouº®_t
 *
jouº®
;

1157 
jouº®_h—d
 *
jh
 = 
	`jbd3_jouº®_add_jouº®_h—d
(
bh
);

1158 
”r
;

1160 
	`jbd_debug
(5, "jouº®_h—d %p\n", 
jh
);

1161 
”r
 = -
EROFS
;

1162 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1163 
out
;

1164 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

1165 
”r
 = 0;

1167 
	`JBUFFER_TRACE
(
jh
, "entry");

1175 
	`jbd_lock_bh_¡©e
(
bh
);

1176 
	`J_ASSERT_JH
(
jh
, (jh->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

1177 
jh
->
b_Œª§ùiÚ
 =ğ
NULL
 ||

1178 (
jh
->
b_Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
 &&

1179 
jh
->
b_jli¡
 =ğ
BJ_FÜg‘
)));

1181 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

1182 
	`J_ASSERT_JH
(
jh
, 
	`bufãr_locked
(
	`jh2bh
(jh)));

1184 ià(
jh
->
b_Œª§ùiÚ
 =ğ
NULL
) {

1193 
	`ş—r_bufãr_dœty
(
	`jh2bh
(
jh
));

1195 
jh
->
b_modif›d
 = 0;

1197 
	`JBUFFER_TRACE
(
jh
, "file‡s BJ_Reserved");

1198 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1199 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_Re£rved
);

1200 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1201 } ià(
jh
->
b_Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
) {

1203 
jh
->
b_modif›d
 = 0;

1205 
	`JBUFFER_TRACE
(
jh
, "set‚extransaction");

1206 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1207 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

1208 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1210 
	`jbd_uÆock_bh_¡©e
(
bh
);

1219 
	`JBUFFER_TRACE
(
jh
, "cancelling„evoke");

1220 
	`jbd3_jouº®_ÿnûl_»voke
(
hªdË
, 
jh
);

1221 
out
:

1222 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1223  
”r
;

1224 
	}
}

1252 
	$jbd3_jouº®_g‘_undo_acûss
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1254 
”r
;

1255 
jouº®_h—d
 *
jh
;

1256 *
comm™‹d_d©a
 = 
NULL
;

1258 ià(
	`jbd3_wr™e_acûss_g¿Áed
(
hªdË
, 
bh
, 
Œue
))

1261 
jh
 = 
	`jbd3_jouº®_add_jouº®_h—d
(
bh
);

1262 
	`JBUFFER_TRACE
(
jh
, "entry");

1269 
”r
 = 
	`do_g‘_wr™e_acûss
(
hªdË
, 
jh
, 1);

1270 ià(
”r
)

1271 
out
;

1273 
»³©
:

1274 ià(!
jh
->
b_comm™‹d_d©a
)

1275 
comm™‹d_d©a
 = 
	`jbd3_®loc
(
	`jh2bh
(
jh
)->
b_size
,

1276 
GFP_NOFS
|
__GFP_NOFAIL
);

1278 
	`jbd_lock_bh_¡©e
(
bh
);

1279 ià(!
jh
->
b_comm™‹d_d©a
) {

1282 
	`JBUFFER_TRACE
(
jh
, "generate b_committed data");

1283 ià(!
comm™‹d_d©a
) {

1284 
	`jbd_uÆock_bh_¡©e
(
bh
);

1285 
»³©
;

1288 
jh
->
b_comm™‹d_d©a
 = 
comm™‹d_d©a
;

1289 
comm™‹d_d©a
 = 
NULL
;

1290 
	`memıy
(
jh
->
b_comm™‹d_d©a
, 
bh
->
b_d©a
, bh->
b_size
);

1292 
	`jbd_uÆock_bh_¡©e
(
bh
);

1293 
out
:

1294 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1295 ià(
	`uÆik–y
(
comm™‹d_d©a
))

1296 
	`jbd3_ä“
(
comm™‹d_d©a
, 
bh
->
b_size
);

1297  
”r
;

1298 
	}
}

1311 
	$jbd3_jouº®_£t_Œigg”s
(
bufãr_h—d
 *
bh
,

1312 
jbd3_bufãr_Œigg”_ty³
 *
ty³
)

1314 
jouº®_h—d
 *
jh
 = 
	`jbd3_jouº®_g¿b_jouº®_h—d
(
bh
);

1316 ià(
	`WARN_ON
(!
jh
))

1318 
jh
->
b_Œigg”s
 = 
ty³
;

1319 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1320 
	}
}

1322 
	$jbd3_bufãr_äoz’_Œigg”
(
jouº®_h—d
 *
jh
, *
m­³d_d©a
,

1323 
jbd3_bufãr_Œigg”_ty³
 *
Œigg”s
)

1325 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

1327 ià(!
Œigg”s
 || !Œigg”s->
t_äoz’
)

1330 
Œigg”s
->
	`t_äoz’
Ñrigg”s, 
bh
, 
m­³d_d©a
, bh->
b_size
);

1331 
	}
}

1333 
	$jbd3_bufãr_abÜt_Œigg”
(
jouº®_h—d
 *
jh
,

1334 
jbd3_bufãr_Œigg”_ty³
 *
Œigg”s
)

1336 ià(!
Œigg”s
 || !Œigg”s->
t_abÜt
)

1339 
Œigg”s
->
	`t_abÜt
Ñrigg”s, 
	`jh2bh
(
jh
));

1340 
	}
}

1365 
	$jbd3_jouº®_dœty_m‘ad©a
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1367 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

1368 
jouº®_t
 *
jouº®
;

1369 
jouº®_h—d
 *
jh
;

1370 
»t
 = 0;

1372 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1373  -
EROFS
;

1374 ià(!
	`bufãr_jbd
(
bh
))

1375  -
EUCLEAN
;

1381 
jh
 = 
	`bh2jh
(
bh
);

1382 
	`jbd_debug
(5, "jouº®_h—d %p\n", 
jh
);

1383 
	`JBUFFER_TRACE
(
jh
, "entry");

1391 ià(
jh
->
b_Œª§ùiÚ
 !ğ
Œª§ùiÚ
 &&

1392 
jh
->
b_Ãxt_Œª§ùiÚ
 !ğ
Œª§ùiÚ
) {

1393 
	`jbd_lock_bh_¡©e
(
bh
);

1394 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

1395 
jh
->
b_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
);

1396 
	`jbd_uÆock_bh_¡©e
(
bh
);

1398 ià(
jh
->
b_modif›d
 == 1) {

1400 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 &&

1401 
jh
->
b_jli¡
 !ğ
BJ_M‘ad©a
) {

1402 
	`jbd_lock_bh_¡©e
(
bh
);

1403 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 &&

1404 
jh
->
b_jli¡
 !ğ
BJ_M‘ad©a
)

1405 
	`´_”r
("JBD3:‡ssertion failure: h_type=%u "

1407 
hªdË
->
h_ty³
, hªdË->
h_lše_no
,

1408 (è
bh
->
b_blockÄ
,

1409 
jh
->
b_jli¡
);

1410 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 !ğ
Œª§ùiÚ
 ||

1411 
jh
->
b_jli¡
 =ğ
BJ_M‘ad©a
);

1412 
	`jbd_uÆock_bh_¡©e
(
bh
);

1414 
out
;

1417 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

1418 
	`jbd_lock_bh_¡©e
(
bh
);

1420 ià(
jh
->
b_modif›d
 == 0) {

1426 ià(
hªdË
->
h_bufãr_üed™s
 <= 0) {

1427 
»t
 = -
ENOSPC
;

1428 
out_uÆock_bh
;

1430 
jh
->
b_modif›d
 = 1;

1431 
hªdË
->
h_bufãr_üed™s
--;

1441 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 && jh->
b_jli¡
 =ğ
BJ_M‘ad©a
) {

1442 
	`JBUFFER_TRACE
(
jh
, "fastpath");

1443 ià(
	`uÆik–y
(
jh
->
b_Œª§ùiÚ
 !=

1444 
jouº®
->
j_ruÂšg_Œª§ùiÚ
)) {

1445 
	`´štk
(
KERN_ERR
 "JBD3: %s: "

1448 
jouº®
->
j_devÇme
,

1449 (è
bh
->
b_blockÄ
,

1450 
jh
->
b_Œª§ùiÚ
,

1451 
jh
->
b_Œª§ùiÚ
 ? jh->b_Œª§ùiÚ->
t_tid
 : 0,

1452 
jouº®
->
j_ruÂšg_Œª§ùiÚ
,

1453 
jouº®
->
j_ruÂšg_Œª§ùiÚ
 ?

1454 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 : 0);

1455 
»t
 = -
EINVAL
;

1457 
out_uÆock_bh
;

1460 
	`£t_bufãr_jbddœty
(
bh
);

1468 ià(
jh
->
b_Œª§ùiÚ
 !ğ
Œª§ùiÚ
) {

1469 
	`JBUFFER_TRACE
(
jh
, "already on otherransaction");

1470 ià(
	`uÆik–y
(((
jh
->
b_Œª§ùiÚ
 !=

1471 
jouº®
->
j_comm™tšg_Œª§ùiÚ
)) ||

1472 (
jh
->
b_Ãxt_Œª§ùiÚ
 !ğ
Œª§ùiÚ
))) {

1473 
	`´štk
(
KERN_ERR
 "jbd3_journal_dirty_metadata: %s: "

1478 
jouº®
->
j_devÇme
,

1479 (è
bh
->
b_blockÄ
,

1480 
Œª§ùiÚ
,¿n§ùiÚ->
t_tid
,

1481 
jh
->
b_Œª§ùiÚ
,

1482 
jh
->
b_Œª§ùiÚ
 ?

1483 
jh
->
b_Œª§ùiÚ
->
t_tid
 : 0,

1484 
jh
->
b_Ãxt_Œª§ùiÚ
,

1485 
jh
->
b_Ãxt_Œª§ùiÚ
 ?

1486 
jh
->
b_Ãxt_Œª§ùiÚ
->
t_tid
 : 0,

1487 
jh
->
b_jli¡
);

1488 
	`WARN_ON
(1);

1489 
»t
 = -
EINVAL
;

1493 
out_uÆock_bh
;

1497 
	`J_ASSERT_JH
(
jh
, jh->
b_äoz’_d©a
 =ğ
NULL
);

1499 
	`JBUFFER_TRACE
(
jh
, "file‡s BJ_Metadata");

1500 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1501 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_M‘ad©a
);

1502 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1503 
out_uÆock_bh
:

1504 
	`jbd_uÆock_bh_¡©e
(
bh
);

1505 
out
:

1506 
	`JBUFFER_TRACE
(
jh
, "exit");

1507  
»t
;

1508 
	}
}

1527 
	$jbd3_jouº®_fÜg‘
 (
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1529 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

1530 
jouº®_t
 *
jouº®
;

1531 
jouº®_h—d
 *
jh
;

1532 
drİ_»£rve
 = 0;

1533 
”r
 = 0;

1534 
was_modif›d
 = 0;

1536 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1537  -
EROFS
;

1538 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

1540 
	`BUFFER_TRACE
(
bh
, "entry");

1542 
	`jbd_lock_bh_¡©e
(
bh
);

1544 ià(!
	`bufãr_jbd
(
bh
))

1545 
nÙ_jbd
;

1546 
jh
 = 
	`bh2jh
(
bh
);

1550 ià(!
	`J_EXPECT_JH
(
jh
, !jh->
b_comm™‹d_d©a
,

1552 
”r
 = -
EIO
;

1553 
nÙ_jbd
;

1557 
was_modif›d
 = 
jh
->
b_modif›d
;

1563 
jh
->
b_modif›d
 = 0;

1565 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
) {

1566 
	`J_ASSERT_JH
(
jh
, !jh->
b_äoz’_d©a
);

1571 
	`ş—r_bufãr_dœty
(
bh
);

1572 
	`ş—r_bufãr_jbddœty
(
bh
);

1574 
	`JBUFFER_TRACE
(
jh
, "belongso currentransaction: unfile");

1580 ià(
was_modif›d
)

1581 
drİ_»£rve
 = 1;

1595 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1596 ià(
jh
->
b_ı_Œª§ùiÚ
) {

1597 
	`__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jh
);

1598 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_FÜg‘
);

1600 
	`__jbd3_jouº®_unfe_bufãr
(
jh
);

1601 ià(!
	`bufãr_jbd
(
bh
)) {

1602 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1603 
nÙ_jbd
;

1606 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1607 } ià(
jh
->
b_Œª§ùiÚ
) {

1608 
	`J_ASSERT_JH
(
jh
, (jh->
b_Œª§ùiÚ
 ==

1609 
jouº®
->
j_comm™tšg_Œª§ùiÚ
));

1612 
	`JBUFFER_TRACE
(
jh
, "belongso olderransaction");

1620 
	`£t_bufãr_ä“d
(
bh
);

1622 ià(!
jh
->
b_Ãxt_Œª§ùiÚ
) {

1623 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1624 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

1625 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1627 
	`J_ASSERT
(
jh
->
b_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
);

1633 ià(
was_modif›d
)

1634 
drİ_»£rve
 = 1;

1642 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1643 ià(!
jh
->
b_ı_Œª§ùiÚ
) {

1644 
	`JBUFFER_TRACE
(
jh
, "belongso‚oneransaction");

1645 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1646 
nÙ_jbd
;

1653 ià(!
	`bufãr_dœty
(
bh
)) {

1654 
	`__jbd3_jouº®_»move_checkpošt
(
jh
);

1655 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1656 
nÙ_jbd
;

1665 
	`ş—r_bufãr_dœty
(
bh
);

1666 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_FÜg‘
);

1667 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1670 
	`jbd_uÆock_bh_¡©e
(
bh
);

1671 
	`__b»l£
(
bh
);

1672 
drİ
:

1673 ià(
drİ_»£rve
) {

1675 
hªdË
->
h_bufãr_üed™s
++;

1677  
”r
;

1679 
nÙ_jbd
:

1680 
	`jbd_uÆock_bh_¡©e
(
bh
);

1681 
	`__bfÜg‘
(
bh
);

1682 
drİ
;

1683 
	}
}

1701 
	$jbd3_jouº®_¡İ
(
hªdË_t
 *
hªdË
)

1703 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

1704 
jouº®_t
 *
jouº®
;

1705 
”r
 = 0, 
wa™_fÜ_comm™
 = 0;

1706 
tid_t
 
tid
;

1707 
pid_t
 
pid
;

1709 ià(!
Œª§ùiÚ
) {

1715 ià(--
hªdË
->
h_»f
 > 0) {

1716 
	`jbd_debug
(4, "h_»à%d -> %d\n", 
hªdË
->
h_»f
 + 1,

1717 
hªdË
->
h_»f
);

1718  
”r
;

1720 ià(
hªdË
->
h_rsv_hªdË
)

1721 
	`jbd3_ä“_hªdË
(
hªdË
->
h_rsv_hªdË
);

1722 
ä“_ªd_ex™
;

1725 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

1727 
	`J_ASSERT
(
	`jouº®_cu¼’t_hªdË
(è=ğ
hªdË
);

1729 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1730 
”r
 = -
EIO
;

1732 
	`J_ASSERT
(
	`©omic_»ad
(&
Œª§ùiÚ
->
t_upd©es
) > 0);

1734 ià(--
hªdË
->
h_»f
 > 0) {

1735 
	`jbd_debug
(4, "h_»à%d -> %d\n", 
hªdË
->
h_»f
 + 1,

1736 
hªdË
->
h_»f
);

1737  
”r
;

1740 
	`jbd_debug
(4, "HªdË %°gošg down\n", 
hªdË
);

1741 
	`Œaû_jbd3_hªdË_¡©s
(
jouº®
->
j_fs_dev
->
bd_dev
,

1742 
Œª§ùiÚ
->
t_tid
,

1743 
hªdË
->
h_ty³
, hªdË->
h_lše_no
,

1744 
jiff›s
 - 
hªdË
->
h_¡¬t_jiff›s
,

1745 
hªdË
->
h_sync
, hªdË->
h_»que¡ed_üed™s
,

1746 (
hªdË
->
h_»que¡ed_üed™s
 -

1747 
hªdË
->
h_bufãr_üed™s
));

1778 
pid
 = 
cu¼’t
->pid;

1779 ià(
hªdË
->
h_sync
 && 
jouº®
->
j_Ï¡_sync_wr™”
 !ğ
pid
 &&

1780 
jouº®
->
j_max_b©ch_time
) {

1781 
u64
 
comm™_time
, 
Œªs_time
;

1783 
jouº®
->
j_Ï¡_sync_wr™”
 = 
pid
;

1785 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

1786 
comm™_time
 = 
jouº®
->
j_av”age_comm™_time
;

1787 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

1789 
Œªs_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_g‘
(),

1790 
Œª§ùiÚ
->
t_¡¬t_time
));

1792 
comm™_time
 = 
	`max_t
(
u64
, commit_time,

1793 1000*
jouº®
->
j_mš_b©ch_time
);

1794 
comm™_time
 = 
	`mš_t
(
u64
, commit_time,

1795 1000*
jouº®
->
j_max_b©ch_time
);

1797 ià(
Œªs_time
 < 
comm™_time
) {

1798 
ktime_t
 
expœes
 = 
	`ktime_add_ns
(
	`ktime_g‘
(),

1799 
comm™_time
);

1800 
	`£t_cu¼’t_¡©e
(
TASK_UNINTERRUPTIBLE
);

1801 
	`scheduË_h¹imeout
(&
expœes
, 
HRTIMER_MODE_ABS
);

1805 ià(
hªdË
->
h_sync
)

1806 
Œª§ùiÚ
->
t_synchrÚous_comm™
 = 1;

1807 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

1808 
	`©omic_sub
(
hªdË
->
h_bufãr_üed™s
,

1809 &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

1817 ià(
hªdË
->
h_sync
 ||

1818 (
	`©omic_»ad
(&
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
) >

1819 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
) ||

1820 
	`time_aá”_eq
(
jiff›s
, 
Œª§ùiÚ
->
t_expœes
)) {

1825 
	`jbd_debug
(2, "transactionoo old,„equesting commit for "

1826 "hªdË %p\n", 
hªdË
);

1828 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
Œª§ùiÚ
->
t_tid
);

1834 ià(
hªdË
->
h_sync
 && !(
cu¼’t
->
æags
 & 
PF_MEMALLOC
))

1835 
wa™_fÜ_comm™
 = 1;

1844 
tid
 = 
Œª§ùiÚ
->
t_tid
;

1845 ià(
	`©omic_dec_ªd_‹¡
(&
Œª§ùiÚ
->
t_upd©es
)) {

1846 
	`wake_up
(&
jouº®
->
j_wa™_upd©es
);

1847 ià(
jouº®
->
j_b¬r›r_couÁ
)

1848 
	`wake_up
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
);

1851 
	`rw£m_»Ëa£
(&
jouº®
->
j_Œªs_comm™_m­
, 1, 
_THIS_IP_
);

1853 ià(
wa™_fÜ_comm™
)

1854 
”r
 = 
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

1856 ià(
hªdË
->
h_rsv_hªdË
)

1857 
	`jbd3_jouº®_ä“_»£rved
(
hªdË
->
h_rsv_hªdË
);

1858 
ä“_ªd_ex™
:

1863 
	`mem®loc_nofs_»¡Üe
(
hªdË
->
§ved_®loc_cÚ‹xt
);

1864 
	`jbd3_ä“_hªdË
(
hªdË
);

1865  
”r
;

1866 
	}
}

1884 
šlše
 

1885 
	$__bli¡_add_bufãr
(
jouº®_h—d
 **
li¡
, jouº®_h—d *
jh
)

1887 ià(!*
li¡
) {

1888 
jh
->
b_Šext
 = jh->
b_»v
 = jh;

1889 *
li¡
 = 
jh
;

1892 
jouº®_h—d
 *
fœ¡
 = *
li¡
, *
Ï¡
 = fœ¡->
b_»v
;

1893 
jh
->
b_»v
 = 
Ï¡
;

1894 
jh
->
b_Šext
 = 
fœ¡
;

1895 
Ï¡
->
b_Šext
 = 
fœ¡
->
b_»v
 = 
jh
;

1897 
	}
}

1908 
šlše
 

1909 
	$__bli¡_d–_bufãr
(
jouº®_h—d
 **
li¡
, jouº®_h—d *
jh
)

1911 ià(*
li¡
 =ğ
jh
) {

1912 *
li¡
 = 
jh
->
b_Šext
;

1913 ià(*
li¡
 =ğ
jh
)

1914 *
li¡
 = 
NULL
;

1916 
jh
->
b_»v
->
b_Šext
 = jh->b_tnext;

1917 
jh
->
b_Šext
->
b_»v
 = jh->b_tprev;

1918 
	}
}

1931 
	$__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jouº®_h—d
 *
jh
)

1933 
jouº®_h—d
 **
li¡
 = 
NULL
;

1934 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

1935 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

1937 
	`J_ASSERT_JH
(
jh
, 
	`jbd_is_locked_bh_¡©e
(
bh
));

1938 
Œª§ùiÚ
 = 
jh
->
b_Œª§ùiÚ
;

1939 ià(
Œª§ùiÚ
)

1940 
	`as£¹_¥š_locked
(&
Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

1942 
	`J_ASSERT_JH
(
jh
, jh->
b_jli¡
 < 
BJ_Ty³s
);

1943 ià(
jh
->
b_jli¡
 !ğ
BJ_NÚe
)

1944 
	`J_ASSERT_JH
(
jh
, 
Œª§ùiÚ
 !ğ
NULL
);

1946 
jh
->
b_jli¡
) {

1947 
BJ_NÚe
:

1949 
BJ_M‘ad©a
:

1950 
Œª§ùiÚ
->
t_Ä_bufãrs
--;

1951 
	`J_ASSERT_JH
(
jh
, 
Œª§ùiÚ
->
t_Ä_bufãrs
 >= 0);

1952 
li¡
 = &
Œª§ùiÚ
->
t_bufãrs
;

1954 
BJ_FÜg‘
:

1955 
li¡
 = &
Œª§ùiÚ
->
t_fÜg‘
;

1957 
BJ_Shadow
:

1958 
li¡
 = &
Œª§ùiÚ
->
t_shadow_li¡
;

1960 
BJ_Re£rved
:

1961 
li¡
 = &
Œª§ùiÚ
->
t_»£rved_li¡
;

1965 
	`__bli¡_d–_bufãr
(
li¡
, 
jh
);

1966 
jh
->
b_jli¡
 = 
BJ_NÚe
;

1967 ià(
Œª§ùiÚ
 && 
	`is_jouº®_abÜ‹d
Ñ¿n§ùiÚ->
t_jouº®
))

1968 
	`ş—r_bufãr_jbddœty
(
bh
);

1969 ià(
	`‹¡_ş—r_bufãr_jbddœty
(
bh
))

1970 
	`m¬k_bufãr_dœty
(
bh
);

1971 
	}
}

1980 
	$__jbd3_jouº®_unfe_bufãr
(
jouº®_h—d
 *
jh
)

1982 
	`__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jh
);

1983 
jh
->
b_Œª§ùiÚ
 = 
NULL
;

1984 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1985 
	}
}

1987 
	$jbd3_jouº®_unfe_bufãr
(
jouº®_t
 *
jouº®
, 
jouº®_h—d
 *
jh
)

1989 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

1992 
	`g‘_bh
(
bh
);

1993 
	`jbd_lock_bh_¡©e
(
bh
);

1994 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1995 
	`__jbd3_jouº®_unfe_bufãr
(
jh
);

1996 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1997 
	`jbd_uÆock_bh_¡©e
(
bh
);

1998 
	`__b»l£
(
bh
);

1999 
	}
}

2007 
	$__jouº®_Œy_to_ä“_bufãr
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
)

2009 
jouº®_h—d
 *
jh
;

2011 
jh
 = 
	`bh2jh
(
bh
);

2013 ià(
	`bufãr_locked
(
bh
è|| 
	`bufãr_dœty
(bh))

2014 
out
;

2016 ià(
jh
->
b_Ãxt_Œª§ùiÚ
 !ğ
NULL
 || jh->
b_Œª§ùiÚ
 != NULL)

2017 
out
;

2019 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2020 ià(
jh
->
b_ı_Œª§ùiÚ
 !ğ
NULL
) {

2022 
	`JBUFFER_TRACE
(
jh
, "remove from checkpoint†ist");

2023 
	`__jbd3_jouº®_»move_checkpošt
(
jh
);

2025 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2026 
out
:

2028 
	}
}

2068 
	$jbd3_jouº®_Œy_to_ä“_bufãrs
(
jouº®_t
 *
jouº®
,

2069 
·ge
 *·ge, 
gå_t
 
gå_mask
)

2071 
bufãr_h—d
 *
h—d
;

2072 
bufãr_h—d
 *
bh
;

2073 
»t
 = 0;

2075 
	`J_ASSERT
(
	`PageLocked
(
·ge
));

2077 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

2078 
bh
 = 
h—d
;

2080 
jouº®_h—d
 *
jh
;

2087 
jh
 = 
	`jbd3_jouº®_g¿b_jouº®_h—d
(
bh
);

2088 ià(!
jh
)

2091 
	`jbd_lock_bh_¡©e
(
bh
);

2092 
	`__jouº®_Œy_to_ä“_bufãr
(
jouº®
, 
bh
);

2093 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

2094 
	`jbd_uÆock_bh_¡©e
(
bh
);

2095 ià(
	`bufãr_jbd
(
bh
))

2096 
busy
;

2097 } (
bh
 = bh->
b_this_·ge
è!ğ
h—d
);

2099 
»t
 = 
	`Œy_to_ä“_bufãrs
(
·ge
);

2101 
busy
:

2102  
»t
;

2103 
	}
}

2117 
	$__di¥o£_bufãr
(
jouº®_h—d
 *
jh
, 
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

2119 
may_ä“
 = 1;

2120 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2122 ià(
jh
->
b_ı_Œª§ùiÚ
) {

2123 
	`JBUFFER_TRACE
(
jh
, "on„unning+cpransaction");

2124 
	`__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jh
);

2130 
	`ş—r_bufãr_dœty
(
bh
);

2131 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_FÜg‘
);

2132 
may_ä“
 = 0;

2134 
	`JBUFFER_TRACE
(
jh
, "on„unningransaction");

2135 
	`__jbd3_jouº®_unfe_bufãr
(
jh
);

2137  
may_ä“
;

2138 
	}
}

2187 
	$jouº®_unm­_bufãr
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
,

2188 
·¹Ÿl_·ge
)

2190 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

2191 
jouº®_h—d
 *
jh
;

2192 
may_ä“
 = 1;

2194 
	`BUFFER_TRACE
(
bh
, "entry");

2202 ià(!
	`bufãr_jbd
(
bh
))

2203 
z­_bufãr_uÆocked
;

2206 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2207 
	`jbd_lock_bh_¡©e
(
bh
);

2208 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2210 
jh
 = 
	`jbd3_jouº®_g¿b_jouº®_h—d
(
bh
);

2211 ià(!
jh
)

2212 
z­_bufãr_no_jh
;

2237 
Œª§ùiÚ
 = 
jh
->
b_Œª§ùiÚ
;

2238 ià(
Œª§ùiÚ
 =ğ
NULL
) {

2243 ià(!
jh
->
b_ı_Œª§ùiÚ
) {

2244 
	`JBUFFER_TRACE
(
jh
, "not on‡nyransaction: zap");

2245 
z­_bufãr
;

2248 ià(!
	`bufãr_dœty
(
bh
)) {

2250 
	`__jbd3_jouº®_»move_checkpošt
(
jh
);

2251 
z­_bufãr
;

2258 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

2262 
	`JBUFFER_TRACE
(
jh
, "checkpointed:‡ddo BJ_Forget");

2263 
may_ä“
 = 
	`__di¥o£_bufãr
(
jh
,

2264 
jouº®
->
j_ruÂšg_Œª§ùiÚ
);

2265 
z­_bufãr
;

2271 ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
) {

2272 
	`JBUFFER_TRACE
(
jh
, "giveo committingrans");

2273 
may_ä“
 = 
	`__di¥o£_bufãr
(
jh
,

2274 
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

2275 
z­_bufãr
;

2279 
	`ş—r_bufãr_jbddœty
(
bh
);

2280 
	`__jbd3_jouº®_»move_checkpošt
(
jh
);

2281 
z­_bufãr
;

2284 } ià(
Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
) {

2285 
	`JBUFFER_TRACE
(
jh
, "on committingransaction");

2291 ià(
·¹Ÿl_·ge
) {

2292 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

2293 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2294 
	`jbd_uÆock_bh_¡©e
(
bh
);

2295 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2296  -
EBUSY
;

2304 
	`£t_bufãr_ä“d
(
bh
);

2305 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 && 
	`bufãr_jbddœty
(
bh
))

2306 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

2307 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

2308 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2309 
	`jbd_uÆock_bh_¡©e
(
bh
);

2310 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2319 
	`J_ASSERT_JH
(
jh
, 
Œª§ùiÚ
 =ğ
jouº®
->
j_ruÂšg_Œª§ùiÚ
);

2320 
	`JBUFFER_TRACE
(
jh
, "on„unningransaction");

2321 
may_ä“
 = 
	`__di¥o£_bufãr
(
jh
, 
Œª§ùiÚ
);

2324 
z­_bufãr
:

2333 
jh
->
b_modif›d
 = 0;

2334 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

2335 
z­_bufãr_no_jh
:

2336 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2337 
	`jbd_uÆock_bh_¡©e
(
bh
);

2338 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2339 
z­_bufãr_uÆocked
:

2340 
	`ş—r_bufãr_dœty
(
bh
);

2341 
	`J_ASSERT_BH
(
bh
, !
	`bufãr_jbddœty
(bh));

2342 
	`ş—r_bufãr_m­³d
(
bh
);

2343 
	`ş—r_bufãr_»q
(
bh
);

2344 
	`ş—r_bufãr_Ãw
(
bh
);

2345 
	`ş—r_bufãr_d–ay
(
bh
);

2346 
	`ş—r_bufãr_unwr™‹n
(
bh
);

2347 
bh
->
b_bdev
 = 
NULL
;

2348  
may_ä“
;

2349 
	}
}

2363 
	$jbd3_jouº®_šv®id©•age
(
jouº®_t
 *
jouº®
,

2364 
·ge
 *page,

2365 
off£t
,

2366 
Ëngth
)

2368 
bufãr_h—d
 *
h—d
, *
bh
, *
Ãxt
;

2369 
¡İ
 = 
off£t
 + 
Ëngth
;

2370 
cu¼_off
 = 0;

2371 
·¹Ÿl_·ge
 = (
off£t
 || 
Ëngth
 < 
PAGE_SIZE
);

2372 
may_ä“
 = 1;

2373 
»t
 = 0;

2375 ià(!
	`PageLocked
(
·ge
))

2376 
	`BUG
();

2377 ià(!
	`·ge_has_bufãrs
(
·ge
))

2380 
	`BUG_ON
(
¡İ
 > 
PAGE_SIZE
 || stİ < 
Ëngth
);

2386 
h—d
 = 
bh
 = 
	`·ge_bufãrs
(
·ge
);

2388 
Ãxt_off
 = 
cu¼_off
 + 
bh
->
b_size
;

2389 
Ãxt
 = 
bh
->
b_this_·ge
;

2391 ià(
Ãxt_off
 > 
¡İ
)

2394 ià(
off£t
 <ğ
cu¼_off
) {

2396 
	`lock_bufãr
(
bh
);

2397 
»t
 = 
	`jouº®_unm­_bufãr
(
jouº®
, 
bh
, 
·¹Ÿl_·ge
);

2398 
	`uÆock_bufãr
(
bh
);

2399 ià(
»t
 < 0)

2400  
»t
;

2401 
may_ä“
 &ğ
»t
;

2403 
cu¼_off
 = 
Ãxt_off
;

2404 
bh
 = 
Ãxt
;

2406 } 
bh
 !ğ
h—d
);

2408 ià(!
·¹Ÿl_·ge
) {

2409 ià(
may_ä“
 && 
	`Œy_to_ä“_bufãrs
(
·ge
))

2410 
	`J_ASSERT
(!
	`·ge_has_bufãrs
(
·ge
));

2413 
	}
}

2418 
	$__jbd3_jouº®_fe_bufãr
(
jouº®_h—d
 *
jh
,

2419 
Œª§ùiÚ_t
 *
Œª§ùiÚ
, 
jli¡
)

2421 
jouº®_h—d
 **
li¡
 = 
NULL
;

2422 
was_dœty
 = 0;

2423 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2425 
	`J_ASSERT_JH
(
jh
, 
	`jbd_is_locked_bh_¡©e
(
bh
));

2426 
	`as£¹_¥š_locked
(&
Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

2428 
	`J_ASSERT_JH
(
jh
, jh->
b_jli¡
 < 
BJ_Ty³s
);

2429 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

2430 
jh
->
b_Œª§ùiÚ
 =ğ
NULL
);

2432 ià(
jh
->
b_Œª§ùiÚ
 && jh->
b_jli¡
 =ğ
jli¡
)

2435 ià(
jli¡
 =ğ
BJ_M‘ad©a
 || jli¡ =ğ
BJ_Re£rved
 ||

2436 
jli¡
 =ğ
BJ_Shadow
 || jli¡ =ğ
BJ_FÜg‘
) {

2444 ià(
	`bufãr_dœty
(
bh
))

2445 
	`w¬n_dœty_bufãr
(
bh
);

2446 ià(
	`‹¡_ş—r_bufãr_dœty
(
bh
) ||

2447 
	`‹¡_ş—r_bufãr_jbddœty
(
bh
))

2448 
was_dœty
 = 1;

2451 ià(
jh
->
b_Œª§ùiÚ
)

2452 
	`__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jh
);

2454 
	`jbd3_jouº®_g¿b_jouº®_h—d
(
bh
);

2455 
jh
->
b_Œª§ùiÚ
 = 
Œª§ùiÚ
;

2457 
jli¡
) {

2458 
BJ_NÚe
:

2459 
	`J_ASSERT_JH
(
jh
, !jh->
b_comm™‹d_d©a
);

2460 
	`J_ASSERT_JH
(
jh
, !jh->
b_äoz’_d©a
);

2462 
BJ_M‘ad©a
:

2463 
Œª§ùiÚ
->
t_Ä_bufãrs
++;

2464 
li¡
 = &
Œª§ùiÚ
->
t_bufãrs
;

2466 
BJ_FÜg‘
:

2467 
li¡
 = &
Œª§ùiÚ
->
t_fÜg‘
;

2469 
BJ_Shadow
:

2470 
li¡
 = &
Œª§ùiÚ
->
t_shadow_li¡
;

2472 
BJ_Re£rved
:

2473 
li¡
 = &
Œª§ùiÚ
->
t_»£rved_li¡
;

2477 
	`__bli¡_add_bufãr
(
li¡
, 
jh
);

2478 
jh
->
b_jli¡
 = 
jli¡
;

2480 ià(
was_dœty
)

2481 
	`£t_bufãr_jbddœty
(
bh
);

2482 
	}
}

2484 
	$jbd3_jouº®_fe_bufãr
(
jouº®_h—d
 *
jh
,

2485 
Œª§ùiÚ_t
 *
Œª§ùiÚ
, 
jli¡
)

2487 
	`jbd_lock_bh_¡©e
(
	`jh2bh
(
jh
));

2488 
	`¥š_lock
(&
Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

2489 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
jli¡
);

2490 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

2491 
	`jbd_uÆock_bh_¡©e
(
	`jh2bh
(
jh
));

2492 
	}
}

2505 
	$__jbd3_jouº®_»fe_bufãr
(
jouº®_h—d
 *
jh
)

2507 
was_dœty
, 
jli¡
;

2508 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2510 
	`J_ASSERT_JH
(
jh
, 
	`jbd_is_locked_bh_¡©e
(
bh
));

2511 ià(
jh
->
b_Œª§ùiÚ
)

2512 
	`as£¹_¥š_locked
(&
jh
->
b_Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

2515 ià(
jh
->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
) {

2516 
	`__jbd3_jouº®_unfe_bufãr
(
jh
);

2525 
was_dœty
 = 
	`‹¡_ş—r_bufãr_jbddœty
(
bh
);

2526 
	`__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jh
);

2532 
jh
->
b_Œª§ùiÚ
 = jh->
b_Ãxt_Œª§ùiÚ
;

2533 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
NULL
;

2534 ià(
	`bufãr_ä“d
(
bh
))

2535 
jli¡
 = 
BJ_FÜg‘
;

2536 ià(
jh
->
b_modif›d
)

2537 
jli¡
 = 
BJ_M‘ad©a
;

2539 
jli¡
 = 
BJ_Re£rved
;

2540 
	`__jbd3_jouº®_fe_bufãr
(
jh
, jh->
b_Œª§ùiÚ
, 
jli¡
);

2541 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
->
t_¡©e
 =ğ
T_RUNNING
);

2543 ià(
was_dœty
)

2544 
	`£t_bufãr_jbddœty
(
bh
);

2545 
	}
}

2553 
	$jbd3_jouº®_»fe_bufãr
(
jouº®_t
 *
jouº®
, 
jouº®_h—d
 *
jh
)

2555 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2558 
	`g‘_bh
(
bh
);

2559 
	`jbd_lock_bh_¡©e
(
bh
);

2560 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2561 
	`__jbd3_jouº®_»fe_bufãr
(
jh
);

2562 
	`jbd_uÆock_bh_¡©e
(
bh
);

2563 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2564 
	`__b»l£
(
bh
);

2565 
	}
}

2570 
	$jbd3_jouº®_fe_šode
(
hªdË_t
 *
hªdË
, 
jbd3_šode
 *
jšode
,

2571 
æags
, 
loff_t
 
¡¬t_by‹
,†off_ˆ
’d_by‹
)

2573 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

2574 
jouº®_t
 *
jouº®
;

2576 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

2577  -
EROFS
;

2578 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

2580 
	`jbd_debug
(4, "Addšg inod%lu,id:%d\n", 
jšode
->
i_vfs_šode
->
i_šo
,

2581 
Œª§ùiÚ
->
t_tid
);

2583 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2584 
jšode
->
i_æags
 |ğ
æags
;

2586 ià(
jšode
->
i_dœty_’d
) {

2587 
jšode
->
i_dœty_¡¬t
 = 
	`mš
(jšode->i_dœty_¡¬t, 
¡¬t_by‹
);

2588 
jšode
->
i_dœty_’d
 = 
	`max
(jšode->i_dœty_’d, 
’d_by‹
);

2590 
jšode
->
i_dœty_¡¬t
 = 
¡¬t_by‹
;

2591 
jšode
->
i_dœty_’d
 = 
’d_by‹
;

2595 ià(
jšode
->
i_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

2596 
jšode
->
i_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
)

2597 
dÚe
;

2604 ià(!
Œª§ùiÚ
->
t_Ãed_d©a_æush
)

2605 
Œª§ùiÚ
->
t_Ãed_d©a_æush
 = 1;

2608 ià(
jšode
->
i_Œª§ùiÚ
) {

2609 
	`J_ASSERT
(
jšode
->
i_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

2610 
	`J_ASSERT
(
jšode
->
i_Œª§ùiÚ
 ==

2611 
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

2612 
jšode
->
i_Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

2613 
dÚe
;

2616 
	`J_ASSERT
(!
jšode
->
i_Ãxt_Œª§ùiÚ
);

2617 
jšode
->
i_Œª§ùiÚ
 = 
Œª§ùiÚ
;

2618 
	`li¡_add
(&
jšode
->
i_li¡
, &
Œª§ùiÚ
->
t_šode_li¡
);

2619 
dÚe
:

2620 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2623 
	}
}

2625 
	$jbd3_jouº®_šode_¿nged_wr™e
(
hªdË_t
 *
hªdË
,

2626 
jbd3_šode
 *
jšode
, 
loff_t
 
¡¬t_by‹
,†off_ˆ
Ëngth
)

2628  
	`jbd3_jouº®_fe_šode
(
hªdË
, 
jšode
,

2629 
JI_WRITE_DATA
 | 
JI_WAIT_DATA
, 
¡¬t_by‹
,

2630 
¡¬t_by‹
 + 
Ëngth
 - 1);

2631 
	}
}

2633 
	$jbd3_jouº®_šode_¿nged_wa™
(
hªdË_t
 *
hªdË
, 
jbd3_šode
 *
jšode
,

2634 
loff_t
 
¡¬t_by‹
,†off_ˆ
Ëngth
)

2636  
	`jbd3_jouº®_fe_šode
(
hªdË
, 
jšode
, 
JI_WAIT_DATA
,

2637 
¡¬t_by‹
, s¹_by‹ + 
Ëngth
 - 1);

2638 
	}
}

2660 
	$jbd3_jouº®_begš_Üd”ed_Œunÿ‹
(
jouº®_t
 *
jouº®
,

2661 
jbd3_šode
 *
jšode
,

2662 
loff_t
 
Ãw_size
)

2664 
Œª§ùiÚ_t
 *
šode_Œªs
, *
comm™_Œªs
;

2665 
»t
 = 0;

2668 ià(!
jšode
->
i_Œª§ùiÚ
)

2669 
out
;

2673 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

2674 
comm™_Œªs
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

2675 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

2676 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2677 
šode_Œªs
 = 
jšode
->
i_Œª§ùiÚ
;

2678 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2679 ià(
šode_Œªs
 =ğ
comm™_Œªs
) {

2680 
»t
 = 
	`fem­_fd©awr™e_¿nge
(
jšode
->
i_vfs_šode
->
i_m­pšg
,

2681 
Ãw_size
, 
LLONG_MAX
);

2682 ià(
»t
)

2683 
	`jbd3_jouº®_abÜt
(
jouº®
, 
»t
);

2685 
out
:

2686  
»t
;

2687 
	}
}

	@/usr/include/linux/errno.h

1 
	~<asm/”ºo.h
>

	@/usr/include/linux/fs.h

2 #iâdeà
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<lšux/lim™s.h
>

14 
	~<lšux/ioùl.h
>

15 
	~<lšux/ty³s.h
>

16 
	~<lšux/fsüy±.h
>

19 
	~<lšux/mouÁ.h
>

32 #undeà
NR_OPEN


33 
	#INR_OPEN_CUR
 1024

	)

34 
	#INR_OPEN_MAX
 4096

	)

36 
	#BLOCK_SIZE_BITS
 10

	)

37 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

39 
	#SEEK_SET
 0

	)

40 
	#SEEK_CUR
 1

	)

41 
	#SEEK_END
 2

	)

42 
	#SEEK_DATA
 3

	)

43 
	#SEEK_HOLE
 4

	)

44 
	#SEEK_MAX
 
SEEK_HOLE


	)

46 
	#RENAME_NOREPLACE
 (1 << 0è

	)

47 
	#RENAME_EXCHANGE
 (1 << 1è

	)

48 
	#RENAME_WHITEOUT
 (1 << 2è

	)

50 
	sfe_şÚe_¿nge
 {

51 
__s64
 
	m¤c_fd
;

52 
__u64
 
	m¤c_off£t
;

53 
__u64
 
	m¤c_Ëngth
;

54 
__u64
 
	mde¡_off£t
;

57 
	sf¡rim_¿nge
 {

58 
__u64
 
	m¡¬t
;

59 
__u64
 
	mËn
;

60 
__u64
 
	mmšËn
;

64 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

65 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

68 
	sfe_dedu³_¿nge_šfo
 {

69 
__s64
 
	mde¡_fd
;

70 
__u64
 
	mde¡_off£t
;

71 
__u64
 
	mby‹s_dedu³d
;

78 
__s32
 
	m¡©us
;

79 
__u32
 
	m»£rved
;

83 
	sfe_dedu³_¿nge
 {

84 
__u64
 
	m¤c_off£t
;

85 
__u64
 
	m¤c_Ëngth
;

86 
__u16
 
	mde¡_couÁ
;

87 
__u16
 
	m»£rved1
;

88 
__u32
 
	m»£rved2
;

89 
fe_dedu³_¿nge_šfo
 
	mšfo
[0];

93 
	sfes_¡©_¡ruù
 {

94 
	mÄ_fes
;

95 
	mÄ_ä“_fes
;

96 
	mmax_fes
;

99 
	sšodes_¡©_t
 {

100 
	mÄ_šodes
;

101 
	mÄ_unu£d
;

102 
	mdummy
[5];

106 
	#NR_FILE
 8192

	)

111 
	sfsx©Œ
 {

112 
__u32
 
	mfsx_xæags
;

113 
__u32
 
	mfsx_extsize
;

114 
__u32
 
	mfsx_Ãx‹Ás
;

115 
__u32
 
	mfsx_´ojid
;

116 
__u32
 
	mfsx_cowextsize
;

117 
	mfsx_·d
[8];

123 
	#FS_XFLAG_REALTIME
 0x00000001

	)

124 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

125 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

126 
	#FS_XFLAG_APPEND
 0x00000010

	)

127 
	#FS_XFLAG_SYNC
 0x00000020

	)

128 
	#FS_XFLAG_NOATIME
 0x00000040

	)

129 
	#FS_XFLAG_NODUMP
 0x00000080

	)

130 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

131 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

132 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

133 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

134 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

135 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

136 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

137 
	#FS_XFLAG_DAX
 0x00008000

	)

138 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

139 
	#FS_XFLAG_HASATTR
 0x80000000

	)

144 
	#BLKROSET
 
	`_IO
(0x12,93è

	)

145 
	#BLKROGET
 
	`_IO
(0x12,94è

	)

146 
	#BLKRRPART
 
	`_IO
(0x12,95è

	)

147 
	#BLKGETSIZE
 
	`_IO
(0x12,96è

	)

148 
	#BLKFLSBUF
 
	`_IO
(0x12,97è

	)

149 
	#BLKRASET
 
	`_IO
(0x12,98è

	)

150 
	#BLKRAGET
 
	`_IO
(0x12,99è

	)

151 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

152 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

153 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

154 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

155 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

157 
	#BLKPG
 
	`_IO
(0x12,105)

	)

161 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

162 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

167 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

168 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

169 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
è

	)

170 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_Œaû_£tup
)

	)

171 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

172 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

173 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

174 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

175 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

176 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

177 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

178 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

179 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

180 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

181 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

182 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

188 
	#BMAP_IOCTL
 1

	)

189 
	#FIBMAP
 
	`_IO
(0x00,1è

	)

190 
	#FIGETBSZ
 
	`_IO
(0x00,2è

	)

191 
	#FIFREEZE
 
	`_IOWR
('X', 119, è

	)

192 
	#FITHAW
 
	`_IOWR
('X', 120, è

	)

193 
	#FITRIM
 
	`_IOWR
('X', 121, 
f¡rim_¿nge
è

	)

194 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

195 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fe_şÚe_¿nge
)

	)

196 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fe_dedu³_¿nge
)

	)

198 
	#FSLABEL_MAX
 256

	)

200 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

201 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

202 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

203 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

204 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
f›m­
)

	)

205 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

206 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

207 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

208 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

209 
	#FS_IOC_FSGETXATTR
 
	`_IOR
('X', 31, 
fsx©Œ
)

	)

210 
	#FS_IOC_FSSETXATTR
 
	`_IOW
('X', 32, 
fsx©Œ
)

	)

211 
	#FS_IOC_GETFSLABEL
 
	`_IOR
(0x94, 49, [
FSLABEL_MAX
])

	)

212 
	#FS_IOC_SETFSLABEL
 
	`_IOW
(0x94, 50, [
FSLABEL_MAX
])

	)

234 
	#FS_SECRM_FL
 0x00000001

	)

235 
	#FS_UNRM_FL
 0x00000002

	)

236 
	#FS_COMPR_FL
 0x00000004

	)

237 
	#FS_SYNC_FL
 0x00000008

	)

238 
	#FS_IMMUTABLE_FL
 0x00000010

	)

239 
	#FS_APPEND_FL
 0x00000020

	)

240 
	#FS_NODUMP_FL
 0x00000040

	)

241 
	#FS_NOATIME_FL
 0x00000080

	)

243 
	#FS_DIRTY_FL
 0x00000100

	)

244 
	#FS_COMPRBLK_FL
 0x00000200

	)

245 
	#FS_NOCOMP_FL
 0x00000400

	)

247 
	#FS_ENCRYPT_FL
 0x00000800

	)

248 
	#FS_BTREE_FL
 0x00001000

	)

249 
	#FS_INDEX_FL
 0x00001000

	)

250 
	#FS_IMAGIC_FL
 0x00002000

	)

251 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

252 
	#FS_NOTAIL_FL
 0x00008000

	)

253 
	#FS_DIRSYNC_FL
 0x00010000

	)

254 
	#FS_TOPDIR_FL
 0x00020000

	)

255 
	#FS_HUGE_FILE_FL
 0x00040000

	)

256 
	#FS_EXTENT_FL
 0x00080000

	)

257 
	#FS_VERITY_FL
 0x00100000

	)

258 
	#FS_EA_INODE_FL
 0x00200000

	)

259 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

260 
	#FS_NOCOW_FL
 0x00800000

	)

261 
	#FS_INLINE_DATA_FL
 0x10000000

	)

262 
	#FS_PROJINHERIT_FL
 0x20000000

	)

263 
	#FS_CASEFOLD_FL
 0x40000000

	)

264 
	#FS_RESERVED_FL
 0x80000000

	)

266 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

267 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

270 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

271 
	#SYNC_FILE_RANGE_WRITE
 2

	)

272 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

273 
	#SYNC_FILE_RANGE_WRITE_AND_WAIT
 (
SYNC_FILE_RANGE_WRITE
 | \

274 
SYNC_FILE_RANGE_WAIT_BEFORE
 | \

275 
SYNC_FILE_RANGE_WAIT_AFTER
)

	)

281 
	t__b™wi£
 
	t__k”Ãl_rwf_t
;

284 
	#RWF_HIPRI
 ((
__k”Ãl_rwf_t
)0x00000001)

	)

287 
	#RWF_DSYNC
 ((
__k”Ãl_rwf_t
)0x00000002)

	)

290 
	#RWF_SYNC
 ((
__k”Ãl_rwf_t
)0x00000004)

	)

293 
	#RWF_NOWAIT
 ((
__k”Ãl_rwf_t
)0x00000008)

	)

296 
	#RWF_APPEND
 ((
__k”Ãl_rwf_t
)0x00000010)

	)

299 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
 |\

300 
RWF_APPEND
)

	)

	@/usr/include/linux/module.h

2 #iâdeà
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/time.h

2 #iâdeà
_LINUX_TIME_H


3 
	#_LINUX_TIME_H


	)

5 
	~<lšux/ty³s.h
>

6 
	~<lšux/time_ty³s.h
>

8 #iâdeà
_STRUCT_TIMESPEC


9 
	#_STRUCT_TIMESPEC


	)

10 
	stime¥ec
 {

11 
__k”Ãl_time_t
 
	mtv_£c
;

12 
	mtv_n£c
;

16 
	stimev®
 {

17 
__k”Ãl_time_t
 
	mtv_£c
;

18 
__k”Ãl_su£cÚds_t
 
	mtv_u£c
;

21 
	stimezÚe
 {

22 
	mtz_mšu‹swe¡
;

23 
	mtz_d¡time
;

30 
	#ITIMER_REAL
 0

	)

31 
	#ITIMER_VIRTUAL
 1

	)

32 
	#ITIMER_PROF
 2

	)

34 
	s™im”¥ec
 {

35 
time¥ec
 
	m™_š‹rv®
;

36 
time¥ec
 
	m™_v®ue
;

39 
	s™im”v®
 {

40 
timev®
 
	m™_š‹rv®
;

41 
timev®
 
	m™_v®ue
;

47 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

49 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

50 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

51 
	#CLOCK_MONOTONIC_RAW
 4

	)

52 
	#CLOCK_REALTIME_COARSE
 5

	)

53 
	#CLOCK_MONOTONIC_COARSE
 6

	)

54 
	#CLOCK_BOOTTIME
 7

	)

55 
	#CLOCK_REALTIME_ALARM
 8

	)

56 
	#CLOCK_BOOTTIME_ALARM
 9

	)

61 
	#CLOCK_SGI_CYCLE
 10

	)

62 
	#CLOCK_TAI
 11

	)

64 
	#MAX_CLOCKS
 16

	)

65 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

66 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

71 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/fscrypt.h

8 #iâdeà
_LINUX_FSCRYPT_H


9 
	#_LINUX_FSCRYPT_H


	)

11 
	~<lšux/ty³s.h
>

14 
	#FSCRYPT_POLICY_FLAGS_PAD_4
 0x00

	)

15 
	#FSCRYPT_POLICY_FLAGS_PAD_8
 0x01

	)

16 
	#FSCRYPT_POLICY_FLAGS_PAD_16
 0x02

	)

17 
	#FSCRYPT_POLICY_FLAGS_PAD_32
 0x03

	)

18 
	#FSCRYPT_POLICY_FLAGS_PAD_MASK
 0x03

	)

19 
	#FSCRYPT_POLICY_FLAG_DIRECT_KEY
 0x04

	)

20 
	#FSCRYPT_POLICY_FLAGS_VALID
 0x07

	)

23 
	#FSCRYPT_MODE_AES_256_XTS
 1

	)

24 
	#FSCRYPT_MODE_AES_256_CTS
 4

	)

25 
	#FSCRYPT_MODE_AES_128_CBC
 5

	)

26 
	#FSCRYPT_MODE_AES_128_CTS
 6

	)

27 
	#FSCRYPT_MODE_ADIANTUM
 9

	)

28 
	#__FSCRYPT_MODE_MAX
 9

	)

36 
	#FSCRYPT_POLICY_V1
 0

	)

37 
	#FSCRYPT_KEY_DESCRIPTOR_SIZE
 8

	)

38 
	sfsüy±_pŞicy_v1
 {

39 
__u8
 
	mv”siÚ
;

40 
__u8
 
	mcÚ‹Ás_’üy±iÚ_mode
;

41 
__u8
 
	mf’ames_’üy±iÚ_mode
;

42 
__u8
 
	mæags
;

43 
__u8
 
	mma¡”_key_desütÜ
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

45 
	#fsüy±_pŞicy
 
fsüy±_pŞicy_v1


	)

51 
	#FSCRYPT_KEY_DESC_PREFIX
 "fsüy±:"

	)

52 
	#FSCRYPT_KEY_DESC_PREFIX_SIZE
 8

	)

53 
	#FSCRYPT_MAX_KEY_SIZE
 64

	)

54 
	sfsüy±_key
 {

55 
__u32
 
	mmode
;

56 
__u8
 
	m¿w
[
FSCRYPT_MAX_KEY_SIZE
];

57 
__u32
 
	msize
;

63 
	#FSCRYPT_POLICY_V2
 2

	)

64 
	#FSCRYPT_KEY_IDENTIFIER_SIZE
 16

	)

65 
	sfsüy±_pŞicy_v2
 {

66 
__u8
 
	mv”siÚ
;

67 
__u8
 
	mcÚ‹Ás_’üy±iÚ_mode
;

68 
__u8
 
	mf’ames_’üy±iÚ_mode
;

69 
__u8
 
	mæags
;

70 
__u8
 
	m__»£rved
[4];

71 
__u8
 
	mma¡”_key_id’tif›r
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

75 
	sfsüy±_g‘_pŞicy_ex_¬g
 {

76 
__u64
 
	mpŞicy_size
;

78 
__u8
 
	mv”siÚ
;

79 
fsüy±_pŞicy_v1
 
	mv1
;

80 
fsüy±_pŞicy_v2
 
	mv2
;

81 } 
	mpŞicy
;

88 
	#FSCRYPT_KEY_SPEC_TYPE_DESCRIPTOR
 1

	)

95 
	#FSCRYPT_KEY_SPEC_TYPE_IDENTIFIER
 2

	)

101 
	sfsüy±_key_¥ecif›r
 {

102 
__u32
 
	mty³
;

103 
__u32
 
	m__»£rved
;

105 
__u8
 
	m__»£rved
[32];

106 
__u8
 
	mdesütÜ
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

107 
__u8
 
	mid’tif›r
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

108 } 
	mu
;

112 
	sfsüy±_add_key_¬g
 {

113 
fsüy±_key_¥ecif›r
 
	mkey_¥ec
;

114 
__u32
 
	m¿w_size
;

115 
__u32
 
	m__»£rved
[9];

116 
__u8
 
	m¿w
[];

120 
	sfsüy±_»move_key_¬g
 {

121 
fsüy±_key_¥ecif›r
 
	mkey_¥ec
;

122 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_FILES_BUSY
 0x00000001

	)

123 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_OTHER_USERS
 0x00000002

	)

124 
__u32
 
	m»mov®_¡©us_æags
;

125 
__u32
 
	m__»£rved
[5];

129 
	sfsüy±_g‘_key_¡©us_¬g
 {

131 
fsüy±_key_¥ecif›r
 
	mkey_¥ec
;

132 
__u32
 
	m__»£rved
[6];

135 
	#FSCRYPT_KEY_STATUS_ABSENT
 1

	)

136 
	#FSCRYPT_KEY_STATUS_PRESENT
 2

	)

137 
	#FSCRYPT_KEY_STATUS_INCOMPLETELY_REMOVED
 3

	)

138 
__u32
 
	m¡©us
;

139 
	#FSCRYPT_KEY_STATUS_FLAG_ADDED_BY_SELF
 0x00000001

	)

140 
__u32
 
	m¡©us_æags
;

141 
__u32
 
	mu£r_couÁ
;

142 
__u32
 
	m__out_»£rved
[13];

145 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fsüy±_pŞicy
)

	)

146 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

147 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fsüy±_pŞicy
)

	)

148 
	#FS_IOC_GET_ENCRYPTION_POLICY_EX
 
	`_IOWR
('f', 22, 
__u8
[9]è

	)

149 
	#FS_IOC_ADD_ENCRYPTION_KEY
 
	`_IOWR
('f', 23, 
fsüy±_add_key_¬g
)

	)

150 
	#FS_IOC_REMOVE_ENCRYPTION_KEY
 
	`_IOWR
('f', 24, 
fsüy±_»move_key_¬g
)

	)

151 
	#FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
 
	`_IOWR
('f', 25, 
fsüy±_»move_key_¬g
)

	)

152 
	#FS_IOC_GET_ENCRYPTION_KEY_STATUS
 
	`_IOWR
('f', 26, 
fsüy±_g‘_key_¡©us_¬g
)

	)

157 
	#FS_KEY_DESCRIPTOR_SIZE
 
FSCRYPT_KEY_DESCRIPTOR_SIZE


	)

158 
	#FS_POLICY_FLAGS_PAD_4
 
FSCRYPT_POLICY_FLAGS_PAD_4


	)

159 
	#FS_POLICY_FLAGS_PAD_8
 
FSCRYPT_POLICY_FLAGS_PAD_8


	)

160 
	#FS_POLICY_FLAGS_PAD_16
 
FSCRYPT_POLICY_FLAGS_PAD_16


	)

161 
	#FS_POLICY_FLAGS_PAD_32
 
FSCRYPT_POLICY_FLAGS_PAD_32


	)

162 
	#FS_POLICY_FLAGS_PAD_MASK
 
FSCRYPT_POLICY_FLAGS_PAD_MASK


	)

163 
	#FS_POLICY_FLAG_DIRECT_KEY
 
FSCRYPT_POLICY_FLAG_DIRECT_KEY


	)

164 
	#FS_POLICY_FLAGS_VALID
 
FSCRYPT_POLICY_FLAGS_VALID


	)

165 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

166 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 
FSCRYPT_MODE_AES_256_XTS


	)

167 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

168 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

169 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 
FSCRYPT_MODE_AES_256_CTS


	)

170 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 
FSCRYPT_MODE_AES_128_CBC


	)

171 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 
FSCRYPT_MODE_AES_128_CTS


	)

172 
	#FS_ENCRYPTION_MODE_SPECK128_256_XTS
 7

	)

173 
	#FS_ENCRYPTION_MODE_SPECK128_256_CTS
 8

	)

174 
	#FS_ENCRYPTION_MODE_ADIANTUM
 
FSCRYPT_MODE_ADIANTUM


	)

175 
	#FS_KEY_DESC_PREFIX
 
FSCRYPT_KEY_DESC_PREFIX


	)

176 
	#FS_KEY_DESC_PREFIX_SIZE
 
FSCRYPT_KEY_DESC_PREFIX_SIZE


	)

177 
	#FS_MAX_KEY_SIZE
 
FSCRYPT_MAX_KEY_SIZE


	)

	@/usr/include/linux/ioctl.h

2 #iâdeà
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/ioùl.h
>

	@/usr/include/linux/limits.h

2 #iâdeà
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/mount.h

1 #iâdeà
_LINUX_MOUNT_H


2 
	#_LINUX_MOUNT_H


	)

11 
	#MS_RDONLY
 1

	)

12 
	#MS_NOSUID
 2

	)

13 
	#MS_NODEV
 4

	)

14 
	#MS_NOEXEC
 8

	)

15 
	#MS_SYNCHRONOUS
 16

	)

16 
	#MS_REMOUNT
 32

	)

17 
	#MS_MANDLOCK
 64

	)

18 
	#MS_DIRSYNC
 128

	)

19 
	#MS_NOATIME
 1024

	)

20 
	#MS_NODIRATIME
 2048

	)

21 
	#MS_BIND
 4096

	)

22 
	#MS_MOVE
 8192

	)

23 
	#MS_REC
 16384

	)

24 
	#MS_VERBOSE
 32768

	)

26 
	#MS_SILENT
 32768

	)

27 
	#MS_POSIXACL
 (1<<16è

	)

28 
	#MS_UNBINDABLE
 (1<<17è

	)

29 
	#MS_PRIVATE
 (1<<18è

	)

30 
	#MS_SLAVE
 (1<<19è

	)

31 
	#MS_SHARED
 (1<<20è

	)

32 
	#MS_RELATIME
 (1<<21è

	)

33 
	#MS_KERNMOUNT
 (1<<22è

	)

34 
	#MS_I_VERSION
 (1<<23è

	)

35 
	#MS_STRICTATIME
 (1<<24è

	)

36 
	#MS_LAZYTIME
 (1<<25è

	)

39 
	#MS_SUBMOUNT
 (1<<26)

	)

40 
	#MS_NOREMOTELOCK
 (1<<27)

	)

41 
	#MS_NOSEC
 (1<<28)

	)

42 
	#MS_BORN
 (1<<29)

	)

43 
	#MS_ACTIVE
 (1<<30)

	)

44 
	#MS_NOUSER
 (1<<31)

	)

49 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

50 
MS_LAZYTIME
)

	)

55 
	#MS_MGC_VAL
 0xC0ED0000

	)

56 
	#MS_MGC_MSK
 0xffff0000

	)

61 
	#OPEN_TREE_CLONE
 1

	)

62 
	#OPEN_TREE_CLOEXEC
 
O_CLOEXEC


	)

67 
	#MOVE_MOUNT_F_SYMLINKS
 0x00000001

	)

68 
	#MOVE_MOUNT_F_AUTOMOUNTS
 0x00000002

	)

69 
	#MOVE_MOUNT_F_EMPTY_PATH
 0x00000004

	)

70 
	#MOVE_MOUNT_T_SYMLINKS
 0x00000010

	)

71 
	#MOVE_MOUNT_T_AUTOMOUNTS
 0x00000020

	)

72 
	#MOVE_MOUNT_T_EMPTY_PATH
 0x00000040

	)

73 
	#MOVE_MOUNT__MASK
 0x00000077

	)

78 
	#FSOPEN_CLOEXEC
 0x00000001

	)

83 
	#FSPICK_CLOEXEC
 0x00000001

	)

84 
	#FSPICK_SYMLINK_NOFOLLOW
 0x00000002

	)

85 
	#FSPICK_NO_AUTOMOUNT
 0x00000004

	)

86 
	#FSPICK_EMPTY_PATH
 0x00000008

	)

91 
	efscÚfig_commªd
 {

92 
	mFSCONFIG_SET_FLAG
 = 0,

93 
	mFSCONFIG_SET_STRING
 = 1,

94 
	mFSCONFIG_SET_BINARY
 = 2,

95 
	mFSCONFIG_SET_PATH
 = 3,

96 
	mFSCONFIG_SET_PATH_EMPTY
 = 4,

97 
	mFSCONFIG_SET_FD
 = 5,

98 
	mFSCONFIG_CMD_CREATE
 = 6,

99 
	mFSCONFIG_CMD_RECONFIGURE
 = 7,

105 
	#FSMOUNT_CLOEXEC
 0x00000001

	)

110 
	#MOUNT_ATTR_RDONLY
 0x00000001

	)

111 
	#MOUNT_ATTR_NOSUID
 0x00000002

	)

112 
	#MOUNT_ATTR_NODEV
 0x00000004

	)

113 
	#MOUNT_ATTR_NOEXEC
 0x00000008

	)

114 
	#MOUNT_ATTR__ATIME
 0x00000070

	)

115 
	#MOUNT_ATTR_RELATIME
 0x00000000

	)

116 
	#MOUNT_ATTR_NOATIME
 0x00000010

	)

117 
	#MOUNT_ATTR_STRICTATIME
 0x00000020

	)

118 
	#MOUNT_ATTR_NODIRATIME
 0x00000080

	)

	@/usr/include/linux/time_types.h

2 #iâdeà
_LINUX_TIME_TYPES_H


3 
	#_LINUX_TIME_TYPES_H


	)

5 
	~<lšux/ty³s.h
>

7 
	s__k”Ãl_time¥ec
 {

8 
__k”Ãl_time64_t
 
	mtv_£c
;

9 
	mtv_n£c
;

12 
	s__k”Ãl_™im”¥ec
 {

13 
__k”Ãl_time¥ec
 
	m™_š‹rv®
;

14 
__k”Ãl_time¥ec
 
	m™_v®ue
;

24 #iâdeà
__k”Ãl_Şd_timev®


25 
	s__k”Ãl_Şd_timev®
 {

26 
__k”Ãl_lÚg_t
 
	mtv_£c
;

27 
__k”Ãl_lÚg_t
 
	mtv_u£c
;

31 
	s__k”Ãl_sock_timev®
 {

32 
__s64
 
	mtv_£c
;

33 
__s64
 
	mtv_u£c
;

	@/usr/include/linux/types.h

2 #iâdeà
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty³s.h
>

7 #iâdeà
__ASSEMBLY__


9 
	~<lšux/posix_ty³s.h
>

17 #ifdeà
__CHECKER__


18 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

20 
	#__b™wi£__


	)

22 
	#__b™wi£
 
__b™wi£__


	)

24 
__u16
 
	t__b™wi£
 
	t__Ë16
;

25 
__u16
 
	t__b™wi£
 
	t__be16
;

26 
__u32
 
	t__b™wi£
 
	t__Ë32
;

27 
__u32
 
	t__b™wi£
 
	t__be32
;

28 
__u64
 
	t__b™wi£
 
	t__Ë64
;

29 
__u64
 
	t__b™wi£
 
	t__be64
;

31 
__u16
 
	t__b™wi£
 
	t__sum16
;

32 
__u32
 
	t__b™wi£
 
	t__wsum
;

43 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

44 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

45 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

47 
	t__b™wi£
 
	t__pŞl_t
;

	@/usr/include/linux/posix_types.h

2 #iâdeà
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<lšux/¡ddef.h
>

22 #undeà
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_b™s
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__k”Ãl_fd_£t
;

30 (*
	t__k”Ãl_sighªdËr_t
)();

33 
	t__k”Ãl_key_t
;

34 
	t__k”Ãl_mqd_t
;

36 
	~<asm/posix_ty³s.h
>

	@/usr/include/linux/stddef.h

4 #iâdeà
__®ways_šlše


5 
	#__®ways_šlše
 
__šlše__


	)

	@
1
.
1
/usr/include
18
402
checkpoint.c
commit.c
journal.c
recovery.c
revoke.c
transaction.c
/usr/include/linux/errno.h
/usr/include/linux/fs.h
/usr/include/linux/module.h
/usr/include/linux/time.h
/usr/include/linux/fscrypt.h
/usr/include/linux/ioctl.h
/usr/include/linux/limits.h
/usr/include/linux/mount.h
/usr/include/linux/time_types.h
/usr/include/linux/types.h
/usr/include/linux/posix_types.h
/usr/include/linux/stddef.h
